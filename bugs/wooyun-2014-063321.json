{"id": 2851, "wybug_id": "wooyun-2014-063321", "wybug_title": "腾讯某界面DOM型跨站（那些容易误用的正则表达式）", "wybug_corp": "腾讯", "wybug_author": "香草", "wybug_date": "2014-06-03 11:24", "wybug_open_date": "2014-07-18 11:24", "wybug_type": "xss跨站脚本攻击", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["技巧", "正则表达式"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-18：\t细节向公众公开  简要描述： 我在看QQ空间的时候看到了一个广告，于是我随手打开看看，由于我习惯型的右键审查元素，于是有了下面的故事……限制域名的正则表达式缺陷，导致我两次绕过限制，加载任意框架，可欺骗登陆。危害不大，就当补习下正则表达式吧 详细说明：  这是腾讯的广告界面，也就是http://etg.qq.com/ 腾讯易推广存在缺陷的链接是：\nhttp://etg.qq.com/billboard/minsite/etg.shtml?fu=http%3A%2F%2Fa.paipai.com%2f%26size%3D1024x768%26time%3D0\n这是第一次的代码\nvar fu=$xss(decodeURIComponent($getQuery('fu')),'script'),      content=document.getElementById('content');     if(fu.search(/^http\\:\\/\\/.*\\.paipai.com($|(\\/[^<>\\'\\\"]*))/) > -1){  \t var uin=$getUin(),\t    sizes=$getQuery('size',fu).split('x');\t\tif(sizes&&sizes.length==2){\t\t\tcontent.style.width=sizes[0]+'px';\t\t\tcontent.style.height=sizes[1]+'px';\t\t}\t\tcontent.src=fu+(uin ? (fu.indexOf('?')>0 ? '&uin=':'?uin=')+uin  :'');  }else{  \tcontent.src='http://www.paipai.com';  }     function $getUin(){\t    var uin=$getCookie(\"uin\")||$getCookie('uin_cookie')||$getCookie('pt2gguin')\t\t        ||$getCookie('o_cookie')||$getCookie('luin')||$getCookie('buy_uin');\t    return uin?parseInt(uin.replace(\"o\",\"\"),10):\"\";   }  function $getQuery(name,url){\tvar u  = arguments[1] || window.location.search,\t\treg = new RegExp(\"(^|&)\"+ name +\"=([^&]*)(&|$)\"),\t\tr = u.substr(u.indexOf(\"\\?\")+1).match(reg);\t   return r!=null?r[2]:\"\";  }  function $getCookie(name) {\tvar reg = new RegExp(\"(^| )\" + name + \"(?:=([^;]*))?(;|$)\"), val = document.cookie.match(reg);\treturn val ? (val[2] ? unescape(val[2]) : \"\") : null;  }function $xss(str,type){\t//空过滤\tif(!str){\t\treturn str===0 ? \"0\" : \"\";\t}\tswitch(type){\t\tcase \"script\":\t\t\treturn str.replace(/[\\\\\"']/g, function(r){\t\t\t\treturn \"\\\\\" + r;\t\t\t}).replace(/%/g, \"\\\\x25\").replace(/\\n/g, \"\\\\n\").replace(/\\r/g, \"\\\\r\").replace(/\\x01/g, \"\\\\x01\");\t\tbreak;\t}}\n存在问题的是这个正则表达式：\nfu.search(/^http\\:\\/\\/.*\\.paipai.com($|(\\/[^<>\\'\\\"]*))/)\n开发人员的本意是想要匹配所有的paipai.com的子域，这个正则限制了开头也限制了结尾，本来是很严密的。可是他显然没有注意到.*是可以匹配任意字符的，于是我们可以构造如下链接进行绕过：\nhttp://etg.qq.com/billboard/minsite/etg.shtml?fu=http%3A%2F%2Fwww.baidu.com%2F%3Fa%3D.paipai.com%2f%26size%3D264x160%26time%3D0//解码后就是http://etg.qq.com/billboard/minsite/etg.shtml?fu=http://www.baidu.com/?a=.paipai.com/&size=264x160&time=0\n可能开发人员也发现了这个问题，正则确实不能这样写，于是几天后这个正则变成了现在这样：\nfu.search(/^http\\:\\/\\/[^.]*\\.paipai.com($|(\\/[^<>\\'\\\"]*))/)\n开发人员也觉得匹配.*不妥，于是换成在前面不能出现点号，那么他想，你可能就不能加载其他框架了嘛，因为 baidu.com是需要点的嘛，至少都需要一个点，如果没有点，那肯定就不能是合法的域名了。这个当然是开发人员自己想的，但是他可能忘了，还有个东西叫IP10进制表示法。就是说，http://1032300905/ 也是可以指向http://www.baidu.com/于是可以构造如下链接绕过限制：\nhttp://etg.qq.com/billboard/minsite/etg.shtml?fu=http%3A%2F%2F1032300905%2F%3Fa%3D.paipai.com%2f%26size%3D1024x768%26time%3D0//解码后就是,没有出现点号http://etg.qq.com/billboard/minsite/etg.shtml?fu=http://1032300905/?a=.paipai.com/&size=1024x768&time=0\n总结：DOM型跨站，正则表达是第一个要注意的东西，因为这则表达式确实有很多容易误用的地方。   漏洞证明：  加载百度\nhttp://etg.qq.com/billboard/minsite/etg.shtml?fu=http%3A%2F%2F1032300905%2F%3Fa%3D.paipai.com%2f%26size%3D1024x768%26time%3D0\n\n\n   修复方案：  修改正则表达式   版权声明：转载请注明来源 香草@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-06-03 15:47 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-03 11:33 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  洞主很细心啊，而且tips不少    \n     2014-06-03 11:43 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @疯狗 狗哥审帖真是神速啊，佩服。每次打开一个界面都习惯性的审查元素了，这个是职业病吗:)    \n     2014-06-03 13:57 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  求拜师~    \n     2014-06-04 09:05 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @D＆G 大牛别闹了    \n     2014-07-18 12:00 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  干的漂亮    \n     2014-07-19 21:19 |    \t\tcunzhangok \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | kail)\t\t \n  NIUBI    \n     2014-07-20 01:43 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  流弊    \n     2014-07-20 19:30 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  还是没有修复额    \n     2014-07-20 22:08 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  修了啊，新浪那个才是还没修复    \n     2014-07-29 12:18 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  顶    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}