{"id": 13657, "wybug_id": "wooyun-2015-0119261", "wybug_title": "美图内网漫游(沦陷大量内部系统、内部服务器权限、企业架构、企业邮箱等敏感信息）", "wybug_corp": "美图秀秀", "wybug_author": "phith0n", "wybug_date": "2015-06-09 15:03", "wybug_open_date": "2015-07-24 15:34", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["渗透测试思路", "安全意识不足"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-24：\t细节向公众公开  简要描述： 挖掘了半个月快，从一个小口子撕大，涉及美图内网各种敏感信息，多台服务器，近百个域名，可控制美图所有应用，替换各种二进制文件。本来想继续深入的，真的太累了，美图内网安全性做得虽然一般，但员工的安全性都还挺高的，弱口令基本没找见，包括各种系统也进行了一些IP的限制，渗透起来有一定难度。web漏洞包括一个后台未授权访问+SQL注入+任意文件上传getshell。内网的一堆，不说了。虽是一场没有做完的渗透，但挖的真的很累，求一个雷。 详细说明：  小口子就是任意文件读取，已经被交过了： WooYun: 美图秀秀某任意文件读取漏洞 所以我就不多说了，以下是渗透的一些笔记。（里面可能走了些弯路，一并发来了，都是这段时间边挖边记录的）文件读取大概翻了一遍，感觉并没有什么可以说的。查看了一些php源码，希望能找到一些漏洞，但是收获甚微（以下是一些读取到的文件）：\n\n基本都是谷歌翻到的.php后缀的文件，读取出来。但并没有找到漏洞。怎么办？下载美图秀秀APP，进行反编译： \n\n用JD-GUI打开，源码十分完整。\n\n找到好多处类似API，查看源码并没有发现漏洞。感觉这条路有点死。因此困扰了一段时间，后来找到一个目标：kankan.web.meitu.com，谷歌翻到的：\n\nduoduo.meitu.com，也就是kankan.web.meitu.com读取/acp/hand.php源码发现，这是一个后台，而且其检查登录的方式居然是前端认证！！\n\n一个后台未授权访问。所以只要禁用了javascript就可以查看后台：\n\n然后拿到了一些文件，其中主要文件是/acp/action.php这个漏洞也比较多呀……先来一处注入：http://kankan.web.meitu.com/acp/action.php?do=category.gettags&cid=1%20union%20select%201,2,version(),user()\n\n通过注入找到一些web_kankan库的信息，包括管理员密码：\n\n\n\n不过对于后续渗透测试并没有太大作用。先存着。另外找到一处任意文件上传：\n\n$f即为$_FILES，$p是$_POST，$kk->move就是move_uploaded_file，所以这里就是一个没有任何检查的任意文件上传。传上去一个文件，通过注入查看文件id为33：\n\n拿到webshell：http://kankan.web.meitu.com/images/catpic/big/33.php菜刀连接：\n\n可见权限很大，这也为后续渗透做足了铺垫。权限很大，可以查看所有web目录和里面的文件。Web目录下找到一处smtp配置：  set from=jiankong@meitu.com  set smtp=smtp.qiye.163.com  set smtp-auth-user=jiankong@meitu.com  set smtp-auth-password=84r4m7Hfyc6t  set smtp-auth=login成功登录企业邮箱：\n\n搜索password关键词：\n\n各种敏感信息。（大量服务器私钥和sudo密码、SSH密码）\n\ndisable_functions禁用了很多函数，但唯独缺了popen。和以前LNMP一键安装包一样的毛病。所以可以执行命令，弹了个shell回来：\n\n开启一个sock5代理，方便后续渗透：https://github.com/phith0n/ssocks5慢慢读其nginx配置文件，发现所有的php请求都交给内网的fastcgi处理了：\n\n于是我就有了继续的思路。只要向这些9000端口提交php代码，即可在其中执行了。具体思路在zone里很久以前就有人给出了：http://zone.wooyun.org/content/1060 我就不多说了，写了个脚本，利用proxychains4挂代理，fastcgi已经可以执行命令了：\n\n利用这个方式，本可以拿下内网很多机子。不幸地是我碰上了高版本的php-fpm，默认security.limit_extensions=.php，所以默认只有后缀是.php的文件我才能请求：\n\n否则会报告Access Denied：\n\n所以，我要拿某个机子的shell，需要先找到这个机子上一个已存在的.php文件。真是很鸡肋呀，这里需要绝对路径，但实际上美图秀秀的服务器都是关闭报错了（连phpinfo都禁用了），感觉很难找到绝对路径。路断了。后来想到，最早任意文件读取漏洞的时候，就读出了/etc/rsyncd.conf这个文件，也就是说内网是有rsync的，而且据我观察，已经拿下shell的这台服务器的rsyncd.conf里所有的host都没有设置密码，只是限制了IP必须是内网。那么，如果内网里其他机器也部署了rsync，很可能也没有设置密码，只是限制了内网，而我已经拿下了内网一台shell，进而就可以进行漫游了。首先，我的目标是data.meitu.com，这个站应该是内网里比较关键的站点。先得找到它的内网IP。这里涉及到一个找内网和外网对应IP的技巧。美图的机器涉及到几个网段，想到应该是多网卡的机器。而多网卡的机器在生产的时候的MAC地址一般都是连续的，所以如果找到两个IP它的mac地址连续，那95%就是一台机器的两张网卡了。如下图：\n\n是172.17.16.24，基本确定了。后来中途好几天因为有别的事就没看了，rsync自己不太熟。后来给自己vps搭了一个rsync异地备份的服务，知道了一些，这晚上又无聊要试下。\n\n果然连上了，见上图，列出目录。那我就可以拿下shell了，直接传webshell：rsync -vzrtopg --progress ./sxx.php 172.17.16.24::www/support.meitu.com\n\n传到了support.meitu.com目录下，直接连http:// support.meitu.com/sxx.php拿下:\n\n擦，看到绝对路径了，原来就是/www/醉了，再试下最早那个fastcgi：\n\n172.17.16.25已经可以执行命令了，但不知道为何24/23不能执行。所以现在有两种方式可以拿下内网各台服务器的shell：1.\tRsync内网未授权访问2.\tFastcgi内网未授权访问所以用这两种方法陆续拿下几台web服务器。23拿下shell：\n\n25拿下shell：\n\n24拿下shell：\n\n（弹shell的目的不是装逼，因为web端做了负债均衡，webshell经常出BUG，还有的web目录没权限，不如直接弹回来系统的shell）然后思路感觉又断了。因为不知道剩下几台服务器的rsync的模块名，所以没法连上这些rsync。先收集些信息吧。\n\n\n\n可以看到大量美图公司内部人员信息。成功登录一些邮箱：\n\nVPN入口：\n\n内部很多系统都是限制IP了（挂代理都上不去的那种），我能想到的有两条路：1.\t找到一个VPN账号2.\t提权服务器，修改black.conf正常情况下应该选择第一种，但就我看来，这个环境下，第二种反而更加合适。因为rsync是可以进行提权的。Rsync的权限是root:root，而且没有限制chroot，所以rsync是可以读写任意文件的。这样的话提权起来就很容易拉。既然没有限制chroot，于是我直接在可写目录写入一个ln -s /root/ ./jmproot然后rsync去同步这个目录，即可读写/root目录下所有文件：\n\n可见有计划任务文件crontab，只要覆盖这个文件或者/etc/crontab，即可以root权限反弹shell。或者直接修改限制IP的一些文件、服务器私钥，我就能直接登录服务器了。不过我就不敢做太敏感的操作了，点到为止，只是说明这个方法是可以提权的。（如果是恶意用户提下来以后，内网之后的路就平坦很多了）虽然不提权，但实际上内网还有好几台机器没有拿到shell，我用rsync读一下敏感文件，看能不能把其他几台开了rsync但猜不到模块名的机器拿下。在history中找到一台：rsync -av /www/dl.meitumobile.com/data/OTA/ 122.141.231.23::fotamobile_meitudata_com/这个IP：122.141.231.23，以前没见过的。果断用rsync写入webshell，然后将host绑定上：122.141.231.23  fotamobile.meitudata.com成功GETSHELL：\n\n这台服务器是储存美图秀秀所有二进制文件的：\n\n框起来的就是美图秀秀电脑版的地址，修改其中的软件就可以秒杀多少使用美图秀秀（包括美图全家的软件）的妹纸，想想就激动！！里面很容易改一下升级地址：\n\n但我也就敢说说，妹纸什么的和我无缘……继续深入。反弹一个shell发现失败，似乎不能连外网。直接在菜刀上看看吧：\n\n只有外网IP，果然不是和之前那些机子在一个地方。但用神器cloudeye发现它是可以连接外网的。还是再试试能不能弹shell。还是不行，这台机子很奇怪，明明有些地方是777的权限，但不能写文件。所以就不试了，翻翻没什么能帮助我继续渗透的信息，就不看了。在上面并没有发现什么特殊的东西，但我读了一下这台机子上的rsync配置文件发现了一个很大的问题：模块限制的IP并不一定是IP段，可能只是一个IP。而且美图内部模块名普遍都有www。这样的话，我就估计我没拿下的那几台服务器并不是因为模块名不是www，而是因为限制了IP，虽然我挂了代理，但代理的这台IP其实也是不允许访问www的。所以我下一步，就是多尝试一些机子，看是不是能够连上一些之前没连上的rsync。又发现几台：\n\n看了一下122.141.231.22、23、24、25包括之前的这些应该都是负债均衡8台一样的机子。里面文件都一样。直接写shell就可以，我就不尝试了。一下又拿到8台机子……笔记基本写到这里就停了，后面真的太累不想做了。给出一些继续渗透的思路：1.rsync提权，解除已控制的这些机器的IP访问限制，挖掘更多漏洞。2.根据已搜集的信息进行vpn登录。3.根据已搜集的信息进行邮箱登录。4.源码审计，挖掘内部系统漏洞。所以建议厂商根据我列出的这些安全威胁，进行相应修正。渗透过程中还发现内网很多管理员操作的时候会把一些数据库密码翘到命令行里，导致我连上了很多数据库，管理员这块也要注意一下。另外，涉及到数据的比较敏感，但我绝对没碰任何数据，这是一定的，全过程就是检测，以发现问题为主。这次渗透测试影响很广，数十个服务器，近百个网站。希望厂商重视。   漏洞证明：  见上面我留的一些webshell，厂商一定要记得删除，另外就没留任何后门了！如下：http://kankan.web.meitu.com/images/catpic/big/33.phphttp://d.meitudata.com/updateadmin/connect.phphttp://fotamobile.meitudata.com/fhgzs.phphttp://support.meitu.com/sxx.php   修复方案：  根据我提出的这些问题进行修正。主要就是rsync、fastcgi请厂商根据实际情况进行限制，最好加上密码，否则只要内网有一台计算机沦陷则整个内网就暴露在黑客眼中了。写了这么多，希望给高分呀~   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-09 15:32 厂商回复： 感谢白帽子的提交！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-09 15:04 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  关注下    \n     2015-06-09 15:32 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @xsser @疯狗  闪电无望了嘛……哭加了一下受影响的站点列表，其实挺多的。    \n     2015-06-09 15:34 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  @phith0n 下次记住不要匿名了，呜呜呜。。。    \n     2015-06-09 15:40 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @紫霞仙子 这也有影响！只是不想给关注者发一遍通知。。    \n     2015-06-09 15:43 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  闪一下    \n     2015-06-09 15:44 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:40        | 我是残废，啦啦啦啦)\t\t \n  ph妞简直666660    \n     2015-06-09 15:49 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @浩天 桑心，确认完了rank和wb不加倍了    \n     2015-06-09 15:50 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  @phith0n 哈哈，迟了一步！    \n     2015-06-09 15:51 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  P牛 也来渗透啦..    \n     2015-06-09 15:52 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:45        | 答案)\t\t \n  p牛 全能型人才    \n     2015-06-09 15:53 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  @phith0n 加倍的，等更新吧    \n     2015-06-09 16:22 |    \t\tHxai11 \t\t\t( 普通白帽子  |\t\t\t        Rank:1137 漏洞数:218        | 于是我们奋力向前游，逆流而上的小舟，不停...)\t\t \n  大牛你变了，不在刷审计了。。。    \n     2015-06-09 16:45 |    \t\t打电话叫人 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 没事，我打电话叫人)\t\t \n  完了，我的素颜照片    \n     2015-06-09 17:11 |    \t\tF4K3R \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:31        | 学习)\t\t \n  一眼看成美团了。。。。    \n     2015-06-09 17:53 |    \t\t卖C4的小男孩 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:6        | 啦啦啦   啦啦啦  我是一个卖C4的小行家!...)\t\t \n  大牛就是不一样啊    \n     2015-06-09 17:54 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  师傅开始搞站了    \n     2015-06-09 18:02 |    \t\tAppLeU0 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 代码审计入门)\t\t \n  师傅 你变了    \n     2015-06-09 18:14 |    \t\t冰麒麟 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 就算是男孩子,只要可爱就没问题了.)\t\t \n  审计牛日站就是厉害    \n     2015-06-09 18:15 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  求继续thinkphp啊，这一个洞能养活一批人    \n     2015-06-09 20:39 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @小川 thinkphp的钱都给你萌刷光了    \n     2015-06-19 15:48 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  真厉害，佩服~    \n     2015-06-19 15:55 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  @Noxxx 这个跟你们当年太像了    \n     2015-06-19 16:56 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  @小川 然而看不了..    \n     2015-06-20 03:09 |    \t\t鸟云厂商  \t\t\t( 核心白帽子 |\t\t\t        Rank:1313 漏洞数:146        | 中国菜鸟)\t\t \n  看完细节，才发现我已经不知不觉跪下了。。。    \n     2015-06-22 13:38 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @phith0n 送手机木有呀    \n     2015-06-26 23:59 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @mango 并没有>.<    \n     2015-06-27 00:08 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @phith0n  = =    \n     2015-07-02 08:41 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  收下我的膝盖    \n     2015-07-09 23:22 |    \t\t卖C4的小男孩 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:6        | 啦啦啦   啦啦啦  我是一个卖C4的小行家!...)\t\t \n  看不了。。好心急    \n     2015-07-10 12:03 |    \t\tgreg.wu \t\t\t( 普通白帽子  |\t\t\t        Rank:815 漏洞数:99        | 打酱油的~)\t\t \n  太厉害了    \n     2015-07-10 17:07 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  简直是太牛逼！    \n     2015-07-13 10:35 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  看完细节，才发现我已经不知不觉跪下了。。。     \n     2015-07-14 12:47 |    \t\tsql  \t\t\t( 核心白帽子 |\t\t\t        Rank:1127 漏洞数:145        | 带着两个MM（mysql,mssql），玩3p（asp,php...)\t\t \n  很好很强大,此文该闪两个雷    \n     2015-07-16 15:15 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  +1024    \n     2015-07-24 15:54 |    \t\tYxWa \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:5        | 颠儿颠儿的小跑中...)\t\t \n  1024    \n     2015-07-24 16:02 |    \t\t李旭敏 \t\t\t( 普通白帽子  |\t\t\t        Rank:469 漏洞数:71        | ฏ๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎...)\t\t \n  天了撸｀｀｀半个月撸的好带劲    \n     2015-07-24 16:10 |    \t\tfuckadmin \t\t\t( 普通白帽子  |\t\t\t        Rank:476 漏洞数:72        | 千里之堤溃于蚁穴)\t\t \n  好文，又涨姿势了。企业总以为将服务器放在内网或DMZ就很安全，一旦突破了边界，再进行纵向深入渗透，总会有意想不到的收获。    \n     2015-07-24 16:18 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  看完细节，才发现我已经不知不觉跪下了。。。这么吊的洞难道没钱?说实话，撸遍内网，很多细节，很多技巧，给个5k不为过，作为辛苦费，洞主666    \n     2015-07-24 16:18 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  看完细节，才发现我已经不知不觉跪下了。。。这么吊的洞难道没钱?说实话，撸遍内网，很多细节，很多技巧，给个5k不为过，作为辛苦费，洞主666    \n     2015-07-24 16:32 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @Mosuan 给了1K京东卡，我很满足了~    \n     2015-07-24 18:10 |    \t\t盛大网络(乌云厂商)\t\t \n  不错 不错    \n     2015-07-24 21:35 |    \t\tzhiher \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:4        | 学习社会工程学...渗透测试...代码审计...w...)\t\t \n  大赞    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}