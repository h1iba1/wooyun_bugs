{"id": 29092, "wybug_id": "wooyun-2015-0101728", "wybug_title": "ThinkPHP某处设计缺陷可导致getshell", "wybug_corp": "ThinkPHP", "wybug_author": "zcy", "wybug_date": "2015-03-16 23:07", "wybug_open_date": "2015-06-15 17:19", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件写入利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-17：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-15：\t细节向公众公开  简要描述： ThinkPHP某处设计缺陷可导致getshell 详细说明：  thinkphp中有个缓存函数S，在使用文件方式的缓存的时候，程序会有写出文件的操作。由于没做好过滤导致了代码执行。\n<?phpnamespace Home\\Controller;use Think\\Controller;class IndexController extends Controller {    public function index(){    \tif (!S('aaaaa')) {    \t\tS('aaaaa',$_GET['w']);    \t\techo 'cache ok';    \t}           }}?>\n判断缓存不存在则写出缓存文件。在使用文件缓存的时候，由于未对缓存文件设置访问权限。导致代码执行。浏览器中访问\nhttp://localhost:8888/thinkphp/Home/Index/index/?w=%0A;phpinfo%28%29;//\n\n\n缓存写出成功，然后访问应用目录下的runtime/temp目录，文件名为key的32位md5.\n\n成功执行phpinfo\n\n   漏洞证明：  thinkphp中有个缓存函数S，在使用文件方式的缓存的时候，程序会有写出文件的操作。由于没做好过滤导致了代码执行。\n<?phpnamespace Home\\Controller;use Think\\Controller;class IndexController extends Controller {    public function index(){    \tif (!S('aaaaa')) {    \t\tS('aaaaa',$_GET['w']);    \t\techo 'cache ok';    \t}           }}?>\n判断缓存不存在则写出缓存文件。在使用文件缓存的时候，由于未对缓存文件设置访问权限。导致代码执行。浏览器中访问\nhttp://localhost:8888/thinkphp/Home/Index/index/?w=%0A;phpinfo%28%29;//\n\n\n缓存写出成功，然后访问应用目录下的runtime/temp目录，文件名为key的32位md5.\n\n成功执行phpinfo\n\n   修复方案：  设置缓存文件的访问权限   版权声明：转载请注明来源 zcy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-15 17:19 厂商回复： 最新的版本支持设置 DATA_CACHE_KEY 参数后，可以避免文件名被猜测到，而且官方的安全部署建议是部署到非WEB访问目录，再说runtime目录也是可以定义的。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-16 23:12 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  mark    \n     2015-03-17 07:57 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  w    \n     2015-03-17 08:10 |    \t\t啊L川 \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:39        | 菜鸟 ，菜渣， 菜呀！)\t\t \n  mark    \n     2015-03-17 08:14 |    \t\tGreenVine \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:3        | Blooming like a flower!)\t\t \n  必须mark    \n     2015-03-17 09:24 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  利用条件不知道苛刻么？？    \n     2015-03-17 10:00 |    \t\t番茄炒蛋 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:31        | test)\t\t \n  必须mark    \n     2015-03-17 17:22 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  靠。这就给忽略了    \n     2015-03-17 17:23 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  @xsser @疯狗 有补rank的可能吗    \n     2015-03-17 22:06 |    \t\t上官元恒 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:3        | 屌丝程序员一枚，上能修电脑，下能装系统。)\t\t \n  mark    \n     2015-04-09 15:29 |    \t\tJonasen \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:9        | have no)\t\t \n  mark    \n     2015-04-15 08:59 |    \t\t带我玩 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 带我玩)\t\t \n  咋个不开放啊    \n     2015-04-30 22:59 |    \t\tJ4nker \t\t\t( 普通白帽子  |\t\t\t        Rank:136 漏洞数:35        | I have a dream)\t\t \n  叉，其实这个漏洞不算蛮严重漏洞的。有过滤的。而且很鸡肋    \n     2015-04-30 23:02 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  @J4nker - -在鸡肋也是漏洞啊    \n     2015-06-16 00:49 |    \t\tQ1NG \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:16        | 临 兵 斗 者 皆 阵 列 前 行 !)\t\t \n  mark    \n     2015-06-16 06:26 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:71        | I'm Me_Fortune)\t\t \n  @zcy 忽略的话还会给奖金么    \n     2015-06-16 13:42 |    \t\txsser_w \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:33        | 哎)\t\t \n  不建议这样的漏洞 归咎于厂商。。开发要是写出SQL注入我还能报给php官方团队让他们改进PHP呢    \n     2015-06-17 00:55 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  怎么知道key呢？@zcy    \n     2015-06-17 09:36 |    \t\t这只猪 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 南无阿弥陀佛！)\t\t \n  mark    \n     2015-06-17 12:54 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  @Jumbo 更适合在白盒里测试。哈哈    \n     2015-06-17 22:09 |    \t\tca1n \t\t\t( 普通白帽子  |\t\t\t        Rank:100 漏洞数:22        | not yet)\t\t \n  。。。。太扯了    \n     2015-09-22 19:12 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  每次生成的缓存的内容都可以操纵？还是说必须要按你这个格式去写才可以操纵内容？如果是要按你这样写才可以的话……那无异于一个留后门的手法而已吧，不会有人特别这样去写代码吧？    \n     2015-09-22 19:49 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @wefgod 总之我是没见过有cms这么写的。。S('x',$_GET['w']);    \n     2015-09-23 02:56 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  @wefgod 入库没过滤的话。查询出来在写入缓存不就可以了吗。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}