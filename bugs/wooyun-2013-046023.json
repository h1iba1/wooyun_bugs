{"id": 5448, "wybug_id": "wooyun-2013-046023", "wybug_title": "易思ESPCMS设计缺陷可登录任意账号", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "贱心", "wybug_date": "2013-12-15 16:15", "wybug_open_date": "2014-03-15 16:16", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-15：\t细节向公众公开  简要描述： 易思ESPCMS某处设计缺陷（验证过弱）可登录任意用户账号 详细说明：  易思ESPCMS cookie存在设计缺陷我看下cookie都有哪些参数\necisp_home_seccodeecisp_member_usernameecisp_member_info\n\nfunction member_cookieview($keyword = false) {\t\t$retrunstr = array();\t\t$retrunstr['username'] = $this->fun->eccode($this->fun->accept('ecisp_member_username', 'C'), 'DECODE', db_pscode);\t\t$user_info = explode('|', $this->fun->eccode($this->fun->accept('ecisp_member_info', 'C'), 'DECODE', db_pscode));\t\tlist($retrunstr['userid'], $retrunstr['alias'], $retrunstr['integral'], $retrunstr['mcid'], $retrunstr['email'], $retrunstr['lastip'], $retrunstr['ipadd'], $retrunstr['useragent'], $retrunstr['adminclassurl']) = $user_info;\t\t$retrunstr['userid'] = intval($retrunstr['userid']);\t\t$retrunstr['integral'] = intval($retrunstr['integral']);\t\t$retrunstr['mcid'] = intval($retrunstr['mcid']);\t\treturn !$keyword ? $retrunstr : $retrunstr[$keyword];\t}\n\nfunction in_center() {\t\tif ($this->CON['mem_isucenter']) {\t\t\tinclude_once admin_ROOT . 'public/uc_client/client.php';\t\t}\t\tparent::start_pagetemplate();\t\tparent::member_purview();\t\t$lng = (admin_LNG == 'big5') ? $this->CON['is_lancode'] : admin_LNG;\t\t$db_where = \"userid=$this->ec_member_username_id AND username='$this->ec_member_username' \";\t\techo $db_where;\t\t$db_table1 = db_prefix . 'member AS a';\t\t$db_table2 = db_prefix . 'member_value AS b';\t\t$db_sql = \"SELECT * FROM $db_table1 LEFT JOIN $db_table2 ON a.userid = b.userid  WHERE a.userid = $this->ec_member_username_id \";\t\t$rsMember = $this->db->fetch_first($db_sql);\t\t$rsMember['userid'] = $this->ec_member_username_id;\t\t$rsMember['rankname'] = $this->get_member_purview($rsMember['mcid'], 'rankname');\t\t$userid = intval($rsMember['userid']);\t\tif (empty($userid)) {\t\t\texit('user err!');\t\t}\t\t$db_table = db_prefix . \"order\";\t\t$db_where = \" WHERE userid=$userid\";\t\t$db_where2 = \" WHERE userid=$userid and ordertype=1\";\t\t$db_where3 = \" WHERE userid=$userid and ordertype=3\";\t\t$this->pagetemplate->assign('ordernum', $this->db_numrows($db_table, $db_where));\t\t$this->pagetemplate->assign('ordernum2', $this->db_numrows($db_table, $db_where2));\t\t$this->pagetemplate->assign('ordernum3', $this->db_numrows($db_table, $db_where3));\t\t$db_table = db_prefix . \"bbs\";\t\t$db_where = \" WHERE userid=$userid\";\t\t$this->pagetemplate->assign('messagenum', $this->db_numrows($db_table, $db_where));\t\t$templatesDIR = $this->get_templatesdir('member');\t\t$templatefilename = $lng . '/' . $templatesDIR . '/member_center';\t\t$this->pagetemplate->assign('out', 'center');\t\t$this->pagetemplate->assign('mlink', $this->mlink);\t\t$this->pagetemplate->assign('member', $rsMember);\t\t$this->pagetemplate->assign('path', 'member');\t\tunset($rsMember, $mlink, $LANPACK, $this->lng);\t\t$this->pagetemplate->display($templatefilename, 'center', false, null, admin_LNG);\t}\necisp_member_info的构成：\n$this->fun->setcookie('ecisp_member_info', $this->fun->eccode(\"500|$rsMember[alias]|$rsMember[integral]|$rsMember[mcid]|$rsMember[email]|$rsMember[lastip]|$ipadd|\" . md5($_SERVER['HTTP_USER_AGENT']) . '|' . md5(admin_ClassURL), 'ENCODE', db_pscode));\n从代码中可以看出验证用户真正用到的是userid也就是说cookie中ecisp_member_info真正起到作用的是userid部分userid只占用了cookie ecisp_member_info字符串中很少的字符而这一部分字符才是起到作用的，其他的无关紧要，这样的验证是不是很弱呢？那我们是不是可以去爆破它呢？我们拿官方演示站来做一下演示：   漏洞证明：  \n\n\n\n\n\n\n\n\n\n查询的 IP：36.40.79.103 来自：陕西省 电信GeoIP: Xian, ChinaChina Telecom查询的 IP：123.138.71.191 来自：陕西省西安市 联通GeoIP: Xian, ChinaChina Unicom Shannxi province network查询的 IP：123.245.145.94 来自：辽宁省 电信GeoIP: Shenyang, ChinaGuangZhouWanGuanGuoJiMaoYiFaZhanYouXianGongSi-SY-Luserid部分 最少两个字符理论上可以登录所有用户   修复方案：  null   版权声明：转载请注明来源 贱心@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-12-15 16:29 厂商回复： 感谢您对此漏洞的提供，非常感谢，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-15 16:18 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  这谁啊 换个名字吧 不雅    \n     2013-12-15 16:19 |    \t\t剑无名 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:32        | 此剑无名。)\t\t \n  @xsser 你直接改吧！粗暴管理员    \n     2013-12-15 17:01 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  哈哈哈    \n     2013-12-19 09:40 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  @xsser 哈哈哈哈哈哈 我知道这是谁    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}