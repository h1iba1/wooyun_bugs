{"id": 87371, "wybug_id": "wooyun-2016-0179441", "wybug_title": "某流控设备&amp;负载均衡器七处SQL注入&amp;一处getshell&amp;多处敏感信息泄漏(都无需登录)                                      ", "wybug_corp": "I-SDN", "wybug_author": "YY-2012", "wybug_date": "2016-02-29 12:00", "wybug_open_date": "2016-06-02 19:30", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误", "设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-07：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-02：\t细节向公众公开  简要描述： 十几万的设备你敢买吗？ 详细说明：  第一处注入/analytics/bal/bal_chart_line_status.php\n//********************************************流量上行和下行统计**********************************************//\tif($_GET[\"act\"]==\"hours\"){\t\t//按小时统计上行平均流量和下行平均流量，每分钟一笔数据\t\t$value=$_GET[\"val\"];\t\t$date=$_GET[\"date\"];\t\tif($value != \"all\"){\t\t\t//查询条件不为空，查询域名的访问量\t\t\t$and=\" and app_name = '\".$value.\"' \";\t\t}\t\tif($date==\"\"){\t\t\t$sql=\"select host_ip,date_format(curr_time,'%H:%i') tm,round(sum(aver_tx)/1024,2) txcount,round(sum(aver_rx)/1024,2) rxcount from t_tjbal_host where \t\t\t\tcurr_time between date_format(date_add(now(),interval -1 hour),'%Y-%m-%d %H:%i:00') \t\t\t\tand date_format(now(),'%Y-%m-%d %H:%i:59') \".$and.\"  group by date_format(curr_time,'%H:%i'),host_ip \t\t\t\torder by host_ip asc,curr_time asc \";\t\t}else{\t\t\t$sql=\"select host_ip,date_format(curr_time,'%H:%i') tm,round(sum(aver_tx)/1024,2) txcount,round(sum(aver_rx)/1024,2) rxcount from t_tjbal_host where \t\t\t\tcurr_time between date_format('\".$date.\"','%Y-%m-%d %H:%i:00') \t\t\t\tand date_format(date_add('\".$date.\"',interval +1 hour),'%Y-%m-%d %H:%i:59') \".$and.\"  \t\t\t\tgroup by date_format(curr_time,'%H:%i'),host_ip order by host_ip asc,curr_time asc \";\t\t}//\t\tprint $sql;\n第二处注入/analytics/analytics_firewall.php\nif ( isset ( $_POST[\"action\"] ) && $_POST[\"action\"]==\"serchFirewall\"){\t\t$serchtype = $_POST[\"serchType\"];\t\t$serchname = $_POST[\"serchinput\"];\t}else{\t\t$serchtype = \"type0\";\t\t//分页提交\t\tif ( isset ( $_POST[\"action\"] ) && $_POST[\"action\"]==\"GO\"){\t\t\t$page = $_POST[\"p\"];\t\t\t$serchtype = $_POST[\"ptype\"];\t\t\t$serchname = $_POST[\"pname\"];\t\t}\t\t\t\tif ( isset ( $_GET[\"p\"] )){\t\t\t$page = $_GET[\"p\"];\t\t\t$serchtype = $_GET[\"serchType\"];\t\t\t$serchname = $_GET[\"serchinput\"];\t\t}\t}\t\t$db = new dbBase();\t//数据库连接\t$iRetCon = $db -> dbConnect();\tif($iRetCon!=1)\t{\t\tprint \"数据连接失败！\";\t\treturn \"\";\t}\t$and=\"\";\tif($serchname!=\"\"){\t\tif($serchtype == \"type0\"){\t\t\t//源地址\t\t\t$and = \" and src_ip like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type1\"){\t\t\t//目标地址\t\t\t$and = \" and dst_ip like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type2\"){\t\t\t//规则\t\t\t$and = \" and fire_wall_name like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type3\"){\t\t\t//网口\t\t\t$and = \" and network_card like '%\".$serchname.\"%' \";\t\t}\t}\t$sql=\"select a.host_name,left(a.fire_wall_name,(LENGTH(a.fire_wall_name)-2)) wallname,**.**.**.**work_card,a.src_mac,a.dst_mac,\t\ta.src_ip,a.dst_ip,a.data_len,a.protocol,a.src_port,a.dst_port,\t\ta.log_time logtime ,right(fire_wall_name,1) stat \t\tfrom t_log_firewall a  where 1=1 \".$and.\" order by log_time desc limit \".($page-1)*$pageSize.\", \".$pageSize;//\tprint $sql;\n第三处注入/analytics/bal/bal_chart_line.php\nif($_GET[\"act\"]==\"hours\"){\t\t//按小时对bal总数量进行统计及单个域名的访问量\t\t$value=$_GET[\"val\"];\t\tif($value != \"all\"){\t\t\t//查询条件不为空，查询域名的访问量\t\t\t$and=\" and application_name = '\".$value.\"' \";\t\t}\t\t$sql=\"select date_format(log_time,'%H:%i') time,sum(app_count) dcount from t_tjbal_time_minute where \t\t\tlog_time between date_format(date_add(now(),interval -2 hour),'%Y-%m-%d %H:%i:00') \t\t\tand date_format(now(),'%Y-%m-%d %H:%i:59') \".$and.\" group by date_format(log_time,'%H:%i') order by log_time asc \";\t\t$arrFi = every5Minute();\t\t$datajson = lineJson($sql,$arrFi);\t\tprint $datajson;\t}else if($_GET[\"act\"]==\"day\"){\t\t//按天对bal总数量进行统计及单个域名的访问量\t\t$value=$_GET[\"val\"];\t\tif($value != \"all\"){\t\t\t//查询条件不为空，查询域名的访问量\t\t\t$and = \" and application_name = '\".$value.\"' \";\t\t}\t\t$sql=\"select concat(date_format(date_add(log_time,interval -2 minute),'%H'),':00') time ,sum(app_count) dcount from t_tjbal_time_minute where \t\t\tdate_add(log_time,interval -2 minute) between date_format(date_add(now(),interval -1 day),'%Y-%m-%d %H:00:00')\t\t\tand date_format(date_add(now(),interval -1 hour),'%Y-%m-%d %H:59:59')\".$and.\" \t\t\tgroup by date_format(date_add(log_time,interval -2 minute),'%H') order by log_time asc \";\t\t$arrFi = every1Hours();\t\t$datajson = lineJson($sql,$arrFi);\t\tprint $datajson;\t}else if($_GET[\"act\"]==\"week\"){\t\t//按周对bal总数量进行统计及单个域名的访问量\n第四处注入/analytics/bal/bal_chart_map.php\nif($_GET[\"act\"]==\"hours\"){\t\t$value=$_GET[\"val\"];\t\tbalMapMinute($value);\t}else if($_GET[\"act\"]==\"day\"){\t\t$value=$_GET[\"val\"];\t\tbalLineDays($value);\t}else if($_GET[\"act\"]==\"week\"){\t\t$value=$_GET[\"val\"];\t\t\tbalLineWeeks($value);\t}else if($_GET[\"act\"]==\"month\"){\t\t$value=$_GET[\"val\"];\t\tbalLineMonth($value);\t}else if($_GET[\"act\"]==\"year\"){\t\t$value=$_GET[\"val\"];\t\tbalLineYears($value);\t}\t/**\t * 实时查询bal的总数（按照区域查询）实时查询\t */\tfunction balMapMinute($value){\t\t$db = new dbBase();\t\t//数据库连接\t\t$iRetCon = $db -> dbConnect();\t\tif($iRetCon!=1){\t\t\tprint \"数据连接失败！\";\t\t\treturn;\t\t}\t\t//查询全球地图信息\t\t$worldArea = getWorldMapDict($db);\t\t//查询世界的数据（各个区域所有的域名数量）\t\tif($value != \"all\"){\t\t\t//查询条件不为空，查询域名的访问量\t\t\t$and=\" and application_name = '\".$value.\"' \";\t\t}\t\t$sql=\"select remark ,sum(app_count) dnum from t_sys_dict a ,t_tjbal_time_minute b\t\t\twhere  area!='-' and area!='' and remark!='' and a.short_name=substring_index(b.area,'-',1) and\t\t\tlog_time between date_format(date_add(now(),interval -2 hour),'%Y-%m-%d %H:%i:00') \t\t\tand date_format(now(),'%Y-%m-%d %H:%i:59') \".$and.\" group by remark\";\t\t$worldData = getWorldMapData($db,$sql);\t\t\t\t//查询中国的信息\t\t$sqlc = \"select full_name,sum(app_count) dnum from t_sys_dict a ,t_tjbal_time_minute b where \t\t\ta.code like '%ZG%' and code!='ZG' and substring_index(b.area,'-',1)='CN' and a.short_name=substring(b.area,4) and\t\t\tlog_time between date_format(date_add(now(),interval -2 hour),'%Y-%m-%d %H:%i:00') \t\t\tand date_format(now(),'%Y-%m-%d %H:%i:59') \".$and.\" group by full_name \";\t\t$chinaData = getChinaMapData($db,$sqlc);\n第五处注入/analytics/analytics_bal.php\nif ( isset ( $_POST[\"action\"] ) && $_POST[\"action\"]==\"serchBal\"){\t\t$serchtype = $_POST[\"serchType\"];\t\t$serchname = $_POST[\"serchinput\"];\t\t$timestat =  $_POST[\"serchStart\"];\t\t$timeend =  $_POST[\"serchEnd\"];\t}else{\t\t$serchtype = \"type0\";\t}//\tprint \"=====>\".$_POST[\"action\"].\"<========\";\t\t//分页post提交\tif ( isset ( $_POST[\"action\"]) && $_POST[\"action\"]==\"GO\"){\t\t$page = $_POST[\"p\"];\t\t$serchtype = $_POST[\"ptype\"];\t\t$serchname = $_POST[\"pname\"];\t\t$timestat =  $_POST[\"pStart\"];\t\t$timeend =  $_POST[\"pEnd\"];//\t\tprint \"==>\".$serchtype.\"==>\".$serchname.\"==>\".$timestat.\"==>\".$timeend;\t}\t//分页get\tif ( isset ( $_GET[\"p\"] )){\t\t$page = $_GET[\"p\"];\t\t$serchtype = $_GET[\"serchType\"];\t\t$serchname = $_GET[\"serchinput\"];\t\t$timestat = $_GET[\"stime\"];\t\t$timeend = $_GET[\"etime\"];\t}\t$db = new dbBase();\t//数据库连接\t$iRetCon = $db -> dbConnect();\tif($iRetCon!=1)\t{\t\tprint \"数据连接失败！\";\t\treturn \"\";\t}\t$and=\"\";\tif($serchname!=\"\"){\t\tif($serchtype == \"type0\"){\t\t\t//策略名称\t\t\t$and .= \" and application_name like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type1\"){\t\t\t//源地址\t\t\t$and .= \" and src_ip like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type2\"){\t\t\t//目标地址\t\t\t$and .= \" and server_name like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type3\"){\t\t\t//状态\t\t\t$and .= \" and status like '%\".$serchname.\"%' \";\t\t}\t}\tif($timestat!=\"\"){\t\t$and .= \" and log_time >= date_format('\".$timestat.\"','%Y-%m-%d %H:%i:00') \";\t}\tif ($timeend!=\"\"){\t\t$and .= \" and log_time <= date_format('\".$timeend.\"','%Y-%m-%d %H:%i:59') \";\t}\t\t\t$sql=\"select host_name,application_name,server_name,src_ip,src_port,action,access_target,datalen,dealtime,status,\t\tlog_time logtime,case when length(access_target)>40 then concat(substr(access_target,1,40),'......') else access_target end netar \t\tfrom t_log_load a where 1=1 \".$and.\"\t\torder by log_time desc limit \".($page-1)*$pageSize.\", \".$pageSize;\t//\tprint $sql.\"<br/>\";\t\t$arrlist = $db->querySqlArray($sql);\t\t\t//查询总页数\t$sqlcou = \"select count(1) cou from t_log_load a  where 1=1 \".$and;\t//\tprint $sqlcou.\"<br/>\";\n第六处注入/analytics/dns/dns_chart_line.php\nif($_GET[\"act\"]==\"hours\"){\t\t/**\t\t * 按小时对dns总数量进行统计及单个域名的访问量\t\t */\t\t$value=$_GET[\"val\"];\t\tif($value != \"\"){\t\t\t//查询条件不为空，查询域名的访问量\t\t\t$and=\" and domain_name like '%\".$value.\"' \";\t\t}//\t\t$sql=\"select date_format(log_time,'%H:%i') time,sum(domain_count) dcount from t_tjdns_time_minute where //\t\t\tdate_format(log_time,'%Y-%m-%d %H:%i') between date_format(date_add(now(),interval -2 hour),'%Y-%m-%d %H:%i') //\t\t\tand date_format(now(),'%Y-%m-%d %H:%i') \".$and.\" group by date_format(log_time,'%H:%i') order by log_time asc \";\t\t$sql=\"select date_format(log_time,'%H:%i') time,sum(domain_count) dcount from t_tjdns_time_minute where \t\t\tlog_time between date_format(date_add(now(),interval -2 hour),'%Y-%m-%d %H:%i:00') \t\t\tand date_format(now(),'%Y-%m-%d %H:%i:59') \".$and.\" group by date_format(log_time,'%H:%i') order by log_time asc \";\t\t$arrFi = every5Minute();\t\t$rsjson = lineJson($sql,$arrFi);\t\tprint $rsjson;\n第七处注入/analytics/analytics_dns_log.php\n<?php \tinclude_once \"./dbcon/dbBase.php\";\tinclude_once \"./dns/time.php\";\tdate_default_timezone_set('Asia/Shanghai');\t\t$serchname = \"\";\t$and=\"\";\tif(isset ( $_GET[\"act\"] )){\t\t//折线图加载log\t\t$serchname = $_GET[\"dns\"];\t\t$strtime = getTime($_GET[\"act\"],$_GET[\"date\"]);\t\t$arrTime = explode(\"#\",$strtime);\t\t$timestat = $arrTime[0];\t\t$timeend = $arrTime[1];\t}else if(isset ( $_GET[\"mapact\"] ) && $_GET[\"mapact\"] ==\"maplog\"){\t\t//地图加载log日志\t\t$country = $_GET[\"cy\"];\t\t//print $country.\"<=======\";\t\t$dnsname = $_GET[\"dname\"];\t\t$timttype = $_GET[\"time\"];\t\t$serchname = $dnsname;\t\t$arrMapTime = explode(\"#\",getMapTime($timttype));\t\t$timestat = $arrMapTime[0];\t\t$timeend = $arrMapTime[1];//\t\tif($country == \"中国\"){//\t\t\t$and .=\" and substring_index(substr(client_ip_ctname,4), '-', 1) = (select short_name from t_sys_dict a where full_name='\".$country.\"') \";//\t\t}else{//\t\t\t$and .=\" and substring_index(client_ip_ctname, '-', 1) = (select short_name from t_sys_dict a where full_name='\".$country.\"') \";//\t\t}\t}else{\t\t$timestat = date(\"Y-m-d\").\" 00:00\";\t\t$timeend =  date(\"Y-m-d H:i\") ;\t}\t\t$page= 1;\t$pageSize = 20;\tif ( isset ( $_POST[\"action\"] ) && $_POST[\"action\"]==\"serchDns\"){\t\t$serchtype = $_POST[\"serchType\"];\t\t$serchname = $_POST[\"serchinput\"];\t\t$timestat = $_POST[\"serchStart\"];\t\t$timeend =  $_POST[\"serchEnd\"];\t\t$country = $_POST[\"country\"];\t}else{//\t\tif($dnsname!=\"\"){//\t\t\t$serchtype = \"type1\";//\t\t}else{//\t\t\t$serchtype = \"type0\";//\t\t}\t\t$serchtype = \"type0\";\t\t//分页提交点击GO\t\tif ( isset ( $_POST[\"action\"] ) && $_POST[\"action\"]==\"GO\"){\t\t\t$page = $_POST[\"p\"];\t\t\t$serchtype = $_POST[\"ptype\"];\t\t\t$serchname = $_POST[\"pname\"];\t\t\t$timestat = $_POST[\"pStart\"];\t\t\t$timeend =  $_POST[\"pEnd\"];\t\t\t$country =  $_POST[\"cy\"];\t\t}\t\t//点击翻页\t\tif ( isset ( $_GET[\"p\"] )){\t\t\t$page = $_GET[\"p\"];\t\t\t$serchtype = $_GET[\"serchType\"];\t\t\t$serchname = $_GET[\"serchinput\"];\t\t\t$timestat = $_GET[\"stime\"];\t\t\t$timeend =  $_GET[\"etime\"];\t\t\t$country =  $_GET[\"cy\"];\t\t}\t}\t\t$db = new dbBase();\t//数据库连接\t$iRetCon = $db -> dbConnect();\tif($iRetCon!=1)\t{\t\tprint \"数据连接失败！\";\t\treturn \"\";\t}\t\tif($serchname!=\"\"){\t\tif($serchtype == \"type0\"){\t\t\t//域名\t\t\t$and .= \" and domain_name like '%\".$serchname.\"%' \";\t\t}else if($serchtype == \"type1\"){\t\t\t//来源地址\t\t\t$and .= \" and client_ip like '%\".$serchname.\"%' \";\t\t}\t}\t\tif($country!=\"\"){\t\t$sqlcy = \"select short_name from t_sys_dict a where full_name='\".$country.\"'\";\t\t$arrCy = $db->querySqlArray($sqlcy);\t\tif(strlen($arrCy[0][\"short_name\"])>2){\t\t\t$and .=\" and substring_index(substr(client_ip_ctname,4), '-', 1) = '\".$arrCy[0][\"short_name\"].\"' \";\t\t}else if(strlen($arrCy[0][\"short_name\"])==2){\t\t\t$and .=\" and substring_index(client_ip_ctname, '-', 1) = '\".$arrCy[0][\"short_name\"].\"' \";\t\t}\t}\n以上注入针对I-SDN负载均衡器案例：\n**.**.**.**/**.**.**.**/\n一处getshell      地址/test/progressbar/target.php\n<?phpif($_SERVER['REQUEST_METHOD']=='POST') {  move_uploaded_file($_FILES[\"test_file\"][\"tmp_name\"], \"c:\\\\sw\\\\wamp\\\\www\\\\\" . $_FILES[\"test_file\"][\"name\"]);  echo \"<p>File uploaded.  Thank you!</p>\";}?>\n以上getshell针对I-SDN流控设备&I-SDN负载均衡器案例：\n**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/test/\n   漏洞证明：  随便选取三处作验证：/analytics/bal/bal_chart_line_status.php?act=hours&val=1&date=1\n\n/analytics/analytics_firewall.php?p=&serchType=type0&serchinput=1\n\n/analytics/bal/bal_chart_map.php?act=hours&val=1\n\nGETSHELL地址/test/progressbar/target.php：\n\n\n\n\n\n\n\n整设备目录遍历导致多处敏感信息泄漏：\n\n\n\n\n\n\n\n以上目录遍历针对I-SDN流控设备&I-SDN负载均衡器案例：\n**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/**.**.**.**/test/\n还有部分版本存在任意文件修改&目录遍历（AjaXplorer功能为未授权访问导致）\n\n针对以上案例：\n**.**.**.**/exploer/#0**.**.**.**/exploer/#0**.**.**.**/exploer/#0**.**.**.**/exploer/#0**.**.**.**/exploer/#0\n   修复方案：  联系厂商   版权声明：转载请注明来源 YY-2012@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2016-03-04 19:29 厂商回复： CNVD未直接复现所述漏洞情况，暂未建立与软件生产厂商或网站管理单位的直接处置渠道，待认领。 最新状态： 2016-03-04：正尝试建立与软件生产厂商上海驾驭网络科技有限公司的联系机制,待处置.  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}