{"id": 916, "wybug_id": "wooyun-2014-073041", "wybug_title": "phpyun设计缺陷可用别的账户money付款，清空别的账户money为0", "wybug_corp": "php云人才系统", "wybug_author": "x44s", "wybug_date": "2014-08-21 12:05", "wybug_open_date": "2014-10-05 12:06", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向公众公开  简要描述： 后台在处理订单的时候，直接获取cookie中的uid，此uid可以伪造成他人的uid，导致可用他人的money付款。经过测试，虽然自己并不能获得支付成功的积分，但是可以扣除他人账户余额。 详细说明：  漏洞文件\\api\\tenpay\\index.php:\n$sql=$db->query(\"select * from `\".$db_config[\"def\"].\"company_order` where `order_id`='$_POST[dingdan]'\");$row=mysql_fetch_array($sql); //通过订单编号获取点单价格$userid=(int)$_COOKIE['uid']; //获取cookie中的uid ,此uid可以伪造成别人的uid !!!!if($_POST['balance']&&$userid){\t$c_sql=$db->query(\"select `pay` from `\".$db_config[\"def\"].\"company_statis` where `uid`='\".$userid.\"'\"); //通过伪造的uid读取出别人的账户余额\t$company_statis=mysql_fetch_array($c_sql);\tif($company_statis['pay']>=$row['order_price']){ //如果账户余额大于付款金额\t\t$up_sql=$db->query(\"update `\".$db_config[\"def\"].\"company_statis` set `pay`=`pay`-'\".$row['order_price'].\"' where `uid`='\".$userid.\"'\"); //通过伪造的uid付款\t\tmysql_fetch_array($up_sql);\t\t$up_order=$db->query(\"update `\".$db_config[\"def\"].\"company_order` set `order_price`='0'\".$invoice_title.\" where `order_id`='\".$row['order_id'].\"'\");\t\tmysql_fetch_array($up_order);\t\t$price=$row['order_price'];\t}else{ //如果账户余额小于付款金额                \t\t$price=$company_statis['pay'];\t\t$up_sql=$db->query(\"update `\".$db_config[\"def\"].\"company_statis` set `pay`='0' where `uid`='\".$userid.\"'\"); //直接清空账户余额位0\t\t$up_sql_status=mysql_fetch_array($up_sql);\t\t$up_order=$db->query(\"update `\".$db_config[\"def\"].\"company_order` set `order_price`=`order_price`-'\".$price.\"'\".$invoice_title.\" where `order_id`='\".$row['order_id'].\"'\");\t\tmysql_fetch_array($up_order); \t}\n   漏洞证明：  注册一个充了值的账户test2,可用余额为100:\n\n注册一个账户test5,提交一个订单：\n\n\n\n付款时抓包将cookie中uid改为test2的uid:\n\n通过test2付款成功:\n\n如果账户余额小于付款金额会重置账户余额为0,test5提交一个价格很高的订单让test2付款\n\n同样抓包修改uid为test2的uid，结果\n\ntest2的消费记录:\n\n   修复方案：     版权声明：转载请注明来源 x44s@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-08-21 21:16 厂商回复： 感谢您的提供，我们会尽快修复! 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}