{"id": 3549, "wybug_id": "wooyun-2014-065005", "wybug_title": "CUUMALL 注入 1-4", "wybug_corp": "cuumall.com", "wybug_author": "′雨。", "wybug_date": "2014-06-15 12:24", "wybug_open_date": "2014-06-16 17:09", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-16：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 来了个新厂商。 挖一下把。    开放+封闭源代码封闭源代码，普通用户使用加密后的代码，付费用户使用开放的源代码，使商城更安全对于我这种屌丝只能用免费版 就是zend后的代码。不过还是有几个文件没zend。 就只看这几个文件了。 详细说明：  找了几个没zend的文件来看看 。第一处ali/notify_url.php中\n$alipayNotify = new AlipayNotify($aliapy_config);$verify_result = $alipayNotify->verifyNotify();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代\t\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表    $out_trade_no\t= $_POST['out_trade_no'];\t    //获取订单号    $trade_no\t\t= $_POST['trade_no'];\t    \t//获取支付宝交易号    $total_fee\t\t= $_POST['total_fee'];\t\t\t//获取总价格    if($_POST['trade_status'] == 'TRADE_FINISHED' ||$_POST['trade_status'] == 'TRADE_SUCCESS') {    //交易成功结束\t\t//判断该笔订单是否在商户网站中已经做过处理（可参考“集成教程”中“3.4返回数据处理”）\t\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t\t//如果有做过处理，不执行商户的业务程序            $arr=include(\"../Conf/config.php\");\t\t\t@mysql_connect($arr[\"DB_HOST\"].\":\".$arr[\"DB_PORT\"],$arr[\"DB_USER\"],$arr[\"DB_PWD\"]);\t\t\t@mysql_select_db($arr[\"DB_NAME\"]);\t\t\t$sql=\"update \".$arr[\"DB_PREFIX\"].\"m_order set orderstate=1,paytime='\".date('Y-m-d H:i:s').\"'  where orderid='\".$out_trade_no.\"'\";\n\n$verify_result = $alipayNotify->verifyNotify();if($verify_result) {\n\nfunction verifyNotify(){\t\tif(empty($_POST)) {//判断POST来的数组是否为空\t\t\treturn false;\t\t}\t\telse {\t\t\t//生成签名结果\t\t\t$mysign = $this->getMysign($_POST);\t\t\t\t\t\t//获取支付宝远程服务器ATN结果（验证是否是支付宝发来的消息）\t\t\t$responseTxt = 'true';\t\t\tif (! empty($_POST[\"notify_id\"])) {$responseTxt = $this->getResponse($_POST[\"notify_id\"]);}\t\t\t\t\t\t//写日志记录\t\t\t//$log_text = \"responseTxt=\".$responseTxt.\"\\n notify_url_log:sign=\".$_POST[\"sign\"].\"&mysign=\".$mysign.\",\";\t\t\t//$log_text = $log_text.createLinkString($_POST);\t\t\t//logResult($log_text);\t\t\t\t\t\t//验证\t\t\t//$responsetTxt的结果不是true，与服务器设置问题、合作身份者ID、notify_id一分钟失效有关\t\t\t//mysign与sign不等，与安全校验码、请求时的参数格式（如：带自定义参数等）、编码格式有关\t\t\tif (preg_match(\"/true$/i\",$responseTxt) && $mysign == $_POST[\"sign\"]) {\t\t\t\treturn true;\t\t\t} else {\t\t\t\treturn false;\t\t\t}\t\t}\n这里有个验证 验证的是我们post的sign 是否与生成的sign相等 生成的是md5的这里自己生成一个sign 就能通过验证。 然后直接把$out_trade_no带入查询 造成了注入。\n\n——————————————————————————————————————————第二处\nali/return_url.php $verify_result = $alipayNotify->verifyReturn();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代码\t\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表    $out_trade_no\t= $_GET['out_trade_no'];\t//获取订单号    $trade_no\t\t= $_GET['trade_no'];\t\t//获取支付宝交易号    $total_fee\t\t= $_GET['total_fee'];\t\t//获取总价格    if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {\t\t//判断该笔订单是否在商户网站中已经做过处理（可参考“集成教程”中“3.4返回数据处理”）\t\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t\t//如果有做过处理，不执行商户的业务程序\t\t\t$arr=include(\"../Conf/config.php\");\t\t\t@mysql_connect($arr[\"DB_HOST\"].\":\".$arr[\"DB_PORT\"],$arr[\"DB_USER\"],$arr[\"DB_PWD\"]);\t\t\t@mysql_select_db($arr[\"DB_NAME\"]);\t\t\t$sql=\"update \".$arr[\"DB_PREFIX\"].\"m_order set orderstate=1,paytime='\".date('Y-m-d H:i:s').\"', where orderid='\".$out_trade_no.\"'\";\t\t\t  mysql_query($sql);\n这里是跟第一处是差不多的。 只是换成了GET。。。第三处。alipay/notify_url.php话说你们这程序 有ali 和 alipay两个目录。 都是支付宝支付的文件。里面的文件都是一样的， 搞不懂你们。\n$alipayNotify = new AlipayNotify($aliapy_config);$verify_result = $alipayNotify->verifyNotify();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代\t\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表    $out_trade_no\t= $_POST['out_trade_no'];\t    //获取订单号    $trade_no\t\t= $_POST['trade_no'];\t    \t//获取支付宝交易号    $total_fee\t\t= $_POST['total_fee'];\t\t\t//获取总价格    if($_POST['trade_status'] == 'TRADE_FINISHED' ||$_POST['trade_status'] == 'TRADE_SUCCESS') {    //交易成功结束\t\t//判断该笔订单是否在商户网站中已经做过处理（可参考“集成教程”中“3.4返回数据处理”）\t\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t\t//如果有做过处理，不执行商户的业务程序            $arr=include(\"../Conf/config.php\");\t\t\t@mysql_connect($arr[\"DB_HOST\"].\":\".$arr[\"DB_PORT\"],$arr[\"DB_USER\"],$arr[\"DB_PWD\"]);\t\t\t@mysql_select_db($arr[\"DB_NAME\"]);\t\t\t$sql=\"select * from \".$arr[\"DB_PREFIX\"].\"m_pay where ordernum=\".$out_trade_no;\n第四处 alipay/return_url.php\n$verify_result = $alipayNotify->verifyReturn();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代码\t\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表    $out_trade_no\t= $_GET['out_trade_no'];\t//获取订单号    $trade_no\t\t= $_GET['trade_no'];\t\t//获取支付宝交易号    $total_fee\t\t= $_GET['total_fee'];\t\t//获取总价格    if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {\t\t//判断该笔订单是否在商户网站中已经做过处理（可参考“集成教程”中“3.4返回数据处理”）\t\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t\t//如果有做过处理，不执行商户的业务程序\t\t\t$arr=include(\"../Conf/config.php\");\t\t\t@mysql_connect($arr[\"DB_HOST\"].\":\".$arr[\"DB_PORT\"],$arr[\"DB_USER\"],$arr[\"DB_PWD\"]);\t\t\t@mysql_select_db($arr[\"DB_NAME\"]);\t\t\t$sql=\"select * from \".$arr[\"DB_PREFIX\"].\"m_pay where ordernum=\".$out_trade_no;\t\t\t$result=mysql_query($sql);\t\t\t//--------\t\t\t$rss=mysql_fetch_array($result);\t\t\tif($rss[\"paystate\"]==0)\t\t\t{\t\t\t  $sql1=\"update \".$arr[\"DB_PREFIX\"].\"m_pay set trade_no='\".$trade_no.\"',payallmoney=paymoney+payallmoney,gettime='\".date('Y-m-d H:i:s').\"',paystate=1 where ordernum='\".$out_trade_no.\"'\";\t\t\t  mysql_query($sql1);\t\t\t  //-----\t\t\t  //echo $sql1.\"<br>\";\t\t\t  $sql2=\"select * from \".$arr[\"DB_PREFIX\"].\"m_member where username='\".$rss[\"username\"].\"'\";\n\n\n这个没单引号保护。  而且可以用到下面的update bu多说了。   漏洞证明：  见上面。   修复方案：  对一些该intval的就intval。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-16 17:09 厂商回复：  最新状态： 2014-06-16：感谢楼主对CuuMall的关注，不过楼主的测试方法是有问题的。支付宝的验签机制是基于不知道商城使用者的key的情况下进行验签的，支付宝提供的几个参数中，分别有PartnerID与Key，PartnerID与Key是对应关系，楼主的测试方法中描述“这里有个验证 验证的是我们post的sign 是否与生成的sign相等 生成的是md5的 这里自己生成一个sign 就能通过验证”，这里测试的方法有问题，我们使用抓包工具查看客户端提交的网址：GET /gateway.do?_input_charset=utf-8&body=%E5%95%86%E5%9F%8E%E5%9C%A8%E7%BA%BF%E6%94%AF%E4%BB%98&notify_url=http%3A%2F%2Fdemo.cuumall.com%2Fali%2Fnotify_url.php&out_trade_no=1402892912300748&partner=2088002189820220&payment_type=1&return_url=http%3A%2F%2Fdemo.cuumall.com%2Fali%2Freturn_url.php&seller_email=XXX@163.com&service=create_direct_pay_by_user&subject=%E5%95%86%E5%9F%8E%E5%9C%A8%E7%BA%BF%E6%94%AF%E4%BB%98&total_fee=23&sign=ad9dc7e90e75a792fe8a8a0e2c3601ec&sign_type=MD5这里的sign是做了签名的，这里的签名方式根据支付宝接口文档说明以及提供的代码来看，是将所有参数按首字母排序后加上key进行md5的，然后提交到支付宝服务器，支付宝服务器根据收到的PartnerID对应的key来将要返回的数据进行加密后返回，其中有项参数必定是随机的，商城的服务器根据得到的各项参数，结合本地存储的key，进行MD5加密后，再与收到的sign进行对比，如果匹配才能进行下一步，如果是这样的话，订单号等信息是无法篡改的，否则是无法验证通过的，除非key遭到了泄密！而楼主的测试方法是直接绕开了支付宝的验签机制的，所以这种测试方法是有问题的。不过仍然感谢楼主对CuuMall的关注 2014-06-17：@′ 雨。 非常感谢你的帮助，根据你的回复，我仔细考虑了一下，因为我们是提供了多支付接口的系统，如果是默认的key的话确实是对用户会有影响，我们的程序在商城后台可以设置相关接口是否生效，但是实际接口失效的代码验证没有加入进来，如果用户不使用支付宝接口，设置支付宝禁用，但是仍然可以访问到这个接口，这样的话支付宝接口确实对外暴露了，并且里面的key是默认的，那这里就会产生一个漏洞了，包括其他几个接口也会有同样的问题，这里我仅考虑到用户一定会启用支付并且输入key的情况了，十分抱歉我没有考虑周全，不知道这里是否可以修改或者补偿rank,这个rank影响还是很大的。  ", "replys": "漏洞评价：\n评论\n     2014-06-15 15:22 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  雨 你这是刷屏    \n     2014-06-15 18:59 |    \t\tYouYaX(乌云厂商)\t\t \n  雨兄，你在我这挖的洞过时了，请关注新版本，囧    \n     2014-06-15 19:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @YouYaX   好吧    在admin5 下的5.7.1     没在官网下 嗯  放假了再看看。    \n     2014-06-15 19:01 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @YouYaX   挖的时候还是最新版。  9号发的， 现在过审核。 就不是最新版了。    \n     2014-06-16 18:29 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  厂商，这文件可以直接访问的？这文件好眼熟    \n     2014-06-16 18:59 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @cuumall   很佩服厂商     回复得这么牛逼。   专注啊，  不过如果key是默认的就行吧。  一朋友自己搭建了cuumall。 没进行任何操作用图上的sign能通过验证，    \n     2014-06-16 19:02 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   这个跟之前我发的csdj那洞是差不多的。  WooYun: CSDJCMS程式舞曲最新版Sql 一枚 这个csdj 这个 demo也能成功  如果key是默认的都能成功吧。@cuumall    \n     2014-06-16 19:48 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:15        | Talk is cheap,show me the shell.)\t\t \n  嘿嘿嘿我也无语了，看了厂商的代码了。深澜也有一处类似    \n     2014-06-17 13:46 |    \t\tCuuMall免费开源商城系统(乌云厂商)\t\t \n  @Mody 这个文件是支付宝提供的支付接口文件，是可以直接访问的，感谢对CuuMall的关注    \n     2014-06-17 13:55 |    \t\tCuuMall免费开源商城系统(乌云厂商)\t\t \n  @′  雨。 非常感谢你的帮助，根据你的回复，我仔细考虑了一下，因为我们是提供了多支付接口的系统，如果是默认的key的话确实是对用户会有影响，我们的程序在商城后台可以设置相关接口是否生效，但是实际接口失效的代码没有加入进来，如果用户不使用支付宝接口，设置支付宝禁用，但是仍然可以访问到这个接口，这样的话支付宝接口确实对外暴露了，并且里面的key是默认的，那这里就会产生一个漏洞了，包括其他几个接口也会有同样的问题，这里我仅考虑到用户一定会启用支付并且输入key的情况了，十分抱歉我没有考虑周全，不知道这里是否可以修改或者补偿rank,这个rank影响还是很大的，20都还是算少了。    \n     2014-06-17 13:58 |    \t\tCuuMall免费开源商城系统(乌云厂商)\t\t \n  @HackPanda 感谢你的关注    \n     2014-06-17 14:08 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:15        | Talk is cheap,show me the shell.)\t\t \n  @CuuMall免费开源商城系统 :)    \n     2014-06-17 15:07 |    \t\tYouYaX(乌云厂商)\t\t \n  @CuuMall免费开源商城系统 其实可以寄一个礼物表示一下    \n     2014-06-17 15:12 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  @YouYaX 考，你的良心大大的好，不挖你的对不住你阿，对了，为什么我每次安装YouYax完总是空白。。。    \n     2014-06-17 15:24 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n   @Mody 以前的版本我有时也是空白 新版本不会了。@YouYaX最新版看了很久也没挑出啥漏洞。只看到了几个bug。    \n     2014-06-17 15:32 |    \t\tCuuMall免费开源商城系统(乌云厂商)\t\t \n  @YouYaX 感谢你的建议，他又发了一遍~:)已给20rank    \n     2014-06-17 16:46 |    \t\tYouYaX(乌云厂商)\t\t \n  @Mody 一般般，没盈利，如果有盈利的话就表示一下礼物    \n     2014-06-17 16:47 |    \t\tYouYaX(乌云厂商)\t\t \n  @Mody 不晓得哇，空白可能是出错了，而我在index.php里屏蔽了错误提示    \n     2014-06-17 16:50 |    \t\tYouYaX(乌云厂商)\t\t \n  @roker 最近不搞版本升级了，如无意外,79版本是最后版本了，再建设另外一个系统了，预计也要很长的时间。    \n     2014-06-17 21:58 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我就说这里讨论那么热烈的？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}