{"id": 437, "wybug_id": "wooyun-2014-069746", "wybug_title": "qibocms V7 整站系统最新版SQL注入一枚 &amp; 另外一处能引入转义符的地方。", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-07-27 23:50", "wybug_open_date": "2014-10-25 23:52", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-25：\t细节向公众公开  简要描述： 好久没看过qibo的了。高三累成狗, 补课生活终于快要结束了。 详细说明：  首先来看一下全局文件\n$_POST=Add_S($_POST);$_GET=Add_S($_GET);$_COOKIE=Add_S($_COOKIE);\n\nfunction Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;\n看这函数对数组中的value进行了addslashes 没有对数组中的key进行addslashes。在member/post.php中\nif($lfjid){\tif($web_admin||$lfjuid==$rsdb[uid]){\t\t$atc_power=1;\t}}\n这里判断了一下权限 如果是管理员的话就让这变量为1 当然我们是注册不到管理员的看后面的 如果你的id 是和这个发布文章的id是一样的 那么这个变量也会成1也是有权限的 所以。。\nelseif($job=='manage'){\tif(!$atc_power)showerr(\"你没权限\");\tif($rsdb[pages]<2){\t\theader(\"location:post.php?job=edit&aid=$aid&mid=$mid&only=$only\");exit;\t}\t$erp=get_id_table($aid);\tif($step==2){\t\tasort($orderDB);\t\t$i=0;\t\tforeach( $orderDB AS $key=>$value){\t\t\t$i++;\t\t\t$db->query(\"UPDATE {$pre}reply$erp SET orderid=$i WHERE aid='$aid' AND rid='$key'\");\t\t}\n这里$orderDB 结合 qibo的伪全局可以直接控制然后把数组中的key直接带入到了查询当中 结合上面说的 数组中的key不会被转义所以造成了注入。__________________________________________________________________0x02 能引入转义符的地方。/inc/artic_function.php中\n/*修改软件*/function post_edit(){\tglobal $db,$_pre,$postdb,$fid,$fidDB,$Fid_db,$lfjuid,$rsdb,$lfjdb,$webdb,$timestamp,$aid,$FROMURL,$groupdb,$web_admin,$fu_fiddb;\tif( $rsdb[levels]&&$postdb[levels] )\t{\t\t$postdb[levels]=$rsdb[levels];\t//处理其他级别2,3,4...以防出错\t}\tif($postdb[top])\n省略一点\nif($rsdb[keywords]!=$postdb[keywords]){\t\tkeyword_del($aid,$rsdb[keywords]);\t\tkeyword_add($aid,$postdb[keywords],$lfjdb[uid]);\t}\n\nfunction keyword_del($aid,$keyword){\tglobal $db,$_pre;\tif(!$keyword){\t\treturn ;\t}\t$detail2=explode(\" \",$keyword);\tforeach( $detail2 AS $key=>$value){\t\tif($value){\t\t\t$db->query(\"UPDATE `{$_pre}keyword` SET num=num-1 WHERE `keywords`='$value'\");\t\t\t$_rs=$db->get_one(\"SELECT * FROM `{$_pre}keyword` WHERE `keywords`='$value'\");\t\t\t$id=$_rs[id];\t\t\t$db->query(\"DELETE FROM `{$_pre}keywordid` WHERE `id`='$id' AND aid='$aid'\");\t\t\t\t}\t}}\nkeyword_del($aid,$rsdb[keywords]);这里进入查询的时候是用的是出库来的  所以能引入转义符。   漏洞证明：  首先注册一个会员\n\n然后选择一个栏目投稿。\n\n发布成功后 因为这里判断了\nif($rsdb[pages]<2){\t\theader(\"location:post.php?job=edit&aid=$aid&mid=$mid&only=$only\");exit;\n就是说页数不能只有一页 所以我们得点 [续发本主题] 再增加一页。\n\n两页了。然后这里可以直接看到id为668.\n\n修改key为注入语句 成功注入。_________________________________________________________________________0x02 引入转义符 首先注册一个会员 然后发布一个文章 这样写\n\n关键字这样写 发完后  然后编辑一下\n\n引入了转义符 成功报错了。   修复方案：  转义一下。\nforeach( $orderDB AS $key=>$value){\t\t\t$i++;                        $key=addslashes($key);\t\t\t$db->query(\"UPDATE {$pre}reply$erp SET orderid=$i WHERE aid='$aid' AND rid='$key'\");\t\t}\n第二个$keyword=addslashes($keyword);   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-28 14:15 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-28 00:02 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  更新了一下 管理帮我更新下把 @疯狗 @Finger @xsser    \n     2014-07-28 01:16 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @′  雨。 我的漏洞为啥都不审核..........    \n     2014-07-28 10:31 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n    求给更新下    \n     2014-07-28 11:23 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 更新    \n     2014-07-28 11:26 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗  狗哥 谢啦    \n     2014-08-01 09:59 |    \t\tC4ndy \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        )\t\t \n  Mark    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}