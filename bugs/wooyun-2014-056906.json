{"id": 56674, "wybug_id": "wooyun-2014-056906", "wybug_title": "Doyo建站系统设计缺陷(知邮箱即可修改该用户密码)", "wybug_corp": "wdoyo.com", "wybug_author": "′雨。", "wybug_date": "2014-04-13 12:29", "wybug_open_date": "2014-07-09 12:30", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-18：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-09：\t细节向公众公开  简要描述： 验证过于简单啊。 详细说明：  在source/member.php中\nfunction retrieve_password(){\t\tif($this->syArgs(\"go\")){\t\t\tif($GLOBALS['G_DY']['vercode']==1){\t\t\t\tif(!$this->syArgs(\"vercode\",1)||md5(strtolower($this->syArgs(\"vercode\",1)))!=$_SESSION['doyo_verify'])message(\"验证码错误\");\t\t\t}\t\t\t$ok=false;\t\t\t$user=$this->syArgs(\"user\",1);\t\t\t$email=$this->syArgs(\"email\",1);\t\t\tif($email){\t\t\t\tif($user){\t\t\t\t\t$conditions = array('user' => $user,'email' => $email);\t\t\t\t\t$m = syDB('member')->find($conditions,null,'id,user,email');\t\t\t\t\tif(!$m){message(\"没有找到匹配的用户和邮箱，请确认用户名及邮箱输入正确。\");}else{$ok=true;}\t\t\t\t}else{\t\t\t\t\t$conditions = array('email' => $email);\t\t\t\t\t$num = syDB('member')->findCount($conditions);\t\t\t\t\tif($num<1)message(\"没有找到匹配的用户和邮箱，请确认用户名及邮箱输入正确。\");\t\t\t\t\tif($num>1)message(\"此邮箱注册了多个账号，必须填写用户名才可找回密码。\");\t\t\t\t\tif($num==1){$m = syDB('member')->find($conditions,null,'id,user,email');$ok=true;}\t\t\t\t}\t\t\t}else{\t\t\t\tmessage(\"请输入email地址\");\t\t\t}\t\t\tif($ok){\t\t\t\t$http=get_domain();\t\t\t\t$subject=$http.'密码找回邮件';\t\t\t\t$token=md5($this->syArgs(\"vercode\",1).$email.time());\t\t\t\t\t\t\t\t$url=$GLOBALS['WWW'].'index.php?c=member&a=reset_password&id='.$m['id'].'&token='.$token;\t\t\t\t$body='您在'.$GLOBALS['S']['title'].'提交了密码找回邮件，点击下面的链接进行密码重置：<a href=\"'.$http.$url.'\" target=\"_blank\">【点击此处进行密码重置】</a>，如果本次找回密码不是您亲自操作，请忽略本邮件。';\t\t\t\t$send=syClass('syphpmailer');\t\t\t\t$retrieve=$send->Send($email,$m['user'],$subject,$body);\t\t\t\tif(!$retrieve){\t\t\t\t\tmessage('邮件发送失败，请联系管理员。');\t\t\t\t}else{\t\t\t\t\tsyDB('member')->update(array('id'=>$m['id']),array('token'=>$token,'tokentime'=>time()));\t\t\t\t\tmessage('密码已成功发送至您的邮箱，请点击邮件内容中的链接设置新密码，有效期3天。','?c=member');\t\t\t\t}\t\t\t}\t\t}\n在这里 修改密码主要就是用$token 可是$token的验证太弱了。\n$token=md5($this->syArgs(\"vercode\",1).$email.time());\n看token的由来, 是用找回密码的时候的验证码 和 邮箱 和 时间戳。所以我们知道要改用户的邮箱就可以直接修改他的密码。   漏洞证明：   \n\n首先把验证码记录上 eqkm  这里用户名不需要填。然后记录时间戳。1397361568\n\n然后 对 eqkmxiaoyu@qq.com1397361568 md5一次 得到adc044125e0a5e96d37f2a171c8b3d96则token就为这个。 但是对方的id我们是不知道的。 这不要紧。载入burpsuite直接跑一次就行了。token我们已经知道了。 就只需要其他用户的id了。 这里把id设置为变量 然后穷举。\n\n观察length 就知道当16的时候是正确的 则用户的id为16.然后直接访问。\n\n即可直接修改其他用户的密码。   修复方案：  加强验证。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-09 12:30 厂商回复：  最新状态： 2014-07-09：已修复  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}