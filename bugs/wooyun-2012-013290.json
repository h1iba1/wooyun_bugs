{"id": 16968, "wybug_id": "wooyun-2012-013290", "wybug_title": "腾讯通RTX企业用户存在渗透风险！", "wybug_corp": "腾讯通RTX企业用户", "wybug_author": "有礼物送上", "wybug_date": "2012-10-13 11:03", "wybug_open_date": "2012-10-18 11:04", "wybug_type": "敏感信息泄露", "wybug_level": "低", "wybug_rank_0": "1", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-10-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-10-18：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述：   腾讯说了没问题，意思就是说欢迎大家去搞，关我毛事。  企业用户还是比较多，哥还是负责，自己还是做一份，请管理员叫给CNCERT处理吧！ 详细说明：  \n完整测试过程：  首先，去官网下载一个完整安装包：  http://rtx.tencent.com/rtx/download/index.shtml    安装服务器端和客户端： （默认下载是TRX2011版，是否是所有版本有影响，没完全测试，但根据部分实例测试来看，大部分版本都有此问题！）\n\n\n\n然后，发现http://127.0.0.1:8012/userlist.php可以直接访问到，里面包含所有用户的用户名等信息的json（里面我添加一个存在弱口令的test帐号，以便后面的测试）： 为什么会直接就能访问到这个userlist.php了？  不管后面的危害如何，这些重要数据是不是不能对普通用户？\n\n看看源代码（虽然不喜欢看代码，也没有用过php），发现是个比较2的失误： 在RTXServer\\WebRoot路径下找到userlist.php文件：\n\n<?php header('Content-Type: text/html; charset=utf-8');//require_once \"IPLimit.php\";$connstr = \"Driver={Microsoft access Driver (*.mdb)};DBQ=../db/rtxdb.mdb\";$conn = @new COM(\"ADODB.Connection\") or die (\"ADO连接失败!\");$conn->Open($connstr);$rs = @new COM(\"ADODB.RecordSet\");$sql =\"select ID,UserName from Sys_user where AccountState<>1 or AccountState is null order by ID\";$rs->Open($sql,$conn,1,3);$rs->MoveFirst();$result = array();  while(!$rs->EOF){  $idField = $rs->Fields(0);  $id = $idField->value;  $nameField = $rs->Fields(1);  $name = $nameField->value;    $name = iconv(\"gb2312\",\"utf-8\", $name);  array_push($result, array('id'=>$id,'name'=>$name));\t$rs->MoveNext();}$rs->close(); //print_r($result);echo json_encode($result);?>\n\n第三行代码被注释掉了：//require_once \"IPLimit.php\";\n\n那么这个IPLimit.php是干什么的了？看命名就知道了，做ip限制的：\n\n<?phpif (PHP_VERSION>='5') require_once('domxml-php4-to-php5.php');$visitorIP = $_SERVER['REMOTE_ADDR'];$visitorIP = trim($visitorIP);//$visitorDns = $_SERVER['REMOTE_HOST'];define(\"LOCAL_IP_PREFIX\", \t\t\t\"127.0.0.\");define(\"IPLIMIT_CONFIGFILE_NAME\", \t\"SDKProperty.xml\");define(\"ELEM_SDKHTTP\", \t\t\t\t\"SDKHttp\");define(\"ELEM_IPLIMIT\", \t\t\t\t\"IPLimit\");define(\"ATTR_LIMITENABLED\", \t\t\"Enabled\");define(\"ELEM_IP\", \t\t\t\t\t\"IP\");function GetIPLimitConfigFilePath(){\t$path = dirname(__FILE__); // webroot\t$path = dirname($path); // RTXServer\t$path .= \"\\\\\";\t$path .= IPLIMIT_CONFIGFILE_NAME;\t\treturn $path;}function IsVisitorLimited($visitorIP){\tif (strpos($visitorIP, LOCAL_IP_PREFIX) !== false)\t{\t\treturn false;\t}\t\t$iplimitConfigFilePath = GetIPLimitConfigFilePath();\tif (!file_exists($iplimitConfigFilePath))\t{\t\treturn false;\t}\t\t$isLimitEnabled = \"0\";\t$arPermittedIP = array();\tGetIPLimitInfo($iplimitConfigFilePath, $isLimitEnabled, $arPermittedIP);\t\tif ($isLimitEnabled == \"0\")\t{\t\treturn false;\t}\t\tif (in_array($visitorIP, $arPermittedIP, false))\t{\t\treturn false;\t}\t\treturn true;}function GetIPLimitInfo($iplimitConfigFilePath, &$isLimitEnabled, &$arPermittedIP){\t$isLimitEnabled = \"0\";\t\t$dom = domxml_open_file($iplimitConfigFilePath);\tif ($dom == null)\t{\t\theader(\"http/1.1 404 domxml_open_file failed!\");\t\texit;\t}\t\t$dom_root = $dom->document_element();\tif ($dom_root == NULL)\t{\t\theader(\"http/1.1 404 ip limit config file invalid!\");\t\texit;\t\t\t}\t\t$sdkhttpNode = NULL;\t$arPropertyChildNodes = $dom_root->child_nodes();\tfor ($i = 0; $i < count($arPropertyChildNodes); $i++)\t{\t\tif (strcasecmp($arPropertyChildNodes[$i]->node_name(), ELEM_SDKHTTP) == 0)\t\t{\t\t\t$sdkhttpNode = $arPropertyChildNodes[$i];\t\t\tbreak;\t\t}\t}\t\tif ($sdkhttpNode != NULL)\t{\t\t $arSDKCgiChildNodes = $sdkhttpNode->child_nodes();\t\t foreach ($arSDKCgiChildNodes as $sdkcgiChildNode)\t\t {\t\t \tif (strcasecmp($sdkcgiChildNode->node_name(), ELEM_IPLIMIT) == 0)\t\t \t{\t\t \t\t$arAttr = $sdkcgiChildNode->attributes();\t\t \t\tfor ($i = 0; $i < count($arAttr); $i++)\t\t \t\t{\t\t \t\t\tif (strcasecmp($arAttr[$i]->name, ATTR_LIMITENABLED) == 0)\t\t \t\t\t{\t\t \t\t\t\t$isLimitEnabled = $arAttr[$i]->value();\t\t \t\t\t}\t\t \t\t}\t\t \t\t\t\t \t\tif ($isLimitEnabled == \"1\")\t\t \t\t{\t\t\t \t\t\t\t\t \t$arChildNodesIP = $sdkcgiChildNode->child_nodes();\t\t\t\t \tforeach ($arChildNodesIP as $childNodeIP)\t\t\t\t \t{\t\t\t\t \t\tif (strcasecmp($childNodeIP->node_name(), ELEM_IP) == 0)\t\t\t\t \t\t{\t\t\t\t \t\t\tarray_push($arPermittedIP, trim($childNodeIP->get_content()));\t\t\t\t \t\t}\t\t\t\t \t}\t\t\t\t}\t\t\t \t\t\t\t \tbreak;\t\t \t}\t\t}\t}\t}if (IsVisitorLimited($visitorIP)){\techo \"IP 受限，请联系管理员开放您的 IP\";\t//header(\"http/1.1 404 IP limited!\");\texit;}?>\n\n这里就有个问题了，这与腾讯的说法就矛盾了，如果userlist.php是正常权限，为什么会有这个功能限制了？\n\n如果是代码审计失误造成的就算了；如果是主动注释掉，怕影响用户体验，那这是个最2的功能了，那这样为什么不做管理页面里？各种看不懂！\n   漏洞证明：  \n然后使用test，在“查看审核结果”处尝试弱口令：\n \n\n\n一般的大企业都是成百上千用户，只要一个存在弱口令，整个公司人员的信息都要暴露等：\n\n在有用户名的情况下，在这个简单登录界面破解一个内网用户密码我想太容易了：\n\n\n\n然后是简单配置一下客户端就成功登录了！\n\n\n\n\n\n然后给点实际案例（除了之前发的一些，我另外又找了些）：110.86.9.189:8012/ rtx.hebstd.gov.cn:8012/rtx.szvienna.com:8012/ 218.75.206.108:8012/ 202.91.227.110:8012/ rtx2009.kanion.com:8012/ rtx.sinoma-ncdri.cn:8012/211.68.208.34:8012/ 120.209.176.9:8012/222.90.72.34:8012/rtx.at-express.com:8012/218.62.80.218:8012/ 61.156.217.52:8012/118.112.186.35:8012/61.175.218.170:8012/ rtx.pkuyy.com:8012/rtx.jianxin.com:8012/rtx.cometgroup.com.cn:8012/hzng.com.cn:8012/124.117.253.19:8012/ 211.81.31.61:8012/rtx.enweixi.com:8012/221.212.46.188:8012/ 218.56.106.149:8012/125.43.85.116:8012/58.128.148.10:8012/ www.pearlcoin.cn:8012/202.113.48.145:8012/218.20.201.30:8012/ 222.89.168.62:8012/ rtx.caams.org.cn:8012/ 218.29.37.196:8012/ 219.141.70.238:8012/cszyz.zpjy.net:8012/www.ynxt56.com:8012/tgzdh.tangsteel.com:92/ www.pssyy.cn:8012/ www.76tzx.com:8012/foisongroup.com:8012/www.hbaxle.com:8012/58.248.49.93:8012/ www.nbqinyuanoa.com:8012/www.gaokegroup.com:8012/sales.midea.com.cn:8012/rtxc.satrip.com:8012/rtx.dycoal.cn:8012/218.90.212.84:8012/60.191.40.4:8012/sucai.nxyc2z.com:8012/www.kt10000.com:8012/ qq.huiyuan.com.cn:8012/\n\n没有一个个测试，有些可能限制了，如：登录8000端口更换了等！\n\n下面是成功入侵的案例（123456密码测试）：rtx10.ougz.com.cn:8012/userlist.php8442 123456http://rtx.dycoal.cn:8012/userlist.phpzsx 123456http://rtx.evoc.cn:8012/userlist.phpsz2054 123456http://www.gaokegroup.com:8012/userlist.php3102 123456\n\n就以高科集团为例（在客户端填好上面的地址，默认8000端口）：\n\n\n\n这样就能获得公司领导的联系方式了：\n\n\n\n还可以使用你们做安全的专业术语，伪造他人与公司财务MM视频传情：\n\n\n\n\n   修复方案：  过程算完整了，真是影响哥周末的心情（这么明显的信息泄露，是真2吗？）！   版权声明：转载请注明来源 有礼物送上@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2012-10-18 11:04 厂商回复：  最新状态： 2012-10-18：不小心忽略了，向大家致歉。涉及的部分案例，如：人民银行项目系统，已通过正式函件向人民银行科技司提交事件处置函。同时，在16日已联系腾讯公司，腾讯公司回复已经关注到案例情况，但目前暂未提供进一步的解决方案。CNCERT认为，对相关页面、用户管理的权限审计设计存在缺陷。  ", "replys": "漏洞评价：\n评论\n     2012-10-13 11:06 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  礼物哥周末愉快啊 ～    \n     2012-10-13 11:21 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  礼物哥怒了。    \n     2012-10-15 12:27 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  期待忽略    \n     2012-10-18 11:23 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  围观忽略。    \n     2012-10-19 08:03 |    \t\t大连万达集团(乌云厂商)\t\t \n  漏洞就是漏洞啊，不过如果部署得合理，应该还好：外网封掉8012，把userlist.php删掉。腾讯大概原来觉得这东西属于部署架构的事。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}