{"id": 9588, "wybug_id": "wooyun-2013-026421", "wybug_title": "ecshop最新版本前台二次注入系列(1)", "wybug_corp": "ShopEx", "wybug_author": "blue", "wybug_date": "2013-06-20 16:42", "wybug_open_date": "2013-09-18 17:33", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["二次注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-06-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-08-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-09-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-18：\t细节向公众公开  简要描述： 二次注入第一枚，通读ecshop代码的结果，我是今天早上从ecshop新下的程序包，你懂的～ 详细说明：  先上结果图：\n\n注入利用过程：1.添加商品到购物车时，写入注入代码到商品属性idhttp://localhost/test/ecshop/flow.php?step=add_to_cartPOST: goods={\"quick\":1,\"spec\":[\"163\",\"158'\"],\"goods_id\":32,\"number\":\"1\",\"parent\":0}注意，需要spec有两个或以上id2.在查看购物车页面，点击更新购物车，执行注入代码(二次注入嘛，单引号可用了)代码分析：1./includes/lib_goods.php 942行\nfunction spec_price($spec){    if (!empty($spec))    {        $where = db_create_in($spec, 'goods_attr_id');  //这里是注入位置，能控制$spec就可以了        $sql = 'SELECT SUM(attr_price) AS attr_price FROM ' . $GLOBALS['ecs']->table('goods_attr') . \" WHERE $where\";        $price = floatval($GLOBALS['db']->getOne($sql));    }    else    {        $price = 0;    }    return $price;}\n2./includes/lib_common.php 2266行get_final_price有spec_price的调用3.再看get_final_price方法的调用 在ecshop/flow.php flow_update_cart方法，2272行\n/* 处理普通商品或非优惠的配件 */            else            {                $attr_id    = empty($goods['goods_attr_id']) ? array() : explode(',', $goods['goods_attr_id']); //看,$attr_id是读取的购物车商品的goods_attr_id字段，所以只要在添加商品到购物车时写入注入代码就可以了                $goods_price = get_final_price($goods['goods_id'], $val, true, $attr_id);                //更新购物车中的商品数量                $sql = \"UPDATE \" .$GLOBALS['ecs']->table('cart').                        \" SET goods_number = '$val', goods_price = '$goods_price' WHERE rec_id='$key' AND session_id='\" . SESS_ID . \"'\";            }\n   漏洞证明：  \n\n   修复方案：  在flow_update_cart中对goods_attr_id进行addslashes   版权声明：转载请注明来源 blue@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2013-06-20 16:52 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-06-20 16:44 |    \t\t瞌睡龙 \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:5        | fighting……)\t\t \n  吊炸天啊，要连载的节奏~    \n     2013-06-20 16:46 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  雷劈了！ecshop的漏洞一定是看了很久代码吧，应该很经典，mark。    \n     2013-06-20 16:50 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  1w的节奏啊    \n     2013-06-20 17:08 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  @瞌睡龙 明天第二发，照样是二次注入～    \n     2013-06-20 17:11 |    \t\tp0di \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 1+1 = 2 ？)\t\t \n  这个需要围观下。    \n     2013-06-20 17:39 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @blue 早点发免得夜长梦多啊！    \n     2013-06-20 17:57 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  @齐迹 不急，那个点很猥琐很猥琐～    \n     2013-06-20 18:00 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @blue 端个板凳坐等    \n     2013-06-20 18:04 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @blue 白盒大牛啊    \n     2013-06-20 18:07 |    \t\tp0di \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 1+1 = 2 ？)\t\t \n  @blue 求大牛连载，做教程。    \n     2013-07-11 14:30 |    \t\takast \t\t\t( 普通白帽子  |\t\t\t        Rank:244 漏洞数:39        | NEURON & LEUKOCYTE)\t\t \n  细节向普通白帽子公开, 怎么看不到?     \n     2013-07-20 16:35 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  好激动，还有7分钟就能看到了    \n     2013-07-20 16:36 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  算错鸟，应该是30号    \n     2013-07-20 16:54 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  提醒：为保证通用型安全漏洞的信息保密性，该漏洞无法使用乌云币提前查看，请踏实的杀洞升级吧 @VIP 自己去对比最新补丁。好像是一个单引号被捣腾了几次后产生了注入。    \n     2013-07-20 16:56 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  @齐迹 好像用普通白帽子帐号也看不到    \n     2013-07-20 17:18 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  @齐迹 看到了一个点，不知道是不是    \n     2013-07-27 21:45 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  涨见识了。。。    \n     2013-10-20 22:36 |    \t\ty35u \t\t\t( 普通白帽子  |\t\t\t        Rank:364 漏洞数:38        | yesu)\t\t \n  @blue 请问这个怎么写注入语句，逗号会被转成,'    \n     2013-10-21 10:37 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  @y35u 看下db_create_in这个方法    \n     2014-05-07 11:15 |    \t\tbitcoin \t\t\t( 普通白帽子  |\t\t\t        Rank:715 漏洞数:218        | 学习是最好的投资！)\t\t \n  大牛，威武！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}