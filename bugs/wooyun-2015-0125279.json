{"id": 65659, "wybug_id": "wooyun-2015-0125279", "wybug_title": "泛微E-office 同一文件多处sql注射/用户信息泄露(ROOT SHELL)", "wybug_corp": "泛微E-office", "wybug_author": "menmen519", "wybug_date": "2015-07-10 12:14", "wybug_open_date": "2015-10-08 11:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-08：\t细节向公众公开  简要描述： 泛微E-office 同一文件多处sql注射/用户信息泄露(ROOT SHELL) 详细说明：  看了wooyun个大牛发的这个产品的漏洞，感觉版本都过低，这里我发一个8.5的版本，里面新增了webservice的相关操作 下来看代码webservice/eoffice.wsdl.php：看看里面的代码：\n<?php/*********************//*                   *//*  Dezend for PHP5  *//*         NWS       *//*      Nulled.WS    *//*                   *//*********************/function UserLogin( $userAccount, $password ){\t\t\t\tglobal $connection;\t\t\t\tglobal $_lang;\t\t\t\tif ( trim( $userAccount ) == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$userLoginReturn['code'] = \"0x0000001\";\t\t\t\t\t\t\t\treturn $userLoginReturn;\t\t\t\t}\t\t\t\t$checkUserAccountIsExsitQuery = \"SELECT * FROM user WHERE USER_ACCOUNTS='\".trim( $userAccount ).\"'\";\t\t\t\t$checkUserAccountIsExsitResult = exequery( $connection, $checkUserAccountIsExsitQuery );\t\t\t\tif ( $checkUserAccountIsExsitRow = mysql_fetch_array( $checkUserAccountIsExsitResult ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( trim( $checkUserAccountIsExsitRow['USER_ACCOUNTS'] ) != trim( $userAccount ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$userLoginReturn['code'] = \"0x0000002\";\t\t\t\t\t\t\t\t\t\t\t\treturn $userLoginReturn;\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$userLoginReturn['code'] = \"0x0000002\";\t\t\t\t\t\t\t\treturn $userLoginReturn;\t\t\t\t}\t\t\t\t$checkPasswordQuery = \"SELECT PASSWORD FROM user WHERE USER_ACCOUNTS='\".trim( $userAccount ).\"'\";\t\t\t\t$checkPasswordResult = exequery( $connection, $checkPasswordQuery );\t\t\t\t$checkPasswordRow = mysql_fetch_array( $checkPasswordResult );\t\t\t\t$myPassword = $checkPasswordRow['PASSWORD'];\t\t\t\tif ( crypt( $password, $myPassword ) != $myPassword )\t\t\t\t{\t\t\t\t\t\t\t\t$userLoginReturn['code'] = \"0x0000003\";\t\t\t\t\t\t\t\treturn $userLoginReturn;\t\t\t\t}\t\t\t\t$query = \"SELECT * from USER where USER_ACCOUNTS='\".$userAccount.\"'\";\t\t\t\t$cursor = exequery( $connection, $query );\t\t\t\t$ROW = mysql_fetch_array( $cursor );\t\t\t\t$timenow = time( );\t\t\t\t$CUR_TIME = date( \"Y-m-d H:i:s\", $timenow );\t\t\t\t$query = \"update USER set LAST_VISIT_TIME='{$CUR_TIME}' where USER_ID='\".$ROW['USER_ID'].\"'\";\t\t\t\texequery( $connection, $query );\t\t\t\t$query = \"SELECT * from USER_PRIV where USER_PRIV=\".$ROW['USER_PRIV'];\t\t\t\t$cursor = exequery( $connection, $query );\t\t\t\tif ( $ROW1 = mysql_fetch_array( $cursor ) )\t\t\t\t{\t\t\t\t\t\t\t\t$LOGIN_FUNC_STR = $ROW1['FUNC_ID_STR'];\t\t\t\t}\t\t\t\t$LOGIN_THEME = $ROW['THEME'];\t\t\t\t$template = $ROW['TEMPLATE'];\t\t\t\tif ( !$template )\t\t\t\t{\t\t\t\t\t\t\t\t$template_query = \"SELECT TEMPLATE_NAME FROM sys_template WHERE TEMPLATE_DEFAULT = 1 \";\t\t\t\t\t\t\t\t$template_rs = exequery( $connection, $template_query );\t\t\t\t\t\t\t\tif ( $row_tp = mysql_fetch_array( $template_rs ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$template = $row_tp['TEMPLATE_NAME'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$template = \"8series\";\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\tif ( $template == \"8series\" )\t\t\t\t{\t\t\t\t\t\t\t\t$mainUrl = \"/general/index8.php\";\t\t\t\t}\t\t\t\telse if ( $template == \"7series\" )\t\t\t\t{\t\t\t\t\t\t\t\t$mainUrl = \"/general/index.php\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$mainUrl = \"index8.php\";\t\t\t\t}\t\t\t\tif ( $LOGIN_THEME == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$LOGIN_THEME = \"default\";\t\t\t\t}\t\t\t\t$LOGIN_THEME = $template.\"/\".$LOGIN_THEME;\t\t\t\tsession_start( );\t\t\t\t$_SESSION['LOGIN_USER_ID'] = $ROW['USER_ID'];\t\t\t\t$_SESSION['LOGIN_PASSWORD'] = $ROW['PASSWORD'];\t\t\t\t$_SESSION['LOGIN_POST_PRIV'] = $ROW['POST_PRIV'];\t\t\t\t$_SESSION['LOGIN_USER_ACCOUNTS'] = $ROW['USER_ACCOUNTS'];\t\t\t\t$_SESSION['LOGIN_USER_NAME'] = $ROW['USER_NAME'];\t\t\t\t$_SESSION['LOGIN_USER_PRIV'] = $ROW['USER_PRIV'];\t\t\t\t$_SESSION['LOGIN_DEPT_ID'] = $ROW['DEPT_ID'];\t\t\t\t$_SESSION['LOGIN_FUNC_STR'] = $LOGIN_FUNC_STR;\t\t\t\t$_SESSION['LOGIN_THEME'] = $LOGIN_THEME;\t\t\t\t$_SESSION['LOGIN_LANG'] = \"cn\";\t\t\t\t$_SESSION['LOGIN_LANG_ID'] = 1;\t\t\t\t$infor['sessionID'] = session_id( );\t\t\t\t$infor['userID'] = $ROW['USER_ID'];\t\t\t\t$infor['deptID'] = $ROW['USER_ID'];\t\t\t\t$infor['privID'] = $ROW['USER_PRIV'];\t\t\t\t$infor['userName'] = $ROW['USER_NAME'];\t\t\t\t$infor['userAccount'] = $ROW['USER_ACCOUNTS'];\t\t\t\t$infor['avatarType'] = $ROW['AVATAR_TYPE'];\t\t\t\t$query = \"update USER set LAST_VISIT_TIME='{$CUR_TIME}' where USER_ID='\".$ROW['USER_ID'].\"'\";\t\t\t\texequery( $connection, $query );\t\t\t\tadd_log( 1, $_lang['common_login_from_PC'], $ROW['USER_ID'] );\t\t\t\t$query = \"SELECT * FROM `sys_para`;\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\tswitch ( $row['PARA_NAME'] )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tcase \"slogan\" :\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$infor['slogan'] = $row['PARA_VALUE'];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\t\tcase \"SMS_FREQUENCY\" :\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$infor['smsFrequency'] = $row['PARA_VALUE'];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\t$query = \"SELECT * FROM sys_upload WHERE MODULE_NAME='SMS' OR MODULE_NAME ='FILE'\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( $row['MODULE_NAME'] == \"SMS\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$temp['maxNumber'] = $row['UPLOAD_MAX_NUM'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['singleMaxSize'] = $row['UPLOAD_SINGLE_MAX_SIZE'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['totalMaxSize'] = $row['UPLOAD_TOTAL_MAX_SIZE'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['denySuffix'] = \"|\".$row['DENY_SUFFIX'].\"|\".UPLOADROLE;\t\t\t\t\t\t\t\t\t\t\t\t$infor['smsUploadParam'] = $temp;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse if ( $row['MODULE_NAME'] == \"FILE\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$temp['maxNumber'] = $row['UPLOAD_MAX_NUM'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['singleMaxSize'] = $row['UPLOAD_SINGLE_MAX_SIZE'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['totalMaxSize'] = $row['UPLOAD_TOTAL_MAX_SIZE'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['denySuffix'] = \"|\".$row['DENY_SUFFIX'].\"|\".UPLOADROLE;\t\t\t\t\t\t\t\t\t\t\t\t$infor['documentUploadParam'] = $temp;\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\t$userLoginReturn['code'] = \"0x0000000\";\t\t\t\t$userLoginReturn['infor'] = $infor;\t\t\t\treturn $userLoginReturn;}function GetLanguage( ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT LANG_ID,LANG_NAME FROM language\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$language = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\t$temp['langID'] = $row['LANG_ID'];\t\t\t\t\t\t\t\t$temp['langName'] = $row['LANG_NAME'];\t\t\t\t\t\t\t\tarray_push( $language, $temp );\t\t\t\t}\t\t\t\treturn $language;}function GetMenuLink( $funcCode, $funcName ){\t\t\t\tif ( trim( $funcCode ) == \"\" || trim( $funcCode ) == \"@\" )\t\t\t\t{\t\t\t\t\t\t\t\t$href = \"\";\t\t\t\t}\t\t\t\telse if ( strstr( $funcCode, \"http://\" ) || strstr( $funcCode, \"workflow/new/do.php\" ) || strstr( $funcCode, \"workflow/new/freedo.php\" ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( strstr( $funcCode, \"workflow/new/do.php\" ) || strstr( $funcCode, \"workflow/new/freedo.php\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$funcCode = \"/general/\".$funcCode;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( strstr( $funcCode, \"workflow/new/do.php\" ) || strstr( $funcCode, \"workflow/new/freedo.php\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$href = \"/general/workflow/flow_redirect.php?url=\".urlencode( $funcCode ).\"&FUNC_ID={$func_id}\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$href = $funcCode;\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\telse if ( strstr( $funcCode, \"file://\" ) )\t\t\t\t{\t\t\t\t\t\t\t\t$winpath = str_replace( \"\\\\\", \"/\", str_replace( \"file://\", \"\", $funcCode ) );\t\t\t\t\t\t\t\t$winpath = base64_encode( $winpath );\t\t\t\t\t\t\t\t$href = \"/general/winexe/run_cache.php?path=\".$winpath.\"&name=\".urlencode( $funcName );\t\t\t\t}\t\t\t\telse if ( strstr( $funcCode, \"*\" ) )\t\t\t\t{\t\t\t\t\t\t\t\t$func_code = str_replace( \"*\", \"\", $funcCode );\t\t\t\t\t\t\t\t$href = \"/general/loginothersys/run_login.php?id=\".$func_code;\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$needle = \"?\";\t\t\t\t\t\t\t\t$tmparray = explode( $needle, $funcCode );\t\t\t\t\t\t\t\tif ( 1 < count( $tmparray ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$href = \"/general/\".$funcCode.\"&func_id={$func_id}\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$href = \"/general/\".$funcCode.\"?func_id={$func_id}\";\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\treturn $href;}function GetUserFuncIDStr( $userPriv ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT FUNC_ID_STR from USER_PRIV where USER_PRIV='\".$userPriv.\"'\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$row = mysql_fetch_array( $result );\t\t\t\treturn substr( $row['FUNC_ID_STR'], 0, -1 );}function GetCommonMenu( $userPriv, $userID, $langID ){\t\t\t\tglobal $connection;\t\t\t\t$funcIDStr = getuserfuncidstr( $userPriv );\t\t\t\t$funcIDStr = $funcIDStr == \"\" ? 0 : $funcIDStr;\t\t\t\t$query = \"SELECT \\r\\n\\t\\t\\t\\ta.FUNC_NAME AS FUNC_NAME_SYS,\\r\\n\\t\\t\\t\\ta.FUNC_NAME_PY AS FUNC_NAME_PY_SYS,\\r\\n\\t\\t\\t\\ta.FUNC_NAME_ZM AS FUNC_NAME_ZM_SYS,\\r\\n\\t\\t\\t\\tb.FUNC_ID,\\r\\n\\t\\t\\t\\tb.FUNC_NAME AS FUNC_NAME_USER,\\r\\n\\t\\t\\t\\tb.FUNC_NAME_PY AS FUNC_NAME_PY_USER,\\r\\n\\t\\t\\t\\tb.FUNC_NAME_ZM AS FUNC_NAME_ZM_USER,\\r\\n\\t\\t\\t\\tb.FUNC_CODE,\\r\\n\\t\\t\\t\\tb.FUNC_ISSYS,\\r\\n\\t\\t\\t\\tc.FUNC_IMG \\r\\n\\t\\t\\t\\tFROM menu_lang AS a \\r\\n\\t\\t\\t\\tJOIN user_menu AS b \\r\\n\\t\\t\\t\\tON a.FUNC_ID = b.FUNC_ID \\r\\n\\t\\t\\t\\tJOIN sys_function AS c \\r\\n\\t\\t\\t\\tON a.FUNC_ID = c.FUNC_ID \\r\\n\\t\\t\\t\\tWHERE ((b.FUNC_ID IN ({$funcIDStr}) AND b.FUNC_ISSYS=1 AND a.LANG_ID = \".$langID.\" ) \\r\\n\\t\\t\\t\\tOR b.FUNC_ISSYS=0) \\r\\n\\t\\t\\t\\tAND LEFT(b.FUNC_CODE,1)<>'@' \\r\\n\\t\\t\\t\\tAND b.FUNC_CODE <> '' \\r\\n\\t\\t\\t\\tAND b.USER_ID = '\".$userID.\"' \\r\\n\\t\\t\\t\\tAND b.FUNC_ISSHOW = 1 \\r\\n\\t\\t\\t\\tORDER BY FREQUENCY DESC \\r\\n\\t\\t\\t\\tLIMIT 0,12\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$returnArray = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( $row['FUNC_ISSYS'] == 1 )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$funcName = $row['FUNC_NAME_SYS'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$funcName = $row['FUNC_NAME_USER'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$funcID = $row['FUNC_ID'];\t\t\t\t\t\t\t\t$menuID = $row['MENU_ID'];\t\t\t\t\t\t\t\t$funcCode = $row['FUNC_CODE'];\t\t\t\t\t\t\t\t$funcImg = $row['FUNC_IMG'];\t\t\t\t\t\t\t\tif ( $funcImg == \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$imgSrc = \"/images/8/icons/48/\".$funcID.\".png\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$imgSrc = \"/attachment/index/48/\".$funcImg;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$imgSrc = file_exists( ROOT_PATH.$imgSrc ) ? $imgSrc : \"/images/8/icons/48/default.png\";\t\t\t\t\t\t\t\t$tempArray['funcName'] = $funcName;\t\t\t\t\t\t\t\t$tempArray['funcID'] = $funcID;\t\t\t\t\t\t\t\t$tempArray['imageLink'] = $imgSrc;\t\t\t\t\t\t\t\t$tempArray['menuLink'] = getmenulink( $funcCode, $funcName );\t\t\t\t\t\t\t\tarray_push( $returnArray, $tempArray );\t\t\t\t}\t\t\t\treturn $returnArray;}function IsHaveChildrenMenu( $userID, $menuID, $funcIDStr ){\t\t\t\tglobal $connection;\t\t\t\t$menuLength = strlen( $menuID );\t\t\t\t$query = \"SELECT COUNT(*) AS CNT FROM user_menu \\r\\n\\t\\t\\t   WHERE LEFT(MENU_ID,\".$menuLength.\")='\".$menuID.\"' \\r\\n\\t\\t\\t   AND LENGTH(MENU_ID)=\".( strlen( $menuID ) + 2 ).\" \\r\\n\\t\\t\\t   AND USER_ID='\".$userID.\"' \\r\\n\\t\\t\\t   AND FUNC_ID IN ({$funcIDStr})\\r\\n\\t\\t\\t   AND FUNC_ISSHOW = 1\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\tif ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( 0 < $row['CNT'] )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\treturn true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\treturn false;\t\t\t\t\t\t\t\t}\t\t\t\t}}function GetAllMenu( $userPriv, $userID, $langID ){\t\t\t\tglobal $connection;\t\t\t\t$funcIDStr = getuserfuncidstr( $userPriv );\t\t\t\t$funcIDStr = $funcIDStr == \"\" ? 0 : $funcIDStr;\t\t\t\t$query = \"SELECT \\r\\n\\t\\t\\t\\ta.FUNC_NAME AS FUNC_NAME_SYS,\\r\\n\\t\\t\\t\\ta.FUNC_NAME_PY AS FUNC_NAME_PY_SYS,\\r\\n\\t\\t\\t\\ta.FUNC_NAME_ZM AS FUNC_NAME_ZM_SYS,\\r\\n\\t\\t\\t\\tb.FUNC_ID,\\r\\n\\t\\t\\t\\tb.FUNC_NAME AS FUNC_NAME_USER,\\r\\n\\t\\t\\t\\tb.FUNC_NAME_PY AS FUNC_NAME_PY_USER,\\r\\n\\t\\t\\t\\tb.FUNC_NAME_ZM AS FUNC_NAME_ZM_USER,\\r\\n\\t\\t\\t\\tb.FUNC_CODE,\\r\\n\\t\\t\\t\\tb.FUNC_ISSYS,\\r\\n\\t\\t\\t\\tb.MENU_ID,\\r\\n\\t\\t\\t\\tc.FUNC_IMG \\r\\n\\t\\t\\t\\tFROM menu_lang AS a \\r\\n\\t\\t\\t\\tRIGHT JOIN user_menu AS b \\r\\n\\t\\t\\t\\tON a.FUNC_ID = b.FUNC_ID \\r\\n\\t\\t\\t\\tLEFT JOIN sys_function AS c \\r\\n\\t\\t\\t\\tON a.FUNC_ID = c.FUNC_ID \\r\\n\\t\\t\\t\\tWHERE ((b.FUNC_ID IN ({$funcIDStr}) AND b.FUNC_ISSYS=1 AND a.LANG_ID = \".$langID.\") \\r\\n\\t\\t\\t\\tOR b.FUNC_ISSYS=0) \\r\\n\\t\\t\\t\\tAND b.USER_ID = '\".$userID.\"' \\r\\n\\t\\t\\t\\tAND b.FUNC_ISSHOW = 1 ORDER BY b.ORDER_ID ASC\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$returnArray = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( $row['FUNC_ISSYS'] == 1 )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$funcName = $row['FUNC_NAME_SYS'];\t\t\t\t\t\t\t\t\t\t\t\t$funcNamePY = $row['FUNC_NAME_PY_SYS'];\t\t\t\t\t\t\t\t\t\t\t\t$funcNameZM = $row['FUNC_NAME_ZM_SYS'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$funcName = $row['FUNC_NAME_USER'];\t\t\t\t\t\t\t\t\t\t\t\t$funcNamePY = $row['FUNC_NAME_PY_USER'];\t\t\t\t\t\t\t\t\t\t\t\t$funcNameZM = $row['FUNC_NAME_ZM_USER'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$funcID = $row['FUNC_ID'];\t\t\t\t\t\t\t\t$menuID = $row['MENU_ID'];\t\t\t\t\t\t\t\t$funcCode = $row['FUNC_CODE'];\t\t\t\t\t\t\t\t$funcImg = $row['FUNC_IMG'];\t\t\t\t\t\t\t\t$menuIDLength = strlen( $menuID );\t\t\t\t\t\t\t\tif ( $funcCode == \"\" || strstr( $funcCode, \"@\" ) !== false )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$isParent = \"true\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$isParent = \"false\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $isParent == \"true\" && !ishavechildrenmenu( $userID, $menuID, $funcIDStr ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tcontinue;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $funcImg == \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$imgSrc = \"/images/8/icons/16/\".$funcID.\".png\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$imgSrc = \"/attachment/index/16/\".$funcImg;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$imgSrc = file_exists( ROOT_PATH.$imgSrc ) ? $imgSrc : \"/images/8/icons/16/default.png\";\t\t\t\t\t\t\t\t$tempArray['isParent'] = $isParent;\t\t\t\t\t\t\t\t$tempArray['funcName'] = $funcName;\t\t\t\t\t\t\t\t$tempArray['funcNamePY'] = $funcNamePY;\t\t\t\t\t\t\t\t$tempArray['funcNameZM'] = $funcNameZM;\t\t\t\t\t\t\t\t$tempArray['funcID'] = $funcID;\t\t\t\t\t\t\t\t$tempArray['imageLink'] = $imgSrc;\t\t\t\t\t\t\t\t$tempArray['menuID'] = $menuID;\t\t\t\t\t\t\t\t$tempArray['menuLink'] = getmenulink( $funcCode, $funcName );\t\t\t\t\t\t\t\tarray_push( $returnArray, $tempArray );\t\t\t\t}\t\t\t\treturn $returnArray;}function GetMenuByUserID( $userID ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT b.FUNC_ID_STR FROM user as a JOIN user_priv as b ON a.USER_PRIV=b.USER_PRIV WHERE a.USER_ID='\".$userID.\"'\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\tif ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\treturn $row['FUNC_ID_STR'];\t\t\t\t}}function GetUser( ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT a.*,b.DEPT_NAME,c.PRIV_NAME \\r\\n\\t\\t\\t\\tFROM user as a \\r\\n\\t\\t\\t\\tJOIN department as b \\r\\n\\t\\t\\t\\tON a.DEPT_ID = b.DEPT_ID \\r\\n\\t\\t\\t\\tJOIN user_priv as c \\r\\n\\t\\t\\t\\tON a.USER_PRIV = c.USER_PRIV \\r\\n\\t\\t\\t\\tWHERE a.DEPT_ID!=0 \\r\\n\\t\\t\\t\\tORDER BY a.LISTNUMBER,a.USER_NAME\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$returnArray = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\t$tempArray['deptID'] = $row['DEPT_ID'];\t\t\t\t\t\t\t\t$tempArray['userID'] = $row['USER_ID'];\t\t\t\t\t\t\t\t$tempArray['userName'] = $row['USER_NAME'];\t\t\t\t\t\t\t\t$tempArray['userPriv'] = $row['USER_PRIV'];\t\t\t\t\t\t\t\t$tempArray['avatarType'] = $row['AVATAR_TYPE'];\t\t\t\t\t\t\t\t$tempArray['department'] = $row['DEPT_NAME'];\t\t\t\t\t\t\t\t$tempArray['userPrivName'] = $row['PRIV_NAME'];\t\t\t\t\t\t\t\t$tempArray['email'] = $row['EMAIL'];\t\t\t\t\t\t\t\t$tempArray['phoneNumber'] = $row['MOBIL_NO'];\t\t\t\t\t\t\t\t$tempArray['birthday'] = $row['BIRTHDAY'];\t\t\t\t\t\t\t\t$tempArray['userNamePY'] = $row['USER_NAME_PY'];\t\t\t\t\t\t\t\t$tempArray['userNameZM'] = $row['USER_NAME_ZM'];\t\t\t\t\t\t\t\tarray_push( $returnArray, $tempArray );\t\t\t\t}\t\t\t\treturn $returnArray;}function GetDept( ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT DEPT_ID,DEPT_NAME,DEPT_PARENT FROM department ORDER BY DEPT_NO ASC\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$returnArray = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\t$tempArray['deptID'] = $row['DEPT_ID'];\t\t\t\t\t\t\t\t$tempArray['deptName'] = $row['DEPT_NAME'];\t\t\t\t\t\t\t\t$tempArray['deptParent'] = $row['DEPT_PARENT'];\t\t\t\t\t\t\t\tarray_push( $returnArray, $tempArray );\t\t\t\t}\t\t\t\treturn $returnArray;}function GetPriv( ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT USER_PRIV,PRIV_NAME FROM user_priv ORDER BY PRIV_NO\";\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$returnArray = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\t$tempArray['privID'] = $row['USER_PRIV'];\t\t\t\t\t\t\t\t$tempArray['privName'] = $row['PRIV_NAME'];\t\t\t\t\t\t\t\tarray_push( $returnArray, $tempArray );\t\t\t\t}\t\t\t\treturn $returnArray;}function SendMessage( $fromUserID, $toUserID, $content, $attachmentID, $attachmentName ){\t\t\t\tglobal $connection;\t\t\t\t$query = \"INSERT INTO sms  \\r\\n\\t\\t\\t(FROM_ID,TO_ID,SMS_TYPE,CONTENT,SEND_TIME,REMIND_FLAG,ATTACHMENT_ID,ATTACHMENT_NAME)\\r\\n\\t\\t\\tVALUES \\r\\n\\t\\t\\t('\".$fromUserID.\"','\".$toUserID.\"',0,'\".$content.\"',NOW(),1,'\".$attachmentID.\"','\".$attachmentName.\"')\";\t\t\t\treturn exequery( $connection, $query );}function GetMessage( $userID, $isOnlyNew ){\t\t\t\tglobal $connection;\t\t\t\t$CUR_TIME = date( \"Y-m-d H:i:s\", time( ) );\t\t\t\t$query = \"SELECT * FROM sms \\r\\n\\t\\t\\t\\t\\tWHERE TO_ID='\".$userID.\"' \\r\\n\\t\\t\\t\\t\\tAND receive_del = 0 \\r\\n\\t\\t\\t\\t\\tAND send_del  !=1  \\r\\n\\t\\t\\t\\t\\tAND SEND_TIME<='{$CUR_TIME}'\";\t\t\t\t$limit = \" LIMIT 0,30\";\t\t\t\tif ( $isOnlyNew )\t\t\t\t{\t\t\t\t\t\t\t\t$query .= \" AND REMIND_FLAG=1\";\t\t\t\t\t\t\t\t$limit = \"\";\t\t\t\t}\t\t\t\t$query .= \" ORDER BY SEND_TIME DESC \".$limit;\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t$returnArray = array( );\t\t\t\twhile ( $row = mysql_fetch_array( $result ) )\t\t\t\t{\t\t\t\t\t\t\t\t$tempArray['smsID'] = $row['SMS_ID'];\t\t\t\t\t\t\t\t$tempArray['smsType'] = $row['SMS_TYPE'];\t\t\t\t\t\t\t\t$tempArray['attachmentID'] = $row['ATTACHMENT_ID'];\t\t\t\t\t\t\t\t$tempArray['attachmentName'] = $row['ATTACHMENT_NAME'];\t\t\t\t\t\t\t\t$tempArray['fromUserID'] = $row['FROM_ID'];\t\t\t\t\t\t\t\t$tempArray['fromUserName'] = getusernamenew( $row['FROM_ID'] );\t\t\t\t\t\t\t\t$tempArray['fromUserAvatar'] = getuseravatartype( $row['FROM_ID'] );\t\t\t\t\t\t\t\t$tempArray['content'] = $row['CONTENT'];\t\t\t\t\t\t\t\t$tempArray['sendTime'] = $row['SEND_TIME'];\t\t\t\t\t\t\t\t$typeArray = getsmstypeurl( $row['SMS_TYPE'], $row['CONTENT'], $row['TABLE_ID'], $row['TABLE_VAR'], $row['TABLE_NAME'], $userID );\t\t\t\t\t\t\t\t$tempArray['typeText'] = $typeArray['TEXT'];\t\t\t\t\t\t\t\t$tempArray['typeUrl'] = $typeArray['URL'];\t\t\t\t\t\t\t\tarray_push( $returnArray, $tempArray );\t\t\t\t}\t\t\t\treturn $returnArray;}function SetMessageRead( $userID, $messageIDStr, $fromUserID ){\t\t\t\tglobal $connection;\t\t\t\t$CUR_TIME = date( \"Y-m-d H:i:s\", time( ) );\t\t\t\t$query = \"UPDATE `sms`\\r\\n\\t\\t\\t\\tSET `REMIND_FLAG` = 0 WHERE SEND_TIME<='{$CUR_TIME}' AND TO_ID='\".$userID.\"'\";\t\t\t\tif ( $fromUserID != \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$query .= \" AND FROM_ID='\".$fromUserID.\"'\";\t\t\t\t}\t\t\t\tif ( $messageIDStr != \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$query .= \" AND SMS_ID IN ({$messageIDStr})\";\t\t\t\t}\t\t\t\texequery( $connection, $query );}function CreateFile( $subject, $attachmentIDStr, $attachmentNameStr, $userID ){\t\t\t\tglobal $connection;\t\t\t\t$currentTime = date( \"Y-m-d H:i:s\", time( ) );\t\t\t\t$query = \"INSERT INTO `file_content`\\r\\n\\t\\t\\t\\t(\\r\\n\\t\\t\\t\\t`CONTENT_TYPE`,\\r\\n\\t\\t\\t\\t`SORT_ID`,\\r\\n\\t\\t\\t\\t`FROM_ID`,\\r\\n\\t\\t\\t\\t`SUBJECT`,\\r\\n\\t\\t\\t\\t`SEND_TIME`,\\r\\n\\t\\t\\t\\t`USER_ID`,\\r\\n\\t\\t\\t\\t`ATTACHMENT_ID`,\\r\\n\\t\\t\\t\\t`ATTACHMENT_NAME`,\\r\\n\\t\\t\\t\\t`FILE_TYPE`)\\r\\n\\t\\t\\t\\tVALUES\\r\\n\\t\\t\\t\\t(\\r\\n\\t\\t\\t\\t1,\\r\\n\\t\\t\\t\\t-1,\\r\\n\\t\\t\\t\\t0,\\r\\n\\t\\t\\t\\t'\".$subject.\"',\\r\\n\\t\\t\\t\\t'\".$currentTime.\"',\\r\\n\\t\\t\\t\\t'\".$userID.\"',\\r\\n\\t\\t\\t\\t'\".$attachmentIDStr.\"',\\r\\n\\t\\t\\t\\t'\".$attachmentNameStr.\"',\\r\\n\\t\\t\\t\\t1);\";\t\t\t\texequery( $connection, $query );\t\t\t\treturn mysql_insert_id( );}function GetNewVersion( ){\t\t\t\tglobal $connection;\t\t\t\t$getVersionQuery = \"SELECT * FROM `client_version` ORDER BY DATE_TIME DESC LIMIT 0,1\";\t\t\t\t$getVersionResult = exequery( $connection, $getVersionQuery );\t\t\t\tif ( $getVersionRow = mysql_fetch_array( $getVersionResult ) )\t\t\t\t{\t\t\t\t\t\t\t\t$return['version'] = $getVersionRow['VERSION'];\t\t\t\t\t\t\t\t$getReadmeQuery = \"SELECT * FROM `client_version_readme` WHERE CLIENT_VERSION_ID=\".$getVersionRow['CLIENT_VERSION_ID'];\t\t\t\t\t\t\t\t$getReadmeResult = exequery( $connection, $getReadmeQuery );\t\t\t\t\t\t\t\twhile ( $getReadmeRow = mysql_fetch_array( $getReadmeResult ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$temp['subject'] = $getReadmeRow['README_SUBJECT'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['describe'] = $getReadmeRow['README_DESCRIBE'];\t\t\t\t\t\t\t\t\t\t\t\t$temp['image'] = $getReadmeRow['README_IMAGE'];\t\t\t\t\t\t\t\t\t\t\t\tif ( !is_array( $return['readme'] ) )\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$return['readme'] = array( );\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\tarray_push( $return['readme'], $temp );\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\treturn $return;}function Attend( $userID, $deptID, $privID, $checkType ){\t\t\t\t$userInfor['UserId'] = $userID;\t\t\t\t$userInfor['DepyId'] = $deptID;\t\t\t\t$userInfor['PrivId'] = $privID;\t\t\t\t$userInfor['LoginCheck'] = $checkType;\t\t\t\t$attend = new attend( );\t\t\t\t$result = $attend->GetLoginInOut( $userInfor );\t\t\t\tif ( $checkType == \"in\" )\t\t\t\t{\t\t\t\t\t\t\t\treturn $result['LoginInLateTime'];\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\treturn $result['LoginOutEarlyTime'];\t\t\t\t}}function CheckIsSignIn( $userID ){\t\t\t\t$attend = new attend( );\t\t\t\t$dutyId = $attend->getUserDutyType( $userID );\t\t\t\t$dutyArray = $attend->getDutyData( $dutyId );\t\t\t\treturn $attend->isSignIn( $dutyArray, $dutyId, $userID );}include_once( \"nusoap/lib/nusoap.php\" );include_once( \"inc/conn.php\" );include_once( \"api/user.class.php\" );include_once( \"api/attend.class.php\" );include_once( \"inc/utility_all.php\" );include_once( \"general/workflow/prcs_role.php\" );include_once( \"lang/cn/common.lang.php\" );$server = new soap_server( );$server->soap_defencoding = \"UTF-8\";$server->decode_utf8 = false;$server->configureWSDL( \"EofficeService\", \"urn:EofficeService\" );$server->wsdl->schemaTargetNamespace = \"urn:EofficeService\";$server->wsdl->addComplexType( \"UserLoginReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"code\" => array( \"name\" => \"code\", \"type\" => \"xsd:string\" ), \"infor\" => array( \"name\" => \"infor\", \"type\" => \"tns:userInforObj\" ) ) );$server->wsdl->addComplexType( \"userInforObj\", \"complexType\", \"struct\", \"all\", \"\", array( \"sessionID\" => array( \"name\" => \"sessionID\", \"type\" => \"xsd:string\" ), \"userID\" => array( \"name\" => \"userID\", \"type\" => \"xsd:string\" ), \"deptID\" => array( \"name\" => \"deptID\", \"type\" => \"xsd:string\" ), \"privID\" => array( \"name\" => \"privID\", \"type\" => \"xsd:string\" ), \"userName\" => array( \"name\" => \"userName\", \"type\" => \"xsd:string\" ), \"userAccount\" => array( \"name\" => \"userAccount\", \"type\" => \"xsd:string\" ), \"avatarType\" => array( \"name\" => \"userAvatar\", \"type\" => \"xsd:string\" ), \"slogan\" => array( \"name\" => \"slogan\", \"type\" => \"xsd:string\" ), \"smsFrequency\" => array( \"name\" => \"smsFrequency\", \"type\" => \"xsd:string\" ), \"smsUploadParam\" => array( \"name\" => \"smsUploadParam\", \"type\" => \"tns:smsUploadParam\" ), \"documentUploadParam\" => array( \"name\" => \"documentUploadParam\", \"type\" => \"tns:documentUploadParam\" ) ) );$server->wsdl->addComplexType( \"smsUploadParam\", \"complexType\", \"struct\", \"all\", \"\", array( \"maxNumber\" => array( \"name\" => \"maxNumber\", \"type\" => \"xsd:string\" ), \"singleMaxSize\" => array( \"name\" => \"singleMaxSize\", \"type\" => \"xsd:string\" ), \"totalMaxSize\" => array( \"name\" => \"totalMaxSize\", \"type\" => \"xsd:string\" ), \"denySuffix\" => array( \"name\" => \"denySuffix\", \"type\" => \"xsd:string\" ) ) );$server->wsdl->addComplexType( \"documentUploadParam\", \"complexType\", \"struct\", \"all\", \"\", array( \"maxNumber\" => array( \"name\" => \"maxNumber\", \"type\" => \"xsd:string\" ), \"singleMaxSize\" => array( \"name\" => \"singleMaxSize\", \"type\" => \"xsd:string\" ), \"totalMaxSize\" => array( \"name\" => \"totalMaxSize\", \"type\" => \"xsd:string\" ), \"denySuffix\" => array( \"name\" => \"denySuffix\", \"type\" => \"xsd:string\" ) ) );$server->register( \"UserLogin\", array( \"userAccount\" => \"xsd:string\", \"password\" => \"xsd:string\" ), array( \"return\" => \"tns:UserLoginReturn\" ), \"urn:EofficeService\", \"urn:EofficeService#UserLogin\", \"rpc\", \"encoded\", \"UserLogin\" );$server->wsdl->addComplexType( \"languageRerurnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:languageReturn[]\" ) ), \"tns:languageReturn\" );$server->wsdl->addComplexType( \"languageReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"langID\" => array( \"name\" => \"langID\", \"type\" => \"xsd:string\" ), \"langName\" => array( \"name\" => \"langName\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetLanguage\", array( ), array( \"return\" => \"tns:languageRerurnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetLanguage\", \"rpc\", \"encoded\", \"GetLanguage\" );$server->wsdl->addComplexType( \"menuRerurnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:menuReturn[]\" ) ), \"tns:menuReturn\" );$server->wsdl->addComplexType( \"menuReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"funcName\" => array( \"name\" => \"funcName\", \"type\" => \"xsd:string\" ), \"funcID\" => array( \"name\" => \"funcID\", \"type\" => \"xsd:string\" ), \"menuLink\" => array( \"name\" => \"menuLink\", \"type\" => \"xsd:string\" ), \"imageLink\" => array( \"name\" => \"imageLink\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetCommonMenu\", array( \"userPriv\" => \"xsd:string\", \"userID\" => \"xsd:string\", \"langID\" => \"xsd:string\" ), array( \"return\" => \"tns:menuRerurnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetCommonMenu\", \"rpc\", \"encoded\", \"GetCommonMenu\" );$server->wsdl->addComplexType( \"allMenuRerurnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:allMenuReturn[]\" ) ), \"tns:allMenuReturn\" );$server->wsdl->addComplexType( \"allMenuReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"funcName\" => array( \"name\" => \"funcName\", \"type\" => \"xsd:string\" ), \"funcNamePY\" => array( \"name\" => \"funcNamePY\", \"type\" => \"xsd:string\" ), \"funcNameZM\" => array( \"name\" => \"funcNameZM\", \"type\" => \"xsd:string\" ), \"funcID\" => array( \"name\" => \"funcID\", \"type\" => \"xsd:string\" ), \"menuLink\" => array( \"name\" => \"menuLink\", \"type\" => \"xsd:string\" ), \"menuID\" => array( \"name\" => \"menuID\", \"type\" => \"xsd:string\" ), \"isParent\" => array( \"name\" => \"isParent\", \"type\" => \"xsd:string\" ), \"imageLink\" => array( \"name\" => \"imageLink\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetAllMenu\", array( \"userPriv\" => \"xsd:string\", \"userID\" => \"xsd:string\", \"langID\" => \"xsd:string\" ), array( \"return\" => \"tns:allMenuRerurnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetAllMenu\", \"rpc\", \"encoded\", \"Get All Menu\" );$server->register( \"GetMenuByUserID\", array( \"userID\" => \"xsd:string\" ), array( \"return\" => \"xsd:string\" ), \"urn:EofficeService\", \"urn:EofficeService#GetMenuByUserID\", \"rpc\", \"encoded\", \"GetMenuByUserID\" );$server->wsdl->addComplexType( \"userReturnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:userReturn[]\" ) ), \"tns:userReturn\" );$server->wsdl->addComplexType( \"userReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"deptID\" => array( \"name\" => \"deptID\", \"type\" => \"xsd:string\" ), \"userPriv\" => array( \"name\" => \"userPriv\", \"type\" => \"xsd:string\" ), \"userID\" => array( \"name\" => \"userID\", \"type\" => \"xsd:string\" ), \"userName\" => array( \"name\" => \"userName\", \"type\" => \"xsd:string\" ), \"avatarType\" => array( \"name\" => \"avatarType\", \"type\" => \"xsd:string\" ), \"department\" => array( \"name\" => \"department\", \"type\" => \"xsd:string\" ), \"userPrivName\" => array( \"name\" => \"userPrivName\", \"type\" => \"xsd:string\" ), \"email\" => array( \"name\" => \"email\", \"type\" => \"xsd:string\" ), \"phoneNumber\" => array( \"name\" => \"phoneNumber\", \"type\" => \"xsd:string\" ), \"birthday\" => array( \"name\" => \"birthday\", \"type\" => \"xsd:string\" ), \"userNamePY\" => array( \"name\" => \"userNamePY\", \"type\" => \"xsd:string\" ), \"userNameZM\" => array( \"name\" => \"userNameZM\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetUser\", array( ), array( \"return\" => \"tns:userReturnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetUser\", \"rpc\", \"encoded\", \"Get User\" );$server->wsdl->addComplexType( \"deptReturnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:deptReturn[]\" ) ), \"tns:deptReturn\" );$server->wsdl->addComplexType( \"deptReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"deptID\" => array( \"name\" => \"deptID\", \"type\" => \"xsd:string\" ), \"deptName\" => array( \"name\" => \"deptName\", \"type\" => \"xsd:string\" ), \"deptParent\" => array( \"name\" => \"deptParent\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetDept\", array( ), array( \"return\" => \"tns:deptReturnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetDept\", \"rpc\", \"encoded\", \"Get Dept\" );$server->wsdl->addComplexType( \"privReturnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:privReturn[]\" ) ), \"tns:privReturn\" );$server->wsdl->addComplexType( \"privReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"privID\" => array( \"name\" => \"privID\", \"type\" => \"xsd:string\" ), \"privName\" => array( \"name\" => \"privName\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetPriv\", array( ), array( \"return\" => \"tns:privReturnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetPriv\", \"rpc\", \"encoded\", \"Get Priv\" );$server->register( \"SendMessage\", array( \"fromUserID\" => \"xsd:string\", \"toUserID\" => \"xsd:string\", \"content\" => \"xsd:string\", \"attachmentID\" => \"xsd:string\", \"attachmentName\" => \"xsd:string\" ), array( \"return\" => \"xsd:string\" ), \"urn:EofficeService\", \"urn:EofficeService#SendMessage\", \"rpc\", \"encoded\", \"SendMessage\" );$server->wsdl->addComplexType( \"messageReturnArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:messageReturn[]\" ) ), \"tns:messageReturn\" );$server->wsdl->addComplexType( \"messageReturn\", \"complexType\", \"struct\", \"all\", \"\", array( \"fromUserName\" => array( \"name\" => \"fromUserName\", \"type\" => \"xsd:string\" ), \"content\" => array( \"name\" => \"content\", \"type\" => \"xsd:string\" ), \"sendTime\" => array( \"name\" => \"sendTime\", \"type\" => \"xsd:string\" ), \"fromUserAvatar\" => array( \"name\" => \"fromUserAvatar\", \"type\" => \"xsd:string\" ), \"fromUserID\" => array( \"name\" => \"fromUserID\", \"type\" => \"xsd:string\" ), \"smsID\" => array( \"name\" => \"smsID\", \"type\" => \"xsd:string\" ), \"smsType\" => array( \"name\" => \"smsType\", \"type\" => \"xsd:string\" ), \"attachmentID\" => array( \"name\" => \"attachmentID\", \"type\" => \"xsd:string\" ), \"attachmentName\" => array( \"name\" => \"attachmentName\", \"type\" => \"xsd:string\" ), \"typeText\" => array( \"name\" => \"typeText\", \"type\" => \"xsd:string\" ), \"typeUrl\" => array( \"name\" => \"typeUrl\", \"type\" => \"xsd:string\" ), \"smsTypeName\" => array( \"name\" => \"smsTypeName\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetMessage\", array( \"userID\" => \"xsd:string\", \"isOnlyNew\" => \"xsd:boolean\" ), array( \"return\" => \"tns:messageReturnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetMessage\", \"rpc\", \"encoded\", \"GetMessage\" );$server->register( \"SetMessageRead\", array( \"userID\" => \"xsd:string\", \"messageIDStr\" => \"xsd:string\", \"fromUserID\" => \"xsd:string\" ), array( ), \"urn:EofficeService\", \"urn:EofficeService#SetMessageRead\", \"rpc\", \"encoded\", \"SetMessageRead\" );$server->register( \"CreateFile\", array( \"subject\" => \"xsd:string\", \"attachmentIDStr\" => \"xsd:string\", \"attachmentNameStr\" => \"xsd:string\", \"userID\" => \"xsd:string\" ), array( \"return\" => \"xsd:string\" ), \"urn:EofficeService\", \"urn:EofficeService#CreateFile\", \"rpc\", \"encoded\", \"CreateFile\" );$server->wsdl->addComplexType( \"newVersionReturnArray\", \"complexType\", \"struct\", \"all\", \"\", array( \"version\" => array( \"name\" => \"version\", \"type\" => \"xsd:string\" ), \"readme\" => array( \"name\" => \"readme\", \"type\" => \"tns:newVersionReadmeArray\" ) ) );$server->wsdl->addComplexType( \"newVersionReadmeArray\", \"complexType\", \"array\", \"\", \"SOAP-ENC:Array\", array( ), array( array( \"ref\" => \"SOAP-ENC:arrayType\", \"wsdl:arrayType\" => \"tns:newVersionReadme[]\" ) ), \"tns:newVersionReadme\" );$server->wsdl->addComplexType( \"newVersionReadme\", \"complexType\", \"struct\", \"all\", \"\", array( \"subject\" => array( \"name\" => \"subject\", \"type\" => \"xsd:string\" ), \"describe\" => array( \"name\" => \"describe\", \"type\" => \"xsd:string\" ), \"image\" => array( \"name\" => \"image\", \"type\" => \"xsd:string\" ) ) );$server->register( \"GetNewVersion\", array( ), array( \"return\" => \"tns:newVersionReturnArray\" ), \"urn:EofficeService\", \"urn:EofficeService#GetNewVersion\", \"rpc\", \"encoded\", \"GetNewVersion\" );$server->register( \"Attend\", array( \"userID\" => \"xsd:string\", \"deptID\" => \"xsd:string\", \"privID\" => \"xsd:string\", \"checkType\" => \"xsd:string\" ), array( \"return\" => \"xsd:string\" ), \"urn:EofficeService\", \"urn:EofficeService#Attend\", \"rpc\", \"encoded\", \"Attend\" );$server->register( \"CheckIsSignIn\", array( \"userID\" => \"xsd:string\" ), array( \"return\" => \"xsd:string\" ), \"urn:EofficeService\", \"urn:EofficeService#CheckIsSignIn\", \"rpc\", \"encoded\", \"CheckIsSignIn\" );$server->service( $HTTP_RAW_POST_DATA );?>\n1.这个文件内容，直到最后也没有任何auth控制，也就是说我们可以通过未授权访问了2.传递参数HTTP_RAW_POST_DATA  这个不走gpc为了方便期间，我这里偷个懒，对http://eoffice.sccm.cn/attachment/mysql_log.sql这个站点mysql配置了抓取\n\n 测试完了，删除即可然后我再次偷懒，下载了wsdigger软件，进行webservice的wsdl文件解析\n\n首先我们看信息泄露：\n\n\n\n\n\n然后我们看sql注射，这里我举两个例子就可以了，因为这个里面的sql语句都带有\\r\\n\\t\\t\\t\\做换行，这种的注释，直接/*就可以做到，其他的都不管用先看UserLogin 这个借口：里面的 userAccount 为admin' union select 1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10,10,1,2,3,4,5,6,7,8,9,10,10,1,2,3,4,5,6,7,8,9,10,10,1,2,3,4,5,6,7,8,9,10,1,'wooyun' into outfile 'D:/eoffice/webroot/attachment/wooyun.php'#\n\n\n\n访问：http://eoffice.sccm.cn/attachment/wooyun.php\n\n下来看看 第二种sql注射：测试createFile这个接口：\n\n当你点击invoke时候就会发成延迟，我们抓取到的sql语句为：\n\nok  统计一下有10处，案例不多举例子了http://oa.sccm.cn//webservice/eoffice.wsdl.php?wsdlhttp://oa.vma.cn/webservice/eoffice.wsdl.php?wsdlhttp://eoffice.sccm.cn/webservice/eoffice.wsdl.php?wsdlhttp://eoffice8.weaver.cn:8028/webservice/eoffice.wsdl.php?wsdl   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2015-07-10 11:56 厂商回复： CNVD确认并复现所述情况，已由CNVD通过软件生产厂商（或网站管理方）公开联系渠道向其邮件（和电话）通报，由其后续提供解决方案并协调相关用户单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-08 12:53 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1575 漏洞数:191        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  通用的又有钱了？这么速度    \n     2015-07-08 12:54 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Coody 估计是乌云收到投资了吧，呵呵    \n     2015-07-08 12:59 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1575 漏洞数:191        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @menmen519 两个数 or 五个数    \n     2015-07-08 13:06 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Coody 这个在乌云不值钱，看钱来看，是小厂商    \n     2015-07-08 13:19 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1575 漏洞数:191        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @menmen519 懂了`(*∩_∩*)′    \n     2015-07-08 14:40 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @menmen519 这个是在提升体验啊，难道没感觉到？    \n     2015-07-08 14:53 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @疯狗 确实的，希望一直这样下去，通用的就耍起了，呵呵    \n     2015-07-09 15:02 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  我的都还没$呢o(╯□╰)o    \n     2015-07-09 15:42 |    \t\t君宝 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 不要跟我比浪。。你浪不过我。。)\t\t \n  过来点赞！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}