{"id": 383, "wybug_id": "wooyun-2014-070366", "wybug_title": "qibocms全部开源系统 Getshell", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-07-31 10:37", "wybug_open_date": "2014-10-29 10:38", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向公众公开  简要描述： 多研究研究了会 发现可以Getshell。看了看qibo所有的开源系统 都存在这洞。无需登录 Getshell。之前一直在因为不能直接闭合而纠结。找P神指点了指点 成功搞定。用整站系统来演示一下把。______________________________________________________________________P.S. 狗哥 能否送我个邀请码/hx 详细说明：  全局过滤函数\nfunction Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t@eregi(\"['\\\\\\\"&]+\",$key) && die('ERROR KEY!');\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n看似修复得很完美 可是呢。\n\n被匹配出当像下图这样提交的时候 匹配的key是asd 那么就不会被匹配出 就不会被过滤。\n\n在label_module.php中  这里无需登录任何\nelse{\tforeach($label AS $key=>$value)\t{\t    var_dump ($value);exit;\t\t//如果是新标签时,即为数组array(),要清空\t\tif(is_array($value))\t\t{\t\t\t$label[$key]='';\t\t}\t}\t//写缓存\tif( (time()-filemtime($FileName))>($webdb[label_cache_time]*60) ){\t\t$_shows=\"<?php\\r\\n\\$haveCache=1;\\r\\n\";\t\t\tforeach($label AS $key=>$value){\t\t\t$value=addslashes($value);\t\t\t$_shows.=\"\\$label['$key']=stripslashes('$value');\\r\\n\";\t\t}\t\twrite_file($FileName,$_shows.'?>');\t}\t}\n由于qibo是 \nforeach($_POST AS $_key=>$_value){\t!ereg(\"^\\_[A-Z]+\",$_key) && $$_key=$_POST[$_key];}foreach($_GET AS $_key=>$_value){\t!ereg(\"^\\_[A-Z]+\",$_key) && $$_key=$_GET[$_key];}\n所以这变量$label 可以直接控制。然后循环出来 数组中的key 和 value 都直接写入到了缓存文件中。这里由于value 全局的函数 会受到第一次转义 $value=addslashes($value);这里又经过了第二次转义 那么就是a\\\\\\' \"\\$label['$key']=stripslashes('$value');\\r\\n\" 写入时候的代码 就看有个stripslashes 其实是不会被执行的 而就是把stripslashes写入到文件当中。这时候只有来利用key 由于在全局的过滤函数中没对key做addslashes(也不能做addslashes)  所以不会被转义   而且结合上面的 就直接绕过了。当写入到文件中的时候是这样的。\n\n\n\nkey中直接含单引号 被匹配到然后退出了。结合上面的方式绕过。\n\n这时候写入的代码为 $label['asd'']=stripslashes('');后面的stripslashes('') 为啥是空的了呢如果不是空的还能利用转义符来搞。因为我们这样提交index.php?label[asd'][asd]=asda' 这样的那么他的value是数组\nif(is_array($value))\t\t{\t\t\t$label[$key]='';\t\t}\n就清空了。一开始我一直在纠结如果闭合之前的这个[ 我就需要提交一个yu']# 类似这样的可是写入的是数组中的key 如果要在key中写入]的话 那么就成了http://web.com/qibov7/index.php?label[asd']][asd]=asda'就成了[asd']] 这样 那么提交的] 和之前[ 闭合 然后key就还是asd' 然后就一直在这纠结这个问题。。后面问了问P神 尼玛 瞬间给我解决。P神给的['a'.\"${phpinfo()}\".''] 利用双引号的二次解析来Getshell那么就让我们的key为a'.\"${phpinfo()}\".' 这个就行了  不含] \n\n测试一下能不能执行\n\n竟然报错了?    这里我们用一下错误抑制符那么也就是['a'.\"${@phpinfo()}\".''] 提交的key为a'.\"${@phpinfo()}\".'\n\n\n\n成功执行。后面我再简化了一下其实是不需要用到双引号的二次解析的[''.phpinfo().'']  提交的key为'.phpinfo().' 依旧可以直接执行  之前的思维一直就是想着去闭合。唉。___________________________________________________________________________内容可以搞定了 这里我们再来看一下文件名是咋来的\n$FileName=ROOT_PATH.\"cache/label_cache/\";\tif(!is_dir($FileName)){\t\tmakepath($FileName);\t}\t$FileName.=(ereg(\"\\.php\",basename($WEBURL))?preg_replace(\"/\\.php(.*)/\",\"\",basename($WEBURL)):'index').\"_\".intval($ch).\"_\".intval($ch_pagetype).\"_\".intval($ch_module).\"_\".intval($ch_fid).\"_\".intval($city_id).'_'.substr(md5(getTpl(\"index\",$chdb[main_tpl])),0,5).\".php\";\n首先目录cache/label_cache/  再来看文件名 _\".intval($ch).\"_\".intval($ch_pagetype).\"_\".intval($ch_module).\"_\".intval($ch_fid).\"_\".intval($city_id).'_'.substr(md5(getTpl(\"index\",$chdb[main_tpl])),0,5).\".php\"就是经过一系列的转整 除开$ch 为1   其他的那些变量 我们都没去定义 那么intval 后为0那么就是index_1_0_0_0_0_substr(md5(getTpl(\"index\",$chdb[main_tpl])),0,5).php来看一下这个 getTpl(\"index\",$chdb[main_tpl])这个其实就是模版地址 网站的绝对路径+默认模版地址这里用到了网站的绝对路径 所以我们要找一个可以泄漏绝对路径的。会泄漏绝对路径的地方很多 我随便贴两处把http://v7.qibosoft.com/data/label_hf.phphttp://v7.qibosoft.com//do/fontimg.phphttp://v7.qibosoft.com//hack/gather/inc/show_system_fid.php以为本地测试为例\n\nD:\\ApmServ\\www\\htdocs\\qibov7\\data\\label_hf.php 那么网站的绝对路径就为 D:\\ApmServ\\www\\htdocs\\qibov7再加上默认模版路径/template/default/index.htm那就是 D:\\ApmServ\\www\\htdocs\\qibov7/template/default/index.htm对这个进行md5一次 得到82e4a1041f04d2edb779e87b37623786然后他这里是substr(md5(getTpl(\"index\",$chdb[main_tpl])),0,5)取前5位那么就是82e4a    再拼凑起来那么就得到  cache/label_cache/index_1_0_0_0_0_82e4a.php  \n\n找文件的第二种方法 在windows iis下可以利用短文件名来猜解如果windows apache的话 那就更简单了直接cache/label_cache/index_~1.php\n\n直接就可以了。当然 5位 也可以尝试爆破一下嘛 哈哈。   漏洞证明：  见上面把。   修复方案：  这个我也不太清楚了 你们自己好好思考思考把。 这个文件 每个开源的系统中都有。每个都要修改。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-01 10:58 厂商回复： 老问题 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-31 10:39 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  关注！    \n     2014-07-31 10:44 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  前排膜拜..    \n     2014-07-31 10:45 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  楼主你悄悄的告诉我吧...    \n     2014-07-31 10:45 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  碉堡    \n     2014-07-31 11:21 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @roker 肉棒 你又调皮了。    \n     2014-07-31 11:52 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  有事因为补丁惹的祸？    \n     2014-07-31 11:52 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @xfkxfk 没啦 之前就有了。    \n     2014-07-31 12:55 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  膜拜雨牛    \n     2014-07-31 14:40 |    \t\tchock \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:15        | 今夜我们都是wooyun人，我们一定要收购长亭)\t\t \n  看来学习代码审计很重要了    \n     2014-08-01 10:03 |    \t\tC4ndy \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        )\t\t \n  Mark   膜拜下洞主    \n     2014-08-01 11:03 |    \t\t′king \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:8        | 马甲甲)\t\t \n  坐等把这老问题 出个牛逼的补丁@齐博cms    \n     2014-08-04 13:07 |    \t\t发条橙子 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:6        | ∑(っ °Д °;)っ)\t\t \n  不会又来重装下    \n     2014-08-04 13:16 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @发条橙子 No 不需重装    \n     2014-08-04 15:43 |    \t\t发条橙子 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:6        | ∑(っ °Д °;)っ)\t\t \n  @′  雨。  这个系统木有看过。- , -不会是缓存之类的。。把某些敏感信息写到某个文件里了。。。     \n     2014-08-04 20:03 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  看了下，利用起来比较负责。。。并且后面的文件名不好控制。。。    \n     2014-08-04 20:03 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  到时候还是我来放个无任何限制的getshell吧    \n     2014-08-05 14:07 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  @eregi(\"['\\\\\\\"&]+\",$key) && die('ERROR KEY!');补丁好像是过滤了键名，注入是不是发生在这个地方。以往的确没有对键名过滤    \n     2014-08-05 19:36 |    \t\t小小鸟 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 小白一个)\t\t \n     求姿势    \n     2014-08-23 17:35 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  那么牛逼    \n     2014-09-10 13:42 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  膜拜大牛    \n     2014-09-29 01:51 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  你这个是那个版本的? $label['a\\'.\\\"${@phpinfo()}\\\".\\'']=stripslashes('');    \n     2014-09-29 01:54 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  假冒漏洞吧？自己改内容的？    \n     2014-09-29 08:23 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @saviour  懂gpc吗？    \n     2014-09-29 08:25 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @saviour 别随时都假冒漏洞假冒漏洞的来  看着就恶心， 麻烦自己多思考原因。    \n     2014-09-29 14:33 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  如果不行的话，就别写这么恶心的标题来忽悠人了，我看过你的一些漏洞，都鸡巴好恶心人的感觉，鸡肋！    \n     2014-09-29 15:03 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @saviour   呵呵  就你牛逼行了吧？  gpc都不知道的大牛  膜拜你了    \n     2014-09-29 15:05 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @saviour  没啥好说的  看了你的漏洞顿时觉得更膜拜了，       \n     2014-09-29 15:23 |    \t\tTr0jan \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:3        | 关注网络安全)\t\t \n  @saviour  哈哈，   gpc都不知道的大牛，  还能看懂别人分析代码的？          能看懂别人的洞再说话 ，  对于你这种只知道用别人东西的 不知道分析还要叫唤的  我也真是被恶心到了。    \n     2014-09-29 15:46 |    \t\t‫‌ \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:14        )\t\t \n  @saviour 你简直再不是个恶心人    \n     2014-09-29 16:19 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @′  雨。 我也是各种被说 哎 以后路人甲吧 各自发表自己的    \n     2014-10-29 10:46 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  @menmen519 @′  雨。 别理就行，求别匿名，还要关注你们的洞呢    \n     2015-03-25 23:08 |    \t\t贱son \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | GE0)\t\t \n  @′雨。 如果上面是iis7或7.5那个。后在那几个怎么通配啊？爆破不了，上面那几个报错文件也是被设置了错误500，就是看不了绝对路径！！求方法。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}