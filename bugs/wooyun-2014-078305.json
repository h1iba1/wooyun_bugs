{"id": 50274, "wybug_id": "wooyun-2014-078305", "wybug_title": "Yuncart#多处存储型xss", "wybug_corp": "Yuncart", "wybug_author": "小邪", "wybug_date": "2014-10-13 10:31", "wybug_open_date": "2015-01-11 10:32", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-13：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-01-11：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： Yuncart#多处存储型xss 皆可打后台cookie 官方demo测试 详细说明：  第一处xss/include/front/member.class.php\npublic function address() {\t\tif(ispostreq()) {\t\t\t$addressid = intval($_POST[\"addressid\"]);\t\t\t//如果是修改，但是没有权限\t\t\tif($addressid\t&& !DB::getDB()->selectexist(\"user_address\",\"addressid\",\"addressid='$addressid' AND uid='\".$this->uid.\"'\") ) {\t\t\t\t$this->setHint(\"user_no_priv\",\"error\");\t\t\t}\t\t\t\t\t\t//参数\t\t\t$receiver = trim($_POST[\"receiver\"]);\t\t\t$province = trim($_POST[\"province\"]);\t\t\t$city\t  = trim($_POST[\"city\"]);\t\t\t$district = trim($_POST[\"district\"]);\t\t\t$zipcode  = trim($_POST[\"zipcode\"]);\t\t\t$link\t  = trim($_POST[\"link\"]);\t\t\t$address  = trim($_POST[\"address\"]);\t\t\t$data = array(\t\t\t\t\t\"receiver\"\t=>$receiver,\t\t\t\t\t\"province\"\t=>$province,\t\t\t\t\t\"city\"\t\t=>$city,\t\t\t\t\t\"district\"\t=>$district,\t\t\t\t\t\"zipcode\"\t=>$zipcode,\t\t\t\t\t\"link\"\t\t=>$link,\t\t\t\t\t\"address\"\t=>$address,\t\t\t\t\t\"uid\"\t\t=>$this->uid);\t\t\t$text  = '';\t\t\tif($addressid) { //修改地址\t\t\t\t$text = 'edit';\t\t\t\tDB::getDB()->update(\"user_address\",$data,\"addressid='$addressid'\");\t\t\t} else { //增加地址\t\t\t\t$text = 'add';\t\t\t\tDB::getDB()->insert(\"user_address\",$data);\t\t\t}\t\t\t$this->setHint(\"address_{$text}_success\",\"success\");\t\t} else {\t\t\t$this->getHint();\t\t\tif(isset($_GET[\"op\"])\t&& ($_GET['op'] == 'edit')\t) { //操作\t\t\t\t$addressid = intval($_GET[\"addressid\"]);\t\t\t\t$this->data[\"address\"] = DB::getDB()->selectrow(\"user_address\",\"*\",\"addressid='$addressid' AND uid='\".$this->uid.\"'\");\t\t\t\tif(!$this->data[\"address\"]) {\t\t\t\t\t$this->setHint(\"address_not_exist\",\"error\");\t\t\t\t}\t\t\t\t$this->getDistrictopt($this->data[\"address\"]['province'],$this->data[\"address\"]['city'],$this->data[\"address\"]['district']);\t\t\t\t$this->data['opertype'] = \"edit\";\t\t\t} else {\t\t\t\t$this->data['opertype'] = \"add\";\t\t\t}\t\t\t//收货地址列表\t\t\t$this->data['addresslist'] = DB::getDB()->select(\"user_address\",\"*\",\"uid='\".$this->uid.\"'\");\t\t\t$this->output(\"myaddress\");\t\t}\t}\n跟踪update\npublic function update($tableName,$data,$where,$only = false) {\t\t$sql = \"UPDATE \".$this->getTableName($tableName).\" SET \";\t\tif(is_array($data)) {\t\t\tforeach($data as $key=>$val) {\t\t\t\t$sql .= $this->escapekey($key) . \"=\" . $this->escapeval($val).\",\";\t\t\t}\t\t} else {\t\t\t$sql .= $data;\t\t}\t\t\t\t$sql = rtrim($sql,\",\").\" \"\t\t\t . $this->buildWhere($where)\t\t\t . ($only?\" LIMIT 1\":\"\")\t\t\t ;\t\t\t\t$this->query($sql);\t\treturn $this->errno?false:true;\n进query看看\npublic function query($sql) {\t\t$sql = preg_replace(\"/`(.+?)`/\",\"\\\"\\\\1\\\"\",$sql);//执行mysql的`替换成\"\t\t\t\t$this->lastSql = $sql;\t\t$this->statement = $this->conn->prepare($sql);\t\tif(false === $this->statement) {\t\t\t\t\t}\t\t$result = $this->statement->execute();\t\tif(false === $result) {\t\t\t$error\t\t   = $this->statement->errorInfo();\t\t\t$this->error   = $error[2];\t\t\t$this->errno   = $this->statement->errorCode();\t\t\tif($this->errno) {\t\t\t\tcerror(\"sqlsrv error:\".$this->errno.\"  \".$this->error);\t\t\t}\t\t}\t\t$this->querynum++;\t}\n可以看到query只过滤了注入字符未对xss的关键字符进行过滤 因此存在xss首先注册一个帐户 进入用户中心修改收货地址\n\n保存 然后去商场选一件商品 提交订单时选择使用刚才的地址 本地弹\n\n提交订单 我们去后台看看\n\n    漏洞证明：  第二处xss选择一件商品购买 订单备注处插入代码 提交\n\n我们进后台看看 查看订单详情\n\n   修复方案：  对xss关键字符进行过滤   版权声明：转载请注明来源 小邪@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}