{"id": 10272, "wybug_id": "wooyun-2013-024689", "wybug_title": "ecshop一处设计缺陷可以被二次利用", "wybug_corp": "ShopEx", "wybug_author": "齐迹", "wybug_date": "2013-05-29 12:19", "wybug_open_date": "2013-08-27 12:19", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-05-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-05-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-07-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-08-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-08-27：\t细节向公众公开  简要描述： ecshop一处设计缺陷导致可以被二次利用。关于管理员密码那些事。 详细说明：  本文前提 已经获得管理员密码的MD5！不知道从那个版本开始ec管理员密码加密方式发生了一些变化$ec_salt=rand(1,9999);md5(md5($pwd).$ec_salt;对于通过注入得到md5的兄弟们标识压力山大啊！爆破无望。不过。。ec后台的找回密码给了大家希望。这个Bug 很明显 可能已经被长期利用下面看代码admin/get_password.php 138行\n/* 验证新密码，更新管理员密码 */    elseif (!empty($_POST['action']) && $_POST['action'] == 'reset_pwd')    {        $new_password = isset($_POST['password']) ? trim($_POST['password'])  : '';        $adminid      = isset($_POST['adminid'])  ? intval($_POST['adminid']) : 0;        $code         = isset($_POST['code'])     ? trim($_POST['code'])      : '';        if (empty($new_password) || empty($code) || $adminid == 0)        {            ecs_header(\"Location: privilege.php?act=login\\n\");            exit;        }        /* 以用户的原密码，与code的值匹配 */        $sql = 'SELECT password FROM ' .$ecs->table('admin_user'). \" WHERE user_id = '$adminid'\";        $password = $db->getOne($sql);        if (md5($adminid . $password) <> $code)        {            //此链接不合法            $link[0]['text'] = $_LANG['back'];            $link[0]['href'] = 'privilege.php?act=login';            sys_msg($_LANG['code_param_error'], 0, $link);        }        //更新管理员的密码\t\t$ec_salt=rand(1,9999);        $sql = \"UPDATE \" .$ecs->table('admin_user'). \"SET password = '\".md5(md5($new_password).$ec_salt).\"',`ec_salt`='$ec_salt' \".               \"WHERE user_id = '$adminid'\";        $result = $db->query($sql);\n看出问题了把md5($adminid . $password) == $code即可重置密码前面已经说了前提了 2个值都有了 code是多少已经很明显了而且这里没有任何限制，存在暴力破解（密码字典+1-9999的盐）。成本较高。但是可以自动化。   漏洞证明：  上面已经很清楚鸟！   修复方案：  换个更加严禁的code生成方式。增加验证码。   版权声明：转载请注明来源 齐迹@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2013-05-29 20:52 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-05-29 12:47 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  这个... 应该是个小缺陷 不用给钱了吧....    \n     2013-05-29 13:51 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @xsser 没事。。马上再来一个xss    \n     2013-06-09 10:00 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  有货呀 呵呵    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}