{"id": 17369, "wybug_id": "wooyun-2012-010800", "wybug_title": "当 |XSS蠕虫| 与 |QQ系统消息推送| 双剑合璧之后 …", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2012-08-11 18:43", "wybug_open_date": "2012-09-25 18:43", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "客户端软件", "蠕虫", "技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-08-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-08-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-08-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-09-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-09-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-09-25：\t细节向公众公开  简要描述： QQ某处页面存在缺陷，导致我们可以恶意推送QQ系统消息，但是单纯的推送消息并不能太实质性的危害！但是，如果这个“系统消息”的链接能够被我们修改为我们自定义的页面的话，那就危险了！在自定义的页面内，结合一个FLASH XSS，进而自动获取用户的好友列表，自动给受害者的好友推送恶意的“系统消息”！ 想想看，那会是一个什么效果？ 当XSS蠕虫结合腾讯的系统消息功能，会是个什么疯狂的效果呢？  可惜，我们是白帽子，无法去实际测试会产生的恐怖后果 :) ，但是利用过程中的一些思路却可以被借鉴。PS：该漏洞最初由我们全宇宙最帅的男人only_guest发现！！在PKAV官网，我们也对此漏洞相关细节进行了描述，http://pkav.net/2012/08/xssworm-qqxiaoxi-vul/ (考虑到漏洞的实际危害，目前对此文进行了加密操作，在腾讯进行修复后，将会予以公开。) 详细说明：  1. 首先是我们全宇宙最帅的男人only_guest发现在QQ奥运竞猜处，可以无限给好友发送邀请消息，而且可以自定义消息窗口的内容。这样一来，我们就可以给好友发送一些虚假公告，或者是一些搞笑的“鄙视“信息。\n\n\n\n2. 但是如果仅仅是这样的话，只能算是一个鸡肋，甚至都算不上是一个安全漏洞了！3. QQ系统消息是可以点击进去查看详情的，如果我们可以把这个链接都改为自己的呢？那么造成的危害将会瞬间升级！4. 带着这个思路，我们可以开始对“奥运竞猜邀请”这个模块进行抓包分析。5. 经过抓包，我们可以看到给好友发送一个邀请，主要是2步～ \n\n5.1 获取好友列表的请求\nhttp://apps.2012.qq.com/guess/friends/list?url=http%3A%2F%2Fapps.2012.qq.com%2Fguess%2Fguess-tid-18-id-363&message=%E5%A5%B3%E7%AF%AE%E5%B0%8F%E7%BB%84%E8%B5%9B-%E4%B8%AD%E5%9B%BDvs%E5%AE%89%E5%93%A5%E6%8B%89%EF%BC%8C%E8%B0%81%E5%B0%86%E8%8E%B7%E8%83%9C%EF%BC%9FQuery String:url\thttp://apps.2012.qq.com/guess/guess-tid-18-id-363message\t女篮小组赛-中国vs安哥拉，谁将获胜？\n在这个请求中，我们看到，有“系统消息”里点击的那个链接。那么这个链接出现在这个请求里有什么用呢？ 我们看看这个请求里的源码。会看到以下内容：\n<script type=\"text/javascript\">//邀提Url_MI.invate.invateUrl = \"/guess/friends/invite?url=http%3A%2F%2Fapps.2012.qq.com%2Fguess%2Fguess-tid-18-id-363&hash=bc85ea9ed27178416dfe984ef58fb657\";_MI.invate.maxNumber = 5;var message=\"女篮小组赛-中国vs安哥拉，谁将获胜？\";var uin=\"22871560\";var invateUrl=\"http://apps.2012.qq.com/guess/guess-tid-18-id-363\";window.onload =function(){_MI.invate.run(message,uin);}</script>\n我们可以看到，在这段代码里，有invateUrl (这个单词是不是写错了,invite?)，还有invateUrl对应的hash 而在下一个请求5.2中，正好又用到了这个hash值。5.2 给好友发送邀请的请求。\nPOST方式：http://apps.2012.qq.com/guess/friends/invite?url=http%3A%2F%2Fapps.2012.qq.com%2Fguess%2Fguess-tid-18-id-363&hash=bc85ea9ed27178416dfe984ef58fb657Query String:url\thttp://apps.2012.qq.com/guess/guess-tid-18-id-363hash\tbc85ea9ed27178416dfe984ef58fb657   <--- 5.1 步骤中得到的hash值Post Datauin0\t86****0nickname0\t小号1号token0\t12a0d8a2b3d9c\n6. 经过以上抓包分析，我们不难做出以下开发逻辑的猜测：6.1 首先通过http://apps.2012.qq.com/guess/friends/list得到好友的QQ号码，token值，以及被邀请竞猜的URL以及URL对应的HASH值6.2 利用6.1中得到的数据给用户发送邀请7. 那么，我们将第一步url里的http://apps.2012.qq.com/guess/guess-tid-18-id-363修改成我们自己的呢？于是我们测试，将url修改为 http://pkav.net，得不到返回结果。\n\n8. 看来这里对域名进行了判断过滤, 那么我们找一个同域名下的XSS试一下吧～ http://apps.2012.qq.com/guess/friends/list?url=http%3A%2F%2Fapps.2012.qq.com%2Fguess%2Fguess-tid-18-id-363\";alert(1)//&message=ok10. 不幸的是，上面这个XSS URL通过了5.1步，但是在5.2步，由于长度限制，返回了错误。\n\n11. 那么这里到底限制了多少长度呢？为了方便测试，用俺的魔盒(http://www.toolmao.com)写了一个利用程序进行了测试。\n\n12. 随后我将这个程序发送给了only_guest, 过一会，他发现在5.1这个步骤上，QQ的域名判断存在问题，用http://pkav.net/#.qq.com/?http://1.qq.com一样可以发送成功。 看来QQ在这里的判断正则写的不到位？或者是indexOf(\"qq.com\")的方式检测？13. 这样一来，我们就可以向自己的好友推送恶意的“系统消息”，并且用户点击系统消息后，会打开我们所设置的链接，http://pkav.net，如下图：\n\n14. 当然这个还不算什么， 如果把这个系统消息推送，再配合一个QQ的XSS，效果该如何呢？ 因为FLASH XSS具有独特的优势（http://zone.wooyun.org/content/368），我就去腾讯的域名下找一个FLASH XSS，然后进行下一步的利用。15. 利用思路可以用下图表示：\n\n16. 按照上面的思路，我们可以写一下利用代码！16.1 首先是FLASH XSS的利用代码。\n@see http://itsokla.duapp.com/aoyun_js.php.txt\n16.2 FLASH XSS会调用我们的JS文件。\n@see http://itsokla.duapp.com/aoyun_worm.js\n16.3 aoyun_worm.js会将用户的QQ号码和cookies发送给aoyun_receive.php\n@see http://itsokla.duapp.com/aoyun_receive.php.txt\n16.4 aoyun_receive.php 就会利用用户的cookies向用户的好友自动推送消息。这里用mysql来存储了以及推送过的QQ号码，防止对同一个用户的全部好友进行多次重复推送。   漏洞证明：  用我的大号打开危害页面后，可以看到大号在不知情的情况下，自动对我的好友小号发送了恶意的“系统消息”\n\n   修复方案：  1. 等奥运结束，活动下线即可2. 对推送消息处的域名判断做审查并修改3. 对消息推送次数做限制4. 修复FLASH XSS，不修复也可以 :)，留着我下次再用吧～～    版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2012-08-13 14:04 厂商回复： 感谢反馈，我们正在跟进处理中 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-08-11 18:46 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  双剑合璧后    \n     2012-08-11 19:04 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  其实测试下也没什么的 我觉得啊    \n     2012-08-11 19:19 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  我擦。又是20点    \n     2012-08-11 19:21 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @xsser 我犹豫了两天..要不要测试一次...后来想想还是算了...不给腾讯找麻烦了...也不给PKAV找麻烦了..    \n     2012-08-11 19:23 |    \t\t闪电小子 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:5        | PKAV技术宅社区！---闪电小子！)\t\t \n  给妹子发消息最有爱啦！哈哈～    \n     2012-08-11 19:26 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  全宇宙最帅的男人only_guest    \n     2012-08-11 19:48 |    \t\tHenry:bobo \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:22        | 本胖吊！~又高又肥2个奶奶像地雷)\t\t \n  @闪电小子 .....好自恋    \n     2012-08-11 19:53 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @zeracker 亲小二不保啊。@闪电小子 大牛出没注意。    \n     2012-08-11 20:00 |    \t\tHenry:bobo \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:22        | 本胖吊！~又高又肥2个奶奶像地雷)\t\t \n  @only_guest ..貌似我回错人了 应该是    \n     2012-08-11 20:39 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  看来有基情    \n     2012-08-11 20:53 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @only_guest +_+肾斗士雄起,小铸 很拜模。    \n     2012-08-11 20:53 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @only_guest 你刚刚开论坛没多久我注册的账号 账号密码都不记得了...    \n     2012-08-11 20:57 |    \t\t数据流 \t\t\t( 普通白帽子  |\t\t\t        Rank:716 漏洞数:88        | all or nothing,now or never)\t\t \n  @only_guest @_Evil 肾斗士?这ID好熟悉     \n     2012-08-11 21:08 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @数据流 百度 \"90后黑客 肾斗士\" 早认识了,= =。。。    \n     2012-08-11 21:53 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @数据流 肾斗士也是我的ID...    \n     2012-08-11 21:56 |    \t\t闪电小子 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:5        | PKAV技术宅社区！---闪电小子！)\t\t \n  @Henry:bobo 我的确给妹子发过。效果刚刚,哈哈～    \n     2012-08-11 22:15 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @zeracker 精华翻倍啊。压力好大    \n     2012-08-11 22:18 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @zeracker 排名不保了....    \n     2012-08-11 23:18 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @only_guest 有竞争力才有动力，除非这个帖子厂商给22点，才超我。哈哈，哥不担心。    \n     2012-08-11 23:44 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @zeracker @xsser 来电他一下    \n     2012-08-11 23:54 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @zeracker 要是加精华了呢....    \n     2012-08-11 23:55 |    \t\trandom_ \t\t\t( 普通白帽子  |\t\t\t        Rank:295 漏洞数:50        | 推动开源推动网络安全)\t\t \n  哈哈 给力    \n     2012-08-12 12:46 |    \t\t啤酒 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:8        | 道不同.喝酒结盟)\t\t \n  微博来的？    \n     2012-08-12 23:58 |    \t\t苦战 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:4        | 人称苦战？乃南方蛮荒之人！相平，谓正不如...)\t\t \n  大爱这类~  关注个吧    \n     2012-08-14 01:17 |    \t\trdpclip \t\t\t( 实习白帽子  |\t\t\t        Rank:50 漏洞数:4        | 脚踏实地，不慕虚华，实事求是的rdpclip)\t\t \n  前来膜拜。。    \n     2012-08-14 14:44 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  http://pkav.net/2012/08/xssworm-qqxiaoxi-vul/内容已经公开    \n     2012-08-14 16:59 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @only_guest 果断转载~    \n     2012-08-23 14:12 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  提醒：级别足够但是无法查看 Rank 高于自己的白帽子漏洞    \n     2012-08-23 14:28 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @only_guest +1    \n     2012-08-23 16:58 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @only_guest 这个限制应该去掉、、    \n     2012-08-23 17:51 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @px1624 @imlonghao http://pkav.net/2012/08/xssworm-qqxiaoxi-vul/ 内容已经公开  你们可以到这里看    \n     2012-08-23 18:08 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @only_guest 早就转了。~看这个回复上面的第5个回复    \n     2012-08-24 14:16 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @only_guest 嗯，这个看了，不过好多都是等级够，rank不够，看不了。。。    \n     2012-08-25 00:13 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @px1624 我要是全转到PKAV拿去公开的话.剑心会弄死我的.    \n     2012-08-25 09:30 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @only_guest @px1624 only_guest说可以用乌云币提前看的    \n     2012-08-25 10:50 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @xsser 没看到怎么使用乌云币诶？    \n     2012-08-26 18:21 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @xsser ................    \n     2012-08-26 18:25 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @px1624 @imlonghao 再仔细看！    \n     2012-08-26 18:36 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @xsser 打死不支付。。。。。都是爱疯配件啊。。。。。。。。。。。。。。。。。。    \n     2012-08-26 20:31 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @xsser 价格怎么定的呢？    \n     2012-08-27 10:08 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @一刀终情 当前漏洞rank的一半儿    \n     2012-08-28 17:17 |    \t\t凤凰 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:6        | 涅磐)\t\t \n  原来乌云币就是rank啊~~手抖了下，10个币没了。。还好这个漏洞是20。不然亏了    \n     2012-08-28 17:21 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @凤凰 rank不会减少 乌云币会    \n     2012-08-28 17:46 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @xsser 支付给作者了么？    \n     2012-08-28 17:57 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @一刀终情 给乌云了...    \n     2012-08-28 18:32 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @xsser ..    \n     2012-08-29 08:39 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @xsser 应该给作者提成，可以提高作者的积极性的哇；提成比例根据支付者的评价定    \n     2012-08-29 08:59 |    \t\t凤凰 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:6        | 涅磐)\t\t \n  @xsser 我也以为给作者了。建议抽个两成给作者    \n     2012-08-29 10:31 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @凤凰 @一刀终情 不是都给精华了咩 ：（    \n     2012-08-29 11:14 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @xsser 也是，精华的，WB翻翻的哇~~没精华的呢……    \n     2012-09-13 09:16 |    \t\tnone \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:5        | 十次十次啊 hack it then know more~)\t\t \n  再给二哥一个精华吧    \n     2013-03-29 03:49 |    \t\tDrizzle.Risk \t\t\t( 普通白帽子  |\t\t\t        Rank:255 漏洞数:19        | You have an error in your SQL syntax; ch...)\t\t \n  太经典了.. 赞一个,有时候，一个洞，不给厂商狠狠证明威胁性，或许就忽略了...    \n     2013-04-09 19:02 |    \t\t小野 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 低调~)\t\t \n  擦！这个漏洞腾讯缝上了吧？？    \n     2013-04-09 19:43 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @小野 ...八百年前的事情了。。。    \n     2013-06-21 12:52 |    \t\t噬魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:141 漏洞数:37        | 08安全团队)\t\t \n  好牛B啊啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}