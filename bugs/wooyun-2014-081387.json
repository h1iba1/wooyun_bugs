{"id": 43867, "wybug_id": "wooyun-2014-081387", "wybug_title": "大米CMS注入后台可以getshelll", "wybug_corp": "damicms.com", "wybug_author": "wilson", "wybug_date": "2014-10-30 18:31", "wybug_open_date": "2015-01-28 18:32", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-28：\t细节向公众公开  简要描述： 大米CMS注入，后台可以getshelll 详细说明：  一)注入1.挖洞前奏Damicms搭建在本地以后，对cms\\dami\\Core\\Lib\\Think\\Db\\Db.class.php进行修改，将sq语句var_dump处理。然后就进行黑盒测试。搜索点，以及admin登入点输入单引号就会给过滤了。。。看到有注册功能，发现登入点居然没有过滤单引号。。。\n\n这运气比较好了2.漏洞原理于是苦逼看代码，发现thinkphp 看不懂  - -去学习了一下回来了。。。。发现登入点在: dami\\Web\\Lib\\Action\\MemberAction.class.php这控制器里面发现问题代码:$username = htmlspecialchars($_REQUEST['username']);$userpwd =  $_REQUEST['userpwd'];if($username=='' || $userpwd==''){$this->error('请输入用户名和密码?');exit();}$info = M('member')->where(\"username='{$username}' and is_lock=0\")->find();if(!$info){$this->error('用户不存在或已经禁止登陆!');}else{\tif($info['userpwd'] != md5($userpwd)){\t\t$this->error('密码错误，请重新登录!');\t\t}else{\t\t$_SESSION['dami_uid'] = $info['id'];\t\t$_SESSION['dami_username'] = $info['username'];\t\tif(!empty($_REQUEST['lasturl'])){\t\t$this->assign('jumpUrl',urldecode(htmlspecialchars($_REQUEST['lasturl'])));\t\t\t}\t\telse{\t\t$this->assign('jumpUrl',U('Member/main'));\t\t}\t\t$this->success('登录成功~');\t\t\t}}发现username没有过滤就放进去了......我想为什么thinkphp不过滤呢？测试其它的点都够了了。最后发现了。\n\nThinkphp的where查看如果只对字符型的，他是不会过滤的 = =......他过滤数组进去的和对象进去的对象。。。。。。。。。程序员过分信赖thinkphp的过滤，导致漏洞发生......也就是登入时候用户名:-1' union select 1,(select concat(id,0x23,username,0x23,password) from dami_admin),'c4ca4238a0b923820dcc509a6f75849b',4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20#密码是1登入进去看见用户名就是注入出的东西了。\n\n4.后台编辑文件直接生成php模板管理 编辑文件 可以直接生成php文件\n\n   漏洞证明：     修复方案：  对用户名继续过滤....   版权声明：转载请注明来源 wilson@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2014-10-30 22:16 厂商回复： 过滤不严可能造成注入风险，但用作者的用户始终是登陆不成功的在版本3.8中测试，不过仍然感谢细心的发现，将对用户名进行严格注入过滤  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-31 14:04 |    \t\twilson \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:4        | 我的菜刀已经饥渴难耐~)\t\t \n  @damicms.com漏洞应该存在才对了....是gpc=on了么？    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}