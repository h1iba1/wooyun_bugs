{"id": 4506, "wybug_id": "wooyun-2014-050087", "wybug_title": "大汉版通JIS统一身份认证系统后台文件上传漏洞及两处越权漏洞", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "wefgod", "wybug_date": "2014-01-30 11:23", "wybug_open_date": "2014-04-30 11:24", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传", "文件上传安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-30：\t细节向公众公开  简要描述： 先祝大家马年吉祥！说会到JIS，原本以为后台是限制得很死的，无法上传jsp，但是研究了下发现不是这样的……另外还有两处越权，打包发了。 详细说明：  后台文件上传，顾名思义还是需要有管理员的账户，或者确切的说，是需要有“有新建应用权限的账户”。这里用管理员权限来说明。先看应用管理——新建\n\n直接看opr_application.jsp文件：\nif(strFileName.toLowerCase().endsWith(\"gif\") || strFileName.toLowerCase().endsWith(\"jpg\")){//cmd.jsp(00)gif轻松过if\tfile = new File( strLoadPath + \"/tmp/\" + strFileName);\tint m = strFileName.lastIndexOf(\".\");\tstrFileName = upload.getFormValue(\"vc_appmark\")+(strFileName.substring(m,strFileName.length()));//cmd.jsp(00)gif，jsp(00)gif获取到了，写文件就截断了都。\tfileNew = new File( strLoadPath + \"/apppic/\"+strFileName);\tif(fileNew.exists())\t\tfileNew.delete();\tfile.renameTo(fileNew);\tbulidminpic.setNWidth(85);\tboolean bl = bulidminpic.buildMiniature(strLoadPath + \"/apppic/\"+strFileName);\n以上有两个傻逼地方：1.用了endsWith（我00截断的话你只有这货肯定不行）2.没有重命名（随机数化）上传的时候文件名改为cmd.jsp(00)gif,中间的(00)就是00字节\n\n看上图下面部分就知道地址会自己返回。.jsp后面部分已经被截断了附上shell截图：\n\n   漏洞证明：  这里说两个越权。随意注册一个用户登录后访问如下页面：http://management.ysx.gov.cn/jis/main/onlineuser.jsp?可以直接看见当前登录的用户及对应的IP。还有一个日志操作的：http://management.ysx.gov.cn/jis/manage/log/opr_export.jsp\n\n   修复方案：  越权的就不说了。文件上传那在判断后缀名的时候，严格一点，加上随机数最好（这个看实际，不能随意就乱做随机数）   版权声明：转载请注明来源 wefgod@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-02-09 09:13 厂商回复： 非常感谢您对大汉产品的关注以及对产品安全方面的指正，涉及问题已在新版本中修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-30 12:15 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  大过年的你要不要这样/hah    \n     2014-01-30 12:22 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @magerx 其实还有。哈哈    \n     2014-01-30 13:23 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  @wefgod 哈哈 你得让人家好好过年~    \n     2014-01-30 14:24 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @magerx 他们这几天肯定不回来确认的……年后一来就吃惊了    \n     2014-02-08 21:19 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  看来自动忽略了，都不用上班了吗    \n     2014-02-20 16:53 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  强烈关注中....    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}