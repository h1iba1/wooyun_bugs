{"id": 65561, "wybug_id": "wooyun-2015-0124949", "wybug_title": "fanwe O2O用户密码可劫持（通用/开源软件jsonp劫持案例）", "wybug_corp": "fanwe.com", "wybug_author": "phith0n", "wybug_date": "2015-07-06 17:52", "wybug_open_date": "2015-10-05 10:14", "wybug_type": "敏感信息泄露", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["应用敏感信息泄漏", "劫持"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-05：\t细节向公众公开  简要描述： TSRC西安沙龙议题之Fanwe o2o。（通用/开源应用中的jsonp劫持案例） 详细说明：  /mapi/Lib/core/common.php中有 fanwe o2o的output函数：\n/** * 输出接口数据 * @param unknown_type $data 返回的接口数据 * @param unknown_type $status 当前状态 0/1 * @param unknown_type $info 当前消息 可选，为空时由客户端取默认提示(默认提示包含成功的默认提示与失败的默认提示) */function output($data,$status=1,$info=\"\"){\theader(\"Content-Type:text/html; charset=utf-8\");\t$r_type = intval($_REQUEST['r_type']);//返回数据格式类型; 0:base64;1;json_encode;2:array 3:jsonp\t$data[CTL] = MODULE_NAME;\t$data[ACT] = ACTION_NAME;\t$data['status'] = $status;\t$data['info'] = $info;\t$data['city_name'] = $GLOBALS['city']['name'];\t$data['return'] = 1; //弃用该返回，统一返回1\t$data['sess_id'] = $GLOBALS['sess_id'];\tif ($r_type == 0)\t{\t\techo base64_encode(json_encode($data));\t}\telse if ($r_type == 1)\t{        echo(json_encode($data));\t}\telse if ($r_type == 2)\t{\t\tprint_r($data);\t}\telse if($r_type == 3)\t{\t\t$json = json_encode($data);\t\techo $_GET['callback'].\"(\".$json.\")\";\t}\texit;}\n这是一个通用的输出函数，所有/mpai下的输出全部由output输出。我们可以看到，这里当$_REQUEST['r_type']==3的时候，输出格式为jsonp。所以，如果$data中有敏感信息，即会造成jsonp劫持。结果当前函数中就存在一个敏感信息：sess_id$data['sess_id'] = $GLOBALS['sess_id'];用户登陆后（fanwe o2o 默认用户账号密码都是fanwe，以这个用户为例），可劫持用户的session（http://o2odemo.fanwe.net/mapi/index.php?ctl=syncbind&act=index&login_type=Sina&access_token=ooooo&sina_id=ooooo&r_type=3&callback=wooyun）：\n\n继续深挖，刚才访问的这个URL（http://o2odemo.fanwe.net/mapi/index.php?ctl=syncbind&act=index&login_type=Sina&access_token=ooooo&sina_id=ooooo&r_type=3&callback=wooyun），实际上就是将账户fanwe绑定了sina_id为ooooo。那么另外一处，我们可以直接用ooooo进行登录：http://o2odemo.fanwe.net/mapi/index.php?ctl=synclogin&act=index&login_type=Sina&sina_id=ooooo&access_token=ooooo&r_type=3&callback=wooyun\n\n如上图，可以直接劫持用户密码。写了个POC证明问题。受害者登录http://o2odemo.fanwe.net，再访问该POC即会弹出他的账号、邮箱、密码：http://mhz.pw/game/tx/fanweo2o.html\n\n   漏洞证明：  http://mhz.pw/game/tx/fanweo2o.html\n\n   修复方案：  敏感信息不要输出。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-07-07 10:12 厂商回复： 已确认，但该漏洞主要在首次需要得到用户的帐号密码做首次登录，或者通过其他途径（如病毒）得到其他用户http传输中的隐私信息才可对他人用户身份进行劫持。因此风险较低，后续我们会改善手机接口的传输加密。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-06 17:55 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  沙发    \n     2015-07-06 17:59 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  好案例，jsonp的基本都是黑箱的，终于有个百盒的    \n     2015-07-06 18:00 |    \t\tmyhalo \t\t\t( 普通白帽子  |\t\t\t        Rank:281 漏洞数:55        | 所属团队:TSafe)\t\t \n  关注    \n     2015-07-06 20:59 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  这次选 通用型 了没    \n     2015-07-06 21:00 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @px1624 选了>.<    \n     2015-07-07 12:34 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @fanwe.com不用得到用户账号密码做首次登陆，只要让用户访问我的POC即可。看来官方还是不了解jsonp的危害呀。。。    \n     2015-07-08 10:00 |    \t\t魔鬼的步伐 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:16        | 一步两步，是魔鬼的步伐)\t\t \n  给个中等可以了，需要交互，变相的csrf 么，不过官方的回复貌似没有搞懂这个原理    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}