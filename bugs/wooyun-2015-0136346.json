{"id": 71330, "wybug_id": "wooyun-2015-0136346", "wybug_title": "AfterLogic WebMail最新版任意文件包含", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2015-08-25 19:44", "wybug_open_date": "2015-11-25 09:18", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "文件包含漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-25：\t细节向公众公开  简要描述： AfterLogic WebMail任意文件包含，包括最新版，和老版本都存在这个问题，无需登录。 详细说明：  AfterLogic WebMail最新版7.6.0的版本为例进行测试AfterLogic WebMail在安装后默认是不会删除install目录的所以这里你也可以重装，设置自己的mailserver，进行各种操作在安装过程中存在设计缺陷导致无需登录，即可进行任意文件包含文件/install/index.php：\n<?php/* * Copyright 2004-2015, AfterLogic Corp. * Licensed under AGPLv3 license or AfterLogic license * if commercial version of the product was purchased. * See the LICENSE file for a full license statement. */\tdefined('WM_INSTALLER_PATH') || define('WM_INSTALLER_PATH', (dirname(__FILE__).'/'));\tinclude WM_INSTALLER_PATH.'installer.php';\t$oInstaller = new CInstaller();\t$oInstaller->Run();\n跟进/install/installer.php：\n$this->_sState = isset($_GET['step']) ? $_GET['step'] : 'index';$this->_aMenu = array(\t\t\t'compatibility', 'license', 'license-key', 'db',\t\t\t'dav', 'admin-panel', 'email-server-test', 'completed'\t\t);function Run()\t{\t\tif (isset($_GET['post']))\t\t{\t\t\t$this->Post();\t\t\texit();\t\t}\t\tif ('index' === $this->_sState)\t\t{\t\t\t$_SESSION['checksessionindex'] = true;\t\t\theader('Location: index.php?step=compatibility');\t\t\texit();\t\t}\t\t$sState = in_array($this->_sState, $this->_aMenu) ? $this->_sState : 'compatibility';\n当这里是POST请求时会调用POST函数如果是GET的话就会判断这里的$this->_sState：\n$sState = in_array($this->_sState, $this->_aMenu) ? $this->_sState : 'compatibility';\n所以这里参数$this->_sState被限制，没办法利用，我们看看POST方法：\nfunction Post()\t{\t\t$sState = empty($_POST['state']) ? '' : $_POST['state'];\t\tif (isset($_POST['back_btn']))\t\t{\t\t\theader('Location: '.'index.php?step='.$this->getBackStep($sState));\t\t}\t\telse\t\t{\t\t\t$oStepObject = null;\t\t\tif (@file_exists(WM_INSTALLER_PATH.'steps/'.$sState.'.php'))\t\t\t{\t\t\t\tinclude_once WM_INSTALLER_PATH.'steps/'.$sState.'.php';\t\t\t\t$oCurrentStateStepClass = 'C'.ucfirst(preg_replace('/[^a-z]/', '', $sState)).'Step';\t\t\t\t$oStepObject = new $oCurrentStateStepClass;\t\t\t\t$sUrl = 'index.php?step='.$sState;\t\t\t\tif ($oStepObject->DoPost())\t\t\t\t{\t\t\t\t\t$sUrl = 'index.php?step='.$this->getNextStep($sState);\t\t\t\t}\t\t\t\theader('Location: '.$sUrl);\t\t\t}\t\t\telse\t\t\t{\t\t\t\techo 'State error';\t\t\t}\t\t}\t}\n可以看到这里$sState = empty($_POST['state']) ? '' : $_POST['state'];然后判断文件是否存在，如果存在就include_once这个文件在进入include_once的文件中带入了我们可控的变量$sState所以导致存在包含漏洞但是这里有点鸡肋，就是需要截断，在5.3.4后的php版本就没办法进行截断了   漏洞证明：  \n\n当然这里可以利用重装，然后登陆上传文件拿到shell   修复方案：  安装文成后自动删除install，或者进行instal.lock判断   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-08-27 09:17 厂商回复： CNVD确认并复现所述情况,根据实测案例,暂未发现国内政府和重要部门用户案例,由于未建立与该厂商的直接处置渠道,待认领. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}