{"id": 47937, "wybug_id": "wooyun-2014-079045", "wybug_title": "Supesite 前台注入 #3 (Delete)", "wybug_corp": "Discuz!", "wybug_author": "′雨。", "wybug_date": "2014-10-13 17:12", "wybug_open_date": "2015-01-11 17:14", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向公众公开  简要描述： Delete如果ucenter和supesite在一个裤的话 可以尝试把uckey注入出来然后…… 详细说明：  在cp.php中\n$ac = empty($_GET['ac']) ? 'profile' : trim($_GET['ac']);if(in_array($ac, array('index', 'news', 'profile', 'credit', 'models'))) {\tinclude_once(S_ROOT.'./source/cp_'.$ac.'.php');\n包含进来在source/cp_news.php中\nif(empty($itemid)) { //这里让$itemid 不为空\t\t\t\tif(!empty($_SCONFIG['posttime']) && $_SGLOBAL['group']['groupid'] != 1) {\t\t\tif($_SGLOBAL['timestamp'] - $_SGLOBAL['member']['lastposttime'] < $_SCONFIG['posttime']) {\t\t\t\tshowmessage('post_too_much');\t\t\t}\t\t}\t\t$newsarr['uid'] = $_SGLOBAL['supe_uid'];\t\t$newsarr['username'] = $_SGLOBAL['supe_username'];\t\t$newsarr['dateline'] = $_SGLOBAL['timestamp'];\t\t\t\tif($_POST['fromtype'] == 'newspost') {\t\t\t$newsarr['fromtype'] = 'newspost';\t\t\t$newsarr['fromid'] = intval($_POST['id']);\t\t} else {\t\t\t$newsarr['fromtype'] = 'userpost';\t\t}\t\tif(!checkperm('allowdirectpost')) {\t\t\t$itemarr['itemid'] = inserttable('spaceitems', $newsarr, 1);\t\t\tinserttable('spacenews', $itemarr);\t\t\tgetreward('postinfo');\t\t\tpostspacetag('add', $_POST['type'], $itemarr['itemid'], $tagarr,1);\t\t\t$do = 'pass';\t\t} else {\t\t\t$itemarr['itemid'] = inserttable('postitems', $newsarr, 1);\t\t\tinserttable('postmessages', $itemarr);\t\t\tpostspacetag('add', $_POST['type'], $itemarr['itemid'], $tagarr,0);\t\t\t$do = 'me';\t\t}\t\t//更新用户最新更新时间\t\tif($_SGLOBAL['supe_uid']) {\t\t\tupdatetable('members', array('updatetime'=>$_SGLOBAL['timestamp'], 'lastposttime'=>$_SGLOBAL['timestamp']), array('uid'=>$_SGLOBAL['supe_uid']));\t\t\t}\t} else { //进入else\t\tif(empty($_SGLOBAL['supe_uid'])) showmessage('no_permission');\t\tupdatetable('postitems', $newsarr, array('itemid'=>$itemid));\t\tupdatetable('postmessages', $itemarr, array('itemid'=>$itemid));\t\t$itemid = empty($_POST['oitemid']) ? $itemid : $_POST['oitemid'];//没有intval\t\tpostspacetag('update', $_POST['type'], $itemid, $tagarr, 0);//跟这里\t}\n\nfunction postspacetag($op, $type, $itemid, $tagarr, $status) {\tglobal $_SGLOBAL;\t$deletetagidarr = $addtagidarr = $spacetagidarr = array();\tif($op == 'add') {\t//已经存在的tag,执行加入操作\t\tif(!empty($tagarr['existsid'])) {\t\t\t$addtagidarr = $tagarr['existsid'];\t\t\t$_SGLOBAL['db']->query('UPDATE '.tname('tags').' SET spacenewsnum=spacenewsnum+1 WHERE tagid IN ('.simplode($tagarr['existsid']).')');\t\t}\t} else {\t\t$query = $_SGLOBAL['db']->query('SELECT * FROM '.tname('spacetags').' WHERE itemid=\\''.$itemid.'\\' AND status=\\''.$status.'\\'');//查询\t\twhile ($spacetag = $_SGLOBAL['db']->fetch_array($query)) {\t\t\tif(!empty($tagarr['existsid']) && in_array($spacetag['tagid'], $tagarr['existsid'])) {\t\t\t\t$spacetagidarr[] = $spacetag['tagid'];\t\t\t} else {\t\t\t\t$deletetagidarr[] = $spacetag['tagid'];//赋值\t\t\t}\t\t}\t\tforeach ($tagarr['existsid'] as $etagid) {\t\t\tif(!empty($spacetagidarr) && in_array($etagid, $spacetagidarr)) {\t\t\t} else {\t\t\t\t$addtagidarr[] = $etagid;\t\t\t}\t\t}\t\tif(!empty($deletetagidarr)) { //这里要$deletetagidarr不为空 那么也就是要让$query = $_SGLOBAL['db']->query('SELECT * FROM '.tname('spacetags').' WHERE itemid=\\''.$itemid.'\\' AND status=\\''.$status.'\\'')这个查询出来的有内容\t\t\t$_SGLOBAL['db']->query('DELETE FROM '.tname('spacetags').' WHERE itemid='.$itemid.' AND tagid IN ('.simplode($deletetagidarr).') AND status=\\''.$status.'\\'');//这里delete查询 WHERE itemid='.$itemid.'  没有被单引号引住。。 并且没intval导致注入\t\t\t$_SGLOBAL['db']->query('UPDATE '.tname('tags').' SET  spacenewsnum=spacenewsnum-1 WHERE tagid IN ('.simplode($deletetagidarr).')');\t\t}\n首先我们注册一个会员 然后投稿 \n\n投稿 这里tag 随便写一个+--------+-------+------------+------+--------+| itemid | tagid | dateline   | type | status |+--------+-------+------------+------+--------+|      3 |     1 | 1412680532 | news |      0 ||      4 |     2 | 1412680930 | news |      0 |数据库里也就创建了。。这里的itemid 在http://127.0.0.1/dan/supesite/cp.php?ac=news&op=view&itemid=4地址中就能看到为4 然后在$query = $_SGLOBAL['db']->query('SELECT * FROM '.tname('spacetags').' WHERE itemid=\\''.$itemid.'\\' AND status=\\''.$status.'\\'');这里查询 \n\n这里查询 后面虽然跟了一些字符 提示warning 但是还是能查询出来。\t$_SGLOBAL['db']->query('DELETE FROM '.tname('spacetags').' WHERE itemid='.$itemid.' AND tagid IN ('.simplode($deletetagidarr).') AND status=\\''.$status.'\\'');然后就进来delete 里面没单引号 且无intval 导致注入。投稿的时候抓包一下\n\n\n\n成功出数据   漏洞证明：  \n\n   修复方案：  intval 或者 单引号上把   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-14 09:08 厂商回复： supesite已经停止维护。感谢您继续关注我们的其他产品 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-13 17:21 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  围观DELETE注入    \n     2014-11-03 23:30 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  围观DELETE注入+1    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}