{"id": 538, "wybug_id": "wooyun-2014-069368", "wybug_title": "Phpyun设计缺陷致任意文件删除可致重装getshell或注入", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2014-07-23 10:31", "wybug_open_date": "2014-10-21 10:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-21：\t细节向公众公开  简要描述： 设计缺陷可致任意文件删除 删除lock可直接进行重装直接达到getshell。 或者删除某文件也可以来注入了。也可导致破坏sql语句。________________________________________________________________________P.S.又是1点多了,明天又无法认真上课了。 2014年7月23日 01:30:01新的一天快乐。              详细说明：  依旧官网下的最新版。在model/ajax.class.php中\nfunction delupload_action(){\t\tif(!$this->uid && !$this->username && $_COOKIE[\"usertype\"]!=2){\t\t\techo 0;die;\t\t}else{\t\t\t$dir=$_POST[str][0];\t\t\t\t\t$isuser = $this->obj->DB_select_once(\"company_show\",\"`picurl`='$dir'\");\t\t\tif($isuser['uid']==$this->uid)\t\t\t{\t\t\t\techo @unlink(\".\".$dir);\t\t\t}else{\t\t\t\techo 0;die;\t\t\t}\t\t}\t}\n0x01 破坏语句执行\n$dir=$_POST[str][0];\t\t\t\t\t$isuser = $this->obj->DB_select_once(\"company_show\",\"`picurl`='$dir'\");\n这里可以看到$dir 如果这时候我们提交的是一个字符串的话 [0] 就成了截取字符的了。截取的是第一个字符。 因为phpyun全局会对'转义变成\\' (单引号会被实体化)截取第一个字符的话 就是一个\\了。\n\n成功引入了转义符。 如果有两个参数可控的话可以 '\\',uesr()#' 类似这样的注入可是这里只有一个参数 所以能引入转义符的话 也无法注入 只能破坏下语句。_________________________________________________________________________0x02 任意文件删除 删lock 可致Getshell首先来看他这里的判断\n$dir=$_POST[str][0];\t\t\t\t\t$isuser = $this->obj->DB_select_once(\"company_show\",\"`picurl`='$dir'\");\t\t\tif($isuser['uid']==$this->uid)\t\t\t{\t\t\t\techo @unlink(\".\".$dir);\t\t\t}else{\t\t\t\techo 0;die;\t\t\t}\t\t}\n这个判断的意思大概是 $isuser['uid']==$this->uid 这个发布的人必须是你然后才能进行删除操作。但是在这里 如果DB_select_once(\"company_show\",\"`picurl`='$dir'\");这个查询出来的是空 然后$this->uid也是空的话 那么就通过了这个判断。\nif(!$this->uid && !$this->username && $_COOKIE[\"usertype\"]!=2){\t\t\techo 0;die;\n在这里 由于用的是&& 所以只有不满足这三个才会退出在这里我们不登录会员 然后前面那两个都为true了。但是$_COOKIE[\"usertype\"]!=2 如果这个为false的话 就不会执行die了。而且COOKIE刚好也是用户可控的。来测试一下。\n\n\n\n可以看到COOKIE usertype为2的时候就不会退出了。这时候由于我们并没有登录 所以$this->uid 为空(0)如果这时候\t$isuser = $this->obj->DB_select_once(\"company_show\",\"`picurl`='$dir'\");$dir 并不存在于这个表中的话(我们要删除的文件自然是不会在这个表中的)那么$isuser['uid'] 也为空。（NULL）\nif($isuser['uid']==$this->uid)\t\t\t{\t\t\t\techo @unlink(\".\".$dir);\n这时候就通过了这个判断 可以执行unlink了。然后$dir也可控。那不就可以删除任意文件了?这里我们来删除data/phpyun.lock 达到重装因为他这之前unlink(\".\".$dir) 定义了一个. 所以直接加个/就行了删除的是根目录的构造一下目录。\n\n返回了1 成功删除了。这里删除了lock就可以进行重装了。\n\n这里不会被转义。\n\n访问首页就成功执行代码了。_________________________________________________________________________0x03 如果不想重装别人系统 但是要注入呢?在member/model/com.class.php中\nfunction product_action()\t{\t\t$this->public_action();\t\t$delid=$_GET['delid'];\t\t\t\tif($delid){\t\t\tif(is_array($delid)){\t\t\t\t$ids=$this->pylode(',',$delid);\t\t\t\t$layer_type=1;\t\t\t}else{\t\t\t\t$ids=$delid;\t\t\t\t$layer_type=0;\t\t\t}\t\t\t$row=$this->obj->DB_select_all(\"company_product\",\"`id` in (\".$ids.\") and `uid`='\".$this->uid.\"'\",\"`pic`\");\n$delid=$_GET['delid']; 如果不是数组的话就没过滤 直接带入到了查询当中。而且没单引号这里直接删除data/db.safety.php 和 include\\webscan360\\360safe\\360webscan.php就能注入了。\n\n\n\n两个都是返回的1 说明成功删除了、就能来注入了。\n\nok 因为删除了拦截文件 所以无拦截。   漏洞证明：  见上面吧。 好累。   修复方案：  这么晚了 真心求个高分。修改一下逻辑。把&&改成|| 咋样? 只是个建议 没多思考。 还是你们自己想想。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-07-24 15:08 厂商回复： 感谢您的提供！我们会及时修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-23 10:38 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   应该是逻辑错误。    \n     2014-07-23 10:52 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  一级棒~ 高三狗,潜心一年,明年再见    \n     2014-07-23 11:12 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  多产啊。    \n     2014-07-23 18:47 |    \t\t9k九块钱 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:11        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  @′  雨。 求带！！！    \n     2014-07-28 09:02 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  delupload?    \n     2014-10-21 12:10 |    \t\t1c3z \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:29        | 我读书少，你可别骗我！！！)\t\t \n  叼叼叼。。。    \n     2014-10-21 13:25 |    \t\t0c0c0f \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | My H34rt c4n 3xploit 4ny h0les!)\t\t \n  叼叼叼。。。     \n     2014-10-21 19:21 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n   棒    \n     2014-10-25 10:55 |    \t\t海绵宝宝 \t\t\t( 普通白帽子  |\t\t\t        Rank:243 漏洞数:50        | 唯有梦想与好姑娘不可辜负.)\t\t \n  66666666    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}