{"id": 5851, "wybug_id": "wooyun-2013-043885", "wybug_title": "TCCMS某处设计缺陷，成功打入官网后台", "wybug_corp": "teamcen.com", "wybug_author": "齐迹", "wybug_date": "2013-11-24 14:13", "wybug_open_date": "2014-02-22 14:14", "wybug_type": "", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-22：\t细节向公众公开  简要描述： TCCMS某处设计缺陷，成功打入官网后台！ 详细说明：  问题发生在app\\controller\\user.class.php146行\npublic function update() {\t\t$_Obj = M ( 'user' );\t\tif (($_POST ['info'] ['password'] !== $_POST ['password1'])) {\t\t\tStringUtil::msgbox ( Config::lang ( \"PWDNOTTHESAME\" ), 'index.php?ac=users_info', 1 );\t\t\texit ();\t\t}\t\t$_Obj->create ();\t\tif ($_POST ['info'] ['password'] != \"\" && ($_POST ['info'] [password] == $_POST ['password1'])) {\t\t\t$_Obj->password = strlen ( $_POST ['info'] ['password'] ) > 15 ? $_POST ['info'] ['password'] : md5 ( $_POST ['info'] ['password'] );\t\t}\t\tif (empty ( $_POST ['info'] ['area'] )) {\t\t\t$_Obj->area = \"\";\t\t}\t\tif (empty ( $_POST ['info'] ['city'] )) {\t\t\t$_Obj->city = \"\";\t\t}\t\t//禁止修改管理员\t\t$userObj = get ( \"user\", $_Obj->id );\t\tif ($userObj->grade == 1) {\t\t\tself::checkIsAdmin ();\t\t}\t\t//禁止修改别人的\t\t$IsSelfData = Authen::checkIsSelfData ( $_Obj->id );\t\tif (! $IsSelfData) {\t\t\t$this->setValue ( \"error\", Config::lang ( \"NOTRIGHT\" ) );\t\t\t$this->forward ( \"error.html\" );\t\t\texit ();\t\t}\t\t$_Obj->update ();\t\tStringUtil::msgbox ( Config::lang ( \"MODIFYSUCCESS\" ), 'index.php?ac=user_info', 1 );\t}\n这里调用了 $_Obj->create ();学TP！然后在看看$_Obj->create (); 这个里面什么情况\npublic function create($datas = '') {        $data = array();        $data = $datas;        if (empty($data)) {            $data = $_POST['info'];        } elseif (is_object($data)) {            $data = get_object_vars($data);        } elseif (!is_array($data)) {        \t$msg = Config::lang(\"ILLEGALDATA\");            exit($msg);        }        if (empty($_POST['info']) && empty($data)) { return false; }        $fieldsType = $this->types; //字段和默认值        $fieldsName = $this->fields; //字段和类型        $formKeyAry = array_keys($data); //post过来的所有$key        /* @var $key type */        foreach ($formKeyAry as $key) {            if (array_key_exists($key, $this->fields)) {                $val = isset($data[$key]) ? $data[$key] : NULL;                if (is_scalar($val)) {                    if (false !== strpos($fieldsType[$key], 'int')) {                        $val = intval($val);                    } elseif (false !== strpos($fieldsType[$key], 'float') || false !== strpos($fieldsType[$key], 'double')) {                        $val = floatval($val);                    }                }                if (!is_null($val)) {                    $this->$key = $val;                }                if (($data[$key] == \"\" || $data[$key] == NULL || $data[$key] === 0) && $fieldsName[$key] != \"\") {                    $this->$key = $fieldsName[$key];                }            }        }        return $this;    }\n$_POST['info'][xx]  xx 直接是数据库字段 可以成功修改！在http://www.teamcen.com/index.php?ac=user_info页面通过修改表单名称 成功把注册的普通帐号修改为了管理员帐号   漏洞证明：  成功打入后台！什么注入都弱爆了！直接执行SQL 好舒服\n\n   修复方案：  你们懂的！   版权声明：转载请注明来源 齐迹@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2013-11-24 16:10 厂商回复： 谢谢关注TCCMS开源项目。有前台会员模块的用户受到影响，官方已经将会下一个版本采取后台登陆URL自定义，会员编辑判断是否管理员身份。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-24 14:38 |    \t\t麻花藤 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  ＭＡＲＫ！！！远看洞主在乌云是这么牛B，你家人知道吗    \n     2013-11-24 16:22 |    \t\tTCCMS-PHP内容管理系统(乌云厂商)\t\t \n  有前台会员系统的用户修复办法:在app/controller/user.class.php找到if ($userObj->grade == 1) {    self::checkIsAdmin ();}修改为:if ($userObj->grade == 1 || $_POST[\"info\"][\"grade\"] == 1) {    self::checkIsAdmin ();}    \n     2013-11-24 16:26 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  额，都进后台了，怎么才评5    \n     2013-11-24 16:41 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  因该是走小厂商了    \n     2013-11-24 17:21 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @TCCMS-PHP内容管理系统 如果这样修复 还会有问题！@小川 我没有getshell页没有 drop 所以他们就给我低了！    \n     2013-11-24 19:53 |    \t\tTCCMS-PHP内容管理系统(乌云厂商)\t\t \n  @齐迹 原来这个rank分数是对你们专业级别的评级。继续找漏洞，下次给你高分哈，不过希望不会有新漏洞出现了    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}