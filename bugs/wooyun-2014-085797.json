{"id": 46142, "wybug_id": "wooyun-2014-085797", "wybug_title": "360压缩3.2.0.2030栈缓冲区溢出+空指针引用", "wybug_corp": "奇虎360", "wybug_author": "blast", "wybug_date": "2014-12-03 23:32", "wybug_open_date": "2015-03-03 23:34", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "14", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["搞笑有爱"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-03：\t细节向公众公开  简要描述： 360压缩处理ZIP文件时数据连接不当导致栈缓冲区溢出PoC1 （BufferOverrun.zip，记得往下点两层）。另附一个空指针引用的PoC2 （NullPointerDef.zip，打开就崩了）。（这么弄会掉粉的……- -）0:000> kChildEBP RetAddr  WARNING: Stack unwind information not available. Following frames may be wrong.001289e8 7c98d144 360zip+0x7127e00128a50 00410041 ntdll!RtlDebugAllocateHeap+0x28100128a60 00410041 360zip+0x1004100128a64 0041005c 360zip+0x1004100128a68 00410041 360zip+0x1005c00128a6c 00410041 360zip+0x1004100128a70 00410041 360zip+0x1004100128a74 00410041 360zip+0x1004100128a78 00410041 360zip+0x1004100128a7c 00410041 360zip+0x1004100128a80 00410041 360zip+0x1004100128a84 00410041 360zip+0x1004100128a88 00410041 360zip+0x1004100128a8c 00410041 360zip+0x10041 详细说明：  虽然考虑了一层路径长度最大应该是MAX_PATH，但是完全没有考虑到上下两层文件夹的名字加起来那就不一定是这个数字了，所以在360zip+0x7124b 处两个字符串拷贝函数处扑街了，拷贝完以后发生栈缓冲区溢出。还好有Security Cookies罩着。问题在：\n0:000> gBreakpoint 2 hiteax=03190748 ebx=00000002 ecx=00120000 edx=03190562 esi=00000060 edi=00a64670eip=0047108b esp=001289d4 ebp=03190560 iopl=0         nv up ei pl zr na pe nccs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246360zip+0x7108b:0047108b 2bc2            sub     eax,edx\n上述有问题的函数整理如下（当是伪代码吧）：\ninline BOOL IsWordValid(WORD wd){return !(wd < 0x30 || wd > 0x39);}inline ULONG Min(ULONG a, ULONG b){return a>b?b:a;}ULONG ListItemValueProc(WCHAR* strFileName, WCHAR* strFullPath){\tif ( strFileName && strFullPath )    // strFileName 目录名字， strFullPath 上层目录名和当前层的文件名字组合在一起的内容    {   \t\tULONG nLenFileName = wcslen(strFileName);\t\tULONG nLenFullPath = wcslen(strFullPath); \t\t\t\tif(nLenFileName > 0)\t\t{\t\t\tULONG nPos1  = 0;\t\t\tULONG nPos2  = 0;\t\t\t\t\t\tULONG nPosTemp = 0;\t\t\t\t\t\tWCHAR wTemp  = 0;\t\t\t\t\t\twhile(1)\t\t\t{\t\t\t\tif(nPos2 > nLenFileName) goto some mark //break;\t\t\t\tif(!IsWordValid(pszStrFileName[pos]) || \t\t\t\t   !IsWordValid(pszStrFullPath[pos2])) \t\t\t\t   break;\t\t\t\t\t\t\t\t\t\t\t\tnPosTemp = nPos1;\t\t\t\tpos2++;\t\t\t\t\t\t\t\tif(nPos1 + 1 < nLenFullPath)\t\t\t\t{\t\t\t\t\twhile(nPosTemp++ < nLenFullPath && IsWordValid(pszStrFileName[nPosTemp]));\t\t\t\t}\t\t\t\t\t\t\t\t//where's if\t\t\t\twhile(nPos2++ < nLenFullPath && IsWordValid(pszStrFullPath[nPos2]));\t\t\t\t\t\t\t\tULONG nCounter1 = 0;\t\t\t\tULONG nCounter2 = 0;\t\t\t\t//WCHAR* szString1 = 0;\t\t\t\tWCHAR szSomeBuffer[MAX_PATH] = {0};\t\t\t\tswscanf(pszStrFileName[nPos1], L\"%d%s\", &nCounter1, szSomeBuffer); //szString1);\t\t\t\tswscanf(pszStrFullPath[nPos1], L\"%d%s\", &nCounter2, szSomeBuffer); //szString1); //szString1应该就是buffer。\t\t\t\tif ( nCounter1 > nCounter2 ) return 1;\t\t\t\tif ( nCounter1 < nCounter2 ) return -1; \t\t\t\t \t\t\t\tnPos1 = nPosTemp;\t\t\t\tSOMELABELUNKNOWN:\t\t\t\tif ( nPos >= nLenFullPath) goto endOfScanning;\t\t\t\t\t\t\t} // end of while(1)\t\t\t\t\t\tULONG nPosA = nPos1 + 1;\t\t\tULONG nPosB = nPos2 + 1;\t\t\tif ( pos + 1 < nLenFileName )\t\t\t{\t\t\t\twhile(nPosA++ < nLenFullPath && IsWordValid(pszStrFileName[nPosA])); //找到最后一个有效字符\t\t\t}\t\t\t//同上，一样的操作\t\t\twhile(nPosB++ < nLenFullPath && IsWordValid(pszStrFullPath[nPosB]));\t\t\t\t\t\t\t\t\tULONG nDiff = nPosA - nPos1;\t\t\tULONG nDiff2= nPosB - nPos2;\t\t\tULONG nDiff3= nLenFileName - nPos1;\t\t\tULONG nDiff4= nLenFullPath - nPos2; \t\t\t\t\t\tif(nDiff < nDiff2)\t\t\t{\t\t\t\tnDiff4 = Min(nDiff2, nDiff3);\t\t\t}\t\t\telse\t\t\t{\t\t\t\tif(nDiff4 > nDiff)\t\t\t\t\tnDiff4 = nDiff;\t\t\t}\t\t\t\t\t\tWCHAR szSomeBufferA[MAX_PATH] = {0};\t\t\tWCHAR szSomeBufferB[MAX_PATH] = {0};\t\t\twcsncpy(szSomeBufferA, pszStrFileName[nPos1], nDiff4); //!!!WARNING!!!\t\t\twcsncpy(szSomeBufferB, pszStrFullPath[nPos2], nDiff4); //!!!WARNING!!!\t\t\t\t\t\tULONG nCompareResult = CompareStringW(LOCALE_USER_DEFAULT, NORM_IGNORECASE, szSomeBufferA, -1, szSomeBufferB, -1); \t\t\t//-1: 字符串是Null Terminated\t\t\t\t\t\tif ( nCompareResult )\t\t\t{\t\t\t\tif ( nCompareResult == 2 )\t\t\t\t{\t\tLABEL_42:\t\t\t\t  pos += nDiff4;\t\t\t\t  pos2 += nDiff4;\t\t\t\t  goto SOMELABELUNKNOWN;\t\t\t\t}\t\t\t\tif(nCompareResult == 1) \t\t\t\t\tresult = -1;\t\t\t\telse\t\t\t\t\tresult = 1;\t\t\t\t//2 * (nCompareResult != 1) - 1;\t\t\t}\t\t\telse\t\t\t{\t\t\t\tresult = _wcsicmp(szSomeBufferA, szSomeBufferB);\t\t\t} \t\t\t\t\t\tif(result) \t\t\t\treturn result;\t\t\telse\t\t\t\tgoto LABEL_42;\t\t\t\t\t\t\t}endOfScanning:\tresult = 0;    if ( nLenFileName != nLenFullPath )    {      if(nLenFileName > nLenFullPath)\t    result = 1;\t  else\t\tresult = -1;    }\t\t  }  else //if ( strFileName && strFullPath ) 的else部分  {\tresult = 0;  }  return result;}\n   漏洞证明：  \n0:000> pcteax=001289f0 ebx=00000000 ecx=00000000 edx=00128bf8 esi=00000128 edi=00000000eip=0047127e esp=001289b4 ebp=0222029e iopl=0         nv up ei pl nz na pe nccs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206360zip+0x7127e:0047127e ff1590a14e00    call    dword ptr [360zip+0xea190 (004ea190)] ds:0023:004ea190={kernel32!CompareStringW (7c80a3ee)}0:000> kChildEBP RetAddr  WARNING: Stack unwind information not available. Following frames may be wrong.001289e8 7c98d144 360zip+0x7127e00128a50 00410041 ntdll!RtlDebugAllocateHeap+0x28100128a60 00410041 360zip+0x1004100128a64 0041005c 360zip+0x1004100128a68 00410041 360zip+0x1005c00128a6c 00410041 360zip+0x1004100128a70 00410041 360zip+0x1004100128a74 00410041 360zip+0x1004100128a78 00410041 360zip+0x1004100128a7c 00410041 360zip+0x1004100128a80 00410041 360zip+0x1004100128a84 00410041 360zip+0x1004100128a88 00410041 360zip+0x1004100128a8c 00410041 360zip+0x1004100128a90 00410041 360zip+0x1004100128a94 00410041 360zip+0x10041\n\n0:000> dd esp L200001289b4  00000400 00000001 001289f0 ffffffff001289c4  00128bf8 ffffffff 00a75a70 00000002001289d4  00a64708 00128e34 0000018a 0222004c001289e4  00000128 ffffffff 7c98d144 00580045001289f4  00520054 004c0041 004e004f 0041004700128a04  00410041 00410041 00410041 0041004100128a14  00410041 00410041 00410041 0041004100128a24  00410041 00410041 00410041 0041004100128a34  00410041 00410041 00410041 0041004100128a44  00410041 00410041 00410041 0041004100128a54  00410041 00410041 00410041 0041004100128a64  00410041 0041005c 00410041 0041004100128a74  00410041 00410041 00410041 0041004100128a84  00410041 00410041 00410041 0041004100128a94  00410041 00410041 00410041 0041004100128aa4  00410041 00410041 00410041 0041004100128ab4  00410041 00410041 00410041 0041004100128ac4  00410041 00410041 00410041 0041004100128ad4  00410041 00410041 00410041 0041004100128ae4  00410041 00410041 00410041 0041004100128af4  00410041 00410041 00410041 0041004100128b04  00410041 00410041 00410041 0041004100128b14  00410041 00410041 00410041 0041004100128b24  00410041 00410041 00410041 0041004100128b34  00410041 00410041 00410041 0041004100128b44  00410041 00410041 00410041 0041004100128b54  00410041 00410041 00410041 0041004100128b64  00410041 00410041 00410041 0041004100128b74  00410041 00410041 00410041 0041004100128b84  00410041 00410041 00410041 00410041\nand。。poc2：\n(59c.3a4): Access violation - code c0000005 (!!! second chance !!!)eax=00000000 ebx=02267cf4 ecx=00000002 edx=028d0016 esi=00000005 edi=015a3ee8eip=01517ca5 esp=02417ba4 ebp=015a3ee4 iopl=0         nv up ei pl nz na po nccs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\\Program Files\\360\\360zip\\360zipc.dll - 360zipc!DeleteExtractObject+0x1f4a5:01517ca5 394858          cmp     dword ptr [eax+58h],ecx ds:0023:00000058=????????\n   修复方案：  使用_s拷贝函数或者好好校验要写入缓冲区的数据内容   版权声明：转载请注明来源 blast@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-12-05 13:29 厂商回复： 感谢白帽子报告此问题，这是360压缩在处理畸形格式文件时发生的溢出漏洞，我们将尽快修复此漏洞。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-03 23:36 |    \t\tblast \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:57        | 五仁委员会)\t\t \n  orz  贴的poc连接没了= = 刚编辑了 麻烦审核下= =     \n     2014-12-03 23:38 |    \t\tblast \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:57        | 五仁委员会)\t\t \n  = =..厂家看不到的话请私信我....    \n     2014-12-03 23:47 |    \t\t路西法 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 堕落天使路西法)\t\t \n  @blast 请私信我POC O(∩_∩)O哈哈~    \n     2014-12-04 00:53 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  师傅＠说好的给徒儿一份呢    \n     2014-12-04 08:14 |    \t\t其实我是路人甲 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 生活要多一点快乐！)\t\t \n  师傅＠说好的给徒儿一份呢    \n     2014-12-04 08:59 |    \t\tblast \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:57        | 五仁委员会)\t\t \n  师傅＠说好的给徒儿一份呢     \n     2014-12-09 20:56 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:3        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  师傅＠说好的给徒儿一份呢    \n     2014-12-10 18:17 |    \t\t轨迹 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 321)\t\t \n  师傅＠说好的给徒儿一份呢    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}