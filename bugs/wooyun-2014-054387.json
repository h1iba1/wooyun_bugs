{"id": 3421, "wybug_id": "wooyun-2014-054387", "wybug_title": "建站之星Sitestar前台Getshell一枚", "wybug_corp": "建站之星", "wybug_author": "′雨。", "wybug_date": "2014-03-23 17:54", "wybug_open_date": "2014-06-21 17:55", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-21：\t细节向公众公开  简要描述： 看sitestar 在某数字公司还是属于一般应用的, 就准备提数字了。  太坑了 然后果断拒绝提交详情。 还是提到乌云来把。 不知道sitestar在乌云是不是属于一般应用的? 狗哥给个回应哈。Sitestar 前台Getshell。 无需登录。 详细说明：  在官方论坛上下的最新版在 install/index.php中\ndefine('IN_CONTEXT', 1);include_once('load.php');?>\n 包含进来 那再继续看看。\n$lockfile = ROOT.'/install.lock';$pattern_db = '/[0-9a-zA-Z]*$/';if(!preg_match($pattern_db, $db_name)||!preg_match($pattern_db, $db_user)){\techo '1001';exit;}if(file_exists($lockfile) && ($_a=='template' || $_a=='setting' || $_a=='check')) {\t\texit('please delete install.lock!');}\n这里判断了Lock 而且if(file_exists($lockfile) && ($_a=='template' || $_a=='setting' || $_a=='check')关键这里是一个and 而不是一个or  只要不满足后面的 也就不会退出了。继续看后面的码。\nif($_a=='template'){\tinclude P_TPL.\"/template.php\";}else if($_a=='check'){\tinclude P_TPL.\"/check.php\";}else if($_a=='setting'){\t$default_tpl = ParamHolder::get(\"default_tpl\",\"jixie-110118-a16\");\t$_SESSION['default_tpl'] = $default_tpl;\tinclude P_TPL.\"/setting.php\";}else if($_a=='result'){\t$domain = $_SERVER['HTTP_HOST'];\tif(isset($_SERVER['SERVER_ADDR'])){\t\t$ip = $_SERVER['SERVER_ADDR'];\t}else{\t\t$ip='127.0.0.1';\t}\t$version = 'sitestar_v2.7_build131012';\t$system = preg_replace('/\\s/','',PHP_OS);\t$vphp = PHP_VERSION;\t$vmysql = $_SESSION['vmysql'];\t$tpl_name = $_SESSION['default_tpl'];\t$http = new Http(\"http://licence.sitestar.cn/feedback.php?domain=$domain&ip=$ip&version=$version&vphp=$vphp&vmysql=$vmysql&tpl_name=$tpl_name&vos=$system\");\t$http->get();\tinclude P_TPL.\"/result.php\";    create_file($version);}else if($_a=='checkconnection'){\t$link = @mysql_connect($db_host,$db_user,$db_pwd);\tif (!$link) {\t\techo '1001';\t\texit;\t}\t$r = mysql_select_db($db_name,$link);\tif(!$r){\t\techo '1002';\t\texit;\t}}else if($_a==\"create\"){\t$link = mysql_connect($db_host,$db_user,$db_pwd);\tif (!$link) {\t\techo '1001';\t\texit;\t}\t$r = mysql_select_db($db_name,$link);\tif(!$r){\t\techo '1002';\t\texit;\t}\t\t$rtn = create_table($db_name,$db_prefix,INSTALL_ROOT.'/../sql/basic.sql');\tif(!empty($rtn)){\t\techo '1005';\t\texit;\t}\tmysql_query(\"INSERT INTO `\".$db_prefix.\"parameters` (`id`, `key`, `val`) VALUES (NULL, 'DEFAULT_TPL', '\".$_SESSION['default_tpl'].\"')\");\t//uploadcopy(ROOT.\"/template/\".$_SESSION['default_tpl'].\"/\".$_SESSION['default_tpl'].\"_2_upload/image\",ROOT.\"/upload/image\");\t//uploadcopy(ROOT.\"/template/\".$_SESSION['default_tpl'].\"/\".$_SESSION['default_tpl'].\"_2_upload/flash\",ROOT.\"/upload/flash\");\tif($demo=='1'){\t\tcreate_table($db_name,$db_prefix,ROOT.\"/template/\".$_SESSION['default_tpl'].\"/\".$_SESSION['default_tpl'].'_2_sample.sql');\t} else {\t\tmysql_query(\"INSERT INTO `\".$db_prefix.\"static_contents` (`id` ,`title` ,`content` ,`create_time` ,`s_locale` ,`published` ,`for_roles`) VALUES ('1', '', NULL , '', 'zh_CN', '1', '{member}{admin}{guest}');\");\t\tmysql_query(\"INSERT INTO `\".$db_prefix.\"static_contents` (`id` ,`title` ,`content` ,`create_time` ,`s_locale` ,`published` ,`for_roles`) VALUES ('2', '', NULL , '', 'zh_CN', '1', '{member}{admin}{guest}');\");\t\tmysql_query(\"INSERT INTO `\".$db_prefix.\"static_contents` (`id` ,`title` ,`content` ,`create_time` ,`s_locale` ,`published` ,`for_roles`) VALUES ('3', '', NULL , '', 'en', '1', '{member}{admin}{guest}');\");\t\tmysql_query(\"INSERT INTO `\".$db_prefix.\"static_contents` (`id` ,`title` ,`content` ,`create_time` ,`s_locale` ,`published` ,`for_roles`) VALUES ('4', '', NULL , '', 'en', '1', '{member}{admin}{guest}');\");\t}\t\techo '1003';}else if($_a==\"createadmin\"){\t$link = mysql_connect($db_host,$db_user,$db_pwd);\tif (!$link) {\t\techo '1001';\t\texit;\t}\t$r = mysql_select_db($db_name,$link);\tif(!$r){\t\techo '1002';\t\texit;\t}\tmysql_query(\"set names utf8\");\tmysql_select_db($db_name,$link);\t$mysql_query = mysql_query(\"select VERSION()\");\t$mysql_row = mysql_fetch_row($mysql_query);\t$vmysql = $mysql_row[0];\t$_SESSION['vmysql'] = $mysql_row[0];\t$passwd = sha1($admin_pwd);\t$tme = time();\tif ($link) {\t\tcreate_config($db_host1,$db_user,$db_pwd,$db_name,$db_prefix,$db_port);\t}\t$query = mysql_query(\"insert into \".$db_prefix.\"users(login,passwd,email,lastlog_time,rstpwdreq_time,active,s_role) values('$admin_name','$passwd','admin@admin.com','$tme','0','1','{admin}')\");\t$insert_id = mysql_insert_id();\t$query = mysql_query(\"insert into \".$db_prefix.\"user_extends(total_saving,total_payment,balance,user_id) values('0.00','0.00','0.00','$insert_id')\");\tif($query){\t\techo '1004';\t}\n可以看到 除开 template  setting  和check 还有其他的 来找找哪个可以利用的。\n}else if($_a==\"createadmin\"){\t$link = mysql_connect($db_host,$db_user,$db_pwd);\tif (!$link) {\t\techo '1001';\t\texit;\t}\t$r = mysql_select_db($db_name,$link);\tif(!$r){\t\techo '1002';\t\texit;\t}\tmysql_query(\"set names utf8\");\tmysql_select_db($db_name,$link);\t$mysql_query = mysql_query(\"select VERSION()\");\t$mysql_row = mysql_fetch_row($mysql_query);\t$vmysql = $mysql_row[0];\t$_SESSION['vmysql'] = $mysql_row[0];\t$passwd = sha1($admin_pwd);\t$tme = time();\tif ($link) {\t\tcreate_config($db_host1,$db_user,$db_pwd,$db_name,$db_prefix,$db_port);\t}\t$query = mysql_query(\"insert into \".$db_prefix.\"users(login,passwd,email,lastlog_time,rstpwdreq_time,active,s_role) values('$admin_name','$passwd','admin@admin.com','$tme','0','1','{admin}')\");\t$insert_id = mysql_insert_id();\t$query = mysql_query(\"insert into \".$db_prefix.\"user_extends(total_saving,total_payment,balance,user_id) values('0.00','0.00','0.00','$insert_id')\");\n我所利用的是这个。 貌似可以直接添加一个管理。 但是不甘心, 看看能不能直接Getshell。\n$link = mysql_connect($db_host,$db_user,$db_pwd);\tif (!$link) {\t\techo '1001';\t\texit;\t}\t$r = mysql_select_db($db_name,$link);\tif(!$r){\t\techo '1002';\t\texit;\t}\n首先看这里。   要检测mysql是否能够连接得上, 并且$db_name 得存在这个mysql中。\n$_a = ParamHolder::get(\"_a\",\"\");$_m = ParamHolder::get(\"_m\",\"frontpage\");$db_host1 = ParamHolder::get(\"db_host\",\"\");$db_user = ParamHolder::get(\"db_user\",\"\");$db_pwd = ParamHolder::get(\"db_pwd\",\"\");$db_name = ParamHolder::get(\"db_name\",\"\");$db_prefix = ParamHolder::get(\"db_prefix\",\"\");$db_port = ParamHolder::get(\"db_port\",\"\");$admin_name = ParamHolder::get(\"admin_name\",\"\");$admin_pwd = ParamHolder::get(\"admin_pwd\",\"\");$demo = ParamHolder::get(\"demo\",\"\");$db_host = $db_host1.\":\".$db_port;\n可以看到哪些参数都是可控的。我们自己搭建一个mysql 可外联就行了。\n$pattern_db = '/[0-9a-zA-Z]*$/';\n\nif(!preg_match($pattern_db, $db_name)||!preg_match($pattern_db, $db_user)){\techo '1001';exit;}\n匹配出除开0-9 a-z A-Z 以外的就退出。\n$passwd = sha1($admin_pwd);\t$tme = time();\tif ($link) {\t\tcreate_config($db_host1,$db_user,$db_pwd,$db_name,$db_prefix,$db_port);\t}\n这里 跟进去 \nfunction create_config($host,$user,$pwd,$dnname,$pre,$port){\t$str = \"\";\t$str .= \"<?php \\n\";\t$str.=\"if (!defined('IN_CONTEXT')) die('access violation error!');\\n\";\t$str.=\"class Config {\\n\";\t$str .= \"public static \\$mysql_ext = 'mysql';\\n\";\t$str .= \"public static \\$db_host = '$host';\\n\";\t$str .= \"public static \\$db_user = '$user';\\n\";\t$str .= \"public static \\$db_pass = '$pwd';\\n\";\t$str .= \"public static \\$db_name = '$dnname';\\n\";\t$str .= \"public static \\$port = '$port';\\n\";\t$str .= \"public static \\$mysqli_charset = 'utf8';\\n\";\t$str .= \"public static \\$tbl_prefix = '$pre';\\n\";\t$str .= \"public static \\$cookie_prefix = '\".randomStr(6).\"_';\\n\";\t$str .= \"public static \\$enable_db_debug = false;\\n\";\t$str .= \"}?>\\n\";\tfile_put_contents(\"../config.php\",$str);\n可以看到 直接写到一个php文件里了。  这时候 好像一切都ok了。可是 一切又没有那么的容易。\n\naccess violation error!是不能含有单引号的。  但是在这里 关键的是 他没有过滤转义符。。然后就进入了无尽的测试当中。。\nfunction create_config($host,$user,$pwd,$dnname,$pre,$port){\t$str = \"\";\t$str .= \"<?php \\n\";\t$str.=\"if (!defined('IN_CONTEXT')) die('access violation error!');\\n\";\t$str.=\"class Config {\\n\";\t$str .= \"public static \\$mysql_ext = 'mysql';\\n\";\t$str .= \"public static \\$db_host = '$host';\\n\";\t$str .= \"public static \\$db_user = '$user';\\n\";\t$str .= \"public static \\$db_pass = '$pwd';\\n\";\t$str .= \"public static \\$db_name = '$dnname';\\n\";\t$str .= \"public static \\$port = '$port';\\n\";\t$str .= \"public static \\$mysqli_charset = 'utf8';\\n\";\t$str .= \"public static \\$tbl_prefix = '$pre';\\n\";\t$str .= \"public static \\$cookie_prefix = '\".randomStr(6).\"_';\\n\";\t$str .= \"public static \\$enable_db_debug = false;\\n\";\t$str .= \"}?>\\n\";\tfile_put_contents(\"../config.php\",$str);\n看这个  理论上来说 只有 \t\n$str .= \"public static \\$mysqli_charset = 'utf8';\\n\";\t$str .= \"public static \\$cookie_prefix = '\".randomStr(6).\"_';\\n\";$str .= \"public static \\$enable_db_debug = false;\\n\";\n这三行不可控, 但是 由于\n$str .= \"public static \\$db_host = '$host';\\n\";\t$str .= \"public static \\$db_user = '$user';\\n\";\t$str .= \"public static \\$db_pass = '$pwd';\\n\";\t$str .= \"public static \\$db_name = '$dnname';\\n\";\n这四个 会用来连接 如果连接不上的话 就退出了。 就算不上能随意控制。\n$str .= \"public static \\$port = '$port';\\n\";\t$str .= \"public static \\$mysqli_charset = 'utf8';\\n\";\t$str .= \"public static \\$tbl_prefix = '$pre';\\n\";\n就剩下了这两个可控。 但是中间还有了个不可控的。如果两个可控的挨在一起的话 可以这样public static $port = '\\';public static $tbl_prefix = ';phpinfo();/*';但是由于中间多了一个不可控的 所以不能直接这样。。  如果可控的两行没挨在一起的话那么可控的必须要三行了 才能执行了。。 那怎么办呢?DB_HOST 肯定是不能改的 要不就连不上了。那就要从 DB_NAME  db_user 和 db_pwd 下手了。\n$pattern_db = '/[0-9a-zA-Z]*$/';if(!preg_match($pattern_db, $db_name)||!preg_match($pattern_db, $db_user)){\techo '1001';exit;}\n这里的正则 验证了 db_name 和 db_user 但是 这中间连接的是一个or。那只要让一个匹配不出除开09 az AZ以外的就行了。那就让db_name匹配不出 因为我测试了db_name 在我创建数据库的时候无法添加符号的。这样只有从db_user 和 db_pwd 下手了。 在本地的mysql里 建一个含有特殊字符的 账户 和 密码。让账户为test@localhost\\ 密码为;/*这样类似的就行了。来测试测试。   漏洞证明：  \n\n首先建立一个账户。 要记得对一些字符转义。然后 访问\n\n来看看配置文件。\n\n直接访问首页。\n\n成功getshell。   修复方案：  说得很清楚啦。低调求20.   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-03-23 21:46 厂商回复： 漏洞利用的条件比较严格，按照表述至少还需要知道mysql的相关权限，而这个对于外部客户来说是几乎很难的一个前提，但是鉴于你的严格的逻辑分析和如此清楚的描述，给15分以表谢意，我们会尽快发布安全补丁。 最新状态： 2014-03-27：我们已经发布了安全补丁，请相关用户在后台点击升级就可以，为了让用户有个升级期，漏洞先不提前公开，让大家能够有时间去升级。谢谢白帽子的支持和理解。  ", "replys": "漏洞评价：\n评论\n     2014-03-23 17:57 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  给力    \n     2014-03-23 18:01 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  少年很赞！    \n     2014-03-23 20:51 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  我也提了几个sitestar的，没有通用奖励 应该只有Q币。    \n     2014-03-23 21:58 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   亲  是不需要本地的mysql密码的。   直接自己搭建一个mysql  开启外联  就可以了。  并不需要本地的mysql密码。    \n     2014-03-23 22:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n     @建站之星你看我测试的时候  都是用的远程的好么。 并不需要知道他原本的mysql密码的。   你们可以具体测试测试。    \n     2014-03-24 11:54 |    \t\tevil_webshell \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 致力于web层面的安全，热爱黑客技术，正在...)\t\t \n  少年加油    \n     2014-03-24 20:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  看来 厂商还是没懂我的意思 。  那个连接的时候 并不需要拿到网站mysql的权限。而是 自己搭建一个Mysql环境, 开启远程连接 然后去连接。所以 利用着 并不苛刻。 只要这个文件存在 一般就可以利用。    \n     2014-03-27 10:45 |    \t\t建站之星(乌云厂商)\t\t \n  @′  雨。 你好，不是我们没有懂你的意思，作为产品维护者和厂商，我们无论任何漏洞信息我们都会第一时间处理和发布补丁，你说的情况我们已经进行了处理和发布了补丁。请大家在后台升级就行。    \n     2014-03-27 20:17 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @建站之星 你又傻X了，自己在回复的时候没说清楚，别人给你解释， 你还说已经修复，呵呵呵呵呵！    \n     2014-03-28 17:11 |    \t\tMorker \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:24        | 双手是最重要的、、、)\t\t \n  坐等了    \n     2014-06-21 19:06 |    \t\tCplusHua \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:33        | 乌云奖金:-1)\t\t \n  @′  雨。 厉害，跟当时DEDE一个变量覆盖，覆盖mysql host，外联mysql的差不多~  思路很好，值得借鉴~ 赞！    \n     2014-06-21 19:40 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  看来厂商并不是真的清楚这漏洞在干什么，虽然我PHP很菜，但是我也大概明白了    \n     2014-06-24 10:22 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  最开始厂商没看懂，后来发现你们都在评论后，仔细一看，我擦，竟然是连接攻击者自己的数据库就可以利用，后来横竖不管怎么样，必须得狡辩一下就闪人，面子还是要的。    \n     2014-06-24 10:23 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @char   哈哈 不过还是正确修复了的    \n     2014-06-24 10:27 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  @′  雨。 修复是一回事，狡辩是另一回事。哈哈    \n     2015-03-22 19:09 |    \t\t拨开乌云 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        )\t\t \n  经典啊~~~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}