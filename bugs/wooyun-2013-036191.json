{"id": 8813, "wybug_id": "wooyun-2013-036191", "wybug_title": "ecshop2.73 api.php 两处鸡肋注入", "wybug_corp": "ShopEx", "wybug_author": "Chora", "wybug_date": "2013-09-05 16:13", "wybug_open_date": "2013-10-20 16:14", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-09-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-09-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-09-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-10-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-10-20：\t细节向公众公开  简要描述： null 详细说明：  switch ($_POST['act']){    case 'search_goods_list': search_goods_list(); break;    case 'search_products_list': search_products_list(); break;......}function search_products_list(){    check_auth(); ......if (!empty($_POST['goods_id']) && is_numeric($_POST['goods_id']) || !empty($_POST['bn'])) //goods_id不为数字,bn不为空.假假得假,假真得真.    {        $sql = 'SELECT goods_id, last_update AS last_modify, shop_price AS price, goods_sn AS bn, goods_name AS name,  goods_weight         AS weight, goods_number AS store, add_time AS uptime' .               ' FROM ' . $GLOBALS['ecs']->table('goods') .               ' WHERE ' . empty($_POST['bn']) ? \"goods_id = $_POST[goods_id]\" : \"goods_sn = $_POST[bn]\"; //bn带入查询.        $goods_data = $GLOBALS['db']->getRow($sql);......}function search_goods_list(){......        $page = empty($_POST['pages']) ? 1 : $_POST['pages']; //没过滤          $counts = empty($_POST['counts']) ? 100 : $_POST['counts']; //没过滤.  1 union select 1,user()        $sql = 'SELECT goods_id, last_update AS last_modify' .               ' FROM ' . $GLOBALS['ecs']->table('goods') .               \" WHERE is_delete = 0 AND is_on_sale = 1 AND (last_update > '\" . $_POST['last_modify_st_time'] . \"' OR last_update = 0)\".               \" LIMIT \".($page - 1) * $counts . ', ' . $counts;//联合查询select...limit 1,1 union select 1,user()        $date_arr = $GLOBALS['db']->getAll($sql);)function check_auth(){    $license = get_shop_license();  // 取出网店 license信息    if (empty($license['certificate_id']) || empty($license['token']) || empty($license['certi']))    {        api_err('0x006', 'no certificate');   //没有证书数据，输出系统级错误:用户权限不够    }    if (!check_shopex_ac($_POST, $license['token'])) //带入token,需要知道数据库里token的值.    {        api_err('0x009');   //输出系统级错误:签名无效    }    /* 对应用申请的session进行验证 */    $certi['certificate_id'] = $license['certificate_id']; // 网店证书ID    $certi['app_id'] = 'ecshop_b2c'; // 说明客户端来源    $certi['app_instance_id'] = 'webcollect'; // 应用服务ID    $certi['version'] = VERSION . '#' .  RELEASE; // 网店软件版本号    $certi['format'] = 'json'; // 官方返回数据格式    $certi['certi_app'] = 'sess.valid_session'; // 证书方法    $certi['certi_session'] = $_POST['app_session']; //应用服务器申请的session值    $certi['certi_ac'] = make_shopex_ac($certi, $license['token']); // 网店验证字符串    $request_arr = exchange_shop_license($certi, $license);    if ($request_arr['res'] != 'succ')    {        api_err('0x001', 'session is invalid');   //输出系统级错误:身份验证失败    }}function check_shopex_ac($post_params,$token){    ksort($post_params);    $str = '';    foreach($post_params as $key=>$value)    {        if ($key!='ac')        {            $str.=$value;        }    }    if ($post_params['ac'] == md5($str.$token))//ac的值要等于提交的参数加上$license['token']的值的md5码.    {         return true;    }    else    {        return true;    }}   漏洞证明：  \n\n\n\n   修复方案：  ...   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2013-09-06 08:51 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-05 16:53 |    \t\tSkull \t\t\t( 实习白帽子  |\t\t\t        Rank:95 漏洞数:33        | 菜鸟一枚。)\t\t \n  mark 前排    \n     2013-09-05 17:04 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  牛逼的路人甲    \n     2013-09-05 18:26 |    \t\tty4z2008 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:5        | Web与数据库习者)\t\t \n  我记得这个昨天在某人的博客看到过    \n     2013-09-17 16:41 |    \t\t大肠精 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 业余兴趣而已)\t\t \n  这个要有那个license才可以的吧    \n     2013-09-26 13:05 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  求工具.- -    \n     2013-09-26 13:49 |    \t\tChora \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:22        | 生存、生活、生命。)\t\t \n  @Black Angel ...这个好老了,有一年没玩了,不知道新工具,当时没得办法就用的这个,用火狐的hackbar呗    \n     2013-10-10 16:02 |    \t\t大肠精 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 业余兴趣而已)\t\t \n  终于公开了,我就知道是这个诶    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}