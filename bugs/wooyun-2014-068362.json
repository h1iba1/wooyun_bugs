{"id": 778, "wybug_id": "wooyun-2014-068362", "wybug_title": "74cms (20140709) 二枚二次注入", "wybug_corp": "74c,s.com", "wybug_author": "′雨。", "wybug_date": "2014-07-13 14:16", "wybug_open_date": "2014-10-11 14:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-11：\t细节向公众公开  简要描述：  不好好的通过修改造成漏洞的代码 而是通过修改过滤函数。  现在的过滤函数, 虽然我是绕不过去了。但是还是能找到几处能出数据的。之前未通过,这次两个打个包来。P.S:这很不好意思 之前测试demo的时候 因为有个是个update的点 忘记加where限制条件了 导致给某处全部都出数据了。。。。。不只应该修改过滤函数,而且也应该在造成漏洞的代码好好的修复一下。 详细说明：  第一枚。 第一枚就不分析代码了。首先注册一个企业会员 然后创建企业\n\n单引号会被转义 然后转义入库。 找找出库的地方。然后创建好企业后 发布招聘 如下。\n\n\n\n点击发布后 可以看到报错了。  这里刚才的企业名出库了 而且带入到了查询当中。这里稍微构造下还是能出数据。 这个咋出数据就不多说了, 第二处再来说说出数据。_____________________________________________________________________________第二处 与上个不同的是 这个是注册一个个人会员然后发布简历。来看代码在user/personal/personal_resume.php中\nelseif ($act=='make4_save'){\t$resume_education=get_resume_education($_SESSION['uid'],$_REQUEST['pid']);\tif (count($resume_education)>=6) showmsg('教育经历不能超过6条！',1,$link);\t$setsqlarr['uid']=intval($_SESSION['uid']);\t$setsqlarr['pid']=intval($_REQUEST['pid']);\tif ($setsqlarr['uid']==0 || $setsqlarr['pid']==0 ) showmsg('参数错误！',1);\t$setsqlarr['start']=trim($_POST['start'])?$_POST['start']:showmsg('请填写开始时间！',1,$link);\t$setsqlarr['endtime']=trim($_POST['endtime'])?$_POST['endtime']:showmsg('请填写结束时间！',1,$link);\t$setsqlarr['school']=trim($_POST['school'])?$_POST['school']:showmsg('请填写学校名称！',1,$link);\t$setsqlarr['speciality']=trim($_POST['speciality'])?$_POST['speciality']:showmsg('请填写专业名称！',1,$link);\t$setsqlarr['education']=trim($_POST['education'])?$_POST['education']:showmsg('请选择获得学历！',1,$link);\t$setsqlarr['education_cn']=trim($_POST['education_cn'])?$_POST['education_cn']:showmsg('请选择获得学历！',1,$link);\t\tif (inserttable(table('resume_education'),$setsqlarr))\t\t{\t\t\tcheck_resume($_SESSION['uid'],intval($_REQUEST['pid']));\ninserttable(table('resume_education')这里把post来的数据带入到了insert当中 入库。这里我们提交一个单引号 然后带入insert的时候虽然是转义 但是入库后会消除转义符。然后继续看 check_resume\nfunction check_resume($uid,$pid){\tglobal $db,$timestamp,$_CFG;\t$uid=intval($uid);\t$pid=intval($pid);\t$percent=0;\t$resume_basic=get_resume_basic($uid,$pid);\t$resume_intention=$resume_basic['intention_jobs'];\t$resume_specialty=$resume_basic['specialty'];\t$resume_education=get_resume_education($uid,$pid);\tif (!empty($resume_basic))$percent=$percent+15;\tif (!empty($resume_intention))$percent=$percent+15;\tif (!empty($resume_specialty))$percent=$percent+15;\tif (!empty($resume_education))$percent=$percent+15;\tif ($resume_basic['photo_img'] && $resume_basic['photo_audit']==\"1\"  && $resume_basic['photo_display']==\"1\")\t{\t$setsqlarr['photo']=1;\t}\telse\t{\t$setsqlarr['photo']=0;\t}\tif ($percent<60)\t{\t\t$setsqlarr['complete_percent']=$percent;\t\t$setsqlarr['complete']=2;\t}\telse\t{\t\t$resume_work=get_resume_work($uid,$pid);\t\t$resume_training=get_resume_training($uid,$pid);\t\t$resume_photo=$resume_basic['photo_img'];\t\tif (!empty($resume_work))$percent=$percent+13;\t\tif (!empty($resume_training))$percent=$percent+13;\t\tif (!empty($resume_photo))$percent=$percent+14;\t\t$setsqlarr['complete']=1;\t\t$setsqlarr['complete_percent']=$percent;\t\trequire_once(QISHI_ROOT_PATH.'include/splitword.class.php');\t\t$sp = new SPWord();\t\t$setsqlarr['key']=$resume_basic['intention_jobs'].$resume_basic['recentjobs'].$resume_basic['specialty'];\t\t\t\t$setsqlarr['key']=\"{$resume_basic['fullname']} \".$sp->extracttag($setsqlarr['key']);\t\t$setsqlarr['key']=str_replace(\",\",\" \",$resume_basic['intention_jobs']).\" {$setsqlarr['key']} {$resume_basic['education_cn']}\";\t\t$setsqlarr['key']=$sp->pad($setsqlarr['key']);\t\t\tif (!empty($resume_education))\t\t{\t\t\tforeach($resume_education as $li)\t\t\t{\t\t\t$setsqlarr['key']=\"{$li['school']} {$setsqlarr['key']} {$li['speciality']}\";\t\t\t}\t\t}\t\t$setsqlarr['refreshtime']=$timestamp;\t}\tupdatetable(table('resume'),$setsqlarr,\"uid='{$uid}' AND id='{$pid}'\");\tupdatetable(table('resume_tmp'),$setsqlarr,\"uid='{$uid}' AND id='{$pid}'\");\n\t$resume_education=get_resume_education($uid,$pid);这里把刚才入库的查询了出来  所以单引号就出来了。 继续看。\n$setsqlarr['key']=$resume_basic['intention_jobs'].$resume_basic['recentjobs'].$resume_basic['specialty'];\t\t\t\t$setsqlarr['key']=\"{$resume_basic['fullname']} \".$sp->extracttag($setsqlarr['key']);\t\t$setsqlarr['key']=str_replace(\",\",\" \",$resume_basic['intention_jobs']).\" {$setsqlarr['key']} {$resume_basic['education_cn']}\";\t\t$setsqlarr['key']=$sp->pad($setsqlarr['key']);\t\t\tif (!empty($resume_education))\t\t{\t\t\tforeach($resume_education as $li)\t\t\t{\t\t\t$setsqlarr['key']=\"{$li['school']} {$setsqlarr['key']} {$li['speciality']}\";\t\t\t}\t\t}\t\t$setsqlarr['refreshtime']=$timestamp;\t}\tupdatetable(table('resume'),$setsqlarr,\"uid='{$uid}' AND id='{$pid}'\");\tupdatetable(table('resume_tmp'),$setsqlarr,\"uid='{$uid}' AND id='{$pid}'\");\n然后把出库来的给一数组 然后带入到了update中。造成了注入。 而且这个update 可以控制的点是在set位置的所以可以是我们想update这table里面的什么就update什么。\n\n\n\n报错了 稍微构造一下。这里我们把address updata成要出的数据\n\n\n\n成功了对关键字的过滤出数据。测试了一下demo 也成功\n\nhttp://demo.74cms.com/resume/resume-show-6271.htm   漏洞证明：  见上面。   修复方案：  真的应该好好的修改代码 而不是光修改过滤函数。 对于这种二次注入 由于入库的时候只会调用一次stripcslashes74cms做了全局转义的 如果再转义一次 那么就算入库也会含有转义符了。 自然出库也有了。或者就是在出库之后再addslashes一次 都行。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-16 15:41 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-13 14:25 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  刚下的74.。。放下74 让我来    \n     2014-07-13 14:30 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @roker  黑客 你来吧。 我马上上学去了。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}