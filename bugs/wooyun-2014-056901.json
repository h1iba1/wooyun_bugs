{"id": 56676, "wybug_id": "wooyun-2014-056901", "wybug_title": "Doyo 建站系统无需登录 Sql 注入漏洞#2", "wybug_corp": "wdoyo.com", "wybug_author": "′雨。", "wybug_date": "2014-04-13 12:33", "wybug_open_date": "2014-07-09 12:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-18：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-09：\t细节向公众公开  简要描述： 过滤不严无需登录会员。 详细说明：  \nfunction GetIP(){ \tif (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\")) \t$ip = getenv(\"HTTP_CLIENT_IP\"); \telse if (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\")) \t$ip = getenv(\"HTTP_X_FORWARDED_FOR\"); \telse if (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\")) \t$ip = getenv(\"REMOTE_ADDR\"); \telse if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\")) \t$ip = $_SERVER['REMOTE_ADDR']; \telse \t$ip = \"unknown\"; \treturn($ip); }\n这里 一个很古老的漏洞 XFF 未过滤。  在message.php中\nfunction add(){\t\t//if($GLOBALS['G_DY']['vercode']==1){\t\t//if(!$this->syArgs(\"vercode\",1)||md5(strtolower($this->syArgs(\"vercode\",1)))!=$_SESSION['doyo_verify'])message(\"验证码错误\");\t\t//}\t\tif(!$this->syArgs('tid'))message(\"请选择栏目\");\t\t$tid=$this->syArgs('tid');\t\t$this->type=syDB('classtype')->find(array('tid'=>$tid),null,'molds,classname,msubmit');\t\tif($this->type['msubmit']!=1){\t\t\t$this->member->p_r($this->type['msubmit']);\t\t}\t\t$isshow = ($this->my['group']['audit']==1) ? 1 : 0;\t\t$user = ($this->my['id']!=0) ? $this->my['user'] : '游客';\t\t$fmolds = ($this->syArgs('fmolds',1)!='') ? $this->syArgs('fmolds',1) : '';\t\t$title = ($this->syArgs('title',1)!='') ? $this->syArgs('title',1) : $this->type['classname'];\t\t$body = ($this->syArgs('body',1)!='') ? $this->syArgs('body',1) : '';\t\t$row1 = array('tid' => $tid,'fmolds' => $fmolds,'faid' => $this->syArgs('faid'),'title' => $title,'addtime' => time(),'orders' => 0,'isshow' => $isshow,'user' => $user,'body' => $body,'reply'=>'');\t\t$row2=$this->fields_args('message',$tid);\t\t$add = syClass('c_message');$newv=$add->syVerifier($row1);\t\tif(false == $newv){\t\t\t$a=$add->create($row1);$row2=array_merge($row2,array('aid' => $a));\t\t\tsyDB('message_field')->create($row2);\t\t\tif($this->my['id']!=0){\t\t\t\tsyDB('member_file')->update(array('hand'=>$this->syArgs('hand'),'uid'=>$this->my['id']),array('hand'=>0,'aid'=>$a,'molds' => 'message'));\t\t\t}else{\t\t\t\tsyDB('member_file')->update(array('hand'=>$this->syArgs('hand'),'ip'=>GetIP()),array('hand'=>0,'aid'=>$a,'molds' => 'message'));\t\t\t}\n这里调用了这个函数。\n$this->type=syDB('classtype')->find(array('tid'=>$tid),null,'molds,classname,msubmit');\t\tif($this->type['msubmit']!=1){\t\t\t$this->member->p_r($this->type['msubmit']);\t\t}\n在这里验证了是否有发布的权限。  默认的 tid 8 23 11都有发布权限。\nif($this->my['id']!=0){\t\t\t\tsyDB('member_file')->update(array('hand'=>$this->syArgs('hand'),'uid'=>$this->my['id']),array('hand'=>0,'aid'=>$a,'molds' => 'message'));\t\t\t}else{\t\t\t\tsyDB('member_file')->update(array('hand'=>$this->syArgs('hand'),'ip'=>GetIP()),array('hand'=>0,'aid'=>$a,'molds' => 'message'));\t\t\t}\n然后在这里 判断了是否登录。  如果登录的话进入的那里是没有调用getip的而没登录的话 就调用了。所以这里我们不要登录。   漏洞证明：  \n\n注入成功 有图真真相。   修复方案：  过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-09 12:34 厂商回复：  最新状态： 2014-04-18：正在修复  ", "replys": "漏洞评价：\n评论\n     2014-04-18 13:02 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:188        | Only Code Never Lie To Me.)\t\t \n  唉  这种厂商。  全部忽略  呵呵。    \n     2014-08-01 18:37 |    \t\tj2ck3r \t\t\t( 普通白帽子  |\t\t\t        Rank:406 漏洞数:90        | 别关注我，跟你不熟。)\t\t \n  @′  雨。 利用方法是什么 发出来啊    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}