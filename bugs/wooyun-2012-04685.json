{"id": 20773, "wybug_id": "wooyun-2012-04685", "wybug_title": "用友ICC网站客服系统远程代码执行漏洞", "wybug_corp": "用友软件", "wybug_author": "only_guest", "wybug_date": "2012-02-26 19:45", "wybug_open_date": "2012-04-11 19:45", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-02-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-02-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-03-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2012-04-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-05-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-05-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-04-11：\t细节向公众公开  简要描述： 全部采用用友ICC客服系统,上线前没有做严格测试!导致漏洞产生!全部可以获得管理权限!网络游戏盛大网络光通娱乐在线销售麦考林母婴之家教育威迅教育中锐留学汽车广州本田永达汽车物流顺丰速运申通快递保险太平洋保险PICC中国人保软件/互联网金山软件 政府上海公共研发平台 金融中国银联环迅电子商务有限公司IFX大成基金东亚银行运营商中国电信中国联通安徽电信西藏电信行业资讯平台泡泡网中国汽车网中国塑料网网易163零售卖场苏宁电器 详细说明：  以下网站客服系统全部采用用友ICC客服系统网络游戏盛大网络光通娱乐在线销售麦考林母婴之家教育威迅教育中锐留学汽车广州本田永达汽车物流顺丰速运申通快递保险太平洋保险PICC中国人保软件/互联网金山软件 政府上海公共研发平台 金融中国银联环迅电子商务有限公司IFX大成基金东亚银行运营商中国电信中国联通安徽电信西藏电信行业资讯平台泡泡网中国汽车网中国塑料网网易163零售卖场苏宁电器小米科技该程序的/home/ecccs/web/5107/upload/uploadFlash.php文件存在严重的逻辑错误!导致漏洞产生!以上大型网站的客服系统全部可以通过此漏洞获取管理权限!\n<?php/** * uploadFlash.php * Flash文件上传. */require_once('../global.inc.php');//operateId=1 上传,operateId=2 获取地址.$operateId\t= intval($_REQUEST['operateId']);if(empty($operateId)) exit;if($operateId == 1){\t$date = date(\"Ymd\");\t$dest = $CONFIG->basePath.\"data/files/\".$date.\"/\";\t$COMMON->createDir($dest);\t//if (!is_dir($dest))\tmkdir($dest, 0777);\t\t$nameExt = strtolower($COMMON->getFileExtName($_FILES['Filedata']['name']));\t\t$allowedType = array('jpg', 'gif', 'bmp', 'png', 'jpeg');\t\tif(!in_array($nameExt, $allowedType)){\t\t$msg = 0;\t}\tif(empty($msg)){\t\t$filename = getmicrotime().'.'.$nameExt;\t\t$file_url = urlencode($CONFIG->baseUrl.'data/files/'.$date.\"/\".$filename);\t\t\t\t$filename = $dest.$filename;\t\tif(empty($_FILES['Filedata']['error'])){\t\t\tmove_uploaded_file($_FILES['Filedata']['tmp_name'],$filename);\t\t}\t\t\t\tif (file_exists($filename)){\t\t\t//$msg = 1;\t\t\t$msg = $file_url;\t\t\t@chmod($filename, 0444);\t\t}else{\t\t\t$msg = 0;\t\t}\t}\t$outMsg = \"fileUrl=\".$msg;\t$_SESSION[\"eoutmsg\"] = $outMsg;\texit;}else if($operateId == 2){\t$outMsg = $_SESSION[\"eoutmsg\"];\tif(!empty($outMsg)){\t\tsession_unregister(\"eoutmsg\");\t\techo '&'.$outMsg;\t\texit;\t}else{\t\techo \"&fileUrl=0\";\t\texit;\t}}function getmicrotime(){     list($usec, $sec) = explode(\" \",microtime());     return ((float)$usec + (float)$sec); }?>\n   漏洞证明：  随便例举几个存在的\n\nhttps://95516.unionpay.com/5107/upload/uploadFlash.php   银联http://icc.xunlei.com/5107/upload/uploadFlash.php        迅雷http://app6.cpic.com.cn/5107/upload/uploadFlash.php      太平洋保险http://im.e-picc.com.cn/5107/upload/uploadFlash.php      人寿保险http://icc.hnair.com/5107/upload/uploadFlash.php         海南航空http://icc.icafe8.com/5107/upload/uploadFlash.php        网维大师http://online.haier.com/5107/upload/uploadFlash.php      海尔电器http://imv3.duba.net/5107/upload/uploadFlash.php         金山毒霸http://ncc2.sdrs.sdo.com/5107/upload/uploadFlash.php     盛大在线http://csol.dcfund.com.cn/5107/upload/uploadFlash.php    大成基金http://service.srcb.com/5107/upload/uploadFlash.php      上海农商银行   修复方案：  速度联系用友升级吧.这套系统里不是只有这么一个问题.我记得还有一个.临时找不到了.你们自己挖吧.   版权声明：转载请注明来源 only_guest@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2012-02-27 18:30 厂商回复： 惭愧，这段代码逻辑错误真的伤不起啊，目前已确认存在此问题，会立即修复此问题，尽快对所有受此影响用户进行安全更新.对only_guest的专业素养和品德致以万分敬意，感谢only_guest对ICC产品安全性提升的巨大帮助，也感谢wooyun提供了这样一个沟通安全研究人员和厂商的平台。 最新状态： 2012-03-05：目前受此漏洞已修复，受影响的客户均已修复，自行维护管理的用户我们已于2012-03-02日前通知所有用户修复，感谢所有关注用友ICC安全的研究者。我们会虚心接受关于产品改进的任何意见与建议，努力做出最好的产品。 2012-05-14：最近爆出的文件上传问题都是旧有版本（4.1.0.0之前版本）存在的问题，自2009年以后的ICC新版本（4.1.0.0版本及后续版本）前端已全部迁移至JAVA中间件平台，并全部重写了前端web相关模块，文件上传采取了全新的实现方式，着重提升了系统安全性。由于部分版本定制导致新旧版本升级兼容性问题和业务问题使得部分用户未能升级到新版本，部分旧版本的安全性问题未能及时发现和修复，感谢piaoye@乌云对我们产品安全提升的关注。我们始终关注并尊重所有安全研究者对ICC产品的安全性提升的意见和建议，并承诺不掩盖任何已知问题，任何新旧版本存在的问题，我们都会认真修正，及时修复所有受影响的系统，再次对piaoye@乌云,only_guest@乌云,Jannock@乌云各位安全研究者对我们ICC产品安全提升的关注和巨大帮助。  ", "replys": "漏洞评价：\n评论\n     2012-02-26 20:43 |    \t\tpopok \t\t\t( 普通白帽子  |\t\t\t        Rank:117 漏洞数:24        | nothing)\t\t \n  关注    \n     2012-02-27 18:50 |    \t\tlivers \t\t\t( 实习白帽子  |\t\t\t        Rank:94 漏洞数:6        | mov esp,0jmp espcrash.....)\t\t \n  咳咳report.jsp     \n     2012-02-28 01:39 |    \t\tpopok \t\t\t( 普通白帽子  |\t\t\t        Rank:117 漏洞数:24        | nothing)\t\t \n  厂商很诚恳，赞！不像某讯~~    \n     2012-02-28 09:35 |    \t\t网路游侠 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:2        | 不玩渗透好多年……)\t\t \n  厂商回复很快啊。    \n     2012-02-28 14:17 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  这个要爆一下RANK，给200，跟冠希叔的艳照有的一拼    \n     2012-02-28 14:50 |    \t\ticefish \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:8        | 欢迎大家和我用邮件进行交流~)\t\t \n  厂商态度很好，很不错    \n     2012-02-28 16:48 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  漏洞影响面太广了.难为了用友敢来认领.    \n     2012-02-28 16:51 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @only_guest 嗯，所以说杀伤力犹如艳照门    \n     2012-03-06 10:32 |    \t\t凤凰 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:6        | 涅磐)\t\t \n  用友的态度的很好啊！期待详情，至少可以作为案例用，嘿嘿    \n     2012-03-29 13:26 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  0day.jgp.php ~    \n     2012-04-11 22:12 |    \t\ther0ma \t\t\t( 核心白帽子 |\t\t\t        Rank:598 漏洞数:84        | 专注小厂商三十年！)\t\t \n  厂商好厂商，白帽好白帽 呱唧呱唧……    \n     2012-04-11 22:19 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  啥？    \n     2012-04-11 22:23 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  有点意思，苦逼代码在于 $nameExt = strtolower($COMMON->getFileExtName($_FILES['Filedata']['name']));\t\t$allowedType = array('jpg', 'gif', 'bmp', 'png', 'jpeg');\t\tif(!in_array($nameExt, $allowedType)){\t\t$msg = 0;\t}\tif(empty($msg)){    \n     2012-04-11 22:43 |    \t\tLee \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:24        | wataru@eviloctal.com)\t\t \n  require_once('../global.inc.php');怎么写的？不用验证session就可以上传吗？那不是又多了一个问题    \n     2012-04-11 22:53 |    \t\tB1n4ry \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:6        )\t\t \n  屌爆了！~~ 看来楼主的裤衩不少啊··· 都是大货··    \n     2012-04-12 00:30 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @xsser ，一个!，一个empty...这段代码如果给我修，我还真不知道怎么理解这个神逻辑...    \n     2012-04-12 00:33 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @B1n4ry 我赌洞主是黑盒出来的    \n     2012-04-12 07:54 |    \t\tB1n4ry \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:6        )\t\t \n  @xsser 我也认为是黑盒出来的，楼主可能当时在搞某XXOO，然后偶遇一上传，再然后就有了此文…… 哈哈··  都是我YY的。切莫当真……    \n     2012-04-12 09:29 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  这个。。    \n     2012-04-12 09:47 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @xsser 其实都是某下载工具给我的灵感.你们懂的,不懂去看我提交过的漏洞    \n     2012-04-12 12:31 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @xsser 能详细说下么,楼主上传文件是什么格式的1.jpg.php? 1.php%00jpg?    \n     2012-04-12 12:35 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @_Evil 仔细看下代码，是直接传的    \n     2012-04-12 13:17 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @_Evil 代码有个很2的错误..仔细看    \n     2012-04-12 13:25 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  我太粗心了 0 1 都一样。 -_-# 肾斗士我太菜了。    \n     2012-04-12 15:23 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  @only_guest 弱弱问下一lz，这个需要验证么？谢谢    \n     2012-04-12 20:56 |    \t\tsaga \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 世界上只有10种人，懂二进制的，和不懂二进...)\t\t \n  强大的楼主，求库    \n     2012-04-12 21:03 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @saga 这叫洞主    \n     2012-04-12 21:08 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @possible 啥验证?上传?代码没看明白?    \n     2012-04-12 22:35 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  @only_guest 我想问的是，是否需要登录后台才使用上传功能？还是无需验证，直接访问就可以上传？这个对我很重要...谢谢lz，同时膜拜一下大神    \n     2012-04-13 16:34 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @possible 直接传.    \n     2012-04-13 17:58 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  @only_guest 谢谢 呵呵    \n     2012-05-14 21:53 |    \t\t葉孒 \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:5        | 呵呵)\t\t \n  任意文件，你赢了。    \n     2012-07-21 23:39 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  好吧，不得不说，连看了好几篇文章了，太强了……就像某淫说的，SQL注入越来越少了，低级的逻辑错误越来越多了。    \n     2014-05-15 10:33 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}