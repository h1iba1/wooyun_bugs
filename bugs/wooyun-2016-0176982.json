{"id": 74168, "wybug_id": "wooyun-2016-0176982", "wybug_title": "jact大汉网上互动管理平台 前台getshell", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "铁爪小飞龙", "wybug_date": "2016-02-19 14:45", "wybug_open_date": "2016-02-19 15:28", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传漏洞", "文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-19：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： jact系统为南京大汉网络有限公司开发的一套面向政府机关的网上互动管理平台。该平台在政府部门得到广泛的应用 详细说明：  jact系统为南京大汉网络有限公司开发的一套面向政府机关的网上互动管理平台。该平台在政府部门得到广泛的应用jact前台写信功能，任意文件上传导致getshell漏洞URL：http://www.anxiang.gov.cn/jact/front/front_mailwrite.action在上传附件部分，存在任意文件上传该功能，仅在前端做了文件名校验\nfunction isattach(file,ImageFileExtend,isAlert){\t//if(ImageFileExtend==null || ImageFileExtend.length<2)//未设置类型，验证常见类型\t\t//ImageFileExtend = \".doc,.txt,.rar,.jpg,.gif,.bmp,.xls\"; \t\tvar  alertMsg = ImageFileExtend;\t\tImageFileExtend = (\",\"+ImageFileExtend+\",\").replace(/,/g, \"|\");\t if(file.value.length>0){\t\t var fileExtend=file.value.substring(file.value.lastIndexOf('.')).toLowerCase();        \t\t if(ImageFileExtend.indexOf(\"|\"+fileExtend+\"|\") != -1){   \t\t\t return true;\t\t }else{\t\t\t if(isAlert){\t\t\t\t alert(\"附件格式错误，请上传\" + alertMsg + \"格式的附件\");\t\t\t }\t\t\treturn false;\t\t }    \t } \t return true;}\n前端校验可以轻松绕过下面来看服务端代码\npublic String processFiles()  {    try    {      try      {        if ((this.filesCheck != null) &&           (this.filesCheck.length() > 1))        {          for (File file : this.files) {            if (file != null)            {              if (file.length() > Config.getSysConfig()                .getAttachsize().intValue() * 1024 * 1024) {                throw new ComplatException(\"请上传\" +                   Config.getSysConfig().getAttachsize() +                   \" M以内的附件\");              }            }          }          this.filesCheck += \",\";        }      } catch (ComplatException e) {        showHtml(          \"<script language=\\\"javascript\\\">alert('\" +           e.getMessage() + \"');history.back();\" +           \"</script>\");        。。。。。               for (String fileName : this.fileNames) {              if (arrtmark.equals(fileName)) {                String filePath = null;                String name = null;                if ((this.filesCheck != null) &&                   (this.filesCheck.indexOf(\",\" + m + \",\") != -1)) {                  Random random = new Random();                  name = this.filesFileName[n];                  filePath = \"/main/jact/commonuser/transact/temp/\" +                     DateFormat.getStrCurrentDate(\"yyyyMMddHHmmss\") + (                    999 - random.nextInt(899)) + (                    (name != null) && (name.lastIndexOf(\".\") != -1) ?                     name.substring(name.lastIndexOf(\".\")) : \"\");                  File f = new File(BaseInfo.getAppPath() + filePath);                  FileUtil.copyFile(this.files[n], f, false);                  n++;              。。。。。    return \"success\";  }\n由以上代码可以得到1、未校验后缀名2、重命名规则为yyyyMMddHHmmss+(100-999之间的随机数)所以导致一下两个问题：1.任意文件上传2.重命名后的文件名可以猜解由此可知，此处可getshell   漏洞证明：  发信页面\n\n数据包：\n\n发送完成后，会切换到提示页面，而页面中的保存在本地功能，可以为我们提供较为接近的时间信息\n\n然后我们看看上传到服务器后的文件名：\n\n然后根据以上信息，遍历已猜解文件名\n\n访问shell：\n\n   修复方案：  服务端校验文件后缀名重命名规则应该更随机化   版权声明：转载请注明来源 铁爪小飞龙@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-02-19 15:28 厂商回复： 此问题800年前就解决了另，安乡不是我们的客户 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}