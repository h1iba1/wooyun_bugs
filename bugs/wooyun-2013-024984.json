{"id": 10141, "wybug_id": "wooyun-2013-024984", "wybug_title": "PHPCMS最新版(V9)SQL注入一枚", "wybug_corp": "phpcms", "wybug_author": "blue", "wybug_date": "2013-06-02 04:46", "wybug_open_date": "2013-08-31 04:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-06-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-07-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-08-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-08-31：\t细节向公众公开  简要描述： 比较有意思的一个SQL注入点，代码分析是个体力活，唿～ 详细说明：  存在于在线充值功能，直接上代码分析，建议先看漏洞证明：\n/phpcms/phpcms/modules/pay/deposit.php 96行起的pay_recharge方法...$trade_sn\t= param::get_cookie('trade_sn'); //约110行位置，如果可以控制$trade_sn，即可注入，事实自然是可以的\t\t\t$usernote = $_POST['info']['usernote'] ? $_POST['info']['name'].'['.$trade_sn.']'.'-'.new_html_special_chars(trim($_POST['info']['usernote'])) : $_POST['info']['name'].'['.$trade_sn.']';\t\t\t\t\t\t$surplus = array(\t\t\t\t\t'userid'      => $this->_userid,\t\t\t\t\t'username'    => $this->_username,\t\t\t\t\t'money'       => trim(floatval($_POST['info']['price'])),\t\t\t\t\t'quantity'    => $_POST['quantity'] ? trim(intval($_POST['quantity'])) : 1,\t\t\t\t\t'telephone'   => preg_match('/[0-9\\-]+/', $_POST['info']['telephone']) ? trim($_POST['info']['telephone']) : '',\t\t\t\t\t'contactname' => $_POST['info']['name'] ? trim($_POST['info']['name']).L('recharge') : $this->_username.L('recharge'),\t\t\t\t\t'email'       => is_email($_POST['info']['email']) ? trim($_POST['info']['email']) : '',\t\t\t\t\t'addtime'\t  => SYS_TIME,\t\t\t\t\t'ip'\t\t  => ip(),\t\t\t\t\t'pay_type'\t  => 'recharge',\t\t\t\t\t'pay_id'      => $payment['pay_id'],\t\t\t\t\t\t\t'payment'     => trim($payment['pay_name']),\t\t\t\t\t'ispay'\t\t  => '1',\t\t\t\t\t'usernote'    => $usernote,\t\t\t\t\t'trade_sn'\t  => $trade_sn,\t\t\t);\t\t\t$recordid = $this->handle->set_record($surplus); //直到这里，也没有对$trade_sn进行处理吧？接下来看set_record方法/phpcms/phpcms/modules/pay/classes/pay_deposit.class.php 12行起\t/**\t * 生成流水记录\t * @param unknown_type \t */\tpublic function set_record($data){\t\t$require_items = array('userid','username','email','contactname','telephone','trade_sn','money','quantity','addtime','paytime','usernote','usernote','pay_type','pay_id','payment','ip','status');\t\tif(is_array($data)) {\t\t\tforeach($data as $key=>$item) {\t\t\t\tif(in_array($key,$require_items)) $info[$key] = $item;\t\t\t}\t\t\t\t\t} else {\t\t\treturn false;\t\t}\t\t$trade_exist = $this->account_db->get_one(array('trade_sn'=>$info['trade_sn']));  //这里\t\tif($trade_exist) return $trade_exist['id'];\t\t$this->account_db->insert($info); //还有这里\t\treturn $this->account_db->insert_id();\t}\n好了，关键是控制$trade_sn的值，看param::get_cookie和param::set_cookie方法\n/phpcms/phpcms/libs/classes/param.class.php\tpublic static function set_cookie($var, $value = '', $time = 0) {\t\t$time = $time > 0 ? $time : ($value == '' ? SYS_TIME - 3600 : 0);\t\t$s = $_SERVER['SERVER_PORT'] == '443' ? 1 : 0;\t\t$var = pc_base::load_config('system','cookie_pre').$var;\t\t$_COOKIE[$var] = $value;\t\tif (is_array($value)) {\t\t\tforeach($value as $k=>$v) {\t\t\t\tsetcookie($var.'['.$k.']', sys_auth($v, 'ENCODE'), $time, pc_base::load_config('system','cookie_path'), pc_base::load_config('system','cookie_domain'), $s);\t\t\t}\t\t} else {\t\t\tsetcookie($var, sys_auth($value, 'ENCODE'), $time, pc_base::load_config('system','cookie_path'), pc_base::load_config('system','cookie_domain'), $s);  //cookie加密了，而且方法很给力,sys_auth是有auth_key的，基本上可以说破解这个值不容易\t\t}\t}......\tpublic static function get_cookie($var, $default = '') {\t\t$var = pc_base::load_config('system','cookie_pre').$var;\t\treturn isset($_COOKIE[$var]) ? sys_auth($_COOKIE[$var], 'DECODE') : $default; //这里是解密方法，咱也用不上\t}\n\n\n看来想自己更改cookie值很难，不知道加密的auth_key值嘛，可是...如果利用一个能set_cookie($value)的点，并且咱们能控制$value呐？这个点自然是有的～\n/phpcms/phpcms/modules/attachment/attachments.php 228行起\tpublic function swfupload_json() {\t\t$arr['aid'] = intval($_GET['aid']);  //这个不行,intval了\t\t$arr['src'] = trim($_GET['src']); //这个可以,虽然$_GET会addslashes，但下面的json_encode会帮上忙（此时' => \\'，这里是一个反斜线 ）\t\t$arr['filename'] = urlencode($_GET['filename']); //这个不行,urlencode了\t\t$json_str = json_encode($arr); (此时 \\' => \\\\' 这里是两个反斜线)所以单引号可以用了\t\t$att_arr_exist = param::get_cookie('att_json');\t\t$att_arr_exist_tmp = explode('||', $att_arr_exist);\t\tif(is_array($att_arr_exist_tmp) && in_array($json_str, $att_arr_exist_tmp)) {\t\t\treturn true;\t\t} else {\t\t\t$json_str = $att_arr_exist ? $att_arr_exist.'||'.$json_str : $json_str;\t\t\tparam::set_cookie('att_json',$json_str); //这里\t\t\treturn true;\t\t\t\t\t}\t}\n   漏洞证明：  1.在COOKIE att_json为空时（当然可以手动清空），访问以下链接生成att_jsonhttp://localhost/test/phpcms/index.php?m=attachment&c=attachments&a=swfupload_json&src=1%27&filename=a%27 （当然，你可以干点别的）2.提交在线充值时，更改COOKIE trade_sn为att_json的值\n\n\n\n   修复方案：  对$trade_sn进行addslashes    版权声明：转载请注明来源 blue@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-06-03 16:52 厂商回复： 感谢反馈！ 最新状态： 2013-06-03：@blue请提供下联系方式，或者联系我们网站在线客服！我们确认身份后，赠送您精美礼品！  ", "replys": "漏洞评价：\n评论\n     2013-06-02 06:08 |    \t\tsmallworm \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:4        | ...)\t\t \n  前排学些    \n     2013-06-02 08:22 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  5点还在挖。。精神可嘉啊！    \n     2013-06-02 08:45 |    \t\t猪刚鬣 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | 哈哈)\t\t \n  前排    \n     2013-06-02 08:58 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  这个马克下    \n     2013-06-02 09:04 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  @齐迹 周末8点起床的程序员，同样精神可嘉～    \n     2013-06-02 09:16 |    \t\t江苏卫视(乌云厂商)\t\t \n  5点还在挖。。精神可嘉啊！    \n     2013-06-02 09:24 |    \t\tVigoss_Z \t\t\t( 普通白帽子  |\t\t\t        Rank:404 漏洞数:63        | 楞娃)\t\t \n  @江苏卫视 你号被社工了？    \n     2013-06-02 09:25 |    \t\t江苏卫视(乌云厂商)\t\t \n  @Vigoss_Z 此话怎讲    \n     2013-06-02 09:43 |    \t\t江苏卫视(乌云厂商)\t\t \n  @Vigoss_Z 刚刚下载了个burp，测试了一下爆破模块，爆破了一下发送礼物的，结果就一发不可收拾了。。。。:(    \n     2013-06-02 10:02 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  @江苏卫视 擦，很好玩么？    \n     2013-06-02 10:03 |    \t\t江苏卫视(乌云厂商)\t\t \n  @se55i0n 嗯    \n     2013-06-02 10:04 |    \t\tVigoss_Z \t\t\t( 普通白帽子  |\t\t\t        Rank:404 漏洞数:63        | 楞娃)\t\t \n  @江苏卫视 。。。好吧    \n     2013-06-02 11:03 |    \t\txch4er \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        | 小弟才疏学浅,前来悉心与各位大牛研究探索.)\t\t \n  坐等更新啊。    \n     2013-06-02 11:12 |    \t\tDamo \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:31        | 我只是喜欢看加菲猫而已ส็็็็็็็็...)\t\t \n  mark    \n     2013-06-02 11:45 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @江苏卫视 自重    \n     2013-06-02 12:21 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @xsser 自重    \n     2013-06-02 21:37 |    \t\t0xTback \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 初入江湖，请多多关照~！！！)\t\t \n  围观~！！！    \n     2013-06-02 23:05 |    \t\tdo9gy \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:15        | Dog loves God。)\t\t \n  @江苏卫视。。我说我这边江苏卫视的洞还没通过，怎么就给我发礼物，激动了一天了    \n     2013-06-03 09:19 |    \t\ther0ma \t\t\t( 核心白帽子 |\t\t\t        Rank:598 漏洞数:84        | 专注小厂商三十年！)\t\t \n  @江苏卫视 是求关注呢，各位白帽子为了礼物，大家都懂的该怎么做. ^_^!    \n     2013-06-03 17:26 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @江苏卫视 干坏事的厂商，一般在大年三十晚上会收到好多好多漏洞的。我不会告诉你说法定假日前一天晚上也有这样的福利的。：）    \n     2013-06-03 17:37 |    \t\tPasser_by \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:21        | 问题真实存在但是影响不大（腾讯微博Passer...)\t\t \n  @疯子 自重    \n     2013-06-03 19:02 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  最新状态：2013-06-03：@blue 请提供下联系方式，或者联系我们网站在线客服！ 我们确认身份后，赠送您精美礼品！  @phpcms 直接通过乌云走呗~    \n     2013-06-21 17:18 |    \t\tL.X \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 分享和谐)\t\t \n  能够update不~~~~~~~    \n     2013-07-04 16:58 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  我家院子里种了很多草，专门吸引大牛来吃草，吃完了就可以挤奶了。    \n     2013-07-13 17:34 |    \t\t神倦懒言 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 从事php开发以及服务器的运维工作，还是菜...)\t\t \n  思路真心不错  真心详细感谢！    \n     2013-08-31 13:59 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  怎么想到的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}