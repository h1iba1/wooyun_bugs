{"id": 21438, "wybug_id": "wooyun-2011-03701", "wybug_title": "某公司员工卡金额校验算法破解", "wybug_corp": "某奇怪公司", "wybug_author": "insight-labs", "wybug_date": "2011-12-21 21:55", "wybug_open_date": "2012-02-04 21:55", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["盲目信任用户数据", "加密算法设计错误", "安全", "硬件安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-12-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2011-12-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2011-12-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-01-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-01-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-02-04：\t细节向公众公开  简要描述： 某公司的员工卡使用了RFID技术，其为Mifare Classic 1k卡，有2种功能：1是门禁系统，2是消费系统，可谓一卡走遍某公司大厦。但其消费系统的实现存在缺陷，导致可以任意构造消费数据进行非法消费。 详细说明：  首先来看一个某公司员工卡的数据，如下图：\n\n观察发现只有第五扇区有数据，其他扇区均为空，那么我们只分析此扇区的4个block的数据结构就可以了。首先我借来同事的员工卡，分别进行对比分析，想先确定出来哪些部分是常量，哪些部分是变量。\n\n上图为A,B,C,D,E 五个员工卡的第五扇区数据，首先，蓝色矩阵框所在的block是Access Control Block，而蓝色矩阵框就是Key A，后面的FF 07 80 69是访问控制位，Key B为默认的全FF。注意这里所有的卡的Key都是相同且永远不变的。然后看红色矩阵框，这里也是每个员工卡都相同的值，且永远不变。再看绿色矩阵框，这里按入职的顺序排列，可以认为是发卡顺序，每个员工卡都是唯一的值，且永远不变。这样block 16（图中00000100h)和block 19（图中00000130h）就分析完了，都是常量，剩余的block 17和block 18都是变量，每次刷卡其中的值都是不断变化的，请看下图：\n\n经过观察分析发现，block 17和block 18每次刷卡后数据都会对调。红色矩阵框是余额，比如第一次刷卡前余额为5.60元，对应60 05 00刷卡后为4.50元对应50 40 00，第二次刷卡前余额为4.50元，对应50 04 00，刷卡后为3.50元，对应50 03 00，之后两个block数据对调。这里的50代表五角零分，03代表零十三元，00代表零千零百元。绿色矩阵框是消费日期，这里第一次数据中block 17里是11月07日，是上次消费的日期，本次是11月10日。蓝色矩阵框是当日消费总额，每天清空一次。比如第一次的数据block 17是09 00，说明在11月7日此卡总共消费了9元，然后11月10日这天，第一次消费了1.10元，第二次消费了1.00元，所以1.10 + 1.00 = 2.10，依次类推。粉色矩阵框是消费的时间，14 09即是下午14点09分。最后是黄色矩阵框，这里是校验位，分析发现其算法很简单，是当前余额的数字之和与FF异或的结果，比如第一次刷卡的数据中block 18是ab，余额是50 04 00，这里50+04+00=54，然后54 xor FF = ab至此某公司员工通消费系统算法完全被攻破。    漏洞证明：  我们可以由算法推算一下数据，假如今天11月11日 ，15:00分充值50元 数据将为 block 18:  ff 00 00 00 11 10 00 05 60 00 14 27 00 00 00 00 block 17:  fa 00 50 00 11 11 00 00 00 00 15 00 00 00 00 00   修复方案：  修改为复杂算法，或一次一密，即每次刷卡Key的值都在变化。   版权声明：转载请注明来源 insight-labs@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2011-12-21 21:59 厂商回复： 多谢！猜测这个会一样影响到很多其他的公司 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2011-12-22 08:06 |    \t\tpiaoye \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:53        | ww)\t\t \n  RFID是个方向，抽空得学习下了，不然连门都进不去何谈安全啊！    \n     2011-12-22 15:43 |    \t\tAnthr@X \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | Where there's a will,there's a way.)\t\t \n  来顶了    \n     2011-12-22 19:12 |    \t\ts!lly3r \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:2        )\t\t \n  嘿    \n     2011-12-22 19:16 |    \t\tyangff \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 介绍写什么呢？)\t\t \n  某家奇怪的公司准备攻略别的公司么=v=    \n     2011-12-23 00:28 |    \t\tzhuowater \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:2        | 程序员一枚，求妹子一枚)\t\t \n  小心坠入魔道    \n     2011-12-23 12:23 |    \t\tKevin2600 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:4        | There is no fate, but what we make ...)\t\t \n  嘿嘿...我也知道某个做电信设备的大公司...他们的门禁卡有问题...不是M1 哦!    \n     2012-01-20 23:47 |    \t\t梦想肥羊 \t\t\t( 实习白帽子  |\t\t\t        Rank:89 漏洞数:18        | 博客：dnswalk.blog.163.com)\t\t \n  oh~神贴~     \n     2012-02-04 03:32 |    \t\t孤独浪子 \t\t\t( 实习白帽子  |\t\t\t        Rank:36 漏洞数:10        | hack30@qq.com)\t\t \n  上海电信公司某童鞋已经邪恶了下    \n     2012-02-04 23:10 |    \t\t歌颂 \t\t\t( 实习白帽子  |\t\t\t        Rank:36 漏洞数:5        | #1024)\t\t \n  膜拜    \n     2012-02-05 00:57 |    \t\ttnt1200 \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 关注飞机安全....)\t\t \n  呵呵，学习了！    \n     2012-02-05 02:47 |    \t\tBlackeagle \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 向WooYun致敬)\t\t \n  厂商的意思是。。你们懂的~    \n     2012-02-05 03:44 |    \t\t木木 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:4        | 扯淡的人生。)\t\t \n  有时间测试我们单位。    \n     2012-02-06 11:47 |    \t\tAの碎碎念 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:4        | 腐宅求妹子~)\t\t \n  哈哈，这个碉堡了~    \n     2012-02-08 09:01 |    \t\t路人乙 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:29        | 中国移动不厚道，说给礼品也不给！)\t\t \n  uid都可以改写了。呵呵。    \n     2012-02-08 15:01 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  玩归玩 不要真触犯法律啊 ～    \n     2012-02-08 15:05 |    \t\tX-Secure \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 扭啊扭啊扭~~~)\t\t \n  厂商的意思……我懂的……    \n     2012-04-03 01:23 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  学习了。    \n     2012-04-04 12:35 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  外部关联：（1）《从乌云的错误漏洞分析看Mifare Classic安全》：http://radiowar.org/?p=184 （2）@RadioWar 对此文的补充解释：http://t.qq.com/p/t/55235042671410    \n     2012-04-04 16:40 |    \t\tliyang \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:11        | 低调 沉默 守望)\t\t \n  http://radiowar.org/?p=184我是小白，只是通知一下。    \n     2012-04-04 17:08 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  把东西讲简单，而不是讲复杂，多么幼稚的技术注重分享而不是炫耀攀比，我顶insight-labs，第一个分享这方面详细过程的人    \n     2012-04-16 12:33 |    \t\t墨水心_Len \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:15        | PKAV技术宅 | 每一个有文化的东西，我们都...)\t\t \n  既简单又生动。    \n     2012-06-27 00:17 |    \t\t北洋贱队 \t\t\t( 普通白帽子  |\t\t\t        Rank:252 漏洞数:25        )\t\t \n  最近购买了设备  正在研究    \n     2012-06-27 10:04 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @北洋贱队 设备贵么？我想买个磁条的；这个卡常见一点~    \n     2012-06-27 15:13 |    \t\t北洋贱队 \t\t\t( 普通白帽子  |\t\t\t        Rank:252 漏洞数:25        )\t\t \n  @一刀终情 Proxmark3  229 美金ACR122   300 人民币    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}