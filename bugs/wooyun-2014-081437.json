{"id": 43852, "wybug_id": "wooyun-2014-081437", "wybug_title": "qibocms 地方门户系统 注入#6 &amp; 另外一处变量覆盖的地方。(demo测试)", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-10-31 12:22", "wybug_open_date": "2015-01-29 12:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向公众公开  简要描述： 这变量覆盖比较不应该了。 详细说明：  在/hy/member/homepage_ctrl/pic_upload.php中\nif($step==2){\tif(!$psid){\t\tshowerr('请选择一个图集!');\t}\t$ck=0;\t\tforeach($photoDB[url] AS $key=>$value){ //对$photoDB[url]数组循环出来\t\tif(!eregi(\"\\.(gif|jpg|jpeg|png|bmp)$\",$value)){\t\t\tdelete_attachment($uid,tempdir($value));\t\t\tcontinue;\t\t}\t\t\t$picpath = \"homepage/pic/\".ceil($uid/1000).\"/\";\t\t$picurl = $picpath.basename($value);\t\t\tmove_attachment($uid,tempdir($value),$picpath);\t//图片转移目录与加水印\t\tif(!is_file(ROOT_PATH.\"$webdb[updir]/$picurl\")){\t\t\t$picurl=$value;\t\t}\t\t\t\t$Newpicpath=ROOT_PATH.\"$webdb[updir]/{$picurl}.gif\";\t\tgdpic(ROOT_PATH.\"$webdb[updir]/$picurl\",$Newpicpath,150,150);\t\tif(!is_file($Newpicpath)){\t\t\tcopy(ROOT_PATH.\"$webdb[updir]/{$picurl}\",$Newpicpath);\t\t}\t\t$title = filtrate($photoDB[name][$key]);//刚才是$photoDB[url] 现在是photoDB[name] 所以这个 photoDB[name] 我们就可以不用提交数组了 提交一个字符串。所以又是截取字符了。用filtrate处理了一下 不过关系不大\t\t$title = get_word($title,32);//这里截取32个字符 这里不影响\t\t\t$db->query(\"INSERT INTO `{$_pre}pic` (`psid` , `uid` , `username` ,  `title` , `url` , `level` , `yz` , `posttime` , `isfm` , `orderlist`  ) VALUES ('$psid', '$uid', '$lfjid', '$title', '$picurl', '0', '1', '$timestamp', '0', '0')\");// 把$title 带入查询 在$title后的$picurl 是\t$picurl = $picpath.basename($value); 数组中循环中的value 限制了必须为jpg结尾 不用考虑 注释掉就行 basename 无影响\t\t$ck++;\t}\n这个先注册个会员 然后开个店铺。\n\n出数据demo测试\n\n____________________________________________________________________一处变量覆盖在shop/inc/join.inc.php中像qibocms这种伪全局机智的cms 一般都会禁止创建GLOBALS变量而qibocms却没有禁止在shop/inc/join/inc.php中\nfunction join_set(){\textract($GLOBALS); //这里我们直接创建GLOBALS 然后变量覆盖掉$_pre\tglobal $address_select,$rsdb,$listdb;\t$address_select = '';/*\tif(!is_table(\"{$_pre}address\")){\t\t$db->query(\"CREATE TABLE `{$_pre}address` AS ( SELECT * FROM `{$_pre}content_2`);\");\t\t$db->query(\"ALTER TABLE `{$_pre}address` ADD PRIMARY KEY ( `rid` );\");\t\t$db->query(\"ALTER TABLE `{$_pre}address` CHANGE `rid` `rid` MEDIUMINT( 7 ) NOT NULL AUTO_INCREMENT ;\");\t\t\t\t$db->query(\"ALTER TABLE `{$_pre}address` ADD INDEX ( `uid` );\");\t\t$db->query(\"TRUNCATE TABLE `{$_pre}address`;\");\t\t$db->query(\"ALTER TABLE `{$_pre}address` DROP `id` ,DROP `fid` ,DROP `content` ,DROP `order_sendtype` ,DROP `order_paytype` ;\");\t}*/\tif($job!='edit'){\t\t$rsdb[order_username] = $lfjdb[truename];\t\t$rsdb[order_phone] = $lfjdb[telephone];\t\t$rsdb[order_mobphone] = $lfjdb[mobphone];\t\t$rsdb[order_email] = $lfjdb[email];\t\t$rsdb[order_qq] = $lfjdb[oicq];\t\t$rsdb[order_postcode] = $lfjdb[postalcode];\t\t$rsdb[order_address] = $lfjdb[address];  \t\t$query = $db->query(\"SELECT * FROM `{$_pre}address` WHERE uid='$lfjuid'\");\t\twhile($rs = $db->fetch_array($query)){\t\t\t$address_select.=\"<option value='$rs[rid]'>地址:{$rs[order_address]} 联系人:{$rs[order_username]} 电话:{$rs[order_mobphone]}</option>\";\t\t\t\t\t}\n输出一下GLOBALS\n\n\n\n直接又创建了GLOBALS 结合这里的extract 直接变量覆盖这里我们来输出一下表前缀\n\n覆盖掉 \n\n成功覆盖掉表前缀。   漏洞证明：  \n\n   修复方案：  第一个判断是不是数组第二个 禁止创建GLOBALS   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-31 15:08 厂商回复： 感谢提出来！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-02 19:09 |    \t\tMxx \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 没有)\t\t \n  你关注的白帽子 ′雨。 发表了漏洞 qibocms 地方门户系统 注入#6 & 另外一处变量覆盖的地方。(demo测试)    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}