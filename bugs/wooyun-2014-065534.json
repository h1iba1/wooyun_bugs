{"id": 1333, "wybug_id": "wooyun-2014-065534", "wybug_title": "Ucserver三个小问题", "wybug_corp": "Discuz!", "wybug_author": "Map", "wybug_date": "2014-06-19 21:09", "wybug_open_date": "2014-09-17 21:10", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向公众公开  简要描述： 一个有条件的SQL注射和两个小问题。 详细说明：  1，暴力破解。ucserver的默认管理员登录需要输入验证码，并且还有登录次数的限制，但是在：/control/app.php 内是没有限制登录的次数的\nfunction onadd() {\t\t$ucfounderpw = getgpc('ucfounderpw', 'P');\t\t$apptype = getgpc('apptype', 'P');\t\t$appname = getgpc('appname', 'P');\t\t$appurl = getgpc('appurl', 'P');\t\t$appip = getgpc('appip', 'P');\t\t$viewprourl = getgpc('viewprourl', 'P');\t\t$appcharset = getgpc('appcharset', 'P');\t\t$appdbcharset = getgpc('appdbcharset', 'P');\t\t$apptagtemplates = getgpc('apptagtemplates', 'P');\t\t$appallowips = getgpc('allowips', 'P');\t\tif(md5(md5($ucfounderpw).UC_FOUNDERSALT) == UC_FOUNDERPW || (strlen($ucfounderpw) == 32 && $ucfounderpw == md5(UC_FOUNDERPW))) {\n只要登录的密码符合，就可以添加一个客户端连接到ucserver并且分配一个uckey和数据库信息。\nelse {\t\t\t\t//$return = \"UC_STATUS_OK|$app[authkey]|$app[appid]|\".UC_DBHOST.'|'.UC_DBNAME.'|'.UC_DBUSER.'|'.UC_DBPW.'|'.UC_DBCHARSET.'|'.UC_DBTABLEPRE.'|'.UC_CHARSET;\t\t\t\t$return = \"$app[authkey]|$app[appid]|\".UC_DBHOST.'|'.UC_DBNAME.'|'.UC_DBUSER.'|'.UC_DBPW.'|'.UC_DBCHARSET.'|'.UC_DBTABLEPRE.'|'.UC_CHARSET;\t\t\t}\n2，已知客户端的uckey的情况下，对ucserver进行SQL注射代码在：/control/mail.php 中\nfunction onadd() {\t\t$this->load('mail');\t\t$mail = array();\t\t$mail['appid']\t\t= $this->app['appid'];\t\t$mail['uids']\t\t= explode(',', $this->input('uids'));\t\t$mail['emails']\t\t= explode(',', $this->input('emails'));\t\t$mail['subject']\t= $this->input('subject');\t\t$mail['message']\t= $this->input('message');\t\t$mail['charset']\t= $this->input('charset');\t\t$mail['htmlon']\t\t= intval($this->input('htmlon'));\t\t$mail['level']\t\t= abs(intval($this->input('level')));\t\t$mail['frommail']\t= $this->input('frommail');\t\t$mail['dateline']\t= $this->time;\t\treturn $_ENV['mail']->add($mail);\t}\n$mail['uids']\t\t= explode(',', $this->input('uids'));这句代码中的$mail['uids']最后进到了SQL语句里，相应的代码在：model/mail.php里有：\n$mail['email_to'] = array();\t\t\t$uids = 0;\t\t\tforeach($mail['uids'] as $uid) {\t\t\t\tif(empty($uid)) continue;\t\t\t\t$uids .= ','.$uid;\t\t\t}\t\t\t$users = $this->db->fetch_all(\"SELECT uid, username, email FROM \".UC_DBTABLEPRE.\"members WHERE uid IN ($uids)\");\n$mail['email_to']被拼到$uids里最后导致了SQL注射。3，信息泄漏，泄漏ucserver内的客户端应用和相应版本代码在：control/app.php 内\nfunction onls() {\t\t$this->init_input();\t\t$applist = $_ENV['app']->get_apps('appid, type, name, url, tagtemplates, viewprourl, synlogin');\t\t$applist2 = array();\t\tforeach($applist as $key => $app) {\t\t\t$app['tagtemplates'] = $this->unserialize($app['tagtemplates']);\t\t\t$applist2[$app['appid']] = $app;\t\t}\t\treturn $applist2;\t}\n所以只要$this->init_input();能正确运行，那么就会抛出ucserver里面的应用和相应的版本号。正好上传头像的api是存在$this->input()所需要的信息的，我们拿官方做个实验。登录后访问：http://www.discuz.net/home.php?mod=spacecp&ac=avatar\n\n获得\nhttp://uc.discuz.net/images/camera.swf?inajax=1&appid=13&input=2b310Oraxl%2BiVL8yXhYy7pJ5DkQOPHYLt2FRsTEIyOD3PMtxkbn%2FDKkzssQgMWYlBirpQPsYOuN4vT9J5mZF7V6Q%2BRD3A8GK9uBTSj8%2FCEOGkPH959sDeep%2FiFag6X8&agent=569b93c7d7e18a505d671ba495198a3a&ucapi=uc.discuz.net&avatartype=virtual&uploadSize=2048\n抠出我们要的东西\n?inajax=1&appid=13&input=2b310Oraxl%2BiVL8yXhYy7pJ5DkQOPHYLt2FRsTEIyOD3PMtxkbn%2FDKkzssQgMWYlBirpQPsYOuN4vT9J5mZF7V6Q%2BRD3A8GK9uBTSj8%2FCEOGkPH959sDeep%2FiFag6X8&agent=569b93c7d7e18a505d671ba495198a3a&ucapi=uc.discuz.net&avatartype=virtual&uploadSize=2048\n拼一下，得到：http://uc.discuz.net/index.php?m=app&a=ls&inajax=1&appid=13&input=2b310Oraxl%2BiVL8yXhYy7pJ5DkQOPHYLt2FRsTEIyOD3PMtxkbn%2FDKkzssQgMWYlBirpQPsYOuN4vT9J5mZF7V6Q%2BRD3A8GK9uBTSj8%2FCEOGkPH959sDeep%2FiFag6X8&agent=569b93c7d7e18a505d671ba495198a3a&ucapi=uc.discuz.net&avatartype=virtual&uploadSize=2048访问得到：\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><root>\t<item id=\"14\">\t\t<item id=\"appid\"><![CDATA[14]]></item>\t\t<item id=\"type\"><![CDATA[UCHOME]]></item>\t\t<item id=\"name\"><![CDATA[uchome]]></item>\t\t<item id=\"url\"><![CDATA[http://u.discuz.net/home]]></item>\t\t<item id=\"tagtemplates\">\t\t\t<item id=\"template\"><![CDATA[]]></item>\t\t</item>\t\t<item id=\"viewprourl\"><![CDATA[]]></item>\t\t<item id=\"synlogin\"><![CDATA[0]]></item>\t</item>\t<item id=\"9\">\t\t<item id=\"appid\"><![CDATA[9]]></item>\t\t<item id=\"type\"><![CDATA[OTHER]]></item>\t\t<item id=\"name\"><![CDATA[Manyou_UChome]]></item>\t\t<item id=\"url\"><![CDATA[http://uchome.developer.manyou.com/uchome]]></item>\t\t<item id=\"tagtemplates\">\t\t\t<item id=\"template\"><![CDATA[]]></item>\t\t</item>\t\t<item id=\"viewprourl\"><![CDATA[/space.php?uid=%s]]></item>\t\t<item id=\"synlogin\"><![CDATA[1]]></item>\t</item>\t<item id=\"11\">\t\t<item id=\"appid\"><![CDATA[11]]></item>\t\t<item id=\"type\"><![CDATA[OTHER]]></item>\t\t<item id=\"name\"><![CDATA[手握手]]></item>\t\t<item id=\"url\"><![CDATA[http://sws.discuz.net/]]></item>\t\t<item id=\"tagtemplates\">\t\t\t<item id=\"template\"><![CDATA[]]></item>\t\t</item>\t\t<item id=\"viewprourl\"><![CDATA[]]></item>\t\t<item id=\"synlogin\"><![CDATA[0]]></item>\t</item>\t<item id=\"13\">\t\t<item id=\"appid\"><![CDATA[13]]></item>\t\t<item id=\"type\"><![CDATA[]]></item>\t\t<item id=\"name\"><![CDATA[Discuz!]]></item>\t\t<item id=\"url\"><![CDATA[http://www.discuz.net/]]></item>\t\t<item id=\"tagtemplates\">\t\t\t<item id=\"template\"><![CDATA[<a href=\"{url}?sid=\" target=\"_blank\">{subject}</a>]]></item>\t\t\t<item id=\"fields\">\t\t\t\t<item id=\"subject\"><![CDATA[标题]]></item>\t\t\t\t<item id=\"uid\"><![CDATA[用户 ID]]></item>\t\t\t\t<item id=\"username\"><![CDATA[发帖者]]></item>\t\t\t\t<item id=\"dateline\"><![CDATA[日期]]></item>\t\t\t\t<item id=\"url\"><![CDATA[主题地址]]></item>\t\t\t</item>\t\t</item>\t\t<item id=\"viewprourl\"><![CDATA[]]></item>\t\t<item id=\"synlogin\"><![CDATA[1]]></item>\t</item></root>\n\n\n   漏洞证明：  \n\n整个其实危害还是挺大的：如果你能暴力出来一个ucserver的管理员密码，你就可以把ucserver和uclient黑了。如果你能黑掉你列出来的任何一个uclient的应用，你就可以拿应用的uckey对ucserver注射。   修复方案：  uc的onls用不上的话可以去掉或者做限制。onadd也可以做个次数限制。SQL注射直接在foreach里进行intval就好了。   版权声明：转载请注明来源 Map@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-06-20 10:46 厂商回复： 安全问题无大小，这些问题我们尽快给于处理，感谢您的支持。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-20 14:29 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  最近discuz官方人的态度和之前千差万别，安全部换负责人了？把x3.1也更新下吧，别老强推你们那3.2什么微社区了。    \n     2014-06-23 12:17 |    \t\t小怿 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:6        | )\t\t \n  @Hmily 从他们的行动速度和对问题的重视，我也觉得是换负责人了。。    \n     2014-07-11 17:15 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  安全问题无大小，这个说的有理。不过最近DZ好像真如上面说的换人了吧，态度很给力了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}