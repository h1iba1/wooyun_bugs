{"id": 13137, "wybug_id": "wooyun-2013-020186", "wybug_title": "QQ空间某功能缺陷导致日志存储型XSS", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2013-03-16 23:11", "wybug_open_date": "2013-04-30 23:12", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "类型应用", "存储型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-03-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-04-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-04-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-04-30：\t细节向公众公开  简要描述： QQ空间日志某处功能缺陷，导致存储型XSS。每次想去瞄一下QQ空间的时候，总能随手发现存储型XSS。关键代码定位+调试 小教学贴。 详细说明：  1. QQ空间日志里面有一个魔方日志的功能。我们随便写一篇模仿日志。2. 抓包，并且看发表日志后的内容。这里值得我们注意的是，HTML中输出的日志内容是一个 img标签，如下图\n\n而我们看到的日志中，则存在FLASH。\n\n3. 从上面可以推出，这里必然会经过某些dom操作，从而将IMG标签转变为OBJECT标签。我们先得到FLASH名称.\n\n接着定位与这个魔方日志有关的功能代码。\n\n-----------------------------分割线------------------5. 好吧，其实以上都是废话，重点是下面的，FLASH将我们带到了这个JS文件， 我们将 http://ctc.qzs.qq.com/qzone/app/blog/v6/script/content_gridsblog.js 美化一下，再看看代码。发现FLASH的部分并没有我们可控的部分。但是可以定位代码下面这样一段代码。GridsScheduler._showGridBlogShortcut();-->在 _showGridBlogShortcut 函数中，有eval('var oGridInfo = ' + PageScheduler.blogInfo.getGridData());6. PageScheduler.blogInfo.getGridData() 这个被eval的是什么数据呢？由于是iframe页面里的变量，直接控制台里没办法输出PageScheduler.blogInfo.getGridData， 我们可以采用“将网络JS映射至本地文件的方法”。\n\n将映射到本地的JS文件里修改为\n....alert(PageScheduler.blogInfo.getGridData());eval('var oGridInfo = ' + PageScheduler.blogInfo.getGridData());....\n7. 接着我们刷新页面，重新打开日志。(* 由于_showGridBlogShortcut 函数中存在判断，必须以外人身份查看日志，才能触发。)看到弹出的 PageScheduler.blogInfo.getGridData() 数据如下。\n\n8. 而这个数据，我们是否可控呢？答案是，我们很有可能可控，因为这个数据，我们提交日志的时候，就存在，如下图：\n\n9. 既然如此，我们将 gridJson这个字段，修改一下，加一段自己的JS代码。\n\n10. 以自己号码查看测试号码的日志,成功执行代码\n\nie,chrome下均可。   漏洞证明：  见详细说明   修复方案：  不影响功能的前提下，对eval的数据有所判断或者过滤。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-03-18 15:24 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-03-16 23:15 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  一哥怒了。。    \n     2013-03-16 23:15 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  第一个来马克,你是我心中永远的二哥,有些屌丝是无法超越你的,哼!@s55i0n    \n     2013-03-16 23:15 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @鬼魅羊羔 现在是三哥了    \n     2013-03-16 23:20 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @小胖胖要减肥 G博士永远都是俺们心目中的一哥。金枪不倒。。。    \n     2013-03-16 23:41 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  切克闹，嘿喂狗，蠕动起来    \n     2013-03-16 23:42 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  @鬼魅羊羔 @小胖子 亲，我只是发个洞子嘛，，况且我是G牛的铁杆粉丝，，不多说啥子，，    \n     2013-03-17 00:03 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  请叫我九妹， 谢谢～    \n     2013-03-17 00:06 |    \t\t猥琐 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 学习什么的最重要！)\t\t \n  @gainover 九妹照片 http://photo.icxo.com/201011/20101141156.jpg    \n     2013-03-17 00:14 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @se55i0n 逗你玩儿呢，小气鬼～你永远是我的好基友～    \n     2013-03-17 00:30 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @猥琐 我擦，G哥亮了。。。    \n     2013-03-17 00:33 |    \t\t冻心 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 爱wooyun  爱生活！)\t\t \n  切克闹，嘿喂狗，蠕动起来    \n     2013-03-17 07:54 |    \t\t苏南同学 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:5        | 苏南同学，就是苏南同学~~~)\t\t \n  我们千寻不得，洞主手到擒来~ 赞~    \n     2013-03-17 09:18 |    \t\trasca1 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:16        | 菜鸟一只)\t\t \n  我们千寻不得，洞主手到擒来~ 赞~     \n     2013-03-17 09:49 |    \t\t陈再胜 \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:13        | 微博收收听~~~●﹏●)\t\t \n  看到教学贴，总要关注下····    \n     2013-03-22 14:09 |    \t\tnone \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:5        | 十次十次啊 hack it then know more~)\t\t \n  二哥快要超越一哥了 (我只看精华)    \n     2013-04-02 09:18 |    \t\tDefa \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:13        | <img src=1 onerror=alert(1)>)\t\t \n  学费真贵，    \n     2013-04-18 21:14 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:84        | 三人行必有我师焉########################...)\t\t \n  终于看见了！大作呀！学习    \n     2013-04-23 21:04 |    \t\tth000 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | 安全初段～)\t\t \n  有意思    \n     2013-05-21 20:07 |    \t\tlossite \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:2        | OK!)\t\t \n  @gainover 弱弱的问一句，为啥我必须加上属性才能执行，是不是我理解错了？ eval('var x1='+ {\"test\":\"(function(){alert(1)})()\"}.test)     \n     2013-05-22 10:05 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @lossite {\"test\":\"(function(){alert(1)})()\"}.test 的值实际上是字符串 \"(function(){alert(1)})()\"， 与 'var x1=' 相加后，即为：var x1=(function(){alert(1)})() 然后 eval('var x1=(function(){alert(1)})() '); 执行代码。可能你想写的是下面的样子：eval('var x1={\"test\":(function(){alert(1)})()}');    \n     2013-05-22 10:52 |    \t\tlossite \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:2        | OK!)\t\t \n  @gainover 多谢大牛，昨天测试的时候写成这个了，eval('var x1={\"test\":\"(function(){alert(1)})()\"}'); 多了两个引号。。。    \n     2013-10-02 20:45 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:34        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n  尼玛看不懂呢，不过很精彩    \n     2014-03-29 14:45 |    \t\tbitcoin \t\t\t( 普通白帽子  |\t\t\t        Rank:715 漏洞数:165        | 学习是最好的投资！)\t\t \n  此人只因天上有    \n     2014-04-17 16:47 |    \t\t乌帽子 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:3        | 学习黑客哪家强 | 中国山东找蓝翔 | sql...)\t\t \n  怎么将网络js映射为本地的？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}