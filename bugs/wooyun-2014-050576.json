{"id": 4397, "wybug_id": "wooyun-2014-050576", "wybug_title": "360webscan检测脚本可绕过", "wybug_corp": "奇虎360", "wybug_author": "phith0n", "wybug_date": "2014-02-10 14:36", "wybug_open_date": "2014-05-08 14:37", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["白盒审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-10：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-08：\t细节向公众公开  简要描述： 全面绕过~360webscan.php见cmseasy、phpyun虽然我知道360肯定会忽略，但我还是要继续@mramydnei 的事业~~http://wooyun.org/bugs/wooyun-2010-049051http://wooyun.org/bugs/wooyun-2010-049161这个漏洞暴露出一个细节问题，可能会影响很多cms。这个靠大家发掘了。 详细说明：  借用cmseasy中的360webscan来说明。其中有一个白名单函数：\n/** *  拦截目录白名单 */function webscan_white($webscan_white_name,$webscan_white_url_t=array()) {  $url_path=$_SERVER['PHP_SELF'];  $url_var=$_SERVER['QUERY_STRING'];  if (preg_match(\"/\".$webscan_white_name.\"/is\",$url_path)==1) {    return false;  }  foreach ($webscan_white_url_t as $webscan_white_url) {\t  foreach ($webscan_white_url as $key => $value) {\t\tif(!empty($url_var)&&!empty($value)){\t\t  if (stristr($url_path,$key)&&stristr($url_var,$value)) {\t\t\treturn false;\t\t  }\t\t}\t\telseif (empty($url_var)&&empty($value)) {\t\t  if (stristr($url_path,$key)) {\t\t\treturn false;\t\t  }\t\t}\t  }  }  return true;}\n这个函数在后面的过滤中起着至关重要的作用，因为过滤的时候判断如果webscan_white返回false就不执行过滤。也就是说，我们如果能让这个函数返回false，那么就能轻松绕过360webscan的过滤。那我们来看这个函数，这个函数第一个字段是白名单内容，我们在webscan_cache.php中可以找到：\n//后台白名单,后台操作将不会拦截,添加\"|\"隔开白名单目录下面默认是网址带 admin  /dede/ 放行$webscan_white_directory='admin|\\/dede\\/|\\/install\\/';\n然后再看到下面：\n$url_path=$_SERVER['PHP_SELF'];  $url_var=$_SERVER['QUERY_STRING'];  if (preg_match(\"/\".$webscan_white_name.\"/is\",$url_path)==1) {    return false;  }\n当$_SERVER['PHP_SELF']中能正则匹配出'admin|\\/dede\\/|\\/install\\/'的时候，就返回false，就绕过了检测。然后再给大家说明一下$_SERVER['PHP_SELF']是什么：PHP_SELF指当前的页面地址，比如我们的网站：http://www.leavesongs.com/hehe/index.php那么PHP_SELF就是/hehe/index.php。但有个小问题很多人没有注意到，当url是PATH_INFO的时候，比如http://www.leavesongs.com/hehe/index.php/phithon那么PHP_SELF就是/hehe/index.php/phithon也就是说，其实PHP_SELF有一部分是我们可以控制的。说到这里大家应该知道怎么绕过360webscan了吧？只要PHP_SELF中含有白名单字段即可。这也可以发散到很多cms上，php_self也是可控变量，注意过滤。   漏洞证明：  官网的demo不知道为何不成功，但是我下载了最新版20140118，本地搭建。比如我们提交一个含有敏感字符union select的查询，被360拦截了：\n\n那我们修改一下path_info,其中带有白名单字段“/admin/”：\n\n果断页面变了，绕过了拦截。不过这个时候css和js也变了（因为基地址有问题），但并不影响sql语句和xss的执行，注入什么的还是能继续的。我们再随便试一个不知什么版本的cmseasy，都没有拦截：\n\n   修复方案：  如果考虑简便性与性能的话，可以选择不修复   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-05-08 14:37 厂商回复： 感谢关注和反馈，该问题在新版中进行修复。考虑到性能和简单性，这个脚本只提供了基础的功能防护，目标是为了进行最基础的SQL注入和XSS防护。完整功能请使用360网站卫士： 漏洞Rank：6  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-10 14:52 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  我结合了前两个漏洞的厂商评论来看 哈哈哈哈 好好笑    \n     2014-02-10 16:08 |    \t\tgery \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:6        | 自由和共享的感觉真好，业余玩安全。)\t\t \n  企业嘛呵呵    \n     2014-02-10 18:33 |    \t\tziwen \t\t\t( 实习白帽子  |\t\t\t        Rank:49 漏洞数:4        | 活着为了乐还是为了苦？)\t\t \n  玛瑞克    \n     2014-02-10 21:10 |    \t\t超威蓝猫 \t\t\t( 核心白帽子 |\t\t\t        Rank:1092 漏洞数:117        | STEAM_0:0:55968383)\t\t \n  这个漏洞乌云直接公开了。360公关能稍微有点水平？    \n     2014-02-10 21:35 |    \t\t超威蓝猫 \t\t\t( 核心白帽子 |\t\t\t        Rank:1092 漏洞数:117        | STEAM_0:0:55968383)\t\t \n  说难听点，360这态度，屁都不如。    \n     2014-02-11 12:14 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  360这个不要脸的企业，永远指使它的员工，叫它的员工不要承认自己的任何错误。    \n     2014-05-08 14:42 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  碉堡    \n     2014-05-08 14:47 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  @只发通用型 哈哈 360确实是逗！    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}