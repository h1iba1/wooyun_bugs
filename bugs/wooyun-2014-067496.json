{"id": 53498, "wybug_id": "wooyun-2014-067496", "wybug_title": "qibocms 新闻系统 Getshell (需结合解析漏洞)#2", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-07-07 16:09", "wybug_open_date": "2014-10-05 16:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向公众公开  简要描述： 上次发的那个官方已补,再来继续看看还可以不。IIS6 or LINUX+APACHE 详细说明：  上回分解 请看这  WooYun: qibocms 新闻系统 Getshell (需结合解析漏洞) http://bbs.qibosoft.com/down2.php?v=news1.0#down下载地址 刚下的。来看看官方是怎么修复的在news/inc/artic_function.php中\nfunction get_outpic($str,$fid=0,$getpic=1){\tglobal $webdb,$lfjuid,$_pre;\tif(!$getpic){\t\treturn $str;\t}\tpreg_match_all(\"/http:\\/\\/([^ '\\\"<>]+)\\.(gif|jpg|jpeg|png)/is\",$str,$array);\t$filedb=$array[0];\tforeach( $filedb AS $key=>$value){\t\tif( strstr($value,$webdb[www_url]) ){\t\t\tcontinue;\t\t}\t\t$listdb[\"$value\"]=$value;\t}\tunset($filedb);\tforeach( $listdb AS $key=>$value){\t\t$filedb[]=$value;\t\t$name=$lfjuid.'_'.rands(5).\"__\".preg_replace(\"/(.*)\\.(jpg|png|gif)$/is\",\".\\\\2\",$value);\npreg_replace(\"/(.*)\\.(jpg|png|gif)$/is\",\".\\\\2\",$value)可以看到改了这里  这里就不能绕过了来看看哪里还有没_________________________________________________________________________在form/form.php中\nfunction get_out_pic($str,$getpic=1){\tglobal $webdb,$_pre;\tif(!$getpic){\t\treturn $str;\t}\tpreg_match_all(\"/http:\\/\\/([^ '\\\"<>]+)\\.(gif|jpg|png)/is\",$str,$array);\t$filedb=$array[0];\tforeach( $filedb AS $key=>$value){\t\tif( strstr($value,$webdb[www_url]) ){\t\t\tcontinue;\t\t}\t\t$listdb[\"$value\"]=$value;\t}\tunset($filedb);\tforeach( $listdb AS $key=>$value){\t\t$filedb[]=$value;\t\t$name=rands(5).\"__\".basename($value);\t\tif(!is_dir(ROOT_PATH.\"$webdb[updir]/form\")){\t\t\tmakepath(ROOT_PATH.\"$webdb[updir]/form\");\t\t}\t\t$ck=0;\t\tif( @copy($value,ROOT_PATH.\"$webdb[updir]/form/$name\") ){\t\t\t$ck=1;\t\t}elseif($filestr=file_get_contents($value)){\t\t\t$ck=1;\t\t\twrite_file(ROOT_PATH.\"$webdb[updir]/form/$name\",$filestr);\t\t}\n可以看到这个是跟之前那个一样的,但是那个做了修改 这个函数却没有修改。就在form/form.php里面调用了这个函数。\nforeach( $m_config[is_html] AS $key=>$value)\t{   \t\t$postdb[$key]=str_replace(\"<img \",\"<img onload=\\'if(this.width>600)makesmallpic(this,600,800);\\' \",$postdb[$key]);\t\t//图片目录转移\t\t$postdb[$key]=move_attachment($lfjdb[uid],$postdb[$key],\"form\");\t\t//获取远程图片\t\t$postdb[$key]=get_out_pic($postdb[$key],$GetOutPic);\t\t$postdb[$key] = En_TruePath($postdb[$key]);\t\t$postdb[$key] = preg_replace('/javascript/i','java script',$postdb[$key]);//过滤js代码\t\t$postdb[$key] = preg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[$key]);//过滤框架代码\t}\n是把$postdb[content] 带入了这函数\t$name=rands(5).\"__\".basename($value);然后拼接一下语句。preg_match_all(\"/http:\\/\\/([^ '\\\"<>]+)\\.(gif|jpg|png)/is\",$str,$array);由于这里匹配的是最后必须是jpg之类的。 所以只有结合解析漏洞IIS6解析漏洞 yu.php;1.jpg 这种是可以解析成php的 这个都是windowsapache+linux解析漏洞:由于apache如果不认识最后一个后缀的话就会向上识别。 例如yu.php.jpg 在linux下jpg格式不会被识别 然后就识别成了php 在windows下的话jpg就会被识别那就是个jpg了所以两种环境可以 一种iis6 第二种 linux+apache。   漏洞证明：  content那里就写自己搭建的环境 然后里面就是马儿的内容\n\nIIS就这里 Linux 同理。   修复方案：  参照你们之前的那样。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2014-07-09 11:49 厂商回复： 万能表单 是供二次开发使用的。默认没采集图片的功能。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-08 13:18 |    \t\tLet a person cry. \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:9        | xxoo)\t\t \n  火速前排留名...来一发不需要解析漏洞的呗    \n     2014-07-09 12:48 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   确定默认没开启?  直接下载下来不做任何配置都行。    \n     2014-07-09 16:11 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:15        | Talk is cheap,show me the shell.)\t\t \n  @′  雨。 这就是给你凑600呢。。。    \n     2014-07-16 00:13 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  @′  雨。 被你插队了QAQ,我测试时候改一下post包还要满足一个啥变量等于1来着（忘了）这个需要开发是自己写，默认确实不开启    \n     2014-07-16 00:20 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @只发通用型 那个变量结合伪全局可以直接控制的把。    \n     2014-07-16 00:24 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @只发通用型 你直接post那变量为1 就可以了。         \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}