{"id": 51800, "wybug_id": "wooyun-2014-073319", "wybug_title": "php云人才系统存储型跨站多处", "wybug_corp": "php云人才系统", "wybug_author": "linadmin", "wybug_date": "2014-08-21 16:50", "wybug_open_date": "2014-11-19 16:52", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向公众公开  简要描述： 前台过滤不严，绕过防护跨站 详细说明：  再次发现phpyunCMS存储型跨站2枚，可能存在多处漏洞代码位于/phpyun/friend/model/index.class.php第一处是：function save_action()//xss\t{\t\tif($this->uid=='')\t\t{\t\t\t$this->obj->ACT_layer_msg( \"请先登录！\", 8);\t\t}\t\tif(trim($_POST['title'])==\"\")\t\t{\t\t\t$this->obj->ACT_layer_msg( \"标题不能为空！\", 8);\t\t}\t\t$data['title']=$_POST['title'];\t\t$data['cid']=(int)$_POST['cid'];\t\t$data['content']=str_replace(\"&amp;\",\"&\",html_entity_decode($_POST['content'],ENT_QUOTES,\"GB2312\"));\t\t$data['uid']=$this->uid;\t\t$data['add_time']=time();\t\t$n_ids=$this->obj->insert_into(\"question\",$data); \t\tif($n_ids) \t\t{\t\t\t$nickname=$this->obj->DB_select_once(\"firend_info\",\"`uid`='\".$this->uid.\"'\",\"`nickname`\");\t\t\t$gourl= $this->aurl(array(\"url\"=>\"c:content,id:\".$n_ids));\t\t\t$sql['uid']=$this->uid;\t\t\t$sql['content']=\"发布了问答《<a href=\\\"\".$gourl.\"\\\" target=\\\"_blank\\\">\".$_POST['title'].\"</a>》。\";\t\t\t$sql['ctime']=time();\t\t\t$this->obj->insert_into(\"friend_state\",$sql);\t\t\t$gourl= $this->aurl(array(\"url\"=>\"c:index\"));\t\t\t$this->obj->ACT_layer_msg( \"提问成功！\",9,$gourl);\t\t}else{\t\t\t$this->obj->ACT_layer_msg( \"提问失败！\", 8);\t\t}\t}第二处：function answer_action()//xsssss\t{\t\t$gourl= $this->aurl(array(\"url\"=>\"c:content,id:\".$_GET['id']));\t\tif($_POST['content'])\t\t{\t\t\t$q_title=$this->obj->DB_select_once(\"question\",\"`id`='\".(int)$_GET['id'].\"'\",\"`uid`,`title`,`content`\");\t\t\tif($q_title['uid']==$this->uid)\t\t\t{\t\t\t\t$content = str_replace(\"&amp;\",\"&\",html_entity_decode(\"<br/>追加内容：<br/>\".$_POST['content'],ENT_QUOTES,\"GB2312\"));\t\t\t\t$content=$q_title['content'].$content;\t\t\t\t$id=$this->obj->update_once(\"question\",array(\"content\"=>$content),array(\"id\"=>(int)$_GET['id']));\t\t\t\tif($id)\t\t\t\t{\t\t\t\t\t$this->obj->ACT_layer_msg( \"提问追加成功！\",9,$gourl);\t\t\t\t}else{\t\t\t\t\t$this->obj->ACT_layer_msg( \"提问追加失败！\",8,$gourl);\t\t\t\t}\t\t\t}else{\t\t\t\t$data['qid']=(int)$_GET['id'];\t\t\t\t$data['content']=str_replace(\"&amp;\",\"&\",html_entity_decode($_POST['content'],ENT_QUOTES,\"GB2312\"));\t\t\t\t$data['uid']=$this->uid;\t\t\t\t$data['comment']=0;\t\t\t\t$data['support']=0;\t\t\t\t$data['oppose']=0;\t\t\t\t$data['add_time']=time();\t\t\t\t$id=$this->obj->insert_into(\"answer\",$data);\t\t\t\tif($id)\t\t\t\t{\t\t\t\t\t$this->obj->DB_update_all(\"question\",\"`answer_num`=`answer_num`+1\",\"id='\".(int)$_GET['id'].\"'\");\t\t\t\t\t$state_content = \"回答了问答《<a href=\\\"\".$gourl.\"\\\" target=\\\"_blank\\\">\".$q_title['title'].\"</a>》。\";\t\t\t\t\t$this->addstate($state_content);\t\t\t\t\t$this->obj->ACT_layer_msg( \"回答成功！\", 9,$gourl);\t\t\t\t}else{\t\t\t\t\t$this->obj->ACT_layer_msg( \"回答失败！\", 8);\t\t\t\t}\t\t\t}\t\t}else{\t\t\t$this->obj->ACT_layer_msg( \"内容不能为空！\", 2);\t\t}\t}两处代码的漏洞都在于$_POST['content']变量并没有进行良好的过滤，直接写入数据库中，虽然phpyun有其他的防护拦截，但是依旧可以绕过，绕过代码<a href=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgiWFNTIik8L3NjcmlwdD4=\">test<a>或者<iframe src=”http://www.baidu.com”>tt</iframe>验证：第一处代码对应的功能是“我要提问”如图： \n\n然后查看“我的问题” \n\n点击test触发弹框第二处在追加（回答）问题处 \n\n提交后可见 \n\n验证完毕。经过我对代码的粗略阅读，phpyunCMS中大量存在类似的缺陷代码，对应的功能我没有详细挖掘，肯定的是存储型跨站绝对不止这两处，希望厂商能对代码整体进行修复。   漏洞证明：  详见说明   修复方案：  过滤   版权声明：转载请注明来源 linadmin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-08-21 21:16 厂商回复： 感谢您的提供，针对此处，我们会进行排查并修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}