{"id": 87733, "wybug_id": "wooyun-2016-0183200", "wybug_title": "CodeIgniter框架内核设计缺陷可能导致任意代码执行                                      ", "wybug_corp": "CodeIgniter框架", "wybug_author": "phith0n", "wybug_date": "2016-03-11 02:00", "wybug_open_date": "2016-06-13 17:20", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-18：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-13：\t细节向公众公开  简要描述： 为准备乌云深圳沙龙，准备几个0day做案例。官方承认这个问题，说明会发布补丁，但不愿承认这是个『漏洞』……不过也无所谓，反正是不是都没美刀~ 详细说明：  CI在加载模板的时候，会调用 $this->load->view('template_name', $data);内核中，查看view函数源码：/system/core/Loader.php\npublic function view($view, $vars = array(), $return = FALSE)    {        return $this->_ci_load(array('_ci_view' => $view, '_ci_vars' => $this->_ci_object_to_array($vars), '_ci_return' => $return));    }...    protected function _ci_load($_ci_data)    {        // Set the default data variables        foreach (array('_ci_view', '_ci_vars', '_ci_path', '_ci_return') as $_ci_val)        {            $$_ci_val = isset($_ci_data[$_ci_val]) ? $_ci_data[$_ci_val] : FALSE;        }        $file_exists = FALSE;        // Set the path to the requested file        if (is_string($_ci_path) && $_ci_path !== '')        {            $_ci_x = explode('/', $_ci_path);            $_ci_file = end($_ci_x);        }        else        {            $_ci_ext = pathinfo($_ci_view, PATHINFO_EXTENSION);            $_ci_file = ($_ci_ext === '') ? $_ci_view.'.php' : $_ci_view;            foreach ($this->_ci_view_paths as $_ci_view_file => $cascade)            {                if (file_exists($_ci_view_file.$_ci_file))                {                    $_ci_path = $_ci_view_file.$_ci_file;                    $file_exists = TRUE;                    break;                }                if ( ! $cascade)                {                    break;                }            }        }        if ( ! $file_exists && ! file_exists($_ci_path))        {            show_error('Unable to load the requested file: '.$_ci_file);        }        // This allows anything loaded using $this->load (views, files, etc.)        // to become accessible from within the Controller and Model functions.        $_ci_CI =& get_instance();        foreach (get_object_vars($_ci_CI) as $_ci_key => $_ci_var)        {            if ( ! isset($this->$_ci_key))            {                $this->$_ci_key =& $_ci_CI->$_ci_key;            }        }        /*         * Extract and cache variables         *         * You can either set variables using the dedicated $this->load->vars()         * function or via the second parameter of this function. We'll merge         * the two types and cache them so that views that are embedded within         * other views can have access to these variables.         */        if (is_array($_ci_vars))        {            $this->_ci_cached_vars = array_merge($this->_ci_cached_vars, $_ci_vars);        }        extract($this->_ci_cached_vars);        /*         * Buffer the output         *         * We buffer the output for two reasons:         * 1. Speed. You get a significant speed boost.         * 2. So that the final rendered template can be post-processed by         *  the output class. Why do we need post processing? For one thing,         *  in order to show the elapsed page load time. Unless we can         *  intercept the content right before it's sent to the browser and         *  then stop the timer it won't be accurate.         */        ob_start();        // If the PHP installation does not support short tags we'll        // do a little string replacement, changing the short tags        // to standard PHP echo statements.        if ( ! is_php('5.4') && ! ini_get('short_open_tag') && config_item('rewrite_short_tags') === TRUE)        {            echo eval('?>'.preg_replace('/;*\\s*\\?>/', '; ?>', str_replace('<?=', '<?php echo ', file_get_contents($_ci_path))));        }        else        {            include($_ci_path); // include() vs include_once() allows for multiple views with the same name        }        log_message('info', 'File loaded: '.$_ci_path);        // Return the file data if requested        if ($_ci_return === TRUE)        {            $buffer = ob_get_contents();            [@ob_end_clean](/ob_end_clean)();            return $buffer;        }        /*         * Flush the buffer... or buff the flusher?         *         * In order to permit views to be nested within         * other views, we need to flush the content back out whenever         * we are beyond the first level of output buffering so that         * it can be seen and included properly by the first included         * template and any subsequent ones. Oy!         */        if (ob_get_level() > $this->_ci_ob_level + 1)        {            ob_end_flush();        }        else        {            $_ci_CI->output->append_output(ob_get_contents());            [@ob_end_clean](/ob_end_clean)();        }        return $this;    }\n且看这一段：\nif (is_array($_ci_vars)){        $this->_ci_cached_vars = array_merge($this->_ci_cached_vars, $_ci_vars);}extract($this->_ci_cached_vars);\n这个extract将导致变量覆盖漏洞。$this->_ci_cached_vars是来自$_ci_vars，而$_ci_vars是来自用户传给view方法的第二个参数。（正常情况下是开发者传给模板的变量）而我们看到extract后面：\nextract($this->_ci_cached_vars);ob_start();// If the PHP installation does not support short tags we'll// do a little string replacement, changing the short tags// to standard PHP echo statements.if ( ! is_php('5.4') && ! ini_get('short_open_tag') && config_item('rewrite_short_tags') === TRUE){    echo eval('?>'.preg_replace('/;*\\s*\\?>/', '; ?>', str_replace('<?=', '<?php echo ', file_get_contents($_ci_path))));}else{    include($_ci_path); // include() vs include_once() allows for multiple views with the same name}\ninclude($_ci_path)，$_ci_path是模板地址，因为之前的变量覆盖，将会导致任意文件包含漏洞，进而getshell。所以，只要我们可以控制view的第二个参数的『键值』，传入 _ci_path=file:///etc/passwd ，在被extract后覆盖原来的模板地址，将可以包含/etc/passwd。这个漏洞和 http://**.**.**.**/bugs/wooyun-2014-051906 有点类似，就是在assign（CI里叫$this->load->vars或是$this->load->view）的时候传入数组导致的。   漏洞证明：  如下Controller将可导致漏洞：\n<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Welcome extends CI_Controller {\t\tpublic function index()\t{\t\t$data = $this->input->post();\t\t$this->load->view('welcome_message', $data);\t}}\n\n\n这个也类似：\npublic function index(){\t$data = $this->input->post('info');\t$this->load->vars($data);\t$this->load->view('welcome_message');}\n\n\n当开启了远程文件包含的情况下，也可以直接包含php://input\n\n   修复方案：  将extract换成\nforeach($this->_ci_cached_vars as $key => $value) {        if(strpos($key, '_ci') !== 0) {                $$key = $value;        }}\n   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2016-03-15 17:12 厂商回复： CNVD未直接复现所述情况，暂未建立与网站管理单位的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-11 02:36 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  随随便便就甩出几个0day~    \n     2016-03-11 08:56 |    \t\t玉林嘎  \t\t\t( 普通白帽子  |\t\t\t        Rank:941 漏洞数:108        )\t\t \n  吊炸天    \n     2016-03-11 09:04 |    \t\t啊L川  \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:39        | 菜鸟 ，菜渣， 菜呀！)\t\t \n  随随便便就甩出几个0day~    \n     2016-03-11 09:06 |    \t\tkomas \t\t\t( 普通白帽子  |\t\t\t        Rank:107 漏洞数:25        )\t\t \n  随随便便就甩出几个0day~    \n     2016-03-11 09:39 |    \t\t盛大网络(乌云厂商)\t\t \n  可以看看Piwik  用的还蛮多的    \n     2016-03-11 09:51 |    \t\t幻老头儿 \t\t\t( 普通白帽子  |\t\t\t        Rank:275 漏洞数:61        | 新手上路。)\t\t \n  @盛大网络 你觉得是厂商里面逛乌云最多的……那么问题来了，搞基不？    \n     2016-03-11 10:12 |    \t\t404notfound \t\t\t( 普通白帽子  |\t\t\t        Rank:417 漏洞数:115        | 考研中，有事请留言)\t\t \n  师傅叼炸天    \n     2016-03-11 10:21 |    \t\t滨湖虎子 \t\t\t( 实习白帽子  |\t\t\t        Rank:68 漏洞数:11        | 阿弥陀佛)\t\t \n  @phith0n 好吧，3号出来的0day这么快就放出来了    \n     2016-03-11 10:23 |    \t\t1c3z \t\t\t( 普通白帽子  |\t\t\t        Rank:307 漏洞数:64        | @)!^)\t\t \n  前排关注    \n     2016-03-11 10:33 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:834 漏洞数:127        | 一个想当文人的黑客~)\t\t \n  @滨湖虎子 哪的0day。。。这个是这两天我找的，应该不是一个吧？    \n     2016-03-11 10:37 |    \t\t滨湖虎子 \t\t\t( 实习白帽子  |\t\t\t        Rank:68 漏洞数:11        | 阿弥陀佛)\t\t \n  @phith0n 漏洞可以引发很多各种问题啊,具体看场景的 对吧     \n     2016-03-11 10:42 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:834 漏洞数:127        | 一个想当文人的黑客~)\t\t \n  @滨湖虎子 嗯是，具体看场景 >.<    \n     2016-03-11 10:47 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1662 漏洞数:191        | 学无止境)\t\t \n  关注，公司很多业务就是ci开发的。。    \n     2016-03-11 11:01 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  666    \n     2016-03-11 11:48 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2016-03-15 14:55 |    \t\t千域千寻 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:8        | 帝吼天啸关山震 皇天后土伏做臣)\t\t \n  随随便便就甩出几个0day    \n     2016-03-29 12:58 |    \t\tning1022 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:74        | 技术万能，技术万万不能！)\t\t \n  好叼！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}