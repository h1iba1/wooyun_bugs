{"id": 29714, "wybug_id": "wooyun-2015-0100874", "wybug_title": "多市公共安全系统Getshell漏洞（通用）", "wybug_corp": "公安部一所", "wybug_author": "pandas", "wybug_date": "2015-03-12 11:10", "wybug_open_date": "2015-06-14 11:36", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "16", "wybug_status": "已交由第三方合作机构(公安部一所)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-14：\t细节向公众公开  简要描述： . 详细说明：  类型并不算是文件上传导致的代码执行，应该是任意写文件操作，无奈没找到对应选项，请不要扣我分。涉及案例：\n\nmask 区域\n1.http://**.**.**2.http://**.**.**3.http://**.**.**4.http://**.**.**5.http://**.**.**6.http://**.**.**7.http://**.**.**8.http://**.**.**9.http://**.**.**10.http://**.**.**\n\n等等，先列举10个案例，若需要更多案例，可私信。漏洞文件：edittheme1.php\n<?phpfunction str2js1( $_obfuscate_R2_b ){\t\t$_obfuscate_R2_b = str_replace( \"\\\\\", \"\\\\\\\\\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_replace( \"\\\"\", \"\\\\\\\"\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_replace( \"\\r\", \"\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_replace( \"\\n\", \"\\\\n\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_replace( \"\\\\v\", \"\\\\v\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_replace( \"\\t\", \"\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_ireplace( \"?>\", \"?&gt;\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_ireplace( \"<?\", \"&lt;?\", $_obfuscate_R2_b );\t\t$_obfuscate_R2_b = str_ireplace( \"<?php \", \"&lt;?php \", $_obfuscate_R2_b );\t\treturn $_obfuscate_R2_b;}$op = $_GET['op'];if ( empty( $op ) ){\t\t$op = $_POST['op'];}include( \"../common.php\" ); //伪全局变量注册机制，比如下面的atc_content变量则默认可以由gp来传递if ( empty( $siteid ) ){\t\texit( \"error\" );}$v = $block_s;if ( $op == \"update\" ){\t\t$atc_content = stripslashes( $atc_content );//act_content可控\t\t$string = $atc_content;\t\t$patterns = \"/(http\\\\:\\\\/\\\\/)([0-9a-z-]*)(\\\\.pt\\\\.17oh\\\\.com\\\\/)/siU\";\t\t$patterns1 = \"/(http\\\\:\\\\/\\\\/)([0-9a-z-]*)(\\\\.jy\\\\.17oh\\\\.com\\\\/)/siU\";\t\t$patterns2 = \"/(http\\\\:\\\\/\\\\/)([0-9a-z-]*)(\\\\.qy\\\\.17oh\\\\.com\\\\/)/siU\";\t\t$patterns3 = \"/(http\\\\:\\\\/\\\\/)([0-9a-z-]*)(\\\\.zf\\\\.17oh\\\\.com\\\\/)/siU\";\t\t$string = preg_replace( $patterns, \"\", $string );\t\t$string = preg_replace( $patterns1, \"\", $string );\t\t$string = preg_replace( $patterns2, \"\", $string );\t\t$string = preg_replace( $patterns3, \"\", $string );\t\t$string = str_replace( $_config_rooturl, \"\", $string );\t\t$atc_content = str2js1( $string );//这个函数对html标签进行了html转义，对漏洞利用没有影响\t\t$cat1 = str_replace( \"f_con\", \"\", $blockid );//blockid可控\t\tif ( $cat1 == \"2\" )\t\t{\t\t\t\t$cat = \"99\";\t\t}\t\telse\t\t{\t\t\t\t$cat = $cat1;\t\t}\t\t$filename = SITE_CACHE.\"/tmp_\".$mod.\"_\".$cat1.\".php\";//mod可控\t\t$h_bg = \"<?\\n\";\t\t$h_bg .= \"\\$fcon[\".$cat.\"]=\\\"\".$atc_content.\"\\\";\\n\";\t\t$h_bg .= \"?>\";\t\tfile_put_contents( $filename, $h_bg );}?>\n由于有伪全局变量注册机制，所以变量h_bg部分可控，且首尾有php标签，filename也是部分可控，所以最后的file_put_contents写入文件没有任何阻碍，可成功getshell，只是利用方式会有一点点绕，具体可见测试代码区。   漏洞证明：  随便选取一处案例写入phpinfo测试，未做破坏：写入一句话木马的原理一样，厂商若需要，可以私信联系。http://www.thxga.gov.cn\n\n\n\n   修复方案：  .   版权声明：转载请注明来源 pandas@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：17  确认时间：2015-03-16 11:35 厂商回复： 验证确认所描述的问题，已通知其修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-12 11:45 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  来了来了，哈哈哈    \n     2015-03-16 11:40 |    \t\tVig0r \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:17        | 十年磨一剑)\t\t \n  还是4rank？    \n     2015-03-19 21:27 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  这些系统你都接触的到啊- -    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 17, "Ranks": null}