{"id": 84309, "wybug_id": "wooyun-2015-0145198", "wybug_title": "【齐博b2b商务系统】前台多处存储型xss直打后台admin", "wybug_corp": "齐博CMS", "wybug_author": "Elliott", "wybug_date": "2015-10-15 11:10", "wybug_open_date": "2016-01-18 11:11", "wybug_type": "XSS跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "存储型", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-20：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-18：\t细节向公众公开  简要描述： 来一发..... 详细说明：  齐博官网下载第一栏的最新版b2b商务系统作测试。\n\n环境：win7+xampp php以普通用户权限注册一个号   账号为test   目标取得后台admin权限（Cookies）在会员中心右栏发表文章，文章发表栏任意~~\n\n填完数据后提交， burp抓包，改postdb[content]栏，如图\n\n提交。   漏洞证明：  因为默认文章需要后台审核后才能发布，用admin登陆后台审核文章。\n\n\n\n\n\n执行了脚本，得到有效cookie~~~content内长度是够了。   看看代码问题在哪儿\\news\\member\\post.php   154-165行\n$postdb[content] = get_outpic($postdb[content],$fid,$GetOutPic);\t$postdb[content] = En_TruePath($postdb[content]);\t$postdb[content] = preg_replace('/javascript/i','java script',$postdb[content]);\t//过滤js代码\t$postdb[content] = preg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[content]);\t//过滤框架代码\t \tforeach($postdb AS $key=>$value){\t\t\tif($key=='content'){\t\t\t\t\tcontinue;  //为啥要continue\t\t}\t\t$postdb[$key]=filtrate($value);\t}\nforeach中看到key为content就放弃filtrate了，且上面的正则根没过滤一样=。=。看看filtrate()\nfunction filtrate($msg){\t//$msg = str_replace('&','&amp;',$msg);\t//$msg = str_replace(' ','&nbsp;',$msg);\t$msg = str_replace('\"','&quot;',$msg);\t$msg = str_replace(\"'\",'&#39;',$msg);\t$msg = str_replace(\"<\",\"&lt;\",$msg);\t$msg = str_replace(\">\",\"&gt;\",$msg);\t$msg = str_replace(\"\\t\",\"   &nbsp;  &nbsp;\",$msg);\t//$msg = str_replace(\"\\r\",\"\",$msg);\t$msg = str_replace(\"   \",\" &nbsp; \",$msg);\treturn $msg;}\n依然没过滤 '<'  '>' 等危险代码，程序猿写一个吧~~~ xss2：进入test用户的用户中心。\n\n写新信息  接受者为admin(默认后台用户名)\n\n填完，burp抓包，改postdb[content]栏   如图\n\n提交用admin账号进入（建站默认admin用户拥有后台前台所有权限）\n\n有新消息，点击查看\n\n\n\n有效admin  cookie出来了。。。 content长度够长~~        看代码xss3：直接上问题code问题文件所在位置  \\hy\\bd_pics.php  5-33行\nfunction ReplaceHtmlAndJs($document){ $document = trim($document); if (strlen($document) <= 0) {  return $document; } $search = array (\"'<script[^>]*?>.*?</script>'si\",  // 去掉 javascript                  \"'<[\\/\\!]*?[^<>]*?>'si\",          // 去掉 HTML 标记                  \"'([\\r\\n])[\\s]+'\",                // 去掉空白字符                  \"'&(quot|#34);'i\",                // 替换 HTML 实体                  \"'&(amp|#38);'i\",                  \"'&(lt|#60);'i\",    //问题在这里                  \"'&(gt|#62);'i\",                  \"'&(nbsp|#160);'i\"                 );                    // 作为 PHP 代码运行 $replace = array (\"\",                   \"\",                   \"\\\\1\",                   \"\\\"\",                   \"&\",                   \"<\",    //恢复了实体                   \">\",                   \" \"                  ); return @preg_replace($search, $replace, $document);}\n这个函数写得挺纳闷，匹配 &lt;和&gt;然后替换成 实体 < > ...........这不是自己给自己设个套吗！！看看哪里调用    ReplaceHtmlAndJs在  hy\\member\\post_company.php 86-88看到\nif(!$postdb[qy_regmoney]) showerr_post(\"请输入公司注册资本\");\tif(!$postdb[content]) showerr_post(\"详细商家介绍不能为空\");\t$postdb[content]=nl2br($postdb[content]);\tif(!$postdb[qy_contact_tel]) showerr_post(\"指定联系人电话不能为空\");\tif(!$postdb[qy_contact]) showerr_post(\"指定联系人不能为空\");\tif(!$postdb[qy_contact_email]) showerr_post(\"指定联系人邮箱地址不能为空\");\tforeach($postdb as $key=>$val){//全部数据处理\t\t\t$postdb[$key]=ReplaceHtmlAndJs($val); //多处参数惨遭xss\t}\tif(!ereg(\"^[-a-zA-Z0-9_\\.]+\\@([0-9A-Za-z][0-9A-Za-z-]+\\.)+[A-Za-z]{2,5}$\",$postdb[qy_contact_email])){\t\tshowerr_post('邮箱不符合规则');\n我们来利用一下打后台。以普通注册用户身份  test登陆   然后创建商铺如图\n\n随便填一下参数，我们的目标是打后台。提交后burp抓包，修改postdb[title]参数 如下图\n\n查看发布情况可以发现存在前台xss  如下图\n\n那么怎么打后台呢，   我们用admin进后台 黄页店铺->店铺管理 即可  如下图\n\n\n\n打到有效admin  cookie  且长度为限制~   修复方案：  xss2修复：/member/pm.php  154-182\nelseif($job=='send'){\tif($step==2)\t{\t\t$rsdb=$userDB->get_passport($touser,'name');\t\tif(!$rsdb)\t\t{\t\t\tshowerr(\"当前用户不存在\");\t\t}\t\tif(!$title){\t\t\tshowerr(\"标题不能为空\");\t\t}\t\tif(strlen($array[title])>100){\t\t\tshowerr(\"标题太长了!\");\t\t}\t\t$array[touid]=$rsdb[uid];\t\t$array[fromuid]=$lfjuid;\t\t$array[fromer]=$lfjid;\t\t$array[title]=filtrate($title);\t\t\t\t//针对火狐浏览器做的处理\t\t$postdb[content] = str_replace(\"=\\\\\\\"../$webdb[updir]/\",\"=\\\\\\\"$webdb[www_url]/$webdb[updir]/\",$postdb[content]);\t\t$postdb[content]\t=\tpreg_replace('/javascript/i','java script',$postdb[content]);\t\t$postdb[content]\t=\tpreg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[content]);\t\t$array[content] = stripslashes($postdb[content]);\t\tpm_msgbox($array);\t\trefreshto(\"?job=list\",\"发送成功\",1);\t}\n正则形同虚设！   版权声明：转载请注明来源 Elliott@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-01-18 11:11 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}