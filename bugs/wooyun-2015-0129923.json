{"id": 66284, "wybug_id": "wooyun-2015-0129923", "wybug_title": "金蝶协同办公系统 GETSHELL漏洞", "wybug_corp": "金蝶", "wybug_author": "applychen", "wybug_date": "2015-07-29 09:10", "wybug_open_date": "2015-10-28 10:10", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-28：\t细节向公众公开  简要描述：  详细说明：  金蝶OA系统在web.xml中配置了一个servlet Connector，是基于旧版本的fckeditor，存在任意文件上传漏洞，配置如下：\n\ncom.fredck.FCKeditor.connector.ConnectorServlet.class反编译出主要代码如下：\npublic void doPost(HttpServletRequest request, HttpServletResponse response)    throws ServletException, IOException  {    ……    String commandStr = request.getParameter(\"Command\");    String typeStr = request.getParameter(\"Type\");    String currentFolderStr = request.getParameter(\"CurrentFolder\");    String currentPath = baseDir + typeStr + currentFolderStr;    String currentDirPath = getServletContext().getRealPath(currentPath);……    if (!commandStr.equals(\"FileUpload\")) {      retVal = \"203\";    } else {      DiskFileUpload upload = new DiskFileUpload();      try {        List items = upload.parseRequest(request);        Map fields = new HashMap();        Iterator iter = items.iterator();        while (iter.hasNext()) {          FileItem item = (FileItem)iter.next();          if (item.isFormField())            fields.put(item.getFieldName(), item.getString());          else            fields.put(item.getFieldName(), item);        }        FileItem uplFile = (FileItem)fields.get(\"NewFile\");        String fileNameLong = uplFile.getName();        fileNameLong = fileNameLong.replace('\\\\', '/');        String[] pathParts = fileNameLong.split(\"/\");        String fileName = pathParts[(pathParts.length - 1)];        String nameWithoutExt = getNameWithoutExtension(fileName);        String ext = getExtension(fileName);        File pathToSave = new File(currentDirPath, fileName);        int counter = 1;        while (pathToSave.exists()) {          newName = nameWithoutExt + \"(\" + counter + \")\" + \".\" + ext;          retVal = \"201\";          pathToSave = new File(currentDirPath, newName);          counter++;        }        uplFile.write(pathToSave);      } catch (Exception ex) {        retVal = \"203\";      }    }  ……  }  private static String getNameWithoutExtension(String fileName)  {    return fileName.substring(0, fileName.lastIndexOf(\".\"));  }private String getExtension(String fileName)  {    return fileName.substring(fileName.lastIndexOf(\".\") + 1);  }\n当Command参数为FileUpload时进行上传，最终服务器上生成的pathToSave文件名，由上传文件路径获得:\nc:\\a\\b.jsp => b.jsp\n可以看到整个过程是没有过滤后缀的。直接本地构造一个上传页面即可上传：\n\n得到webshell如下：http://202.104.120.18:7890/oa/uploadfiles/File/testabc.jsp金蝶官方协同办公系统测试地址：\nhttp://kdhr.kingdee.com/oa/login/k3oa.dohttp://202.104.120.18:7890/oa/\n搜索引擎中记录的，有些已经被getshell了：\nhttp://www.baidu.com/s?wd=inurl%3A%2Foa%2Fthemes%20inurl%3Ajsp&pn=0&oq=inurl%3A%2Foa%2Fthemes%20inurl%3Ajsp&tn=baiduhome_pg&ie=utf-8&rsv_idx=2&rsv_pq=fb5f291b0000049f&rsv_t=82d1fPuT2XOZBoyz9U23%2FZ%2Ft1VKbzrvhMO%2F2TBLPypK2rkEqqA7Xt0LZtkQw42tT1RMn\n   漏洞证明：  同上   修复方案：  取消Connector的映射，改用SimpleUploader   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-07-30 10:09 厂商回复： 谢谢对金蝶的关注，为我们发现安全漏洞。我们已通知相关部门修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}