{"id": 4049, "wybug_id": "wooyun-2014-056392", "wybug_title": "中国邮政某分站从目录遍历到服务器沦陷", "wybug_corp": "中国邮政集团公司信息技术局", "wybug_author": "超威蓝猫", "wybug_date": "2014-04-11 13:45", "wybug_open_date": "2014-05-26 13:46", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-26：\t细节向公众公开  简要描述： 中国邮政某分站从目录遍历到服务器沦陷 详细说明：  http://hotel.11185.cn/这个站看上去很简陋，而且服务端用的是IIS，于是习惯性地在地址栏敲了/admin\n\n一番搜寻，发现/admin/Image/Images.aspx或许可以上传文件。\n\n访问该页面马上就跳转到了/admin/Login.aspx。虽然跳转地很快但还是能看到原页面闪了一下，于是猜测是js控制的跳转。我们打开chrome的F12，禁用js后再访问这个页面就不会跳转啦。\n\n\n\n再看看上传图片的js段:天了噜居然是本地验证?\n$(\"#btnUpload\").click(function() {                var patn = /\\.jpg$|\\.jpeg$|\\.gif$|\\.png$/i;                var allowString = \"jpg,jpeg,gif,png\";                var wbproimage = document.getElementById(\"ImgPath\").value;                if (wbproimage.length > 0) {                    var index = wbproimage.lastIndexOf(\"\\\\\");                    var filename = wbproimage.substr(index + 1);                    if (!patn.test(filename)) {                        alert(\"图片格式不正确，只能上传以下图片格式：\" + allowString);                        return false;                    }                } else {                    alert(\"请选择图片地址!\");                    return false;                }\n我们传一个图片马，用burp抓包把后缀改成.asp看看:\n\n\n\n成功上传:\n\n但是图片被服务器压缩了，插入的一句话也被压没了..\n\n接着我又试了直接传不带图片头的一句话、png头的一句话、gif头、bmp头的都会被服务器压缩，天了噜我简直快绝望惹回到/admin/下看看还有没有什么东西，在/admin/old目录下居然发现了许多asp文件，日期还都是刚刚的，于是与刚才刚才测试的asp进行比对:\n\n\n\n咦文件大小怎么不一样呢?我怀疑/old目录下的是上传的原文件。菜刀连接，密码ws\n\n成功连接。系统补丁不及时 可以提权哦\n\n   漏洞证明：  如上。未做任何破坏。\n\n   修复方案：  虽然是外包的站，也没什么重要业务在上面，但都能getshell了如果还给10分那也太不够意思了吧=.=求礼物   版权声明：转载请注明来源 超威蓝猫@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-04-14 17:44 厂商回复： 谢谢，我们会联系相关负责人进行处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-26 13:51 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  我咋就没去看image.aspx呢。。。楼主够细心阿    \n     2014-06-12 03:30 |    \t\t风之子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 好好学习...囧)\t\t \n  居然直接就可以目录遍历，吓尿了-_-#    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}