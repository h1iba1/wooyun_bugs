{"id": 59897, "wybug_id": "wooyun-2013-045687", "wybug_title": "appcms评论xss绕过长度限制，可打后台", "wybug_corp": "appcms.cc", "wybug_author": "phith0n", "wybug_date": "2013-12-12 10:43", "wybug_open_date": "2014-03-09 10:44", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-17：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-09：\t细节向公众公开  简要描述： AppCMS前台评论功能可xss，但有长度限制（20字），以前一个漏洞给我启发可以绕过，直接打到后台，可打后台地址和管理员cookie。 详细说明：  comment.php 获得IP地址，并插入数据库：\n...（79行）    $fields['ip'] = helper :: getip();    if ($fields['parent_id'] != 0) {        $ress = $dbm -> query_update(\"UPDATE \" . TB_PREFIX . \"comment SET son = son + 1 WHERE comment_id = '{$fields['parent_id']}'\");    }     $res = $dbm -> single_insert(TB_PREFIX . 'comment', $fields);    if (empty($res['error']) && empty($ress['error'])) die('{\"code\":\"0\",\"msg\":\"恭喜发表成功\"}');    die('{\"code\":\"1\",\"msg\":\"发表失败：' . $ress['error'] . '\"}');\n获得IP的函数：\n/**     * 获取客户端IP地址     */    public static function getip() {        $onlineip = '';        if (getenv('HTTP_CLIENT_IP') && strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')) {            $onlineip = getenv('HTTP_CLIENT_IP');        } elseif (getenv('HTTP_X_FORWARDED_FOR') && strcasecmp(getenv('HTTP_X_FORWARDED_FOR'), 'unknown')) {            $onlineip = getenv('HTTP_X_FORWARDED_FOR');        } elseif (getenv('REMOTE_ADDR') && strcasecmp(getenv('REMOTE_ADDR'), 'unknown')) {            $onlineip = getenv('REMOTE_ADDR');        } elseif (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], 'unknown')) {            $onlineip = $_SERVER['REMOTE_ADDR'];        }        return $onlineip;　　}\n　　当HTTP_X_FORWARDED_FOR存在时获取的IP就是它，但是HTTP_X_FORWARDED_FOR是可以伪造的，所以造成了XSS代码的注入。　　但在数据库中，ip这个字段限制了字数，只有20字，所以绕过成为了难点。　　所以我们来构造。　　首先留一条言，内容是我们要写的xss代码，我这里就简单的弹出窗口：\n\n　　发表的时候抓包，修改X-FORWARDED-FOR，写半个闭合的script：\n\n　　然后刷新页面后再次写一条留言，内容就无所谓了，仍然是抓包，写前半个script标签：\n\n　　这时任务就算完成了，实战的话就坐等接收cookie和后台地址了。　　我们可以来到管理员页面 - 查看评论，可以看到窗口已经弹了：\n\n　　我们看看源码：\n\n　　看懂了吗，两次插入的内容正好闭合了，中间用注释符注释掉，然后第一次插入的评论内容就是我们的javascript代码，而这个代码的两遍用注释符再闭合掉就可以了。　　我们运用两次留言成功构造了一个xss，绕过了最大长度为20的限制。   漏洞证明：  已经在说明里说清楚了。\n\n   修复方案：  　　不使用X_FORWARDED_FOR来获取用户IP地址。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-03-09 10:44 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-18 11:16 |    \t\t丶潇洒哥 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 我是一枚农民工。)\t\t \n  厂商说了，无影响厂商忽略    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}