{"id": 659, "wybug_id": "wooyun-2014-069146", "wybug_title": "Ecmall的Sql注入第四弹", "wybug_corp": "ShopEx", "wybug_author": "′雨。", "wybug_date": "2014-07-21 11:18", "wybug_open_date": "2014-10-16 11:20", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-26：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向公众公开  简要描述： 又把20140618的补丁看了一看。  详细说明：  顺便把之前发的任意文件删除的确认了一下? 之前图片贴错了 现在更新过来了。这个绝对是从官网上刚下的20140618的补丁, 这次真的别再说618的补丁已经修复了。my_goods.app.php中\nfunction _upload_image($goods_id)    {        import('image.func');        import('uploader.lib');        $uploader = new Uploader();        $uploader->allowed_type(IMAGE_FILE_TYPE);        $uploader->allowed_size(SIZE_GOODS_IMAGE); // 400KB        /* 取得剩余空间（单位：字节），false表示不限制 */        $store_mod  =& m('store');        $settings      = $store_mod->get_settings($this->_store_id);        $upload_mod =& m('uploadedfile');        $remain        = $settings['space_limit'] > 0 ? $settings['space_limit'] * 1024 * 1024 - $upload_mod->get_file_size($this->_store_id) : false;        $files = $_FILES['new_file'];        foreach ($files['error'] as $key => $error)        {            if ($error == UPLOAD_ERR_OK)            {                /* 处理文件上传 */                $file = array(                    'name'            => $files['name'][$key],                    'type'            => $files['type'][$key],                    'tmp_name'  => $files['tmp_name'][$key],                    'size'            => $files['size'][$key],                    'error'        => $files['error'][$key]                );                $uploader->addFile($file);                if (!$uploader->file_info())                {                    $this->_error($uploader->get_error());                    return false;                }                /* 判断能否上传 */                if ($remain !== false)                {                    if ($remain < $file['size'])                    {                        $this->_error('space_limit_arrived');                        return false;                    }                    else                    {                        $remain -= $file['size'];                    }                }                $uploader->root_dir(ROOT_PATH);                $dirname      = 'data/files/store_' . $this->_store_id . '/goods_' . (time() % 200);                $filename  = $uploader->random_filename();                $file_path = $uploader->save($dirname, $filename);                $thumbnail = dirname($file_path) . '/small_' . basename($file_path);                make_thumb(ROOT_PATH . '/' . $file_path, ROOT_PATH . '/' . $thumbnail, THUMB_WIDTH, THUMB_HEIGHT, THUMB_QUALITY);                /* 处理文件入库 */                $data = array(                    'store_id'  => $this->_store_id,                    'file_type' => $file['type'],                    'file_size' => $file['size'],                    'file_name' => $file['name'],                    'file_path' => $file_path,                    'add_time'  => gmtime(),                );                $uf_mod =& m('uploadedfile');                $file_id = $uf_mod->add($data);\n重点看这里 \n$data = array(                    'store_id'  => $this->_store_id,                    'file_type' => $file['type'],                    'file_size' => $file['size'],                    'file_name' => $file['name'],                    'file_path' => $file_path,                    'add_time'  => gmtime(),                );\n  $file_id = $uf_mod->add($data)然后就直接带入到了add函数中\nforeach ($files['error'] as $key => $error)        {            if ($error == UPLOAD_ERR_OK)            {                /* 处理文件上传 */                $file = array(                    'name'            => $files['name'][$key],\n这里 $file['name'] 就是上传来的文件名。而且没做任何过滤就带入到了add函数中。files 变量无视gpc。来看看哪里调用了这函数 依旧在my_goods.app.php中\nfunction _save_post_data($data, $id = 0)    {        /* 保存商品 */        if ($id > 0)        {            // edit            if (!$this->_goods_mod->edit($id, $data['goods']))            {                $this->_error($this->_goods_mod->get_error());                return false;            }            $goods_id = $id;        }        else        {\n省略点\n/* 保存商品图片 */       if (!$this->_upload_image($goods_id))        {            return false;        }\n再看看哪里调用了。还是这文件\nfunction edit()    {        $id = empty($_GET['id']) ? 0 : intval($_GET['id']);        if (!IS_POST)        {            $this->assign('goods', $this->_get_goods_info($id));\n省略点\nelse        {            /* 取得数据 */            $data = $this->_get_post_data($id);            /* 检查数据 */            if (!$this->_check_post_data($data, $id))            {                $this->show_warning($this->get_error());                return;            }            /* 保存商品 */            if (!$this->_save_post_data($data, $id))//欧克这里终于调用了            {                $this->show_warning($this->get_error());                return;            }            $this->show_message('edit_ok',\n找到了调用这函数的地方 就来注入把。   漏洞证明：  \nPOST /web/ecmall/index.php?app=my_goods&act=edit&id=1 HTTP/1.1Host: web.com\n\n\n成功了。   修复方案：  转义了再入库把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-10-16 11:20 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-21 13:51 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  碎碎念。。。    \n     2014-07-21 17:01 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  楼上是二货    \n     2014-08-18 15:58 |    \t\t暗影侠客 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:5        | xss,inject,ctrf)\t\t \n  我也想看，可惜看不到    \n     2014-09-17 22:49 |    \t\tBloodwolf \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:8        | whoami)\t\t \n  碎碎念。。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}