{"id": 9510, "wybug_id": "wooyun-2013-033675", "wybug_title": "友宝自动贩卖机多处高危漏洞导致主控端+内部权限泄漏", "wybug_corp": "友宝在线", "wybug_author": "s0mun5", "wybug_date": "2013-08-07 14:03", "wybug_open_date": "2013-09-21 14:04", "wybug_type": "内部绝密信息泄漏", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-08-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-08-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-08-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-09-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-21：\t细节向公众公开  简要描述： 每次去友宝买饮料，都有那激动人心的游戏环节，是张根硕？是矿泉水还是珍珍？中奖到底是个什么算法？这个问题深深的埋在了一个少年的心底，让他走上了探索怎么免费喝饮料的不归路。 详细说明：  目测主站是没什么搞的，没有发现可利用的地方。然后对主站的c段进行扫描，发现了下列几个web系统http://service.uboxol.com/login/login   客服后台http://211.151.164.47/seeyon/index.jsp   OA系统http://211.151.164.78/index.php   仙人掌http://211.151.164.62/  站台app官网 目测又是一约炮神器http://neirong.uboxol.com/index.php   友乐汇后台http://vms.uboxol.com/ubox-vms/login.do  后台管理系统（核心系统）大致看一下，弱口令没得，嘛也找不到，放弃正面攻击。回到vms后台管理系统，发现版权后面有一个故障管理的链接，点进去\n\nhttp://124.127.89.53:8080/zentao/来到了禅道项目管理系统，弱口令没的，又是一个c段，又是一顿扫。http://124.127.89.57/   客户管理系统（CRM）https://124.127.89.49/   友宝统一账号密码修改http://124.127.89.51:8080/  目测是一个down脚本的地方down一个ubox-whitelist.wanup白名单脚本\niptables -I wanout -d 211.151.164.32/27 -j ACCEPTiptables -I wanout -d 124.127.89.48/28 -j ACCEPTiptables -I wanout -d 10.0.0.1 -j ACCEPTiptables -I wanout -d 10.0.0.254 -j ACCEPT\n友宝的ip段，跟我开始目测的124.127.89.47 -124.127.89.64211.151.164.1 -211.151.164.80差不多。既然这样，也就不再找新的ip段了，就在已经找到的系统上下功夫把。先是故障管理系统又目录遍历，但是没有找到任何有用的东西。http://124.127.89.53:8080/zentao/data/upload/1/然后。。卡住了那么多struts的系统，让我秒一个多好啊，可惜好像都补了。后来突然发现http://124.127.89.57/ 客户管理系统 是 .NET写的然后又神器的发现可以目录遍历，然后更神奇的发现是编译好的dll,果断全部脱下来反编译。先是抓包得到登陆的post地址是http://124.127.89.57/Login.ashx?&Type=Login然后源码里找到登陆模块。\n\n各位看官看明白了么，每天晚上7点到8点，返回-1如果cookie值里的account不为空，就执行select password from sys_user where ACCOUNT='\" + str9 + \"'\"活生生的把密码给select出来了。。当然是要用户名存在的情况下然后给你把用户名和密码显示在  \"❄\"  这朵菊花的两侧。。这朵菊花。。。最终利用方法就是修改http://124.127.89.57/Login.ashx?Type=Load的cookie 加上一个account为了方便，写了个php脚本进行中转http://localhost/zz.php?a=xxx a就是cookie中account的值用后来获得的一个用户名证明一下\n\n赤裸裸的菊花和密码就这么显示出来了想问我是怎么获得的用户名？注意上面的sql语句，这是个注入点！\n\n很开心有木有。注入后获得管理员账号是gly密码是1，对，就一个1。进入后台后发现毫无可利用的地方，只是一个管理和查询客户信息的后台。但是不要紧，这里的注入点给我们提供了宝贵的员工账号和密码资源。   漏洞证明：  有账号密码了怎么搞，当然是登陆最有可能有内部信息的地方，邮箱。挑了一些账号测试，发现几乎有一小半的账号密码能直接登陆邮箱，下面贴出一部分获得的信息，仅作为证明危害。\ndata.uboxol.com:8001组织:domID:admin密码:admin望账号：xa_songmengen期望账号密码:woaibaobao您的VMS后台账号已经建立。用户名： suyi密  码:  sy@2012账号zongjiajun 密码ubox1369新VMS后台访问地址：http://vms.uboxol.com:9080/ubox-vmsmengyan2012 mengyan2012mengyan邮箱 my430@#bj-haidao\thaidao@0828用户名：xuge密码:xg@2013地址：http://vs2.ubox.cn/ubox-vms/http://ubox-fms-tmp.uboxol.com/logins/toLogin  （盒饭管理系统，之前在扫描时没有发现）wenyong1ubox123新同事刘轩崇的账号已开通：企业邮箱用户名：liuxuanchong 密码：2013@ubox 登录地址为http://mail.ubox.cn/友宝统一账号：liuxuanchong 密码：2013@ubox 密码修改地址为http://password.ubox.cn杨炯内网技术组Add:北京市朝阳区亮马桥路39号第一上海中心C座6层 (100016)Tel: 5798 2456Email:yangjiong@ubox.cnlimulan企业邮箱用户名：yangguoqing 密码：2013@ubox 登录地址为http://mail.ubox.cn/友宝统一账号：yangguoqing 密码：2013@ubox 密码修改地址为http://password.ubox.cn同时，文件共享服务器启用，共享地址为\\\\192.168.8.6，请使用新的域帐号、密码进行登录，在用户名处输入ubox\\chenyang或者chenyang@ubox.cn 均可登录。目前“友宝总部”、“友宝北分”文件夹下尚未创建太多共享文件夹，有需要的部门或项目组请发邮件与我联系。内网技术组 陈洋各位好：       现请大家马上登陆新的客服系统。           （客服电话，这个比较犀利！！）       系统网址：http://119.254.230.74:32766/agent/  （建议在IE7-IE9浏览器下使用）       登陆密码及账号(分配的两个账号)：        第一个账号：       队列号码：200       电话分机: 801  （以电话机上的贴的标签为准）或按*61听取分机号码。       工号：1201       密码：1234         第二个账号：       队列号码：200       电话分机: 802  （以电话机上的贴的标签为准）或按*61听取分机号码。       工号：1202       密码：1234       系统的使用说明书，昨天已发过附件。               特别注意：       在退出客服系统时，不能直接将IE浏览器关闭。要点击系统中的退出系统按钮才可以。请大家牢记。\t   \t   \t   wangjiaren邮箱 wjr122400\t   chenxi tc6119\t   lishu kiki6011\t   zhuji 071217kkpajkklcz\n这些信息当时不是我的最终目的，我的目的是免费喝饮料，游戏必中将！通过分析一些信息后发现 VMS 后台是管理整个友宝网络的核心系统于是继续拿之前获得的账号登陆。成功进入一个高权限账号，顺便说一下，这个后台的权限控制很严，等级分明，比较赞。\n\n哈哈，运气比较好，已经可以直接喝免费饮料了\n\n随便改，可以控制全国任意一台友宝机器的价格，开售停售，等等等等，并且还可以直接下发文件，更新机器屏幕上显示的东西。尼玛，全国性的屏幕广告啊！！！！！！！！然后发现了一个不痛不痒的注入，对我来说不痛不痒，应为我没有获得任何有用的信息，不能执行子查询。\n\n不过，这个人的权限好像不是最高的，好想获得一个admin级别的账号，肿么办么。分析邮件发现，公司里经常会有员工申请开设某一模块的权限，刚才说过了，这个系统权限控制的非常严格。也就是说，超级管理员每天会登陆后台编辑用户权限，也就是说后台会存在一个用户列表。这又什么用呢？ 跨他！修改个人资料，\n\n这里js验证不能填写特殊字符，那么burp改包，在姓名里插入xss代码，果然没有过滤，截至执行。那么，等吧。一段时间过后，pia，cookie来了。\n\n原来权限控制是单独的后台。\n\n然后成功进入后台，最高权限账号，哇哈哈。\n\n现在终于可以舒舒坦坦的喝上免费饮料了，留后门什么的都不是问题。最后 附送一个盒饭管理系统\n\n\n\n问题比较多，能想到的比较严重的就这样了。目的已经达到了，就不再窥探内网了，到此为止。   修复方案：  测试过程中收集的数据已经全部销毁，不过，还是让员工统一改一次密码吧。对整个系统进行一次安全评估，乌云众测是个不错的方式。   版权声明：转载请注明来源 s0mun5@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-08-07 16:07 厂商回复： 非常感谢 s0mun5 ，我们正在积级处理此漏洞。可否留下您的联系方式。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-08-07 14:22 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  mark 又见硬件黑阔    \n     2013-08-07 14:23 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  估计忽略    \n     2013-08-07 14:25 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  忽略了就有福利了 哈哈    \n     2013-08-07 15:02 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  @VIP 没有，是搞了主控端，可以改全国几万台售货机的任意商品的价格，中奖几率等，还可以改售货机屏幕的显示内容，比那什么户外传媒牛逼多了    \n     2013-08-07 16:19 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  @友宝在线 你是张雄么    \n     2013-08-07 16:55 |    \t\txsjswt \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:49        | 我思故我猥琐，我猥琐故我强大)\t\t \n  非常感谢 s0mun5 ，我们正在积级处理此漏洞。可否留下您的联系方式,以便日后查水表用。    \n     2013-08-07 17:05 |    \t\t无敌L.t.H \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | ‮……肉肉捉活，亭长放解)\t\t \n  对于自助贩卖机，炮姐表示毫无压力。    \n     2013-08-07 19:46 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  畅饮礼物已经送到 :)    \n     2013-08-08 09:34 |    \t\tsecer \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 来乌云学习学习)\t\t \n  @s0mun5 效率这么高...    \n     2013-08-08 09:45 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  @s0mun5 畅饮是说随便你喝么    \n     2013-08-08 10:03 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  @s0mun5 畅饮是说随便你喝么    \n     2013-08-08 10:52 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  @secer @VIP @niliu 够我喝上几年的了    \n     2013-08-08 11:14 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  @s0mun5 哇.....好流弊    \n     2013-08-08 11:32 |    \t\tsun \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:12        )\t\t \n  @s0mun5 小心直接查水表~    \n     2013-08-29 11:03 |    \t\tfox \t\t\t( 普通白帽子  |\t\t\t        Rank:159 漏洞数:16        | fox)\t\t \n  @s0mun5 啥叫畅饮礼物啊？    \n     2013-09-15 14:44 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  @s0mun5 代码帝就是牛逼 直接反汇编.NET找注入，还碰见这么奇葩的查询语句，lucky!    \n     2013-09-21 14:38 |    \t\tsdj \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:6        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  good job!    \n     2013-10-31 01:41 |    \t\t姿势不行 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:7        | 我是爱卖萌的小阿狸呀http://www.qinqinyo....)\t\t \n  - -妹的 难怪我的shell全登不上了    \n     2013-11-16 23:00 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  非常感谢 s0mun5 ，我们正在积级处理此漏洞。可否留下您的联系方式,以便日后查水表用。    \n     2013-11-16 23:35 |    \t\t未来还没来 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | 每个人都期望成为主角，却不知道世界上从来...)\t\t \n  大牛。    \n     2013-11-17 00:19 |    \t\tMoogong \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:8        | 伪法医)\t\t \n  我擦 好赞！    \n     2013-12-31 20:33 |    \t\tJoker \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:6        | while(age++) {\tmake(rmb);\tif (outOf(...)\t\t \n  good fuck!    \n     2014-01-13 21:57 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  好牛逼的一次测试经历！    \n     2014-09-26 08:48 |    \t\tB1uH4ck \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 大牛们你们好，小弟刚来。)\t\t \n  @s0mun5 我想知道看源码那里，ashx文件是怎么看到源码的，非常不明白。    \n     2014-09-26 09:57 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  @B1uH4ck dll文件    \n     2014-09-26 13:16 |    \t\tB1uH4ck \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 大牛们你们好，小弟刚来。)\t\t \n  @s0mun5 没有webshell的话dll文件貌似也是不能下载的啊。    \n     2014-09-26 13:42 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  @B1uH4ck 配置不当的时候是可以下载的    \n     2014-11-05 18:09 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n   长姿势了 原来自动贩卖机是这样黑的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}