{"id": 26814, "wybug_id": "wooyun-2015-0103233", "wybug_title": "iOS URL Scheme劫持-在未越狱的iPhone 6(iOS 8.2)上盗取支付宝和微信支付的帐号密码", "wybug_corp": "苹果", "wybug_author": "蒸米", "wybug_date": "2015-03-23 15:48", "wybug_open_date": "2015-06-22 08:10", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": [], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-24：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向公众公开  简要描述： iOS URL Scheme劫持-在未越狱的iPhone 6(iOS 8.2)上盗取支付宝和微信支付的帐号密码 详细说明：  事先声明：1、该漏洞是iOS系统漏洞，和支付宝，微信app无关。本文只是拿支付宝和微信作为演示漏洞的应用，其他应用同样可以中招，转发者请勿断章取义。2、此漏洞是另一个漏洞，和“在非越狱的iPhone 6 (iOS 8.1.3) 上进行钓鱼攻击 (盗取App Store密码)”上利用的漏洞无关，本人不会干用一个漏洞写两个文章灌水的事情。该漏洞最早是由我在FireEye的同事hui, Song jin和lenx发现的，因为该漏洞利用简单，修复却非常复杂，所以在iOS 8.2上还是未能修复。虽然iOS尚未修复，但app本身还是可以有防护的方法，本人在文章最后会提出一些应急的解决方案以供开发人员参考。   漏洞证明：  首先来看demo: 在未越狱的iPhone6(iOS 8.2)上盗取支付宝帐号密码Youtube（需翻墙）: https://www.youtube.com/watch?v=p86Kv1uHO-s 腾讯视频: http://v.qq.com/page/p/d/s/p0149z3tgds.html在未越狱的iPhone6(iOS 8.2)上盗取微信支付密码Youtube（需翻墙）: https://www.youtube.com/watch?v=4SfCVGReyKI腾讯视频: http://v.qq.com/page/i/f/h/i0149uh43fh.htmlDEMO细节分析（支付宝）：在iOS上，一个应用可以将其自身”绑定”到一个自定义 URL Scheme 上，该 scheme 用于从浏览器或其他应用中启动该应用。这个设计非常类似于android上的broadcast和broadcast receiver，但远远没有android上的复杂。美团利用支付宝付款的整个过程如图一所示：美团首先将订单信息通过URL Scheme发送给Alipay，Alipay收到订单信息，调用支付界面，用户在Alipay上完成支付后，Alipay再发送一个URL Scheme给美团，美团收到付款信息后，显示团购成功的界面。但因为URL scheme这个机制太简单了，完全没有考虑有多个app声明同一个URL Scheme的情况，也没有权限管理之类的方案。在iOS官方说明中：“在多个应用程序注册了同一种URL Scheme 的时候，iOS 系统程序的优先级高于第三方开发程序。但是如果一种URL Scheme 的注册应用程序都是第三方开发的，那么这些程序的优先级关系是不确定的。”实际上，经过我们的测试，这个顺序是和Bundle ID有关的，如果精心构造Bundle ID，iOS总是会调用我们app的URL Scheme去接收相应的URL Scheme请求。那么问题来了，如果我们精心构造一个app并声明“alipay”这个URL Scheme会怎么样呢？结果就如demo中所演示的那样，后安装的FakeAlipay应用劫持了美团与支付宝之间的支付流程，并且可以在用户毫无意识情况下获取用户的帐号，支付密码，以及帮用户完成支付。整个过程如图二所示：FakeAlipay在收到美团发来的订单信息后，构造了一个和支付宝一样的登陆界面，用户在输入了帐号密码后，FakeAlipay会把帐号密码以及订单信息发送到黑客的服务器上，黑客在获得了这些信息后，可以在自己的iOS设备上完成支付，并把支付成功的URL Scheme信息发回给FakeAlipay，FakeAlipay再把支付成功的URL Scheme信息转发给美团。因为时间原因，demo做得比较粗糙，没有做转发信息给美团这一部分的演示，但绝对是可行的。这种攻击可以成功的原因除了iOS本身的漏洞外，支付宝也有一定的责任。那就是发给支付宝的订单信息并不是绑定当前设备的。因为这个原因，黑客可以在其他的iOS设备上完成支付。 同样是因为不绑定当前设备的问题，黑客甚至可以先在自己的设备上生成好订单，然后在用户打开支付宝支付的时候把订单替换掉，让用户给黑客的订单买单。DEMO细节分析（微信）：基本上和支付宝一样，不过支付时只需要提供6位支付密码，如果想要得到微信帐号密码的话，还需要构造一个假的登陆界面。当然了，你可能会说有短信验证，但是如果整个登录界面都是伪造的话，用户也会乖乖的帮你输入短信验证码的。并且，在iOS 8.1之前，iOS的短信也存在监控漏洞，具体请参考我们ASIACCS的论文。好吧，讲到这里肯定又有人说：你的漏洞是挺严重的，但还是得往我机器上装app啊。我从来不用什么pp助手，同步推之类的，也不装什么企业应用，平时只在AppStore上下载，因为有苹果的审核，所以我肯定不会中招的。呵呵，苹果的审核真的信得过么？请看第二个demo: Google Chrome URL Scheme劫持Youtube（需翻墙）: https://www.youtube.com/watch?v=uqZPelheVdM腾讯视频: http://v.qq.com/page/x/d/4/x0149k4red4.html 图三、Google Chrome URL Scheme劫持Google公司不比阿里差吧？Google Chrome可以算是Google在iOS上最重要的应用之一了吧？可惜的是，在该demo中Google公司的Chrome应用已经非常不幸的被App Store下载的app劫持掉了。如图三所示：演示用的app会利用Google Chrome的URL Scheme去打开Google.com这个网站。在机器上只安装Chrome的情况下，app会跳转到Chrome打开Google.com。但是当我们在App Store下载完一个叫BASCOM Browser的app之后，app却会跳转到BASCOM Browser打开Google.com。经过统计，App Store上有大量的应用声明了Chrome以及FaceBook的URL scheme，并且他们的开发者并不属于Google和Facebook。这说明Apple根本就没有保护那些热门应用的URL Scheme的想法，上传的App无论声明什么样的URL Scheme，苹果都会通过审核的。所以说，不光Chrome，Facebook有危险，支付宝，微信啥的也逃不过这一劫。2015/03/20 文章更新：刚说完支付宝，微信逃不过这一劫，我们已经在App Store上发现了劫持了支付宝的真实案例。来看demo: 战旗TV劫持支付宝URL SchemeYoutube（需翻墙）: https://www.youtube.com/watch?v=O4U3l1ffUiwYouku：http://v.youku.com/v_show/id_XOTE3NTc0MjM2.html当用户想要使用支付宝支付的时候，却跳转到了战旗TV。这里想问一下战旗TV，你到底想要干些什么呢？:-)   修复方案：  解决方案：1、针对iOS系统。因为Bundle ID在App Store上是唯一的（类似Android上的package name）苹果可以限制iOS应用不能注册别的应用的Bundle ID作为URL Scheme。这样的话，使用自己的Bundle ID作为URL Scheme的接收器就会变的安全很多。2、针对第三方应用。既然苹果不发布补丁保护第三方应用。第三方应用就没有办法了么？不是的，这里至少有两种方法可以检测自己应用的URL Scheme是否被Hijack：(1)、应用本身可以发送一条URL Scheme请求给自己，如果自己可以接收到的话，说明URL Scheme没有被劫持，如果不能收到的话，就说明被劫持了，这时候可以提醒用户卸载有冲突的app。代码如下：\n[[UIApplication sharedApplication] openURL:[NSURL URLWithString:@“alipay://test“]];\n(2)、利用MobileCoreServices服务中的applicationsAvailableForHandlingURLScheme()方法可以所有注册了该URL Schemes的应用和处理顺序，随后应用就可以检测自己，或者别人的URL Scheme是否被劫持了。代码如下：\nClass LSApplicationWorkspace_class = objc_getClass(\"LSApplicationWorkspace\");NSObject* workspace = [LSApplicationWorkspace_class performSelector:@selector(defaultWorkspace)];NSLog(@\"openURL: %@\",[workspace performSelector:@selector(applicationsAvailableForHandlingURLScheme:)withObject:@\"alipay\"]);\n 在任意app下运行这个函数，可以返回URL 处理的顺序，比如运行结果是：\n2015-03-18 15:34:37.695 GetAllApp[13719:1796928] openURL: (    \"<LSApplicationProxy: 0x156610010> com.mzheng.GetAllApp\",    \"<LSApplicationProxy: 0x1566101f0> com.mzheng.Alipay\",    \"<LSApplicationProxy: 0x15660fc30> com.alipay.iphoneclient\")\n说明有三个app都声名了alipay这个URL shceme，并且会处理这个请求的是\"com.mzheng.GetAllApp\"，而不是支付宝。PS: 各大公司是不是要开始推送iOS手机安全助手了？:-)   版权声明：转载请注明来源 蒸米@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-22 08:10 厂商回复： 互联网上已经公开,不评论不确认. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-23 15:50 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  关注一下    \n     2015-03-23 15:52 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  屌爆了    \n     2015-03-23 15:53 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  可以直接去知识库看详情咯    \n     2015-03-23 16:09 |    \t\t红客十年 \t\t\t( 普通白帽子  |\t\t\t        Rank:334 漏洞数:63        | 去年离职富士康，回到家中上蓝翔，蓝翔毕业...)\t\t \n  卧槽，火钳刘敏    \n     2015-03-23 16:10 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  前排留名    \n     2015-03-23 16:10 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  http://drops.wooyun.org/papers/5309    \n     2015-03-23 16:15 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  关注一下    \n     2015-03-23 16:46 |    \t\tfuzz-ing \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:21        | 闭关半年)\t\t \n  貌似很吊，留名关注    \n     2015-03-23 16:59 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  这个叼    \n     2015-03-23 17:16 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  我擦。deops那个    \n     2015-03-23 17:17 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  @浅蓝 广告28秒    \n     2015-03-23 17:55 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  这个时候就显示出来那些坑爹的app分发市场的重要性了    \n     2015-03-23 18:15 |    \t\ta6c \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:4        | ·̮̃·̃)\t\t \n  666    \n     2015-03-23 18:58 |    \t\tzph \t\t\t( 普通白帽子  |\t\t\t        Rank:235 漏洞数:43        )\t\t \n  作者厉害    \n     2015-03-23 19:32 |    \t\tleakless \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 今天我没吃药感觉自己萌萌哒~~)\t\t \n  央视记者拍这里。记得剃刀道歉的时候叫我一声。    \n     2015-03-23 20:38 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-03-23 21:13 |    \t\t暗羽 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:6        | 喵呜，给人类的智商跪了)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-03-23 21:32 |    \t\tmtfly \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:6        | 啥都不会)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-03-23 21:56 |    \t\t233 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | 小孩子看了根本把持不住)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。     \n     2015-03-23 22:47 |    \t\t机器猫 \t\t\t( 普通白帽子  |\t\t\t        Rank:1141 漏洞数:253        | 爱生活、爱腾讯、爱网络！)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-03-24 07:12 |    \t\t’‘Nome \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:19        | 在此感谢 @M4sk @mango @裤裆 @泳少 @5up3r...)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-03-24 09:48 |    \t\thkmm \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 世上女人千千万，实在不行天天换)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-03-24 09:59 |    \t\t红客十年 \t\t\t( 普通白帽子  |\t\t\t        Rank:334 漏洞数:63        | 去年离职富士康，回到家中上蓝翔，蓝翔毕业...)\t\t \n  不评论…不确认…用户安全何在    \n     2015-06-22 09:47 |    \t\tAll \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | 碰巧进乌云的小菜，)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n     2015-06-23 15:52 |    \t\t屠龙宝刀点击就送 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 简要介绍不能为空)\t\t \n  央视记者拍这里。 记得剃刀道歉的时候叫我一声。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}