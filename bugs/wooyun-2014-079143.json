{"id": 47956, "wybug_id": "wooyun-2014-079143", "wybug_title": "ThinkSNS SQL注射一枚(无视WAF)", "wybug_corp": "ThinkSNS", "wybug_author": "phith0n", "wybug_date": "2014-10-13 10:32", "wybug_open_date": "2015-01-11 10:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向公众公开  简要描述： 开发时候发现的。 详细说明：  apps/page/Lib/Action/DiyAction.class.php 192行：\npublic function doCopyTemplate() {\t\t$id = intval ( $_POST ['id'] );\t\t$page = $_POST ['page'];\t\t$channel = $_POST ['channel'];\t\t$databaseData = D ( 'Page' )->getPageInfo ( $page, $channel );\t\t$result = $this->checkRole ( $databaseData ['manager'], $databaseData );\t\tif ($result ['admin']) {\t\t\techo D ( 'pageTemplate' )->saveCopyAction ( $id, $this->mid, $page, $channel );\t\t} else {\t\t\techo - 1;\t\t}\t}\n取到$_POST['channel']传入getPageInfo函数。我们看看这个函数：\n/**\t * 返回页面详细信息\t * @param unknown_type $id\t * @param unknown_type $field\t * @return unknown\t */\tpublic function getPageInfo( $map , $field = 'id,page_name,domain,canvas,manager,status,guest,seo_title,seo_keywords,seo_description'){\t\t$data = $this->where($map)->field($field)->find();\t\treturn $data;\t}\n光看默认值就知道，第二个参数是字段名，甚至不用考虑addslashes。我们来试试，登录后发送如下数据包：\n\n看看mysql执行了什么语句：\n\n图中可以看到，我们可控的部分很多，从select 后面所有内容我们都可控。没有敏感词select，所以无视WAF。同样的方法在这个文件中还有多处，我就不一一指出。   漏洞证明：  来构造一个盲注。看到代码：\n$databaseData = D ( 'Page' )->getPageInfo ( $page, $channel );\t\t$result = $this->checkRole ( $databaseData ['manager'], $databaseData );\n$databaseData ['manager']传入了checkRole函数，进去看看：\nprivate function checkRole($user, $pageInfo) {\t\t$admin = false;\t\t$openDiy = false;\t\t$userModel = model ( 'UserGroup' );\t\t$user = explode( ',' , $user);\t\tif (in_array ( $this->mid, $user ) || $userModel->isAdmin ( $this->mid )) {\t\t\t$admin = true;\t\t} else {\t\t\t$this->error( '您没有管理权限！' );\t\t}\t\tif (isset ( $_GET ['diy'] ) && $pageInfo ['pageType'] != 'list') {\t\t\t$openDiy = true;\t\t}\t\t$this->assign ( 'openDiy', $openDiy );\t\t$this->assign ( 'admin', $admin );\t\t$result ['admin'] = $admin;\t\t$result ['openDiy'] = $openDiy;\t\treturn $result;\t}\n如果$this->mid（就是你的uid）在$user中，则通过，否则显示“您没有管理权限”。所以，通过是否显示“您没有管理权限”，可以来盲注。我的$this->mid为2。>113显示“找不到方法”：\n\n>114显示“您没有管理员权限”：\n\n同理，注入用户密码只要改user()为password即可。   修复方案：  不知道。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-10-13 14:14 厂商回复： 非常感谢！理论上首先要得到管理员权限。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-13 10:40 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  1楼    \n     2014-10-13 10:47 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  2楼    \n     2014-10-13 10:55 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  锟斤拷烫烫烫    \n     2014-10-13 10:56 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  开发时候发现的。。。    \n     2014-10-13 11:44 |    \t\tSunshie \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:10        | http://phpinfo.me)\t\t \n  66666    \n     2014-10-13 13:14 |    \t\terror \t\t\t( 普通白帽子  |\t\t\t        Rank:415 漏洞数:96        )\t\t \n  莫非又是t函数    \n     2014-10-13 14:27 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @ThinkSNS 这个注入并不需要管理员权限！我的mid=2并不是管理员，厂商你再看看，试试就知道了~    \n     2014-10-13 14:52 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  非常感谢!实践上首先要得到管理员权限。    \n     2014-10-13 15:08 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:40        | 我是残废，啦啦啦啦)\t\t \n  ph牛吊炸天    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}