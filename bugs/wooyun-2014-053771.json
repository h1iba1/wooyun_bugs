{"id": 3597, "wybug_id": "wooyun-2014-053771", "wybug_title": "Discuz! X2.5 / X3 / X3.1中CSRF攻击防御可被绕过", "wybug_corp": "Discuz!", "wybug_author": "kookxiang", "wybug_date": "2014-03-16 11:32", "wybug_open_date": "2014-06-14 11:32", "wybug_type": "CSRF", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["防护策略绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-14：\t细节向公众公开  简要描述： 写插件的时候偶然发现的...可绕过Discuz自带的CSRF攻击 详细说明：  discuz在判断表单时用这个函数：\nsubmitcheck('submit', true)\n其中第二个参数本来应该是是否允许GET请求的选项。在X2.5 / X3 / X3.1中，第二个参数为true时竟然不判断formhash直接return true了……使用批量搜索工具搜索discuz源代码里的submitcheck(*, *)……然后发现官方也用了这种写法，尿了尿了另外表示X2和之前的都没看过，不确定是否有问题。 我本地的X2.5 X3 X3.1这个文件基本都一样……   漏洞证明：  source/class/helper/helper_form.phpLine 22\nif($allowget || ($_SERVER['REQUEST_METHOD'] == 'POST' && !empty($_GET['formhash']) && $_GET['formhash'] == formhash() && empty($_SERVER['HTTP_X_FLASH_VERSION']) && (empty($_SERVER['HTTP_REFERER']) ||\t\t\tpreg_replace(\"/https?:\\/\\/([^\\:\\/]+).*/i\", \"\\\\1\", $_SERVER['HTTP_REFERER']) == preg_replace(\"/([^\\:]+).*/\", \"\\\\1\", $_SERVER['HTTP_HOST'])))) {\n当$allowget = TRUE时，后面整个括号就可以无视了   修复方案：  最简单的办法，修改下这个判断语句的逻辑吧   版权声明：转载请注明来源 kookxiang@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2014-03-17 16:48 厂商回复： allowget这个参数是用户无法控制的，只有当程序员认为这个功能不需要post方式提交和formhash校验的时候，才会使用allowget这个参数。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-03-16 12:55 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  前排收wb    \n     2014-03-16 13:01 |    \t\t耐小心 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:5        | 噗 我是新手 新手求罩)\t\t \n  mark    \n     2014-03-17 18:56 |    \t\tHUC缘生 \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:29        | 小白求罩~~~~)\t\t \n  围观    \n     2014-03-19 00:45 |    \t\tkookxiang \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:6        | 苦逼PHP程序猿…)\t\t \n  @xsser 能帮忙转移下楼上那行到漏洞说明么 = =    \n     2014-03-19 11:11 |    \t\tjhdxr \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | 这家伙很懒，所以。。。)\t\t \n  discuz给rank是出了名的吝啬。。。不忽略已经给很给面子了(→_→)    \n     2014-03-20 18:56 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @kookxiang 求细节...    \n     2014-03-22 19:12 |    \t\tkookxiang \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:6        | 苦逼PHP程序猿…)\t\t \n  @horseluke 发到微博那边了 = = 没注意乌云提醒    \n     2014-03-23 21:11 |    \t\tLooTan \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 拍黄片的大象派来的逗比)\t\t \n  新人求罩!    \n     2014-03-24 19:46 |    \t\tCoxxs \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:8        | 节操数:233 | ww)\t\t \n  新人求罩!    \n     2014-03-30 00:00 |    \t\ttensor \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 花式撸管，撸出美好明天。)\t\t \n  围观一下    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}