{"id": 36851, "wybug_id": "wooyun-2015-0100986", "wybug_title": "phpems多处水平权限漏洞可进行订单操作", "wybug_corp": "phpems", "wybug_author": "路人甲", "wybug_date": "2015-03-12 18:47", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-12：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： phpems多处水平权限漏洞可进行订单操作 详细说明：  3.网站多处存在平行权限漏洞存在漏洞的代码位置在/app/user/center.php的payfor()函数中public function payfor()\t{\t\t$subaction = $this->ev->url(3);\t\t$orderstatus = array(1=>'待付款',2=>'已完成',99=>'已撤单');\t\t$this->tpl->assign('orderstatus',$orderstatus);\t\tswitch($subaction)\t\t{\t\t\tcase 'remove':\t\t\t$oid = $this->ev->get('ordersn');\t\t\t$order = $this->order->getOrderById($oid);\t\t\tif($order['orderstatus'] == 1)\t\t\t{\t\t\t\t$this->order->delOrder($oid);\t\t\t\t$message = array(\t\t\t\t\t'statusCode' => 200,\t\t\t\t\t\"message\" => \"订单删除成功\",\t\t\t\t    \"callbackType\" => 'forward',\t\t\t\t    \"forwardUrl\" => \"reload\"\t\t\t\t);\t\t\t}\t\t\telse\t\t\t$message = array(\t\t\t\t'statusCode' => 300,\t\t\t\t\"message\" => \"订单操作失败\"\t\t\t);\t\t\texit(json_encode($message));\t\t\tbreak;\t\t\tcase 'orderdetail':\t\t\t$oid = $this->ev->get('ordersn');\t\t\tif(!$oid)exit(header(\"location:index.php?user-center\"));\t\t\t$order = $this->order->getOrderById($oid);\t\t\t$alipay = $this->G->make('alipay');\t\t\t$payforurl = $alipay->outPayForUrl($order,WP.'index.php?route=user-api-alipaynotify',WP.'index.php?route=user-api-alipayreturn');\t\t\t$this->tpl->assign('payforurl',$payforurl);\t\t\t$this->tpl->assign('order',$order);\t\t\t$this->tpl->display('payfor_detail');\t\t\tbreak;\t\t\tdefault:\t\t\tif($this->ev->get('payforit'))\t\t\t{\t\t\t\t$money = intval($this->ev->get('money'));\t\t\t\tif($money < 1)\t\t\t\t{\t\t\t\t\t$message = array(\t\t\t\t\t\t'statusCode' => 300,\t\t\t\t\t\t\"message\" => \"最少需要充值1元\"\t\t\t\t\t);\t\t\t\t\texit(json_encode($message));\t\t\t\t}\t\t\t\t$args = array();\t\t\t\t$args['orderprice'] = $money;\t\t\t\t$args['ordertitle'] = \"考试系统充值 {$args['orderprice']} 元\";\t\t\t\t$args['ordersn'] = date('YmdHi').rand(100,999);\t\t\t\t$args['orderstatus'] = 1;\t\t\t\t$args['orderuserid'] = $this->_user['sessionuserid'];\t\t\t\t$args['ordercreatetime'] = TIME;\t\t\t\t$args['orderuserinfo'] = array('username' => $this->_user['sessionusername']);\t\t\t\t$this->order->addOrder($args);\t\t\t\t$message = array(\t\t\t\t\t'statusCode' => 200,\t\t\t\t\t\"message\" => \"订单创建成功\",\t\t\t\t    \"callbackType\" => 'forward',\t\t\t\t    \"forwardUrl\" => \"index.php?user-center-payfor-orderdetail&ordersn=\".$args['ordersn']\t\t\t\t);\t\t\t\texit(json_encode($message));\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$page = $this->ev->get('page');\t\t\t\t$args = array();\t\t\t\t$args = \"orderuserid = '\".$this->_user['sessionuserid'].\"'\";\t\t\t\t$myorders = $this->order->getOrderList($args,$page);\t\t\t\t$this->tpl->assign('orders',$myorders);\t\t\t\t$this->tpl->display('payfor');\t\t\t}\t\t}\t}该函数switch中的前两个条件一个是用于删除订单，一个用于查看订单细节，进入具体代码case 'remove':\t\t\t$oid = $this->ev->get('ordersn');\t\t\t$order = $this->order->getOrderById($oid);//这里的提交oid可以由URL参数ordersn指定\t\t\tif($order['orderstatus'] == 1)\t\t\t{\t\t\t\t$this->order->delOrder($oid);\t\t\t\t$message = array(\t\t\t\t\t'statusCode' => 200,\t\t\t\t\t\"message\" => \"订单删除成功\",\t\t\t\t    \"callbackType\" => 'forward',\t\t\t\t    \"forwardUrl\" => \"reload\"\t\t\t\t);\t\t\t}\t\t\telse\t\t\t$message = array(\t\t\t\t'statusCode' => 300,\t\t\t\t\"message\" => \"订单操作失败\"\t\t\t);\t\t\texit(json_encode($message));\t\t\tbreak;\t\t\tcase 'orderdetail':\t\t\t$oid = $this->ev->get('ordersn');\t\t\tif(!$oid)exit(header(\"location:index.php?user-center\"));\t\t\t$order = $this->order->getOrderById($oid);//这里的oid也可以由URL参数ordersn指定\t\t\t$alipay = $this->G->make('alipay');\t\t\t$payforurl = $alipay->outPayForUrl($order,WP.'index.php?route=user-api-alipaynotify',WP.'index.php?route=user-api-alipayreturn');\t\t\t$this->tpl->assign('payforurl',$payforurl);\t\t\t$this->tpl->assign('order',$order);\t\t\t$this->tpl->display('payfor_detail');\t\t\tbreak;无论是删除订单还是查看订单细节他们的条件变量都是用户可控的，就是说可以在URL参数中人为指定，因而导致了平行权限的问题，直接结果就是可以遍历用户订单和删除任意用户订单。验证：注册两个用户，test和test1  test有一封订单，test1没有\n\n但现在以test1用户访问链接 \n\n可以看到test1用户看到了test用户的订单，OVER!   漏洞证明：  注册两个用户，test和test1  test有一封订单，test1没有\n\n但现在以test1用户访问链接 \n\n可以看到test1用户看到了test用户的订单，OVER!   修复方案：  增强逻辑验证起码加上_session[username]   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}