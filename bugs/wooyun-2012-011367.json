{"id": 17086, "wybug_id": "wooyun-2012-011367", "wybug_title": "深信服上网行为管理系统权限绕过", "wybug_corp": "深信服", "wybug_author": "an1k3r", "wybug_date": "2012-08-26 14:04", "wybug_open_date": "2012-10-10 14:05", "wybug_type": "网络设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["服务配置不当", "目录遍历", "应用敏感信息泄漏", "渗透测试思路", "运维管理不当", "内部敏感信息泄漏", "深信服", "管理员密码泄漏"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-08-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-08-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-09-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-09-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-09-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-10-10：\t细节向公众公开  简要描述： 深信服上网行为管理系统及广域网优化网关权限绕过，另外还包括VPN的一个漏洞。 详细说明：  本来在找常见的web漏洞，但是呢，无意间去看了一下apahce的配置文件。\n#    Alias /manual/ \"/virus/apache/apache/htdocs/manual/\"#    <Directory \"/virus/apache/apache/htdocs/manual\">#        Options Indexes FollowSymlinks -MultiViews -Indexes#        AllowOverride None#        Order allow,deny#        Allow from all#    </Directory>    Alias /file/ \"/\"\n看到这里汗了一下～  最后一行的意思是把系统根目录设置为file别名。 0.0  刚开始不太相信，以为是前面哪位大牛留的后门，但后来经过分析文件修改时间及其它版本的几个设备，推测应该不是。然后呢，就是这样了。能直接访问shadow，说明是root权限。\n\n但现在只是拿到了系统的shadow文件，只能暴力破解。所以我们需要先找到后台维护的密码。路径为：http://58.251.x.x:85/file/etc/updatemepasswd\n\n用后台维护软件连上去之后，用OD添加新的用户就可以了。命令是：\nuseradd -u 0 -o -g root -G root -d /tmp root4 -p \"cryptpass\"\n\n\n这样就添加了一个root4的账户，-p参数后的字符串必须是加密后的，这样写入shadow文件里后才能登录系统。\n\nWEB前台的密码是保存在ctrluser.ini文件里的，貌似用了sha1加密（具体不清楚，加密菜鸟一枚）。不过我们既然拿到root权限了，就直接将之替换为已知明文的密文即可。\n\n保存配置文件后，可以成功登录系统。\n\n目前测试有漏洞的上网行为管理系统的版本为\nAC2.0 http://125.33.*.*:85AC2.1 http://115.238.*.*:85AC3.5 http://60.2.*.*:85部分的AC4.01 http://58.251.*.*:85\n以及广域网优化产品的\nWANACC 6.0SP3 http://222.143.*.*:85WANACC 7.0SP1 http://58.251.*.*:85\n好了，接下来是VPN的简单绕过，不过有版本和其它一些限制。问题出在备份机制和BOA（类似于Apache的服务）的配置文件上。先说VPN的备份机制。在WEB管理界面里点击备份配置后，系统会将一些配置文件和带有用户信息的数据库加密并导出为一个bcf文件，类似于sangfor_all_20120825.bcf这样的格式。密码是不知道的，到这里应该没什么问题。但是呢，备份后系统会在stmp目录下保存一份没有经过加密的文件。我们再来看下BOA的配置文件是怎么写的。\n# Aliases: Aliases one path to another.# Example: Alias /path1/bar /path2/foo#Alias /doc /usr/docAlias /stmp /stmp # ScriptAlias: Maps a virtual path to a directory for serving scripts# Example: ScriptAlias /htbin/ /www/htbin/\n看到这里大家应该都知道了吧，是的，还是别名的问题，系统把stmp目录放在web目录下了。这样只要做过备份的系统，我们都可以就可以直接下载备份文件，不需要验证。\n\n将下载下来的cfgbk文件解压即可。解压后的db目录里有数据库的备份文件，数据库使用sqlite，里面保存了用户名，密码等信息。\n\n这样对只使用密码验证一种方式的用户来说，就可以直接连VPN了。\n\n所以呢，绕过权限需要满足的条件有1. 做过系统备份2. 目前测试有漏洞的版本为\nVPN 4.12VPN 4.21 VPN 4.30\n其实还有其它的系统如SC4.2、WANACC 7.0 SP1都有该漏洞，建议厂商自查一下。   漏洞证明：  在详细说明里了。另外，俺觉得把一些东西放在系统出厂之前做，比在实施环节要好。毕竟从研发层面把控也就是从源头把控，实施环节有太多不确定的因素，如客户或渠道因素等。这就比如一个网站有SQL注入漏洞，想的不是如果去修补这个漏洞，而是防火墙，WAF，IPS一股脑的往上堆，最后可能还是会被攻击。好了，俺只是在这里瞎掰，不用听俺的哈～  >.<   修复方案：  修改Apache，BOA配置文件及备份机制。另外，请提醒文中提到几个公司，其中几个有弱口令。   版权声明：转载请注明来源 an1k3r@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：13  确认时间：2012-08-26 14:05 厂商回复：  最新状态： 2012-08-31：感谢您的意见，我们确认后的情况如下：以上漏洞为已知漏洞，针对以上问题深信服已经发放过补丁包、自动升级包进行修正。出现以上情况应该是没有打上相应的补丁包或者没有自动升级导致的，建议用户尽快更新到最新版本。  ", "replys": "漏洞评价：\n评论\n     2012-08-26 14:33 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  威猛    \n     2012-08-26 14:47 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  管理员呢？这个加精啊    \n     2012-08-26 16:04 |    \t\tan1k3r \t\t\t( 普通白帽子  |\t\t\t        Rank:474 漏洞数:40        | 0.0)\t\t \n  @xsser 嘿嘿～    \n     2012-08-31 14:14 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @xsser  an1k3r是乌云中屈指可数的渗透大牛啊！你信不？    \n     2012-08-31 14:27 |    \t\txsjswt \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:49        | 我思故我猥琐，我猥琐故我强大)\t\t \n  忽略了，我操    \n     2012-08-31 15:06 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  牛淫!!    \n     2012-08-31 15:13 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @风萧萧 已经看到了 信！    \n     2012-08-31 15:34 |    \t\tPasser_by \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:21        | 问题真实存在但是影响不大（腾讯微博Passer...)\t\t \n  此贴必火！    \n     2012-09-03 18:40 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  坐等！    \n     2012-09-03 19:47 |    \t\tSZn \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | 雄鹰小时候也叫菜鸟！)\t\t \n  我这正好有一台，求细节！    \n     2012-09-03 19:50 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  奇怪，明明没有公布，怎么在对我公布的漏洞中啊，求解！    \n     2012-09-04 19:49 |    \t\tckaexn \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:2        | ~)\t\t \n  @qiaoy 好像公开过，又不知怎么关闭了    \n     2012-09-06 20:19 |    \t\tenter \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:4        | 127.0.0.1)\t\t \n  @qiaoy 我的也是。。。    \n     2012-09-07 09:07 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  @xsser 求解释。    \n     2012-09-07 10:11 |    \t\tzidane \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:2        | 噢 乖，你们应该明白 这样下去对我们谁都不...)\t\t \n  求看看    \n     2012-09-12 17:48 |    \t\tdyun \t\t\t( 普通白帽子  |\t\t\t        Rank:102 漏洞数:15        | [code][/code])\t\t \n  难道是wooyun的bug,我这显示也是对工公开，但明明没有公布...    \n     2012-09-12 18:27 |    \t\tdoosit \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | 木有介绍。)\t\t \n  这个是厂商要求屏蔽了的  百度可以搜索到快照    \n     2012-09-12 23:02 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @xsser 怎么还没有细节！1！    \n     2012-09-20 09:16 |    \t\tBreaker \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:1        )\t\t \n   我也是..    \n     2012-09-25 01:32 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  刚进来看了看，原来是特别照顾厂商了啊……这样这样    \n     2012-10-10 22:59 |    \t\tLeadUrLife \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:14        | 好好学习 天天向上)\t\t \n  又一强洞    \n     2012-10-11 09:22 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  洞主厉害！    \n     2012-10-11 09:32 |    \t\tl4mbda \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:3        | 嘘嘘)\t\t \n  @xsser 厂商确认时间大亮啊 是0啊    \n     2012-10-11 12:01 |    \t\t木易木兆 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:4        | 烧死异性恋！！！！！！！！！)\t\t \n  1970-02-15： 细节向公众公开    \n     2012-10-11 12:08 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @木易木兆 悲剧    \n     2012-10-11 14:10 |    \t\tl4mbda \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:3        | 嘘嘘)\t\t \n  好快啊 时间改过来了    \n     2012-10-11 14:11 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @l4mbda 嗯=。= 居然是0 奇怪了    \n     2012-10-12 10:18 |    \t\tzidane \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:2        | 噢 乖，你们应该明白 这样下去对我们谁都不...)\t\t \n  已知网关地址，如何能找到管理地址啊    \n     2012-10-12 10:33 |    \t\twebvul@sohu.com \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:13        | www.freebuf.com)\t\t \n  求细节    \n     2012-10-17 10:06 |    \t\tby_奇奇 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:7        | 2)\t\t \n  大牛大牛啊。，    \n     2013-01-09 14:25 |    \t\tSlcio \t\t\t( 实习白帽子  |\t\t\t        Rank:74 漏洞数:13        | 白帽)\t\t \n  安全设备厂商多数都有漏洞。。只是没有人去挖而已。。之前做过之类的测试。。所测产品都存在。。但是还和华为谈过设备安全测试培训。。只是懒得做对方要求太高。。    \n     2013-01-16 14:59 |    \t\thack2012 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:3        | 关注信息安全 http://www.waitalone.cn/)\t\t \n  很强大！！    \n     2013-01-25 15:20 |    \t\t我勒个去 \t\t\t( 实习白帽子  |\t\t\t        Rank:98 漏洞数:8        | 我勒个去)\t\t \n  @an1k3r ctrluser.ini的位置是？    \n     2013-07-31 23:14 |    \t\t花心 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 我是来找机油的。)\t\t \n  @an1k3r 我们公司就是深信服的系统希望大牛加我下 告诉我下详细情况我们公司的网络全部被限制掉了。悲催的无法上网啊    \n     2013-12-13 21:47 |    \t\twarrioj4 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 专注工具30年)\t\t \n  @花心 同求INI的位置    \n     2013-12-14 14:46 |    \t\twarrioj4 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 专注工具30年)\t\t \n  @花心 /etc/sinfor 加密方式现在未知 所以我也没办法替换成有效的加密字符串 估计洞主自己都没搞清楚加密方式    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 13, "Ranks": null}