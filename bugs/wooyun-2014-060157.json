{"id": 55707, "wybug_id": "wooyun-2014-060157", "wybug_title": "某通用cms未授权访问可添加管理员可拿shell", "wybug_corp": "郑州博望达计算机技术有限公司", "wybug_author": "nextdoor", "wybug_date": "2014-05-12 14:22", "wybug_open_date": "2014-08-10 14:24", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-12：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-08-10：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 某通用cms未授权访问可添加管理员可拿shell听说乌云通用漏洞奖钱了 详细说明：  1.简单描述    这个cms虽然在sql注入和xss漏洞上面的防御安全做的还不错。根据木桶原理网站是否安全取决于最短的那个木板。2.挖掘过程a.google一下，找到相关的网站Google语法 intext:技术支持：郑州博望达计算机技术有限公司如下图：\n\n有漏洞的网站，还有很多自己找http://www.zzbwd.com/wzl/admin_loginadd.asphttp://www.zzjntw.com/wzl/admin_loginadd.asphttp://www.hnyycs.com/wzl/admin_loginadd.asphttp://www.jtdny.com/wzl/admin_loginadd.asphttp://www.hnwzhf.cn/wzl/admin_loginadd.asphttp://www.zuoan168.com/wzl/admin_left.asphttp://www.zzzhuangji.com/wzl/admin_left.asphttp://www.yypep.com/wzl/admin_left.asphttp://www.hnxqjd.com/wzl/admin_left.asphttp://www.vorlon.cn/wzl/admin_left.asphttp://www.gsdaiban.com/wzl/admin_left.asphttp://www.hnmaosen.com/wzl/admin_left.aspb.下面的链接直接进入管理员添加页面，可以任意添加管理员http://www.zzjntw.com/wzl/admin_loginadd.asp添加的管理员成功了\n\nc.下面就是进入后台了,后台页面\n\n后台有很多拿shell的姿势，为了不破坏网站的正常运营，就用我们的FCKeditor编辑器截断修改文件夹名为xx.asp的IIS6的解析漏洞拿shell.过程如下:\n\n上传图片马,拿到webshell.\n\n   漏洞证明：  漏洞证明：下面我们分析一下他的/wzl/admin_loginadd.asp文件\n...... //无关代码省略<%If Action<>\"\" Then        //这是添加管理员的代码，进入asp文件时未进行有效的判断用户是否登录，没什么好解释的就是一个添加管理的页面。\tRs.Open\"Select * From [Admin] Where Cstr(ID)='\"&ID&\"' And UserName<>'wzl198511'\",Conn(),1,3\tIf Not Rs.Eof Then\t\tIf Action=\"Update\" Then       //添加管理员\t\t\tRs1.Open\"Select * From [Admin] Where UserName='\"&Request(\"UserName\")&\"' And Cstr(ID)<>'\"&ID&\"' And UserName<>'wzl198511'\",Conn(),1,1\t\t\tIf Not Rs1.Eof Then\t\t\t\tResponse.Write\"<script language='javascript'>\"\t\t\t\tResponse.Write\"alert('管理员不能重复!');\"\t\t\t\tResponse.Write\"location.href='?ID='+document.getElementById('ID').value;\"\t\t\t\tResponse.Write\"</script>\"\t\t\t\tResponse.End()\t\t\tElse\t\t\t\tRs(\"UserName\")=ClearHtml(Trim(Request(\"UserName\")))\t\t\t\tRs(\"Flag\")=Request(\"Flag\")\t\t\t\tIf Request(\"UserPas\")<>\"\" Then\t\t\t\t\tRs(\"UserPas\")=Md5(Request(\"UserPas\"))\t\t\t\tEnd If\t\t\t\tRs(\"QuanXian\")=Request(\"QuanXian\")\t\t\t\tRs(\"Date\")=Date()\t\t\t\tRs.Update\t\t\t\tResponse.Write\"<script language='javascript'>\"\t\t\t\tResponse.Write\"alert('修改成功!');\"\t\t\t\tResponse.Write\"location.href='?';\"\t\t\t\tResponse.Write\"</script>\"\t\t\t\tResponse.End()\t\t\tEnd If\t\t\tRs1.Close:Set Rs1=Nothing\t\tElseIf Action=\"Del\" Then\t\t\tRs.Delete\t\t\tResponse.Write\"<script language='javascript'>\"\t\t\tResponse.Write\"location.href='?';\"\t\t\tResponse.Write\"</script>\"\t\t\tResponse.End()\t\tEnd If\tElse\t\tRs1.Open\"Select * From [Admin] Where UserName='\"&Request(\"UserName\")&\"' And UserName<>'wzl198511'\",Conn(),1,1\t\tIf Not Rs1.Eof Then\t\t\tResponse.Write\"<script language='javascript'>\"\t\t\tResponse.Write\"alert('管理员已经存在!');\"\t\t\tResponse.Write\"location.href='?';\"\t\t\tResponse.Write\"</script>\"\t\t\tResponse.End()\t\tElse\t\t\tRs.Addnew\t\t\tRs(\"UserName\")=ClearHtml(Trim(Request(\"UserName\")))\t\t\tRs(\"UserPas\")=Md5(Request(\"UserPas\"))\t\t\tRs(\"Flag\")=Request(\"Flag\")\t\t\tRs(\"QuanXian\")=Request(\"QuanXian\")\t\t\tRs(\"Date\")=Now()\t\t\tRs.Update\t\t\tResponse.Write\"<script language='javascript'>\"\t\t\tResponse.Write\"alert('添加成功!');\"\t\t\tResponse.Write\"location.href='?';\"\t\t\tResponse.Write\"</script>\"\t\t\tResponse.End()\t\tEnd If\t\tRs1.Close:Set Rs1=Nothing\tEnd If\tRs.Close:Set Rs=NothingEnd If%>......//无关代码省略\n在login_left.asp中也存在这样的问题，还有很多的后台文件\n<%       //同上一个文件存在同样的问题Rs.Open\"Select * From Bs_PrBigClass Where Type='link'  Order By [Order] Asc\",Conn(),1,1For i=1 To Rs.Recordcount\tIf Rs.Eof Then Exit For%>  <tr class=\"display2\" >    <td width=\"50%\" height=\"30\" align=\"center\"><%=Rs(\"BigClassName\")%></td>    <td width=\"25%\" height=\"30\" align=\"center\"><a href=\"add_link.asp?Type=<%=Rs(\"BigClassID\")%>&Title=<%=Rs(\"BigClassName\")%>&PicDisplay=<%=Rs(\"Pic\")%>&C=<%=Rs(\"Type\")%>\" target=\"right\">发布</a></td>    <td width=\"25%\" align=\"center\"><a href=\"link_list.asp?Type=<%=Rs(\"BigClassID\")%>&Title=<%=Rs(\"BigClassName\")%>&PicDisplay=<%=Rs(\"Pic\")%>&C=<%=Rs(\"Type\")%>\" target=\"right\">管理</a></td>  </tr>  <%Rs.MovenextNextRs.Close%>  <tr class=\"display\">  \t\t<td height=\"30\" align=\"center\"><a href=\"Class2.asp?Type=link&Title=新闻分类\" target=\"right\"  >新闻分类</a></td>  \t\t<td height=\"30\" colspan=\"2\" align=\"center\">&nbsp;</td>  </tr></table><table width=\"160\"  border=\"1\" cellpadding=\"1\" cellspacing=\"1\"   borderColorLight=#c89f7b   borderColorDark=#f8f8f8  class=\"Title1\" style=\"display:none;\"  >  <tr>    <td class=menu_title onclick=menuclick(menuTitleother) height=30 align=\"center\"><strong>其它分类</strong></td>  </tr></table><table width=\"160\" border=1 cellpadding=\"1\"  cellspacing=\"1\"  borderColorLight=#c89f7b   borderColorDark=#ffffff  class=\"Title2\"  id=\"menuTitleother\"  style=\"display:none;\">  <tr>    <td width=\"100%\" height=\"30\" align=\"center\" colspan=\"3\"><%Set Rs1=Conn2.Execute(\"Select * From Bs_PrBigClass Where Type='Other' Order By [Order] Asc\")Do While Not Rs1.Eof%>\t\t<div style=\"width:49%;float:left;height:25px;line-height:25px;text-align:left;margin-left:1px;margin-bottom:1px;background:#f8f8f8;\"><a href=\"class2.asp?Type=<%=Rs1(\"BigClassID\")%>&Title=<%=Rs1(\"BigClassName\")%>&PicDisplay=<%=Rs1(\"Pic\")%>&C=<%=Rs1(\"Type\")%>\" target=\"right\"><%=Rs1(\"BigClassName\")%></a></div>  <%Rs1.MovenextLoopRs1.Close%><div style=\"width:49%;float:left;height:25px;line-height:25px;text-align:center;\"><a href=\"Class2.asp?Type=Other&Title=其它分类\" target=\"right\"  >分类管理</a></div>       </td>  </tr></table>  <%Set Rs1=Conn2.Execute(\"Select * From Bs_PrBigClass Where Type='News' Order By [Order] Asc\")Do While Not Rs1.Eof%><table width=\"160\"  border=\"1\" cellpadding=\"1\" cellspacing=\"1\"   borderColorLight=#c89f7b   borderColorDark=#f8f8f8  class=\"Title1\"  >  <tr>    <td class=menu_title onclick=menuclick(menuTitle<%=Rs1(\"BigClassID\")%>) height=30 align=\"center\"><strong><%=Rs1(\"BigClassName\")%></strong></td>  </tr></table><table width=\"160\" border=1 cellpadding=\"1\"  cellspacing=\"1\"  borderColorLight=#c89f7b   borderColorDark=#ffffff  class=\"Title2\"  id=\"menuTitle<%=Rs1(\"BigClassID\")%>\">  <%  Small Rs1(\"BigClassID\"),Rs1(\"BigClassName\")Rs2.Open\"Select * From Bs_PrBigClass Where Type='link\"&Rs1(\"BigClassID\")&\"'  Order By [Order] Asc\",Conn(),1,1For j=1 To Rs2.Recordcount\tIf Rs2.Eof Then Exit For%>  <tr>    <td width=\"50%\" height=\"30\" align=\"center\"><%=Rs2(\"BigClassName\")%></td>    <td width=\"25%\" height=\"30\" align=\"center\"><a href=\"add_link.asp?Type=<%=Rs2(\"BigClassID\")%>&Title=<%=Rs2(\"BigClassName\")%>&PicDisplay=<%=Rs2(\"Pic\")%>&C=<%=Rs2(\"Type\")%>\" target=\"right\">发布</a></td>    <td width=\"25%\" align=\"center\"><a href=\"link_list.asp?Type=<%=Rs2(\"BigClassID\")%>&Title=<%=Rs2(\"BigClassName\")%>&PicDisplay=<%=Rs2(\"Pic\")%>&C=<%=Rs2(\"Type\")%>\" target=\"right\">管理</a></td>  </tr>  <%Rs2.MovenextNextRs2.Close......%>\n   修复方案：  修复的方法1.通过服务器路径和提交的路径进行比较如下：Request.ServerVariables(\"Http_Host\")得到的是www.doman.com:8000 Request.ServerVariables(\"Server_Name\")得到的是www.doman.com 这样可以防止外部提交的数据，但是它的一个缺点就是必须在服务器上。\n<server_v1=Cstr(Request.ServerVariables(\"HTTP_REFERER\"))'本地路径server_v2=Cstr(Request.ServerVariables(\"SERVER_NAME\"))'服务器路径if mid(server_v1,8,len(server_v2))<>server_v2 thenresponse.write (\"<table cellSpacing=0 borderColorDark=#ffffff cellPadding=0  width=600 align=center borderColorLight=#c89f7b border=1>\")response.write  (\"<tr align=center>\")response.write    (\"<td height=36>你提交的路径有误，禁止从站点外部提交数据,请关闭窗口！</td>\")response.write  (\"</tr>\")response.write (\"<tr align=center>\")response.write (\"<form><td height=30>\")response.write (\"<INPUT TYPE='BUTTON' value='关闭窗口' onClick='window.close()'> \")response.write (\"</td></form>\")response.write (\"</tr>\")response.write (\"</table>\")response.endend if\n2.判断用户登陆后session进行判断是否登陆。\n<%If Session(\"XUserName\")=\"\" or Session(\"XPassword\")=\"\" then Response.Write \"<script>alert('系统提示：您没有登陆。');location='/wzl/admin_login.asp'</script>\"End If%>\n   版权声明：转载请注明来源 nextdoor@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-05-12 20:21 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  @xsser 为什么这个通用漏洞不提交给cncert呢    \n     2014-08-24 14:52 |    \t\tEvil卍 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        )\t\t \n  洞主收到钱了吗    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}