{"id": 56981, "wybug_id": "wooyun-2014-055673", "wybug_title": "Yungoucms 一元团购 Getshell 一枚", "wybug_corp": "yungoucms.com", "wybug_author": "′雨。", "wybug_date": "2014-04-07 17:40", "wybug_open_date": "2014-07-03 17:41", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-12：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-03：\t细节向公众公开  简要描述： 无需登录。 详细说明：  在install目录下 check.php  finish.php 在一开始都检测了lock 可是在setconf.php 中 是在后面才检测的lock。在setconf.php中\nif(isset($_POST['edit'])){\t$db_host = isset($_POST['db_host']) ? trim($_POST['db_host']) : '';\t$db_user = isset($_POST['db_user']) ? trim($_POST['db_user']) : '';\t$db_pwd = isset($_POST['db_pwd']) ? trim($_POST['db_pwd']) : '';\t$db_name = isset($_POST['db_name']) ? trim($_POST['db_name']) : '';\t$db_prefix = isset($_POST['db_prefix']) ? trim($_POST['db_prefix']) : '';\t$user_name = isset($_POST['user_name']) ? trim($_POST['user_name']) : '';\t$sqm_num= isset($_POST['sqm_num']) ? trim($_POST['sqm_num']) : '';\t$password = isset($_POST['password']) ? trim($_POST['password']) : '';\t$repassword = isset($_POST['repassword']) ? trim($_POST['repassword']) : '';\t$conn = mysql_connect($_POST['db_host'],$_POST['db_user'],$_POST['db_pwd']);\t$conn_db = mysql_select_db($_POST['db_name'],$conn);\tif(!$conn){\t\techo \"数据库主机或数据库用户名或数据库密码错误!\";exit;\t}elseif(!$conn_db){\t\techo '数据库名称!';exit;\t}elseif($db_name == ''){\t\techo '数据库不能为空!';exit;\t}elseif($db_prefix == ''){\t\techo '数据库前缀不能为空!';exit;\t}elseif(!preg_match(\"/^[\\w_]+_$/\",$db_prefix)){\t\techo '数据库前缀格式错误!';exit;\t}elseif($user_name == '' || $password == ''){\t\techo '登录名和密码不能为空!';exit;\t}elseif(strlen($password) < 6){\t\techo '登录密码不得小于6位';exit;\t}elseif($password!=$repassword){\t\techo '两次输入的密码不一致';exit;\t}\t$config_file='../system/config/database.inc.php';\t\t$con =\"<?php\\r\\n\\r\\n\";\t$con .= \"return array(\\r\\n\";\t\t$con .= \"\\t'default' => array (\\r\\n\\t\";\t\t\t$con .= \"\\t'hostname' => '\".$db_host.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'database' => '\".$db_name.\"',\";                \t\t\t$con .= \"\\r\\n\\t\\t'username' => '\".$db_user.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'password' => '\".$db_pwd.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'tablepre' => '\".$db_prefix.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'charset' => 'utf8',\";\t\t\t$con .= \"\\r\\n\\t\\t'type' => 'mysql',\";\t\t\t$con .= \"\\r\\n\\t\\t'debug' => true,\";\t\t\t$con .= \"\\r\\n\\t\\t'pconnect' => 0,\";\t\t\t$con .= \"\\r\\n\\t\\t'autoconnect' => 0\";\t\t$con .= \"\\r\\n\\t),\";\t$con .= \"\\r\\n);\\r\\n?>\";\tfile_put_contents($config_file,$con);\t\t\tif(!empty($sqm_num)){\t\t\t\t$sqm_file='../system/config/code.inc.php';\t\t$sqm=\"<?php return array('code'=>'$sqm_num'); ?>\";\t\tfile_put_contents($sqm_file,$sqm);\t\t\t}\t\t$conn = @mysql_connect($_POST['db_host'],$_POST['db_user'],$_POST['db_pwd']);\t\t\t mysql_select_db($_POST['db_name'],$conn);\tmysql_query(\"set names utf8\");\t\t$sql = file_get_contents(\"install.sql\");\t$sql = str_replace('DROP TABLE IF EXISTS `',\"DROP TABLE IF EXISTS `\".$_POST['db_prefix'],$sql);\t$sql = str_replace('CREATE TABLE `',\"CREATE TABLE `\".$_POST['db_prefix'],$sql);\t$sql = str_replace('INSERT INTO `',\"INSERT INTO `\".$_POST['db_prefix'],$sql);\t$sql = str_replace('IF EXISTS `',\"IF EXISTS `\".$_POST['db_prefix'],$sql);\t$array_sql = preg_split(\"/;[\\r\\n]/\",$sql);\t$query_sql_g=true;\techo \"<h3 style='text-align:center; line-height:50px; font-weight:bold'><font color='#0c0'>正在安装中...请不要结束本页面！</font></h3><br/>\";\techo \"<div style='text-align:center;width:100%'>\";\t\tif(strlen(end($array_sql)) == 2){\t\t\t\t\tarray_pop($array_sql);    }\t$ik = 0;\tforeach($array_sql as $sql){\t\t$sql = trim($sql);\t\t\t\tif (!empty($sql) && strlen($sql) != 2){\t\t\t$query_sql = mysql_query($sql,$conn);\t\t\tif(!$query_sql){\t\t\t\tif($ik%9==0){\t\t\t\t\techo \"<br/>\";\t\t\t\t}\t\t\t\techo $sql.\"<font color='red'>SQL 执行失败！</font>\";$ik++;\t\t\t}else{\t\t\t\tif($ik%9==0){\t\t\t\t\techo \"<br/>\";\t\t\t\t}\t\t\t\techo \"【SQL执行成功!】\";$ik++;\t\t\t}\t\t}\t\t\t}\t\t$password=md5(trim($password));\t$sql = \"INSERT INTO `\".$db_prefix.\"admin` (uid,mid,username,userpass) VALUES ('1','0','$user_name','$password')\";\t$q = mysql_query($sql,$conn);\tif(!$q){\t\t\t\t\techo $sql.\"<font color='red'>【添加管理员失败】</font>\";$ik++;\t}else{\t\techo \"【添加管理员成功】\";$ik++;\t}\techo \"</div>\";\t\tif(!$query_sql_g){\t\techo \"<br/><h3 style='text-align:center; line-height:50px; font-weight:bold'><font color='red'>数据库安装失败,请清空数据库后重新安装！</font></h3><br/>\";\t}else{\t\techo \"<br/><h3 style='text-align:center; line-height:50px; font-weight:bold'><a style='color:#f60' href='finish.php'>安装完成，点击进入！</a></h3><br/>\";\t}\texit;}if(file_exists(\"ok.lock\")){\techo \"程序已经安装过\";\techo \"<br>\";\techo \"重新安装请删除,install 文件夹下的 <font color='red'>ok.lock</font> 文件\";\texit;}\n可以看到 是在后面才check  lock。  那我们在check lock之前找找利用的。\n$config_file='../system/config/database.inc.php';\t\t$con =\"<?php\\r\\n\\r\\n\";\t$con .= \"return array(\\r\\n\";\t\t$con .= \"\\t'default' => array (\\r\\n\\t\";\t\t\t$con .= \"\\t'hostname' => '\".$db_host.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'database' => '\".$db_name.\"',\";                \t\t\t$con .= \"\\r\\n\\t\\t'username' => '\".$db_user.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'password' => '\".$db_pwd.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'tablepre' => '\".$db_prefix.\"',\";\t\t\t$con .= \"\\r\\n\\t\\t'charset' => 'utf8',\";\t\t\t$con .= \"\\r\\n\\t\\t'type' => 'mysql',\";\t\t\t$con .= \"\\r\\n\\t\\t'debug' => true,\";\t\t\t$con .= \"\\r\\n\\t\\t'pconnect' => 0,\";\t\t\t$con .= \"\\r\\n\\t\\t'autoconnect' => 0\";\t\t$con .= \"\\r\\n\\t),\";\t$con .= \"\\r\\n);\\r\\n?>\";\tfile_put_contents($config_file,$con);\n可以看到 这里直接写到了配置文件中 \n}elseif(!preg_match(\"/^[\\w_]+_$/\",$db_prefix)){\t\techo '数据库前缀格式错误!';exit;\n这个正则了。  无法利用了。   host肯定是不能改的。 因为需要连接上去。db_name 也需要存在在这个mysql中。   漏洞证明：  首先利用这个漏洞 是需要自己去搭建一个mysql环境 而不是需要拿到网站的mysql权限。\n\n首先建立一个用户。 因为帐号的话是有长度限制的 就用密码来。然后提交 \n\n来看看配置文件 \n\n\n\nGetshell成功。   修复方案：  Lock放前。求不忽略。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-03 17:41 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-12 17:46 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  擦  又忽略 @云购cms    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}