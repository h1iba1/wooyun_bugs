{"id": 82011, "wybug_id": "wooyun-2015-0152291", "wybug_title": "PHPCMS设计缺陷可重置前台任意用户密码", "wybug_corp": "phpcms", "wybug_author": "loopx9", "wybug_date": "2015-11-06 12:39", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 验证逻辑设计缺陷. 详细说明：  \\phpcms\\modules\\member\\index.php:\n//通过用户名找回密码\tpublic function public_forget_password_username() {\t\t$step = intval($_POST['step']);\t\t$step = max($step,1);\t\t$this->_session_start();\t\t\t\tif(isset($_POST['dosubmit']) && $step==2) {\t\t//处理提交申请，以手机号为准\t\t\tif ($_SESSION['code'] != strtolower($_POST['code'])) {\t\t\t\tshowmessage(L('code_error'), HTTP_REFERER);\t\t\t}\t\t\t$username = safe_replace($_POST['username']);\t\t\t$r = $this->db->get_one(array('username'=>$username),'userid,email');\t\t\tif($r['email']=='') {\t\t\t\t$_SESSION['userid'] = '';\t\t\t\t$_SESSION['code'] = '';\t\t\t\tshowmessage(\"该账号没有绑定手机号码，请选择其他方式找回！\");\t\t\t} else {\t\t\t\t$_SESSION['userid'] = $r['userid'];\t\t\t\t$_SESSION['email'] = $r['email'];\t\t\t}\t\t\t$email_arr = explode('@',$r['email']);\t\t\tinclude template('member', 'forget_password_username');\t\t} elseif(isset($_POST['dosubmit']) && $step==3) {\t\t\t$sms_report_db = pc_base::load_model('sms_report_model');\t\t\t$mobile_verify = $_POST['mobile_verify'];\t\t\t$email = $_SESSION['email'];\t\t\tif($email){\t\t\t\tif(!preg_match('/^([a-z0-9_]+)@([a-z0-9_]+).([a-z]{2,6})$/',$email)) exit('check email error');\t\t\t\tif($_SESSION['emc_times']=='' || $_SESSION['emc_times']<=0){\t\t\t\t\tshowmessage(\"验证次数超过5次,验证码失效，请重新获取邮箱验证码！\",HTTP_REFERER,3000);\t\t\t\t}\t\t\t\t$_SESSION['emc_times'] = $_SESSION['emc_times']-1;\t\t\t\tif($_SESSION['emc']!='' && $_POST['email_verify']==$_SESSION['emc']) {\t\t\t\t\t\t\t\t\t\t$userid = $_SESSION['userid'];\t\t\t\t\t$updateinfo = array();\t\t\t\t\t$password = random(8,\"23456789abcdefghkmnrstwxy\");\t\t\t\t\t$encrypt = random(6,\"23456789abcdefghkmnrstwxyABCDEFGHKMNRSTWXY\");\t\t\t\t\t$updateinfo['encrypt'] = $encrypt;\t\t\t\t\t$updateinfo['password'] = password($password, $encrypt);\t\t\t\t\t\t\t\t\t\t$this->db->update($updateinfo, array('userid'=>$userid));\t\t\t\t\t$rs = $this->db->get_one(array('userid'=>$userid),'phpssouid');\t\t\t\t\tif(pc_base::load_config('system', 'phpsso')) {\t\t\t\t\t\t//初始化phpsso\t\t\t\t\t\t$this->_init_phpsso();\t\t\t\t\t\t$this->client->ps_member_edit('', '', '', $password, $rs['phpssouid'], $encrypt);\t\t\t\t\t}\t\t\t\t\t$_SESSION['email'] = '';\t\t\t\t\t$_SESSION['userid'] = '';\t\t\t\t\t$_SESSION['emc'] = '';\t\t\t\t\t$_SESSION['code'] = '';\t\t\t\t\tpc_base::load_sys_func('mail');\t\t\t\t\tsendmail($email, '密码重置通知', \"您在\".date('Y-m-d H:i:s').\"通过密码找回功能，重置了本站密码。\");\t\t\t\t\tinclude template('member', 'forget_password_username');\t\t\t\t\texit;\t\t\t\t} else {\t\t\t\t\tshowmessage(\"验证码错误！请重新获取！\",HTTP_REFERER,3000);\t\t\t\t}\t\t\t} else {\t\t\t\tshowmessage(\"非法请求！\");\t\t\t}\t\t} else { \t\t\tinclude template('member', 'forget_password_username');\t\t}\t}\t//邮箱获取验证码\tpublic function public_get_email_verify() {\t\tpc_base::load_sys_func('mail');\t\t$this->_session_start();\t\t$code = $_SESSION['emc'] = random(8,\"23456789abcdefghkmnrstwxy\");\t\t$_SESSION['emc_times']=5;\t\t$message = '您的验证码为：'.$code;\t\tsendmail($_SESSION['email'], '邮箱找回密码验证', $message);\t\techo '1';\t}\n通过用户名找回密码方式存在设计缺陷。找回密码流程可分作三步来看:步骤1: 客户端提交用户名，服务端在数据库中查询记录，如果存在此用户就在session中保存用户身份信息；步骤2: 生成验证码并保存在session，然后将验证码发往用户注册邮箱；步骤3: 服务端将客户端提交的验证码与session中保存的进行比对，验证通过后重置用户密码。从代码中可以看到验证码没有绑定用户身份，这样就导致可以使用用户A的验证码来重置用户B的密码。使用用户A（可控账户）走正常密码找回流程来获取验证码，但不使用，然后再使用用户B（要攻击的账户）走步骤1，接着跳过步骤2使用前面获取到的验证码直接走步骤3，就能重置用户B的密码了。   漏洞证明：  http://**.**.**.**/index.php?m=member&c=index&a=public_get_password_type选择“通过用户名找回密码”输入自己的账户获取验证码:\n\n\n\n\n\n回到第一步输入要重置的用户名:\n\n使用前边获取的验证码直接重置密码:\n\n\n\n登录成功:\n\n   修复方案：    将步骤1步骤2合为一步或者验证码绑定用户身份   版权声明：转载请注明来源 loopx9@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2015-11-06 14:17 厂商回复： 感谢发现 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-06 12:41 |    \t\t玉林嘎  \t\t\t( 核心白帽子 |\t\t\t        Rank:933 漏洞数:107        )\t\t \n  前排    \n     2015-11-06 12:43 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1561 漏洞数:234        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  纳尼    \n     2015-11-06 12:43 |    \t\tDNS \t\t\t( 普通白帽子  |\t\t\t        Rank:711 漏洞数:73        | root@qisec.com)\t\t \n  打雷/    \n     2015-11-06 13:02 |    \t\th3hz \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:5        )\t\t \n  刘明    \n     2015-11-06 13:19 |    \t\t啊L川 \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:39        | 菜鸟 ，菜渣， 菜呀！)\t\t \n  卧槽     \n     2015-11-06 13:22 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:260 漏洞数:63        | 潜心代码审计。)\t\t \n  我擦    \n     2015-11-06 14:00 |    \t\tLooke \t\t\t( 普通白帽子  |\t\t\t        Rank:1041 漏洞数:129        )\t\t \n  我去    \n     2015-11-06 14:01 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:233 漏洞数:81        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  ..    \n     2015-11-06 14:32 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:285 漏洞数:54        | little red pig!)\t\t \n  牛逼    \n     2015-11-06 14:40 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n      \n     2015-11-06 15:17 |    \t\t带头大哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:548 漏洞数:170        | |任意邮件伪造| |目录遍历| |任意文件读取|...)\t\t \n  验证码     发表评论　    \n     2015-11-06 15:19 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  @带头大哥 女娲上面那位是你么？(*^__^*)     \n     2015-11-10 17:02 |    \t\tWalle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:5        | ...   位卑、未敢忘忧国！   ...)\t\t \n  我靠    \n     2015-12-06 17:20 |    \t\tHaLit \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 做个优秀的白帽子)\t\t \n  顶1    \n     2016-01-10 14:54 |    \t\t深夜买醉 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 没啥好介绍的，大牛太多了)\t\t \n  是不是两个username=？  后面用'可以注入 那个    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}