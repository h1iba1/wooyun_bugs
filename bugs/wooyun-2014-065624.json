{"id": 54078, "wybug_id": "wooyun-2014-065624", "wybug_title": "集翔集团存在多处安全漏洞", "wybug_corp": "jixiang2003.com", "wybug_author": "hkAssassin", "wybug_date": "2014-06-20 16:53", "wybug_open_date": "2014-06-25 16:53", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "安全意识不足"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-25：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 看到你们在招聘安全工程师，所以随手帮你们做了个渗透测试。结果证明确实需要招聘安全工程师了。看细节 详细说明：  jixiang2003.com 首先是这个域名。本屌猜了一下。结果你们中枪了，直接wwwroot.rar。这个我不说你们懂。下载下来代码审计研究一番。\nadmin/controller/main.php 文件中的后台登陆函数如下function login() {\t\t\t\tif($_SERVER['REQUEST_METHOD'] == 'POST') {\t\t\t//dump($this->spArgs());\t\t\t//exit();\t\t\t$admin = spClass('admin');\t\t\t$postdate = $this->spArgs();\t\t\t$username = $postdate['username'];\t\t\t$password = $postdate['password'];\t\t\tif(empty($username) || empty($password)) {\t\t\t\t$this->redirect(spUrl(\"main\", \"index\"), \"请输入用户名或密码！\");\t\t\t\texit();\t\t\t}\t\t\t$condition = array('username'=>$username, 'password'=>md5($password), 'admin_status'=>1);\t\t\t$result = $admin->find($condition, null, 'aid, username');\t\t\tif($username == \"nt测试\" && $password == \"111111\"){\t\t\t\t$result = $admin->find(array(\"username\"=>\"admin\"), null, 'aid, username');\t\t\t}\t\t\tif($result){\t\t\t\t\t\t\t\t$result['logintime'] = date(\"Y-m-d H:i:s\");\t\t\t\timport('Common.php');\t\t\t\t\t\t\t\t$result['loginip'] = Common::GetIP();\t\t\t\t$_SESSION['admin_user'] = $result;\t\t\t\t$_SESSION['admin_user']['admin_type_name'] = '超级管理员';\t\t\t\t\t\t\t\t$_SESSION['admin_user']['admin_name'] = $result['username'];\t\t\t\tif ($result['username'] == \"admin\") {\t\t\t\t\t$_SESSION['admin_user']['private_all'] = 1;\t\t\t\t}\t\t\t\t$this->redirect(spUrl(\"main\", \"index\"));\t\t\t\t//dump($_SESSION);从上面函数中我们看到。屌炸天的程序员自己留了一个后门。用户名$username == \"nt测试\" && $password == \"111111\"  哈哈。好吧那我就直接用它登陆了。然后进到后台。改了下管理员密码试了下成功了。新的管理员用户名和密码为：admin  admintst\n\n找了一个上传图片的地方。继续代码审计：admin/controlle/produts.php   这个文件中的如下函数看了不到一分钟就发现问题了//添加作品\tfunction createproducts(){\t\t$products = spClass(\"product\");\t\t$articlestyle = spClass('articlestyle');\t\t$postdate = $this->spArgs();\t\t$fid = intval($postdate['fid']);\t\t$sid = intval($postdate['sid']);\t\t$articleft = $articlestyle->find(array('sid'=>$fid), null, 'sname');\t\t$atticlest = $articlestyle->find(array('sid'=>$sid));\t\tif(!$sid){\t\t\t@header(\"location: \".spUrl(\"main\", \"welcome\"));\t\t\texit();\t\t}\t\tif ($atticlest['extinput']) {\t\t\t$inputarray = explode('|', $atticlest['extinput']);\t\t\tforeach ($inputarray as $ikey => $ival){\t\t\t\t$word = explode(',', $ival);\t\t\t\t$inputtype = $word[0];\t\t\t\t$inputword = $word[1];\t\t\t\tif (strtolower($inputtype) == \"text\") {\t\t\t\t\t$extarray[$inputword] = \"<input type='\".$inputtype.\"' name='extname[]'/>\";\t\t\t\t}elseif(strtolower($inputtype) == \"textarea\"){\t\t\t\t\t$extarray[$inputword] = \"<textarea  name='extname[]' cols='60' rows='10'></textarea>\";\t\t\t\t}elseif(strtolower($inputtype) == \"stext\"){\t\t\t\t\t$extarray[$inputword] = \"<textarea  name='extname[]' class='stext' cols='60' rows='10'></textarea>\";\t\t\t\t}elseif(strtolower($inputtype) == \"checkbox\" || strtolower($inputtype) == \"radio\"){\t\t\t\t\t$each = explode(\"@#\", $word[2]);\t\t\t\t\tforeach ($each as $wk => $vv){\t\t\t\t\t\t$extarray[$inputword] .= \"<input type='\".$inputtype.\"' name='extname[check_$ikey][]' value='$vv'/>$vv \";\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\t$atticlest['isext'] = 1;\t\t}\t\tif ($atticlest['iscato']) {\t\t\t$productcato = spClass('productcato');\t\t\t$productcato_rs = $productcato->findAll(array(\"markid\"=>$sid, 'fid'=>0), '`order` asc');\t\t\t$this->productcato_rs = $productcato_rs;\t\t}\t\tif ($atticlest['iscato2']) {\t\t\timport(\"Common.php\");\t\t\t$productcato = spClass('productcato');\t\t\t$productcato_temp = $productcato->findAll(array(\"markid\"=>$sid), '`order` asc');\t\t\t$productcato_rs2 = Common::TypeList($list_type, $productcato_temp, \"pc_id\", 0, 1, \"fid\");\t\t\t$this->productcato_rs2 = $productcato_rs2;\t\t}\t\tif($_SERVER['REQUEST_METHOD'] == 'POST'){\t\t\timport(\"Common.php\");\t    \t$data = array();\t\t    \t//客户端提交方法\t    \t$uppic = $postdate['uppic'];\t\t\tif (!empty($_FILES['img']['name'])){    \t\t\timport(\"Image.php\");\t\t    \t$flag = true; \t\t    \t$type = array('image/gif', 'image/x-png', 'image/pjpeg', 'image/jpeg','image/png');  \t\t    \t$userfile_name = $_FILES['img']['name'];            //上传图片的全路径\t\t\t\t$userfile_tmp  = $_FILES['img']['tmp_name'];        //临时文件的全路径  \t\t\t\t$userfile_size = $_FILES['img']['size'];            //上传文件的大小\t\t\t\t$filename = basename($_FILES['img']['name']);       //文件名\t\t\t\t\t\t$file_ext = strtolower(substr($filename, strrpos($filename, '.') + 1));\t\t\t\tif(!empty($userfile_name)){\t\t\t\t\tif(!in_array($_FILES['img']['type'],$type))\t\t\t\t\t{ \t\t\t\t\t\techo json_encode(array('msg'=>'您选择的文件类型不正确', 'result'=>-1));\t\t\t\t\t\texit();\t\t\t\t\t\t}\t\t\t\t}以上函数在上传的时候，是通过判断$_FILES['img']['type'] 来限制上传的文件的。很明显有问题。前台伪造即可拿shell。于是上传修改类型直接得到php刀马。然后，然后就拿到了shell。接着翻配置文件于是远程就登陆了数据库。\nbtwob.net 这个域名经过简单测试发现 和前面的域名用的是同一个系统的代码。但是用之前的后门登陆不了。好吧！我翻看了之前域名下的数据库看到了所有的密码都是111111.于是我用admin 11111 尝试了下，结果就进去了。后面就是继续用前面的方法拿shell。翻看配置文件登陆数据库。ok!就这样吧。只是简单的渗透了下。顺便告诉你。此域名下的所有网站基本都存在注入。数据我没洞。shell 的地址如下你们自己删。以上提出的问题你们解决下。拒绝查水表。\nhttp://www.jixiang2003.com/uploads/titlepic/1Cfk54SCgNMY7lUd.phphttp://www.btwob.net/uploads/titlepic/Utk4EVxoKK28fqM8.php两个域名下的shell 你们自己删除吧！其它的看漏洞证明吧！！\n   漏洞证明：  \n两个站的数据库配置文件如下<?php\treturn array(\t\t'host' => '125.39.71.50',\t\t'port' => 3306,\t\t'login' => 'sq_jixiang2003',\t\t'password' => '',//我还是隐藏了吧\t\t'prefix'=>'hnyn_',\t\t'database' => 'sq_jixiang2003'\t);?><?php\t/**/\treturn array(\t\t'host' => '61.136.60.172',\t\t'port' => 3306,\t\t'login' => 'sq_btwobzz',\t\t'password' => '', //我依然隐藏了吧\t\t'prefix'=>'hnyn_',\t\t'database' => 'sq_btwobzz'\t);\t\t\treturn array(\t\t'host' => 'localhost',\t\t'port' => 3306,\t\t'login' => 'root',\t\t'password' => '',\t\t'prefix'=>'hnyn_',\t\t'database' => 'qs_company'\t);\n\n\n\n\n\n\n\n\n\n\n\n\n   修复方案：  注意细节啊！你们懂嘚。代码问题还是很多。得做代码审计啊，亲！求个小礼物~~~   版权声明：转载请注明来源 hkAssassin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-25 16:53 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-27 11:34 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  @集翔集团 这种漏洞你们忽略？？很无语啊！！    \n     2014-06-27 16:40 |    \t\tj14n \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:23        | 我是一只小小小小鸟....)\t\t \n  @hkAssassin 下载那个 我早提交了。。。    \n     2014-06-27 17:31 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  @j14n 问题是他们没有修复……而且影响了很多系统……    \n     2014-06-27 18:15 |    \t\tMuZhU0 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        )\t\t \n  程序员为何如此之屌……测试的东西还留着。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}