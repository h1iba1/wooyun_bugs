{"id": 17556, "wybug_id": "wooyun-2015-0107120", "wybug_title": "tipask问答社区xss定向getshell", "wybug_corp": "tipask问答社区", "wybug_author": "Aug0st", "wybug_date": "2015-04-13 13:15", "wybug_open_date": "2015-07-14 14:08", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-14：\t细节向公众公开  简要描述： tipask问答社区某工功能xss可以导致getshell，其实只要构造好了问题，不用定向问管理员，只要管理员把问题点了，就能触发导致getshell 详细说明：  tipask问答社区定向提问处未做过滤，导致xss,然后台出可以写文件，然后用前台的提问去提问管理员，管理员前台点开问题即可触发getshell,不需要管理后台交互。其实只要构造好了问题，不用定向问管理员，只要管理员把问题点了，就能触发导致getshell.   漏洞证明：  1.首选来看这个xss,这个应该会和此人的这个有重合， WooYun: tipask xss漏洞打包，可任意指定用户获取cookie ,但是我看不到他的具体细节。（其实此人我认识）来看，问题出现在了提问处\n\n来看代码，\nfunction onadd() {        $navtitle = \"提出问题\";        if (isset($this->post['submit'])) {            $title = htmlspecialchars($this->post['title']);            $description = $this->post['description'];//未做处理            $cid1 = $this->post['cid1'];            $cid2 = $this->post['cid2'];            $cid3 = $this->post['cid3'];            $cid = $this->post['cid'];            $hidanswer = intval($this->post['hidanswer']) ? 1 : 0;            $price = abs($this->post['givescore']);            $askfromuid = $this->post['askfromuid'];            $this->setting['code_ask'] && $this->checkcode(); //检查验证码            $offerscore = $price;            ($hidanswer) && $offerscore+=10;            (intval($this->user['credit2']) < $offerscore) && $this->message(\"财富值不够!\", 'BACK');            //检查审核和内容外部URL过滤(此处也不是处理特使字符，只是审核和检查有没有外部url)            $status = intval(1 != (1 & $this->setting['verify_question']));            $allow = $this->setting['allow_outer'];            if (3 != $allow && has_outer($description)) {                0 == $allow && $this->message(\"内容包含外部链接，发布失败!\", 'BACK');                1 == $allow && $status = 0;                2 == $allow && $description = filter_outer($description);            }            //检查标题违禁词（这也不是处理）            $contentarray = checkwords($title);            1 == $contentarray[0] && $status = 0;            2 == $contentarray[0] && $this->message(\"问题包含非法关键词，发布失败!\", 'BACK');            $title = $contentarray[1];            //检查问题描述违禁词（也不是）            $descarray = checkwords($description);            1 == $descarray[0] && $status = 0;            2 == $descarray[0] && $this->message(\"问题描述包含非法关键词，发布失败!\", 'BACK');            $description = $descarray[1];            /* 检查提问数是否超过组设置 */            ($this->user['questionlimits'] && ($_ENV['userlog']->rownum_by_time('ask') >= $this->user['questionlimits'])) &&                    $this->message(\"你已超过每小时最大提问数\" . $this->user['questionlimits'] . ',请稍后再试！', 'BACK');            $qid = $_ENV['question']->add($title, $description, $hidanswer, $price, $cid, $cid1, $cid2, $cid3, $status);\nso弹了\n\n，所以此处证明有xss，其实还有好多处，咱用这一处。2，下来再看后台可以写shell的证明，在此处\n\n，来看代码function onucenter() {        if (isset($this->post['submit'])) {            $this->setting['ucenter_open'] = intval(isset($this->post['ucenter_open']));            $_ENV['setting']->update($this->setting);            if ($this->post['ucenter_config']){                $ucconfig = \"<?php\\n\";                $ucconfig.=tstripslashes($this->post['ucenter_config']);                writetofile(TIPASK_ROOT . '/data/ucconfig.inc.php',$ucconfig);            }            //连接ucenter服务端，生成uc配置文件            $message = 'UCenter设置完成！';        }        include template('setting_ucenter', 'admin');来看这个函数tstripslashesfunction tstripslashes($string) {    if (is_array($string)) {        foreach ($string as $key => $val) {            $string[$key] = tstripslashes($val);        }    } else {        $string = stripslashes($string);    }    return $string;}看到stripslashes想到了什么哈哈没错所以是可以写进去shell的好了，咱们看两者结合,构造如下.\n\n,提交。管理登陆。\n\n显然我们的js已经加载了。然后看看文件写成功了没。\n\n，文件写入成功。菜刀连接\n\n成功。3.再附一处程序bug\n\n   修复方案：  你们更专业   版权声明：转载请注明来源 Aug0st@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-04-15 14:07 厂商回复： CNVD未直接复现所述漏洞情况，暂未建立与软件生产厂商（或网站管理单位）的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-13 13:20 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  xss难得上首页，还是交给cncert的。    \n     2015-04-13 13:25 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  csrf getshell吧? 话说tipask怎么被转到cncert了    \n     2015-04-13 13:27 |    \t\tAug0st \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:32        | 看你后面~)\t\t \n  @浅蓝 差不多那意思，不过得利用xss    \n     2015-04-13 13:45 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  偶像,宇哥屌    \n     2015-04-13 13:50 |    \t\tAug0st \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:32        | 看你后面~)\t\t \n  @zcy 呵呵，认错人了，和宇哥id确实很像    \n     2015-04-13 16:54 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  我看了下我提交的关于tipask 的快一年了还没审核！我也是醉醉的了！    \n     2015-04-14 10:44 |    \t\t上山砍竹子 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 屌丝一枚)\t\t \n  最近正好在用额    \n     2015-07-14 20:40 |    \t\tguanji \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | linux)\t\t \n  牛  xss  插shell    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}