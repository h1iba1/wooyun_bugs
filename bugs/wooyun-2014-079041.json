{"id": 47941, "wybug_id": "wooyun-2014-079041", "wybug_title": "Supesite 前台注入 #2 (Insert)", "wybug_corp": "Discuz!", "wybug_author": "′雨。", "wybug_date": "2014-10-13 16:39", "wybug_open_date": "2015-01-11 16:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向公众公开  简要描述： Insert 无视GPC 装supesite会有ucenter如果在一个裤的话 可以尝试把uckey注入出来然后…… 详细说明：  来看看全局文件\nif(!(get_magic_quotes_gpc())) {\t$_GET = saddslashes($_GET);\t$_POST = saddslashes($_POST);    $_COOKIE = saddslashes($_COOKIE);}\n判断gpc 是否开启 如果没有开启 就对get post cookie 转义这里没有对files转义。_______________________________________________在batch.upload.php中\nelseif (!empty($_POST)) { //如果POST不为空\t\t//编辑标题\tif(!empty($_GET['editaid']) && $editaid = intval($_GET['editaid'])) {\t\t$editsubject = cutstr(trim(shtmlspecialchars($_POST['editsubject'])), 50);\t\tupdatetable('attachments', array('subject'=>$editsubject), array('aid'=>$editaid));\t\tprint <<<END\t\t<script language=\"javascript\">\t\tvar div = parent.document.getElementById(\"div_upload_\" + $editaid);\t\tvar pf = parent.document.getElementById(\"phpframe\");\t\tpf.src = \"about:blank\";\t\tdiv.innerHTML = \"$editsubject\";\t\t</script>END;\t\texit;\t}\t\t//上传文件\t//上传模式\t$mode = intval(postget('mode')); \tif($mode>3) exit; //mode 直接让他为空\t$hash = trim(preg_replace(\"/[^a-z0-9\\-\\_]/i\", '', trim($_POST['hash'])));\tif(strlen($hash) != 16) showresult($blang['unable_to_complete_this_craft']);//这里只判断hash的长度为不为16 没有进一步的验证 那么就让hash为1111111111111111\t\t//个数\t$filecount = 1;\t$query = $_SGLOBAL['db']->query('SELECT COUNT(*) FROM '.tname('attachments').' WHERE hash=\\''.$hash.'\\'');\t$count = $_SGLOBAL['db']->result($query, 0);\t$allowmax = intval($_POST['uploadallowmax']);\tif($allowmax > 0 && $count + $filecount > $allowmax) showresult($blang['the_number_has_reached_maximum']);\t//类型\t$allowtypearr = getallowtype(trim($_POST['uploadallowtype']));//取得上传的类型\t\t//空间\t$attachsize = 0;\tinclude_once(S_ROOT.'./function/upload.func.php');\tif(empty($mode)) { //让$mode为空即可\t\t//本地上传\t\t//检查\t\t$filearr = $_FILES['localfile'];//获取files\t\tif(empty($filearr['size']) || empty($filearr['tmp_name'])) showresult($blang['failure_to_obtain_upload_file_size']);\t\t$fileext = fileext($filearr['name']);//获取后缀\t\tif(!empty($allowtypearr)) {\t\t\tif(empty($allowtypearr[$fileext])) showresult($blang['upload_not_allow_this_type_of_resources'].\" ($allowtype_ext)\");\t\t\tif($filearr['size'] > $allowtypearr[$fileext]['maxsize']) showresult($blang['file_size_exceeded_the_permissible_scope']);\t\t}\t\t//缩略图\t\tif(!empty($_POST['uploadthumb0']) && !empty($_SCONFIG['thumbarray'][$_POST['uploadthumb0']])) {\t\t\t$thumbarr = $_SCONFIG['thumbarray'][$_POST['uploadthumb0']];\t\t} else {\t\t\t$thumbarr = array($_POST['thumbwidth'], $_POST['thumbheight']);\t\t}\t\t\t\t//上传\t\t$newfilearr = savelocalfile($filearr, $thumbarr);\t\tif(empty($newfilearr['file'])) showresult($blang['uploading_files_failure']);\t\t//数据库\t\tif(empty($_POST['uploadsubject0'])) $_POST['uploadsubject0'] = cutstr(filemain($filearr['name']), 50);//下面就带入到insert当中啦\t\t$insertsqlarr = array(\t\t\t'uid' => $uid,\t\t\t'dateline' => $_SGLOBAL['timestamp'],\t\t\t'filename' => saddslashes($filearr['name']),//对文件的名字转义\t\t\t'subject' => trim(shtmlspecialchars($_POST['uploadsubject0'])),\t\t\t'attachtype' => $fileext,//这里没有对文件的后缀转义\t\t\t'isimage' => (in_array($fileext, array('jpg','jpeg','gif','png'))?1:0),\t\t\t'size' => $filearr['size'],\t\t\t'filepath' => $newfilearr['file'],\t\t\t'thumbpath' => $newfilearr['thumb'],\t\t\t'hash' => $hash\t\t);\t\tinserttable('attachments', $insertsqlarr)//insert;\n'filename' => saddslashes($filearr['name']) 在查询的时候名字被转义了'attachtype' => $fileext 来看一下$fileext$fileext = fileext($filearr['name']);\nfunction fileext($filename) {\treturn strtolower(trim(substr(strrchr($filename, '.'), 1)));}\n获取点以后的 没做转义 所以可以在后缀这进行注入了。\n\n可以看到 名字被转义 后缀那成功引入单引号\n\n出数据   漏洞证明：  \n\n   修复方案：  转义之   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-13 16:44 厂商回复： 感谢您提供的信息。SupeSite目前已经停止维护，希望您关注我们的其他产品。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-13 16:43 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 Supesite 前台注入 #2 (Insert)    \n     2014-10-13 16:44 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n    把 delete 和 select 也通过了吧。     \n     2014-10-13 16:46 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 Supesite 前台注入 #2 (Insert)    \n     2014-10-13 17:21 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  靠，那么快确认,又不见X测的确认了    \n     2014-10-13 17:42 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 Supesite 前台注入 #1 (Select)     \n     2015-08-21 13:49 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}