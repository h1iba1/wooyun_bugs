{"id": 56528, "wybug_id": "wooyun-2014-057447", "wybug_title": "EasyTalk任意文件删除漏洞（可删除内置waf）", "wybug_corp": "nextsns.com", "wybug_author": "xfkxfk", "wybug_date": "2014-04-18 11:55", "wybug_open_date": "2014-07-17 11:56", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "设计不当导致攻击界面扩大", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-17：\t细节向公众公开  简要描述： EasyTalk任意文件删除漏洞 详细说明：  EasyTalk存在两处任意文件删除漏洞。一处是在SettingAction.class.php文件的doface函数处，已经有人提交过了。这里是在GuideAction.class.php文件的doface2函数处。\n//头像裁剪处理    public function doface2() {        $ysw=$_POST['ysw'];        if ($ysw>660) {            $zoom=intval($ysw)/660;        } else {            $zoom=1;        }        $x=$_POST['x']*$zoom;        $y=$_POST['y']*$zoom;        $w=$_POST['w']*$zoom;        $h=$_POST['h']*$zoom;        $imgpath=ET_ROOT.$_POST['imgpath'];        $ext=strtolower(getExtensionName($imgpath));        import(\"@.ORG.IoHandler\");        $IoHandler = new IoHandler();        if(!isImage($imgpath)) {            $IoHandler->DeleteFile($imgpath);            setcookie('setok', json_encode(array('lang'=>L('face2'),'ico'=>2)),0,'/');            header('location:'.SITE_URL.'/?m=guide');            exit;        }        $image_path = ET_ROOT.'/Public/attachments/head/'.date('Ymd').'/';        if(!is_dir($image_path)) {            mkdir($image_path);        }        $f=date('His');        //大图片\t\timport(\"@.ORG.makethumb\");\t\t$makethumb=new makethumb();        $filename=$f.'_big.'.$ext;        $dst_file = $image_path.$filename;        $make_result = $makethumb->dothumb($imgpath,$dst_file,max(10,min(120,$w)),max(10,min(120,$h)),0,0,$x,$y,$w,$h);        //小图片        $filename=$f.'_small.'.$ext;        $dst_file = $image_path.$filename;        $make_result = $makethumb->dothumb($imgpath,$dst_file,max(10,min(50,$w)),max(10,min(50,$h)),0,0,$x,$y,$w,$h);        $IoHandler->DeleteFile($imgpath);        M('Users')->where(\"user_id='\".$this->my['user_id'].\"'\")->setField('user_head',date('Ymd').'/'.$filename.'?v='.time());        setcookie('setok', json_encode(array('lang'=>L('face1'),'ico'=>1)),0,'/');        header('location:'.SITE_URL.'/?m=guide');    }\n可以看到$imgpath=ET_ROOT.$_POST['imgpath'];看看函数isImage做了什么：\nfunction isImage($filename){    $types = '.gif|.jpg|.jpeg|.png';//定义检查的图片类型    if(file_exists($filename)){        $info = getimagesize($filename);        $ext = image_type_to_extension($info['2']);        return stripos($types,$ext)>=0?1:0;    }else{        return false;    }}\n如果文件的后缀不是.gif|.jpg|.jpeg|.png这几种类型就返回false。当返回false的时候，就会删除这里的文件：$IoHandler->DeleteFile($imgpath);所以只要我们提交的文件不是上面几种就可导致任意文件删除。   漏洞证明：  第一步，先注册一个用户第二步，会出现向导，此时上传一个头像\n\n第三步，提交剪裁时，抓包，修改imgpath=%2FPublic%2Finstall.lock此时已经删除了install.lock文件。会跳转到安装页面。\n\n然后可以重装，后台getshell   修复方案：  判断imgpath的内容。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-04-18 16:10 厂商回复： 感谢，已经修复了 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-22 15:30 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  小伙子要发财啊    \n     2014-04-22 15:43 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:330        | 呵呵！)\t\t \n  @xsser ？    \n     2014-04-22 15:51 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  @xfkxfk 看到你报了好多通用型 近期乌云不是在统一发奖了么    \n     2014-04-22 16:08 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:330        | 呵呵！)\t\t \n  @xsser 表示近期没有发财，什么情况？！    \n     2014-04-22 16:18 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  @xfkxfk 联系@疯狗 或者坐等    \n     2014-04-22 16:37 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:330        | 呵呵！)\t\t \n  @xsser 好吧    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}