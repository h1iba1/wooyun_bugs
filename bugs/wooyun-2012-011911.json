{"id": 16847, "wybug_id": "wooyun-2012-011911", "wybug_title": "金山毒霸沙箱对api请求处理不当可造成越权访问", "wybug_corp": "金山软件集团", "wybug_author": "zhq445078388", "wybug_date": "2012-09-08 10:57", "wybug_open_date": "2012-10-23 10:58", "wybug_type": "命令执行", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-09-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-09-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-09-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-09-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-10-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-10-23：\t细节向公众公开  简要描述： 毒霸沙箱将沙箱内API请求由用户模式代理成内核模式 导致openprocess一些被保护的进程成功 详细说明：  金山毒霸沙箱程序是用于隔离物理环境与真实环境的其原理是全局重定向但是在openprocess等函数的处理上并没有进行重定向 还将原本属于usermode的请求转换为Kernelmode大多数保护用HOOK会自动放行来自内核的请求 也就是Kernelmode 仅过滤usermode的请求而毒霸沙箱将请求“升级”后 即可绕过金山毒霸自我保护结束金山大多数进程 包括沙箱shell进程而金山的核心进程的访问保护也过滤了内核模式 所以open失败 结束就不成功   漏洞证明：  将任务管理器用沙箱打开 可直接结束金山毒霸大多数进程而不使用沙箱则没有问题   修复方案：  建议重定向openprocess请求 或将请求伪装hook后代理api时 使用原本的请求级别 不要改变或毒霸自我保护过滤下来自内核模式的请求   版权声明：转载请注明来源 zhq445078388@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2012-09-10 10:50 厂商回复： 收到，我们将尽快确认和修复 最新状态： 2012-09-11：已经确定问题。新版将修复，非常感谢； 2012-09-11：金山毒霸 2012版SP5.8升级后即修复，2013版没有沙箱。  ", "replys": "漏洞评价：\n评论\n     2012-09-08 11:16 |    \t\tzhq445078388 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:19        | 请牢记\"杀进程点康姆\")\t\t \n  补充：\t建议从毒霸自我保护中去掉这块代码：if (ExGetPreviousMode() == KernelMode)\t{\t\treturn( oldadd(ProcessHandle,DesiredAccess,ObjectAttributes,ClientId));\t}    \n     2012-09-08 11:18 |    \t\ttenzy \t\t\t( 普通白帽子  |\t\t\t        Rank:176 漏洞数:21        | Need not to know)\t\t \n  @zhq445078388 黑客啊！！！！！！这才是黑客。。。。。。    \n     2012-09-08 11:29 |    \t\tzhq445078388 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:19        | 请牢记\"杀进程点康姆\")\t\t \n  @tenzy 其实最主要的原因不在这是毒霸的共用的HOOK是KiFastCallEntry 这货直接将请求下发了。。上面的是骗利用者的 反正毒霸看到这个问题都能找到。    \n     2012-09-10 13:18 |    \t\t期待爱 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:3        | 这个家伙很精明 连条内裤也没有留下！！！)\t\t \n  金山毒霸沙箱其实是个鸡肋    \n     2012-09-11 10:33 |    \t\t夜莺 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | C python)\t\t \n  这是开源的那个么？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}