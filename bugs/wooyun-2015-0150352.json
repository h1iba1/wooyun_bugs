{"id": 82663, "wybug_id": "wooyun-2015-0150352", "wybug_title": "海盗云商 最新版密码重置漏洞", "wybug_corp": "www.haidao.la", "wybug_author": "xiao.k", "wybug_date": "2015-11-02 16:29", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-12-17：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： 因为逻辑判断的问题，导致任意用户可被重置密码 详细说明：  漏洞文件在`appliaction\\Controller\\User\\PublicController.class.php`,197-235行\n/*通过邮件找回密码*/\tpublic function setrepwd(){\t\tif(IS_POST){\t\t\t$id = (int)$_POST['id'];            if ($id < 1) showmessage('您的信息有误');            $passowrd = trim($_POST['password']);            $passowrd1 = trim($_POST['password1']);            if (!$passowrd) showmessage('请输入新密码',U('User/Public/setrepwd',array('repwd_key'=>$_POST['repwd_key'])));            if (!$passowrd1) showmessage('请输入确认密码',U('User/Public/setrepwd',array('repwd_key'=>$_POST['repwd_key'])));            if ($passowrd != $passowrd1) showmessage('两次输入的密码不一致',U('User/Public/setrepwd',array('repwd_key'=>$_POST['repwd_key'])));            $userinfo = model('user')->find($id);            if ($userinfo['email'] != $_POST['email']) showmessage('您的信息有误，请重新获取链接',U('User/Public/repwd'));            if ($_POST['repwd_key'] != $userinfo['repwd_key']) showmessage('找回密码的链接无效，请重新获取',U('User/Public/repwd'));\t\t\t$data = array();            $data['id'] = $id;\t\t\t$data['valid'] = random(10);\t\t\t$data['password'] = md5($data['valid'].$_POST['password']);\t\t\t$data['repwd_key'] = NULL;\t\t\t$r = model('user')->save($data);\t\t\tif(!$r) showmessage('找回密码失败,请重新找回!',U('User/Public/repwd'));\t\t\tshowmessage('密码已经成功更改,请重新登录!',U('User/Public/login'),1);\t\t\t\t\t}else{\t\t\t..... 省略无关代码 ......\t\t}\t\t\t}\n当我们需要重置密码时，我们需要提交用户的id、用户的邮箱地址和我们要设置的密码，以及`repwd_key`。用户的id和用户邮件都比较好搞定。我们主要关注`repwd_key`。当新用户注册完成时，实际上`repwd_key`这个字段是为空的。如下图：\n\n那么当我提交的`repwd_key`为空时，自然也满足校验的条件。\nif ($_POST['repwd_key'] != $userinfo['repwd_key']) showmessage('找回密码的链接无效，请重新获取',U('User/Public/repwd'));\n当条件都满足时，即可进行重置密码。   漏洞证明：  \n\n   修复方案：  判断 `$_POST['repwd_key']` 是否为空   版权声明：转载请注明来源 xiao.k@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-11-03 13:18 厂商回复： 感谢关注，我们会立即着手修复。 最新状态： 2016-01-21：本漏洞已处理，我们会在新版发布时更新此补丁。  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}