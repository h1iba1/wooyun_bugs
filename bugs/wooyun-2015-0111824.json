{"id": 26803, "wybug_id": "wooyun-2015-0111824", "wybug_title": "北京国际首都机场重要敏感信息泄露导致出现一系列安全问题（可泄露所有人的登机信息、理论可getshell）", "wybug_corp": "北京国际首都机场", "wybug_author": "izy", "wybug_date": "2015-05-03 23:53", "wybug_open_date": "2015-06-22 08:30", "wybug_type": "系统/服务运维配置不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感信息泄露"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向公众公开  简要描述： 泄露..泄露...各种泄露... 详细说明：  这是当时在机场测试的，时间比较紧没有测试完全就登机了。。。在登陆的时候抓包看到这个\n\n然后我就把seat改成我朋友的，同样返回一个password，并且可以登录\n\n\n\n\n\n返回的账号都是可以成功登陆的，因为不在机场所以就不测试了...当时因为登陆速度太慢了，同时用nmap探测了一下wifi认证的服务器:106.120.238.126对机场用户开放了如下端口:\n\n如果是外网则未开放80、8090端口在机场的时候访问443端口：http://106.120.238.126:443/ （刚刚回来发现外网也可以访问）有目录遍历漏洞\n\n服务器账号密码泄露（不可外连）\n\n找到源码，还是1月份备份的\n\n\n\n\n\n还有各种接口的信息稍微看了一下源码，有很多漏洞啊..因为前面就有一个越权访问的漏洞，所以重点看了一下登陆、查询的逻辑，普通的：短信炸弹、越权访问（泄露登机人信息）都是验证成功后直接调用接口，而我们可以直接访问接口绕过验证\npublic function sendsmsAction(){            $this->_helper->viewRenderer->setNoRender();            $userip = $_SERVER[\"REMOTE_ADDR\"];            $pid = $_REQUEST['pid'];            $phone = $_REQUEST['phone'];            $lan = $_REQUEST['lan'];            $curtime = $_REQUEST['curtime'];            $passport = $_REQUEST['passport'];            $password = \"auto!^**wwkeypss\";\t    $json = array(array('code'=>'1', 'msg'=>'申请成功,直接发送短信'),array('code'=>'2', 'msg'=>'申请成功,返回帐号'),array('code'=>'3', 'msg'=>'申请成功,返回帐号和密码'),array('code'=>'-1', 'msg'=>'登陆失败'),array('code'=>'-2', 'msg'=>'非法的手机号'),array('code'=>'-3', 'msg'=>'非法的mac地址'),array('code'=>'-4', 'msg'=>'非法>的校验位'));            $value = md5($pid.$phone.$curtime.$password);            if($passport!=$value){                $rt = json_encode($json[6]);                echo $rt ;                die;            }            $getsmsurl = \"http://106.120.238.122/portal/regbycustomer?idtype=1&idnum=$phone\";            $f = fopen($getsmsurl, \"r\");            if($f){                    $smscode=fread($f,60);                    $result = substr($smscode,10,1);//                      var_dump($smscode);echo \"</br>\";//                  var_dump($result);                    if($result == 1){                        $rt = json_encode($json[0]);                        echo $rt;                    }            }    }\n越权访问，理论可以获得所有人的登机信息\npublic function ajaxloginAction()    {        $this->_helper->viewRenderer->setNoRender();        $user=trim($_POST['user']);        $password=trim($_POST['password']);\t$mac=$_SESSION[\"usermac\"];\t$userIp = $_SERVER['REMOTE_ADDR'];\t$userip = $_SERVER[\"REMOTE_ADDR\"];        if ('' == $user) {            echo -4;//账号不能为空            return;        }        if ('' == $password) {            echo -5;//密码不能为空            return;        }        //require_once '../application/models/Login/Standard.php';        require_once '../application/models/Remote/DataValidation.php';        $login=new Models_Remote_DataValidation();        $rs=$login->checkLogin($user, $password);        //echo $rs;// -1:用户名，密码不对,-2:用户帐号使用时间已到期,正值：剩余上网时间\t$len=strlen($rs);\tif($len > 10)\t{\t\techo 0;\t\tfopen(\"http://\".REMOTE_ADDRESS.\"/portal/macinsacct?mac=$mac&user=$user&pass=$password\", \"r\");\t\t\t\terror_log(\"user==================================\".$user);\t\t$i=0;\t\tfor($i=0;$i<3;$i++)\t\t{\t\t\t$rt=$this->test();\t\t\terror_log(\"bras rt=$rt\");\t\t\t\t\t\tif(0==$rt)\t\t\t{\t\t\t\t$sendurlcn = \"http://106.120.238.123/portal/sendloginauth?ip=$userip&username=$user&msgtype=2\";                        try{                                fopen ( $sendurlcn, \"r\" );                        }catch(Exception $e){\t\t\t}\t\t\tbreak;\t\t\t}\t\t\t\t\t\tbreak;\t\t}\t\tif(0==$rt)\t\t{\t\t\t\t\t\t$cookiewu=$_COOKIE['loginwu'];\t\t\t$cookiewp=$_COOKIE['loginwp'];\t\t\tif ($cookiewu && $cookiewp){\t\t\t\t\t\t\t}else{\t\t\t\t$loginuser = $user;\t\t\t\t$loginpass = $password;\t\t\t\t$sendurlcn = \"http://106.120.238.123/portal/getregtime?username=$user\";\t\t\t\t$f = fopen ( $sendurlcn, \"r\" );\t\t\t\tif($f){\t\t\t\t\t$name=fread($f,80);\t\t\t\t\t$logintimescj = $name;\t\t\t\t}else{// \t\t\t\t\t$username = $user;\t\t\t\t}\t\t\t\tsetcookie(\"loginwu\",\"$loginuser\",time()+3600*4);\t\t\t\tsetcookie(\"loginwp\",\"$loginpass\",time()+3600*4);\t\t\t\tsetcookie(\"loginwt\",\"$logintimescj\",time()+3600*4);\t\t\t}\t\t\terror_log(\"user=================loginsuccess============\".$user);\t\t\techo  $rt;\t\t}\t\telseif(2==$rt)\t\t{\t\t\techo \"1\";\t\t\terror_log(\"重复登陆，直接跳转!\");\t\t}\t\telse\t\t{\t\t\techo \"-3\";\t\t\terror_log(\"login fail !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\");\t\t}\t\t\t}else\t{\t\techo $rs;\t\terror_log(\"login failed rt=$rt\\n\");\t}    }\n直接访问接口则绕过登陆验证，理论可以登陆所有账户因为在外网所以不能测试如果可以，请找一家安全公司做源码审计项目,问题太多，既然用户这么信任你，请保护好用户的隐私。在这也是 可能 造成前台getshell的漏洞\nfunction updateConf($username, $pass, $server){\t\tif(!file_exists(\"api/config.inc.php\")) return \"文件smsdemo/api/config.inc.php 不存在！\";\t\tif(!is_writable(\"api/config.inc.php\")) return \"文件smsdemo/api/config.inc.php 不可写！请检查文件属性！\";\t\t$fd = fopen(\"api/config.inc.php\",\"w\");\t\tif(!$fd) return \"文件smsdemo/api/config.inc.php 打不开, 请检查文件属性！\";\t\t$line = '<? '.\"\\n\".\t\t\t\t'/** '.\"\\n\".\t\t\t\t' * 这是配置文件 '.\t\t\t\t' * $'.\"vcpserver\t\tSCP服务器地址，测试服务器为testxml.todaynic.com，正式服务器为xml.todaynic.com \".\"\\n\".\t\t\t\t' * $'.\"vcpserverport\tSCP服务器，在测试环境和真实环境，使用的接口均为20001 \".\"\\n\".\t\t\t\t' * $'.\"vcpsuser\t\t时代互联提供的真实短信用户或测试用户 \".\"\\n\".\t\t\t\t' * $'.\"vcppassword\t\t 时代互联提供的真实短信用户密码或测试用户密码 \".\"\\n\".\t\t\t\t' * '.\"\\n\".\t\t\t\t' * www.now.com,Inc. http://www.now.com '.\"\\n\".\t\t\t\t'**/ '.\"\\n\".\t\t\t\t'$'.'vcpserver=\"'.$server.'\"; '.\"\\n\".\t\t\t\t'$'.'vcpserverport=\"20001\"; '.\"\\n\".\t\t\t\t'$'.'vcpuser=\"'.$username.'\"; '.\"\\n\".\t\t\t\t'$'.'vcppassword=\"'.$pass.'\"; '.\"\\n\".\t\t\t\t'?> '.\"\\n\";\t\tif(fwrite($fd, $line)===FALSE) return \"文件smsdemo/api/config.inc.php 写入失败！请检查文件属性！\";\t\tfclose($fd);\t\treturn \"1\";\t}\n还有这个服务器，不知为何测试有点问题：$vcpserver=\"sms.todaynic.com\"; $vcpserverport=\"20002\"; $vcpuser=\"m****18\"; $vcppassword=\"o****t\";    漏洞证明：  \n\n所有资料、源码已删。   修复方案：  安全审计、服务器安全配置、第三方接口认证   版权声明：转载请注明来源 izy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2015-05-08 08:28 厂商回复： CNVD未直接复现,已经转由CNCERT向民航行业测评单位通报,由其后续协调网站管理单位处置. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-04 00:13 |    \t\tMr.Lonely \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 努力成为一个有用的人。)\t\t \n  走到哪儿，挖到哪儿。。。    \n     2015-05-04 08:44 |    \t\tizy \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:22        | http://1zy.pw/)\t\t \n  @Mr.Lonely 强迫症T_T    \n     2015-05-06 13:42 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  izy日机场    \n     2015-05-06 18:12 |    \t\tizy \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:22        | http://1zy.pw/)\t\t \n  @phith0n 23333    \n     2015-05-07 14:21 |    \t\tMr.Lonely \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 努力成为一个有用的人。)\t\t \n  @phith0n 0_o    \n     2015-05-08 09:02 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  好叼    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}