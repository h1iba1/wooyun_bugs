{"id": 4165, "wybug_id": "wooyun-2014-051339", "wybug_title": "smartoa 企业版 政务办 任意文件上传 获取webshell（多处）", "wybug_corp": "广州力智软件有限公司", "wybug_author": "what_news", "wybug_date": "2014-02-19 10:16", "wybug_open_date": "2014-05-20 10:17", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "代码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-20：\t细节向公众公开  简要描述： 没有对用户上传类型就行判断过滤，虽然在客户端进行了过滤筛选，但是到服务端没有进行多一步的验证，使得可以通过改包绕过客户端验证 详细说明：  测试网站：http://demo.smartoa.com.cn/ 随机选择一个普通用户登录进去（管理员更不用说了）第1处在应用中心->新闻管理->新增 按钮 -> 基础信息 -> 点击上传 主要代码如下\npublic JsonResult UpLoadImage(){    ArticleBLL.UpFileImage image = new ArticleBLL().UpLoadImage(); //跟进    base.G2Result.Data = image;    if (string.IsNullOrEmpty(image.ImageUrl))    {        base.G2Result.Result = false;        base.G2Result.Message = \"上传失败\";    }    return base.Json(base.G2Result);}public UpFileImage UpLoadImage(){    UpFileImage image = new UpFileImage();    UploadedFileCollection uploadedFiles = HttpUploadModule.GetUploadedFiles();    if (uploadedFiles != null)    {        foreach (UploadedFile file in uploadedFiles)        {            try            {                string path = string.Concat(new object[] { @\"CMS\\Article\\TitleImage\\\", Guid.NewGuid(), \".\", file.Extension }); //没判断文件类型，直接利用 导致任意文件上传                file.SaveAs(path);                image.ImageName = file.ClientName;                image.ImageUrl = path;                image.FileServerUrl = FileManage.FileServerPath;            }            catch            {                throw;            }        }    }    return image;}\n正常上传 我把一句话木马改成jpg格式\n\n修改成aspx格式\n\nshell路径\n\n第2处在应用中心->新闻管理->新增 按钮 -> 文章内容 -> 有个添加图片的图标 点击上传主要代码如下\npublic JsonResult UploadImage(){    G2JsonObject data = new G2JsonObject();    string str = Path.Combine(this.storeRootPath, DateTime.Now.ToString(\"yyyyMMdd\"));    UploadedFileCollection uploadedFiles = HttpUploadModule.GetUploadedFiles();    foreach (UploadedFile file in uploadedFiles)    {        try        {            file.SaveAs(Path.Combine(str, file.ClientName)); //没过滤，可上传任意文件            data.Result = true;            data.Data = Path.Combine(str, file.ClientName);        }        catch (Exception exception)        {            data.Message = exception.Message;            data.Result = false;        }    }    return base.Json(data);}\n正常上传 把木马改成jpg格式\n\n抓包，修改成aspx格式\n\n木马地址\n\n菜刀链接\n\n第3处任务中心->任务派发->新增->附件浏览页面主要代码如下\npublic JsonResult UploadAttachment(string ID){    UploadedFileCollection uploadedFiles = HttpUploadModule.GetUploadedFiles();    if ((uploadedFiles != null) && (uploadedFiles.Count >= 1))    {        UploadedFile file = uploadedFiles[0];        AttachmentContract contract = new AttachmentContract();        contract.AttachmentID = Guid.NewGuid();        contract.AttachmentSize = file.ContentLength;        contract.Extension = file.Extension.ToLower();        contract.AttachmentName = file.ClientName;        contract.AttachmentNameWithNotExtension = file.ClientNameWithoutExtension;        contract.CreateEmployeeName = this.CurrentUserName;        contract.CreateTime = DateTime.Now;        string str = Path.Combine(\"UDF\", DateTime.Now.ToString(\"yyyyMM\"));        contract.StorePath = Path.Combine(str, contract.AttachmentID.ToString() + \".\" + contract.Extension);//没过滤直接利用        file.SaveAs(contract.StorePath, true);        base.G2Result.Data = contract;    }    return base.Json(base.G2Result);}\n\n\n\n\n\n\n\n\n\n\n第4处 应用中心->人事管理->劳动合同—>附件信息->上传附件主要代码如下\npublic JsonResult UpLoadFile(){    ContractAttachmentBLL tbll = new ContractAttachmentBLL();    return base.Json(tbll.UpLoadFile()); //跟进}public ListDataResult<ContractAttachmentContract> UpLoadFile(){    ListDataResult<ContractAttachmentContract> result = new ListDataResult<ContractAttachmentContract>();    result.Result = true;    UploadedFileCollection uploadedFiles = HttpUploadModule.GetUploadedFiles();    try    {        if (uploadedFiles == null)        {            return result;        }        foreach (UploadedFile file in uploadedFiles)        {            ContractAttachmentContract contract2 = new ContractAttachmentContract();            contract2.AttachmentID = new Guid?(Guid.NewGuid());            ContractAttachmentContract item = contract2;            string str = item.AttachmentID.ToString();            string str2 = @\"ContractAttachment\\\" + str + \".\" + file.Extension;//没判断 产生漏洞            file.SaveAs(@\"HRCM\\\" + str2);            item.AttachmentName = file.ClientNameWithoutExtension;            item.AttachmentUrl = str2;            item.ExtName = file.Extension;            item.FileSize = file.ContentLength;            result.Rows.Add(item);        }    }    catch (Exception exception)    {        result.Result = false;        result.Message = exception.Message;    }    return result;}\n\n\n\n\n\n\n\n\n第5处 个人办公 我的网盘那 可以随便上传任意文件 只是上传后暂时找不到文件上传后的路径比较悲催 但是也存在任意文件上传漏洞   漏洞证明：  如上   修复方案：  白名单判断类型修复   版权声明：转载请注明来源 what_news@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-02-24 09:15 厂商回复： CNVD未在本地实例或其他实例上复现，仅确认所述DEMO实例及原理分析，rank 15 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-19 10:47 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  给力。    \n     2014-02-19 10:49 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @wefgod 要多像你学习    \n     2014-02-20 09:50 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这货是JSP的还是PHP的    \n     2014-02-20 10:45 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  .NET    \n     2014-02-20 10:59 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  明白。    \n     2014-03-02 01:09 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  @wefgod 看来你准备刷一波 ~~    \n     2014-03-02 01:29 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @Matt 木有，就搞了两个去数字。太小众了。    \n     2014-03-02 21:38 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  @wefgod 站个位置咩 我都2-3月没在数字提拉 被你们这群黑客刷的太狠了    \n     2014-03-03 09:33 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @Matt 哈哈，我打酱油的而已    \n     2014-03-16 14:14 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这个oa还有更厉害的漏洞。    \n     2014-03-17 11:38 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @wefgod 你为什么这么厉害    \n     2014-05-20 12:07 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  iis6解析即可~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}