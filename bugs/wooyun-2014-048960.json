{"id": 4823, "wybug_id": "wooyun-2014-048960", "wybug_title": "国内外多家vpn设备厂商批量漏洞(续集二)", "wybug_corp": "众多vpn厂商", "wybug_author": "felixk3y", "wybug_date": "2014-01-15 10:43", "wybug_open_date": "2014-04-15 10:44", "wybug_type": "设计不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["运维管理不当", "信息泄露", "源代码泄露", "安全管理不到位"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-15：\t细节向公众公开  简要描述： 暂时不出续集三了,将发现的问题一起放出来...经测试,此系列漏洞任然普遍存在,成功利用此系列漏洞有下列威胁1.任意文件上传;2.任意代码/命令执行;3.任意文件下载/删除4.严重敏感信息泄露4.整个源代码泄露等等等...倘若进一步利用,危害性将非常大。同时该漏洞涉及到包括网御神州、天融信、西安网赢、卫士通、吉大正元、美国凹凸、德国 ANIX等多家VPN厂商设备在政务、地产、运营商、政府部门、高校、企业、公安、司法、银行等行业存在的任意文件下载、远程命令执行、维护后门、三方平台帐号泄漏、恶意客户端下发等高位漏洞。 详细说明：  #1 同样请先看\n WooYun: 国内外多家vpn设备厂商批量漏洞(续集一) \n在测试的过程中,我大概看了下源代码，于是就有了这个漏洞...#2 系列漏洞---任意文件上传漏洞先列举其一/admin/system/cert_request_import_action.php 代码如下\n<?include_once \"management/certificate.php\";//此文件没有权限的验证,SO...$MAX_SIZE= 2*1000*1000;if ($_FILES['gw_cert']) {\t$file_size = $_FILES['gw_cert']['size'];\t$file_type = $_FILES['gw_cert']['type'];\t\t$temp_name = $_FILES['gw_cert']['tmp_name'];\t$gw_file_name = $_FILES['gw_cert']['name'];\t$gw_file_name = str_replace(\"\\\\\",\"\",$gw_file_name);\t$gw_file_name = str_replace(\"'\",\"\",$gw_file_name);\t$gw_file_name = str_replace(\" \",\"\",$gw_file_name);\t$file_path = $CFG_UPLOAD_PATH.$gw_file_name;\t//File Name Check\tif ( $gw_file_name == \"\" ) { \t\tinclude \"include/error.php\";\t\treturn;\t}\t$gw_file_name = $file_path;\t$result  =  move_uploaded_file($temp_name, $file_path);\tchmod($file_path, $CFG_UPLOAD_MOD);} else {\tinclude \"include/error.php\";\treturn;}if ($_FILES['iss_cert']) {\t$file_size = $_FILES['iss_cert']['size'];\t$file_type = $_FILES['iss_cert']['type'];\t\t$temp_name = $_FILES['iss_cert']['tmp_name'];\t$iss_file_name = $_FILES['iss_cert']['name'];\t$iss_file_name = str_replace(\"\\\\\",\"\",$iss_file_name);\t$iss_file_name = str_replace(\"'\",\"\",$iss_file_name);\t$iss_file_name = str_replace(\" \",\"\",$iss_file_name);\t$file_path = $CFG_UPLOAD_PATH.$iss_file_name;\t//File Name Check\tif ( $iss_file_name == \"\" ) { \t\tinclude \"include/error.php\";\t\treturn;\t}\t$iss_file_name = $file_path;\t$result  =  move_uploaded_file($temp_name, $file_path);\tchmod($file_path, 0777);}$CM = new CertificateManager;if ($_FILES['iss_cert'])\t$msg = $CM->Import_GW_CA_Cert($ticket, $gw_file_name, $iss_file_name);else\t$msg = $CM->Import_GW_CA_Cert($ticket, $gw_file_name, \"\");$RURL = \"?body=3\";$RURL1 = \"?body=4\";if ($msg != \"OK\")\tinclude \"include/error.php\";else\techo \"<META HTTP-EQUIV=\\\"REFRESH\\\" CONTENT=\\\"0; URL=\".$RURL.\"\\\">\";?>\n我们来看下其上传的代码是怎样写的\nif ($_FILES['gw_cert']) {\t$file_size = $_FILES['gw_cert']['size'];\t$file_type = $_FILES['gw_cert']['type'];\t\t$temp_name = $_FILES['gw_cert']['tmp_name'];\t$gw_file_name = $_FILES['gw_cert']['name'];\t$gw_file_name = str_replace(\"\\\\\",\"\",$gw_file_name);\t$gw_file_name = str_replace(\"'\",\"\",$gw_file_name);\t$gw_file_name = str_replace(\" \",\"\",$gw_file_name);\t$file_path = $CFG_UPLOAD_PATH.$gw_file_name;\t//File Name Check\tif ( $gw_file_name == \"\" ) { \t\tinclude \"include/error.php\";\t\treturn;\t}\t$gw_file_name = $file_path;\t$result  =  move_uploaded_file($temp_name, $file_path);\tchmod($file_path, $CFG_UPLOAD_MOD);} else {\tinclude \"include/error.php\";\treturn;}\n看见了吧,只要稍有代码编写能力的人都可以看出来有问题，完全没有经过任何的安全检查便把文件写入的对方硬盘..对此我不想多说什么,更不想去做测试,因为那简直就是浪费时间..(我表示很无语啊,这样的代码写的东西至少我不敢用,你们敢吗?)存在同样问题的地方还有如下文件：\n/sub_ca_action.php/admin/system/gw_cert_import_action.php/admin/account/admin_add_action.php/admin/account/group_batch_add_action.php/admin/authentication/mini_ca_action.php/admin/authentication/mini_ca_action.php....\n还有很多,还请都检查下...#2 系列漏洞---任意文件下载/删除问题出现在：/admin/system/backup_down.php 代码如下\n<?if (isset($_POST[\"file_name\"]))\t$file_name = \"/data/upload/sysbackup_\".$_POST[\"file_name\"].\".bin\";else {\theader(\"Location: ../login.php\");\treturn;}header(\"Pragma: \"); header(\"Cache-Control: \"); header(\"Content-type: application/octet-stream\");header(\"Content-Length: \".filesize($file_name));header(\"Content-Disposition: attachment; filename=\\\"sysbackup.bin\\\"\");readfile($file_name);@unlink($file_name);?>\n看见了吧，没有任何的权限验证,没有任何的安全检查...这个也不想多说,不测试,真的是浪费时间...#2 系列漏洞---配置信息泄露根目录下的 htdocs 中的文件\n2014/01/09  16:40    <DIR>          .2014/01/09  16:40    <DIR>          ..2014/01/07  14:00             3,550 httpd-mpm.conf.big2014/01/07  14:00             3,550 httpd-mpm.conf.small2014/01/07  14:00             3,089 httpd.conf2014/01/07  14:00             3,148 httpd.conf-802014/01/07  14:00             2,183 index.php               5 个文件         15,520 字节               2 个目录 105,551,912,960 可用字节\n能过Web可以访问,此处以httpd.conf为例：\n\n\nServerRoot \"/usr\"Listen 127.0.0.1:1#Listen 80LoadModule auth_basic_module lib/httpd/modules/mod_auth_basic.soLoadModule include_module lib/httpd/modules/mod_include.soLoadModule env_module lib/httpd/modules/mod_env.soLoadModule mime_magic_module lib/httpd/modules/mod_mime_magic.soLoadModule expires_module lib/httpd/modules/mod_expires.soLoadModule headers_module lib/httpd/modules/mod_headers.soLoadModule setenvif_module lib/httpd/modules/mod_setenvif.soLoadModule mime_module lib/httpd/modules/mod_mime.soLoadModule autoindex_module lib/httpd/modules/mod_autoindex.soLoadModule cgi_module lib/httpd/modules/mod_cgi.soLoadModule vhost_alias_module lib/httpd/modules/mod_vhost_alias.soLoadModule dir_module lib/httpd/modules/mod_dir.soLoadModule actions_module lib/httpd/modules/mod_actions.soLoadModule alias_module lib/httpd/modules/mod_alias.soLoadModule rewrite_module lib/httpd/modules/mod_rewrite.soUser rootGroup rootServerAdmin cheng.zhang@o2micro.com#ServerName www.example.com:80ServerName 127.0.0.1DocumentRoot \"/ssl/www\"<Directory />    Options FollowSymLinks ExecCGI    AllowOverride None#    Order deny,allow#    Deny from all</Directory><Directory \"/ssl/www\">    Options -Indexes FollowSymLinks MultiViews ExecCGI    AllowOverride None</Directory><IfModule dir_module>    DirectoryIndex index.html index.php login.php</IfModule>ErrorLog /dev/null#ErrorLog /var/log/httpd/error_log#LogLevel warnDefaultType text/plain<IfModule mime_module>    TypesConfig /etc/httpd/mime.types    AddType application/x-compress .Z    AddType application/x-gzip .gz .tgz    AddHandler cgi-script .cgi</IfModule>#MIMEMagicFile /etc/httpd/magic# Server-pool management (MPM specific)Include /etc/httpd/extra/httpd-mpm.conf# Multi-language error messages#Include /etc/httpd/extra/httpd-multilang-errordoc.conf# Fancy directory listings#Include /etc/httpd/extra/httpd-autoindex.conf# Language settings#Include /etc/httpd/extra/httpd-languages.conf# User home directories#Include /etc/httpd/extra/httpd-userdir.conf# Real-time info on requests and configuration#Include /etc/httpd/extra/httpd-info.conf# Virtual hosts#Include /etc/httpd/extra/httpd-vhosts.conf# Local access to the Apache HTTP Server Manual#Include /etc/httpd/extra/httpd-manual.conf# Distributed authoring and versioning (WebDAV)#Include /etc/httpd/extra/httpd-dav.conf# Various default settingsInclude /etc/httpd/extra/httpd-default.conf# Override the setting in httpd-default.confKeepAlive OffServerSignature OffServerTokens Prod Timeout 180  # Uncomment the following line to enable PHP:#Include /etc/httpd/mod_php.conf<VirtualHost 127.0.0.1:1>\tServerName 127.0.0.1\tDocumentRoot \"/ssl/www\"\tRewriteEngine on \tRewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)\tRewriteRule .* -[F]\tRewriteRule ^/admin$ /admin/ [R] </VirtualHost>#<VirtualHost _default_:80>#\tServerName 127.0.0.1#\tDocumentRoot \"/ssl/www/htdocs\"#\tAlias /admin/ \"/ssl/www/htdocs/\"#\tRewriteEngine on #\tRewriteRule ^/admin$ /admin/ [R] #</VirtualHost>\n   漏洞证明：  #4 系列漏洞---源代码泄露在整个系统中,有很多的重要php文件,配置文件以.inc的文件格式存放,恰巧,几乎所有的站点都没有对其进行安全处理,造成了严重的安全漏洞例如：/filepass/  目录下的filepass_helper.inc/filepass/ftp/目录下的ftp_cmd.inc  ftp_user.inc\n2014/01/07  14:00             6,585 ftp_cmd.inc2014/01/07  14:00             3,531 ftp_***.php2014/01/07  14:00             4,358 ftp_***.php2014/01/07  14:00               702 ftp_***.php2014/01/07  14:00            21,572 ftp_helper.inc2014/01/07  14:00             4,653 ftp_***.php2014/01/07  14:00            10,056 ftp_***.php2014/01/07  14:00            11,489 ftp_screen_pda.php2014/01/07  14:00             3,031 ftp_***.php2014/01/07  14:00            11,703 ftp_user.inc\n/filepass/share/目录下的share_user.inc等2014/01/07  14:03    <DIR>          conf2014/01/07  14:00             4,173 share_***.php2014/01/07  14:00             8,898 share_***.php2014/01/07  14:00               711 share_***.php2014/01/07  14:00            16,977 share_helper.inc2014/01/07  14:00             3,960 share_***.php2014/01/07  14:00             9,383 share_***.php2014/01/07  14:00            11,620 share_***.php2014/01/07  14:00            19,769 share_***.php2014/01/07  14:00             3,162 share_***.php2014/01/07  14:00            13,136 share_user.inc其他的差不多都忘了...还有很多都请好好检查下，下面给一个例子，请看.https://vpn.mcut.edu.tw//filepass/ftp/ftp_user.inc\n\nhttps://vpn.mcut.edu.tw//filepass/share/share_user.inc\n\n好了,暂时就到这里,不继续深入了对了,我想问一下，用该VPN系统的用户有Windwos环境搭建的吗?   修复方案：  你们懂.   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-01-20 09:43 厂商回复： cnvd确认并复现所述情况，已经分别根据测试用例按厂商整理通报，拟联系软件生产厂商处置，由于存在代码同源情况，对于oem源暂不认定。同时对电信，教育，政府部门案例进行分类整理，拟分别通报基础电信企业，教育网应急组织和下发各分中心处置。rank 40+ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-15 11:29 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  @felixk3y  我就喜欢这样的LZ ~     \n     2014-01-15 11:35 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @乐乐、 明天播放续集三,非常精彩的    \n     2014-01-15 12:17 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @felixk3y 第二集明显不如第一集精彩啊    \n     2014-01-15 12:22 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xsser 那是肯定的,不过下次在PHPCMS上会更精彩,哈哈 期待吧...    \n     2014-01-15 12:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @felixk3y 续集三是啥啊    \n     2014-01-15 14:52 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xsser 续集三和这个洞放一起了...    \n     2014-01-15 14:54 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @felixk3y 赞～    \n     2014-01-15 15:11 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  坐等第三集~    \n     2014-01-15 16:14 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  终于发了啊。期待phpcms的啊    \n     2014-01-21 12:08 |    \t\tcmd2k \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 学习,努力,加油)\t\t \n  坐等    \n     2014-02-09 11:00 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  叫他们OEM啊    \n     2014-04-08 08:48 |    \t\t晏子 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 无)\t\t \n  rank 40+洞主等着查水表吧。    \n     2014-04-15 15:56 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  rank 40+ 流弊    \n     2014-04-16 20:18 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  目测这些代码是临时工写的。。。    \n     2014-07-05 10:26 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n   WooYun: [再浅谈内网安全]--网神某带ids,waf网关设备完控0day又一枚  跟之前的这个漏洞涉及点有些重复 ,但是洞主列出的细节点得很详细，更能帮助厂商逐个修复问题。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}