{"id": 3353, "wybug_id": "wooyun-2014-065813", "wybug_title": "腾讯QQ强制聊天漏洞（也可以判断任何人好友关系等）", "wybug_corp": "腾讯", "wybug_author": "小虫", "wybug_date": "2014-06-23 17:20", "wybug_open_date": "2014-06-24 10:21", "wybug_type": "未授权访问/权限绕过", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感接口缺乏认证", "用户敏感信息泄露"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-24：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 腾讯QQ强制聊天是一个经久不衰的话题，今天小虫就提交一个关于强聊的bug吧，该bug可实现对任意QQ发起临时会话，细节不便透漏。。。 详细说明：     所谓强聊，就是不经过对方同意，直接发起QQ会话。   这个强聊的漏洞是由QQ空间引发的。   怀着严谨的态度，以下所有测试均是在测试QQ号码未开通QQ在线状态服务的前提下！开启了这个服务，就不用这么麻烦了，直接就能聊。   在QQ空间中，有一个谁看过我的功能，然后我们把鼠标移到他们的头像上，会弹出一个信息卡片，如图：\n\n   信息卡片上有一个聊天功能，也就是这个接口，出现了严重的bug。   点击聊天，抓包结果如下：\n\n   从图片中可以看出，聊天的接口为：\nhttp://r.cnc.qzone.qq.com/cgi-bin/user/cgi_tmp_talk?qzone_uin=20737302&to_uin=569550119&g_tk=1593160781\n   里边有两个重要参数qzone_uin发起QQ(以下简称sender)，to_uin接收QQ(以下简称receiver)，指定这两个参数后，请求接口，返回信息如下：\n<script type=\"text/javascript\"><!--var url = 'tencent://message/?Menu=yes&uin=569550119&Service=112&SigT=ff8847c4116e035fd4b467f691cd9e42c0d413cec47eefb75d5e970421a2376ab400fffb0ea6cb8a&SigU=8a718a0cd8eba14b389fceb5788e72797b8a7eae107b9c43dd56bc7cc21090bccf67158b657963841c529232def3d416761799a1050acaaa29033f62f7fb46b5580fef571e7d82041508e926d65900ae77fae70b9cc4a341b7677c65b215d0327211235a5702bb6564157a3dfc11abe4';location = url;//--></script>\n   这里边又有三个非常重要的数据，经过大量实践，发现：uin是接收人的QQ，SigT是receiver的指纹，SigU是sender的指纹。   由此可见，有了这两个指纹，然后访问tencent://message/接口，就可以发起临时会话。   那怎么实现强聊呢？   小虫直接说结论，想强聊，必须知道自己一个好友的QQ号和被聊人一个好友的QQ号。这两个条件均不难实现，自己的QQ好友您还不知道么。。。而被聊人的QQ好友，也是很容易获取的，比如你想和你同班的美女聊，那么班主任的QQ就是切入点。   为什么需要这么奇怪的条件呢？小虫直接演示。   假设有四个角色，分别是A(发起人)，AF(发起人好友),B(接收人),BF(接收人好友)   第一步，我们需要在A和AF间建立一个通道，将A作为聊天的发起人，可以这样构造URL：\nhttp://r.cnc.qzone.qq.com/cgi-bin/user/cgi_tmp_talk?qzone_uin=A&to_uin=AF&g_tk=1593160781\n   在服务器返回的参数中，我们拿到SigU参数，这个也就是A作为sender的指纹。   第二步，我们在B和BF间建立一个通道，将B作为聊天接收人，可以这样构造URL：\nhttp://r.cnc.qzone.qq.com/cgi-bin/user/cgi_tmp_talk?qzone_uin=BF&to_uin=B&g_tk=1593160781\n   在服务器返回的参数中，我们拿到SigT参数，这个也就是 B作为receiver的指纹。   接下来我们把这两个指纹混合在一起，访问tencent://message/接口（别忘了加上最基本的uin参数，接收人QQ），恭喜，可以聊天了！   等等，好像有大问题，假如B和BF不是好友呢？我们并不能保证他们一定是好友，也就是说，我们是猜的。   这一猜，就出大问题了！！！\n\n   上图我就猜错了，他们不是好友。。。   聪明的你可能已经发觉了，这个接口可以测试两个QQ号码是不是好友(前提是被测者未开通QQ在线状态，如果一方开通了这个服务，可以尝试将sender、receiver反过来)！！！   这是多么邪恶的接口！   不法分子可以通过这个接口收费帮别人测试好友，进而导致情侣隐私泄漏，夫妻感情破裂，进而导致社会不和谐，进而导致生产力下降，进而导致科技停止发展，严重阻碍人类进化。   最后，补充一句，通过这个方法发起的临时会话，即使没有开启QQ在线状态服务也是可以的，除非你屏蔽了所有临时会话。   漏洞证明：     20737302和1444390619强聊。   中间人649374916，这个号码既是20737302的好友，也是1444390619的好友。   就地取材，我用官方的接口证明20737302和1444390619不是好友。\n\n   构造sender指纹：\n\n   构造receiver指纹：\n\n   混合指纹信息，访问临时会话接口：\n\n\n\n   修复方案：     其实漏洞主要出现在这个接口上：\nhttp://r.cnc.qzone.qq.com/cgi-bin/user/cgi_tmp_talk?qzone_uin=649374916&to_uin=1444390619&g_tk=1593160781\n   关键在于这个接口可以任意使用，输入什么QQ号都行，只要限制一下，让这个接口只允许当前登录的QQ发起即可，虽然说起来简单，但由于具体业务原因，可能很不好操作。   版权声明：转载请注明来源 小虫@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-24 10:21 厂商回复： 非常感谢您的报告，经评估该问题并不存在，故此忽略。如果您有任何的疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-23 17:28 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  卖茶叶那种是不是这么搞的    \n     2014-06-23 17:44 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  @疯狗 狗哥 求过~ http://www.wooyun.org/bugs/wooyun-2014-065830/trace/cee6b4d95f031321fc760c2d0c074d86http://www.wooyun.org/bugs/wooyun-2014-065819/trace/63fee1eac3f8a8df6caa9b355a31e549    \n     2014-06-23 20:21 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @疯狗 买茶叶蛋？啥段子？    \n     2014-06-23 20:58 |    \t\t小学猹 \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:30        | 暮春者，春服既成，冠者五六人，童子六七人...)\t\t \n  mark0 0     \n     2014-06-23 21:23 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @疯狗 求审核，看着别扭，都半个月了    \n     2014-06-24 10:36 |    \t\t小虫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 菜鸟一枚，希望为网络安全做出一份贡献)\t\t \n  既然忽略，看来我可以做一个nodejs应用，来提供在线聊天、好友判断服务了。。。    \n     2014-06-24 11:06 |    \t\t乡间小路 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 关注网络安全。)\t\t \n  不法分子可以通过这个接口收费帮别人测试好友，进而导致情侣隐私泄漏，夫妻感情破裂，进而导致社会不和谐，进而导致生产力下降，进而导致科技停止发展，严重阻碍人类进化。    \n     2014-06-24 13:46 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  @乡间小路 我擦  犀利~  这洞给20rank都少了 影响太大    \n     2014-06-24 14:02 |    \t\t小学猹 \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:30        | 暮春者，春服既成，冠者五六人，童子六七人...)\t\t \n  --。--似乎真的不能聊    \n     2014-06-24 14:55 |    \t\tAnonymous.L \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:8        | 最后一位关注xxxx的人 , 孤独之人)\t\t \n  @Mosuan PHP初学者？    \n     2014-06-24 15:44 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @Anonymous.L 是的，有何指教？    \n     2014-06-24 18:09 |    \t\t乡间小路 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 关注网络安全。)\t\t \n  厂商回复：非常感谢您的报告，经评估该问题并不存在，故此忽略。如果您有任何的疑问，欢迎反馈，我们会有专人跟进处理。现在打开~http403错误    \n     2014-06-24 21:39 |    \t\tfhod \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:1        | 进来学习的)\t\t \n  这奸商，问题不存在，怎么现在打开403错误    \n     2014-06-25 09:28 |    \t\tAnonymous.L \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:8        | 最后一位关注xxxx的人 , 孤独之人)\t\t \n  @Mosuan 那是准备做PHP开发？    \n     2014-06-25 09:29 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我去？403？    \n     2014-06-25 09:51 |    \t\t小虫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 菜鸟一枚，希望为网络安全做出一份贡献)\t\t \n  我发现的时候肯定不是403的，否则这些图哪来的。。晕死刚刚我看了一下，地址换了。变成了：http://r.qzone.qq.com/cgi-bin/user/cgi_tmp_talk?qzone_uin=20737302&to_uin=649374916&g_tk=1531301928简单来个403，就把我给否了，太鲁莽。。。各位高手，我把方法都告诉你们了，自己动手去试试呗！！别直接用我给的结果，亲自操作一遍    \n     2014-06-25 09:52 |    \t\t小虫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 菜鸟一枚，希望为网络安全做出一份贡献)\t\t \n  @wefgod 绝对可用，耐心点，自从抓包，然后操作一遍    \n     2014-06-25 09:55 |    \t\t小虫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 菜鸟一枚，希望为网络安全做出一份贡献)\t\t \n  @fhod 地址有变，重新抓包即可，我今天就写个程序出来    \n     2014-06-25 10:09 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @Anonymous.L 不知道，走一步看一步    \n     2014-06-25 11:17 |    \t\t小虫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 菜鸟一枚，希望为网络安全做出一份贡献)\t\t \n  @Mosuan 学好js才是硬道理    \n     2014-06-25 11:35 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @小虫 原来如此。看来TSRC又悲剧了    \n     2014-06-25 11:54 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @小虫 暂时对js没兴趣    \n     2014-06-28 23:18 |    \t\tby灰客 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:12        )\t\t \n  @小虫 可以用 =  =程序写好了吗    \n     2014-06-29 20:27 |    \t\tby灰客 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:12        )\t\t \n   @小虫 程序写好了，一级查询的，如何能二级查询？    \n     2014-07-31 21:12 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  终于写好了  明天我也去卖茶叶啊....    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}