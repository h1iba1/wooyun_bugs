{"id": 2128, "wybug_id": "wooyun-2014-061084", "wybug_title": "大汉版通某系统文件上传导致任意代码执行", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "路人甲", "wybug_date": "2014-05-16 22:19", "wybug_open_date": "2014-08-14 22:20", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传安全", "文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-14：\t细节向公众公开  简要描述： 大汉版通某个系统存在两处文件上传，可Getshell 详细说明：  #1 漏洞文件总共存在两处文件上传，路径如下\n/xxgk/m_5_5/m_5_5_3/upload.jsp/xxgk/m_5_5/m_5_5_3/import_style.jsp\n选择其一贴下漏洞代码\n<%    ListTable listtable = new ListTable(request);    out.println(listtable.getListTableCssJs());    sys.initSysPara(request);    //*得到用户信息*/    Merp_Pub_UserEntity userentity = UserRightBLF.getUserInfo(request);    String strFilePath = application.getRealPath(\"\")            + \"/m_5_5/m_5_5_3/temp/upload/\";//上传文件保存的路径    Convert.createDirectory(strFilePath);    CommonUploadFile upload = new CommonUploadFile(strFilePath, \"\");    boolean bl = false;    String[] strFiles = null;    try {        SysInit.init();        if (SysInit.m_strImportNoFileType == null) {            upload.setM_Notfiletype(\"exe,com,bat,php,asp,php3,phtml,jsp,aspx\");        } else {            upload.setM_Notfiletype(SysInit.m_strImportNoFileType);        }        bl = upload.uploadFile(request);    } catch (Exception e) {    }    if (bl) {        StyleParse sp = new StyleParse(sys.appId, sys.webId);        sp.setUserentity(userentity);        String strXMLFile = \"\";        strFiles = upload.getAllFileName();        if (strFiles != null) {            for (int i = 0; i < strFiles.length; i++) {                strXMLFile = strFilePath + strFiles[i];                //解析xml文件                sp.importStyle(strXMLFile);            }        }    }\n重点在这几行\nString strFilePath = application.getRealPath(\"\")            + \"/m_5_5/m_5_5_3/temp/upload/\";//上传文件保存的路径//...if(SysInit.m_strImportNoFileType == null) {   upload.setM_Notfiletype(\"exe,com,bat,php,asp,php3,phtml,jsp,aspx\");} else {   upload.setM_Notfiletype(SysInit.m_strImportNoFileType);}\n很明显，程序采用了黑名单限制文件的上传，如下upload.setM_Notfiletype(\"exe,com,bat,php,asp,php3,phtml,jsp,aspx\");这让我们没有办法上传jsp格式的文件（暂不考虑其它的绕过情况）但是你们知道吗? jspx 同样可以解析为jsp#2 漏洞测试ok 那接下来进行漏洞的测试随机在互联网上选取案例进行测试，这里为\nhttp://xxgk.weifang.gov.cn/xxgk/m_5_5/m_5_5_3/import_style.jsp\n如图所示\n\n我们将xiao.jspx 改名为xiao.xml 上传..提交后抓包修改文件名为1.jspx即可，如下图所示\n\n此时已经在 /m_5_5/m_5_5_3/temp/upload/ 目录下生成了xiao.jspx 访问下 成功\n\n   漏洞证明：  #连接shell\nhttp://xxgk.weifang.gov.cn/xxgk//m_5_5/m_5_5_3/temp/upload/xiao.jspx\n如图所示\n\n最高权限哦\n[*] 基本信息 [ A:C:D:E:F: ]D:\\*****\\tomcat\\webapps\\xxgk\\> whoamint authority\\system\n   修复方案：  严格过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-05-19 10:00 厂商回复： 感谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-16 22:25 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  要么就是后台吧，要么就是setup咯。猜测。    \n     2014-05-17 13:17 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  如果不是jcms的话，我就鄙视你    \n     2014-05-17 14:16 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @动后河 这个好像木有啥好鄙视的吧……    \n     2014-05-18 03:23 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  @wefgod  确实    \n     2014-08-14 22:59 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @wefgod 解析jspx好像要容器限制吧    \n     2014-08-15 11:35 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  我看好多人都是先展示分析代码，再演示利用方法。实际情况好像是看不到代码的，那不是要测试很多次嘛    \n     2014-08-20 13:11 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @U神 tomcat默认情况支持    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}