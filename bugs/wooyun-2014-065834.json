{"id": 54011, "wybug_id": "wooyun-2014-065834", "wybug_title": "qibocms 新闻系统 Getshell (需结合解析漏洞)", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-06-23 18:51", "wybug_open_date": "2014-09-21 18:52", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-21：\t细节向公众公开  简要描述： IIS || Apache。 详细说明：  http://bbs.qibosoft.com/down2.php?v=news1.0#down下载地址。在news/member/post.php中\nrequire_once(Mpath.\"inc/check.postarticle.php\");if($job=='postnew'){\tif($step=='post')\t{\t\tpost_new();\t\t//生成静态\t\tmake_article_html(\"$Murl/member/post.php?job=endHTML&aid=$aid\");\t\t$mid && $mid<106 && $none='none';\t\trefreshto(\"?job=postnew&fid=$fid\",\"<CENTER>[<A HREF='?job=postnew&fid=$fid'>继续发表新主题</A>] <span style='display:$none;'>[<A HREF='?job=post_more&fid=$fid&aid=$aid'>续发本主题</A>]</span> [<A HREF='myarticle.php?job=myarticle&fid=$fid'>返回主题列表</A>] [<A HREF='$Mdomain/bencandy.php?fid=$fid&aid=$aid' target=_blank>查看主题</A>] [<A HREF='?job=edit&aid=$aid'>点击修改</A>]</CENTER>\",60);\t}\t$MSG='新发表内容';\t$select_fid=$Guidedb->SelectIn(\"{$_pre}sort\",0,$fid);\trequire(ROOT_PATH.\"member/head.php\");\trequire(dirname(__FILE__).\"/template/post.htm\");\trequire(ROOT_PATH.\"member/foot.php\");\n包含了这个进来inc/check.postarticle.php 进去看看。\n$postdb[title]\t\t=\tfiltrate($postdb[title]);\t$postdb[subhead]\t=\tfiltrate($postdb[subhead]);\t$postdb[keywords]\t=\tfiltrate($postdb[keywords]);\t$postdb[smalltitle]\t=\tfiltrate($postdb[smalltitle]);\t$postdb[picurl]\t\t=\tfiltrate($postdb[picurl]);\t//$postdb[description]=\tfiltrate($postdb[description]);\t$postdb[author]\t\t=\tfiltrate($postdb[author]);\t$postdb[copyfrom]\t=\tfiltrate($postdb[copyfrom]);\t$postdb[copyfromurl]=\tfiltrate($postdb[copyfromurl]);\t$postdb[description]\t=\tpreg_replace('/javascript/i','java script',$postdb[description]);\t$postdb[description]\t=\tpreg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[description]);\t\t//针对火狐浏览器做的处理\t$postdb[content]=str_replace(\"=\\\\\\\"../$webdb[updir]/\",\"=\\\\\\\"$webdb[www_url]/$webdb[updir]/\",$postdb[content]);\tif(!$groupdb[PostNoDelCode]){\t\t$postdb[content]\t=\tpreg_replace('/javascript/i','java script',$postdb[content]);\t\t$postdb[content]\t=\tpreg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[content]);\t}\t//采集外部图片\t$postdb[content]\t=\tget_outpic($postdb[content],$fid,$GetOutPic);\n跟这函数来看看。get_outpic\nfunction get_outpic($str,$fid=0,$getpic=1){\tglobal $webdb,$lfjuid,$_pre;\tif(!$getpic){\t\treturn $str;\t}\tpreg_match_all(\"/http:\\/\\/([^ '\\\"<>]+)\\.(gif|jpg|png)/is\",$str,$array);\t$filedb=$array[0];\tforeach( $filedb AS $key=>$value){\t\tif( strstr($value,$webdb[www_url]) ){\t\t\tcontinue;\t\t}\t\t$listdb[\"$value\"]=$value;\t}\tunset($filedb);\tforeach( $listdb AS $key=>$value){\t\t$filedb[]=$value;\t\t$name=$lfjuid.'_'.rands(5).\"__\".basename($value);\t\tif(!is_dir(ROOT_PATH.\"$webdb[updir]/$_pre/$fid\")){\t\t\tmakepath(ROOT_PATH.\"$webdb[updir]/$_pre/$fid\");\t\t}\t\t$ck=0;\t\tif( @copy($value,ROOT_PATH.\"$webdb[updir]/$_pre/$fid/$name\") ){\t\t\t$ck=1;\t\t}elseif($filestr=file_get_contents($value)){\t\t\t$ck=1;\t\t\twrite_file(ROOT_PATH.\"$webdb[updir]/$_pre/$fid/$name\",$filestr);\t\t}\n\npreg_match_all(\"/http:\\/\\/([^ '\\\"<>]+)\\.(gif|jpg|png)/is\",$str,$array);\t$filedb=$array[0];\tforeach( $filedb AS $key=>$value){\t\tif( strstr($value,$webdb[www_url]) ){\t\t\tcontinue;\t\t}\t\t$listdb[\"$value\"]=$value;\t}\tunset($filedb);\n这里匹配了 http://xxxx.com/xx.jpg|png|gif 这种的匹配出来后 循环赋值 然后又再把数组$listdb循环出来\nforeach( $listdb AS $key=>$value){\t\t$filedb[]=$value;\t\t$name=$lfjuid.'_'.rands(5).\"__\".basename($value);\n然后拼接成$name 最后 $name做了文件的名字。然后再file get contents 就write file了。由于这里匹配的时候限制匹配到.jpg 结束 所以要利用一下解析漏洞 这里先说下解析漏洞。IIS6解析漏洞:yu.php;1.jpg 这样是可以当php文件来执行的。Apache解析漏洞:yu.php.jpg (当最后一个后缀无法解析的时候也就是.jpg无法解析的时候 就会向上来解析就解析成了.php.  当服务器是windows的时候jpg是会被识别的所以这样解析无效, 当linux时 jpg无法解析 就会解析成.php了)   漏洞证明：  发表文章的时候抓个包。\nfunction get_outpic($str,$fid=0,$getpic=1){\tglobal $webdb,$lfjuid,$_pre;\tif(!$getpic){\t\treturn $str;\t}\n由于这里当这变量为false的时候就直接返回了。 结合qibocms的伪全局机智 直接post提交下就行了。$name=$lfjuid.'_'.rands(5).\"__\".basename($value);这里文件名的名字是由uid_随机5个字符__拼接的名字这里uid 和名字我们自己都能知道  但是随机的5个字符不太清楚 但是后面有函数会帮忙。\ngdpic(ROOT_PATH.\"$webdb[updir]/$postdb[picurl]\",$Newpicpath,$picWidth?$picWidth:300,$picHeight?$picHeight:225,$webdb[autoCutSmallPic]?array('fix'=>1):'');\t\t\t\t\t\t//多生成一张3:4的图片,方便标签调用\t\t\tgdpic(ROOT_PATH.\"$webdb[updir]/$postdb[picurl]\",\"$Newpicpath.jpg\",$picHeight?$picHeight:225,$picWidth?$picWidth:300,$webdb[autoCutSmallPic]?array('fix'=>1):'');\t\t\t//多生成一张1:1的图片,方便标签调用\t\t\tgdpic(ROOT_PATH.\"$webdb[updir]/$postdb[picurl]\",\"$Newpicpath.jpg.jpg\",$picWidth?$picWidth:300,$picWidth?$picWidth:300,$webdb[autoCutSmallPic]?array('fix'=>1):'');\n在这里 调用了这个函数\nfunction gdpic($srcFile,$dstFile,$width,$height,$type=''){\trequire_once(ROOT_PATH.\"inc/waterimage.php\");\tif(is_array($type)){\t\t//截取一部分,以满足匹配尺寸\t\tcutimg($srcFile,$dstFile,$x=$type[x]?$type[x]:0,$y=$type[y]?$type[y]:0,$width,$height,$x2=$type[x2]?$type[x2]:0,$y2=$type[y2]?$type[y2]:0,$scale=$type[s]?$type[s]:100,$fix=$type[fix]?$type[fix]:'');\t}elseif($type==1){\t\t//成比例的缩放\t\tResizeImage($srcFile,$dstFile,$width,$height);\t}else{\t\t//与尺寸不匹配时.用色彩填充\t\tgdfillcolor($srcFile,$dstFile,$width,$height);\n继续跟\nfunction cutimg($srcimgurl,$endimgurl,$x,$y,$endimg_w,$endimg_h,$border_w,$border_h,$scale=100,$fix=0){\t$path = dirname ($endimgurl);\tif (!is_dir($path)) {\t\tif(!@mkdir ($path, 0777)){\t\t\tshowerr(\"{$path} 此目录不能创建,文件创建失败\");\t\t}\t}\t$ground_info = getimagesize($srcimgurl);\tswitch($ground_info[2]){ \t\tcase 1:$im = imagecreatefromgif($srcimgurl);break; \t\tcase 2:$im = imagecreatefromjpeg($srcimgurl);break; \t\tcase 3:$im = imagecreatefrompng($srcimgurl);break; \t\tdefault:die(\"图片格式不允许$srcimgurl\");\n当cut失败的时候 会直接透漏出文件的名字。\n\n\n\n这种格式的文件在iis 或者 apache下是能解析的。   修复方案：  。。看你们啦。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-06-24 11:11 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-23 21:02 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 qibocms 新闻系统 Getshell (需结合解析漏洞)   大神消停会吧，放过cms吧，放过建站系统吧......    \n     2014-06-23 21:28 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Mosuan  为了生活，    \n     2014-06-23 21:30 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @′  雨。 在学php中，想学点代码审计。同为生活，你才高中而已，你为了什么生活.    \n     2014-06-23 21:33 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Mosuan   为大学学费努力中    \n     2014-06-23 21:34 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @′  雨。 代码审计累吗？    \n     2014-06-23 21:36 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Mosuan   其实还好 周末放假 有时间了就看看，    \n     2014-06-23 21:36 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @′  雨。 唉，撸撸看教程去    \n     2014-06-23 22:17 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  @Mosuan @′  雨。 你关注的白帽子 ′ 雨。 发表了漏洞 qibocms 新闻系统 Getshell (需结合解析漏洞) 大神消停会吧，放过cms吧，放过建站系统吧......     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}