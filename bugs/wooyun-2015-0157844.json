{"id": 79558, "wybug_id": "wooyun-2015-0157844", "wybug_title": "用友ICC系统GETSHELL漏洞（影响银行/保险/电信等行业）", "wybug_corp": "用友软件", "wybug_author": "applychen", "wybug_date": "2015-12-03 00:31", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-12-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-12-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-12-07：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-02-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 给两个刀吧…… 详细说明：  在struts.xml中定义了一个crud-default包：\n<package name=\"crud-default\" extends=\"convention-default\">\t\t<!-- 基于paramsPrepareParamsStack,\t\t\t增加store interceptor保证actionMessage在redirect后不会丢失 -->\t\t<interceptors>\t\t\t<interceptor-stack name=\"crudStack\">\t\t\t\t<interceptor-ref name=\"store\">\t\t\t\t\t<param name=\"operationMode\">AUTOMATIC</param>\t\t\t\t</interceptor-ref>\t\t\t\t<interceptor-ref name=\"paramsPrepareParamsStack\" />\t\t\t</interceptor-stack>\t\t</interceptors>\t\t<default-interceptor-ref name=\"crudStack\" />        <action name=\"showUpload\">            <result>/common/testStrutsUpload.jsp</result>        </action>                <action name=\"doUpload\" class=\"**.**.**.**mon.upload.StrutsFileUpload\">        \t<param name=\"fileSavePath\">/upload</param>            <result name=\"input\">/common/testStrutsUpload.jsp</result>            <result>/common/testStrutsUploadSuccess.jsp</result>                    </action>\t</package>\n其中的action doUpload用于上传文件，跟踪其class文件com/ufida/icc/common/upload/StrutsFileUpload.java：\npublic StrutsFileUpload()\t{\t\tft = 0;\t\tuploadPath = SystemProperties.instance().webUploadPath;//上传保存文件路径/opt/uficc/icc_data/upload/\t\tallowTypes = SystemProperties.instance().webUploadAllowTypes;//上传检查白名单application/rtf,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.wordprocessingml.template,application/msword,application/vnd.ms-excel,text/plain,application/vnd.ms-powerpoint,application/pdf,image/png,image/gif,image/jpeg,image/pjpeg,image/jpg,image/bmp,application/x-zip-compressed,.zip\t} private int checkTypes(String fileType)  {    int type = 0;    if (fileType == null) {      return 0;    }    String[] types = this.allowTypes.split(\",\");    for (int i = 0; i < types.length; i++) {      if (types[i].equals(fileType.toLowerCase())) {        type = 1;        break;      }    }    return type;  }\tpublic String execute()    throws Exception  {    try    {      String targetDirectory = this.uploadPath;//保存路径      if (this.filename != null) {        this.uploadFileName = this.filename;//将filename赋值给uploadFileName        this.upload = this.file;      }      if (this.ft == 10) {//当ft=10时将上传对象传递给upload        this.upload = this.attach;      }            String extName = this.uploadFileName.substring(this.uploadFileName.lastIndexOf(\".\") + 1);//获取后缀      if (extName.equals(this.uploadFileName)) {//文件名中没有.时退出        this.successFlag = 3;        return \"success\";      }      if (checkTypes(this.uploadContentType) == 0) {//未通过checkTypes()白名单检查时则退出        if ((this.uploadContentType == null) && (this.uploadFileName != null))        {          if ((!extName.equals(\"jpg\")) &&             (this.f != 1)) {            this.successFlag = 3;            return \"success\";          }        }        else        {          this.successFlag = 3;          return \"success\";        }      }      String targetFileName = \"\";      if (this.filename != null) {//filename不为空时再将filename取值回来传递给targetFileName        targetFileName = this.uploadFileName;      } else {       ……      }      File target = new File(targetDirectory, targetFileName);//创建文件      FileUtils.copyFile(this.upload, target);//生成文件内容      ……\n通过上面代码不难看出在创建文件时文件名targetFileName直接由filename得到，而白名单检测的是通过uploadContentType，这里只要将uploadContentType设定为.zip即可通过checkTypes()检查。最终通过控制filename进行目录跳转将文件保存到web目录。下面以联通为例进行测试：\nhttp://**.**.**.**/web/icc/\n构造一个上传页面：\n\n直接上传jsp文件：\n\n访问上传成功后的地址：\nhttp://**.**.**.**/web/testabc.jsp\n\n\n受影响的站点很多，列几个：\n银联 https://**.**.**.**/web/testabc.jsp人保财险 http://**.**.**.**/web/testabc.jsp交行信用卡 http://**.**.**.**/web/abctest.jsp猎豹 http://**.**.**.**/web/testabc.jsp上海电信 http://**.**.**.**/web/testabc.jsp\n上传包打了个码，相关HTML放到代码测试区了。   漏洞证明：  同上   修复方案：  1、过滤filename参数传递的../字符2、过滤filename参数传递文件后缀   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-12-04 08:30 厂商回复： 非常感谢 applychen@乌云 对我们ICC在线客服产品安全的关注，经验证我们已经确认此问题的存在，目前我们已经修复了此漏洞，并通知所有受影响的用户及时更新，我们致力于为用户提供安全可靠的软件产品，并乐意接受所有关注我们产品的安全研究者的指正，努力提高软件产品安全性和产品质量。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-12-03 10:49 |    \t\t岛云首席鉴黄师 \t\t\t( 普通白帽子  |\t\t\t        Rank:460 漏洞数:125        | icisaw.cn 超低价虚拟主机VPS 购买返现 支...)\t\t \n  坐等忽略    \n     2015-12-03 11:25 |    \t\tapplychen  \t\t\t( 普通白帽子  |\t\t\t        Rank:482 漏洞数:43        | 白发现首)\t\t \n  坐等确认    \n     2015-12-03 11:31 |    \t\t我的邻居王婆婆 \t\t\t( 普通白帽子  |\t\t\t        Rank:2991 漏洞数:508        | 刚发现个好洞网站就挂了)\t\t \n  快告诉我细节，好人    \n     2015-12-03 11:31 |    \t\thh2014 \t\t\t( 普通白帽子  |\t\t\t        Rank:535 漏洞数:119        | Rank:600 漏洞数120| Rank:700 漏洞数140...)\t\t \n  这么快给钱了,恭喜洞主    \n     2015-12-03 11:40 |    \t\t我的邻居王婆婆 \t\t\t( 普通白帽子  |\t\t\t        Rank:2991 漏洞数:508        | 刚发现个好洞网站就挂了)\t\t \n  @applychen  2000有吗    \n     2015-12-03 11:59 |    \t\t带我玩 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:7        | 带我玩)\t\t \n  坐等忽略     \n     2015-12-03 12:12 |    \t\tapplychen  \t\t\t( 普通白帽子  |\t\t\t        Rank:482 漏洞数:43        | 白发现首)\t\t \n  @我的邻居王婆婆 肯定有啊    \n     2015-12-03 13:47 |    \t\ts4cr00t \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:7        | 自由，共享，平等)\t\t \n  这次会忽略吗？    \n     2015-12-03 14:20 |    \t\t表哥 \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:11        | 他依然帅气。)\t\t \n  坐等忽略    \n     2015-12-03 15:14 |    \t\tHonker红颜 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:52        | 皖南人士,90后宅男,自学成才,天朝教育失败....)\t\t \n  坐等忽略     \n     2015-12-03 15:30 |    \t\tMrFk \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 蒻蒟)\t\t \n  太强了    \n     2015-12-03 15:39 |    \t\tboooooom  \t\t\t( 普通白帽子  |\t\t\t        Rank:473 漏洞数:51        | 我有一个好想法！)\t\t \n  厉害啊！    \n     2015-12-03 16:07 |    \t\t帅 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:2        | 一个正经的JAVA程序猿)\t\t \n  前排混脸熟    \n     2015-12-03 16:22 |    \t\tccl \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:8        | 精通web渗透测试。熟悉java web开发，jsp s...)\t\t \n  nice!!!!!!1    \n     2015-12-03 20:12 |    \t\t0x 80 \t\t\t( 普通白帽子  |\t\t\t        Rank:1578 漏洞数:451        | 某安全公司招聘渗透测试工程师，具备3-5年...)\t\t \n  沙发    \n     2015-12-03 20:54 |    \t\tPharaoh \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | hello world)\t\t \n  忽略忽略忽略忽略……    \n     2015-12-03 21:09 |    \t\tFire ant \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:32        | 他们回来了................)\t\t \n  忽略忽略忽略忽略……    \n     2015-12-07 18:17 |    \t\t一升米 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 起步学习阶段，求指导，求进步)\t\t \n  好奇是多少大洋    \n     2015-12-07 18:32 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1228 漏洞数:327        | 穷苦人家的孩子)\t\t \n  @一升米 2000    \n     2015-12-07 19:04 |    \t\t一升米 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 起步学习阶段，求指导，求进步)\t\t \n  @Huc-Unis 怎么看出来的？？是因为2个$符号？好好好奇    \n     2015-12-07 19:06 |    \t\tU神 \t\t\t( 普通白帽子  |\t\t\t        Rank:1343 漏洞数:148        | 五个乌云币都不给我留着，兄弟们太小气了吧)\t\t \n  @一升米 看漏洞质量就知道了    \n     2015-12-07 21:59 |    \t\t一升米 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 起步学习阶段，求指导，求进步)\t\t \n  @U神 好吧，感谢大神指点。。。。。    \n     2015-12-08 00:38 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1228 漏洞数:327        | 穷苦人家的孩子)\t\t \n  @一升米 u牛正解    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}