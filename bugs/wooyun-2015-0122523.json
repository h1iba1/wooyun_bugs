{"id": 24422, "wybug_id": "wooyun-2015-0122523", "wybug_title": "正方教务管理系统最新版无条件注入&amp;GetShell", "wybug_corp": "zfsoft.com", "wybug_author": "RedFree", "wybug_date": "2015-06-24 17:53", "wybug_open_date": "2015-09-26 07:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧", "正方教务", "注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-26：\t细节向公众公开  简要描述： 最新几个版本正方教务系统的SQL注入漏洞，无需任何条件！真正的教务杀手，获取教师、部门用户密码，查看妹子信息不是梦! 详细说明：      正方教务系统提供了一系列的WebService接口，然而这些接口并未经过严格的认证，从而导致任何浏览者都可以使用这些接口查询信息。由于其对用户提交的参数未进行过滤，从而导致注入的发生！    搜索发现正方教务系统的asmx文件大致有这么些：\n\n【1】文件管理接口    首先查看file.asmx：\n\n    checkFile（检查文件是否存在）只要求提供一个文件路径便可以工作。\n\n    尝试使用soap协议去请求：\n\n\n\n    UpFile2Dir（上传文件到指定目录），本以为这个接口有些利用价值，然而看完代码后却发现根本无法利用。代码如下：\n\n    其中的 checkFilePath函数是来检查filepath是否法的，当然这个filepath并不是指文件路径，它是写在配置文件中的一系列字串。然而通过对众多正方教务系统的测试发现，基本上都没有配置这个字串。所以无论你的filePath是什么，当调用UpFile2Dir时均会报“未设置可信地址”这个错误。从日志的记录中也印证了这一点：\n\n【2】各类查询接口    正方教务系统同样提供了各类查询接口，我仅仅研究了service.asmx和service1.asmx中的数个接口便发现了众多的注入。\n\n    需要注意的是这些接口中需要提供strPass，和strKey这两个参数（有的只用提供strKey有的需要提供strPass，有的则两都都要提供）。经过反编译发现strPass是从数据库中查询出来的（不过悲剧的是绝大多数的正方教务系统并没有wsmmb这个表，估计这是历史遗留下的接口。。。）：\n\n    而strKey是定义好的常量（\nsKey = \"KKKGZ2312\";\n）：\n\n    到这里已经非常显然了，有了sKey就可以去查询一些接口了。【3】查询接口注入    比如BMCheckPassword（检查部门账号密码？）：\n\n    实际上只提供strYHM、sKey这两个参数就可查询了，如图（提供正确的用户名时回显结果为5，用户名错误时回显结果为3）：\n\n\n\n    尝试在这里构造注入语句：\n\n\n\n    使用这样的payload来查询jwc01的密码：\njwc01' and (SELECT SUBSTR(TO_CHAR(KL),1,1) from yhb where yhm='jwc01')='a\n\n\n    最后得到jwc01的加密密码为：2jl)Dssu，解密得：llj@usst\n\n    登录教务系统：\n\n【4】更粗暴的注入    获得上面接口的注入点后，我并满足，因为更新一点版本的正方教务系统已经去掉了BMCheckPassword这个接口，于是继续寻找。功夫不负有心人最终找到了GetStuCheckinInfo这个接口中存在的注入。\n\n\n\n    提供学号、学年+学期、sKey便可以查询。然而这个接口注入的粗暴之处在于可以使用union查询。\n\n\n\n    学号处构造这样的payload测试：\n222222' union select Null,'test',Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null from yhb where 'a'='a\n\n\n    查询jwc01的密码：\n\n    获得加密密码：zaqtHswK 解密得：1qaz2wsx。登录jwc01这个账号：\n\n【5】GetShell绝杀正方教务系统    您可能要问了：为什么你这么跟jwc01过不去呢？原因很简单：1、jwc01是正方教务系统的初始管理账户，基本上每个教务系统都存在这个账户不必要再麻烦的去获取数据库中的账户信息了。2、正如1所述，jwc01是初始管理账户，拥有很高的权限！1、低版本的正方    会对低版本的正方教务系统，可以在教务公告发布那里直接上传ashx文件来取得webshell。有时候教务公告发布这个页面并没有给出链接（当然页面是一直存在的），可以F12随便修改个链接为：\n<a onclick=\"GetMc('教务公告发布');\" target=\"zhuti\" href=\"jwggfb.aspx?xh=jwc01&xm=&gnmkdm=N120201\">教务公告发布</a>\n然后点击标签，你会发现教务公告发布页面打开了！    上传的文件后保存到/wbwj/这个目录中去，上传生成aspx文件的ashx到wbwj,访问测试（当然直接上传ashx类型的webshell也是可行的）：\n\n\n\n\n\n2、高版本的正方    高版本的正方教务系统如果提交的文件名中含有asp、cer、aspx、cdx、asa等这些关键字（只要文件名或后缀中含有这些关键字）就会拦截掉请求。\n\n    审计反编译的代码得知允许上传的缀列表保存在表fjsckzb中：\n\n    允许上传的后缀SYFLG列标记为1，很显然，除了这些后缀其它的均不允许上传。    尝试上传ashx文件：\n\n那么可不可以添加一条后缀到这个表中呢？(我对Oracle了解的不够深入，不知道如何通过注入点多行查询去insert一条记录。。。）然而我使用了另一种方法：通过注入点（正方默认连接的账号是DBA）获取数据库的账号密码之后内网连接数据库或是使用Oracle提供的isqlplus登录：http://jwgl.xx.edu.cn:5560/isqlplus。之后再将ashx后缀添加到可上传列表，管理账号登录上传>取得webshell。（事实上只要获得了DBA权限的账号和密码，就可以使用JAVA来执行命令了*^_^*）\n\n\n\n \n受限于我现在的网络环境，以前使用isqlplus已成功执行命令的内网案例不能截图证明。如审核需要我提供5个以上的通用案例，可再联系我。\n   漏洞证明：  \n\n\n\n   修复方案：  全面检查webservice接口！   版权声明：转载请注明来源 RedFree@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-06-28 07:48 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-24 18:07 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  mark    \n     2015-06-24 18:12 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  开始玩这个咯    \n     2015-06-24 18:19 |    \t\tMayIKissYou \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:33        | 勿忘初心)\t\t \n  不是说是搬砖的么 这也会么    \n     2015-06-24 18:24 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  目前很多系统都存在这问题，尤其是java 应该算是短板了    \n     2015-06-24 18:30 |    \t\t幽灵 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:6        | 一步一步)\t\t \n  期待...    \n     2015-06-24 18:37 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  不知道和我手里的一样不。先观望。    \n     2015-06-24 18:38 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  卧槽，这对偶们学生狗是绝对的福利啊。    \n     2015-06-24 18:44 |    \t\tRedFree \t\t\t( 普通白帽子  |\t\t\t        Rank:180 漏洞数:40        | 每个系统都有它自身的弱点，无论是相对的还...)\t\t \n  @MayIKissYou 搬砖的也要多学些姿势嘛；我说：学到老，活到老；从而得知：不学习会死.*^_^*.@sin 若是和你手里的一样，那你就有点亏了，应该早点提交到乌云。    \n     2015-06-24 18:45 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  @RedFree 之前提了一批正方洞的到360了的。感觉厂商那边还是不重视，提的就没意思了。    \n     2015-06-24 20:34 |    \t\tFire ant \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:26        | 他们回来了................)\t\t \n  mark    \n     2015-06-24 20:47 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  这个叼    \n     2015-06-24 22:20 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @felixk3y 正方新版用Java了？    \n     2015-06-24 22:43 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  看来落后了    \n     2015-06-24 23:06 |    \t\treality0ne \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:7        )\t\t \n  学校穷的连新版有用不起了噜。。。    \n     2015-06-24 23:16 |    \t\tVirink \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 呵呵)\t\t \n  @sin 这个意思是你已经XXOO了各大高校、、、、妹子的信息、、    \n     2015-06-28 11:11 |    \t\t1c3z \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:29        | 我读书少，你可别骗我！！！)\t\t \n  快交出妹子    \n     2015-06-28 13:24 |    \t\t晏子 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 无)\t\t \n  急切求看    \n     2015-06-28 14:54 |    \t\tV-King \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:7        | 我是静静)\t\t \n  期末临近了....    \n     2015-07-27 09:09 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  @wefgod SSH框架    \n     2015-07-29 18:33 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @BeenQuiver 哦很久没关注了，新版已经换了啊    \n     2015-08-25 13:11 |    \t\twellsun \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | www.wellsun.com)\t\t \n  目测webservices XML injection    \n     2015-09-26 07:59 |    \t\t小2b \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 努力赚钱)\t\t \n  屌的不行    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}