{"id": 52001, "wybug_id": "wooyun-2014-072670", "wybug_title": "qibocms b2b 二次注入一枚。", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-08-18 16:22", "wybug_open_date": "2014-11-16 16:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-16：\t细节向公众公开  简要描述： 应该是qibo的最后一弹了。 详细说明：  所测试的  http://down.qibosoft.com/down.php?v=b2b_________________________________________________________________________在hy/member/homapage_ctrl/info.php中\n$db->query(\"INSERT INTO `{$_pre}company_fid` VALUES $values\");\t\t$title=filtrate($title);\t$picurl=filtrate($picurl);\t$fname=filtrate($fname);\t$my_trade=filtrate($my_trade);\t$qy_cate=filtrate($qy_cate);\t$qy_regmoney=filtrate($qy_regmoney);\t$qy_saletype=filtrate($qy_saletype);\t$qy_pro_ser=filtrate($qy_pro_ser);\t$my_buy=filtrate($my_buy);\t$qy_regplace=filtrate($qy_regplace);\t$db->query(\"UPDATE `{$_pre}company` SET \t`title`='$title',\t`picurl`='$picurl',\t`fname`='$fname',\t`province_id`='{$province_id}',\t`city_id`='{$postdb[city_id]}',\t\t`zone_id`='{$postdb[zone_id]}',\t\t`street_id`='{$postdb[street_id]}',\t`my_trade`='$my_trade',\t`qy_cate`='$qy_cate',\t`qy_regmoney`='$qy_regmoney',\t`qy_saletype`='$qy_saletype',\t`qy_createtime`='$qy_createtime',\t`qy_pro_ser`='$qy_pro_ser',\t`my_buy`='$my_buy',\t`qy_regplace`='$qy_regplace'\tWHERE uid='$uid'\");\n$title=filtrate($title); 这里进行了个过滤\nfunction filtrate($msg){\t//$msg = str_replace('&','&amp;',$msg);\t//$msg = str_replace(' ','&nbsp;',$msg);\t$msg = str_replace('\"','&quot;',$msg);\t$msg = str_replace(\"'\",'&#39;',$msg);\t$msg = str_replace(\"<\",\"&lt;\",$msg);\t$msg = str_replace(\">\",\"&gt;\",$msg);\t$msg = str_replace(\"\\t\",\"   &nbsp;  &nbsp;\",$msg);\t//$msg = str_replace(\"\\r\",\"\",$msg);\t$msg = str_replace(\"   \",\" &nbsp; \",$msg);\treturn $msg;}\n这里过滤了单引号　转义符没过滤。然后就带入到update中 入库了。在hy/member/cankao.php中\n$companydb=$db->get_one(\"SELECT * FROM {$_pre}company WHERE uid='$uid' LIMIT 1\");if(!$companydb[if_homepage]){\tshowerr(\"您还没有申请企业商铺,<a href='$Murl/member/post_company.php?action=apply'>点击这里申请企业商铺</a>，拥有自己的商铺\");}\n这里查询出来了        $title = filtrate($title);\t$url = filtrate($url);\t$description = filtrate($description);\tif($ck_id){\t\t$db->query(\"UPDATE `{$_pre}friendlink` SET\t\ttitle='$title',\t\turl='$url',\t\tdescription='$description',\t\tyz=1\t\tWHERE ck_id='$ck_id';\");\t}else{\t\t$db->query(\"INSERT INTO `{$_pre}friendlink` ( `ck_id` , `uid` , `username` ,  `companyName` , `title` , `url` , `description` , `yz` ) VALUES ('', '$lfjuid', '$lfjid', '$companydb[title]', '$title', '$url', '$description', '1')\");\t}</code>然后这里把出库的$companydb[title] 也带入到了查询当中 所以这里我们可以引入转义符了。然后后面的变量刚好也是可以控制的 所以就可以注入了。\n\n把名字改成这样 然后\n\n报错了。构造一下\n\n\n\n成功出数据。   漏洞证明：  \n\n   修复方案：  \nelse{ $companydb[title]=addslashes($companydb[title]);\t\t$db->query(\"INSERT INTO `{$_pre}friendlink` ( `ck_id` , `uid` , `username` ,  `companyName` , `title` , `url` , `description` , `yz` ) VALUES ('', '$lfjuid', '$lfjid', '$companydb[title]', '$title', '$url', '$description', '1')\");\t}\n对出库的转义一下把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-18 18:25 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-18 16:27 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  前排瓜子    \n     2014-08-18 16:33 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  qibo走小厂商？  表示呵呵    \n     2014-08-18 17:22 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  没上首页？呵呵    \n     2014-08-18 17:23 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @索马里的海贼 哈哈 也是过程太简单了。         运气不错 。    \n     2014-08-18 20:04 |    \t\tLet a person cry. \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:9        | xxoo)\t\t \n  qibo也走小厂商，那么没法混了，哈哈    \n     2014-10-16 11:00 |    \t\t0c0c0f \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | My H34rt c4n 3xploit 4ny h0les!)\t\t \n  表示还可以测试成功哇    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}