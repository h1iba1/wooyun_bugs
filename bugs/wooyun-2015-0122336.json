{"id": 28495, "wybug_id": "wooyun-2015-0122336", "wybug_title": "dtcms最新版任意文件删除漏洞(补丁修复不给力绕过继续删除)", "wybug_corp": "dtcms.net", "wybug_author": "不能忍", "wybug_date": "2015-06-25 12:07", "wybug_open_date": "2015-09-23 12:12", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向公众公开  简要描述： http://www.wooyun.org/bugs/wooyun-2014-060431就是这个bug的补丁不给力，所以继续删除 详细说明：  同样的是tools/upload_ajax.ashx:\t\tprivate void UpLoadFile(HttpContext context)\t\t{\t\t\tDTcms.Model.siteconfig siteConfig = new DTcms.BLL.siteconfig().loadConfig();\t\t\tstring _delfile = DTRequest.GetString(\"DelFilePath\");\t\t\tHttpPostedFile _upfile = context.Request.Files[\"Filedata\"];\t\t\tbool _iswater = false;\t\t\tbool _isthumbnail = false;\t\t\tif (DTRequest.GetQueryString(\"IsWater\") == \"1\")\t\t\t{\t\t\t\t_iswater = true;\t\t\t}\t\t\tif (DTRequest.GetQueryString(\"IsThumbnail\") == \"1\")\t\t\t{\t\t\t\t_isthumbnail = true;\t\t\t}\t\t\tif (_upfile == null)\t\t\t{\t\t\t\tcontext.Response.Write(\"{\\\"status\\\": 0, \\\"msg\\\": \\\"请选择要上传文件！\\\"}\");\t\t\t}\t\t\telse\t\t\t{\t\t\t\tUpLoad upFiles = new UpLoad();\t\t\t\tstring msg = upFiles.fileSaveAs(_upfile, _isthumbnail, _iswater);\t\t\t\tif (!string.IsNullOrEmpty(_delfile) && _delfile.ToLower().StartsWith(siteConfig.webpath.ToLower() + siteConfig.filepath.ToLower()))\t\t\t\t{\t\t\t\t\tUtils.DeleteUpFile(_delfile);\t\t\t\t}\t\t\t\tcontext.Response.Write(msg);\t\t\t\tcontext.Response.End();\t\t\t}\t\t}补丁应该就是：if (!string.IsNullOrEmpty(_delfile) && _delfile.ToLower().StartsWith(siteConfig.webpath.ToLower() + siteConfig.filepath.ToLower()))这里其实就是读取xmlconfig/site.config配置文件，里面有webpath => \"/\"和filepath => \"upload\"也就是说只要我们提交的DelFilePath中以/upload开头就可以绕过这个逻辑判断了，那么我们可以构造：DelFilePath=/upload/../web.config   漏洞证明：  这里我们同样是demo演示:\n\n这个是第一次上传\n\n这里是删除了同样的我们把DelFilePath=/upload/../web.config传过去，网站配置文件就删掉了!   修复方案：  补丁的补丁   版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-06-25 12:10 厂商回复： 我们继续跟进及处理 最新状态： 2015-09-16：已对4.0上传进行修补工作，下载最新的源码及补丁即可解决问题。  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}