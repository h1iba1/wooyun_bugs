{"id": 5425, "wybug_id": "wooyun-2013-046216", "wybug_title": "Destoon全版本通杀SQL注入", "wybug_corp": "DESTOON", "wybug_author": "Chora", "wybug_date": "2013-12-17 14:49", "wybug_open_date": "2014-03-17 14:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-17：\t细节向公众公开  简要描述： 还有一个类似的点在特定的环境里触发，还没测试，明天测试了再说。 详细说明：  common.inc.php 0x00\nif(!empty($_SERVER['REQUEST_URI'])) strip_uri($_SERVER['REQUEST_URI']); //跟进0x01if($_POST) { $_POST = strip_sql($_POST); strip_key($_POST); }//跟进0x01if($_GET) { $_GET = strip_sql($_GET); strip_key($_GET); }if($_COOKIE) { $_COOKIE = strip_sql($_COOKIE); strip_key($_COOKIE); }if(!IN_ADMIN) {\t$BANIP = cache_read('banip.php');\tif($BANIP) banip($BANIP);\t$destoon_task = '';}if($_POST) extract($_POST, EXTR_SKIP);if($_GET) extract($_GET, EXTR_SKIP);......$forward = isset($forward) ? urldecode($forward) : $DT_REF;//用这里的urldecode来绕过。......\ninclude/global.func.php 0x01\nfunction strip_uri($uri) { //检查了REQUEST_URI,里面有%就解码，解到最后检查敏感字符，我们要引入'，即使我们双编码过后，最终还是会被还原成',这里检查了',所以GET提交无解，但是我们POST提交的话,REQUEST_URI就不会接受任何数据，从而绕过了检查。\tif(strpos($uri, '%') !== false) {\t\twhile($uri != urldecode($uri)) {\t\t\t$uri = urldecode($uri);\t\t}\t}\tif(strpos($uri, '<') !== false || strpos($uri, \"'\") !== false || strpos($uri, '\"') !== false || strpos($uri, '0x') !== false) {\t\tdhttp(403, 0);\t\tdalert('HTTP 403 Forbidden', DT_PATH);\t}}function strip_sql($string) {//一长串过滤。我们绕过了上面，下面的话可以采用URL双编码绕过。比如union就可以写成unoin%256E来绕过，前提是要有urldecode或者rawurldecode。\t$search = array(\"/union/i\",\"/0x([a-z0-9]{2,})/i\",\"/select([[:space:]\\*\\/\\-])/i\",\"/update([[:space:]\\*\\/])/i\",\"/replace([[:space:]\\*\\/])/i\",\"/delete([[:space:]\\*\\/])/i\",\"/drop([[:space:]\\*\\/])/i\",\"/outfile([[:space:]\\*\\/])/i\",\"/dumpfile([[:space:]\\*\\/])/i\",\"/load_file\\(/i\",\"/substring\\(/i\",\"/substr\\(/i\",\"/concat\\(/i\",\"/concat_ws\\(/i\",\"/ascii\\(/i\",\"/hex\\(/i\",\"/ord\\(/i\",\"/char\\(/i\");\t$replace = array('unio&#110;','0&#120;\\\\1','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','outfil&#101;\\\\1','dumpfil&#101;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','conca&#116;(','concat_w&#115;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($search, $replace, $string);}\n绕过了上面就简单了。module/member/chat.inc.php\nswitch($action) {......default:\t\tif(isset($touser) && check_name($touser)) {\t\t\tif($touser == $_username) dalert('不能与自己对话', 'chat.php');\t\t\tif(!$MG['chat']) {\t\t\t\tlogin(); //当然要登陆咯。\t\t\t\tdalert('您所在的会员组没有权限发起对话', 'grade.php');\t\t\t}\t\t\t$user = userinfo($touser);\t\t\t$user or dalert('会员不存在', 'chat.php');\t\t\tif($user['black']) {\t\t\t\t$black = explode(' ', $user['black']);\t\t\t\tif(in_array($chatuser, $black)) dalert('对方拒绝与您对话', 'chat.php');\t\t\t\tif(!$_username && in_array('Guest', $black)) dalert('对方拒绝与您对话', 'chat.php');\t\t\t}\t\t\t$chat_fromuser = $chatuser;\t\t\t$chat_touser = $touser;\t\t\t$chat_id = $chatid = get_chat_id($chat_fromuser, $chat_touser);\t\t\t$online = online($user['userid']);\t\t\t$user['type'] = 'member';\t\t\t$type = 1;\t\t\tif(!$_userid && !is_file(get_chat_file($chatid))) $type = 4;\t\t\t$head_title = '与【'.$user['company'].'】对话中';\t\t\t$chat = $db->get_one(\"SELECT * FROM {$table} WHERE chatid='$chatid'\");\t\t\t$chat_status = 3;\t\t\tif($chat) { //第一次创建会话的时候执行下面的else，创建过后执行if下面的。\t\t\t\t//对话已经存在\t\t\t\tif($chat['touser'] == $_username) {//当前为接收人\t\t\t\t\tif($DT_TIME - $chat['freadtime'] > $MOD['chat_poll']*3) {//发起对话人已经断开\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET fromuser='$chat_fromuser',touser='$chat_touser',tgettime=0 WHERE chatid='$chatid'\");\t\t\t\t\t} else {//发起人在线\t\t\t\t\t\tdheader('?chatid='.$chatid);\t\t\t\t\t}\t\t\t\t\t//\t\t\t\t} else {//当前为发起人\t\t\t\t\tif($DT_TIME - $chat['treadtime'] > $MOD['chat_poll']*3) {//接收人已经断开\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET tgettime=0 WHERE chatid='$chatid'\");\t\t\t\t\t} else {//接收人在线\t\t\t\t\t\t//\t\t\t\t\t}\t\t\t\t}\t\t\t} else {//第一次执行这里。\t\t\t\t$forward = dsafe($forward);//过滤某些敏感字符的函数，不跟了。累死懒得贴，反正还是双编码绕过就行了。\t\t\t\tif(strpos($forward, $MOD['linkurl']) !== false) $forward = '';\t\t\t\t//创建一个新对话\t\t\t\t$db->query(\"INSERT INTO {$table} (chatid,fromuser,touser,tgettime,forward) VALUES ('$chat_id','$chat_fromuser','$chat_touser','0','$forward')\"); //关键点！0x00已经贴出来了$forward是urldecode所解码而得到的,所以我们能引入'来进行注射。记得$chat_touser要等于当前用户，这样做是为了下面的可显查询。不然就只能盲注。\t\t\t}\t\t} else if(isset($chatid) && is_md5($chatid)) {\t\t\t$chat = $db->get_one(\"SELECT * FROM {$table} WHERE chatid='$chatid'\"); //这里构造我们刚刚插入的$chatid的值就可以查询出来了。\t\t\tif($chat && $chat['touser'] == $_username) {//等于当前用户。\t\t\t\t$chat_id = $chatid;\t\t\t\t$chat_status = 3;\t\t\t\tif(check_name($chat['fromuser'])) {\t\t\t\t\tif($DT_TIME - $chat['freadtime'] > $MOD['chat_poll']*3) {//发起对话人已经断开\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET tgettime=0 WHERE chatid='$chatid'\");\t\t\t\t\t\tdheader('chat.php?touser='.$chat['fromuser']);\t\t\t\t\t}\t\t\t\t\t$user = userinfo($chat['fromuser']);\t\t\t\t\t$online = online($user['userid']);\t\t\t\t\t$user['type'] = 'member';\t\t\t\t} else {\t\t\t\t\t$user = array();\t\t\t\t\t$user['type'] = 'guest';\t\t\t\t\t$user['ip'] = $chat['fromuser'];\t\t\t\t\t$user['area'] = ip2area($chat['fromuser']);\t\t\t\t\tif($DT_TIME - $chat['freadtime'] > $MOD['chat_poll']*3) {//发起人是游客，并且已经断开，只能查看记录\t\t\t\t\t\t$time = $DT_TIME - $MOD['chat_poll']*4;\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET freadtime='$time' WHERE chatid='$chatid'\");\t\t\t\t\t}\t\t\t\t}\t\t\t\t$head_title = '与'.($user['type'] == 'guest' ? '【游客】' : $chat['fromuser']).'对话中';\n是root权限又能引入单引号的话各显神通吧。   漏洞证明：  \n\n\n\n\n\n\n\n\n\n   修复方案：  休息。。。   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2013-12-19 16:06 厂商回复： 已确认存在，我们会尽快修复 最新状态： 2013-12-20：感谢Chora，已修复，详见：http://bbs.destoon.com/thread-55559-1-1.html  ", "replys": "漏洞评价：\n评论\n     2013-12-17 15:01 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  牛逼，必须给宝贝儿捧场，求分钱！    \n     2013-12-17 15:45 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  又是destoon的全版本，这,,,什么时候大家搞帝国的啊，那些都是牛B的站啊    \n     2013-12-17 17:00 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  又来赚妹子钱了    \n     2013-12-17 17:22 |    \t\tChora \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:22        | 生存、生活、生命。)\t\t \n  @小胖子 么么哒，大宝贝，都快过年了，陪睡这么久了，不发红包也要发辛苦费啊。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}