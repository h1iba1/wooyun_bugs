{"id": 33999, "wybug_id": "wooyun-2015-0107491", "wybug_title": "创想oa二次注入", "wybug_corp": "天生创想oa", "wybug_author": "also", "wybug_date": "2015-04-27 16:27", "wybug_open_date": "2015-07-29 10:38", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-29：\t细节向公众公开  简要描述： 过份相信从数据库里面取出的数据造成sql注入 详细说明：  \nelseif ($do == 'add') {\t\tif($_POST['view']!=''){\t\t$id = getGP('id','P','int');\t\tif($id!=''){\t\t\t$title = check_str(getGP('title','P'));\t\t\t$subject = check_str(getGP('subject','P'));\t\t\t$content = getGP('content','P');\t\t\t$attendance = getGP('participation','P');\t\t\t$startdate = getGP('startdate','P').\" \".getGP('starttime1','P').\":\".getGP('starttime2','P');\t\t\t$enddate = getGP('enddate','P').\" \".getGP('endtime1','P').\":\".getGP('endtime2','P');\t\t\t$conferenceroom = getGP('conferenceroom','P');\t\t\t$otype = getGP('otype','P');\t\t\t$staffidsms=getGP('staffid','P');\t\t\t$conference = array(\t\t\t\t'title' => $title,\t\t\t\t'subject' => $subject,\t\t\t\t'content' => $content,\t\t\t\t'attendance' => $attendance,\t\t\t\t'startdate' => $startdate,\t\t\t\t'enddate' => $enddate,\t\t\t\t'conferenceroom' => $conferenceroom,\t\t\t\t'otype' => $otype\t\t\t);                        #print_r($conference);exit;\t\t\tupdate_db('conference',$conference, array('id' => $id));\t\t\t$content='';\t\t\t$content=serialize($conference);\t\t\t$title='编辑会议信息';\t\t\tget_logadd($id,$content,$title,19,$_USER->id);\t\t\t\t\t}else{\t\t\t$title = check_str(getGP('title','P'));\t\t\t$subject = check_str(getGP('subject','P'));\t\t\t$content = getGP('content','P');\t\t\t$appperson = check_str(getGP('apppersonid','P'));\t\t\t$recorduser = check_str(getGP('recorduserid','P'));\t\t\t$date = get_date('Y-m-d H:i:s',PHP_TIME);\t\t\t$attendance = check_str(getGP('participation','P'));\t\t\t$startdate = getGP('startdate','P').\" \".getGP('starttime1','P').\":\".getGP('starttime2','P');\t\t\t$enddate = getGP('enddate','P').\" \".getGP('endtime1','P').\":\".getGP('endtime2','P');\t\t\t$conferenceroom = check_str(getGP('conferenceroom','P'));\t\t\t$type = 1;\t\t\t$otype = getGP('otype','P');\t\t\t$staffid = getGP('staffidid','P'); //漏洞的开始在这里形成  getGP函数只是进行了简单过滤将敏感字符替换为空如select等 绕过方法有大小写绕过和seselctlectd等这样的方法\t\t\t$uid=$_USER->id;\t\t\t$apppersonsms=check_str(getGP('appperson','P'));\t\t\t$staffidsms=check_str(getGP('staffid','P'));\t\t\t$conference = array(\t\t\t\t'title' => $title,\t\t\t\t'subject' => $subject,\t\t\t\t'content' => $content,\t\t\t\t'appperson' => $appperson,\t\t\t\t'recorduser' => $recorduser,\t\t\t\t'date' => $date,\t\t\t\t'attendance' => $attendance,\t\t\t\t'startdate' => $startdate,\t\t\t\t'enddate' => $enddate,\t\t\t\t'conferenceroom' => $conferenceroom,\t\t\t\t'type' => $type,\t\t\t\t'staffid' => $staffid,\t\t\t\t'uid' => $uid,\t\t\t\t'otype' => $otype\t\t\t);\t\t\tinsert_db('conference',$conference); //将$conference的数据插入到conference数据库中 value内容可控但是被转义，没有关系插入到数据库里面后会反转义一次\t\t\t$id=$db->insert_id();\t\t\tif(getGP('sms_info_box_appperson','P')!=''){\t\t\t\t$content='';\t\t\t\t$content=$apppersonsms.':您申请的会议室己经提交,请注意查看!';\t\t\t\t$content.='<a href=\"admin.php?ac='.$ac.'&fileurl='.$fileurl.'&do=views';\t\t\t\t$content.='&id='.$id.'\">点击查看>></a>';\t\t\t\tSMS_ADD_POST($apppersonsms,$content,0,0,$_USER->id);\t\t\t}\t\t\tif(getGP('sms_phone_box_appperson','P')!=''){\t\t\t\t$content='';\t\t\t\t$content=$apppersonsms.':您申请的会议室己经提交,请登录OA进行查看!';\t\t\t\tPHONE_ADD_POST(getGP('apppersonphone','P'),$content,$apppersonsms,0,0,$_USER->id);\t\t\t}\t\t\t//出席人员\t\t\tif(getGP('sms_info_box_participation','P')!=''){\t\t\t\t$content='';\t\t\t\t$content='您有一个会议需要出席,申请人是:\"'.$apppersonsms.'\",请注意查看会议出席时间!<a href=\"admin.php?ac='.$ac.'&fileurl='.$fileurl.'&do=views&id='.$id.'\">点击查看>></a>';\t\t\t\t\t\t\t\tSMS_ADD_POST($attendance,$content,0,0,$_USER->id);\t\t\t}\t\t\t\t\t\tif(getGP('sms_phone_box_participation','P')!=''){\t\t\t\t$content='';\t\t\t\t$content='您有一个会议需要出席,申请人是:\"'.$apppersonsms.'\",请登录OA查看会议出席时间!';\t\t\t\tPHONE_ADD_POST(getGP('participationphone','P'),$content,$attendance,0,0,$_USER->id);\t\t\t}\t\t\t//审批人员\t\t\tif(getGP('sms_info_box_staffid','P')!=''){\t\t\t\t$content='';\t\t\t\t$content=$staffidsms.':有一个会议申请需要您审批,申请人是:\"'.$apppersonsms.'\",请进入会议管理进行审批!<a href=\"admin.php?ac='.$ac.'&fileurl='.$fileurl.'&do=views&id='.$id.'\">点击审批>></a>';\t\t\t\t\t\t\t\tSMS_ADD_POST($staffidsms,$content,0,0,$_USER->id);\t\t\t}\t\t\t\t\t\tif(getGP('sms_phone_box_staffid','P')!=''){\t\t\t\t$content='';\t\t\t\t$content=$staffidsms.':有一个会议申请需要您审批,申请人是:\"'.$apppersonsms.'\",请登录OA进行审批!';\t\t\t\tPHONE_ADD_POST(getGP('staffidphone','P'),$content,$staffidsms,0,0,$_USER->id);\t\t\t}\t\t\t$content='';\t\t\t$content=serialize($conference);\t\t\t$title='新增会议信息';\t\t\tget_logadd($id,$content,$title,19,$_USER->id);\t\t}\t\tshow_msg('会议信息操作成功！', 'admin.php?ac='.$ac.'&fileurl='.$fileurl.'');\t}else{\t\t$id = getGP('id','G','int');\t\tif($id!=''){\t\t\tget_key(\"istration_conference_edit\");\t\t\t$user = $db->fetch_one_array(\"SELECT * FROM \".DB_TABLEPRE.\"conference  WHERE id = '$id'\");\t\t\t$startdate=explode(' ',$user['startdate']);\t\t\t$starttime=explode(':',$startdate[1]);\t\t\t$enddate=explode(' ',$user['enddate']);\t\t\t$endtime=explode(':',$enddate[1]);\t\t\t$_title['name']='编辑';\t\t}else{ \t\t\tget_key(\"istration_conference_Increase\");\t\t\t$startdate=explode(' ',get_date('Y-m-d H:i:s',PHP_TIME));\t\t\t$starttime=explode(':',$startdate[1]);\t\t\t$enddate=explode(' ',get_date('Y-m-d H:i:s',PHP_TIME));\t\t\t$endtime=explode(':',$enddate[1]);\t\t\t$_title['name']='发布';\t\t}\t\tinclude_once('template/conferenceadd.php');\t\t\t}}\n\n308行else{\t\t\tif($id!=''){\t\t\t\t$blog = $db->fetch_one_array(\"SELECT * FROM \".DB_TABLEPRE.\"conference  WHERE id = '$id'\"); //取出conference表内所以的信息给$blog \t\t\t\t$record = $db->fetch_one_array(\"SELECT * FROM \".DB_TABLEPRE.\"conference_record  WHERE conferenceid = '$id'\");\t\t\t\t$_title['name']='[会议信息浏览]';\t\t\t}\t\t}\t\tinclude_once('template/conferenceviews.php'); //包含这个文件,跟进\t\t<form name=\"save\" method=\"post\" action=\"?ac=<?php echo $ac?>&fileurl=<?php echo $fileurl?>&do=views\">\t<input type=\"hidden\" name=\"view\" value=\"edit\" />\t<input type=\"hidden\" name=\"bbsid\" value=\"<?php echo $blog['id']?>\" />\t<input type=\"hidden\" name=\"author\" value=\"<?php echo get_realname($_USER->id)?>\" /><table class=\"TableBlock\" border=\"0\" width=\"90%\" align=\"center\" style=\"border-bottom:#4686c6 solid 0px;\">\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">申请时间：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $blog['date']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t\t\t<tr>      <td nowrap class=\"TableContent\"> 申请人：</td>      <td class=\"TableData\"><?php echo get_realname($blog['appperson'])?>  同样存在漏洞但是因字节数有限不好利用\t   </td>    </tr>\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">名称：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $blog['title']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">主题：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $blog['subject']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">出席人员：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $blog['attendance']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">会议开始时间：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $blog['startdate']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">会议结束时间：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $blog['enddate']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">会议室：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo get_typename($blog['conferenceroom'])?>\t同样存在漏洞但是因字节数有限不好利用\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">分类：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo get_typename($blog['otype'])?>\t\t同样存在漏洞但是因字节数有限不好利用\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">记录人员：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo get_realname($blog['recorduser'])?>\t同样存在漏洞但是因字节数有限不好利用\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"90\">审批人员：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo get_realname($blog['staffid'])?>\t把$blog['staffid']带入到get_realname 方法中\t\t代码如下：function get_realname($id=0){\tif($id!=0){\t\tglobal $db;\t\t$sql = \"SELECT name FROM \".DB_TABLEPRE.\"user_view where uid='\".$id.\"'  ORDER BY uid desc limit 0,1\"; //没有任何过滤将$id（$blog['staffid']）带入到sql语句中\t\t$row = $db->fetch_one_array($sql);\t\tif($row['name']!=''){\t\t\treturn $row['name'];\t\t}\t}}\t\t\t\t\t</td>  \t  \t\t\t</tr>\t\t\t\t\t</table>\t\t<table  width=\"90%\" style=\"border-left:#4686c6 solid 1px;border-right:#4686c6 solid 1px;border-bottom:#4686c6 solid 1px;\" align=\"center\">\t<tr>      <td colspan=\"2\" bgcolor=\"#FFFFFF\" style=\"padding:20px 20px 20px 20px;\"><?php echo $blog['content']?> </td>    </tr>\t</table>\t\t\t<?if($record['rid']!=''){?>\t\t<table width=\"90%\" border=\"0\" align=\"center\" cellpadding=\"3\" cellspacing=\"0\" class=\"small\" style='margin-top:30px;'>  <tr>    <td class=\"Big\"><img src=\"template/default/content/images/notify_new.gif\" align=\"absmiddle\"><span class=\"big3\"> 会议总结</span>    </td>  </tr></table><table class=\"TableBlock\" border=\"0\" width=\"90%\" align=\"center\" style=\"border-bottom:#4686c6 solid 0px;\">\t\t<tr>\t\t\t<td nowrap class=\"TableContent\" width=\"120\">总结时间：</td>\t\t\t  <td class=\"TableData\">\t\t\t\t\t<?php echo $record['date']?>\t\t\t\t</td>  \t  \t\t\t</tr>\t\t<tr>      <td nowrap class=\"TableContent\"> 具体出席参会人员：</td>      <td class=\"TableData\"><?php echo $record['attendance']?>     </td>    </tr>\t<tr>      <td nowrap class=\"TableContent\"> 所在会议室：</td>      <td class=\"TableData\"><?php echo get_typename($record['conferenceroom'])?></td>    </tr>\t\t<tr>      <td nowrap class=\"TableContent\"> 会议总结人：</td>      <td class=\"TableData\"><?php echo get_realname($record['recordperson'])?>     </td>    </tr>\n表结构：\n\n\n\n   漏洞证明：  \n\n\n\n   修复方案：  对数据库取出的数据再次进行过滤   版权声明：转载请注明来源 also@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-04-30 10:38 厂商回复： CNVD确认所述情况，已经由CNVD通过网站公开联系方式（或以往建立的处置渠道）向网站管理单位（软件生产厂商）通报。  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}