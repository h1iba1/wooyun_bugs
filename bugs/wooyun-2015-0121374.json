{"id": 28763, "wybug_id": "wooyun-2015-0121374", "wybug_title": "某通用教育系统任意文件上传+代码分析", "wybug_corp": "杭州东方盈动信息技术有限公司", "wybug_author": "Damo", "wybug_date": "2015-06-18 15:39", "wybug_open_date": "2015-09-21 09:20", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "13", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传", "文件上传安全", "代码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-21：\t细节向公众公开  简要描述： 主要有代码逻辑判断问题导致 详细说明：  系统：盈动信息发布系统问题文件：/Admin/WebUpload.aspx代码分析：该系统在admin目录中已经建立了web.config并且限制了用户访问但是代码如下：\n<location path=\"WebUploaded.aspx\">    <system.web>      <authorization>        <allow users=\"?\" />      </authorization>    </system.web>  </location>  <location path=\"WebUpload.aspx\">    <system.web>       <authorization>        <allow users=\"?\" />      </authorization>    </system.web>  </location>\n却允许部分页面可访问既然可访问那就看WebUpload.aspx的代码\nprotected void Ok_Click(object sender, EventArgs e)\t\t{\t\t\tstring text = \"\";\t\t\ttry\t\t\t{\t\t\t\tstring upFileType = Globals.UpFileType;/*获取允许格式白名单*/\t\t\t\tstring text2 = this.UploadFile.PostedFile.FileName;/*获取上传的文件名*/\t\t\t\tbool flag = text2 != string.Empty;\t\t\t\tif (!flag)\t\t\t\t{\t\t\t\t\ttext = \"没有选择文件！\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\ttext2 = Path.GetExtension(text2);\t\t\t\t\tint contentLength = this.UploadFile.PostedFile.ContentLength;\t\t\t\t\ttext2 = text2.Remove(0, 1);\t\t\t\t\ttext2 = text2.Trim();\t\t\t\t\ttext2 = text2.ToLower();\t\t\t\t\tif (flag)\t\t\t\t\t{\t\t\t\t\t\t/*这里判断文件大小  允许上传1M大小的文件*/\t\t\t\t\t\tflag = (Globals.MaxFileSize == 0 || (contentLength > 0 & contentLength <= Globals.MaxFileSize * 1024));\t\t\t\t\t}\t\t\t\t\tif (!flag)\t\t\t\t\t{\t\t\t\t\t\ttext = \"文件大小超过了限制，最大只能上传\" + Globals.MaxFileSize.ToString() + \"K的文件！\";\t\t\t\t\t}\t\t\t\t\telse\t\t\t\t\t{\t\t\t\t\t\tflag = (upFileType.IndexOf(text2) >= 0);/*判断后缀名*/\t\t\t\t\t\tif (!flag)\t\t\t\t\t\t{\t\t\t\t\t\t\t/*设置错误信息*/\t\t\t\t\t\t\ttext = \"这个文件类型不允许上传，只允许上传\" + upFileType + \"类型文件！\";\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\tif (flag)\t\t\t\t\t{\t\t\t\t\t\tGlobals.UploadFileNum++;\t\t\t\t\t\tstring str = \"upfile\" + Globals.UploadFileNum.ToString() + \".\" + text2;\t\t\t\t\t\tstring text3 = string.Concat(new string[]\t\t\t\t\t\t{\t\t\t\t\t\t\t\"/\",\t\t\t\t\t\t\tGlobals.ApplicationVRoot,\t\t\t\t\t\t\t\"sites/\",\t\t\t\t\t\t\tGlobals.CurrentSiteVirtualDirectory,\t\t\t\t\t\t\t\"/\",\t\t\t\t\t\t\tGlobals.SaveUpFilesPath\t\t\t\t\t\t});\t\t\t\t\t\tstring text4 = base.Server.MapPath(text3);\t\t\t\t\t\tif (text4.EndsWith(\"\\\\\"))\t\t\t\t\t\t{\t\t\t\t\t\t\ttext4 = text4.Substring(0, text4.Length - 1);\t\t\t\t\t\t}\t\t\t\t\t\ttext4 = text4 + \"\\\\\" + str;\t\t\t\t\t\ttext3 = text3 + \"/\" + str;\t\t\t\t\t\tthis.UploadFile.PostedFile.SaveAs(text4);/*保存文件*/\t\t\t\t\t\tstring returnValue = this.GetReturnValue(text3);\t\t\t\t\t\tif (returnValue != \"\")\t\t\t\t\t\t{\t\t\t\t\t\t\tbase.Response.Write(returnValue);/*输入文件名称以及路径*/\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\tcatch (Exception)\t\t\t{\t\t\t\ttext = \"文件没有保存!\";\t\t\t}\t\t\tfinally\t\t\t{\t\t\t\tif (text != \"\")\t\t\t\t{\t\t\t\t\tbase.Response.Write(\"<script>alert('\" + text + \"')</script>\");\t\t\t\t}\t\t\t}\t\t}\t}}\n利用方式：http://www.jgedu.net/Admin/WebUpload.aspx选择要上传的文件，“确定”上传完毕F12查看页面代码即可得到shell如果遇到上传完毕页面关闭之类的问题请将浏览器JavaScript禁用之后再上传 如下图\n\n   漏洞证明：  \n\nshell:http://www.jgedu.net/sites/main/UploadFiles/upfile95621.aspx    admin案例http://www.hzjlxx.com/Admin/WebUpload.aspxhttp://www.jgedu.net/Admin/WebUpload.aspxhttp://www.jhjdedu.org/Admin/WebUpload.aspxhttp://www.hujys.net/Admin/WebUpload.aspxhttp://www.hzjygh.org/Admin/WebUpload.aspx   修复方案：  this.UploadFile.PostedFile.SaveAs(text4);/*保存文件*/更改为\nif(string.IsNullOrEmpty(text)){\tbase.Response.Write(\"<script>alert('\" + text + \"')</script>\");\tbase.Response.End();//必须加}this.UploadFile.PostedFile.SaveAs(text4);/*保存文件*/\n再有就是当前目录的web.config配置不可直接访问   版权声明：转载请注明来源 Damo@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-06-23 09:19 厂商回复： CNVD确认并复现所述情况,根据实测案例,已经转由CNCERT下发给浙江分中心,由其后续协调网站管理单位处置. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-20 03:47 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  被执行人姓名/名称：\t杭州东方盈动信息技术有限公司身份证号码/组织结构代码：\t751728457法定代表或者负责人姓名：\t李国炎执行法院：\t杭州市西湖区人民法院省份：\t浙江执行依据文号：\t(2011)杭西执民字第02439号立案时间：\t2015年01月19日案号：\t(2011)杭西民初字第02371号做出执行依据单位：\t杭州西湖法院生效法律文书确定的义务：\t支付人民币22000元被执行人的履行情况：\t全部未履行失信被执行人行为具体情形：\t其他有履行能力而拒不履行生效法律文书确定义务    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}