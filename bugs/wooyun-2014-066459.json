{"id": 1098, "wybug_id": "wooyun-2014-066459", "wybug_title": "qibocmsV7整站系统任意文件下载导致无限制注入多处(可提升自己为管理 Demo演示)", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-06-30 10:43", "wybug_open_date": "2014-09-28 10:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-28：\t细节向公众公开  简要描述： 我擦 写完标题后发现标题如此的长。应该是qibo中用得最多的系统了把。与之前我发的那个有所不同。  Fuzz。发现qibo是不是换人了? 给分给的越来越低? 之前18 到 10 到现在的5分了?用demo来演示演示把。应该可以直接登录后台 懒得弄了。如果这个洞还不给20的话 我只能呵呵了。 详细说明：  http://bbs.qibosoft.com/down2.php?v=v7#down下载地址 刚下载的。在inc/job/download.php中\n$url=trim(base64_decode($url));$fileurl=str_replace($webdb[www_url],\"\",$url);if( eregi(\".php\",$fileurl) && is_file(ROOT_PATH.\"$fileurl\") ){\tdie(\"ERR\");}if(!$webdb[DownLoad_readfile]){\t$fileurl=strstr($url,\"://\")?$url:tempdir($fileurl);\theader(\"location:$fileurl\");\texit;}if( is_file(ROOT_PATH.\"$fileurl\") ){\t$filename=basename($fileurl);\t$filetype=substr(strrchr($filename,'.'),1);\t$_filename=preg_replace(\"/([\\d]+)_(200[\\d]+)_([^_]+)\\.([^\\.]+)/is\",\"\\\\3\",$filename);\t\tif(eregi(\"^([a-z0-9=]+)$\",$_filename)&&!eregi(\"(jpg|gif|png)$\",$filename)){\t\t$filename=urldecode(base64_decode($_filename)).\".$filetype\";\t}\tob_end_clean();\theader('Last-Modified: '.gmdate('D, d M Y H:i:s',time()).' GMT');\theader('Pragma: no-cache');\theader('Content-Encoding: none');\theader('Content-Disposition: attachment; filename='.$filename);\theader('Content-type: '.$filetype);\theader('Content-Length: '.filesize(ROOT_PATH.\"$fileurl\"));\treadfile(ROOT_PATH.\"$fileurl\");}else{\tif(eregi(\".php\",$fileurl)){\t\theader(\"location:$fileurl\");\t\texit;\t}\t$filename=basename($fileurl);\t$filetype=substr(strrchr($filename,'.'),1);\t$fileurl=strstr($url,\"://\")?$url:tempdir($fileurl);\tob_end_clean();\theader('Last-Modified: '.gmdate('D, d M Y H:i:s',time()).' GMT');\theader('Pragma: no-cache');\theader('Content-Encoding: none');\theader('Content-Disposition: attachment; filename='.$filename);\theader('Content-type: '.$filetype);\treadfile($fileurl);\n\n$url=trim(base64_decode($url))$fileurl=str_replace($webdb[www_url],\"\",$url);if( eregi(\".php\",$fileurl) && is_file(ROOT_PATH.\"$fileurl\") ){\tdie(\"ERR\");\n这里由于是解码后再匹配 所以不能靠编码绕过。只要匹配到.php就退出 。  测试了一下.php. 也会被匹配出。这里还开启了i模式 所以像phP之类的大小写绕过也没办法。难道真的没办法了?\nif( is_file(ROOT_PATH.\"$fileurl\") ){\t$filename=basename($fileurl);\t$filetype=substr(strrchr($filename,'.'),1);\t$_filename=preg_replace(\"/([\\d]+)_(200[\\d]+)_([^_]+)\\.([^\\.]+)/is\",\"\\\\3\",$filename);\t\tif(eregi(\"^([a-z0-9=]+)$\",$_filename)&&!eregi(\"(jpg|gif|png)$\",$filename)){\t\t$filename=urldecode(base64_decode($_filename)).\".$filetype\";\t}\tob_end_clean();\theader('Last-Modified: '.gmdate('D, d M Y H:i:s',time()).' GMT');\theader('Pragma: no-cache');\theader('Content-Encoding: none');\theader('Content-Disposition: attachment; filename='.$filename);\theader('Content-type: '.$filetype);\theader('Content-Length: '.filesize(ROOT_PATH.\"$fileurl\"));\treadfile(ROOT_PATH.\"$fileurl\");\n在这里调用了is_file这函数来检测文件是否存在,如果存在的话才会进入这语句块。由于匹配出.php 就会退出。  能有什么办法呢?这里我们来fuzz is_file这函数一下。\n<?phpfor ($i=0; $i<255; $i++) {$yu = '1.ph' . chr($i);$yu1 = @is_file($yu);if (!empty($yu1)){echo chr($i);echo \"</br>\";}}?>\n在本地新建一个1.php的文件。 然后is_file 看看有神么能输出来。\n\n可以看到除开 P p 还有其他的因为开启了i 所以P p 都不行 来试试<\n<?Php $a=$_GET[a];$b=is_file($a);var_dump($b);\n\n\n\n\n可以看到1.ph< 返回了true 这样不就可以绕过这个的过滤了?因为我看英文看不怎么懂。。 那些什么翻译 翻译来又太蛋疼了 一大堆翻译错误的。以下是我的理解 可能有错 也请大牛来指导指导了。因为当PHP解析器解析这些函数的时候 会调用winapi调用了Winapi的函数Findfirstfile然后<字符被转换成了* 成了通配符。所以导致1.ph< 找到了1.php。也就导致了这个漏洞的产生。这里不止is_file函数调用了这个api 大部分的函数都调用了这个api \n\n可以看到unlink函数用这方法就不行。没调用这api的函数大概有unlink、rename、rmdir就这三个了。其他的函数基本都调用了。 _______________________________________________________________________________上面那个介绍完了, 继续回到qibocms。。\nif( is_file(ROOT_PATH.\"$fileurl\") ){\t$filename=basename($fileurl);\t$filetype=substr(strrchr($filename,'.'),1);\t$_filename=preg_replace(\"/([\\d]+)_(200[\\d]+)_([^_]+)\\.([^\\.]+)/is\",\"\\\\3\",$filename);\t\tif(eregi(\"^([a-z0-9=]+)$\",$_filename)&&!eregi(\"(jpg|gif|png)$\",$filename)){\t\t$filename=urldecode(base64_decode($_filename)).\".$filetype\";\t}\tob_end_clean();\theader('Last-Modified: '.gmdate('D, d M Y H:i:s',time()).' GMT');\theader('Pragma: no-cache');\theader('Content-Encoding: none');\theader('Content-Disposition: attachment; filename='.$filename);\theader('Content-type: '.$filetype);\theader('Content-Length: '.filesize(ROOT_PATH.\"$fileurl\"));\treadfile(ROOT_PATH.\"$fileurl\");\n在这里通过is_file的判断后。\n$filename=basename($fileurl);\t$filetype=substr(strrchr($filename,'.'),1);\t$_filename=preg_replace(\"/([\\d]+)_(200[\\d]+)_([^_]+)\\.([^\\.]+)/is\",\"\\\\3\",$filename);\t\tif(eregi(\"^([a-z0-9=]+)$\",$_filename)&&!eregi(\"(jpg|gif|png)$\",$filename)){\t\t$filename=urldecode(base64_decode($_filename)).\".$filetype\";\t}\n对这些有进行了各种处理, 但是我没搞懂对这些的处理有什么用?readfile(ROOT_PATH.\"$fileurl\")最后带入readfile 的是$fileurl。Come on 利用来吧。\n$url=trim(base64_decode($url));$fileurl=str_replace($webdb[www_url],\"\",$url);if( eregi(\".php\",$fileurl) && is_file(ROOT_PATH.\"$fileurl\") ){\tdie(\"ERR\");}\n这里由于会先解码所以首先要自己编码一次。这里我们来下载data/config.php 这文件。对data/config.php base64 encode试试 \n\n被匹配出了 再对data/config.ph< base64 encode\n\n成功下载到配置文件_________________________________________________________________________这里如何让任意文件下载变成注入?这里qibocms 里面有一个加密解码的函数\nfunction mymd5($string,$action=\"EN\",$rand=''){ //字符串加密和解密 \tglobal $webdb;\tif($action==\"DE\"){//处理+号在URL传递过程中会异常\t\t$string = str_replace('QIBO|ADD','+',$string);\t}    $secret_string = $webdb[mymd5].$rand.'5*j,.^&;?.%#@!'; //绝密字符串,可以任意设定 \tif(!is_string($string)){\t\t$string=strval($string);\t}    if($string===\"\") return \"\";     if($action==\"EN\") $md5code=substr(md5($string),8,10);     else{         $md5code=substr($string,-10);         $string=substr($string,0,strlen($string)-10);     }    //$key = md5($md5code.$_SERVER[\"HTTP_USER_AGENT\"].$secret_string);\t$key = md5($md5code.$secret_string);     $string = ($action==\"EN\"?$string:base64_decode($string));     $len = strlen($key);     $code = \"\";    for($i=0; $i<strlen($string); $i++){         $k = $i%$len;         $code .= $string[$i]^$key[$k];     }    $code = ($action == \"DE\" ? (substr(md5($code),8,10)==$md5code?$code:NULL) : base64_encode($code).\"$md5code\");\tif($action==\"EN\"){//处理+号在URL传递过程中会异常\t\t$code = str_replace('+','QIBO|ADD',$code);\t}    return $code; }\n这里的key是保存到配置文件里面的,  当我们拿到key过后就可以调用这函数自己来生成一个加密的字符串。再找哪里调用了这函数来解密的。 这样就无视了qibocms的全局转义。key 就是保存到data/config.php里面的 刚才通过任意文件下载已经拿到了。\n\n  还是给官方的key打个码、来找找哪里调用了这函数的。首先在member/yz.php里面\nelseif($action=='mobphone2'){\tif($lfjdb[mob_yz]){\t\tshowerr(\"请不要重复验证手机号码!\");\t}\tif(!$yznum){\t\tshowerr(\"请输入验证码\");\t}elseif(!$md5code){\t\tshowerr(\"资料有误\");\t}else{\t\tunset($code,$mobphone,$uid);\t\tlist($code,$mobphone,$uid)=explode(\"\\t\",mymd5($md5code,\"DE\") );\t\tif($code!=$yznum||$uid!=$lfjuid){\t\t\tshowerr(\"验证码不对\");\t\t}\t}\tadd_user($lfjuid,$webdb[YZ_MobMoney],'手机号码审核奖分');\t$db->query(\"UPDATE {$pre}memberdata SET mobphone='$mobphone',mob_yz='1' WHERE uid='$lfjuid'\");\trefreshto(\"yz.php?job=mob\",\"恭喜你,你的手机号码成功通过审核,你同时得到 {$webdb[YZ_MobMoney]} 个积分奖励!\",10);\n这里调用了mymd5 而且是decode 所以解码后就能直接注入了。而且可以发现update的表是memberdata 这个表里面groupid column 就是用来判断是不是管理员的。而且$mobphone 是解码后来的 而且直接在set位 这里只要稍微构造一下 就可以直接update groupid=3 然后就提升自己为管理员了。这里在之前的图片系统里提到过 就不多说了。再继续来看看。在inc/common.inc.php中 登录后台的时候也调用了这个\nif($_COOKIE[\"adminID\"]&&$detail=mymd5($_COOKIE[\"adminID\"],'DE',$onlineip)){\tunset($_uid,$_username,$_password);\tlist($_uid,$_username,$_password)=explode(\"\\t\",$detail);\t$lfjdb=$db->get_one(\"SELECT * FROM {$pre}memberdata WHERE uid='$_uid' AND username='$_username'\");}\nmymd5($_COOKIE[\"adminID\"],'DE',$onlineip)这里解码的时候还调用了$onlineip进了第三个参数    $secret_string = $webdb[mymd5].$rand.'5*j,.^&;?.%#@!'; //绝密字符串,可以任意设定 可以看到第三个参数是进了这个变量然后带入了加密中 看看$onlineip怎么来的。来看看全局文件 \nif($_SERVER['HTTP_CLIENT_IP']){     $onlineip=$_SERVER['HTTP_CLIENT_IP'];}elseif($_SERVER['HTTP_X_FORWARDED_FOR']){     \t $onlineip=$_SERVER['HTTP_X_FORWARDED_FOR'];}else{     $onlineip=$_SERVER['REMOTE_ADDR'];}$onlineip = preg_replace(\"/^([\\d\\.]+).*/\", \"\\\\1\", filtrate($onlineip));preg_match(\"/[\\d\\.]{7,15}/\", $onlineip, $onlineipArray);$onlineip = $onlineipArray[0] ? $onlineipArray[0] : '0.0.0.0';\n可以看到是获取的xff 但是后面用了正则来验证ip是否合法 如果不合法的话 就return的是0.0.0.0 这里我们就随便让xff不合法就行了然后把0.0.0.0 带入到加密函数当中________________________________________________________________________不多说了 直接调用一下函数生成一下加密的字符串。\n\n在测试demo的时候发现竟然不报错。\n\n这怎么可能呢?   后面想了一想 $secret_string = $webdb[mymd5].$rand.'5*j,.^&;?.%#@!'; //绝密字符串,可以任意设定 $rand 后面设定的是可以任意设定的 可能demo修改了。然后果断继续利用刚才的方法下载inc/function.inc.php\nfunction mymd5($string,$action=\"EN\",$rand=''){ //字符串加密和解密 \tglobal $webdb;    $secret_string = $webdb[mymd5].$rand.'5*j,.^&;?.%#@!=67987d'; //绝密字符串,可以任意设定\n呵呵 demo果然修改了。   把这个修改后 继续调用一下这函数 再生成一下语句。\n\n成功报错。  后面的不用多说了。 生成一个加密的报错注入的语句就能注入了。不想多说。这里应该可以直接登录后台,懒得弄了。   漏洞证明：  是不需要登录后台的 是在后台登录页面 等 其他多个地方注入。见上面。   修复方案：  漏洞的源头是任意文件下载。过滤<等特殊字符。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-01 11:35 厂商回复： 感谢提出来。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-30 10:46 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  给的分越来越低是逼你发大洞呢..    \n     2014-06-30 11:04 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  前排留名    \n     2014-06-30 11:14 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  雨神威武    \n     2014-06-30 13:32 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  雨神威武    \n     2014-07-01 02:55 |    \t\tLet a person cry. \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:9        | xxoo)\t\t \n  来个后台拿shell的呗    \n     2014-07-01 07:33 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Let a person cry.  。。后台那么多方法， 还有命令执行。    懒得写了，    \n     2014-07-05 17:48 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  雨神威武     \n     2014-07-06 14:27 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  @Let a person cry. 后台拿shell应该好拿的吧。    \n     2014-07-08 00:52 |    \t\t打酱油的小男孩 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 俺也来乌云看看)\t\t \n  任意文件下载导致无限制注入？。。这俩漏洞能扯上关系啊？- -#不懂。。    \n     2014-07-13 17:55 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  记录写进数据库？    \n     2014-07-13 18:09 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Hero  no    \n     2014-07-13 18:48 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @′  雨。 Like this？http://www.2cto.com/Article/201212/176488.html    \n     2014-07-13 18:54 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @Hero 恩   还用到了个小特性来绕黑名单    \n     2014-07-13 19:03 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @′  雨。 soga学到了 thx    \n     2014-07-29 11:32 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  牛逼哦    \n     2014-09-29 17:26 |    \t\t开心一下1313 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:20        | 喝口水,压压惊......)\t\t \n  眼睛都看痛了，果然是凶！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}