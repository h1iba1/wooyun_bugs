{"id": 4371, "wybug_id": "wooyun-2014-050679", "wybug_title": "Cmseasy sql注入一枚", "wybug_corp": "cmseasy", "wybug_author": "′雨。", "wybug_date": "2014-02-11 19:23", "wybug_open_date": "2014-05-09 19:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-21：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-09：\t细节向公众公开  简要描述： 无视gpc 无需登录。 详细说明：  昨天下的。 \\lib\\plugins\\pay\\alipay.php因为是调用的respond 类\nfunction respond() {\t    \t\t        if (!empty($_POST)) {            foreach($_POST as $key =>$data) {                $_GET[$key] = $data;            }        }        $payment  = pay::get_payment($_GET['code']);        $seller_email = rawurldecode($_GET['seller_email']);        $order_sn = str_replace($_GET['subject'],'',$_GET['out_trade_no']);        $order_sn = trim($order_sn);        if (!pay::check_money($order_sn,$_GET['total_fee'])) {            return false;        }\t\t        if($_GET['trade_status'] == \"WAIT_SELLER_SEND_GOODS\"||$_GET['trade_status'] == \"TRADE_FINISHED\" || $_GET['trade_status'] == \"TRADE_SUCCESS\") {            pay::changeorders($order_sn,$_GET);            return true;        }else {            return false;        }    }}\n挺多可控的\npublic static function changeorders($id,$orderlog) {    \t//file_put_contents('logs.txt', $id);        $where=array();        $where['id']=$id;        $where['status']=4;        //$where['orderlog']=serialize($orderlog);        $update=orders::getInstance()->rec_update($where,$id);        if($update<1) {            exit('改变订单状态出错，请联系管理员');        }    }\n$orderlog 基本没怎么用到 - -\npublic  function rec_update($row , $where){\t\tif(empty($this->tablename)) return;\t\tif(!empty($row) && !empty($where)){\t\t\t\t        $sqlud='';            foreach ($row as $key=>$value) {        \t\t$key = $this->simpledb->escape_string($key);        \t\t$value = $this->simpledb->escape_string($value);                                $sqlud .= \"`$key`\".\"= '\".$value.\"',\";            }\t        $sqlud=rtrim($sqlud);\t        $sqlud=rtrim($sqlud,',');\t        $where = $this->webscandb_condtion($where);\t        $sql=\"UPDATE `\".$this->tablename.\"` SET \".$sqlud.\" WHERE \".$where;\t\t\treturn $this->simpledb->execute($sql);\t\t}\n可以看到 where 是没有单引号的  开始利用把。 $order_sn = str_replace($_GET['subject'],'',$_GET['out_trade_no']);UPDATE `cmseasy_p_orders` SET `id`= '123',`status`= '4' WHERE 123然后让他延时 需要id=123 sleep(10) 这样但是发现$_GET 过滤了 =  对<> urlencode。。不知道怎么办了。  想了很久。  后面才看到。\nif (!empty($_POST)) {            foreach($_POST as $key =>$data) {                $_GET[$key] = $data;            }        }\n 就那用post来提交把 post未过滤= <>之类的。   漏洞证明：  \n\n\n\n\n\n\n\n\n\n\n\n  OK咯。   修复方案：  求过滤 求20分。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-05-09 19:24 厂商回复：  漏洞Rank：10  (WooYun评价) 最新状态： 2014-02-28：感谢提交漏洞，官方已经修正，望尽快下载更新。  ", "replys": "漏洞评价：\n评论\n     2014-02-11 19:33 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  有全局过滤和处理吧    \n     2014-02-11 23:04 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  看来很有意思    \n     2014-02-11 23:05 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @mramydnei 不觉得很有希望    \n     2014-02-12 00:00 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  cmseasy不是用了那个防护脚本    \n     2014-02-12 10:47 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @xsser 全局360 有过滤撒。        360 被发布绕过啦。 我测试了 是可以的。     \n     2014-02-12 10:50 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @xsser 用了360的脚本. 然后自己的过滤 对get多点 post少点。    \n     2014-02-12 11:02 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @′  雨。 show me the shell~    \n     2014-02-12 11:50 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  360开始坑厂商了，看来装了cmseasy还得装360安全卫士才行啊~    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}