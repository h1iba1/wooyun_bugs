{"id": 49596, "wybug_id": "wooyun-2014-080781", "wybug_title": "B2Bbuilder 网站商城跨站脚本攻击两处", "wybug_corp": "shop-builder.cn", "wybug_author": "nextdoor", "wybug_date": "2014-10-28 13:57", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-02：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： B2Bbuilder 网站商城跨站脚本攻击两处一个是指谁打谁另一个是可打大量用户 详细说明：  下载的版本 B2Bbuilder B2B网站管理系统 v7.0 .1最新 正式版第一处admin_message_sed.php //用户发送私信处，用户信息未做过滤\nif(isset($_POST['msgsend'])&&$_POST['sendid']!=','){\t$msg->friend_msg_batch_send(); //跟踪friend_msg_batch_send函数}//------------------邮件详情if(!empty($_GET['id'])){\t$de=$msg ->mail_det($_GET['id']);//跟踪mail_det函数\t$tpl->assign(\"de\",$de);\t$_GET['uid']=$de['fromuserid'];}//--------------------收件人if(!empty($_GET['uid'])){\t$sql=\"select user from \".ALLUSER.\" where userid='$_GET[uid]'\";\t$db->query($sql);\t$tpl->assign(\"auser\",$db->fetchField('user'));}//--------------------批量发邮件$info=$friend->get_batch_friend_info();$tpl->assign(\"re\",$info);//--------------------联系人名单$friendlist=$friend->friends_lists();$tpl->assign(\"friendlist\",$friendlist);//==================================$tpl->assign(\"config\",$config);$tpl->assign(\"lang\",$lang);$output=tplfetch(\"admin_message_sed.htm\");跟踪两个函数plugin_msg_class.php中\tfunction mail_det($id)\t{\t\tglobal $buid;\t\t$sql=\"select *,NULL as about from \".FEEDBACK.\" where id='$id'\";\t\t$this->db->query($sql);\t\t$re=$this->db->fetchRow();\t\tif($re['iflook']<1)\t\t{\t\t\t$sql=\"update \".FEEDBACK.\" SET iflook=1  WHERE id='$id'\";\t\t\t$this->db->query($sql);\t\t}\t\t\t\tif($re[\"fromuserid\"]&&$re['msgtype']==1)\t\t{//收件箱\t\t\t$sql=\"select * from \".ALLUSER.\" where userid='\".$re['fromuserid'].\"'\";\t\t\t$this->db->query($sql);\t\t\t$re[\"fromInfo\"]=$this->db->fetchRow();\t\t} //\t\tif($re[\"touserid\"]&&$re['msgtype']==2)\t\t{//发件箱\t\t\t$sql=\"select * from \".ALLUSER.\" where userid='\".$re['touserid'].\"'\";\t\t\t$this->db->query($sql);\t\t\t$re[\"fromInfo\"]=$this->db->fetchRow();\t\t}\t\tif($re['fromuserid'])\t\t{\t\t\t$sql=\"select id from \".FRIENDS.\" where fuid=$re[fromuserid]\";\t\t\t$this->db->query($sql);\t\t\t$re[\"is_myfriend\"]=$this->db->fetchField('id');\t\t}\t\t\t\t$re['edit_con']='<br><br><br><br><br>//======================================================='.$re['con'];//显示$re['con']也未过滤\t\treturn $re;\t}\tfunction friend_msg_batch_send()\t{\t\t\tglobal $buid,$admin;\t\tif(!empty($_POST['senduser'])&&!empty($_POST['msgcon']))\t\t{\t\t\t$date=date(\"Y-m-d H:i:s\");\t\t\t$sear=explode(';',$_POST['senduser']);\t\t\tif(count($sear)>1)\t\t\t{\t\t\t\t$sear1=array_unique($sear);\t\t\t\t$suser=\"'0'\";\t\t\t\tforeach($sear1 as $v)\t\t\t\t{\t\t\t\t\t$suser.=\",'$v'\";\t\t\t\t}\t\t\t\t$sql=\"select user,email,userid from \".ALLUSER.\" where user in ($suser)\";\t\t\t}\t\t\telse\t\t\t\t$sql=\"select user,email,userid from \".ALLUSER.\" where user ='$_POST[senduser]'\";\t\t\t$this->db->query($sql);\t\t\t$re=$this->db->getRows();\t\t\tforeach($re as $v)\t\t\t{\t\t\t\t$sql=\"insert into \".FEEDBACK.\" (touserid,fromuserid,fromInfo,sub,con,date,msgtype) VALUES \t\t\t\t('$v[userid]','$buid','Business Friends Message','$_POST[msgtitle]','$_POST[msgcon]','$date','1')\";\t\t\t\t$this->db->query($sql);\t\t\t\t\t\t\t\t\t\t$sql=\"insert into \".FEEDBACK.\" (touserid,fromuserid,fromInfo,sub,con,date,msgtype) VALUES \t\t\t\t('$v[userid]','$buid','Business Friends Message','$_POST[msgtitle]','$_POST[msgcon]','$date','2')\";//$_POST[msgcon]没过滤就插入数据库\t\t\t\t$this->db->query($sql);\t\t\t\t//-----------------如果是回复邮件标记为已回复\t\t\t\t$this->db->query(\"UPDATE \".FEEDBACK.\" set iflook='3' where id='$_GET[id]'\");\t\t\t\t\t\t\t\tif(!empty($_POST['semail'])&&$v[\"email\"])\t\t\t\t{\t\t\t\t\tsend_mail($v[\"email\"],$v[\"name\"],$_POST['msgtitle'],$_POST['msgcon']);\t\t\t\t}\t\t\t}\t\t\t$admin->msg(\"main.php?m=message&s=admin_message_list_inbox\");//发送成功\t\t}\t\telse\t\t\t$admin->msg(\"main.php?m=message&s=admin_message_sed&msgsend=error\");\n第二处\nbuy_class.php //进入点和输出点都没有过滤导致xss漏洞这个的影响也较大，只要用户点击求购栏目就会中招buy=new buy();if($_GET['ajax']==1){\t$buy->del_pro_buy($_POST['id']);\tdie;}if(!empty($submit)&&empty($_POST['editID'])){\t    //========================================================\t$pactidlist=!empty($_POST['catid'])?$_POST['catid']:NULL;\tif(!empty($_POST['tcatid']))\t\t$pactidlist.= \",\".$_POST['tcatid'];\tif(!empty($_POST['scatid']))\t\t$pactidlist.=\",\".$_POST['scatid'];\tif(!empty($_POST['sscatid']))\t\t$pactidlist.=\",\".$_POST['sscatid'];\t$buy->add_user_common_cat($pactidlist);//增加会员常用类别，跟踪一下这个函数\t//=======================================================\t$buy_id = $buy->add_buy();\tif($buy_id)\t\t$admin->msg(\"main.php?m=buy&s=admin_buy_list\");}$_POST['editID']*=1;if($_POST['editID']){\t$re=$buy->edit_buy();\tif($re)\t\t$admin->msg(\"main.php?m=buy&s=admin_buy_list\");}if(isset($_GET['edit'])){   \t$de = $buy->buy_detail($_GET['edit']);\t$pactidlist=$de['catid'];\tif(!empty($de['tcatid']))\t\t$pactidlist.=\",\".$de['tcatid'];\tif(!empty($de['scatid']))\t\t$pactidlist.=\",\".$de['scatid'];\t\tif(!empty($de['sscatid']))\t\t$pactidlist.=\",\".$de['sscatid'];\t$tpl->assign(\"typenames\",$buy->getProTypeName($pactidlist));\t$buy->add_user_common_cat($pactidlist);//增加会员常用类别\t$tpl->assign(\"de\",$de);}buy_class.phpfunction add_user_common_cat($cid) \t{\t\tglobal $buid;\t\t//-------------------\t\t$cid=explode(\",\",$cid);\t\t$id=$cid[0];\t\tif(!empty($cid[1]))\t\t\t$id=$cid[1];\t\tif(!empty($cid[2]))\t\t\t$id=$cid[2];\t\tif(!empty($cid[3]))\t\t\t$id=$cid[3];\t\t$sql=\"select id from \".SHOPSETTING.\" where company_id='$bcid'\";\t\t$this->db->query($sql);\t\t$rec=$this->db->fetchRow();\t\tif($rec['id'])\t\t\t$sql=\"update \".SHOPSETTING.\" set common_cat=REPLACE(common_cat,',$id',''),common_cat=concat(common_cat,',$id') where userid='$buid'\";\t\telse\t\t\t$sql=\"insert into \".SHOPSETTING.\" (userid,rec_pro,common_cat) values ('$buid','',',$id')\";//更新rec_pro,common_cat时未过滤\t\t$re=$this->db->query($sql);\t}\n   漏洞证明：  漏洞证明： 官网演示用户打开信息时触发\n\n用户单击首页上的求购栏目是即可触发\n\n   修复方案：  转义   版权声明：转载请注明来源 nextdoor@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}