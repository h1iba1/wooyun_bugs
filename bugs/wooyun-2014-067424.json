{"id": 899, "wybug_id": "wooyun-2014-067424", "wybug_title": "Hdwiki最新版二次注入一枚", "wybug_corp": "互动在线（北京）科技有限公司", "wybug_author": "′雨。", "wybug_date": "2014-07-11 11:37", "wybug_open_date": "2014-10-06 11:38", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-16：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向公众公开  简要描述： 上Hdwiki官网 发现更新日期一直都没变。还以为一直都没更新了, 结果今天下载一个下来看看。发现之前发的洞竟然都补掉了。 非盲注 直接出数据。ps. 更新程序了应该还是把日期更新了一下 要不别人会一直以为没更新的。 详细说明：  在user/pms.php中\nfunction doblacklist(){\t\tif(isset($this->post['blacklist'])){\t\t\t$blacklist = htmlspecialchars(string::stripscript($this->post['blacklist']));\t\t\tif(empty($blacklist)){\t\t\t\t$result = $_ENV['pms']->remove_blacklist($this->user['uid']);\t\t\t}else{\t\t\t\t$result = $_ENV['pms']->add_blacklist($blacklist,$this->user['uid']);\t\t\t}\nadd_blacklist($blacklist,$this->user['uid']);$blacklist = htmlspecialchars(string::stripscript($this->post['blacklist'])post 都会转义的。 来看看这函数 stripscript\nfunction stripscript($string){\t\t$pregfind=array(\"/<script.*>.*<\\/script>/siU\",'/on(error|mousewheel|mouseover|click|load|onload|submit|focus|blur|start)=\"[^\"]*\"/i');\t\t$pregreplace=array('','',);\t\t$string=preg_replace($pregfind,$pregreplace,$string);\t\treturn $string;\t}}\n这是过滤了一些xss常用的。\nfunction add_blacklist($blacklist,$uid){\t\treturn($this->db->query(\"REPLACE INTO \".DB_TABLEPRE.\"blacklist (uid,blacklist) VALUES('$uid','$blacklist')\"));\t}\n然后直接入库, 虽然转义了 但是转义后入库之后转义符会被消除的。来看看哪里出库了。依旧在control/pms.php中\nfunction dobox(){\t\t$this->get[3] = empty($this->get[3]) ? NULL : $this->get[3];\t\t$page = max(1,isset($this->get[4]) ? $this->get[4] : $this->get[3]);\t\t$num = isset($this->setting['list_prepage'])?$this->setting['list_prepage']:20;\t\t$start_limit = ($page - 1) * $num;\t\t\t\t$count = $_ENV['pms']->get_totalpms($this->user['uid'], $this->get[2]);\n\nfunction get_totalpms($uid, $type, $group=''){\t\t$sqladd = '';\t\tif($type == 'inbox'){\t\t\t$blacklist = $this->get_blacklist($uid);\t\t\tif($blacklist == '[ALL]'){\t\t\t\treturn '0';\t\t\t}else{\t\t\t\t$blackuser = str_replace(\",\",\"','\",$blacklist);\t\t\t\t\t\tif($group){\t\t\t\t\t$sqladd = ($group == 'owner') ? 'AND og=0' : 'AND og=1';\t\t\t\t}\t\t\t\t$query = \"SELECT COUNT(*) num FROM \".DB_TABLEPRE.\"pms WHERE toid='$uid' AND delstatus!=2 AND drafts!=1 $sqladd AND `from` NOT IN ('$blackuser')\";\t\t\t\t\t\t}\t\t\t\t}else{\t\t\t$sqladd = ($type == 'outbox') ? 'drafts!=1' : 'drafts=1';\t\t\t$query = \"SELECT COUNT(*) as num FROM \".DB_TABLEPRE.\"pms WHERE fromid='$uid' AND delstatus!=1 AND $sqladd\";\t\t\t\t\t}\t\t$total = $this->db->fetch_first($query);\t\treturn $total['num'];\t\t\t}\n$blacklist = $this->get_blacklist($uid);\nfunction get_blacklist($uid){\t\t$user = $this->db->fetch_first(\"SELECT blacklist FROM \".DB_TABLEPRE.\"blacklist WHERE uid='\".$uid.\"'\");\t\treturn $user['blacklist'];\t}\n这里把刚才入库的查询了出来 成功引入了单引号。\n$blackuser = str_replace(\",\",\"','\",$blacklist);\t\t\t\t\t\tif($group){\t\t\t\t\t$sqladd = ($group == 'owner') ? 'AND og=0' : 'AND og=1';\t\t\t\t}\t\t\t\t$query = \"SELECT COUNT(*) num FROM \".DB_TABLEPRE.\"pms WHERE toid='$uid' AND delstatus!=2 AND drafts!=1 $sqladd AND `from` NOT IN ('$blackuser')\";\n然后查询出来后赋值给$blackuser  然后带入了查询当中， 而且在最后\treturn $total['num'];\treturn回来后直接\t$this->view->assign('count',$count);  输出来。就可以直接出数据。\t$blackuser = str_replace(\",\",\"','\",$blacklist);在这里会把逗号替换 然后就不用逗号来注入把。   漏洞证明：  \n\n首先在忽略列表里面添加这样的语句然后访问\n\n直接出数据。   修复方案：  转义一下。挖洞不易 给个20分把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-10-06 11:38 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-11 11:59 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  大圣收了神通吧    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}