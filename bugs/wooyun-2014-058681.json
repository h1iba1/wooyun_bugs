{"id": 3653, "wybug_id": "wooyun-2014-058681", "wybug_title": "对电厂生产控制网络的一次漫游（针对工控网络的小型APT攻击）", "wybug_corp": "某电厂", "wybug_author": "Z-0ne", "wybug_date": "2014-04-27 19:57", "wybug_open_date": "2014-06-11 19:57", "wybug_type": "系统/服务运维配置不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["安全意识不足", "工业控制系统", "监控系统", "工控安全", "边界防护"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-11：\t细节向公众公开  简要描述： 发散一下思路，攻击入口多多，又一次的从外网到内网的实例，其中又见南京科远的应用，最后达到的效果是可以直接操作多个Modbus TCP Slave子站，当然改数据什么的都是小事情，后面的你懂的，个 人认为针对工控系统的攻击一般都是对来源的实时数据做溯源挖掘，因为数据是直接来自于设备的，随着现在信息化的建设，常规下我们在WEB界面看到的实时数据其实一般经过了多次转发，环顾时下工控安全环境，还是太浮于表面，工控安全厂商层面现在的氛围还是很好的，但是针对实际的用户还是不以为然，现在软，硬，实例一起搞还不给个闪电？ 详细说明：  根据对内网摸查，排除了未知的网络部分，这里简单绘制已经完全了解的如下图的拓扑：\n\n其实该拓扑也是早期网络中最常见的形式，如果现在看图说话，那按照位置的话在mis和sis中间的实时数据库就相当于以前堡垒机了.有了拓扑都不想打太多字了，下面简单说一下每一步的操作步骤和往下撸的思路供大家参考1、当时的入口选择的还是企业的公司官网，拿下了网站的shell，至于怎么找这种企业，个人感觉可以找网上的应用、成功案例、案例展示等熟悉企业应用，当然这么说是准备着长期APT了，其实讲个笑话很多集成商企业在发布成功案例时就有可能手滑了没打码，好吧如果存活的话，这就是一个入口了，在我之前的案例中基本都是这样确定了目标，而且还是屡见不鲜。2、以这个案例来说，危险的是他的服务是直接在内网做的WEB发布，而没有租用虚拟主机，我相信这种企业其实不在少数。\n\n3、如何撸WEB这块就直接省略了，现在都忘了是怎么拿下的shell，因为shell趟了太常时间，web服务器这块因为是IIS支持asp和asp.net，当时环境下可以运行程序，提权的话用的方式是可以getpass直接读内存中的登录密码或者直接用程序提权加用户，个人做法是直接读登录密码，一般拿到的密码其实能通关很多服务器，其实这步最关键。\n\n4、拿下web服务器知道了系统常用的密码，这时又到了最上面的内网，就可以在内网开撸了，根据网络连接，服务基本可以先确认一部分子网。\n\n5、如下图确认了一台没有密码的XP疑似办公机，遍历此网段服务，发现多个网络摄像头web监控界面，不知道是否与泵房部门有关系，能判断是办公网是因为，存活主机远程桌面显示清一色为XP，推测192.168.10*.0类型网段应该是不同部门使用，\n\n6、翻查办公机的浏览记录确认了几台应用服务器地址，因为浏览器的下拉菜单中记录了几个曾经登录过的的用户名，这确认多个用户名和一个用户的弱口令，基本确认为管理员权限\n\n\n\n\n\n7、在内网环境又确认了多台应用服务器，包含科远的sis监控服务器，这里确认主机房监控等正好与之前的存活IP相符\n\n\n\n8、关键的来了，得到了SIS监控的地址，这时就着数据源就可以找到下面的设备了\n\n9、其实要放大攻击面也就需要拿下SIS监控的实时数据库，至于怎么搞，那就请看前面的案例吧，要不社社社。\n\n\n\n10、到这里基本确定了已经身处生产网络当中，这里再次确认了存活性和几个简单的服务，例如通过指纹信息发现赫斯曼的交换机和modbus子站。\n\n11、如何确认是真实的modbus slave从站控制设备？而不是别的系统转发的的数据呢，基本可以通过telnet系统开饭端口判断139 135 等系统端口是否开放这样排除.\n\n\n\n12、到这里攻击者想下置修改数据，亦或是直接让其拒绝服务这都不是事儿。   漏洞证明：  综上所属   修复方案：  修改常用口令加装工控安全设备边界防护   版权声明：转载请注明来源 Z-0ne@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-04-30 23:07 厂商回复： 一个典型的产网不分的案例，转由CNCERT先上报给国家上级信息安全主管部门，同时后续将及时通报网站管理单位。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-27 19:59 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  mark    \n     2014-04-27 20:01 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  辛苦了啊。    \n     2014-04-27 20:02 |    \t\tinsight-labs  \t\t\t( 普通白帽子  |\t\t\t        Rank:623 漏洞数:75        | Security guys)\t\t \n  工控系统应该广泛应用数字签名等机制，防止对数据进行篡改。假如4096位的私钥公钥直接刷在离心机控制器的rom里，用跳线防止写入，对回传的数据用hmac+私钥签名，对收到的指令用公钥验证签名，stuxnet，duqu之类的东西还能有用？    \n     2014-04-27 20:02 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  @zeracker 晕，打码真是个艺术    \n     2014-04-27 20:05 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @Z-0ne — —。 页面标题还是有部分没打好啊。自查下。     \n     2014-04-27 20:23 |    \t\t浅兮 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:30        )\t\t \n  好想学APT攻击，大牛教教呗！    \n     2014-04-27 20:28 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  这个关注一下。。。。    \n     2014-04-27 21:12 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  闪电了    \n     2014-04-27 21:19 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  mark。    \n     2014-04-27 21:35 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  是不是可以停电     \n     2014-04-27 21:41 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @Black Angel 可以    \n     2014-04-27 22:34 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  牛逼，马克    \n     2014-04-28 09:01 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  @insight-labs 这样弄之后实时性还能保证吗？    \n     2014-04-28 09:14 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-04-28 09:22 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  @cncert国家互联网应急中心 加高硬件性能，不过成本就上去了    \n     2014-04-28 10:55 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  埃 我机房那个可以在家里控制的空调多安逸 可惜只用了三个小时网线就被我拔出了 能联网的东西都不安全    \n     2014-04-28 18:01 |    \t\tinsight-labs  \t\t\t( 普通白帽子  |\t\t\t        Rank:623 漏洞数:75        | Security guys)\t\t \n  @cncert国家互联网应急中心 绝对可以啊，当然要是单片机级别的肯定不行了。如果追求速度可以用256位椭圆曲线    \n     2014-04-28 20:39 |    \t\t弹涂鱼 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 一条跳跳鱼。)\t\t \n  膜拜Z-One，你真敢撸。。。    \n     2014-06-11 20:10 |    \t\tHRay \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:28        | 018)\t\t \n  提权的话用的方式是可以getpass直接读内存中的登录密码，洞主普通权限就可以直接getpass了？    \n     2014-06-11 20:33 |    \t\tkeke \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:8        | 目测和口算各种妹纸)\t\t \n  @ insight-labs 贱人波    \n     2014-06-11 21:55 |    \t\t孤月寒城 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        )\t\t \n  哈哈，看过    \n     2014-06-25 18:25 |    \t\t半世倾尘 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:8        | 努力)\t\t \n  非常好！      \n     2014-06-26 00:50 |    \t\t革命往事 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:2        | 革命已成往事)\t\t \n  这个屌    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}