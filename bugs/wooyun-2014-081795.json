{"id": 47146, "wybug_id": "wooyun-2014-081795", "wybug_title": "74cms(20141027)多处二次注入", "wybug_corp": "74c,s.com", "wybug_author": "JJ Fly", "wybug_date": "2014-11-05 14:05", "wybug_open_date": "2015-02-03 14:06", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-03：\t细节向公众公开  简要描述： 看完了xfkxfk大神的http://wooyun.org/bugs/wooyun-2010-070827http://wooyun.org/bugs/wooyun-2014-070858对74cms尝试了下，果然有收货。 详细说明：  1.\nuser/company/company_ajax.phpelseif($act==\"promotion_add_save\"){************************\t\t\t\t\treport_deal($uid,2,$points);\t\t\t\t\t$user_points=get_user_points($uid);\t\t\t\t\twrite_memberslog($uid,1,9001,$_SESSION['username'],\"{$pro_cat['cat_name']}：<strong>{$jobs['jobs_name']}</strong>，推广 {$days} 天，(-{$points})，(剩余:{$user_points})\",1,1018,\"{$pro_cat['cat_name']}\",\"-{$points}\",\"{$user_points}\");\t\t\t\t}elseif($_CFG['operation_mode']=='2'){\t\t\t\t\t$user_pname=trim($_POST['pro_name']);\t\t\t\t\taction_user_setmeal($uid,$user_pname); //更新套餐中相应推广方式的条数\t\t\t\t\t$setmeal=get_user_setmeal($uid);//获取会员套餐\t\t\t\t\twrite_memberslog($uid,1,9002,$_SESSION['username'],\"{$pro_cat['cat_name']}：<strong>{$jobs['jobs_name']}</strong>，推广 {$days} 天，套餐内剩余{$pro_cat['cat_name']}条数：{$setmeal[$user_pname]}条。\",2,1018,\"{$pro_cat['cat_name']}\",\"-{$days}\",\"{$setmeal[$user_pname]}\");//9002是套餐操作\t\t\t\t}\t\t\t\twrite_memberslog($uid,1,3004,$_SESSION['username'],\"{$pro_cat['cat_name']}：<strong>{$jobs['jobs_name']}</strong>，推广 {$days} 天。\");*******************}\n会调用write_memberslog这个函数。然后重点看这个变量$jobs['jobs_name']从上面我们可以得知$jobs=get_jobs_one($jobid,$uid);然后再继续看下去\nfunction get_jobs_one($id,$uid=''){\tglobal $db,$timestamp;\t$id=intval($id);\tif (!empty($uid)) $wheresql=\" AND uid=\".intval($uid);\t$tb1=$db->getone(\"select * from \".table('jobs').\" where id='{$id}' {$wheresql} LIMIT 1\");\t$tb2=$db->getone(\"select * from \".table('jobs_tmp').\" where id='{$id}' {$wheresql} LIMIT 1\");\t$val=!empty($tb1)?$tb1:$tb2;\tif (empty($val)) return false;\t$val['contact']=$db->getone(\"select * from \".table('jobs_contact').\" where pid='{$val['id']}' LIMIT 1 \");\t$val['deadline_days']=($val['deadline']-$timestamp)>0?\"距到期时间还有<strong style=\\\"color:#FF0000\\\">\".sub_day($val['deadline'],$timestamp).\"</strong>\":\"<span style=\\\"color:#FF6600\\\">目前已过期</span>\";\treturn $val;}\n直接进行调用，没有处理。So我们可以这样，新建一个职位，名称为\n1','1','1',user(),'1','9')#\n\n\n然后去为其消费，让其创建记录。置顶，变色，紧急，推荐都行。\n\n然后在积分消费明细中可以看到\n\n经过上面，我们可以得知，经过函数get_jobs_one返回的值没有就行处理。然后可以搜索下喊函数，看看在什么地方调用了，而且进入了数据库。\n\n2.下面继续看了一下申请职位名称这。\n\n这一处，在  个人简历名称  职位名称  企业名称  三处都没有进行过滤，随后我们可以去查看一下源码。我们可以找出 上面这三处 数据 是怎么获取的，然后尝试是否可以扩大战果。$jobsarr=app_get_jobs($jobsid);foreach($jobsarr as $jobs){$addarr['company_name']=$jobs['companyname'];$addarr['jobs_name']=$jobs['jobs_name'];}简历信息在这$resume_basic=get_resume_basic($_SESSION['uid'],$resumeid);3.在邀请面试的地方同样发现了二次注入。\n\n这个构造一下吧 。把企业名称修改成这样\nm',1,3,'zz',1,user(),1,1)#\n随后我们可以见下图\n\n4.经过测试，又发现，收藏职位处也可二次注入，\n\nm'为企业名称5.发现一个有问题的函数\nfunction get_company($uid){\tglobal $db;\t$sql = \"select * from \".table('company_profile').\" where uid=\".intval($uid).\" LIMIT 1 \";\t$result = $db->getone($sql);\treturn $result;}\n获取企业资料不检测直接返回，随后找了这个函数进行了调用，然后执行了数据操作。\nfunction add_down_resume($resume_id,$company_uid,$resume_uid,$resume_name){\tglobal $db,$timestamp;\t$resume_id=intval($resume_id);\t$company_uid=intval($company_uid);\t$resume_uid=intval($resume_uid);\t$resume_name=trim($resume_name);\t\t$company=get_company($company_uid);\t$sql = \"INSERT INTO \".table('company_down_resume').\" (resume_id,resume_uid,resume_name,company_uid,company_name,down_addtime) VALUES ('{$resume_id}','{$resume_uid}','{$resume_name}','{$company_uid}','{$company['companyname']}','{$timestamp}')\";\treturn $db->query($sql);}\n然后再挖掘这个函数的下载记录。\n\n   漏洞证明：  \n\n\n\n   修复方案：  根据函数进行处理吧。希望你们也自行检查一下，不要指哪补哪   版权声明：转载请注明来源 JJ Fly@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-11-08 11:50 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}