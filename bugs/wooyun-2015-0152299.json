{"id": 82007, "wybug_id": "wooyun-2015-0152299", "wybug_title": "中国电信某站注射到webshell(可影响充值系统)", "wybug_corp": "中国电信", "wybug_author": "路人甲", "wybug_date": "2015-11-06 13:50", "wybug_open_date": "2015-12-25 10:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-25：\t细节向公众公开  简要描述： 这事还得从一个被忽略掉的漏漏开始（其实是我特么上网被电信愁死了，早上起来网页直接打不开，我打客户投诉之后的5分钟网络还是OK的，不过10分钟后还得继续投诉。恶意循环，简直不能忍）. 详细说明：  地址:http://**.**.**.**/ 程序采用的是PHPCMSV9。这个最近被爆的很火..过程就泄漏KEY，然后注射拿到密码(次期间再次投诉了几次).最后拿到webshell\n\n发现权限比较大.意外的列出来了**.**.**.**的源码\n\n不知道给自己的多充点，然后把宽带提升到100M什么的。结果想的有点多，但是找到一些接口\n\n   漏洞证明：  操着审计的那啥，学着看了下相关的代码，发现一个有意思的地方.url：http://**.**.**.**/web/flows.php这页面有个流量加装包的功能，是通过发送短信给机主，机主输入验证码后再进行下一步操作如果我想给人恶意支付开通什么超值功能的时候，会有个验证码提示\n/*------------------------------------------------------ */ //-- 相关操作 /*------------------------------------------------------ */ if( $action=='getvcode') {\t$phone = $_POST[\"phone\"];\t$sjm=rand(100000,999999);  //验证码\t//发送验证码至手机\t//发送短信\t$contents = '欢迎办理流量加装包业务，您本次获取的手机验证码为：'.$sjm;\t$datat    = array('phone'=>$phone, 'content'=>$contents, 'pwd'=>Md5($phone.'**********'));\t$message  = array();\t$api      = autoLoad('api', 'plugin', 'api');  //加载插件，用于发短信\ttry {\t\tif(getOperators($datat['phone'])==\"1\"){\t\t\t$result = $api->SendSms($datat['phone'],$datat['content']);\t\t\tif($result[\"respCode\"]==\"0\"){\t\t\t\t$_SESSION['checkcode'.$phone]=$sjm;\t\t\t\t$message['code'] = \"1\";\t\t\t\t$message['message'] = \"验证码发送成功\";\t\t\t\techo json_encode($message);\t\t\t\texit;\t\t\t} else{\t\t\t\t$message['code'] = \"0\";\t\t\t\t$message['message'] = \"验证码发送失败\";\t\t\t\techo json_encode($message);\t\t\t\texit;\t\t\t}\t\t} else {\t\t\t$message['code'] = \"3\";\t\t\t$message['message'] = \"请输入电信手机号码\";\t\t\techo json_encode($message);\t\t\texit;\t\t}\t} catch (Exception $e) {\t\t$message['code'] = \"2\";\t\t$message['message'] = $e;\t\techo json_encode($message);\t\texit;\t}\n验证码是随机的6位数。rand(100000,999999).而且这里还没有发送一次到下一次的间隔时间，导致可以造成一个对电信手机的短信轰炸机.（拿基友的号码测试的.）\n\n\n\n对验证码的验证过程\n$action=='checkvcode'){\t$message= array();\t$phone=$_POST['phone'];\t$vcode = $_POST['vcode'];\tif(empty($_SESSION['checkcode'.$phone])){\t\t$message['code'] = \"2\";\t\t$message['message'] = \"取验证码已过期，请重新获取\";\t\techo json_encode($message);\t\texit;\t}\tif($vcode!=$_SESSION['checkcode'.$phone]){\t\t$ctimes = !empty($_SESSION['checkcode'.$phone.'ctimes']) ? $_SESSION['checkcode'.$phone.'ctimes'] : 1;\t\t\t\t\t$_SESSION['checkcode'.$phone.'ctimes'] = $ctimes+1;\t\tif($_SESSION['checkcode'.$phone.'ctimes']==4){\t\t\tunset($_SESSION['checkcode'.$phone]);\t\t\tunset($_SESSION['checkcode'.$phone.'ctimes']);\t\t}\t\t\t$message['code'] = \"0\";\t\t$message['message'] = \"验证码错误\";\t\techo json_encode($message);\t\texit;\t}else{\t\t$message['code'] = \"1\";\t\t$message['message'] = \"验证码正确\";\t\techo json_encode($message);\t\texit;\t}\n想生成验证码爆破的，基友说如果开通了立马来我家打死我.所以并没有尝试.因为这个验证过程中并没有看到其他相关的验证，所以如果想给谁开个什么套餐之类的.只是需要填入号码，然后生成100000到999999的验证码跑一下~就可以开通了。仔细思考了下，这里应该还有存在一个10000号码给任意电信用户发生任意短信内容的漏洞.   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-11-10 10:43 厂商回复： CNVD确认并复现所述情况,已经转由CNCERT向中国电信集团公司通报,由其后续协调网站管理部门处置. 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}