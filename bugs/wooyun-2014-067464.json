{"id": 978, "wybug_id": "wooyun-2014-067464", "wybug_title": "CmsEasy最新 V5.5-UTF8 正式版多处漏洞打包", "wybug_corp": "cmseasy", "wybug_author": "HackBraid", "wybug_date": "2014-07-05 00:55", "wybug_open_date": "2014-10-03 00:56", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-03：\t细节向公众公开  简要描述： 补了20140605 详细说明：  首先是个注入，这个漏洞比较无语，真正的无视过滤，没引号保护。。漏洞位于bbs/add-archive.php：\n<?php  require_once 'bbs_public.php';  //验证用户登陆相关操作  $admin = new action_admin();  $admin->check_login();  $category = db_bbs_category::getInstance();  $category_data = $category->getAll();  $cid = isset($_GET['cid']) ? intval($_GET['cid']) : 1 ;  $label = db_bbs_label::getInstance();  $lable_data = $label->getAll();  if(isset($_POST['submit'])){  \t  if(strtolower(trim($_POST['verify'])) != strtolower($_SESSION['verify'])){          action_public::turnPage('index.php','验证码输入错误！');  \t  }      $archive = db_bbs_archive::getInstance();            unset($_POST['submit']);      unset($_POST['verify']);      $_POST['username'] = $_COOKIE['login_username'];      $_POST['userid'] = $admin->userid;      $_POST['ip'] = $_SERVER['REMOTE_ADDR'];      $_POST['addtime'] = mktime();      if($id = $archive->inserData($_POST)){ //这里直接将表单中的值交给了insertData函数，我们跟进          action_public::turnPage('archive-display.php?aid='.$id,'文章添加成功');      }else{      \t  action_public::turnPage('index.php','添加失败，请联系我们！');      }  }?>\ninserData函数代码：\npublic function inserData($data){       $r = $this->odb->insert($this->tblName,$data);//继续跟进       if($r)           return $this->odb->getInsertId();       else           return false;\t}\ninsert函数代码：\npublic function insert($table, $data)\t{\t\t$sql = $this->getInsertString($table, $data);//这里跟进\t\treturn $this->execSql($sql);//执行sql语句\t}\ngetInsertString函数代码：\npublic function getInsertString($table, $data)\t{\t\t$n_str = '';\t\t$v_str = '';\t\t$table = $this->filterString($table);\t\tforeach ($data as $k => $v)\t\t{\t\t\t$n_str .= $this->filterString($k).',';//对key进行filter，跟进filter函数\t\t\t$v_str .= \"'\".$this->filterString($v).\"',\";\t\t}\t\t$n_str = preg_replace( \"/,$/\", \"\", $n_str );\t\t$v_str = preg_replace( \"/,$/\", \"\", $v_str );\t\t$str = 'INSERT INTO '.$table.' ('.$n_str.') VALUES('.$v_str.')';\t\treturn $str;\t}\nfilterString函数代码：\nelse {\t\t\t$ret = @mysqli_real_escape_string($this->con, $str);//对单引号、双引号和一些字符进行了转义。\t\t\tif ( strlen($str) && !isset($ret) ) {\t\t\t\t$r = $this->checkConnection();\t\t\t\tif ($r !== true) {\t\t\t\t\t$this->closeDB();\t\t\t\t\t$ret = $str;\t\t\t\t}\t\t\t}\t\t\treturn $ret;\t\t}\n构造查询语句时没有加引号保护，导致注入。另外就是验证码的问题打包下发出来吧，见漏洞证明。   漏洞证明：  \nSQL注入漏洞\nkey的insert注入，构造exp还是费了点劲，看下结果吧：1、bbs上发帖：\n\n2、抓包在content后写上exp：\n\n3.forward后看我们的帖子：\n\n\n验证码漏洞打包\n首先以论坛发帖为例。发帖最下方需要验证码验证，我们输入验证码后点击发帖后抓包，这个包会验证下验证码是否正确，我们forward此包，再将第二个包放到repeater里即可实现重放攻击，造成无限制刷帖。1.要重放的包：\n\n2.刷帖结果：\n\n存在同样的问题还有论坛回复处：\n\n商品评论处：\n\n   修复方案：  1.注入点加个引号保护；2.验证码的问题也很严重，毕竟电商被刷帖或者刷评论（好评？差评？）还是有些危害的。   版权声明：转载请注明来源 HackBraid@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-07 09:55 厂商回复： 感谢，理解修正 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-05 01:07 |    \t\tzj1244 \t\t\t( 普通白帽子  |\t\t\t        Rank:273 漏洞数:33        | 小葵)\t\t \n  膜拜师傅    \n     2014-07-05 01:21 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  都这么晚还不睡    \n     2014-07-05 01:27 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  夜猫子居多    \n     2014-07-05 05:58 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  @zj1244 你是他徒弟？    \n     2014-07-05 08:29 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  我擦，牛    \n     2014-07-05 15:19 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  牛逼    \n     2014-07-05 15:27 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  @wefgod 很水的。。。不及你的千分之一牛    \n     2014-07-05 15:54 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @HackBraid 我没你们想的那么厉害啊，都把我神话了，回头会让你们失望    \n     2014-07-29 09:49 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  很给力啊。成为大牛了    \n     2014-07-30 16:57 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  @wefgod ...水洞，本来就想研究下刷帖，顺便看了下那块源码    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}