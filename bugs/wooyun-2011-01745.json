{"id": 23203, "wybug_id": "wooyun-2011-01745", "wybug_title": "乔客(joekoe) CMS 4.0 上传与SQL注入漏洞", "wybug_corp": "乔客(joekoe) CMS 4.0", "wybug_author": "蓝盾科技", "wybug_date": "2011-03-28 21:56", "wybug_open_date": "2011-03-29 11:08", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["白盒测试", "源码审核", "乔客"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-03-28：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2011-03-29：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 乔客4.0版本中存在两个高危漏洞,一个上传漏洞,可以随意上传任意文件,包括ASP,另一个是SQL注入,甚至还有返回错误信息,可怕啊上传漏洞:看/common/include/web.upload.asp 中的代码————————————————————-sub doPageLoad()if APP_STATUS=”close” thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”网站暂时因关闭维护中！请稍候…”exit subend ifup.doInit()if not upConfig.isInit thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”上传文件的参数不正确！”elsedoPageLoadUser()select case upConfig.channelcase “forum”upConfig.setSaveDir(upConfig.getSaveDir&(left(ops.time.toConvertString(“”,10),6)&DIR_SEPARATOR))upConfig.filename=”\"case “user.face”upConfig.filename=”face_”&upConfig.useridupConfig.setSaveDir(“face”&DIR_SEPARATOR)upConfig.filetype=”gif”case “blog.logo”upConfig.setSaveDir(“blog”&DIR_SEPARATOR)upConfig.filetype=”gif”case elseif instr(upConfig.channel,”.”)>0 thenupConfig.setSaveDir(mid(upConfig.channel,1,instr(upConfig.channel,”.”)-1)&DIR_SEPARATOR)end ifif instr(upConfig.fileinput,”url”)>0 thenupConfig.filetype=”affix”end ifend selectif len(upConfig.getSaveDir())<3 thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”上传文件的参数不正确！”exit subend ifif 1=1 thenupConfig.setData “zoom.channel.width”,120upConfig.setData “zoom.channel.height”,90end ifupConfig.setBaseDir(DIR_ROOT&DIR_UPLOAD)upConfig.setBasePath(opsDirPath(DIR_ROOT&DIR_UPLOAD))upConfig.setBaseURL(URL_UPLOAD)up.doLoad()end ifend sub————————————————————-这段代码通过channel判断是否给上传类型赋值,如果channel不等于forum、user.face、blog.logo的时候判断fileinput是否包含url，如果不包含，upConfig.filetype就不赋值，继续往下看———————————————————————if up.isPost() thencall doParseUploadData()treeData.addItem “_status”,”succeed”dim tmpFormMode,tmpFileValue,tmpThumbValuetmpFormMode=”set”if upConfig.channel=”user.face” thentmpLinkMode=”no”tmpFileValue=”#”&up.getFileInfo(“filename”)elsetmpFileValue=up.getFileInfo(“file.path”)select case upConfig.filetypecase “file”tmpLinkMode=”no”‘tmpFileValue=up.getFileInfo(“file.path”)case “pic”,”spic”,”pics”,”affix”,”gif”,”jpg”,”jpeg”,”bmp”,”png”tmpLinkMode=”no”tmpThumbValue=up.getFileInfo(“thumb.path”)case elsetmpLinkMode=”again”tmpFormMode=”append”dim tmpFileType:tmpFileType=lcase(up.getFileInfo(“filetype”))select case tmpFileTypecase “gif”,”jpg”,”jpeg”,”bmp”,”png”tmpFileValue=”\"case “swf”tmpFileValue=”\"case elsetmpFileValue=”[download=\"&tmpFileType&\"]upload_download.asp?id=”&upConfig.fileid&”[/download]“end selectend selectend iftreeData.addItem “_form.mode”,tmpFormModetreeData.addItem “_form.filevalue”,tmpFileValuetreeData.addItem “_form.thumbvalue”,tmpThumbValueend if———————————————————————-这段代码判断upConfig.filetype，然后定义上传文件的后缀名，只要之前upConfig.filetype没被赋值，且不是gif,jpg,jpeg,bmp,png,swf,就tmpFileValue=”[download=\"&tmpFileType&\"]upload_download.asp?id=”&upConfig.fileid&”[/download]“，看到这个，大家眼睛都放光了，根据用户的定义来判断上传类型，就好比问一个要偷东西的人：“你是贼么？”，这段代码也太XX了，估计之前也有不少人读出来了，只不过没公开而已 详细说明：  乔客4.0版本中存在两个高危漏洞,一个上传漏洞,可以随意上传任意文件,包括ASP,另一个是SQL注入,甚至还有返回错误信息,可怕啊上传漏洞:看/common/include/web.upload.asp 中的代码————————————————————-sub doPageLoad()if APP_STATUS=”close” thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”网站暂时因关闭维护中！请稍候…”exit subend ifup.doInit()if not upConfig.isInit thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”上传文件的参数不正确！”elsedoPageLoadUser()select case upConfig.channelcase “forum”upConfig.setSaveDir(upConfig.getSaveDir&(left(ops.time.toConvertString(“”,10),6)&DIR_SEPARATOR))upConfig.filename=”\"case “user.face”upConfig.filename=”face_”&upConfig.useridupConfig.setSaveDir(“face”&DIR_SEPARATOR)upConfig.filetype=”gif”case “blog.logo”upConfig.setSaveDir(“blog”&DIR_SEPARATOR)upConfig.filetype=”gif”case elseif instr(upConfig.channel,”.”)>0 thenupConfig.setSaveDir(mid(upConfig.channel,1,instr(upConfig.channel,”.”)-1)&DIR_SEPARATOR)end ifif instr(upConfig.fileinput,”url”)>0 thenupConfig.filetype=”affix”end ifend selectif len(upConfig.getSaveDir())<3 thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”上传文件的参数不正确！”exit subend ifif 1=1 thenupConfig.setData “zoom.channel.width”,120upConfig.setData “zoom.channel.height”,90end ifupConfig.setBaseDir(DIR_ROOT&DIR_UPLOAD)upConfig.setBasePath(opsDirPath(DIR_ROOT&DIR_UPLOAD))upConfig.setBaseURL(URL_UPLOAD)up.doLoad()end ifend sub————————————————————-这段代码通过channel判断是否给上传类型赋值,如果channel不等于forum、user.face、blog.logo的时候判断fileinput是否包含url，如果不包含，upConfig.filetype就不赋值，继续往下看———————————————————————if up.isPost() thencall doParseUploadData()treeData.addItem “_status”,”succeed”dim tmpFormMode,tmpFileValue,tmpThumbValuetmpFormMode=”set”if upConfig.channel=”user.face” thentmpLinkMode=”no”tmpFileValue=”#”&up.getFileInfo(“filename”)elsetmpFileValue=up.getFileInfo(“file.path”)select case upConfig.filetypecase “file”tmpLinkMode=”no”‘tmpFileValue=up.getFileInfo(“file.path”)case “pic”,”spic”,”pics”,”affix”,”gif”,”jpg”,”jpeg”,”bmp”,”png”tmpLinkMode=”no”tmpThumbValue=up.getFileInfo(“thumb.path”)case elsetmpLinkMode=”again”tmpFormMode=”append”dim tmpFileType:tmpFileType=lcase(up.getFileInfo(“filetype”))select case tmpFileTypecase “gif”,”jpg”,”jpeg”,”bmp”,”png”tmpFileValue=”\"case “swf”tmpFileValue=”\"case elsetmpFileValue=”[download=\"&tmpFileType&\"]upload_download.asp?id=”&upConfig.fileid&”[/download]“end selectend selectend iftreeData.addItem “_form.mode”,tmpFormModetreeData.addItem “_form.filevalue”,tmpFileValuetreeData.addItem “_form.thumbvalue”,tmpThumbValueend if———————————————————————-这段代码判断upConfig.filetype，然后定义上传文件的后缀名，只要之前upConfig.filetype没被赋值，且不是gif,jpg,jpeg,bmp,png,swf,就tmpFileValue=”[download=\"&tmpFileType&\"]upload_download.asp?id=”&upConfig.fileid&”[/download]“，看到这个，大家眼睛都放光了，根据用户的定义来判断上传类型，就好比问一个要偷东西的人：“你是贼么？”，这段代码也太XX了，估计之前也有不少人读出来了，只不过没公开而已.   漏洞证明：  上传漏洞:看/common/include/web.upload.asp 中的代码————————————————————-sub doPageLoad()if APP_STATUS=”close” thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”网站暂时因关闭维护中！请稍候…”exit subend ifup.doInit()if not upConfig.isInit thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”上传文件的参数不正确！”elsedoPageLoadUser()select case upConfig.channelcase “forum”upConfig.setSaveDir(upConfig.getSaveDir&(left(ops.time.toConvertString(“”,10),6)&DIR_SEPARATOR))upConfig.filename=”\"case “user.face”upConfig.filename=”face_”&upConfig.useridupConfig.setSaveDir(“face”&DIR_SEPARATOR)upConfig.filetype=”gif”case “blog.logo”upConfig.setSaveDir(“blog”&DIR_SEPARATOR)upConfig.filetype=”gif”case elseif instr(upConfig.channel,”.”)>0 thenupConfig.setSaveDir(mid(upConfig.channel,1,instr(upConfig.channel,”.”)-1)&DIR_SEPARATOR)end ifif instr(upConfig.fileinput,”url”)>0 thenupConfig.filetype=”affix”end ifend selectif len(upConfig.getSaveDir())<3 thentreeData.addItem “_status”,”error.message”treeData.addItem “_message”,”上传文件的参数不正确！”exit subend ifif 1=1 thenupConfig.setData “zoom.channel.width”,120upConfig.setData “zoom.channel.height”,90end ifupConfig.setBaseDir(DIR_ROOT&DIR_UPLOAD)upConfig.setBasePath(opsDirPath(DIR_ROOT&DIR_UPLOAD))upConfig.setBaseURL(URL_UPLOAD)up.doLoad()end ifend sub————————————————————-这段代码通过channel判断是否给上传类型赋值,如果channel不等于forum、user.face、blog.logo的时候判断fileinput是否包含url，如果不包含，upConfig.filetype就不赋值，继续往下看———————————————————————if up.isPost() thencall doParseUploadData()treeData.addItem “_status”,”succeed”dim tmpFormMode,tmpFileValue,tmpThumbValuetmpFormMode=”set”if upConfig.channel=”user.face” thentmpLinkMode=”no”tmpFileValue=”#”&up.getFileInfo(“filename”)elsetmpFileValue=up.getFileInfo(“file.path”)select case upConfig.filetypecase “file”tmpLinkMode=”no”‘tmpFileValue=up.getFileInfo(“file.path”)case “pic”,”spic”,”pics”,”affix”,”gif”,”jpg”,”jpeg”,”bmp”,”png”tmpLinkMode=”no”tmpThumbValue=up.getFileInfo(“thumb.path”)case elsetmpLinkMode=”again”tmpFormMode=”append”dim tmpFileType:tmpFileType=lcase(up.getFileInfo(“filetype”))select case tmpFileTypecase “gif”,”jpg”,”jpeg”,”bmp”,”png”tmpFileValue=”\"case “swf”tmpFileValue=”\"case elsetmpFileValue=”[download=\"&tmpFileType&\"]upload_download.asp?id=”&upConfig.fileid&”[/download]”end selectend selectend iftreeData.addItem “_form.mode”,tmpFormModetreeData.addItem “_form.filevalue”,tmpFileValuetreeData.addItem “_form.thumbvalue”,tmpThumbValueend if乔客(JoeKoe) CMS 4.0后台拿shell。来到后台—>系统管理—>网站配置—>网站名称—>在网站名称那里写入一句话。\n\n然后通过一句话链接器连接. www.XXX.com/index.asp 即可！   修复方案：     版权声明：转载请注明来源 蓝盾科技@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：12 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 12, "Ranks": null}