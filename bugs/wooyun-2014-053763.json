{"id": 57645, "wybug_id": "wooyun-2014-053763", "wybug_title": "PHPMYWIND Sql Injection #2", "wybug_corp": "phpmywind.com", "wybug_author": "′雨。", "wybug_date": "2014-03-18 16:35", "wybug_open_date": "2014-06-16 16:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-16：\t细节向公众公开  简要描述： 过滤不严。 详细说明：  PHPMyWind\\data\\alipay\\notify_url.php中\n$alipayNotify = new AlipayNotify($alipay_config);$verify_result = $alipayNotify->verifyNotify();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代\t\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——\t    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表\t\t//商户订单号\t$out_trade_no = $_POST['out_trade_no'];\t//支付宝交易号\t$trade_no = $_POST['trade_no'];\t//交易状态\t$trade_status = $_POST['trade_status'];    if($_POST['trade_status'] == 'TRADE_FINISHED') {\t\t//更新订单状态\t\t$r = $dosql->GetOne(\"SELECT * FROM `#@__goodsorder` WHERE `id`=$out_trade_no\");\t\t\t\tif(isset($r) && is_array($r))\t\t{\t\t\t$checkinfo = explode(',',$r['checkinfo']);\t\t\t\tif(!in_array('payment',$checkinfo))\t\t\t{\t\t\t\t$sql = \"UPDATE `#@__goodsorder` SET checkinfo='\".$r['checkinfo'].',payment'.\"' WHERE `id`=$out_trade_no\";\t\t\t\t$dosql->ExecNoneQuery($sql);\t\t\t}\t\t}\n首先要注入的话 肯定要先通过这个验证。\nfunction verifyNotify(){\t\tif(empty($_POST)) {//判断POST来的数组是否为空\t\t\treturn false;\t\t}\t\telse {\t\t\t//生成签名结果\t\t\t$isSign = $this->getSignVeryfy($_POST, $_POST[\"sign\"]);\t\t\t//获取支付宝远程服务器ATN结果（验证是否是支付宝发来的消息）\t\t\t$responseTxt = 'true';\t\t\tif (! empty($_POST[\"notify_id\"])) {$responseTxt = $this->getResponse($_POST[\"notify_id\"]);}\t\t\t\t\t\t//写日志记录\t\t\t//if ($isSign) {\t\t\t//\t$isSignStr = 'true';\t\t\t//}\t\t\t//else {\t\t\t//\t$isSignStr = 'false';\t\t\t//}\t\t\t//$log_text = \"responseTxt=\".$responseTxt.\"\\n notify_url_log:isSign=\".$isSignStr.\",\";\t\t\t//$log_text = $log_text.createLinkString($_POST);\t\t\t//logResult($log_text);\t\t\t\t\t\t//验证\t\t\t//$responsetTxt的结果不是true，与服务器设置问题、合作身份者ID、notify_id一分钟失效有关\t\t\t//isSign的结果不是true，与安全校验码、请求时的参数格式（如：带自定义参数等）、编码格式有关\t\t\tif (preg_match(\"/true$/i\",$responseTxt) && $isSign) {\t\t\t\treturn true;\t\t\t} else {\t\t\t\treturn false;\t\t\t}\t\t}\t}\n只要两个变量都匹配出true 就通过验证。responseTxt 为true 这个就不用看了 看另外一个\nfunction getSignVeryfy($para_temp, $sign) {\t\t//除去待签名参数数组中的空值和签名参数\t\t$para_filter = paraFilter($para_temp);\t\t\t\t//对待签名参数数组排序\t\t$para_sort = argSort($para_filter);\t\t\t\t//把数组所有元素，按照“参数=参数值”的模式用“&”字符拼接成字符串\t\t$prestr = createLinkstring($para_sort);\t\t\t\t$isSgin = false;\t\tswitch (strtoupper(trim($this->alipay_config['sign_type']))) {\t\t\tcase \"MD5\" :\t\t\t\t$isSgin = md5Verify($prestr, $sign, $this->alipay_config['key']);\t\t\t\tbreak;\t\t\tdefault :\t\t\t\t$isSgin = false;\t\t}\t\t\t\treturn $isSgin;\t}\n\nfunction md5Verify($prestr, $sign, $key) {\t$prestr = $prestr . $key;\t$mysgin = md5($prestr); \tif($mysgin == $sign) {\t\treturn true;\t}\telse {\t\treturn false;\t}}?>\n只要相等的话就会返回True了。那来注入把。   漏洞证明：  \n\n注入成功 有图 有真相。   修复方案：  无尽的过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-03-26 17:12 厂商回复： 该文件为支付宝官方提供文件，漏洞存在。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-16 12:23 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′ 雨。 hi洞主，我居然私信不到你。。。    \n     2014-04-16 12:39 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗    那狗哥  加个扣扣吧。。    \n     2014-04-16 12:48 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′ 雨。 嗯 加个秋秋 防泄漏 mail到 help@wooyun.org 里吧~    \n     2014-04-16 13:31 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗   狗哥 已发，    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}