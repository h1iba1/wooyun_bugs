{"id": 15994, "wybug_id": "wooyun-2012-013505", "wybug_title": "ThinkSNS 2.8 上传任意文件漏洞", "wybug_corp": "ThinkSNS", "wybug_author": "yelo", "wybug_date": "2012-10-18 15:18", "wybug_open_date": "2012-12-02 15:19", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "14", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-10-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-10-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-11-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-11-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-11-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-12-02：\t细节向公众公开  简要描述： ThinkSNS 2.8 可上传任意文件 详细说明：  微博上传图片时只在前端进行验证, 服务器端没有进行安全过滤。\\api\\StatusesApi.class.php\nfunction uploadpic(){     \tif( $_FILES['pic'] ){    \t\t//执行上传操作    \t\t$savePath =  $this->_getSaveTempPath();    \t\t$filename = md5( time().'teste' ).'.'.substr($_FILES['pic']['name'],strpos($_FILES['pic']['name'],'.')+1);\t    \tif(@copy($_FILES['pic']['tmp_name'], $savePath.'/'.$filename) || @move_uploaded_file($_FILES['pic']['tmp_name'], $savePath.'/'.$filename))\t        {\t        \t$result['boolen']    = 1;\t        \t$result['type_data'] = 'temp/'.$filename;\t        \t$result['picurl']    = SITE_PATH.'/uploads/temp/'.$filename;\t        } else {\t        \t$result['boolen']    = 0;\t        \t$result['message']   = '上传失败';\t        }    \t}else{        \t$result['boolen']    = 0;        \t$result['message']   = '上传失败';    \t}\t\treturn $result;    }\nunloadpic()方法没有对文件类型进行验证可以构建表单, 选择任意文件, 提交到/index.php?app=w3g&mod=Index&act=doPost在新提交的微博上可以找到上传的文件地址(去掉small_、middle_ 前缀)   漏洞证明：  在登录thinksns官方微博后,构建以下表单:\n<form action=\"http://t.thinksns.com/index.php?app=w3g&mod=Index&act=doPost\" method=\"post\" enctype=\"multipart/form-data\" />\t\t<textarea name=\"content\">test</textarea>\t\tfile: <input id=\"file\" type=\"file\" name=\"pic\" />\t\t<input type=\"submit\" value=\"Post\" />\t</form>\n去掉缩略图的前缀(small_ )\n\n   修复方案：  \\api\\StatusesApi.class.php\nfunction uploadpic(){    \t/**    \t * 20121018 @yelo    \t * 增加上传类型验证    \t */    \t$pathinfo = pathinfo($_FILES['pic']['name']);    \t$ext = $pathinfo['extension'];    \t$allowExts = array('jpg', 'png', 'gif', 'jpeg');    \t$uploadCondition = $_FILES['pic'] && in_array(strtolower($ext),$allowExts,true);    \tif( $uploadCondition ){    \t\t//执行上传操作    \t\t$savePath =  $this->_getSaveTempPath();    \t\t$filename = md5( time().'teste' ).'.'.substr($_FILES['pic']['name'],strpos($_FILES['pic']['name'],'.')+1);\t    \tif(@copy($_FILES['pic']['tmp_name'], $savePath.'/'.$filename) || @move_uploaded_file($_FILES['pic']['tmp_name'], $savePath.'/'.$filename))\t        {\t        \t$result['boolen']    = 1;\t        \t$result['type_data'] = 'temp/'.$filename;\t        \t$result['picurl']    = SITE_PATH.'/uploads/temp/'.$filename;\t        } else {\t        \t$result['boolen']    = 0;\t        \t$result['message']   = '上传失败';\t        }    \t}else{        \t$result['boolen']    = 0;        \t$result['message']   = '上传失败';    \t}\t\treturn $result;    }\n   版权声明：转载请注明来源 yelo@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2012-10-23 10:04 厂商回复： 这个已修复过了，不过还没通知用户，还是感谢您发现了问题，截图很详尽。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-10-22 10:50 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  截图上传那里？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}