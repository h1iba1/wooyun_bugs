{"id": 85964, "wybug_id": "wooyun-2016-0170571", "wybug_title": "微软某PC端软件二进制代码劫持漏洞", "wybug_corp": "微软", "wybug_author": "MITM", "wybug_date": "2016-01-17 14:56", "wybug_open_date": "2016-04-11 16:08", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "17", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["客户端安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-24：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-03-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-03-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-04-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-04-11：\t细节向公众公开  简要描述： 微软某PC端软件二进制代码劫持漏洞。 详细说明：  Visual Studio Code Version 0.10.6存在DLL和EXE劫持漏洞。当使用Code打开文件（比如test.md）时，当前目录（current directory）为test.md所在目录。Code在启动时尝试运行REG.exe（reg query HKLM\\Software\\Microsoft\\SQMClient /v MachineId），而且没有指定全路径，导致REG.exe可以从当前目录加载[1]。如果攻击者把test.md和reg.exe一起发给用户（比如做成压缩包），那么当用户打开test.md时，reg.exe也会执行。另外Code还加载了一些不存在的DLL：CSUNSAPI.dll, swift.dll, nfhwcrhk.dll, SureWareHook.dll, aep.dll, atasi.dll, nuronssl.dll, ubsec.dll。这些DLL不存在于应用目录以及系统目录，这导致它们一样可以从当前目录加载。下载地址：https://**.**.**.**/Docs/?dv=win[1] 加载exe和加载dll的寻找顺序不一样。加载exe的顺序是：应用目录>当前目录>系统目录>PATH，加载dll的默认顺序是：应用目录>系统目录>当前目录>PATH。这导致即使系统目录中存在该exe，仍可以劫持该exe。https://**.**.**.**/en-us/library/windows/desktop/ms682425(v=vs.85).aspxhttps://**.**.**.**/en-us/library/windows/desktop/ff919712(v=vs.85).aspx英文版：Visual Studio Code Version 0.10.6 is vulnerable to DLL and EXE planting attacks.Product: Visual Studio Code Version: 0.10.6Download URL: https://**.**.**.**/Docs/?dv=winType of vulnerability: Remote Code ExecutionDetail:VS Code doesn't set its current directory to the application directory. So, when a file (taking test.md as an example) is opened with Code, the current directory is where test.md resides. During initialization, Code launches reg.exe without specifying the full path (reg query HKLM\\Software\\Microsoft\\SQMClient /v MachineId), so reg.exe can be loaded from the current directory, which can be controlled by an attacker if he distributes a zip file containing test.md and a malicious reg.exe.Also Code loads CSUNSAPI.dll, swift.dll, nfhwcrhk.dll, SureWareHook.dll, aep.dll, atasi.dll, nuronssl.dll, ubsec.dll. These DLLs exist neither in the application directory nor in the system directories. So they can be loaded from the current directory as well.To fix this vulnerability, set the current directory to the application directory. Alternatively, specify the full path of reg.exe (or use Registry APIs to query values) and call SetDllDirectory(\"\").   漏洞证明：  打开Process Explorer，筛选Code.exe进程、NAME NOT FOUND结果，就可以发现这个漏洞：\n\n\n\n\n\n\n\n   修复方案：  使用全地址，调用SetDllDirectory(\"\")，把当前地址设置为应用地址。   版权声明：转载请注明来源 MITM@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2016-01-21 13:47 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-17 15:36 |    \t\t’‘Nome \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:31        | 有事请发邮件，2859857@gmail.com，垃圾邮...)\t\t \n  哥们 , 你玩中间人劫持玩的很厉害呀~    \n     2016-01-17 15:54 |    \t\tMark0smith \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:55        | ^_^)\t\t \n  前排    \n     2016-01-21 14:05 |    \t\t面具 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:6        | 同样是一个B,往北走是NB,往南走就是SB,所以...)\t\t \n  前排    \n     2016-01-21 17:55 |    \t\t内谁 \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:5        | 我是内谁)\t\t \n  关注    \n     2016-01-22 09:00 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:322 漏洞数:58        | little red pig!)\t\t \n  膜拜    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}