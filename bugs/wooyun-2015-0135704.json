{"id": 71225, "wybug_id": "wooyun-2015-0135704", "wybug_title": "江南科友堡垒机直接获取主机账密/IP/暴漏物理路径", "wybug_corp": "江南科友堡垒机", "wybug_author": "孔卡", "wybug_date": "2015-08-22 22:30", "wybug_open_date": "2015-11-22 19:02", "wybug_type": "非授权访问", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感信息泄露", "未授权访问", "默认配置高危"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-22：\t细节向公众公开  简要描述： 据说虐狗节还在挖洞的一辈子找不到女盆友~~~~当然了，我这个洞是提前挖好的，上来粘贴复制的！！在等女朋友汇合中~~~~~ 详细说明：  看到标题审核估计会以为重复了，那我事先简单说一下先http://**.**.**.**/bugs/wooyun-2010-077350   这个直接导出主机资源和堡垒机个人用户的漏洞里涉及的俩文件是/excel/user_export.php   导出后对应user.xls/excel/server_export.php   导出后对应server.xlsuser如果是本地密码存储的话，user.xls里会有sha1加密的hash值，当然，现在大多是radius小令牌认证，自然也就木有密码了。server.xls 是对所有接入堡垒机的主机资源的一个统计，只有IP和主机名。没有其他意思，只是介绍一下以便区分我要说的问题点。然后另外一枚漏洞中泄露物理路径的是这里**.**.**.**/system/download_cert.php?down_cret=1客户案例不用说了吧？好了，下部分开始说正事。   漏洞证明：  0x01  一键获取主机账密、端口、IP路径是  /excel/sso_user_export.php   导出后文件名也是user.xls  打开后的结果见图吧\n\n打码打的狠了点，毕竟不是自家的堡垒机。这些账密在其数据库中存储是sha1加密的，而这样导出直接是明文。接下来能干嘛不废话了。贴出sso_user_export.php\n<?/** * 设置环境变量 * */$path = 'WEB-INF';set_include_path(get_include_path() . PATH_SEPARATOR . $path);require_once('../operation/SSoDB.php');$db = new SSoDB();\tif(!empty($_GET['rsname']))\t{\t\t$acc=$db->Getuserinfo($_GET['rsname']);\t}\telse\t\t$acc=$db->GetAllAccount(1,$db->Get_count());\tif(empty($acc))\t{\t\techo '<script type=\"text/javascript\"> alert(\"抱歉，无帐户可导出！\");  history.back(); </script>';\t\texit;\t}\t$time=date(\"Y-m-d\"); //\tprint_r($acc);echo \"<br>\";\tfor($i=0;$i < count($acc);$i++)\t{\t\t$temp_msg[$i][0] = $acc[$i]['name'];\t\t$temp_msg[$i][1] = DecryptPWD($acc[$i]['pwd']);\t\t$temp_msg[$i][2] = $acc[$i]['ip'];\t\t$temp_msg[$i][3] = $acc[$i]['pwd_trusteeship'];\t\tif(!empty($_GET['rsname']))\t\t{\t\t\tif($acc[$i]['7'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][3] = '普通帐户';\t\t\t}\t\t\telse if($acc[$i]['7'] == 1)\t\t\t{\t\t\t\t$temp_msg[$i][3] = '管理帐户';\t\t\t}\t\t\telse if($acc[$i]['7'] == 2)\t\t\t{\t\t\t\t$temp_msg[$i][3] = 'ftp帐户';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][3] = '超级管理帐户';\t\t\t}\t\t\tif($acc[$i]['9'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][4] = '否';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][4] = '是'; \t\t\t}\t\t\tif($acc[$i]['8'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][5] = '永久有效';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][5] = $acc[$i]['pwd_lifetime'].'天';\t\t\t\t}\t\t\tif($acc[$i]['10'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][6] = '未激活';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][6] = '激活';\t\t\t\t}\t\t}\t\telse\t\t{\t\t\tif($acc[$i]['manager_flag'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][3] = '普通帐户';\t\t\t}\t\t\telse if($acc[$i]['manager_flag'] == 1)\t\t\t{\t\t\t\t$temp_msg[$i][3] = '管理帐户';\t\t\t}\t\t\telse if($acc[$i]['manager_flag'] == 2)\t\t\t{\t\t\t\t$temp_msg[$i][3] = 'ftp帐户';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][3] = '超级管理帐户';\t\t\t}\t\t\tif($acc[$i]['pwd_trusteeship'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][4] = '否';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][4] = '是'; \t\t\t}\t\t\tif($acc[$i]['pwd_lifetime'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][5] = '永久有效';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][5] = $acc[$i]['pwd_lifetime'].'天';\t\t\t\t}\t\t\tif($acc[$i]['state'] == 0)\t\t\t{\t\t\t\t$temp_msg[$i][6] = '未激活';\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$temp_msg[$i][6] = '激活';\t\t\t\t}\t\t}\t\t\t\t$temp_msg[$i][7] = $acc[$i]['spec'];\t}//print_r($temp_msg);exit;require 'Spreadsheet/Excel/Writer.php'; $workbook = new Spreadsheet_Excel_Writer(); // 初始化类 $workbook->send('user.xls'); // 发送 Excel 文件名供下载 $worksheet =& $workbook->addWorksheet('sheet-1'); // 加入一个工作表 sheet-1 $data = array(    \t\t\t\t\tarray('帐户名', '密码', 'IP','帐户类型','密码托管','密码有效期','帐户状态','帐户备注')\t\t\t\t\t\t\t);for ($row = 0; $row < count($data); $row ++) {  for ($col = 0; $col < count($data[0]); $col ++)   {\t\t$worksheet->writeString($row, $col, $data[$row][$col]); // 在 sheet-1 中写入数据   }}for ($r = 1; $r <= count($temp_msg); $r ++) {    for ($c = 0; $c < count($temp_msg[0]); $c++)     {\t\t\t$worksheet->writeString($r, $c, $temp_msg[$r-1][$c]); // 在 sheet-1 中写入数据     }}$col_width = 10;$worksheet->setColumn(0,1,$col_width*2);$worksheet->setColumn(2,2,$col_width*2);$worksheet->setColumn(3,7,$col_width*2);$workbook->close(); // 完成下载?>\n0x02  直接爆物理路径漏洞/excel/Spreadsheet/Excel/Writer.php 1处/excel/Spreadsheet/Excel/Writer/ 路径下Format.php  Parser.php  BIFFwriter.php   Workbook.php   Worksheet.php  这5处全部爆物理路径\n\n\n\n0x03 吐槽下该堡垒机的无语的默认配置一.内置一个谁都审计不到的具有最高权限的 Administrator   密码我直接说明文了吧 UnionHAC  方便各位自查。（这个有人说过了，本人亲身测试了3家都是这个密码，省下注入解密了）二.内置本地mysql数据库  root 123456  你没看错，就这么任性。如果端口限制不严的话，配合物理路径getshell。三.内置的配置，如ftp日志服务器连接字符串，radius服务器公钥等，虽然都打码的，并且在数据库中sha1加密，但是，只要点编辑，然后保存，你就会发现，明文数据包全部抓到。好了，之所以贴出明文是希望部分客户看到后直接用以上明文快速测试一下，以确保最后一道防线的安全。   修复方案：  漏洞忒多，找厂家要下补丁吧，一言难尽啊。我过虐狗节去了哈~   版权声明：转载请注明来源 孔卡@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-08-24 19:00 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-11-22 21:59 |    \t\tf19ht \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:15        | 依依不舍的还是你的菊花。)\t\t \n  大码大的不专业啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}