{"id": 1951, "wybug_id": "wooyun-2014-067527", "wybug_title": "日本北海道大学能源管理系统加三菱Q系列PLC以太网模块泄露", "wybug_corp": "日本北海道大学", "wybug_author": "Z-0ne", "wybug_date": "2014-07-05 17:50", "wybug_open_date": "2014-08-19 17:52", "wybug_type": "网络未授权访问", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["内部系统对外", "工控安全", "基础设备安全", "安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-19：\t细节向公众公开  简要描述： 针对三菱Q系列PLC的安全分析可以参照前文，而这个就是一个控制设备跑在公网的切实的案例，同样也是本次能根据title确认的一个案例。理论上PLC如果没设置密码是可通过编程软件是实现远程管理操作，即工程上载和下载，停止运行等。该案例中确认了涉事地址开放的web服务为ecoserver（应该同为三菱的小型web能源监控管理系统，主要用来监视当前电力使用情况，加载java后可以查看趋势图等）通过开放的udp端口确认了PLC型号为Q系列PLC（Q12DCCPU-V）。识别方式可以参照上一篇分析，通用批量验证的话可以使用文中的基于NMAP的nse脚本。 详细说明：  Web部分截图:首页\n\n\n\n趋势图\n\n测点信息\n\n利用NMAP脚本识别的信息：\n\n   漏洞证明：  NMAP通用型发现脚本tcp版本\nhttp://plcscan.org/blog/wp-content/uploads/2014/07/melsecq-discover.nse_.txt\nudp版本\nhttp://plcscan.org/blog/wp-content/uploads/2014/07/melsecq-discover-udp.nse_.txt\n\n-- Nmap Scripting Engine-- required packages for this script-- local bin = require \"bin\"local nmap = require \"nmap\"local shortport = require \"shortport\"local stdnse = require \"stdnse\"local string = require \"string\"local table = require \"table\"--Output Example:--PORT     STATE SERVICE                REASON--5006/udp open  Mitsubishi/Melsoft udp syn-ack--| melsecq-discover:--|_  CPUINFO: Q03UDECPUdescription = [[discovery Mitsubishi Electric Q Series PLC \tGET CPUINFO]]author = \"ICS Security Workspace(plcscan.org)\"license = \"Same as Nmap--See http://nmap.org/book/man-legal.html\"categories = {\"discovery\",\"intrusive\"}function set_nmap(host, port)\tport.state = \"open\"\tport.version.name = \"Mitsubishi/Melsoft Udp\"\tport.version.product = \"Mitsubishi Q PLC\"\tnmap.set_port_version(host, port)\tnmap.set_port_state(host, port, \"open\") endfunction send_receive(socket, query)\tlocal sendstatus, senderr = socket:send(query)\tif(sendstatus == false) then    return \"Error Sending getcpuinfopack\"\tend\tlocal rcvstatus,response = socket:receive()\tif(rcvstatus == false) then\treturn \"Error Reading getcpuinfopack\"\tend\treturn response\tendportrule = shortport.port_or_service(5006, \"Melsoft/TCP\", \"udp\")action = function(host,port)\tlocal getcpuinfopack = bin.pack(\"H\",\"57000000001111070000ffff030000fe03000014001c080a080000000000000004\" .. \"0101\" .. \"010000000001\")\tlocal response\tlocal output = stdnse.output_table()\tlocal sock = nmap.new_socket()\tlocal constatus,conerr = sock:connect(host,port)\tif not constatus then    stdnse.print_debug(1,      'Error establishing connection for %s - %s', host,conerr      )    return nil\tend\tresponse  = send_receive(sock, getcpuinfopack)\tlocal mel, pack_head = bin.unpack(\"C\", response, 1)--\tlocal mel, space_id = bin.unpack(\"C\", response, 55)\tlocal offset = 0\tif ( pack_head == 0xd7) then--\t\tif ( space_id == 0x20) then\t\tlocal mel\t\tlocal mel, cpuinfo = bin.unpack(\"z\", response, 42 + offset)\t\toutput[\"CPUINFO\"] = string.sub(cpuinfo, 1, 16)\t\tset_nmap(host, port)\t\tsock:close()\t\treturn output\t--\tend\telse\tsock:close()    \treturn nil\t\tend\t\t\tend\n   修复方案：  内部系统和外部设备还是不应该对外   版权声明：转载请注明来源 Z-0ne@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-10 17:14 厂商回复： CNVD确认所述情况（不直接复现），已经转由CNCERT直接向JPCERT/JVN通报所述漏洞案例情况。给z-0ne建立的 rank 20。建议有兴趣在工控方面研究的白帽子共同参与。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-05 17:54 |    \t\t我也不知道 \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:8        | 小新人QAQ)\t\t \n  叼炸天    \n     2014-07-05 17:55 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  要感谢下某位童鞋提供的基础数据以供二次识别确认    \n     2014-07-05 18:37 |    \t\tHUC缘生 \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:29        | 小白求罩~~~~)\t\t \n  围观  是能源设备cpu加载以太网模块接入公网？ 如果编程软件没有加入权限密码可以任意上传下载停止类似PLC的数据模块？     \n     2014-07-05 19:10 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  勘误一下，现在也只能猜测为是可能用于某楼能控的PLC，web的话应该为内嵌的，低版本的Q系列对以太网的支持是没有嵌入式的web监控界面的，产品资料http://www.mitsubishielectric.co.jp/fa/products/faspec/point.do?kisyu=/plcq&formNm=700057164    \n     2014-07-05 19:58 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  我觉得还是有一定几率是 实验室环境中的设备，当然仍然是存在风险的，我建议洞主能够多收集目标ip。     \n     2014-07-05 22:35 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:78        | 就恨自己服务器太少)\t\t \n  洞主，解放军需要你！    \n     2014-07-10 15:57 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  @Z-0ne 哪位同学啊，全网的数据么？    \n     2014-07-10 16:19 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  @cncert国家互联网应急中心 万分之一的命中率，全网没资源去做    \n     2014-07-10 23:04 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  给力啊    \n     2014-07-13 22:10 |    \t\t我是白帽子 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 我是白帽子)\t\t \n  转由CNCERT直接向JPCERT/JVN通报所述漏洞案例情况    \n     2014-08-19 19:13 |    \t\t看风者 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:14        | To shun evil is understanding)\t\t \n  光看名字就nb    \n     2014-08-19 19:21 |    \t\t魂淡、 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:2        | 么么哒)\t\t \n  促进中日良好合作发展，改善中日外交关系    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}