{"id": 52676, "wybug_id": "wooyun-2014-070493", "wybug_title": "appcms前台getshell（文件包含配合一处设计缺陷）", "wybug_corp": "appcms.cc", "wybug_author": "roker", "wybug_date": "2014-08-01 16:53", "wybug_open_date": "2014-10-27 16:54", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件包含漏洞利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-06：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-27：\t细节向公众公开  简要描述： rt 详细说明：  看到 index.php 的tpl\nif (substr($tpl, strlen($tpl)-4, 4) == '.php') {    $tmp_file = '/templates/' . $from_mobile . '/' . $tpl;} else {    $tmp_file = '/templates/' . $from_mobile . '/' . $tpl . '.php';} if (!file_exists(dirname(__FILE__) . $tmp_file)) die('模板页面不存在' . $tmp_file);require(dirname(__FILE__) . $tmp_file);\n很显然的 截断包含。但是 这个cms与用户交互的地方 很少，没有普通用户上传的地方。上传 shell的地方找了蛮久，我们 看到 upload/upload_file.php\n$page['get'] = $_GET;$page['post'] = $_POST;$dbm = new db_mysql();$params = $page['get']['params'];/** * $params=json_encode(urldecode($params)); * die('<script> alert('.$params.');</script>'); */$params = preg_replace('~(\\\\\\\")~', '\"', $params);$json_params = json_decode($params);// 1.验证请求安全性$verify = isset($page['get']['v'])?$page['get']['v']:'';if ($verify == '') die('<script>alert(\"No Access 001\");</script>');$verify = helper :: decrypt($verify, UPLOAD_KEY);$gsc = substr($verify, 0, strlen(UPLOAD_CODE));if ($gsc != UPLOAD_CODE) die('<script>alert(\"No Access 002 ' . $gsc . '\");</script>');if (!preg_match('~(\\d{10})~', substr($verify, strlen(UPLOAD_CODE)))) die('<script>alert(\"No Access 003' . $verify . '\");</script>');.............\n要知道 上传密钥 提交 verify 才能上传继续看到 同目录下 upload_form.php\n<?php    require_once(dirname(__FILE__).\"/../core/init.php\");    $upload_server= SITE_PATH.\"upload/\";    // 上传安全验证字符串    $verify=helper::encrypt(UPLOAD_CODE.strtotime(date('Y-m-d H:i:s')),UPLOAD_KEY);    $params=$_GET['params'];    $params=preg_replace('~(\\\\\\\")~','\"',$params);    $json=json_decode($params);?><html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /><title><?php echo SITE_NAME;?>后台管理</title><style>body{cursor:default;}.input-file {overflow:hidden;position:relative;background:#eee;border:1px solid #ccc;cursor:default;width:70px;height:25px;line-height:25px; margin-top:1px\\9; height:26px\\9; font-size:12px;display:inline-block;text-align:center;color:blue;}.input-file:hover{background:#ddd;cursor:default;}.input-file input{opacity:0;filter:alpha(opacity=0);font-size:100px;position:absolute;top:0;right:0;cursor:default;}</style><script language=\"javascript\" type=\"text/javascript\" src=\"<?php echo SITE_PATH?>templates/lib/jquery-1.7.1.min.js\" ></script><script type=\"text/javascript\">  $(document).ready(function() {      //提交上传    $('#file').bind('change', function() {        $('#form').submit();    });}) //回调通知function callback_upload(ret){    window.parent.<?php echo($json->func); ?>(ret);}</script></head><body>     <form action='<?php echo($upload_server); ?>upload_file.php?params=<?php echo urlencode($params);?>&v=<?php echo($verify);?>' id=\"form\" name=\"form\" enctype=\"multipart/form-data\" method=\"post\" target=\"hidden_frame\">          <a class=\"input-file\">上传文件<input type=\"file\" id=\"file\" name=\"file\" size=\"1\" style=\"width:70px;cursor:default;height:25px;line-height:25px;\"></a>       <iframe name=\"hidden_frame\" id=\"hidden_frame\" frameborder=\"no\" border=\"0″ marginwidth=\"0″ marginheight=\"0\" scrolling=\"no\" allowtransparency=\"yes\"></iframe>   </form> </body></html>\n这个文件 ，把 verify 给echo出来了。。我们 在浏览器里打开这个文件，\n\n得到 verify 后本地构造表单 上传 jpg格式一句话文件\n\n得到地址后 截断包含即可getshell\n\n   漏洞证明：  \n\n   修复方案：  修复~~   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-10-27 16:54 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-08 09:49 |    \t\tSunshine \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:10        | Nothing.)\t\t \n  tpl吗?    \n     2014-08-08 11:45 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @Sunshine 恩。。    \n     2014-09-23 20:46 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @roker 请教一下测试截断用的什么环境？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}