{"id": 36287, "wybug_id": "wooyun-2015-0102229", "wybug_title": "KingCms最新版（k9）越权添加管理员", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-19 14:29", "wybug_open_date": "2015-05-03 14:30", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作", "认证缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-19：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-03：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）越权添加管理员 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9，官网下下来学习一下。在wooyun上看到了几个漏洞，如： WooYun: kingcms最新版sql注入漏洞 这里可越权添加管理员。问题文件在/user/manage.php0x00：先来看看获得相关权限的绕过方法吧Kingcms使用$u=new user;$u->auth_role('admin');来验证用户是否具有admin的权限，先来看看user类，主要用来判断用户是否登录，以及获得用户的各种属性。/user/user.class.phpuser的构造方法如下\npublic function __construct(){\t\t$cookie=kc_cookie('userauth');\t\t$cookiePass=substr($cookie,0,32);\t\t$ischeck=true;\t\t$GLOBALS['db']=new db;\t\t$GLOBALS['str']=new str;\t\t$GLOBALS['cache']=new cache;\t\tglobal $db,$str;\t\t\t\tif(empty($cookie) && !empty($_GET['jsoncallback'])\t\t\t&& !empty($_GET['USERID']) && !empty($_GET['SIGN'])){\t//第1处注释：这里很容易使条件成立，执行下面的if语句\t\t\t\t\t\t\t$get_userid=$_GET['USERID'];\t\t\t$get_sign=$_GET['SIGN'];\t\t\t\t\t\t$sign=md5($get_userid.SITEURL.kc_config('system.salt'));\t\t\t\t\t\t$userid = $sign==$get_sign ? $get_userid : 0;\t//第2处注释：这里是唯一的一次简单验证\t\t\t\t\t$ischeck=false; //第3处注释：在下面第4处注释处会用到\t\t}else{\t\t\t$userid=substr($cookie,32);\t\t}\t\tif(!kc_validate($userid,2)) $userid=0;\t\tif(empty($userid)){\t\t\t$user=array('userpass'=>'x');\t\t}else{\t\t\t$user=$db->getRows_one('%s_user','*','userid='.$userid);\t\t\tif(empty($user)) $user=array('userpass'=>'x');\t\t}\t\t\t\t//用户已登录\t\tif (md5($user['userpass'])==$cookiePass || $ischeck==false) {//第4处注释无关代码\n上面代码的第二处注释的地方，要获得需要操作的userid，要计量$sign=md5($get_userid.SITEURL.kc_config('system.salt'));\t其中的参数$get_userid是用户输入，SITEURL是当前域名，不包含www等二级域名,[小写]，kc_config('system.salt')是系统默认的，定值。这样，这里就可以绕过了。使得$ischeck=false。$_GET['SIGN']也即$sign计算过程是这样的\n<?php$str=\"10000\";//10000即POST参数中的USERID$str.=\"kingcms.com\";//网站域名$SIGN=md5($str);?>\n在第4处注释处，因为$ischeck=false，所以，用户已登陆，USERID输入10000(kingcms系统的超级管理员id),就获得了管理员的所有权限了。下面看看添加管理员的代码吧/user/manage.php\nfunction _edit(){\t$u=new user;$u->auth_role('admin');\t$userid=kc_post('userid',2,0);\t$db=new db;\t$str=new str;\tif(empty($userid)){\t\tif (empty($_POST['username'])) kc_tip('请填写用户名!','form');\t\tif ($str->len($_POST['username'])>12) kc_tip('用户名太长，不能超过12字','form');\t\tif(preg_match('/[<>\\s\\!\\@\\/\\\\\\|\\]\\[\\}\\{\\#\\$\\%\\^\\&\\*\\(\\)\\_\\+\\=\\-]/',$_POST['username'])) kc_tip('用户名不能含有非法字符!','form');\t\t$rs=$db->getRows_one('%s_user','userid','username=\\''.$db->encode($_POST['username']).'\\'');\t\tif(!empty($rs)) kc_tip('您要添加的用户已经存在!','form');\t}\tif(empty($userid)){\t\tif(empty($_POST['userpass'])) kc_tip('密码不能为空!','form');\t}\tif(!empty($_POST['username'])){\t\tif (strlen($_POST['userpass'])>30) kc_tip('您的密码太长，不能超过30个字符!','form');\t\tif($_POST['userpass1']<>$_POST['userpass']) kc_tip('两次输入的密码不一致!','form');\t}\t\tif(!empty($_POST['rid']) && !kc_validate($_POST['rid'],3)) kc_tip('所属角色参数错误!','form');\t$rids=empty($_POST['rid']) ? array() : explode(',',$_POST['rid']);\tforeach($rids as $rid){\t\tif(!empty($_POST['role_removedate'.$rid]) && !kc_validate($_POST['role_removedate'.$rid],9)) kc_tip('有效日期格式不正确!','form');\t}\t\tif(!empty($_POST['gid']) && !kc_validate($_POST['gid'],3)) kc_tip('所属用户组参数错误!','form');\t$gids=empty($_POST['gid']) ? array() : explode(',',$_POST['gid']);\tforeach($gids as $gid){\t\tif(!empty($_POST['group_removedate'.$gid]) && !kc_validate($_POST['group_removedate'.$gid],9)) kc_tip('有效日期格式不正确!','form');\t}\tif($str->len($_POST['name'])>20) kc_tip('真实姓名过长!','form');\tif($str->len($_POST['tel'])>30) kc_tip('电话过长!','form');\tif($str->len($_POST['email'])>50) kc_tip('邮箱过长!','form');\tif(!empty($_POST['email']) && !kc_validate($_POST['email'],5)) kc_tip('邮箱地址格式','form');\tif($str->len($_POST['qq'])>12) kc_tip('QQ号码过长!','form');\tif($str->len($_POST['address'])>200) kc_tip('通信地址过长!','form');\tif($str->len($_POST['qianming'])>250) kc_tip('个性签名过长!','form');\t$array=array(\t\t'name'=>$_POST['name'],\t\t'tel'=>$_POST['tel'],\t\t'email'=>$_POST['email'],\t\t'qq'=>$_POST['qq'],\t\t'address'=>$_POST['address'],\t\t'qianming'=>$_POST['qianming'],\t\t\t);\t\tif(!empty($_POST['userpass'])) $array['userpass']=md5($_POST['userpass']);\tif(empty($userid)){\t\t$array['username']=$_POST['username'];\t\t$array['regdate']=TIME;\t\t$array['date']=TIME;\t\t$array['regip']=$str->ip();\t\t$array['ip']=$str->ip();\t\t$userid=$db->insert('%s_user',$array);\t\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_NEW','cid'=>$userid));\t}else{\t\t$db->update('%s_user',$array,'userid='.$userid);\t\t$db->delete('%s_user_group_bind','userid='.$userid);\t\t$db->delete('%s_user_role_bind','userid='.$userid);\t\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_EDIT','cid'=>$userid));\t}\t\t//更新role和user绑定表信息\t$array=array();\tforeach($rids as $rid){\t\t$removedate=empty($_POST['role_removedate'.$rid]) ? 0 :str_replace('-','',$_POST['role_removedate'.$rid]);\t\t$array[]=array(\t\t\t'userid'=>$userid,\t\t\t'rid'=>$rid,\t\t\t'removedate'=>$removedate,\t\t);\t}\t$db->insert('%s_user_role_bind',$array,1);\t\t//更新group和user绑定表信息\t$array=array();\tforeach($gids as $gid){\t\t$removedate=empty($_POST['group_removedate'.$gid]) ? 0 :str_replace('-','',$_POST['group_removedate'.$gid]);\t\t$array[]=array(\t\t\t'userid'=>$userid,\t\t\t'gid'=>$gid,\t\t\t'removedate'=>$removedate,\t\t);\t}\t$db->insert('%s_user_group_bind',$array,1);\t\t$s='<ul class=\"goto\">';\t$s.='<li><a href=\"/?_=user\">返回用户列表</a></li>';\t$s.='<li><a href=\"javascript:;\" onclick=\"$.kc_close();$(\\'.Submit\\').removeAttr(\\'disabled\\');\">继续编辑</a></li>';\t$s.='<li><a href=\"/?_=user_edit\">+ 添加新用户</a></li>';\t$s.='</ul>';\tkc_ajax(array(\t\t'TITLE'=>'继续您的操作',\t\t'MAIN'=>$s,\t\t'ID'=>'k_ajax',\t\t'WIDTH'=>370,\t\t'HEIGHT'=>120,\t));}\n过程见下图\n\n添加成功后，登录，具有所有的权限哟\n\n   漏洞证明：  见 详细说明   修复方案：  权限验证   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}