{"id": 65960, "wybug_id": "wooyun-2015-0126100", "wybug_title": "phpcmsv9 会员登录中心SQL注入漏洞", "wybug_corp": "phpcms", "wybug_author": "yinian", "wybug_date": "2015-07-13 10:15", "wybug_open_date": "2015-10-16 10:17", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-18：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-16：\t细节向公众公开  简要描述： phpcmsv9 SQL注入漏洞 详细说明：  实战测试http://www.anquan.com.cn/index.php?m=member登录抓包\n\npost过去的password替换掉构造好的注射语句\n\n\n\n再发出去\n\n成功入库。后来又到官方下载了最新版的V9进行FUZz\n\n\n\n\nif(isset($_GET['callback']) && trim($_GET['callback'])) {\t\t\t$o = new SaeTOAuthV2(WB_AKEY, WB_SKEY);\t\t\tif (isset($_REQUEST['code'])) {\t\t\t\t$keys = array();\t\t\t\t$keys['code'] = $_REQUEST['code'];\t\t\t\t$keys['redirect_uri'] = WEB_CALLBACK;\t\t\t\ttry {\t\t\t\t\t$token = $o->getAccessToken('code', $keys);\t\t\t\t} catch (OAuthException $e) {\t\t\t\t}\t\t\t}\t\t\tif ($token) {\t\t\t\t$_SESSION['token'] = $token;\t\t\t}\t\t\t$c = new SaeTClientV2(WB_AKEY, WB_SKEY, $_SESSION['token']['access_token'] );\t\t\t$ms  = $c->home_timeline(); // done\t\t\t$uid_get = $c->get_uid();\t\t\t$uid = $uid_get['uid'];\t\t\t$me = $c->show_user_by_id( $uid);//根据ID获取用户等基本信息\t\t\tif(CHARSET != 'utf-8') {\t\t\t\t$me['name'] = iconv('utf-8', CHARSET, $me['name']);\t\t\t\t$me['location'] = iconv('utf-8', CHARSET, $me['location']);\t\t\t\t$me['description'] = iconv('utf-8', CHARSET, $me['description']);\t\t\t\t$me['screen_name'] = iconv('utf-8', CHARSET, $me['screen_name']);\t\t\t}\t\t\tif(!empty($me['id'])) { \t\t\t\t//检查connect会员是否绑定，已绑定直接登录，未绑定提示注册/绑定页面\t\t\t\t$where = array('connectid'=>$me['id'], 'from'=>'sina');\t\t\t\t$r = $this->db->get_one($where);\t\t\t\t\t\t\t\t//connect用户已经绑定本站用户\t\t\t\tif(!empty($r)) {\t\t\t\t\t//读取本站用户信息，执行登录操作\t\t\t\t\t\t\t\t\t\t$password = $r['password'];\t\t\t\t\t$this->_init_phpsso();\t\t\t\t\t$synloginstr = $this->client->ps_member_synlogin($r['phpssouid']);\t\t\t\t\t$userid = $r['userid'];\t\t\t\t\t$groupid = $r['groupid'];\t\t\t\t\t$username = $r['username'];\t\t\t\t\t$nickname = empty($r['nickname']) ? $username : $r['nickname'];\t\t\t\t\t$this->db->update(array('lastip'=>ip(), 'lastdate'=>SYS_TIME, 'nickname'=>$me['name']), array('userid'=>$userid));\t\t\t\t\t\t\t\t\t\tif(!$cookietime) $get_cookietime = param::get_cookie('cookietime');\t\t\t\t\t$_cookietime = $cookietime ? intval($cookietime) : ($get_cookietime ? $get_cookietime : 0);\t\t\t\t\t$cookietime = $_cookietime ? TIME + $_cookietime : 0;\t\t\t\t\t\t\t\t\t\t$phpcms_auth = sys_auth($userid.\"\\t\".$password, 'ENCODE', get_auth_key('login'));\t\t\t\t\t\t\t\t\t\tparam::set_cookie('auth', $phpcms_auth, $cookietime);\t\t\t\t\tparam::set_cookie('_userid', $userid, $cookietime);\t\t\t\t\tparam::set_cookie('_username', $username, $cookietime);\t\t\t\t\tparam::set_cookie('_groupid', $groupid, $cookietime);\t\t\t\t\tparam::set_cookie('cookietime', $_cookietime, $cookietime);\t\t\t\t\tparam::set_cookie('_nickname', $nickname, $cookietime);\t\t\t\t\t$forward = isset($_GET['forward']) && !empty($_GET['forward']) ? $_GET['forward'] : 'index.php?m=member&c=index';\t\t\t\t\tshowmessage(L('login_success').$synloginstr, $forward);\t\t\t\t\t\t\t\t\t} else { \t\t\t\t\t//弹出绑定注册页面\t\t\t\t\t$_SESSION = array();\t\t\t\t\t$_SESSION['connectid'] = $me['id'];\t\t\t\t\t$_SESSION['from'] = 'sina';\t\t\t\t\t$connect_username = $me['name'];\t\t\t\t\t\t\t\t\t\t//加载用户模块配置\t\t\t\t\t$member_setting = getcache('member_setting');\t\t\t\t\tif(!$member_setting['allowregister']) {\t\t\t\t\t\tshowmessage(L('deny_register'), 'index.php?m=member&c=index&a=login');\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t//获取用户siteid\t\t\t\t\t$siteid = isset($_REQUEST['siteid']) && trim($_REQUEST['siteid']) ? intval($_REQUEST['siteid']) : 1;\t\t\t\t\t//过滤非当前站点会员模型\t\t\t\t\t$modellist = getcache('member_model', 'commons');\t\t\t\t\tforeach($modellist as $k=>$v) {\t\t\t\t\t\tif($v['siteid']!=$siteid || $v['disabled']) {\t\t\t\t\t\t\tunset($modellist[$k]);\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\tif(empty($modellist)) {\t\t\t\t\t\tshowmessage(L('site_have_no_model').L('deny_register'), HTTP_REFERER);\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t$modelid = 10; //设定默认值\t\t\t\t\tif(array_key_exists($modelid, $modellist)) {\t\t\t\t\t\t//获取会员模型表单\t\t\t\t\t\trequire CACHE_MODEL_PATH.'member_form.class.php';\t\t\t\t\t\t$member_form = new member_form($modelid);\t\t\t\t\t\t$this->db->set_model($modelid);\t\t\t\t\t\t$forminfos = $forminfos_arr = $member_form->get();\t\t\t\t\t\t//万能字段过滤\t\t\t\t\t\tforeach($forminfos as $field=>$info) {\t\t\t\t\t\t\tif($info['isomnipotent']) {\t\t\t\t\t\t\t\tunset($forminfos[$field]);\t\t\t\t\t\t\t} else {\t\t\t\t\t\t\t\tif($info['formtype']=='omnipotent') {\t\t\t\t\t\t\t\t\tforeach($forminfos_arr as $_fm=>$_fm_value) {\t\t\t\t\t\t\t\t\t\tif($_fm_value['isomnipotent']) {\t\t\t\t\t\t\t\t\t\t\t$info['form'] = str_replace('{'.$_fm.'}',$_fm_value['form'], $info['form']);\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t$forminfos[$field]['form'] = $info['form'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t$formValidator = $member_form->formValidator;\t\t\t\t\t}\t\t\t\t\tinclude template('member', 'connect');\t\t\t\t}\t\t\t} else {\t\t\t\tshowmessage(L('login_failure'), 'index.php?m=member&c=index&a=login');\t\t\t}\t\t} else {\t\t\t$o = new SaeTOAuthV2(WB_AKEY, WB_SKEY);\t\t\t$aurl = $o->getAuthorizeURL(WEB_CALLBACK);\t\t\tinclude template('member', 'connect_sina');\t\t}\t}\n   漏洞证明：  \n\n   修复方案：  只会拆不懂修   版权声明：转载请注明来源 yinian@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-10-16 10:17 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-27 17:51 |    \t\thuotoo \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:3        | 努力学习中)\t\t \n  屌........    \n     2015-07-30 03:11 |    \t\t张三 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | 张三)\t\t \n  @phpcmsphpcms:710de87fff574e2123ec793e333c1bad:z52Jxgzhangmingxue:0664400c18b3fe8a28336493dc291372:VBqZUEsso_adminwangdongwu:d62f502a7de53caf4df9b572d6b91ecb:530488phpip:911f2ee1bef0ce919f9e964aad0d1882:X2kf3kmayuhui:139f245da04fdc23a3d88dd2d3ae353c:515f0f    \n     2015-07-30 16:59 |    \t\t逝情 \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:12        | 自己选择的路，就算跪着也要走完~!)\t\t \n  @张三 有蛋？    \n     2015-08-17 14:00 |    \t\tlonely heart \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | I look at you)\t\t \n  密码不好破  有卵用？    \n     2015-09-06 10:21 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  这个不用等了。这个漏洞。只有在5.3的情况下是可以注射的。    \n     2015-09-21 20:06 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:70        | JDSec)\t\t \n  假洞一个    \n     2015-09-23 22:09 |    \t\t逝情 \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:12        | 自己选择的路，就算跪着也要走完~!)\t\t \n  @微尘 注射出来都破不出来，蛋碎    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}