{"id": 54767, "wybug_id": "wooyun-2014-063409", "wybug_title": "Cmseasy最新版存在存储型XSS及代码分析（2）", "wybug_corp": "cmseasy", "wybug_author": "zj1244", "wybug_date": "2014-06-04 21:21", "wybug_open_date": "2014-09-02 21:22", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向公众公开  简要描述： cmseasy某处存在存储型xss影响版本：CmsEasy_5.x（包括最新版CmsEasy_5.5_UTF-8_20140420） 详细说明：  影响版本：CmsEasy_5.x（包括最新版CmsEasy_5.5_UTF-8_20140420）存在漏洞的文件：bbs_public.php用户量级：250，000\n\nBBS下所有POST提交，都会经过bbs_public.php文件里的remove_xss函数过滤，此函数在bbs_public.php文件的35行，存在问题的代码如下：\nfunction remove_xss($val){\t$val = preg_replace('/([\\x00-\\x08,\\x0b-\\x0c,\\x0e-\\x19])/', '', $val);\t$search = 'abcdefghijklmnopqrstuvwxyz';\t$search .= 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\t$search .= '1234567890!@#$%^&*()';\t$search .= '~`\";:?+/={}[]-_|\\'\\\\';\tfor ($i = 0; $i < strlen($search); $i++) {\t\t$val = preg_replace('/(&#[xX]0{0,8}'.dechex(ord($search[$i])).';?)/i', $search[$i], $val);         //可以看到，这里对于html实体解码包含了;，可是浏览器对于没有;的html实体也可以解码\t\t$val = preg_replace('/(&#0{0,8}'.ord($search[$i]).';?)/', $search[$i], $val);\t}\t$val = html_entity_decode($val);\tif(preg_match('/&#(\\d+);/', $val)){\t\texit('error');          //这里的判断也包括了;，所以我们可以去掉;来绕过\t}\tif(preg_match('/&#[xX](\\d+);/', $val)){\t\texit('error');\t}\nPOC如下：在bbs的内容处填入：\n<a href=\"java&#11&#53cript:alert(document.cookie)\">点这里!!!</a>\n此POC可在CmsEasy_5.5_UTF-8_2014xxxx版本上利用，如下图：\n\n本来到此应该结束了，但是在网上找实例的时候，发现这个poc在2013之前的版本不行，所以如果是2013之前的版本，用如下POC：\n<a href=\"java&#115cript:alert(document.cookie)\">点这里!!!</a>\n第一个实例：5.5 2013版本的http://www.cosiqqi.com/bbs/archive-display.php?aid=3\n\n\n\n第二个实例：5.5 20121112版本的http://www.cdsyzn.com/bbs/archive-display.php?aid=4\n\n第三个实例：5.5 20130605版本的www.e-metersbonwe.com/bbs/archive-display.php?aid=1\n\n第四个实例：5.5 20140118版本http://www.lings24.com/bbs/archive-display.php?aid=1\n\n第五个实例：最新版5.5_UTF-8_20140420版本http://www.hocoson.cn/bbs/archive-display.php?aid=1\n\n   漏洞证明：  5.5_UTF-8_20140420版本http://www.hocoson.cn/bbs/archive-display.php?aid=1\n\n   修复方案：  ;的判断去掉   版权声明：转载请注明来源 zj1244@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-05 11:10 厂商回复： 感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}