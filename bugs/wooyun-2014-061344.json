{"id": 2060, "wybug_id": "wooyun-2014-061344", "wybug_title": "大汉版通系统再次getshell（需登陆）", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "路人甲", "wybug_date": "2014-05-18 22:01", "wybug_open_date": "2014-08-16 22:02", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传安全", "文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-16：\t细节向公众公开  简要描述： 大汉版通系统可以再次getshell，外加一处任意文件下载 详细说明：  注：该系统为信息公开系统(xxgk)另外这个漏洞同样比较有意思，不知道程序员的逻辑是什么..#1 任意文件下载\n/xxgk/m_5_7/replace/export.jsp\n代码为\n<%@page contentType=\"text/html;charset=iso8859-1\"%><%@page import=\"jcms.util.DownFile\"%><%@page import=\"com.hanweb.common.util.Convert\"%><%    //原文件名    String strFileName = Convert.getParameter(request, \"filename\");    strFileName = strFileName == null ? \"\" : strFileName;    //要保存的文件名    String downloadname = Convert.getParameter(request, \"savename\");    downloadname = new String(downloadname.getBytes(\"UTF-8\"), \"8859_1\");    if (!DownFile.getFile(strFileName, downloadname, response, \"UTF-8\")) {        out                .println(Convert                        .getAlterScript(\"alert('下载失败！');\"));    }%>\n可以看出filename和savename直接get提交，SO..#2 getshell\n/xxgk/m_5_7/replace/opr_importinfo.jsp\n产生漏洞的代码为\n<%    //...    // 表单变量初始化\t    String strTpl_i_ID = \"\";    String strTpl_fn_billstatus = \"S\";//初始化操作状态    // 基本变量初始化    String strFilePath = \"\";    String strFileName = \"\";    strFilePath = application.getRealPath(\"\") + \"/m_5_7/replace/temp/\";    Jcms_ReplaceBLF blf = new Jcms_ReplaceBLF(sys);    // 保存状态 -- 新增S或者更新B    if (strBillStatus.equals(\"S\")) {        //创建文件路径\t        Convert.createDirectory(strFilePath);        String strMsg = \"\";        String strIllMsg = \"\";        //上传图片        CommonUploadFile upload = new CommonUploadFile(strFilePath, \"\");        SysInit.init();        if (SysInit.m_strImportNoFileType == null) {            upload.setM_Notfiletype(\"exe,com,bat,php,asp,php3,phtml,jsp,aspx\");        } else {            upload.setM_Notfiletype(SysInit.m_strImportNoFileType);        }        boolean bResult = upload.uploadFile(request);\t\treturn;        String strUpFileName = \"\";        if (bResult) {            String[] strFiles = upload.getAllFileName();            jcms.filter.FilterWordParse parse = new jcms.filter.FilterWordParse();            File file;            Vector vReplace = new Vector();            Hashtable ht;            for (int i = 0; i < strFiles.length; i++) {                strUpFileName = strFilePath + strFiles[i];                file = new File(strUpFileName);                if (!file.exists()) {                    com.hanweb.common.log.LogWriter.debug(\"文件不存在!\");                    continue;                }}\n上述代码有以下几个关键点\n1.上传文件保存的路径strFilePath = application.getRealPath(\"\") + \"/m_5_7/replace/temp/\";2.限制上传文件类型(黑名单不靠谱)upload.setM_Notfiletype(\"exe,com,bat,php,asp,php3,phtml,jsp,aspx\");\n另外上传文件做了客户端验证(客户端同样不靠谱，直接bypass)对于关键点2，经过多次测试验证发现，这段代码并没有起到任何作用，直接无视即可..#3 漏洞验证由于网上有大量的实例，任意选取几个案例进行测试验证..First:首先将我们要上传的文件改名为shell.xml,之后抓包再改回来..在验证之前简单说下比较有意思的地方,当我们点击上传的时候，采用Burp suite抓包修改，提交即可，如图\n\n上图中有两处需要修改的地方：\nContent-Disposition: form-data; name=\"file1\"; filename=\"shell.xml\"修改为：Content-Disposition: form-data; name=\"file3\"; filename=\"shell.jsp\"注意：name必须修改为非file1，要不然无法成功上传（这里就是我觉得比较有意思的地方）\n提交后会就会在 /m_5_7/replace/temp/ 目录下生成shell.jsp案例一：\nhttp://xxgk.weifang.gov.cn/xxgk/m_5_7/replace/opr_importinfo.jsp?fn_billstatus=1\n\n\n案例二：\nhttp://xxgk.lyg.gov.cn//xxgk/m_5_7/replace/opr_importinfo.jsp?fn_billstatus=1\n\n\n   漏洞证明：  #证明案例一：\nhttp://xxgk.weifang.gov.cn/xxgk/m_5_7/replace/opr_importinfo.jsp?fn_billstatus=1\n\n\n案例二：\nhttp://xxgk.lyg.gov.cn//xxgk/m_5_7/replace/opr_importinfo.jsp?fn_billstatus=1\n\n\n   修复方案：  严格限制文件   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-05-19 10:01 厂商回复： 感谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-18 22:28 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  连发啊我擦。看来是各个系统都有的统一问题    \n     2014-06-11 14:48 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  @xsser 为什么已经对普通白帽子公开了我却看不到啊？    \n     2014-06-11 14:51 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @xiaoL 难道rank不够？    \n     2014-06-11 14:53 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xiaoL @xsser 就是rank不够，这个可以稍微优化下    \n     2014-06-11 14:55 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @felixk3y 故意这么做的 借鉴黄色网站    \n     2014-06-11 14:58 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xsser 哈哈 好吧    \n     2014-06-11 15:21 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  @felixk3y 哈哈！一看就知道你是作者吧！路人甲！    \n     2014-06-11 22:01 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @felixk3y 原来是你啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}