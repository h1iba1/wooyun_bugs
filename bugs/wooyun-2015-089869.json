{"id": 46698, "wybug_id": "wooyun-2015-089869", "wybug_title": "完美时空某站点任意上传殃及内网数十台主机", "wybug_corp": "完美时空", "wybug_author": "zhangfei", "wybug_date": "2015-01-04 09:44", "wybug_open_date": "2015-02-18 09:46", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-18：\t细节向公众公开  简要描述： 完美某游戏7年老玩家~~能用漏洞换几件神装不 详细说明：  一、首先：cafe.dota2.com.cn处任意上传\n\n用完美通行证登录后，点击申请特权\n\n然后随便找个地方就……把马上去了\n\n还直接给了位置，太贴心了~~~\n\n结果\n\n\n\n反弹shell，发现好多端口反弹不出去，最后试了试80端口，可以了\n\n内核版本\nuname -aLinux gw41 3.7.0lvs.20130608.R620 #3 SMP Mon Sep 16 19:13:02 CST 2013 x86_64 x86_64 x86_64 GNU/Linux\n提权：漏洞利用CVE-2013-2094\n\n\niduid=0(root) gid=0(root) groups=0(root),99(nobody)\n习惯性的翻了翻/root/.ssh里面的东西\nls -lah /root/.ssh\n\n\n好像连过好多机器的样子再翻翻hosts文件\ncat /etc/hosts\n\n\n好像IP和本机不在同一段里面啊是不是换过IP？试试连接172.21.57.254\nssh 172.21.57.254\n\n\n嗯？连上去了？这次再翻翻hosts文件\ncat /etc/hosts127.0.0.1               localhost172.21.57.254           manager172.21.57.253           manager_bak             bak172.21.57.4             gw4             web4            members         sys             test172.21.57.6             gw6             web6            jms172.21.57.9             gw9             web9            new             wangbaolong172.21.57.10            gw10            web10           WXmarket                xuzhongpeng172.21.57.11            gw11            web11           WXmarket                xuzhongpeng172.21.57.12            gw12            web12           WXmarket                xuzhongpeng172.21.57.14            gw14            web14           dota2           sms             chenhao172.21.57.15            gw15            web15           dota2           sms             chenhao172.21.57.18            gw18            web18           ngx1172.21.57.19            gw19            web19           wangbaolog              test            old             172.30.255.19172.21.57.21            gw21            web21           wx              hanyahui172.21.57.22            gw22            web22           wangpingtao             liujun          test            message         send172.21.57.23            gw23            web23           dota2bbs                discuz          x2.5            test            173bbs          nwxbox.wanmei.com172.21.57.24            gw24            web24           p2sp            fanzhenyu172.21.57.25            gw25            web25           www.173.com             liaomin         old172.21.57.26            gw26            web26           sanfangdenglu           weijianghu              daoke           shediao_appser172.21.57.27            gw27            web27           sanfangdenglu           interface.173.com               api.lianyun.173.com172.21.57.28            gw28            web28           sanfangdenglu           api.173.com172.21.57.29            gw29            web29           dota2&173DB172.21.57.30            gw30            web30           dota2&173DB172.21.57.31            gw31            web31           mail_service172.21.57.32            gw32            web32           173             test172.21.57.33            gw33            web33           sanfangdenglu           DBmaster172.21.57.34            gw34            web34           sanfangdenglu           DBslave172.21.57.35            gw35            web35           sanfangdenglu           haproxy172.21.57.36            gw36            web36           sanfangdenglu           haproxy172.21.57.37            gw37            web37           eventie         DBmaster172.21.57.38            gw38            web38           eventie         DBslave172.21.57.39            gw39            web39           api.dota2.com.cn172.21.57.41            gw41            web41           Dota2           CMS172.21.57.43            gw43            web43           www.173.com             bak172.21.57.46            gw46            web46           new172.21.57.47            gw47            web47           lvs             172.30.255.49172.21.57.48            gw48            web48           lvs_bak         172.30.255.50172.21.57.49            gw49            web49           api             172.30.255.51172.21.57.50            gw50            web50           api             172.30.255.52172.21.57.51            gw51            web51           api             172.30.255.53172.21.57.52            gw52            web52           api             172.30.255.54172.21.57.53            gw53            web53           members         172.30.255.55           173             pay.dota2.com.cn                school.dota2.com172.21.57.54            gw54            web54           members         172.30.255.56           173             pay.dota2.com.cn                school.dota2.com172.21.57.55            gw55            web55           members         172.30.255.57           173             pay.dota2.com.cn                school.dota2.com172.21.57.56            gw56            web56           new             no_ip58.215.52.140           members.dota2.com.cn*.*.*.95            *.*.*.wanmei.com                *.*.wanmei.com #我自己打码\nhosts文件写的很详细，导致的结果就是，这40多台主机我全部可以控制。其中包含无冬之夜主站，173.com主站，members.dota2.com.cn，完美精灵，微信客服平台等重要站点可以被完全操纵用几个webshell证明一下无冬之夜OL主站\n\n↑↑↑↑↑这货第二次上乌云了，哈哈members.dota2.com.cn的其中一个IP的shell\n\nrobot.cs.wanmei.com客服机器人站点的大马\n\n危害：1.如果被别有用心的人利用，尤其是像members.dota2.com.cn这样的站点进行挂马一天盗的号数量相当可观；2.被人修改了pay.dota2.com.cn的源码，导致直接的经济损失3.被挂黑链4.被人脱裤，造成大量运营方面的和用户的敏感信息泄露，被竞争对手拿去做大数据分析5.被扣奖金受到脑洞的限制，只想到了这么多~~~   漏洞证明：  172.21.57.10\t/web/webapps/csrobot/js/jspdama.jsp\t\t\t\t\thttp://robot.cs.wanmei.com/js/jspdama.jsp172.21.57.23\t/web/webapps/nwanmei/nwanmei.com/resources/js/jquery.jsp\t\t\t\t\thttp://www.neverwinterol.com.cn/resources/js/jquery.jsp172.21.57.26\t/web/webapps/shediaoApp-server/backoffice/wooyun.txt\t\t\t\t\t\thttp://ams.sd.wanmei.com/wooyun.txt172.21.57.41\t/export/webapps/dota2_bar/upload/uploadimg/jspdama-1418562689987.jsp\t\t\t\t\thttp://cafe.dota2.com.cn/upload/uploadimg/jspdama-1418562689987.jsp172.21.57.55\t/export/webapps/pwpk_dota2/common/wushaobintest.jsp\t\t\t\thttp://members.dota2.com.cn/common/wushaobintest.jsp\thost指向58.241.15.141搞清楚这40台主机跑了什么站真的很费时间……   修复方案：  1.备份并重启172.21.57.41，我也不知道提权是否对主机真的有影响，现在跑tomcat的这个用户都变得很奇怪2.打一顿写cafe.dota2.com.cn上传图片的人，让他记住，要对上传的文件类型进行过滤3.安全管理方面的问题：主机之间登录不要相互信任，单向信任管理机就行   版权声明：转载请注明来源 zhangfei@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-01-05 17:04 厂商回复： 感谢洞主能够提交漏洞，礼物作为管理员也在向上面申请，尽量帮你整个吧，最后还是谢谢你能够比较详细的描述能够帮助我们修改漏洞，谢谢！ 最新状态： 2015-01-05：请作者提供联系方式，方便我们发放礼物。 谢谢 2015-02-12：感谢洞主提交的漏洞，目前已经把礼物发放完毕，并且洞主已经确认收到，发放的礼物情况如下：樱桃（Cherry） MX-Board 3.0 G80-3850 黑色红轴 机械键盘,再次感谢洞主的辛苦付出！  ", "replys": "漏洞评价：\n评论\n     2015-01-04 09:48 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  红蓝药水已经打入你游戏帐户，请注意查收。    \n     2015-01-04 10:53 |    \t\tIvan \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:9        | 小菜逼一个)\t\t \n  给下点会员呗    \n     2015-01-04 14:28 |    \t\tcrackershi \t\t\t( 普通白帽子  |\t\t\t        Rank:122 漏洞数:18        | 云标准制定 CISP ISO审核员)\t\t \n  GM说乌云专属套装量身为你打造，有洞就是这么任性，你要火哥们。    \n     2015-01-05 17:20 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  好直接 。。。    \n     2015-01-05 18:30 |    \t\t小饼仔 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:48        | 不告诉你)\t\t \n  乌云专属神装 + 1000....    \n     2015-01-05 19:04 |    \t\tzhangfei \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:5        | (╯°Д°)╯︵ ┻━┻)\t\t \n  @小饼仔 哈哈，最高+20    \n     2015-01-05 20:08 |    \t\t盛大网络(乌云厂商)\t\t \n  @char 放学别走    \n     2015-01-05 22:48 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  @char 放学别走     \n     2015-01-06 09:15 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  @盛大网络 今晚7点，张江地铁站5号口，有本事你来。    \n     2015-02-12 11:41 |    \t\tzhangfei \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:5        | (╯°Д°)╯︵ ┻━┻)\t\t \n  @完美时空 礼物已收到！    \n     2015-02-28 11:38 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  不错哦，有通用的站吗，有源码吗    \n     2015-02-28 15:37 |    \t\tzhangfei \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:5        | (╯°Д°)╯︵ ┻━┻)\t\t \n  @wefgod 通用的就看见了discuz    \n     2015-03-01 15:37 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @zhangfei 这样，还以为他们应该会用到什么商业通用的系统呢    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}