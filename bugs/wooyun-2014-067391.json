{"id": 998, "wybug_id": "wooyun-2014-067391", "wybug_title": "万户OA任意文件上传导致代码执行（多处总结）", "wybug_corp": "cncert", "wybug_author": "瘦蛟舞", "wybug_date": "2014-07-04 15:44", "wybug_open_date": "2014-10-02 15:46", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-02：\t细节向公众公开  简要描述： 万户OA任意文件上传导致代码执行（多处总结） 详细说明：  \n/defaultroot/public/editor/tpsc.jsp/defaultroot/public/editor/1_tpsc.jsp/defaultroot/work_flow/formOptJSPUpload.jsp/defaultroot/work_flow/formStartJSPUpload.jsp/defaultroot/govezoffice/custom_documentmanager/smartUpload.jsp?path=innerMailbox&fileName=innerMailFileName&saveName=innerMailSaveName&tableName=innerMaildisplaytable&fileMaxSize=0&fileMaxNum=0&fileType=&fileMinHeight=0&fileMinWidth=0&fileMaxHeight=0&fileMaxWidth=0/defaultroot/custom_form/smartUpload.jsp?path=innerMailbox&fileName=innerMailFileName&saveName=innerMailSaveName&tableName=innerMaildisplaytable&fileMaxSize=0&fileMaxNum=0&fileType=&fileMinHeight=0&fileMinWidth=0&fileMaxHeight=0&fileMaxWidth=0/defaultroot/public/jsp/goodsphotoupload.jsp?path=goodspic&visualName=goodsPicName&hiddenName=goodsPicName&del=yes/defaultroot/public/jsp/livephotoupload.jsp?path=peopleinfo&visualName=empLivingPhotoTemp&hiddenName=empLivingPhoto&del=yes/defaultroot/public/jsp/livephotoupload2.jsp?path=peopleinfo&visualName=empLivingPhotoTemp&hiddenName=empLivingPhoto&del=yes/defaultroot/public/jsp/singleupload.jsp?path=desktop&visualName=unitImgName&hiddenName=unitImgSaveName&del=yes/defaultroot/public/jsp/smartUpload.jsp?path=innerMailbox&fileName=innerMailFileName&saveName=innerMailSaveName&tableName=innerMaildisplaytable&fileMaxSize=0&fileMaxNum=0&fileType=&fileMinHeight=0&fileMinWidth=0&fileMaxHeight=0&fileMaxWidth=0\n上面是面哥发的，自己看了下源码，发现有上传的地方基本都是调用smartUpload的javabean。于是顺手找了下剩下的上传点。特征代码\n<%@ page language=\"java\" import=\"com.jspsmart.upload.*\"%><jsp:useBean id=\"myUpload\" scope=\"page\" class=\"com.jspsmart.upload.SmartUpload\" />\n有部分使用apache fileupload组件的但是通用性不强就不说了。   漏洞证明：  \\defaultroot\\customize\\upload.jsp （需截断doc）\\defaultroot\\information_manager\\informationmanager_upload.jsp （无限制直接上传）\\defaultroot\\work_flow\\workflow_upload.jsp （无过滤，报错前已经执行成功，鸡肋未返回文件名可以根据时间暴力采集）\\defaultroot\\dragpage_department\\upload.jsp （需截断jpg）\\defaultroot\\skin\\5\\dragpage_department\\upload.jsp  （需截断jpg）\\defaultroot\\information_manager\\产品-信息管理UTF-8-2009--8.21.1\\defaultroot\\information_manager\\information_smartUpload.jsp(通用性不强，无过滤)\\defaultroot\\dossier\\dossier_import.jsp代码大致就分一种无过滤的，直接可以上传shell。\nmyUpload.initialize(pageContext);    myUpload.upload();    for(int j = 0; j < myUpload.getFiles().getCount(); j ++){        myRandom=new com.whir.common.util.Random().getRandom();        com.jspsmart.upload.File myFile = myUpload.getFiles().getFile(j);        if (!myFile.isMissing()) {            saveName=myRandom+\".\"+myFile.getFileExt();            fileName=myFile.getFileName();            myFile.saveAs(\"\\\\upload\\\\information\\\\\" + saveName);        }    }\n另一种就是有过滤的，但是可以用截断绕过\n// Initialization\tmySmartUpload.initialize(pageContext);\t//mySmartUpload.setTotalMaxFileSize(100000);\tmySmartUpload.setAllowedFilesList(\"jpg,gif,bmp,swf,avi\");\t// Upload\t\tmySmartUpload.upload();\n部分证明如下图。\n\n\n\n\n\n   修复方案：     版权声明：转载请注明来源 瘦蛟舞@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-07-09 13:36 厂商回复： CNVD确认所述情况（原理验证），由CNVD通过公开联系渠道向软件生产厂商（已经建立的万户网络公司渠道）通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-04 15:48 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  这一发出来又有好多oa要遭殃了，    \n     2014-07-04 16:29 |    \t\t卡卡更健康 \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:14        )\t\t \n   WooYun: 中望龙腾OA系统任意文件上传漏洞 ，楼主，是这个吗？    \n     2014-07-04 20:58 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @卡卡更健康 我不会告诉你，你说的这个中望的在对我公开的第一秒时间我就看了，然后花了一个晚上挖完了好几个文件上传。嘿嘿    \n     2014-07-28 00:35 |    \t\t不许联想 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:3        | 求收编，本人会注入，会上传，会Xss，会破...)\t\t \n  好期待啊！每天都来看看有没有公布！    \n     2014-07-30 10:55 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这OA被你们玩坏了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}