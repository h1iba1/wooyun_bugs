{"id": 52165, "wybug_id": "wooyun-2014-072109", "wybug_title": "ThinkSAAS 2.2 GET型CSRF到Getshell", "wybug_corp": "thinksaas.cn", "wybug_author": "phith0n", "wybug_date": "2014-08-12 20:21", "wybug_open_date": "2014-11-10 20:22", "wybug_type": "CSRF", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-10：\t细节向公众公开  简要描述： 后台Getshell本想在XSS漏洞里一起提交的。。。结果我给忘了。不过后来发现这个洞是Get型的CSRF，利用方便，老少咸宜，在社区CMS中可以说威力无限呀。 详细说明：  /app/system/action/plugin.php 83行：\ncase \"delete\":\t\t$apps = $_GET['apps'];\t\t$pname = $_GET['pname'];\t\t\t\tdelDir('plugins/'.$apps.'/'.$pname);\t\t\t\tqiMsg('删除成功！');\t\tbreak;\n获得了GET到的值以后拼接成路径以后传入delDir函数。delDir函数：\n/** * 删除文件夹和文件夹下所有的文件 * @param string $dir * @return boolean */function delDir($dir = '') {\tif (empty ( $dir )) {\t\t$dir = rtrim ( RUNTIME_PATH, '/' );\t}\tif (substr ( $dir, - 1 ) == '/') {\t\t$dir = rtrim ( $dir, '/' );\t}\tif (! file_exists ( $dir ))\t\treturn true;\tif (! is_dir ( $dir ) || is_link ( $dir ))\t\treturn @unlink ( $dir );\tforeach ( scandir ( $dir ) as $item ) {\t\tif ($item == '.' || $item == '..')\t\t\tcontinue;\t\tif (! delDir ( $dir . \"/\" . $item )) {\t\t\t@chmod ( $dir . \"/\" . $item, 0777 );\t\t\tif (! delDir ( $dir . \"/\" . $item ))\t\t\t\treturn false;\t\t}\t\t;\t}\treturn @rmdir ( $dir );}\n就是一个删除的函数。所以，这个CSRF可以直接通过GET方式删除任意文件。通过插入这个链接即可删除config.inc.php:\nhttp://localhost/think/index.php?app=system&ac=plugin&ts=delete&apps=1&pname=../../data/config.inc.php\n至于怎么getshell，比较简单。删除了config.inc.php以后就可以重装系统了。1.重装时候插配置文件可以getshell。2.提供一个新方式：/thinksaas/thinksaas.php中有这么一句：\n//安装专用变量$install = isset($_GET['install']) ? $_GET['install'] : 'index';//安装配置文件，数据库配置判断if(!is_file('data/config.inc.php')){\tinclude 'install/index.php';\texit;}\n如果配置文件不存在则包含install/index.php看看：\n<?phpdefined('IN_TS') or die('Access Denied.'); /* *ThinkSAAS 安装程序 * @copyright (c) 2010-3000 ThinkSAAS All Rights Reserved * @code by QiuJun * @Email:thinksaas@qq.com *///安装文件的IMG，CSS文件$skins\t= 'data/install/skins/';//进入正题$title = 'ThinkSAAS安装程序';require_once 'action/'.$install.'.php';\n$install是刚才$_GET到的变量(这个时候GET还没有经过addslashes过滤)，直接截断包含，也能够getshell。   漏洞证明：  登录后台后直接访问http://localhost/think/index.php?app=system&ac=plugin&ts=delete&apps=1&pname=../../data/config.inc.php即可删除重装。   修复方案：  后台也要过滤。而且似乎csrf token好像没起到作用呀？   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-08-12 23:03 厂商回复： 感谢反馈，官网社区已经修复，稍后会在版本发布中更新 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-12 20:53 |    \t\tCoffeeSafe \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:37        )\t\t \n      你关注的白帽子 phith0n 发表了漏洞 ThinkSAAS 2.2 GET型CSRF到Getshell    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}