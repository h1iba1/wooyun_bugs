{"id": 45095, "wybug_id": "wooyun-2014-088860", "wybug_title": "大汉jcms某处SQL注入漏洞一枚", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "sex is not show", "wybug_date": "2014-12-29 17:41", "wybug_open_date": "2015-04-02 10:23", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-03：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： RT 详细说明：  貌似通杀不少版本的~~ 直接分析了漏洞文件：/jcms/jcms_files/jcms1/web2/site/module/comment/opr_getcount.jsp漏洞参数：fn_Keywords漏洞类型：SQL注入（GET型）漏洞分析：先看opr_getcount.jsp文件：\n......//省掉前面无关代码<%\tresponse.setHeader(\"Pragma\",\"No-cache\");\tresponse.setHeader(\"Cache-Control\",\"no-cache\");    \tresponse.setDateHeader(\"Expires\", 0);\tint colId = Convert.getParameterInt(request, \"i_colid\", 0);\tint infoId = Convert.getParameterInt(request, \"i_infoid\", 0);\tString pltype = Convert.getParameter(request, \"pltype\", \"\",true,true);//这个类型很重要，决定带入那个方法体\t\tString strToPath = application.getRealPath(\"\") + \"/jcms_files/jcms\" + strAppID+\"/web\"+strWebID+\"/site/module/comment/\";\tString strIniPath = strToPath +\"config/init.xml\";\tString strIpStyle = xmlFile.getContent(\"ipstyle\", strIniPath);\t\tint start = Convert.getParameterInt(request,\"startrecord\",1);\tint iPerPage = Convert.getParameterInt(request,\"perpage\",10);\tint groupsize = Convert.getParameterInt(request,\"groupsize\",8);\tString c_uuid = Convert.getParameter(request,\"c_uuid\",\"\",true,true);\tint totalNum = 0;\tString strCommentStyle = \"\";\t\tString strKeywords = Convert.getParameter(request, \"fn_Keywords\", \"\");\tString strScope = Convert.getParameter(request, \"fn_Scope\");\tString strStartTime = Convert.getParameter(request, \"starttime\");\tString strEndTime = Convert.getParameter(request, \"endtime\");\tString strTpl_vc_Ip = Convert.getIp(request);\t\t//获取IPd地址\tJcms_Comment_InfoBLF commentBLF = new Jcms_Comment_InfoBLF(strAppID,strWebID);\tJcms_Comment_InfoBLF blf = new Jcms_Comment_InfoBLF(strAppID,strWebID);\tArrayList al = new ArrayList();\tif(\"Y\".equals(pltype)) {//当pltype为Y时，走这里\t\ttotalNum = blf.getTotalNum(strScope, strKeywords, colId, infoId, strStartTime, strEndTime);//这里进入getTotalNum(...)函数中\t\t\tstrCommentStyle = xmlFile.getContent(\"scriptcode\", strIniPath);\t\t // 原文\t\tal = blf.getEnt(strScope, strKeywords, colId, infoId, strStartTime, strEndTime, start, iPerPage+1);\t}......\n然后跟进getTotalNum(......)函数中：\npublic int getTotalNum(String strScope, String strKeywords, int colId, int infoId, String strStartTime, String strEndTime)  {    StringBuffer sbSql = new StringBuffer(128);    StringBuffer strConditionBuf = new StringBuffer(128);    try {      strScope = Convert.getValue(strScope);      strKeywords = Convert.getValue(strKeywords);      strStartTime = Convert.getValue(strStartTime);      strEndTime = Convert.getValue(strEndTime);      if (!strScope.equals(\"\")) { ////strScope随意为下面中的一个，都能拼接进SQL语句，导致注入产生        if (strScope.equalsIgnoreCase(\"vc_infoTitle\"))        {          strConditionBuf.append(\" AND vc_infotitle LIKE '%\" + strKeywords + \"%'\");        }        if (strScope.equalsIgnoreCase(\"vc_author\"))        {          strConditionBuf.append(\" AND vc_author LIKE '%\" + strKeywords + \"%'\");        }        if (strScope.equalsIgnoreCase(\"t_content\"))        {          strConditionBuf.append(\" AND t_content LIKE '%\" + strKeywords + \"%'\");        }      }      if ((strStartTime.length() > 0) && (strEndTime.length() > 0)) {        strConditionBuf.append(\" AND c_createtime >= '\" + strStartTime + \"'\")          .append(\" AND c_createtime <= '\" + strEndTime + \"'\");      }      else if ((strStartTime.length() > 0) && (strEndTime.length() == 0)) {        strConditionBuf.append(\" AND c_createtime >= '\" + strStartTime + \"'\");      }      else if ((strStartTime.length() == 0) && (strEndTime.length() > 0)) {        strConditionBuf.append(\" AND c_createtime <= '\" + strEndTime + \"'\");      }      sbSql.append(\"SELECT COUNT(i_id)\")        .append(\" FROM jcms_comment_info\")        .append(\" WHERE i_sid=0 AND b_ischeck=1\")        .append(\" AND b_iscallback=0\")        .append(\" AND i_columnid=\").append(colId)        .append(\" AND i_infoid=\").append(infoId)        .append(strConditionBuf.toString());      String[][] strData = Manager.doQuery(this.strAppID, sbSql.toString());      if ((strData == null) || (strData.length == 0))        return 0;      return Convert.getStringValueInt(strData[0][0]);    } catch (Exception e) {      LogWriter.error(\"getEnt Error:\" + e, Jcms_Comment_InfoBLF.class);      return 0;    } finally {      if ((sbSql != null) && (sbSql.length() > 0)) {        sbSql.delete(0, sbSql.length());      }      if ((strConditionBuf != null) && (strConditionBuf.length() > 0))        strConditionBuf.delete(0, strConditionBuf.length());    }  }\n实例演示：1.版本：VJCMS2.6.7[U9]http://www.sqsc.gov.cn/jcms/jcms_files/jcms1/web2/site/module/comment/opr_getcount.jsp?fn_Keywords=q&starttime=&endtime=&pltype=Y&fn_Scope=vc_infoTitle\n\n2.版本：VJCMS2.6.7[U9]-BJDEWGYXY[U3]http://www.bisu.edu.cn/jcms/jcms_files/jcms1/web2/site/module/comment/opr_getcount.jsp?fn_Keywords=q&starttime=&endtime=&pltype=Y&fn_Scope=vc_infoTitle\n\n3.版本：VJCMS2.6.3-ZZSZF[U11]http://xfxzz.zaozhuang.gov.cn/jcms/jcms_files/jcms1/web2/site/module/comment/opr_getcount.jsp?fn_Keywords=q&starttime=&endtime=&pltype=Y&fn_Scope=vc_infoTitle\n\n4.版本：VJCMS2.6.7[U6]http://sha.sinotrans.com/jcms/jcms_files/jcms1/web2/site/module/comment/opr_getcount.jsp?fn_Keywords=q&starttime=&endtime=&pltype=Y&fn_Scope=vc_infoTitle\n\n5.版本：VJCMS2.6.3-ZZSZF[U11]http://ipad.zaozhuang.gov.cn/jcms/jcms_files/jcms1/web2/site/module/comment/opr_getcount.jsp?fn_Keywords=q&starttime=&endtime=&pltype=Y&fn_Scope=vc_infoTitle\n\n   漏洞证明：  见详细把   修复方案：  参数过滤，参数化查询   版权声明：转载请注明来源 sex is not show@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 10:23 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-05 09:58 |    \t\t影刺 \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:25        | 关注web安全)\t\t \n  好隐蔽的地方    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}