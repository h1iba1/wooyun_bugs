{"id": 53512, "wybug_id": "wooyun-2014-067459", "wybug_title": "Hdwiki 二次注入第二弹", "wybug_corp": "互动在线（北京）科技有限公司", "wybug_author": "′雨。", "wybug_date": "2014-07-11 12:12", "wybug_open_date": "2014-10-06 12:14", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-16：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向公众公开  简要描述： 上Hdwiki官网 发现更新日期一直都没变。还以为一直都没更新了, 结果今天下载一个下来看看。发现之前发的洞竟然都补掉了。——————————————————————————————————ps. 更新程序了应该还是把日期更新了一下 要不别人会一直以为没更新的。 详细说明：  在control/doc.php中\nfunction doedit(){\t\t$this->_anti_copy();\t\tif(isset($this->post['predoctitle'])){\t\t\t$title = $this->post['predoctitle'];\t\t\t$content=string::stripscript($_ENV['doc']->replace_danger_word($this->post['content']));\t\t\t$this->view->assign(\"content\",stripslashes($content));\t\t\t$this->view->assign(\"title\",$title);\t\t\t//$this->view->display(\"previewdoc\");\t\t\t$_ENV['block']->view('previewdoc');\t\t\treturn;\t\t}\n省略一点.......\nif(!$_ENV['doc']->check_eng_pcnt($doc['content']) || !$_ENV['doc']->check_extlink_pcnt($doc['content'])) {\t\t\t\t\tif($this->setting['save_spam']) {\t\t\t\t\t\t$doc['visible'] = 0;\t\t\t\t\t} else {\t\t\t\t\t\t$this->message($this->view->lang['spam_msg'],\"BACK\",0);\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\tif( $this->setting['verify_doc'] == -1 && $this->user['newdocs'] != -1 && $increase_edition) { //如果开启首次编辑审核,且用户尚未通过审核,且编辑的是他从未编辑过的词条\t\t\t\t$_ENV['user']->update_newdocs($this->user['uid'], +1); //则newdocs +1\t\t\t}\t\t\t$_ENV['doc']->edit_doc($doc,\"1\", $increase_edition);\t\t\t$_ENV['doc']->unset_editlock($doc['did'],$this->user['uid']);\t\t\tif($doc['visible']==1 && $_ENV['doc']->is_addcredit($doc['did'],$this->user['uid'])){\t\t\t\t$_ENV['user']->add_credit($this->user['uid'],'doc-edit',$this->setting['credit_edit'],$this->setting['coin_edit']);\t\t\t}\t\t\t$_ENV['user']->update_field('edits',$this->user['edits']+1,$this->user['uid']);\t\t\t$_ENV['doc']->del_autosave('',$this->user['uid'],$doc['did']);\n$_ENV['doc']->edit_doc($doc,\"1\", $increase_edition)跟这函数 \nfunction edit_doc($doc,$edittype='1',$increase_edition=true) {\t\tif($this->base->setting['base_createdoc']==1){\t\t\t$edition = $doc;\t\t}else{\t\t\t$edition=$this->db->fetch_first(\"SELECT * FROM \".DB_TABLEPRE.\"doc WHERE did=\".$doc['did']);\t\t\t$edition=string::haddslashes($edition,1);\t\t}\t\t$edition_sql = $increase_edition ? 'edits=edits+1,editions=editions+1,' : '';\t\t$this->db->query(\"UPDATE \".DB_TABLEPRE.\"doc SET\t\ttag='\".$doc['tags'].\"' ,summary='\".$doc['summary'].\"' ,content='\".$doc['content'].\"',lastedit='\".$doc['time'].\"',\t\tlasteditor='\".$this->base->user['username'].\"',lasteditorid='\".$this->base->user['uid'].\"',{$edition_sql}visible='\".$doc['visible'].\"' WHERE did=\".$doc['did']);\t\t\t\t$words=string::hstrlen($edition['content']);\t\t$images=util::getimagesnum($edition['content']);\t\tif(!empty($this->base->setting['db_storage']) && $this->base->setting['db_storage']=='txt'){\t\t\t$content=stripslashes($edition['content']);\t\t\t$edition['content']='';\t\t}\t\t\tif($increase_edition == true) {\t\t\t$this->db->query(\"INSERT INTO \".DB_TABLEPRE.\"edition\t\t\t(did,author,authorid,time,ip,title,tag,summary,content,words,images,reason,`type`)\t\t\tVALUES ('\".$edition['did'].\"','\".$this->base->user['username'].\"','\".$this->base->user['uid'].\"','\".$edition['lastedit'].\"','\".$this->base->ip.\"','\".$edition['title'].\"','\".$edition['tags'].\"','\".$edition['summary'].\"','\".$edition['content'].\"','$words','$images','\".$doc['reason'].\"','$edittype')\");\t\t\t$eid = $this->db->insert_id();\n带入到了insert当中在control/edition.php\nfunction doremove(){\t\t$did=isset($this->post['did'])?$this->post['did']:$this->get[2];\t\t$eids=isset($this->post['eid'])?$this->post['eid']:array($this->get[3]);\t\tforeach($eids as $eid){\t\t\tif(!is_numeric($eid)&&!is_numeric($did)){\t\t\t\t$this->message($this->view->lang['parameterError'],'BACK',0);\t\t\t}\t\t}\t\t\t\t$result=$_ENV['doc']->remove_edition($eids, $did);\nremove_edition($eids, $did)跟一下这函数。  \nfunction remove_edition($eid, $did=0){\t\tif(is_array($eid)){\t\t\t$eid=implode(\",\",$eid);\t\t}\t\t\t\t$sql=\"INSERT INTO \".DB_TABLEPRE.\"recycle (type,keyword,content,file,adminid,admin,dateline) values \";\t\t$query=$this->db->query(\"SELECT * FROM \".DB_TABLEPRE.\"edition WHERE eid IN ($eid)\");\t\t$delete_count = array();\t\twhile($edition=$this->db->fetch_array($query)){\t\t\t$delete_count[$edition['did']]=0;\t\t\t$file=$this->get_edition_fileinfo($edition['eid'],'file');\t\t\t$file=($edition['content'])?\"N;\":serialize(array(\"$file\"));\t\t\t$sql.=\"('edition','\".$edition['title'].\"','\".addslashes(serialize($edition)).\"','$file','\".$this->base->user['uid'].\"','\".$this->base->user['username'].\"','\".$this->base->time.\"'),\";\n$query=$this->db->query(\"SELECT * FROM \".DB_TABLEPRE.\"edition WHERE eid IN ($eid)\");这里查询出来 出库。$sql.=\"('edition','\".$edition['title'].\"','\".addslashes(serialize($edition)).\"','$file','\".$this->base->user['uid'].\"','\".$this->base->user['username'].\"','\".$this->base->time.\"'),\"在这里addslashes(serialize($edition)像这些的addslashes都转义了 但是 $edition['title'] 这里出库的标题没过滤。然后带入到了insert当中， 造成了注入。   漏洞证明：  首先发布一个词条 ua',user(),user(),user(),user(),user())#\n\n然后编辑一下这个词条 就入库了。\n\n\n\n   修复方案：  addslashes($edition['title'])   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-10-06 12:14 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-11 12:57 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  刚说完。。。。    \n     2014-07-11 17:21 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  你好碉    \n     2015-01-22 13:37 |    \t\t小菜虫 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:5        )\t\t \n  雨牛，edition-remove一般账户不是不能访问的吗    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}