{"id": 39665, "wybug_id": "wooyun-2015-093537", "wybug_title": "UWA 2.X v2.1.5 多处sql注入。", "wybug_corp": "asthis.net", "wybug_author": "roker", "wybug_date": "2015-01-30 15:28", "wybug_open_date": "2015-05-01 00:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-01：\t细节向公众公开  简要描述： rt。2.1.5.2521 官网下的最新版 详细说明：  看看这个函数/core/lib/core/Db.class.php\nprotected function parse_value($value) {\t\tif(is_string($value)) {\t\t\t$value = '\\'' . $this->escape_string($value) . '\\'';\t\t}\t\telseif(isset($value[0]) && is_string($value[0]) && strtolower($value[0]) == 'exp') {\t\t\t$value = $this->escape_string($value[1]);\t\t}\t\telseif(is_array($value)) {\t\t\t$value = array_map(array($this, 'parse_value'), $value);\t\t}\t\telseif(is_null($value)) {\t\t\t$value = 'null';\t\t}\t\treturn $value;\t}\n这是一个数据库操作时 对字段进行处理的函数。 可以看到当字段 为数组 且 第一个值为exp时，没有了单引号的包裹。（咋和tp有点像。。）何处调用了呢？例如 \nprotected function parse_set($data) {\t\tforeach($data as $key => $val) {\t\t\t$value = $this->parse_value($val);\t\t\tif(is_scalar($value)) { // filter non-scalar\t\t\t\t$set[] = $this->parse_key($key) . '=' . $value;\t\t\t}\t\t}\t\treturn ' SET ' . implode(',', $set);\t}\n往上跟进，\npublic function update($data, $options) {\t\t$sql = 'UPDATE '\t\t.$this->parse_table($options['table'])\t\t.$this->parse_set($data)\t\t.$this->parse_where(isset($options['where']) ? $options['where'] : '')\t\t.$this->parse_order(isset($options['order']) ? $options['order'] : '')\t\t.$this->parse_limit(isset($options['limit']) ? $options['limit'] : '')\t\t.$this->parse_lock(isset($options['lock']) ? $options['lock'] : false);\t\treturn $this->execute($sql);\t}\n那么当我们 ->update($data);时 ，满足条件时，就能绕过单引号注入了。 调用这个函数的还有很多，insert之类的。不一一举例了。两个注入以证实其可注入.# 1/lib/ctrlr/Member/ArchiveCtrlr.class.phpadd_archive_do 函数。\npublic function add_archive_do() {\t\t.........\t\t$data = array();\t\t$data['archive_channel_id'] = intval(ARequest::get('archive_channel_id'));\t\t............\t\t$data['a_title'] = AFilter::text(AFilter::plain_text(ARequest::get('a_title'), 85));\t\t$data['a_keywords'] = AFilter::text(AFilter::plain_text(ARequest::get('a_keywords'), 85));\t\t$data['a_description'] = AFilter::text(ARequest::get('a_description'), 200);\t\t$data['a_cost_points'] = intval(ARequest::get('a_cost_points'));\t\t$data['member_id'] = ASession::get('member_id');\t\t$data['m_username'] = ASession::get('m_username');\t\t$data['a_add_time'] = time();\t\t$data['a_edit_time'] = $data['a_add_time'];\t\t$data['a_add_ip'] = AServer::get_ip();\t\t$data['a_edit_ip'] = $data['a_add_ip'];\t\t$data['a_rank'] = 50;\t\t$_o = M('Option')->get_option(array('core', 'interaction'));\t\t$_aci = M('ArchiveChannel')->where(array('archive_channel_id' => array('EQ', $data['archive_channel_id'])))->find();......\t\t/* insert to main table */\t\t$result = M('Archive')->add_archive($data);\t\tif(!empty($result['error'])) {\t\t\t$this->error(L('PUBLISH_FAILED'), Url::U('archive/list_archive?archive_model_id=' . $data['archive_model_id']));\t\t}\t\t/* insert to addon table */\t\t$data['archive_id'] = $result['data'];\t\t$data = array_merge(ARequest::get(), $data);\t\t/* delete external links */\t\tif(isset($data['delete_external_links']) and !empty($data['delete_external_links'])) {\t\t\tforeach($data['delete_external_links'] as $field) {\t\t\t\tif(MAGIC_QUOTES_GPC) {\t\t\t\t\t$data[$field] = stripslashes($data[$field]);\t\t\t\t}\t\t\t\t$data[$field] = str_replace(__HOST__, '#basehost#', $data[$field]);\t\t\t\t$data[$field] = preg_replace(\"/(<a[ \\t\\r\\n]{1,}href=[\\\"']{0,}http:\\/\\/[^\\/]([^>]*)>)|(<\\/a>)/isU\", '', $data[$field]);\t\t\t\t$data[$field] = str_replace('#basehost#', __HOST__, $data[$field]);\t\t\t\tif(MAGIC_QUOTES_GPC) {\t\t\t\t\t$data[$field] = addslashes($data[$field]);\t\t\t\t}\t\t\t}\t\t}\t\t$result = M('Archive')->add_archive_addon($data);\t\t...........\t}\n添加文章，抓包\n\n数据出来了\n\n#2 edit_archive_do函数。代码和add_archive_do的差不多抓包修改出数据。。\n\n   漏洞证明：  \n\n   修复方案：  修复   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-01-31 00:41 厂商回复： 多谢关注，已确认。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-31 13:02 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  膜拜爷爷    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}