{"id": 1340, "wybug_id": "wooyun-2014-065479", "wybug_title": "phpshe最新版无需登录前台getshell", "wybug_corp": "phpshe.com", "wybug_author": "xfkxfk", "wybug_date": "2014-06-19 15:56", "wybug_open_date": "2014-09-17 15:58", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "任意文件写入利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向公众公开  简要描述： PHPSHE最新版无需登录Getshell 详细说明：  此问题由于phpshe系统可以重装，加上install时存在任意代码写入导致代码执行。install/index.php\n<?php/** * @copyright     2008-2012 简好技术 <http://www.phpshe.com> * @creatdate     2012-1111 koyshe <koyshe@gmail.com> */error_reporting(E_ALL ^ E_NOTICE);date_default_timezone_set('PRC');header('Content-Type: text/html; charset=utf-8');//改写不安全的register_global和防sql注入处理if (@ini_get('register_globals')) {\tforeach($_REQUEST as $name => $value){unset($$name);}}$pe['host_root'] = 'http://'.str_ireplace(rtrim(str_replace('\\\\','/',$_SERVER['DOCUMENT_ROOT']), '/'), $_SERVER['HTTP_HOST'], str_replace('\\\\', '/', dirname(__FILE__))).'/../';$pe['path_root'] = str_replace('\\\\','/',dirname(__FILE__)).'/../';include(\"{$pe['path_root']}/include/class/cache.class.php\");include(\"{$pe['path_root']}/include/function/global.func.php\");if (get_magic_quotes_gpc()) {\t!empty($_GET) && extract(pe_trim(pe_stripslashes($_GET)), EXTR_PREFIX_ALL, '_g');\t!empty($_POST) && extract(pe_trim(pe_stripslashes($_POST)), EXTR_PREFIX_ALL, '_p');}else {\t!empty($_GET) && extract(pe_trim($_GET),EXTR_PREFIX_ALL,'_g');\t!empty($_POST) && extract(pe_trim($_POST),EXTR_PREFIX_ALL,'_p');}switch ($_g_step) {\t//#####################@ 配置信息 @#####################//\tcase 'setting':\t\tif (isset($_p_pesubmit)) {\t\t\t$dbconn = mysql_connect(\"{$_p_db_host}:{$_p_db_port}\", $_p_db_user, $_p_db_pw);\t\t\tif (!$dbconn) pe_error('数据库连接失败...数据库ip，用户名，密码对吗？');\t\t\tif (!mysql_select_db($_p_db_name, $dbconn)) {\t\t\t\tmysql_query(\"CREATE DATABASE `{$_p_db_name}` DEFAULT CHARACTER SET utf8\", $dbconn);\t\t\t\t!mysql_select_db($_p_db_name, $dbconn) && pe_error('数据库选择失败...数据库名对吗？');\t\t\t}\t\t\tmysql_query(\"SET NAMES utf8\", $dbconn);\t\t\tmysql_query(\"SET sql_mode = ''\", $dbconn);\t\t\t$sql_arr = explode('/*#####################@ pe_cutsql @#####################*/', file_get_contents(\"{$pe['path_root']}install/phpshe.sql\"));\t\t\tforeach ($sql_arr as $v) {\t\t\t\t$result = mysql_query(trim(str_ireplace('{dbpre}', $_p_dbpre, $v)));\t\t\t}\t\t\tif ($result) {\t\t\t\tmysql_query(\"update `{$_p_dbpre}admin` set `admin_name` = '{$_p_admin_name}', `admin_pw` = '\".md5($_p_admin_pw).\"' where `admin_id`=1\", $dbconn);\t\t\t\t$config = \"<?php\\n\\$pe['db_host'] = '{$_p_db_host}'; //数据库主机地址\\n\\$pe['db_name'] = '{$_p_db_name}'; //数据库名称\\n\\$pe['db_user'] = '{$_p_db_user}'; //数据库用户名\\n\\$pe['db_pw'] = '{$_p_db_pw}'; //数据库密码\\n\\$pe['db_coding'] = 'utf8';\\n\\$pe['url_model'] = 'pathinfo'; //url模式,可选项(pathinfo/pathinfo_safe/php)\\ndefine('dbpre','{$_p_dbpre}'); //数据库表前缀\\n?>\";\t\t\t\tfile_put_contents(\"{$pe['path_root']}config.php\", $config);\t\t\t\tpe_goto(\"{$pe['host_root']}install/index.php?step=success\");\t\t\t}\t\t\telse {\t\t\t\tpe_error('数据库安装失败！');\t\t\t}\t\t}\t\tif (is_writeable(\"{$pe['path_root']}data/\")) {\t\t\t$mod_data = '<strong class=\"cgreen num\">Yes</strong>';\t\t\t$mod_data_result = true;\t\t\t\t\t\t}\t\telse {\t\t\t$mod_data = '<strong class=\"cred num\">No</strong>';\t\t\t$mod_data_result = false;\t\t}\t\tif (is_writeable(\"{$pe['path_root']}config.php\")) {\t\t\t$mod_config = '<strong class=\"cgreen num\">Yes</strong>';\t\t\t$mod_config_result = true;\t\t\t\t\t\t}\t\telse {\t\t\t$mod_config = '<strong class=\"cred num\">No</strong>';\t\t\t$mod_config_result = false;\t\t}\t\t$menucss_2 = \"sel\";\t\t$seo = pe_seo($menutitle='配置信息 -> PHPSHE商城系统安装向导', '', '', 'admin');\tbreak;\t//#####################@ 安装成功 @#####################//\tcase 'success':\t\t$menucss_3 = \"sel\";\t\t$seo = pe_seo($menutitle='安装成功 -> PHPSHE商城系统安装向导');\tbreak;\t//#####################@ 安装协议 @#####################//\tdefault :\t\t$menucss_1 = \"sel\";\t\t$seo = pe_seo($menutitle='安装协议 -> PHPSHE商城系统安装向导');\tbreak;}include('install.html');pe_result();?>\n整个过程都没有判断安装后的install.lock文件，导致可以任意重装漏洞！再来看，安装时，传输数据时没有过滤，导致任意文件内容写入：\nif ($result) {\t\t\t\tmysql_query(\"update `{$_p_dbpre}admin` set `admin_name` = '{$_p_admin_name}', `admin_pw` = '\".md5($_p_admin_pw).\"' where `admin_id`=1\", $dbconn);\t\t\t\t$config = \"<?php\\n\\$pe['db_host'] = '{$_p_db_host}'; //数据库主机地址\\n\\$pe['db_name'] = '{$_p_db_name}'; //数据库名称\\n\\$pe['db_user'] = '{$_p_db_user}'; //数据库用户名\\n\\$pe['db_pw'] = '{$_p_db_pw}'; //数据库密码\\n\\$pe['db_coding'] = 'utf8';\\n\\$pe['url_model'] = 'pathinfo'; //url模式,可选项(pathinfo/pathinfo_safe/php)\\ndefine('dbpre','{$_p_dbpre}'); //数据库表前缀\\n?>\";\t\t\t\tfile_put_contents(\"{$pe['path_root']}config.php\", $config);\t\t\t\tpe_goto(\"{$pe['host_root']}install/index.php?step=success\");\t\t\t}\t\t\telse {\t\t\t\tpe_error('数据库安装失败！');\t\t\t}\n这里的配置信息没有任何处理，进入了config文件，导致代码执行。   漏洞证明：  首先完整安装一次然后再次安装，完全无限制。在安装时，我们在数据表前缀写入：');phpinfo();//\n\n安装后我们来看config.php文件：\n\n我们的代码成功写入文件最后访问首页就可证明：\n\n   修复方案：  强制安装后，删除install内容。过滤输入内容。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-06-20 13:47 厂商回复： 感谢@xfkxfk。 提供代码审计，安装文档及安装完成有提示删除install目录，新版会再强制lock下安装文件,加强过滤！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-19 18:20 |    \t\tquanxian \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:2        | This is QuanXian.)\t\t \n  这。。。。。吊    \n     2014-06-19 18:24 |    \t\t发条橙子 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:6        | ∑(っ °Д °;)っ)\t\t \n  已经被黑产    \n     2014-09-17 19:58 |    \t\tjgjsfgv \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:10        | www.baidu.com)\t\t \n  这。没有数据库密码怎么破？    \n     2014-09-17 20:05 |    \t\tjgjsfgv \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:10        | www.baidu.com)\t\t \n  好像get不了啊？ 求解最后访问首页？访问首页之前有何要求？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}