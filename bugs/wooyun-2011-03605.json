{"id": 21527, "wybug_id": "wooyun-2011-03605", "wybug_title": "QQDLL加载漏洞可能导致用户密码被窃取", "wybug_corp": "腾讯", "wybug_author": "liyang", "wybug_date": "2011-12-11 13:07", "wybug_open_date": "2012-01-25 13:07", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["劫持", "客户端密码窃取", "劫持利用", "劫持分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-12-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2011-12-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2011-12-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2012-02-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-02-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-02-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-01-25：\t细节向公众公开  简要描述： QQDLL加载漏洞可能导致用户密码被窃取 详细说明：  \n\n\t利用了Windows加载DLL的一个特点。由于输入表中只包含DLL名而没有它的路径名，因此加载程序必须在磁盘上搜索DLL文件，而不是按照指定路径加载。\t在Windows XP sp2以上的系统会默认开启Safe Dll Search Mode，启用了这个模式后，DLL文件的搜索顺序是：\t可执行程序的加载目录\t系统目录（即system32文件夹）\t16位系统目录\tWindows目录\t当前目录\tPath环境变量中列出的目录\t伪造的DLL制作好后，放到程序目录下，这样当原程序调用原函数时就会优先调用了伪造的DLL文件，进入劫持DLL的代码。该文件也提供了和系统文件一样的输出表，并最终转向真正的系统文件。\tLpk.dll是系统关键文件之一，QQ启动时也要加载这个文件。在平时我们使用普通的键盘记录器记录的QQ密码是错误的，因为QQ的密码框使用了特殊的设计，保护密码安全。但是我制作了一个假冒的lpk.dll，这个文件能够通过Hook部分API函数解除对QQ密码框的保护。\t先到http://www.kuaipan.cn/file/id_774356833665645.html下载键盘记录器及lpk.dll文件（只支持Windows XP系统）。然后将lpk.dll文件复制到QQ目录下（一般是C:\\Program Files\\Tencent\\QQ\\Bin文件夹。启动QQ，查看lpk.dll文件的调用情况。\n\n\t这里显示QQ的两个进程加载了两个lpk.dll文件。别忘了，真正的lpk.dll文件最后也是要加载的。我们再看一下这两个文件的路径，一个是system32文件夹，一个是QQ目录。说明DLL劫持试验成功。\tQQ加载的这个文件破坏了密码框的保护，在输入密码的时候，我们记录下了正确的密码。\n\n所以为了断绝木马窃取密码的另一种方式，请修复该漏洞。   漏洞证明：  \n\n   修复方案：  微软的解释请访问http://msdn.microsoft.com/en-us/library/ff919712(VS.85).aspx　　(1）调用LoadLibrary，LoadLibraryEx，CreateProcess的，或者的ShellExecute等涉及到模块加载的函数的时候，指定DLL加载的完整路径，貌似应该有API可以获取当前程序运行的目录的　　（2）考虑使用的DLL重定向或Manifests文件，以确保程序使用正确的DLL。　　HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlSessionManagerKnownDLLs　　（3）确保DLL安全搜索模式被激活。未使用安全搜索设置的话，第二加载项就是当前目录。　　HKLMSystemCurrentControlSetControlSessionManagerSafeDllSearchMode　　（4）从搜索列表中取消当前目录，可以通过调用SetDllDirectory参数设置为一个空字符串   版权声明：转载请注明来源 liyang@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2011-12-12 09:59 厂商回复： thanks 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2011-12-11 13:36 |    \t\tPnig0s \t\t\t( 实习白帽子  |\t\t\t        Rank:46 漏洞数:2        | The quiter you are,the more you're able ...)\t\t \n  坐等详情是Hook上了么亲~    \n     2011-12-11 13:45 |    \t\t Jesus \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 天地不仁,以万物为刍狗！)\t\t \n  Pnig0s，亲，好久不见    \n     2011-12-11 16:02 |    \t\tPnig0s \t\t\t( 实习白帽子  |\t\t\t        Rank:46 漏洞数:2        | The quiter you are,the more you're able ...)\t\t \n  原来是耶稣哥哥昂~~不好好赚奶粉钱跑这嘛来了亲~~~~    \n     2012-06-03 09:06 |    \t\ts1Ng4r \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:2        | runningm4n)\t\t \n  LPK提权一个原理么。    \n     2012-07-05 17:51 |    \t\txsjswt \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:49        | 我思故我猥琐，我猥琐故我强大)\t\t \n  这。。。。。qq的mainifest不是早就上了么，这用的啥版本的qq    \n     2012-11-18 17:03 |    \t\tzhq445078388 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:19        | 请牢记\"杀进程点康姆\")\t\t \n  QQ版本比较老吧..    \n     2013-04-30 07:52 |    \t\t小震 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | ~)\t\t \n  还有利用msimg32.dll  做显IP插件的= = 。。。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}