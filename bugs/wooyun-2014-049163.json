{"id": 4702, "wybug_id": "wooyun-2014-049163", "wybug_title": "ThinkSNS某功能平行权限2", "wybug_corp": "ThinkSNS", "wybug_author": "齐迹", "wybug_date": "2014-01-20 14:27", "wybug_open_date": "2014-04-20 14:28", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "6", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-20：\t细节向公众公开  简要描述： ThinkSNS某功能多处平行权限 详细说明：  继续平行权限还是刚才的文件本打算补充一下的 结果已经过了审核了！所以就在提交一个！问题发生在微吧模块代码apps\\weiba\\index.action.php行652\n/**\t * 删除帖子\t * @return void\t */\tpublic function postDel(){\t\t$weibaid = D('weiba_post')->where('post_id='.intval($_POST['post_id']))->getField('weiba_id');\t\tif ( !CheckWeibaPermission( '' , $weibaid , 'weiba_del') ){\t\t\tif ( !CheckPermission('weiba_normal','weiba_del') ){\t\t\t\techo 0;return;\t\t\t}\t\t}\t\t$post_id = $_POST['post_id'];\t\tif(D('weiba_post')->where('post_id='.$post_id)->setField('is_del',1)){\t\t\t$post_detail = D('weiba_post')->where('post_id='.$post_id)->find();\t\t\tif(intval($_POST['log'])==1){\t\t\t\tD('log')->writeLog($post_detail['weiba_id'],$this->mid,'删除了帖子“'.$post_detail['title'].'”','posts');\t\t\t}\t\t\tD('weiba')->where('weiba_id='.intval($_POST['weiba_id']))->setDec('thread_count');\t\t\t//添加积分\t\t\tmodel('Credit')->setUserCredit($this->mid,'delete_topic');\t\t\t// 删除相应的微博信息\t\t\tmodel('Feed')->doEditFeed($post_detail['feed_id'], 'delFeed', '', $this->mid);\t\t\t\t\t\techo 1;\t\t}\t}\nPOST参数直接进入了SQL而且不是数组！第一反应 注入把！可惜 底层有防注入 目前尚未找到绕过方式！不过我相信大牛们一定可以的！我这里就 or 1=1就只有全部删除了！！这个文件所有使用if ( !CheckWeibaPermission( '' , $weiba['weiba_id'] ,'weiba_edit') )进行权限检查的都存在绕过\nfunction CheckWeibaPermission( $weiba_admin , $id , $action , $uid){\t!$uid && $uid = $GLOBALS['ts']['mid'];\t//超级管理员判断\tif ( CheckPermission('core_admin','admin_login') ){\t\treturn true;\t}\tif ( $action ){\t\t//用户组权限判断\t\tif ( CheckPermission( 'weiba_admin' , $action ) ){\t\t\treturn true;\t\t}\t}\t//吧主判断\tif ( !$weiba_admin && $id ){\t\t$map['weiba_id'] = $id;\t\t$map['level'] = array('in','2,3');\t\t$weiba_admin = D('weiba_follow')->where($map)->order('level desc')->field('follower_uid,level')->findAll();\t\t$weiba_admin = getSubByKey( $weiba_admin , 'follower_uid' );\t}\treturn in_array( $uid , $weiba_admin);}\n第一个参数为空的时候 就直接是管理员权限了！   漏洞证明：  \n\n   修复方案：  1  intval一下把2 CheckWeibaPermission方法应该完善一下了！   版权声明：转载请注明来源 齐迹@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-01-21 14:34 厂商回复： 非常感谢这位认真的白帽，临近假期响应慢了！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}