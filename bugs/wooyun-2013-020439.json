{"id": 13017, "wybug_id": "wooyun-2013-020439", "wybug_title": "PHPCMS 2008 最新漏洞（第一季）", "wybug_corp": "phpcms", "wybug_author": "西毒", "wybug_date": "2013-03-21 22:47", "wybug_open_date": "2013-05-05 22:47", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "字符类型注射", "参数未过滤", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-04-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-04-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-04-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-05-05：\t细节向公众公开  简要描述： 先放第一季吧 详细说明：  在include/common.inc.php中 ，这是phpcms的全局要加载的配置文件\n$dbclass = 'db_'.DB_DATABASE;require $dbclass.'.class.php';          $db = new $dbclass;$db->connect(DB_HOST, DB_USER, DB_PW, DB_NAME, DB_PCONNECT, DB_CHARSET);          require 'session_'.SESSION_STORAGE.'.class.php';$session = new session();session_set_cookie_params(0, COOKIE_PATH, COOKIE_DOMAIN);          if($_REQUEST){    if(MAGIC_QUOTES_GPC)    {        $_REQUEST = new_stripslashes($_REQUEST);        if($_COOKIE) $_COOKIE = new_stripslashes($_COOKIE);        extract($db->escape($_REQUEST), EXTR_SKIP);    }    else    {        $_POST = $db->escape($_POST);        $_GET = $db->escape($_GET);        $_COOKIE = $db->escape($_COOKIE);        @extract($_POST,EXTR_SKIP);        @extract($_GET,EXTR_SKIP);        @extract($_COOKIE,EXTR_SKIP);    }    if(!defined('IN_ADMIN')) $_REQUEST = filter_xss($_REQUEST, ALLOWED_HTMLTAGS);    if($_COOKIE) $db->escape($_COOKIE);}//echo QUERY_STRING;if(QUERY_STRING && strpos(QUERY_STRING, '=') === false && preg_match(\"/^(.*)\\.(htm|html|shtm|shtml)$/\", QUERY_STRING, $urlvar)){    //var_dump($urlvar[1]);    //echo 'test';    parse_str(str_replace(array('/', '-', ' '), array('&', '=', ''), $urlvar[1]));              }\n这里的话首先实例化了这个数据库，产生了一个$db资源句柄，他是用来操作数据库的然后就是将我们传进来的参数进行变量化这里有一些小过滤，自己可以看，所以这里传进来的参数就作为了变量但是接下来这行呢？\nif(QUERY_STRING && strpos(QUERY_STRING, '=') === false && preg_match(\"/^(.*)\\.(htm|html|shtm|shtml)$/\", QUERY_STRING, $urlvar)){    //var_dump($urlvar[1]);    //echo 'test';    parse_str(str_replace(array('/', '-', ' '), array('&', '=', ''), $urlvar[1]));                }\n看看这里？这里的QUERY_STRING来自前面这里有个过滤，但是不影响如果我们在这里进行覆盖这个db变量呢因为这里 parse_str(str_replace(array('/', '-', ' '), array('&', '=', ''), $urlvar[1]));可以将我们传进去的/ - 进行替换所以我们如果提交如下字符http://localhost/phpcms/index.php?db-5/gid-xd.html他由于这个db被覆盖就会出错，所以物理路径就爆出来了\n\n在c.php中\n$db->query(\"UPDATE \".DB_PRE.\"ads SET `clicks`=clicks+1 WHERE adsid=\".$ads['adsid']);$info['username'] = $_username;$info['clicktime'] = time();$info['ip'] = IP;$info['adsid'] = $id;$info['referer'] = HTTP_REFERER;$year = date('ym',TIME);$table = DB_PRE.'ads_'.$year;$table_status = $db->table_status($table);//echo 'test';if(!$table_status) {    include MOD_ROOT.'include/create.table.php';}$db->insert($table, $info);\n注意这里的HTTP_REFERER这个常量这里的常量是通过前面的common.inc.php定义好的define('HTTP_REFERER', isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : '');没有经过任何过滤操作，所以你懂的，我估计很多同学已经发现了，只是没去公布了，所以俺就替你们xxoo了，哈哈...别骂我然后$db->insert($table, $info);我们来看一下它这里的操作所以你懂的\n\n所以就可以xxoo了，很简单，exp已经写好了暂时还只看一部分，可能一季一季的放吧exp 我就放到https://forum.90sec.org 以及www.linux520.com里面去大家去里面找   漏洞证明：  \n\n   修复方案：  这个自己过滤吧！   版权声明：转载请注明来源 西毒@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2013-03-24 15:57 厂商回复： 希望还在使用08的朋友们尽快升级到v9。感谢提交问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-03-21 22:50 |    \t\t3King \t\t\t( 普通白帽子  |\t\t\t        Rank:1129 漏洞数:81        | 【study at HNUST】非常感谢大家的关注~ 大...)\t\t \n  目测连载······    \n     2013-03-21 22:57 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:170        | 力不从心)\t\t \n  明显会连载的。    \n     2013-03-21 23:08 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  明显会连载的。    \n     2013-03-22 08:11 |    \t\t牛￡金钢 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:4        | 我是新手，还需要学习，大神们要指点下了.....)\t\t \n  明显会连载的。    \n     2013-03-22 09:03 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:64        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  明显会连载的。    \n     2013-03-22 09:09 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:41        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  明显会连载的。    \n     2013-03-22 10:22 |    \t\t猥琐 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 学习什么的最重要！)\t\t \n  明显会连载的。    \n     2013-03-22 10:50 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  明显会连载的。    \n     2013-03-22 11:01 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:64        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  http://www.2cto.com/Article/201211/170127.html  我发现这个洞在去年11月份我们网站就发布了 - -    \n     2013-03-22 11:17 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:32        | 心存谦卑才能不断超越自我)\t\t \n  @孤独雪狼  那重复了....悲剧.....我陆续再放其他洞吧，哈哈    \n     2013-03-22 11:18 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:32        | 心存谦卑才能不断超越自我)\t\t \n  @孤独雪狼  由于官方没有升级，所以就发现了此洞，反正不急，我慢慢放吧，我这里还有其他的，XSS SQL GETSHELL。。    \n     2013-03-22 11:44 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @西毒 那咱可就说好了，坐等看连载    \n     2013-03-22 14:01 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @西毒 PHPCMS 2008已经是个不维护的老版本了，官方目前的维护版本是PHPCMS V9。    \n     2013-03-23 01:57 |    \t\t猴子 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:5        | 我是一只骚猴子)\t\t \n  跪求phpcms2008 sql inject    \n     2013-03-23 11:06 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:170        | 力不从心)\t\t \n  @猴子 上面好像有？    \n     2013-03-25 12:18 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  不是连载吗？肿么没了呢？    \n     2013-03-25 12:44 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  说好的连载呢。    \n     2013-04-12 21:43 |    \t\t小鸡鸡 \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:4        )\t\t \n  @西毒 大哥来分exp 1321212165@qq.com    \n     2013-09-12 13:46 |    \t\thack2012 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:3        | 关注信息安全 http://www.waitalone.cn/)\t\t \n  @小鸡鸡 http://www.waitalone.cn/phpcms2008-sql-injection-exp.html 我博客有的，你不去找。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}