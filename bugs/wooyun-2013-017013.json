{"id": 14498, "wybug_id": "wooyun-2013-017013", "wybug_title": "Flash应用安全系列[1]--360反射型跨站", "wybug_corp": "奇虎360", "wybug_author": "p.z", "wybug_date": "2013-01-06 22:33", "wybug_open_date": "2013-02-20 22:34", "wybug_type": "xss跨站脚本攻击", "wybug_level": "低", "wybug_rank_0": "3", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型", "应用安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-01-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-01-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-01-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-01-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-02-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-02-20：\t细节向公众公开  简要描述： 360某处Flash应用存在漏洞，可能导致跨站脚本攻击。 详细说明：  在一切开始之前，我们先来说明几个基本的问题。1.SWF如何被嵌入HTML页面的\t此处所说的嵌入，就是指当你打开一个网页，这个网页中包含着SWF媒体文件，通常是embed或者object标签的形式。SWF嵌入HTML时，embed或者object标签通常还含有几个特定的属性，关键的有allowScriptAccess以及allowNetworking。\tallowScriptAccess控制着SWF文件与HTML页面通信的级别，这里所说的通信，包括但不仅限于让SWF执行JS，还囊括了从JS调用SWF里预留出的api接口。\tallowScriptAccess有以下三个值：\nalways \t\t允许任意SWF文件与HTML页面通信。never \t\t禁止任意SWF文件与HTML页面通信。samedomain \t只有在SWF文件来自与HTML页相同的域时才允许通信。当未指定allowScriptAccess时，samedomain为默认值。\n\tallowNetworking控制着SWF文件与WEB通信的级别，这里所说的通信，基本上就是发送、读取网络上的资源文件，以及控制浏览器的页面导航。\tallowNetworking有以下三个值：\nall \t\t无任何限制。internal \t禁止控制浏览器页面导航的函数。none \t\t禁止任何网络通信。当未指定allowNetworking时，all为默认值。\n2.我直接打开SWF文件时发生了什么\t如果你在直接打开SWF文件时，使用IE开发者工具或者Firebug查看DOM源码就会发现，其实你打开的还是一个HTML页面，页面的内容只有一行代码：\n<embed type=\"application/x-shockwave-flash\" src=\"[SWF URL]\" name=\"plugin\" height=\"100%\" width=\"100%\">\n\t前面我们已经讲了两个基本的属性，这里都没有指定，那么Flash Player自动取其默认值：allowScriptAccess=samedomain & allowNetworking=all. 在明白了上面两点之后，我们就能下面几个容易让人混淆的问题作出解答：\n- a.com 的html页面 embed 了一个 b.com 的xss.swf，脚本执行域是哪个域？- a.com 因为swf并不能执行JS，我们见到的他所执行的JS，其实是flash player通过调用承载他的html页面的js来实现的，所以是a.com。\n\n- a.com 的html页面 iframe 了一个 b.com 的xss.swf，脚本执行域是哪个域？- b.com 因为iframe了一个swf，其实是iframe了一个只有一行代码的HTML页面，html页面的域是b.com，故脚本的执行域也是b.com。\n\n- a.com/load.swf能够加载任意的swf，我直接打开http://a.com/load.swf?url=http://b.com/xss.swf，能不能执行脚本？- 不能，因为直接打开一个swf，他的allowScriptAccess是samedomain，而xss.swf的域是b.com，所以不能执行JS。\nFlash里能执行JS的脚本函数有以下：\ngetURL(AS2) / navigateToURL (AS3)flash.external.ExternalInterface.call(methodName:String, [parameter1:Object])\n 我们只需要搜索getURL/navigateToURL/ExternalInterface.call等关键字，然后在逆溯变量是否可控，就可以找到一些最基本的XSS漏洞。以360的这个swf为例，搜索ExternalInterface.call，我们发现了下面的代码。\npublic static function initLanguage() : void{\tvar _loc_1:* = null;\tParam.language = {};\tif (ExternalInterface.available)\t{\t\t_loc_1 = ExternalInterface.call(Param.jsLang);\t\tif (_loc_1 != null)\t\t{\t\t\tParam.language[\"CX0189\"] = _loc_1[\"CX0189\"];\t\t\tParam.language[\"CX0193\"] = _loc_1[\"CX0193\"];\t\t\t_loc_1 = null;\t\t}\t}\treturn;}\n回溯Param.jsLang\nthis.parameter = this.loaderInfo.parameters;...Param.jsFunc = this.parameter[\"jsfunc\"];...Param.initLanguage()\n这里的loaderInfo.parameters就是接受外部以flashvars或者类似a.swf?a=va&b=vb形式传入的变量和值。这里我们打开 http://wan.360.cn/swf/avatar.swf?jslang=alert(1)\n\n这里我们也许还有一个疑问，在官方的帮助文档里，flash.external.ExternalInterface.call可以接受两个参数，第一个是methodName，第二个是要传入的变量，那么对于上面的poc，正确的调用方法应该是flash.external.ExternalInterface.call(\"alert\",\"1\")才是，为什么flash.external.ExternalInterface.call(\"alert(1)\")也能成功。我们打开ie的调试工具，借用80vul.com上的demo，看看swf执行js时候发生了什么。首先打开的是http://www.80vul.com/xss.swf?a=alert&b=1\n\n\ntry { __flash__toXML(alert(\"1\")) ; } catch (e) { \"<undefined/>\"; }\n__flash__toXML是将函数执行的结果进行编码后传回SWF的函数，外面再嵌套了一层容错语句，看来一切和预想的一样再打开http://www.80vul.com/xss.swf?a=alert(2)&b=1\n\n\ntry { __flash__toXML(alert(2)(\"1\")) ; } catch (e) { \"<undefined/>\"; }\nJS先执行了alert(2)，弹出对话框。再单步进入\n\nalert函数没有返回值，alert(2)(\"1\")出错，所以跳到了catch语句这样一来，就能解释为什么即使不按adobe的文档说明的方法进行调用，也能执行js了，再多说一句，由于这样会引起出错导致SWF接收不到JS返回的值，所以在某些特定的情况下，我们要对插入的函数进行进一步的变化，比如\thttp://www.80vul.com/xss.swf?a=(function(_a){alert(_a);return function(_z){prompt(2,3)};return 5})(1)&b=4这样，SWF就可以接收到我们可以任意构造的返回值 5 了。原始SWF下载：http://swfpoc.appspot.com/vul/wan.360.cn_swf_avatar.swf   漏洞证明：     修复方案：  正则匹配下，只允许[a-zA-Z\\.]   版权声明：转载请注明来源 p.z@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2013-01-06 22:39 厂商回复： 感谢您精心准备的详细的漏洞说明，该问题已经确定，我们已经通知业务部门对swf文件做一次批量处理。thx 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-01-06 22:54 |    \t\t3King \t\t\t( 普通白帽子  |\t\t\t        Rank:1129 漏洞数:92        | 【study at HNUST】非常感谢大家的关注~ 大...)\t\t \n  前排搞基~    \n     2013-01-06 23:01 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  围观大牛！    \n     2013-01-07 10:36 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  目测要连载啊    \n     2013-01-07 10:42 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  围观改变世界    \n     2013-01-08 20:09 |    \t\t黑色的屌丝 \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:5        | →_→→_→)\t\t \n  连载让世界更精彩    \n     2013-02-07 02:51 |    \t\t专业查水表 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:5        | \"><script>alert(/我是\"J.L\"的大号/);</scr...)\t\t \n  连载出书的绝对要火。。。我是来帮忙盖楼的    \n     2013-02-21 00:43 |    \t\tsaber \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 我只是一个人走了太久，久到习惯了一个人。)\t\t \n  目测要火啊。。    \n     2013-02-21 01:31 |    \t\tlsh4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:14        | 不是黑客!但是黑客手段都要会?)\t\t \n  大牛！    \n     2013-02-21 08:13 |    \t\tx1aoh4i \t\t\t( 普通白帽子  |\t\t\t        Rank:403 漏洞数:62        )\t\t \n  目测要火，是连载的话，采用    \n     2013-02-21 09:49 |    \t\tNiceWorm \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:38        )\t\t \n  学习了    \n     2013-02-21 10:54 |    \t\tblast \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:57        | 五仁委员会)\t\t \n  围观学习    \n     2013-03-09 06:45 |    \t\t苏南同学 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:5        | 苏南同学，就是苏南同学~~~)\t\t \n  学习    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}