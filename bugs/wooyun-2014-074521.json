{"id": 49246, "wybug_id": "wooyun-2014-074521", "wybug_title": "74CMS 最新版二次SQL注入多出可越权操作", "wybug_corp": "74c,s.com", "wybug_author": "xfkxfk", "wybug_date": "2014-09-01 12:14", "wybug_open_date": "2014-11-30 12:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向公众公开  简要描述： 74CMS 最新版二次SQL注入多出可越权操作 详细说明：  74CMS最新版：74cms_v3.4.20140820 官方8.20号更新文件：/user/personal/personal_resume.php\n//保存-求职意向elseif ($act=='make2_save'){\t\t$resumeuid=intval($_SESSION['uid']);\t$resumepid=intval($_REQUEST['pid']);\tif ($resumeuid==0 || $resumepid==0 ) showmsg('参数错误！',1);\t$resumearr['recentjobs']=trim($_POST['recentjobs']);\t$resumearr['nature']=intval($_POST['nature'])?intval($_POST['nature']):showmsg('请选择期望岗位性质！',1);\t$resumearr['nature_cn']=trim($_POST['nature_cn']);\t$resumearr['district']=trim($_POST['district'])?intval($_POST['district']):showmsg('请选择期望工作地！',1);\t$resumearr['sdistrict']=intval($_POST['sdistrict']);\t$resumearr['district_cn']=trim($_POST['district_cn']);\t$resumearr['wage']=intval($_POST['wage'])?intval($_POST['wage']):showmsg('请选择期望月薪！',1);\t$resumearr['wage_cn']=trim($_POST['wage_cn']);\t$resumearr['trade']=$_POST['trade']?trim($_POST['trade']):showmsg('请选择期望从事的行业！',1);\t$resumearr['trade_cn']=trim($_POST['trade_cn']);\t$resumearr['intention_jobs']=trim($_POST['intention_jobs']);\tif ($_CFG['audit_edit_resume']!=\"-1\")\t{\t$resumearr['audit']=$_CFG['audit_edit_resume'];\t}\tadd_resume_jobs($resumepid,$_SESSION['uid'],$_POST['intention_jobs_id'])?\"\":showmsg('更新失败！',0);\tupdatetable(table('resume'),$resumearr,\" id='{$resumepid}'  AND   uid='{$resumeuid}'\");\tupdatetable(table('resume_tmp'),$resumearr,\" id='{$resumepid}'  AND   uid='{$resumeuid}'\");\tcheck_resume($_SESSION['uid'],intval($_REQUEST['pid']));\tif ($_POST['go_resume_show'])\t{\t\theader(\"Location: ?act=resume_show&pid={$resumepid}\");\t}\telse\t{\theader(\"Location: ?act=make3&pid=\".intval($_POST['pid']));\t}}\n这里插入了求职意向，主要这里的职位信息：recentjobs\n//创建简历-技能特行elseif ($act=='make3_save'){\t\tif (intval($_POST['pid'])==0 ) showmsg('参数错误！',1);\t$setsqlarrspecialty['specialty']=!empty($_POST['specialty'])?$_POST['specialty']:showmsg('请填写您的技能特长！',1);\t$_CFG['audit_edit_resume']!=\"-1\"?$setsqlarrspecialty['audit']=intval($_CFG['audit_edit_resume']):\"\";\tupdatetable(table('resume'),$setsqlarrspecialty,\" id='\".intval($_POST['pid']).\"' AND uid='\".intval($_SESSION['uid']).\"'\");\tupdatetable(table('resume_tmp'),$setsqlarrspecialty,\" id='\".intval($_POST['pid']).\"' AND uid='\".intval($_SESSION['uid']).\"'\");\tcheck_resume($_SESSION['uid'],intval($_REQUEST['pid']));\tif ($_POST['go_resume_show'])\t{\t\theader(\"Location: ?act=resume_show&pid={$_POST['pid']}\");\t}\telse\t{\t\theader(\"Location: ?act=make4&pid=\".intval($_POST['pid']));\t}}\n这里更新了技能特长：specialty最后在文件：/include/fun_personal.php\n//检查简历的完成程度function check_resume($uid,$pid){\tglobal $db,$timestamp,$_CFG;\t$uid=intval($uid);\t$pid=intval($pid);\t$percent=0;......省略if ($percent>=60)\t{\t\t$j=get_resume_basic($uid,$pid);\t\t$searchtab['sex']=$j['sex'];\t\t$searchtab['nature']=$j['nature'];\t\t$searchtab['marriage']=$j['marriage'];\t\t$searchtab['experience']=$j['experience'];\t\t$searchtab['district']=$j['district'];\t\t$searchtab['sdistrict']=$j['sdistrict'];\t\t$searchtab['wage']=$j['wage'];\t\t$searchtab['education']=$j['education'];\t\t$searchtab['photo']=$j['photo'];\t\t$searchtab['refreshtime']=$j['refreshtime'];\t\t$searchtab['talent']=$j['talent'];\t\tupdatetable(table('resume_search_rtime'),$searchtab,\"uid='{$uid}' AND id='{$pid}'\");\t\t$searchtab['key']=$j['key'];\t\t$searchtab['likekey']=$j['intention_jobs'].','.$j['recentjobs'].','.$j['specialty'].','.$j['fullname'];\t\tupdatetable(table('resume_search_key'),$searchtab,\"uid='{$uid}' AND id='{$pid}'\");\t\tunset($searchtab);\n这里从简历信息里取出来了信息注意这里：\n$searchtab['likekey']=$j['intention_jobs'].','.$j['recentjobs'].','.$j['specialty'].','.$j['fullname'];\n这里的recentjobs，specialty，就是上面插入简历信息里面的recentjobs，specialty，这里取出来后，有进入了updatetable：\nupdatetable(table('resume_search_key'),$searchtab,\"uid='{$uid}' AND id='{$pid}'\");\n这里是更新搜索关键字的最后来看看updatetable函数：\nfunction updatetable($tablename, $setsqlarr, $wheresqlarr, $silent=0) {\tglobal $db;\t$setsql = $comma = '';\tforeach ($setsqlarr as $set_key => $set_value) {\t\tif(is_array($set_value)) {\t\t\t$setsql .= $comma.'`'.$set_key.'`'.'='.$set_value[0];\t\t} else {\t\t\t$setsql .= $comma.'`'.$set_key.'`'.'=\\''.$set_value.'\\'';\t\t}\t\t$comma = ', ';\t}\t$where = $comma = '';\tif(empty($wheresqlarr)) {\t\t$where = '1';\t} elseif(is_array($wheresqlarr)) {\t\tforeach ($wheresqlarr as $key => $value) {\t\t\t$where .= $comma.'`'.$key.'`'.'=\\''.$value.'\\'';\t\t\t$comma = ' AND ';\t\t}\t} else {\t\t$where = $wheresqlarr;\t}\t//echo \"UPDATE \".($tablename).\" SET \".$setsql.\" WHERE \".$where, $silent?\"SILENT\":\"\";\treturn $db->query(\"UPDATE \".($tablename).\" SET \".$setsql.\" WHERE \".$where, $silent?\"SILENT\":\"\");}\n将参数直接进入SQL语句，没有经过过滤。总结：1、求职职位和技能特长进入数据库，可带入恶意sql语句2、从简历信息里取出来职位及特长3、再次进入数据库，没有过滤，恶意SQL语句进入数据库4、导致二次sql注入这里的求职职位，技能特长，姓名三处都存在二次注入这里通过截断即可更新任意用户的信息了   漏洞证明：  1、在求职职位中输入\n\n2、在技能特长处输入\n\n3、最后看看是否执行成功：\n\n数据库中likekey成功被修改，恶意sql语句成功执行   修复方案：  进入数据库时再次过滤   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-09-02 09:46 厂商回复： 感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-01 22:17 |    \t\t树上草 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:8        | <img height=\"12\" width=\"12\" style=\"verti...)\t\t \n  我擦，牛逼    \n     2014-09-02 10:14 |    \t\t尼玛椰子树 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 简单，守护心中那份沉静。疯狂，爆破黎明的...)\t\t \n  哥哥 你累不累呀！~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}