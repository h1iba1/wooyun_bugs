{"id": 5688, "wybug_id": "wooyun-2014-048914", "wybug_title": "Discuz附件下载权限绕过", "wybug_corp": "Discuz!", "wybug_author": "Coxxs", "wybug_date": "2014-01-15 16:09", "wybug_open_date": "2014-03-01 16:09", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-01：\t细节向公众公开  简要描述： 绕过附件下载权限只是漏洞的一个应用，还可以免费下载附件，其他的应用还没发掘.. 详细说明：  在下载附件的时候，附件所设置的“阅读权限”可以被绕过。Discuz的附件下载地址是类似\nforum.php?mod=attachment&aid=Nzg4fDQwNGQzYjMxfDEzODk2OTM4Mzh8MzEyNTR8MjY3Mw%3D%3D\n这样的地址，其中的aid参数是一串base64，解码后是：\n788|404d3b31|1389693838|31254|2673\n这串aid在source/module/forum/forum_attachment.php 中被这样解析\n@list($_GET['aid'], $_GET['k'], $_GET['t'], $_GET['uid'], $_GET['tableid']) = daddslashes(explode('|', base64_decode($_GET['aid'])));\n之前提交的 788|404d3b31|1389693838|31254|2673 中的 31254 就是登录用户的UID，它被赋值进了 $_GET['uid'] 变量。紧接着：\nif($_GET['uid'] != $_G['uid'] && $_GET['uid']) {\t$_G['uid'] = $_GET['uid'] = intval($_GET['uid']);\t......}\n如果用户提交的uid和当前登录的uid不同，DZ就会将用户所提交的uid赋值给discuz的全局使用变量$_G也就是说，用户可以在下载附件时，任意“伪造”自己的身份。但好在，这个php只能用于下载附件，不会造成更大的安全问题。但不可避免的，由于缺少了必要的过滤，还是会造成一些低危漏洞。这部分内容在漏洞证明中说明。   漏洞证明：  越权下载含有“阅读权限”的插件、下载插件免扣币重现步骤：1、使用管理员账户，上传一个有高阅读权限的附件2、使用低权限的用户账户，下载附件，这个时候，Discuz会提示无权下载此时，浏览器中的附件地址形如\nforum.php?mod=attachment&aid=Nzg4fDQwNGQzYjMxfDEzODk2OTM4Mzh8MzEyNTR8MjY3Mw%3D%3D\n解码aid\n788|404d3b31|1389693838|31254|2673\n修改其中的uid部分（这里将uid改成了管理员账户：1）\n788|404d3b31|1389693838|1|2673\n编码修改后的aid\nforum.php?mod=attachment&aid=Nzg4fDQwNGQzYjMxfDEzODk2OTM4Mzh8MXwyNjcz\n此时，成功下载原本需要高权限的附件另外下载的同时还可能会刷新用户的最后登录时间（我也因为这个巧合才发现这个漏洞的，因为某些cdn把地址里的base64全部小写了，造成解析错误，解析成了别人的uid，顺便刷新了最后登录时间）   修复方案：  附件下载是有key校验的，可以将uid也加入key校验中，防止用户随意修改   版权声明：转载请注明来源 Coxxs@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-01-15 16:54 厂商回复： 此问题我们已经开始修复，谢谢您的建议 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-15 17:24 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  哇？！？！？！那么快确认？！态度180度大转变？    \n     2014-01-15 19:47 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  mark    \n     2014-03-01 17:54 |    \t\tCoffee \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:15        | Corie, a student of RDFZ.)\t\t \n  通杀吗？混论坛必备。    \n     2014-03-01 18:02 |    \t\tRicter \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:15        | 渣渣一个)\t\t \n  这个好啊    \n     2014-03-10 00:22 |    \t\t马云 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 啪啪啪啪啪啪啪啪)\t\t \n  吾爱破解已经发工具了，测试了下好几个已经修复了    \n     2014-03-10 00:23 |    \t\t马云 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 啪啪啪啪啪啪啪啪)\t\t \n  DZ刷金币的漏洞没人发现？    \n     2014-03-10 19:34 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  @马云 吾爱又这个漏洞没？貌似发工具的小孩密码被人社工了，帖子被人改了，从其他地方搜了下，找到这个工具发现感染病毒了，不排除发帖人自己感染的，各位下载使用小心点。    \n     2014-03-10 22:37 |    \t\t马云 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 啪啪啪啪啪啪啪啪)\t\t \n  @Hmily 我擦 老大，我是HTC，论坛没有这个漏洞。我说我试过你不会ban我ID吧-。-    \n     2014-04-27 20:52 |    \t\t橘子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | 呢个...羞射高中生一枚。带上大神@Haswell...)\t\t \n  赞一个~    \n     2014-05-04 16:57 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  @马云 好孩子，不ban。。。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}