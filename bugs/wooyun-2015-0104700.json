{"id": 24078, "wybug_id": "wooyun-2015-0104700", "wybug_title": "禅道项目管理软件多个漏洞", "wybug_corp": "禅道", "wybug_author": "xcrypt", "wybug_date": "2015-03-30 12:16", "wybug_open_date": "2015-06-28 13:02", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-28：\t细节向公众公开  简要描述： 问题都比较严重，可导致匿名用户写入任意代码。测试版本：开源版6.3和7.1，专业版4.5，其他版本可能也受影响。 详细说明：  1、upgrade.php缺少权限验证，导致匿名用户可随意调用任意模块，造成任意代码写入。2、附件上传模块的黑名单过滤在windows环境下可被绕过，结合第一个漏洞，匿名用户可上传任意文件。   漏洞证明：  1、越权upgrade.php关键代码如下\n\nindex.php相关代码如下\n\n可以看到upgrade.php在loadModule之前少了一行checkPriv，即无需权限验证即可调用模块。但上面还有一行判断，$_SERVER['HTTP_X_REQUESTED_WITH']如果为空并且两个版本号比较结果小于等于0，则跳转到index.php。测试发现，两个版本号比较结果始终等于0，那么，$_SERVER['HTTP_X_REQUESTED_WITH']是不是可控的呢？答案是肯定的，这个值从http头中获取。这样便跳过了if判断，直接加载模块。官方演示站也存在该问题，如下图所示：\n\n后台的模块编辑功能可以写入任意php代码，利用该漏洞可以无条件写入任意代码并执行。2、任意文件上传除了利用模块编辑功能外，附件上传功能在windows环境下也可以被利用。下图是获取文件后缀的代码\n\n如果存在以下危险后缀，则返回txt。\n\n黑名单检查一不小心就会被绕过，特别是程序部署在windows服务器上时，因为windows的一些特性导致。利用过程如下：\n\n\n\n\n\n   修复方案：  1、upgrade.php加上权限判断2、使用白名单   版权声明：转载请注明来源 xcrypt@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-03-30 13:00 厂商回复： 谢谢反馈。:) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-30 12:37 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2360 漏洞数:406        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  匿名用户    \n     2015-04-02 16:18 |    \t\tpapaver \t\t\t( 普通白帽子  |\t\t\t        Rank:197 漏洞数:35        | 95后，高一学生一枚... 萌萌哒..)\t\t \n  居然现在有厂商了。。。    \n     2015-06-29 21:18 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:54        | 潜心代码审计。)\t\t \n  ::$ mark    \n     2015-08-11 13:30 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  截断上传::$DATA    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}