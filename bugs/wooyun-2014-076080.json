{"id": 48888, "wybug_id": "wooyun-2014-076080", "wybug_title": "Discuz!X一个为所欲为的csrf+hpp(站点脱裤，任意文件文件操作，目录穿越，可能其他cms躺着中枪)", "wybug_corp": "Discuz!", "wybug_author": "menmen519", "wybug_date": "2014-09-14 22:45", "wybug_open_date": "2014-12-13 22:46", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向公众公开  简要描述： Discuz!x 一个为所欲为的csrf(站点脱裤，任意文件文件操作，目录穿越，可能其他cms躺着中枪) 求闪电！！！！！！！！！！！！！！ 详细说明：  此漏洞来自dz公司的ucenter，这个ucenter，应该是在数据库备份操作时候，没有做csrf防御可导致dz被文件操作，脱裤等等，开始分析：\n\n下来我们分析代码：uc_server\\control\\admin\\db.php:(85-ll6行):\nfunction onoperate() {\t\trequire_once UC_ROOT.'lib/xml.class.php';\t\t$nexturl = getgpc('nexturl');\t\t$appid = intval(getgpc('appid'));\t\t$type = getgpc('t') == 'import' ? 'import' : 'export';\t\t$backupdir = getgpc('backupdir');\t\t$app = $this->cache['apps'][$appid];\t\tif($nexturl) {\t\t\t$url = $nexturl;\t\t} else {\t\t\tif($appid) {\t\t\t\tif(!isset($this->cache['apps'][$appid])) {\t\t\t\t\t$this->message($this->_parent_js($appid, 'appid_invalid'));\t\t\t\t}\t\t\t\tif($app['type'] == 'DISCUZX') {\t\t\t\t\t$url = $app['url'].'/api/db/dbbak.php?apptype='.$app['type'];\t\t\t\t} else {\t\t\t\t\t$url = $app['url'].'/api/dbbak.php?apptype='.$app['type'];\t\t\t\t}\t\t\t\t$code = $this->authcode('&method='.$type.'&sqlpath='.$backupdir.'&time='.time(), 'ENCODE', $app['authkey']);\t\t\t} else {\t\t\t\t$url = 'http://'.$_SERVER['HTTP_HOST'].str_replace('admin.php', 'api/dbbak.php', $_SERVER['PHP_SELF']).'?apptype=UCENTER';\t\t\t\t$code = $this->authcode('&method='.$type.'&sqlpath='.$backupdir.'&time='.time(), 'ENCODE', UC_KEY);\t\t\t}\t\t\t$url .= '&code='.urlencode($code);\t\t}\t\tif(empty($appid)) {\t\t\t$app['ip'] = defined('UC_IP') ? UC_IP : '';\t\t}\t\t$res = $_ENV['misc']->dfopen2($url, 0, '', '', 1, $app['ip'], 20, TRUE);\t\tif(empty($res)) {\t\t\t$this->message($this->_parent_js($appid, 'db_back_api_url_invalid'));\n这里的意思就是，当你发送一个get请求之后，然后php内部通过fopen完成剩下的所有动作，漏洞产生在哪里呢：\n$url = 'http://'.$_SERVER['HTTP_HOST'].str_replace('admin.php', 'api/dbbak.php', $_SERVER['PHP_SELF']).'?apptype=UCENTER';\t\t\t\t$code = $this->authcode('&method='.$type.'&sqlpath='.$backupdir.'&time='.time(), 'ENCODE', UC_KEY);\n看到这两句了没有，举个例子吧：我们提交的http请求如果是:http://site.com/index.php?a=1&b=2那么当我们b传递进来的时候重新二次构造url，如果我们的b=xxxx%26backupfilename%3Daaaa这里时候等于在内部通过fopen发送get请求时候后面多添加了一个参数交个backupfilename=aaaa看到这个解释，就恍然大悟了吧，肯定后面有怎么设置backupfilename，本来这里是不会被用户更改的，这样已设置，我们备份的文件名字可控了，直接可以拿到，在看代码：uc_server\\api\\dbbak.php:(255-334):\nif($get['method'] == 'export') {\t$db->query('SET SQL_QUOTE_SHOW_CREATE=0', 'SILENT');\t$time = date(\"Y-m-d H:i:s\", $timestamp);\t$tables = array();\t$tables = arraykeys2(fetchtablelist($tablepre), 'Name');\tif($apptype == 'discuz') {\t\t$query = $db->query(\"SELECT datatables FROM {$tablepre}plugins WHERE datatables<>''\");\t\twhile($plugin = $db->fetch_array($query)) {\t\t\tforeach(explode(',', $plugin['datatables']) as $table) {\t\t\t\tif($table = trim($table)) {\t\t\t\t\t$tables[] = $table;\t\t\t\t}\t\t\t}\t\t}\t}\t$get['volume'] = isset($get['volume']) ? intval($get['volume']) : 0;\t$get['volume'] = $get['volume'] + 1;\t$version = $version ? $version : $apptype;\t$idstring = '# Identify: '.base64_encode(\"$timestamp,$version,$apptype,multivol,$get[volume]\").\"\\n\";\tif(!isset($get['sqlpath']) || empty($get['sqlpath'])) {\t\t$get['sqlpath'] = 'backup_'.date('ymd', $timestamp).'_'.random(6);\t\tif(!mkdir(BACKUP_DIR.'./'.$get['sqlpath'], 0777)) {\t\t\tapi_msg('mkdir_error', 'make dir error:'.BACKUP_DIR.'./'.$get['sqlpath']);\t\t}\t} elseif(!is_dir(BACKUP_DIR.'./'.$get['sqlpath'])) {\t\tif(!mkdir(BACKUP_DIR.'./'.$get['sqlpath'], 0777)) {\t\t\tapi_msg('mkdir_error', 'make dir error:'.BACKUP_DIR.'./'.$get['sqlpath']);\t\t}\t\t\t}\tif(!isset($get['backupfilename']) || empty($get['backupfilename'])) {\t\t$get['backupfilename'] = date('ymd', $timestamp).'_'.random(6);\t}\t$sqldump = '';\t$get['tableid'] = isset($get['tableid']) ? intval($get['tableid']) : 0;\t$get['startfrom'] = isset($get['startfrom']) ? intval($get['startfrom']) : 0;\t$complete = TRUE;\tfor(; $complete && $get['tableid'] < count($tables) && strlen($sqldump) + 500 < $sizelimit * 1000; $get['tableid']++) {\t\t$sqldump .= sqldumptable($tables[$get['tableid']], strlen($sqldump));\t\tif($complete) {\t\t\t$get['startfrom'] = 0;\t\t}\t}\t!$complete && $get['tableid']--;\t$dumpfile = BACKUP_DIR.$get['sqlpath'].'/'.$get['backupfilename'].'-'.$get['volume'].'.sql';\tif(trim($sqldump)) {\t\t$sqldump = \"$idstring\".\t\t\t\"# <?php exit();?>\\n\".\t\t\t\"# $apptype Multi-Volume Data Dump Vol.$get[volume]\\n\".\t\t\t\"# Time: $time\\n\".\t\t\t\"# Type: $apptype\\n\".\t\t\t\"# Table Prefix: $tablepre\\n\".\t\t\t\"# $dbcharset\\n\".\t\t\t\"# $apptype Home: http://www.comsenz.com\\n\".\t\t\t\"# Please visit our website for newest infomation about $apptype\\n\".\t\t\t\"# --------------------------------------------------------\\n\\n\\n\".\t\t\t$sqldump;\t\t\t\t\t@$fp = fopen($dumpfile, 'wb');\t\t@flock($fp, 2);\t\tif(@!fwrite($fp, $sqldump)) {\t\t\t@fclose($fp);\t\t\tapi_msg('database_export_file_invalid', $dumpfile);\t\t} else {\t\t\tfclose($fp);\t\t\tauto_next($get, $dumpfile);\t\t}\t} else {\t\t@touch(ROOT_PATH.$get['sqlpath'].'/index.htm');\t\tapi_msg('explor_success', 'explor_success');\t}\n我们主要看着一句：\nif(!isset($get['backupfilename']) || empty($get['backupfilename'])) {\t\t$get['backupfilename'] = date('ymd', $timestamp).'_'.random(6);\t}\n刚才我们举例子了，按照这个逻辑走那么我们就会绕过去，不会在这里创建一个6个字符的随机数文件名这里为了举例子，我们摘出来其中一部分sql备份：url:http://192.168.10.70/discuz_x3.2_sc_utf8/upload/uc_server/admin.php?m=db&a=operate&t=export&appid=0&backupdir=xxxx%26backupfilename%3Daaaa按照程序的逻辑，这句话的意思就是在xxxx目录底下备份一个aaaa-1.sql我们访问一下：\n\n我们去这个目录看看是否已经生成备份文件：\n\n有了这个我们害怕什么，很简单的一个get csrf，这时候我们在论坛发送一个img<img src=http://192.168.10.70/discuz_x3.2_sc_utf8/upload/uc_server/admin.php?m=db&a=operate&t=export&appid=0&backupdir=xxxx%26backupfilename%3Daaaa>一切都搞定......关于这里怎么利用，方法太多了下来我们看第二个漏洞目录穿越:这里的backupdir 居然没有做任何限制，所以我们可以再操作系统内部随意创建文件夹并且把备份的文件给写入进去，想想都可怕，如果dz的数据库非常强大，我这里只要一个死循环，分分钟让硬盘爆满:url：http://192.168.10.70/discuz_x3.2_sc_utf8/upload/uc_server/admin.php?m=db&a=operate&t=export&appid=0&backupdir=../../../../../../../../../../../../../../../../../xxxx这时候我们去根目录看看:\n\n有人说gpc开着那么我们就没有办法阶段这一句代码:\n!$complete && $get['tableid']--;\t$dumpfile = BACKUP_DIR.$get['sqlpath'].'/'.$get['backupfilename'].'-'.$get['volume'].'.sql';\n说的一点都没有错，因为我们这个$get['backupfilename']是完全可控的，如果我们发送%00这里会被gpc转义为\\0不会被截短，但是在linux底下就不一样了，每个文件达到一定长度时候它自然就被截断了，举个例子:\n$a='';　　for($i=0;$i<=4071;$i++) {　　$a .= '/';　　}　　$a = 'test.txt'.$a; //完整的路径为/var/www/test/test.txt　　require_once($a.'.php');　　?>\n在Linux环境下测试，你会发现'.php'被截断了.这时候我们就可以写一个php文件了，不做演示了，主要漏洞点演示完毕下来我们再看一个文件删除的地方：\nelseif($get['method'] == 'delete') {\t$sqlpath = trim($get['sqlpath']);\tif(empty($sqlpath) || !is_dir(BACKUP_DIR.$sqlpath)) {\t\tapi_msg('dir_no_exists', $sqlpath);\t}\t$directory = dir(BACKUP_DIR.$sqlpath);\twhile($entry = $directory->read()) {\t\t$filename = BACKUP_DIR.$sqlpath.'/'.$entry;\t\tif(is_file($filename) && preg_match('/\\d+_\\w+\\-(\\d+).sql$/', $filename) && !@unlink($filename)) {\t\t\tapi_msg('delete_dumpfile_error', $filename);\t\t}\t}\t$directory->close();\t@rmdir(BACKUP_DIR.$sqlpath);\tapi_msg('delete_sqlpath_success', 'delete_sqlpath_success');}\n这里的逻辑就是删除某个目录底下的以sql后缀的文件，然后删除改文件夹，当然了这个文件夹如果是空的，那么我也就直接删除，非空是删不掉的 由于$sqlpath 路径完全可控，所以导致，可以再某一个盘符底下任意穿越删除sql文件，不管你是其他备份的还是这里自己生成的一概删掉反正有了这个fopen的参数污染bug，那么应该还有好多地方存在问题，这里就不一一说了再付最后一张图：\n\n\n\n这些 我想就不用分析了吧，都是嵌入应用.........ok   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-09-15 10:35 厂商回复： 感谢您对我们产品的支持，我们会尽快处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-14 22:49 |    \t\t苍崎深雪 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | 微光)\t\t \n  火钳    \n     2014-09-14 22:49 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  看着很厉害    \n     2014-09-14 22:52 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  csrf    \n     2014-09-14 23:01 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  好腻害！    \n     2014-09-14 23:16 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  威力强大的组合技能    \n     2014-09-14 23:16 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  火钳留翔    \n     2014-09-14 23:38 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  mark    \n     2014-09-14 23:49 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  。。。又是uc_key被搞到了么    \n     2014-09-15 00:14 |    \t\tMoo \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | PS：不打脸，还要泡妞呢)\t\t \n  +1    \n     2014-09-15 00:26 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  牛逼，csrf脱裤，1w的节奏！    \n     2014-09-15 00:36 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @pandas 就是把以前怀疑的地方重新看了看    \n     2014-09-15 01:19 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  大牛    \n     2014-09-15 01:23 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  我不得不承认，又没有给闪电，和明天再给你发一个shell,怒了    \n     2014-09-15 02:15 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  DZ惹着道上的弟兄了...    \n     2014-09-15 03:00 |    \t\t写个七 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 一点一点积累。)\t\t \n      这个比较叼！  我日    \n     2014-09-15 07:42 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  峰会很有用    \n     2014-09-15 08:41 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  卧槽    \n     2014-09-15 08:54 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  为所欲为,你们这帮禽兽    \n     2014-09-15 09:10 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  哥  出去玩了两天 沙发不是我了    \n     2014-09-15 09:22 |    \t\t木马游民 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:8        | I love LSD!)\t\t \n  禽兽    \n     2014-09-15 11:40 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @menmen519 hi，冻主，又是我，顾问团团长，这个地方也言过其实了，首先那个东西一般不常登陆，即使登陆上去，不活动的时间也只有1800秒，也就是30分钟，而导出的东西内有<?php exit;?>的限制，尝试删除的文件也有.sql的后主，我觉得这个东西很难为所欲为，对运气的要求太高了。    \n     2014-09-15 11:42 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  @Ray 我擦，真相？    \n     2014-09-15 11:43 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  对，要是有限制就不要借鉴我的“为所欲为”的表达方式，你让我以后怎么用啊。    \n     2014-09-15 11:46 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @pandas - -|||，临危授命    \n     2014-09-15 11:48 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Ray 首先你得承认 hpp导致的sql备份文件完全可控，下来硬盘随意写文件，其他的就不说了，就这两点就够了    \n     2014-09-15 11:49 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Map 操作文件 这里还有删除dz站点的风险，你们可以深入看看    \n     2014-09-15 11:51 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @menmen519 太有限制了……，首先限制了必须在对方登陆30分钟内走到你的逻辑里，限制了文件的内容，限制了要删除的文件的后缀，这……不否认有漏洞，但是不是高危的为所欲为啊。    \n     2014-09-15 11:56 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Ray 都脱裤子了 还不高危啊  我记得上一个csrf 最起码最后的备份文件名字还要暴力破解六位数字，这得多长时间，我这个直接名字自定义    \n     2014-09-15 12:21 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Ray 再说你在看看7.2 根本就没有限制，哪里来个时间限制    \n     2014-09-15 13:59 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @menmen519 uc_server的sid_encode内有个1800。 ：）    \n     2014-09-21 22:05 |    \t\t鱼化石 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:18        | 介绍不能为空)\t\t \n  +++    \n     2014-12-13 23:04 |    \t\t道长且阻 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 学习 学习 学习)\t\t \n  学习学习 我要学php    \n     2014-12-14 00:35 |    \t\tM4ster \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:7        | www.m4ster@gmail.com)\t\t \n  @道长且阻 PHP是世界上最好的语言    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}