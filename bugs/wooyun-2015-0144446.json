{"id": 73371, "wybug_id": "wooyun-2015-0144446", "wybug_title": "贷齐乐p2p全局问题多处注入(无视gpc/waf)", "wybug_corp": "chinaanhe.com", "wybug_author": "Xser", "wybug_date": "2015-10-02 08:31", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-05：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-11-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： RT 详细说明：  出现在upload文件上\nif ($error==\"\"){\t\t\t\t\t\t$sql = \"insert into `{upfiles}` set code='{$data['code']}',aid='{$data['aid']}',user_id='{$data['user_id']}',`name`='{$_name}',filesize='{$_FILES[$file]['size'][$i]}',filetype='{$this->img_type}',fileurl='\".$this->file_dir.$newFile.\"',filename='\".$newFile.\"',`addtime` = '\".time().\"', `updatetime` = '\".time().\"',`addip` = '\".ip_address().\"',`updateip` = '\".ip_address().\"'\";\t\t\t\t\t\t$mysql ->db_query($sql);\t\t\t\t\t\t$upfiles_id = $mysql->db_insert_id();\t\t\t\t\t\t$_result[$i]['filename'] = $this->file_dir.$newFile;\t\t\t\t\t\t$_result[$i]['upfiles_id'] = $upfiles_id;\t\t\t\t\t}else{\t\t\t\t\t\techo \"<script>alert('\".$err_var[$error].\"');history.go(-1);</script>\";\t\t\t\t\t\texit;\t\t\t\t\t}\t\t\t\t}\n可以看到文件名没有验证然后带入sql查询跟踪下在哪里调用了在module/user/user.inc.php中\n/实名认证\telseif ($_U['query_type'] == \"realname\"){\t\tif (isset($_POST['realname'])){\t\t\t\t$var = array(\"realname\",\"sex\",\"card_type\",\"card_id\",\"province\",\"city\",\"province\",\"city\",\"area\",\"nation\");\t\t\t$data = post_var($var);\t\t\t$data['user_id'] = $_G['user_id'];\t\t\t$data['birthday'] = get_mktime($_POST['birthday']);\t\t\t$data['real_status'] = 2;\t\t\t\t\t\t$result = userClass::CheckIdcard(array(\"user_id\"=>$data['user_id'],\"card_id\"=>$data['card_id']));\t\t\tif(!isIdCard($data['card_id'])){\t\t\t\t$msg = array(\"身份证号码格式不正确\",\"\",\"?user&q=code/user/realname\");\t\t\t}elseif($result == true){\t\t\t\t$msg = array(\"身份证号码已经存在\",\"\",\"?user&q=code/user/realname\");\t\t\t\t}else{\t\t\t\t$_G['upimg']['file'] = \"card_pic2\";\t\t\t\t$_G['upimg']['code'] = \"user\";\t\t\t\t$pic_result = $upload->upfile($_G['upimg']);\t\t\t\tif ($pic_result!=\"\"){\t\t\t\t\t$data['card_pic2'] = $pic_result['filename'];\t\t\t\t}\t\t\t\t$_G['upimg']['file'] = \"card_pic1\";\t\t\t\t$pic_result = $upload->upfile($_G['upimg']);\t\t\t\tif ($pic_result!=\"\"){\t\t\t\t\t$data['card_pic1'] = $pic_result['filename'];\t\t\t\t}\t\t\t\t$result = $user->UpdateUserAll($data);\t\t\t\tif ($result == false){\t\t\t\t\t$msg = array($result);\t\t\t\t\t}else{\t\t\t\t\t$msg = array(\"姓名认证添加成功，请等待管理员审核\",\"\",$url);\t\t\t\t\t}\t\t\t}\t\t}\n实名认证那里\n$_G['upimg']['file'] = \"card_pic1\";\t\t\t\t$pic_result = $upload->upfile($_G['upimg']);\t\t\t\tif ($pic_result!=\"\"){\t\t\t\t\t$data['card_pic1'] = $pic_result['filename'];\t\t\t\t}\t\t\t\t$result = $user->UpdateUserAll($data);\n因为是FILE数组所以不受gpc/waf我们测试下带入单引号http://127.0.0.1/index.php?user&q=code/user/realname\n\n抓包修改提交，看看报错\n\n   漏洞证明：  出现在upload文件上\nif ($error==\"\"){\t\t\t\t\t\t$sql = \"insert into `{upfiles}` set code='{$data['code']}',aid='{$data['aid']}',user_id='{$data['user_id']}',`name`='{$_name}',filesize='{$_FILES[$file]['size'][$i]}',filetype='{$this->img_type}',fileurl='\".$this->file_dir.$newFile.\"',filename='\".$newFile.\"',`addtime` = '\".time().\"', `updatetime` = '\".time().\"',`addip` = '\".ip_address().\"',`updateip` = '\".ip_address().\"'\";\t\t\t\t\t\t$mysql ->db_query($sql);\t\t\t\t\t\t$upfiles_id = $mysql->db_insert_id();\t\t\t\t\t\t$_result[$i]['filename'] = $this->file_dir.$newFile;\t\t\t\t\t\t$_result[$i]['upfiles_id'] = $upfiles_id;\t\t\t\t\t}else{\t\t\t\t\t\techo \"<script>alert('\".$err_var[$error].\"');history.go(-1);</script>\";\t\t\t\t\t\texit;\t\t\t\t\t}\t\t\t\t}\n可以看到文件名没有验证然后带入sql查询跟踪下在哪里调用了在module/user/user.inc.php中\n/实名认证\telseif ($_U['query_type'] == \"realname\"){\t\tif (isset($_POST['realname'])){\t\t\t\t$var = array(\"realname\",\"sex\",\"card_type\",\"card_id\",\"province\",\"city\",\"province\",\"city\",\"area\",\"nation\");\t\t\t$data = post_var($var);\t\t\t$data['user_id'] = $_G['user_id'];\t\t\t$data['birthday'] = get_mktime($_POST['birthday']);\t\t\t$data['real_status'] = 2;\t\t\t\t\t\t$result = userClass::CheckIdcard(array(\"user_id\"=>$data['user_id'],\"card_id\"=>$data['card_id']));\t\t\tif(!isIdCard($data['card_id'])){\t\t\t\t$msg = array(\"身份证号码格式不正确\",\"\",\"?user&q=code/user/realname\");\t\t\t}elseif($result == true){\t\t\t\t$msg = array(\"身份证号码已经存在\",\"\",\"?user&q=code/user/realname\");\t\t\t\t}else{\t\t\t\t$_G['upimg']['file'] = \"card_pic2\";\t\t\t\t$_G['upimg']['code'] = \"user\";\t\t\t\t$pic_result = $upload->upfile($_G['upimg']);\t\t\t\tif ($pic_result!=\"\"){\t\t\t\t\t$data['card_pic2'] = $pic_result['filename'];\t\t\t\t}\t\t\t\t$_G['upimg']['file'] = \"card_pic1\";\t\t\t\t$pic_result = $upload->upfile($_G['upimg']);\t\t\t\tif ($pic_result!=\"\"){\t\t\t\t\t$data['card_pic1'] = $pic_result['filename'];\t\t\t\t}\t\t\t\t$result = $user->UpdateUserAll($data);\t\t\t\tif ($result == false){\t\t\t\t\t$msg = array($result);\t\t\t\t\t}else{\t\t\t\t\t$msg = array(\"姓名认证添加成功，请等待管理员审核\",\"\",$url);\t\t\t\t\t}\t\t\t}\t\t}\n实名认证那里\n$_G['upimg']['file'] = \"card_pic1\";\t\t\t\t$pic_result = $upload->upfile($_G['upimg']);\t\t\t\tif ($pic_result!=\"\"){\t\t\t\t\t$data['card_pic1'] = $pic_result['filename'];\t\t\t\t}\t\t\t\t$result = $user->UpdateUserAll($data);\n因为是FILE数组所以不受gpc/waf我们测试下带入单引号http://127.0.0.1/index.php?user&q=code/user/realname\n\n抓包修改提交，看看报错\n\n   修复方案：     版权声明：转载请注明来源 Xser@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-10-02 11:12 厂商回复： 请官方认真审核，此并非贷齐乐正版漏洞，应该是贷齐乐盗版或者是贷齐乐1.0版，看界面就是很古老的版本，请不要以贷齐乐冠名，贷齐乐身份上传已经早就不这样写了 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-10-03 20:27 |    \t\t岛云首席鉴黄师 \t\t\t( 普通白帽子  |\t\t\t        Rank:430 漏洞数:123        | icisaw.cn 超低价虚拟主机VPS 购买返现 支...)\t\t \n  贷齐乐1.0版不是你们的？    \n     2015-10-06 10:18 |    \t\tsecgov \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 安全审计，漏洞挖掘,WAF. 提醒大家揭露漏洞...)\t\t \n  态度决定命运    \n     2015-10-09 15:14 |    \t\t小良 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 根本不会挖漏洞~)\t\t \n  @岛云首席鉴黄师 贷齐乐1.0确实不是他们的，他们盗版的别人的~    \n     2015-10-10 02:12 |    \t\t岛云首席鉴黄师 \t\t\t( 普通白帽子  |\t\t\t        Rank:430 漏洞数:123        | icisaw.cn 超低价虚拟主机VPS 购买返现 支...)\t\t \n  @小良 soga~看来也是个二逼厂商……    \n     2015-10-11 16:36 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:365 漏洞数:83        | JDSec)\t\t \n  其实我想说这个是你们的2.1商业版本。。。。。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}