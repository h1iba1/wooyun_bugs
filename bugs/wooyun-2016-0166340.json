{"id": 75815, "wybug_id": "wooyun-2016-0166340", "wybug_title": "某联通实名后台管理系统源码泄露", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "风情万种", "wybug_date": "2016-01-03 22:00", "wybug_open_date": "2016-02-20 15:48", "wybug_type": "任意文件遍历/下载", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["默认配置不当", "源代码泄漏"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-20：\t细节向公众公开  简要描述： 某联通实名后台管理系统源码泄露 详细说明：  **.**.**.**/直接列出目录和文件  可下载备份文件\n\n\n<?php//header(\"Content-type: text/html; charset=utf-8\");ini_set(\"error_reporting\",E_ALL ^ E_NOTICE);//获取POST请求的参数$type = $_GET['type'];//请求类型//根据type判断是什么操作:;if ($type==\"0\") {//type=0表示检测手机号是否允许实名\t$tel = $_GET['tel'];//手机号\t$deviceid = $_GET['deviceid'];//deviceid\tcheckUnicomNum($tel,$deviceid);}if ($type==\"1\") {//type=1表示根据iccid获取手机号;\t$iccid = $_GET['iccid'];//iccid\t//echo $iccid.'<br/>';\t$deviceid = $_GET['deviceid'];//deviceid\t$num = getUnicomNum($iccid,$deviceid);\tprint(json_encode(array(\"result\"=>$num)));}if($type==\"2\") {//type=2表示提交实名认证信息;\t$tel = $_GET['tel'];//手机号\t$name = $_GET['name'];//姓名\t$num = $_GET['num'];//身份证号\t$addr = $_GET['addr'];//身份证地址\t$communicaID = $_GET['communicaID'];//communicaID\t$UID = $_GET['UID'];//UID用户id，用来记录提交实名信息的用户\t$deviceid = $_GET['deviceid'];//deviceid\tsubmitUnicomNum($tel,$name,$num,$addr,$communicaID,$UID,$deviceid);\t//submitUnicomNum('13146033307','段士辉','411503198903243012','北京市昌平区史各庄镇西半壁');}if($type == \"3\"){\t$dc = new DesCrypt();\t$iccid = $dc->en('981818','sunnada0');//调用DesCrypt的en方法,加密\t$iccid = strtoupper($iccid);//字符串转换为大写echo $iccid.'<br/>';}if($type == \"4\"){\tinsertTrueName('13146033307','段士辉','411503198903243012','北京市昌平区史各庄镇西半壁');}/****检测手机号是否允许实名*/function checkUnicomNum($tel,$deviceid){\t $url = \"**.**.**.**:8090\";\t$dc = new DesCrypt();\t$ks = $dc->en($tel,'qwertyui');\t$ks = strtoupper($ks);\t\t$s='<SOAP-ENV:Envelope xmlns:xsi=\"http://**.**.**.**/2001/XMLSchema-instance\"xmlns:xsd=\"http://**.**.**.**/2001/XMLSchema\"xmlns:SOAP-ENC=\"http://**.**.**.**/soap/encoding/\"xmlns:SOAP-ENV=\"http://**.**.**.**/soap/envelope/\"xmlns:ns=\"urn:SmsWBS\"><SOAP-ENV:Body><ns:checkTelphone><deviceID>3567080483013190</deviceID><communicaID>FFFF</communicaID><agentId>80B73E3132818FFF3FC989A755DCABDF</agentId><telplone>'\t.$ks.'</telplone><versionCode>1.1</versionCode><versionName>1.0</versionName><clientType>01</clientType></ns:checkTelphone></SOAP-ENV:Body></SOAP-ENV:Envelope>';\t//$s = '<SOAP-ENV:Envelope xmlns:xsi=\"http://**.**.**.**/2001/XMLSchema-instance\"xmlns:xsd=\"http://**.**.**.**/2001/XMLSchema\"xmlns:SOAP-ENC=\"http://**.**.**.**/soap/encoding/\"xmlns:SOAP-ENV=\"http://**.**.**.**/soap/envelope/\"xmlns:ns=\"urn:SmsWBS\"><SOAP-ENV:Body><ns:checkTelphone><deviceID>3567080483013190</deviceID><communicaID>FFFF</communicaID><agentId>935CE99C05CE8E1DE04C47F38CAC04A6</agentId><telplone>'.$ks.'</telplone><versionCode>1.1</versionCode><versionName>1.0</versionName><clientType>01</clientType></ns:checkTelphone></SOAP-ENV:Body></SOAP-ENV:Envelope>';\t//echo print($s);\t$curl = curl_init($url);    curl_setopt($curl, CURLOPT_HEADER, 0);    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);    curl_setopt($curl, CURLOPT_POST, true);    curl_setopt($curl, CURLOPT_POSTFIELDS, $s);    $responseText = curl_exec($curl);\t\tcurl_close($curl);\t//echo $responseText;\t//print(json_encode(array(\"result\"=>'success',\"communicaID\"=>'0000')));\tif(strpos($responseText,\"<tradeState>0000</tradeState>\")>0){\t\t$ret = 'success';\t\t$start =  strpos($responseText,\"<communicaID>\");\t\t$end = strpos($responseText,\"</communicaID>\");\t\t$communicaIDStr = substr($responseText,$start+13,$end-$start-13);//获取communicaID\t\tprint(json_encode(array(\"result\"=>$ret,\"communicaID\"=>$communicaIDStr)));\t\treturn;\t\t}else{\t\t\t\t$start =  strpos($responseText,\"<description>\");\t\t$end = strpos($responseText,\"</description>\");\t\t$ret = substr($responseText,$start+13,$end-$start-13);\t\tprint(json_encode(array(\"result\"=>$ret)));\t\treturn;\t}\t//echo \"\\n\";\t//echo $responseText;        return;}/****根据uccid获取手机号*/function getUnicomNum($iccid,$deviceid){\t$url = \"**.**.**.**:8090\";\t$dc = new DesCrypt();\t$iccid = $dc->en($iccid,'sunnada0');//调用DesCrypt的en方法,加密\t$iccid = strtoupper($iccid);//字符串转换为大写\t//echo $iccid.\"<br/>\";\t$s = '<SOAP-ENV:Envelope xmlns:xsi=\"http://**.**.**.**/2001/XMLSchema-instance\"xmlns:xsd=\"http://**.**.**.**/2001/XMLSchema\"xmlns:SOAP-ENC=\"http://**.**.**.**/soap/encoding/\"xmlns:SOAP-ENV=\"http://**.**.**.**/soap/envelope/\"xmlns:ns=\"urn:SmsWBS\"><SOAP-ENV:Body><ns:NetCardFind><deviceID>3567080483013190</deviceID><communicaID>FFFF</communicaID><agentId>859381E3E0D4BE3EDB10018AD702FFA9</agentId><iccidnumber>'.$iccid.'</iccidnumber><versionName>1.0</versionName><clientType>01</clientType></ns:NetCardFind></SOAP-ENV:Body></SOAP-ENV:Envelope>';\t//$s = '<SOAP-ENV:Envelope xmlns:xsi=\"http://**.**.**.**/2001/XMLSchema-instance\"xmlns:xsd=\"http://**.**.**.**/2001/XMLSchema\"xmlns:SOAP-ENC=\"http://**.**.**.**/soap/encoding/\"xmlns:SOAP-ENV=\"http://**.**.**.**/soap/envelope/\"xmlns:ns=\"urn:SmsWBS\"><SOAP-ENV:Body><ns:NetCardFind><deviceID>3567080483013190</deviceID><communicaID>FFFF</communicaID><agentId>ADA658DD7BCD302965607BBFEE530EEC</agentId><iccidnumber>'.$iccid.'</iccidnumber><versionName>1.0</versionName><clientType>01</clientType></ns:NetCardFind></SOAP-ENV:Body></SOAP-ENV:Envelope>';\t//echo $s;\t$curl = curl_init($url);    curl_setopt($curl, CURLOPT_HEADER, 0);    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);    curl_setopt($curl, CURLOPT_POST, true);    curl_setopt($curl, CURLOPT_POSTFIELDS, $s);    $s = curl_exec($curl);\t//echo $s.'<br />';    curl_close($curl);\t\t$start =  strpos($s,\"<cardnumber>\");//返回字符串<cardnumber>在另一个字符串$s中第一次出现的位置。\t$end = strpos($s,\"</cardnumber>\");\t//echo $start.'<br />';\t//echo $end.'<br />';\t\t$num = '';\tif( $start>0 && $end>0&&($end-$start-12)>0 ){\t\t\t$ret = substr($s,$start+12,$end-$start-12);\t\t//echo $ret.'<br />';\t\t$dc = new DesCrypt();\t\t$num = $dc->de( strtolower($ret),'sunnada0' );\t\t$num = trim($num);\t}\t\t//echo $num;\treturn $num;}/****提交实名认证信息*/function submitUnicomNum($tel,$name,$num,$addr,$communicaID,$UID,$deviceid){\t$url = \"**.**.**.**:8090\";\t$telTemp = $tel;\t$nameTemp = $name;\t$numTemp = $num;\t$addrTemp = $addr;\t$dc = new DesCrypt();\t$telplone = $dc->en($tel,'qwertyui' );//访问dc对象里边的en方法，并把返回值复制给telphone变量\t$telplone = strtoupper($telplone);\t\t$name = $dc->en(iconv('utf-8','gbk',$name),'qwertyui');//iconv('utf-8','gbk//IGNORE',$name),'qwertyui' \t$name = strtoupper($name);\t$num = $dc->en($num,'qwertyui' );\t$num = strtoupper($num);\t$addr = $dc->en(iconv('utf-8','gbk',$addr),'qwertyui' );//iconv('utf-8','gbk//IGNORE',$addr)\t$addr = strtoupper($addr);\t\t$s = '<SOAP-ENV:Envelope xmlns:xsi=\"http://**.**.**.**/2001/XMLSchema-instance\"xmlns:xsd=\"http://**.**.**.**/2001/XMLSchema\"xmlns:SOAP-ENC=\"http://**.**.**.**/soap/encoding/\"xmlns:SOAP-ENV=\"http://**.**.**.**/soap/envelope/\"xmlns:ns=\"urn:SmsWBS\"><SOAP-ENV:Body><ns:uploadCertificateInfo><deviceID>3567080483013190</deviceID><communicaID>'.$communicaID.'</communicaID><agentId>80B73E3132818FFF3FC989A755DCABDF</agentId>'.\t'<telplone>'.$telplone.'</telplone>'.\t'<certificateName>'.$name.'</certificateName>'.\t'<certificateType>8D1B6F7327986F7F</certificateType>'.\t'<certificateNum>'.$num.'</certificateNum>'.\t'<certificateAdd>'.$addr.'</certificateAdd>'.\t'<clientType>01</clientType></ns:uploadCertificateInfo></SOAP-ENV:Body></SOAP-ENV:Envelope>';\t\t//echo $s;\t\t $curl = curl_init($url);//// 创建一个新cURL资源\t// 设置URL和相应的选项\t\t    curl_setopt($curl, CURLOPT_HEADER, 0);    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);    curl_setopt($curl, CURLOPT_POST, true);    curl_setopt($curl, CURLOPT_POSTFIELDS, $s);    $responseText = curl_exec($curl);// 抓取URL并把它传递给浏览器\t// 关闭cURL资源，并且释放系统资源    curl_close($curl);\techo $responseText;\t/* if(strpos($responseText,\"<tradeState>0000</tradeState>\")>0){\t\t$ret = 'success';\t\t\t\tinsertTrueName($telTemp,$nameTemp,$numTemp,$addrTemp,$UID);\t\tprint(json_encode(array(\"result\"=>$ret)));\t\treturn;\t\t}else{\t\t\t\t$start =  strpos($responseText,\"<description>\");\t\t$end = strpos($responseText,\"</description>\");\t\t$ret = substr($responseText,$start+13,$end-$start-13);\t\tprint(json_encode(array(\"result\"=>$ret)));\t\treturn;\t} */    }function insertTrueName($tel,$name,$num,$addr,$UID){\t//Connect to database\tmysql_connect('localhost', 'root', 'mysql');\t//Select database\tini_set(\"error_reporting\",E_ALL ^ E_NOTICE);\tmysql_select_db('hoorayos');\tmysql_query(\"SET NAMES 'utf8'\"); \tmysql_query(\"SET CHARACTER_SET_CLIENT=utf8\"); \tmysql_query(\"SET CHARACTER_SET_RESULTS=utf8\");\t$query = \"INSERT INTO tb_truename(tel,name,number,address,datetime,user_id) VALUES ('$tel','$name','$num','$addr',now(),'$UID')\";\t//echo $query;\t//Insert\tmysql_query($query);}class DesCrypt{     var $key   = 'qwertyui';     var $deviceid   = '';     var $user   = '';     var $lsh   = '';     var $cipherText = '';     var $HcipherText = '';     var $decrypted_data ='';      function DesCrypt(){     }     //加密     //加密     function en($str,$key=\"\")     {\t\t $k = $this->key;\t\t if( strlen($key)>0 ){\t\t\t$k = $key;\t\t }         $cipher = mcrypt_module_open(MCRYPT_DES, '', MCRYPT_MODE_ECB, '');         $iv     = mcrypt_create_iv(mcrypt_get_iv_size(MCRYPT_DES,MCRYPT_MODE_ECB), MCRYPT_RAND);          if (mcrypt_generic_init($cipher, substr($k,0,8), $iv) != -1)         {             $this->cipherText = mcrypt_generic($cipher,$this->pad($str));             mcrypt_generic_deinit($cipher);             $this->HcipherText=bin2hex($this->cipherText);         \t\t//printf(\"<p>3DES HexEncrypted:\\n%s</p>\",$this->HcipherText);         }         mcrypt_module_close($cipher);         return $this->HcipherText;     }   //解密     function de($str , $key=\"\")     {\t\t $k = $this->key;\t\t if( strlen($key)>0 ){\t\t\t$k = $key;\t\t }         $str    = pack('H*', $str);         $cipher = mcrypt_module_open(MCRYPT_DES, '', MCRYPT_MODE_ECB, '');         $iv     = mcrypt_create_iv(mcrypt_get_iv_size(MCRYPT_DES,MCRYPT_MODE_ECB), MCRYPT_RAND);         if (mcrypt_generic_init($cipher, substr($k,0,8), $iv) != -1)         {             $this->decrypted_data = mdecrypt_generic($cipher,$str);             mcrypt_generic_deinit($cipher);         }         mcrypt_module_close($cipher);\t\treturn  $this->decrypted_data;         //return $this->unpad($this->decrypted_data);     }      private function pad ($data)     {         $data = str_replace(\"\\n\",\"\",$data);         $data = str_replace(\"\\t\",\"\",$data);         $data = str_replace(\"\\r\",\"\",$data);         return $data;     }      private function unpad ($text)     {         $pad = ord($text{strlen($text) - 1});         if ($pad > strlen($text)) {             return false;         }         if (strspn($text, chr($pad), strlen($text) - $pad) != $pad) {             return false;         }         return substr($text, 0, - 1 * $pad);      } }; ?>\n   漏洞证明：  \n\n   修复方案：  你懂   版权声明：转载请注明来源 风情万种@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2016-01-08 17:30 厂商回复： CNVD确认并复现所述情况,已经转由CNCERT向中国联通集团公司通报,由其后续协调网站管理部门处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}