{"id": 2432, "wybug_id": "wooyun-2014-060037", "wybug_title": "74CMS存储型XSS跨进后台可GetShell", "wybug_corp": "74c,s.com", "wybug_author": "xfkxfk", "wybug_date": "2014-05-09 16:06", "wybug_open_date": "2014-08-04 16:08", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "第三方不可信程序", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-14：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-04：\t细节向公众公开  简要描述： ~~ 详细说明：  1、先来看存储型XSS跨进后台在申请链接处，文件/link/add_link.php\nelseif ($act==\"save\"){\t\t$captcha=get_cache('captcha');\t$postcaptcha = trim($_POST['postcaptcha']);\tif($captcha['verify_link']=='1' && empty($postcaptcha))\t{\t\tshowmsg(\"请填写验证码\",1); \t}\tif ($captcha['verify_link']=='1' &&  strcasecmp($_SESSION['imageCaptcha_content'],$postcaptcha)!=0)\t{\t\tshowmsg(\"验证码错误\",1);\t}\tif ($_CFG['app_link']<>\"1\")\t{\tshowmsg('已停止自助申请链接，请联系网站管理员！',1);\t}\telse\t{\t$setsqlarr['link_name']=trim($_POST['link_name'])?trim($_POST['link_name']):showmsg('您没有填写标题！',1);\t$setsqlarr['link_url']=trim($_POST['link_url'])?trim($_POST['link_url']):showmsg('您没有填写链接地址！',1);\t$setsqlarr['link_logo']=trim($_POST['link_logo']);\t$setsqlarr['app_notes']=trim($_POST['app_notes']);\t$setsqlarr['alias']=trim($_POST['alias']);\t$setsqlarr['display']=2;\t$setsqlarr['type_id']=2;\t$link[0]['text'] = \"返回网站首页\";\t$link[0]['href'] =$_CFG['site_dir'];\t!inserttable(table('link'),$setsqlarr)?showmsg(\"添加失败！\",0):showmsg(\"添加成功，请等待管理员审核！\",2,$link);\t}}\n对链接信息没有过滤直接进入数据库。在后台显示时，文件/admin/admin_link.phpif($act == 'list'){\tget_token();\tcheck_permissions($_SESSION['admin_purview'],\"link_show\");\trequire_once(QISHI_ROOT_PATH.'include/page.class.php');\t$oederbysql=\" order BY l.show_order DESC\";\t$key=isset($_GET['key'])?trim($_GET['key']):\"\";\t$key_type=isset($_GET['key_type'])?intval($_GET['key_type']):\"\";\tif ($key && $key_type>0)\t{ \t\tif     ($key_type===1)$wheresql=\" WHERE l.link_name like '%{$key}%'\";\t\telseif ($key_type===2)$wheresql=\" WHERE l.link_url like '%{$key}%'\";\t}\telse\t{\t!empty($_GET['alias'])? $wheresqlarr['l.alias']=trim($_GET['alias']):'';\t!empty($_GET['type_id'])? $wheresqlarr['l.type_id']=intval($_GET['type_id']):'';\tif (is_array($wheresqlarr)) $wheresql=wheresql($wheresqlarr);\t}\t\tif ($_CFG['subsite']==\"1\" && $_CFG['subsite_filter_links']==\"1\")\t\t{\t\t\t$wheresql.=empty($wheresql)?\" WHERE \":\" AND \";\t\t\t$wheresql.=\" (l.subsite_id=0 OR l.subsite_id=\".intval($_CFG['subsite_id']).\") \";\t\t}\t$joinsql=\" LEFT JOIN \".table('link_category').\" AS c ON l.alias=c.c_alias  \";\t$total_sql=\"SELECT COUNT(*) AS num FROM \".table('link').\" AS l \".$joinsql.$wheresql;\t$page = new page(array('total'=>$db->get_total($total_sql), 'perpage'=>$perpage));\t$currenpage=$page->nowindex;\t$offset=($currenpage-1)*$perpage;\t$link = get_links($offset, $perpage,$joinsql.$wheresql.$oederbysql);\t$smarty->assign('link',$link);\t$smarty->assign('page',$page->show(3));\t$smarty->assign('upfiles_dir',$upfiles_dir);\t$smarty->assign('get_link_category',get_link_category());\t$smarty->assign('navlabel',\"list\");\t$smarty->display('link/admin_link.htm');}看看get_link函数：\nfunction get_links($offset, $perpage, $get_sql= ''){\tglobal $db;\t$row_arr = array();\t$limit=\" LIMIT \".$offset.','.$perpage;\t$result = $db->query(\"SELECT l.*,c.categoryname FROM \".table('link').\" AS l \".$get_sql.$limit);\twhile($row = $db->fetch_array($result))\t{\t$row_arr[] = $row;\t}\treturn $row_arr;\t}\n直接取出显示，没有过滤，导致xss。我们来申请链接：http://localhost/74cms/link/add_link.php\n\n后台管理员查看申请链接时：http://localhost/74cms/admin/admin_index.php\n\n2、后台GetShell我们首先可以在前台上传一个头像jpg文件，文件内容:\n<?php phpinfo();?>\n上传后的文件路径为：http://localhost/74cms/user/personal/personal_index.php查看头像属性：\n\n通过第一步拿到的cookie登陆后台。后台工具——计划任务——添加任务：任务脚本就填我们上传的头像图片路径：../../data/avatar/100/2014/05/09/1.jpg然后提交即可。此时在网站首页刷新页面，得到结果：\n\n3、总结通过上面的XSS和后台的GetShell我们可以全部自动化，由于后台有csrf防御，我们可以先通过xss获取到后天的csrftoken，然后构造getshell的js文件，在来一次xss就搞定了。   漏洞证明：  见详细说明。   修复方案：  过滤啊   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-04 16:08 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}