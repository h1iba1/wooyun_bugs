{"id": 43483, "wybug_id": "wooyun-2014-082599", "wybug_title": "php云人才系统csrf防护不当可刷钱", "wybug_corp": "php云人才系统", "wybug_author": "JJ Fly", "wybug_date": "2014-11-11 15:06", "wybug_open_date": "2015-02-09 15:08", "wybug_type": "CSRF", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-09：\t细节向公众公开  简要描述： php云人才系统csrf防护不当可刷钱 详细说明：  搜索了下$_SESSION['pytoken']一个有两个函数进行了调用 如下\nfunction admin(){\t\t$r=$this->obj->get_admin_user_shell();\t\t$this->registrs(); \t\tif($_POST){\t\t\tif($_POST['pytoken']!=$_SESSION['pytoken']){\t\t\t\tunset($_POST['pytoken']);\t\t\t\t$this->obj->ACT_layer_msg(\"来源地址非法！\",3,$this->config['sy_weburl']);\t\t\t}\t\t}\t\tif(!$_SESSION['pytoken']){\t\t\t$_SESSION['pytoken'] = substr(md5(uniqid().$_SESSION['auid'].$_SESSION['ausername'].$_SESSION['ashell']), 8, 12);\t\t}\t\t$this->yunset('pytoken',$_SESSION['pytoken']);\t}\tfunction check_token(){\t\tif($_SESSION['pytoken']!=$_GET['pytoken'] || !$_SESSION['pytoken'])\t\t{\t\t\tunset($_SESSION['pytoken']);\t\t\t$this->obj->ACT_layer_msg(\"来源地址非法！\",8,'index.php');\t\t\texit();\t\t}\t}\nadmin这个函数 只进行判断 是不是有post这样的话 如果get提交数据  便不会检测token。再就是后台手动完成订单的地方，没有调用check_token这个函数\nfunction setpay_action(){\t\t$del=(int)$_GET[\"id\"];\t\t$row=$this->obj->DB_select_once(\"company_order\",\"`id`='$del'\");\t\tif($row[\"order_state\"]==1||$row[\"order_state\"]==3){\t\t\t$nid=$this->upuser_statis($row);\t\t\tisset($nid)?$this->layer_msg(\"充值记录(ID:\".$del.\")确认成功！\",9):$this->layer_msg(\"确认失败,请销后再试！\",8);\t\t}else{\t\t\t$this->layer_msg(\"订单已确认，请勿重复操作！\",8);\t\t}\t}\n   漏洞证明：  1.我们先来下个订单\n\n然后在充值记录生成如下\n\n然后去看下去付款的连接为http://localhost/phpyun/member/index.php?c=payment&id=1可以知道 充值记录的id为12.后台中\n\n抓包如下\n\n我们知道没有进行防护So 我们可以构造出来这样一个urllocalhost/phpyun/admin/index.php?m=company_order&c=setpay&id=1然后让管理员进行访问就可以了。3.下面我们把这个url插到企业信息这个页面然后就等管理员维护企业的时候上钩了，如果着急的话 可以尝试社工\n\n这样 我们便充值成功了\n\n   修复方案：  另外知名企业那也没有防护，其他的地方，希望你们也能检查下。   版权声明：转载请注明来源 JJ Fly@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-11-11 15:08 厂商回复： 感谢您的提供，我们会尽快修复并全面检查！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}