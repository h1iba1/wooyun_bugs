{"id": 72026, "wybug_id": "wooyun-2015-0151191", "wybug_title": "万达集团某重要系统从SQL注入到系统命令执行再到域漫游", "wybug_corp": "大连万达集团股份有限公司", "wybug_author": "路人甲", "wybug_date": "2015-11-02 08:51", "wybug_open_date": "2015-12-17 09:18", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 详细过程：SQL注入->服务器管理员权限->域管理权限 详细说明：  一、SQL注入检测万达集团某APP时，发现以下地方存在注入：（POST中的groupCode，stacked queries和布尔盲注）\nPOST /hotelprocess/hotel/hotelList.action HTTP/1.1Content-Length: 87Content-Type: application/x-www-form-urlencodedX-Requested-With: XMLHttpRequestReferer: http://app.wandahotels.com/hotelprocess/hotel/hotelList.actionCookie: JSESSIONID=27C5851C2AB17BA654E8BF2B1FB31B19Host: app.wandahotels.comConnection: Keep-aliveAccept-Encoding: gzip,deflateUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.21 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.21Accept: */*cityCode=BJS&groupCode=1&language=zh\n1、SQLMap漏洞证明\n\n2、查看当前数据库用户，居然是sa！检测了下，果然是dba~~\n\n\n\n3、列出所有数据库，共14个\n\n4、不妨看下当前库ECRS的表，共493个\n\n二、服务器本地管理权限获取刚才看了当前数据库用户是sa，是dba，不妨执行下系统命令看看系统权限。通过注入可获知系统环境为：Windows + MSSQL 2008 + JSP于是通过SQLMAP的--os-shell，其原理为打开MSSQL的cmdshell模块，并在当前库中创建临时表sqlmapoutput，进而将执行命令时返回的结果存储在此表中，然后通过SQL查询返回给SQLMAP；这里碰到一个问题，能使用--os-shell的只有stacked queries和UNION QUERY两种注入类型，此处注入只有stacked queries，而没有UNION QUERY，stacked queries是通过枚举+延时来进行判断的，所以返回结果时巨慢！！！后来想了个办法，由于本处注入还有布尔盲注，因此先通过stacked queries进行命令执行，然后通过布尔盲注dump当前库的sqlmapoutput表中的数据，这样速度就快多了，因为布尔盲注不依靠延时，而且可以多线程，即：命令执行(sqlmap)：\n--os-shell --technique=S\n命令结果查看(sqlmap)：\n--technique=B --threads=10 -D \"ECRS\" -T \"sqlmapoutput\" -C \"data\" --dump\n于是执行了以下命令：1、确定MSSQL在系统中的权限，也就是我们在系统中的权限，默认安装时MSSQL服务会以SYSTEM权限运行，相应权限也就是system~但认真的管理员在安装时会对其进行降权，比如降权到NETWORK SERVICE或新建一个IWAM账户等，此时我们可以通过执行whoami命令来确定。发现返回是wanda\\amadmin，非系统默认账户，此时我们得再运行命令去进一步确定我们的权限。\n\n2、为了确定wanda\\amadmin的权限，我们可以运行net user amadmin来查看。但是这个命令会有多行大量的结果，比较耗时，于是我选择了运行net localgroup administrators，直接查看本地管理员组的成员，发现我们的wanda\\amadmin也在其中，因此可确定我们已是系统的管理员。可执行任意命令。\n\n3、由于通过sqlmap来执行shell实在太慢了，虽然有布尔盲注辅助返回。于是我想getshell执行命令来提高返回速度，但是后来看了下，发现这台只是一台数据库服务器，与web服务器分离，并没开放web服务；于是我改为查看一些系统网络环境，如本地IP，但发现都是内网的……（ipconfig）\n\n于是我又查看了本地开放的端口（netstat /an）\n\n但貌似没啥用，服务器估计是在内网，反弹不出来，也进不去……但是，目前已经完全控制此服务器了，可执行任意命令。三、域漫游由于刚才看administrators组成员时，看到一个叫做WANDA\\Domain Admins的，所以推测此服务器在WANDA域中，于是我们不妨执行些域命令来探测下。首先，查看域管理员\nnet group \"domain admins\" /domain\n\n\n我们貌似不是域管理员哦~~但是只要域管理员登陆过本服务器，我们就可以用工具拿到他密码了~~不过速度是在慢得难受，同时也考虑到企业安全，就没继续深入了；比如我们还可以看看我们在域中的身份和所属的组及其权限\nnet user wxadmin /domain\n当然，还可以继续查看域成员\nnet user /domain\n不过估计很多~~又是好久好久了~~今天先搞到这里吧~虽然还有很多……   漏洞证明：     修复方案：  请多指教~~   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-11-02 09:17 厂商回复： 感谢路人甲同学的关注与贡献！马上通知业务整改！请私信留Q联系，谢谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-11-02 08:58 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1394 漏洞数:123        | 收wb   1：5 无限量收   [平台担保])\t\t \n  超级严重的mark    \n     2015-11-02 09:02 |    \t\t高小厨 \t\t\t( 普通白帽子  |\t\t\t        Rank:874 漏洞数:79        | 不会吹牛的小二不是好厨子！)\t\t \n  这两天万达的洞好多啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}