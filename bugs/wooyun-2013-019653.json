{"id": 13348, "wybug_id": "wooyun-2013-019653", "wybug_title": "康基自动售水机储值卡任意修改余额", "wybug_corp": "康基", "wybug_author": "larblue", "wybug_date": "2013-03-07 09:52", "wybug_open_date": "2013-04-21 09:53", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["一卡通", "会员卡", "康基"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-03-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-04-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-04-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-04-21：\t细节向公众公开  简要描述： 康基售水机储值卡存在设计漏洞，扇区加密简单，储值金额明码表示，没有对账机制容易篡改。 详细说明：  康基等靠M1卡为储值载体的会员卡基本都有此类漏洞通过对卡数据dump，发现该卡使用了第2、3扇区的第一条数据，并对扇区访问密码做了一卡一密。两个扇区的密码相同。其他未利用扇区的密码默认为FF FF FF FF FF FF ，其中一个漏洞是加密扇区的KeyA是根据卡UID经过一系列算法加密过，而KeyB是简单的00 00 00 00 00 00.如果要对卡内余额等进行修改知道这个KeyB已经足够了。因为你除了不可以发卡以外其他的都可以做了。    下面分析数据，第二扇区的第一条数据为C0 D1 D2 06 06 00 00 00 02 00 00 00 00 00 00 00，通过对多张卡进行分析，发现此条数据为固定值，听有的用户反映该公司的售水机不能对不同代理商售出的水卡售水，怀疑此数据为代理商代码。    第三扇区的第一条数据为0X 0X 0X 0X 0X 0X 00 00 00 00 00 00 00 00 00 00,X为0-9的数字，总共为6位数，单位是分。本条数据是存储余额的内容，没有任何加密，假如你卡的余额是123.45元那么该条数据就是00 01 02 03 04 05 00 00 00 00 00 00 00 00 00 00。   下面说一下本卡的一卡一密算法，算法很简单。UID  9E FC 41 6E,KeyA 7B 1D D8 AB 1A 49,KeyB 00 00 00 00 00 00    密码的前四位加密算法相同，分别由UID的每一字节，16进制的0x119被减的值，再用0x100取余，例密码第一位0x7B=（0x119-0x9E）% 0x100,第五位是固定的0x1A，第六位是UID四字节逐个相加再用以0x100取余，例如第六位0x49= (0x9E+0xFC+0x41+0x6E)% 0x100。    知道一次一密算法就可以使用任何mf1k或者mf4k卡发卡了。   漏洞证明：  看懂的人可以自己用一张M1卡按照我说的办法自制一张卡测试即可。   修复方案：  1，对储值扇区采用更高级别的加密方式，而不是这种简单的可逆方式2，对储值数据采用防篡改校验值MAC，并且根据卡UID和交易时间随机生成，一次一密只要本次交易结束，交易结果运算的余额和校验值相互绑定，实现防篡改3，使用CPU卡，升级成本较大，其实合理的逻辑可以不使用CPU卡，也可以达到相同的安全等级4.使用对账机制，防止篡改，升级代价较大，以后出的新机型可以考虑   版权声明：转载请注明来源 larblue@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2013-03-12 08:14 厂商回复： CNVD暂未复现，不过将按照所述情况尝试进行协调处置。对于不具备计算能力（或者说仅具备固定逻辑处理能力）的IC卡，存在此类破解可能。rank 16 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-03-07 11:21 |    \t\tsmallworm \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:4        | ...)\t\t \n  小区有这种售水机 ，做等公开    \n     2013-03-07 18:30 |    \t\t无敌L.t.H \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | ‮……肉肉捉活，亭长放解)\t\t \n  我们这是投币的……    \n     2013-03-07 22:15 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  售水机？·····一天可以喝多少水啊……全家都送，不错哦，嘿嘿    \n     2013-03-08 09:57 |    \t\txsleaf \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:5        | 探索无尽的网海~)\t\t \n  小区不是这个牌子的售水机，用的是带芯片的IC卡，有戏嚒？    \n     2013-03-08 15:20 |    \t\tlarblue \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:1        )\t\t \n  @xsleaf 99%的自动售水机有此漏洞，有的甚至加密比这个还要简单    \n     2013-03-09 14:22 |    \t\txsleaf \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:5        | 探索无尽的网海~)\t\t \n  @larblue 坐等公开~~~~    \n     2013-03-12 09:36 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  坐等公开    \n     2013-03-12 12:16 |    \t\t北洋贱队 \t\t\t( 普通白帽子  |\t\t\t        Rank:252 漏洞数:25        )\t\t \n  你一天能喝多少水    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}