{"id": 29137, "wybug_id": "wooyun-2015-0120357", "wybug_title": "某通用型公共安全系统漏洞合集", "wybug_corp": "公安部一所", "wybug_author": "路人甲", "wybug_date": "2015-06-15 11:38", "wybug_open_date": "2015-09-18 11:41", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(公安部一所)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-20：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-18：\t细节向公众公开  简要描述： 参考pandas前辈提交的漏洞，获得测试案例。http://www.wooyun.org/bugs/wooyun-2010-0100874 详细说明：  测试案例请看 WooYun: 多市公共安全系统Getshell漏洞（通用） 一. 任意文件读取\n漏洞文件：viewcode.phpif ( $iid ){ \t...\telse if ( $iid && $catid )\t{\t\t$str = file_get_contents( ROOT_PATH.\"config/moban/\".$catid.\"/\".$iid.\".php\" );\t}}echo \"<textarea style=\\\"width:500px; height:400px;\\\">\";echo htmlspecialchars( $str ); echo \"</textarea>\";?>\necho htmlspecialchars( $str ); 此处将文件内容html转义后输出，造成任意文件读取，exp详见测试代码区。二. Getshell\n漏洞文件：design/catid_user_save.phpinclude '../common.php';//引入伪全局变量注册机制$a=stripslashes($atc_content); //变量a删除反斜杠//$source=repairhtml($a);$source=$a;…else{\tif (file_exists(ROOT_PATH.'mod/sns/parse/'.$type.'.php')){\t\tinclude ROOT_PATH.'mod/sns/parse/'.$type.'.php';\t}\t\t$r_url=ROOT_URL.'/';\t//便于模板的移植性\t$source=str_replace($r_url,'',$source);\t$content=str_replace($r_url,'',$content);\t\twritefile(SITE_CACHE.'/themes/table_'.$catid.'_'.$type.'_s.php',$source);//漏洞产生，\twritefile(SITE_CACHE.'/themes/table_'.$catid.'_'.$type.'.php',$content);//同上}?>\nwritefile函数实则为file_put_contents方法，直接写入webshell，exp详见测试代码区。三.任意文件删除\n漏洞文件：del_mod.phpdefine( \"ROOT_PATH\", str_replace( \"del_mod.php\", \"\", str_replace( \"\\\\\", \"/\", __FILE__ ) ) );$delid = $_POST['delid'];$fid = $_POST['fid'];$siteid = $_POST['siteid'];$md = $_POST['md'];if ( empty( $md ) ){\t\texit( \"4\" );}$temp = md5( $siteid.\"&@#\" );$temp = substr( $temp, 2, 10 );if ( $md != $temp ){\t\texit( \"5\" );}define( \"ROOT_PATH\", str_replace( \"del_mod.php\", \"\", str_replace( \"\\\\\", \"/\", __FILE__ ) ) );define( SITE_CACHE, ROOT_PATH.\"../website/\".$siteid );if ( file_exists( SITE_CACHE.\"/themes/\".$delid.\".php\" ) ){\t\t@unlink( SITE_CACHE.\"/themes/\".$delid.\".php\" );\ndelid可通过伪全局变量来传递，完全可控造成了任意php文件删除。只是需要根据删除的文件名来动态构造md的值才能删除成功，具体可以看测试代码区的exp。   漏洞证明：  一. 任意文件读取证明\n\n二. Getshell写入phpinfo来证明：\n\n\n\n   修复方案：  应该要过滤严格一点   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-09-18 11:41 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}