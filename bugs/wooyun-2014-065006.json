{"id": 54266, "wybug_id": "wooyun-2014-065006", "wybug_title": "CUUMALL 注入 5-8", "wybug_corp": "cuumall.com", "wybug_author": "′雨。", "wybug_date": "2014-06-17 14:57", "wybug_open_date": "2014-09-15 14:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向公众公开  简要描述： 来了个新厂商。 挖一下把。    开放+封闭源代码封闭源代码，普通用户使用加密后的代码，付费用户使用开放的源代码，使商城更安全对于我这种屌丝只能用免费版 就是zend后的代码。不过还是有几个文件没zend。 就只看这几个文件了。 详细说明：  第五处kuaiqian/receive_mall.php中\n$dealTime=trim($_REQUEST['dealTime']);//获取实际支付金额///单位为分///比方 2 ，代表0.02元$payAmount=trim($_REQUEST['payAmount']);//获取交易手续费///单位为分///比方 2 ，代表0.02元$fee=trim($_REQUEST['fee']);//获取扩展字段1$ext1=trim($_REQUEST['ext1']);//获取扩展字段2$ext2=trim($_REQUEST['ext2']);//获取处理结果///10代表 成功; 11代表 失败///00代表 下订单成功（仅对电话银行支付订单返回）;01代表 下订单失败（仅对电话银行支付订单返回）$payResult=trim($_REQUEST['payResult']);//获取错误代码///详细见文档错误代码列表$errCode=trim($_REQUEST['errCode']);//获取加密签名串$signMsg=trim($_REQUEST['signMsg']);//生成加密串。必须保持如下顺序。\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"merchantAcctId\",$merchantAcctId);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"version\",$version);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"language\",$language);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"signType\",$signType);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"payType\",$payType);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"bankId\",$bankId);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"orderId\",$orderId);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"orderTime\",$orderTime);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"orderAmount\",$orderAmount);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"dealId\",$dealId);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"bankDealId\",$bankDealId);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"dealTime\",$dealTime);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"payAmount\",$payAmount);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"fee\",$fee);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"ext1\",$ext1);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"ext2\",$ext2);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"payResult\",$payResult);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"errCode\",$errCode);\t$merchantSignMsgVal=appendParam($merchantSignMsgVal,\"key\",$key);$merchantSignMsg= md5($merchantSignMsgVal);//echo $merchantSignMsg;//初始化结果及地址$rtnOk=0;$rtnUrl=\"\"; define(\"_UL_\", $_SERVER['SERVER_NAME']);//商家进行数据处理，并跳转会商家显示支付结果的页面///首先进行签名字符串验证if(strtoupper($signMsg)==strtoupper($merchantSignMsg)){\tswitch($payResult){\t\t  \t\t  case \"10\":\t\t\t\t\t\t/* \t\t\t' 商户网站逻辑处理，比方更新订单支付状态为成功\t\t\t' 特别注意：只有strtoupper($signMsg)==strtoupper($merchantSignMsg)，且payResult=10，才表示支付成功！\t\t\t*/\t\t\t\t\tmysql_connect($arr[\"DB_HOST\"].\":\".$arr[\"DB_PORT\"],$arr[\"DB_USER\"],$arr[\"DB_PWD\"]);\t\t\tmysql_select_db($arr[\"DB_NAME\"]);\t\t\t$sql=\"update \".$arr[\"DB_PREFIX\"].\"m_pay set paystate=1,trade_no='\".$dealId.\"',payallmoney=payallmoney+paymoney,gettime='\".date('Y-m-d H:i:s').\"' where ordernum='\".$orderId.\"'\";\t\t\tmysql_query($sql);\t\t\t$sql3=\"select * from \".$arr[\"DB_PREFIX\"].\"m_pay where ordernum='\".$orderId.\"'\";\t\t\t$result=mysql_query($sql3);\t\t\t$rs=mysql_fetch_array($result);\t\t\t$sql2=\"update \".$arr[\"DB_PREFIX\"].\"m_member set money=money+\".$rs[\"paymoney\"].\" where username='\".$rs[\"username\"].\"'\";\t\t\tmysql_query($sql2);\n这个又是只验证了一下md5。。\n\n—————————————————————————————————————————第六处kuaiqian/receive_store.php中跟第五处一样的。不多说了。__________________________________________________________________________第七处  在tenpay/return_url.php中\n$resHandler = new PayResponseHandler();$resHandler->setKey($key);//判断签名if($resHandler->isTenpaySign()) {\t\t//交易单号\t$transaction_id = $resHandler->getParameter(\"transaction_id\");\t\t//金额,以分为单位\t$total_fee = $resHandler->getParameter(\"total_fee\");\t\t//支付结果\t$pay_result = $resHandler->getParameter(\"pay_result\");\t\t//商户交易号\t$sp_billno=$resHandler->getParameter(\"sp_billno\");\t\tif( \"0\" == $pay_result ) {\t\t\t//------------------------------\t\t//处理业务开始\t\t//------------------------------\t\t\t@mysql_connect($arr[\"DB_HOST\"].\":\".$arr[\"DB_PORT\"],$arr[\"DB_USER\"],$arr[\"DB_PWD\"]);\t\t\t@mysql_select_db($arr[\"DB_NAME\"]);\t\t\t$sql=\"select * from \".$arr[\"DB_PREFIX\"].\"m_pay where ordernum=\".$sp_billno;\t\t\t$result=mysql_query($sql);\t\t\t//--------\t\t\t$rss=mysql_fetch_array($result);\t\t\tif($rss[\"paystate\"]==0)\t\t\t{\t\t\t  $sql1=\"update \".$arr[\"DB_PREFIX\"].\"m_pay set trade_no='\".$transaction_id.\"',payallmoney=paymoney+payallmoney,gettime='\".date('Y-m-d H:i:s').\"',paystate=1 where ordernum='\".$sp_billno.\"'\";\t\t\t  mysql_query($sql1);\t\t\t  //-----\n用了个函数来验证 这个函数跟之前 验证alipay的那个基本一样。第八处 tenpay/return_stor_url.php\n\n   漏洞证明：  见上面。   修复方案：  对这些intval一次把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-17 15:31 厂商回复： 你上次提交的1-4和这个是一个类型的，都是支付接口没有添加禁用代码的问题，上次那个问题在这里补偿你了：） 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-17 15:22 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  本来两个是一起发的，    \n     2014-06-17 15:39 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:15        | Talk is cheap,show me the shell.)\t\t \n  @′  雨。 快钱接口的？    \n     2014-06-17 15:40 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:15        | Talk is cheap,show me the shell.)\t\t \n  @′  雨。 上次附件发过去了…第一个邮件是我2B了……    \n     2014-06-17 15:42 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @HackPanda  块钱  财付通，  嗯  之前在上课 也没怎么注意。   上周周末回家的时候才发现。   感谢哈。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}