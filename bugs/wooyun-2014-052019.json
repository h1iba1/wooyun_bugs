{"id": 4096, "wybug_id": "wooyun-2014-052019", "wybug_title": "phpcmsV9某sql注射漏洞", "wybug_corp": "phpcms", "wybug_author": "kobin97", "wybug_date": "2014-02-25 22:24", "wybug_open_date": "2014-05-23 22:25", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["字符类型注射", "注射技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-07：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-23：\t细节向公众公开  简要描述： 别人说最危险的地方最安全，我说最安全的地方最危险。。。相信你们也没有想到这个最常见，常常会在各种教程出现的地方会存在SQL注射。。。需 GPC OFF 详细说明：  首先，我们看登陆的地方。。最常见了吧。。。http://127.0.0.1/index.php?m=member&c=index&a=login默认安装情况下，会使有 V9自带的用户中心。phpcms\\modules\\member\\index.php\npublic function login() {\t\t$this->_session_start();\t\t//获取用户siteid\t\t$siteid = isset($_REQUEST['siteid']) && trim($_REQUEST['siteid']) ? intval($_REQUEST['siteid']) : 1;\t\t//定义站点id常量\t\tif (!defined('SITEID')) {\t\t   define('SITEID', $siteid);\t\t}\t\t\t\tif(isset($_POST['dosubmit'])) {\t\t\tif(empty($_SESSION['connectid'])) {\t\t\t\t//判断验证码\t\t\t\t$code = isset($_POST['code']) && trim($_POST['code']) ? trim($_POST['code']) : showmessage(L('input_code'), HTTP_REFERER);\t\t\t\tif ($_SESSION['code'] != strtolower($code)) {\t\t\t\t\tshowmessage(L('code_error'), HTTP_REFERER);\t\t\t\t}\t\t\t}\t\t\t\t\t\t$username = isset($_POST['username']) && trim($_POST['username']) ? trim($_POST['username']) : showmessage(L('username_empty'), HTTP_REFERER);\t\t\t$password = isset($_POST['password']) && trim($_POST['password']) ? trim($_POST['password']) : showmessage(L('password_empty'), HTTP_REFERER);\t\t\t$cookietime = intval($_POST['cookietime']);\t\t\t$synloginstr = ''; //同步登陆js代码\t\t\t\t\t\tif(pc_base::load_config('system', 'phpsso')) {\t\t\t\t$this->_init_phpsso();\t\t\t\t$status = $this->client->ps_member_login($username, $password);\t\t\t\t$memberinfo = unserialize($status);\n可以看到用户名密码交给了 $this->client->ps_member_login($username, $password);我们跟进。phpcms\\modules\\member\\classes\\client.class.php$return = $this->_ps_send('login', array('username'=>$username, 'password'=>$password));\nprivate function _ps_send($action, $data = null) { \t\treturn $this->_ps_post($this->ps_api_url.\"/index.php?m=phpsso&c=index&a=\".$action, 500000, $this->auth_data($data));\t}\n\npublic function auth_data($data) {\t\t$s = $sep = '';\t\tforeach($data as $k => $v) {\t\t\tif(is_array($v)) {\t\t\t\t$s2 = $sep2 = '';\t\t\t\tforeach($v as $k2 => $v2) {\t\t\t\t\t\t$s2 .= \"$sep2{$k}[$k2]=\".$this->_ps_stripslashes($v2);\t\t\t\t\t$sep2 = '&';\t\t\t\t}\t\t\t\t$s .= $sep.$s2;\t\t\t} else {\t\t\t\t$s .= \"$sep$k=\".$this->_ps_stripslashes($v);\t\t\t}\t\t\t$sep = '&';\t\t}\t\t$auth_s = 'v='.$this->ps_vsersion.'&appid='.APPID.'&data='.urlencode($this->sys_auth($s));\t\treturn $auth_s;\t}\n_ps_stripslashes\nprivate function _ps_stripslashes($string) {\t\t!defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());\t\tif(MAGIC_QUOTES_GPC) {\t\t\treturn stripslashes($string);\t\t} else {\t\t\treturn $string;\t\t}\t}\n还原了  GPC，传参数给 API。我们再看看 API 方的处理方式phpsso_server\\phpcms\\modules\\phpsso\\classes\\phpsso.class.php\nif(isset($_POST['data'])) {\t\t\tparse_str(sys_auth($_POST['data'], 'DECODE', $this->applist[$this->appid]['authkey']), $this->data);\t\t\t\t\t\t\t\tif(!is_array($this->data)) {\t\t\t\texit('0');\t\t\t}\t\t} else {\t\t\texit('0');\t\t}\nparse_str  函数默认是根据 GPC情况过滤。再到phpsso_server\\phpcms\\modules\\phpsso\\index.php\npublic function login() {\t\t$this->password = isset($this->data['password']) ? $this->data['password'] : '';\t\t$this->email = isset($this->data['email']) ? $this->data['email'] : '';\t\tif($this->email) {\t\t\t$userinfo = $this->db->get_one(array('email'=>$this->email));\t\t} else {\t\t\t$userinfo = $this->db->get_one(array('username'=>$this->username));\t\t}\nphpsso_server\\phpcms\\libs\\classes\\model.class.php\nfinal public function get_one($where = '', $data = '*', $order = '', $group = '') {\t\tif (is_array($where)) $where = $this->sqls($where);\t\treturn $this->db->get_one($data, $this->table_name, $where, $order, $group);\t}\n\n/**\t * 将数组转换为SQL语句\t * @param array $where 要生成的数组\t * @param string $font 连接串。\t */\tfinal public function sqls($where, $font = ' AND ') {\t\tif (is_array($where)) {\t\t\t$sql = '';\t\t\tforeach ($where as $key=>$val) {\t\t\t\t$sql .= $sql ? \" $font `$key` = '$val' \" : \" `$key` = '$val'\";\t\t\t}\t\t\treturn $sql;\t\t} else {\t\t\treturn $where;\t\t}\t}\n可以看到全程没有对字符串进行过滤。。。因此，在GPC为 OFF 时，存在SQL注入。可能没说清楚问题在那里两个： 1、auth_data 参数拼接2、api中没有对数据进行过滤可以做什么？盲注，任意用户登陆。。。其实还有很多利用的地方。。测试如下：   漏洞证明：  \n\n\n\n\n\n   修复方案：  过滤   版权声明：转载请注明来源 kobin97@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-05-23 22:25 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-25 22:29 |    \t\t爱上平顶山  \t\t\t( 核心白帽子 |\t\t\t        Rank:2738 漏洞数:547        | [不戴帽子]异乡过客.曾就职于天朝某机构.IT...)\t\t \n  000000000000000    \n     2014-02-25 22:32 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  11111111111111    \n     2014-02-25 22:50 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  2222222222222222222    \n     2014-02-25 22:55 |    \t\t乌云一哥 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:1        | echo file_get_contents('http://www.wooyu...)\t\t \n  3333333333333333    \n     2014-02-25 23:12 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  444444444444444444我们应该叫四爷？    \n     2014-02-25 23:26 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  555555555555555    \n     2014-02-25 23:32 |    \t\tMy5t3ry \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        )\t\t \n  6666666666这是什么节奏啊    \n     2014-02-25 23:33 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  7777777777777    \n     2014-02-26 07:41 |    \t\t银狼_avi \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:13        | 本屌十二岁破处)\t\t \n  8888888888888888    \n     2014-02-26 08:34 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  9999999999999999999999    \n     2014-02-26 09:35 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  1010101010101010101010101010101010这什么情况？    \n     2014-02-26 09:44 |    \t\t宇少 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:41        | Jyhack-TeaM：bbs.jyhack.com 群:308694453...)\t\t \n  靠，你又来。    \n     2014-02-26 10:35 |    \t\tWalle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:5        | ...   位卑、未敢忘忧国！   ...)\t\t \n  11111111111111111111111111111111111111111    \n     2014-03-11 18:14 |    \t\t黑色键盘 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 黑色键盘，指间的灵感。)\t\t \n  怎么个略过的节奏    \n     2014-03-17 10:00 |    \t\tkobin97  \t\t\t( 核心白帽子 |\t\t\t        Rank:1754 漏洞数:190        | 关注网络安全。。)\t\t \n  phpcms.cn 官网好像打不好了。。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}