{"id": 7475, "wybug_id": "wooyun-2013-037204", "wybug_title": "代码审计系列2:Simple Down 简单下载系统 v5.4 各种SQLi、XSS", "wybug_corp": "Simple Down", "wybug_author": "LaiX", "wybug_date": "2013-09-16 12:06", "wybug_open_date": "2013-12-15 12:06", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["数字类型注射", "安全意识不足", "源码审核", "注射漏洞利用技巧", "白盒测试", "后台验证绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-16：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2013-12-15：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 整个程序无任何过滤，满城尽是 SQLi 、  XSS。 详细说明：  1.拿到程序后，我们先来看看 登录页面。(login.php)先来看看管理登录页面(admin/adminlogin.php)的核心代码\n<?phpif(!isset($_POST['adminlogin'])){\techo \"<script type='text/javascript'>\";\techo \"document.title = '·Ç·¨·ÃÎÊ'\";\techo \"</script>\";\techo \"·Ç·¨·ÃÎÊ¡£3Ãëºó½«·µ»ØµÇÂ½Ò³Ãæ£¬Èç¹ûÄãµÄä¯ÀÀÆ÷²»Ö§³Ö×Ô¶¯Ìø×ª£¬Çëµã»÷&nbsp;<a href='index.php' style='color:green;'>ÕâÀï</a>\";\techo '<script type=\"text/javascript\">';\techo 'GoIndex()';\techo '</script>';\texit();}$username = strval($_POST['t_UserName']);$password = strval($_POST['t_UserPass']);$password = MD5($password);if($username != \"admin\"){\techo \"<script type='text/javascript'>\";\techo \"document.title = '¹ÜÀíÔ±ÕËºÅ´íÎó'\";\techo \"</script>\";\techo \"¹ÜÀíÔ±ÕËºÅ´íÎó¡£3Ãëºó½«·µ»ØµÇÂ½Ò³Ãæ£¬Èç¹ûÄãµÄä¯ÀÀÆ÷²»Ö§³Ö×Ô¶¯Ìø×ª£¬Çëµã»÷&nbsp;<a href='index.php' style='color:green;'>ÕâÀï</a>\";\techo '<script type=\"text/javascript\">';\techo 'GoIndex()';\techo '</script>';\texit();}$check_query = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_NAME = '$username' AND USER_PASS = '$password' LIMIT 1\");if($row = mysql_fetch_array($check_query)){    $_SESSION['username'] = $username;    $_SESSION['userid'] = $row['ID'];\techo '<script type=\"text/javascript\">';\techo \"AutoOpenURL('admin.php')\";\techo '</script>';\texit();} else{\techo \"<script type='text/javascript'>\";\techo \"document.title = '¹ÜÀíÔ±µÇÂ½Ê§°Ü'\";\techo \"</script>\";\techo \"¹ÜÀíÔ±µÇÂ½Ê§°Ü£¬Çë¼ì²éÕËºÅºÍÃÜÂëÊÇ·ñÕýÈ·¡£3Ãëºó½«·µ»ØµÇÂ½Ò³Ãæ£¬Èç¹ûÄãµÄä¯ÀÀÆ÷²»Ö§³Ö×Ô¶¯Ìø×ª£¬Çëµã»÷&nbsp;<a href='index.php' style='color:green;'>ÕâÀï</a>\";\techo '<script type=\"text/javascript\">';\techo 'GoIndex()';\techo '</script>';\texit();} \tmysql_free_result($result);mysql_close($conn);?>\n从\nif($username != \"admin\")\n 和 \n$password = MD5($password);\n这两句发现，似乎用户名只允许使用admin 并且密码被md5加密。现在似乎还无法绕过登录我们再来看看用户登录页面(login.php)的核心代码\n<?phprequire_once \"header.php\";if(!isset($_POST['login'])){\techo \"<script type='text/javascript'>\";\techo \"document.title = '非法访问'\";\techo \"</script>\";\techo \"非法访问。3秒后将返回登陆页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;如果您还没有账号可从&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;前往注册。\";\techo '<script type=\"text/javascript\">';\techo 'GoLogin()';\techo '</script>';\texit();}\t$username = strval($_POST['t_UserName']);\t$password = strval($_POST['t_UserPass']);\t$password = MD5($password);\t\t$check_query = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_NAME = '$username' AND USER_PASS = '$password' LIMIT 1\");\tif( $row = mysql_fetch_array( $check_query ) ){  //登录成功\t\t$_SESSION['username'] = $username;\t\t$_SESSION['userid'] = $row['ID'];\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '登陆成功'\";\t\techo \"</script>\";\t\techo \"用户登陆成功。3秒后将跳转到网站主首页，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='index.php' style='color:green;'>这里</a>&nbsp;返回首页。如果您还没有账号可从&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;前往注册。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoIndex()';\t\techo '</script>';\t}\telse\t{\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '登陆失败'\";\t\techo \"</script>\";\t\techo \"用户登陆失败。3秒后将返回登陆页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;如果您还没有账号可从&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;前往注册。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoLogin()';\t\techo '</script>';\t}?>\n这个页面出现了一个比较经典的语句\n$check_query = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_NAME = '$username' AND USER_PASS = '$password' LIMIT 1\");if( $row = mysql_fetch_array( $check_query ) ){  //登录成功\n这句SQL语句的意思是查询是否存在管理员，如果存在就提升权限。看了一下周围的代码，没有发现任何过滤。根据此SQL语句结构，我们构造一个\"万能密码\":\n\n进入服务器后就会变成：\n\"SELECT ID FROM HBDX_USERS WHERE USER_NAME = 'admin' # AND USER_PASS = '123456' LIMIT 1\"\n意为：查询目标表中是否存在admin用户名，而查询密码的语句已经被 # 所注释。登录一下果然进入了：\n\n\n\n2.再来看看注册页面。\n<?phprequire_once 'header.php';if(!isset($_POST['reg'])){\techo \"<script type='text/javascript'>\";\techo \"document.title = '非法访问'\";\techo \"</script>\";\techo \"非法访问1。3秒后将返回注册页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;如果您已经有账号可从&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;前往登陆。\";\techo '<script type=\"text/javascript\">';\techo 'GoReg()';\techo '</script>';\texit();}\t$username = strval($_POST['t_UserName']);\t$disname  = strval($_POST['iptNickName']);\t$userqq   = strval($_POST['iptCard']);\t$password = strval($_POST['t_UserPass']);\t$password = MD5($password);\t$repass   = strval($_POST['t_RePass']);\t$email    = strval($_POST['t_Email']);\t$datetime = date(\"Y-m-d H:i:s\");\t  \t$reg    = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_NAME = '\".$username.\"'\");\t$regnum = mysql_num_rows($reg);\tif($regnum > 0){\t\techo \"用户名&nbsp;<b style='color:green;'>\".$username.\"</b>&nbsp;已经被使用<br/>\";\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '注册失败'\";\t\techo \"</script>\";\t\techo \"用户注册失败。3秒后将返回注册页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;如果您已经有账号可从&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;前往登陆。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoReg()';\t\techo '</script>';\t\texit();\t}\t$reg    = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_DISPLAYNAME = '\".$disname.\"'\");\t$regnum = mysql_num_rows($reg);\tif($regnum > 0){\t\techo \"昵称&nbsp;<b style='color:green;'>\".$disname.\"</b>&nbsp;已经被使用<br/>\";\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '注册失败'\";\t\techo \"</script>\";\t\techo \"用户注册失败。3秒后将返回注册页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;如果您已经有账号可从&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;前往登陆。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoReg()';\t\techo '</script>';\t\texit();\t}\t$reg    = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_QQ = '\".$userqq.\"'\");\t$regnum = mysql_num_rows($reg);\tif($regnum > 0){\t\techo \"QQ号码&nbsp;<b style='color:green;'>\".$userqq.\"</b>&nbsp;已经被使用<br/>\";\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '注册失败'\";\t\techo \"</script>\";\t\techo \"用户注册失败。3秒后将返回注册页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;如果您已经有账号可从&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;前往登陆。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoReg()';\t\techo '</script>';\t\texit();\t}\t\t$reg    = mysql_query(\"SELECT ID FROM HBDX_USERS WHERE USER_MAIL = '\".$email.\"'\");\t$regnum = mysql_num_rows($reg);\tif($regnum > 0){\t\techo \"邮箱&nbsp;<b style='color:green;'>\".$email.\"</b>&nbsp;已经被使用<br/>\";\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '注册失败'\";\t\techo \"</script>\";\t\techo \"用户注册失败。3秒后将返回注册页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;如果您已经有账号可从&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;前往登陆。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoReg()';\t\techo '</script>';\t\texit();\t} \t\tif(mysql_query(\"INSERT INTO HBDX_USERS (USER_NAME,USER_DISPLAYNAME,USER_QQ,USER_PASS,USER_MAIL,REGISTERDATE,LOGINDATE) VALUES ('$username','$disname','$userqq','$password','$email','$datetime','$datetime')\"))\t{\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '用户注册成功'\";\t\techo \"</script>\";\t\techo \"用户注册成功。3秒后将跳转到登录页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='login.html' style='color:green;'>登录</a>&nbsp;或者返回&nbsp;<a href='index.php' style='color:green;'>主页</a>\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoLogin()';\t\techo '</script>';\t}\telse\t{\t\techo \"<script type='text/javascript'>\";\t\techo \"document.title = '注册失败'\";\t\techo \"</script>\";\t\techo \"用户注册失败。3秒后将返回注册页面，如果你的浏览器不支持自动跳转，请点击&nbsp;<a href='reg.html' style='color:green;'>这里</a>&nbsp;如果您已经有账号可从&nbsp;<a href='login.html' style='color:green;'>这里</a>&nbsp;前往登陆。\";\t\techo '<script type=\"text/javascript\">';\t\techo 'GoReg()';\t\techo '</script>';\t}?>\n同样无任何过滤，根据最后一层验证的SQL语句\nif(mysql_query(\"INSERT INTO HBDX_USERS (USER_NAME,USER_DISPLAYNAME,USER_QQ,USER_PASS,USER_MAIL,REGISTERDATE,LOGINDATE) VALUES ('$username','$disname','$userqq','$password','$email','$datetime','$datetime')\"))\n我们可以构造一个form来绕过前端验证\n<form action=\"http://127.0.0.1:8080/d.hbdx.cc/reg.php\" method=\"post\" >\t<input name=\"reg\" value=\"免费注册\">    <input name=\"t_UserName\" value=\"admin2\">    <input name=\"iptNickName\" value=\"的的\">    <input name=\"t_UserPass\" value=\"123456\">    <input name=\"t_RePass\" value=\"123456\">    <input name=\"iptCard\" value=\"123456\">    <input name=\"t_Email\" value=\"123456@qq.com'\">    <input type=\"submit\" value=\"ok\"></form>\n\n\n可以看见提交之后出现报错，我们可以使用子查询构造除了HBDX_USERS表以外的 读取任意表数据的 SQL语句因为这个站的表除了HBDX_USERS，其他的表并没有什么敏感数据故不再演示。3.再来看看(catalogue.php)\n@$type      = strval($_GET['type']);  //得到type的值@$page      = intval($_GET['page']);  //得到page的值@$hot       = strval($_GET['hot']);  //得到type的值$page       = isset($_GET['page'])?intval($_GET['page']):1; //当前页数$result     = mysql_query(\"SELECT CODE FROM HBDX_BASEINFO WHERE TAGSECOND = 'FILESHOW'\"); $filerow    = mysql_fetch_array($result);$result     = mysql_query(\"SELECT CODE FROM HBDX_BASEINFO WHERE TAGSECOND = 'PAGENUM'\"); $pagerow    = mysql_fetch_array($result);$perNumber  = $filerow['CODE'];  //每页显示的最大记录数$limit_page = $pagerow['CODE'];$startCount = ($page-1)*$perNumber;if (empty($type)){\techo '<script type=\"text/javascript\">';\techo 'AutoOpenURL(\"index.php\")';\techo '</script>';}else{\techo \"<script type='text/javascript'>\";\techo \"document.title = '$type'\";\techo \"</script>\";}if (empty($hot)){\t$hot = \",ID DESC\";}else{\t$hot = \",FILENUM DESC\";}$result  = mysql_query(\"SELECT * FROM HBDX_BLUE WHERE FILETYPE = '\".$type.\"'\"); $num_max = mysql_num_rows($result); $result  = mysql_query(\"SELECT * FROM HBDX_BLUE WHERE FILETYPE = '\".$type.\"' ORDER BY TOP \".$hot.\" LIMIT $startCount,$perNumber\"); echo '<table class=\"table\"><tr>';echo \"<th>操作</th><th>名称</th><th>大小</th><th><a href='catalogue.php?type=\".$type.\"&hot=hot' style='color:green;'>下载量</a></th><th>发布者/联盟</th><th>标签</th><th>发布时间</th>\";echo '</tr>';while($row = mysql_fetch_array($result)){\t$fileuser  = $row['FILEUSER'];\t$usersinfo = mysql_query(\"SELECT USER_DISPLAYNAME FROM HBDX_USERS WHERE ID = '\".$fileuser.\"'\"); \t$usersrows = mysql_fetch_array($usersinfo);\techo \"<td><a href='pages.php?id=\".$row['ID'].\"'>详情&nbsp;&nbsp;</a>\";\tif( $row['FILEEXT'] == 'net' )\t{\t\t$fileid = $row['ID'];\t\techo \"<a href='\".$row['FILEURL'].\"' target='_blank' onClick=\\\"javascript:ClickNumber('$fileid');\\\">下载&nbsp;&nbsp;</a></td>\";\t} \telse\t{\t\techo \"<a href='download.php?id=\".$row['ID'].\"'>下载&nbsp;&nbsp;</a></td>\";\t}\techo \"<td>\";\tif( $row['FILEEXT'] == 'torrent' )\t{\t\techo '<a style=\"background:#1369A4;color:#fff;\">&nbsp;&nbsp;种子&nbsp;&nbsp;</a>';\t}\t$pos = strpos( $row['FILEURL'], 'ed2k://|file|');\tif ($pos !== false)\t{\t\techo '<a style=\"background:#467500;color:#fff;\">&nbsp;&nbsp;电驴&nbsp;&nbsp;</a>';\t}\t$baidu = strpos( $row['FILEURL'], 'pan.baidu.com/share/link?');\tif ($baidu !== false)\t{\t\techo '<a style=\"background:#BB3D00;color:#fff;\">&nbsp;&nbsp;百度&nbsp;&nbsp;</a>';\t}\t$kuai = strpos( $row['FILEURL'], 'kuai.xunlei.com/d/');\tif ($kuai !== false)\t{\t\techo '<a style=\"background:#7E3D76;color:#fff;\">&nbsp;&nbsp;快传&nbsp;&nbsp;</a>';\t}\t\techo \"<a href='pages.php?id=\".$row['ID'].\"'><b>\".$row['FILETITLE'].\"</b></a>\";\tif ($row['TOP'] == 0) {\t\techo \"<img src='images/top.gif'></img>\";\t}\t$datetoday = date(\"Y-m-d\");\t$d1   = strtotime($datetoday);\t$d2   = strtotime($row['LOADDATE']);\t$days = round(($d1-$d2)/3600/24);\tif( $days < 10 )\t{\t\techo \"<img src='images/new.gif'></img>\";\t}\tif( $row['FILENUM'] > 99 )\t{\t\techo \"<img src='images/hot.gif'></img>\";\t}\techo \"</td>\";\techo \"<td>\".$row['FILESIZE'].\"</td>\";\techo \"<td>\".$row['FILENUM'].\"</td>\";\techo \"<td>\".$usersrows['USER_DISPLAYNAME'].\"</td>\";\t$tags   = strtok( $row['FILETAG'],',');\techo \"<td>\";\twhile( $tags ) {\t\techo \"<a href=\\\"javascript:void(0)\\\" onClick=\\\"javascript:send_request('tools.php?seacher=\".$tags.\"');\\\">\".$tags.\"&nbsp;&nbsp;</a>\";\t\t$tags = strtok (\",\"); \t}\techo \"</td>\";\techo \"<td>\".$row['LOADDATE'].\"</td>\";\techo '</tr>';}echo \"</table>\";$pagecount = ceil($num_max/$perNumber);   //总页数if ($page == 1) {echo \"<a href='catalogue.php?type=\".$type.\"'><strong>首页&nbsp;&nbsp;</strong></a>\";}if ($page != 1) {\techo \"<a href='catalogue.php?type=\".$type.\"'><strong>首页&nbsp;&nbsp;</strong></a>\";\techo \"<a href='catalogue.php?type=\".$type.\"&page=\".($page-1).\"'><strong>上一页&nbsp;&nbsp;</strong></a>\";}for ($i=1;$i<=$pagecount;$i++){\tif($i <= $limit_page)\t{\t\techo \"<a href='catalogue.php?type=\".$type.\"&page=\".$i.\"'>$i&nbsp;&nbsp;</a>\";\t}}if ($page<$pagecount){\techo \"<a href='catalogue.php?type=\".$type.\"&page=\".($page+1).\"'><strong>下一页&nbsp;&nbsp;</strong></a>\";\techo \"<a href='catalogue.php?type=\".$type.\"&page=\".$pagecount.\"'><strong>尾页&nbsp;&nbsp;</strong></a>\";}if ($page==$pagecount){\techo \"<a href='catalogue.php?type=\".$type.\"&page=\".$pagecount.\"'><strong>尾页&nbsp;&nbsp;</strong></a>\";}echo \"第<b>\".$page.\"</b>页 \";echo \" 共<b>\".$pagecount.\"</b>页 \";\n这个页面可控参数太多@$type      = strval($_GET['type']);  //得到type的值@$page      = intval($_GET['page']);  //得到page的值@$hot       = strval($_GET['hot']);  //得到type的值$page       = isset($_GET['page'])?intval($_GET['page']):1; //当前页数这个页面也同样无任何过滤。我们尝试type参数，除了出现注入以外，还出现了输出在<script>中的情况\n\n我们闭合之后：\n\n   漏洞证明：  以上详细说明附带证明过程。   修复方案：  幸好你的后台很简单。   版权声明：转载请注明来源 LaiX@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2013-12-15 18:48 |    \t\tneal \t\t\t( 普通白帽子  |\t\t\t        Rank:219 漏洞数:23        )\t\t \n  ....如果gpc=on   你觉得还行吗？    \n     2013-12-15 23:46 |    \t\tjk_影 \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:9        | 专注google三十年)\t\t \n  我也觉得gpc开了就没办法了    \n     2013-12-24 18:57 |    \t\tLaiX \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:39        | 承接 建站、仿站、维护、反黑客、代码审计...)\t\t \n  @neal @neal 你是来关注安全的，还是来反驳我达到装逼目的的。不管有没有开，并不代表漏洞不存在。不要扭曲了乌云的思想。    \n     2013-12-24 19:23 |    \t\t小土豆 \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:23        )\t\t \n  @LaiX 赞一个~ 学习到了。    \n     2013-12-24 19:27 |    \t\tneal \t\t\t( 普通白帽子  |\t\t\t        Rank:219 漏洞数:23        )\t\t \n  @LaiX    我扭曲了乌云的思想？ 您还真会扯。   我对这个不是很懂，有问题问一下 不行吗？  难道有问题我还不能问了？       \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}