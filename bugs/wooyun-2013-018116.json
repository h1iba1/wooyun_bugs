{"id": 14757, "wybug_id": "wooyun-2013-018116", "wybug_title": "PHP safe_mode等安全配置绕过", "wybug_corp": "PHP", "wybug_author": "GaRY", "wybug_date": "2013-01-30 16:00", "wybug_open_date": "2013-02-04 16:08", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-01-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-02-04：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 在某些常见环境下的PHP执行环境，可以绕过其php.ini中设置的安全相关配置执行命令或者做其他操作 详细说明：  在PHP-FPM环境下的fastcgi运行的PHP中，因为PHP-FPM无法知晓我们的fastcgi请求来源于哪儿，因此我可以模仿fcgi协议向PHP-FPM发起伪造的请求。而且PHP-FPM自从5.3.3开始，允许利用fcgi的参数PHP_VALUE, PHP_ADMIN_VALUE对php.ini的内容进行设置，因此可以利用此去覆盖原有php的安全设置。但是因为disable_functions/classes的工作原理和其他配置有区别，通过这种方式我们无法覆盖这两个的配置，因此无法绕过disable_functions/classes。   漏洞证明：  利用结果如下：\n\n   修复方案：  实际上这个还真不太好修复，可以暂时去除PHP_VALUE的支持，但是这只是一个临时方案，看PHP官方如何处理吧。毕竟他无法解决“PHP-FPM无法知晓我们的fastcgi请求来源于哪儿”的问题。这又是一个架构上的问题了。   版权声明：转载请注明来源 GaRY@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-02-04 16:08 厂商回复：  最新状态： 2013-02-04：QUOTE: \"fat@php.net:Even if I don't understand why a person of sound mind would expose FPM to the internet (don't tell me it's because of the cloud, if that's the case, stop using clouds: it's not secure !), there's some case where this could be a security risk, I agree.How to fix this:1- add an option to php-fpm to disable the PHP_VALUE and PHP_ADMIN_VALUE fastcgi headers (default to disable).2- see if we can find a way of authenticate the client (the legitimate webserver) (is there a way from a php script to see the content of the fastcgi request headers ?, if not, the legitimate webserver can sent a password in the fastcgi headers to authenticate itself to FPM)3- both (1 & 2)\"  ", "replys": "漏洞评价：\n评论\n     2013-01-30 16:04 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  发了两个啊 @xsser    \n     2013-01-30 16:26 |    \t\t小囧 \t\t\t( 普通白帽子  |\t\t\t        Rank:396 漏洞数:62        | 在通往牛B的路上一路狂奔)\t\t \n  这么说来  那  sae  bae  这些都不安全了哟？    \n     2013-01-30 16:52 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  关注    \n     2013-01-30 16:55 |    \t\tXhm1n9 \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:13        | bug)\t\t \n  用.htaccess么？    \n     2013-01-30 16:57 |    \t\t/fd \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        )\t\t \n  果斷关注    \n     2013-01-30 16:58 |    \t\t蓝风 \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:25        | 崬汸慾哓 嗼檤焄垳皁 沓猵圊屾亾沬荖 颩憬...)\t\t \n  求忽略    \n     2013-01-30 17:01 |    \t\tZ-0ne  \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:38        | 目前专注于工控安全基础研究，工业数据采集...)\t\t \n  这个得mark    \n     2013-01-30 17:22 |    \t\ttxcbg \t\t\t( 普通白帽子  |\t\t\t        Rank:391 漏洞数:53        | 说点什么呢？)\t\t \n  关注    \n     2013-01-30 20:24 |    \t\t Jesus \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 天地不仁,以万物为刍狗！)\t\t \n  @xsser 爷，没人来确认的，放出来吧。。。    \n     2013-01-30 23:37 |    \t\t无敌L.t.H \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | ‮……肉肉捉活，亭长放解)\t\t \n  open_basedir safe_mode都被玩坏多少次了。    \n     2013-02-02 11:01 |    \t\tShell \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | shell)\t\t \n  坐等公开    \n     2013-02-04 16:46 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  厂商居然来了    \n     2013-02-04 17:12 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  厂商的话好霸气：引用：“fat@php.net：即使我不明白为什么一个心智健全的人会暴露FPM的互联网（别告诉我那是因为云，如果是这样的话，停止使用云：它是不安全的！）有些情况下，这可能是一个安全风险，我同意。如何解决这个问题：1 -增加一个选项，PHP程序禁用php_value和php_admin_value FastCGI头（默认禁用）。2看是否能找到一种方式，客户端进行身份验证（合法的网络服务器）（有从一个PHP脚本来看到FastCGI请求标头的内容吗？，如果不是，合法的网络服务器可以发送密码在FastCGI标题以FPM认证本身）3 -（1 - 2）”    \n     2013-02-04 17:35 |    \t\t云中鹰 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:10        | 云中鹰)\t\t \n  关注~~~    \n     2013-02-04 18:28 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  顺带提一句，这个对disable_functions没有绕过作用。之前更新的漏洞貌似没用，还是回复里提一下    \n     2013-02-04 18:33 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  原因么，我回头zone上写个帖子说明以下    \n     2013-02-04 22:06 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  发了个帖子解释这个漏洞相关信息：http://zone.wooyun.org/content/2605     \n     2013-02-05 12:00 |    \t\tleehenwu \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:24        | 撸·啊·撸)\t\t \n  exp 可以参考fastcgi remote code execution exp 修改一下吧。。    \n     2013-02-09 23:44 |    \t\t假装纯情 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        | 不折腾会死星人~)\t\t \n  这个要mark    \n     2013-12-20 23:46 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}