{"id": 1621, "wybug_id": "wooyun-2014-063655", "wybug_title": "ECSHOP前台任意用户登录", "wybug_corp": "ShopEx", "wybug_author": "路人甲", "wybug_date": "2014-06-05 15:28", "wybug_open_date": "2014-09-03 15:30", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向公众公开  简要描述： 由于代码设计缺陷 导致网站任意用户登录 详细说明：  影响文件:flow.php 188行开始\nelseif ($_REQUEST['step'] == 'login'){    include_once('languages/'. $_CFG['lang']. '/user.php');    /*     * 用户登录注册     */    if ($_SERVER['REQUEST_METHOD'] == 'GET')       .....    else    {        include_once('includes/lib_passport.php');        if (!empty($_POST['act']) && $_POST['act'] == 'signin')        {            $captcha = intval($_CFG['captcha']);            if (($captcha & CAPTCHA_LOGIN) && (!($captcha & CAPTCHA_LOGIN_FAIL) || (($captcha & CAPTCHA_LOGIN_FAIL) && $_SESSION['login_fail'] > 2)) && gd_version() > 0)            {                if (empty($_POST['captcha']))                {                    show_message($_LANG['invalid_captcha']);                }                /* 检查验证码 */                include_once('includes/cls_captcha.php');                $validator = new captcha();                $validator->session_word = 'captcha_login';                if (!$validator->check_word($_POST['captcha']))                {                    show_message($_LANG['invalid_captcha']);                }            }            if ($user->login($_POST['username'], $_POST['password'],isset($_POST['remember'])))            {                .....            }\n上面代码中执行了 登录操作 $user->login($_POST['username'], $_POST['password'],isset($_POST['remember'])login方法如下：（\nfunction login($username, $password, $remember = null)    {        if ($this->check_user($username, $password) > 0)        {            if ($this->need_sync)            {                $this->sync($username,$password);            }            $this->set_session($username);            $this->set_cookie($username, $remember);            return true;        }        else        {            return false;        }    }function check_user($username, $password = null)    {        $post_username = $username;        /* 如果没有定义密码则只检查用户名 */        if ($password === null)        {            $sql = \"SELECT \" . $this->field_id .                   \" FROM \" . $this->table($this->user_table).                   \" WHERE \" . $this->field_name . \"='\" . $post_username . \"'\";            return $this->db->getOne($sql);        }        else        {            $sql = \"SELECT \" . $this->field_id .                   \" FROM \" . $this->table($this->user_table).                   \" WHERE \" . $this->field_name . \"='\" . $post_username . \"' AND \" . $this->field_pass . \" ='\" . $this->compile_password(array('password'=>$password)) . \"'\";            return  $this->db->getOne($sql);        }    }\n登录操作最终执行check_user方法，当用户密码为null时，只判断用户名。而在flow.php中并没有对密码进行判断或者初始化。可以只通过账号就可以实现登录。url: ./flow.php?step=login   POST:  act=signin&username=xxxx&captcha=yyyyycaptcha是验证码，有时候是不需要验证码的   漏洞证明：  影响文件:flow.php 188行开始\nelseif ($_REQUEST['step'] == 'login'){    include_once('languages/'. $_CFG['lang']. '/user.php');    /*     * 用户登录注册     */    if ($_SERVER['REQUEST_METHOD'] == 'GET')       .....    else    {        include_once('includes/lib_passport.php');        if (!empty($_POST['act']) && $_POST['act'] == 'signin')        {            $captcha = intval($_CFG['captcha']);            if (($captcha & CAPTCHA_LOGIN) && (!($captcha & CAPTCHA_LOGIN_FAIL) || (($captcha & CAPTCHA_LOGIN_FAIL) && $_SESSION['login_fail'] > 2)) && gd_version() > 0)            {                if (empty($_POST['captcha']))                {                    show_message($_LANG['invalid_captcha']);                }                /* 检查验证码 */                include_once('includes/cls_captcha.php');                $validator = new captcha();                $validator->session_word = 'captcha_login';                if (!$validator->check_word($_POST['captcha']))                {                    show_message($_LANG['invalid_captcha']);                }            }            if ($user->login($_POST['username'], $_POST['password'],isset($_POST['remember'])))            {                .....            }\n上面代码中执行了 登录操作 $user->login($_POST['username'], $_POST['password'],isset($_POST['remember'])login方法如下：（\nfunction login($username, $password, $remember = null)    {        if ($this->check_user($username, $password) > 0)        {            if ($this->need_sync)            {                $this->sync($username,$password);            }            $this->set_session($username);            $this->set_cookie($username, $remember);            return true;        }        else        {            return false;        }    }function check_user($username, $password = null)    {        $post_username = $username;        /* 如果没有定义密码则只检查用户名 */        if ($password === null)        {            $sql = \"SELECT \" . $this->field_id .                   \" FROM \" . $this->table($this->user_table).                   \" WHERE \" . $this->field_name . \"='\" . $post_username . \"'\";            return $this->db->getOne($sql);        }        else        {            $sql = \"SELECT \" . $this->field_id .                   \" FROM \" . $this->table($this->user_table).                   \" WHERE \" . $this->field_name . \"='\" . $post_username . \"' AND \" . $this->field_pass . \" ='\" . $this->compile_password(array('password'=>$password)) . \"'\";            return  $this->db->getOne($sql);        }    }\n登录操作最终执行check_user方法，当用户密码为null时，只判断用户名。而在flow.php中并没有对密码进行判断或者初始化。可以只通过账号就可以实现登录。url: ./flow.php?step=login   POST:  act=signin&username=xxxx&captcha=yyyyycaptcha是验证码，有时候是不需要验证码的   修复方案：  初始化密码   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-06 09:16 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复,发布补丁非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-05 15:29 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  这错误...    \n     2014-06-05 16:39 |    \t\tYouYaX(乌云厂商)\t\t \n  一般涉及任意用户的都是cookie的问题    \n     2014-06-05 16:44 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  @YouYaX 那可不一定    \n     2014-06-05 17:21 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  莫非空。。    \n     2014-06-05 18:41 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @YouYaX  亲  你好活跃    \n     2014-06-05 19:41 |    \t\tYouYaX(乌云厂商)\t\t \n  @′  雨。 学习知识    \n     2014-06-05 21:34 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  @YouYaX 目测是调用时没有判断密码     \n     2014-06-05 22:28 |    \t\tYouYaX(乌云厂商)\t\t \n  ecshop是开源免费的，商派不紧张的，要是攻破shopex，那么估计第一时间修复了    \n     2014-06-05 23:18 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  听上去很强大，这个厉害啊，赞！    \n     2014-06-05 23:29 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  这个好活跃    \n     2014-06-06 10:02 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-06-10 01:31 |    \t\t网络小兵 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | t00ls)\t\t \n  20分啊    \n     2014-06-10 02:19 |    \t\t网络小兵 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | t00ls)\t\t \n  有人猜中了啊，已经成功复现。    \n     2014-06-10 11:44 |    \t\t笨猫猫 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:5        | 喵勒个咪的)\t\t \n  应该不是cookie 看了是验证了密码的    \n     2014-09-03 18:14 |    \t\t杜工 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:3        | 架构人生)\t\t \n  这种情况...很不理解程序员为什么要写这个逻辑，故意留漏洞？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}