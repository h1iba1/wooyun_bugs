{"id": 59641, "wybug_id": "wooyun-2013-046585", "wybug_title": "YXcms1.2.0版本 存储式XSS（实站演示+源码分析）", "wybug_corp": "YXcms", "wybug_author": "lxj616", "wybug_date": "2013-12-26 15:57", "wybug_open_date": "2014-03-26 15:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-26：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-03-26：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： YXcms 最新1.2.0版本 存储式XSS（实站演示）源码分析请见详细说明，各种躺枪的演示在漏洞证明 详细说明：  题外话：之所以发这个漏洞，是因为1.这个CMS的过滤比较强，不像之前某些CMS一丁点儿过滤都没有 完全没有挑战的价值2.Stored-XSS 是跨站中危害比较大的漏洞，之前一直没找机会玩一玩跨站，再不发跨站的漏洞可能会被人认为不会挖XSS的洞洞看代码/protected/apps/default/controller/extendController.php     line:40\nsession_starts(); //接收表单的地方           if($_POST['checkcode']!=$_SESSION['verify'] || empty($_SESSION['verify'])) $this->error('验证码错误，请重新输入');//验证码无缺陷，扫描器不可能发现这个漏洞，继续看代码           for($i=1;$i<count($tableinfo);$i++){//动态的表单支持            if(is_array($_POST[$tableinfo[$i]['tableinfo']]))//先看后面的else              $data[$tableinfo[$i]['tableinfo']]=implode(',',$_POST[$tableinfo[$i]['tableinfo']]);            else//正常提交表单会到这里，使用in函数来过滤参数，grep一下              $data[$tableinfo[$i]['tableinfo']]=in($_POST[$tableinfo[$i]['tableinfo']]);           }           $data['ip']=get_client_ip();           $data['ispass']=0;           $data['addtime']=time();           if(empty($urls[1])) $jump=$_SERVER['HTTP_REFERER'];           else{              $jurl=explode(',',$urls[1]);              if(!empty($jurl[1])){                $arr=explode('/',$jurl[1]);                if(!empty($arr)){                  $canshu=array();                  foreach ($arr as $vo) {                     $val=explode('=',$vo);                     $canshu[$val[0]]=$val[1];                  }                }              }              $jump=url($jurl[0],$canshu);            }//下面用的是in函数过滤完的post，看来只能去找in函数了           if(model('extend')->Extin($tableinfo[0]['tableinfo'],$data)) $this->success('提交成功请等待审核~',$jump);           else $this->error('提交失败~');\n寻找in函数/protected/include/lib/common.function.php   line:8\nfunction in($data,$force=false){//完美的htmlspecialchars+addslashes//看上去好像没希望了//没错，我马上要说但是了，看看这个CMS是怎么输出的留言内容吧\tif(is_string($data)){\t\t$data=trim(htmlspecialchars($data));//防止被挂马，跨站攻击\t\tif(($force==true)||(!get_magic_quotes_gpc())) {\t\t   $data = addslashes($data);//防止sql注入\t\t}\t\treturn  $data;\t} else if(is_array($data)) {\t\tforeach($data as $key=>$value){\t\t   $data[$key]=in($value,$force);\t\t}\t\treturn $data;\t} else {\t\treturn $data;\t}\t}\n/protected/apps/default/view/default/extend_guestbook.php   line:77怎么感觉这么喜感，在一堆$vo['tname']  $vo['addtime']  $vo['reply'] 中出现了一个html_out($vo['content'])\n<div class=\"book-list-info\">留言者：{$vo['tname']}&nbsp;&nbsp;&nbsp;  IP:{$vo['ip']} &nbsp;&nbsp;&nbsp; 留言时间:{date($vo['addtime'],Y-m-d H:m:i)}</div>                  <div class=\"book-list-con\">{html_out($vo['content'])}</div>                  <div class=\"book-list-back\">{$vo['reply']}</div>\n/protected/include/lib/common.function.php   line:75\nfunction html_out($str){\tif(function_exists('htmlspecialchars_decode'))\t\t$str=htmlspecialchars_decode($str);        //天哪！好不容易过滤掉的东西又回来了！！！\telse\t\t$str=html_entity_decode($str);    $str = stripslashes($str);\treturn $str;}\n留言content引发存储式XSS，证毕   漏洞证明：  经测试，那个表单是在留言处接受的先在本机证明，再去光顾躺枪的网站：表单位置：\nhttp://127.0.0.1/index.php?r=default/extend/index&id=100023\n\n\n然后改content\n\n\n\n打cookie了，下面的cookie是躺枪的haohm网站的\n\n为了方便测试，再发一个alert的图\n\n\n\n\n\n躺枪光荣，我只是登了演示一下漏洞，啥都没干http://www.haohm.net/\n\n再躺一个，仍然只是验证漏洞，没有任何恶意\n\n   修复方案：  /protected/apps/default/view/default/extend_guestbook.php   line:78\n<div class=\"book-list-con\">{html_out($vo['content'])}</div>\n去掉html_out，后台显示也同理去掉html_out   版权声明：转载请注明来源 lxj616@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-04-24 11:43 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  mark    \n     2014-09-21 11:17 |    \t\t拨开乌云 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        )\t\t \n  我先路过，看接下来哪位兄弟能看到我。。。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}