{"id": 8373, "wybug_id": "wooyun-2013-034219", "wybug_title": "腾讯电脑管家 TSKsp.sys拒绝服务漏洞", "wybug_corp": "腾讯", "wybug_author": "n0bele", "wybug_date": "2013-08-13 16:31", "wybug_open_date": "2013-11-08 16:32", "wybug_type": "拒绝服务", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-08-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-08-13：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-10-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-10-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-10-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-11-08：\t细节向公众公开  简要描述： 早上起来，也搞了下就出来了.顺带问一下wooyun提交和腾讯漏洞提交的区别是什么? 详细说明：   TSKsp.sys发生未处理的ExRaiseDatatypeMisalignment异常。\n\n第1帧可以看到原来是ProbeForWrite函数抛出了Data misaligned - code 80000002这个异常kd>  .frame 101 f3cac838 f4945b53 nt!ProbeForWrite+0x54kd> dds f3cac838 l 10f3cac838  f3cac974f3cac83c  f4945b53 afd!AfdFastIoDeviceControl+0x4b3f3cac840  d40d73e7 //addressf3cac844  00000004 //Lengthf3cac848  00000004 //Alignmentf3cac84c  8644d288f3cac850  86261250f3cac854  f4943030 afd!AfdFastIoDispatchf3cac858  f3cac7e0f3cac85c  00000009f3cac860  f3cac8ccf3cac864  80536e40 nt!_except_handler3f3cac868  f3cac8c8f3cac86c  867ec000f3cac870  805460fe nt!ExAllocatePoolWithTag+0x27ef3cac874  00000009可以看到是地址参数出了问题，d40d73e7。那这个参数是从哪里来的呢？我首先想到的是去对比NtDeviceIoControlFile传入的InputBuffer，那就去对比一下：kd> .frame 404 f3caca58 f48f4a46 nt!NtDeviceIoControlFile+0x2akd> dds f3caca58 l 10f3caca58  f3cacaa4f3caca5c  f48f4a46 TSKsp+0x14a46f3caca60  0000022c // FileHandlef3caca64  00000000 // Eventf3caca68  00000000 // ApcRoutinef3caca6c  00000000 // IoStatusBlockf3caca70  00d7fd4c // ApcContextf3caca74  000120cf // IoControlCodef3caca78  00d7fd20 // InputBufferf3caca7c  00000024 // InputBufferLengthf3caca80  00000000 // OutputBufferf3caca84  00000000 // OutputBufferLengthf3caca88  eeee0000f3caca8c  805436d8 nt!__InterlockedDecrement传入的InputBuffer并不是我们所期望的d40d73e7为了进一步确认，我们还是把内存数据dump出来看看.\n\nInputBuffer+0x20处的一个DWORD会被当做用户空间地址去进行可写验证，但是却没有进行异常处理.ProbeForWrite没有放在try/except块中么?   漏洞证明：  已经说了.   修复方案：  他们懂   版权声明：转载请注明来源 n0bele@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-11-08 16:32 厂商回复： 这是xp下afd.sys驱动本身的问题，但微软不认为是漏洞并拒绝修复，因此忽略，非常感谢您的反馈。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}