{"id": 55365, "wybug_id": "wooyun-2014-061192", "wybug_title": "Mallbuilder(多用户商城) Getshell一枚", "wybug_corp": "Mallbuilder", "wybug_author": "′雨。", "wybug_date": "2014-05-19 19:39", "wybug_open_date": "2014-08-17 19:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-19：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-08-17：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： Lost check。 详细说明：  在install/index.php中\nif(file_exists(\"../install/isinstall.lock\")){\techo \"<script language=\\\"JavaScript\\\">alert(\\\"系统已经安装!如需要重新安装，请手动删除install/isinstall.lock文件后再重新安装\\\");</script>\";\texit(); }\n这里是判断了lock了的。。但是在install/install.php中竟然没有判断lock。\ndefine('IN_HICHINA', TRUE);//获取动作参数$action = $_GET['action'];\n\nif($action == \"setup\"){\t//检查参数是否完整\t$dbhost = $_GET['dbhost'];\t$port = $_GET['port'];\t$dbname = $_GET['dbname'];\t$dbuser = $_GET['dbuser'];\t$dbpassword = $_GET['dbpassword'];\t$tableprefix = $_GET['tableprefix'];\t$guid = $_GET['guid'];\tif(!$port)\t\t$port = 3306;\tif ($dbhost && $port && $dbname && $dbuser && $dbpassword && $tableprefix && $guid)\t{\t\tfile_put_contents(\"db.txt\", $dbhost.'|'.$port .'|'.$dbname .'|'.$dbuser .'|'.$dbpassword .'|'.$tableprefix.'|'.$guid);\t\t$link = mysql_connect($dbhost . \":\" . $port, $dbuser, $dbpassword);\t\tif($link)\t\t{\t\t\tmysql_query(\"CREATE DATABASE IF NOT EXISTS `\".$dbname.\"`;\", $link);\t\t\tmysql_query(\"SET NAMES 'utf8',character_set_client=binary,sql_mode='';\",$link);\t\t\t$link2 = mysql_select_db($dbname, $link);\t\t\tif($link2)\t\t\t{\t\t\t\t//==========================================================更新进度\t\t\t\tfile_put_contents('progress.txt', 10);\t\t\t\t//安装步骤1. 创建数据库结构\t\t\t\t$sqlfile = 'B2Bbuilder.sql';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\t\t\t\twhile($mysql=GetNextSQL())\t\t\t\t{\t\t\t\t\tmysql_query($mysql);\t\t\t\t}\t\t\t\tfclose($fp);\t\t\t\t//---------------------------------\t\t\t\t$rurl=$_SERVER ['HTTP_HOST'].$_SERVER['PHP_SELF'];\t\t\t\t$aurl = explode(\"/\", $rurl);\t\t\t\t$realurl='';\t\t\t\tfor($i=0;$i<count($aurl)-2;$i++)\t\t\t\t\t   $realurl=$realurl.$aurl[$i].\"/\";\t\t\t\t$realurl=\"http://\".$realurl;\t\t\t\t$realurl=substr($realurl,0,-1);\t\t\t\t\t\t\t\t\t\t\t\t$burl=explode(\".\",$realurl);\t\t\t\t$pb=array_shift($burl);\t\t\t\t$baseurl=str_replace($pb.'.','',$_POST[\"weburl\"]);\t\t\t\t$baseurl=str_replace('http://','',$_POST[\"weburl\"]);\t\t\t\t$baseurl=explode('/',$baseurl);\t\t\t\t$baseurl=$baseurl[0];\t\t\t\tif(substr($baseurl,0,3)=='loc'||substr($baseurl,0,3)=='127')\t\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='' where `index`='baseurl'\");\t\t\t\telse\t\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='\".$baseurl.\"' where `index`='baseurl'\");\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='$realurl' where `index`='weburl'\");\t\t\t\t//写系统配置文件\t\t\t\t$rsid=mysql_query(\"select * from  \".$tableprefix.\"web_config\");\t\t\t\t$arr=array(); $configs=array();\t\t\t\twhile($row=mysql_fetch_array($rsid))\t\t\t\t{ \t\t\t\t\t$arr[] = $row; \t\t\t\t} \t\t\t\tforeach($arr as $v)\t\t\t\t{\t\t\t\t\t$index=$v['index'];\t\t\t\t\t$value=$v['value'];\t\t\t\t\t$configs[$index]=$value;\t\t\t\t}\t\t\t\t$write_config_con_array=$configs;\t\t\t\t$write_config_con_str=serialize($write_config_con_array);//将数组序列化后生成字符串\t\t\t\t$write_config_con_str='<?php $config = array_merge($config, unserialize(\\''.$write_config_con_str.'\\'));?>';//生成要写的内容\t\t\t\t$cfp=fopen(dirname(__FILE__).'/../config/web_config.php','w');\t\t\t\tfwrite($cfp,$write_config_con_str,strlen($write_config_con_str));//将内容写入文件．\t\t\t\tfclose($cfp);\t\t\t\t//======================================================更新进度\t\t\t\tfile_put_contents('progress.txt', 30);\t\t\t\t\t\t\t\t/*\t\t\t\t//安装步骤2. 导入测试数据\t\t\t\t$sqlfile = 'data.txt';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\t\t\t\twhile(!feof($fp))\t\t\t\t{\t\t\t\t\t$line = rtrim(fgets($fp, 1024));\t\t\t\t\tif(preg_match(\"#;$#\", $line))\t\t\t\t\t{\t\t\t\t\t\t$query .= $line;\t\t\t\t\t\t$query = str_replace('{tableprefix}',$tableprefix,$query);\t\t\t\t\t\t$rs = mysql_query($query,$link);\t\t\t\t\t\t$query='';\t\t\t\t\t} else if(!preg_match(\"#^(\\/\\/|--)#\", $line))\t\t\t\t\t{\t\t\t\t\t\t$query .= $line;\t\t\t\t\t}\t\t\t\t}\t\t\t\tfclose($fp);\t\t\t\t\t\t\t*/\t\t\t\t//更新进度\t\t\t\tfile_put_contents('progress.txt', 70);\t\t\t\t//=======================================================安装步骤3. 配置文件修改\t\t\t\t$contents='<?php\t\t\t\t\t$config[\\'dbhost\\'] = \\''.$dbhost.'\\';      //数据库所在IP地址\t\t\t\t\t$config[\\'dbuser\\'] = \\''.$dbuser.'\\';  //数据库用户\t\t\t\t\t$config[\\'dbpass\\'] = \\''.$dbpassword.'\\';   \t //数据库密码\t\t\t\t\t$config[\\'dbname\\'] = \\''.$dbname.'\\';     //数据库名\t\t\t\t\t$config[\\'port\\'] = \\''.$port.'\\';     //端口\t\t\t\t\t$config[\\'table_pre\\']=\\''.$tableprefix.'\\';  //数据库表前缀\t\t\t\t\t$config[\\'authkey\\']=\\''.md5(time().rand(0,100000)).'\\';  //数据库表前缀\t\t\t\t\t?>';\t\t\t\t$filename = dirname(__FILE__).\"/../config/config.inc.php\"; \t\t\t\t$cfp = fopen($filename,'w'); \t\t\t\tfwrite($cfp,$contents);\n这里可以看到直接把一些连接的参数写入到了配置文件当中这里很多都是可控的。首先本地搭建一个mysql环境(不需要拿到网站的mysql权限)。   漏洞证明：  \n\nindex.php check lock。\n\n\n\n成功getshell。   修复方案：  Check lock   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}