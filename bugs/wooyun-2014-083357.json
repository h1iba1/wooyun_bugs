{"id": 43236, "wybug_id": "wooyun-2014-083357", "wybug_title": "BiWEB最新商城版任意文件上传getshell", "wybug_corp": "BiWEB", "wybug_author": "路人甲", "wybug_date": "2014-11-17 11:38", "wybug_open_date": "2015-02-15 11:40", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意", "文件上传", "文件上传安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-17：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-02-15：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： BiWEB最新商城版任意文件上传getshell 详细说明：  在wooyun上看到了有人提了BiWEB的一个XSS漏洞： WooYun: BIWEB商城版XSS盲打cookie ，也有人提了SQL注入，我来找找其他的漏洞吧。去官网下BiWEB商城版最新的5.8.4来看看。在用户修改资料时，有一个上传执照图片的点，分析一下这个上传是不是会有任意文件上传的问题呢？上传点在这里/user/adminu/licence.php分析一下上传代码\n无关代码if ($_SERVER[\"REQUEST_METHOD\"] == \"POST\"){\t//图片上传\tif ($_FILES['Filedata']['name'] != \"\") {\t\t$strOldFile = $arrGPic['FileSavePath'].'s/'.$_POST['savefilename'];\t\tif (is_file($strOldFile)) {\t// 缩略图删除\t\t\tunlink($strOldFile);\t\t}\t\t$strOldFile = $arrGPic['FileSavePath'].'b/'.$_POST['savefilename'];\t\tif (is_file($strOldFile)) {\t// 原文件删除\t\t\tunlink($strOldFile);\t\t}\t\t$_POST['photo1'] = $objWebInit->uploadInfoImage($_FILES['Filedata'],'',$_POST['FileListPicSize'],$_POST['csize0'],$arrInfo['user_id']);\t}else{\t\t$_POST['photo1'] = $_POST['savefilename'];\t}\t// 取会员信息\t$arrInfo['photo1'] = $_POST['photo1'];\t//修改状态表明正在申请验证,必须设定为字符串形式\t$arrInfo['pass'] = '0';\tif (!empty($arrInfo)) {\t\t$objWebInit->saveInfo($arrInfo,1);\t\techo \"<script>\" . check::WindowLocation('/user/adminu/licence.php').\"</script>\";\t\texit();\t}}无关代码\n调用了uploadInfoImage()方法，/web_common5.8/php_common.php\n无关代码if ($arrFile['error'] != 0) {\t\t\tcheck::AlertExit('文件上传错误！('.$arrFile['error'].')',-1);\t\t}\t\tif ($arrFile['name']) {\t\t\t$strFileType = strtolower($arrFile['type']);\t\t\tif (!in_array( $strFileType , array( 'image/jpg','image/jpeg', 'image/gif' , 'image/pjpeg','image/png','image/x-png'))) {\t\t\t\tcheck::AlertExit('文件类型不符合要求('.$arrFile['type'].')',-1);\t\t\t}\t\t}无关代码\n可以看到，这里只对filetype做了验证，也就是只对MIME做了一次验证，后面就没有别的验证了，这里问题就出来了。直接上php马，然后修改Content-Type为“image/jpg','image/jpeg', 'image/gif' , 'image/pjpeg','image/png','image/x-png”中的任意一个都可以成功绕过检验完成上传。下面上传一个php马试试，先来看看上传点\n\n上传时，请先申请一个账号登陆，上传成功后的名称即你访问的你上传图片的路径，如上图。修改Content-Type，以绕过MIME检测，如下图\n\n上传成功，连刀看看效果\n\n   漏洞证明：  见 详细说明    修复方案：  检测   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}