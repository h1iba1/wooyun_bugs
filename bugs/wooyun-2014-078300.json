{"id": 50276, "wybug_id": "wooyun-2014-078300", "wybug_title": "GV32-CMS最新版V5.6.4前台getshell", "wybug_corp": "GV32-CMS", "wybug_author": "宇少", "wybug_date": "2014-10-11 15:50", "wybug_open_date": "2015-01-09 15:52", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传", "文件上传安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-09：\t细节向公众公开  简要描述： GV32-CMS最新版V5.6.4前台getshell 详细说明：  GV32-CMS最新版V5.6.4前台getshell   漏洞证明：  #1 文件application\\user\\upload.php 11-96行\n//文件上传uploadfile();function uploadfile(){\t$configUp=array();\t\t$configUp['type']\t= array(\"flash\",\"img\"); //上传允许type值\t\t$configUp['img'] \t= array(\"jpg\",\"bmp\",\"gif\",\"png\"); //img允许后缀\t\t$configUp['flash'] \t= array(\"flv\",\"swf\"); //flash允许后缀\t\t$configUp['office'] = array(\"doc\",\"docx\",\"docm\",\"dotx\",\"dotm\",\t\t\t\t\t\t\t\"xls\",\"xlsx\",\"xlsm\",\"xltm\",\"xlsb\",\"xlam\",\"csv\",\"xlw\",\"wk4\",\"wk3\",\"wk1\",\"wks\",\"dbf\",\t\t\t\t\t\t\t\"ppt\",\"pptx\",\"pptm\",\"ppsx\",\"potx\",\"potm\",\"ppam\"); //office允许后缀\t\tif(MAX_UPSIZE != '')\t{\t\t$configUp['flash_size'] = MAX_UPSIZE; //上传flash大小上限 单位：KB\t\t$configUp['img_size'] = MAX_UPSIZE; //上传img大小上限 单位：KB\t}else{\t\t$configUp['flash_size']\t=\t1000; //上传flash大小上限 单位：KB\t\t$configUp['img_size']\t=\t2000; //上传img大小上限 单位：KB\t}\t\t$configUp['message']\t= \"上传成功\"; //上传成功后显示的消息，若为空则不显示\t$configUp['name']\t= mktime(); //上传后的文件命名规则 这里以unix时间戳来命名\t\tif(BASE_WEBURL!='')\t{\t\t$configUp['flash_dir']\t= BASE_WEBURL.\"/uploads/flash\"; //上传flash文件地址 采用绝对地址 方便upload.php文件放在站内的任何位置 后面不加\"/\"\t\t$configUp['img_dir']\t\t= BASE_WEBURL.\"/uploads/img\"; //上传img文件地址 采用绝对地址 采用绝对地址 方便upload.php文件放在站内的任何位置 后面不加\"/\"\t}else{\t\t$configUp['flash_dir']\t=  \"/uploads/flash\"; //上传flash文件地址 采用绝对地址 方便upload.php文件放在站内的任何位置 后面不加\"/\"\t\t$configUp['img_dir']\t\t= \"/uploads/img\"; //上传img文件地址 采用绝对地址 采用绝对地址 方便upload.php文件放在站内的任何位置 后面不加\"/\"\t}\t\tif(IMG_URL!='')\t{\t\t$configUp['site_url'] = IMG_URL; //网站的网址 这与图片上传后的地址有关 最后不加\"/\" 可留空\t}else{\t\t$configUp['site_url']=\"\"; //网站的网址 这与图片上传后的地址有关 最后不加\"/\" 可留空\t}\t//判断是否是非法调用\tif(empty($_GET['CKEditorFuncNum']))\tmkhtml(1,\"\",\"错误的功能调用请求\");\t$fn=$_GET['CKEditorFuncNum'];\tif(is_uploaded_file($_FILES['upload']['tmp_name']))\t{\t   //判断上传文件是否允许\t   $filearr=pathinfo($_FILES['upload']['name']);\t   $filetype=$filearr[\"extension\"];\t   if(!in_array($filetype,$configUp['img']))\t\tmkhtml($fn,\"\",\"错误的文件类型！\");\t   //判断文件大小是否符合要求\t   if($_FILES['upload']['size'] > $configUp[\"img_size\"]*1024)\t\tmkhtml($fn,\"\",\"上传的文件不能超过\".$configUp[\"img_size\"].\"KB！\"); \t   \t   $file_abso=$configUp[\"img_dir\"].\"/\".$configUp['name'].\".\".$filetype;\t   $file_host=$_SERVER['DOCUMENT_ROOT'].$file_abso;\t   if(move_uploaded_file($_FILES['upload']['tmp_name'],$file_host))\t   {\t\t\tmkhtml($fn,$file_abso,$configUp['message']);\t   }else\t   {\t\t\tmkhtml($fn,\"\",\"文件上传失败，请检查上传目录设置和目录读写权限\");\t   }\t}}//输出js调用function mkhtml($fn,$fileurl,$message){\techo $str='<script type=\"text/javascript\">window.parent.CKEDITOR.tools.callFunction('.$fn.', \\''.$fileurl.'\\', \\''.$message.'\\');</script>';\texit($str);}?>\nif(!in_array($filetype,$configUp['img'])) 判断了文件类型数组$configUp['img'] \t= array(\"jpg\",\"bmp\",\"gif\",\"png\"); 然后js调用输出 很好突破直接抓包修改格式上传就ok#2 利用方式#1 首先注册一个账号#2 首页 > 用户中心 > 基本信息 头像上传文件 抓包改包上传google关键词：Powered by GV32.COM 找到约 19,300 条结果 （用时 0.29 秒） 有一定的用户量 随便找一个站测试下#http://engleeagro.com/ 注册个账号，然后头像上传 抓包改包上传成功：\n\n   修复方案：  加强验证   版权声明：转载请注明来源 宇少@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2014-10-16 09:06 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-13 08:08 |    \t\t07@jyhack.com \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:10        | 希望和大家多多交流，多多沟通、)\t\t \n  貌似厉害哦！    \n     2014-10-16 09:49 |    \t\t宇少 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:41        | Jyhack-TeaM：bbs.jyhack.com 群:308694453...)\t\t \n  你敢不敢不走小厂商，我勒个去    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}