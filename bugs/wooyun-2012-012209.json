{"id": 16677, "wybug_id": "wooyun-2012-012209", "wybug_title": "沦陷学生之家，一次漂亮的渗透与源码分析", "wybug_corp": "StarStudio", "wybug_author": "剑心", "wybug_date": "2012-09-14 15:50", "wybug_open_date": "2012-10-29 15:51", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-09-14：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2012-10-29：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 某某河畔是郫县男子dota技术专修学校里各种骚男闷女无聊打发时间的地方。使用的是pw+php bluster搭建的。负责维护的童鞋几乎把pw的基础代码都改写过了，代码安全性还是比较高的。但是这次无情的被沦陷了。 详细说明：  1. 沦陷备份服务器\t各种弱口令+cacti拿shell\t访问http://xxx.xxxhome.net，使用弱密码admin/admin进入管理页面\t上网找了几个cacti的漏洞，都没能利用上。于是自己开始下了一套cacti开始折磨。\t看到install目录下有几个.php文件，顿时眼前一亮\n\n\t把cacti的日志文件设置为这几个文件中的一个，重新登陆一下，可以看到日志确实被写进去了，那么只要想办法产生一些<?php这样的日志，就能执行代码了。最直接的想法那就是用<?php这样的用户去登录，有兴趣的同学可以继续深入，我反正没成功，cacti把尖括号神马的都过滤掉了。这条路暂时封死了。\n\n\n\n\t无聊之中，发现了同机器上竟然装了pma，尝试了下，默认密码竟然进去了。\n\n\t数据库中的poller_command引起了我的兴趣，照理说这应该是一个会导致命令执行的地方。大致看了下源码，水平搓，没有看懂究竟是执行shell命令还是php命令，实践出真知，直接写一句吧。\n\n\n\n\t等了5分钟，poller执行（试过的童鞋应该知道，啥命令都不会被执行，不知道为啥），虽然没有直接效果，但是却在log中成功写入了php代码。Then，get shell\n\n2. 代码漏洞，拿到bbs的shell\t通过观察，可以知道cacti的服务器同时还是备份服务器，bbs的代码被同步到了这个机器上。然后就是长期而苦逼的读代码的过程了。当然最直接的想法是去找调用了eval或者preg_replace这类直接能执行代码的地方。\n\n\t下面要扯一下某某河畔的论坛的登录。某某河畔论坛登录采用的是usercenter方式认证，bbs作为uc的一个application存在，每次需要认证的时候产生一个rand，记录在session中，并把需要的相关参数拼接上rand、app_key计算md5散列后作为附加参数，通过用户浏览器GET传递给uc；uc验证用户登录授权是否合法之后，将用户uid拼接上rand和app_key计算md5作为附加参数，通过用户浏览器GET回bbs。\t仔细观察登录验证的api代码，惊喜的发现一个eval。\n\n\t回查调用代码，只要通过下面代码的检查就会执行到eval，数据库密码明写在代码中，那么只要在数据库中添加一个名为“xxx.eval($_REQUEST[cmd]);//”的api就可以执行代码了。接下来的写一句话，自是不提。\n\n\n\n这次检测有几点感觉：1. 很过管理密码保持默认的危害性非常大，你完全不知道什么时候这个应用会被发现并威胁到服务器安全。特别是各种内部系统会对外开放的时候。2. 很多应用都是对外部数据防护得很好，而内部数据过于信任，根本就没有任何过滤措施。如这次cacti，可以任意指定log文件的位置，没有检查拓展名；没有检查数据库中commad的内容，直接将错误信息输出到log中；uc没有对api名做基本的检查，导致任意代码执行。3. 很多机器web目录权限总是设置不当4. APT攻击几乎总能成功5. 安全问题总是很难防护得很完善，一处被击破，处处都受影响   漏洞证明：  见漏洞详情   修复方案：  1. cacti不用就卸载掉2. web目录的除了上传目录，都不应该让www用户有写权限，而上传目录应该限制死不能执行脚本3. bbs验证登录时，需要判断referer，从非用户渠道获取是否真正成功登陆，以避免app_key泄漏带来的各种风险4. 仅仅对于用户提交的数据严格过滤是不够的，对于来自数据库，session，文件这样的内部数据也要进行安全检查   版权声明：转载请注明来源 剑心@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2012-09-14 16:05 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  题目 很漂亮 呵呵    \n     2012-09-14 17:37 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  围观我大河畔    \n     2012-09-14 17:38 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  瞅瞅有多漂亮    \n     2012-09-14 18:46 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  郫县dota?dota是豆瓣的翻译么    \n     2012-09-14 19:15 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @蟋蟀哥哥 俺们学校额。。。    \n     2012-09-14 19:48 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  @pangshenjie 郫县...那个镇上...对吧....菊花学校...是不是    \n     2012-09-14 20:05 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @蟋蟀哥哥 你太聪明了。。。。你不是还来过么。    \n     2012-09-14 20:54 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  围观技巧性动作    \n     2012-09-14 23:43 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  @pangshenjie 在那边逛过    \n     2012-09-15 08:47 |    \t\tghy459 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:5        | 深挖洞，广积shell。)\t\t \n  坐等被无视，StarStudio知道的都懂的~    \n     2012-09-15 08:48 |    \t\tghy459 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:5        | 深挖洞，广积shell。)\t\t \n  还有某某河畔是半个小时搭好的我会乱说~    \n     2012-09-15 13:53 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  围观名字    \n     2012-09-15 16:40 |    \t\tcnrstar \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:23        | Be my personal best!)\t\t \n  围观LZ，撸主很细心的读源码读了很久我会乱说~！    \n     2012-09-15 22:50 |    \t\t冰锋刺客 \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:14        | 请在监护人陪同下与本人交流)\t\t \n  等着观看文章，“漂亮的渗透” --吸引人啊 =.=    \n     2012-09-17 16:00 |    \t\tyyytest \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 菜鸟一枚，学习来的.........)\t\t \n  是郫县纺专么？？？？？？？    \n     2012-09-17 18:29 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @yyytest 显然不是，985啊亲    \n     2012-10-16 19:01 |    \t\tGolova \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:3        | 过去过不去的终究会过去。)\t\t \n  进来看pangshenjie的菊花。    \n     2012-10-29 16:00 |    \t\tshack2 \t\t\t( 普通白帽子  |\t\t\t        Rank:470 漏洞数:71        | QQ:1341413415 一个热爱编程(Java),热爱网...)\t\t \n  漂亮的爆菊    \n     2012-10-30 00:35 |    \t\t云中鹰 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:10        | 云中鹰)\t\t \n  多么好的名字~    \n     2012-10-30 09:16 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  确实漂亮！    \n     2012-10-30 23:12 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @Golova 看你妹    \n     2012-12-25 21:36 |    \t\tO.o \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:12        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  清水河畔现在没限制源IP了？@星辰     \n     2012-12-25 22:22 |    \t\tghy459 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:5        | 深挖洞，广积shell。)\t\t \n  @O.o 有外网访问地址 bbs.qshpan.com    \n     2012-12-25 23:27 |    \t\tO.o \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:12        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  @ghy459 唔=。=收藏夹没收藏它，果断了~    \n     2014-04-05 01:47 |    \t\t风之子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 好好学习...囧)\t\t \n  围观，河畔现已改版。。。    \n     2014-04-24 12:08 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n  @蟋蟀哥哥  什么学校·· 电子科大？    \n     2014-05-04 11:39 |    \t\t伟哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:29        | 不怕流氓有文化,就怕色狼有耐心,那么一只起...)\t\t \n  围观     \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}