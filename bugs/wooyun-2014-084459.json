{"id": 42875, "wybug_id": "wooyun-2014-084459", "wybug_title": "KPPW某处SQL注入一枚", "wybug_corp": "keke.com", "wybug_author": "玉林嘎", "wybug_date": "2014-11-25 21:58", "wybug_open_date": "2015-02-23 22:00", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向公众公开  简要描述： 听了一晚上7师傅 根本停不下来 详细说明：  KPPW最新版 漏洞出现在一个函数/lib/inc/keke_table_class.php第75-87行:\nfunction del($pk, $val, $url = null) {\t\tif (! $val) {\t\t\treturn false;\t\t}\t\tif (is_array ( $val ) && ! empty ( $val )) {\t\t\t$ids = implode ( ',', $val );\t\t\t$this->_table_obj->setWhere ( \" $pk in ($ids)\" );\t\t} elseif ($val) {\t\t\t$this->_table_obj->setWhere ( \"$pk = \" . $val );\t\t}\t\t$del_query = \"del_\" . $this->_pre . $this->_table_name;\t\treturn $this->_table_obj->$del_query ();\t}\n可看到$val 传进来只要不是数组且存在就会走elseif分支之后直接 未做'保护进入sql语句找找 调用点/control/user/message_detail.php/control/user/message_notice.php  存在调用且有问题2个类似 以第一个为例/control/user/message_detail.php第9-16行:\nif (isset ( $action )&&$action=='delSingle') {\t\t\tif ($msgId) {\t\t\t\t$objMsgT->del ( 'msg_id', $msgId );\t\t\t\tkekezu::show_msg ( '删除成功', 'index.php?do=user&view=message&op='.$type.'&intPage='.$intPage, NULL, NULL, 'ok' );\t\t\t} else {\t\t\t\tkekezu::show_msg ( '删除失败', NULL, NULL, NULL, 'error' );\t\t\t}}\n$msg_id直接进入函数 而$msg_id是post进来且未做任何过滤的   漏洞证明：  创建一个用户 给其他用户发一个消息\n\n\n\n\n\n传上点击查看进去 删除抓包 改包成如下 特别要把空格替换成/**/ 否则不成\n\n发包之后会显示 服务器繁忙 无视之 在查看我的发件箱 直接在当前界面删除(第一次和第二次 是在2个不同地方删除)  便可删除\n\n查看mysql日志\n\n执行sql语句了\n\n亲测可删除 网站所有 信息   修复方案：  查看其它调用del函数的地方    版权声明：转载请注明来源 玉林嘎@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-11-27 13:20 厂商回复： 感谢支持，我们会尽快修复此漏洞 最新状态： 2014-11-27：漏洞已修复  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}