{"id": 13597, "wybug_id": "wooyun-2013-019057", "wybug_title": "KesionCMS V9.03 Final SQL注射漏洞", "wybug_corp": "KesionCMS", "wybug_author": "My5t3ry", "wybug_date": "2013-02-22 17:31", "wybug_open_date": "2013-04-08 17:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["字符类型注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-02-22：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2013-04-08：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 昨天提交科讯getshell的洞，通知官方后，说是V9移除wap模块.....然后就没下文了，好吧，那就来个V9的 详细说明：  漏洞存在于User/ChinaBankAutoReceive.asp\n<%@LANGUAGE=\"VBSCRIPT\" CODEPAGE=\"936\"%><%option explicit%><!--#include file=\"../Conn.asp\"--><!--#include file=\"../Plus/md5.asp\"--><!--#include file=\"../KS_Cls/Kesion.MemberCls.asp\"--><!--#include file=\"payfunction.asp\"--><%'****************************************************' Software name:Kesion CMS 9.0' Email: service@kesion.com . QQ:111394,9537636' Web: http://www.kesion.com http://www.kesion.cn' Copyright (C) Kesion Network All Rights Reserved.'****************************************************Response.Buffer = true Response.Expires = 1 Response.CacheControl = \"no-cache\"Dim KSUser:Set KSUser=New UserClsDim KS:Set KS=New PublicClsDim PaymentPlat:PaymentPlat=1Dim RSP:Set RSP=Server.CreateObject(\"ADODB.RECORDSET\")RSP.Open \"Select top 1 * From KS_PaymentPlat where id=\" & PaymentPlat,conn,1,1If RSP.Eof Then\t\t RSP.Close:Set RSP=Nothing\t\t Response.Write \"Error!\"\t\t Response.End()End IfDim AccountID:AccountID=RSP(\"AccountID\")Dim MD5Key:MD5Key=RSP(\"MD5Key\")Dim PayOnlineRate:PayOnlineRate=KS.ChkClng(RSP(\"Rate\")) Dim RateByUser:RateByUser=KS.ChkClng(RSP(\"RateByUser\")) RSP.Close:Set RSP=Nothing Call ChinaBank()'网银在线返回Sub ChinaBank()  Dim v_oid,v_pmode,v_pstatus,v_pstring,v_string,v_amount,v_moneytype,remark2,v_md5str,text,md5text,zhuangtai' 取得返回参数值\tv_oid=request(\"v_oid\")                               ' 商户发送的v_oid定单编号\tv_pmode=request(\"v_pmode\")                           ' 支付方式（字符串） \tv_pstatus=request(\"v_pstatus\")                       ' 支付状态 20（支付成功）;30（支付失败）\tv_pstring=request(\"v_pstring\")                       ' 支付结果信息 支付完成（当v_pstatus=20时）；失败原因（当v_pstatus=30时）；\tv_amount=request(\"v_amount\")                         ' 订单实际支付金额\tv_moneytype=request(\"v_moneytype\")                   ' 订单实际支付币种\tremark2=request(\"remark2\")                           ' 备注字段2\tv_md5str=request(\"v_md5str\")                         ' 网银在线拼凑的Md5校验串\tif request(\"v_md5str\")=\"\" then\t\tresponse.Write(\"v_md5str：空值\")\t\tresponse.end\tend if\ttext = v_oid&v_pstatus&v_amount&v_moneytype&MD5Key 'md5校验\tmd5text = Ucase(trim(md5(text,32)))    '商户拼凑的Md5校验串\tif md5text<>v_md5str then\t\t' 网银在线拼凑的Md5校验串 与 商户拼凑的Md5校验串 进行对比\t  \tresponse.write(\"error\") '告诉服务器验证失败，要求重发\t    response.end '中断程序\telse\t  response.write(\"ok\")\t  if v_pstatus=20 then '支付成功\t\tCall UpdateOrder(v_amount,remark2,v_oid,v_pmode)\t\tConn.Execute(\"Update KS_LogMoney Set PaymentID=1 Where OrderID='\" & v_oid & \"'\")\t  else\t   \tresponse.write(\"error\") '告诉服务器验证失败，要求重发\t    response.end '中断程序\t  end if\tend ifend Sub%>\n上面代码中的v_oid=request(\"v_oid\")没有过滤，然后就调用了\nCall UpdateOrder(v_amount,remark2,v_oid,v_pmode)\n我们接着看UpdateOrder\nSub UpdateOrder(v_amount,remark2,v_oid,v_pmode) Dim KSUser:Set KSUser=New UserCls Dim UserName,MoneyType,Money,Remark,sqlUser,rsUser,orderid,mobile,Action orderid=v_oid IF Cbool(KSUser.UserLoginChecked) Then UserName=KSUser.UserName Else UserName=KS.S(\"UserName\")         \t\t '=======================如果从request里得不到数据，则重新取值=================\t\t If UserName=\"\" Then UserName=SUserName\t\t Dim UserCardID\t\t UserCardID=KS.ChkClng(KS.S(\"UserCardID\"))\t\t iF UserCardID=0 Then UserCardID=sUserCardID\t\t Action=KS.G(\"Action\"): If Action=\"\" Then Action=Saction\t\t '==============================================================================\t\t          Mobile=KSUser.GetUserInfo(\"Mobile\")\t\t Money=v_amount\t\t Remark=remark2\t\t Dim RSLog,RS\t\tSet RSLog=Server.CreateObject(\"ADODB.RECORDSET\")\t\tRSLog.Open \"Select top 1 * From KS_LogMoney where orderid='\" & v_oid & \"'\",Conn,1,1\t\tif RSLog.Eof And RSLog.BoF Then\t\t\t Select Case Action\t\t\t case \"shop\"   '商城中心购物\t\t\t\t Set RS=Server.CreateObject(\"ADODB.RECORDSET\")\t\t\t\t RS.Open \"Select top 1 * From KS_Order Where OrderID='\" & v_oid & \"'\",Conn,1,3\t\t\t\t If RS.Eof Then\t\t\t\t   RS.Close:Set RS=Nothing\t\t\t\t   KS.Die \"<br><li>支付过程中遇到问题，请联系网站管理员！\"\t\t\t\t End If\t\t\t\t  If Mobile=\"\" Then\t\t\t\t  Mobile=RS(\"Mobile\")\t\t\t\t  End If\t\t\t\t  RS(\"MoneyReceipt\")=Money\t\t\t\t  If Money>=RS(\"MoneyTotal\") Then\t\t\t\t\tRS(\"PayStatus\")=1  '已付清\t\t\t\t  ElseIf Money<>0 Then\t\t\t\t\t RS(\"PayStatus\")=2  '已收定金\t\t\t\t  Else\t\t\t\t\t RS(\"PayStatus\")=0  '未付款\t\t\t\t  End If\t\t\t\t  Dim OrderStatus:OrderStatus=rs(\"status\")\t\t\t\t  RS(\"Status\")=1\t\t\t\t  RS(\"PaymentPlatId\")=KS.ChkClng(Request(\"PaymentPlat\"))  '支付接口ID\t\t\t\t  RS(\"PayTime\")=now   '记录付款时间\t\t\t\t  RS.Update                  orderid=RS(\"OrderID\")\t\t\t\t  Dim XID:XID=RS(\"ID\")\t\t\t\t  Call KS.MoneyInOrOut(rs(\"UserName\"),RS(\"Contactman\"),Money,2,1,now,rs(\"orderid\"),\"System\",\"为购买订单：\" &v_oid & \"使用\" & v_pmode & \"在线充值\",0,0,0)\t\t          Call KS.MoneyInOrOut(rs(\"UserName\"),RS(\"Contactman\"),Money,4,2,now,rs(\"orderid\"),\"System\",Remark,0,0,0)\t\t\t\t  \t\t\t\t\t\t\t\t\t\t'====================更新库存量========================\t\t\t\t\tDim rsp:set rsp=conn.execute(\"select id,title from ks_product where id in(select proid from KS_OrderItem where orderid='\" & rs(\"orderid\") & \"')\")\t\t\t\t\tdo while not rsp.eof\t\t\t\t\t\t\t\t\t\t  dim rsi:set rsi=conn.execute(\"select amount,attrid from ks_orderitem where orderid='\" & rs(\"orderid\") & \"' and proid=\" & rsp(0))\t\t\t\t\t  if not rsi.eof then\t\t\t\t\t\t  if OrderStatus<>1 Then  '扣库存量\t\t\t\t\t\t   If RSI(\"AttrID\")<>0 Then\t\t\t                  Conn.Execute(\"update KS_ShopSpecificationPrice set amount=amount-\" & RSI(0) & \" Where amount>=\" & RSI(0) & \" and ID=\" & RSI(1))\t\t\t              Else\t\t\t\t\t\t   conn.execute(\"update ks_product set totalnum=totalnum-\" & rsi(0) &\" where totalnum>=\" & rsi(0) &\" and id=\" & rsp(0))        \t\t\t\t\t\t  End If\t\t\t\t\t\t  End If\t\t\t\t\t  end if\t\t\t\t\t  rsi.close\t\t\t\t\t  set rsi=nothing\t\t\t\t\t  \t\t\t\t\t  'Call KS.ScoreInOrOut(UserName,1,KS.ChkClng(rsp(0))*amount,\"系统\",\"购买商品<font color=red>\" & rsp(\"title\") & \"</font>赠送!\",0,0)\t\t\t\t\t  \t\t\t\t\trsp.movenext\t\t\t\t\tloop\t\t\t\t\trsp.close\t\t\t\t\tset rsp=nothing\t\t\t\t\t'================================================================\t\t\t\t\t\t\t\t\t\tRS.Close:Set RS=Nothing\t\t\t\t\tIF KS.C(\"UserName\")<>\"\" Then response.Redirect \"User_Order.asp?Action=ShowOrder&ID=\" & XID\t\t\t Case else   '会员中心充值\t\t\t\t\tSet rsUser=Server.CreateObject(\"Adodb.RecordSet\")\t\t\t\t\tsqlUser=\"select top 1 * from KS_User where UserName='\" & UserName & \"'\"\t\t\t\t\trsUser.Open sqlUser,Conn,1,1\t\t\t\t\tif rsUser.bof and rsUser.eof then\t\t\t\t\t\t\t\tResponse.Write \"<br><li>充值过程中遇到问题，请联系网站管理员！\"\t\t\t\t\t\t\t\trsUser.close:set rsUser=Nothing\t\t\t\t\t\t\t\texit sub\t\t\t\t\tend if\t\t\t\t\tDim RealName:RealName=rsUser(\"RealName\")\t\t\t\t\tDim Edays:Edays=rsUser(\"Edays\")\t\t\t\t\tDim BeginDate:BeginDate=rsUser(\"BeginDate\")\t\t\t\t\trsUser.Close : Set rsUser=Nothing\t\t\t\t\tIf UserCardID<>0 Then   '充值卡\t\t\t\t\t       Call UpdateByCard(0,UserCardID,UserName,RealName,Edays,BeginDate,v_oid,v_pmode)\t\t\t\t\tElse\t\t\t\t  \t Call KS.MoneyInOrOut(UserName,RealName,Money,3,1,now,v_oid,\"System\",v_pmode & \"在线充值,订单号为:\" & v_oid,0,0,0)\t\t\t\t\tEnd If\t\t\t\t\t\t\t\t End Select\t\t\t \t\tEnd If\t\tRSLog.Close:Set RSLog=NothingEnd Sub\n\nRSLog.Open \"Select top 1 * From KS_LogMoney where orderid='\" & v_oid & \"'\",Conn,1,1\n这句带入SQL了！那么然后构造参数才能触发漏洞呢？我们这样构造:/User/ChinaBankAutoReceive.asp?v_oid=1%27&v_pstatus=20&v_amount=1&v_moneytype=1&v_md5str=9B5BF7166AFBB5E1602BBCC964459B9B其中的v_oid带入我们的SQL注射语句...你懂的，后面的v_md5str是md5(v_oid&v_pstatus&v_amount&v_moneytype&MD5Key)得到的，MD5Key的值来自数据库值为0简单地说，v_oid构造SQL后，md5(v_oid&v_pstatus&v_amount&v_moneytype&MD5Key)计算出v_md5str,然后提交就行了   漏洞证明：  /User/ChinaBankAutoReceive.asp?v_oid=1%27&v_pstatus=20&v_amount=1&v_moneytype=1&v_md5str=9B5BF7166AFBB5E1602BBCC964459B9B\n\n   修复方案：  过滤，你懂的   版权声明：转载请注明来源 My5t3ry@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2013-04-07 11:06 |    \t\t黑云 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:3        | 米有)\t\t \n  联系不到厂商就一直不公开么?    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}