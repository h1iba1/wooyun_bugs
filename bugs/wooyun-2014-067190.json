{"id": 53564, "wybug_id": "wooyun-2014-067190", "wybug_title": "FengCms 过滤不言导致sql注入，可爆管理用户名密码", "wybug_corp": "fengcms.com", "wybug_author": "hkAssassin", "wybug_date": "2014-07-03 14:47", "wybug_open_date": "2014-10-01 14:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-01：\t细节向公众公开  简要描述： 这个小的cms刚问世，我就测了下。感觉还是不错。但是百密终有一疏。注入啊…… 详细说明：  \n/app/model/moduleModel.php 文件中 search函数是前台做搜索用的。具体看代码public function search($arrays,$field=\"\",$num=\"20\"){\t//\tvar_dump($arrays);\t\t//var_dump($field);\t\t//die;\t\tif($arrays['project']){\t\t\t$sql='select * from `'.DB_PREFIX.$arrays['project'].'` where title like \"%'.$arrays['tags'].'%\" or tags like \"%'.$arrays['tags'].'%\"';\t\t\t\t\t//\tvar_dump($sql);\t\t\t//die;\t\t\treturn arraypage(D($this->d_name)->excsql($sql.' order by id desc'),$num);\t\t}else{\t\t\t$arr=D($this->d_name)->field(\"project\")->where(\"type=1&&search=1\")->getall();\t\t\tif(count($arr)>1)$union=\"union\";\t\t\tforeach($arr as $k => $v){\t\t\t\tif($this->attrib($v['project'],'tags')){\t\t\t\t\t$array[]='select '.$this->fieldhandle($field).'id,title,html,time from `'.DB_PREFIX.$v['project'].'` where title like \"%'.$arrays['tags'].'%\" or tags like \"%'.$arrays['tags'].'%\" and status=1';\t\t\t\t}else{\t\t\t\t\t$array[]='select '.$this->fieldhandle($field).'id,title,html,time from `'.DB_PREFIX.$v['project'].'` where title like \"%'.$arrays['tags'].'%\" and status=1';\t\t\t\t}\t\t\t}\t\t\treturn arraypage(D($this->d_name)->excsql(\"select  * from (\".implode(\" union \",$array).\") h order by time desc\"),$num);\t\t}\t}这段代码中最终调用了D($this->d_name)->excsql（）来执行sql语句。通过跟踪发现。excsql这个函数位于/system/core/model.php中。函数如下：public function excsql($sql){        return $this->db->fetch($this->db->query($sql)); \t }可以看到直接调用了数据库中的query查询。而此处的query位于/system/driver/db_mysqli.php中。函数如下：public function query($sql){\t\t// 验证连接是否正确        if (!$this->is_links())return throwexce(sprintf('Supplied argument is not a valid MySQLI-Link resource.'));\t\t$this->query_id = mysqli_query($this->link_id,$sql);可以看到最后一句直接调用了mysqli_query()执行了sql语句。虽然此cms用了全局过滤的方法来防范sql注入。但是这个地方全局过滤是不起作用的。因为第一：整个查询没有用到单引号，而是用了双引号。即使此处用了单引号也还是不起作用。因为你们查询的时候是通过html模板传过来的。全局过滤没注意到这个地方。所以造成了注入。具体利用看漏洞证明。\n   漏洞证明：  mysql的监控日志中得到的。可以看到语句确实被带入了可以执行。\n\n通过构造可以爆出管理员密码等信息\n\n   修复方案：  你们应该懂%…………   版权声明：转载请注明来源 hkAssassin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-07-04 10:45 厂商回复： 感谢您对FENGCMS的支持…… 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-08 12:37 |    \t\tFengCMS(乌云厂商)\t\t \n  FengCms安全测试站地址：http://guf521656.h163.92hezu.org/ 有效期2014-7-8至2014-7-15 欢迎各位安全界的朋友帮我们寻找安全漏洞！作为一个小小的创业团队，对各位朋友对FengCms的关注表示衷心的感谢！    \n     2014-07-08 13:01 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  @FengCMS rank 能给高点不，本来就走的小厂商流程，你给10rank到我手里只有2rank了。代码审计很累的有木有……而且我还想说你们的设计是存在缺陷的。私信个联系方式我告诉你……记得以后多给rank 拉拉拉拉拉拉……    \n     2014-07-08 14:57 |    \t\tFengCMS(乌云厂商)\t\t \n  @hkAssassin 不好意思。这个漏洞不是我确认的，是程序员确认的。下次一定注意！我的邮箱 web@fengcms.com QQ：97007948    \n     2014-07-09 13:07 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  @FengCMS 看到这个回复，我只想说。我爱你！亲爱的……    \n     2014-07-10 16:23 |    \t\tFengCMS(乌云厂商)\t\t \n  非常感谢各位白帽子的辛勤工作！FengCms安全测试站地址：http://guf521656.h163.92hezu.org/ 已经升级到最新版本 有效期2014-7-8至2014-7-15 欢迎各位安全界的朋友帮我们寻找安全漏洞！作为一个小小的创业团队，对各位朋友对FengCms的关注表示衷心的感谢！@hkAssassin    \n     2014-07-16 14:19 |    \t\t果冻好吃 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:11        | 大学通知书下来那天，我迫不及待的用四百块...)\t\t \n  @FengCMS 我只想说。我爱你！对厂商赞个！    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}