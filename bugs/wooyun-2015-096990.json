{"id": 40829, "wybug_id": "wooyun-2015-096990", "wybug_title": "qibocms全部开源系统前台注入一枚", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2015-02-13 13:48", "wybug_open_date": "2015-05-14 15:06", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-14：\t细节向公众公开  简要描述： 无视GPC。因为出现的问题还是在公共文件上出的问题。而且是每个qibo的每个系统都必须有的文件所以每个系统都存在。之前在360发的, 然后刚放假 就再去官网下载个新的来看。惨不忍睹。用v7整站系统来演示一下最近通用漏洞貌似要好好查啊,写详细点。 详细说明：  最新下载地址 http://down.qibosoft.com/down.php?v=v7之前在360发了个 后面看到补了，之前的漏洞文件 vote/vote.php来看看\nforeach($voteId AS $key=>$value)\t{\t\t$value=addslashes($value); //对比之前的是 加了一个来转义。\t\t$db->query(\"UPDATE {$pre}vote_element SET votenum=votenum+1 WHERE id='$value' \");\t}\n这样是修复了这里没错 但是没修到实处。导致了我们还可以找到其他的文件的注入。继续来看看inc/common.inc.php中 这个公共文件 是每个qibo的系统都必须有的。\n$_POST=Add_S($_POST);$_GET=Add_S($_GET);$_COOKIE=Add_S($_COOKIE);function Add_S($array){\tforeach($array as $key=>$value){\t\t@eregi(\"['\\\\\\\"]+\",$key) && die('ERROR KEY!');\t\tif(!is_array($value)){\t\t\t\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}if(!ini_get('register_globals')){\t@extract($_FILES,EXTR_SKIP);//这里是漏洞点。  //可以看到上面的判断条件是 判断register globals 是不是开启的。 // 如果是关闭的 才会进入。 注意是关闭 不是开启哦。。  // regitser globals这个不用多说 从php 4.2开始默认都是off的 // 基本都是关闭的 曾经提交漏洞 因为需要register globals on 所以被未通过。 //  当是off的时候 extract来把_FILES里的读取出来 用了EXTR_SKIP参数 //  所以不能覆盖之前存在的变量 但是qibo是伪全局 所以我们可以找一个未初始化的 //  _FILES extract出来后 还是一个数组 所以找一个把数组循环出来的 //  因为_FILES数组里的key是我们不可控制的把, 但是一些value可以控制 例如name}\n所以就要去找一个 把数组循环出来的value带入查询的。因为之前发了个 把vote/vote.php里面的那处修复了 所以就需要另外找一处了。找了一会　才找到了一处。。在member/comment.php中\nif($job=='del'){\tforeach( $cidDB AS $key=>$value){\t\t$rs=$db->get_one(\"SELECT aid FROM {$pre}comment WHERE cid='$value'\");//把value带入了查询。\t\t$erp=get_id_table($rs[aid]);\t\t$rsdb=$db->get_one(\"SELECT C.cid,C.uid AS commentuid,C.aid,A.uid,A.fid FROM {$pre}comment C LEFT JOIN {$pre}article$erp A ON C.aid=A.aid WHERE C.cid='$value'\");\t\tif($rsdb[uid]==$lfjuid||$rsdb[commentuid]==$lfjuid||$web_admin||in_array($rsdb[fid],$fiddb)){\t\t\t$db->query(\"DELETE FROM {$pre}comment WHERE cid='$rsdb[cid]'\");\t\t}\t\t$db->query(\"UPDATE {$pre}article$erp SET comments=comments-1 WHERE aid='$rsdb[aid]'\");\t}\n   漏洞证明：  \n\n利用放到下面的购买板块啦。利用很简单  如果能看懂的话 就自己去构造构造把 就别来购买了。这个member/comment.php 是需要登录一个会员的其实地方门户系统还有其他的地方是不需要登录会员的。但是这里我就不多说了。   修复方案：  _FILES过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-02-13 15:05 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-13 13:51 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  过年又发了！！！！    \n     2015-02-13 13:53 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  前排！    \n     2015-02-13 14:36 |    \t\t炊烟 \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:44        | 每一天都需要努力。)\t\t \n  雨牛又回来了！！    \n     2015-02-13 14:41 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  放假了。。    \n     2015-02-13 14:56 |    \t\t牧马 \t\t\t( 普通白帽子  |\t\t\t        Rank:107 漏洞数:17        | 我是要成为猪猪侠的男人。。。。)\t\t \n  雨牛id的空格不见了？    \n     2015-02-13 15:01 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @牧马 对捏 有空格@不到 就麻烦 就把空格去掉了。    \n     2015-02-13 15:01 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  话说咋看不到那POC板块了。。    \n     2015-02-13 16:19 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  前天放的假吧 给跪了    \n     2015-02-13 18:49 |    \t\t%270x5c \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:23        | 乌拉拉)\t\t \n  为何要这么叼    \n     2015-02-13 23:22 |    \t\t小菜虫 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:5        )\t\t \n  雨神 是变量覆盖吗    \n     2015-02-17 21:27 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:42        | 最大的漏洞就是人)\t\t \n  @′雨。 还能改ID???    \n     2015-03-17 19:25 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  common.inc 和我猜测的一样，果真是common文件问题 看样子思路这东西能通用啊    \n     2015-05-14 16:06 |    \t\t超蓝 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 换个马甲好好做人，请叫我暧昧)\t\t \n  叼屌屌    \n     2015-05-14 16:59 |    \t\tsql小神 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 有些漏洞可以提，有些漏洞不可以提。)\t\t \n  雨神又来了    \n     2015-05-14 21:50 |    \t\tbobbi \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 人生真是寂寞如雪)\t\t \n  求构造语句    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}