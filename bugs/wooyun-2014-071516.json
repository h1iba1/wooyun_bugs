{"id": 196, "wybug_id": "wooyun-2014-071516", "wybug_title": "Discuz 5.x 6.x 7.x 前台SQL注入漏洞一枚", "wybug_corp": "Discuz!", "wybug_author": "′雨。", "wybug_date": "2014-08-08 10:46", "wybug_open_date": "2014-11-06 10:48", "wybug_type": "SQL注射漏洞", "wybug_level": "低", "wybug_rank_0": "1", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-06：\t细节向公众公开  简要描述：  自从补课补完了 感觉自己都完全荒废了。   睡觉 看电视 看小说。  唉。   得开始努力学习考大学 哦也。_________________________________________________________________________看到map牛 发了几个dz7.2的 也看到还在更新 我也就看了看前台注入一枚, 也都知道 如果ucenter 和 DZ 在一个裤里面的话就可以拿到uc_key拿到uc_key了 然后……。很简单的一个洞。 详细说明：  http://download.discuz.net/Discuz/7.2/Discuz_7.2_SC_GBK.zip刚在官网下的这个。首先说一下 这洞需要有权限发布投票才行 刚注册的会员是不能发布投票的我看了下默认发布投票需要的权限 需要从注册会员开始才有发布投票的权限\n\n\n\n看了一下注册会员所需要的积分是50分50分 上传个头像 做个任务就差不多了(所以狗哥 这不算限制条件把?)_________________________________________________________________________在post.php中从263行开始 也就是最后的那几行\nif($action == 'newthread') {\t($forum['allowpost'] == -1) && showmessage('forum_access_disallow');\trequire_once DISCUZ_ROOT.'./include/newthread.inc.php';} elseif($action == 'reply') {\t($forum['allowreply'] == -1) && showmessage('forum_access_disallow');\trequire_once DISCUZ_ROOT.'./include/newreply.inc.php';} elseif($action == 'edit') {\t($forum['allowpost'] == -1) && showmessage('forum_access_disallow');\trequire_once DISCUZ_ROOT.'./include/editpost.inc.php';} elseif($action == 'newtrade') {\t($forum['allowpost'] == -1) && showmessage('forum_access_disallow');\trequire_once DISCUZ_ROOT.'./include/newtrade.inc.php';}\n包含了这么多文件进来 我找了这个文件看了起来include/editpost.inc.php然后在include/editpost.inc.php 第272行左右\nif($thread['special'] == 1 && ($alloweditpoll || $isorigauthor) && !empty($polls)) {\t\t\t\t$pollarray = '';\t\t\t\t$pollarray['options'] = $polloption;\t\t\t\tif($pollarray['options']) {\t\t\t\t\tif(count($pollarray['options']) > $maxpolloptions) {\t\t\t\t\t\tshowmessage('post_poll_option_toomany');\t\t\t\t\t}\t\t\t\t\tforeach($pollarray['options'] as $key => $value) {\t\t\t\t\t\tif(!trim($value)) {\t\t\t\t\t\t\t$db->query(\"DELETE FROM {$tablepre}polloptions WHERE polloptionid='$key' AND tid='$tid'\");\t\t\t\t\t\t\tunset($pollarray['options'][$key]);\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\t$polladd = ', special=\\'1\\'';\n\t\tforeach($pollarray['options'] as $key => $value) {这里直接把数组中的key带入到了delete查询当中。再来看一下dz的全局文件\nforeach(array('_COOKIE', '_POST', '_GET') as $_request) {\tforeach($$_request as $_key => $_value) {\t\t$_key{0} != '_' && $$_key = daddslashes($_value);\t}}\n\nfunction daddslashes($string, $force = 0) {\t!defined('MAGIC_QUOTES_GPC') && define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());\tif(!MAGIC_QUOTES_GPC || $force) {\t\tif(is_array($string)) {\t\t\tforeach($string as $key => $val) {\t\t\t\t$string[$key] = daddslashes($val, $force);\t\t\t}\t\t} else {\t\t\t$string = addslashes($string);\t\t}\t}\treturn $string;}\n这里先判断了gpc是否开启 如果没有开启 就用addslashes再来转义这里对数组中的value进行转义 key无过滤。\n$db->query(\"DELETE FROM {$tablepre}polloptions WHERE polloptionid='$key' AND tid='$tid'\n所以再进行这个查询的时候 我们就可以引入单引号了。_______________________________________________________________在执行循环之前有一个条件 if($thread['special'] == 1 && ($alloweditpoll || $isorigauthor) && !empty($polls))这里($alloweditpoll || $isorigauthor) $isorigauthor判断是不是你是作者 如果你编辑的是你的文章的话 肯定是true。 $polls 这个直接就可以控制。$thread['special'] == 1 之前我一直在纠结这个是啥东西。。后面看了看发文章的时候的代码 这个$thread['special'] == 1代表的就是发布的是投票。那如果我们自己发布一个投票 然后再编辑 就可以进入这里了。\n\n首先发布一个投票。 发布完后 再点击编辑。然后再抓一下包。这里我输出了一下\n$polladd = '';\t\t\tif($thread['special'] == 1 && ($alloweditpoll || $isorigauthor) && !empty($polls)) {\t\t\t\t$pollarray = '';\t\t\t\t\t\t\t\t$pollarray['options'] = $polloption;\t\t\tvar_dump ($polloption);exit;//输出\n\n\n我擦 一看竟然已经有值了?在这里我本来已经准备放弃了,  但是还是抱着试一试的态度 在url写了这个\n\n发现还是可以控制 而且单引号 理所应当的没有被转义。那不是就可以注入了吗? 构造一下语句。\nif(!trim($value)) {\t\t\t\t\t\t\t$db->query(\"DELETE FROM {$tablepre}polloptions WHERE polloptionid='$key' AND tid='$tid'\");\n因为这里 数组中的value为false的时候才会进去所以这里数组的value我们就不写\n\n成功出数据。   漏洞证明：  \n\n   修复方案：  foreach($pollarray['options'] as $key => $value) {$key=addslashes($key);\t\t\t\t\t\tif(!trim($value)) {\t\t\t\t\t\t\t$db->query(\"DELETE FROM {$tablepre}polloptions WHERE polloptionid='$key' AND tid='$tid'\");? 还是看你们把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-08-12 12:38 厂商回复： 问题收下。感谢您对discuz的关注，不过对于 dz7以及之前的版本，我们已经停止维护，产品距离现在都4，5年了。我们只能尽力敦促用户尽可能的升级到最新版 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-08 10:46 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  mark    \n     2014-08-08 10:49 |    \t\tonlycjeg \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:5        | 我就看看,我不说话.)\t\t \n  好好补课啊，骚年；    \n     2014-08-08 10:50 |    \t\tdo9gy \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:15        | Dog loves God。)\t\t \n  膜拜    \n     2014-08-08 10:55 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @′ 雨。大牛你要火了    \n     2014-08-08 10:56 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  @@！    \n     2014-08-08 10:56 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  我日，膜拜....    \n     2014-08-08 11:00 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  mark    \n     2014-08-08 11:04 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  还能不能愉快的挖洞了~~~    \n     2014-08-08 11:05 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  牛逼！    \n     2014-08-08 11:06 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  危害等级：\t低自评为什么是低？有限制？    \n     2014-08-08 11:07 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  又来    \n     2014-08-08 11:24 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @索马里的海贼 因为太简单了。。。。    \n     2014-08-08 11:40 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 Discuz 7.2前台SQL注入漏洞一枚    \n     2014-08-08 11:41 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @′  雨。 怎么简单？    \n     2014-08-08 12:15 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  我擦，碉堡了，雨神V5    \n     2014-08-08 12:18 |    \t\tchar \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:3        | 中国平安，不只保险这么简单。)\t\t \n  @′  雨。 应该看影响程度定危害等级。    \n     2014-08-08 12:28 |    \t\t浅兮 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:30        )\t\t \n  支持支持，又有oday了！嘿嘿！    \n     2014-08-08 14:00 |    \t\tphantomer \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:4        | 菜比一个。求勿喷。)\t\t \n  叼~    \n     2014-08-08 15:05 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  仔细看了下 5.x 6.x 7.x 都存在这洞。  狗哥 换个霸气点的标题可好@疯狗    \n     2014-08-08 15:22 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @′  雨。 流弊～～～    \n     2014-08-08 15:27 |    \t\t        Jn·  \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:14        | 本小菜很可爱，如果不服你TM来打我啊--哎呀...)\t\t \n  @′  雨。 流弊~~~~    \n     2014-08-08 15:48 |    \t\tMelody \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 啊)\t\t \n  V5V5V5    \n     2014-08-08 16:22 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 确认就行    \n     2014-08-08 16:36 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @疯狗 变态啊！！！    \n     2014-08-08 17:10 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  你们这群大便态    \n     2014-08-08 17:14 |    \t\tbitcoin \t\t\t( 普通白帽子  |\t\t\t        Rank:715 漏洞数:218        | 学习是最好的投资！)\t\t \n  大牛大牛，求带！    \n     2014-08-08 17:30 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  流弊~我找了两天都没找到    \n     2014-08-09 22:05 |    \t\t冉冉升起 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | ...)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 Discuz 7.2前台SQL注入漏洞一枚     \n     2014-08-10 12:39 |    \t\t有妹子送上 \t\t\t( 实习白帽子  |\t\t\t        Rank:89 漏洞数:28        | 杭州最帅的男人)\t\t \n  mk    \n     2014-08-11 18:10 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  mark    \n     2014-08-11 22:52 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-08-12 13:01 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  http://www.discuz.net/thread-3579915-1-1.html@Discuz! 7.x不是还在发补丁?    \n     2014-08-12 14:02 |    \t\t蓝莓说 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 爱网络安全 代码审计 php网站开发)\t\t \n  @′ 雨。   补丁已经不出了别指望在修复了    \n     2014-08-12 14:03 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @蓝莓说 。。。。。。。。。。。。。    \n     2014-08-12 14:36 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @蓝莓说 wp的0day呢？DZ！X的0day呢？求一键getshell    \n     2014-08-12 14:45 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  人家都停止维护4，5年了    \n     2014-08-13 13:31 |    \t\t大风对我说 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 酱油党)\t\t \n  牛逼    \n     2014-08-17 00:32 |    \t\t取经中的稳健少年 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 取经中的稳健少年)\t\t \n  这是要飞的节奏啊    \n     2014-09-04 11:32 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  PHP为何会出这种漏洞啊……其它语言好像都没见过    \n     2014-09-04 11:59 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @wefgod  php数组是哈希表，biubiubiu    \n     2014-09-15 20:56 |    \t\tsec_jtn \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:56        | 本想无耻的刷rank，最后发现是我想太多了。...)\t\t \n  ....小菜看了整个人都不舒服了    \n     2014-09-22 20:43 |    \t\t5nooze \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 菜笔)\t\t \n  关注..    \n     2014-10-16 10:46 |    \t\tQinHeart \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 乌云奖金:690150.00 元)\t\t \n  关注    \n     2014-12-06 09:42 |    \t\t拨开乌云 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        )\t\t \n  @索马里的海贼 因为低调与版本低    \n     2015-01-14 11:34 |    \t\t%230CC \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 溜溜)\t\t \n  膜拜    \n     2015-02-05 13:07 |    \t\t血梦 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:11        | www.blackcyber.org)\t\t \n  膜拜    \n     2015-03-05 10:52 |    \t\t哎呦我去 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | 新手白帽子！！继续努力)\t\t \n  大牛无处不在啊    \n     2015-04-21 20:09 |    \t\t子非鱼 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:14        | 联系Q896738539)\t\t \n  不明真相的围观群众！    \n     2015-04-24 23:32 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  为什么这么老的版本的洞现在才被人发现，    \n     2015-05-27 16:58 |    \t\taygj1412 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 只有神知道的世界)\t\t \n  间隔那么久还有人用啊？    \n     2015-07-22 08:31 |    \t\t九零奶嘴 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:4        | 小菜比)\t\t \n  膜拜大神    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}