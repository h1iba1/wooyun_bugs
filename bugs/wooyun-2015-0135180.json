{"id": 67216, "wybug_id": "wooyun-2015-0135180", "wybug_title": "metinfo 一处设计不当（可重置管理员密码）", "wybug_corp": "MetInfo", "wybug_author": "淡蓝色の忧伤", "wybug_date": "2015-08-19 11:23", "wybug_open_date": "2015-11-17 11:30", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-17：\t细节向公众公开  简要描述： 其实有点鸡肋的但是确实可以改 详细说明：  \\admin\\admin\\getpassword.php 第42行 找回密码步骤2\ncase 'next2':\t\t//此处省略x+y 字  O(∩_∩)O哈！\t\t\t}\t\t\tif($admin_list){\t\t\t\t$met_fd_usename=$met_fd_usename;\t\t\t\t$met_fd_fromname=$met_fd_fromname;\t\t\t\t$met_fd_password=$met_fd_password;\t\t\t\t$met_fd_smtp=$met_fd_smtp;\t\t\t\t$met_webname=$met_webname;\t\t\t\t$met_weburl=$met_weburl;\t\t\t\t$adminfile=$url_array[count($url_array)-2];\t\t\t\t$from=$met_fd_usename;\t\t\t\t$fromname=$met_fd_fromname;\t\t\t\t$to=$admin_list['admin_email'];\t\t\t\t$usename=$met_fd_usename;\t\t\t\t$usepassword=$met_fd_password;\t\t\t\t$smtp=$met_fd_smtp;\t\t\t\t$title=$met_webname.$lang_getNotice;\t\t\t\t$x = md5($admin_list[admin_id].'+'.$admin_list[admin_pass]);\t\t\t\t$outime=3600*24*3;\t\t\t\t$String=authcode($admin_list[admin_id].\".\".$x,'ENCODE', $met_webkeys, $outime);\t\t\t\t$String=urlencode($String);\t\t\t\t$mailurl= $met_weburl.$adminfile.'/admin/getpassword.php?p='.$String;\t\t\t\t$body =\"<style type='text/css'>\\n\";\t\t\t\t$body .=\"#metinfo{ padding:10px; color:#555; font-size:12px; line-height:1.8;}\\n\";\t\t\t\t$body .=\"#metinfo .logo{ border-bottom:1px dotted #333; padding-bottom:5px;}\\n\";\t\t\t\t$body .=\"#metinfo .logo img{ border:none;}\\n\";\t\t\t\t$body .=\"#metinfo .logo a{ display:block;}\\n\";\t\t\t\t$body .=\"#metinfo .text{ border-bottom:1px dotted #333; padding:5px 0px;}\\n\";\t\t\t\t$body .=\"#metinfo .text p{ margin-bottom:5px;}\\n\";\t\t\t\t$body .=\"#metinfo .text a{ color:#70940E;}\\n\";\t\t\t\t$body .=\"#metinfo .copy{ color:#BBB; padding:5px 0px;}\\n\";\t\t\t\t$body .=\"#metinfo .copy a{ color:#BBB; text-decoration:none; }\\n\";\t\t\t\t$body .=\"#metinfo .copy a:hover{ text-decoration:underline; }\\n\";\t\t\t\t$body .=\"#metinfo .copy b{ font-weight:normal; }\\n\";\t\t\t\t$body .=\"</style>\\n\";\t\t\t\t$body .=\"<div id='metinfo'>\\n\";\t\t\t\tif($met_agents_type<=1){\t\t\t\t\t$body .=\"<div class='logo'><a href='$met_weburl' title='$met_webname'><img src='http://www.metinfo.cn/upload/200911/1259148297.gif' /></a></div>\";\t\t\t\t}\t\t\t\t$body .=\"<div class='text'><p>\".$lang_hello.$admin_name.\"</p><p>$lang_getTip1</p>\";\t\t\t\t$body .=\"<p><a href='$mailurl'>$mailurl</a></p>\\n\";\t\t\t\tif($met_agents_type<=1){\t\t\t\t\t$body .=\"<p>$lang_getTip2</p></div><div class='copy'>$foot</a></div>\";\t\t\t\t}\t\t\t\trequire_once ROOTPATH.'include/jmail.php';\t\t\t\t$sendMail=jmailsend($from,$fromname,$to,$title,$body,$usename,$usepassword,$smtp);\t\t\t\tif($sendMail==0){\t\t\t\t\trequire_once ROOTPATH.'include/export.func.php';\t\t\t\t\t$post=array('to'=>$to,'title'=>$title,'body'=>$body);\t\t\t\t\t$met_file='/passwordmail.php';\t\t\t\t\t$sendMail=curl_post($post,30);\t\t\t\t\tif($sendMail=='nohost')$sendMail=0;\t\t\t\t\t}\t\t\t\t\t\t\t\t$text=$sendMail?$lang_getTip3.$lang_memberEmail.'：'.$admin_list['admin_email']:$lang_getTip4;\t\t\t\tokinfo('../index.php',$text);\t\t\t}\t\t}\n最重要的是 这句$sendMail=jmailsend($from,$fromname,$to,$title,$body,$usename,$usepassword,$smtp);发送邮件的函数$usename,$usepassword,$smtp这三个变量来自$met_fd_usename $met_fd_password $met_fd_smtp回溯这三个变量在config/config.inc.php\n/*读配置数据*/$_M[config][tablepre]=$tablepre;$query = \"SELECT * FROM $met_config WHERE lang='$lang' or lang='metinfo'\";$result = $db->query($query);while($list_config= $db->fetch_array($result)){\t$_M[config][$list_config['name']]=$list_config['value'];\tif($metinfoadminok)$list_config['value']=str_replace('\"', '&#34;', str_replace(\"'\", '&#39;',$list_config['value']));\t$settings_arr[]=$list_config;\tif($list_config['columnid']){\t\t$settings[$list_config['name'].'_'.$list_config['columnid']]=$list_config['value'];\t}else{\t\t$settings[$list_config['name']]=$list_config['value'];\t}\tif($list_config['flashid']){\t\t$list_config['value']=explode('|',$list_config['value']);\t\t$falshval['type']=$list_config['value'][0];\t\t$falshval['x']=$list_config['value'][1];\t\t$falshval['y']=$list_config['value'][2];\t\t$falshval['imgtype']=$list_config['value'][3];\t\t$list_config['mobile_value']=explode('|',$list_config['mobile_value']);\t\t$falshval['wap_type']=$list_config['mobile_value'][0];\t\t$falshval['wap_y']=$list_config['mobile_value'][1];\t\t$met_flasharray[$list_config['flashid']]=$falshval;\t}}$_M[lang]=$lang;@extract($settings);\n这段代码不是重点，只是说明一下变量在这里赋值的而已但是在公共文件admin/include/common.inc.php第50 行引入require_once ROOTPATH.'config/config.inc.php';但是70 行是伪全局代码\nforeach(array('_COOKIE', '_POST', '_GET') as $_request) {\tforeach($$_request as $_key => $_value) {\t\t$_key{0} != '_' && $$_key = daddslashes($_value,0,0,1);\t\t$_M['form'][$_key]=daddslashes($_value,0,0,1);\t}}\n所以这这些变量都可以覆盖，那样我们就把$met_fd_usename $met_fd_password $met_fd_smtp 覆盖为我们自己的邮箱这样我们可以让找回密码的邮件用我们的邮箱发送。然后我们登录邮箱，找到邮件记录 -> 改密码   漏洞证明：  依据metinfo的伪全局机制，我们只要在cookie中添加met_fd_usename =  邮箱用户名met_fd_password = 邮箱密码met_fd_smtp = 邮箱服务器就可以了   修复方案：     版权声明：转载请注明来源 淡蓝色の忧伤@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-08-19 11:28 厂商回复： 后续版本中修复此漏洞，感谢您的反馈。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}