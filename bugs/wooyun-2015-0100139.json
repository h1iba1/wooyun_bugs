{"id": 37245, "wybug_id": "wooyun-2015-0100139", "wybug_title": "doyo建站程序平行权限问题2处", "wybug_corp": "wdoyo.com", "wybug_author": "linadmin", "wybug_date": "2015-03-09 17:23", "wybug_open_date": "2015-06-07 18:26", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向公众公开  简要描述： doyo建站程序平行权限问题2处 详细说明：  小伙伴和我看了下doyoCMS的逻辑，交wooyun小伙伴们看看是不是个漏洞首先出现问题的地方是这段代码代码位置：/source/member.phpfunction mydel(){//多处逻辑越权操作\t\t$molds=$this->syArgs('molds',1);\t\t$id=$this->syArgs('id'); \t\tswitch ($molds){\t\t\tcase 'comment':\t\t\t\tif(!syDB('comment')->delete(array('cid'=>$id,'user'=>$this->my['user']))){\t\t\t\t\tmessage(\"删除失败,请重新提交\");\t\t\t\t}\t\t\tbreak;\t\t\tcase 'message':\t\t\t\tif(!syDB('message')->delete(array('id'=>$id,'user'=>$this->my['user']))){\t\t\t\t\tmessage(\"删除失败,请重新提交\");\t\t\t\t}\t\t\t\tsyDB('message_field')->delete(array('aid'=>$id));\t\t\tbreak;\t\t\tdefault:\t\t\t\t$c=syDB($molds)->find(array('id'=>$id,'user'=>$this->my['user'],'usertype'=>1),null,'id,isshow');\t\t\t\tif(!$c||$c['isshow']==1)message(\"此内容已经审核或不是您发布的内容，不能删除。\");\t\t\t\tif(!syDB($molds)->delete(array('id'=>$id,'user'=>$this->my['user'],'usertype'=>1))){\t\t\t\t\tmessage(\"删除失败,请重新提交\");\t\t\t\t}\t\t\t\tsyDB($molds.'_field')->delete(array('aid'=>$id));\t\t\tbreak;\t\t}\t\t$w=array('aid'=>$id,'molds'=>$molds);\t\tforeach(syDB('member_file')->findAll($w,null,'url') as $v){@unlink($v['url']);}\t\tsyDB('member_file')->delete($w);\t\tmessage(\"删除成功\");\t}这么看不方便，我上一张图：\n\n代码从URL获得了$molds $id两个变量然后进入判断，问题在设计逻辑上，假如$molds被赋值为comment进入308行case,后面无论id等于多少语句不会出错，所以就会执行成功，然后跳出，进入328行，这时候molds固定，而id是可控的，所以数据库member_file中的数据就会被人为控制删掉，并且数据库链接中的实际图片文件也会别unlink掉验证一下：首先注册用户，登陆之查看数据库\n\n删除aid=11的图片\n\n结果\n\n验证了我的猜想说他越权原因在于，这个数据库存放的资源uid是隶属于不同人的，也就是说在删除的时候没有考虑uid,这里uid很明显0，也就是管理员的uid,里面的图片也是管理员放的产品图片，所以可以认为是越权操作，利用其可以删除别人的图片资源，导致网站丢图。同理，这个地方还有另一处越权操作访问如图链接：\n\n删除message的同时，可以随意删掉别人的应聘请求（这个地方是字段属于应聘请求数据）\n\n如果说上一处还存在争议，这一处绝对没有问题。实测可用。   漏洞证明：  如上图片，太难贴图就不贴了   修复方案：  增加数据库造作中uid的识别   版权声明：转载请注明来源 linadmin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：9  确认时间：2015-03-09 18:24 厂商回复： 感谢提供 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-30 11:47 |    \t\tBMa \t\t\t( 普通白帽子  |\t\t\t        Rank:1776 漏洞数:200        )\t\t \n  @linadmin 这里应该是 假如$molds被赋值为message，进入313行case，后面无论id等于多少语句不会出错，所以就会执行成功    \n     2015-03-30 18:13 |    \t\tlinadmin \t\t\t( 实习白帽子  |\t\t\t        Rank:50 漏洞数:30        | 低调进取，低调为人)\t\t \n  @BMa 对对对！这个地方是我疏忽了，我的错误！多谢指出！:)    \n     2015-03-30 18:28 |    \t\tBMa \t\t\t( 普通白帽子  |\t\t\t        Rank:1776 漏洞数:200        )\t\t \n  @linadmin :)     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 9, "Ranks": null}