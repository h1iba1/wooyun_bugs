{"id": 18270, "wybug_id": "wooyun-2012-09134", "wybug_title": "蚂蚁游戏官方服务器设置不当成功入侵", "wybug_corp": "领聚乐娱科技（天津）有限公司", "wybug_author": "GuoKer（ZhuLiu）", "wybug_date": "2012-07-02 13:37", "wybug_open_date": "2012-08-16 13:38", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方框架", "解析漏洞", "远程代码执行", "文件上传", "远程命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-07-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-07-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-07-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-07-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-08-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-08-16：\t细节向公众公开  简要描述： 蚂蚁游戏官方服务器设置不当 存在解析漏洞 详细说明：  两个漏洞  服务器解析漏洞 和现在很火的struts2命令执行漏洞0x0.1 解析漏洞\n\n随便注册一个用户然后在修改头像这边上传一个包含有恶意代码的图片http://www.gamemayi.com/mayi.website/upload/20120630042642423.jpg上传好了这样一个图片文件然后在图片后缀的后面加上1.phphttp://www.gamemayi.com/mayi.website/upload/20120630042642423.jpg/1.php服务器就会让这张图片以PHP的方式运行进而获取到网站权限\n\n-------------------------------------------------------------------0x0.2 struts2命令执行漏洞http://www.gamemayi.com/mayi.website/web!index.actionroot权限\n\n0xEnd-------------------------   漏洞证明：  \n\n   修复方案：  0x.01解析漏洞 网上提供的临时解决方法有：　　方法①、修改php.ini，设置 cgi.fix_pathinfo = 0;然后重启php-cgi。此修改会影响到使用PATH_INFO伪静态的应用，例如我以前博文的URL：http://blog.s135.com/read.php/348.htm 就不能访问了。　　方法②、在nginx的配置文件添加如下内容后重启：if ( $fastcgi_script_name ~ ..*/.*php ) {return 403;}。该匹配会影响类似 http://www.domain.com/software/5.0/test.php（5.0 为目录），http://www.domain.com/goto.php/phpwind 的URL访问。　　方法③、对于存储图片的location{…}，或虚拟主机server{…}，只允许纯静态访问，不配置 PHP访问。例如在金山逍遥网论坛、SNS上传的图片、附件，会传送到专门的图片、附件存储服务器集群上（pic.xoyo.com），这组服务器提供纯静态服务，无任何动态PHP配置。各大网站几乎全部进行了图片服务器分离，因此Nginx的此次漏洞对大型网站影响不大。　　本人再提供一种修改nginx.conf配置文件的临时解决方法，兼容“http://blog.s135.com/demo/0day/phpinfo.php/test” 的PATH_INFO伪静态，拒绝“http://www.2cto.com/PreviousFile/Article/201007/20100701104324770.jpg/test.php” 的漏洞攻击：location ~* .*.php($|/){if ($request_filename ~* (.*).php) {set $php_url $1;}if (!-e $php_url.php) {return 403;}fastcgi_pass 127.0.0.1:9000;fastcgi_index index.php;include fcgi.conf;}　　也可将以下内容写在 fcgi.conf文件中，便于多个虚拟主机引用：if ($request_filename ~* (.*).php) {set $php_url $1;}if (!-e $php_url.php) {return 403;}fastcgi_param GATEWAY_INTERFACE CGI/1.1;fastcgi_param SERVER_SOFTWARE nginx;fastcgi_param QUERY_STRING $query_string;fastcgi_param REQUEST_METHOD $request_method;fastcgi_param CONTENT_TYPE $content_type;fastcgi_param CONTENT_LENGTH $content_length;fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;fastcgi_param SCRIPT_NAME $uri;fastcgi_param REQUEST_URI $request_uri;fastcgi_param DOCUMENT_URI $document_uri;fastcgi_param DOCUMENT_ROOT $document_root;fastcgi_param SERVER_PROTOCOL $server_protocol;fastcgi_param REMOTE_ADDR $remote_addr;fastcgi_param REMOTE_PORT $remote_port;fastcgi_param SERVER_ADDR $server_addr;fastcgi_param SERVER_PORT $server_port;fastcgi_param SERVER_NAME $server_name;# PHP only, required if PHP was built with –enable-force-cgi-redirectfastcgi_param REDIRECT_STATUS 200;0x0.2struts2命令执行漏洞升级   版权声明：转载请注明来源 GuoKer（ZhuLiu）@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2012-07-02 13:39 厂商回复： 多谢提醒，我们会尽快处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-07-02 14:01 |    \t\tGuoKer（ZhuLiu） \t\t\t( 普通白帽子  |\t\t\t        Rank:168 漏洞数:21        | 在校学生党的路过   霸气侧漏)\t\t \n  嘿嘿    \n     2012-07-03 04:11 |    \t\t顺子 \t\t\t( 普通白帽子  |\t\t\t        Rank:236 漏洞数:36        | 0-0努力像正常青年靠近，再也不当上错图的2...)\t\t \n  @GuoKer（ZhuLiu） =.=蚂蚁给的分很高的噢·~·  大家来关注蚂蚁安全吧：）    \n     2012-07-03 10:31 |    \t\tGuoKer（ZhuLiu） \t\t\t( 普通白帽子  |\t\t\t        Rank:168 漏洞数:21        | 在校学生党的路过   霸气侧漏)\t\t \n  @顺子 因为我丢出的漏洞不止一个啊，呵呵，而且还帮他们修咯 自然给得高 嘿嘿， 跟站长搞好关系，给分就高    \n     2012-07-03 19:19 |    \t\t顺子 \t\t\t( 普通白帽子  |\t\t\t        Rank:236 漏洞数:36        | 0-0努力像正常青年靠近，再也不当上错图的2...)\t\t \n  @GuoKer（ZhuLiu） ：）我给蚂蚁的第一个漏洞，也是20rank    \n     2012-08-17 17:13 |    \t\tgery \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:6        | 自由和共享的感觉真好，业余玩安全。)\t\t \n  解析的修复用%00.php可以绕过吗？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}