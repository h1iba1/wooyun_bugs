{"id": 57005, "wybug_id": "wooyun-2014-055593", "wybug_title": "Destoon Sql注入漏洞之3", "wybug_corp": "DESTOON", "wybug_author": "′雨。", "wybug_date": "2014-04-04 21:38", "wybug_open_date": "2014-07-03 21:39", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-03：\t细节向公众公开  简要描述： 过滤不严。 详细说明：  在api/js.php中\nif($_SERVER['QUERY_STRING']) {\t$exprise = isset($_GET['tag_expires']) ? intval($_GET['tag_expires']) : 0;\t$moduleid = isset($_GET['moduleid']) ? intval($_GET['moduleid']) : 0;\t$moduleid > 3 or exit('document.write(\"<h2>Bad Parameter</h2>\");');\t$tag = $_SERVER['QUERY_STRING'];\t\t$_SERVER['QUERY_STRING'] = $_SERVER['REQUEST_URI'] = '';\tforeach($_GET as $k=>$v) { unset($$k); }\t$_GET = array();\trequire '../common.inc.php';\theader(\"Content-type:text/javascript\");\t \t($DT['jstag'] && $DT['safe_domain'] && check_referer()) or exit('document.write(\"<h2>Invalid Referer</h2>\");');\t\t$tag = strip_sql(stripslashes(urldecode($tag)));   \tforeach(array('#', '$', '&amp;', 'table', 'fields', 'password', 'payword', 'debug') as $v) {\t\tstrpos($tag, $v) === false or exit('document.write(\"<h2>Bad Parameter</h2>\");');\t}\tob_start();\t\ttag($tag, $exprise);\n在这里。\t($DT['jstag'] && $DT['safe_domain'] && check_referer()) or exit('document.write(\"<h2>Invalid Referer</h2>\");');绕过这个的话 只要safe domain里面有植就行 无论为什么。然后check_referer 自己修改一下referer 就可以绕过了。\nfunction strip_sql($string) {\t$search = array(\"/union/i\",\"/0x([a-z0-9]{2,})/i\",\"/select([[:space:]\\*\\/\\-])/i\",\"/update([[:space:]\\*\\/])/i\",\"/replace([[:space:]\\*\\/])/i\",\"/delete([[:space:]\\*\\/])/i\",\"/drop([[:space:]\\*\\/])/i\",\"/outfile([[:space:]\\*\\/])/i\",\"/dumpfile([[:space:]\\*\\/])/i\",\"/load_file\\(/i\",\"/substring\\(/i\",\"/substr\\(/i\",\"/concat\\(/i\",\"/concat_ws\\(/i\",\"/ascii\\(/i\",\"/hex\\(/i\",\"/ord\\(/i\",\"/char\\(/i\");\t$replace = array('unio&#110;','0&#120;\\\\1','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','outfil&#101;\\\\1','dumpfil&#101;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','conca&#116;(','concat_w&#115;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($search, $replace, $string);}\n然后绕过这个的话 利用这里的deocode来绕过。\nfunction tag($parameter, $expires = 0) {\tglobal $DT, $CFG, $MODULE, $DT_TIME, $db;\tif($expires > 0) {\t\t$tag_expires = $expires;\t} else if($expires == -2) {\t\t$tag_expires = $CFG['db_expires'];\t} else if($expires == -1) {\t\t$tag_expires = 0;\t} else {\t\t$tag_expires = $CFG['tag_expires'];\t}\t$tag_cache = false;\t$db_cache = ($expires == -2 || defined('TOHTML')) ? 'CACHE' : '';\tif($tag_expires && $db_cache != 'CACHE' && strpos($parameter, '&page=') === false) {\t\t$tag_cache = true;\t\t$TCF = DT_CACHE.'/tag/'.md5($parameter).'.htm';\t\tif(is_file($TCF) && ($DT_TIME - filemtime($TCF) < $tag_expires)) {\t\t\techo substr(file_get($TCF), 17);\t\t\treturn;\t\t}\t}\t$parameter = str_replace(array('&amp;', '%'), array('', '##'), $parameter);\tparse_str($parameter, $par);\tif(!is_array($par)) return '';\t$par = dstripslashes($par);\textract($par, EXTR_SKIP);\tisset($prefix) or $prefix = $db->pre;\tisset($moduleid) or $moduleid = 1;\tif(!isset($MODULE[$moduleid])) return '';\tisset($fields) or $fields = '*';\tisset($catid) or $catid = 0;\tisset($child) or $child = 1;\tisset($areaid) or $areaid = 0;\tisset($areachild) or $areachild = 1;\tisset($dir) or $dir = 'tag';\tisset($template) or $template = 'list';\tisset($condition) or $condition = '1';\tisset($group) or $group = '';\tisset($page) or $page = 1;\tisset($offset) or $offset = 0;\tisset($pagesize) or $pagesize = 10;\tisset($order) or $order = '';\tisset($showpage) or $showpage = 0;\tisset($showcat) or $showcat = 0;\tisset($datetype) or $datetype = 0;\tisset($target) or $target = '';\tisset($class) or $class = '';\tisset($length) or $length = 0;\tisset($introduce) or $introduce = 0;\tisset($debug) or $debug = 0;\tisset($lazy) or $lazy = 0;\t(isset($cols) && $cols) or $cols = 1;\tif($catid) {\t\tif($moduleid > 4) {\t\t\tif(is_numeric($catid)) {\t\t\t\t$CAT = $db->get_one(\"SELECT child,arrchildid,moduleid FROM {$db->pre}category WHERE catid=$catid\");\t\t\t\t$condition .= ($child && $CAT['child'] && $CAT['moduleid'] == $moduleid) ? \" AND catid IN (\".$CAT['arrchildid'].\")\" : \" AND catid=$catid\";\t\t\t} else {\t\t\t\tif($child) {\t\t\t\t\t$catids = '';\t\t\t\t\t$sql=\"SELECT arrchildid FROM {$db->pre}category WHERE catid IN ($catid)\";\t\t\t\t    echo $sql;exit;\n在这里 把语句输出来。 测试一下语句。   漏洞证明：  \n\n需要把referer修改成域名才能绕过check_referer这里decode 那就用%2b来绕过空格。 过滤了substr 那就left 。 过滤了char 但是char (97)这样依旧可以执行。基本就绕完了。\n\n相等即执行。   修复方案：  过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-04-08 12:27 厂商回复： 感谢提醒，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}