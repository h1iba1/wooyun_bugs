{"id": 406, "wybug_id": "wooyun-2014-070072", "wybug_title": "qibocms多个系统绕过补丁继续注入", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-07-29 13:56", "wybug_open_date": "2014-10-27 13:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-27：\t细节向公众公开  简要描述： （最后更新于2014-7-28）附件： 安全补丁.rar (218 K) 下载次数:15582 看到更新补丁了 再来看看。绕过这补丁 当然 绕过了这补丁的话 也是通杀qibo多个系统。 详细说明：  之前发的  WooYun: qibocms V7 整站系统最新版SQL注入一枚 & 另外一处能引入转义符的地方。 ————————————————————————————————\n\n下载了个补丁下来看看 看了看member目录 竟然没有看到上次我发的那个post.php我以为没做修复了呢 后来看了看全局文件 inc/common.inc.php中\n$_POST=Add_S($_POST);$_GET=Add_S($_GET);$_COOKIE=Add_S($_COOKIE);\n依旧是全局的过滤函数\nfunction Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t$key=str_replace(array(\"'\",'\"','\\\\','&'),'',$key);\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n在这里 可以看到修改了这个过滤函数。添加了一句 $key=str_replace(array(\"'\",'\"','\\\\','&'),'',$key);把数组中的key 如果含有' 或者 \" 或者 \\ 清空成空。那这样数组里面的key就不能像之前一样含有特殊符号了看起来好像是没有问题了。   但是这里我们来测试一下。这里我们调用一下qibocms这函数来测试一下\n<?php$_GET=Add_S($_GET);var_dump ($_GET);function Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t$key=str_replace(array(\"'\",'\"','\\\\','&'),'',$key);\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n\n\n这里 我们再在key中加一个单引号 看看会是什么情况。\n\narray(2) { [\"a'\"]=> string(3) \"asd\" [\"a\"]=> string(3) \"asd\" } 可以看到 其中一个元素有了单引号。  其中一个元素没有单引号。为什么会有两个元素了。 其实这点我根本没搞懂啊 - -问了问P神 大概是因为 第一次循环因为单引号被清空了 所以有了一个a元素   然后就创建了一个a元素，导致数组变成了两个元素.然后这两个元素都在这里面了。。 一个有单引号 一个无单引号。 也就是a'和a两个元素 - - 这里我还是不太懂。   但是就是这样 array(2) { [\"a'\"]=> string(3) \"asd\" [\"a\"]=> string(3) \"asd\" } key中还是能引入单引号。所以导致了这补丁被绕过。______________________________________________________________________绕过了这个 又能通杀多个系统了。 这里我就以整站系统做个演示。继续在member/post.php\nelseif($job=='manage'){  \tif(!$atc_power)showerr(\"你没权限\");\tif($rsdb[pages]<2){\theader(\"location:post.php?job=edit&aid=$aid&mid=$mid&only=$only\");exit;\t}\t\t$erp=get_id_table($aid);\tif($step==2){\t\tasort($orderDB);\t\t$i=0;\t\tforeach( $orderDB AS $key=>$value){ \t\t\t$i++;\t\t\t\t\t\t$db->query(\"UPDATE {$pre}reply$erp SET orderid=$i WHERE aid='$aid' AND rid='$key'\");\t\t}\t\trefreshto(\"$FROMURL\",\"排序成功\",1);\n注册一个会员 然后发布文章 因为这个 \nif($rsdb[pages]<2){\theader(\"location:post.php?job=edit&aid=$aid&mid=$mid&only=$only\");exit;\t}\n 所以需要发两页。\n\n这里我输出一下这变量 可以看到第一个没单引号 第二个有单引号但是foreach 是循环执行的 所以第二个也能执行到。   漏洞证明：  \n\n成功注入。   修复方案：  这里为什么就不参考一下之前我给的修复方法呢?\nforeach( $orderDB AS $key=>$value){ $key=addslashes($key);\t\t\t$i++;\t\t\t\t\t\t$db->query(\"UPDATE {$pre}reply$erp SET orderid=$i WHERE aid='$aid' AND rid='$key'\");\t\t}\n我测试了一下 至少在这里是不能注入了的。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-29 15:42 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-29 14:31 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  不得不说洞主真是cms的杀手    \n     2014-07-29 16:35 |    \t\t命运 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 我是来乌云秀智商下限的~~)\t\t \n  洞主小心做黑产的药弄你。    \n     2014-07-29 16:36 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @命运 已经只剩下最后一口气。    \n     2014-07-29 23:17 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  蛋疼死我了。。 本来能Getshell的。。。。。    \n     2014-10-27 21:07 |    \t\tsutdy \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:33        | 0.0)\t\t \n  洞主  你是哪的？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}