{"id": 39921, "wybug_id": "wooyun-2015-092924", "wybug_title": "LebiShop商城系统最新版SQL注入五", "wybug_corp": "www.lebi.cn", "wybug_author": "xfkxfk", "wybug_date": "2015-01-23 15:34", "wybug_open_date": "2015-04-23 15:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-23：\t细节向公众公开  简要描述： LebiShop商城系统最新版SQL注入五 详细说明：  LebiShop商城系统最新版SQL注入一处文件Shop.supplier.Ajax.Ajax_product\n// Shop.supplier.Ajax.Ajax_productpublic void Product_Batch_Price_Update(){\tif (!base.Power(\"supplier_product_batch_price\", \"批量调价\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring step = RequestTool.RequestString(\"step\");\tstring dateFrom = RequestTool.RequestString(\"dateFrom\");\tstring dateTo = RequestTool.RequestString(\"dateTo\");\tstring Pro_Type_id = RequestTool.RequestString(\"Pro_Type_id\");\tint brand = RequestTool.RequestInt(\"brand\", 0);\tint tag = RequestTool.RequestInt(\"tag\", 0);\tint price_markettype = RequestTool.RequestInt(\"price_markettype\", 0);\tint price_marketvalue = RequestTool.RequestInt(\"price_marketvalue\", 0);\tint price_marketadd = RequestTool.RequestInt(\"price_marketadd\", 0);\tint price_costtype = RequestTool.RequestInt(\"price_costtype\", 0);\tint price_costvalue = RequestTool.RequestInt(\"price_costvalue\", 0);\tint price_costadd = RequestTool.RequestInt(\"price_costadd\", 0);\tint pricetype = RequestTool.RequestInt(\"pricetype\", 0);\tint pricevalue = RequestTool.RequestInt(\"pricevalue\", 0);\tint priceadd = RequestTool.RequestInt(\"priceadd\", 0);\tint addtype = RequestTool.RequestInt(\"addtype\", 0);\tint addvalue = RequestTool.RequestInt(\"addvalue\", 0);\tint reducetype = RequestTool.RequestInt(\"reducetype\", 0);\tint reducevalue = RequestTool.RequestInt(\"reducevalue\", 0);\tstring mes = \"\";\tstring where = \"1=1\";\tif (dateFrom != \"\" && dateTo != \"\")\t{\t\tstring text = where;\t\twhere = string.Concat(new string[]\t\t{\t\t\ttext,\t\t\t\" and (datediff(d,Time_Add,'\",\t\t\tdateFrom,\t\t\t\"')<=0 and datediff(d,Time_Add,'\",\t\t\tdateTo,\t\t\t\"')>=0)\"\t\t});\t\tstring text2 = mes;\t\tmes = string.Concat(new string[]\t\t{\t\t\ttext2,\t\t\t\"上架日期\",\t\t\tdateFrom,\t\t\t\"-\",\t\t\tdateTo,\t\t\t\";\"\t\t});\t}\tif (Pro_Type_id != \"\")\t{\t\twhere = where + \" and Pro_Type_id in (\" + EX_Product.Categoryid(Pro_Type_id) + \")\";\t\tmes = mes + \"商品分类\" + Pro_Type_id + \";\";\t}\n参数Pro_Type_id通过RequestTool.RequestString(\"Pro_Type_id\")获取在RequestTool.RequestString方法中只进行了单引号的转换\n// Shop.Tools.RequestToolpublic static string RequestString(string nKey, string def){\tstring ojb = HttpContext.Current.Request.QueryString[nKey];\tif (ojb != null)\t{\t\treturn StringTool.InjectFiltrate(ojb.Trim());\t}\tojb = HttpContext.Current.Request.Form[nKey];\tif (ojb != null)\t{\t\treturn StringTool.InjectFiltrate(ojb.Trim());\t}\treturn def;}// Shop.Tools.StringToolpublic static string InjectFiltrate(string str){\tif (!StringTool.IsSafeSqlString(str))\t{\t\tstr = str.Replace(\"'\", \"&#180;\");\t}\treturn str;}\n然后Pro_Type_id进入了EX_Product.Categoryid方法，跟进\n// Shop.Bussiness.EX_Productpublic static string Categoryid(string id){\tstring str = id.ToString();\tList<Lebi_Pro_Type> ts = B_Lebi_Pro_Type.GetList(\"Parentid=\" + id + \" and IsShow = 1\", \"Sort desc\");\tforeach (Lebi_Pro_Type t in ts)\t{\t\tstr = str + \",\" + EX_Product.Categoryid(string.Concat(t.id));\t}\treturn str;}\n然后Pro_Type_id最后进入了B_Lebi_Pro_Type.GetList方法，且没有使用单引号保护   漏洞证明：  官方demo演示报出当前数据库\nhttp://plus.demo.lebi.cn/supplier/ajax/ajax_product.aspx?__Action=Product_Batch_Price_Update&url=/Pro_Type_id=db_name()\n\n\n报出servername，服务器主机名\n\nsqlmap即可跑出数据   修复方案：  使用RequestTool.RequestInt或者添加单引号保护变量   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-01-26 15:10 厂商回复： 已统一修复SQL漏洞，感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}