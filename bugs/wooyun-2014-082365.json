{"id": 43566, "wybug_id": "wooyun-2014-082365", "wybug_title": "某建站系统文件包含+登陆伪造漏洞", "wybug_corp": "凡诺广告传媒中心", "wybug_author": "路人甲", "wybug_date": "2014-11-10 12:35", "wybug_open_date": "2015-02-08 12:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "18", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-10：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-02-08：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 123 详细说明：  http://www.mycodes.net/25/2089.htm源码作者:         凡诺广告传媒中心         下载次数:         138500官网http://www.pcfinal.cn/百度关键词  程序开发：凡诺网络\n\n\n\n案例说明;http://www.wangluojiaoshi.com/admin/cms_login.asphttp://www.tjtongxun.com/admin/cms_login.asphttp://www.rj-bz.com/admin/cms_login.asphttp://www.jlsty.com/admin/cms_login.asphttp://www.texcrew.com/admin/cms_login.asphttp://www.51yyc.com/admin/cms_login.asphttp://www.baigonghuashi.cn/admin/cms_login.asphttp://www.cqxhy.com/admin/cms_login.asphttp://www.hd9168.com/admin/cms_login.asphttp://www.86229222.com/admin/cms_login.asphttp://www.wxftdz.com/admin/cms_login.asphttp://ci.zju.edu.cn/admin/cms_login.asp(可爱的浙江大学...)还有相当多啊、   漏洞证明：  一般直接从数据库交互的地方看起/admin/index.asp\n<%2Response.Redirect(\"cms_login.asp\")3%>\n/admin/cms_login.asp\n<!--#include file=\"../_system/conn.asp\"-->02<!--#include file=\"../_system/library.asp\"-->03<%04If rf(\"submit\") = \"管理登录\" Then05    Call null_back(rf(\"login_name\"), \"用户名不能为空！\")06    Call null_back(rf(\"login_password\"), \"密码不能为空！\")07    Call null_back(rf(\"login_verifycode\"), \"验证码不能为空！\")08    If CStr(Session(\"CheckCode\")) <> CStr(Request.Form(\"login_verifycode\")) Then09        Call alert_href(\"验证码错误！\",\"cms_login.asp\")10    End If11    Set rs = ado_query(\"select * from cms_admin where a_enable = 1 and a_name='\"&str_safe(request.Form(\"login_name\"))&\"' and a_password='\"&md5(str_safe(request.Form(\"login_password\")))&\"'\")12        response.write \"select * from cms_admin where a_enable = 1 and a_name='\"&str_safe(request.Form(\"login_name\"))&\"' and a_password='\"&md5(str_safe(request.Form(\"login_password\")))&\"'\"13    If Not rs.EOF Then14            Response.Cookies(\"admin_check\") = request.Form(\"login_name\")15        rs.close16                set rs = nothing17        response.redirect \"cms_welcome.asp\"18    Else19        rs.close20                set rs = nothing21        Call alert_href(\"错误提示：用户名或密码错误，请核对后重新输入！\",\"cms_login.asp\")22    End If23End If24%>\n可以看到输入点被str_safe处理过找到包含文件，conn 和 library去寻找函数\nFunction str_safe(byval Str)02    If IsNull(Str) Then Exit Function03    Str = str_isafe(Str)04    Str = Replace(Str, \"<\", \"<\")05    Str = Replace(Str, \">\", \">\")06    Str = Replace(Str, \"\"\"\", \"\"\")07    str_safe = Str08End Function09Function str_editor(str)10    If IsNull(Str) Then Exit Function11        str = Replace(str, \"&\", \"&\")12        str = Replace(str, \"<\", \"<\")13        str = Replace(str, \">\", \">\")14        str = Replace(str, \"\"\"\", \"\"\")15        str_editor = str16End Function17 18'函数：SQL关键词过滤 用于获取含HTML标签的内容19 20Function str_isafe(byval Str)21    If IsNull(Str) Then Exit Function22    Str = Replace(Str, \"select \", \"select \", 1, -1, 1)23    Str = Replace(Str, \"insert \", \"insert \", 1, -1, 1)24    Str = Replace(Str, \"update \", \"update \", 1, -1, 1)25    Str = Replace(Str, \"delete \", \"delete \", 1, -1, 1)26    Str = Replace(Str, \" and\", \" and \", 1, -1, 1)27    Str = Replace(Str, \"drop table\", \"drop table\", 1, -1, 1)28    Str = Replace(Str, \"script\", \"script\")29    Str = Replace(Str, \"*\", \"*\")30    Str = Replace(Str, \"%\", \"%\")31    Str = Replace(Str, \"'\", \"''\")32    str_isafe = Str33End Function\n感觉过滤挺好的，好像没戏了，真心好像没戏了，我去，然后看到cookie验证的，看看后台能伪造登录不于是来到/admin/cms_welcome.asp看到包含了<!--#include file=\"inc_global.asp\"--><!--#include file=\"../_system/function.asp\"-->当我看到./_system/function.asp就无语了\n<%02'==========获取当前账户相关信息==========03'response.write Request.Cookies(\"admin_check\")04If inull(Request.Cookies(\"admin_check\")) Then05    Response.Redirect(\"index.asp\")06End If07Set rs_gap = ado_query(\"select * from cms_admin where a_name = '\"&Request.Cookies(\"admin_check\")&\"'\")08If rs_gap.EOF Then09    Response.Redirect(\"index.asp\")10End If11admin_name = rs_gap(\"a_name\")12'response.write admin_name13admin_truename = rs_gap(\"a_truename\")14admin_penname = rs_gap(\"a_penname\")15admin_purview = rs_gap(\"a_purview\")16arr_admin_purview = Split(admin_purview, \",\")17rs_gap.Close18Set rs_gap = Nothing\n前面所有的函数，所有的判断都是狗屁，这里直接读cookie了，啥过滤没有直接来到  /admin/cms_welcome.asp  firebug一下  admin_check   为admin  我觉得一般不会改就算改的话也可以继续构造语句，因为什么都没过滤利用：/admin/cms_welcome.asp自己添加cookie   admin_check的值为 admin 刷新即可越权访问后台后台还可以直接getshell   修复方案：  1   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}