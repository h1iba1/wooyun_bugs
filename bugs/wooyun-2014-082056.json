{"id": 43676, "wybug_id": "wooyun-2014-082056", "wybug_title": "齐博CMS 二次注入", "wybug_corp": "齐博CMS", "wybug_author": "Power", "wybug_date": "2014-11-07 12:03", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-12：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： 齐博门户二次注入 详细说明：  shop\\join.php中\nif($action==\"postnew\"){\t//自定义字段的合法检查与数据处理\t$Module_db->checkpost($field_db,$postdb,'');//跟踪\tjoin_post();   \tunset($id_array);\ncheckpost()函数中\nfunction checkpost($field_db,&$postdb,$rsdb=''){\tforeach($field_db AS $key=>$rs)\t{.................省略\t\telse\t\t{\t\t\tif(is_array($postdb[$key])){\t\t\t\t\t\t\t$postdb[$key]='/#/'.implode(\"/#/\",$postdb[$key]).'/#/';\t\t\t}\t\t\t//过滤不安全的字符\t\t\t$postdb[$key]=filtrate($postdb[$key]);//对传递过来的数据进行过滤\t\t}\t\tif(strlen($postdb[$key])>30000){\t\t\tshowerr(\"内容不能大于1.5万个汉字\");\t\t}\t}}\n上面的我无法利用，但是在shop//member/address.php中\nelseif($action==\"postnew\"){\t$db->query(\"INSERT INTO `{$_pre}address` (`uid` ,`order_username` ,`order_phone` ,`order_mobphone` ,`order_email` ,`order_qq` ,`order_postcode` ,`order_address` ) VALUES ('$lfjuid', '$order_username', '$order_phone', '$order_mobphone', '$order_email', '$order_qq', '$order_postcode', '$order_address')\");//直接转义之后入库\trefreshto(\"?job=list\",'',0);}elseif($action==\"edit\"){\tcheckrid($rid);\t$db->query(\"UPDATE `{$_pre}address` SET order_username='$order_username',order_phone='$order_phone',order_email='$order_email',order_qq='$order_qq',order_postcode='$order_postcode',order_address='$order_address',order_mobphone='$order_mobphone' WHERE rid='$rid'\");//转移后入库\trefreshto(\"?job=list\",'',0);}\n在shop\\join.php中\nif($action==\"postnew\"){\t//自定义字段的合法检查与数据处理\t$Module_db->checkpost($field_db,$postdb,'');\tjoin_post();//跟踪\njoin_post()函数中\nfunction join_post(){\textract($GLOBALS);\tglobal $postdb,$listdb;\tif(!table_field(\"{$_pre}join\",'products')){\t\t$db->query(\"ALTER TABLE `{$_pre}join` ADD `products` TEXT NOT NULL ;\");\t}\t$query = $db->query(\"SELECT * FROM {$_pre}content WHERE id IN (\".implode(',',$_ar).\")\");\twhile($rs = $db->fetch_array($query)){\t\t$rs[price] = str_replace(',','',$rs[price]);\t\t$listdb[$rs[uid]][] = $rs;/* \t\tvar_dump($listdb);\t\texit; */\t}\tif($postdb[address_type]>0){\t\t$ts = $db->get_one(\"SELECT * FROM `{$_pre}address` WHERE uid='$lfjuid' AND rid='$postdb[address_type]'\");     //数据出库\t\t$postdb[order_username] = $ts[order_username];\t\t$postdb[order_phone] = $ts[order_phone];\t\t$postdb[order_mobphone] = $ts[order_mobphone];\t\t$postdb[order_email] = $ts[order_email];\t\t$postdb[order_qq] = $ts[order_qq];\t\t$postdb[order_postcode] = $ts[order_postcode];\t\t$postdb[order_address] = $ts[order_address];\t}elseif($postdb[address_type]=='-1'){\t\t\t$db->query(\"INSERT INTO `{$_pre}address` ( `uid` , `order_username` , `order_phone` , `order_mobphone` , `order_email` , `order_qq` , `order_postcode` , `order_address` ) VALUES ('$lfjuid' , '$postdb[order_username]' , '$postdb[order_phone]' , '$postdb[order_mobphone]' , '$postdb[order_email]' , '$postdb[order_qq]' , '$postdb[order_postcode]' , '$postdb[order_address]')\");\t}}\n/shop/join.php中\nif($action==\"postnew\"){\t//自定义字段的合法检查与数据处理\t$Module_db->checkpost($field_db,$postdb,'');        join_post();//此函数取出入库数据\tunset($id_array);\tforeach($listdb AS $uid=>$array){\t\t$totalmoney = 0;\t\t$detail='';\t\tforeach($array AS $_rs){\t\t\t$totalmoney+=$_rs[price]*$p_totalArray[$_rs[id]];\t\t\t$detail[] = \"$_rs[id]={$p_totalArray[$_rs[id]]}\";\t\t}\t\t$products = addslashes( implode(',',$detail) );\t\t$rs=$db->get_one(\"SELECT * FROM `{$pre}purse` WHERE uid='$uid'\");\t\t$parray=unserialize($rs[config]);\t\t\t\tif($postdb[order_sendtype]==2){\t\t\t//平邮\t\t\t$totalmoney+=floatval($parray[slow_send]);\t\t}elseif($postdb[order_sendtype]==3){\t//快递\t\t\t$totalmoney+=floatval($parray[norm_send]);\t\t}elseif($postdb[order_sendtype]==4){\t//EMS\t\t\t$totalmoney+=floatval($parray[ems_send]);\t\t}\t\t//$totalmoney = number_format($totalmoney,2);\t\t/*往主信息表插入内容*/\t\t$db->query(\"INSERT INTO `{$_pre}join` ( `mid` , `cid` , `cuid` ,  `posttime` ,  `uid` , `username` , `yz` , `ip` ,  `totalmoney`,`products`) \t\tVALUES (\t\t'$mid' , '$_rs[id]' , '$uid', '$timestamp','$lfjdb[uid]','$lfjdb[username]','0','$onlineip','$totalmoney','$products')\");\t\t$id = $id_array[] = $db->insert_id();\t\t\t\tunset($sqldb);\t\t$sqldb[]=\"id='$id'\";\t\t$sqldb[]=\"uid='$lfjuid'\";\t\t/*检查判断辅信息表要插入哪些字段的内容*/\t\tforeach( $field_db AS $key=>$value){\t\t\tisset($postdb[$key]) && $sqldb[]=\"`{$key}`='{$postdb[$key]}'\";\t\t}\t\t$sql=implode(\",\",$sqldb);\t\t$db->query(\"INSERT INTO `{$_pre}content_$mid` SET $sql\");//数据入库产生注入\n   漏洞证明：  估计是我的Mysql 注册版本太低，不能报错注入，http://www.tongyuxian.com/shop/此网站躺抢首先注册一个个人用户，访问http://www.tongyuxian.com/shop//member/address.php?job=postnew\n\n然后购买商品，结算，使用存在的地址。\n\n\n\n   修复方案：  ...   版权声明：转载请注明来源 Power@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 2014-12-02：老问题。之前有人提过。已修复 的了  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}