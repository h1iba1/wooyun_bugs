{"id": 59419, "wybug_id": "wooyun-2013-047464", "wybug_title": "DTcmsV2.1 access版本 feedback插件存在xss漏洞", "wybug_corp": "DTcms", "wybug_author": "what_news", "wybug_date": "2013-12-31 12:48", "wybug_open_date": "2014-03-31 12:49", "wybug_type": "xss跨站脚本攻击", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-31：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-03-31：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 该cms未对留言反馈部分用户的输入进行处理，用户输入的信息直接插入到数据库中，再读出留言反馈信息又未对数据直接显示 使得存在xss漏洞威胁 详细说明：  通过Reflector5反编译，查看代码 我们先看源码目录下 DTcms.Web =>aspx =>feedback.aspx这页面 ，主要代码如下\nStringBuilder builder = new StringBuilder();    feedback feedback = new feedback();    feedback model = new feedback();    string formString = DTRequest.GetFormString(\"txtCode\");    string str2 = DTRequest.GetFormString(\"txtTitle\");    string str3 = DTRequest.GetFormString(\"txtContent\");    string str4 = DTRequest.GetFormString(\"txtUserName\");    string str5 = DTRequest.GetFormString(\"txtUserTel\");    string str6 = DTRequest.GetFormString(\"txtUserQQ\");    string str7 = DTRequest.GetFormString(\"txtUserEmail\");    中间省略一些代码....        model.title = str2;        model.content = Utils.ToHtml(str3);        model.user_name = str4;        model.user_tel = str5;        model.user_qq = str6;        model.user_email = str7;        model.add_time = DateTime.Now;        model.is_lock = 1;        if (feedback.Add(model) > 0)        {            context.Response.Write(\"{msg: 1, msgbox: \\\"恭喜您，留言提交成功啦！\\\"}\");        }\n然后我们看下GetFormString函数是怎么处理输入的数据\npublic static string GetFormString(string strName, bool sqlSafeCheck){    if (HttpContext.Current.Request.Form[strName] == null)    {        return \"\";    }    if (!(!sqlSafeCheck || Utils.IsSafeSqlString(HttpContext.Current.Request.Form[strName])))    {        return \"unsafe string\";    }    return HttpContext.Current.Request.Form[strName];}\n在跟进看下 IsSafeSqlString函数\npublic static bool IsSafeSqlString(string str){    return !Regex.IsMatch(str, @\"[-|;|,|\\/|\\(|\\)|\\[|\\]|\\}|\\{|%|@|\\*|!|\\']\");}\n可以看出 没对用户输入进行xss检测，所以用户提交的数据直接插入到数据库我们在看下 读出留言反馈数据的代码 在源码目录下的 DTcms.Web=>pluginsfeedback=>admin=>index.aspx 页面 主要代码如下\nprotected void Page_Load(object sender, EventArgs e){    if (!string.IsNullOrEmpty(base.Request.Params[\"keywords\"]))    {        this.keywords = base.Request.Params[\"keywords\"].Trim();    }    this.pageSize = this.GetPageSize(15);    if (!this.Page.IsPostBack)    {        this.RptBind(\"id>0\" + this.CombSqlTxt(this.keywords), \"is_lock desc,add_time desc\");    }}\n在看下PptBind函数\nif (!int.TryParse(base.Request.QueryString[\"page\"], out this.page))    {        this.page = 1;    }    this.txtKeywords.Text = this.keywords;    this.rptList.DataSource = new feedback().GetList(this.pageSize, this.page, _strWhere, _orderby, out this.totalCount);    this.rptList.DataBind();    this.txtPageNum.Text = this.pageSize.ToString();    string linkUrl = Utils.CombUrlTxt(\"index.aspx\", \"keywords={0}&page={1}\", new string[] { this.keywords, \"__id__\" });    this.PageContent.InnerHtml = Utils.OutPageList(this.pageSize, this.page, this.totalCount, linkUrl, 8);\n其中getlist就是直接select出留言反馈的信息，然后通过控件databine绑定数据源 并没有对读出来的数据进行处理   漏洞证明：  首先 我们看下feedback.aspx 提交测试数据 如图\n\n然后进入后台 确保freeback插件已经安装\n\n接着访问插件主页\n\n   修复方案：  在数据进行html处理\nmodel.title = Utils.ToHtml(str2);        model.content = Utils.ToHtml(str3);        model.user_name =Utils.ToHtml(str4);        model.user_tel =Utils.ToHtml(str5);        model.user_qq = Utils.ToHtml(str6);        model.user_email = Utils.ToHtml(str7);\n   版权声明：转载请注明来源 what_news@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-01-10 17:34 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我去，居然有人挖DTCMS的了，求SQL注入    \n     2014-01-13 09:33 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @wefgod 代码还没仔细看。。。    \n     2014-01-13 10:34 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @what_news 哈哈，其实这套原本想看看的，但是一直都没安排到。这套CMS还是值得看看的    \n     2014-01-13 11:15 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @wefgod 没厂商回应 我的积极性就不是很高了 等过年在看看别的了哈哈    \n     2014-01-13 11:27 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @what_news .NET的普遍都是这样的。除非是风讯啊什么的估计会快一点    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}