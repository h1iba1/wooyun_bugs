{"id": 48672, "wybug_id": "wooyun-2014-076860", "wybug_title": "江南科友堡垒机xss+越权+通杀SQL注入漏洞一（无需登录）", "wybug_corp": "江南科友科技股份有限公司", "wybug_author": "路人甲", "wybug_date": "2014-09-21 22:32", "wybug_open_date": "2014-12-20 22:34", "wybug_type": "设计不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-20：\t细节向公众公开  简要描述：  详细说明：  接上一枚 WooYun: 江南科友堡垒机全版本getshell（无需登录） 漏洞涉及客户如下：国内各大银行：中国银行、民生银行、广东发展银行、平安银行、深圳发展银行、浦发银行、渤海银行总行及各分行、中国工商银行、中国农业银行、中国建设银行、交通银行、招商银行、中信银行、兴业银行、华夏银行、中国邮政储蓄银行总行或部分分行中国银联：总公司及北京、广州、深圳、南京、福州、长沙、武汉、济南、青岛、沈阳、郑州、海口、天津、香港、厦门等分公司银联数据：全国卡系统业务托管商业银行外资银行：渣打银行、东亚银行：全国境内各个分行外资金融机构：韩亚银行、花旗银行、通用电气、星展银行、美国第一资讯（FDC)地方商业银行及农村信用社：40余家商业银行及农村信用社社会保障与公共交通系统：湖北、黑龙江、广东、北京等社保卡安全系统，上海市公交一卡通安全系统，杭州市市民卡系统，长春一汽企业IC卡加密系统，宁波市民卡系统，郑州交通一卡通系统，山东一卡通系统....这是一个官方做的一个统计，在日常工作当中，在很多能源单位以及金融单位经常见江南科友堡垒机。。所以影响范围就不说了。看分析吧0x01 反射型xss   在rdplogout.php中 \n</script>\t<body>\t\t<div align=\"center\">\t\t<font color=\"red\" >\t\t\t资源\t\t\t<?php\t\t\techo $_GET['res_name'];  //直接输出，产生xss\t\t\t?>\t\t的远程连接已经退出\t\t</font>\t</div>\n链接如下：https://1.1.1.1/rdplogout.php?res_name=<script>alert(222)</script>\n\n0x02 越权、信息泄露(物理路径）   https://1.1.1.1/system/ADD_VDH_Protocl.php   代码就不分析了。没有任何权限验证，导致可以随意增加协议相关信息 \n\n   https://1.1.1.1/system/download_cert.php?down_cret=1 \n\n0x03 通杀SQL注入漏洞    在system/download_cert.php当中31行处 \nif(isset($_GET['manager']) && isset($_GET['user_id']) && isset($_GET['cert_psw']))\t{\t\t$db = new SystemDB();\t\t\t$cert_msg = $db->getCertById('',$_GET['user_id'],$_GET['manager']);\t\t\t\tif(!empty($cert_msg))\t\t{\n我们跟踪下getCertById 方法\npublic function getCertById($id=null,$user_id=null,$userflag=null)     {    \ttry     \t{    \t\tif(!empty($id) && empty($user_id))    \t\t\t$sql = \"select * from cert where id = \".$id;    \t\telse if(empty($id) && !empty($user_id))    \t\t{    \t\t\t$sql = \"select * from cert where user_id=\".$user_id.\" and userflag=\".$userflag;\t    \t\t}    \t\t//echo $sql;    \t\t$stmt = $this->dbh->prepare($sql);    \t\t$stmt->execute();\n当$id 不为空 和$user_id为空的情况下 执行 \"select * from cert where id = \".$id;其中$id 有过滤吗？没，所以直接注，并且它有显错模式如图 https://1.x.x.98/system/download_cert.php?user_id=2&cert_psw=3&manager=1 \n\n\n\n\n\n\n\n\n\n\n\n堡垒机相信大家都懂，不懂的自己百度吧堡垒机上面的内网机器就不去鼓捣了。。。我们控制了它，相当于控制了内网的所有主机了。。。。      漏洞证明：   https://1.x.x.98/system/download_cert.php?user_id=2&cert_psw=3&manager=1 \n\n\n\n\n\n\n\n\n\n\n\n堡垒机相信大家都懂，不懂的自己百度吧堡垒机上面的内网机器就不去鼓捣了。。。我们控制了它，相当于控制了内网的所有主机了。。。。   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2014-09-26 10:14 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-22 08:44 |    \t\tfeiyu \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:10        )\t\t \n  太吊了用堡垒机的单位都有搞头    \n     2014-10-17 11:45 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  其实我一直想问到底怎么证明是通杀的……每次都看见有一句话说xxx通杀，好像都是同一台机器？    \n     2014-12-20 23:28 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @wefgod  首先源代码怎么来的，其二怎么通杀！其三没有互联网示例    \n     2014-12-21 09:21 |    \t\tMark \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 渗透你的心)\t\t \n  源码是怎么搞到的 好奇    \n     2014-12-22 09:09 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @U神 源码肯定是其它漏洞搞到的啊。通杀无法证明，看截图就一个例子，互联网是有示例的，他截图上的就是。我就说那么多咯    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}