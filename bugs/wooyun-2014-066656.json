{"id": 53742, "wybug_id": "wooyun-2014-066656", "wybug_title": "maccms8 由于涉及缺陷可以再系统内部随意创建文件目录", "wybug_corp": "maccms.com", "wybug_author": "menmen519", "wybug_date": "2014-07-02 15:13", "wybug_open_date": "2014-09-30 15:14", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-30：\t细节向公众公开  简要描述： maccms8 由于涉及缺陷可以再系统内部随意创建文件目录（开启文件缓存！！！！！！）  详细说明：  今天在查看苹果cms的时候发现一个任意创建文件目录的代码，本想着可以任意创建文件，但是由于对于文件各方面的过滤，还有一些目录遍历方面的过滤，只能审计到此，啥也不说了，直接看代码index.php(41-42):\n$tpl->ifex();\tsetPageCache($tpl->P['cp'],$tpl->P['cn'],$tpl->H);\t$tpl->run();\techo $tpl->H;\nsetPageCache这个函数功能就是把页面内容缓存起来，那么我们进入到缓存的函数里面查看\nfunction setPageCache($cp,$cn,$cv){\tif($GLOBALS['MAC']['app']['dynamiccache'] ==0){ return false; }\t$cf = MAC_ROOT.'/cache/'.$cp.'/'.$cn.'.html';\t$path = dirname($cf);\tmkdirs($path);\t@fwrite(fopen($cf,'wb'),$cv);}\n这时候我们看到了 这里有一个mkdirs($path)，那我们可不可以在cache底下随意穿件我们认为的文件名，由于苹果cms的请求机制都是伪静态的，而且与$cp和$cn相关的地方都进行了初始化，或者说是进行了转移，那么我们是否可以找到一个部队$cp做任何处理的请求呢，经过一番苦苦寻觅，如下：module/comment.php的save函数存在这样的可能\nelseif($method=='save'){\t$c_vid = intval(be(\"all\", \"vid\"));    $c_name = be(\"all\", \"c_name\");    $c_type = intval(be(\"all\", \"aid\"));    $c_content = be(\"all\", \"c_content\");    $c_code = be(\"all\",\"c_code\");        if($c_type>=16 && $c_type<=18){    \t$c_type=16;    }        if (isN($c_name) || isN($c_content)){ echo '请输入昵称和内容'; exit; }    //if ($MAC['other']['commentverify']==1 && $_SESSION[\"code_comment\"] != $c_code){ echo '验证码错误'; exit; }    if (getTimeSpan(\"last_commenttime\") < $MAC['other']['commenttime']){ echo '请不要频繁操作';exit; }    $pattern = '/[^\\x00-\\x80]/'; \tif(!preg_match($pattern,$c_content)){\t\techo '内容必须包含中文,请重新输入!';exit;\t}        $c_name = badFilter($c_name);    $c_content = badFilter($c_content);    $c_ip = ip2long(getIP());    $c_time = time();\n发现没有进行任何处理,这里我们注释掉验证码检测部分（之后输入验证码，截获发出去就行）url:http://192.168.10.70/maccms8_mfb_/maccms8_mfb/index.php?m=comment-save-cp-testdir-cn-a%2500sdasdapost_data:c_content=请输111&c_name=2222&c_code=xxxx如图所示：\n\n下来我们去cache文件夹底下查看：\n\n看似危害不大，我们猜想一下，如果页面有一个反射型xss，那么该反射性就会被缓存到cache里面，转白成为了真真正正的存储型，而且 无限制的创建文件   漏洞证明：     修复方案：  对不适用到cp的地方做初始化   版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-07-02 19:23 厂商回复： 此漏洞已经确认，感谢你的帮助。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}