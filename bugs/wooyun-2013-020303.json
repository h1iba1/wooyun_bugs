{"id": 13070, "wybug_id": "wooyun-2013-020303", "wybug_title": "QQ空间某功能缺陷导致日志存储型XSS - 5", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2013-03-19 14:46", "wybug_open_date": "2013-05-03 14:46", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "类型应用", "利用技巧", "存储型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-03-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-04-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-04-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-05-03：\t细节向公众公开  简要描述： 日志的功能都快被测光了。。。只好把目光放在了一个不是很可能出XSS的地方，还是有，有木有！ 详细说明：  1. 发布一个日志，插入一张图片，保存日志。当鼠标移动到图片上时，可以看到下面的东东。\n\n2. 查看对应部分的源码，可以看到 转发部分的代码里，有这个图片的URL。\n\n3. 这里可以猜测到，这部分代码的实现，大概是将图片的src取出来，然后通过字符串连接到代码里。如果图片的地址里带有 \" ，并且没有被过滤的话，是不是就可以导致XSS了呢？4. 我们来试试。日志，HTML模式，写入以下代码。<div style=\"text-align:center\"><img src=\"http://xsst.sinaapp.com/img.jpg#&quot;&gt;&lt;img style=display:none src=1 onerror=&quot;alert(1)//\" alt=\"图片\" style=\"width:466px;height:700px\"></div>5. 没弹出，查看DOM代码，可以看到，腾讯对外部图片做了一定的措施。\n\n6. 要绕过这个限制，我们到相册里自己上传以下，得到一个腾讯站内地址试试。<div style=\"text-align:center\"><img src=\"http://b254.photo.store.qq.com/psb?/01d1295e-6c2f-4efd-825e-e15c2a77c787/mPEZeaUmy4PfIqxb9UclFShCdxmBJup1fOa6uKTgL80!/b/dJyTa5cOCQAA&bo=0gG8AgAAAAABAEo!#&quot;&gt;&lt;img style=display:none src=1 onerror=&quot;alert(1)//\" alt=\"图片\" style=\"width:466px;height:700px\"></div>7. 再次查看日志，当鼠标移动到【日志内的美女图片上时】，可以看到，弹出了1。\n\n8.  通过DOM代码附近的 InfoManager.twitterImage ，我们可以定位到 http://ctc.qzs.qq.com/qzone/app/blog/v6/script/blog_content.js\n..tip_str += (['<a id=\"qzblog_twitter_img_btn\" class=\"forward\" href=\"javascript:void(0);\" onclick=\"InfoManager.twitterImage(\\'{0}\\');return false;\"><i class=\"icon_forward\"></i>转发</a>']).join('');..oTip.innerHTML = QZBlog.Util.formatMsg(tip_str, [imgObj.src]);..(In http://ctc.qzs.qq.com/qzone/newblog/v5/script/common.js)QZBlog.Util.formatMsg = (function(msg, values, filter) {    var pattern = /\\{([\\w-]+)?\\}/g;    return function(msg, values, filter) {        return msg.replace(pattern,         function(match, key) {            return filter ? filter(values[key], key) : values[key];        });    }} ());\n进一步可以看出，图片的src取出后，经过formatMsg函数，进入tip_str最终进入oTip.innerHTML9. 最后补充下一个小细节，在本地XSS中，图片地址后面，我们用#，而没有用 ?，这是为什么呢？因为在chrome下，xxx.src取出图片地址时，会对地址进行编码，如果用  xxx.jpg?\"><img 就会变成  xxx.jpg?%22%3E%3cimg，如下图。\n\n而用#号则不会被编码。 这也是决定是否可以利用成功的一个小技巧，故在此说明一下。   漏洞证明：  1. IE和chrome下均可， 2. 当用户进入日志后，鼠标移动到日志中插入的图片上时，即会触发XSS。3. 虽然这是一个 onmouseover xss，但是从用户查看日志的习惯上来说，当图片SIZE非常大，图片内容有吸引力，以及用户一些移动鼠标的误操作， 会使得该XSS的触发成功率会非常高，和自动触发差距不大。\n\n   修复方案：  缺陷文件及代码位置已给出，取出 imgObj.src 进行 encode一次。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2013-03-19 15:13 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-03-19 14:48 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:70        | 人这一辈子总要动真格的爱上什么人)\t\t \n  沙花    \n     2013-03-19 14:54 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  不愧是传说中的二哥!    \n     2013-03-19 14:54 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:111        | 收wb   1：5 无限量收   [平台担保])\t\t \n  不多说，多说了全是泪    \n     2013-03-19 14:54 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  永远的二哥    \n     2013-03-19 15:04 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @xsser 鼻血三升，你还能来回复，不容易不容易～～    \n     2013-03-19 15:05 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:172        )\t\t \n  二师兄，大师兄去tsrc刷礼物了？    \n     2013-03-19 15:07 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:76        | coder)\t\t \n  发个标题为“QQ空间日志存储型XSS”打包！再霸气点！    \n     2013-03-20 08:35 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  二哥威武    \n     2013-04-18 21:46 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  学习了！二哥大作！    \n     2013-04-19 00:26 |    \t\tnone \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:5        | 十次十次啊 hack it then know more~)\t\t \n  这简直是深入研究啊    \n     2013-04-19 19:21 |    \t\trasca1 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:16        | 菜鸟一只)\t\t \n  二哥是不是经常对着这相片上的妹子撸？    \n     2013-05-04 04:08 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:170        | 力不从心)\t\t \n  美女的胸可以啊。@rasca1 二哥女人很多的，图片上的估计实战过    \n     2013-06-20 15:35 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:208        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  关二爷，你的弹窗挡着重点了    \n     2014-11-05 01:35 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  算个dom额    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}