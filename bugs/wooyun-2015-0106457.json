{"id": 34401, "wybug_id": "wooyun-2015-0106457", "wybug_title": "phpems 多处sql注射", "wybug_corp": "PHPEMS", "wybug_author": "路人甲", "wybug_date": "2015-04-09 17:46", "wybug_open_date": "2015-05-24 17:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-09：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-24：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： phpems 多处sql注射 详细说明：  百度搜索：title:PHPEMS无纸化模拟考试系统\n\nev.cls.php:\npublic function getClientIp()\t{\t\tif(!isset($this->e['ip']))\t\t{\t\t\tif (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\"))\t\t\t\t$ip = getenv(\"HTTP_CLIENT_IP\");\t\t\telse if (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\"))\t\t\t\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\t\t\telse if (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\"))\t\t\t\t$ip = getenv(\"REMOTE_ADDR\");\t\t\telse if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\"))\t\t\t\t$ip = $_SERVER['REMOTE_ADDR'];\t\t\telse\t\t\t\t$ip = \"unknown\";\t\t\t$this->e['ip'] = $ip;\t\t}\t\treturn $this->e['ip'];\t}\n搜索：getClientIp\n\n举一个例子:app.php:\npublic function register()\t{\t\tif($this->ev->get('userregister'))\t\t{\t\t\t$fob = array('admin','管理员','站长');\t\t\t$args = $this->ev->get('args');\t\t\t$defaultgroup = $this->user->getDefaultGroup();\t\t\tif(!$defaultgroup['groupid'] || !trim($args['username']))\t\t\t{\t\t\t\t$message = array(\t\t\t\t\t'statusCode' => 300,\t\t\t\t\t\"message\" => \"用户不能注册\"\t\t\t\t);\t\t\t\texit(json_encode($message));\t\t\t}\t\t\t$username = $args['username'];\t\t\tforeach($fob as $f)\t\t\t{\t\t\t\tif(strpos($username,$f) !== false)\t\t\t\t{\t\t\t\t\t$message = array(\t\t\t\t\t\t'statusCode' => 300,\t\t\t\t\t\t'errorinput' => 'args[username]',\t\t\t\t\t\t\"message\" => \"用户已经存在\"\t\t\t\t\t);\t\t\t\t\texit(json_encode($message));\t\t\t\t}\t\t\t}\t\t\t$user = $this->user->getUserByUserName($username);\t\t\tif($user)\t\t\t{\t\t\t\t$message = array(\t\t\t\t\t'statusCode' => 300,\t\t\t\t\t'errorinput' => 'args[username]',\t\t\t\t\t\"message\" => \"用户已经存在\"\t\t\t\t);\t\t\t\texit(json_encode($message));\t\t\t}\t\t\t$email = $args['useremail'];\t\t\t$user = $this->user->getUserByEmail($email);\t\t\tif($user)\t\t\t{\t\t\t\t$message = array(\t\t\t\t\t'statusCode' => 300,\t\t\t\t\t'errorinput' => 'args[username]',\t\t\t\t\t\"message\" => \"邮箱已经被注册\"\t\t\t\t);\t\t\t\texit(json_encode($message));\t\t\t}\t\t\t$id = $this->user->insertUser(array('username' => $username,'usergroupid' => $defaultgroup['groupid'],'userpassword' => md5($args['userpassword']),'useremail' => $email));\t\t\t$this->session->setSessionUser(array('sessionuserid'=>$id,'sessionpassword'=>md5($args['userpassword']),'sessionip'=>$this->ev->getClientIp(),'sessiongroupid'=>$defaultgroup['groupid'],'sessionlogintime'=>TIME,'sessionusername'=>$username));\t\t\t$message = array(\t\t\t\t'statusCode' => 200,\t\t\t\t\"message\" => \"操作成功\",\n\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}