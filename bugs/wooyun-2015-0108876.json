{"id": 33412, "wybug_id": "wooyun-2015-0108876", "wybug_title": "同花顺部分源码泄露", "wybug_corp": "同花顺", "wybug_author": "set", "wybug_date": "2015-04-19 09:30", "wybug_open_date": "2015-04-24 09:32", "wybug_type": "敏感信息泄露", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码泄露"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-24：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述：  详细说明：  \nhttp://www.10jqka.com.cn/ia/index.php~\n\nhttp://www.10jqka.com.cn/ia/mod.php~\n\nhttp://www.10jqka.com.cn/modules.php~\n\nhttp://www.10jqka.com.cn/modules/toplist/get_js.php~\n\nhttp://www.10jqka.com.cn/modules/trade/get_user_trade_info.php~\n\nhttp://www.10jqka.com.cn/kid_mammon/config.inc\n\n\n\n\n\n\n\n\n   漏洞证明：  \n<?php// Invest Assis Main Filerequire_once(\"include/global.php\");require_once(\"include/sess.php\");require_once(\"config.php\");sess_start();sess_get($is_customer, \"is_customer\");//print_r($aaa);// Invoker check$invoker = chk_invoker();$mod_name = $_REQUEST[name];$entry = $_REQUEST[entry];// 弥补工程部错误的将其他模块发布if(!in_array($mod_name,$allowed_module) && !preg_match('/^172\\.16\\.\\d{1,3}\\.\\d{1,3}$/', $_SERVER[REMOTE_ADDR])){\theader(\"Location: http://www.10jqka.com.cn/ia/building.html\");\texit;}// 弥补结束if(empty($mod_name)){\t//$mod_name = \"invest_center\";\theader(\"Location: http://www.10jqka.com.cn/web_club/\");\texit;}if(empty($entry)){\t$entry = \"index\";}$title = get_page_title($mod_name);// Create global smarty$smar = new IA_Smarty;//$caching = SMARTY_CATCHING;//$cache_lifetime = 0;// If not a customer, go Index.php $auth_result = chk_user_new(\"\", \"\", $_REQUEST['passport']);\t/*if($_SERVER[REMOTE_ADDR] == \"220.184.64.43\"){\t\techo $_REQUEST['bo'];\t\techo sess_is_registered(\"user\");\t\texit;\t}*/if (sess_is_registered(\"user\")){\tsess_get($user, \"user\");\tsess_get($is_customer, \"is_customer\");\t$smar->assign(\"login_info\", \"欢迎<B>\".$user[1].\"</B>使用同花顺理财系统！当前时间为\".date(\"Y年m月d日 H:i:s\"));}else if(!in_array($mod_name, $allowed_module)){\tif((strlen($_COOKIE[user]) == 0) || (0 != $auth_result)){\t\theader(\"location: index.php?name=\".$mod_name.\"&passport=\".$_REQUEST['passport']);\t\texit;\t}}sess_get($aaa, \"access_auth\");if (!is_array($aaa)) $aaa = $access_auth;// If the module rightif (in_array($mod_name, $free_module)) {}elseif(!is_array($aaa) || !array_key_exists($mod_name.\"__\".$_REQUEST['blockname'], $aaa) || (\"1\" != $aaa[$mod_name.\"__\".$_REQUEST['blockname']])) {\t\t$body_tpl = \"body_invoke_err.tpl\";\t$smar->assign(\"title\", $title);\t$smar->assign(\"user\", $user);\t$smar->assign(\"name\", $mod_name);\t$smar->assign(\"invoker\", $invoker);\t$smar->assign(\"msg\", \"您没有足够的权限访问本功能模块！！\");\t$smar->display(\"html_header.tpl\");\t$smar->display(\"header.tpl\");\tif(!empty($_REQUEST[blockname])) $smar->assign(\"blockname\", $_REQUEST[blockname]);\tif($for_account)$smar->display(\"body_header.tpl\");\t$smar->display($body_tpl);\t$smar->display(\"body_footer.tpl\");\t$smar->display(\"footer.tpl\");\t$smar->display(\"html_footer.tpl\");\t\t// 记录出错信息\tinclude_once(\"include/passport.php\");\t$data = base64_decode($_POST[passport]);\t$ppt = new PassPort($data);\t\t\tsess_get($user, \"user\");\t$msg .= \"userinfo = \".print_r($user, 1);\t$msg .= \"passport = \".$data;\t$msg .= \"\\nppt = \".print_r($ppt, 1);\t$msg .= \"\\ncookie = \".print_r(explode(\":\",base64_decode($_COOKIE[user])), 1);\t$msg .= \"\\naaa = \".print_r($aaa, 1);\t$msg .= \"\\nin_array(\".$mod_name.\", free_module): \".in_array($mod_name, $free_module).\"\\n\";\t$msg .= \"is_array(aaa): \".is_array($aaa).\"\\n\";\t$msg .= \"array_key_exists(\".$mod_name.\"__\".$_REQUEST['blockname'].\",aaa): \".array_key_exists($mod_name.\"__\".$_REQUEST['blockname'], $aaa).\"\\n\";\t$msg .= \"aaa[\".$mod_name.\"__\".$_REQUEST['blockname'].\"]: \".$aaa[$mod_name.\"__\".$_REQUEST['blockname']];\tmake_err_log(\"req_error_4\", $msg);\t\texit;}// User have loginedrequire_once(\"include/xsql.php\");require_once(\"include/auth.php\");require_once(\"include/quota.php\");if(isset($_REQUEST[acc_id])){\t\t$cur_acc = $_REQUEST[acc_id];\tsess_set($cur_acc, \"cur_acc\");}else{\t\tsess_get($cur_acc, \"cur_acc\");}sess_get($acc_list, \"acc_list\");if(\"999\" != $acc_list && empty($acc_list)){\t// Get all account of user\tsess_get($user, \"user\");\t$xsql_info = xsql_func(\"invest_get_account_list\", $user[10]);\tif(($xsql_info[\"code\"] != \"0\") || empty($xsql_info[\"info\"])){\t\t$acc_list = \"999\";\t}else{\t\t$acc_list = $xsql_info[\"info\"];\t}\t// Set account list to session(format: acc_list[acc_id=>acc_name])\tsess_set($acc_list, \"acc_list\");}if(\"999\" != $acc_list && !empty($acc_list)){\t$smar->assign(\"mod_name\", $mod_name);\t$smar->assign(\"entry\", $entry);\t// Get user account list\t$i = 0;\tforeach($acc_list as $val){\t\t$acc_list_options[$val[\"ACCOUNTID\"]] = $val[\"ACCOUNTNAME\"];\t\tif(empty($cur_acc) && $i == 0){\t\t\t$cur_acc = $val[\"ACCOUNTID\"];\t\t\tsess_set($cur_acc, \"cur_acc\");\t\t}\t\t\t$i ++;\t}\t$smar->assign(\"acc_list_options\", $acc_list_options);\t$smar->assign(\"cur_acc\", (!empty($_REQUEST[aid])?$_REQUEST[aid]:$cur_acc)); // If isset aid, aid option checked\t$smar->assign(\"acc_select_js\", \"<SCRIPT LANGUAGE=\\\"JavaScript\\\">\\n<!--\\nfunction on_select_acc(acc_id){\\nwindow.location=\\\"mod.php?name=\".$mod_name.\"&func=\".$_REQUEST[func].\"&entry=\".$entry.\"&blockname=\".$_REQUEST[blockname].\"&acc_id=\\\"+acc_id;\\n}\\n//-->\\n</SCRIPT>\");\t$smar->assign(\"acc_temp\", \"temp\");}$body_tpl = \"body_default.tpl\";$body_func = \"body_default\";$self_html = false;$for_account = true;$with_html_header = true;$with_header = true;$with_nav = true;$with_footer = true;run();if($self_html){\t$with_html_header = false;\t$with_header = false;\t$with_nav = false;\t$with_footer = false;}// Output page//$smar->caching = $caching;//$smar->cache_lifetime = $cache_lifetime;$smar->assign(\"title\", $title);$smar->assign(\"user\", $user);$smar->assign(\"name\", $mod_name);$smar->assign(\"invoker\", $invoker);$module_info = &get_module_info($mod_name);$smar->assign(\"module_catalog\", $module_info['cata']);$smar->assign(\"module_name\", $module_info['name']);$smar->register_function(\"body_func\", $body_func);if($with_html_header){\t$smar->display(\"html_header.tpl\");}if($with_header && $invoker != _CLIENT) $smar->display(\"header.tpl\");if(!empty($_REQUEST[blockname])) $smar->assign(\"blockname\", $_REQUEST[blockname]);if($with_nav) $smar->display(\"nav.tpl\");//if(!strcasecmp($mod_name, \"operate_eval\")) $smar->display(\"czfx_nav.tpl\");//if(!strcasecmp($mod_name, \"account_eval\")) $smar->display(\"ccfx_nav.tpl\");if($for_account)$smar->display(\"body_header.tpl\");$smar->display($body_tpl);$smar->display(\"body_footer.tpl\");if($with_footer && $invoker != _CLIENT) $smar->display(\"footer.tpl\");$smar->display(\"html_footer.tpl\");function run(){\tglobal $user;\t$arr_ip = explode(\".\", $_SERVER[\"REMOTE_ADDR\"]);\tif(($arr_ip[0] == \"172\") && ($arr_ip[1] == \"16\")){\t\t// 核新点击不记录\t}else{\t\t/*\t\tif(strlen($user[1])){\t\t\tmysql_connect(\"10.0.0.5\", \"root\", \"kernel\");\t\t\tmysql_select_db(\"cells\");\t\t\t$date = date(\"Y-m-d\");\t\t\t$result = mysql_query(\"SELECT count(*) as c FROM stat_ia WHERE date='\".$date.\"' AND uname='\".$user[1].\"'\");\t\t\tlist($count) = mysql_fetch_row($result);\t\t\tif($count <= 0){\t\t\t\tmysql_query(\"INSERT INTO stat_ia (date, uname) VALUES ('\".$date.\"', '\".$user[1].\"')\");\t\t\t}\t\t\tmysql_close();\t\t}*/\t}\tglobal $mod_name, $entry;\tglobal $smar, $body_tpl, $body_func;\t$include_file = $mod_name.\"/\".$entry.\".php\";\tif(file_exists($include_file)){\t\trequire_once($include_file);\t\t$func = $mod_name.\"__index\";\t\tif(function_exists($func)){\t\t\t$func();\t\t}else{\t\t\t// waiting a default err page\t\t\t$body_tpl = \"body_invoke_err.tpl\";\t\t\t$smar->assign(\"msg\", _NO_FUNC);\t\t\treturn true;\t\t}\t}else{\t\t// waiting a default err page\t\t$body_tpl = \"body_invoke_err.tpl\";\t\t$smar->assign(\"msg\", _NO_MODULE);\t\treturn true;\t}}function body_default(){\tglobal $mod_name, $entry;\tglobal $smar, $body_tpl, $body_func;\tif (sess_get($user, \"user\")){\t\techo \"<table height=\\\"100%\\\" valign=\\\"center\\\"><tr><td height=\\\"100%\\\">\";\t\techo \"<b>Waiting building Investment Center</b>\";\t\techo \"</td<tr></table>\";\t\treturn;\t}}?>\n\n<?phprequire_once(\"mainfile.php\");if(!ip_check($_SERVER[\"REMOTE_ADDR\"])){\tdie(header(\"HTTP/1.0 Not Fount\"));}$vip_mods = array('article', 'star', 'analysist', 'vote_result', 'what', 'article_comment', 'school', 'Forums', 'Your_Account', 'Downloads', 'my_page', 'trade', 'finance', 'hk_index', 'vt_home', 'yjfh', 'sms_order', 'news_caijing', 'news_content', 'news_caijing', 'news_guping');include_once(\"certificate.php\");$module = 1;if(isset($_REQUEST[name])) $module_name = $_REQUEST[name];//$snd_nav = make_snd_nav($name);if (isset($name)) {\tif(in_array($name, $vip_mods)) $vip = true;\telse $vip = false;\t\tif(!$vip){   \t\t $result = sql_query(\"select active, view from \".$prefix.\"_modules where title='$name'\", $dbi);    \t\tlist($mod_active, $view) = sql_fetch_row($result, $dbi);\t}    if ($vip || (($mod_active == 1) OR ($mod_active == 0 AND is_admin($admin)))) {\tif (!isset($mop)) { $mop=\"modload\"; }\tif (!isset($file)) { $file=\"index\"; }\tif (ereg(\"\\.\\.\",$name) || ereg(\"\\.\\.\",$file)) {\t    echo \"You are so cool...\";\t} else {\t    //$ThemeSel = get_theme();\t    $ThemeSel = 'NukeTest';\t    if (file_exists(\"themes/$ThemeSel/modules/$name/$file.php\")) {\t\t\t$modpath = \"themes/$ThemeSel/\";\t    }\t    if ($view == 0) {\t\t\t$modpath .= \"modules/$name/$file.php\";\t\t\tif (file_exists($modpath)) {\t\t\t    \tinclude($modpath);    \t\t\t} else {\t\t\t\tdie (\"Sorry, such file doesn't exist.\");\t\t\t}\t    }\t    if ($view == 1 AND is_user($user) || is_admin($admin)) {\t\t$modpath .= \"modules/$name/$file.php\";    \t\tif (file_exists($modpath)) {\t\t    \tinclude($modpath);    \t\t} else {\t\t    \tdie (\"Sorry, such file doesn't exist..\");\t\t}\t    } elseif ($view == 1 AND !is_user($user) || !is_admin($admin)) {\t\t\t$pagetitle = \"- \"._ACCESSDENIED.\"\";\t\t\tinclude(\"header.php\");\t\t\tif(isset($_REQUEST[agent]) and ereg(\"^[0-9]+$\", $_REQUEST[agent])){\t\t\t\ttitle(\"<br>鉴权错误：\"._ACCESSDENIED.\"<br><br>\");\t\t\t\tOpenTable();\t\t\t\techo \"<br><center><b>对不起，这个区域仅供会员使用！</b><br><br>\";\t\t\t\techo \"<form name=\\\"disp_login\\\" action=\\\"modules.php?name=Your_Account\\\" method=\\\"post\\\">\"\t\t\t\t.\"<hr width=70%><b>用户登录入口</b><br><br>\"\t\t\t\t.\"<table border=\\\"0\\\"><tr><td>\"\t\t\t\t.\"用户名:</td><td><input type=\\\"text\\\" id=\\\"uname\\\" name=\\\"uname\\\" size=\\\"15\\\" maxlength=\\\"25\\\"></td>\"\t\t\t\t.\"<td>&nbsp;&nbsp;\"._PASSWORD.\":</td><td><input type=\\\"password\\\" id=\\\"pass\\\" name=\\\"pass\\\" size=\\\"15\\\" maxlength=\\\"20\\\"></td>\"\t\t\t\t.\"<td>&nbsp;&nbsp;保留登录时间:</td><td><select name=\\\"cookiedate\\\"><option value=\\\"0\\\">一次有效</option><option value=\\\"1\\\" selected>一天有效</option><option value=\\\"2\\\">一月有效</option><option value=\\\"3\\\">一年有效</option></select>\"\t\t\t\t.\"<input type=\\\"hidden\\\" name=\\\"op\\\" value=\\\"login\\\">\"\t\t\t\t\t\t.\"<input type=\\\"hidden\\\" name=\\\"agent\\\" value=\\\"\".$_REQUEST[agent].\"\\\">\"\t\t\t\t.\"<td><input type=\\\"submit\\\" value=\\\"\"._LOGIN.\"\\\"></td></tr></table></form>\";\t\t\t\tCloseTable();\t\t\t}else{\t\t\t\ttitle(\"$sitename: \"._ACCESSDENIED.\"\");\t\t\t\tOpenTable();\t\t\t\techo \"<center><b>\"._RESTRICTEDAREA.\"</b><br><br>\"\t\t    \t.\"\"._MODULEUSERS.\"\"\t\t    \t.\"\"._GOBACK.\"\";\t\t\t\tCloseTable();\t\t\t}\t\t\tinclude(\"footer.php\");\t\t\tdie();\t    \t}\t    \tif ($view == 2 AND is_admin($admin)) {\t\t\t\t$modpath .= \"modules/$name/$file.php\";    \t\t\tif (file_exists($modpath)) {\t\t    \t\tinclude($modpath);    \t\t\t} else {\t\t    \t\tdie (\"Sorry, such file doesn't exist...\");\t\t\t\t}\t\t    \t} elseif ($view == 2 AND !is_admin($admin)) {\t\t\t\t$pagetitle = \"- \"._ACCESSDENIED.\"\";\t\t\t\tinclude(\"header.php\");\t\t\t\ttitle(\"$sitename: \"._ACCESSDENIED.\"\");\t\t\t\tOpenTable();\t\t\t\techo \"<center><b>\"._RESTRICTEDAREA.\"</b><br><br>\"\t\t    \t.\"\"._MODULESADMINS.\"\"\t\t    \t.\"\"._GOBACK.\"\";\t\t\t\tCloseTable();\t\t\t\tinclude(\"footer.php\");\t\t\t\tdie();\t    \t}\t\t}    } else {\t\tinclude(\"header.php\");\t\tOpenTable();\t\techo \"<center><B>\"._MODULENOTACTIVE.\"</B><br><br>\"\t    .\"\"._GOBACK.\"</center>\";\t\tCloseTable();\t\tinclude(\"footer.php\");    }} else {    die (\"Sorry, you can't access this file directly...\");}// 第二级导航function make_snd_nav($name){\tswitch($name){\t\tcase \"Your_Account\":\treturn _SND_NAV_2ND; break;\t\tcase \"my_page\": \t\treturn _SND_NAV_3RD; break;\t\tcase \"trade\":\t\t\treturn _SND_NAV_4TH; break;\t\tcase \"hk_index\":\t\treturn _SND_NAV_5TH; break;\t\tcase \"Downloads\":\t\treturn _SND_NAV_6TH; break;\t\tcase \"finance\":\t\t\treturn _SND_NAV_7TH; break;\t\tcase \"Forums\":\t\t\tbreak; //改在/usr/local/www/mobile/themes/NukeTest/theme.php\t\tdefault:\t\t\t\treturn _SND_NAV_1ST; break;\t}}?>\n   修复方案：  。。。   版权声明：转载请注明来源 set@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-24 09:32 厂商回复：  漏洞Rank：8  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-17 00:05 |    \t\t强子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 入侵，漏洞)\t\t \n  大神联系方式多少    \n     2015-05-18 09:57 |    \t\tset \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:7        | Especially  for you)\t\t \n  @强子 :不是大神    \n     2015-05-19 15:04 |    \t\t强子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 入侵，漏洞)\t\t \n  加Q详谈459093    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}