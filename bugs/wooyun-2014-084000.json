{"id": 46606, "wybug_id": "wooyun-2014-084000", "wybug_title": "php云两处SQL二次注入", "wybug_corp": "php云人才系统", "wybug_author": "D＆G", "wybug_date": "2014-11-21 18:25", "wybug_open_date": "2015-02-19 18:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-19：\t细节向公众公开  简要描述： php云两处二次注入 详细说明：  最新版。两个注入点。顺带一个绕过waf的小技巧。第一处:/member/model/index.class.php39行\nfunction index_action()\t{\t\t$this->public_action();\t\t$this->member_satic();        $this->com_cache();\t\t$resume = $this->obj->DB_select_once(\"resume\",\"`uid`='\".$this->uid.\"'\");\t\t$expect=$this->obj->DB_select_once(\"resume_expect\",\"`id`='\".$resume['def_job'].\"'\");\t\tif($_GET['type']==\"job\")\t\t{\t\t\t$where=\"`job_post` in (\".$expect['job_classid'].\") and `status`<>'1' and `state`='1' and `sdate`<'\".mktime().\"' and `r_status`<>'2' and `edate`>'\".mktime().\"'\";\t\t}elseif($_GET['type']==\"city\"){\t\t\t$where=\"`cityid`='\".$expect['cityid'].\"' and `status`<>'1' and `state`='1' and `sdate`<'\".mktime().\"' and `r_status`<>'2' and `edate`>'\".mktime().\"'\";\t\t}else{\t\t\t$where=\"`state`='1' and status<>'1' and `sdate`<'\".mktime().\"' and `r_status`<>'2' and `edate`>'\".mktime().\"'\";\t\t}\t\t$rows=$this->obj->DB_select_all(\"company_job\",$where.\" order by id desc limit 12\",\"`name`,`id`,`salary`,`edu`,`edate`\");\nwhere 语句拼接了$expect['job_classid'].变量。而这个变量来自于$expect=$this->obj->DB_select_once(\"resume_expect\",\"`id`='\".$resume['def_job'].\"'\"); resume_expect 表。member/model/index.class.php 587行\nfunction saveexpect_action()\t{\t\tif($_POST['submit'])\t\t{\t\t\t$eid=(int)$_POST['eid'];\t\t\tunset($_POST['submit']);\t\t\tunset($_POST['eid']);\t\t\tunset($_POST['urlid']);\t\t\t$_POST['name'] = iconv(\"utf-8\", \"gbk\", $_POST['name']);\t\t\t$where['id']=$eid;\t\t\t$where['uid']=$this->uid;\t\t\t$_POST['lastupdate']=time();\t\t\tif($eid==\"\")\t\t\t{\t\t\t\t$num=$this->obj->DB_select_num(\"resume_expect\",\"`uid`='\".$this->uid.\"'\");\t\t\t\tvar_dump($num);\t\t\t\tif($num>=$this->config['user_number'])\t\t\t\t{\t\t\t\t\techo 1;die;\t\t\t\t}\t\t\t\t$_POST['uid']=$this->uid;\t\t\t\t$nid=$this->obj->insert_into(\"resume_expect\",$_POST);\t\t\t\tif ($nid)\t\t\t\t{\n可以看到整个$_POST插入到了expect表中。完全是可控的。测试过程。因为phpyun有两个waf，360就不说了。phpyun自带的依然可以白名单绕过。这里说一下自带的waf。\nfunction gpc2sql($str,$str2) {\tif(preg_match(\"/select|insert|update|delete|union|into|load_file|outfile/is\", $str))\t{\t\texit(safe_pape());\t}\tif(preg_match(\"/select|insert|update|delete|union|into|load_file|outfile/is\", $str2))\t{\t\texit(safe_pape());\t}\t$arr=array(\" and \"=>\" an d \",\" or \"=>\" Ｏr \",\"%20\"=>\" \",\"select\"=>\"Ｓelect\",\"update\"=>\"Ｕpdate\",\"count\"=>\"Ｃount\",\"chr\"=>\"Ｃhr\",\"truncate\"=>\"Ｔruncate\",\"union\"=>\"Ｕnion\",\"delete\"=>\"Ｄelete\",\"insert\"=>\"Ｉnsert\",\"<\"=>\"&lt;\",\">\"=>\"&gt;\",\"\\\"\"=>\"&quot;\",\"'\"=>\"&acute;\",\"--\"=>\"- -\");\t\tforeach($arr as $key=>$v){    \t$str = preg_replace('/'.$key.'/isU',$v,$str);\t}\treturn $str;}\n这个函数直接过滤了select|insert|update|delete|union|into|load_file|outfile 关键字，$arr=array(\" and \"=>\" an d \",\" or \"=>\" Ｏr \",\"%20\"=>\" \",\"select\"=>\"Ｓelect\",\"update\"=>\"Ｕpdate\",\"count\"=>\"Ｃount\",\"chr\"=>\"Ｃhr\",\"truncate\"=>\"Ｔruncate\",\"union\"=>\"Ｕnion\",\"delete\"=>\"Ｄelete\",\"insert\"=>\"Ｉnsert\",\"<\"=>\"&lt;\",\">\"=>\"&gt;\",\"\\\"\"=>\"&quot;\",\"'\"=>\"&acute;\",\"--\"=>\"- -\"); 这里之前把%20替换为空。之前有人提的利用这里引入or关键字的方式就不可以了。这个过滤还是很变态的。所以这里尝试进行延时注入。其中过滤sleep的正则是这样的：\nsleep\\s*?\\\\([\\d\\.]+?\\\\)\n看了以前原来已经前辈发过了。 WooYun: 360webscan正则不当可被绕过进行SQL注入 sleep里面进行算数运算就可以了。这里说一下别的方法：比如sleep((11))，多加一层括号，sleep((select 2)),等等。所以 WooYun: 360webscan正则不当可被绕过进行SQL注入  这里分析的改成benchmark这样也是不安全的。\nbenchmark\\s*?\\\\(\\d+?|sleep\\s*?\\\\([\\d\\.]+?\\\\)\n最彻底的就是sleep\\s*?\\(.*\\)进行过滤。最后说一下这里的利用过程。首先登陆，post数据到数据库。\n\n\n\n访问一下url触发。\n\n所以这里实现的绕过也就是前辈说过的\n如果我们想让服务器挂掉或者查询当前的数据库环境，很容易，我们可以很轻松的sleep或者获取当前运行的数据库信息了，这些不依赖select字符的事情我们都可以做了。\n第二个点存在招聘会的地方，也是二次注入，写数据的时候需要后台审核。企业预订的时候，抓包。\n\n修改GET /phpyun3.1/index.php?m=ajax&c=zphcom&uid=5&pid=1&jobid=2 HTTP/1.1  jobid为注入payload。然后查看参会企业触发。只是默认情况下，企业申请需要管理员审核。\n\n相关代码:model/zph.class.php23行：\nfunction com_action()\t{\t\t$this->job_cache();\t\t$row=$this->obj->DB_select_once(\"zhaopinhui\",\"`id`='\".(int)$_GET['id'].\"'\");\t\t$this->yunset(\"row\",$row);\t\t$where=\"`zid`='\".(int)$_GET['id'].\"' and status='1'\";\t\tvar_dump($where);\t\t$urlarr[\"c\"]=$_GET['c'];\t\t$urlarr[\"id\"]=$_GET['id'];\t\t$urlarr[\"page\"]=\"{{page}}\";\t\t$pageurl=$this->url(\"index\",$_GET['m'],$urlarr,\"1\");\t\t$rows=$this->get_page(\"zhaopinhui_com\",$where.\"  order by id desc\",$pageurl,\"13\");\t\tif(is_array($rows)){\t\t\tforeach($rows as $key=>$v){\t\t\t\t$rows[$key]['comname']=$this->obj->get_comname($v['uid']);\t\t\t\t$rows[$key]['job']=$this->obj->DB_select_all(\"company_job\",\"id in (\".$v['jobid'].\") and `status`<>'1' and `r_status`<>'2'\",\"name,id\");\t\t\t}\t\t}\n写数据的代码位于model/ajax.class.php894 line\nfunction zphcom_action()\t{\t\tif(!$this->uid || !$this->username || $_COOKIE['usertype']!=2 || $this->uid!=$_GET['uid'])\t\t{\t\t\t$arr['status']=0;\t\t\t$arr['content']=iconv(\"gbk\",\"utf-8\",\"您不是企业用户或者还没有登录,<a href='index.php?m=login&usertype=2'>请先登录</a>\");\t\t}elseif(!$_GET['pid']){\t\t\t$arr['status']=0;\t\t\t$arr['content']=iconv(\"gbk\",\"utf-8\",\"你没有选择招聘会\");\t\t}elseif(!$_GET['jobid']){\t\t\t$arr['status']=0;\t\t\t$arr['content']=iconv(\"gbk\",\"utf-8\",\"你还没有选择职位\");\t\t}elseif(is_array($this->obj->DB_select_once(\"zhaopinhui_com\",\"uid='\".(int)$_GET['uid'].\"' and zid='\".(int)$_GET['pid'].\"'\"))){\t\t\t$arr['status']=0;\t\t\t$arr['content']=iconv(\"gbk\",\"utf-8\",\"您已经参与该招聘会\");\t\t}else{\t\t\t$jobidarr=@explode(\",\",$_GET['jobid']);\t\t\t$array=array();\t\t\tforeach($jobidarr as $v){\t\t\t\tif(!in_array($v,$array)){\t\t\t\t\t$array[]=$v;\t\t\t\t}\t\t\t}\t\t\t$sql['uid']=$_GET['uid'];\t\t\t$sql['zid']=$_GET['pid'];\t\t\t$sql['jobid']=@implode(\",\",$array);\t\t\t$sql['ctime']=mktime();\t\t\t$sql['status']=0;\t\t\t$id=$this->obj->insert_into(\"zhaopinhui_com\",$sql);\n   漏洞证明：  \n\n   修复方案：     版权声明：转载请注明来源 D＆G@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-11-21 20:02 厂商回复： 感谢您的提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-13 09:50 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  顶    \n     2015-04-13 11:29 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @pandas 马甲 你好~    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}