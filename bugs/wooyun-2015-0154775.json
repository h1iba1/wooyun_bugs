{"id": 80957, "wybug_id": "wooyun-2015-0154775", "wybug_title": "小米路由器过滤不严可root权限修改启动项开ssh", "wybug_corp": "小米科技", "wybug_author": "New4", "wybug_date": "2015-11-21 18:34", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "设计不当", "wybug_level": "低", "wybug_rank_0": "1", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "设计不当", "硬件安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-27：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 小米路由器过滤不严可root权限修改启动项开ssh，攻击者通过绕过修改替换rc.local实现开启ssh获取路由器root控制权。 详细说明：  涉及文件：r1d(2.8.16)\\usr\\lib\\lua\\luci\\controller\\service\\datacenter.luar1d(2.8.16)\\usr\\sbin\\thrifttunnel elf执行文件THRIFT_TUNNEL_TO_DATACENTER = \"thrifttunnel 0 '%s'\"    entry({\"api\", \"xqdatacenter\", \"request\"}, call(\"tunnelRequest\"), _(\"\"), 301)function tunnelRequest()    local XQCryptoUtil = require(\"xiaoqiang.util.XQCryptoUtil\")    local payload = XQCryptoUtil.binaryBase64Enc(LuciHttp.formvalue(\"payload\"))    local cmd = XQConfigs.THRIFT_TUNNEL_TO_DATACENTER % payload    local LuciUtil = require(\"luci.util\")    LuciHttp.write(LuciUtil.exec(cmd))endfunction upload()    local fp    local log = require(\"xiaoqiang.XQLog\")    local fs = require(\"luci.fs\")    local tmpfile = \"/userdisk/upload.tmp\"    if fs.isfile(tmpfile) then        fs.unlink(tmpfile)    end    local filename    LuciHttp.setfilehandler(        function(meta, chunk, eof)            if not fp then                if meta and meta.name == \"file\" then                    fp = io.open(tmpfile, \"w\")                    filename = meta.file                    filename = string.gsub(filename, \"+\", \" \")                    filename = string.gsub(filename, \"%%(%x%x)\",                        function(h)                            return string.char(tonumber(h, 16))                        end)                    filename = filename.gsub(filename, \"\\r\\n\", \"\\n\")                end            end            if chunk then                fp:write(chunk)            end            if eof then                fp:close()            end        end    )    local path = LuciHttp.formvalue(\"target\")    if string.match(path, \"\\/$\") == nil then        path = path .. \"/\"    end    fs.mkdir(path, true)    local savename = filename    if fs.isfile(path .. savename) then        local basename = savename        local index = basename:match(\".+()%.%w+$\")        if index then            basename = basename:sub(1, index - 1)        end        local extension = savename:match(\".+%.(%w+)$\")        for i = 1, 100, 1 do            local tmpname = basename .. \"(\" .. i .. \")\"            if extension then                tmpname = tmpname .. \".\" .. extension            end            if not fs.isfile(path .. tmpname) then                savename = tmpname                break            end        end    end    local dest = path .. savename    log.log(3, \"dest=\" .. dest)    fs.rename(tmpfile, dest)    local result = {}    result[\"code\"] = 0    LuciHttp.write_json(result)end关键api函数，参数无过滤带入thrifttunnel 0 '%s'执行。 可实现文件复制及替换功能 详见exp。   漏洞证明：  通过：/api/xqdatacenter/request实现文件复制及替换备份。在：/api/xqdatacenter/upload实现文件上传功能。后通过/api/xqdatacenter/request，实现替换开机/etc/rc.local脚本实现命令间接执行。导致攻击者获取ssh权限或实现木马植入。\nopenwrt 实现启用dropbear ssh功能nvram set ssh_en=1nvram set uart_en=1nvram commitsed -i \":x;N;s/ssh_en/lan_stp/;b x\" /etc/init.d/dropbearsed -i \":x;N;s/version.CHANNEL/version.ROM/;b x\" /etc/init.d/dropbear/etc/init.d/dropbear start\n确定影响版本：小米路由器（R1D）ROM 2.0 稳定版 版本2.8.16（10月16日更新）其他版本未测试   修复方案：  web参数过滤或elf执行命令检查   版权声明：转载请注明来源 New4@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-11-24 16:40 厂商回复： 需要管理员身份，漏洞利用有一定限制。感谢提交！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-27 19:38 |    \t\t大漠長河 \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:10        | ̷̸̨̀͒̏̃ͦ̈́̾( 天龙源景区枫叶正...)\t\t \n  需要管理员身份，漏洞利用有一定限制。感谢提交！然而一样很吊。    \n     2015-11-27 21:26 |    \t\tWinner \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        | Winner)\t\t \n  暗组的New4大神么~~·    \n     2015-11-30 10:11 |    \t\tSuner \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 再读小学生)\t\t \n  New4大神依然在搞路由器    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}