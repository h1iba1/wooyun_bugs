{"id": 53298, "wybug_id": "wooyun-2014-068153", "wybug_title": "TinyShop Sql Injection 1（无视GPC）", "wybug_corp": "tinyrise.com", "wybug_author": "xiaoL", "wybug_date": "2014-07-22 18:11", "wybug_open_date": "2014-10-20 18:12", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-20：\t细节向公众公开  简要描述： TinyShop Sql Injection 1（无视GPC） 详细说明：  后台登陆界面存在检查功能，不安全取值导致的SQL注入。\n/controller/controller_class.php    public  function check()    {                $this->safebox = Safebox::getInstance();        $this->title='后台登录';                        $code = $this->safebox->get($this->captchaKey);        if($code != strtolower(Req::args($this->captchaKey)))        {            $this->msg='验证码错误！';            $this->layout = \"\";            $this->redirect('login',false);        }        else        {            $manager = new Manager(Req::args('name'),Req::args('password'));            $this->msg='验证码错误！';            if($manager->getStatus() == 'online')            {                $back = Req::args('callback');                $model = new Model(\"manager\");                $model->data(array('last_ip'=>Chips::getIP(),'last_login'=>date(\"Y-m-d H:i:s\")))->where(\"id=\".$manager->id)->update();//这里有一个getIP函数，跟入。                if($back === null) $back = $this->defaultAction;                $this->redirect($back,true);            }            else            {                $this->msg='用户名或者密码错误';                $this->layout = \"\";                $this->redirect('login',false);            }        }}\ngetip函数跟进。/framework/lib/util/chips_class.php\tpublic static function getIP()\t{\t\tif (isset($_SERVER[\"HTTP_X_FORWARDED_FOR\"]))$ip = $_SERVER[\"HTTP_X_FORWARDED_FOR\"];\t\telseif (isset($_SERVER[\"HTTP_CLIENT_IP\"])) $ip = $_SERVER[\"HTTP_CLIENT_IP\"];\t\telseif (isset($_SERVER[\"REMOTE_ADDR\"])) $ip = $_SERVER[\"REMOTE_ADDR\"];\t\telseif (getenv(\"HTTP_X_FORWARDED_FOR\")) $ip = getenv(\"HTTP_X_FORWARDED_FOR\");\t\telseif (getenv(\"HTTP_CLIENT_IP\")) $ip = getenv(\"HTTP_CLIENT_IP\");\t\telseif (getenv(\"REMOTE_ADDR\")) $ip = getenv(\"REMOTE_ADDR\");\t\telse $ip = \"Unknown\";\t\treturn $ip;\t}直接获取了$_SERVER[\"HTTP_X_FORWARDED_FOR\"]，gpc也没用了。导致了注入。我输出语句演示。   漏洞证明：  \n\n\n\n   修复方案：  获取转义   版权声明：转载请注明来源 xiaoL@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：3  确认时间：2014-07-24 09:47 厂商回复： 非常感谢您为TinyShop信息安全做的贡献我们将尽快修复,非常感谢您的支持。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-23 10:02 |    \t\tMutoubug \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:16        | <script>alert(wooyun);</script>)\t\t \n  ORZ    \n     2014-09-17 17:17 |    \t\tchopper \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:29        | 菜鸟求学，多多关照~)\t\t \n  ORZ    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 3, "Ranks": null}