{"id": 36989, "wybug_id": "wooyun-2015-0100672", "wybug_title": "NIUBICMS地方门户系统重置任意用户密码", "wybug_corp": "NIUBICMS", "wybug_author": "darker", "wybug_date": "2015-03-11 14:36", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-11：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： http://www.niubicms.com/官方网站。http://demo.niubicms.com/官方demo 详细说明：  部分案例。juwtc.comwww.jlkxxx.comwww.rtxnet.comwww.lbcsw.comwww.cp368.comwww.sihongren.comwww.wa118114.comwww.mylovedz.com0759n.comhaoheihe.comyuecity.netwww.zmdbxw.comwww.rtxnet.combdsh.52aite.cnwww.qzw0595.comxzslhj.comwww.hykm888.cnwww.baixinxi.comwww.anji365.cnwww.jieemall.comwww.ooovv.com漏洞文件:member/login.inc.php\ncase 'getpwd':                        if($do_submit)                        {                                       if(!preg_match('/^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$/i',$email))                                {                                        showjsmsg($sitelang['err-email']);                                }                                $userid=$memberobj->getuseridbyemail($email);                                if($userid)                                {                                        $password=mt_rand(100000,999999);                                        $memberobj->set($userid,array('password'=>$password));                                        if(UC_OPEN)                                        {                                                $info=$memberobj->getbase($userid);                                                $action='editpwd';                                                $username=$info['username'];                                                $old_password='';                                                 $new_password=$password;                                                $email=$info['email'];                                                require_once SYSTEM_ROOT.'api/passport_server_ucenter.php';                                                     }                                        $site_name=$LA['sitename'];                                        $site_url=$LA['siteurl'];                                        $desc='您的登录密码已经重置为：'.$password.'，请尽快登录修改您的密码：<br />';                                        $emailbody=stripslashes(file_get_contents(SYSTEM_ROOT.'template/email/email.html'));                                        $emailbody=str_replace('{$site_name}',$site_name,$emailbody);                                        $emailbody=str_replace('{$site_url}',$site_url,$emailbody);                                        $emailbody=str_replace('{$username}',$site_name.'用户',$emailbody);                                        $emailbody=str_replace('{$email}',$email,$emailbody);                                        $emailbody=str_replace('{$desc}',$desc,$emailbody);                                        $emailbody=str_replace('{$url}',$LA['siteurl'].'member/index.php?file=login&action=login',$emailbody);                                        require_once SYSTEM_ROOT.'include/email.class.php';                                        $emailobj=new email();                                        $emailobj->set($LA['mail_server'], $LA['mail_port'], $LA['mail_user'], $LA['mail_pwd'], $LA['mail_type']);                                        $emailobj->send($email, $LA['sitename'].'- 找回密码', $emailbody, $LA['mail_user']);                                        showjsmsg('新密码已经发送到您的邮箱，请查收后登录！');                                }                                else                                {                                        showjsmsg('该邮箱尚未注册或不存在！');                                }                        }\n随机生成密码为6位数字。$password=mt_rand(100000,999999);......$desc='您的登录密码已经重置为：'.$password.'，请尽快登录修改您的密码：我们注册一个会员。然后找回密码。新生成的密码为6位纯数字。http://demo.niubicms.com/member/index.php?file=login&action=login由于登陆多次，验证码不会失效。\ncase 'login':\t\t\tif($_userid)\t\t\t{\t\t\t\theader(\"location:\".LA_PATH.'member/index.php');exit();\t\t\t}\t\t\t$captcha_open=explode(\",\",$LA['captcha_open']);\t\t\t$captquetion_open=explode(\",\",$LA['captquetion_open']);\t\t\tif(isset($do_submit))\t\t\t{\t\t\t\tif(in_array(2,$captcha_open) && $_POST['inputcheckcode']!=$_SESSION['captcha'])\t\t\t\t{\t\t\t\t\tshowjsmsg('ÑéÖ¤ÂëÊäÈë²»ÕýÈ·£¡');\t\t\t\t}\t\t\t\tif(!preg_match('/^[\\x80-\\xff_a-zA-Z0-9]{1,64}$/i',$account) && !preg_match('/^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$/i',$account))\t\t\t\t{\t\t\t\t\tshowjsmsg('µÇÂ½ÕËºÅ²»´æÔÚ£¡');\t\t\t\t}\t\t\t\tif(preg_match('/[\\x80-\\xff]/i',$password))\t\t\t\t{\t\t\t\t\tshowjsmsg('µÇÂ½ÃÜÂë²»ÕýÈ·£¡');\t\t\t\t}\t\t\t\t\t\t\t\t$info['username']=strpos($account,'@')?'':$account;\t\t\t\t$info['email']=strpos($account,'@')?$account:'';\t\t\t\t$uccode='';\t\t\t\tif(UC_OPEN)\t\t\t\t{\t\t\t\t\trequire_once SYSTEM_ROOT.'api/passport_server_ucenter.php';\t\t\t\t\t$db=new mysql();\t\t\t\t\t$db->connect(LA_HOST,LA_USER,LA_PSW,LA_NAME,LA_PCONNECT,LA_CHARSET);\t\t\t\t}\t\t\t\t$userid=$memberobj->getuserid($account);\t\t\t\tif(!$userid)\t\t\t\t{\t\t\t\t\t$userid=$memberobj->getuseridbyemail($account);\t\t\t\t}\t\t\t\tif(!$userid)\t\t\t\t{\t\t\t\t\tshowjsmsg('µÇÂ½ÕËºÅ²»´æÔÚ£¡');\t\t\t\t}\t\t\t\t$info=$memberobj->get($userid);\t\t\t\tif($info['password']!=md5($password) || !$info)\t\t\t\t{\t\t\t\t\tshowjsmsg('µÇÂ½ÃÜÂë²»ÕýÈ·£¡');\t\t\t\t}\t\t\t\t\t\t\t\t$u=array();\t\t\t\t$u['logintime']=TIME;\t\t\t\t$u['loginip']=IP;\t\t\t\tif($info['expire']<TIME)\t\t\t\t{\t\t\t\t\t$u['gradeid']=3;\t\t\t\t}\t\t\t\t\t\t\t\t$memberobj->set($userid,$u);\t\t\t\t$la_auth_key=md5(AUTH_KEY.$_SERVER['HTTP_USER_AGENT']);\t\t\t\t$la_auth=la_auth($userid.\"\\t\".md5($password),'ENCODE',$la_auth_key);\t\t\t\tset_cookie('auth',$la_auth,0);\t\t\t\t\t\t\t\tif($refer)\t\t\t\t{\t\t\t\t\texit($uccode.'<script language=\"javascript\">top.location.href=\"'.$refer.'\";</script>');\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\texit($uccode.'<script language=\"javascript\">top.location.href=\"'.LA_PATH.'member/index.php?file=user&action=complete\";</script>');\t\t\t\t}\t\t\t}\t\t\telse\t\t\t{\t\t\t\tinclude member_tlp('login');\t\t\t\tbreak;\t\t\t}\n可以暴力破解6位数字。达到重置任意用户密码目的。   漏洞证明：  官方demo 注册用户有点问题。这里使用www.lbcsw.com 这个做演示。= =好像这个发送邮件有点问题。但是不影响漏洞演示，找回密码会重置成10000~999999的纯数字。我们慢慢猜就可以了。\n\n测试的时候线程开大了。= =服务器不堪重任。挂了。   修复方案：  1.生成复杂的随机密码。2.登陆页面验证码出错后，重新生成验证码。   版权声明：转载请注明来源 darker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}