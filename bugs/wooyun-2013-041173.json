{"id": 60997, "wybug_id": "wooyun-2013-041173", "wybug_title": "appcms最新补丁处理不当仍然任意文件下载", "wybug_corp": "appcms.cc", "wybug_author": "lxj616", "wybug_date": "2013-10-28 17:59", "wybug_open_date": "2014-01-26 18:00", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取", "源码审核", "文件操作参数未过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-10-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-10-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-10-31：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-12-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-01-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-01-26：\t细节向公众公开  简要描述： 虽然 appcms 对之前的第一次任意文件下载 进行了修补，但是修补方式不当，导致仍然能够任意文件下载（官方演示站再次验证） 详细说明：  经补丁后的文件pic.php如下（注释为本人做的说明）\n<?phpif(isset($_GET['url']) && trim($_GET['url']) != '' && isset($_GET['type'])) {\t$img_url = base64_decode($_GET['url']);    $_GET['url']=strtolower($img_url);        //解码后相当于没有编码    $_GET['type']=strtolower($_GET['type']);    $arr_a=array('jpg','jpeg','png','gif');   //扩展名白名单    $down=0;                                  //down=1时标记审计策略通过    foreach($arr_a as $b){                    //循环审计        if(strstr($_GET['url'],$b)){          //如果url里包含白名单jpg字符串即为审核通过，问题就出在这里，url里只要出现jpg就可以，那么xxx/xxx.jpg是合法的，但是呢，假定xxxjpg/../xxx.php会通过判定！            $down=1;        }    }    if($_GET['type']=='php') $down=0;         //完全没有用处，不是根据type判定的    if($down==1){        $shffix = trim($_GET['type']);        //下面没有任何限制了，直接文件读取了        header(\"Content-Type: image/{$shffix}\");        readfile($img_url);    }else{        die('image type forbidden');    }} else {\tdie('image not find！');}?>\n结合以上分析，构造一下即可任意文件下载/pic.php?url=MWpwZy8uLi9jb3JlL2NvbmZpZy5jb25uLnBocA==&type=jpg注：示例的base64为：   1jpg/../core/config.conn.php证明在漏洞证明里   漏洞证明：  1.先证明官方演示站点已经打过补丁，即不存在之前的老漏洞\n\n2.证明本次漏洞的存在\nhttp://www.kele8.cn/pic.php?url=MWpwZy8uLi9jb3JlL2NvbmZpZy5jb25uLnBocA==&type=jpg\n\n\n\n\n   修复方案：  严格过滤url中不能有特殊字符话说漏洞要记得到乌云---确认----给高危RANK---然后自己留着别公开，不然超时或者直接标记忽略的话---会直接向公众公开---，其实只要确认后不公开，不用着急发补丁发公告的，反正别人也看不到，下一版本出来时默默地顺便补上就是了，然后再公开什么的   版权声明：转载请注明来源 lxj616@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-10-28 21:21 厂商回复： 已提供新的修复代码 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}