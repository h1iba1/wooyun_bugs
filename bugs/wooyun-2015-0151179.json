{"id": 82399, "wybug_id": "wooyun-2015-0151179", "wybug_title": "Discuz!另一处SSRF无须登陆无须条件", "wybug_corp": "Discuz!", "wybug_author": "Jannock", "wybug_date": "2015-11-02 08:57", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "6", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： SSRF对于小程序来说，并不是什么问题，但对于大企业来说，这可能是极严重的。。。并且泄露了真实IP，这对于WAF来说算是严重的问题。 详细说明：  文件：source/module/forum/forum_ajax.php\n} elseif($_GET['action'] == 'downremoteimg') {\t$_GET['message'] = str_replace(array(\"\\r\", \"\\n\"), array($_GET['wysiwyg'] ? '<br />' : '', \"\\\\n\"), $_GET['message']);\tpreg_match_all(\"/\\[img\\]\\s*([^\\[\\<\\r\\n]+?)\\s*\\[\\/img\\]|\\[img=\\d{1,4}[x|\\,]\\d{1,4}\\]\\s*([^\\[\\<\\r\\n]+?)\\s*\\[\\/img\\]/is\", $_GET['message'], $image1, PREG_SET_ORDER);\tpreg_match_all(\"/\\<img.+src=('|\\\"|)?(.*)(\\\\1)([\\s].*)?\\>/ismUe\", $_GET['message'], $image2, PREG_SET_ORDER);\t$temp = $aids = $existentimg = array();\tif(is_array($image1) && !empty($image1)) {\t\tforeach($image1 as $value) {\t\t\t$temp[] = array(\t\t\t\t'0' => $value[0],\t\t\t\t'1' => trim(!empty($value[1]) ? $value[1] : $value[2])\t\t\t);\t\t}\t}\tif(is_array($image2) && !empty($image2)) {\t\tforeach($image2 as $value) {\t\t\t$temp[] = array(\t\t\t\t'0' => $value[0],\t\t\t\t'1' => trim($value[2])\t\t\t);\t\t}\t}\trequire_once libfile('class/image');\tif(is_array($temp) && !empty($temp)) {\t\t$upload = new discuz_upload();\t\t$attachaids = array();\t\tforeach($temp as $value) {\t\t\t$imageurl = $value[1];\t\t\t$hash = md5($imageurl);\t\t\tif(strlen($imageurl)) {\t\t\t\t$imagereplace['oldimageurl'][] = $value[0];\t\t\t\tif(!isset($existentimg[$hash])) {\t\t\t\t\t$existentimg[$hash] = $imageurl;\t\t\t\t\t$attach['ext'] = $upload->fileext($imageurl);\t\t\t\t\tif(!$upload->is_image_ext($attach['ext'])) {\t\t\t\t\t\tcontinue;\t\t\t\t\t}\t\t\t\t\t$content = '';\t\t\t\t\tif(preg_match('/^(http:\\/\\/|\\.)/i', $imageurl)) {\t\t\t\t\t\t$content = dfsockopen($imageurl);\t\t\t\t\t} elseif(preg_match('/^('.preg_quote(getglobal('setting/attachurl'), '/').')/i', $imageurl)) {\t\t\t\t\t\t$imagereplace['newimageurl'][] = $value[0];\t\t\t\t\t}\n$content = dfsockopen($imageurl);处，直接可以传入URL，造成SSRF   漏洞证明：  \nhttp://xxxx/bbs/forum.php?mod=ajax&action=downremoteimg&message=[img=1,1]http://xxxxxxxxxxxxxx.jpg[/img]&formhash=09cec465\n3.x 版本如果请求提示xss拦截要带上 formhash 加cookie,之前版本好像不用。\n\n   修复方案：  这个我也不懂！   版权声明：转载请注明来源 Jannock@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-11-06 09:58 厂商回复： 感谢您提出的问题，我们尽快予以修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-02 09:03 |    \t\t我的邻居王婆婆 \t\t\t( 普通白帽子  |\t\t\t        Rank:2991 漏洞数:508        | 刚发现个好洞网站就挂了)\t\t \n  前排     \n     2015-11-02 09:06 |    \t\t撸大叔 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:11        | 钓鱼培养耐心  养鱼需要精心！)\t\t \n  终于等到另一处了 ！    \n     2015-11-02 09:06 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  观望一哥    \n     2015-11-02 09:52 |    \t\t爱与诚一号 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        )\t\t \n  哎哟我去这个吊这个吊     \n     2015-11-02 11:49 |    \t\tYuku \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:20        | 数据挖掘)\t\t \n  牛逼    \n     2015-11-02 14:25 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:532 漏洞数:79        | 潜心学习~~~)\t\t \n  钱呢？雷呢？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}