{"id": 39911, "wybug_id": "wooyun-2015-092941", "wybug_title": "LebiShop商城系统最新版十一处SQL注入六", "wybug_corp": "www.lebi.cn", "wybug_author": "xfkxfk", "wybug_date": "2015-01-23 15:34", "wybug_open_date": "2015-04-23 15:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-23：\t细节向公众公开  简要描述： LebiShop商城系统最新版十一处SQL注入六 详细说明：  LebiShop商城系统最新版十一处SQL注入这里也是需要有商家账号权限首先注册普通用户账户，然后申请注册商家账户申请商家用户是默认开发注册的Shop.Supplier.Ajax.ajax_config文件第一处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void Bank_Del(){\tif (!base.Power(\"supplier_bank_list\", \"收款账号\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"Fid\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_Supplier_Bank.Delete(string.Concat(new object[]\t{\t\t\"id in (\",\t\tid,//注入产生\t\t\") and Supplier_id = \",\t\tthis.CurrentSupplier.id\t}));\tLog.Add(\"删除收款账号\", \"Bank\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第二处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void BillType_Del(){\tif (!base.Power(\"supplier_billtype_list\", \"发票管理\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"Fid\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_Supplier_BillType.Delete(string.Concat(new object[]\t{\t\t\"id in (\",\t\tid,//注入产生\t\t\") and Supplier_id = \",\t\tthis.CurrentSupplier.id\t}));\tLog.Add(\"删除发票类型\", \"BillType\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第三处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void indeximage_Del(){\tif (!EX_Admin.Power(\"indeximage_del\", \"删除店铺幻灯\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"ids\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_Page.Delete(string.Concat(new object[]\t{\t\t\"id in (\",\t\tid,//注入产生\t\t\") and Supplier_id=\",\t\tthis.CurrentSupplier.id\t}));\tLog.Add(\"删除店铺幻灯\", \"Page\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第四处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void Message_Del(){\tif (!base.Power(\"supplier_message\", \"站内信\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"ids\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_Message.Delete(string.Concat(new object[]\t{\t\t\"Supplier_id=\",\t\tthis.CurrentSupplier.id,\t\t\" and id in (\",\t\tid,//注入产生\t\t\")\"\t}));\tLog.Add(\"删除站内信\", \"Message\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第五处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void ServicePanel_Del(){\tif (!base.Power(\"supplier_servicepanel_list\", \"客服面板\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"ids\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_ServicePanel.Delete(string.Concat(new object[]\t{\t\t\"Supplier_id = \",\t\tthis.CurrentSupplier.id,\t\t\" and id in (\",\t\tid,//注入产生\t\t\")\"\t}));\tLog.Add(\"删除客服成员\", \"ServicePanel\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第六处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void ServicePanel_Group_Del(){\tif (!base.Power(\"supplier_servicepanel_list\", \"客服面板\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"ids\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_ServicePanel_Group.Delete(string.Concat(new object[]\t{\t\t\"Supplier_id = \",\t\tthis.CurrentSupplier.id,\t\t\" and id in (\",\t\tid,//注入产生\t\t\")\"\t}));\tLog.Add(\"删除客服部门\", \"ServicePanel_Group\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第七处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void ServicePanel_Group_Update(){\tif (!base.Power(\"supplier_servicepanel_list\", \"客服面板\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"Uid\");\tList<Lebi_ServicePanel_Group> models = B_Lebi_ServicePanel_Group.GetList(string.Concat(new object[]\t{\t\t\"Supplier_id = \",\t\tthis.CurrentSupplier.id,\t\t\" and id in (\",\t\tid,//注入产生\t\t\")\"\t}), \"\");\tforeach (Lebi_ServicePanel_Group model in models)\t{\t\tmodel.Sort = RequestTool.RequestInt(\"Sort\" + model.id, 0);\t\tmodel.Name = RequestTool.RequestString(\"Name\" + model.id);\t\tB_Lebi_ServicePanel_Group.Update(model);\t}\tLog.Add(\"编辑客服部门\", \"ServicePanel_Group\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第八处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void ServicePanel_Update(){\tif (!base.Power(\"supplier_servicepanel_list\", \"客服面板\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"Uid\");\tList<Lebi_ServicePanel> models = B_Lebi_ServicePanel.GetList(string.Concat(new object[]\t{\t\t\"Supplier_id = \",\t\tthis.CurrentSupplier.id,\t\t\" and id in (\",\t\tid,//注入产生\t\t\")\"\t}), \"\");\tforeach (Lebi_ServicePanel model in models)\t{\t\tmodel.Sort = RequestTool.RequestInt(\"Sort\" + model.id, 0);\t\tmodel.Name = RequestTool.RequestString(\"Name\" + model.id);\t\tmodel.Account = RequestTool.RequestString(\"Account\" + model.id);\t\tB_Lebi_ServicePanel.Update(model);\t}\tLog.Add(\"编辑客服成员\", \"ServicePanel\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第九处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void Transport_Price_Del(){\tif (!base.Power(\"supplier_transport_list\", \"配送方式\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tstring id = RequestTool.RequestString(\"Fid\");\tif (id == \"\")\t{\t\tbase.Response.Write(\"{\\\"msg\\\":\\\"\" + base.Tag(\"请选择要删除的信息\") + \"\\\"}\");\t\treturn;\t}\tB_Lebi_Transport_Price.Delete(string.Concat(new object[]\t{\t\t\"id in (\",\t\tid,//注入产生\t\t\") and Supplier_id = \",\t\tthis.CurrentSupplier.id\t}));\tLog.Add(\"删除配送区域\", \"Transport_Price\", id.ToString(), this.CurrentSupplier, id.ToString());\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n第十处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void Transport_Price_Edit(){......else\t{\t\tstring aids = RequestTool.RequestString(\"Area_ids\");\t\tif (aids == \"\")\t\t{\t\t\taids = \"0\";\t\t}\t\tList<Lebi_Area> areas = B_Lebi_Area.GetList(\"id in (\" + aids + \")\", \"\");\n参数aids在GetList方法中的in条件语句中产生注入第十一处SQL注入\n// Shop.Supplier.Ajax.ajax_configpublic void Transport_Price_Update(){\tif (!base.Power(\"supplier_transport_list\", \"配送方式\"))\t{\t\tbase.AjaxNoPower();\t\treturn;\t}\tint tid = RequestTool.RequestInt(\"tid\", 0);\tstring id = RequestTool.RequestString(\"Uid\");\tLebi_Transport tmodel = B_Lebi_Transport.GetModel(tid);\tList<Lebi_Transport_Price> models = B_Lebi_Transport_Price.GetList(string.Concat(new object[]\t{\t\t\"id in (\",\t\tid,//注入产生\t\t\") and Transport_id=\",\t\ttid,\t\t\"  and Supplier_id = \",\t\tthis.CurrentSupplier.id\t}), \"\");\tforeach (Lebi_Transport_Price model in models)\t{\t\tmodel.Price = RequestTool.GetFormDecimal(\"Price\" + model.id, 0m);\t\tmodel.Weight_Start = RequestTool.GetFormDecimal(\"Weight_Start\" + model.id, 0m);\t\tmodel.Weight_Step = RequestTool.GetFormDecimal(\"Weight_Step\" + model.id, 0m);\t\tmodel.Price_Step = RequestTool.GetFormDecimal(\"Price_Step\" + model.id, 0m);\t\tB_Lebi_Transport_Price.Update(model);\t}\tLog.Add(\"编辑配送区域\", \"Transport_Price\", id.ToString(), this.CurrentSupplier, tmodel.Name);\tbase.Response.Write(\"{\\\"msg\\\":\\\"OK\\\"}\");}\n上述SQL注入都是在通过RequestTool.RequestString方法获取参数值这里只是进行了单引号的转义然后参数值进入了数据库执行的in条件SQL语句在in条件语句中没有单引号保护，导致RequestTool.RequestString的处理无效导致恶意sql语句进入sql条件语句中，最终导致SQL注入产生   漏洞证明：  以第一处sql注入为例官方demo演示报出当前数据库信息\nhttp://plus.demo.lebi.cn/supplier/ajax/ajax_config.aspx?__Action=Bank_Del&url=/Fid=db_name()\n\n\n使用SQLmap即可跑出数据   修复方案：  使用RequestTool.RequestInt获取参数，或者给变量加上单引号   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-01-26 15:11 厂商回复： 已统一修复SQL漏洞，感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-23 15:49 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  就不能打包么。。我擦    \n     2015-01-23 15:52 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @roker 大礼包在后面    \n     2015-01-23 16:20 |    \t\t淡蓝色の忧伤 \t\t\t( 普通白帽子  |\t\t\t        Rank:172 漏洞数:26        | 开启审计php代码模式      (⊙v⊙)嗯)\t\t \n  你关注的白帽子 xfkxfk 发表了漏洞 LebiShop商城系统最新版十一处SQL注入六你关注的白帽子 xfkxfk 发表了漏洞 LebiShop商城系统最新版SQL注入五你关注的白帽子 xfkxfk 发表了漏洞 LebiShop商城系统最新版九处SQL注入四你关注的白帽子 xfkxfk 发表了漏洞 LebiShop商城系统最新版六处SQL注入三你关注的白帽子 xfkxfk 发表了漏洞 LebiShop商城系统最新版两处SQL注入二你关注的白帽子 xfkxfk 发表了漏洞 LebiShop商城系统最新版SQL注入一(同一文件多处)    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}