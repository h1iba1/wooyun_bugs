{"id": 987, "wybug_id": "wooyun-2014-067044", "wybug_title": "Kindeditor特定情况可能会导致全盘浏览", "wybug_corp": "上海浩跃软件有限公司", "wybug_author": "Tea", "wybug_date": "2014-07-04 18:53", "wybug_open_date": "2014-10-02 18:54", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["目录浏览"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-02：\t细节向公众公开  简要描述： 因为例子很少，开始想了下不是他们的漏洞，后面想了下，后面没有检查好用户的正常配置内容导致，还是提下吧。 详细说明：  下载地址：http://kindeditor.googlecode.com/files/kindeditor-4.1.10.zip貌似是最新版本的。测试语言：PHP测试漏洞文件：/kindeditor/php/file_manager_json.php默认配置(第16行)：\n$root_path = $php_path . '../attached/';\n当/attached/文件夹不存在(被删)或者被改名为一个不存在的目录时，如网上的一个例子：\n$root_path = $php_path . '../../../upload/';\n这个CMS下面的目录根本就没得这个目录，所以就造成了漏洞。怎么造成了漏洞的呢？我们分析下。\n<?php/** * KindEditor PHP * * 本PHP程序是演示程序，建议不要直接在实际项目中使用。 * 如果您确定直接使用本程序，使用之前请仔细确认相关安全设置。 * */require_once 'JSON.php';$php_path = dirname(__FILE__) . '/';$php_url = dirname($_SERVER['PHP_SELF']) . '/';//根目录路径，可以指定绝对路径，比如 /var/www/attached/$root_path = $php_path . '../../../upload/';//根目录URL，可以指定绝对路径，比如 http://www.yoursite.com/attached/$root_url = $php_url . '../../../upload/';//图片扩展名$ext_arr = array('gif', 'jpg', 'jpeg', 'png', 'bmp');//目录名$dir_name = empty($_GET['dir']) ? '' : trim($_GET['dir']);if (!in_array($dir_name, array('', 'image', 'flash', 'media', 'file'))) {\techo \"Invalid Directory name.\";\texit;}if ($dir_name !== '') {\t$root_path .= $dir_name . \"/\";\t$root_url .= $dir_name . \"/\";\tif (!file_exists($root_path)) {\t\tmkdir($root_path);\t}}//根据path参数，设置各路径和URLif (empty($_GET['path'])) {\t$current_path = realpath($root_path) . '/';\t$current_url = $root_url;\t$current_dir_path = '';\t$moveup_dir_path = '';} else {\t$current_path = realpath($root_path) . '/' . $_GET['path'];\t$current_url = $root_url . $_GET['path'];\t$current_dir_path = $_GET['path'];\t$moveup_dir_path = preg_replace('/(.*?)[^\\/]+\\/$/', '$1', $current_dir_path);}//echo realpath($root_path);//排序形式，name or size or type$order = empty($_GET['order']) ? 'name' : strtolower($_GET['order']);//不允许使用..移动到上一级目录if (preg_match('/\\.\\./', $current_path)) {\techo 'Access is not allowed.';\texit;}//最后一个字符不是/if (!preg_match('/\\/$/', $current_path)) {\techo 'Parameter is not valid.';\texit;}//目录不存在或不是目录if (!file_exists($current_path) || !is_dir($current_path)) {\techo 'Directory does not exist.';\texit;}//遍历目录取得文件信息$file_list = array();if ($handle = opendir($current_path)) {\t$i = 0;\twhile (false !== ($filename = readdir($handle))) {\t\tif ($filename{0} == '.') continue;\t\t$file = $current_path . $filename;\t\tif (is_dir($file)) {\t\t\t$file_list[$i]['is_dir'] = true; //是否文件夹\t\t\t$file_list[$i]['has_file'] = (count(scandir($file)) > 2); //文件夹是否包含文件\t\t\t$file_list[$i]['filesize'] = 0; //文件大小\t\t\t$file_list[$i]['is_photo'] = false; //是否图片\t\t\t$file_list[$i]['filetype'] = ''; //文件类别，用扩展名判断\t\t} else {\t\t\t$file_list[$i]['is_dir'] = false;\t\t\t$file_list[$i]['has_file'] = false;\t\t\t$file_list[$i]['filesize'] = filesize($file);\t\t\t$file_list[$i]['dir_path'] = '';\t\t\t$file_ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));\t\t\t$file_list[$i]['is_photo'] = in_array($file_ext, $ext_arr);\t\t\t$file_list[$i]['filetype'] = $file_ext;\t\t}\t\t$file_list[$i]['filename'] = $filename; //文件名，包含扩展名\t\t$file_list[$i]['datetime'] = date('Y-m-d H:i:s', filemtime($file)); //文件最后修改时间\t\t$i++;\t}\tclosedir($handle);}//排序function cmp_func($a, $b) {\tglobal $order;\tif ($a['is_dir'] && !$b['is_dir']) {\t\treturn -1;\t} else if (!$a['is_dir'] && $b['is_dir']) {\t\treturn 1;\t} else {\t\tif ($order == 'size') {\t\t\tif ($a['filesize'] > $b['filesize']) {\t\t\t\treturn 1;\t\t\t} else if ($a['filesize'] < $b['filesize']) {\t\t\t\treturn -1;\t\t\t} else {\t\t\t\treturn 0;\t\t\t}\t\t} else if ($order == 'type') {\t\t\treturn strcmp($a['filetype'], $b['filetype']);\t\t} else {\t\t\treturn strcmp($a['filename'], $b['filename']);\t\t}\t}}usort($file_list, 'cmp_func');$result = array();//相对于根目录的上一级目录$result['moveup_dir_path'] = $moveup_dir_path;//相对于根目录的当前目录$result['current_dir_path'] = $current_dir_path;//当前目录的URL$result['current_url'] = $current_url;//文件数$result['total_count'] = count($file_list);//文件列表数组$result['file_list'] = $file_list;//输出JSON字符串header('Content-type: application/json; charset=UTF-8');$json = new Services_JSON();echo $json->encode($result);\n第三十八行：$current_path = realpath($root_path) . '/';当$root_path被realpath以后，不存在的目录会返回空，然后连接后面的'/'$current_path所以默认就等于'/'当提交了$_GET['path']以后，而且$_GET['path']要以'/'为结尾(有验证)，所以，我们就可以构造浏览全盘目录了。kingedit/php/file_manager_json.php?path=/ (浏览盘符的根目录)   漏洞证明：  接着上面给出验证的（互联网找到几个）：先给本地的(attached文件夹被我删了)：\n\n\n\n互联网找到的：http://demo.douco.com/admin/include/kindeditor/php/file_manager_json.php?path=home/demodoucokdce4mmohd8okuoc1o/wwwroot/&dir=image\n\nhttp://route53.com.tw/static/jscripts/kindeditor/php/file_manager_json.php?path=home/onepage/public_html/\n\nhttp://www.bndvalve.com/Public/kindeditor/php/file_manager_json.php?path=wwwroot/bonade/\n\n   修复方案：  再验证下绝对路径？   版权声明：转载请注明来源 Tea@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-07-09 15:28 厂商回复： 暂未建立与软件生产厂商的处置渠道，先行确认，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-31 22:43 |    \t\tj2ck3r \t\t\t( 普通白帽子  |\t\t\t        Rank:406 漏洞数:92        | 别关注我，跟你不熟。)\t\t \n  测试是什么版本的？    \n     2014-08-02 23:34 |    \t\tTea \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:37        | Can't We Be Young.)\t\t \n  @j2ck3r 详细说明里面有，最新版本吧。    \n     2014-08-03 12:42 |    \t\tj2ck3r \t\t\t( 普通白帽子  |\t\t\t        Rank:406 漏洞数:92        | 别关注我，跟你不熟。)\t\t \n  @Tea 这漏洞我从来没有成功过 不知道你是在什么环境下成功的    \n     2014-08-03 12:45 |    \t\tTea \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:37        | Can't We Be Young.)\t\t \n  @j2ck3r 例子，还有乌云。    \n     2014-10-02 09:51 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @Tea 应该很少有CMS的kindeditor会没有attached目录吧    \n     2014-10-08 10:00 |    \t\tTea \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:37        | Can't We Be Young.)\t\t \n  @U神 前面说了。。配置文件跟目录不一致了就会有。。默认是存在那目录的。所以标题叫特定情况。。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}