{"id": 45206, "wybug_id": "wooyun-2014-088872", "wybug_title": "phpyun v3.2 (20141226) 两处注入。", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2014-12-29 18:32", "wybug_open_date": "2015-03-29 18:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-29：\t细节向公众公开  简要描述： 最近更新日期（2014-12-26）又更新了,  麻烦别再给5rank了 20走起可好。一处是新的 一处算是绕过补丁了。之前还有一两个没打补丁哦 加快速度把。 详细说明：  第一处 新发现的在兑换奖品的时候在model/redeem.class.php中\nfunction dh_action(){\t\t$this->public_action();\t\tif(!$this->uid && !$this->username)\t    {\t\t     $this->obj->ACT_layer_msg(\"您还没有登录，请先登录！\",8,$_SERVER['HTTP_REFERER']);\t\t}\t\tif($_POST['submit']){\t\t\tif(!$_POST['password']){\t\t\t\t$this->obj->ACT_layer_msg(\"密码不能为空！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}\t\t\tif(!$_POST['linkman'] || !$_POST['linktel'] ){\t\t\t\t$this->obj->ACT_layer_msg(\"联系人或联系电话不能为空！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}\t\t\t$info=$this->obj->DB_select_once(\"member\",\"`uid`='\".$this->uid.\"'\",\"`password`,`salt`\");\t\t\t$passwrod=md5(md5($_POST['password']).$info['salt']);\t\t\tif($info['password']!=$passwrod){\t\t\t\t$this->obj->ACT_layer_msg(\"密码不正确！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}\t\t\tif(!$this->uid && !$this->username){\t\t\t\t $this->obj->ACT_layer_msg(\"您还没有登录，请先登录！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}else{\t\t\t\tif($_POST['num']<1){\t\t\t\t\t$this->obj->ACT_layer_msg(\"请填写正确的数量！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t}else{\t\t\t\t\tif($_COOKIE['usertype']==\"1\"){\t\t\t\t\t\t$table=\"member_statis\";\t\t\t\t\t}elseif($_COOKIE['usertype']==\"2\"){\t\t\t\t\t\t$table=\"company_statis\";\t\t\t\t\t}elseif($_COOKIE['usertype']==\"3\"){\t\t\t\t\t\t$table=\"lt_statis\";\t\t\t\t\t}elseif($_COOKIE['usertype']==\"4\"){\t\t\t\t\t\t$table=\"px_train_statis\";\t\t\t\t\t}\t\t\t\t\t$info=$this->obj->DB_select_once($table,\"`uid`='\".$this->uid.\"'\",\"integral\");\t\t\t\t\t$gift=$this->obj->DB_select_once(\"reward\",\"`id`='\".(int)$_GET['id'].\"'\");\t\t\t\t\tif($_POST['num']>$gift['stock']){\t\t\t\t\t\t$this->obj->ACT_layer_msg(\"已超出库存数量！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t\t}else{\t\t\t\t\t\tif($gift['restriction']!=\"0\"&&$_POST['num']>$gift['restriction']){\t\t\t\t\t\t\t$this->obj->ACT_layer_msg(\"已超出限购数量！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$integral=$gift['integral']*$_POST['num'];\t\t\t\t\t\t\tif($info['integral']<$integral){\t\t\t\t\t\t\t\t$this->obj->ACT_layer_msg(\"您的积分不足！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t$this->obj->company_invtal($this->uid,$integral,false,\"积分兑换\",true,2,'integral',24);\t\t\t\t\t\t\t\t$value.=\"`uid`='\".$this->uid.\"',\";\t\t\t\t\t\t\t\t$value.=\"`username`='\".$this->username.\"',\";\t\t\t\t\t\t\t\t$value.=\"`usertype`='\".$_COOKIE['usertype'].\"',\";\t\t\t\t\t\t\t\t$value.=\"`name`='\".$gift['name'].\"',\";\t\t\t\t\t\t\t\t$value.=\"`gid`='\".$gift['id'].\"',\";\t\t\t\t\t\t\t\t$value.=\"`linkman`='\".$_POST['linkman'].\"',\";\t\t\t\t\t\t\t\t$value.=\"`linktel`='\".$_POST['linktel'].\"',\";\t\t\t\t\t\t\t\t$value.=\"`body`='\".$_POST['body'].\"',\";\t\t\t\t\t\t\t\t$value.=\"`integral`='\".$integral.\"',\";\t\t\t\t\t\t\t\t$value.=\"`num`='\".$_POST['num'].\"',\";//这里被单引号了。\t\t\t\t\t\t\t\t$value.=\"`ctime`='\".time().\"'\";\t\t\t\t\t\t\t\t$this->obj->DB_insert_once(\"change\",$value);\t\t\t\t\t\t\t\t$this->obj->DB_update_all(\"reward\",\"`stock`=`stock`-\".$_POST['num'].\"\",\"`id`='\".(int)$_GET['id'].\"'\");//注意看这里 `stock`-\".$_POST['num'] 直接把post来的带入到了查询当中 没有被单引号 再来看DB_update_all\t\t\t\t\t\t\t\t$this->obj->ACT_layer_msg(\"兑换成功，请等待管理员审核！\",9,$_SERVER['HTTP_REFERER']);\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t\t  }\t\t}\n \nfunction DB_update_all($tablename, $value, $where = 1){    \t$SQL = \"UPDATE `\" . $this->def . $tablename . \"` SET $value WHERE $where\"; \t\t$this->db->query(\"set sql_mode=''\");\t\t$return=$this->db->query($SQL);\t\treturn $return;\t}\n查询查询但是我们来看看$_POST['num'] 之前有啥处理没。可以看到前面有三个比较。\nif($_POST['num']<1){ //这里比较是否小于1 php弱语言 像1asdxx 都能过。\t\t\t\t\t$this->obj->ACT_layer_msg(\"请填写正确的数量！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t}else{\t\t\t\t\tif($_COOKIE['usertype']==\"1\"){\t\t\t\t\t\t$table=\"member_statis\";\t\t\t\t\t}elseif($_COOKIE['usertype']==\"2\"){\t\t\t\t\t\t$table=\"company_statis\";\t\t\t\t\t}elseif($_COOKIE['usertype']==\"3\"){\t\t\t\t\t\t$table=\"lt_statis\";\t\t\t\t\t}elseif($_COOKIE['usertype']==\"4\"){\t\t\t\t\t\t$table=\"px_train_statis\";\t\t\t\t\t}\t\t\t\t\t$info=$this->obj->DB_select_once($table,\"`uid`='\".$this->uid.\"'\",\"integral\");\t\t\t\t\t$gift=$this->obj->DB_select_once(\"reward\",\"`id`='\".(int)$_GET['id'].\"'\");\t\t\t\t\tif($_POST['num']>$gift['stock']){、//这里第二处比较 这里是把商品查询出来 看看他的库存。 然后与传递过来的num比较 所以这里我们num最好就为1 然后这里我先输出胰腺癌。 var_dump($_POST['num']>$gift['stock']);exit;这里的库存为100.  发现如果我传递的num为1asd之类的时候 竟然true了。。 那么就失败了, 然后再继续测试 当传递的num为1+asd就返回false 意味着成功了。 那么这里我们就添加一个加号。\t\t\t\t\t\t$this->obj->ACT_layer_msg(\"已超出库存数量！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t\t}else{\t\t\t\t\t\tif($gift['restriction']!=\"0\"&&$_POST['num']>$gift['restriction']){\t\t\t\t\t\t\t$this->obj->ACT_layer_msg(\"已超出限购数量！\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t\t\t}else{\n\n\n\n\n那么我们就能绕过这个判断了。\n\nUPDATE `phpyun_reward` SET `stock`=`stock`-1+1,name=(select concat(username,0x23,password) from php_admin_user) WHERE `id`='1'此时执行的语句\n\n这里随便说一下 补丁解决泄漏key的那个方法太渣了把。。很轻松的就绕过去了。  这里不多说， 简直。。第二处在 api\\alipay\\alipayto.php\nrequire_once(dirname(dirname(dirname(__FILE__))).\"/data/db.config.php\");require_once(dirname(dirname(dirname(__FILE__))).\"/data/db.safety.php\");//添加了过滤的进来。require_once(dirname(dirname(dirname(__FILE__))).\"/plus/config.php\");require_once(dirname(dirname(dirname(__FILE__))).\"/include/mysql.class.php\");$db = new mysql($db_config['dbhost'], $db_config['dbuser'], $db_config['dbpass'], $db_config['dbname'], ALL_PS, $db_config['charset']);if(!is_numeric($_POST['dingdan'])){die;} $_COOKIE['uid']=(int)$_COOKIE['uid'];$_POST['is_invoice']=(int)$_POST['is_invoice'];$_POST['balance']=(int)$_POST['balance']; $member_sql=$db->query(\"SELECT * FROM `\".$db_config[\"def\"].\"member` WHERE `uid`='\".$_COOKIE['uid'].\"' limit 1\");$member=mysql_fetch_array($member_sql);  if($member['username'] != $_COOKIE['username'] || $member['usertype'] != $_COOKIE['usertype']||md5($member['username'].$member['password'].$member['salt'])!=$_COOKIE['shell']){  \techo '登录信息验证错误，请重新登录！';die;}  $sql=$db->query(\"select * from `\".$db_config[\"def\"].\"company_order` where `order_id`='\".$_POST['dingdan'].\"' AND `order_price`>=0\");$row=mysql_fetch_array($sql);if(!$row['uid'] || $row['uid']!=$_COOKIE['uid']){\tdie;}if((int)$_POST['is_invoice']=='1'&&$config[\"sy_com_invoice\"]){\t$invoice_title=\",`is_invoice`='\".$_POST['is_invoice'].\"'\";\tif($_POST['linkway']=='1'){\t\t$com_sql=$db->query(\"select `linkman`,`linktel`,`address` from `\".$db_config[\"def\"].\"company` where `uid`='\".$_COOKIE['uid'].\"'\");//查询余额\t\t$company=mysql_fetch_array($com_sql);   \t\t$link=\",'\".$company['linkman'].\"','\".$company['linktel'].\"','\".$company['address'].\"'\";\t\t$up_record=\",`link_man`='\".$company['linkman'].\"',`link_moblie`='\".$company['linktel'].\"',`address`='\".$company['address'].\"'\";\t}else{  \t\t$link=\",'\".$_POST['link_man'].\"','\".$_POST['link_moblie'].\"','\".$_POST['address'].\"'\"; \t\t$up_record=\",`link_man`='\".$_POST['link_man'].\"',`link_moblie`='\".$_POST['link_moblie'].\"',`address`='\".$_POST['address'].\"'\";\t}\t$record_sql=$db->query(\"select `id` from `\".$db_config[\"def\"].\"invoice_record` where `order_id`='\".$_POST['dingdan'].\"' and `uid`='\".$_COOKIE['uid'].\"'\");\t$record=mysql_fetch_array($record_sql);  \tif($record['id']){\t\t$upr_sql=$db->query(\"update `\".$db_config[\"def\"].\"invoice_record` set `title`='\".trim($_POST['invoice_title']).\"',`status`='0',`addtime`='\".time().\"'\".$up_record.\" where `id`='\".$record['id'].\"'\");\t\tmysql_fetch_array($upr_sql);\n可以看到 data/db.safety.php  把过滤文件添加进来了。那么这里的$_POST我们就不能引入单引号了。但是。。\nif($_POST['linkway']=='1'){\t\t$com_sql=$db->query(\"select `linkman`,`linktel`,`address` from `\".$db_config[\"def\"].\"company` where `uid`='\".$_COOKIE['uid'].\"'\");//查询余额\t\t$company=mysql_fetch_array($com_sql);   \t\t$link=\",'\".$company['linkman'].\"','\".$company['linktel'].\"','\".$company['address'].\"'\";//当linkway为1的时候 这里拼接的是出库来的 。。\t\t$up_record=\",`link_man`='\".$company['linkman'].\"',`link_moblie`='\".$company['linktel'].\"',`address`='\".$company['address'].\"'\";\t}else{  \t\t$link=\",'\".$_POST['link_man'].\"','\".$_POST['link_moblie'].\"','\".$_POST['address'].\"'\"; \t\t$up_record=\",`link_man`='\".$_POST['link_man'].\"',`link_moblie`='\".$_POST['link_moblie'].\"',`address`='\".$_POST['address'].\"'\";\t}\n首先编辑自己的企业信息 把safekey加进去。\n\n这里我直接把语句数出来了。\n\n   漏洞证明：  \n\n   修复方案：  第一个用pylode第二个对出库的addslashes一次。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-12-29 18:59 厂商回复： 感谢您的提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-29 21:59 |    \t\t世纪缘 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | 专注无线网络安全！)\t\t \n  说好的rank20起步！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}