{"id": 3207, "wybug_id": "wooyun-2014-061158", "wybug_title": " Anymacro 邮件系统N处SQL注入漏洞", "wybug_corp": "北京安宁创新网络科技有限公司", "wybug_author": "路人甲", "wybug_date": "2014-05-17 20:29", "wybug_open_date": "2014-07-01 20:30", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-01：\t细节向公众公开  简要描述：  详细说明：  与： WooYun: Anymacro 邮件系统SQL注入漏洞和任意文件（邮件）删除（无需登录）   重复乌云已经把它列入到通用型奖励厂商当中了。0x01 背景AnyMacro（安宁）成立于1999年，是国内领先的统一消息/移动门户/PushMail产品与应用解决方案提供商。主要客户涵盖国家部委、大型企业以及部分海外客户，客户分布于政府、军工、金融、电信、能源、教育等行业。 AnyMacro在技术创新和关键应用中一直处于行业领先地位，在全球首家提出并实现LAMP架构邮件/消息系统已成为事实的行业标准。AnyMacro 具有统一消息/移动门户/PushMail领域的全线技术与自主知识产权，还是多家国际Linux厂商的OEM邮件/消息产品提供商。0x02 漏洞分析：由于该邮件系统部分代码已经加密，并且暂无方法解密，通过黑盒加白盒测试，发现所有页面只要添加了权限验证模块，都会出现SQL注入漏洞（危害非常非常严重），SQL注入漏洞可获取邮件信息，以及邮件用户名和密码。 此SQL注入漏洞产生于COOKIE当中，其中只要ANY_EMAIL=xxxx’  即可报错注入。。。\n\n初步怀疑该问题存在于加密代码当中。。。。下面分析在其中一处代码当中的SQL注入在tosms.php中\n<?phprequire_once 'config/config.php';require_once 'include/template.php';require_once 'include/func.php';require_once 'include/right.php';require_once 'include/dbfunc.php';require_once 'include/sms_func.php';require_once 'include/func_login.php';include_once \"include/$AUTH_MODULE\";session_start();$F_sid = trim($_REQUEST['F_sid']);if(isset($_REQUEST['F_sms_send'])) { //当f_sms_send条件存在时，触发\t$email\t\t= $_COOKIE['ANY_EMAIL'];  //无过滤从cookie中获取\t$telstr \t= trim($_REQUEST['F_tel']);\t$tmp = explode(\":\",$telstr);\t$send_tel \t= $tmp[0];\t$send_pass \t= '';\t$sql = \"SELECT id,maildir FROM user WHERE id='\".$email.\"'\";//直接传入sql语句当中执行，造成sql注入漏洞\t$res = db_query($sql);\t$row = db_fetch($res);\tif(!empty($row['id'])) {\t\t$smsfile = $row['maildir'].'/sms.config';\t\tif(file_exists($smsfile)) {\t\t\t$fstr = @file($smsfile);\t\t\t$farr = explode(\",\",trim($fstr[0]));\t\t\t$tel_arr[$farr[0]] = $farr[2];\t\t\t$send_pass = $tel_arr[$send_tel];\t\t}\t}\t$recv_tel \t= trim($_REQUEST['F_phone']);\t$sms_msg\t= trim($_REQUEST['F_msg']);\n\n\n抓包丢sqlmap注入，即可注入出所有邮件用户名和密码。。。\n\n\n\n注入出用户名和密码，登录后台。。。\n\n   漏洞证明：  \n\n\n\n   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-05-18 13:27 厂商回复： 此产品为我公司G6版本，此程序为短信发送程序只在部分程序用到此内容。正在准备升级包联系用户升级事宜 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}