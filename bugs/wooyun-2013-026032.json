{"id": 9705, "wybug_id": "wooyun-2013-026032", "wybug_title": "易思espcms后台功能绕过[可直接利用后台sql注入]", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "l5ffy", "wybug_date": "2013-06-16 00:35", "wybug_open_date": "2013-09-14 00:36", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入", "设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-06-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-06-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-08-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-08-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-14：\t细节向公众公开  简要描述： 后台功能绕过，后台存在sql注入结合绕过漏洞，进行sql注入 详细说明：  本地测试使用默认的adminsoft为后台目录，使用类的构造函数验证用户的后台访问权限后台各功能都为模版类important，该类构造函数如下：\nfunction important() {\t$this->softbase(true);\t}\n该类为继承类，跟进父类，文件/public/class_connector.php中第14行\nfunction softbase($admin_purview = false) {\t\theader(\"Content-Type: text/html; charset=utf-8\");\t\t$this->dbmysql();\t\t$this->commandinc();\t\t$this->systemfile();\t\t$this->cachedb();\t\tif ($admin_purview) {\t\t\t$this->admin_purview();\t\t\t$this->sitelng = $this->getlng();\t\t\t$action = $this->fun->accept('action', 'R');\t\t\tif (in_array($action, $this->esp_powerlist) && !in_array('all', $this->esp_powerlist)) {\t\t\t\texit('Permissions errors');\t\t\t}\t\t}…………………………\n判断管理权限主要为代码$this->admin_purview();，跟进在该文件第330行如下：\nfunction admin_purview() {\t\tif ($this->fun->accept('archive', 'R') == 'filemanage' && $this->fun->accept('action', 'R') == 'batupfilesave') {\t\t\t$ecisp_admininfo = $this->fun->accept('ecisp_admininfo', 'G');\t\t\t$esp_powerlist = $this->fun->accept('esp_powerlist', 'G');\t\t\t$gettype = false;\t\t} else {\t\t\t$ecisp_admininfo = $this->fun->accept('ecisp_admininfo', 'C');\t\t\t$esp_powerlist = $this->fun->accept('esp_powerlist', 'C');\t\t\t$gettype = true;\t\t}\t\t$arr_purview = explode('|', $this->fun->eccode($ecisp_admininfo, 'DECODE', db_pscode));\t\t$this->esp_powerlist = explode('|', $this->fun->eccode($esp_powerlist, 'DECODE', db_pscode));\t\tlist($this->esp_adminuserid, $this->esp_username, $this->esp_password, $this->esp_useragent, $this->esp_powerid, $this->esp_inputclassid, $this->esp_softurl) = $arr_purview;\t\tif ($gettype) {\t\t\tif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl) {\t\t\t\t$condition = 0;\t\t\t} else {\t\t\t\t$condition = 1;\t\t\t}\t\t} else {\t\t\tif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_ClassURL) != $this->esp_softurl) {\t\t\t\t$condition = 0;\t\t\t} else {\t\t\t\t$condition = 1;\t\t\t}\t\t}\t\tif ($condition == 0) {\t\t\tif ($this->fun->accept('archive', 'R') != 'adminuser' && $this->fun->accept('action', 'R') != 'login') {\t\t\t\theader('location: index.php?archive=adminuser&action=login');\t\t\t\texit();\t\t\t}\t\t} else {\t\t\tif ($condition == 1 && $this->fun->accept('point', 'R') == '' && $this->fun->accept('archive', 'R') == '' && $this->fun->accept('action', 'R') == '') {\t\t\t\theader('location: index.php?archive=management&action=tab&loadfun=mangercenter&out=tabcenter');\t\t\t\texit();\t\t\t}\t\t}\t}\n跟上一个问题差不多，获取cookie里面的字段ecisp_admininfo，然后解密赋值，也就是说只要保证代码if (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl)不成立，则可以绕过逻辑验证，访问后台功能函数。admin_AGENT和admin_ClassURL又为预定义数据，\ndefine('admin_AGENT', $_SERVER['HTTP_USER_AGENT']);define('admin_ClassURL', 'http://' . $_SERVER['HTTP_HOST'] . substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/')));\n由此可以伪造对应的cookie字段ecisp_admininfo，我这里使用火狐浏览器，加密前：1|2|3|e0b858f1249c7bbe85c69dcf5eaac720|5|6|fae169abd4e73eb55567e2a202526274内置加密函数加密一下：ZLCTsWitnWeabWVqy2WTZ5_IbciYyGqXm2tsmMSbapaZmJtsYmLhad1p4suXy2eZa8OamWeZmGiak21sbWtnl5eVk2OYmmicaJpm添加这个cookie字段后可以绕过限制，访问任意函数了下面我演示一下通过此漏洞利用后台文件adminsoft/control/acmessagemain.php的sql注入   漏洞证明：  文件/adminsoft/control/acmessagemain.php 第52行到63行\n$limitkey = $this->fun->accept('limitkey', 'R');$limitkey = empty($limitkey) ? 'dmid' : $limitkey;$limitclass = $this->fun->accept('limitclass', 'R');$limitclass = empty($limitclass) ? 'DESC' : $limitclass;$db_table = db_prefix . 'document_message';if (!empty($countnum)) {\t$countnum = $this->db_numrows($db_table, $db_where);\texit($countnum);\t}$sql = 'SELECT * FROM ' . $db_table . $db_where . ' ORDER BY ' . $limitkey . ' ' . $limitclass . ' LIMIT ' . $MinPageid . ',' . $MaxPerPage;$rs = $this->db->query($sql);\n$limitkey直接通过$this->fun->accept('limitkey', 'R');获取未做处理，该函数默认进行gpc，htmlspecial过滤，由于此处不在引号内部，可直接忽略上述处理，我这里不登陆直接添加上述cookie字段后，打印一下sql语句吧，\n\n   修复方案：  先修复判断判断再修复sql注入   版权声明：转载请注明来源 l5ffy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：3  确认时间：2013-06-16 12:03 厂商回复： 感谢对漏洞的提供，我们将会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-06-16 11:05 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  ：）    \n     2013-06-16 15:09 |    \t\t少校 \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:5        | 别开枪，自己人！)\t\t \n  我也要挖啦 开始！    \n     2015-09-01 22:23 |    \t\tElliott \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        | 绝逼不当程序员)\t\t \n  每个程序  db_pscode 都不一样吧 ，你这dp_pscode怎么来？？    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 3, "Ranks": null}