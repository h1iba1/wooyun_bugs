{"id": 1761, "wybug_id": "wooyun-2014-062848", "wybug_title": "MetInfo设计缺陷导致删除整站等严重漏洞全版本通杀", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2014-05-30 10:00", "wybug_open_date": "2014-08-28 10:00", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-28：\t细节向公众公开  简要描述： MetInfo设计缺陷，可导致删除整站等严重漏洞，5.1及5.2通杀。 详细说明：  那官方最新版metinfo5.2测试！第一处：任意目录删除文件出在/admin/system/uploadfile.php\n<?php# MetInfo Enterprise Content Management System # Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved.require_once '../login/login_check.php';require_once 'mydir.class.php';$rurls='../system/uploadfile.php?anyid='.$anyid.'&cs='.$cs.'&lang='.$lang;if($action=='deletefolder'){   $filedir=\"../../\".$filename;   deldir($filedir,0);   metsave($rurls);}if($action=='delete'){\t$rurls.='&fileurl='.$fileurl.'&file_classnow='.$file_classnow.'&page='.$page;\tif($action_type==\"del\"){\t\t$allidlist=explode(',',$allid);\t\t$k=count($allidlist)-1;\t\tfor($i=0;$i<$k; $i++){\t\t\tif(strcasecmp(substr(trim($allidlist[$i]),0,13),'../../upload/')!=0)die('met1');\t\t\tif(substr_count(trim($allidlist[$i]),'../')!=2)die('met2');\t\t\tif(file_exists($allidlist[$i]))@unlink($allidlist[$i]);\t\t}\t\tmetsave($rurls);\t}else{\t\tif(strcasecmp(substr(trim($filename),0,13),'../../upload/')!=0)die('met1');\t\tif(substr_count(trim($filename),'../')!=2)die('met2');\t\tif(file_exists($filename)){\t\t\t@unlink($filename);\t\t\tmetsave($rurls);\t\t}else{\t\t\tmetsave($rurls,$lang_setfilenourl);\t\t}\t}\n当$action=='deletefolder'时，filename没有过滤，直接拼接到filedir然后deldir($filedir,0)，这里比删除文件更给力，可直接删除真个目录，甚至删除整站目录。虽然在后台才能删除，但是这里存在CSRF漏洞，没有任何防御CSRF的措施，而且是GET直接请求，可以给管理留言等，可以优势管理访问我们的链接，后果不堪设想。首先我们在网站根目录下新建一个目录test\n\n然后构造伪造请求，来删除此目录：\nhttp://localhost/metinfo/admin/system/uploadfile.php?filename=test&action=deletefolder\n\n\n如图所示，成功把根目录下的test删除，而且在过程中没有任何CSRF防御措施。这样的话恶意攻击者可以使用CSRF删除系统文件，删除整站，删除config等等，瞬间搞垮网站。同样的问题还有：任意添加管理员，修改上传文件类型等操作。   漏洞证明：  见详细说明   修复方案：  控制删除的目录。添加CSRF Token   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-06-04 09:35 厂商回复： CNVD确认所述情况（本地复现），需要认证前提，由CNVD转报给软件生产厂商，长沙米拓公司。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-30 10:08 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  擦，还有，mark    \n     2014-05-30 10:21 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  这个叼    \n     2014-05-30 10:48 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  哇靠    \n     2014-05-30 17:47 |    \t\tAzui \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:10        | 用一只黑色铅笔画一出舞台默剧。)\t\t \n  吊。    \n     2014-08-28 10:04 |    \t\tBrick713 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 擅长围观各种漏洞，我就看看，偷摸试试。)\t\t \n  时候到了    \n     2014-08-28 10:10 |    \t\tTG666 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:1        | 云霓之望，人应远虑网安天下，信念为先)\t\t \n  这个要赞一下    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}