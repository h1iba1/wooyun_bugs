{"id": 22523, "wybug_id": "wooyun-2015-0114708", "wybug_title": "一种可大规模定向钓鱼携程旅游网千万用户的攻击过程重放（附案例，非携程用户依然躺枪）", "wybug_corp": "携程旅行网", "wybug_author": "黑暗游侠", "wybug_date": "2015-05-18 06:25", "wybug_open_date": "2015-07-02 10:22", "wybug_type": "应用配置错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向公众公开  简要描述： 当人类终于变成同类 详细说明：  这两天在外面旅游又用起来携程订酒店，偶然看到这样一个功能\n\n可以给自己的邮箱发送一封自己的行程邮件，点开后默认的邮箱是自己账户绑定的邮箱，也可以自行修改为其他任意邮箱\n\n\n\n来看一下邮件的内容，\n\n如果我们能控制页面输出变量的话，那么可以引发一场定向的钓鱼攻击邮箱都是支持html标记的，那么抓包来看一下,变量中所能控制的\nPOST /Customer-API-Online/Ajax/AjaxMailJourney.aspx HTTP/1.1Host: my.ctrip.comProxy-Connection: keep-aliveContent-Length: 118Cache-Control: max-age=0Origin: http://my.ctrip.comIf-Modified-Since: Thu, 01 Jan 1970 00:00:00 GMTUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36Content-Type: application/x-www-form-urlencoded; charset=UTF-8Accept: */*Referer: http://my.ctrip.com/Customer-API-Online/MyJourney.aspxAccept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Cookie: *************************************************UserName=页面中输出的用户名，可控制&EmailTo=发往的邮箱目的地址&Consumer=&StartTime=&EndTime=&TargetCityName=&ItineraryType=-1&OrderStatusName=\n\nUserName=页面中输出的用户名，可控制&EmailTo=发往的邮箱目的地址\n要能实现攻击，首先的就是测试是否对长度有限制，如果限制了长度，那么攻击将可能变得很鸡肋甚至根本无法利用设置\nUserName=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n结果如图：\n\n并没有长度限制，而且因为框架超出问题，原来的行程单也无法正常显示，进一步提供了有利的条件既然不限制长度，那么就来测试自定义html标签的攻击了测试1：\nUserName=<img src=https://www.baidu.com/img/bdlogo.png />\n返回结果服务器500错误：\n\n携程的中间件风险控制的规则应该是匹配GET、POST（COOKIE没有进行测试）中的高危行为，比如and 1=1、</>等，然后定义到错误页面，如果同一IP连续多次访问该错误页面，那么就会在一段时间内屏蔽该IP地址测试2，urlencode 1次 ：\nUserName=%3Cimg%20src=https://www.baidu.com/img/bdlogo.png%20/%3E\n返回500，被防御规则丢弃测试3，urlencode 2次：\nUserName=%253Cimg%2520src=https://www.baidu.com/img/bdlogo.png%2520/%253E\n返回200，如图，成功绕过了风险控制匹配\n\n看一下邮件：\n\n百度君插入了之后就是对页面元素分析，如何插入一个最真实逼真的钓鱼环境举个例子，比如要把后面跟着的“先生/女士…………”移动到第一个框架外\nUserName=Wooyun html%253C/table%253E%253C/table%253E%253Ctable%253E%253Ctable%253E\n可以看到，第一个淡蓝色方框内已经排除了其他元素，剩下的可以自定义了\n\n由于洞主对前端设计、html这一块实在是一个渣渣尽力也只能伪造了以下不忍直视的结果\n\n将背景颜色设置为白色会好看点\n\n\n\n数据库里随便选了100个携程用户的邮箱，发送了邮件进行钓鱼测试那么问题来了，用户哪里来？是否记得有一个这个漏洞：http://wooyun.org/bugs/wooyun-2014-077356这个漏洞里面的问题，在报告之前很久就发现了，但是觉得不是安全问题很多站点都有该问题，以前只爬虫收集过一部分用户uid邮箱，一直躺在硬盘里，刚好拿出来用部分下午就有了结果，很快，这么点钱我就不退了~~毕竟我不知道你们的支付宝。。。\n\n\n\n只有2条支付过来的记录，不过如果大规模进行攻击的话，还是很可怕的。密码钓鱼也返回了1条\n\n然后另选100条其他邮箱数据，非携程用户在http://cli.im/生成二维码附上，内容为测试网站，做好IP统计竟然有这么多人扫了。。。。看来携程的知名度还是有的，福利诱惑一般人扛不住\n\n2种方式进行规模化攻击：1、直接导入邮箱变量进行fuzzing2、可以一次性群发（注意最开始我提到的），发一次即可，一次50条邮箱，发太多怕被服务器拒绝。==============================Conclusion 总结1、我写的这么渣的钓鱼页面都能中招，看来大部分网民的安全意识还是很薄弱，如果换成前端大神@疯狗 来精心伪造一页面元素，说不定我都中招了。2、安全不一定在于真正强的地方有多强。3、风控规则仍需完善，urlencode2次就绕过了。   漏洞证明：     修复方案：  Conclusion 总结1、我写的这么渣的钓鱼页面都能中招，看来大部分网民的安全意识还是很薄弱，如果换成前端大神@疯狗 来精心伪造一页面元素，说不定我都中招了。2、安全不一定在于真正强的地方有多强。3、风控规则仍需完善，urlencode2次就绕过了。   版权声明：转载请注明来源 黑暗游侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-05-18 10:21 厂商回复： 感谢您提交此漏洞相关信息。漏洞已经提交至开发人员处进行修补。再次感谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-18 09:33 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  诺亚方舟    \n     2015-05-18 12:03 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  有意思    \n     2015-05-28 22:18 |    \t\tQ1NG \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:16        | 临 兵 斗 者 皆 阵 列 前 行 !)\t\t \n  mark    \n     2015-06-07 15:42 |    \t\tBMa \t\t\t( 普通白帽子  |\t\t\t        Rank:1776 漏洞数:200        )\t\t \n  脑洞大开    \n     2015-06-09 03:04 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  奶洞大开！    \n     2015-06-11 14:45 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  携程这个新来的审核员太nb了，加我qq聊着聊着聊到股票，我给他分析了几只股票，然后竟然号突然掉了，显示被封，一查是好友举报，我那个7位qq就他一个好友，so，我简直感到不可思议，会有这种人。    \n     2015-06-11 15:09 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  携程换了一批人  这两天各种加人聊。。。    \n     2015-07-02 13:47 |    \t\tMark \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 渗透你的心)\t\t \n  脑洞大开     \n     2015-07-03 10:35 |    \t\t莱纳斯 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | 花式钓鱼，Xss learner)\t\t \n  给跪了。这思路和脑洞。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}