{"id": 50893, "wybug_id": "wooyun-2014-076463", "wybug_title": "B2Bbuilder 最新版任意文件包含", "wybug_corp": "B2Bbuilder", "wybug_author": "路人甲", "wybug_date": "2014-09-19 11:20", "wybug_open_date": "2014-12-18 11:22", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "文件包含漏洞", "文件包含漏洞利用技巧", "漏洞查找技巧", "文件包含", "文件包含漏洞利用", "本地文件包含利用", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-19：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-12-18：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 过滤不完全导致任意文件包含 详细说明：  \n先看过滤函数：function inject_check($sql){ \treturn preg_match(\"/(select|insert|delete|\\.\\.\\/|\\.\\/|union|into|load_file|outfile|\\'|%27|{|\\()/i\", $sql);// 进行过滤   }function magic(){\t\tif(!get_magic_quotes_gpc()&&isset($_POST))\t{\t\tforeach($_POST as $key=>$v)\t\t{\t\t\tif(!is_array($v))\t\t\t\t$_POST[$key]=addslashes($v);\t\t\telse\t\t\t{\t\t\t\tforeach($v as $skey=>$sv)\t\t\t\t{\t\t\t\t\t$_POST[$key][$skey]=addslashes($sv);\t\t\t\t}\t\t\t}\t\t}\t}\t\t//===========GET\tif(inject_check(implode('',$_GET)))\t{\t\tdie('Invalid URL !');\t}\t//===========POST\tif(isset($_POST))\t{\t\tforeach($_POST as $key=>$v)\t\t{\t\t\tif(!is_array($v))\t\t\t{\t\t\t\tif(strpos($v,'eval(')or(strpos($v,'$_POST[')))\t\t\t\t\tdie('Invalid POST');\t\t\t}\t\t}\t}}\n在这里，对POST的数据进行了转义。 而对get的数据只是做了判断。 其中只是判断了get请求中是否有../  ，在windows环境下，可以使用..\\来作为目录。\n在看b2bbuilder.php 文件中的代码：if(!empty($_GET['m'])){\t\t$_GET['s']=!empty($_GET['s'])?$_GET['s']:'index';\t$s=str_replace('/','',$_GET['s']);\t$m=$_GET['m'];\tif(file_exists($config['webroot'].'/module/'.$m.'/'.$s.'.php'))\t{\t\tif(file_exists($config['webroot'].'/config/module_'.$m.'_config.php'))\t\t{\t\t\t@include($config['webroot'].'/config/module_'.$m.'_config.php');\t\t\t$mcon='module_'.$m.'_config';\t\t\t@$config = array_merge($config,$$mcon);\t\t}\t\t@include('module/'.$m.'/lang/'.$config['language'].'.php');\t\tinclude('module/'.$m.'/'.$s.'.php');\t}\telseif(file_exists($m.'.html'))\t\tinclude($m.'.html');\telse\t\theader(\"Location: 404.php\");\n先看$config['webroot'].'/module/'.$m.'/'.$s.'.php'，  当m=.. 就会被重定向到网站根目录，由于没有过滤掉\\  这样利用s可以包含任意的php文件。利用%00截断功能，可以包含任意类型的文件。也可以通过include($m.'.html'); 这个来包含，其没有过滤..\\这种格式。\n\n   漏洞证明：  \n\n   修复方案：  过滤\\   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}