{"id": 87974, "wybug_id": "wooyun-2016-0188026", "wybug_title": "TodayMail邮件系统涉及缺陷可导致多个漏洞（任意邮件读取/SQL注入漏洞/命令执行/任意文件删除）                                      ", "wybug_corp": "广东时代互联科技有限公司", "wybug_author": "路人甲", "wybug_date": "2016-03-23 11:05", "wybug_open_date": "2016-06-21 12:00", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-26：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-21：\t细节向公众公开  简要描述： ps:已按照审核要求补充案例进行说明TodayMail邮件系统涉及缺陷可导致多个漏洞（任意邮件读取/N处SQL注入漏洞/命令执行/任意文件删除）无需登录，直接shellhttp://www.wooyun.org/bugs/wooyun-2014-063422通过此处获取了源代码（以前泄露） 详细说明：  http://**.**.**.**/bugs/wooyun-2014-063422通过此处获取了源代码（以前泄露）进入webmail\\main文件夹下所有代码均加载了\n<?php/*- * PROMailVIP webmail  *  * Copyright (c) 1999-2001 by PROMailVIP network system Inc. * All rights reserved. * Author: Sanry William <sanry@**.**.**.**> * * $Id: getpopmail.php,v 1.6 2003/01/16 03:23:50 sanry Exp $ * modify by keenx 2005.3.9 */header(\"Content-Type: text/html; charset=utf-8\");//$DEBUG = 1;//if($DEBUG) $timebegin = gettimeofday();include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";\n其中login_inc.php为核心权限验证文件\n<?php/*- * PROMailVIP webmail  * Copyright (c) 1999-2004 by PROMailVIP network system Inc. * All rights reserved. * Author: sanry <sanry@**.**.**.**> * $Id: login_inc.php,v 1.8 2004/07/02 03:09:52 sanry Exp $ * 所有文件已经移到子文件夹下，所以使用Location: ../login.php 2005-9-2 keenx */if(!defined(\"INCLUDE_LOGIN_OK\")) {\tdefined(\"INCLUDE_LOGIN_OK\");\tsession_start();\t$G_USERNAME = $_SESSION['G_USERNAME'];\t//echo $G_USERNAME;\t$G_DOMAIN = $_SESSION['G_DOMAIN'];\t$G_HOME = $_SESSION['G_HOME'];\t//$G_TIME = $_SESSION['G_TIME'];\t//$G_QUOTA = $_SESSION['G_QUOTA'];\t$G_NICKNAME = $_SESSION['G_NICKNAME'];\t$G_ID = $_SESSION['G_ID'];\t$G_LANG = $_SESSION['G_LANG'];\t$G_TEMP = $_SESSION['G_TEMP'];\tif ( !$G_USERNAME ){\t\techo \"<script language=\\\"javascript\\\">window.top.location.href='../login.php';</script>\";\t  //  header(\"Location: ../login.php\");\t\texit(); \t/*\tif ( !$G_USERNAME || !$G_DOMAIN || !$G_HOME || !$G_TIME|| !$G_QUOTA  ){\t     header(\"Location: login.php\");\t\texit();\t*/\t}} // End of INCLUDE_LOGIN_OK?>\n通过上面可知，$G_USERNAME 变量就是控制整个邮件登录过程的唯一因素，而$G_USERNAME的来源为session方式赋值，所以目前来看，无法绕过。但是通过对所有代码进行审计发现如下位置webmail/main/mailcurlapi.phpwebmail/main/sendstatusapi.php\n<?phpheader(\"Content-Type:  text/html;charset=utf-8\");include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";include_once \"../../core/send.class.inc.php\";set_time_limit(0);session_start();$G_USERNAME = $_SESSION['G_USERNAME'] = $_POST['G_USERNAME'] ? $_POST['G_USERNAME'] : 'monitor';$G_DOMAIN = $_SESSION['G_DOMAIN']   = $_POST['G_DOMAIN'] ? $_POST['G_DOMAIN'] : '**.**.**.**';$_SESSION['G_HOME']     = $_POST['G_HOME'] ? $_POST['G_HOME'] : '/tmdomains/m/**.**.**.**/monitor';$_SESSION['G_NICKNAME'] = $_POST['G_NICKNAME'] ? $_POST['G_NICKNAME'] : 'monitor';$G_ID = $_SESSION['G_ID']       = $_POST['G_ID'] ? $_POST['G_ID'] : '4458';$_SESSION['G_LANG']     = $_POST['G_LANG'] ? $_POST['G_LANG'] : 0;$_SESSION['G_TEMP']     = NULL;include_once \"../include/login_inc.php\";//登陆等安全检测$value \t = $_POST['sendto'];$subject = $_POST['subject'];$content = $_POST['content']; if(!$value){echo '没有邮箱';exit;}\n我们可以看到直接对session值进行了操作，以post方式进行赋值，在后续\ninclude_once \"../include/login_inc.php\";//登陆等安全检测\n又进行了权限验证。这是什么逻辑？ 这就导致直接绕过邮箱验证，直接可登陆邮箱，造成任意邮件读取。所以后台所有页面操作，均可以采用如下方式绕过赋值一、任意邮件读取  通过POST提交方式即可构造G_USERNAME   G_DOMAIN   G_HOME  G_NICKNAME   G_ID即可绕过登陆任意人邮箱二SQL注入漏洞（举10例分析）  1、webmail/tools/getpopmail.php \n<?php/*- * PROMailVIP webmail  *  * Copyright (c) 1999-2001 by PROMailVIP network system Inc. * All rights reserved. * Author: Sanry William <sanry@**.**.**.**> * * $Id: getpopmail.php,v 1.6 2003/01/16 03:23:50 sanry Exp $ * modify by keenx 2005.3.9 */header(\"Content-Type: text/html; charset=utf-8\");//$DEBUG = 1;//if($DEBUG) $timebegin = gettimeofday();include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";//get$get_Cmd = trim($_GET['Cmd']);$popid=trim($_GET['popid']);$EmailCore = new EmailCore($G_ID);if($get_Cmd=='Get'){\t$Total = $EmailCore->getPOPTotal();\tif($popid=='all')\t\t$POPList = $EmailCore->getPOPList(1);\telse $POPList=$EmailCore->getPOPlist(1,1,\" and popid=$popid\");\tif(!$POPList){\t\techo $LANG_POP_NOT_MAIL.'!<a href=\"../setting/setpopmail.php\" style=\"color:#0000FF\">'+$LANG_POP_CILCK_ADD+'</a>';\t}\npopid为注入点，2、webmail\\tools\\cardList.php\n<?phpheader(\"Content-Type: text/html; charset=utf-8\");$DEBUG = 1;include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";// 每页显示的行数 10$CFG_ADDR_NUMPERPAGE = 10; /////查询列表$key = mysql_real_escape_string($_REQUEST['key']);if ($key) $sql_plus = \" AND (name LIKE '%$key%' or cname LIKE '%$key%' or email LIKE '%$key%' or \".\t\"addr LIKE '%$key%' or job LIKE '%$key%' or tel LIKE '%$key%' or mobile LIKE '%$key%' or note LIKE '%$key%') \";else\t$sqlwhere = \"\";\t//////排序处理if($_REQUEST[sort_by]) $orderby = \"order by $_REQUEST[sort_by] asc\";if(!$orderby) $orderby = \"order by cardid desc\";$EmailCore = new EmailCore($G_ID);/////总列表\n$_REQUEST[sort_by] 注入，此处为order by 注入3、webmail\\tools\\cardCmd.php\n<?phpheader(\"Content-Type: text/html; charset=utf-8\");include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";$get_Cmd = $_REQUEST[cmd];$CardID = $_REQUEST[cardid];$EmailCore = new EmailCore($G_ID);if(!preg_match(\"/[0-9]/\",$_REQUEST[agid]))$_REQUEST[agid]='';if($get_Cmd == \"add\"){\t$CardInfo = array();\t$CardInfo['name'] = $_REQUEST[name];\t$CardInfo['cname'] = $_REQUEST[cname];\t$CardInfo['addr'] = $_REQUEST[addr];\t$CardInfo['job'] = $_REQUEST[job];\t$CardInfo['tel'] = $_REQUEST[tel];\t$CardInfo['PhoneNum'] = $_REQUEST[PhoneNum];\t$CardInfo['email'] = $_REQUEST[email];\t$CardInfo['ag_id'] = $_REQUEST[agid];\t$CardInfo['note'] = $_REQUEST[note];\t$res = $EmailCore->insertAddress($CardInfo);}\n跟踪insertAddress方法\nfunction insertAddress($addressInfo){\t\tforeach($addressInfo as $key=>$val) {\t\t\t$key = mysql_real_escape_string($key);\t\t\t$val = mysql_real_escape_string($val);\t\t\tif($key==\"ag_id\"){\t\t\t\tif($val!=\"\") $sql_plus .= \", $key=$val\";\t\t\t\telse $sql_plus .= \", $key=null\";\t\t\t}\t\t\telse\t$sql_plus .= \", $key='$val'\";\t\t}\t\t$sql=\"insert into address set ftm_id=\".$this->TMID.$sql_plus;\t\t$this->mysql->query($sql);\t\treturn true;\t}\n在这里的$this->TMID又是前面我们伪造session值的\nnew EmailCore($G_ID);\n$G_ID即为我们可控的值，又是注入三、任意文件删除webmail\\main\\doAction.php\ncase \"del\":\t\t$name=(isset($_POST['name']) and $_POST['name'])?$_POST['name']:\"\";\t\t$EmailCore->deleteAttach($name,$sendBasePath);\n跟踪方法deleteAttach\nfunction deleteAttach($filename,$sendBasePath='')\t{\t\tif(!$sendBasePath) $sendBasePath = $this->getTMBasePath().\"/sendfile/attach/\".session_id();\t\t$listattachfile = \"$sendBasePath/list_attach\";\t\t$listattachfileTEMP = \"$sendBasePath/list_attach_tmp\";\t\t($FD_LIST_ATTACH = fopen($listattachfile,\"r\")) || die(__FUNCTION__.\" \".__LINE__.\" \".\"Error open $listattachfile!\");\t\t($FD_LIST_ATTACH_TEMP = fopen($listattachfileTEMP,\"w\")) || die(__FUNCTION__.\" \".__LINE__.\" \".\"Error open $listattachfileTEMP!\");\t\twhile( $buff = fgets($FD_LIST_ATTACH,1024) ){\t\t\tlist($name,$size,) = preg_split(\"/\\t/\",$buff,3);\t\t\tif ($name!=$filename) fputs($FD_LIST_ATTACH_TEMP,$buff);\t\t}\t\tfclose($FD_LIST_ATTACH);\t\tfclose($FD_LIST_ATTACH_TEMP);\t\tif(file_exists(\"$sendBasePath/$filename\")) unlink(\"$sendBasePath/$filename\");\t\tunlink($listattachfile);\t\trename($listattachfileTEMP, $listattachfile);\t}\n四、命令执行\n行号           文件代码1 <?2 //by sanry 2005.07.01  v1.03 //last modify by frank 2005-07-11 11:524 5 include \"security.inc.php\";6 if(!$cmd)$cmd=\"ls\";7 ?>8 <html>9 <table>10  <tr>11 \t<td>12 \t  <a href=\"<?=$PHP_SELF?>?cmd=ifconfig\">��������</a>&nbsp;13 \t  <a href=\"<?=$PHP_SELF?>?cmd=dmesg\">��Ӳ��״̬</a>&nbsp;14 \t  <a href=\"<?=$PHP_SELF?>?cmd=netstat -n\">�������</a>&nbsp;15 \t  <a href=\"<?=$PHP_SELF?>?cmd=uptime\">CPU״̬</a>&nbsp;16 \t  <a href=\"<?=$PHP_SELF?>?cmd=ps aux\">�����б�</a>&nbsp;17 \t  <a href=\"<?=$PHP_SELF?>?cmd=lsof\">���ļ��б�</a>&nbsp;18 \t  <a href=\"<?=$PHP_SELF?>?cmd=df\">��������</a>&nbsp;19 \t  <a href=\"<?=$PHP_SELF?>?cmd=free\">�ڴ�ʹ��</a>&nbsp;20 \t  <a href=\"<?=$PHP_SELF?>?cmd=cat /var/log/boot.msg\">����ռ�</a>21    </td>22  </tr>23  <tr>24    <td>25 \t<form action=\"<?=$PHP_SELF?>\">\t\t26 \t\t<input type=submit value=\"����\">27 \t\t<input type=text name=\"cmd\" size=\"100\" value=\"<?=$cmd?>\">28 \t</form>29 \t</td>30  </tr>31 </table>32 <textarea rows=\"50\" style=\"width:90%\"><?system($cmd);?></textarea>33 </html>\n\ninclude \"security.inc.php\";\n\nrequire_once(\"../api/netaddr/ipcheck.inc.php\"); $ipcheck=new IPCheck(); $arrnew=array( \"0\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\") , \"1\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\") , \"2\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\") , \"3\"=> array(\"ip\"=>\"**.**.**.**\",  \"mask\"=>\"**.**.**.**\"), \"4\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), \"5\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), \"6\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), \"7\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), );  $ipcheck->setipfilters($arrnew); //echo \"REMOTE_ADDR: \".$REMOTE_ADDR.\"<br>\";\t//tesing,add by frank 2005-07-27 15:29 if(!$ipcheck->checkip($_SERVER[REMOTE_ADDR]) ){\techo \"authorization is permission error($_SERVER[REMOTE_ADDR])\";\texit; }?>\n五、任意文件读取mail\\webmail\\main\\mime.php\n<?php/*- * PROMailVIP webmail * * Copyright (c) 1999-2001 by PROMailVIP network system Inc. * All rights reserved. * Author: Sanry William <sanry@**.**.**.**> * * $Id: mime.php,v 1.8 2003/05/16 00:36:29 sanry Exp $ * Modify by keenx 2005-7-19 */ob_start(); header(\"Content-Type: text/html; charset=utf-8\");include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../include/mimeType.php\";//getforeach($_REQUEST as $key=>$val){\t$$key=trim($val);}$get_File = rawurldecode($_REQUEST['File']);$get_Cmd = $_REQUEST['Cmd'];$get_ID = $_REQUEST['id'];$EmailCore = new EmailCore($G_ID);$BodyInfo = $EmailCore->getBodyInfo();if ($get_Cmd==\"ShowByMD5\"){\tob_end_clean();\t@mysql_close($db);\t@mysql_close($db_remote);\t$filePath = $EmailCore->getTMBasePath().'/sendfile/attach/'.session_id().'/'.$get_File;\tif(is_file($filePath)){\t\techo file_get_contents($filePath);\t\texit;\t}\t$filePath = $EmailCore->getTMBasePath().'/bodyfile/'.$get_File;\tif(is_file($filePath)){\t\techo file_get_contents($filePath);\t\texit;\t}\texit;\n演示如下：默认访问http://**.**.**.**/webmail/tools/getpopmail.php?Cmd=Get&popid=1\n\n 即为跳转，所以我么通过如下方式先赋值session\n\n再次访问\n\nhttp://**.**.**.**/webmail/tools/getpopmail.php?Cmd=Get&popid=1 and 1=2 union select 1,2,3,4,user(),6,7,8\n\n\n\n案例\n\n通过写个爬虫把所有邮箱爬下来mx620.**.**.**.****.**.**.**mx603.**.**.**.****.**.**.**mx606.**.**.**.**mx622.**.**.**.**mx605.**.**.**.**mx623.**.**.**.****.**.**.**mx621.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**mx600.**.**.**.****.**.**.****.**.**.****.**.**.**mx601.**.**.**.****.**.**.****.**.**.**webmail.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**mx620.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**mx623hk.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**/**.**.**.****.**.**.****.**.**.****.**.**.**   漏洞证明：  http://**.**.**.**/bugs/wooyun-2014-063422通过此处获取了源代码（以前泄露）进入webmail\\main文件夹下所有代码均加载了\n<?php/*- * PROMailVIP webmail  *  * Copyright (c) 1999-2001 by PROMailVIP network system Inc. * All rights reserved. * Author: Sanry William <sanry@**.**.**.**> * * $Id: getpopmail.php,v 1.6 2003/01/16 03:23:50 sanry Exp $ * modify by keenx 2005.3.9 */header(\"Content-Type: text/html; charset=utf-8\");//$DEBUG = 1;//if($DEBUG) $timebegin = gettimeofday();include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";\n其中login_inc.php为核心权限验证文件\n<?php/*- * PROMailVIP webmail  * Copyright (c) 1999-2004 by PROMailVIP network system Inc. * All rights reserved. * Author: sanry <sanry@**.**.**.**> * $Id: login_inc.php,v 1.8 2004/07/02 03:09:52 sanry Exp $ * 所有文件已经移到子文件夹下，所以使用Location: ../login.php 2005-9-2 keenx */if(!defined(\"INCLUDE_LOGIN_OK\")) {\tdefined(\"INCLUDE_LOGIN_OK\");\tsession_start();\t$G_USERNAME = $_SESSION['G_USERNAME'];\t//echo $G_USERNAME;\t$G_DOMAIN = $_SESSION['G_DOMAIN'];\t$G_HOME = $_SESSION['G_HOME'];\t//$G_TIME = $_SESSION['G_TIME'];\t//$G_QUOTA = $_SESSION['G_QUOTA'];\t$G_NICKNAME = $_SESSION['G_NICKNAME'];\t$G_ID = $_SESSION['G_ID'];\t$G_LANG = $_SESSION['G_LANG'];\t$G_TEMP = $_SESSION['G_TEMP'];\tif ( !$G_USERNAME ){\t\techo \"<script language=\\\"javascript\\\">window.top.location.href='../login.php';</script>\";\t  //  header(\"Location: ../login.php\");\t\texit(); \t/*\tif ( !$G_USERNAME || !$G_DOMAIN || !$G_HOME || !$G_TIME|| !$G_QUOTA  ){\t     header(\"Location: login.php\");\t\texit();\t*/\t}} // End of INCLUDE_LOGIN_OK?>\n通过上面可知，$G_USERNAME 变量就是控制整个邮件登录过程的唯一因素，而$G_USERNAME的来源为session方式赋值，所以目前来看，无法绕过。但是通过对所有代码进行审计发现如下位置webmail/main/mailcurlapi.phpwebmail/main/sendstatusapi.php\n<?phpheader(\"Content-Type:  text/html;charset=utf-8\");include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";include_once \"../../core/send.class.inc.php\";set_time_limit(0);session_start();$G_USERNAME = $_SESSION['G_USERNAME'] = $_POST['G_USERNAME'] ? $_POST['G_USERNAME'] : 'monitor';$G_DOMAIN = $_SESSION['G_DOMAIN']   = $_POST['G_DOMAIN'] ? $_POST['G_DOMAIN'] : '**.**.**.**';$_SESSION['G_HOME']     = $_POST['G_HOME'] ? $_POST['G_HOME'] : '/tmdomains/m/**.**.**.**/monitor';$_SESSION['G_NICKNAME'] = $_POST['G_NICKNAME'] ? $_POST['G_NICKNAME'] : 'monitor';$G_ID = $_SESSION['G_ID']       = $_POST['G_ID'] ? $_POST['G_ID'] : '4458';$_SESSION['G_LANG']     = $_POST['G_LANG'] ? $_POST['G_LANG'] : 0;$_SESSION['G_TEMP']     = NULL;include_once \"../include/login_inc.php\";//登陆等安全检测$value \t = $_POST['sendto'];$subject = $_POST['subject'];$content = $_POST['content']; if(!$value){echo '没有邮箱';exit;}\n我们可以看到直接对session值进行了操作，以post方式进行赋值，在后续\ninclude_once \"../include/login_inc.php\";//登陆等安全检测\n又进行了权限验证。这是什么逻辑？ 这就导致直接绕过邮箱验证，直接可登陆邮箱，造成任意邮件读取。所以后台所有页面操作，均可以采用如下方式绕过赋值一、任意邮件读取  通过POST提交方式即可构造G_USERNAME   G_DOMAIN   G_HOME  G_NICKNAME   G_ID即可绕过登陆任意人邮箱二SQL注入漏洞（举10例分析）  1、webmail/tools/getpopmail.php \n<?php/*- * PROMailVIP webmail  *  * Copyright (c) 1999-2001 by PROMailVIP network system Inc. * All rights reserved. * Author: Sanry William <sanry@**.**.**.**> * * $Id: getpopmail.php,v 1.6 2003/01/16 03:23:50 sanry Exp $ * modify by keenx 2005.3.9 */header(\"Content-Type: text/html; charset=utf-8\");//$DEBUG = 1;//if($DEBUG) $timebegin = gettimeofday();include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";//get$get_Cmd = trim($_GET['Cmd']);$popid=trim($_GET['popid']);$EmailCore = new EmailCore($G_ID);if($get_Cmd=='Get'){\t$Total = $EmailCore->getPOPTotal();\tif($popid=='all')\t\t$POPList = $EmailCore->getPOPList(1);\telse $POPList=$EmailCore->getPOPlist(1,1,\" and popid=$popid\");\tif(!$POPList){\t\techo $LANG_POP_NOT_MAIL.'!<a href=\"../setting/setpopmail.php\" style=\"color:#0000FF\">'+$LANG_POP_CILCK_ADD+'</a>';\t}\npopid为注入点，2、webmail\\tools\\cardList.php\n<?phpheader(\"Content-Type: text/html; charset=utf-8\");$DEBUG = 1;include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";// 每页显示的行数 10$CFG_ADDR_NUMPERPAGE = 10; /////查询列表$key = mysql_real_escape_string($_REQUEST['key']);if ($key) $sql_plus = \" AND (name LIKE '%$key%' or cname LIKE '%$key%' or email LIKE '%$key%' or \".\t\"addr LIKE '%$key%' or job LIKE '%$key%' or tel LIKE '%$key%' or mobile LIKE '%$key%' or note LIKE '%$key%') \";else\t$sqlwhere = \"\";\t//////排序处理if($_REQUEST[sort_by]) $orderby = \"order by $_REQUEST[sort_by] asc\";if(!$orderby) $orderby = \"order by cardid desc\";$EmailCore = new EmailCore($G_ID);/////总列表\n$_REQUEST[sort_by] 注入，此处为order by 注入3、webmail\\tools\\cardCmd.php\n<?phpheader(\"Content-Type: text/html; charset=utf-8\");include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";$get_Cmd = $_REQUEST[cmd];$CardID = $_REQUEST[cardid];$EmailCore = new EmailCore($G_ID);if(!preg_match(\"/[0-9]/\",$_REQUEST[agid]))$_REQUEST[agid]='';if($get_Cmd == \"add\"){\t$CardInfo = array();\t$CardInfo['name'] = $_REQUEST[name];\t$CardInfo['cname'] = $_REQUEST[cname];\t$CardInfo['addr'] = $_REQUEST[addr];\t$CardInfo['job'] = $_REQUEST[job];\t$CardInfo['tel'] = $_REQUEST[tel];\t$CardInfo['PhoneNum'] = $_REQUEST[PhoneNum];\t$CardInfo['email'] = $_REQUEST[email];\t$CardInfo['ag_id'] = $_REQUEST[agid];\t$CardInfo['note'] = $_REQUEST[note];\t$res = $EmailCore->insertAddress($CardInfo);}\n跟踪insertAddress方法\nfunction insertAddress($addressInfo){\t\tforeach($addressInfo as $key=>$val) {\t\t\t$key = mysql_real_escape_string($key);\t\t\t$val = mysql_real_escape_string($val);\t\t\tif($key==\"ag_id\"){\t\t\t\tif($val!=\"\") $sql_plus .= \", $key=$val\";\t\t\t\telse $sql_plus .= \", $key=null\";\t\t\t}\t\t\telse\t$sql_plus .= \", $key='$val'\";\t\t}\t\t$sql=\"insert into address set ftm_id=\".$this->TMID.$sql_plus;\t\t$this->mysql->query($sql);\t\treturn true;\t}\n在这里的$this->TMID又是前面我们伪造session值的\nnew EmailCore($G_ID);\n$G_ID即为我们可控的值，又是注入三、任意文件删除webmail\\main\\doAction.php\ncase \"del\":\t\t$name=(isset($_POST['name']) and $_POST['name'])?$_POST['name']:\"\";\t\t$EmailCore->deleteAttach($name,$sendBasePath);\n跟踪方法deleteAttach\nfunction deleteAttach($filename,$sendBasePath='')\t{\t\tif(!$sendBasePath) $sendBasePath = $this->getTMBasePath().\"/sendfile/attach/\".session_id();\t\t$listattachfile = \"$sendBasePath/list_attach\";\t\t$listattachfileTEMP = \"$sendBasePath/list_attach_tmp\";\t\t($FD_LIST_ATTACH = fopen($listattachfile,\"r\")) || die(__FUNCTION__.\" \".__LINE__.\" \".\"Error open $listattachfile!\");\t\t($FD_LIST_ATTACH_TEMP = fopen($listattachfileTEMP,\"w\")) || die(__FUNCTION__.\" \".__LINE__.\" \".\"Error open $listattachfileTEMP!\");\t\twhile( $buff = fgets($FD_LIST_ATTACH,1024) ){\t\t\tlist($name,$size,) = preg_split(\"/\\t/\",$buff,3);\t\t\tif ($name!=$filename) fputs($FD_LIST_ATTACH_TEMP,$buff);\t\t}\t\tfclose($FD_LIST_ATTACH);\t\tfclose($FD_LIST_ATTACH_TEMP);\t\tif(file_exists(\"$sendBasePath/$filename\")) unlink(\"$sendBasePath/$filename\");\t\tunlink($listattachfile);\t\trename($listattachfileTEMP, $listattachfile);\t}\n四、命令执行\n行号           文件代码1 <?2 //by sanry 2005.07.01  v1.03 //last modify by frank 2005-07-11 11:524 5 include \"security.inc.php\";6 if(!$cmd)$cmd=\"ls\";7 ?>8 <html>9 <table>10  <tr>11 \t<td>12 \t  <a href=\"<?=$PHP_SELF?>?cmd=ifconfig\">��������</a>&nbsp;13 \t  <a href=\"<?=$PHP_SELF?>?cmd=dmesg\">��Ӳ��״̬</a>&nbsp;14 \t  <a href=\"<?=$PHP_SELF?>?cmd=netstat -n\">�������</a>&nbsp;15 \t  <a href=\"<?=$PHP_SELF?>?cmd=uptime\">CPU״̬</a>&nbsp;16 \t  <a href=\"<?=$PHP_SELF?>?cmd=ps aux\">�����б�</a>&nbsp;17 \t  <a href=\"<?=$PHP_SELF?>?cmd=lsof\">���ļ��б�</a>&nbsp;18 \t  <a href=\"<?=$PHP_SELF?>?cmd=df\">��������</a>&nbsp;19 \t  <a href=\"<?=$PHP_SELF?>?cmd=free\">�ڴ�ʹ��</a>&nbsp;20 \t  <a href=\"<?=$PHP_SELF?>?cmd=cat /var/log/boot.msg\">����ռ�</a>21    </td>22  </tr>23  <tr>24    <td>25 \t<form action=\"<?=$PHP_SELF?>\">\t\t26 \t\t<input type=submit value=\"����\">27 \t\t<input type=text name=\"cmd\" size=\"100\" value=\"<?=$cmd?>\">28 \t</form>29 \t</td>30  </tr>31 </table>32 <textarea rows=\"50\" style=\"width:90%\"><?system($cmd);?></textarea>33 </html>\n\ninclude \"security.inc.php\";\n\nrequire_once(\"../api/netaddr/ipcheck.inc.php\"); $ipcheck=new IPCheck(); $arrnew=array( \"0\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\") , \"1\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\") , \"2\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\") , \"3\"=> array(\"ip\"=>\"**.**.**.**\",  \"mask\"=>\"**.**.**.**\"), \"4\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), \"5\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), \"6\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), \"7\"=> array(\"ip\"=>\"**.**.**.**\",\"mask\"=>\"**.**.**.**\"), );  $ipcheck->setipfilters($arrnew); //echo \"REMOTE_ADDR: \".$REMOTE_ADDR.\"<br>\";\t//tesing,add by frank 2005-07-27 15:29 if(!$ipcheck->checkip($_SERVER[REMOTE_ADDR]) ){\techo \"authorization is permission error($_SERVER[REMOTE_ADDR])\";\texit; }?>\n五、任意文件读取mail\\webmail\\main\\mime.php\n<?php/*- * PROMailVIP webmail * * Copyright (c) 1999-2001 by PROMailVIP network system Inc. * All rights reserved. * Author: Sanry William <sanry@**.**.**.**> * * $Id: mime.php,v 1.8 2003/05/16 00:36:29 sanry Exp $ * Modify by keenx 2005-7-19 */ob_start(); header(\"Content-Type: text/html; charset=utf-8\");include_once \"../include/login_inc.php\";include_once \"../config/config_inc.php\";include_once \"../config/dbremote.inc.php\";include_once \"../../core/emailcore.class.inc.php\";include_once \"../../core/emailutil.inc.php\";include_once \"../language/utf8_inc.php\";include_once \"../include/mimeType.php\";//getforeach($_REQUEST as $key=>$val){\t$$key=trim($val);}$get_File = rawurldecode($_REQUEST['File']);$get_Cmd = $_REQUEST['Cmd'];$get_ID = $_REQUEST['id'];$EmailCore = new EmailCore($G_ID);$BodyInfo = $EmailCore->getBodyInfo();if ($get_Cmd==\"ShowByMD5\"){\tob_end_clean();\t@mysql_close($db);\t@mysql_close($db_remote);\t$filePath = $EmailCore->getTMBasePath().'/sendfile/attach/'.session_id().'/'.$get_File;\tif(is_file($filePath)){\t\techo file_get_contents($filePath);\t\texit;\t}\t$filePath = $EmailCore->getTMBasePath().'/bodyfile/'.$get_File;\tif(is_file($filePath)){\t\techo file_get_contents($filePath);\t\texit;\t}\texit;\n演示如下：默认访问http://**.**.**.**/webmail/tools/getpopmail.php?Cmd=Get&popid=1\n\n 即为跳转，所以我么通过如下方式先赋值session\n\n再次访问\n\nhttp://**.**.**.**/webmail/tools/getpopmail.php?Cmd=Get&popid=1 and 1=2 union select 1,2,3,4,user(),6,7,8\n\n\n\n案例\n\n通过写个爬虫把所有邮箱爬下来mx620.**.**.**.****.**.**.**mx603.**.**.**.****.**.**.**mx606.**.**.**.**mx622.**.**.**.**mx605.**.**.**.**mx623.**.**.**.****.**.**.**mx621.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**mx600.**.**.**.****.**.**.****.**.**.****.**.**.**mx601.**.**.**.****.**.**.****.**.**.**webmail.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**mx620.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**mx623hk.**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**/**.**.**.****.**.**.****.**.**.****.**.**.**   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2016-03-23 11:53 厂商回复： 谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-23 11:07 |    \t\tAasron \t\t\t( 普通白帽子  |\t\t\t        Rank:891 漏洞数:162        | raw_input(\"你知道我要输入什么？\"))\t\t \n  哎，我的洞啊    \n     2016-03-23 11:16 |    \t\t玉林嘎  \t\t\t( 普通白帽子  |\t\t\t        Rank:941 漏洞数:108        )\t\t \n  我擦.............    \n     2016-03-23 11:19 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:307 漏洞数:70        | baozisec)\t\t \n  你是把验证文件删了吧    \n     2016-03-23 11:26 |    \t\tkomas \t\t\t( 普通白帽子  |\t\t\t        Rank:107 漏洞数:25        )\t\t \n  关注    \n     2016-03-29 08:53 |    \t\t大漠長河 \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:10        | ̷̸̨̀͒̏̃ͦ̈́̾( 天龙源景区枫叶正...)\t\t \n  下载个看看  三个美刀威武    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}