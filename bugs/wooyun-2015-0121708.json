{"id": 2113, "wybug_id": "wooyun-2015-0121708", "wybug_title": "ThinkPHP设计缺陷导致逻辑漏洞造成密码找回绕过等问题", "wybug_corp": "ThinkPHP", "wybug_author": "Ricter", "wybug_date": "2015-06-20 10:06", "wybug_open_date": "2015-09-23 10:09", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-25：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-23：\t细节向公众公开  简要描述： 在不正确使用 ThinkPHP 时，可能会造成参数处理流程导致的逻辑漏洞。 详细说明：  ThinkPHP 处理传入的参数的时候，如果直接带入一个数组，接着数组带入 SQL 语句，会产生之前 phithon 大牛爆的 0day： WooYun: ThinkPHP框架架构上存在SQL注入 利用方式很简单：\ndata[0]=exp&data[1]=SQLI\n 然而，thinkphp 支持的不仅仅是 exp，像 like、in，都会支持。也就是说，我们可以在很多地方精心构造一个参数，导致造成逻辑漏洞。比如找回密码、权限验证等。   我们传入：\ndata[0]=like&data[1]=x%25\n这样就会编译成如下 mysql 语句：\nselect xx from xx where data like 'x%'\n举个例子：找回密码的地方，总会有一个 token，这个token如果储存在数据库，又从 url 接受的话，就会有如下情况。假如 token 为 202cb962ac59075b964b07152d234b70，找回密码的 url 为：\nhttp://localhost/reset?token=202cb962ac59075b964b07152d234b70\n 那么我们传入：\nhttp://localhost/reset?token[0]=like&token[1]=2%25\n 不用知道全部的 token 即可重置管理员的密码，因为 2% 在 mysql 中匹配正好会匹配到 202cb962ac59075b964b07152d234b70。   比如在 ThinkOX 登录的地方：POST 内容：\nusername[0]=like&username[1]=tes%25&password=bb\n执行的 SQL 语句为：\n\nPOST 内容：\nusername[0]=in&username[1][0]=test&username[1][1]=test2&password=bb\n执行的 SQL 语句为：\n\n   漏洞证明：  手头没有源码可以测试，但是有一个线上业务，就此测试一下。1. https://i.hostker.com/member/forgot_password 发送找回密码邮件：\n\n2.猜测收到的 token，成功发送密码到邮箱(实际上我没有猜测，因为收到的token开头为 if，所以我直接用 if%来访问)https://i.hostker.com/member/reset_password?session[0]=like&session[1]=if%25\n\n这个案例实际上不算利用很成功的案例，因为密码不是在线重设的而是发送到自己的邮箱。<del>给 Hostker 的安全赞一个</del>。     修复方案：  在利用 ThinkPHP 写东西时，最好避免直接讲传入的参数带入 SQL 语句。因为构造数组的话很容易出问题。   版权声明：转载请注明来源 Ricter@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-09-23 10:09 厂商回复：  漏洞Rank：8  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-20 10:11 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  前排！    \n     2015-06-20 10:11 |    \t\tRicter \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:15        | 渣渣一个)\t\t \n  有个图片传错了_(:з」∠)_嘛倒是不影响..    \n     2015-06-20 10:31 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  thinkphp的新闻    \n     2015-06-20 14:34 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  thinkphp的新闻    \n     2015-06-22 11:48 |    \t\tThinkPHP(乌云厂商)\t\t \n  ThinkPHP的I函数已经统一解决了此类问题的     \n     2015-09-23 13:17 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  。。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}