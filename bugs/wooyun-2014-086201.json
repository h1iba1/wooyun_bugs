{"id": 42292, "wybug_id": "wooyun-2014-086201", "wybug_title": "KPPW最新版SQL注入漏洞二", "wybug_corp": "keke.com", "wybug_author": "xfkxfk", "wybug_date": "2014-12-09 00:34", "wybug_open_date": "2015-03-09 00:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-09：\t细节向公众公开  简要描述： KPPW最新版SQL注入漏洞二 详细说明：  KPPW最新版SQL注入漏洞二文件/control/user/account_auth.php\n$arrAllowAuth = array('realname','enterprise','bank','mobile','email');if ($code&&in_array($code,$arrAllowAuth)) {\t$code or $code = $keys ['0']; \t$code or kekezu::show_msg ( $_lang ['param_error'], \"index.php?do=auth\", 3, '', 'warning' );\t$auth_class = \"keke_auth_\" . $code . \"_class\";\t$objAuth = new $auth_class ( $code ); \t$auth_item = $arrAllAuthItems [$code]; \t$auth_dir = $auth_item ['auth_dir']; \t$arrAuthInfo = $objAuth->get_user_auth_info ( $gUid, 0, $intBankAid ); \trequire S_ROOT . \"/auth/$code/control/index.php\";\trequire keke_tpl_class::template ( 'auth/' . $code . '/tpl/' . $_K ['template'] . '/'.$step );\tdie;} else {\t$real_pass = keke_auth_fac_class::auth_check ( 'enterprise', $gUid ) or $real_pass = keke_auth_fac_class::auth_check ( \"realname\", $gUid );\t$arrHasAuthItem = keke_auth_fac_class::get_auth ( $gUserInfo );\t$arrUserAuthInfo = $arrHasAuthItem ['info'];}\n仔细看看这里的：\n$arrAuthInfo = $objAuth->get_user_auth_info ( $gUid, 0, $intBankAid );\n这里的变量$intBankAid进入了函数get_user_auth_info函数跟进函数get_user_auth_info文件/lib/sys/keke_auth_base_class.php：\npublic function get_user_auth_info($uid,$is_username=0,$show_id=''){\t\t$sql=\"select * from \".TABLEPRE.$this->_auth_table_name;\t\tif($uid){\t\t\t$is_username=='0' and $sql.=\" where uid = '$uid' \" or $sql.=\" where username = '$uid' \";\t\t\t$show_id and $sql.=\" and \".$this->_primary_key.\"=\".$show_id;\t\t\t$sql .=\" order by $this->_primary_key desc\";\t\t\t$data = db_factory::query($sql);\t\t\tif(sizeof($data)==1){\t\t\t\treturn $data[0];\t\t\t}else{\t\t\t\treturn $data;\t\t\t}\t\t}else{\t\t\treturn array();\t\t}\t}\n接收到的变量$intBankAid——$show_id，然后$show_id进入$sql整个过程中变量$intBankAid未过滤，最后进入$sql进入数据库，导致sql注入漏洞   漏洞证明：  盲注证明：\nhttp://localhost/KPPW2520141118UTF-8/index.php?do=user&view=account&op=auth&code=bank&step=step2&intBankAid=147 and 1=1\n\n\n\nhttp://localhost/KPPW2520141118UTF-8/index.php?do=user&view=account&op=auth&code=bank&step=step2&intBankAid=147 and 1=2\n\n\n数据库执行记录：\n\n   修复方案：  \nget_user_auth_info函数：$show_id and $sql.=\" and \".$this->_primary_key.\"='\".$show_id.\"'\";\n   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-12-10 10:02 厂商回复： 漏洞已修复                      -QK 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}