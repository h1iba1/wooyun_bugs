{"id": 2815, "wybug_id": "wooyun-2014-058479", "wybug_title": "最土团购注入一枚可直接提升自己为管理 &amp; 无限刷钱。", "wybug_corp": "zuitu.com", "wybug_author": "′雨。", "wybug_date": "2014-04-25 21:43", "wybug_open_date": "2014-07-23 18:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向公众公开  简要描述： 最土团购在我印象中 用得还是有把。  至少我自己都遇到过几次了。 前段时间挖的了。  本来想留着自己玩的。 可是留着留着也没用过, 忘记了自己早已不搞站。 还是发出来把。注入可提升自己为管理 & 给自己刷100万可好?无视GPC。  详细说明：  在order/chinabank/notify.php中\n$key = $INI['chinabank']['sec'];$v_oid     = trim($_POST['v_oid']);  // 商户发送的v_oid定单编号   $v_pmode   = trim($_POST['v_pmode']); // 支付方式（字符串）   $v_pstatus = trim($_POST['v_pstatus']);   //支付状态 ：20 成功,30 失败$v_pstring = trim($_POST['v_pstring']);   // 支付结果信息$v_amount  = trim($_POST['v_amount']);     // 订单实际支付金额$v_moneytype = trim($_POST['v_moneytype']); //订单实际支付币种    $remark1   = trim($_POST['remark1' ]);      //备注字段1$remark2   = trim($_POST['remark2' ]);     //备注字段2$v_md5str  = trim($_POST['v_md5str' ]);   //拼凑后的MD5校验值  /* 重新计算md5的值 */$text = \"{$v_oid}{$v_pstatus}{$v_amount}{$v_moneytype}{$key}\";$md5string = strtoupper(md5($text));/* 判断返回信息，如果支付成功，并且支付结果可信，则做进一步的处理 */if ($v_md5str == $md5string) {\tlist($_, $order_id, $city_id, $_) = explode('-', $v_oid, 4);\tif($v_pstatus==\"20\") {\t\t/* charge */\t\tif ( $_ == 'charge' ) {\t\t\t@list($_, $user_id, $create_time, $_) = explode('-', $v_oid, 4);\t\t\t\t\t\t\t\tZFlow::CreateFromCharge($v_amount, $user_id, $create_time, 'chinabank');\t\t\tdie('ok');\t\t}\nkey是空的 不用管他。 只是一点点的验证。 MD5相等可好, 然后把v_oid用来切割。然后带入CreateFromCharge\nstatic public function CreateFromCharge($money,$user_id,$time,$service='alipay',$trade_no=''){\t\tglobal $option_service;\t\tif (!$money || !$user_id || !$time) return 0;\t\t\t$pay_id = \"charge-{$user_id}-{$time}\";\t\t$pay = Table::Fetch('pay', $pay_id);\t\tif ( $pay ) return 0;\t\t\t$order_id = ZOrder::CreateFromCharge($money,$user_id,$time,$service);\t\tif (!$order_id) return 0;\t\t//insert pay record\t\t$pay = array(\t\t\t'id' => $pay_id,\t\t\t'vid' => $trade_no,\t\t\t'order_id' => $order_id,\t\t\t'bank' => $option_service[$service],\t\t\t'currency' => 'CNY',\t\t\t'money' => $money,\t\t\t'service' => $service,\t\t\t'create_time' => $time,\t\t);\t\tDB::Insert('pay', $pay);\t\tZCredit::Charge($user_id, $money);\t\t//end//\t\t//update user money;\t\t\t$user = Table::Fetch('user', $user_id);\t\t\tTable::UpdateCache('user', $user_id, array(\t\t\t\t\t'money' => array( \"money + {$money}\" ),\t\t\t\t\t));\t\t$u = array(\t\t\t\t'user_id' => $user_id,\t\t\t\t'admin_id' => 0,\t\t\t\t'money' => $money,\t\t\t\t'direction' => 'income',\t\t\t\t'action' => 'charge',\t\t\t\t'detail_id' => $pay_id,\t\t\t\t'create_time' => $time,\t\t\t\t);\t\treturn DB::Insert('flow', $u);\t}\n这里有一个insert 语句 和一个update语句。 insert 里面的都被单引号了。 而且如果我们提交单引号的话还会被转义。\nTable::UpdateCache('user', $user_id, array(\t\t\t\t\t'money' => array( \"money + {$money}\" ),\t\t\t\t\t));\n看这个update $money是没有单引号的。然后带入查询 首先构造一下语句。由于 管理和用户都是在user表里 是通过manager这个column 用来判断是否为管理员。 我们给我们自己的用户的manager update成y 即可成为管理员。UPDATE `user` SET `money`=money + asd WHERE `id`='88'执行的语句如此。 我们构造一下语句。   漏洞证明：  \n\n\n\n成功提升。百度随便找了个站测试。\n\n无限刷钱\n\n成功提升。   修复方案：  过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-23 18:34 厂商回复：  最新状态： 2014-05-19：此产品已不再维护，原站已经下线，感谢白帽子提交漏洞，中国因你们更精彩  ", "replys": "漏洞评价：\n评论\n     2014-04-25 21:44 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  最土团购..这名..真的 土爆了..    \n     2014-04-25 21:46 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  尖刀的小伙伴~~    \n     2014-04-25 21:46 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  你以为乌云上真有那么多白帽子提交漏洞？太天真了，全是我小号，不信我换一个号提交漏洞！    \n     2014-04-25 21:47 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @疯子 你妹！（保持队形！）    \n     2014-04-25 21:50 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  @鬼魅羊羔 你妹！！（保持队形！）    \n     2014-04-25 21:52 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @zcy 你妹！！！（保持队型）    \n     2014-04-25 22:03 |    \t\tLonely \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:27        | 人生如梦,始终都游不过当局者迷的悲哀。)\t\t \n  @Hero 你妹！！！（保持队型）    \n     2014-04-25 22:19 |    \t\t楼下小黑 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 高智商白痴)\t\t \n  @Lonely  你妹！！！（保持队型）    \n     2014-04-25 22:21 |    \t\t漫步云端 \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:33        | I'm Ramble!)\t\t \n  @楼下小黑 你妹！！！（保持队型）    \n     2014-04-25 22:25 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  。。破坏队形。    \n     2014-04-25 22:41 |    \t\tBird \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:25        | Stay hungry. Stay foolish.)\t\t \n  @′  雨。 你妹！！！（恢复队形）    \n     2014-04-25 22:53 |    \t\t小威 \t\t\t( 普通白帽子  |\t\t\t        Rank:492 漏洞数:76        | 活到老，学到老!)\t\t \n  @Bird 你妹！！！（专业维持队形）    \n     2014-04-25 22:55 |    \t\t土豪 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:6        | 我是土豪却没有5WB)\t\t \n  打乱队形    \n     2014-04-25 22:57 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @土豪 你妹！！！（恢复队形）    \n     2014-04-25 22:57 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  再打乱队形    \n     2014-04-25 23:06 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @nextdoor 你妹！！！(wooyun自动恢复)    \n     2014-04-25 23:33 |    \t\tSummer \t\t\t( 普通白帽子  |\t\t\t        Rank:433 漏洞数:98        | 尽自己最大的努力去完成梦想)\t\t \n  忽略    \n     2014-04-26 00:12 |    \t\t好人 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:6        | 多少人曾爱慕你年轻的容颜)\t\t \n  @Summer  你妹！！！(wooyun自动恢复)    \n     2014-04-26 00:13 |    \t\t熊猫 \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:33        | panda)\t\t \n  网站都打不开    \n     2014-04-26 00:26 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @熊猫 你妹！！！（已经自动fix bug）    \n     2014-04-26 01:42 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  官网都没了 呵呵呵 我的shell啊 唉...     \n     2014-04-26 04:46 |    \t\tCougar \t\t\t( 实习白帽子  |\t\t\t        Rank:69 漏洞数:19        | 不容易。)\t\t \n  牛阿    \n     2014-04-26 08:49 |    \t\tJiuShao \t\t\t( 普通白帽子  |\t\t\t        Rank:405 漏洞数:94        | ╮(╯▽╰)╭锄禾日当午)\t\t \n  叼，坐等忽略。    \n     2014-04-26 10:10 |    \t\t小博博 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:9        | .)\t\t \n  @大神 你妹 （专业恢复队形500年）    \n     2014-04-26 10:10 |    \t\t马云 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        | 啪啪啪啪啪啪啪啪)\t\t \n  @寂寞的瘦子 你妹！！！    \n     2014-04-26 12:22 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  @马云 你妹！！！     \n     2014-04-26 13:03 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  @Master 你妹！！！    \n     2014-04-27 11:47 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  @′  雨。 你妹！！！    \n     2014-04-30 19:47 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  看来又要自动忽略了   5天时间是不是太短了？  @疯狗    \n     2014-04-30 19:54 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 一周时间就给厂商进行个漏洞确认操作，真心话不短啊    \n     2014-04-30 19:57 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗  额5天。我感觉是不是有些厂商都没看到邮件的  我猜测的是不是在自动忽略过后乌云会给厂商再发邮件。        有几次都是漏洞自动忽略没多久厂商就来回复了。  为什么不在自动忽略前不久来自动发个邮件呢。    \n     2014-04-30 19:58 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 一般情况下厂商看到了，但是处理问题是最优先的事情，然后乌云的确认就被遗忘了    \n     2014-04-30 19:59 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 这块我看看在加一次提醒吧，比如5天即将公开的时候，第四天在发封邮件这种    \n     2014-04-30 20:05 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗   嗯   这再好不过了，    \n     2014-04-30 21:50 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n    唉  又自动被忽略了  狗哥来补点分撒  @疯狗    \n     2014-05-19 17:12 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 最土已经停止维护了啊。。    \n     2014-05-19 17:18 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @疯狗 中国因为你们更精彩    \n     2014-05-19 17:34 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @疯狗   这蛋疼，，。。  狗哥这样得就没奖金了吧？    \n     2014-05-19 18:26 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @′  雨。 如果还有很多用户的话还是会给奖励，另外你这个有技术亮点啊，淫荡的提权，所以还是有奖金的    \n     2014-05-20 12:41 |    \t\t熊猫 \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:33        | panda)\t\t \n  人家。。都不开网站了    \n     2014-06-19 23:27 |    \t\tWalle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:5        | ...   位卑、未敢忘忧国！   ...)\t\t \n  小菜还是不会利用啊、哪位大神教教啊、、    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}