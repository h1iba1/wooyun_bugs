{"id": 48534, "wybug_id": "wooyun-2014-077405", "wybug_title": "PHP云人才系统任意刷钱（附演示）", "wybug_corp": "php云人才系统", "wybug_author": "xiaoL", "wybug_date": "2014-09-26 14:23", "wybug_open_date": "2014-12-25 14:24", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-25：\t细节向公众公开  简要描述： PHP云人才系统任意刷钱漏洞，演示详细过程，利用难度低0-0！ 详细说明：  起因在member\\model\\com.class.php文件中：\nfunction dingdan_action(){\t\tif($_POST['price']){\t\t\tif($_POST['comvip']){\t\t\t\t$comvip=(int)$_POST['comvip'];\t\t\t\t$ratinginfo =  $this->obj->DB_select_once(\"company_rating\",\"`id`='\".$comvip.\"'\");\t\t\t\t$price = $ratinginfo['service_price'];\t\t\t\t$data['type']='1';\t\t\t}elseif($_POST['price_int']){\t\t\t\t$price = $_POST['price_int']/$this->config['integral_proportion'];  //integral_proportion = 20 只是简单的相除，没有判断正负。\t\t\t\t$data['type']='2';\t\t\t}elseif($_POST['price_msg']){\t\t\t\t$price = $_POST['price_msg']/$this->config['integral_msg_proportion'];\t\t\t\t$data['type']='5';\t\t\t}else{ \t\t\t\t$this->obj->ACT_layer_msg(\"参数不正确，请正确填写！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}\t\t\t$dingdan=mktime().rand(10000,99999); //订单生产的订单号，使用时间戳加上随机数。\t\t\t$data['order_id']=$dingdan;\t\t\t$data['order_price']=$price;\t\t\t$data['order_time']=mktime();\t\t\t$data['order_state']=\"1\";\t\t\t$data['order_remark']=trim($_POST['remark']);\t\t\t$data['uid']=$this->uid;\t\t\t$data['rating']=$_POST['comvip'];\t\t\t$data['integral']=$_POST['price_int'];\t\t\t$id=$this->obj->insert_into(\"company_order\",$data); //成功插入了数据库\t\t\tif($id){\t\t\t\t$this->obj->ACT_layer_msg(\"下单成功，请付款！\",9,\"index.php?c=payment&id=\".$id);\t\t\t}else{\t\t\t\t$this->obj->ACT_layer_msg(\"提交失败，请重新提交订单！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}\t\t}else{\t\t\t$this->obj->ACT_layer_msg(\"参数不正确，请正确填写！\",8,$_SERVER['HTTP_REFERER']);\t\t}\t}\n此处可以插入$_POST['price_int']=-20000  相当于 -1000元接下来看api\\tenpay\\index.php文件中的逻辑：\nif(!is_numeric($_POST['dingdan']))  //判断了是否为数字{\tdie;}$userid=(int)$_COOKIE['uid'];$_POST['is_invoice']=(int)$_POST['is_invoice']; //无用$_POST['balance']=(int)$_POST['balance'];   //化为整数了，此参数只要存在就行了，随便提交$member_sql=$db->query(\"SELECT * FROM `\".$db_config[\"def\"].\"member` WHERE `uid`='\".$userid.\"' limit 1\");$member=mysql_fetch_array($member_sql);if($member['username'] != $_COOKIE['username'] || $member['usertype'] != $_COOKIE['usertype']||md5($member['username'].$member['password'].$member['salt'])!=$_COOKIE['shell']){\techo '登录信息验证错误，请重新登录！';die;}$sql=$db->query(\"select * from `\".$db_config[\"def\"].\"company_order` where `order_id`='$_POST[dingdan]'\");  //根据订单号查询order$row=mysql_fetch_array($sql);if($_POST['balance']&&$userid){  //正常登陆用户，随便提交balance参数即可\t$c_sql=$db->query(\"select `pay` from `\".$db_config[\"def\"].\"company_statis` where `uid`='\".$userid.\"'\");\t$company_statis=mysql_fetch_array($c_sql);\tif($company_statis['pay']>=$row['order_price']){             //关键来了，判断用户余额是否大于订单，因为order_price 是负数，一定为true\t\t$up_sql=$db->query(\"update `\".$db_config[\"def\"].\"company_statis` set `pay`=`pay`-'\".$row['order_price'].\"' where `uid`='\".$userid.\"'\"); //此处直接相减了，负负得正！金钱增加。漏洞触发。\t\tmysql_fetch_array($up_sql);\t\t$up_order=$db->query(\"update `\".$db_config[\"def\"].\"company_order` set `order_price`='0'\".$invoice_title.\" where `order_id`='\".$row['order_id'].\"'\");  //这里不影响，后面都不影响。\t\tmysql_fetch_array($up_order);\t\t$price=$row['order_price'];\t}else{\t\t$price=$company_statis['pay'];\t\t$up_sql=$db->query(\"update `\".$db_config[\"def\"].\"company_statis` set `pay`='0' where `uid`='\".$userid.\"'\");\t\t$up_sql_status=mysql_fetch_array($up_sql);\t\t$up_order=$db->query(\"update `\".$db_config[\"def\"].\"company_order` set `order_price`=`order_price`-'\".$price.\"'\".$invoice_title.\" where `order_id`='\".$row['order_id'].\"'\");\t\tmysql_fetch_array($up_order);\t}\t$insert_company_pay=$db->query(\"insert into `\".$db_config[\"def\"].\"company_pay`(order_id,order_price,pay_time,pay_state,com_id,pay_remark,type) values('\".$row['order_id'].\"','-\".$price.\"','\".time().\"','2','\".$userid.\"','\".$row['order_remark'].\"','2')\");\tmysql_fetch_array($insert_company_pay);\t$new_sql=$db->query(\"select * from `\".$db_config[\"def\"].\"company_order` where `order_id`='\".$row['order_id'].\"'\");\t$row=mysql_fetch_array($new_sql);}\n大致成因是这样的，利用起来也相当的简单。\n在文件member\\model\\com.class.php中：\tfunction paylog_action(){\t\tinclude(CONFIG_PATH.\"db.data.php\");\t\t$this->yunset(\"arr_data\",$arr_data);\t\t$this->public_action();/*省略*/\t\t}else{\t\t\t$urlarr=array(\"c\"=>\"paylog\",\"page\"=>\"{{page}}\");\t\t\t$pageurl=$this->url(\"index\",\"index\",$urlarr);\t\t\t$where=\"`uid`='\".$this->uid.\"'\";\t\t\t$where.=\" and `order_price`>0 order by order_time desc\";  //根据这个逻辑只显示了订单额大于0的项目，因此订单号需要我们去猜测。\t\t\t$this->get_page(\"company_order\",$where,$pageurl,\"10\");\t\t}/*省略*/\t}\n\n\n默认只显示正数订单，但是其实订单都是存在在数据库中的。   漏洞证明：  利用方法：只要在短时间多次重放订单数据包，就能在一秒内拥有最多的订单数，然后跑一遍10000-99999的后缀即可了。重发使用burpsuite，可以设置大线程。这里有个技巧就是第一个提交一定是一个正常的数据，这样就可以找到mktime前缀了。演示一遍。1、多线程提交订单\n\n2、只会显示第一个正常的订单\n\n3、数据库中显示订单存在\n\n开始遍历1411709332这个段的订单。订单前缀是在列表中直接显示的- -。4、其中blance字段一定要有，值随意\n\n坐等跑完\n\n查看余额\n\n试过这样就可以使用了，可以买会员，比如上图的铜牌会员。   修复方案：  逻辑- -   版权声明：转载请注明来源 xiaoL@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-09-26 14:26 厂商回复： 感谢提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-30 12:09 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  太刁了    \n     2014-10-01 09:43 |    \t\tsecmap \t\t\t( 普通白帽子  |\t\t\t        Rank:920 漏洞数:155        )\t\t \n  可提现不?    \n     2014-12-25 15:05 |    \t\tmilkeway \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 我是帅锅。。小城是我老大)\t\t \n  。好叼 刷钱    \n     2014-12-25 15:10 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  太叼了 可以提现不    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}