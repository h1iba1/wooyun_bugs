{"id": 4767, "wybug_id": "wooyun-2014-049160", "wybug_title": "ThinkSNS某功能平行权限漏洞", "wybug_corp": "ThinkSNS", "wybug_author": "齐迹", "wybug_date": "2014-01-17 15:35", "wybug_open_date": "2014-04-17 15:36", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "6", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-17：\t细节向公众公开  简要描述： ThinkSNS某功能平行权限 详细说明：  问题发生在微吧模块代码apps\\weiba\\index.action.phppublic function postEdit() 这个方法有判断权限不过到了代码行561这里并没有判断被编辑的帖子是否是当前用户发的！\npublic function doPostEdit(){\t\t$weiba = D('weiba_post')->where('post_id='.intval($_POST['post_id']))->field('weiba_id,attach')->find();\t\tif ( !CheckWeibaPermission( '' , $weiba['weiba_id'] ,'weiba_edit') ){\t\t\tif ( !CheckPermission('weiba_normal','weiba_edit') ){\t\t\t\t$this->error('对不起，您没有权限进行该操作！',true);\t\t\t}\t\t}\t\t$checkContent = str_replace('&nbsp;', '', $_POST['content']);\t\t$checkContent = str_replace('<br />', '', $checkContent);\t\t$checkContent = str_replace('<p>', '', $checkContent);\t\t$checkContent = str_replace('</p>', '', $checkContent);\t\t$checkContents = preg_replace('/<img(.*?)src=/i','img',$checkContent);\t\t$checkContents = preg_replace('/<embed(.*?)src=/i','img',$checkContents);\t\tif(strlen(t($_POST['title']))==0) $this->error('帖子标题不能为空',true);\t\tif(strlen(t($checkContents))==0) $this->error('帖子内容不能为空',true);\t\tpreg_match_all('/./us', t($_POST['title']), $match);          if(count($match[0])>30){     //汉字和字母都为一个字        \t$this->error('帖子标题不能超过30个字',true);        }\t\t$post_id = intval($_POST['post_id']);\t\t$data['title'] = t($_POST['title']);\t\t$data['content'] = h($_POST['content']);\t\t$data['attach'] = '';\t\tif ( $_POST['attach_ids'] ){\t\t\t$attach = explode('|', $_POST['attach_ids']);\t\t\tforeach ( $attach as $k=>$a){\t\t\t\tif ( !$a ){\t\t\t\t\tunset($attach[$k]);\t\t\t\t}\t\t\t}\t\t\t$attach = array_map( 'intval' , $attach);\t\t\t$data['attach'] =  serialize($attach);\t\t}\t\t$res = D('weiba_post')->where('post_id='.$post_id)->save($data);\t\tif($res!==false){\t\t\t$post_detail = D('weiba_post')->where('post_id='.$post_id)->find();\t\t\tif(intval($_POST['log'])==1){\t\t\t\tD('log')->writeLog($post_detail['weiba_id'],$this->mid,'编辑了帖子“<a href=\"'.U('weiba/Index/postDetail',array('post_id'=>$post_id)).'\" target=\"_blank\">'.$post_detail['title'].'</a>”','posts');\t\t\t}\t\t\t//同步到微博\t\t\t$feedInfo = D('feed_data')->where('feed_id='.$post_detail['feed_id'])->find();\t\t\t$datas = unserialize($feedInfo['feed_data']);\t\t\t$datas['content'] = '【'.$data['title'].'】'.getShort(t($checkContent),100).'&nbsp;';\t\t\t$datas['body'] = $datas['content'];\t\t\t$data1['feed_data'] = serialize($datas);\t\t\t$data1['feed_content'] = $datas['content'];\t\t\t$feed_id = D('feed_data')->where('feed_id='.$post_detail['feed_id'])->save($data1);\t\t\tmodel('Cache')->rm('fd_'.$post_detail['feed_id']);\t\t\treturn $this->ajaxReturn($post_id, '编辑成功', 1);\t\t}else{\t\t\t$this->error('编辑失败',true);\t\t}\t}\n   漏洞证明：  第一步 用普通帐号发布一个帖子然后编辑访问/index.php?app=weiba&mod=Index&act=postEdit&post_id=1\n\n\n\n   修复方案：  判断一下权限！   版权声明：转载请注明来源 齐迹@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-01-21 14:34 厂商回复： 非常感谢这位认真的白帽，临近假期响应慢了！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}