{"id": 38134, "wybug_id": "wooyun-2015-098094", "wybug_title": "中国环境检测总站任意文件下载漏洞", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "假面，", "wybug_date": "2015-02-27 16:54", "wybug_open_date": "2015-04-13 16:58", "wybug_type": "任意文件遍历/下载", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件操作参数未加过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-13：\t细节向公众公开  简要描述： http://www.cnemc.cn/news/downLoad.jsp?filePath= 详细说明：  http://www.cnemc.cn/news/downLoad.jsp?filePath=http://www.cnemc.cn/news/downLoad.jsp?filePath=news/downLoad.jsp   漏洞证明：  \n<%@ page contentType=\"text/html;charset=gbk\"%><%@ page import=\"java.io.File\"%><%@ page import=\"java.io.*\"%><%@ page import=\"java.net.*\"%><% String filePath = request.getParameter(\"filePath\");String root = request.getRealPath(\"/\");                     String fileName = \"\";filePath=filePath.replaceAll(\"..//\", \"\");filePath=filePath.replaceAll(\"WEB-INF\", \"\");String describe = request.getParameter(\"describe\");File fileInfo = new File(root+filePath);if (!fileInfo.exists()) {\t%>\t\t<script type=\"text/javascript\">\t\t\talert(\"下载文件不存在！\");\t\t\twindow.close();\t\t</script>\t\t<%\treturn;}else{\t\tfileName = fileInfo.getName();\tSystem.out.println(fileInfo.getAbsolutePath());}if(fileName.equals(\"\")){\t%>\t\t<script type=\"text/javascript\">\t\t\talert(\"下载文件不存在！\");\t\t\twindow.close();\t\t</script>\t\t<%\treturn;}String _fileName = fileName;StringBuffer s = new StringBuffer(URLEncoder.encode(_fileName,\"UTF-8\"));_fileName = s.toString().replaceAll(\"[+]\",\"%20\"); response.reset();//后缀名String fileExt = \"\";int k = _fileName.substring(0,_fileName.indexOf(\".\")).length();fileExt = _fileName.substring(k,_fileName.length());String title = \"\";if(!(\"\").equals(describe)){\ttitle = describe+fileExt;}else{\ttitle = fileName.substring(fileName.indexOf(\".\"),fileName.length());}if(title.indexOf(\"docx\") >0){\t\tresponse.setContentType(\"application/vnd.openxmlformats-officedocument.wordprocessingml.document; charset=GBK\");     //linux}else if(title.indexOf(\"xlsx\") >0){\tresponse.setContentType(\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet; charset=GBK\");     //linux}else if(title.indexOf(\"pptx\")>0){\tresponse.setContentType(\"application/vnd.openxmlformats-officedocument.presentationml.presentation; charset=GBK\");     //linux}else if(title.indexOf(\"pdf\") >0){\t response.setContentType(\"application/pdf\");     //linux}else{\tresponse.setContentType(\"application/octet-stream; charset=GBK\");     //linux}//response.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\"+DateProcess.getNum()+title+\"\\\"\");if (fileName.length() > 22) { \tString guessCharset = \"gb2312\";\t _fileName = new String(fileName.getBytes(guessCharset), \"ISO8859-1\"); }response.addHeader(\"Content-Disposition\", \"attachment; filename=\"+ new String(title.getBytes(\"GBK\"), \"ISO-8859-1\")); if(title.indexOf(\"pdf\") >0){\tresponse.setHeader(\"Content-Disposition\", \"inline; filename=\"+new String(title.getBytes(\"GBK\"), \"ISO-8859-1\"));}OutputStream output = null;FileInputStream fis = null;try{    File f = new File(root + filePath);  output = response.getOutputStream();  fis = new FileInputStream(f);   byte[] b = new byte[(int)f.length()];    int i = 0;  while((i = fis.read(b)) > 0){    output.write(b, 0, i);  }  output.flush();}catch(Exception e){  e.printStackTrace();}finally{  if(fis != null){    fis.close();    fis = null;  }  if(output != null){    output.close();    output = null;  } response.flushBuffer();out.clear();out = pageContext.pushBody();}%>\n   修复方案：  \n你们比我懂~\n   版权声明：转载请注明来源 假面，@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-03-04 09:11 厂商回复： CNVD确认所述情况，已经由CNVD通过网站公开联系方式向网站管理单位通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}