{"id": 29429, "wybug_id": "wooyun-2015-0119409", "wybug_title": "phpshe任意修改订单状态+鸡肋注入1枚", "wybug_corp": "phpshe.com", "wybug_author": "路人甲", "wybug_date": "2015-06-12 16:22", "wybug_open_date": "2015-09-15 16:25", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-17：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-15：\t细节向公众公开  简要描述： phpshe任意修改订单状态+鸡肋注入1枚 详细说明：  先来看看如何修改订单状态，在/include/plugin/payway/alipay/notify_url_sgn.php就像 WooYun: phpshe最新版sql注入一枚 中说的，厂商一直在确认，但是还是没在根本上解决，这里引起了任意修改订单状态，又可以不花钱买东西了~~可以对订单状态任意修改，这里以“把订单由未付款改为已付款，等待发货”为例进行说明。\ninclude('../../../../common.php');require_once(\"alipay.config.php\");require_once(\"lib/alipay_notify.class.php\");//计算得出通知验证结果$alipayNotify = new AlipayNotify($alipay_config);$verify_result = $alipayNotify->verifyNotify();//验证成功if ($verify_result) {\t\t\t//商户订单号\t$out_trade_no = $_POST['out_trade_no'];\t//支付宝交易号\t$trade_no = $_POST['trade_no'];\t$info = $db->pe_select('order', array('order_id'=>$out_trade_no));\t\t\t//该判断表示买家已在支付宝交易管理中产生了交易记录，但没有付款\tif ($_POST['trade_status'] == 'WAIT_BUYER_PAY') {\t        echo \"success\";\t\t//请不要修改或删除    }\t//该判断表示买家已在支付宝交易管理中产生了交易记录且付款成功，但卖家没有发货\telseif ($_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {\t\tif ($info['order_state'] == 'notpay') {\t\t\t$order['order_outid'] = $trade_no;\t\t\t$order['order_payway'] = 'alipay_db';\t\t\t$order['order_state'] = 'paid';\t\t\t$order['order_ptime'] = time();\t\t\t\t\t$db->pe_update('order', array('order_id'=>$out_trade_no), $order);\t\t}        echo \"success\";\t\t//请不要修改或删除    }\t//该判断表示卖家已经发了货，但买家还没有做确认收货的操作\telseif ($_POST['trade_status'] == 'WAIT_BUYER_CONFIRM_GOODS') {\t\tif ($info['order_state'] == 'paid') {\t\t\t$order['order_state'] = 'send';\t\t\t$order['order_stime'] = time();\t\t\t\t\t\t\t\t$db->pe_update('order', array('order_id'=>$out_trade_no), $order);\t\t}\t        echo \"success\";\t\t//请不要修改或删除    }\t//该判断表示买家已经确认收货，这笔交易完成\telseif ($_POST['trade_status'] == 'TRADE_FINISHED') {\t\tif ($info['order_state'] == 'notpay') {\t\t\t$order['order_outid'] = $trade_no;\t\t\t$order['order_payway'] = 'alipay_js';\t\t\t$order['order_state'] = 'paid';\t\t\t$order['order_ptime'] = time();\t\t\t\t\t\t\t\t$db->pe_update('order', array('order_id'=>$out_trade_no), $order);\t\t}\t\telseif ($info['order_state'] == 'send') {\t\t\t$order['order_state'] = 'success';\t\t\t\t\t\t\t\t$db->pe_update('order', array('order_id'=>$out_trade_no), $order);\t\t}        echo \"success\";\t\t//请不要修改或删除    }\t//其他状态判断    else {        echo \"success\";    }}\nwooyun在多个漏洞中提到了如何绕过if ($verify_result) ，因为key默认，alipay_key = esfsclzgahxncgzi3bbe7giwa2ywxyv3，因此，可以计算得到sign,这里可以绕过的。当$_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS'时，如上面代码，会把订单的状态UPDATE为paid，如下图\n\n修改前：\n\n修改后：\n\n再来说下注入，还是在/include/plugin/payway/alipay/notify_url_sgn.php  为什么说鸡肋呢，就像上面说的，执行一次订单的状态就变了，所以每执行一次，就要换个订单号，我是真的够了~~在 WooYun: phpshe最新版sql注入一枚 中，提了$out_trade_no ，我这次说下$trade_no\ninclude('../../../../common.php');require_once(\"alipay.config.php\");require_once(\"lib/alipay_notify.class.php\");//计算得出通知验证结果$alipayNotify = new AlipayNotify($alipay_config);$verify_result = $alipayNotify->verifyNotify();//验证成功if ($verify_result) {\t\t\t//商户订单号\t$out_trade_no = $_POST['out_trade_no'];\t//支付宝交易号\t$trade_no = $_POST['trade_no'];\t$info = $db->pe_select('order', array('order_id'=>$out_trade_no));\t\t\t//该判断表示买家已在支付宝交易管理中产生了交易记录，但没有付款\tif ($_POST['trade_status'] == 'WAIT_BUYER_PAY') {\t        echo \"success\";\t\t//请不要修改或删除    }\t//该判断表示买家已在支付宝交易管理中产生了交易记录且付款成功，但卖家没有发货\telseif ($_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {\t\tif ($info['order_state'] == 'notpay') {\t\t\t$order['order_outid'] = $trade_no;\t\t\t$order['order_payway'] = 'alipay_db';\t\t\t$order['order_state'] = 'paid';\t\t\t$order['order_ptime'] = time();\t\t\t\t\t$db->pe_update('order', array('order_id'=>$out_trade_no), $order);\t\t}        echo \"success\";\t\t//请不要修改或删除    }\n没有防注的措施，这里就简单的证明注入的存在吧，一起修复吧。如下图\n\n   漏洞证明：  见 详细说明   修复方案：  过滤 处理key   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-09-15 16:25 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}