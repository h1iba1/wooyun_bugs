{"id": 51194, "wybug_id": "wooyun-2014-075384", "wybug_title": "hdcms 多处XSS可打后台和主页", "wybug_corp": "后盾网", "wybug_author": "只发通用型", "wybug_date": "2014-09-10 10:56", "wybug_open_date": "2014-12-09 10:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-10：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-12-09：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 学tp框架开发看的是后盾网的教程，老师讲得挺好的,顺手挖了一下后盾cms的漏洞一个XSS rank5 4个一共rank20 哈哈哈哈...源码地址https://git.oschina.net/houdunwang/hdcms/repository/archive?ref=master 详细说明：  第一处和第二第三处:用户中心---修改昵称漏洞出在/hd/Hdcms/Member/Control/ProfileControl.class.php 15行~43行\n//修改昵称\tpublic function editNickname() {\t\t$Model = M(\"user\");\t\t$state = $Model -> save(array('uid' => $_SESSION['uid'], 'nickname' => $_POST['nickname']));\t\tif ($state) {\t\t\t$_SESSION['nickname'] = $_POST['nickname'];\t\t\t$this -> success('修改昵称成功!');\t\t} else {\t\t\t$this -> error('昵称修改失败');\t\t}\t//修改用户资料\tpublic function edit() {\t\t$this -> field = M('user') -> find(session(\"uid\"));\t\t$this -> display();\t}\t//编辑基本信息（个性签名，个性域名）\tpublic function edit_message() {\t\t$_POST['signature'] = mb_substr($_POST['signature'], 0, 50, 'utf-8');\t\t//修改资料\t\tif ($this -> _db -> where(\"uid=\" . session('uid')) -> save()) {\t\t\t$_SESSION['domain'] = $_POST['domain'];\t\t\t$_SESSION['signature'] = $_POST['signature'];\t\t\t$this -> _ajax(1, '修改成功!');\t\t}\t}\neditNickname函数和edit_message函数$_POST变量没有经过过滤 直接传入..导致XSSeditNickname这个点可以XSS到后台和主页edit_message函数可以X到个人中心第四处：文章--评论/hd/Hdcms/Member/Control/ProfileControl.class.php 45~107行\npublic function addComment() {\t\t$Model = K('Comment');\t\t$ModelCache= cache('model');\t\t$mid = Q('mid',0,'intval');\t\t$cid = Q('cid', 0, 'intval');\t\t$aid = Q('aid', 0, 'intval');\t\tif (!session(\"uid\")) {\t\t\t$this -> _ajax('nologin', '没有登录');\t\t}\t\t//-验证评论发表间隔时间\t\tQ('session.comment_send_time', 0, 'intval');\t\t//间隔时间小于配置项\t\tif (!IN_ADMIN && Q('session.comment_send_time') + C('comment_step_time') > time()) {\t\t\t$_time = Q('session.comment_send_time') + C('comment_step_time') - time();\t\t\t$step = $_time / 60 > 1 ? intval($_time / 60) . '分钟' : $_time . '秒';\t\t\t$this -> error('请' . $step . '后发表');\t\t}\t\t$content=Q('content');\t\tif (!$content) {\t\t\t$this -> error('评论内容不能为空');\t\t}\t\t$state = $Model -> where(\"cid={$cid} && aid={$aid} && \" . C(\"DB_PREFIX\") . \"comment.uid=\" . session('uid')) \t\t\t\t\t\t-> where(\"content='$content'\") -> order(\"comment_id DESC\") -> find();\t\tif ($state) {\t\t\t$this -> error('请不要发表重复内容');\t\t}\t\t//添加积分\t\t$reply_credits = intval(C('reply_credits'));\t\t$credits_msg = '';\t\tif ($reply_credits) {\t\t\t$sql = \"UPDATE \" . C('DB_PREFIX') . 'user AS u SET credits=credits+' . $reply_credits;\t\t\tM() -> exe($sql);\t\t\t$_SESSION['credits'] += $reply_credits;\t\t\t$credits_msg = '奖励' . $reply_credits . '个积分';\t\t}\t\t//添加\t\tif ($comment_id = $Model -> addComment()) {\t\t\t//记录发表时间\t\t\tsession('comment_send_time', time());\t\t\t//修改文章评论数\t\t\tM($ModelCache[$mid]['table_name']) -> inc('comment_num', 'aid=' . $aid);\t\t\t$comment_state = M('role')->where('rid='.$_SESSION['rid'])->getField('comment_state');\t\t\tif($comment_state == 1 || IN_ADMIN){\t\t\t\t$comment = $this -> getCommentHtml($comment_id);\t\t\t\t$msg =  '评论成功！' . $credits_msg;\t\t\t}else{\t\t\t\t$comment='';\t\t\t\t$msg =  '评论成功，审核后显示';\t\t\t}\t\t\t//添加动态\t\t\t$Message= mb_substr($content, 0, 30, 'utf-8');\t\t\t$DyMessge = \"<a target='_blank' href='\".__WEB__.\"?a=Index&c=Index&m=content&mid={$mid}&cid={$cid}&aid={$aid}'>\".$Message.\"</a>\";\t\t\taddDynamic($_SESSION['uid'],\"发表了评论: \" . $DyMessge);\t\t\t//向文章作者发送系统消息\t\t\t$article = M($ModelCache[$mid]['table_name'])->where(\"aid=$aid\")->find();\t\t\t$articleUrl = __WEB__.\"?a=Index&c=Index&m=content&mid={$mid}&cid={$cid}&aid={$aid}\";\t\t\t$title = mb_substr($article['title'], 0,30,'utf-8');\t\t\taddSystemMessage($_SESSION['uid'],\" <a target='_blank' href='\".$articleUrl.\"'>{$title}</a> 有了新评论\");\t\t\t$this -> _ajax(1,$msg, $comment);\t\t} else {\t\t\t$this -> error('失败了哟');\t\t}\t}\n $content变量没有经过过滤导致XSS漏洞 这个点可以XSS到主页和后台    漏洞证明：  \n\n\n\n可以打到cookies\n\n\n\n   修复方案：  htmlspecialchars一下   版权声明：转载请注明来源 只发通用型@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}