{"id": 500, "wybug_id": "wooyun-2014-075425", "wybug_title": "优酷某站配置不当导致getshell，用户泄露，内部邮件泄露，并可内网漫游", "wybug_corp": "优酷", "wybug_author": "if、so", "wybug_date": "2014-09-08 10:31", "wybug_open_date": "2014-10-23 10:32", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["渗透测试思路"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-23：\t细节向公众公开  简要描述： 大半夜在看视频，看着看着就发现了优酷某站配置不当导致getshell，用户泄露，内部邮件泄露，并可内网漫游等严重问题，尼玛，光看代码看了2个小时！此次渗透可谓是一波三折，提交漏洞时，思路花了好久才理清，花了一夜时间，马上天亮了 详细说明：  晚上在看优酷视频的时候跳出了优酷分享计划，随便点了几下，就跳到了今晚的主角，http://bbs.share.youku.com。\n\n论坛使用discuz x3.0搭建，\nhttp://bbs.share.youku.com/home.php?mod=space&uid=1\n发现samo是管理员，试了试管理员弱口令，失败，尝试一些配置文件的bak，也提示404.准备离开的时候竟然发现data可以列目录！\n\n在里面发现了一个感觉有料的文件log.tar.gz的文件，下载回来发现是一些日志文件。\n\n一共45个文件，有些文件就是一些系统日志文件，有些文件记录了详细敏感的信息。比如smtp.php就记录了发信失败的记录\n<?PHP exit;?>\t2014-03-13 09:51:14\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server<?PHP exit;?>\t2014-03-13 09:51:24\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server<?PHP exit;?>\t2014-03-13 09:51:36\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server<?PHP exit;?>\t2014-03-13 09:51:37\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server<?PHP exit;?>\t2014-03-13 09:51:41\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server<?PHP exit;?>\t2014-03-13 09:51:43\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server<?PHP exit;?>\t2014-03-13 09:51:44\t221.10.117.198\t1570\t/home.php?mod=spacecp&ac=profile&op=password&resend=1\t(smtp.163.com:25) CONNECT - Unable to connect to the SMTP server...\n而cplog.php和illegallog.php就比较有价值了,分别截取一些片段cplog\n{server=smtp.foxmail.com; port=25; }; 1={server=smtp.163.com; port=25; }; 2={server=smtp.163.com; port=25; }; }; esmtp={0={server=smtp.foxmail.com; port=25; auth=1; from=yuanchuang-test@foxmail.com; auth_username=yuanchuang-test@foxmail.com; auth_password=y********re; }; 1={server=smtp.163.com; port=25; auth=1; from=youkusamo@163.com; auth_username=youkusamo@163.com; auth_password=9********07; }; 2={server=smtp.163.com; port=25; auth=1; from=shaiyuanchuang@163.com; auth_username=shaiyuanchuang@163.com; auth_password=y********re; }; }; mailusername=1; sendmail_silent=1; }; }; test_from=shaiyuanchuang@163.com; test_to=315832738@qq.com; mailcheck=检测邮件发送设置; }; POST={anchor=mailcheck; operation=mailcheck; settingnew={mail={mailsend=2; smtp={0={server=smtp.foxmail.com; port=25; }; 1={server=smtp.163.com; port=25; }; 2={server=smtp.163.com; port=25; }; }; esmtp={0={server=smtp.foxmail.com; port=25; auth=1; from=yuanchuang-test@foxmail.com; auth_username=yuanchuang-test@foxmail.com; auth_password=y********re; }; 1={server=smtp.163.com; port=25; auth=1; from=youkusamo@163.com; auth_username=youkusamo@163.com; auth_password=9********07; }; 2={server=smtp.163.com; port=25; auth=1; from=shaiyuanchuang@163.com; auth_username=shaiyuanchuang@163.com; auth_password=y********re; }; }; mailusername=1; sendmail_silent=1; }; }; test_from=shaiyuanchuang@163.com; test_to=315832738@qq.com; mailcheck=检测邮件发送设置; };\nillegallog.php\n<?PHP exit;?>\t1381895976\ttest\t1***5\tQues #0\t211.157.171.226<?PHP exit;?>\t1381977787\t\t12***6\tQues #0\t211.157.171.226<?PHP exit;?>\t1382342805\tsamo\t9***7\tQues #0\t211.157.171.226<?PHP exit;?>\t1382342825\tsamo\t9***7\tQues #0\t211.157.171.226<?PHP exit;?>\t1382698952\tsamo\ts***o\tQues #0\t211.157.171.226<?PHP exit;?>\t1382931098\t裂舞\t19***7\tQues #0\t10.155.9.34<?PHP exit;?>\t1382931108\t裂舞\t19***7\tQues #0\t10.155.9.34<?PHP exit;?>\t1382931120\t裂舞\t54MW***en\tQues #0\t10.155.9.34<?PHP exit;?>\t1382931184\t裂舞\tmao***ot\tQues #0\t10.155.9.34<?PHP exit;?>\t1383144109\tlan\tla***n\tQues #0\t124.204.144.76\n从上面2个文件我们得出：论坛使用163或者Foxmail作为系统邮箱，然后就是发现samo的密码可能为：9***7，s***o这2个，可是文件里面中间都是3位星号，不确定密码到底是几位，不然就可以直接爆破了。于是现在就卡在这里了，看看上面的smtp日志，感觉yuanchuang-test@foxmail.com和shaiyuanchuang@163.com邮箱的密码就是youkushare，从长度和可能性都很像，我们尝试登录进邮箱看看了，最后只登陆进去了shaiyuanchuang@163.com。\n\n发现这个邮箱只有系统发信的内容，没有其他敏感信息。。峰回路转##再仔细拍查了下，发现了\nauth_username=youkusamo@163.com; auth_password=9********07\n（见上面的cplog.php代码片段）发现youkusamo@163.com应该就是管理员的邮箱，9********07和illegallog.php里面的记录也很相似，密码应该就是9********07，可是中间密码都被隐去了，都不确定几位数，真是想暴力破解都不行。又卡在这里了。最后实在没办法，只能一个个php文件翻了，希望能发现好东西。cplog.php代码特别多，特别长，我看完足足花了2个小时，代码繁多，一不小心就看花眼了老天见我如此勤劳，觉得奖赏我，我竟然发现了没有隐去密码的9********071!发现的一霎那，我都不敢乱动，生怕鼠标移走了又找不到了\n\n卧槽，真是再看这些代码就要吐了果断立刻尝试登录后台http://bbs.share.youku.com/admin.php    samo 901107成功进入！！\n\n发现版本是discuz 3.0，可以使用 WooYun: Discuz的利用UC_KEY进行getshell 来getshell成功getshell:\nhttp://bbs.share.youku.com/config/config_ucenter.php\n密码：c\n\n6000多名分享计划人员信息泄露\n\n执行命令发现在内网\n[/bbs/upload/config/]$ cat /etc/hosts# Do not remove the following line, or various programs# that require network functionality will fail.127.0.0.1\tlocalhost.localdomain localhost::1\t\tlocalhost6.localdomain6 localhost610.103.52.121   localhost.localdomain10.103.20.163   mcenterapi.youku.com#10.25.10.50     api.tudou.com10.108.89.19    login.tudou.com10.103.52.121   b01.web.revenue.b28.youku123.126.98.166\tapi.tudou.com\n可以架设一个代理来进行内网漫游！可是我实在没力气了，就不深入了。可是还没有完，我又想到了youkusamo@163.com的密码有没有可能也是901107？尝试登陆下，果然登陆进去了，在里面发现更为给力的东西\n\n\n\n\n\n如图示，他应该设置了邮件服务器的转发功能，也是就是把自己youku的公司信箱转发到了这个163邮箱！！安全意识啊！   漏洞证明：  \n\n\n[/bbs/upload/config/]$ cat /etc/hosts# Do not remove the following line, or various programs# that require network functionality will fail.127.0.0.1\tlocalhost.localdomain localhost::1\t\tlocalhost6.localdomain6 localhost610.103.52.121   localhost.localdomain10.103.20.163   mcenterapi.youku.com#10.25.10.50     api.tudou.com10.108.89.19    login.tudou.com10.103.52.121   b01.web.revenue.b28.youku123.126.98.166\tapi.tudou.com\n\n\n\n\n\n\n   修复方案：  好好修复吧   版权声明：转载请注明来源 if、so@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-09-08 11:15 厂商回复： 多谢提醒，马上修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-08 10:39 |    \t\tHxai11 \t\t\t( 普通白帽子  |\t\t\t        Rank:1137 漏洞数:218        | 于是我们奋力向前游，逆流而上的小舟，不停...)\t\t \n  看洞主发的洞，估计是内射上瘾了，哈哈哈    \n     2014-09-08 10:43 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  看视频看着看着……    \n     2014-09-08 12:18 |    \t\tStardustsky \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | ……)\t\t \n  别人也要放中秋的好吧，就不能迟一天发？作死！！    \n     2014-09-08 12:35 |    \t\tif、so  \t\t\t( 核心白帽子 |\t\t\t        Rank:1008 漏洞数:91        | 梦想还是要有的，万一实现了呢？)\t\t \n  @Stardustsky 他们只需点下确认    \n     2014-09-08 12:41 |    \t\t炊烟 \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:44        | 每一天都需要努力。)\t\t \n  mark    \n     2014-09-08 15:42 |    \t\t安然意境 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:79        | 无论是你的事业还是你的个人，可能走的过程...)\t\t \n  看视频看着看着……    \n     2014-09-09 20:32 |    \t\t黑吃黑 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:29        | 倚楼听风雨，淡看江湖路...)\t\t \n  围观中    \n     2014-09-28 15:36 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  佩服洞主心细如尘，之前这个站尝试很多次无果的：（    \n     2014-09-28 15:42 |    \t\tif、so  \t\t\t( 核心白帽子 |\t\t\t        Rank:1008 漏洞数:91        | 梦想还是要有的，万一实现了呢？)\t\t \n  @梧桐雨  。。主要不会编程，不然写个正则匹配检测那些php文件，妥妥的    \n     2014-10-08 15:12 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  @if、so grep,find，可以省2个小时~总的来说，还是灰常佩服的~    \n     2014-10-08 17:39 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  干的漂亮    \n     2014-10-14 15:29 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  欲哭无泪,大概三个月前我看到这里 没有洞主细心 没找到 ╮(╯▽╰)╭ 膜拜    \n     2014-10-23 10:55 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  幸福的歌声传遍·四方~    \n     2014-10-23 10:59 |    \t\tJulyTornado \t\t\t( 普通白帽子  |\t\t\t        Rank:339 漏洞数:43        | 善战者，无赫赫之功)\t\t \n  运维已被开除。。。    \n     2014-10-23 11:33 |    \t\t小卖部部长 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:3        | 别拿部长不当干部！)\t\t \n  优酷的广告，真他娘的烦，长达一分钟，要逆天哪？？？？    \n     2014-11-28 11:39 |    \t\t写个七 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 一点一点积累。)\t\t \n  干的漂亮    \n     2014-12-11 14:21 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  赞一个~另外，notepad++支持在打开的所有文件里搜索指定字符串，你可以试试    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}