{"id": 72137, "wybug_id": "wooyun-2015-0142234", "wybug_title": "DESTOON某处注入可以直接提升为管理员", "wybug_corp": "DESTOON", "wybug_author": "Noxxx", "wybug_date": "2015-09-21 10:32", "wybug_open_date": "2015-12-20 10:52", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-11-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-20：\t细节向公众公开  简要描述： DESTOON sql注入漏洞 详细说明：  首先看一个函数 :dhtmlspecialchars\nfunction dhtmlspecialchars($string) {\tif(is_array($string)) {\t\treturn array_map('dhtmlspecialchars', $string);\t} else {\t\t$string = htmlspecialchars($string, ENT_QUOTES, DT_CHARSET == 'GBK' ? 'GB2312' : 'UTF-8');\t\t$string = str_replace('&amp;', '&', $string);\t\tif(defined('DT_ADMIN')) return $string;\t\t$_string = str_replace(array('&quot;', '&#34;', '\"'), array('', '', ''), $string);\t\tif($_string == $string) return $string;\t\treturn strip_sql($_string);\t}}\n好像也没什么问题,仔细一看这行:$string = htmlspecialchars($string, ENT_QUOTES, DT_CHARSET == 'GBK' ? 'GB2312' : 'UTF-8');这行功能是 把双引号和单引号转换为实体化.在继续往下看,$_string = str_replace(array('&quot;', '&#34;', '\"'), array('', '', ''), $string);这一行居然又把实体化的双引号给替换成空了，这样会造成一个后果，会导致转义字符实效。我们来从头到尾来过一遍。首先初始化变量,对变量进行转义if(!$MQG) {\tif($_POST) $_POST = daddslashes($_POST);\tif($_GET) $_GET = daddslashes($_GET);\tif($_COOKIE) $_COOKIE = daddslashes($_COOKIE);}此时我们提交 ?g=\" 那么对应的变量应该是 g=\\\"我们在调用htmlspecialchars进行转义:g=&quot;\\调用str_replace后变成 g=\\ 看这样可以直接进行注入了。这个函数应用的地方非常多几乎每个功能模块都有再用，找了一个修改资料的地方可以直接提升为自己成为管理员。   漏洞证明：  首先注册一个企业会员，成功后。先修改一次资料 分别把个人资料里面阿里旺旺和公司联系方式里面的公司传真修改为一串数字 后面会用到\n\n\n\n保存修改后，我们再来一次修改资料，先修改公司资料填入以下内容：\n\",groupid=1 ORDER BY fax=587587554251  DESC LIMIT 1#  fax=你刚刚填入的公司传真。\n\n\n更新成功后 销售产品会变成 ',buy=我们再来第二次更新修改，这次修改个人资料：\n\",admin=1,groupid=1 ORDER BY ALI=52514541511112 DESC LIMIT 1##ALI=你刚刚填入的阿里旺旺。\n\n\n成功后手机号码会变成 ',department=此时已经成功提升为管理员，\n\n（注入管理员的话很简单，因为在同表内。）最新版测试通过。   修复方案：  有点蛋疼，转义。   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-09-21 10:51 厂商回复： 感谢反馈 我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-09-21 10:35 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  我次噢    \n     2015-09-21 12:36 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:789 漏洞数:150        | http://menmen519.blog.sohu.com/)\t\t \n  mark 真快    \n     2015-09-21 18:33 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:372 漏洞数:109        )\t\t \n  大赞。好棒~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}