{"id": 13091, "wybug_id": "wooyun-2013-020277", "wybug_title": "QQ空间某功能缺陷导致日志存储型XSS - 4", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2013-03-18 21:24", "wybug_open_date": "2013-05-02 21:25", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "类型应用", "黑盒分析技巧", "黑盒测试技巧", "黑盒"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-03-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-03-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-04-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-04-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-05-02：\t细节向公众公开  简要描述： 依然是某处功能缺陷，加上开发人员犯了某种古老的过滤错误导致我不好意思的又来了。 详细说明：  1. 模板日志，看到有这么一个播放器，在播放器里加一首歌，随便发个日志，同时抓包。\n\n\n\n2. 我们搜索 MusicPlayer.swf， 可以定位到 http://ctc.qzs.qq.com/qzone/app/blog/v6/script/content_templateblog_parser.js看下日志源代码，我们可以看到这里实际上是一个 <div data=\"xxxxx\" name=\"xxxxx\"></div>\n\n这个可以给我们在定位代码的时候有所启示。 搜索 \"data\" 或 'data'\n\n可以看到Music.Parser调用了 data 属性里的数据并返回，3. 那么哪里调用了 Music.Parser呢？搜索 \"Music.Parser(\"\n\n可以看到，数据进一步到了 TemplateBlogParser.music4. 接着 TemplateBlogParser.music 被哪里用到了呢？ \n\n可以看到数据进一步到了aData.content 5.  稍微继续往下看，可以看到 aData进入了一处 eval, 不过这里eval处是无法利用的。\n\n如上图，这里的代码相当于是执行了aObj=new MusicPlayer(itemId,aData);6. 进一步跟踪，找到MusicPlayer对象的定义。搜索 \"function MusicPlayer\" 找到MusicPlayer后，我们观察它的第2个参数（即data）的流向。\n\n可以看到，data.content 进入了 this.data.content。7. 继续往下面代码看。\n\n接着this.data.content进入了 this.convertKorean() 函数，看样子是做了一次转换。8. 我们进而看看，this.convertKorean 函数对数据进行了什么处理。\nthis.convertKorean = function(str) {        var div = document.createElement(\"div\");        div.innerHTML = str;        str = div.innerText || div.textContent;        return str;    };\n看到这段代码，顿时觉得有戏！！我们的str被传入到了 div.innerHTML中。这段代码的功能，实际上是去掉 str中的 html标签，然而这段代码实际上是犯了一个很经典的\"过滤错误\"，开发人员建立一个临时的div，然后取出innerText/textContent。但是实际上无论 div 是否被追加到DOM中，innerHTML=\"<img src=1 onerror=alert(1)>\" 都是会被执行的。9. 这里一来，我们回溯回去，我们的str实际上就是来自于我们最初的 data中的值。接下来的就好办啦！我们找到最开始抓到的数据，修改并发包。<div class=\"blog_details_20120222\"><div name=\"title\">xxxxxxxxxxx</div><div name=\"text\"><br />x<br />xxxxxxx</div><img name=\"pic\" style=\"display:block;\" width=\"280\" height=\"230\" alt=\"??\" position=\"0_-7\" isDefaultPhoto=\"1\" rotation=\"0\" scale=\"0\" src=\"http://ctc.qzs.qq.com/qzone/space_item/orig/3/87731/module_1.jpg\" /><div name=\"title\">xxxxxx</div><div name=\"title\">xxxx</div><div name=\"title\">xxxx</div><div name=\"MultiImageController\" data=\"\"></div><div name=\"music\" data=\"http://stream16.qqmusic.qq.com/31303066.mp3|<img src=1 onerror=&quot;alert(document.cookie)&quot;>|A-Ha|0\"></div></div>11. 可以看到成功弹出cookies\n\nIE下一样。   漏洞证明：  见详细说明   修复方案：  数据进入 this.convertKorean 之前，或者从 getAttribute(\"data\") 取出数据之后，对数据进行 HTMLEncode.   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-03-19 10:51 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-03-18 21:25 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  二哥就是二哥 每个月都要来几次    \n     2013-03-18 21:27 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:125        | 如果大海能够带走我的矮丑...)\t\t \n  二哥真的怒了！！！！！    \n     2013-03-18 21:32 |    \t\tcnrstar \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:20        | Be my personal best!)\t\t \n  逆天了！    \n     2013-03-18 21:54 |    \t\trasca1 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:16        | 菜鸟一只)\t\t \n  靠，为毛我们再找也找不到，差距啊，，    \n     2013-03-18 22:49 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:41        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @gainover 你知道我想表达啥不？    \n     2013-03-18 22:52 |    \t\trasca1 \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:16        | 菜鸟一只)\t\t \n  你想和他搞基，很明显了    \n     2013-03-18 23:18 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:172        )\t\t \n  @鬼魅羊羔 二哥是骨干美    \n     2013-03-18 23:26 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:41        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @se55i0n 我喜欢瘦的，哈哈    \n     2013-03-19 08:44 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  二哥你好，二哥再见    \n     2013-03-19 09:12 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:41        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @心伤的瘦子 说！你把胖子怎么了！？    \n     2013-03-19 09:46 |    \t\tMetasploit \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:7        | http://www.metasploit.cn/)\t\t \n  连载    \n     2013-03-19 10:31 |    \t\tEl4pse \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:7        | 世界上从来没有不可能这几个字，可不可能完...)\t\t \n  你又调皮了。。好一整子没见着你了    \n     2013-03-19 20:02 |    \t\t心伤的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:147 漏洞数:21        | 严肃点~此号为虚拟小号，并不存在实体...)\t\t \n  @鬼魅羊羔 瘦子来崇拜你们了,还需要胖子吗    \n     2013-03-19 20:23 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:125        | 如果大海能够带走我的矮丑...)\t\t \n  @心伤的瘦子 还需要更胖的吗？    \n     2013-04-18 21:42 |    \t\tlucky \t\t\t( 普通白帽子  |\t\t\t        Rank:409 漏洞数:81        | 三人行必有我师焉########################...)\t\t \n  学习了！二哥大作！    \n     2013-04-19 06:32 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n  二哥这量不少啊，月月轻松    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}