{"id": 53875, "wybug_id": "wooyun-2014-066211", "wybug_title": "Taocms存储型XSS一枚（需点击）", "wybug_corp": "taocms开源", "wybug_author": "xiaoL", "wybug_date": "2014-06-25 18:05", "wybug_open_date": "2014-09-20 18:06", "wybug_type": "xss跨站脚本攻击", "wybug_level": "低", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向公众公开  简要描述： 前辈们的审计让taocms改写了架构，审计难度加大。不过官方的处理似乎存在一些问题。导致了一处XSS漏洞。 详细说明：  新架构里：base.php存在safeword函数：其中主要的是：\nswitch ($level)\t\t\t{\t\t\t\tcase 0:\t\t\t\t\t$safeword=$text;\t\t\t\t\tbreak;\t\t\t\tcase 1:\t\t\t\t\t$safeword=intval($text);\t\t\t\t\tbreak;\t\t\t\tcase 3:\t\t\t\t\t$safeword=strip_tags($text);\t\t\t\t\tbreak;\t\t\t\tcase 5:\t\t\t\t\t$safeword=nl2br(htmlspecialchars($text));\t\t\t\t\tbreak;\t\t\t\tcase 6:\t\t\t\t\t$safeword=str_replace(\"'\",\"\",addslashes($text));\t\t\t\t\t$safeword=str_replace(\"select\",\"\",$safeword);\t\t\t\t\t$safeword=str_replace(\"union\",\"\",$safeword);\t\t\t\t\t$safeword=str_replace(\"=\",\"\",$safeword);\t\t\t\t\tbreak;\t\t\t\tdefault:\t\t\t\t\tif(ucfirst(DB)=='Sqlite'){\t\t\t\t\t\t$safeword=str_replace(\"'\",\"''\",$text);\t\t\t\t\t}\t\t\t\t\telse{\t\t\t\t\t\t$safeword=Base::_addslashs($text);\t\t\t\t\t}\t\t\t\t\tbreak;\t\t\t\t\t\t}\n其中大量使用3->5的组合来过滤XSS漏洞。仔细一看，这样的过滤对于处在script环境中的字符没有防御能力。因为我就去找这样的一个点。最终在发表评论处发现。comment.php文件中\n$dbit=new Dbclass(SYS_ROOT.DB_NAME);\t\t$data['article_id']=Base::safeword($_POST['article_id'],1);\t\t$data['name']=Base::safeword(Base::safeword($_POST['name'],3),5);\t\t$data['emails']=Base::safeword(Base::safeword($_POST['emails'],3),5);\t\t$data['websites']=Base::safeword(Base::safeword($_POST['websites'],3),5);\t\t$data['content']=Base::safeword( Base::safeword($_POST['comment'],4) ,5 );\n其中$data['name']的输出位置在一处a标签的onclick事件里，也就是“回复”功能。因此提交xx')+alert(document.domain);//可成功触发   漏洞证明：  在name处提交xx')+alert(document.domain);//成功触发。\n\n此处长度限制60，完全够用。   修复方案：  对于script环境的过滤设计。   版权声明：转载请注明来源 xiaoL@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-20 18:06 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-23 10:04 |    \t\tMutoubug \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:16        | <script>alert(wooyun);</script>)\t\t \n  各种审计啊    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}