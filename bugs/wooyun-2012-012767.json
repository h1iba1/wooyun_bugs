{"id": 16359, "wybug_id": "wooyun-2012-012767", "wybug_title": "腾讯微博存储型XSS漏洞--看我这标题多普通", "wybug_corp": "腾讯", "wybug_author": "心伤的胖子", "wybug_date": "2012-09-27 09:42", "wybug_open_date": "2012-11-11 09:43", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-09-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-09-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-10-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-10-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-10-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-11-11：\t细节向公众公开  简要描述： 腾讯微博存储型XSS漏洞，需要用户进行交互才能够触发。 详细说明：  先给出重现过程1、发微博处添加音乐，随便搜索一个，比如test，在出现的音乐列表中选择一个插入到微博中，在发表微博的时候截断包，\ncontent=%23%E5%88%86%E4%BA%AB%E9%9F%B3%E4%B9%90%23%20%23We%20are%20AMARS-%E5%90%89%E6%A3%AE%E4%BF%A1%23%20http%3A%2F%2Furl.cn%2F534joC&startTime=1348674746009&endTime=1348675207813&countType=&viewModel=&attips=&pic=&musicID=1886728&musicSong=We%20are%20AMARS<img src=a onerror=alert(1)>&musicSinger=%E5%90%89%E6%A3%AE%E4%BF%A1&musicLocation=http%3A%2F%2Fstream4.qqmusic.qq.com%2F13886728.wma&musicShortUrl=534joC&apiType=8&syncQzone=0&syncQQSign=0\n修改musicSong参数，在后面加上<img src=a onerror=alert(1)>，然后发表微博。2、回到首页刚发表微博的地方，微博内容如下图：\n\n3、点击播放，执行了我们插入的代码。漏洞分析过程：1、漏洞形成的原因经过简单分析是，在http://mat1.gtimg.com/www/mb/js/mi.TalkListRich_120921a.js这个js文件中有如下代码：\nMI.TalkList.prototype.musicEvent = function(b) {\t\tfor (var a = this,\t\tc = 0,\t\te = b.length; c < e; c++) {\t\t\tvar d = b[c],\t\t\tf = g(d, \".albumInfo .mThumbsBox\")[0];\t\t\tif (f) {\t\t\t\t…………\t\t\t} else {\t\t\t\tf = g(d, \".mThumbsBox\")[0];\t\t\t\tj = g(d, \".mBox\")[0];\t\t\t\tg(j, \".mTitBox\");\t\t\t\tvar h = g(j, \".btn_mClose\")[0],\t\t\t\ti = g(j, \".btn_mPlay\")[0],\t\t\t\tj = g(j, \".btn_mPause_hover\")[0],\t\t\t\tk = g(d.parentNode.parentNode, \".msgCnt .ico_music\")[0] || g(d.parentNode.parentNode, \".msgCnt .ico_qlz\")[0];\t\t\t\tf.onclick = i.onclick = function() {\t\t\t\t\tMI.app({\t\t\t\t\t\tMusic: function() {\t\t\t\t\t\t\tMI.TalkList.music(d)\t\t\t\t\t\t}\t\t\t\t\t});\t\t\t\t\treturn ! 1\t\t\t\t};\t\t\t\tk && (k.onclick = function() {…………\t};\n点击触发click时间，然后调用MI.TalkList.music(d)函数进行音乐播放。2、MI.TalkList.music函数在http://mat1.gtimg.com/www/mb/js/mi.Music_120821.js文件中。\nMI.TalkList.music = function(a) {\t\tMI.TalkList.lastMusic = a;\t\tMI.Music && MI.Music.stop(\"\", !0);\t\tvar b = g(a, \".albumInfo .mThumbsBox\")[0];                …………\t\t\ta = '<a class=\"mPlayerPlaying\" href=\"http://music.soso.com/url_player.html?song=%esong%&singer=%esinger%&url=%songurl%&stream=0&songID=0\" target=\"_blank\" title=\"%song%-%singer%\"><span style=\"margin-right:10px;\">%song%-%singer%</span></a>'.replace(/\\%esong\\%/gi, escape(UI.A(a, \"song\"))).replace(/\\%esinger\\%/gi, escape(UI.A(a, \"singer\"))).replace(/\\%song\\%/gi, UI.A(a, \"song\")).replace(/\\%singer\\%/gi, UI.A(a, \"singer\")).replace(/\\%songurl\\%/gi, UI.A(a, \"songurl\")).replace(/\\%songid\\%/gi, UI.A(a, \"songid\"));\t\t\th || (UI.append(UI.html(a)[0], f), h = g(f, \".mPlayerPlaying\")[0]);\t\t\tn || UI.append(UI.html('<span class=\"mPlayerState\"></span>')[0], f);\t\t\t…………\n上面代码中会从页面中获取歌手名和歌曲名然后替换a变量中的内容，在替换的没有对歌曲名和歌手名进行URL编码和HTML编码处理，造成存在XSS漏洞。PS：感觉分析的挺乱的，你们看看能否看懂吧！   漏洞证明：  下图是执行了插入的代码：\n\n   修复方案：  1、在通过js输出html代码的时候对用户传入的数据进行编码处理。   版权声明：转载请注明来源 心伤的胖子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2012-09-27 10:47 厂商回复： 非常感谢您的反馈，漏洞正在跟进处理中。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-09-27 09:51 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  普通不火啊！    \n     2012-09-27 09:55 |    \t\t心伤的胖子 \t\t\t( 普通白帽子  |\t\t\t        Rank:308 漏洞数:29        | 因为心伤，所以胖子。)\t\t \n  @风萧萧 我也这么觉得，回头不管内容如何，先来个够火爆的标题才行。    \n     2012-09-27 09:58 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @心伤的胖子 你绝对是个马甲！    \n     2012-09-27 10:05 |    \t\t心伤的胖子 \t\t\t( 普通白帽子  |\t\t\t        Rank:308 漏洞数:29        | 因为心伤，所以胖子。)\t\t \n  @xsser 说话要有证据，小心我告你哦，信不信明天就让你受到北山法院的传票。    \n     2012-09-27 10:07 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  @xsser  认识的黑客中谁是胖子啊？还带点淡淡的忧伤。    \n     2012-09-27 10:08 |    \t\t心伤的胖子 \t\t\t( 普通白帽子  |\t\t\t        Rank:308 漏洞数:29        | 因为心伤，所以胖子。)\t\t \n  @风萧萧 胖子很多，不过那是蛋蛋的忧伤。    \n     2012-09-27 10:39 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  南山法院和北山法院是一家么。    \n     2012-09-27 10:56 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  肿么没有sina的。。。    \n     2012-10-10 14:56 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @zeracker 你的签名......    \n     2012-10-10 15:02 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  @horseluke 自己就这样了。    \n     2012-10-18 16:39 |    \t\tLeadUrLife \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:14        | 好好学习 天天向上)\t\t \n  关注这个胖子1下    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}