{"id": 2042, "wybug_id": "wooyun-2014-061859", "wybug_title": "U-Mail邮件服务系统任意文件上传+执行漏洞（runtime缺陷与验证绕过）", "wybug_corp": "U-Mail邮件服务系统", "wybug_author": "felixk3y", "wybug_date": "2014-05-22 12:36", "wybug_open_date": "2014-08-17 12:38", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "配置错误", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-27：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-17：\t细节向公众公开  简要描述： 产品介绍(摘自官网)U-Mail专注于电子邮件领域15年，为企业轻松搭建最安全稳定的电子邮件系统软件。关键字：15年 最安全 最稳定{15年 最安全 最稳定} , (w)(o)(x)(*)(a)(o)(l)(e),这么奇葩的代码，这么奇葩的设计、这么奇葩的配置、这么奇葩的、超常轻松的、利用正常的不能再正常的功能就可以拿到shell的系统，我服了...涉及：金融、政府、银行，石油、军队、证券行业等重要部门，影响非常巨大，经测试受影响率：99.8%~100%场外话：我很想把农业银行拿下来的,想想还是算了,毕竟随便改卡里的数字,成土豪了，这样是极其不安全的.. 详细说明：  #1 产品介绍U-Mail邮件服务器，为企业轻松搭建最安全稳定的电子邮件系统软件。U-Mail专注于电子邮件领域15年，将广大企事业单位对邮箱服务器软件稳定安全的各类需求，与电子邮件应用管理的多样化、个性化为目标做深入开发，最大化拓展企业邮箱系统功能的灵活性和稳定性，使之成为政府部门、大专院校、中小学校、企事业集团和从事销售企业邮箱软件的网络服务商、集成商最理想的企业邮局系统架设软件。支持数字证书服务并提供强大的管理功能，可直接在WebMail中撰写或阅读经过数字签名或数字加密的安全邮件(S/MIME)。提供军事级别的高安全强度(4096位DH/DSS加密或2048位RSA加密)；使用TLS/SSL标准安全套接字层通讯协议(1024位RSA加密)，支持包括 SSL SMTP, SSL POP3, SSL IMAP4 安全通讯服务，防止网络侦听，使得通信更安全。#2 U-Mail客户案例中国外交部中国农业银行福州市人大常委会南宁国际机场上海电信公司酒泉卫星发射中心国家环境保护总局浦发银行呼和浩特分行四川省知识产权局晋中商业银行华夏航空国测卫星中心广元贵商银行国家保密技术研究所中华人民共和国厦门海事局威海市商业银行 ...还有很多很多就不一一列举了...#3 先来说说真正的上传漏洞，再说奇葩的配置问题漏洞文件/client/mail/module/o_attach.php代码如下（代码是Zend加密的，但是呢..）\nif ( ACTION == \"attach-upload\" ){    if ( $_FILES )    {        $file_name = $_FILES['Filedata']['name'];        $file_type = $_FILES['Filedata']['type'];        $file_size = $_FILES['Filedata']['size'];        $file_source = $_FILES['Filedata']['tmp_name'];        $file_suffix = getfilenamesuffix( $file_name );        $not_allow_ext = array( \"php\", \"phps\", \"php3\", \"exe\", \"bat\" );        if ( in_array( $file_suffix, $not_allow_ext ) )        {            dump_json( array( \"status\" => 0, \"message\" => el( \"不支持该扩展名文件上传\", \"\" ) ) );        }        $path_target = getusercachepath( );        do        {            $file_id = makerandomname( );            $file_target = $path_target.$file_id.\".\".$file_suffix;        } while ( file_exists( $file_target ) );        if ( move_uploaded_file( $file_source, $file_target ) )        {            dump_json( array( \"status\" => 0, \"message\" => el( \"写入文件出错，请与管理员联系！\", \"\" ) ) );        }        $_SESSION[SESSION_ID]['attach_cache'][] = array( \"id\" => $file_id, \"name\" => $file_name, \"type\" => \"1\", \"path\" => $file_target, \"size\" => $file_size );        dump_json( array( \"status\" => \"1\", \"filename\" => $file_name, \"filesize\" => $file_size, \"file_id\" => $file_id ) );    }    else    {        dump_json( array( \"status\" => \"0\", \"message\" => el( \"无法找到需要上传的文件！\", \"\" ) ) );    }}\n这里的话，主要是你们对前段时间对该漏洞修复不完善，可以绕过，导致可以再次上传任意文件，获取服务器权限..首先来看看你们是怎样修复的\n$not_allow_ext = array( \"php\", \"phps\", \"php3\", \"exe\", \"bat\" );        if ( in_array( $file_suffix, $not_allow_ext ) )        {            dump_json( array( \"status\" => 0, \"message\" => el( \"不支持该扩展名文件上传\", \"\" ) ) );        }\n这不就是典型的黑名单限制嘛，黑名单太不靠谱了，于是可以轻易的绕过..这里就不给出具体的证明了，文件的上传可以参考先前的这个漏洞\n WooYun: U-Mail任意文件上传漏洞一枚 \n但由于官方已经修复了这个漏洞，当然利用上面的方法是无法成功上传的，要稍微改变下构造表单上传的时候，采用Burp抓包上，修改上传的文件名 如下\nContent-Disposition: form-data; name=\"Filedata\"; filename=\"shell.jpg\"修改为Content-Disposition: form-data; name=\"Filedata\"; filename=\"shell.php \"注意：shell.php后面的个空格\n提交，即可获取webshell,如图\n\n(当时并不是这样获取到的webshell,当时获取webshell是通过#4的方法获取到的)#4 奇葩的U-Mail环境当时测试这个文件上传的时候(\nwww.wooyun.org/bugs/wooyun-2014-059954\n)，由于修复了，获取不到shell,当测试上传正常的jpg图片时，图片地址为\nhttp://mail.comingchina.com/webmail/client/cache/78427/14006861677.jpg\n可以当时手抖了下 在连接后面加上/.php 不可思议的是，居然解析了..\n\n难道是Nginx??? No！！！居然是IIS的，太奇葩了\n\n不过更奇葩的还在后面...#5 奇葩配置家家有今天早上起来，想起这事 会不会其他的服务器上同样存在这个问题呢?果真是不搜不知道，一搜吓一跳...原来这种奇葩的配置普遍都存在..\nhttp://mail.shcmusic.edu.cn/webmail/images/login9/login_month05.gif\n\n\n\nhttp://mail.huacemedia.com:6080/webmail/images/login9/login_month05.gif\n\n\n\nhttp://sznslib.com.cn/webmail/images/login9/login_month05.gif\n\n\n\nhttp://mail.onlyedu.com:3000/webmail/images/login9/login_month05.gif\n\n\n还有很多很多，就不一一截图举例了，几乎是全部都存在这个问题，影响实在是太大了...\nhttp://mail.chongqingbeer.com/webmail/images/login6/index_r3_c7.jpg/.phphttp://mail.dxh.gov.cn:8000/webmail/images/login9/login_month05.gif/.phphttp://mail.szclib.org.cn/webmail/images/login8/lo_3.jpg/.phphttp://mail.maxqueen.com/webmail/images/login9/login_month05.gif/.phphttp://mail.ypsti.com/webmail/images/login8/logo_def.jpg/.phphttp://www.dencare.com.cn:8081/webmail/images/login9/login_month05.gif/.phphttp://mail.chsdl.com/webmail/images/login9/login_month05.gif/.phphttp://mail.cmpedu.com/webmail/images/login9/login_month05.gif/.phphttp://mail.warriorshoes.com/webmail/images/login4/pt.jpg/.phphttp://mail.scrftb.gov.cn/webmail/images/login8/lo_3.jpg/.phphttp://www.xdrc.gov.cn:6080/webmail/images/login8/lo_3.jpg/.phphttp://mail.zzradio.cn/webmail/images/login9/login_month05.gif/.phphttp://mail.zzradio.cn/webmail/images/login9/login_month05.gif/.phphttp://mail.jasolar.com/webmail/images/login5/vir1.gif/.phphttp://mail.kyfc.com.cn/webmail/images/login9/login_month05.gif/.phphttp://mail.ms.gov.cn/webmail/images/login9/login_month05.gif/.phphttp://mail.ms.gov.cn/webmail/images/login9/login_month05.gif/.phphttp://mail.guojihr.com/webmail/images/login9/login_month05.gif/.phphttp://mail.tlf.gov.cn/webmail/images/login9/login_month05.gif/.phphttp://mail.lianyuan.gov.cn:800/webmail/images/login9/login_month05.gif/.phphttp://www.gdmsa.gov.cn:3000/webmail/images/login9/login_month05.gif/.phphttp://www.imbcams.com.cn/webmail/images/login9/login_month05.gif/.phphttps://www.hnhtxx.com.cn/webmail/images/login9/login_month05.gif/.php\n小结：上述结果仅列出Google前3页，全部中招... 命中率：100%\n\n   漏洞证明：  #丢个官方shell\n\n   修复方案：  不想多说了   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-17 12:38 厂商回复：  漏洞Rank：20  (WooYun评价) 最新状态： 2014-05-27：CNVD确认并复现所述情况，由CNVD通过公开联系渠道向软件生产厂商深圳市福洽科技有限公司通报，发邮箱120982@qq.com, umailtry@comingchina.com, Services@comingchina.com处置。  ", "replys": "漏洞评价：\n评论\n     2014-05-22 13:48 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1344 漏洞数:216        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  路人甲是最大的土豪    \n     2014-05-22 14:38 |    \t\t冰冻冷咖啡 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 菜鸟一只)\t\t \n  路人甲/.....    \n     2014-05-22 17:47 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  难道是那个黑名单过滤机制？别匿啊，    \n     2014-05-27 13:33 |    \t\tBird \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:25        | Stay hungry. Stay foolish.)\t\t \n  你拿下了邮件系统也拿不到钱。。。同学。。。money的数据库和邮件是明显隔绝的。。。    \n     2014-08-18 15:06 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  还是有很多没修复啊    \n     2014-11-20 20:59 |    \t\t波总z \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 本人学计算机网络这方面的，很高兴加入到你...)\t\t \n  怎么上传的文件  需要登录邮箱呀。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}