{"id": 9740, "wybug_id": "wooyun-2013-032632", "wybug_title": "天津大学录取查询系统struts2漏洞（详细利用过程与修复方案）", "wybug_corp": "天津大学", "wybug_author": "b33", "wybug_date": "2013-07-29 19:23", "wybug_open_date": "2013-09-12 19:23", "wybug_type": "成功的入侵事件", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方框架", "渗透测试思路"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-07-29：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2013-09-12：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 天津大学录取查询系统存在struts2 s2-016漏洞，可导致学生信息及数据库内的所有信息泄露。若被非法利用，可添加录取数据进行诈骗。 详细说明：  漏洞原理：Struts2下DefaultActionMapper中的handleSpecialParameters方法可以用action、redirect、 redirectAction对写入数据进行处理，从而改变前缀参数，这样操作的目的是方便表单中的操作。在2.3.15.1版本以前的struts2中，没有对action、redirect、 redirectAction等进行过滤处理，导致ongl表达式可以被执行。\n\n图(0)天津大学的录取查询系统使用了2.3.15.1之前的版本，导致出现了上述的严重安全问题。   漏洞证明：  一、经检测，以下页面存在struts2命令执行漏洞http://121.193.130.44/zs/search.actionroot 权限（见图1），可执行任意命令（见图2），可上传webshell\n\n图(1)\n\n图(2)二、利用该漏洞成功上传webshell\n\n图(3)三、找到配置文件内的数据库信息并成功连接\n\n图(4)\n\n图(5)\n\n图(6)\n\n图(7)四、成功写入HTML页面至该系统根目录下http://121.193.130.44/zs/1.html\n\n图(8)\n\n图(9)   修复方案：  此方法可修补S2-016、S2-017漏洞重写struts2 DefaultActionMapper的handleSpecialParameters方法，增加action、redirect、redirectAction等参数的过滤。操作步骤：1、新建com/website/struts2/MyDefaultActionMapper.java，代码如下：\n/** * zhounenghua@163.com copyright */package com.website.struts2;/** * @author jason.zhou * @date 2013-7-18 */public class MyDefaultActionMapper extends DefaultActionMapper {    public void handleSpecialParameters(HttpServletRequest request, ActionMapping mapping) {        Set uniqueParameters = new HashSet();        Map parameterMap = request.getParameterMap();        for (Iterator iterator = parameterMap.keySet().iterator(); iterator.hasNext();) {            String key = (String) iterator.next();            if ((key.endsWith(\".x\")) || (key.endsWith(\".y\"))) {                key = key.substring(0, key.length() - 2);            }            // -- jason.zhou 20130708 add start -- //            if ((key.contains(\"redirect:\")) || (key.contains(\"redirectAction:\")) || (key.contains(\"action:\"))) {                return;            }            // -- jason.zhou 20130708 add end -- //                        if (!uniqueParameters.contains(key)) {                ParameterAction parameterAction = (ParameterAction) this.prefixTrie.get(key);                if (parameterAction != null) {                    parameterAction.execute(key, mapping);                    uniqueParameters.add(key);                    break;                }            }        }    }}\n2、复制MyDefaultActionMapper.class 到 /com/website/struts2/目录。3、在struts.xml文件中添加如下代码：\n<bean type=\"org.apache.struts2.dispatcher.mapper.ActionMapper\" name=\"myDefaultActionMapper\" class=\"com.website.struts2.MyDefaultActionMapper\" />     <constant name=\"struts.mapper.class\" value=\"myDefaultActionMapper\" />\n4、重启服务器。   版权声明：转载请注明来源 b33@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2013-07-29 22:19 |    \t\t在路上 \t\t\t( 普通白帽子  |\t\t\t        Rank:193 漏洞数:13        | 在学习的路上、在成长的路上...)\t\t \n  不是吧 随便上天大？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}