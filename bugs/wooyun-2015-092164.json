{"id": 46180, "wybug_id": "wooyun-2015-092164", "wybug_title": "360安全路由某版本固件源码中发现多处安全隐患（PHP代码逻辑）", "wybug_corp": "奇虎360", "wybug_author": "Matt", "wybug_date": "2015-01-16 19:28", "wybug_open_date": "2015-03-02 19:28", "wybug_type": "应用配置错误", "wybug_level": "中", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-02：\t细节向公众公开  简要描述： 360安全路由某版本固件源码中发现多处安全隐患 详细说明：  /*由于手头上没有360路由，暂且一切都是从代码层面上来看的。理论上漏洞是存在的。*/先用binwalk导出了360路由的固件发现其用的是php写的web模块，其中指令的交互是与本机的5000端口进行通信实现的，包括重启等动作。   漏洞证明：  并且验证代码存在多处漏洞1 unserialize  在userclient的模块中，  验证用户的时候，首先通过读取cookie中的qty的值进行unserialize  所以这里存在一个潜在的威胁\n```PHP  \tpublic function GetData()\t{\t\tglobal $_COOKIE;\t\t$ArrRet\t= Array();\t\t$sQRT\t= array_key_exists( self::COOKIE_NAME, $_COOKIE ) ? $_COOKIE[ self::COOKIE_NAME ] : '';\t\t$sQRT\t= trim( $sQRT );\t\tif ( ! empty( $sQRT ) )\t\t{\t\t\t$sQRT\t= @ stripslashes( $sQRT );\t\t\t$ArrTmp\t= @ unserialize( $sQRT );//存在的点\t\t\tif ( is_array( $ArrTmp ) && count( $ArrTmp ) )\t\t\t{\t\t\t\t$ArrRet = $ArrTmp;\t\t\t}\t\t}\t\treturn $ArrRet;\t}  ```\n2 dev_mod  360的开发者模式存在俩种判断模式  1 手动开启了开发者模式  2 HTTP_HOST=127.0.0.1  在第二种模式中 我们完全可以通过      GET http://192.168.1.1/ HTTP/1.0  Host: 127.0.0.1  这样的请求达到请求的HOST是127.0.0.1  从而绕过他对HOST的判断\n```PHP  function _is_dev_env() {    if (defined ( '_is_dev_env_cache' )) {        return true;    }        if (0 == strcasecmp ( '127.0.0.1', $_SERVER ['HTTP_HOST'] )) { //漏洞点        define ( '_is_dev_env_cache', 1 );        return true;    }        return false;}  ```\n  绕过开发者模式到底能看什么呢，就不用细说了，看下面的文件列表大概就知道了 \nroot@kali:~/Desktop/_360_Original_0605.bin.extracted/squashfs-root# grep -n -r \"IsDebug\" *\tgrep: home: 没有那个文件或目录\twww/mag/incfsmag/CMagWifi.php:28:      if ($this->IsDebug()) {\twww/mag/incfsmag/CMagWifi.php:64:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagWifi.php:79:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagWifi.php:118:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagWifi.php:135:  \tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagWifi.php:165:\t    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagNetwork.php:49:\t\t\tif ( parent::IsDebug() ) {\twww/mag/incfsmag/CMagNetwork.php:102:\t\t\tif ( parent::IsDebug() ) {\twww/mag/incfsmag/CMagNetwork.php:149:\t\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagLoginChange.php:20:  \tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagLoginChange.php:59:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagBase.php:16:  public function IsDebug() {\twww/mag/incfsmag/CMagWatt.php:19:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagWatt.php:44:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagDevice.php:25:\t\t\tif (parent::IsDebug ()) {\twww/mag/incfsmag/CMagDevice.php:91:\t\t\tif (parent::IsDebug ()) {\twww/mag/incfsmag/CMagOptimize.php:36:        if ( parent::IsDebug() )\twww/mag/incfsmag/CMagReboot.php:29:\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagMacClone.php:20:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagMacClone.php:47:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagInfo.php:35:\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagDeviceList.php:34:\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagDeviceList.php:211:\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagDeviceList.php:270:\t\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagDhcp.php:23:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagDhcp.php:41:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagDhcp.php:67:    if ($this->IsDebug()) {\twww/mag/incfsmag/CMagDeviceBlackList.php:14:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagProtect.php:36:\t\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagProtect.php:44:\t\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagProtect.php:234:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagProtect.php:264:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagProtect.php:294:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagProtect.php:314:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagProtect.php:328:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagUpgrade.php:25:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagUpgrade.php:35:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagUpgrade.php:54:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagUpgrade.php:94:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagUpgrade.php:112:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagUpgrade.php:133:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CMagUpgrade.php:163:\t\tif ($this->IsDebug ()) {\twww/mag/incfsmag/CDiagnose.php:13:\t\tif ( parent::IsDebug() )\twww/mag/incfsmag/CMagFirstLaunch.php:22:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagFirstLaunch.php:40:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagFirstLaunch.php:52:\t\tif ($this->IsDebug()) {\twww/mag/incfsmag/CMagFirstLaunch.php:125:\t\tif ($this->IsDebug()) {\n3 后门or正常服务？\nclass CMagReboot extends CMagBase\t{\t\tconst SERVER_ADDR\t= '127.0.0.1';\t\tconst SERVER_PORT\t= 5000;\n\t基本通讯功能都是与这个端口进行通信，\t暂且不知道这个端口只是单独绑定在127还是绑定在所有的网卡上的4 修改任意配置？\t我猜这个要么是手机客户端使用的，要么是web的时候ajax请求，\t不管怎么说这是一个验证的错误 \najax_execute.php\t\t$cmd = isset($_REQUEST['cmd']) ? $_REQUEST['cmd'] : \"\";$skipReferCheck = (0 == strcasecmp ('isinited_start', $cmd));if (!$skipReferCheck) {\t_check_refer();//检测来路，来路是不是Luyou360.com 这个绕过不用说罢}//login_verify_start //isinited_start// 开绿灯$skipInitedCheck = \t(0 == strcasecmp ('login_verify_start', $cmd) \t||0 == strcasecmp ('isinited_start', $cmd) );if (!$skipInitedCheck) {\t$ajaxBase = new AjaxBase();\t$ajaxIsInited = new AjaxIsInited();\t$isDebug = $ajaxBase->isDebug(); \tif (!$isDebug && $ajaxIsInited->isInitedSucc()) {\t\techo \"yyyy\";\t\texit();\t}}$result = null;$ajaxMap = new AjaxMap();try {    $worker = $ajaxMap->Parse($cmd);//这边可以调用一些模块    if (!empty($worker)) {        $result = $worker['o']->execute($worker['p']);    }} catch (Exception $e) {}if (empty ( $result )) {    $result = getResultArray( SRConst::SR_ERROR_UNKNOWN );}header( 'Content-type: text/html; charset=utf-8' );echo @ json_encode(is_array($result) ? $result : Array());\n这里是大致可以调用的模块，但是模块的参数都是加密的很多模块哦，什么改ssid密码，拨号密码什么的ajaxmap.php \nvar $cmdMap = Array(        'login_verify_start'\t=> Array('c' => 'AjaxLoginVerify', 'p' => Array('cmd', 'userpwd')),\t        \t\t'islogin_start'\t\t=> Array( 'c' => 'AjaxIsLogin', 'p' => Array('cmd', 'isblock')),\t\t'isinited_start'\t=> Array( 'c' => 'AjaxIsInited', 'p' => Array('cmd', 'isblock')),\t\t'initpwd_start'\t\t=> Array( 'c' => 'AjaxInitPwd', 'p' => Array('cmd', 'userpwd','isblock')),\t\t'dwt_start'\t\t=> Array( 'c' => 'AjaxDetectWLanType', 'p' => Array('cmd')),\t\t'dwt_read'\t\t=> Array( 'c' => 'AjaxDetectWLanType', 'p' => Array('cmd')),\t\t'loginpppoe_start'\t=> Array( 'c' => 'AjaxPPPOE', 'p' => Array('cmd', 'username', 'userpwd', 'dns_type', 'dns1', 'dns2')),//比如这个可以修改dns配置和pppoe配置\t\t'loginpppoe_read'\t=> Array( 'c' => 'AjaxPPPOE', 'p' => Array('cmd')),\t\t\t\t'loginpppoesp_start'\t=> Array( 'c' => 'AjaxPPPOESpecial', 'p' => Array('cmd', 'username', 'userpwd', 'dns_type', 'dns1', 'dns2', 'area')),\t\t'loginpppoesp_read'\t=> Array( 'c' => 'AjaxPPPOESpecial', 'p' => Array('cmd')),\t\t'wanstatic_start'\t=> Array( 'c' => 'AjaxWanStatic', 'p' => Array('cmd', 'ip', 'mask', 'gate', 'dns_type', 'dns1', 'dns2')),\t\t'wanstatic_read'\t=> Array( 'c' => 'AjaxWanStatic', 'p' => Array('cmd')),\t\t'wandhcp_start'\t\t=> Array( 'c' => 'AjaxWanDHCP', 'p' => Array('cmd', 'dns_type', 'dns1', 'dns2')),\t\t'wandhcp_read'\t\t=> Array( 'c' => 'AjaxWanDHCP', 'p' => Array('cmd')),\t\t'wconfig_start'\t\t=> Array( 'c' => 'AjaxConfigWLan', 'p' => Array('cmd', 'ssid', 'sspwd', 'isblock')),//比如这个可以修改ssid的名字密码\t\t'wconfig2_start'\t=> Array( 'c' => 'AjaxConfigWLan2', 'p' => Array('cmd', 'ssid', 'sspwd','userpwd'))\t\t\t\t);\n\t大概都是这么加密的\t\t// 解密\n$primarykey = parent::getAesKeyLen16();//aes看到我就吓尿了，\t\t$username = lib_aes_decrypt($primarykey, $username);\t\t$password = lib_aes_decrypt($primarykey, $password);\t\t//check params\t\tif (empty($username) || empty($password) ||\t\t    $dns_type < 0 || $dns_type > 2) {\t\t\treturn parent::getReturnJsonStruct(SRConst::SR_ERROR_PARAMETER);\t\t}\t\t传说中的key到手了，那我还不横着走？\t\tCMagBase.php\t\t public function  getAesKeyLen16(){\t\t\treturn '360luyou#install';\t\t  }\n    修复方案：  你猜   版权声明：转载请注明来源 Matt@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2015-01-19 15:57 厂商回复： 此报告涉及产品为老款的360安全路由，我们已修复相关漏洞隐患，新的固件将很快发布在官网论坛上。关于通信端口的问题，由于已绑定了127.0.0.1的网卡，任何外部请求都无法访问。感谢白帽子对360安全路由的关注！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-16 19:30 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:78        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  安全路由~    \n     2015-01-16 20:48 |    \t\txy小雨 \t\t\t( 普通白帽子  |\t\t\t        Rank:171 漏洞数:47        | 成为海贼王的男人)\t\t \n  打脸了    \n     2015-01-16 21:12 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:259        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  10W大奖吗？    \n     2015-01-16 23:32 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:87        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  P1 么    \n     2015-01-19 16:03 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:170        | 力不从心)\t\t \n  哟哟哟哟哟！    \n     2015-03-03 01:19 |    \t\tTh1nk \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:21        | 关注苍老师与波多野老师)\t\t \n  求一份源码    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}