{"id": 57643, "wybug_id": "wooyun-2014-053773", "wybug_title": "Maccms V8 Sql Injection #2", "wybug_corp": "maccms.com", "wybug_author": "′雨。", "wybug_date": "2014-03-16 20:44", "wybug_open_date": "2014-06-14 20:45", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-14：\t细节向公众公开  简要描述： 现在 V8版本 基本全部文件都有zend加密了。   只有那么少数的几个文件没加密。。 我就看看那几个把。。 详细说明：  在inc/user/alipay/notify_url.php中\n$alipayNotify = new AlipayNotify($alipay_config);$verify_result = $alipayNotify->verifyNotify();$verify_result_2 = $alipayNotify->verifyReturn();if($verify_result) {//验证成功\t/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\t//请在这里加上商户的业务逻辑程序代\t//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——\t    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表\t//商户订单号\t$out_trade_no = $_POST['out_trade_no'];\t//支付宝交易号\t$trade_no = $_POST['trade_no'];\t//交易状态\t$trade_status = $_POST['trade_status'];\t\t\tif($_POST['trade_status'] == 'WAIT_BUYER_PAY') {\t\t//该判断表示买家已在支付宝交易管理中产生了交易记录，但没有付款\t\t//判断该笔订单是否在商户网站中已经做过处理\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t//如果有做过处理，不执行商户的业务程序\t\t        echo \"success\";\t\t//请不要修改或删除\t\t        //调试用，写文本函数记录程序运行情况是否正常        //logResult(\"这里写入想要调试的代码变量值，或其他运行的结果记录\");    }\telse if($_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS' || $_POST['trade_status'] == 'TRADE_FINISHED') {\t\t//该判断表示买家已在支付宝交易管理中产生了交易记录且付款成功，但卖家没有发货\t\t//判断该笔订单是否在商户网站中已经做过处理\t\t//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序\t\t//如果有做过处理，不执行商户的业务程序\t\t$db = new AppDb($MAC['db']['server'],$MAC['db']['user'],$MAC['db']['pass'],$MAC['db']['name']);\t\t$sql ='select * from {pre}user_pay where p_status=0 and p_order='.$out_trade_no;\t\t\t\t$row = $db->getRow($sql);\t\tif($row){\t\t\t$point = $row['p_point'];\t\t\t$db->query(\"update {pre}user set u_points=u_points+\".$point.\" where u_id = \". $row[\"p_uid\"]);\t\t\t$db->query(\"update {pre}user set p_status=1 where p_order=\".$out_trade_no);\t\t}\nalipay的验证。 我们就来满足这个验证就行了。\nfunction verifyNotify(){\t\tif(empty($_POST)) {//判断POST来的数组是否为空\t\t\treturn false;\t\t}\t\telse {\t\t\t//生成签名结果\t\t\t$isSign = $this->getSignVeryfy($_POST, $_POST[\"sign\"]);\t\t\t//获取支付宝远程服务器ATN结果（验证是否是支付宝发来的消息）\t\t\t$responseTxt = 'true';\t\t\tif (! empty($_POST[\"notify_id\"])) {$responseTxt = $this->getResponse($_POST[\"notify_id\"]);}\t\t\t\t\t\t//写日志记录\t\t\t//if ($isSign) {\t\t\t//\t$isSignStr = 'true';\t\t\t//}\t\t\t//else {\t\t\t//\t$isSignStr = 'false';\t\t\t//}\t\t\t//$log_text = \"responseTxt=\".$responseTxt.\"\\n notify_url_log:isSign=\".$isSignStr.\",\";\t\t\t//$log_text = $log_text.createLinkString($_POST);\t\t\t//logResult($log_text);\t\t\t\t\t\t//验证\t\t\t//$responsetTxt的结果不是true，与服务器设置问题、合作身份者ID、notify_id一分钟失效有关\t\t\t//isSign的结果不是true，与安全校验码、请求时的参数格式（如：带自定义参数等）、编码格式有关\t\t\tif (preg_match(\"/true$/i\",$responseTxt) && $isSign) {\t\t\t\treturn true;\t\t\t} else {\t\t\t\treturn false;\t\t\t}\t\t}\t}\n必须两个都匹配出true。\nfunction getSignVeryfy($para_temp, $sign) {\t\t//除去待签名参数数组中的空值和签名参数\t\t$para_filter = paraFilter($para_temp);\t\t\t\t\t\t//对待签名参数数组排序\t\t$para_sort = argSort($para_filter);\t\t\t\t//把数组所有元素，按照“参数=参数值”的模式用“&”字符拼接成字符串\t\t$prestr = createLinkstring($para_sort);\t\t\t\t\t$isSgin = false;\t\tswitch (strtoupper(trim($this->alipay_config['sign_type']))) {\t\t\tcase \"MD5\" :\t\t\t\t$isSgin = md5Verify($prestr, $sign, $this->alipay_config['key']);\t\t\t\tbreak;\t\t\tdefault :\t\t\t\t$isSgin = false;\n然后就是md5一次。 相等则true。   漏洞证明：  \n\n来看看执行的语句。\n\n   修复方案：  无尽的过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-03-16 20:47 厂商回复： 漏洞已确认，正在着手修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}