{"id": 33096, "wybug_id": "wooyun-2015-0109606", "wybug_title": "JTBC(CMS)SQL注入漏洞一枚", "wybug_corp": "JTBC", "wybug_author": "命途多舛", "wybug_date": "2015-04-24 15:46", "wybug_open_date": "2015-06-08 15:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["数字类型注射", "源码审核", "注射漏洞利用技巧", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-24：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-06-08：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 亲，http://wooyun.org/bugs/wooyun-2010-046456这都过了，我有什么道理不通过，别说我们的是一样的 详细说明：  1.首先定位到漏洞文件。passport\\common\\incfiles\\manage_config.inc.php。\nfunction jtbc_cms_module_manage_usersetdisp(){  $tbackurl = $_GET['backurl'];  global $conn;  global $ndatabase, $nidfield, $nfpre;  global $nusername;  $tsqlstr = \"select * from $ndatabase where \" . ii_cfname('username') . \"='$nusername'\";  $trs = ii_conn_query($tsqlstr, $conn);  $trs = ii_conn_fetch_array($trs);  if ($trs)  {    global $face_width_max, $face_height_max;    $tface_width = ii_get_num($_POST['face_width']);    $tface_height = ii_get_num($_POST['face_height']);    if ($tface_width > $face_width_max) $tface_width = $face_width_max;    if ($tface_height > $face_height_max) $tface_height = $face_height_max;    $tsqlstr = \"update $ndatabase set    \" . ii_cfname('face') . \"=\" . ii_get_num($_POST['face']) . \",    \" . ii_cfname('face_u') . \"=\" . ii_get_num($_POST['face_u']) . \",    \" . ii_cfname('face_url') . \"='\" . ii_left(ii_cstr($_POST['face_url']), 255) . \"',//这里是主要的问题所在    \" . ii_cfname('face_width') . \"=$tface_width,    \" . ii_cfname('face_height') . \"=$tface_height,    \" . ii_cfname('sign') . \"='\" . ii_left(ii_cstr($_POST['sign']), 100) . \"'    where \" . ii_cfname('username') . \"='$nusername'\";    $trs = ii_conn_query($tsqlstr, $conn);    if ($trs) mm_imessage(ii_itake('global.lng_public.edit_succeed', 'lng'), $tbackurl);    else mm_client_alert(ii_itake('global.lng_public.sudd', 'lng'), $tbackurl);  }  else mm_client_alert(ii_itake('global.lng_public.sudd', 'lng'), $tbackurl);}\n2.$_POST['sign']在传入数据库之前，通过了两个函数ii_cstr和ii_left。定位到两个函数\nfunction ii_cstr($strers){  if (get_magic_quotes_gpc()) return $strers;  else return addslashes($strers);}\n\nfunction ii_left($strers, $len, $type = 0){  if (!(ii_isnull($strers)))  {    if ($type == 0) return mb_substr($strers, 0, $len, CHARSET);    else return substr($strers, 0, $len);  }}\n3.可以看出，ii_cstr是对传入的参数进行了addslashes的操作，ii_left是去字符的前多少位。那么问题来了，如果我们取前255位，传入的字符刚好是255个，最后一位是单双引号之一。那么经过截取，最后一位就只剩下反斜线。构造我们的payload，如测试代码所示。\n\n   漏洞证明：  本地的：\n\n互联网案列http://www.sunka-sh.com\n\nhttp://www.ooo0.net/参考上一个的案列吧。谷歌百度搜索：Copyright 2004-2015 JTBC(CMS)，找php版本的就可以了   修复方案：  过滤   版权声明：转载请注明来源 命途多舛@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}