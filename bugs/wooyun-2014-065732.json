{"id": 1175, "wybug_id": "wooyun-2014-065732", "wybug_title": "Ecmall Sql 注入 第二弹", "wybug_corp": "ShopEx", "wybug_author": "′雨。", "wybug_date": "2014-06-26 16:41", "wybug_open_date": "2014-09-24 16:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-24：\t细节向公众公开  简要描述： 已打上20140618补丁。再来试试。 详细说明：  在app/my_goods.app.php中\nfunction spec_edit()   {        $id = isset($_GET['id']) ? intval($_GET['id']) : 0;        if (!IS_POST)        {            $goods_spec = $this->_goods_mod->findAll(array(                'fields' => \"this.goods_name,this.goods_id,this.spec_name_1,this.spec_name_2\",                'conditions' => \"goods_id = $id\",                'include' => array('has_goodsspec' => array('order'=>'spec_id')),            ));            header('Content-Type:text/html;charset=' . CHARSET);            $this->assign('goods', current($goods_spec));            $this->display(\"spec_edit.html\");        }        else        {  \t\t             $data = $this->save_spec($_POST);\t            if (empty($data))            {                $this->pop_warning('not_data');            }            $default_spec = array(); // 更新商品中默认规格的信息            foreach ($data as $key => $val)            {                 if (empty($default_spec))                {                    $default_spec = array('price' => $val['price']);                }                $this->_spec_mod->edit($key, $val);            }            $this->_goods_mod->edit($id, $default_spec);            $this->pop_warning('ok', 'my_goods_spec_edit');        }   }\n来看看这个 $data = $this->save_spec($_POST);\nfunction save_spec($spec)   {           $data = array();\t        if (empty($spec['price']) || empty($spec['stock']))        {            return $data;        }        foreach ($spec['price'] as $key => $val)        {            $data[$key]['price'] = $this->_filter_price($val);        }        foreach ($spec['stock'] as $key => $val)        {            $data[$key]['stock'] = intval($val);        }        return $data;   }\n这里return的是data。 在这里 $spec['stock']  被intval了。 $data[$key]['price'] = $this->_filter_price($val);\nfunction _filter_price($price)    {        return abs(floatval($price));    }}\n返回非浮点 。 所以这里data的value 是不可控的 但是 key是可控的 继续看。\nforeach ($data as $key => $val)            {                 if (empty($default_spec))                {                    $default_spec = array('price' => $val['price']);                }                $this->_spec_mod->edit($key, $val);            }\nkey 带入到了edit中 继续看\nfunction edit($conditions, $edit_data)    {         if (empty($edit_data))        {            return false;        }        $edit_data = $this->_valid($edit_data);        if (!$edit_data)        {            return false;        }        $edit_fields = $this->_getSetFields($edit_data);        $conditions  = $this->_getConditions($conditions, false);        $this->db->query(\"UPDATE {$this->table} SET {$edit_fields}{$conditions}\");        return $this->db->affected_rows();\n 拼语句。 直接注入。 在618补丁中还加入放注入的了。但是还是勉强能过。   漏洞证明：  首先注册一个会员 然后发布一个商品。\n\n   修复方案：  限制一下key把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-06-26 16:54 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-26 16:46 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   你们确认的时候注意下吧 你们的20140618补丁中添加的防注入是可以勉强绕过的。参照图中的 你们可以测试测试。    \n     2014-06-26 18:00 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  有时间我也撸一发    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}