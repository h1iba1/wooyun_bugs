{"id": 363, "wybug_id": "wooyun-2014-070353", "wybug_title": "qibocms多个系统绕过补丁继续注入2", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-07-31 17:04", "wybug_open_date": "2014-10-29 17:06", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向公众公开  简要描述： 之前发了补丁被绕过了, 现在又发布了补丁。  今天上午的时候看了看补丁。 第一眼觉得很牛逼。  然后觉得这补丁很吊,就放下了。下午的时候又继续看了看补丁 原来还是可以绕过。依旧是通杀多个系统。由于是通用的函数, 所以能造成注入的点不止一处。用v7整站系统 再随便找一个点来说就行啦。 详细说明：  再来看看一下 qibocms的全局过滤函数\n$_POST=Add_S($_POST);$_GET=Add_S($_GET);$_COOKIE=Add_S($_COOKIE);\n\nfunction Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t@eregi(\"['\\\\\\\"&]+\",$key) && die('ERROR KEY!');\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n这里把数组中的value addslashes 转义了但是没有对key addslashes  (这里应该也不能做addslashes 因为会像上次那样绕过)可以看到是把过滤key的代码换了 之前是replace  可以绕过现在是 @eregi(\"['\\\\\\\"&]+\",$key) && die('ERROR KEY!');我擦, 看起来很叼的样子。 匹配到' 或者 \" 或者\\ 就直接退出。当我第一眼看到的时候 觉得很叼   就放下了qibo。 睡觉去了。________________________________________________________________________到了下午 精神倍棒依旧 我们自己来写一个文件测试一下再调用一下qibo的这函数\n<?php  $_GET=Add_S($_GET[a]);function Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t@eregi(\"['\\\\\\\"&]+\",$key) && die('ERROR KEY!');\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n\n\n碉堡 key中的单引号被匹配到了 被退出了但是换一种方式呢  这里我输出一下$key\n\n可以看到提交web.com/yu.php?a[a'][asd]=a 的时候 那么进入过滤函数的时候的key是asd那么就不会被匹配到 就不会被过滤了。那么我们不就是绕过了这个过滤了?___________________________________________________________________________绕过了这个随便找个点来说在member/post.php中\nelseif($job=='manage'){\tif(!$atc_power)showerr(\"你没权限\");\tif($rsdb[pages]<2){\t\theader(\"location:post.php?job=edit&aid=$aid&mid=$mid&only=$only\");exit;\t}\t$erp=get_id_table($aid);\tif($step==2){\t\tasort($orderDB);\t\t$i=0;\t\tforeach( $orderDB AS $key=>$value){\t\t\t$i++;\t\t\t$db->query(\"UPDATE {$pre}reply$erp SET orderid=$i WHERE aid='$aid' AND rid='$key'\");\t\t}\t\trefreshto(\"$FROMURL\",\"排序成功\",1);\t}\nforeach 出来的key没有过滤 直接带入到了查询当中\n\n直接提交key被匹配出  像刚才那样绕过一下\n\n这样进行检测的key 是asd  但是 带入查询的 而是那段含单引号的key。造成了注入。   漏洞证明：  \n\n   修复方案：  这个我真心也不知道怎么过滤了。。 还是看你们把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-01 10:20 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-31 17:06 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  雨神  求你放过齐伯吧，他老人家年纪大了，经不起你天天折腾    \n     2014-07-31 17:07 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  我感觉你看代码，从未间断...    \n     2014-07-31 17:13 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @贫道来自河北 @felixk3y 放假了   哈哈 时间挺多。    \n     2014-07-31 17:15 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  能不能 不要这么叼    \n     2014-07-31 17:17 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  这都绕了多少次了，程序员在干嘛呢。。    \n     2014-07-31 17:19 |    \t\t果冻好吃 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:11        | 大学通知书下来那天，我迫不及待的用四百块...)\t\t \n  齐博会把你收了！    \n     2014-07-31 17:30 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  ......    \n     2014-07-31 17:46 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  齐伯没有女儿，你要搅基吗    \n     2014-07-31 18:06 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  不会是同一个问题吧？！改来改去没改到正道上。。。    \n     2014-07-31 18:38 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @xfkxfk  这两次的补丁改的还是挺有进步。    \n     2014-07-31 22:01 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  苦逼的厂商    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}