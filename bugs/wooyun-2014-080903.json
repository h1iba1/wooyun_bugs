{"id": 44010, "wybug_id": "wooyun-2014-080903", "wybug_title": "mallbuilder多用户商城系统SQL注入", "wybug_corp": "shop-builder.cn", "wybug_author": "nextdoor", "wybug_date": "2014-10-29 15:03", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-03：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： mallbuilder多用户商城系统SQL注入 详细说明：  系统 MallBuilder_v5.8.1.1典型的XFF注入\nregister.php文件if(!empty($_POST['user'])&&strtolower($_POST['yzm'])==strtolower($_SESSION['auth'])){\tif($config['closetype']==2)\t{\t//关闭注册\t\tdie('access dined!');\t}\tif($config['user_reg_verf'])\t{\t//验证码不对\t\tif(trim($_POST['ckyzwt'])!=trim($_SESSION['YZWT']))\t\t\t die(\"Verification question error...\");\t}\tif($config['inhibit_ip']==1)\t{\t//ip禁止注册\t\t$ip=getip();\t\tif(empty($ip))\t\t\tdie(\"Can not get you IP...\");\t\telse\t\t{\t\t\t\t$config['exception_ip']=explode(\"\\r\\n\",$config['exception_ip']);\t\t\tif(!in_array($ip,$config['exception_ip']))\t\t\t{\t\t\t\t$sql=\"select ip from \".MEMBER.\" where ip='$ip'\";\t\t\t\t$db->query($sql);\t\t\t\tif($db->num_rows())\t\t\t\t\tdie(\"Your IP has been registered...\");\t\t\t\tunset($sql);\t\t\t}\t\t}\t}\tif($config['openbbs']==2)\t{\t//关联UCHENTER\t\tinclude_once('uc_client/client.php');\t\t$user=trim($_POST['user']);\t\t$pass=trim($_POST['password']);\t\t$email=trim($_POST['email']);\t\t$regtime=time();\t\t$uid = uc_user_register($user, $pass, $email);\t\tif($uid>0)\t\t{\t\t\tdoreg($uid); //\t\t}\t}\telse\t\tdoreg();//跟踪doreg函数}register.php文件doreg函数function doreg($guid=NULL){\tglobal $db,$config,$ip;\t$user=$_POST['user'];\t$pass=$_POST['password'];\t$email=$_POST['email'];\t$ip=getip();$ip=empty($ip)?NULL:$ip; //看看getip()参数\t$lastLoginTime=time();\t$regtime=date(\"Y-m-d H:i:s\");\t$user_reg=$config['user_reg']==3?\"1\":\"2\";\t\t$sql=\"select * from \".MEMBER.\" where user='$user'\";    $db->query($sql);    if($db->num_rows())\t\tdie(\"User name is have\");\t\t$sql=\"insert into \".MEMBER.\" (user,password,ip,lastLoginTime,email,regtime,statu) values ('$user','\".md5($pass).\"','$ip','$lastLoginTime','$email','$regtime','$user_reg')\"; //$ip未过滤进入sql语句,传统的过滤gpc参数的过滤无效\t$re=$db->query($sql);\t$userid=$db->lastid();\t$sql=\"update \".MEMBER.\" set number='$userid' where userid='$userid'\";\t$re=$db->query($sql);\t\t\t\tif($userid)\t{\t\t\t$points=$config['reg_points']?$config['reg_points']:\"0\";\t\t$sql=\"INSERT INTO \".MEMBERCOUNT.\" (member_id,points) VALUES ('$userid','$points')\"; \t\t$re=$db->query($sql);\t\tif($points>0)\t\t{\t\t\tinclude_once(\"$config[webroot]/module/member/includes/plugin_member_class.php\");\t\t\t$member=new member();\t\t\t$flag=$member->add_points($points,'5','',$userid);\t\t}\t\tif($re)\n\ninclues/convertip.php中getip函数function getip(){\tif (isset($_SERVER))\t{\tif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {\t   $realip = $_SERVER['HTTP_X_FORWARDED_FOR'];\t} elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {\t   $realip = $_SERVER['HTTP_CLIENT_IP'];\t} else {\t   $realip = $_SERVER['REMOTE_ADDR'];\t}\t} else {\tif (getenv(\"HTTP_X_FORWARDED_FOR\")) {\t   $realip = getenv( \"HTTP_X_FORWARDED_FOR\");\t} elseif (getenv(\"HTTP_CLIENT_IP\")) {\t   $realip = getenv(\"HTTP_CLIENT_IP\");\t} else {\t   $realip = getenv(\"REMOTE_ADDR\");\t}\t}\treturn $realip;}\n   漏洞证明：  漏洞证明：\n\n\n\n   修复方案：  另一处用convertip()过滤了，这一处为啥没过滤呢   版权声明：转载请注明来源 nextdoor@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-31 12:16 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  你这个不会和我那个重复？求企鹅交流~~    \n     2014-10-31 12:51 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  @郭斯特 上08安全交流群    \n     2014-10-31 12:54 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  @郭斯特 上08安全交流群    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}