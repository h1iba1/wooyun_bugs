{"id": 2064, "wybug_id": "wooyun-2014-061295", "wybug_title": "大汉版通系统再再次getshell之3", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "路人甲", "wybug_date": "2014-05-18 19:08", "wybug_open_date": "2014-08-16 19:10", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传安全", "文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-16：\t细节向公众公开  简要描述： 大汉版通系统再再次getshell之3，同样存在两处.. 详细说明：  注：该系统为信息公开系统(xxgk)#1 漏洞文件\n/xxgk/m_5_e/module/opr_module.jsp?fn_billstatus=1/xxgk/m_5_e/module/review/opr_review_template.jsp\n由于第二个文件的上传比较有意思，我们选择其贴下关键的代码\n//上传if (strStatus.equals(\"S\")) {\tblf.doUpload(request);\tout.println(Convert.getAlterScript(\"parent.location='./opr_review_template.jsp'\"));\treturn;}\n这两个上传也仅在客户端进行验证\n<script language=\"javascript\"><!--\tfunction GetFileExtension(name)\t{\t\tvar ext = name.substring(name.lastIndexOf(\".\") + 1, name.length);\t\treturn ext.toLowerCase();\t}\tfunction jsUpload()\t{\t\t\t\tvar obj = document.uploadmodal.upfile;\t\tvar objImg = document.uploadmodal.upfile1;\t\tif( obj.value == \"\" && objImg.value == \"\" ){\t\t\talert(\"请选择要上传的文件!\");\t\t\tobj.focus();\t\t\treturn false; \t\t}\t\t\t\tvar ext = GetFileExtension( obj.value );\t\tvar extimg = GetFileExtension( objImg.value );\t\t//...\t\tif( extimg != \"\" && extimg != \"zip\" ){\t\t\talert(\"图片文件格式应该为：zip文件, 请重新选择!\");\t\t\tobj.focus();\t\t\treturn false;\t\t}\t\tvar page = \"./opr_review_template.jsp?status=S&modaltype=-1\";\t\tdocument.uploadmodal.action = page;\t\treturn true;\t\t}}</script>\n这里既然可以上传 zip 格式的文件，程序肯定会解压缩ZIP包，那么，假如我们在ZIP包里隐藏了我们想要上传的恶意文件，而恰巧程序解压后，并不会删除这些文件，那么不就直接getshell了吗?#2 漏洞测试有了这些想法，那么我们就来测试测试，程序的逻辑是不是真如我们想象的那样..那么，我们首先将要上传的文件打包成zip，这里为shell.zip\n\n由于这套系统网上的实例很多，随机选取两个进行测试..测试一：\nhttp://xxgk.lyg.gov.cn//xxgk/m_5_e/module/review/opr_review_template.jsp\n打开此页面后，直接上传我们的shell.zip，点击提交即可在服务器上解压并生成Customize.jsp路径为：\n/xxgk/jcms_files/jcms1/web0/site/zfxxgk/letterbox/template/-1/文件名注：经过多个测试，一般情况都为此路径，极少部分 有可能会更改jcms1 web0后面的数字\n连接shell,如图所示\n\n测试二：\nhttp://xxgk.weifang.gov.cn//xxgk/m_5_e/module/review/opr_review_template.jsp\n同样直接上传我们的shell.zip,即可在上面的目录下生成：Customize.jsp同样连接Customize.jsp,如图所示\n\n   漏洞证明：  #证明\nhttp://xxgk.weifang.gov.cn//xxgk/m_5_e/module/review/opr_review_template.jspC:\\WINDOWS\\system32\\> whoamint authority\\systemC:\\WINDOWS\\system32\\> ipconfigWindows IP ConfigurationEthernet adapter 本地连接 2:   Connection-specific DNS Suffix  . :    IP Address. . . . . . . . . . . . : 10.82.17.26   Subnet Mask . . . . . . . . . . . : 255.255.255.0   Default Gateway . . . . . . . . . : 10.82.17.1\n   修复方案：  严格限制上传的文件   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-05-19 10:01 厂商回复： 感谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-18 19:18 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  丫！现在通用的审核好慢啊    \n     2014-05-18 20:44 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  哎哟喂我去，这个哥们给力哦    \n     2014-05-19 10:03 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  @wefgod 这哥们就是你啊。。。    \n     2014-05-19 10:15 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @HackBraid 和我有毛关系啊    \n     2014-05-19 10:34 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @HackBraid 等看狗哥发出5月的通用统计就知道是谁了    \n     2014-05-22 10:36 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  这个路人甲是哪位大神！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}