{"id": 19911, "wybug_id": "wooyun-2015-0106776", "wybug_title": "利用FoxMail持久型XSS漏洞偷取任意的邮件内容或执行任意代码等", "wybug_corp": "腾讯", "wybug_author": "Tea", "wybug_date": "2015-04-09 11:38", "wybug_open_date": "2015-07-08 17:04", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-08：\t细节向公众公开  简要描述： 你以为FOXMAIL的XSS就只能弹框么。。 详细说明：  这个不是站在 WooYun: Foxmail邮箱客户端持久型XSS跨站脚本攻击漏洞（收邮件就触发） 研究的问题，是去年提交了TSRC以后更新版本后绕过一些问题的东西。测试版本，最新版本7.2 build 6.0.40本报告不包含以前版本的利用信息。PS：因为软件更新以后在TSRC提交的问题已经修护，后面版本产生的问题算为新问题（跟TSRC工作人员确认过了，他们也认为我以前提交的问题修护了）新问题，就换个地方提了。还有一点就是，\n\n这个地方后面更新了小版本号，这里一直没有更新时间，而且FOXMAIL里面的更新是更新不到最新的小版本号版本的，诡异下面就来说说问题的情况了。其实FOXMAIL就类似是一个大的浏览器，里面CSS,JS,HTML都解析。然后呢，FOXMIAL里面加载了Jquery的。这里可以做下判断看看。这里会方便后面获取任意邮件的内容什么的。具体可以看:mail_frame.html里面加载的JS。。\n\n/Template/Conversation/Javascript/Main.js这个JS里面有很多好玩的方法，发邮件，打开邮件，菜单，快速回复等。自己看看功能比如：window.J2D_WriteLog()\t写日志，这个会写内容到一个文本文件在FOXMAIL目录的子目录window.J2D_PopupCompose(4294968029, 'Ni,Hao.') 可以直接打开写信窗口window.J2D_ChangeTopState(4294968029, 1)\t给邮件置顶window.J2D_ContinueXSend(mailid) 触发快速回复，这个会直接发送回邮件上面这些截图就不截了，自己可以去玩。。在FOXMAIL里面标记一个邮件用到的是mailid.如何获取这个mailid呢。我们可以用如下的方法获取到：\nvar mailidtmp = $('.mail_session').attr('mailid');\n在发送邮件过去以后，收到邮件后就有了\n\n我们的目标是偷任意的邮件内容。但是能执行代码的为什么不执行呢。。这里先给出触发这个XSS的POC：测试代码里面。。FOXMAIL邮件查看页面里面还启用了CSP..好了，我们下面说怎么获取任意的邮箱内容了。前面说了，$ajax是有的，方便了我们后面获取邮件内容发送出去。。后面我们会把内容GET出去（这里只作验证）更猥琐的大牛自行完善。。以下只给出结果，过程就不说了，会跟以前的问题重复，怕挨打。。先个几个短的JS功能：/*实现获得当前MAILID，然后遍历几个MAILID，打开其他的邮件，并且插入'c'*/\nvar maxmid=$('.mail_session').attr('mailid');var minmid=maxmid - 4;for (minmid;minmid<maxmid;minmid++){window.J2D_PopupCompose(minmid, 'c')}\n开始在这里逗留了很久，一直找不到直接转其他邮件并且把收件人或者CC人改变为自己控制的邮箱的方法，不然你发送一个邮箱，对面一触发再给你转过来，也是没得意义的事情。window.J2D_PopupCompose(minmid, 'c')这个方法的实现就是，打开其他邮件通过mailid控制，并且插入后面跟的内容。比如上面的\"c\".这下猥琐的思路就来了。。XSS触发-->获取当前mailid-->打开其他邮件-->在其他邮件内容出插入新XSS代码-->XSS代码在新页面执行以上就是利用的流程了。还有一个FOXMAIL的mailid（我测试自己不同机器）总是以相同的一个 mailid开始，然后增加。所以，只是玩玩的话，可以猜几个 mailid玩玩。给出获取内容的JS（只是测试）：\nfunction removeHTMLTag(str){str=str.replace(/<\\/?[^>]*>/g,'');str=str.replace(/[ | ]*\\n/g,'\\n');str=str.replace(/\\n[\\s| | ]*\\r/g,'\\n');str=str.replace(/&nbsp;/ig,''); return str;};var mid =$('blockquote').html();alert(removeHTMLTag(mid));\n//$('blockquote').html 这里用这个是因为测试的时候这里方便然后给出最后的POC:其实利用代码太粗糙，可以好好改改，但是测试能用，证明问题就行了。   漏洞证明：  \n\n\n\n\n\nGET到服务器出邮件内容：\n\n这里是查询远程服务器日志的内容（GET出去的邮件内容）\n\n\n\n要想多偷邮件，就用上面的For循环多循环就OK了。传出去用户像是不知道，但是一下邮箱打开很多其他邮件的框框还是很可疑的，暂时做不到静默偷取。。\n\n如这种框框。。会很多。   修复方案：  window.open(\"*.exe\")这个很容易绕过。exe后面跟/或者.等CSP 其他的都有完善了，object-src没有完善好。最好是可以让用户插入的XSS代码全部都假死。过滤够。   版权声明：转载请注明来源 Tea@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-04-09 17:02 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-09 17:10 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  终于确认了    \n     2015-04-09 17:14 |    \t\tf4ck \t\t\t( 实习白帽子  |\t\t\t        Rank:42 漏洞数:7        | 有些人很牛B，一个漏洞能刷成N个。)\t\t \n  上首显了,少有的20rank。    \n     2015-04-09 17:15 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  怎么确认了还在最新提交列表里    \n     2015-04-09 17:17 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  少有的20rank    \n     2015-04-09 17:32 |    \t\t’‘Nome \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:19        | 在此感谢 @M4sk @mango @裤裆 @泳少 @5up3r...)\t\t \n  少有的20rank  腾讯说话太夸张了。。。。打脸了吧？    \n     2015-04-09 17:34 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  20rank    \n     2015-04-09 17:36 |    \t\tchock \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:15        | 今夜我们都是wooyun人，我们一定要收购长亭)\t\t \n  哦，碉堡了    \n     2015-04-09 17:49 |    \t\tboooooom  \t\t\t( 普通白帽子  |\t\t\t        Rank:467 漏洞数:50        | 我有一个好想法！)\t\t \n  二哥还有30秒到达战场....    \n     2015-04-09 17:50 |    \t\the1renyagao \t\t\t( 普通白帽子  |\t\t\t        Rank:225 漏洞数:29        | 是金子总会发光，在还未发光之前，先打磨打...)\t\t \n  20rank    \n     2015-04-09 18:05 |    \t\tMr.leo \t\t\t( 普通白帽子  |\t\t\t        Rank:1314 漏洞数:176        | 说点神马呢！！)\t\t \n  $$$$    \n     2015-04-09 18:05 |    \t\t岩少 \t\t\t( 普通白帽子  |\t\t\t        Rank:586 漏洞数:171        | 破晓团队)\t\t \n  这么多，这是多少钱啊    \n     2015-04-09 18:10 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  卧槽关注啊    \n     2015-04-09 18:12 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  火钳刘民呀    \n     2015-04-09 18:14 |    \t\tcatcat520 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:4        | 大家好，我是刚学网络 00后，求照顾，谢谢)\t\t \n  关注一下    \n     2015-04-09 18:16 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  我了割草啊,这么快就$$$了    \n     2015-04-09 18:20 |    \t\t’‘Nome \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:19        | 在此感谢 @M4sk @mango @裤裆 @泳少 @5up3r...)\t\t \n  这么快就$$$了     我要是得到$$$  @浩天 你让我和你搞基 我都同意~~~~    \n     2015-04-09 18:21 |    \t\tssss \t\t\t( 实习白帽子  |\t\t\t        Rank:80 漏洞数:19        | 虫子是给早起的勤奋的鸟儿七的。)\t\t \n  火钳关注    \n     2015-04-09 18:22 |    \t\tterm \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:21        )\t\t \n  卧槽 直接$$$  一提交钱就到了    \n     2015-04-09 18:24 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  卧槽，这么快就给钱了    \n     2015-04-09 18:30 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  @‘Nome 我还不愿意呢    \n     2015-04-09 18:56 |    \t\tan0nym0u5 \t\t\t( 普通白帽子  |\t\t\t        Rank:172 漏洞数:31        )\t\t \n  吃饭的功夫就雷劈了不说~还$$$啊！NB！    \n     2015-04-09 19:05 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  好多钱    \n     2015-04-09 19:32 |    \t\t暗羽 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:6        | 喵呜，给人类的智商跪了)\t\t \n  ~\\(≧▽≦)/~    \n     2015-04-09 19:35 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  5000以上    \n     2015-04-09 19:35 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  我用的就是foxmail啊，别黑我啊    \n     2015-04-09 20:39 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2015-04-09 20:52 |    \t\tTaro \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:48        | 走向最远的方向，哪怕前路迷茫；抱着最大的...)\t\t \n  三个雷啊    \n     2015-04-09 21:04 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  xss也能这么高！    \n     2015-04-09 21:07 |    \t\txbuther \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 多多交流，一起进步。。。O(∩_∩)O~)\t\t \n  碉堡了。    \n     2015-04-09 21:33 |    \t\tB1acken \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:56        | 渣渣)\t\t \n  火前留名    \n     2015-04-09 21:43 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  打脸了吧？    \n     2015-04-09 22:05 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  $$$是多少？    \n     2015-04-09 22:46 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:42        | 最大的漏洞就是人)\t\t \n  二哥还有30秒到达战场....    \n     2015-04-09 23:43 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:30        | Wow~~~哈哈~~~)\t\t \n  先膜拜一下，哈哈..    \n     2015-04-10 00:16 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  来迟了。    \n     2015-04-13 17:49 |    \t\t顾顾顾金威 \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:12        | 拉拉拉拉阿拉拉拉)\t\t \n  $$$不得一万吗    \n     2015-04-13 19:02 |    \t\t找寻者 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 学习啊)\t\t \n  我去,都是大牛啊    \n     2015-04-13 19:05 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  立刻核心白帽子？    \n     2015-04-14 15:55 |    \t\t那年打死一只小强 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:6        | 请大牛带我飞)\t\t \n  代码码的好    何止弹窗呢？    \n     2015-04-17 00:24 |    \t\tJGHOOluwa \t\t\t( 普通白帽子  |\t\t\t        Rank:206 漏洞数:32        | 就是来看看大牛们如何超神的^-^)\t\t \n  关注    \n     2015-06-03 23:24 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这个很给力啊    \n     2015-06-11 11:30 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  @wefgod  确实给力，很久没看过这么精彩的案例    \n     2015-06-14 13:43 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  没看懂xss是哪里触发的啊    \n     2015-06-24 09:34 |    \t\tyinian \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:22        | 代 码 审 计 求 交 流)\t\t \n  好贵    \n     2015-07-08 17:18 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:84        | [code]心若没有栖息的地方，走到哪里都是在...)\t\t \n  好厉害    \n     2015-07-08 18:08 |    \t\t大物期末不能挂 \t\t\t( 普通白帽子  |\t\t\t        Rank:132 漏洞数:23        | 1.一个学渣，只求每门都不挂2.想把漏洞提...)\t\t \n  二哥还有30秒到达战场....    \n     2015-07-08 18:31 |    \t\t鬼见愁 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 挖洞之神)\t\t \n  求测试代码是多少    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}