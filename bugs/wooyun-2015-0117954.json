{"id": 29917, "wybug_id": "wooyun-2015-0117954", "wybug_title": "KesionIMALL  注册处存在cookie 注入", "wybug_corp": "kesion.com", "wybug_author": "路人甲", "wybug_date": "2015-06-03 16:51", "wybug_open_date": "2015-09-06 08:44", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-06：\t细节向公众公开  简要描述： 之前就更新过有关官方的补丁，加上了关键字的拦截但是拦截的方法是有误的，还有好多地方没有做到对应的出来案例是本地搭建的demo注入点:用户注册地方http://127.0.0.1:8010/regok.aspx 详细说明：  \n\n\n\n\n\n   漏洞证明：     修复方案：  错误代码：public static void UpdateLoginInfo(string username, string password, DateTime lastlogintime, int cookies){\tstring text = Utils.RndNum(20);\tCheckUserLogin.icheckUserLogin_0.UpdateLoginInfo(username, password, lastlogintime, cookies, text);\tif (Utils.GetSysInfo(\"//sysinfo/model/mall\").ToString().ToLower() == \"true\")\t{\t\ttry\t\t{\t\t\tif (!string.IsNullOrEmpty(new TemporaryVar().OrderID))\t\t\t{\t\t\t\tDataFactory.ExecuteNonQuery(string.Concat(new string[]\t\t\t\t{\t\t\t\t\t\"Update KS_ProOrder Set UserName='\",\t\t\t\t\tusername,\t\t\t\t\t\"' Where OrderID='\",\t\t\t\t\tnew TemporaryVar().OrderID,\t\t\t\t\t\"'\"\t\t\t\t}));\t\t\t\tnew TemporaryVar().OrderID = string.Empty;\t\t\t}\t\t\tif (new TemporaryVar().AddressId != 0)\t\t\t{\t\t\t\tDataFactory.ExecuteNonQuery(string.Concat(new object[]\t\t\t\t{\t\t\t\t\t\"Update KS_ProAddress Set UserName='\",\t\t\t\t\tusername,\t\t\t\t\t\"' Where AddressID=\",\t\t\t\t\tnew TemporaryVar().AddressId\t\t\t\t}));\t\t\t\tnew TemporaryVar().AddressId = 0;\t\t\t}\t\t\tif (new TemporaryVar().InvoiceId != 0)\t\t\t{\t\t\t\tDataFactory.ExecuteNonQuery(string.Concat(new object[]\t\t\t\t{\t\t\t\t\t\"Update KS_ProInvoice Set UserName='\",\t\t\t\t\tusername,\t\t\t\t\t\"' Where invoiceID=\",\t\t\t\t\tnew TemporaryVar().InvoiceId\t\t\t\t}));\t\t\t\tnew TemporaryVar().InvoiceId = 0;\t\t\t}\t\t}\t\tcatch (Exception)\t\t{\t\t}\t\tDataFactory.ExecuteNonQuery(string.Concat(new string[]\t\t{\t\t\t\"Update KS_ProShoppingCart Set UserName='\",\t\t\tusername,\t\t\t\"' Where userName='\",\t\t\tBaseFun.GetTempUserName(),\t\t\t\"'\"\t\t}));\t\tDataFactory.ExecuteNonQuery(string.Concat(new string[]\t\t{\t\t\t\"Update KS_ProAddress Set UserName='\",\t\t\tusername,\t\t\t\"' Where userName='\",\t\t\tBaseFun.GetTempUserName(),\t\t\t\"'\"\t\t}));\t}\tif (Utils.GetSysInfo(\"//sysinfo/model/exam\").ToString().ToLower() == \"true\")\t{\t\tDataFactory.ExecuteNonQuery(string.Concat(new object[]\t\t{\t\t\t\"Update KS_SjScore Set UserID=\",\t\t\tUserManage.GetUserInfo(username).UserID,\t\t\t\",UserName='\",\t\t\tusername,\t\t\t\"' Where UserName='\",\t\t\tBaseFun.GetTempUserName(),\t\t\t\"'\"\t\t}));\t}\tHttpCookie httpCookie = new HttpCookie(\"User\");\tif (BaseConfigManage.AllowSubDomain.ToLower().Equals(\"true\"))\t{\t\thttpCookie.Domain = BaseConfigManage.RootDomain;\t}\tif (Utils.IsNumber(username) && DataFactory.Exists(\"KS_User\", string.Concat(new object[]\t{\t\t\"userid=\",\t\tUtils.StrToInt(username),\t\t\" and password='\",\t\tpassword,\t\t\"'\"\t})))\t{\t\thttpCookie.Values[\"userid\"] = username;\t\thttpCookie.Values[\"username\"] = HttpUtility.UrlEncode(UserManage.GetUserInfo(Utils.StrToInt(username)).UserName);\t}\telse\t{\t\thttpCookie.Values[\"userid\"] = UserManage.GetUserInfo(username).UserID.ToString();\t\thttpCookie.Values[\"username\"] = HttpUtility.UrlEncode(username);\t}\thttpCookie.Values[\"password\"] = password;\thttpCookie.Values[\"RndPassword\"] = text;\tswitch (cookies)\t{\tcase 1:\t\thttpCookie.Expires = DateTime.Now.AddMinutes(1440.0);\t\tbreak;\tcase 2:\t\thttpCookie.Expires = DateTime.Now.AddMinutes(43200.0);\t\tbreak;\tcase 3:\t\thttpCookie.Expires = DateTime.Now.AddMinutes(518400.0);\t\tbreak;\t}\tHttpContext.Current.Response.AppendCookie(httpCookie);}   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-06-08 08:43 厂商回复： 感谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-08 10:07 |    \t\thackyandi \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:16        | 一个没有梦想的人)\t\t \n  Rank 好低    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}