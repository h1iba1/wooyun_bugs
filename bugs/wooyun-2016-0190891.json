{"id": 88209, "wybug_id": "wooyun-2016-0190891", "wybug_title": "PHPYUN任意文件上传导致GETSHELL                                      ", "wybug_corp": "php云人才系统", "wybug_author": "pang0lin", "wybug_date": "2016-03-31 15:20", "wybug_open_date": "2016-06-29 15:40", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-03：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-29：\t细节向公众公开  简要描述： 简单到你难以想象，只要网站还可以注册就可以GETSHELL，无视GPC,无视WAF。4.1beta版本，其他版本未测 详细说明：  1.在审计PHPYUN的时候一度对PHPYUN的WAF非常无语，但是在大家都痴迷于寻找SQL注入漏洞的时候，确实忽略了一个很简单的上传漏洞。首先定位到漏洞文件wap/member/model/index.class.php\nfunction photo_action(){\t\tif($_POST['submit']){\t\t\tpreg_match('/^(data:\\s*image\\/(\\w+);base64,)/', $_POST['uimage'], $result);\t\t\t$uimage=str_replace($result[1], '', str_replace('#','+',$_POST['uimage']));\t\t\t$new_file = time().\".\".$result[2];\t\t\tif (!file_exists(DATA_PATH.\"upload/user/\".date('Ymd').\"/\")){\t\t\t\tmkdir(DATA_PATH.\"upload/user/\".date('Ymd').\"/\");\t\t\t\tchmod(DATA_PATH.\"upload/user/\".date('Ymd').\"/\",0777);\t\t\t}\t\t\t$re=file_put_contents(DATA_PATH.\"upload/user/\".date('Ymd').\"/\".$new_file, base64_decode($uimage));\t\t\tchmod(DATA_PATH.\"upload/user/\".date('Ymd').\"/\".$new_file,0777);\t\t\tif($re){\t\t\t\t$user=$this->obj->DB_select_once(\"resume\",\"`uid`='\".$this->uid.\"'\",\"`photo`,`resume_photo`\");\t\t\t\tif($user['photo']||$user['resume_photo']){\t\t\t\t\tunlink_pic(APP_PATH.$user['photo']);\t\t\t\t\tunlink_pic(APP_PATH.$user['resume_photo']);\t\t\t\t}\t\t\t\t$photo=\"./data/upload/user/\".date('Ymd').\"/\".$new_file;\t\t\t\t$this->obj->DB_update_all(\"resume\",\"`resume_photo`='\".$photo.\"',`photo`='\".$photo.\"'\",\"`uid`='\".$this->uid.\"'\");\t\t\t\t$this->obj->DB_update_all(\"resume_expect\",\"`photo`='\".$photo.\"'\",\"`uid`='\".$this->uid.\"'\");\t\t\t\techo 1;die;\t\t\t}else{\t\t\t\tunlink_pic(\"../data/upload/user/\".date('Ymd').\"/\".$new_file);\t\t\t\techo 2;die;\t\t\t}\t\t} else{\t\t\t$user=$this->obj->DB_select_once(\"resume\",\"`uid`='\".$this->uid.\"'\",\"`photo`\");\t\t\tif($user['photo']==\"\"){\t\t\t\t$user['photo']='/'.$this->config['sy_member_icon'];\t\t\t}\t\t\t$this->yunset(\"user\",$user);\t\t\t$this->waptpl('photo');\t\t}\t}\n2.这里的file_put_contents接收两个参数，两个参数均是来自于$_POST['uimage']，而且还经过了base64_decode的反编码，就可以无视WAF了。首先注册一个普通的用户，随便填一个简历，然后构造payload，如测试代码，就可以在我们的根目录下面生成一个php的一句话webshell。官网没找到demo,就以官网中的排名第一个的案例http://**.**.**.**/（电商人才网）演示漏洞参照测试代码，构造payload，你以为最后的时间戳还要爆破么，完全不用，使用burp抓包（不能直接访问，除非你是用手机访问的，因为这里验证了UA头，是电脑会被重定向，但是后面的代码仍然可以执行），访问http://**.**.**.**/wap/member/index.php?c=photo&m=index（这里不post任何数据，就可以直接看到当前的头像，里面有我们传好的webshell）\n\nhttp://**.**.**.**/data/upload/user/20160330/1459344569.php3,同样的问题还出现在wap/member/model/com.class.php。   漏洞证明：  \n\nhttp://**.**.**.**/data/upload/user/20160330/1459344569.php按照管理员大大的要求再提供案例吧,都只传phpinfo，没问题吧1.http://**.**.**.**/data/upload/user/20160331/1459407471.php2.http://**.**.**.**/data/upload/user/20160331/1459407615.php3.http://**.**.**.**/data/upload/user/20160331/1459407983.php4.http://**.**.**.**/data/upload/user/20160331/1459408176.php5.http://**.**.**.**/data/upload/user/20160330/1459344569.php6.http://**.**.**.**/data/upload/user/20160331/1459408409.php   修复方案：  你们更专业   版权声明：转载请注明来源 pang0lin@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2016-03-31 15:36 厂商回复： 感谢提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-31 15:22 |    \t\t玉林嘎  \t\t\t( 普通白帽子  |\t\t\t        Rank:941 漏洞数:108        )\t\t \n  ...    \n     2016-03-31 15:22 |    \t\tkomas \t\t\t( 普通白帽子  |\t\t\t        Rank:107 漏洞数:25        )\t\t \n  ...膜拜    \n     2016-03-31 15:24 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:307 漏洞数:70        | baozisec)\t\t \n  程序员写错代码了    \n     2016-03-31 15:25 |    \t\tanswer  \t\t\t( 普通白帽子  |\t\t\t        Rank:453 漏洞数:54        | 答案)\t\t \n  ...    \n     2016-03-31 20:34 |    \t\tksss \t\t\t( 普通白帽子  |\t\t\t        Rank:592 漏洞数:89        | 靡不有初，鲜克有终)\t\t \n  哇    \n     2016-04-01 10:29 |    \t\tRainism \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:4        | hacking for fun)\t\t \n  ……    \n     2016-04-01 11:30 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:408 漏洞数:92        | JDSec)\t\t \n  .......    \n     2016-04-04 13:42 |    \t\tYOUYU \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:4        | 不想说)\t\t \n  .....    \n     2016-04-05 16:35 |    \t\twps2015 \t\t\t( 普通白帽子  |\t\t\t        Rank:654 漏洞数:86        | 不叫一日荒废)\t\t \n  666    \n     2016-04-06 13:38 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:415 漏洞数:99        | 哇啦啦啦啦啦 我的宝贝  |  Tr3jer@Gmail.c...)\t\t \n  ......    \n     2016-04-06 14:55 |    \t\t风炫 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:6        | 菊花残，满地伤)\t\t \n  腥风血雨，目测要火    \n     2016-04-06 17:28 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:408 漏洞数:92        | JDSec)\t\t \n  wap的问题……    \n     2016-04-22 01:17 |    \t\ti0nAy \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 你渴望力量吗? <不我渴望奶子.>)\t\t \n  目测要火... 关注 洞主66666666    \n     2016-05-02 19:22 |    \t\t清风づ \t\t\t( 实习白帽子  |\t\t\t        Rank:68 漏洞数:15        | 90后小屌丝~努力学习代码审计的渣渣)\t\t \n  ...赞    \n     2016-06-04 21:14 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:251 漏洞数:35        | 我不是 T0n9 和 T0n9@X1a0J1e 的大号！)\t\t \n  自带waf bypass。    \n     2016-06-29 15:54 |    \t\t美食家L \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:10        | http://404.so 安静的坚持自己的原则)\t\t \n  程序员写错代码了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}