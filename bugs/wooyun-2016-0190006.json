{"id": 88245, "wybug_id": "wooyun-2016-0190006", "wybug_title": "从一木马分析到Windows UAC机制成功绕过实战（全静默无须用户交互）                                      ", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "路人甲", "wybug_date": "2016-03-28 17:40", "wybug_open_date": "2016-06-30 16:40", "wybug_type": "非授权访问/认证绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-04-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-04：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-30：\t细节向公众公开  简要描述： 涉及Windows 7/2008/8/2012/Vista X86/64版本，全静默无须用户交互 详细说明：  最近遭受大规模邮件木马攻击，发现该木马被触发后竟能绕过Windows UAC机制并成功安装后门程序，故分析其样本并按其思路自行编写工具重现Windows UAC绕过全过程。一、UAC机制理论上Win7后的版本系统上都有UAC机制保护（系统安装后默认如下图）\n\n一般情况下普通管理员权限在安装未经微软签名的程序或执行某些命令时，都会触发UAC机制，要求提供权限或管理员‌密码以进行验证，即平时我们经常所见的以下弹框，需要管理员交互确认后方可继续安装，否则拒绝安装\n\n如果程序是通过命令行运行安装的，未经UAC授权会直接提示拒绝访问二、绕过原理目标是绕过Windows的UAC机制，前提如下：1）涉及Windows 7/2008/8/2012/Vista版本，不包括Win102）已具有普通管理员权限，即在administrators组中绕过原理：运行系统安全目录中已签名的白名单程序，并对其实行dll劫持，将我们需要安装或运行的程序或命令注入到dll中，从而实现UAC绕过。1）在Win7上，有三个可执行文件可被利用并且相关的DLL如下，这些程序皆为系统自带的安全目录中已签名的白名单程序，运行时不会触发UAC机制，故可对其dll进行劫持。\n\nWin 8的类似程序及其相关DLL如下\n\n2）关于dll劫持，上表中程序相关的dll一般在System32目录中，当程序运行加载时，系统会按照程序目录-System32目录的顺序进行加载（当然，KnownDlls列表中的dll除外，KnownDlls列表即在HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\KnownDLLs中指定的dll，只能从系统目录即SYSTEM32目录下调用），而上述dll皆不在KnownDlls列表中，故会先加载程序目录下的同名dll，因此我们只需将我们伪造的dll置于该程序目录中，即可进行劫持。3）由于1中的程序皆在系统安全目录中（%windir%），UAC机制下也是需要验证才能往里面写入或修改文件；这时，可以使用微软自带的更新命令wusa，从而把我们的伪造dll释放到相应的安全目录中。三、绕过实战此处不妨以Windows 7为例，我们通过Mcx2Prov.exe及其cryptbase.dll实现UAC绕过，安装木马后门程序A。1、制作伪造dll首先反编译原cryptbase.dll，获取其入口函数，并在函数中插入我们需要执行的后门程序A的安装命令，最后保持原出口点不变，链接回原dll，使得原程序能正常执行不出错。这里提供个Dll劫持的反编译工具：\nhttps://**.**.**.**/coca1ne/DLL_Hijacker\n2、制作及释放wsua更新包将我们要安装的木马程序A及伪造的dll文件进行封包，以便到时使用wsua命令释放到安全目录中。封包格式为微软自带的mszip加压技术，即我们常见的cab。\nmakecab cryptbase.dll\n\nmakecab muma.exe\n得到两个压缩包文件，cryptbase和muma（后缀名随意~）wsua释放命令，由于我们选用的白名单程序Mcx2Prov.exe在C:\\Windows\\ehome目录中，因此伪造的dll文件也许释放到该目录中，木马程序则释放到System32目录中。\nwusa /quiet \"C:\\Windows\\Temp\\muma\" /extract:\"C:\\Windows\"\n\nwusa /quiet \"C:\\Windows\\Temp\\cryptbase\" /extract:\"C:\\Windows\\ehome\"\n3、最终命令行运行Mcx2Prov.exe，即可全程静默绕过UAC安装木马后门程序A。此处附上演示视频（为gif动画，请通过以下链接自行下载并使用浏览器观看）\nhttp://**.**.**.**/upload/image/201603/2016032814554724178.gif\n经测试，漏洞涉及Windows 7/2008/8/2012/Vista X86/64版本。Win 10自带的wsua程序由于不再支持/extract释放命令了，故此法不适用。\n\n   漏洞证明：  -   修复方案：  请多指教~   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2016-04-01 16:36 厂商回复： CNVD未直接复现所述情况，已由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-04-01 16:45 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:135 漏洞数:30        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  关注了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}