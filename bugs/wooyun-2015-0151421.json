{"id": 82326, "wybug_id": "wooyun-2015-0151421", "wybug_title": "某综合监控管理平台配置不当致未授权访问getshell(以某市全市卫生监督所为例/可威胁内网)", "wybug_corp": "浙江大华技术股份有限公司", "wybug_author": "路人甲", "wybug_date": "2015-11-05 00:00", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["命令执行", "文件上传", "敏感文件操作参数未加过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-12：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 某综合监控管理平台配置不当致未授权访问getshell(以某市全市卫生监督所为例，可威胁内网)-2# 详细说明：  浙江大华作为全国第二大的监控产品供应商和解决方案服务商，其产品在党政、公安、监狱、学校等占有很大的市场份额，top2的监控产品供应商的用户量可想而知了。来看看存在本漏洞的部分案例吧，国家电网某站也中枪了（http://**.**.**.**/）\n**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**:8081/portal/login_init.action**.**.**.**:8081/portal/login_init.action**.**.**.**:8080/portal/login_init.action**.**.**.**:8080/portal/login_init.action**.**.**.**:8000/portal/login_init.action**.**.**.**:88/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:88/portal/login_init.action**.**.**.**:88/portal/login_init.action**.**.**.**:88/portal/login_init.action**.**.**.**:88/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**:81/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action**.**.**.**/portal/login_init.action\n本次漏洞出现在浙江大华的“综合监控管理平台”上，下面将一步步讲解如何拿下shell的。该漏洞与http://**.**.**.**/bugs/wooyun-2015-0150977不是同一个文件/同一个操作的漏洞，而且需要的几个重要参数不一样，包括jsonstr={%22mapx%22:null,%22mapy%22:null,%22name%22:%22%22,%22path%22:%22%22,%22desc%22:%22%22,%22pId%22:null}和layerName，下面会具体说，测试时，为了这两个参数，测试了几天时间，今天终于突破了~~~先说下这里用到的漏洞吧：平台配置不当导致本应该只有超级管理员可以访问的某上传页面被未授权访问，而该页面只使用了js对上图片进行验证，由于配置问题，可以轻松得到上传shell的名称，另外上传的路径也可以直接访问，因此，这里就可以拿到webshell；通过查看配置文件，得到超级管理员的登录密码，已登录后台；可以直接下载数据库文件，得到数据库数据；该服务器有多个内网网段，可进一步渗透内网。下面整个过程都以 杭州市全市卫生监督所为 为例进行说明：**.**.**.**:81，可以控制全市所有使用该系统的监控这里直接写个表单上传，但是注意，这里在构造表单时，一定要写上jsonstr和layerName两个参数，这与http://**.**.**.**/bugs/wooyun-2015-0150977有很大的不同，如果这里没有这两个参数的话，不会返回上传文件名字，拿到webshell后，可以看到，文件被重命名，从格式可以看出，使用了Date.getTime()来对文件进行重命名，如果不能成功返回文件名，那利用难度就大了。直接构造表单\n\n上传马儿，抓包，上传，查看返回，得到马儿名称\n\n直接上刀吧，连接之\n\n查看下连接情况\n\n有多个内网网段，可进一步渗透内网，占到为止了找到了数据库文件\n\n使用该系统的案例当中，有很大一部分是可以外连的，举个例子吧，**.**.**.**\n\n在数据库中找到了平台后台的超级用户名和密码，明文害死人啊，登录之\n\n\n\n都是敏感单位，占到为止   漏洞证明：  见 详细说明   修复方案：  整改   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-11-09 11:18 厂商回复： CNVD确认并复现所述漏洞情况，已经转由CNCERT下发对应分中心，由其后续协调网站管理单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-02-16 23:10 |    \t\t幻老头儿 \t\t\t( 普通白帽子  |\t\t\t        Rank:220 漏洞数:50        | 新手上路。)\t\t \n  国家电网是哪个地址啊？    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}