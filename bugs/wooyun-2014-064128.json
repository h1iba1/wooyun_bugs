{"id": 54523, "wybug_id": "wooyun-2014-064128", "wybug_title": "Finecms v2.3.2前台getshell #1 (官网已shell)", "wybug_corp": "dayrui.com", "wybug_author": "phith0n", "wybug_date": "2014-06-09 11:44", "wybug_open_date": "2014-09-04 11:46", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-10：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-04：\t细节向公众公开  简要描述： 看了一下你们以往对漏洞的态度，以及我上一个提交的漏洞的情况，来个狠的，希望不要再忽略了，希望给20 rank。官方demo已shell。这是第1发。 详细说明：  问题仍然出现在头像上传处。finecms头像上传代码沿用的phpcms，多的不说，直接看代码吧。/member/controllers/Account.php 第412行：\n/**\t *  上传头像处理\t *  传入头像压缩包，解压到指定文件夹后删除非图片文件\t */\tpublic function upload() {\t\t\tif (!isset($GLOBALS['HTTP_RAW_POST_DATA'])) {            exit('环境不支持');        }\t\t\t\t$dir = FCPATH.'member/uploadfile/member/'.$this->uid.'/'; // 创建图片存储文件夹\t\tif (!file_exists($dir)) {            mkdir($dir, 0777, true);        }\t\t$filename = $dir.'avatar.zip'; // 存储flashpost图片\t\tfile_put_contents($filename, $GLOBALS['HTTP_RAW_POST_DATA']);\t\t\t\t// 解压缩文件\t\t$this->load->library('Pclzip');\t\t$this->pclzip->PclFile($filename);\t\tif ($this->pclzip->extract(PCLZIP_OPT_PATH, $dir, PCLZIP_OPT_REPLACE_NEWER) == 0) {            exit($this->pclzip->zip(true));        }\n看到倒数第3行，这是解压的操作。熟悉phpcms那个洞的同学应该知道，上传头像的时候先是本地flash对头像进行处理、压缩以后上传，后端进行解压。解压以后删除所有非法文件。如代码所示，解压如果遇到错误的话，就exit。所以，如果我们构造一个压缩包，让解压发生错误，但其中的部分内容又能够解压出来，就能exit出这个程序，就不会删除非法文件，我们的shell就能留下来。思路就这样，利用方法及demo证明见下方。   漏洞证明：  首先构造压缩包。准备7个php文件，直接打包：\n\n打包好的1.zip，用UltraEdit打开编辑，将结尾处的6.php修改类似下图，保存：\n\n我们直接用winrar解压就能发现报错了，但文件却正常地解压了出来：\n\n要的就是这个效果。接下来，上传。注册一个账号，登录以后来到头像上传处。选择正常图片抓包，将数据包修改成刚才生成的那个zip：\n\n发送会发现返回包报错了：\n\n报错了没关系，直接根据目录结构即可找到上传的这个shell，在/member/uploadfile/member/你的uid/3.php其中，1/2/3/4/5/6/7都试一下，根据有些可能没解压出来。demo站phpinfo证明：http://v2.finecms.net/member/uploadfile/member/639/3.php   修复方案：  给20分我就告诉你~   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-04 11:46 厂商回复： 上个月就修复了这个 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-10 12:22 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @dayrui.com那为啥你的演示站和下载的源码里没修复，你自己骗自己好吗？演示站都被我拿下了，还死要脸不承认！    \n     2014-06-12 12:06 |    \t\t想要减肥的胖纸 \t\t\t( 普通白帽子  |\t\t\t        Rank:250 漏洞数:42        )\t\t \n  坐等公开 学习下大牛的思路    \n     2014-06-14 09:38 |    \t\tquanxian \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:2        | This is QuanXian.)\t\t \n  呵呵    \n     2014-06-23 04:32 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  @phith0n 哈哈，还是被忽略啊下次碰到这种厂商webshell发给我就好了，我帮你玩    \n     2014-07-23 00:56 |    \t\t瓦解° \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:5        | web渗透学习小菜一枚。)\t\t \n  无良厂商其实挺多的哈。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}