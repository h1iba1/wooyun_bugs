{"id": 84805, "wybug_id": "wooyun-2015-0141461", "wybug_title": "PHPSHE 二次注入一枚", "wybug_corp": "phpshe.com", "wybug_author": "路人甲", "wybug_date": "2015-10-07 09:21", "wybug_open_date": "2016-01-11 15:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-10：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： rt 详细说明：  \ncase 'register':\t\tif (isset($_p_pesubmit)) {\t\t\tif($db->pe_num('user', array('user_name'=>pe_dbhold($_g_user_name)))) pe_error('用户名已存在...');\t\t\tif($db->pe_num('user', array('user_email'=>pe_dbhold($_g_user_email)))) pe_error('邮箱已存在...');\t\t\tif (strtolower($_s_authcode) != strtolower($_p_authcode)) pe_error('验证码错误');\t\t\t$sql_set['user_name'] = $_p_user_name;\t\t\t$sql_set['user_pw'] = md5($_p_user_pw);\t\t\t$sql_set['user_email'] = $_p_user_email;\t\t\t$sql_set['user_ip'] = pe_ip();\t\t\t$sql_set['user_atime'] = $sql_set['user_ltime'] = time();\t\t\tif ($user_id = $db->pe_insert('user', pe_dbhold($sql_set))) {\t\t\t\tadd_pointlog($user_id, 'reg', $cache_setting['point_reg'], '注册帐号');\t\t\t\t$info = $db->pe_select('user', array('user_id'=>$user_id));\t\t\t\t$_SESSION['user_idtoken'] = md5($info['user_id'].$pe['host_root']);\t\t\t\t$_SESSION['user_id'] = $info['user_id'];\t\t\t\t$_SESSION['user_name'] = $info['user_name'];\t\t\t\t$_SESSION['pe_token'] = pe_token_set($_SESSION['user_idtoken']);\t\t\t\t//未登录时的购物车列表入库\t\t\t\tif (is_array($cart_list = unserialize($_c_cart_list))) {\t\t\t\t\tforeach ($cart_list as $k => $v) {\t\t\t\t\t\t$cart_info['cart_atime'] = time();\t\t\t\t\t\t$cart_info['product_id'] = $k;\t\t\t\t\t\t$cart_info['product_num'] = $v['product_num'];\t\t\t\t\t\t$cart_info['user_id'] = $info['user_id'];\t\t\t\t\t\t$db->pe_insert('cart', pe_dbhold($cart_info));\n用户注册时 ，进行了转义，然后登入时将完整的值带入了session\ncase 'login':\t\tif (isset($_p_pesubmit)) {\t\t\t$sql_set['user_name'] = $_p_user_name;\t\t\t$sql_set['user_pw'] = md5($_p_user_pw);\t\t\tif (strtolower($_s_authcode) != strtolower($_p_authcode)) pe_error('验证码错误');\t\t\tif ($info = $db->pe_select('user', pe_dbhold($sql_set))) {\t\t\t\t$db->pe_update('user', array('user_id'=>$info['user_id']), array('user_ltime'=>time()));\t\t\t\tif (!$db->pe_num('pointlog', \" and `user_id` = '{$info['user_id']}' and `pointlog_type` = 'reg' and `pointlog_text` = '登录帐号' and `pointlog_atime` >= '\".strtotime(date('Y-m-d')).\"'\")) {\t\t\t\t\tadd_pointlog($info['user_id'], 'reg', $cache_setting['point_login'], '登录帐号');\t\t\t\t\t\t\t\t}\t\t\t\t$_SESSION['user_idtoken'] = md5($info['user_id'].$pe['host_root']);\t\t\t\t$_SESSION['user_id'] = $info['user_id'];\t\t\t\t$_SESSION['user_name'] = $info['user_name'];\n在 D:/wamp/www/module/index/order.php出库了\ncase 'comment':\t\t$order_id = pe_dbhold($_g_id);\t\t$info = $db->pe_select('order', array('order_id'=>$order_id, 'user_id'=>$_s_user_id));\t\tif (!$info['order_id']) pe_error('参数错误...');\t\t$info_list = $db->pe_selectall('orderdata', array('order_id'=>$order_id));\t\tif (isset($_p_pesubmit)) {\t\t\tpe_token_match();\t\t\tif ($info['order_comment']) pe_error('请勿重复评价...');\t\t\tforeach ($info_list as $k=>$v) {\t\t\t\t$sql_set[$k]['comment_star'] = intval($_p_comment_star[$v['product_id']]);\t\t\t\t$sql_set[$k]['comment_text'] = pe_dbhold($_p_comment_text[$v['product_id']]);\t\t\t\t$sql_set[$k]['comment_atime']= time();\t\t\t\t$sql_set[$k]['product_id'] = $v['product_id'];\t\t\t\t$sql_set[$k]['order_id'] = $order_id;\t\t\t\t$sql_set[$k]['user_ip'] = pe_dbhold(pe_ip());\t\t\t\t$sql_set[$k]['user_id'] = $_s_user_id;\t\t\t\t$sql_set[$k]['user_name'] = $_s_user_name;\t\t\t\tif (!$sql_set[$k]['comment_text']) pe_error('评价内容必须填写...');\t\t\t}\t\t\tif ($db->pe_insert('comment', $sql_set)) {\t\t\t\torder_callback('comment', $order_id);\t\t\t\tpe_success('评价成功!');\n我们注册个用户 aaaaaaa' ,购买商品后评价，可以看到 单引号带入了。\n\n   漏洞证明：  \n\n盲注。   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-10-07 09:27 厂商回复： 感谢@路人甲 提供代码审计，已将漏洞提交到技术部 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}