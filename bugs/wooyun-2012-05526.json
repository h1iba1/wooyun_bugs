{"id": 20396, "wybug_id": "wooyun-2012-05526", "wybug_title": "joomla变量覆盖导致注册提权漏洞", "wybug_corp": "joomla", "wybug_author": "牛奶坦克", "wybug_date": "2012-03-24 17:42", "wybug_open_date": "2012-05-08 17:43", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "逻辑错误", "设计不当", "变量覆盖", "提权"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-03-24：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2012-05-08：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： joomla用户注册流程存在一个变量覆盖漏洞，可以导致攻击者直接注册管理员权限帐号。 详细说明：  /components/com_users/controllers/registration.php\npublic function register(){// 检测tokenJRequest::checkToken() or jexit(JText::_('JINVALID_TOKEN'));... ...// 初始化用户注册模块$app = JFactory::getApplication();$model = $this->getModel('Registration', 'UsersModel');// 这个地方获取用户注册信息，POST进来的jform数组，但是没有详细指定$requestData = JRequest::getVar('jform', array(), 'post', 'array');... ...// 验证数据$data = $model->validate($form, $requestData);... ...// 将用户注册数据提交给register模块处理，这里一会继续分析$return = $model->register($data);... ...// 以上流程走完后调到完成页面if ($return === 'adminactivate'){$this->setMessage(JText::_('COM_USERS_REGISTRATION_COMPLETE_VERIFY'));$this->setRedirect(JRoute::_('index.php?option=com_users&view=registration&layout=complete', false));} elseif ($return === 'useractivate') {$this->setMessage(JText::_('COM_USERS_REGISTRATION_COMPLETE_ACTIVATE'));$this->setRedirect(JRoute::_('index.php?option=com_users&view=registration&layout=complete', false));} else {$this->setMessage(JText::_('COM_USERS_REGISTRATION_SAVE_SUCCESS'));$this->setRedirect(JRoute::_('index.php?option=com_users&view=login', false));}\n/components/com_users/models/registration.php\npublic function getData(){if ($this->data === null) {$this->data = new stdClass();$app = JFactory::getApplication();$params = JComponentHelper::getParams('com_users');... .../* 默认用户组id为2，joomla组结构如下mysql> select * from ilpy2_usergroups;+----+-----------+-----+-----+--------------------------+| id | parent_id | lft | rgt | title                    |+----+-----------+-----+-----+--------------------------+|  1 |         0 |   1 |  20 | Public                   ||  2 |         1 |   6 |  17 | Registered               ||  3 |         2 |   7 |  14 | Author                   ||  4 |         3 |   8 |  11 | Editor                   ||  5 |         4 |   9 |  10 | Publisher                ||  6 |         1 |   2 |   5 | Manager                  ||  7 |         6 |   3 |   4 | Administrator            ||  8 |         1 |  18 |  19 | Super Users              || 12 |         2 |  15 |  16 | Customer Group (Example) || 10 |         3 |  12 |  13 | Shop Suppliers (Example) |+----+-----------+-----+-----+--------------------------+*/$system = $params->get('new_usertype', 2);$this->data->groups[] = $system;... ...public function register($temp){$config = JFactory::getConfig();$db= $this->getDbo();$params = JComponentHelper::getParams('com_users');// Initialise the table with JUser.$user = new JUser;//这里注意，在遍历用户注册信息前加入了点数据$data = (array)$this->getData();// 遍历出注册信息foreach ($temp as $k => $v) {$data[$k] = $v;}... ...// 组合数据if (!$user->bind($data)) {$this->setError(JText::sprintf('COM_USERS_REGISTRATION_BIND_FAILED', $user->getError()));return false;}// Load the users plugin group.JPluginHelper::importPlugin('user');// 保存用户注册数据if (!$user->save()) {$this->setError(JText::sprintf('COM_USERS_REGISTRATION_SAVE_FAILED', $user->getError()));return false;}\nlibraries/joomla/user/user.php\npublic function save($updateOnly = false)        {                $table = $this->getTable();                $this->params = (string) $this->_params;                //$this->getProperties()里保存的就是用户注册信息了                $table->bind($this->getProperties());                //但是joomla有个机制，就是只有super user才能创建、操作super user，所以提权不能如此彻底，只能根据joomla的组机制建立一个可行的最高权限Administrator，id为7                        $iAmSuperAdmin = $my->authorise('core.admin');                        // We are only worried about edits to this account if I am not a Super Admin.                        if ($iAmSuperAdmin != true)                        {                                if ($isNew)                                //后面不贴了，实在是太多了\n   漏洞证明：  因为groups被初始化为2，也就是Registered，所以注册时在提交数据中多加入一个二维数组，jfrom[groups][]=7，利用foreach的问题覆盖掉groups数组，变成7（Administrator）。\n\n\n\n   修复方案：  貌似随着程序的进步，曾经的“过滤不严”，“绕过过滤”等慢慢的开始像变量未初始化，变量覆盖问题上发展了，程序员是不是除了过滤与限制的同时在考虑一下其他需要注意的地方呢？   版权声明：转载请注明来源 牛奶坦克@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：16 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n     2012-03-24 21:28 |    \t\tf19ht \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:15        | 依依不舍的还是你的菊花。)\t\t \n  joomla的插件太多了还是坐等公布了    \n     2012-03-25 12:21 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  这个：http://jeffchannell.com/Joomla/joomla-161725-privilege-escalation-vulnerability.html ？是的话，貌似可以直接公开了...    \n     2012-03-25 14:14 |    \t\tyoustar \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:8        | 我们人啊~)\t\t \n  这个老外爆的呀，貌似做多能注册到管理员，还没实际权限的。    \n     2012-09-29 20:51 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  foreach ($temp as $k => $v) {$data[$k] = $v;}$system = $params->get('new_usertype', 2);利用foreach的问题覆盖掉groups数组 GOOD    \n     2013-09-13 17:12 |    \t\tACGT \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:4        | another script kiddie)\t\t \n  不说版本号的漏洞都是耍流氓    \n     2013-12-29 17:44 |    \t\tConer \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:1        )\t\t \n  @_Evil 这里是什么道理咯？    \n     2013-12-31 16:08 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  - -当我再次看帖子,我发现了错别字..而且这个错别字我也会经常错!jfrom  jform    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 16, "Ranks": null}