{"id": 66922, "wybug_id": "wooyun-2015-0143128", "wybug_title": "地下城堡iOS客户端伪造上传存档获取水晶（通信算法解密分析）", "wybug_corp": "dxcb.leiting.com", "wybug_author": "GoSSIP_SJTU", "wybug_date": "2015-09-24 11:40", "wybug_open_date": "2015-11-09 10:54", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当", "设计错误", "设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向公众公开  简要描述： 地下城堡iOS客户端上传存档功能校验算法存在漏洞，可以任意伪造存档。通过此方法可以获取大量付费资源。 详细说明：  地下城堡为中国区iOS付费榜前十的游戏，其iOS版中存在一个上传存档的功能，会将用户目前的游戏数据处理后发往api.dxcb.cn.taojingame.com，这个功能存在逻辑漏洞，可以构造任意存档。首先通过抓包可以截获到上传存档的流量：\n\n\n\n通过反复的尝试上传不同的存档，可以确认data参数代表了存档数据，md5参数是对存档数据的签名，其他参数在短时间内不会改变。通过逆向程序发现存档数据的变换算法为：data = urlencode(base64encode(zlib.compress(game_data)))对data参数的值进行解码可以得到明文的存档数据：\n\n通过修改这些数据，可以构造任意的存档，其中也包含了钻石等付费资源的数据。存在漏洞的部分是之后的md5签名算法，开发商通过对data参数进行md5签名校验来防止用户篡改存档，但是此处的md5签名算法内嵌在程序代码中，保护强度不够，可以被逆向分析。通过逆向代码我们可以发现md5签名的具体算法：\n\nmd5 = md5(zlib.compress(game_data) + secret1 + secret2)其中secret1硬编码在代码中，为\"dxc.taojinhudong.6%&76\"。secret2为动态生成，逆向代码无法获得，但是通过对代码的分析我们发现secret2会在同一个流量中被base64encode后发出，作为pwd参数的值，通过对该值进行base64解码我们就可以得到secret2，至此我们已经可以计算出正确的md5值，也就是可以伪造任意的上传存档请求。通过向api.dxcb.cn.taojingame.com发送伪造后的上传存档请求，就可以为自己的账号构造任意的存档，以此来获取大量的资源。\n\n   漏洞证明：  \n\n   修复方案：  更换md5签名算法，不要将动态生成的secret发出。   版权声明：转载请注明来源 GoSSIP_SJTU@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-09-25 10:53 厂商回复： 我方工作人员已确认此漏洞，目前正在修复中，非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-09-24 11:41 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  算法牛！    \n     2015-09-24 11:43 |    \t\tking7 \t\t\t( 普通白帽子  |\t\t\t        Rank:612 漏洞数:110        | 一场秋雨一场寒~)\t\t \n  NBNBNBNBNB     \n     2015-09-24 12:21 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:19        | 当我又回首一切,这个世界会好吗?)\t\t \n  洞主很擅长这个啊    \n     2015-09-24 14:19 |    \t\t数据流  \t\t\t( 普通白帽子  |\t\t\t        Rank:737 漏洞数:92        | 没关系啊，我们还有音乐)\t\t \n  搞算法的是高富帅 搞脚本的都是屌丝    \n     2015-10-18 22:14 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:28        | 逆水行舟，不进则退。)\t\t \n  这个吊！算法逆向各种屌啊    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}