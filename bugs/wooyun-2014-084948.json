{"id": 46403, "wybug_id": "wooyun-2014-084948", "wybug_title": "某通用网站管理系统任意用户登陆/SQL注入/GetShell漏洞源码分析", "wybug_corp": "力拓科技", "wybug_author": "xfkxfk", "wybug_date": "2014-11-27 20:31", "wybug_open_date": "2015-02-25 20:32", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计不当导致攻击界面扩大", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-02-25：\t细节向公众公开  简要描述： 此系统非开源，大部分是高校在用，把源码脱下来看了下 详细说明：  0x00 通用案例：\n厂商：力拓科技官网：http://www.ltpower.net/主要是做教育产品的厂商搜了一下用户大部分都是高校使用的门户网站技术支持:广东省东莞市力拓科技有限公司案例如下：http://zybj.jnu.edu.cn/http://jpkc.gmc.edu.cn/gwsy/index.asphttp://210.36.18.31/slstx/http://glz.dgpt.edu.cn/http://xxgcxy.gdut.edu.cn/user/reg.asphttp://qghgxy.gdut.edu.cn/user/reg.asphttp://tmjtxy.gdut.edu.cn/user/login.asphttp://gsgc.gzhu.edu.cn/szgc/user/reg.asphttp://nhsjd.gzhu.edu.cn/user/reg.asphttp://eeit.hut.edu.cn/user/reg.asphttp://glsxjd.dgpt.edu.cn/user/reg.asphttp://glz.dgpt.edu.cn/user/reg.asphttp://jdsxjd.dgpt.edu.cn/user/reg.asphttp://etc.xmut.edu.cn/user/reg.asphttp://www.zjyy.com.cn/mnwk/http://sps.sysu.edu.cn/zsyx/http://202.116.65.190/xhyxt/index.asp......\n0x01 漏洞分析：任意用户登陆漏洞：首先看一下前台注册用户过程文件user/reg.asp\n<%dim action,UserIDaction=Trim(Request(\"action\"))if action=\"savereg\" then\tdim usr,pwd,code,cname,AuditState\tdim strSql,objRs\tusr=RSQL(Request.Form(\"usr\"))\tpwd=MD5(Request.Form(\"pwd1\"))\tcname=RSQL(Request.Form(\"cname\"))\tcode = Request.Form(\"Code\")\t'\tif arrSite(23)=\"0\" then'\t\tAuditState=0'\telse'\t\tAuditState=1'\tend if\t\t\tIf CStr(code) <>CStr(Session(Const_Cache&\"_Code\")) then\t\tResponse.Write(\"<script>alert('验证码有误，重新输入！');history.back();</script>\")\t\tResponse.End\tEnd If\t\tstrSql=\"select * from base_user where UserName='\"&usr&\"'\"\tset objRs=conn.execute(strSql)\tif not objRs.eof and not objRs.bof then\t\tResponse.Write(\"<script>alert('用户已存在,请更换用户!');history.back();</script>\")\t\tResponse.End\telse\t\tstrSql=\"insert into base_user (RoleID,UserName,[PassWord],Cname,IsEnable) values(6,'\"&usr&\"','\"&pwd&\"','\"&cname&\"',0)\"\t\tconn.execute(strSql)\t\tResponse.Write(\"<script>alert('用户注册成功!');location.href='../index.asp';</script>\")\t\t\t\tend ifend if%>\n用户注册成功后，将用户信息插入表“base_user”表这里用户角色roleid被写死了，这里是6，有些是5接下来看看后台登陆文件\\Admin\\login.asp\n<!--#include file=\"Conn.asp\"--><!--#include file=\"Config.asp\"--><!--#include file=\"../Inc/MD5.asp\"--><!--#include file=\"Function.asp\"--><% Select Case Request(\"Action\")\tCase \"LoginCheck\"\t\tCall LoginCheck()\tCase \"LoginOut\"\t\tCall LoginOut()\tCase Else\t\tCall Lt_login_Main()End SelectSub LoginCheck()\tDim A_PWD,PassWord,UserName,Lt_Code,SqlStr,RS\tLt_Code = trim(Request.Form(Const_Cache&\"Code\"))\tIf CStr(Lt_Code)<>CStr(Session(Const_Cache&\"_Code\")) then\t\tResponse.Write(\"<script>alert('验证码有误，重新输入！');history.back();</script>\")\t\tResponse.End\tEnd If\t\tA_PWD = MD5(Request.Form(\"PassWord\"))\tUserName = RSQL(Request.Form(\"UserName\"))\tPassWord = RSQL(Request.Form(\"PassWord\"))\tSet RS = Server.CreateObject(\"ADODB.RecordSet\")\tSqlStr = \"select * from base_user where UserName='\" & UserName & \"'\"\tRS.Open SqlStr,Conn,1,3\tIF Rs.eof And Rs.bof Then\t\texe(\"INSERT INTO Base_log(Logtype,LogUser,Logcontent,LogIP,LogTime) VALUES('登陆日志','\"&UserName&\"','后台登陆失败，错误的管理帐号！','\"&getip()&\"','\"&now&\"')\")\t\tResponse.Write(\"<script>alert('登录失败:\\n\\n您输入了错误的管理帐号，请再次输入！');history.back();</script>\")\t\tResponse.End\tElse\t\tIF Rs(\"PassWord\") = A_PWD Then\t\t\tIF Rs(\"IsEnable\") = 1 Then\t\t\t\texe(\"INSERT INTO Base_log(Logtype,LogUser,Logcontent,LogIP,LogTime) VALUES('登陆日志','\"&UserName&\"','后台登陆失败，账号已被管理员锁定！','\"&getip()&\"','\"&now&\"')\")\t\t\t\tResponse.Write(\"<script>alert('登录失败:\\n\\n您的账号已被管理员锁定，请与您的系统管理员联系！');history.back();</script>\")\t\t\t\tResponse.End\t\t\tElse\t\t\t\texe(\"UPDATE Base_User SET Lastlogin='\"&now&\"',Loginip='\"&GetIP()&\"',LoginNum=LoginNum+1 where username='\"&UserName&\"'\")\t\t\t\texe(\"INSERT INTO Base_log(Logtype,LogUser,Logcontent,LogIP,LogTime) VALUES('登陆日志','\"&rs(\"UserName\")&\"','后台登陆成功','\"&getip()&\"','\"&now&\"')\")\t\t\t\tResponse.Cookies(Const_Cache)(\"AdminID\") = Rs(\"UserID\")\t\t\t\tSession.Timeout = 30\t\t\tEnd IF\t\tElse\t\t\texe(\"INSERT INTO Base_log(Logtype,LogUser,Logcontent,LogIP,LogTime) VALUES('登陆日志','\"&UserName&\"','后台登陆失败，密码错误','\"&getip()&\"','\"&now&\"')\")\t\t\tResponse.Write(\"<script>alert('登录失败:\\n\\n您输入了错误的口令，请再次输入！');history.back();</script>\")\t\t\tResponse.End\t\tEnd IF\t\tRs.Close:Set Rs = Nothing\t\tResponse.Redirect(\"index.asp\")\tEnd IFEnd Sub\n这里后台登陆也是直接从base_user表里面取出用户信息进行对比的这样的话我们注册的前台普通用户也能登陆后台admin了但是这里有roleid的限制，虽然普通用户登陆了后台，但是是没权限使用功能的，没有功能模块，空白页面后台操作的权限控制是通过文件admin/checkuserpopedom.asp控制的\n<!--#include file=\"conn.asp\"--><!--#include file=\"Config.asp\"--><!--#include file=\"Function.asp\"--><!--#include file=\"../Inc/Lt_Main.Cls.asp\"--><% \tDim AdminUserID,AdminRoleID,objRs,AdminUser,Ltset Lt=new Lt_MainAdminUserID=request.Cookies(Const_Cache)(\"AdminID\")if AdminUserID<>\"\" then\tset objRs=conn.execute(\"SELECT * FROM Base_User WHERE Userid=\"&AdminUserID)\tif not objRs.eof and not objRs.bof then\t   AdminUser=objRs(\"UserName\")\t   AdminRoleID=objRs(\"RoleID\")\telse\t   response.Redirect \"login.asp\"\t   response.end\tend ifelse\tresponse.Redirect \"login.asp\"\tresponse.end\tend if\n从这里可以看到，根据AdminUserID从base_user表中取出用户信息AdminRoleID主要是这里的AdminRoleID就是后台功能模块的判断标准通过此AdminRoleID判断此用户是否有权限操作后台响应功能模块但是这里我们看到\nAdminUserID=request.Cookies(Const_Cache)(\"AdminID\")\nAdminUserID直接从cookie中取得，用户完全可控了所以我们前台注册的用户，通过登陆后台后，在修改COOKIE中的AdminID为管理员ID，0或者1即可登陆管理员账户了，导致了任意用户登陆漏洞0x02 SQL注入漏洞而且这里的AdminUserID没有通过处理，导致SQL注入漏洞0x03 GetShell这里的GetShell需在IIS环境下进行文件admin/templetedit.asp，这里可以添加模板也可以修改原先模版\nFunction save()\tDim Content,FileFSO\t\tContent=request(\"content\")\t\tPath=request(\"Path\")\t\t If lcase(Right(Path,4))<>\"html\" And lcase(Right(Path,3))<>\"htm\" Then Call Lt.Alert(\"文件名的扩展名必须是html或htm\",\"\")\t\t Set FileFSO = Server.CreateObject(\"ADODB.Stream\")\t\t\tWith FileFSO\t\t\t.Type = 2\t\t\t.Mode = 3\t\t\t.Open\t\t\t.Charset = \"utf-8\"\t\t\t.Position = FileFSO.Size\t\t\t.WriteText  Content\t\t\t.SaveToFile Server.MapPath(Path),2\t\t\t.Close\t\t\tEnd With\t\tSet FileFSO = Nothing\t\tResponse.Write (\"<script>parent.frame.cols=\"\"180,*\"\";</script>\")\t\tCall Lt.Alert(\"模板修改成功!\",\"TempLate.asp\"):Exit Function\tEnd Function \tFunction Addsave()\tDim Content,FileFSO,File,PhysicalPath,fs\t\tContent=request(\"content\")\t\tFile=request(\"File\")\t\tPath=request(\"Path\")\t\t If lcase(Right(File,4))<>\"html\" And lcase(Right(File,3))<>\"htm\" Then Call Lt.Alert(\"文件名的扩展名必须是html或htm\",\"\")\t\t Set fs = Server.CreateObject(\"scripting.filesystemobject\")\t\t  PhysicalPath=Server.Mappath(Path&File)\t      if fs.FileExists(PhysicalPath) = False Then\t\t\t Set FileFSO = Server.CreateObject(\"ADODB.Stream\")\t\t\tWith FileFSO\t\t\t.Type = 2\t\t\t.Mode = 3\t\t\t.Open\t\t\t.Charset = \"utf-8\"\t\t\t.Position = FileFSO.Size\t\t\t.WriteText  Content\t\t\t.SaveToFile Server.MapPath(Path&File),2\t\t\t.Close\t\t\tEnd With\t\t\tSet FileFSO = Nothing\t\t\tResponse.Write (\"<script>parent.frame.cols=\"\"180,*\"\";</script>\")\t\t\tCall Lt.Alert(\"模板增加成功!\",\"TempLate.asp\"):Exit Function\t\t  Else \t\t\t  Call Lt.Alert(\"文件名已经存在,请另取一个名称!\",\"\")\t\t  End  If \tEnd Function\n从代码可以看到，在保存文件时，主要后四位为html，或者后三位为htm即可，没有处理文件内容所以当在IIS情况下，我们可以修改保存文件名为111111.asp;.html，或者111111.asp;.htm即可文件内容为一句话木马，或者webshell内容   漏洞证明：  拿暨南大学为例证明：1、前台注册用户地址：http://zybj.jnu.edu.cn/user/reg.asp2、用注册的用户后台登陆地址：http://zybj.jnu.edu.cn/admin/login.asp3、后台登陆后为空白：\n\n4、修改cookie中的adminid即可登陆管理\n\n5、修改模板拿shell：\n\n6、成功拿到shell，这个站已经有黑阔来过了，pr都上了，看了已经沦陷：\n\n其他案例也是这样同样的漏洞和同样的证明方法此系统肯定还有很多漏洞，既然拿到shell，拿到源码了就没什么说的了   修复方案：     版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-12-01 17:16 厂商回复：   最新状态： 2015-05-12：已经查明此问题在少部分网站中存在，目前绝大多数有此隐患的网站已经完成紧急修复！  ", "replys": "漏洞评价：\n评论\n     2014-11-28 09:16 |    \t\t光刃 \t\t\t( 普通白帽子  |\t\t\t        Rank:200 漏洞数:24        | 萝卜白菜保平安)\t\t \n  大牛逼    \n     2014-11-28 09:19 |    \t\tcovertops \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:23        | wooyun)\t\t \n  把源码脱下来看了下    \n     2015-04-04 17:39 |    \t\tdgdg \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:5        | 乌云币:10000)\t\t \n  http://wooyun.org/bugs/wooyun-2010-081636      \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}