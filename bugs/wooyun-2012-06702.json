{"id": 19685, "wybug_id": "wooyun-2012-06702", "wybug_title": "新浪分站部分源代码泄露,可进一步利用", "wybug_corp": "新浪", "wybug_author": "蟋蟀哥哥", "wybug_date": "2012-05-05 11:42", "wybug_open_date": "2012-06-19 11:43", "wybug_type": "重要敏感信息泄露", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码泄漏", "备份文件处理不当", "备份文件未删除"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-05-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-05-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-05-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-05-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-06-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-06-19：\t细节向公众公开  简要描述： 新浪分站部分源代码泄露,可进一步利用 详细说明：  新浪分站部分源代码泄露,可进一步利用.昨天送的礼物全被抢了，再求礼物.谢谢   漏洞证明：  http://eladies.sina.com.tw/getnews.php~\n<?php//**********************************************************// include_once \"./include/define.php\";if(!defined(\"NO_LOGIN_HANDLE_METHOD\")){    define(\"NO_LOGIN_HANDLE_METHOD\", NO_LOGIN_CONTINUE);}include_once DEFAULT_DOC_ROOT.\"/include/smarty.php\";include_once DEFAULT_DOC_ROOT.\"/common/initialize.php\";include_once DEFAULT_DOC_ROOT.\"/util/network.php\";include_once DEFAULT_DOC_ROOT.\"/util/str_process.php\";include_once DEFAULT_DOC_ROOT.\"/include/eladies.php\";/*process ...*/$op     = Request_Param(\"op\",\"\",\"request\");$smarty = new Template;$smarty->assign('WWW_ROOT',DEFAULT_WWW_ROOT);$smarty->assign('DEFAULT_DOC_ROOT',DEFAULT_DOC_ROOT);$smarty->assign('WWW_ROOT_IMAGES',WWW_ROOT_IMAGE);$smarty->assign('WWW_ROOT_CSS',WWW_ROOT_CSS);$smarty->assign('WWW_ROOT_JS',WWW_ROOT_JS);$smarty->assign('UPDATE_IMAES',UPDATE_IMAES);$smarty->assign('INCLUDE_TMPL_ROOT',INCLUDE_TMPL_ROOT);$smarty->assign('CRON_INDEX_TMPL',CRON_INDEX_TMPL);$smarty->assign('WWW_EXTRATMPL_ROOT',DEFAULT_WWW_ROOT.\"/templates/extratmpl\");if( !empty( $MemberInfo ) && isset($MemberInfo[\"NickName\"])){\t$smarty->assign('USER_NAME', $MemberInfo[\"NickName\"] );}$connect = mysql_connect(ELADIES_WDB_HOST,ELADIES_WDB_USER,ELADIES_WDB_PASS) or die(\"資料庫連線錯誤,請聯絡管理員\");mysql_select_db(ELADIES_WDB_NAME,$connect);////**********************************************************include_once \"./include/define.php\";if(!defined(\"NO_LOGIN_HANDLE_METHOD\")){    define(\"NO_LOGIN_HANDLE_METHOD\", NO_LOGIN_CONTINUE);}include_once DEFAULT_DOC_ROOT.\"/include/smarty.php\";include_once DEFAULT_DOC_ROOT.\"/common/initialize.php\";include_once DEFAULT_DOC_ROOT.\"/util/network.php\";include_once DEFAULT_DOC_ROOT.\"/include/eladies.php\";include_once DEFAULT_DOC_ROOT.\"/include/dict.php\";$id  = Request_Param(\"newsid\",\"\",\"request\");if( intval($id) <= 0 ){\theader(\"Location:http://eladies.sina.com.tw\");}$eladies  = new Eladies();$news = $eladies->getPubNewsById( $id );if( !$news || empty($news) || $news['content'] == \"\" || $news['title'] == \"\"){\theader(\"Location:http://eladies.sina.com.tw\");}else{\tif( !$eladies->updateNewsClick( $news['newsid'])){\t\theader(\"Location:http://eladies.sina.com.tw\");\t}}$keywords = $news['keywords'];$conn_news = $eladies->getConnNews($id, $keywords , 8 , $news['video_count'] , $news['category']);$category = $eladies->getCategory( $news['category']);$tpl_layout_name = \"article.shtml\";$onevision_ad_config = 0;$change_video_type = 0;$_common_js_clickrecord = 'news';$news_shcont_ = mb_substr(trim(strip_tags($news['content'])),0,35,\"UTF-8\").\" ... \"; if( intval($news['video_count']) == 1 && $news['source'] == \"tw\"){ \t\t\t\t//only process tw    $video = $eladies->getVideoByNewsid( $news['id'] , $news['source'] );    $onevision_ad_config = $eladies->getOptionFunction_Onevision( 'onevision-ad-config' );    $tpl_layout_name = \"article_video.shtml\"; \t\t\t\t\t\t\t//video tmpl            if(isset($news['onevision_url']) && $onevision_ad_config['advertising_config'] == 1 ) {  \t//only for onevision        $change_video_type = 1;                }    $_common_js_clickrecord = 'video';                }elseif( intval($news['media_count']) == 1 && $news['layout'] == \"11\" ){    $newsid = intval( $news['newsid']);    $images = $eladies->getImageByNewsid( $newsid , $news['source']);    $tpl_layout_name = \"article_photo.shtml\"; \t\t\t\t\t\t\t//laypout by one images tmpl                        }elseif( intval($news['media_count']) > 1 ){    $newsid = intval( $news['newsid']);\t$img_album_id = $newsid;    $images = $eladies->getImageByNewsid( $newsid ,$news['source']);\tif( !empty($images) && count($images) > 1 && file_exists(DEFAULT_DOC_ROOT.\"/images/flash/newsPhoto/\".$newsid.\"_list.xml\")){        $tpl_layout_name = \"article_photo02.shtml\"; \t\t\t\t\t\t//imgnum > 1 tmpl                \t\t}elseif( count($images) == 1 && $news['layout'] == \"11\" ){\t\t$tpl_layout_name = \"article_photo.shtml\";\t\t\t\t\t\t\t}else{\t\t$tpl_layout_name = \"article.shtml\";\t\t\t\t}\t}$authorid = intval( $news['author']);$author = $eladies->getAuthor( $authorid);$smarty = new Template;$smarty->assign('news',$news);$smarty->assign('author',$author);$smarty->assign('category',$category);$smarty->assign('share_title_content',$news_shcont_);$smarty->assign('onevision_ad_config',$onevision_ad_config);$smarty->assign('change_video_type',$change_video_type);$smarty->assign('WWW_ROOT',DEFAULT_WWW_ROOT);$smarty->assign('DEFAULT_DOC_ROOT',DEFAULT_DOC_ROOT);$smarty->assign('WWW_ROOT_IMAGES',WWW_ROOT_IMAGE);$smarty->assign('WWW_ROOT_CSS',WWW_ROOT_CSS);$smarty->assign('WWW_ROOT_JS',WWW_ROOT_JS);$smarty->assign('UPDATE_IMAES',UPDATE_IMAES);$smarty->assign('INCLUDE_TMPL_ROOT',INCLUDE_TMPL_ROOT);$smarty->assign('CRON_INDEX_TMPL',CRON_INDEX_TMPL);$smarty->assign('WWW_EXTRATMPL_ROOT',DEFAULT_WWW_ROOT.\"/templates/extratmpl\");$patten = \"/<img.*?src\\s*=\\s*[\\\"|\\']?\\s*([^>\\\"\\'\\s\\[]*)/i\";if( preg_match( $patten , $news['content'])){\t$smarty->assign('CONTENT_IMG',\"yes\");}else{\t$smarty->assign('CONTENT_IMG',\"\");}if( $images && !empty($images) ){        $smarty->assign('first_image',$images['info'][0]['photo_image1']);        if( intval($news['media_count']) == 1 ){                $smarty->assign('first_image',$images['info'][0]['photo_image1']);        }else{ //> 1                $smarty->assign('img_album_id',$img_album_id);        }}if( !empty( $MemberInfo ) && isset($MemberInfo[\"NickName\"])){        $smarty->assign('USER_NAME', $MemberInfo[\"NickName\"] );}$catid = intval($category['id']);$topidinfo = $eladies->getCategory( $category['topid'] );if( $catid == \"1\" ||  $catid == \"2055\" ){\t$smarty->display(\"todaynews/$tpl_layout_name\");\texit;}elseif( $topidinfo && isset($topidinfo['id']) && $topidinfo['id'] != \"1\"){\t$topid = intval( $topidinfo['id'] );\tif( $topid == \"107\" ){\t\t$toptmpl = $tmpl_access[100]['subsection'][107]['twname'];\t\t$path = \"<a href=\\\"/fashion/brands/list.shtml\\\">\".$toptmpl.\"</a>\";\t\t$catinfo = $eladies->getCategory( $catid );                $tmpl  = $catinfo['cname'];                $path.= \" &gt; <a href=\\\"get_tmpl.php?op=list&tpldir=fashion&secdir=brands&catid=\".$catid.\"\\\">\".$catinfo['cname'].\"</a>\";\t\t$tmplname = \"fashion/$tpl_layout_name\";\t}elseif( $topid == \"357\"){\t\t$toptmpl = $tmpl_access[101]['subsection'][357]['twname'];\t\t$path = \"<a href=\\\"/beauty/brands/list.shtml\\\">\".$toptmpl.\"</a>\";\t\t$catinfo = $eladies->getCategory( $catid );\t\t$tmpl  = $catinfo['cname'];\t\t$path.= \" &gt; <a href=\\\"get_tmpl.php?op=list&tpldir=beauty&secdir=brands&catid=\".$catid.\"\\\">\".$catinfo['cname'].\"</a>\";\t\t$tmplname = \"beauty/$tpl_layout_name\";\t}else{\t\t\t$toptmpl = $tmpl_access[$topid]['cname'];\t\t$path = \"<a href=\\\"index.php?op=\".$tmpl_access[$topid]['cname'].\"\\\">\".$tmpl_access[$topid]['twname'].\"</a>\";\t\t$tmpl  =  $tmpl_access[$topid]['subsection'][$catid]['cname'];\t\t$tmplname = $toptmpl.\"/$tpl_layout_name\";\t\t$path.= \" &gt; <a href=\\\"get_tmpl.php?op=list&tpldir=\".$tmpl_access[$topid]['cname'].\"&secdir=\".$tmpl_access[$topid]['subsection'][$catid]['cname'].\"\\\">\".$tmpl_access[$topid]['subsection'][$catid]['twname'].\"</a>\";\t}}else{\t\t$tmpl = $tmpl_access[$catid]['cname'];\t\t$tmplname = $tmpl.\"/$tpl_layout_name\";\t\t$path = \"<a href=\\\"index.php?op=\".$tmpl_access[$catid]['cname'].\"\\\">\".$tmpl_access[$catid]['twcname'].\"</a>\";}if( !$tmpl ){\t$path = \"\";\t$tmplname = \"todaynews/$tpl_layout_name\";}$smarty->assign(\"pathname\",$path);//add click record function  //$smarty->assign('_common_js_clickrecord',$_common_js_clickrecord);//start 1.0 buy.sina.com.tw$HTTP_USER_AGENT=$_SERVER['HTTP_USER_AGENT'];if(\teregi(\"BOT\",strtoupper($HTTP_USER_AGENT)) ||\teregi(\"YAHOO\",strtoupper($HTTP_USER_AGENT)) ||\teregi(\"GOOGLE\",strtoupper($HTTP_USER_AGENT))){\t$b_newsid = intval( $news['id']);\tif($b_newsid==\"22700\" || $b_newsid==\"22688\" || $b_newsid==\"22615\"){\t\t\t$smarty->assign('BUY_REQ_USER_AGENT',\"1\");\t\t}\t} //end 1.0 buy.sina.com.twif( $conn_news && !empty($conn_news )){\tforeach( $conn_news as $key => $val ){\t\t$conn_news[$key]['title'] = cut_str(strip_tags($val['title']),15,null);\t}\t$smarty->assign('conn_news',$conn_news);}else{\t$smarty->assign('conn_news',\"\");}//*************************************************************************************//$specialid = intval(trim($_GET['special'])) ? intval(trim($_GET['special'])) : 0;if($specialid){\t$sql = \"select title from feature where type = '0' and id = '$specialid'\";\t$query = mysql_query($sql);\t$result = mysql_fetch_row($query);\t$title = $result[0];\t\t$smarty->assign('specialID',$specialid);\t$smarty->assign('title',$title);\t\t$sql = \"select href,image,cshow from feature where type = '1' and ztype = '$specialid'\";\t$query = mysql_query($sql);\t$result = mysql_fetch_row($query);\tlist($bannerHref,$bannerImage,$bannerCshow) = $result;\t$smarty->assign('hasBanner',$bannerCshow);\t$smarty->assign('bannerHref',$bannerHref);\t$smarty->assign('bannerImage',$bannerImage);\t\t$smarty->assign('special',1);}if($specialid){    if(strpos($tmplname,'video')){        $sql = \"select content,title from feature where type = '4' and ztype = '$specialid'\";\t    $query = mysql_query($sql);\t    while($result = mysql_fetch_row($query)){\t       \tif($result[0] == $id){\t            $about .= '<option selected>'.$result[1].'</option>';\t        }else {\t            $about .= '<option value=\"./pre_news.php?id='.$result[0].'&special='.$specialid.'\">'.$result[1].'</option>';\t        }\t    }\t\t$smarty->assign('about',$about);    }else{\t\t$sql = \"select ctype from feature where sort='$id'\";\t\t$query = mysql_query($sql);\t\t$result = mysql_fetch_row($query);\t\t$zflID = $result[0];\t\t$sql = \"select sort,title from feature where type = '3' and ctype = '$zflID'\";\t\t$query = mysql_query($sql);\t\twhile($result = mysql_fetch_row($query)){\t\t\tif($result[0] == $id){\t\t\t\t$about .= '<option selected>'.$result[1].'</option>';\t\t\t}\t\t\telse {\t\t\t\t$about .= '<option value=\"./pre_news.php?id='.$result[0].'&special='.$specialid.'\">'.$result[1].'</option>';\t\t\t}\t\t}\t\t\t$smarty->assign('about',$about);\t}\t$sql = \"select sort,title,image from feature where type = '3' and ctype = '$zflID' and sort != '$id' limit 8\";\t$query = mysql_query($sql);\twhile($result = mysql_fetch_row($query)){\t\tlist($tmp['id'],$tmp['title'],$tmp['image']) = $result;\t\tif(!$tmp['image']){\t\t\t$tmp['image'] = 'http://eladies.sina.com.tw/images/dummy.gif';\t\t}\t\t$righ[] = $tmp;\t\tunset($tmp);\t}\t\t$smarty->assign('righ',$righ);}//echo $tmplname;exit;if($specialid){\t$nd_tmpl = explode('/',$tmplname);\t$tmplname = 'fashion/'.$nd_tmpl[1];}////*************************************************************************************debug_log('tmplname:'.$tmplname .' ==== _common_js_clickrecord is ====' . $_common_js_clickrecord);$eladies->replaceClickRecord($news['id'],$_common_js_clickrecord=='news'?0:1);//$smarty->display($tmplname);function debug_log($str) { \tif($fd = @fopen(\"/home/archive/logs/debug_result.txt\", \"a\")) { \t\tfputs($fd, $str . \"\\n\\r\"); \t\tfclose($fd); \t} }?>\n   修复方案：  你们比我专业，你们懂的   版权声明：转载请注明来源 蟋蟀哥哥@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2012-05-05 12:39 厂商回复： 感谢提供! 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-05-05 19:35 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  不知道这个漏洞拿到礼物没    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}