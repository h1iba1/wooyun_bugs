{"id": 13737, "wybug_id": "wooyun-2013-020759", "wybug_title": "Espcms v5.6 暴力注入", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "Yaseng", "wybug_date": "2013-03-28 11:01", "wybug_open_date": "2013-04-02 11:02", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "数字类型注射", "源码审核", "注射漏洞利用技巧", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-04-02：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： Espcms  某处挺有意思的注入,虽然对传值有加密并且随机key,但可以逆向重举这个弱伪随机数来控制sql任意参数,导致系统注入 详细说明：  interface\\membermain.php  第 33行\n$db_sql = \"SELECT * FROM $db_table1 LEFT JOIN $db_table2 ON a.userid = b.userid  WHERE a.userid = $this->ec_member_username_id \";\nec_member_username_id 直接从cookies的ecisp_member_info系统对cookie进行特定的加密 并且随机出key加密函数:public\\class_function.php  第179 行\nfunction eccode($string, $operation = 'DECODE', $key = '@LFK24s224%@safS3s%1f%') {\t\t$result = '';\t\tif ($operation == 'ENCODE') {\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t$char = chr(ord($char) + ord($keychar));\t\t\t\t$result.=$char;\t\t\t}\t\t\t$result = base64_encode($result);\t\t\t$result = str_replace(array('+', '/', '='), array('-', '_', ''), $result);\t\t} elseif ($operation == 'DECODE') {\t\t\t$data = str_replace(array('-', '_'), array('+', '/'), $string);\t\t\t$mod4 = strlen($data) % 4;\t\t\tif ($mod4) {\t\t\t\t$data .= substr('====', $mod4);\t\t\t}\t\t\t$string = base64_decode($data);\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t$char = chr(ord($char) - ord($keychar));\t\t\t\t$result.=$char;\t\t\t}\t\t}\t\treturn $result;\t}\nkey的生成:install\\fun_center.php 第 238 行\n$pscode = rand('99', '999');$config .= \"define('db_pscode', '\" . md5(md5($pscode)) . \"');\\r\\n\";\n额  两次md5 随机值在围观下 cookies中 ecisp_member_info的生成吧 interface\\member.php  第 110 行\n$this->fun->setcookie('ecisp_member_info', $this->fun->eccode(\"$memberread[userid]|$memberread[alias]|$memberread[integral]|$memberread[mcid]|$memberread[email]|$memberread[lastip]|$ipadd|\" . md5($_SERVER['HTTP_USER_AGENT']) . '|' . md5(admin_ClassURL), 'ENCODE', db_pscode));\n用户id 名称  邮箱 等等信息,这些对于攻击者都是可知的,那不是可以重举99到999 的key来匹配这些信息简单计算出key之后,即可以操作cookie,传入任意sql语句例如 官方演示站  \n\nkey为 95e87f86a2ffde5110e93c2823634927查看当前语句把member_info 明文为 1 and  1=2  union select  1,2,3,user(),5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28eccode  之后修改cookie值即可查询出mysql 当前用户\n\n   漏洞证明：  通过一系列编码cookie操作可以获取管理员用户名 密码\n\n登陆系统后台 可在模板编辑处 getshell,从而拿下权限\n\n   修复方案：  过滤使用mt_rand改变算法   版权声明：转载请注明来源 Yaseng@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2013-04-02 11:02 厂商回复：  漏洞Rank：16  (WooYun评价) 最新状态： 2013-04-23：此漏洞已经过官方修正，下载最新包即可!  ", "replys": "漏洞评价：\n评论\n     2013-03-27 17:04 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  给力    \n     2013-03-27 17:06 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @_Evil @Seay 暴力注入=0=~    \n     2013-03-27 17:53 |    \t\tking \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:2        | 喜爱安全，网络游戏安全应用漏洞挖掘)\t\t \n  顶 yangse    \n     2013-03-27 17:58 |    \t\tSeay \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:8        )\t\t \n  【虽然对传值有加密并且随机key,但可以逆向重举这个弱伪随机数来控制sql任意参数,导致系统注入】哈哈，这种最有意思了    \n     2013-03-27 18:01 |    \t\t酱油甲 \t\t\t( 普通白帽子  |\t\t\t        Rank:645 漏洞数:126        | 打个酱油，吃个海蜇~)\t\t \n  洞主好HAPPY    \n     2013-03-27 19:01 |    \t\tDragonEgg \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:18        | 冷漠无情的绅士，温柔善良的坏蛋。)\t\t \n  洞主4个洞，，3个已忽略，这是第四个。。。= =！    \n     2013-03-27 19:05 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @DragonEgg 乌云给加分吧 @xsser    \n     2013-03-27 19:07 |    \t\tYaseng \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:7        | 干)\t\t \n  @DragonEgg  欢迎来到乌云单机吧  -_-    \n     2013-03-27 20:13 |    \t\tw5r2 \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:52        )\t\t \n  @Yaseng @Yaseng @Yaseng @Yaseng 2    \n     2013-04-02 11:16 |    \t\t乌云 \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:5        | 菜鸟一枚,      </iframe>...)\t\t \n  @DragonEgg  楼主好悲剧。 连着被忽略了四个。    \n     2013-04-02 11:24 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  这官方sb吧    \n     2013-04-02 11:52 |    \t\t乌云 \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:5        | 菜鸟一枚,      </iframe>...)\t\t \n  @xsser  我艹。阁下爆粗口了    \n     2013-04-02 22:28 |    \t\t银冥币 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:21        | \"/upload/avatar/avatar_251_b.jpg\" />)\t\t \n  忽略。。    \n     2013-04-04 09:34 |    \t\tDragonEgg \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:18        | 冷漠无情的绅士，温柔善良的坏蛋。)\t\t \n  @Yaseng 哈哈，，让你自己再乌鸦嘴。。= =！    \n     2015-09-01 12:47 |    \t\tElliott \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        | 绝逼不当程序员)\t\t \n  学习了！！！！    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}