{"id": 85938, "wybug_id": "wooyun-2016-0170707", "wybug_title": "天融信TopScanner四处SQL注入漏洞root权限(无需登录)", "wybug_corp": "天融信", "wybug_author": "xfkxfk", "wybug_date": "2016-01-18 09:07", "wybug_open_date": "2016-04-11 16:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-21：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-03-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-03-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-04-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-04-11：\t细节向公众公开  简要描述： 天融信TopScanner四处root权限SQL注入漏洞(无需登录) 详细说明：  天融信TopScanner默认会对输入的参数进行转义，大部分都是用了单引号和双引号对输入参数进行了保护，但是还是有一些地方漏掉了，没有进行引号保护，导致绕过gpc进行sql注入第一处sql注入文件task/htmlReportShow.php\n<?//header('Content-Type:   text/html;   charset=utf-8');require_once(\"CTaskReport.php\");require_once ('jpgraph/jpgraph.php');require_once ('jpgraph/jpgraph_pie.php');require_once ('jpgraph/jpgraph_pie3d.php');$taskId = $_GET[\"task_id\"];//任务ID号$company = $_GET[\"company\"];//公司名称$creator = $_GET[\"creator\"];//报告人姓名$reportName = $_GET[\"name\"];//报表名称$modeID = $_GET[\"modeID\"];//模板ID$style = $_GET[\"style\"];//报告的下载格式：1——html；2——pdf；3——rtf?>......<?php$report = new CTaskReport($taskId,$company,$creator,$name,$modeID);$arrReportMode=array();$arrReportMode=$report->getReportMode($modeID);$m=1;//一级标号foreach($arrReportMode as $mode){    $firstName=$mode['firstName'];//一级项名称    $seconNameArray=$mode['secondArrayName'];//二级项名称数组?>\n看这里$modeID = $_GET[\"modeID\"];进入了函数$arrReportMode=$report->getReportMode($modeID);跟进函数getReportMode，文件task/CTaskReport.php\n//根据模板的ID得到报表所使用的模板所有项（二维数组）\tfunction getReportMode($modeID){\t\t$arrReportMode = array();\t\t$firstMode=array();//一级项名称        $sql = \"select distinct(t_reportsolofirst.RSF_ID),t_reportsolofirst.RSF_Name from t_reportsolorules,t_reportsolofirst where t_reportsolofirst.RSF_ID=t_reportsolorules.RSF_ID and t_reportsolorules.RSM_ID=$modeID\";        $result = $this->dl->queryDB($this->cn,$sql);\t\tif(!$result) return false;\t\twhile($row = $this->dl->fetchArray($result)){\t\t\t$temp=array();\t\t\t$temp['fid']=$row[RSF_ID];\t\t\t$temp['fname']=$row[RSF_Name];\t\t\tarray_push($firstMode,$temp);\t\t}\t\t//var_dump($firstMode);\t\tif(!$firstMode){\t\t\treturn null;\t\t}\t\tforeach($firstMode as $first){\t\t\t$mode=array();//临时变量\t\t\t$mode['firstName']=$first['fname'];//一级名称\t\t\t$firstID=$first['fid'];\t\t\t//$subsql=\"select * from t_reportsolosecond where RSF_ID=$firstID\"; \t\t\t$subsql=\"select * from t_reportsolosecond,t_reportsolorules \";\t\t\t$subsql.=\"where t_reportsolorules.RSM_ID=$modeID and t_reportsolorules.RSF_ID=$firstID \";\t\t\t$subsql.=\"and t_reportsolorules.RSS_ID=t_reportsolosecond.RSS_ID\";\t\t\t$result = $this->dl->queryDB($this->cn,$subsql); if(!$result) return false;\t\t\t$i=1;\t\t\t$temp=array();\t\t\twhile($row = $this->dl->fetchArray($result)){\t\t\t\t$temp[$i]=$row[RSS_Name];\t\t\t\t$i=$i+1;\t\t\t}\t\t\t$mode['secondArrayName']=$temp;//二级名称数组\t\t\tarray_push($arrReportMode,$mode);\t\t}\t\treturn $arrReportMode;\t}\n可以看到$modeID参数直接进入sql语句然后执行，导致sql注入漏洞而且这里没有判断登录状态，所无需登录即可进行注入，见漏洞证明第二处sql注入，文件task/rtf_report.php\n<?phprequire_once(\"phprftlite-1.1.1/rtfreport.php\");require_once(\"CTaskReport.php\");require_once ('jpgraph/jpgraph.php');require_once ('jpgraph/jpgraph_pie.php');require_once ('jpgraph/jpgraph_pie3d.php');$taskId = $_GET[\"task_id\"];//任务ID号$company = $_GET[\"company\"];//公司名称$creator = $_GET[\"creator\"];//报告人姓名$reportName = $_GET[\"name\"];//报表名称$modeID = $_GET[\"modeID\"];//模板ID$style = $_GET[\"style\"];//报告的下载格式：1——html；2——pdf；3——rtf$rtf = new RTF_Report();$rtf->WriteTitle('扫描结果单一任务报告',0);$header = array('报告名称：','单位名称：','报 告 人：','生成日期：');$width = array(40,40);$data = array($reportName,$company,$creator,date('Y年 m月 d日'));$rtf->InsertInfo($header,$width,$data );$report = new CTaskReport($taskId,$company,$creator,$name,$modeID);$arrReportMode=array();$arrReportMode=$report->getReportMode($modeID);\n同理第一处sql注入：$modeID = $_GET[\"modeID\"];参数进入函数$report->getReportMode($modeID)，然后进入sql语句，无引号保护，导致无需登录sql注入漏洞产生第三处sql注入，文件/task/verticalReportShow.php\n<?//header('Content-Type:   text/html;   charset=utf-8');require_once(\"task/CTaskReport.php\");require_once(\"distribute/relation.php\");require_once (\"jpgraph/jpgraph.php\");require_once (\"jpgraph/jpgraph_pie.php\");require_once (\"jpgraph/jpgraph_pie3d.php\");require_once(\"tcpdf_php4/config/lang/chi.php\");require_once(\"tcpdf_php4/tcpdf.php\");$id = $_GET[\"id\"];//当前报告对应的id号$modeID=$_GET[\"modeID\"];//报表模板ID$reportName = $_GET[\"name\"];//报告的名称$company = $_GET[\"company\"];//单位名称$reporter = $_GET[\"reporter\"];//报告人$user = $_GET[\"user\"];//当前登录用户$type = $_GET[\"type\"];//报告类型$style=$_GET[\"style\"];//报告的下载格式：1——html；2——pdf；3——rtf$ipTask = $_GET[\"ip_task\"];//ip:taskid1-taskid2-taskid3;ip:taskid1-..... 手动选$ipList = $_GET[\"ip_list\"];//ip1;ip2;ip3//按月或按年$month = $_GET[\"month\"];//月份$year = $_GET[\"year\"];//年份......$dl = new DataLayer();$cn = $dl->connectDB();$re = new CRelation;$globalReport = new\tCTaskReport($id,$company,$reporter,$reportName,$modeID);//(\"\",\"\",\"\");$taskArr = array();......$arrReportMode=array();\t$arrReportMode=$globalReport->getReportMode_VH($modeID);\t//var_dump($arrReportMode);\t$m=1;//一级标号\tforeach($arrReportMode as $mode){\t\t$firstName=$mode['firstName'];//一级项名称\t\t$seconNameArray=$mode['secondArrayName'];//二级项名称数组\n可以看到参数$modeID=$_GET[\"modeID\"]进入函数$globalReport->getReportMode_VH($modeID);跟进函数getReportMode_VH，文件/task/CTaskReport.php\n//根据模板的ID得到报表所使用的模板项,二维数组\t//对比报告相关（纵向和横向） function getReportMode_VH($modeID){\t\t$arrReportMode = array();\t\t$firstMode=array();//一级项名称        $sql =\"select RO_ID,RO_Name from t_rankone where RO_ID in (select distinct(`RT_OID`) from t_ranktwo where `RT_ID`in (select t_reportrules.RT_ID from t_reportrules where t_reportrules.RS_ID=$modeID))\";\t\t//echo $sql;\t\t$result = $this->dl->queryDB($this->cn,$sql);\n可见参数$modeID进入$sql，最后进入数据库被执行，没有引号保护，导致sql注入漏洞且这里无登录状态验证，导致无需登录即可利用注入第四处sql注入，文件/task/vertical_rtf_report.php\n<?phprequire_once(\"task/CTaskReport.php\");require_once(\"distribute/relation.php\");require_once(\"phprftlite-1.1.1/rtfreport.php\");$dl = new DataLayer();$cn = $dl->connectDB();$id = $_GET[\"id\"];//当前报告对应的id号$modeID=$_GET[\"modeID\"];//报表模板ID$reportName = $_GET[\"name\"];//报告的名称$company = $_GET[\"company\"];//单位名称$reporter = $_GET[\"reporter\"];//报告人$user = $_GET[\"user\"];//当前登录用户$type = $_GET[\"type\"];//报告类型$style=$_GET[\"style\"];$ipTask = $_GET[\"ip_task\"];//ip:taskid1-taskid2-taskid3;ip:taskid1-..... 手动选$ipList = $_GET[\"ip_list\"];//ip1;ip2;ip3//按月或按年$month = $_GET[\"month\"];//月份$year = $_GET[\"year\"];//年份......$globalReport = new\tCTaskReport($id,$company,$reporter,$reportName,$modeID);//(\"\",\"\",\"\");......$arrReportMode=array();\t$arrReportMode=$globalReport->getReportMode_VH($modeID);\n漏洞原理同第三处sql注入，参数$modeID进入$sql，最后进入数据库被执行，没有引号保护，导致sql注入漏洞   漏洞证明：  第一处证明：\n**.**.**.**/task/htmlReportShow.php?task=20120112173538&company=netpower&creator=liuyl&reportName=report1&modeID=1 and 1=1**.**.**.**/task/htmlReportShow.php?task=20120112173538&company=netpower&creator=liuyl&reportName=report1&modeID=1 and 1=2明显的sql盲注\n\n\n第二处SQL注入\n\n第三和第四处同第一处和第二处证明可直接跑出数据，且为root权限：\n\n\n\n\n\n\n\n由于是盲注，跑数据很慢，就不跑出具体数据了，而且容易就将服务器跑挂。。。测试案例：**.**.**.**/**.**.**.**/**.**.**.**/   修复方案：  按照此系统使用引号保护加登录验证即可   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2016-01-18 10:07 厂商回复： 已确认，感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-18 09:12 |    \t\t伤心的猫猫 \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:32        | @sangfor,@qq,@alibaba,@baidu)\t\t \n  6    \n     2016-01-18 09:24 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:228 漏洞数:31        | 开发真是日了狗了)\t\t \n  当安全产品不安全时。。。    \n     2016-01-18 09:46 |    \t\t麦兜 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:10        | 麦兜爱吃苹果.)\t\t \n  师傅这是赚奶粉钱的节奏么？    \n     2016-01-18 10:06 |    \t\tSH0X8001 \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:6        | 你猜)\t\t \n  6666    \n     2016-01-18 10:33 |    \t\t0hey_boy0 \t\t\t( 普通白帽子  |\t\t\t        Rank:123 漏洞数:22        | balabala~)\t\t \n  师傅这是赚奶粉钱的节奏么？     \n     2016-01-21 16:36 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | for fun……)\t\t \n  哈哈，这么挖友商洞真的好么？    \n     2016-01-21 16:53 |    \t\t伤心的猫猫 \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:32        | @sangfor,@qq,@alibaba,@baidu)\t\t \n  @Sai、 你知道xfk是谁吗？她其实是天融信自己人。    \n     2016-01-22 10:17 |    \t\tGeek.Ethan \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 拥有一颗极客的心，却没有极客的行动！)\t\t \n  @伤心的猫猫。xfkxfk邓工，应该是nsfocus的！    \n     2016-01-22 13:19 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:4        | for fun……)\t\t \n  @伤心的猫猫 是绿盟的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}