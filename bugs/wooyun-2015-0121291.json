{"id": 32935, "wybug_id": "wooyun-2015-0121291", "wybug_title": "一次艰难的安全狗规则绕过", "wybug_corp": "安全狗", "wybug_author": "MayIKissYou", "wybug_date": "2015-06-18 08:53", "wybug_open_date": "2015-09-16 10:16", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-21：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-12：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-22：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-16：\t细节向公众公开  简要描述： 估计下面评论又要开始诅咒了。。。。。 详细说明：  1：篇前先附送一个sql注入绕过，字符是%a0，这个字符之前是修正果的，我记得上个版本有两个字符没有过滤的，估计是redfree同学上报了之后，给修复了，但是竟然修复之后的规则还带回滚的，现在又支持%a0的绕过了。就不去刷rank了。这个不细说了，进入正文。2:测试的安全狗的版本是\n\n这个应该是最新的版本,今天刚在官网上下载的3:本机的测试环境是:操作系统:win7应用环境:wamp安全狗:windows apache版本因此这里也是针对的是主流的mysql环境做绕过的时候可以利用各个层面的特性去绕过，这次测试绕过的方向主要是通过mysql的特性去做绕过。下面来看这个艰难的过程。4:测试sql注入规则绕过的时候，我一般都会先去测试 []select[][]from[]这个点的规则经过大量的反复的测试，这里我们得到如下的结果：除开%a0以外,基本上在安全狗的环境下：上面方括号代表位置1-41):位置1允许a-z,A-Z以及_和数字2):位置2允许a-z,A-Z以及_和数字3):位置3允许a-z，A-Z以及＿4):位置4允许a-z,A-Z以及_和数字5:知晓各个点的过滤情况之后接下来就是在脑[wen]海[dang]里翻阅资料，翻阅到之前的那个精华帖子\nhttp://zone.wooyun.org/content/16772\n里面使用了一个字符引起了注意：\nselect * from users where id=\\Nunion select 1,2,3,4,5,6,7,8,9,0\n这里这个\\N的字符能用在union这，能不能用在\\Nfrom前面呢，如果能用在from前面可能我们就能够绕过select from的检测6:在mysql console下进行测试发现：\n\n7:因此这里我们便可以使用这样的payload绕过select from的检测\nselect 1,\\Nfrom table\n\n\n8:我们的目的是要能绕过安全狗防护爆出数据，本来以为可以直接就爆出数据，但是在测试的过程中又发现了一些问题。\n\n分析：由于我们做数据读取的时候，会用到如下的语句select schema_name from information_schema.schemata limit 1这里又由于我们要绕过select from的限制，因此我们就要使用select 1,\\N的形式。而这里我们可以看出来报错貌似要求我们只能有一列的返回结果，但是我们由于引入了\\Ｎ符号，我们必须要有两列。9:之前有作过如下的测试：\n\n可以看出两列也是可以做大小判断的，这里我们利用这个trick，因此我们至少可以试试盲注。我们先用盲注，然后再试试难度较大的报错10:我的第一个schema_name的长度是１８，结果为真的时候显示了数据库记录\n\n11：结果为假的时候显示为空\n\n果真可以盲住。12：接下来我们来看看如何进行报错的注入，我擦勒，又在脑[wen]海[dang]里想了想，又是好长段时间过去了，发现有如下记录：\nhttp://zone.wooyun.org/content/13270\n里面提到了\nmysql> SELECT 2 * if((SELECT * from (select * from test.shop) as `` limit 1)>(SELECT * from test.shop limit 1), 18446744073709551610, 18446744073709551610);ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '(2 * if(((select `article`,`dealer`,`price` from (select `test`.`shop`.`article` AS `article`,`test`.`shop`.`dealer` AS `dealer`,`test`.`shop`.`price` AS `price` from `test`.`shop`) limit 1) > (select `test`.`shop`.`article`,`test`.`shop`.`dealer`,`test`.`shop`.`price` from `test`.`shop` limit 1)),18446744073709551610,18446744073709551610))'\n13:这个报错有限制，提示是ｍｙｓｑｌ5.5版本以上才能使用，既然如此我们试试\n\n这个大概知道了，就应该是两边长度不一样，既然这样粗暴点直接给补齐再试试：\n\n篇后语：市面上在过滤的时候都会允许select和from之间添加英文字符的，这样的waf规则都会被这种方法给bypass。估计够各厂商喝一壶了。到此结束！   漏洞证明：  9:之前有作过如下的测试：\n\n可以看出两列也是可以做大小判断的，因此我们至少可以试试盲注入。我们先用盲注，然后再试试难度大的报错10:我的第一个schema_name的长度是１８，结果为真的时候显示了数据库记录\n\n11：结果为假的时候显示为空\n\n果真可以盲住。12：接下来我们来看看如何进行报错的注入，我擦勒，又在脑[wen]海[dang]里想了想，又是好长段时间过去了，发现有如下记录：\nhttp://zone.wooyun.org/content/13270\n里面提到了\nmysql> SELECT 2 * if((SELECT * from (select * from test.shop) as `` limit 1)>(SELECT * from test.shop limit 1), 18446744073709551610, 18446744073709551610);ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '(2 * if(((select `article`,`dealer`,`price` from (select `test`.`shop`.`article` AS `article`,`test`.`shop`.`dealer` AS `dealer`,`test`.`shop`.`price` AS `price` from `test`.`shop`) limit 1) > (select `test`.`shop`.`article`,`test`.`shop`.`dealer`,`test`.`shop`.`price` from `test`.`shop` limit 1)),18446744073709551610,18446744073709551610))'\n13:这个报错有限制，提示是ｍｙｓｑｌ5.5版本以上才能使用，既然如此我们试试\n\n这个大概知道了，就应该是两边长度不一样，既然这样粗暴点直接给补齐再试试：\n\n篇后语：市面上在过滤的时候都会允许select和from之间添加英文字符的，这样的waf规则都会被这种方法给bypass。到此结束！   修复方案：  这次感觉要添加特例了   版权声明：转载请注明来源 MayIKissYou@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-06-18 10:15 厂商回复： 小伙伴们今天真是热情，接连报了两个问题，在此表示深深的感谢。我们会尽快修复这个问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-18 09:10 |    \t\txy小雨 \t\t\t( 普通白帽子  |\t\t\t        Rank:171 漏洞数:47        | 成为海贼王的男人)\t\t \n  都已经知道艰难了为何要发出来。。。    \n     2015-06-18 09:47 |    \t\tsauren \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:10        | 天天打DOTA，快乐你我他~)\t\t \n  本是同根生，相煎何太急。    \n     2015-06-18 09:58 |    \t\tkav \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        )\t\t \n  本是同根生，相煎何太急。     \n     2015-06-18 10:08 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:17        | 当我又回首一切,这个世界会好吗?)\t\t \n  估计下面评论又要开始诅咒了。。。。。    \n     2015-06-18 10:12 |    \t\tjeary \t\t\t( 普通白帽子  |\t\t\t        Rank:296 漏洞数:89        | (:‮.kcaH eb nac gnihtynA))\t\t \n  让自己无路可走..    \n     2015-06-21 11:50 |    \t\tblack4yl \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | WoHoo !)\t\t \n  呵呵，然而并不止这些...    \n     2015-06-21 21:37 |    \t\tCnb-Web \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | FU)\t\t \n  卖我份 邮箱ttcc20112012@gmail.com    \n     2015-06-21 22:30 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  做黑产中介的小学生，初中生要把你打屎了。。学校门口见    \n     2015-06-23 02:27 |    \t\tBello \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 我是雷锋)\t\t \n  呵呵，然而并不止这些...    \n     2015-06-25 10:59 |    \t\ttestKaI \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        )\t\t \n  然而并没有什么卵用    \n     2015-07-05 22:34 |    \t\tKeen \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | ...)\t\t \n  为了这jb点rank,今天你两个是翔吃多了吧。傻逼    \n     2015-07-22 12:52 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:188        | Only Code Never Lie To Me.)\t\t \n  @Keen 说得好像别人不发你能挖到一样 哈哈哈哈哈    \n     2015-08-29 15:50 |    \t\tMurk Emissary \t\t\t( 实习白帽子  |\t\t\t        Rank:74 漏洞数:14        | 低调做人 低调行事)\t\t \n  @Keen 说得好像别人不发你能挖到一样 哈哈哈哈哈    \n     2015-09-16 10:27 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:41        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @Keen 最喜欢你们这种人了，自己挖不到，还嫉妒别人先发现，就喜欢你这暴脾气。。。    \n     2015-09-16 16:45 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:25        | 不会挖洞洞的猿猿不是好学生)\t\t \n  @Keen 说得好像别人不发你能挖到一样 哈哈哈哈哈    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}