{"id": 16070, "wybug_id": "wooyun-2012-015156", "wybug_title": "躺在床上读代码之phpcms sql注射漏洞", "wybug_corp": "phpcms", "wybug_author": "快点啊！！", "wybug_date": "2012-11-23 14:01", "wybug_open_date": "2012-11-28 14:01", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "8", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-11-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-11-28：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 躺在床上读代码之phpcms [0x01] 详细说明：  在phpcms/modules/formguide/index.php中的57行。\n$formguide_input = new formguide_input($formid);$data = $formguide_input->get($_POST['info']);\n这里调用了一个class,formguide_input，然后get函数处理了$_POST过来的info，那么，我们看看这个get函数\nfunction get($data,$isimport = 0) {\t\t$this->data = $data;\t\t$info = array();\t\tforeach($this->fields as $field) {\t\t\t…… 省略几行也不会死\t\t\t$value = $data[$field['field']];                        //在这里的value使用了data的值，data就是$_POST['info']                                                 …… 省略几行也不会死\t\t\t\t\t\tif($maxlength && $length > $maxlength) {\t\t\t\tif($isimport) {\t\t\t\t\t$value = str_cut($value,$maxlength,'');                                        //value使用了str_cut截取了字节\t\t\t\t} else {\t\t\t\t\tshowmessage($name.' '.L('not_more_than').' '.$maxlength.L('characters'));\t\t\t\t}\t\t\t} elseif($maxlength) {\t\t\t\t$value = str_cut($value,$maxlength,'');                                //又一次截取\t\t\t}                    省略……             return $info;\n str_cut函数是phpcms自定义的截取函数，第三个参数是控制dot是不是...，所以这里截取的时候当value是123\\'的时候，如果截取字段是4的话，将截取出一个反斜线\\出来。而后这部分的变量进入了insert在phpcms/modules/formguide/index.php中的63行。$dataid = $this->m_db->insert($data, true);导致了SQL注射漏洞以下为str_cut的代码\nfunction str_cut($string, $length, $dot = '...') {\t$strlen = strlen($string);\tif($strlen <= $length) return $string;\t$string = str_replace(array(' ','&nbsp;', '&amp;', '&quot;', '&#039;', '&ldquo;', '&rdquo;', '&mdash;', '&lt;', '&gt;', '&middot;', '&hellip;'), array('∵',' ', '&', '\"', \"'\", '“', '”', '—', '<', '>', '·', '…'), $string);\t$strcut = '';\tif(strtolower(CHARSET) == 'utf-8') {\t\t$length = intval($length-strlen($dot)-$length/3);\t\t$n = $tn = $noc = 0;\t\twhile($n < strlen($string)) {\t\t\t$t = ord($string[$n]);\t\t\tif($t == 9 || $t == 10 || (32 <= $t && $t <= 126)) {\t\t\t\t$tn = 1; $n++; $noc++;\t\t\t} elseif(194 <= $t && $t <= 223) {\t\t\t\t$tn = 2; $n += 2; $noc += 2;\t\t\t} elseif(224 <= $t && $t <= 239) {\t\t\t\t$tn = 3; $n += 3; $noc += 2;\t\t\t} elseif(240 <= $t && $t <= 247) {\t\t\t\t$tn = 4; $n += 4; $noc += 2;\t\t\t} elseif(248 <= $t && $t <= 251) {\t\t\t\t$tn = 5; $n += 5; $noc += 2;\t\t\t} elseif($t == 252 || $t == 253) {\t\t\t\t$tn = 6; $n += 6; $noc += 2;\t\t\t} else {\t\t\t\t$n++;\t\t\t}\t\t\tif($noc >= $length) {\t\t\t\tbreak;\t\t\t}\t\t}\t\tif($noc > $length) {\t\t\t$n -= $tn;\t\t}\t\t$strcut = substr($string, 0, $n);\t\t$strcut = str_replace(array('∵', '&', '\"', \"'\", '“', '”', '—', '<', '>', '·', '…'), array(' ', '&amp;', '&quot;', '&#039;', '&ldquo;', '&rdquo;', '&mdash;', '&lt;', '&gt;', '&middot;', '&hellip;'), $strcut);\t} else {\t\t$dotlen = strlen($dot);\t\t$maxi = $length - $dotlen - 1;\t\t$current_str = '';\t\t$search_arr = array('&',' ', '\"', \"'\", '“', '”', '—', '<', '>', '·', '…','∵');\t\t$replace_arr = array('&amp;','&nbsp;', '&quot;', '&#039;', '&ldquo;', '&rdquo;', '&mdash;', '&lt;', '&gt;', '&middot;', '&hellip;',' ');\t\t$search_flip = array_flip($search_arr);\t\tfor ($i = 0; $i < $maxi; $i++) {\t\t\t$current_str = ord($string[$i]) > 127 ? $string[$i].$string[++$i] : $string[$i];\t\t\tif (in_array($current_str, $search_arr)) {\t\t\t\t$key = $search_flip[$current_str];\t\t\t\t$current_str = str_replace($search_arr[$key], $replace_arr[$key], $current_str);\t\t\t}\t\t\t$strcut .= $current_str;\t\t}\t}\treturn $strcut.$dot;}\n   漏洞证明：  我想证明一下，可是这个功能在我本地测试失败，该表不存在，但是漏洞步骤确实如上。   修复方案：  进入数据库的东西不能随意取消dot的。   版权声明：转载请注明来源 快点啊！！@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2012-11-28 14:01 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-11-23 14:34 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  好淫荡的名字    \n     2012-11-23 15:29 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  碉堡了。。。。    \n     2012-11-23 17:49 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n   每天躺一次 一天一个呀    \n     2012-11-28 15:12 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @快点啊！！ 真应该叫躺哥    \n     2012-11-28 17:08 |    \t\tEnjoy_Hacking \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:8        | 时间无言，如此这般。)\t\t \n  躺在床上对着代码撸？？？    \n     2012-12-05 09:27 |    \t\tw5r2 \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:52        )\t\t \n  @Enjoy_Hacking 这个说法NB    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}