{"id": 53667, "wybug_id": "wooyun-2014-066853", "wybug_title": "DouPHP存储型XSS一枚可打后台管理", "wybug_corp": "douco.com", "wybug_author": "magerx", "wybug_date": "2014-07-04 12:28", "wybug_open_date": "2014-09-29 12:30", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["持久型", "存储型", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-09：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向公众公开  简要描述： xss 详细说明：  漏洞文件：admin/login.php:68行\n$query = $dou->select($dou->table(admin), '*', \"user_name = '$_POST[user_name]'\");\t$user = $dou->fetch_array($query);\t\tif (!is_array($user))\t{\t\t$dou->create_admin_log($_LANG['login_action'] . \": \" . $_POST['user_name'] . \" ( \" . $_LANG['login_user_name_wrong'] . \" ) \");\t\t$dou->dou_msg($_LANG['login_input_wrong'], 'login.php', 'out');\t\texit;\t}\telseif (md5($_POST['password']) != $user['password'])\t{\t\tif ($_POST['password'])\t\t{\t\t  $dou->create_admin_log($_LANG['login_action'] . \": \" . $_POST['user_name'] . \" ( \" . $_LANG['login_password_wrong'] . \" ) \");\t\t}\t\t$dou->dou_msg($_LANG['login_input_wrong'], 'login.php', 'out');\t\texit;\t}\n可以看到当用户名或密码错误时有一次create_admin_log操作：admin/include/action.class.php:210行\nfunction create_admin_log($action)\t{\t\t$create_time = time();\t\t$ip = $this->get_ip();\t\t$sql = \"INSERT INTO \" . $this->table('admin_log') . \" (id, create_time, user_id, action ,ip)\" .\t\t\" VALUES (NULL, '$create_time', '$_SESSION[user_id]', '$action', '$ip')\";\t\t$this->query($sql);\t}\n记录相关信息到admin_log中，我们来看看ip来自get_ip()include/common.class.php:122行\nfunction get_ip()\t{\t\tstatic $ip;\t\tif (isset ($_SERVER))\t\t{\t\t\tif (isset ($_SERVER[\"HTTP_X_FORWARDED_FOR\"]))\t\t\t{\t\t\t\t$ip = $_SERVER[\"HTTP_X_FORWARDED_FOR\"];\t\t\t}\t\t\telse\t\t\t\tif (isset ($_SERVER[\"HTTP_CLIENT_IP\"]))\t\t\t\t{\t\t\t\t\t$ip = $_SERVER[\"HTTP_CLIENT_IP\"];\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t$ip = $_SERVER[\"REMOTE_ADDR\"];\t\t\t\t}\t\t}\t\telse\t\t{\t\t\tif (getenv(\"HTTP_X_FORWARDED_FOR\"))\t\t\t{\t\t\t\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\t\t\t}\t\t\telse\t\t\t\tif (getenv(\"HTTP_CLIENT_IP\"))\t\t\t\t{\t\t\t\t\t$ip = getenv(\"HTTP_CLIENT_IP\");\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t$ip = getenv(\"REMOTE_ADDR\");\t\t\t\t}\t\t}\t\treturn $ip;\t}\nXFF,本来想用来注入的，但是不报错，而且每次都要输验证码，转而想到XSS,于是发现后台操作记录查看的地方会有get_admin_log操作\nfunction get_admin_log($user_id = '', $num = '')\t{\t\tif ($user_id)\t\t{\t\t\t$where = \" WHERE user_id = \" . $user_id;\t\t}\t\tif ($num)\t\t{\t\t\t$limit = \" LIMIT $num\";\t\t}\t\t$sql = \"SELECT * FROM \" . $this->table('admin_log') . $where . \" ORDER BY id DESC\" . $limit;\t\t$query = $this->query($sql);\t\twhile ($row = $this->fetch_array($query))\t\t{\t\t\t$create_time = date(\"Y-m-d\", $row[create_time]);\t\t\t$user_name = $this->get_one(\"SELECT user_name FROM \" . $this->table('admin') . \" WHERE user_id = \" . $row['user_id']);\t\t\t$log_list[] = array (\t\t\t\t\"id\" => $row['id'],\t\t\t\t\"create_time\" => $create_time,\t\t\t\t\"user_name\" => $user_name,\t\t\t\t\"action\" => $row['action'],\t\t\t\t\"ip\" => $row['ip']\t\t\t);\t\t}\t\treturn $log_list;\t}\n同样没做什么过滤，由于数据库中IP字段长度限制，所以构造多次payload:1、\n*/</script>\n2、\n*/alert(2)/*\n3、\n<script>/*\n由于按时间排序，所以顺序相反，分多次插入，中间用/**/注释，代码成功执行，\n\n当然用到IP地方有很多处，也请厂商自己修正下。   漏洞证明：  \n\n   修复方案：  。   版权声明：转载请注明来源 magerx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-29 12:30 厂商回复：  最新状态： 2014-07-11：已经修正，谢谢提醒  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}