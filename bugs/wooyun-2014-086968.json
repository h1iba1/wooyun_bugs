{"id": 47635, "wybug_id": "wooyun-2014-086968", "wybug_title": "ThinkPHP补丁修复不当导致SQL注入", "wybug_corp": "ThinkPHP", "wybug_author": "phith0n", "wybug_date": "2014-12-12 21:24", "wybug_open_date": "2015-01-18 21:26", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "12", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["代码审计", "源码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-13：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-18：\t细节向公众公开  简要描述： 放学回寝室，发现大家都在吐槽这个补丁。这补丁我也是看醉了。逻辑有问题啊。。 详细说明：  这是ThinkPHP对这次注入的补丁：https://github.com/liu21st/thinkphp/commit/23c6e130ce75f2132e5b48699363a75ed28e15b2\n}elseif(is_array($val) && isset($_REQUEST[$key]) && is_array($_REQUEST[$key])){\t$options['where'][$key]\t=\t(string)$val;\n这逻辑……简单说一下他的逻辑：$key是数据库字段名字，$val是我传入的参数。当$val是一个数组，而且$_REQUEST[$key]存在并且$_REQUEST[$key]是一个数组，则强制将我传入的参数$val转换成字符串。可是，$_REQUEST[$key]和我传入的$val有直接关系吗？例如\n$map['username'] = $_POST['name'];M('user')->where($map)->find();\n这时候$key是username，但实际我传入的是$_POST['name']，是name。thinkphp的开发者是不是把两个“key”给弄混了？是被我找的onethink的例子误导了吗？我就不找实例了，举个简单例子吧。如果代码这样写（POST中的key和数据库的key相同，都是uname）\npublic function test()\t{\t\t\t\t$u = M('user')->where(array(\t\t\t'uname' => I('post.uname', '', 'trim')\t\t))->find();\t\tdump($u);\t}\n按这个确实可以防御，可见：\n\n不过如果两个key不一样：\npublic function test()\t{\t\t\t\t$u = M('user')->where(array(\t\t\t'uname' => I('post.name', '', 'trim')\t\t))->find();\t\tdump($u);\t}\n继续注入啊：\n\n   漏洞证明：  见详情。。。   修复方案：  我自己也没想好。。。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-01-18 21:26 厂商回复： 感谢作者，不过鉴于还是前面一个漏洞的补遗，就不再重复确认了。参考前面漏洞的说明和更新~ 官方会更新漏洞补丁 漏洞Rank：10  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-12 21:29 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  沙发    \n     2014-12-12 21:31 |    \t\tjusker \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:11        | xxoo决定未来)\t\t \n  以后再用thinkphp直接垛手，还是tornado靠谱    \n     2014-12-12 21:35 |    \t\t乌云 \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:14        | a)\t\t \n  。。。。。。。。。打脸啊。。。    \n     2014-12-12 21:37 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  补天不是发了吗？    \n     2014-12-12 21:39 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @泳少 那不是我，我也不知道他的方法和我的一样不~    \n     2014-12-12 21:41 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  @phith0n 会不会是因为泄漏问题?感觉像是厂商泄漏出来的    \n     2014-12-12 21:44 |    \t\tdiguoji \t\t\t( 普通白帽子  |\t\t\t        Rank:323 漏洞数:79        | 中国吉林长春)\t\t \n  乌云有你们更精彩    \n     2014-12-12 21:47 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @phith0n 恩。期待ph牛的精彩思路喔~    \n     2014-12-12 21:51 |    \t\tbacktrack丶yao \t\t\t( 普通白帽子  |\t\t\t        Rank:290 漏洞数:107        | \"><img src=x onerror=alert(666666);> <im...)\t\t \n  又来了    \n     2014-12-12 21:53 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @子非海绵宝宝 只因厂商漏洞修复回了这样一句话，\"目前的github版本TP和OT均已修正~\"https://github.com/liu21st/thinkphp/commit/23c6e130ce75f2132e5b48699363a75ed28e15b2 然后就..    \n     2014-12-12 22:57 |    \t\t风情万种 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:63        | 不再相信爱了)\t\t \n  叼    \n     2014-12-12 23:01 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  piapia    \n     2014-12-12 23:38 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  卧槽    \n     2014-12-12 23:40 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2014-12-13 13:19 |    \t\tmilk \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:5        | 美女，你肥皂掉了)\t\t \n  这脸打得好    \n     2014-12-14 12:53 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  https://butian.360.cn/vul/info/id/40907 360上不是已经提交了吗。    \n     2014-12-14 13:01 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @進撃のDanny 360上被人提交了就不许我交乌云了？你咋知道我们方法是不是一样？    \n     2014-12-14 13:13 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  @phith0n 大牛随便提交哪里都行。那位PM你啥了，我们就不知道了，呵呵。    \n     2014-12-14 13:16 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @進撃のDanny 呵呵。身正不怕影儿歪，我敢实名交漏洞，我心里就没鬼。小人之心妒君子之腹的人，我也见多了。    \n     2014-12-14 13:35 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  @phith0n 哦，这么巧PM你后就发现问题了，刚出补丁时干嘛去了呢，私底下交流技术没有问题，哪里提交也没有问题。请不要扯到人品上来，我非小人，你也非君子。    \n     2014-12-14 13:53 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @進撃のDanny 我们聊的什么你知道么？你为何用自己的想法来思考别人？这不算小人之腹么？他加我告诉我让我多看看，我之前没仔细看所以没发现，他提醒我之后我细读了一下发现了，有什么问题么？你把别人想那么肮脏是为何？我敢把我聊天记录给任何人看，他有透露一丝一毫我立马退出圈子。    \n     2014-12-14 14:20 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  @phith0n 我思考什么了，我只是以白帽子身份说下我说看到的，在你眼中别人都是小人之腹就是你君子么，你这样未免有点自大吧？你和他说什么了，不用和我说，也不想知道。基本都是那个问题，看补丁都可以猜到是哪个漏洞，没意思。    \n     2014-12-14 14:26 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @進撃のDanny 君子不会无凭无证质疑别人。并且我眼中大部分人都是君子，楼上泳少也问过我同样的问题。看回复就知道怎样的人是我口中的君子了。    \n     2014-12-14 14:42 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  @phith0n 就是说了下我所看到的而已，没有质疑之意，作为一个白帽子都有言论自由。恩，这样最好。    \n     2014-12-14 14:50 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @進撃のDanny 那就不吵了，我也正好借这件事澄清一下，免得再被其他人误会。    \n     2014-12-14 23:44 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  php 5.3以后吗？    \n     2014-12-15 09:14 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @_Evil 不是cookie的问题    \n     2014-12-15 16:34 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @phith0n 呃，补了rank，分析的很好啊。    \n     2014-12-17 17:48 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @疯狗 感谢~~真好    \n     2014-12-17 20:45 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @phith0n 别吵吧，亲，别人能研究到的，自己也可以。管他咋说，嘴巴长别人嘴里，再说了大家都不知道详情更不知道如何分析这个补丁然后出注入的。所以吧。。。咳咳    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}