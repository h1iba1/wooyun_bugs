{"id": 47968, "wybug_id": "wooyun-2014-079091", "wybug_title": "Supesite 前台二次注入一枚", "wybug_corp": "Discuz!", "wybug_author": "′雨。", "wybug_date": "2014-10-12 18:16", "wybug_open_date": "2015-01-10 18:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-10：\t细节向公众公开  简要描述： 二次猪肉。 详细说明：  在cp.php中\n$ac = empty($_GET['ac']) ? 'profile' : trim($_GET['ac']);if(in_array($ac, array('index', 'news', 'profile', 'credit', 'models'))) {\tinclude_once(S_ROOT.'./source/cp_'.$ac.'.php');\n包含文件进来在source/cp_news.php中\n$newsarr = array('subject' => $_POST['subject'],\t\t\t\t\t 'catid' => $_POST['catid'],\t\t\t\t\t 'type' => $_POST['type'],\t\t\t\t\t 'lastpost' => $_SGLOBAL['timestamp']);\t$itemarr = array('message' => $_POST['message'],\t\t\t\t\t'relativetags' => addslashes(serialize($tagnamearr)),\t\t\t//相关TAG\t\t\t\t\t 'newsfrom' => $_POST['newsfrom'],\t\t\t\t\t 'newsauthor' => $_POST['newsauthor'],\t\t\t\t\t 'newsfromurl' => $_POST['newsfromurl'],\t\t\t\t\t 'postip' => $_SGLOBAL['onlineip'],\t\t\t\t\t 'includetags' => postgetincludetags($_POST['message'], $tagnamearr)\t\t\t\t\t);\n这里对投稿时的处理。\n$itemarr['itemid'] = inserttable('spaceitems', $newsarr, 1); //这里  \t\t\tinserttable('spacenews', $itemarr);\t\t\tgetreward('postinfo');\t\t\tpostspacetag('add', $_POST['type'], $itemarr['itemid'], $tagarr,1);\t\t\t$do = 'pass';\t\t} else {\t\t\t$itemarr['itemid'] = inserttable('postitems', $newsarr, 1);\n全局对_POST转义了 然后转义入库  转义符就没了。找找出库的地方。在viewcomment.php中\nif($channels['menus'][$type]['type'] == 'model') {\tinclude_once(S_ROOT.'./function/model.func.php');\t$cacheinfo = getmodelinfoall('modelname', $type);\tif(empty($cacheinfo['models'])) {\t\tshowmessage('visit_the_channel_does_not_exist', S_URL);\t}\t$modelsinfoarr = $cacheinfo['models'];\t$categories = $cacheinfo['categories'];\t$query = $_SGLOBAL['db']->query('SELECT i.*, ii.* FROM '.tname($type.'items').' i, '.tname($type.'message').' ii WHERE i.itemid = ii.itemid AND i.itemid=\\''.$itemid.'\\' AND i.allowreply=\\'1\\'');\t$ismodle = '1';} else {\t$query = $_SGLOBAL['db']->query('SELECT i.*, ii.* FROM '.tname('spaceitems').' i, '.tname('spacenews').' ii WHERE i.itemid = ii.itemid AND i.itemid=\\''.$itemid.'\\' AND i.allowreply=\\'1\\'');//这里查询出来\t$ismodle = '0';}if(!$item = $_SGLOBAL['db']->fetch_array($query)) showmessage('not_found', S_URL)//出库;\n$channel = $type = empty($item['type']) ? $type : $item['type'];赋值的是查询出来的 就能引入单引号了。\n$sql = \"SELECT COUNT(*) FROM \".tname('spacecomments').\" WHERE itemid='$itemid' AND status='1' AND `type`='$type' $wherestr \";$listcount = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($sql), 0);$iarr = array();\n再把出库的带入到了查询当中造成了注入。在viewnews.php中 也有出库的\nif(!empty($_SCONFIG['viewspace_pernum']) && $listcount) {\t$repeatids = array();\t$j = 1;\t$sql = \"SELECT c.* FROM \".tname('spacecomments').\" c WHERE c.itemid='$news[itemid]' AND c.type='$news[type]' AND status='1' ORDER BY c.dateline \".($_SCONFIG['commorderby']?'DESC':'ASC').\" LIMIT 0, $_SCONFIG[viewspace_pernum]\";\t$query = $_SGLOBAL['db']->query($sql);\n注册一个会员 然后发帖入库\n\n\n\nviewnews.php的一样 就不说了。   漏洞证明：  \n\n   修复方案：  出库了再转义下。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-13 09:46 厂商回复： supesite已经停止维护，感谢您关注我们的产品。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-12 18:26 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  图破得？    \n     2014-10-12 18:48 |    \t\t小飞 \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:12        | 挖洞对于16岁的我来说实在是太艰难了！10...)\t\t \n  我说我下午围观了雨挖到这个洞你们怎么看~    \n     2014-10-12 21:14 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  叼    \n     2014-10-12 21:19 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  @′  雨。 雨牛，提现多少了？    \n     2014-10-12 21:22 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @ki11y0u 我不会告诉你 ，雨牛，在360库带一个月就拿了20000    \n     2014-10-12 21:26 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  @贫道来自河北 我擦类，我要去蓝翔学挖掘机。    \n     2014-10-12 21:30 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  @ki11y0u 推荐你学完挖掘机再去北大青鸟学计算机，最后，到新东方找王老师学烹饪，他会教你如何用电脑控制的挖掘机去炒菜的    \n     2014-10-12 21:45 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  @′  雨。 审计牛 求合作呀    \n     2014-10-12 22:12 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  你不可以这么叼。真的不可以、起码你得带上我啊...    \n     2014-10-13 08:11 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:40        | 我是残废，啦啦啦啦)\t\t \n  雨牛闷声发大财    \n     2014-10-13 09:36 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这个好像很老的系统了啊    \n     2014-10-13 17:19 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @′ 雨 你可真快啊  我本来审完dz 下来就要看这个 突然看见你发了三个注入 厉害！！！！    \n     2014-10-15 08:01 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @menmen519   啊哈  放了半天的假 就看了看    \n     2015-01-10 21:18 |    \t\t相关部们 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | 简要介绍够简要吧。)\t\t \n  @′  雨。 因雨哥省略了太多字，无奈前来求细节  请雨哥私信 谢谢    \n     2015-08-21 17:29 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}