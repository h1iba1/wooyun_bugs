{"id": 7149, "wybug_id": "wooyun-2013-042746", "wybug_title": "成都市某管理局网上报建大厅任意文件上传漏洞", "wybug_corp": "成都市规划管理局网上报建大厅", "wybug_author": "袋鼠妈妈", "wybug_date": "2013-11-13 10:07", "wybug_open_date": "2013-12-28 10:08", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-12-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-28：\t细节向公众公开  简要描述： 成都市某管理局网上报建大厅任意文件上传漏洞 详细说明：  地址:\nhttp://netspnew.cdgh.gov.cn/\n\n\n1.“报建申请”随便选择一个项目,如:\nhttp://netspnew.cdgh.gov.cn/UserApply.aspx?type=5\n2.选择上传\n\n\n\n3.虽然在上传时，用TamperData没有抓到有用的内容，但经过上传不同后缀的文件发现一点:任何文件上传后文件名修改为1,如有多个同类型文件,则依次为2、3等。虽然上传没有抓到东西，这个删除按钮，就不信不会与服务器交互，点击“删除”按钮:抓包:\nPOSTDATA=a=%5B2013%5D35104229&b=1.aspx\n转换之后就是POSTDATA=a=[2013]35104229&b=1.aspx判断[2013]35104229应该是为文件夹名称。\n\n4.但是还是不够.没有获取到真正的路径，回过头再来看看页面内容，对于\"选择文件\"按钮的内容：\n<object id=\"upfile_0Uploader\" width=\"120\" height=\"30\" type=\"application/x-shockwave-flash\" data=\"js/uploadify.swf\" style=\"visibility: visible;\"><param name=\"quality\" value=\"high\"><param name=\"wmode\" value=\"opaque\"><param name=\"allowScriptAccess\" value=\"sameDomain\"><param name=\"flashvars\" value=\"uploadifyID=upfile_0&pagepath=/&buttonText=%E9%80%89%E6%8B%A9%E6%96%87%E4%BB%B6&script=UploadHandler.ashx&folder=FileUpload/%5B2013%5D35104229&scriptData=fileTxtname%3D&width=120&height=30&wmode=opaque&method=get&queueSizeLimit=999&simUploadLimit=999&fileDesc=图片文件(*.png;*.doc;*.gif;*.jpg;*.bmp;*.jpeg;*.doc;*.docx;*.xls;*.ppt;*.txt;*.pdf;*.rar;*.zip;*.tif)&fileExt=*.png;*.doc;*.gif;*.jpg;*.bmp;*.jpeg;*.doc;*.docx;*.xls;*.ppt;*.txt;*.pdf;*.rar;*.zip;*.tif&auto=true&sizeLimit=5242880&fileDataName=Filedata&queueID=showupfile_0\">\n看起来是通过uploadify.swf上传,解码之后：\n<object id=\"upfile_0Uploader\" width=\"120\" height=\"30\" type=\"application/x-shockwave-flash\" data=\"js/uploadify.swf\" style=\"visibility: visible;\"><param name=\"quality\" value=\"high\"><param name=\"wmode\" value=\"opaque\"><param name=\"allowScriptAccess\" value=\"sameDomain\"><param name=\"flashvars\" value=\"uploadifyID=upfile_0&pagepath=/&buttonText=选择文件&script=UploadHandler.ashx&folder=FileUpload/[2013]35104229&scriptData=fileTxtname=&width=120&height=30&wmode=opaque&method=get&queueSizeLimit=999&simUploadLimit=999&fileDesc=图片文件(*.png;*.doc;*.gif;*.jpg;*.bmp;*.jpeg;*.doc;*.docx;*.xls;*.ppt;*.txt;*.pdf;*.rar;*.zip;*.tif)&fileExt=*.png;*.doc;*.gif;*.jpg;*.bmp;*.jpeg;*.doc;*.docx;*.xls;*.ppt;*.txt;*.pdf;*.rar;*.zip;*.tif&auto=true&sizeLimit=5242880&fileDataName=Filedata&queueID=showupfile_0\">\n\nfolder=FileUpload/[2013]35104229&scriptData=fileTxtname=\n这下全有了,上传ASPX木马文件路径为:\nhttp://netspnew.cdgh.gov.cn/fileupload/[2013]35104229/1.aspx\n\n\n进入查看UserApply.aspx页面代码,和分析的一样:\n$('#'+_id+'').uploadify({                'uploader': 'js/uploadify.swf',                'script': 'UploadHandler.ashx',                'cancelImg': 'js/uploadify-cancel.png',                'folder': 'FileUpload/'+applyid,\t\t\t\t'method':\"get\",                'scriptData':{fileTxtname:escape(_filename)},                'multi': false,                'auto': true,                'queueID': _showid,                'queueSizeLimit': 999,                'simUploadLimit': 999,                'buttonText': '选择文件',                'sizeLimit':5*1024*1024,                'fileExt': '*.png;*.doc;*.gif;*.jpg;*.bmp;*.jpeg;*.doc;*.docx;*.xls;*.ppt;*.txt;*.pdf;*.rar;*.zip;*.tif',                'fileDesc': '图片文件(*.png;*.doc;*.gif;*.jpg;*.bmp;*.jpeg;*.doc;*.docx;*.xls;*.ppt;*.txt;*.pdf;*.rar;*.zip;*.tif)',                'removeCompleted': true,\t\t\t    'onSelectOnce': function (event, data) {\t\t\t\t\t\t     $(\"showname\").val(_filename);\t\t\t\t\t\t    $('#status-message').text(data.filesSelected + ' 个文件加入上传队列');                },                'onComplete': function (event, queueId, fileObj, response, data) {                    //alert(response.split('|')[1]); //这里获取上传后的URL路径，用来在前台显示 \t\t\t\t\t//alert(_filenum.val(parseInt(_filenum.val())+1)+response);\n另,不用TamperData而直接用抓包工具,在上传的时候就能够获取到URL:\n\n   漏洞证明：  \n\n\n\nShell地址（请删除）:\nhttp://netspnew.cdgh.gov.cn/fileupload/[2013]35104229/1.aspx\n   修复方案：  修复   版权声明：转载请注明来源 袋鼠妈妈@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2013-11-17 21:21 厂商回复： CNVD确认并复现所述情况，已经转由CNCERT下发给四川分中心，由其后续联系网站管理方处置。该案例文件上传测试的TamperData分析还是比较好的。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-13 10:23 |    \t\t雷锋小号 \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云现在就缺我这种默默顶贴从来不求脸熟的...)\t\t \n  l乌云现在就缺我这种默默顶贴从来不求脸熟的雷锋    \n     2013-11-13 10:58 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  @雷锋小号 雷锋叔叔辛苦了~~    \n     2013-11-13 12:10 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @雷锋小号 已封    \n     2013-12-28 12:10 |    \t\t麻花藤 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | ด้้้้้็็็็็้้้้้็็็็...)\t\t \n  目测此网站基本没啥安全设置    \n     2014-10-30 16:37 |    \t\tStranger \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 我注意你很久了.....)\t\t \n  政府类网站是不屑维护的......    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}