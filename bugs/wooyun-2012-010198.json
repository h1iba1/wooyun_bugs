{"id": 17691, "wybug_id": "wooyun-2012-010198", "wybug_title": "Stcms的一个sql注射", "wybug_corp": "Stcms", "wybug_author": "Zvall", "wybug_date": "2012-07-27 10:31", "wybug_open_date": "2012-09-10 10:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-07-27：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2012-09-10：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： Sql 注入 详细说明：  \n$mysql = new mysql();$search_arr = array(\"/\\bunion /i\",\"/\\bselect /i\",\"/\\bupdate /i\",\"/\\boutfile /i\",\"/\\bor /i\",\"/\\bdelete /i\",\"/\\binsert /i\"); $replace_arr = array(\"union&nbsp;\",\"select&nbsp;\",\"update&nbsp;\",\"outfile&nbsp;\",\"or&nbsp;\",\"delete&nbsp;\",\"insert&nbsp;\"); $_POST = stripSql($_POST,$search_arr,$replace_arr);$_GET = stripSql($_GET,$search_arr,$replace_arr);$_COOKIE = stripSql($_COOKIE,$search_arr,$replace_arr);unset($search_arr, $replace_arr);if(!get_magic_quotes_gpc()){\t$_POST = addslash($_POST);\t$_GET = addslash($_GET);\t$_COOKIE = addslash($_COOKIE);\t$_SERVER = addslash($_SERVER);}@extract($_POST, EXTR_SKIP);@extract($_GET, EXTR_SKIP);sriipSql:function stripSql($str,$search_arr,$replace_arr) {\tif(is_array($str)) {\t\tforeach($str as $key => $value) {\t\t\t$result[$key] = stripSql($value,$search_arr,$replace_arr);\t\t}\t} else {\t\t$result = preg_replace($search_arr,$replace_arr,$str);\t}\treturn $result;把我们的 union+空格  替换成 union&nbsp; //这个过滤有些问题我们只要把空格替换诸如：+| N个空格| tab | enter | 等index.php?8'+/*!Union*/+/*!SelEct*/+1,2,3,4,version(),6,7,8,在magic_quotes_gpc关闭时 会调用 addslash过滤GET POST COOKIESFunction addslash{if(is_array($str)) {\t\tforeach($str as $key => $value) {\t\t\t$result[$key] = addslash($value);\t\t}\t} else {\t\t$result = @mysql_real_escape_string($str) ? mysql_real_escape_string($str) : addslashes($str);\t}\treturn $result;调用mysql_real_escape_string函数来转义Sql语句中特殊字符，它有一个特征就是会考虑到连接的当前字符集除了例如 Set names GBK  就是期望返回GKB集编码上面说了mysql_real_escape_string会考虑当前连接的字符集除了mysql_set_charset 能改变默认字符集.其它的都是默认latin-1Mysql_real 这时使用的是默认的 导致和addslashes处理一样的效果SQL注入U.php 50-65行\tcase 'list':\t\t\t$totalNum = $mysql->numTable(\"member\", $where);\t\t$pageNum = 20;\t\t$totalPage = intval($totalNum/$pageNum) == $totalNum/$pageNum ? $totalNum/$pageNum : intval($totalNum/$pageNum)+1;\t\t$page = $page ? $page : 1;\t\t$page = $page>$totalPage ? $totalPage : $page;\t\t$page = $page<1 ? 1 : $page;\t\t$members = $mysql->select(\"member\",\"id,name,time,money,provience,city,picture\",$where,array(\"id DESC\"),array(($page-1)*$pageNum,$pageNum));\t\trequire(INCLUDE_PATH.\"page.class.php\");\t\t$pageClass = new page($page,$totalNum,$pageNum, WEB_URL.\"member/u.php?action=list\", true);\t\t$pageCode = $pageClass->getCode();\t\t$smarty->assign(\"webTitle\",\"会员列表\");\t\t$smarty->assign(\"uList\", $members);\t\t$smarty->assign(\"pageCode\", $pageCode);\t\t$smarty->display(\"member/m_u_list.html\");function numTable($table='',$wheres=false)\t{\t\t$table = $this->dbPrefix.$table;\t\t$sql = \"SELECT COUNT(*) AS num FROM `$table`\";\t\tif($wheres)\t\t{\t\t\t$sql .= \" WHERE \";\t\t\tif(is_array($wheres))\t\t\t{\t\t\t\tforeach($wheres as $key => $val)\t\t\t\t{\t\t\t\t\t$whr[] = \"`$key`='\".$val.\"'\";\t\t\t\t}\t\t\t\t$sql .= implode(\" AND \",$whr);\t\t\t}\t\t\telseif(is_string($wheres))\t\t\t{\t\t\t\t$sql .= $wheres;\t\t\t}\t\t}\t\t$result = $this->fetch($this->query($sql));\t\treturn $result['num'];\t}Where 没初始化 导致可执行任意sql语句http://localhost/stcms_html/member/u.php?action=list&where={sql}\n   漏洞证明：  http://localhost/stcms_html/member/u.php?action=list&where={sql}    修复方案：  变量要正确初始化   版权声明：转载请注明来源 Zvall@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2012-07-27 12:42 |    \t\t腰上有胸器 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:5        | 一根带刺的黄瓜和一个女人的故事。)\t\t \n  是搜索框那边的吗？    \n     2012-07-27 14:47 |    \t\tZvall \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:14        | hello world)\t\t \n  @腰上有胸器 不是呀。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}