{"id": 2922, "wybug_id": "wooyun-2014-057076", "wybug_title": "大汉网络JCMS覆盖全局配置文件漏洞", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "矿主", "wybug_date": "2014-04-15 10:39", "wybug_open_date": "2014-07-14 10:40", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["配置文件覆盖"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-14：\t细节向公众公开  简要描述： 大汉网络JCMS恶意篡改，覆盖全局配置文件漏洞，范围广、危害大。 详细说明：  测试版本：Version 2010 2.4，其他版本似乎也存在此问题。范围很广。\n\n   漏洞证明：  利用方式一：全局配置文件覆盖。源文件/jcms/setup/opr_setting.jsp：\n//程序开始执行，没有任何权限限制，直接能够访问。 String strRealPath = application.getRealPath(\"\"); strRealPath = strRealPath.replace('\\\\','/'); jcms.sys.Install install = new jcms.sys.Install( strRealPath ); install.setMerpHome( ); //获取动态参数，没有任何过滤，直接传入参数。 String servername = Convert.getParameter( request,\"servername\"); String jndi = Convert.getParameter( request,\"jndi\"); String adminpwd = Convert.getParameter( request,\"adminpwd\"); String lucserver1 = Convert.getParameter( request,\"lucserver1\"); String rssserver1 = Convert.getParameter( request,\"rssserver1\"); String debug1 = \"1\"; //Convert.getParameter( request,\"debug1\"); ...... //写merpserver.ini配置文件，直接对全局配置信息进行覆盖。 String iniPath = strRealPath + \"/WEB-INF/ini/merpserver.ini\"; boolean bl = false; String strMsg = \"\"; com.hanweb.common.util.IniFile ini = new com.hanweb.common.util.IniFile( iniPath ); bl = ini.readIni(); if(bl){  ini.setIniValue(\"WebServer\",servername);  ini.setIniValue(\"AppPath\",jndi);  ini.setIniValue(\"DBType\",dbtypename);  ini.setIniValue(\"AdminPW\",adminpwd);  ini.setIniValue(\"loglevel\",debug1);  ini.setIniValue(\"b_index\",lucserver1);  ini.setIniValue(\"b_rss\",rssserver1);  ini.setIniValue(\"publishfiletype\",publishfiletype);  ......  ini.writeIni();  strMsg = \"alert('配置文件修改完成，请重新启动服务！');\\n\";\n覆盖管理员密码，直接重置管理员密码。源文件/jcms/setup/opr_login.jsp：\nString iniPath = strRealPath + \"/WEB-INF/ini/merpserver.ini\"; com.hanweb.common.util.IniFile ini = new com.hanweb.common.util.IniFile( iniPath ); ini.readIni();  strNewPwd = ini.getIniValue(\"AdminPW\");  //直接由全局配置文件，获取密码。通过覆盖全局配置中AdminPW的值，可以修改密码。 if( !user.trim().equals(\"admin\"))  {  strMessage = \"用户名不正确!\"; } else if( !pwd.trim().equals( strNewPwd.trim() )) {  strMessage = \"密码不正确!\";\t  } else  {  strMessage = \"登陆成功!\";\n利用方式二，数据库信息覆盖。访问：/jcms/setup/publishadmin.jsp\n\n写入相应配置后，提交到/setup/opr_publishsetting.jsp处理。分析源码/jcms/setup/opr_publishsetting.jsp\n<%@page import=\"com.hanweb.common.util.Convert\"%><%@ page contentType=\"text/html;charset=UTF-8\"%><%//程序开始执行，没有任何权限限制，直接能够访问。 String strRealPath = application.getRealPath(\"\"); jcms.sys.Install install = new jcms.sys.Install( strRealPath ); install.setMerpHome( ); //获取动态参数，没有任何过滤，直接传入参数。 String servername = Convert.getParameter( request,\"servername\"); String jndi = Convert.getParameter( request,\"jndi\");  String debug1 = Convert.getParameter( request,\"debug1\"); String dbtypename = Convert.getParameter( request,\"dbtypename\"); String dbtype = Convert.getParameter( request,\"dbtype\"); //写merpserver.ini配置文件，直接对数据库配置信息进行覆盖。 String iniPath = strRealPath + \"/WEB-INF/ini/merpserver.ini\"; com.hanweb.common.util.IniFile ini = new com.hanweb.common.util.IniFile( iniPath ); ini.readIni(); ini.setIniValue(\"WebServer\",servername); ini.setIniValue(\"AppPath\",jndi); ini.setIniValue(\"DBType\",dbtypename); ini.setIniValue(\"loglevel\",debug1); ini.writeIni();\n至此，merpserver.ini被任意覆盖，服务器正常运行需要其中的配置，利用此漏洞，可导致网站瘫痪，或恶意篡改。   修复方案：  添加文件访问权限，系统安装部署后，自动删除默认安装文件。   版权声明：转载请注明来源 矿主@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-04-15 13:45 厂商回复： 感谢关注此问题只涉及老版本的jcms2.4.10 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-15 18:04 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  setup？    \n     2014-05-05 16:25 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  果然是setup。其它系统的大概提交过了，JCMS就不去看了。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}