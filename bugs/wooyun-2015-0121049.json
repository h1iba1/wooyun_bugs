{"id": 2891, "wybug_id": "wooyun-2015-0121049", "wybug_title": "74cms 两处二次注入", "wybug_corp": "74c,s.com", "wybug_author": "answer", "wybug_date": "2015-06-18 21:12", "wybug_open_date": "2015-09-22 15:27", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-24：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-08-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-22：\t细节向公众公开  简要描述： rt 详细说明：  漏洞文件：user/user_download_resume.php 331-356行\nelseif ($act==\"download_save\"){\t$ruser=get_user_info($resumeshow['uid']);\t$pms_notice=intval($_GET['pms_notice']);\tif($_SESSION['utype']==1){\t\tif ($_CFG['operation_mode']==\"2\")\t\t{\t\t\t\t\tif ($resumeshow['talent']=='2')\t\t\t\t{\t\t\t\t\t\tif ($setmeal['download_resume_senior']>0 && add_down_resume($id,$_SESSION['uid'],$resumeshow['uid'],$resumeshow['resume_name']))\t\t\t\t\t\t{\t\t\t\t\t\taction_user_setmeal($_SESSION['uid'],\"download_resume_senior\");\t\t\t\t\t\t$setmeal=get_user_setmeal($_SESSION['uid']);\t\t\t\t\t\twrite_memberslog($_SESSION['uid'],1,9002,$_SESSION['username'],\"下载了 {$ruser['username']} 发布的高级简历,还可以下载 {$setmeal['download_resume_senior']} 份高级简历\",2,1005,\"下载高级简历\",\"1\",\"{$setmeal['download_resume_senior']}\");\t\t\t\t\t\twrite_memberslog($_SESSION['uid'],1,4001,$_SESSION['username'],\"下载了 {$ruser['username']} 发布的简历\");\t\t\t\t\t\t//站内信\t\t\t\t\t\tif($pms_notice=='1'){\t\t\t\t\t\t\t$company=$db->getone(\"select id,companyname  from \".table('company_profile').\" where uid ={$_SESSION['uid']} limit 1\");\t\t\t\t\t\t\t$resume_url=url_rewrite('QS_resumeshow',array('id'=>$id));\t\t\t\t\t\t\t$company_url=url_rewrite('QS_companyshow',array('id'=>$company['id']),false);\t\t\t\t\t\t\t$message=$_SESSION['username'].\"下载了您发布的简历：<a href=\\\"{$resume_url}\\\" target=\\\"_blank\\\">{$resumeshow['resume_name']}</a>，<a href=\\\"$company_url\\\" target=\\\"_blank\\\">点击查看公司详情</a>\";\t\t\t\t\t\t\twrite_pmsnotice($resumeshow['uid'],$ruser['username'],$message);\t\t\t\t\t\t}\t\t\t\t\t\texit(\"ok\");\t\t\t\t\t\t}\t\t\t\t}\n这里有用到两个函数，write_memberslog和write_pmsnotice.而且都传进了参数 $ruser['username']，而$ruser['username']来自于333行直接查询数据库而来，并且没有做转义操作。若果write_memberslog和write_pmsnotice也没有做出转义，那么久造成了注入。我们跟进这两个函数\nfunction write_memberslog($uid,$utype,$type,$username,$str,$mode,$op_type,$op_type_cn,$op_used,$op_leave){ \tglobal $db,$online_ip,$ip_address; \t$sql = \"INSERT INTO \".table('members_log').\" (log_uid,log_username,log_utype,log_type,log_addtime,log_ip,log_address,log_value,log_mode,log_op_type,log_op_type_cn,log_op_used,log_op_leave) VALUES ( '{$uid}','{$username}','{$utype}','{$type}', '\".time().\"','{$online_ip}','{$ip_address}','{$str}','{$mode}','{$op_type}','{$op_type_cn}','{$op_used}','{$op_leave}')\";\treturn $db->query($sql);}\n\nfunction write_pmsnotice($touid,$toname,$message){\tglobal $db;\t$setsqlarr['message']=trim($message);\t$setsqlarr['msgtype']=1;\t$setsqlarr['msgtouid']=intval($touid);\t$setsqlarr['msgtoname']=trim($toname);\t$setsqlarr['dateline']=time();\t$setsqlarr['replytime']=time();\t$setsqlarr['new']=1;\tinserttable(table('pms'),$setsqlarr);}\n可以看见，两个函数对传入的数据都没有做转义。所以造成注入。下面开始利用   漏洞证明：  这里演示由write_memberslog函数造成的注入，因为write_pmsnotice在它的后面，如果我们前面已的用户名已经注册成恶意字符，后面的的这个函数sql语句会执行不成功，因为插入的字段数目和本身的SQL语句的字段数目不匹配（不知道说清楚没有）1.首先注册一个企业账号，并且发布一个职位。2.注册一个普通用户，我们的用户名要注册成：1','1','1',user(),'1','9')#(虽然有全局转义，但是代入数据库之后，会被还原的)。\n\n3.填好一份简历，然后申请刚刚我们发布的那个职位\n\n4.登陆企业账号，来到职位管理的地方，我们点击下载简历\n\n5.看看数据库监控语句，成功执行。\n\n顺便看看，write_pmsnotice函数的sql语句\n\n看到没有，还是直接带入语句的，只是因为我们的字段数不匹配，所以不成功执行而已，但确实是注入，所以一并修复哦6.来到我的账户，\n\nOK ，找到出来的的地方了。   修复方案：  你懂的   版权声明：转载请注明来源 answer@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-09-22 15:27 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-18 21:44 |    \t\tManning \t\t\t( 普通白帽子  |\t\t\t        Rank:559 漏洞数:78        | 就恨自己服务器太少)\t\t \n  之前3个这次又2    \n     2015-06-18 21:51 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  你们俩都发大招了    \n     2015-06-18 21:53 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:45        | 答案)\t\t \n  @牛肉包子 并没有    \n     2015-06-18 22:00 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  @牛肉包子 我是捡漏狂魔 有一个重复了 可惜啦    \n     2015-06-18 23:06 |    \t\t龍 、 \t\t\t( 普通白帽子  |\t\t\t        Rank:398 漏洞数:135        | 你若安好  我就是晴天)\t\t \n  我是捡漏狂魔 有一个重复了 可惜啦     \n     2015-09-22 16:58 |    \t\tsOnsec \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:24        | 安全是什么...)\t\t \n  无影响？    \n     2015-09-22 23:28 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  666    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}