{"id": 2241, "wybug_id": "wooyun-2014-060479", "wybug_title": "U-Mail邮件系统上传文件缺陷导致暴力getshell", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2014-05-13 01:12", "wybug_open_date": "2014-08-11 01:14", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-11：\t细节向公众公开  简要描述： U-Mail邮件系统某处上传缺陷，导致可以暴力获取webshell 详细说明：  漏洞文件：C:\\umail\\WorldClient\\html\\client\\mail\\module\\o_attach.php代码：\nif ( ACTION == \"attach-upload\" ){        if ( $_FILES )        {                $file_name = $_FILES['Filedata']['name'];                $file_type = $_FILES['Filedata']['type'];                $file_size = $_FILES['Filedata']['size'];                $file_source = $_FILES['Filedata']['tmp_name'];                $file_suffix = getfilenamesuffix( $file_name );                $path_target = getusercachepath( );                do                {                        $file_id = makerandomname( );                        $file_target = $path_target.$file_id.\".\".$file_suffix;                } while ( file_exists( $file_target ) );                if ( !move_uploaded_file( $file_source, $file_target ) )                {                        dump_json( array(                                \"status\" => 0,                                \"message\" => el( \"写入文件出错，请与管理员联系！\", \"\" )                        ) );                }                $_SESSION[SESSION_ID]['attach_cache'][] = array(                        \"id\" => $file_id,                        \"name\" => $file_name,                        \"type\" => \"1\",                        \"path\" => $file_target,                        \"size\" => $file_size                );                dump_json( array(                        \"status\" => \"1\",                        \"filename\" => $file_name,                        \"filesize\" => $file_size,                        \"file_id\" => $file_id                ) );        }        else        {                dump_json( array(                        \"status\" => \"0\",                        \"message\" => el( \"无法找到需要上传的文件！\", \"\" )                ) );        }}\n此处为发送邮件时的上传附件函数，允许上传任意文件，在通过黑白盒测试对比分析后得知$path_target = getusercachepath( )函数执行的结果为C:\\umail\\WorldClient\\html\\client\\cache\\{用户的user_id}，其中$file_id即为上传文件保存的随机文件名，$file_suffix即为上传附件的文件类型。在执行上传文件时候先将文件保存为临时文件，而此临时文件是存在web目录里，默认配置是可执行的（此处演示的是官网下载的最新版，windows server 2003搭建，且都为默认配置）漏洞产生的在哪里？首先通过对代码的分析，没找到用户可以查看$user_id的函数，而$user_id还是有规律可循的，按用户的数量从1一直递增；临时文件存放的路径是在web目录里，默认是有脚本执行权限的；临时文件名在上传成功后，审查元素可以看到。因而，可以暴力猜解$user_id的值，来获得我们的webshell。漏洞演示：首先要有一个普通的用户，此处为了说明存储文件的伪随机性，在后台添加1000个用户，如图\n\n挑选test00877@fuck.com帐号密码password877登录后，写信，如图\n\n选择添加附件，上传php文件，返回结果获得的文件名(php文件上传过程中的临时文件名)为13998959208，保留此页面不关闭，然后打开burpsuite构造如下请求\n\n载入intruder，设置payloads为numbers，依次递增。\n\n好吧，1000个用户，跑了不到5秒。结果如下\n\n服务器状况为\n\n   漏洞证明：  如上详细描述   修复方案：  将临时文件放在非web目录下，可以参考你们的网盘文件的写法   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-05-16 18:31 厂商回复： CNVD只发现贵司官网的测试版本存在漏洞，其他实例因没有账号，无法确认。已联系深圳市福洽科技有限公司处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-13 07:15 |    \t\t夕风号 \t\t\t( 普通白帽子  |\t\t\t        Rank:229 漏洞数:35        )\t\t \n  Another example of \"Bye,360.Hello,wooyun.\"    \n     2014-05-13 08:25 |    \t\tLonely \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:27        | 人生如梦,始终都游不过当局者迷的悲哀。)\t\t \n  Another example of \"Bye,360.Hello,wooyun.\"     \n     2014-05-13 11:13 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  @夕风号 Don't talk about these platforms,sharing is the most valuable.    ：）    \n     2014-05-13 11:29 |    \t\t夕风号 \t\t\t( 普通白帽子  |\t\t\t        Rank:229 漏洞数:35        )\t\t \n  @Ano_Tom Good job,bro!    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}