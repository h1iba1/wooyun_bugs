{"id": 651, "wybug_id": "wooyun-2014-068941", "wybug_title": "74cms (20140709) 任意文件读取 &amp; 注入漏洞", "wybug_corp": "74c,s.com", "wybug_author": "′雨。", "wybug_date": "2014-07-18 13:35", "wybug_open_date": "2014-10-16 13:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-23：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-26：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-16：\t细节向公众公开  简要描述： 20140709. 详细说明：  20140709的74cms在plus/weixin.php中 因为默认的这个文件都会checkSignature  来检测token但是来看看74cms的  根本就不需要token。\n$wechatObj = new wechatCallbackapiTest($dbhost,$dbuser,$dbpass,$dbname);\t\tif(isset($_REQUEST['echostr']))\t\t\t\t\t $wechatObj->valid();\t\telseif(isset($_REQUEST['signature']))\t\t{\t\t\t  \t\t\t$wechatObj->responseMsg();\t\t}\n来看看valid\npublic function valid()    {        $echoStr = $_GET[\"echostr\"];        if($this->checkSignature())\t\t{        \texit($echoStr);        }    }\n  check了。\nelseif(isset($_REQUEST['signature']))\t\t{\t\t\t  \t\t\t$wechatObj->responseMsg();\n可是在这里 如果设置了这个 就直接进入了。所以 完全没验证token。。。\npublic function responseMsg()    { \t\t$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];\t\t\t\tif (!empty($postStr))\t\t{                              \t$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);\t\t\t\t                $fromUsername = $postObj->FromUserName;                $toUsername = $postObj->ToUserName;                $keyword = trim($postObj->Content);\t\t\t\t$keyword = iconv(\"utf-8\",\"gb2312\",$keyword);                $time = time();\t\t\t\t$event = trim($postObj->Event);\t\t\t\t\t\t\tif ($event === \"subscribe\")\t\t\t\t{\t\t\t\t\t$word= \"回复j返回紧急招聘，回复n返回最新招聘！您可以尝试输入职位名称如“会计”，系统将会返回您要找的信息，我们努力打造最人性化的服务平台，谢谢关注。\";\t\t\t\t\t$text=\"<xml>\t\t\t\t\t<ToUserName><![CDATA[\".$fromUsername.\"]]></ToUserName>\t\t\t\t\t<FromUserName><![CDATA[\".$toUsername.\"]]></FromUserName>\t\t\t\t\t<CreateTime>\".$time.\"</CreateTime>\t\t\t\t\t<MsgType><![CDATA[text]]></MsgType>\t\t\t\t\t<Content><![CDATA[\".$word.\"]]></Content>\t\t\t\t\t</xml> \";\t\t\t\t\texit($text);\t\t\t\t\t\t\t\t}\n0x01  任意文件读取 (这个无视接口是否开启)因为在解析xml的时候是在判断接口是否开启之前 所以就算没开启也能读取。\n$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);\t\t\t\t                $fromUsername = $postObj->FromUserName;                $toUsername = $postObj->ToUserName;                $keyword = trim($postObj->Content);\t\t\t\t$keyword = iconv(\"utf-8\",\"gb2312\",$keyword);\n在这里解析了传递过来的xml \nif ($event === \"subscribe\")\t\t\t\t{\t\t\t\t\t$word= \"回复j返回紧急招聘，回复n返回最新招聘！您可以尝试输入职位名称如“会计”，系统将会返回您要找的信息，我们努力打造最人性化的服务平台，谢谢关注。\";\t\t\t\t\t$text=\"<xml>\t\t\t\t\t<ToUserName><![CDATA[\".$fromUsername.\"]]></ToUserName>\t\t\t\t\t<FromUserName><![CDATA[\".$toUsername.\"]]></FromUserName>\t\t\t\t\t<CreateTime>\".$time.\"</CreateTime>\t\t\t\t\t<MsgType><![CDATA[text]]></MsgType>\t\t\t\t\t<Content><![CDATA[\".$word.\"]]></Content>\t\t\t\t\t</xml> \";\t\t\t\t\texit($text);\t\t\t\t\t\t\t\t}\t                \tif (!empty($keyword))\t\t\t\t{\t\t\t\t\t\t\t\tif($_CFG['sina_apiopen']=='0')\t\t\t\t\t{\t\t\t\t\t\t\t$word=\"网站微信接口已经关闭\";\t\t\t\t\t\t\t$text=\"<xml>\t\t\t\t\t\t\t<ToUserName><![CDATA[\".$fromUsername.\"]]></ToUserName>\t\t\t\t\t\t\t<FromUserName><![CDATA[\".$toUsername.\"]]></FromUserName>\t\t\t\t\t\t\t<CreateTime>\".$time.\"</CreateTime>\t\t\t\t\t\t\t<MsgType><![CDATA[text]]></MsgType>\t\t\t\t\t\t\t<Content><![CDATA[\".$word.\"]]></Content>\t\t\t\t\t\t\t</xml> \";\t\t\t\t\t\t\texit($text);\n解析过后 这里exit($text); 退出的时候会把内容输出过来。 所以。构造一个xml 就能读取任意文件了。\n\n_______________________________________________________________________________上面那个任意文件读取不需要开启接口, 下面这个注入就需要开启接口了。0x02 注入\nif($_CFG['sina_apiopen']=='0')\t\t\t\t\t{\t\t\t\t\t\t\t$word=\"网站微信接口已经关闭\";\t\t\t\t\t\t\t$text=\"<xml>\t\t\t\t\t\t\t<ToUserName><![CDATA[\".$fromUsername.\"]]></ToUserName>\t\t\t\t\t\t\t<FromUserName><![CDATA[\".$toUsername.\"]]></FromUserName>\t\t\t\t\t\t\t<CreateTime>\".$time.\"</CreateTime>\t\t\t\t\t\t\t<MsgType><![CDATA[text]]></MsgType>\t\t\t\t\t\t\t<Content><![CDATA[\".$word.\"]]></Content>\t\t\t\t\t\t\t</xml> \";\t\t\t\t\t\t\texit($text);\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t$limit=\" LIMIT 6\";\t\t\t\t\t\t\t\t\t\t$orderbysql=\" ORDER BY refreshtime DESC\";\t\t\t\t\t\t\t\t\t\tif($keyword==\"n\")\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t$jobstable=table('jobs_search_rtime');\t\t\t \t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\telse if($keyword==\"j\")\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t$jobstable=table('jobs_search_rtime');\t\t\t\t\t\t\t\t\t\t\t$wheresql=\" where `emergency`=1 \";\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t$jobstable=table('jobs_search_key');\t\t\t\t\t\t\t\t\t\t$wheresql.=\" where likekey LIKE '%{$keyword}%' \";\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t$word='';\t\t\t\t\t\t\t\t\t\t$list = $id = array();\t\t\t\t\t\t\t\t\t\t$idresult = $this->query(\"SELECT id FROM {$jobstable} \".$wheresql.$orderbysql.$limit);\t\t\t\t\t\t\t\t\t\twhile($row = $this->fetch_array($idresult))\n($_CFG['sina_apiopen']=='0' 在这里由于判断了接口是否开启 关闭了则退出 所以注入的话得开启才行,在这里 $wheresql.=\" where likekey LIKE '%{$keyword}%' \";来看看$keyword哪里来的。\n$keyword = trim($postObj->Content);\t\t\t\t$keyword = iconv(\"utf-8\",\"gb2312\",$keyword);\n可以看到是解析后来的$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];$GLOBALS[\"HTTP_RAW_POST_DATA\"]这个是不会被74cms的addslashes转义的所以造成了注入。、\n\n   漏洞证明：  \n\n\n\n   修复方案：  首先 你这个检测函数根本都没用到。 所以造成了这些问题。用一下检测函数, 然后 随机生成一下token 或者 判断一下是否初始化了token 如果未初始化就exit   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-23 11:22 厂商回复： 感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-18 13:36 |    \t\tHero \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:31        | 药药切克闹,充气娃娃迷幻药)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 74cms (20140709) 任意文件读取 & 注入。    \n     2014-07-18 14:20 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  xml实体？我一直在想没时间    \n     2014-07-18 15:02 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  雨牛 74cms是不是好不了了？    \n     2014-07-18 15:06 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @mramydnei 老师快来 继续下去。    \n     2014-07-18 15:06 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @phith0n 嗯    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}