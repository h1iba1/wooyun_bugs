{"id": 1878, "wybug_id": "wooyun-2014-062599", "wybug_title": "用友CRM客户关系管理系统+自动授权+GETSHELL+system权限(无需登录通杀所有版本)", "wybug_corp": "用友软件", "wybug_author": "loli", "wybug_date": "2014-05-28 11:48", "wybug_open_date": "2014-08-23 11:50", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "功能设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-02：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-06：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-16：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-23：\t细节向公众公开  简要描述：       用友CRM客户关系管理软件访问某文件时自动分配全局管理员session信息导致可直接使用系统管理员账号身份登录crm及GETSHELL等。 详细说明：  1. 漏洞文件：/webservice/service.php   *注释中写得很明白了~~~\n<?php/** * 如果没有登录时,要求必须指定参数orgcode: 单位代码 * 如没有传入orgcode，则取orgid=1 * 为当前的会话设置一个登录标识: WSLOGIN = 0/1, 如果没有登录, 则默认以当前ORG的admin登录,以便查看可用的WEB服务 */ //从原始请求头中找出<xxx:Header><xx:PHPSESSID>中的SESSIONID信息preg_match_all(\"/<[ a-zA-Z0-9:_='\\\"]*PHPSESSID[ a-zA-Z0-9:_='\\\"]*>([a-zA-Z0-9]+)<\\/[a-zA-Z0-9:_]*PHPSESSID>/\", $GLOBALS['HTTP_RAW_POST_DATA'], $matches, PREG_SET_ORDER);//file_put_contents(\"c:/aa.txt\", $matches[0][1]);if(count($matches) > 0){\t$UserSessionID = $matches[0][1];}$DontCheckLogin = true;include_once \"tglobal.lib\";$gblObj = TGBL_getObject();if($gblObj->getUserSession(\"WSLOGIN\",0) == 0){\t//检查orgcode变量\tif (isEmptyString($orgcode))\t{\t\t$org_id = 1;\t}\telse \t{\t\t$org_id = 0;\t\t$sql = \"select org_id from tc_org_profile where org_code='$orgcode'\";\t\t$rs = $gblDB->Query($sql);\t\tif($rs)\t\t{\t\t\tif($rs->fetchRecord())\t\t\t\t$org_id = $rs->getFieldValue(0);\t\t\t$rs->close();\t\t}\t\tif(!isValidID($org_id))\t\t\tdie(\"parameter orgcode not found or invalid!\");\t}\t//以admin模拟登录\t$gblObj->LoginWithUser(1,$org_id);}//加载WEB服务\n------------------------------------------------------------------------2.测试版本官方：http://prm.yonyou.com/version.txt    7.0 patch3（其他版本也一样）   该CRM登陆需要三个条件：单位简称，用户名，密码\n\n3.直接访问http://prm.yonyou.com/webservice/service.php，然后在访问http://prm.yonyou.com/ 会惊奇的发现已经是administrator权限登陆状态了|||—\n\n\n\n4.用户上传图片可绕过限制上传php脚本(正常上传时11.php被命名为11.php_)\nHTTP/1.1 200 OKContent-Length: 154Keep-Alive: timeout=5, max=100Connection: Keep-AliveContent-Type: text/html; charset=utf-8{\"success\":true,\"code\":\"\",\"message\":\"\",\"files\":[{\"vname\":\"picfile\",\"fname\":\"11.php\",\"url\":\"\\/tmpfile\\/upd184.tmp.php_\",\"type\":\"image\\/jpeg\",\"size\":5158}]}\n5.11.php后面加空格可绕过限制\nHTTP/1.1 200 OKDate: Wed, 28 May 2014 02:45:25 GMTServer: Apache/2.2.13 (Win32) PHP/5.2.10X-Powered-By: PHP/5.2.10Expires: Thu, 19 Nov 1981 08:52:00 GMTCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0Pragma: no-cacheVary: Accept-Encoding,User-AgentContent-Length: 155Keep-Alive: timeout=5, max=100Connection: Keep-AliveContent-Type: text/html; charset=utf-8{\"success\":true,\"code\":\"\",\"message\":\"\",\"files\":[{\"vname\":\"picfile\",\"fname\":\"11.php \",\"url\":\"\\/tmpfile\\/upd186.tmp.php \",\"type\":\"image\\/jpeg\",\"size\":5158}]}\n6.Apache采用system权限启动。\n\n   漏洞证明：  \n\n漏洞影响：----------------------------------该程序搜索引擎关键字“用友TurboCRM”-----------------------------------   修复方案：  1.身份验证 （用友其他程序调用的接口？）2.上传过滤（白名单验证，并将tmpfile文件夹设置不执行php）3.最小权限+服务（Apache降权）   版权声明：转载请注明来源 loli@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-23 11:50 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-28 11:59 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  标题长，危害大    \n     2014-05-28 12:03 |    \t\tsecgov \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 安全审计，漏洞挖掘,WAF. 揭露漏洞有风险，...)\t\t \n  用友要哭了    \n     2014-05-28 12:13 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  给力    \n     2014-05-28 12:16 |    \t\tloli  \t\t\t( 普通白帽子  |\t\t\t        Rank:550 漏洞数:52        )\t\t \n  测试的时候都被搞糊涂了，啥都没输入稀里糊涂的就成了管理员。。。然后就一直回看抓包记录，到底访问了啥文件。。    \n     2014-05-28 12:24 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @loli 现在的漏洞越来越像后门    \n     2014-05-28 12:25 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @疯狗 说不定根本就是后门    \n     2014-06-02 19:05 |    \t\tloli  \t\t\t( 普通白帽子  |\t\t\t        Rank:550 漏洞数:52        )\t\t \n  @疯狗  忽略了，我去。。。。    \n     2014-06-21 22:22 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @疯狗 以前见过类似的页面，很那啥，一访问就会自动分配cookie了，还是最高权限。很恶心的。这种东西简直就是后门    \n     2014-07-03 15:07 |    \t\t【|→上善若水】 \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:25        | 【|→上善若水】)\t\t \n  @疯狗 http://wooyun.org/bugs/wooyun-2014-063664/trace/7da937bab3c845f4630bd4c60839a501 http://wooyun.org/bugs/wooyun-2014-061563/trace/5a8a26b0dca3f3da8e5f042617391cc5 求审核！    \n     2014-08-23 12:00 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  被忽略了，用友，你值得拥有    \n     2014-12-04 10:25 |    \t\tboyyzz \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:5        | 大婊砸)\t\t \n  @loli 能说下上传的地方在哪里？    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}