{"id": 83557, "wybug_id": "wooyun-2015-0147470", "wybug_title": "kppw最新版前台sql注入", "wybug_corp": "keke.com", "wybug_author": "路人甲", "wybug_date": "2015-10-20 16:34", "wybug_open_date": "2016-01-23 16:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-25：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-23：\t细节向公众公开  简要描述： 我这么认真，你们还是给我点对应的rank吧 详细说明：  算上关联的函数，本来还有很多的，我自己也没有找了，我测试的是utf版本的，你们gbk版本由于这个问题已经炸了，希望好好审查下面我拿 control\\user\\message_send.php文件举例，同样问题的我找的还有 message.php,yijia.php\n<?php defined ( 'IN_KEKE' ) or exit('Access Denied');$strUrl = 'index.php?do=user&view=message&op=send';if (isset ( $formhash ) && kekezu::submitcheck ( $formhash )) {\t$title  = kekezu::str_filter ( kekezu::escape (strip_tags(htmlspecialchars_decode($title)   ))) ;\t$content  = kekezu::str_filter ( kekezu::escape (strip_tags(htmlspecialchars_decode($content)   ))) ;\t$objMsgM = new Keke_witkey_msg_class ();\tif (strtoupper ( CHARSET ) == 'GBK') {\t\t$to_username = kekezu::utftogbk($to_username );\t}\t$arrSpaceInfo = kekezu::get_user_info ( $to_username, 1 );\tif (! $arrSpaceInfo) {\t\t$tips['errors']['to_username'] = '用户不存在';\t\tkekezu::show_msg($tips,NULL,NULL,NULL,'error');\t}\tif ($arrSpaceInfo ['uid'] == $gUid) {\t\t$tips['errors']['to_username'] = '无法给自己发送';\t\tkekezu::show_msg ( $tips, NULL, NULL, NULL, 'error' );\t}\tif (strtoupper ( CHARSET ) == 'GBK') {\t\t$title = kekezu::utftogbk($title );\t\t$content = kekezu::utftogbk($content );\t}\t$objMsgM->setUid ( $gUid );\t$objMsgM->setUsername ( $username );\t$objMsgM->setTo_uid ( $arrSpaceInfo ['uid'] );\t$objMsgM->setTo_username ( $arrSpaceInfo ['username'] );\t$objMsgM->setTitle ($title );\t$objMsgM->setContent ($content);\t$objMsgM->setOn_time ( time () );\t$objMsgM->create_keke_witkey_msg ();\tunset ( $objMsgM );\tkekezu::show_msg ( '已保存', 'index.php?do=user&view=message&op=outbox', NULL, NULL, 'ok' );}else{\t$objUid and $intObjUid = intval($objUid);\t$arrObjInfo =  kekezu::get_user_info ( $intObjUid);}\n我们跟进 utftogbk() /lib/inc/keke_base_class.php\nstatic function utftogbk($string) { \t\t$string = self::charset_encode ( \"utf-8\", \"gbk\", $string );\t\treturn $string;\t}\n继续 \nstatic function charset_encode($_input_charset, $_output_charset, $input) {\t\t$output = \"\";\t\t$string = $input;\t\tif (is_array ( $input )) {\t\t\t$key = array_keys ( $string );\t\t\t$size = sizeof ( $key );\t\t\tfor($i = 0; $i < $size; $i ++) {\t\t\t\t$string [$key [$i]] = self::charset_encode ( $_input_charset, $_output_charset, $string [$key [$i]] );\t\t\t}\t\t\treturn $string;\t\t} else {\t\t\tif (! isset ( $_output_charset ))\t\t\t\t$_output_charset = $_input_charset;\t\t\tif ($_input_charset == $_output_charset || $input == null) {\t\t\t\t$output = $input;\t\t\t} elseif (function_exists ( \"mb_convert_encoding\" )) {\t\t\t\t$output = mb_convert_encoding ( $input, $_output_charset, $_input_charset );\t\t\t} elseif (function_exists ( \"iconv\" )) {\t\t\t\t$output = iconv ( $_input_charset, $_output_charset, $input );\t\t\t} else\t\t\t\tdie ( \"sorry, you have no libs support for charset change.\" );\t\t\treturn $output;\t\t}\t}\niconv()函数，哈哈  我们随便注册个账号登陆 进入发消息界面  这里我们需要把发消息的对象填正确 下面的标题，内容随便你选哪个，我这里方便闭合，选择内容对象 admin（默认存在） 标题 111111 内容 123錦'and sleep(1),123)#   这里必须用#注释，%23是无效的\n\n\n\n成功 sleep() 本来很多的没有刷了，希望上个首页，么么哒   漏洞证明：  算上关联的函数，本来还有很多的，我自己也没有找了，我测试的是utf版本的，你们gbk版本由于这个问题已经炸了，希望好好审查下面我拿 control\\user\\message_send.php文件举例，同样问题的我找的还有 message.php,yijia.php\n<?php defined ( 'IN_KEKE' ) or exit('Access Denied');$strUrl = 'index.php?do=user&view=message&op=send';if (isset ( $formhash ) && kekezu::submitcheck ( $formhash )) {\t$title  = kekezu::str_filter ( kekezu::escape (strip_tags(htmlspecialchars_decode($title)   ))) ;\t$content  = kekezu::str_filter ( kekezu::escape (strip_tags(htmlspecialchars_decode($content)   ))) ;\t$objMsgM = new Keke_witkey_msg_class ();\tif (strtoupper ( CHARSET ) == 'GBK') {\t\t$to_username = kekezu::utftogbk($to_username );\t}\t$arrSpaceInfo = kekezu::get_user_info ( $to_username, 1 );\tif (! $arrSpaceInfo) {\t\t$tips['errors']['to_username'] = '用户不存在';\t\tkekezu::show_msg($tips,NULL,NULL,NULL,'error');\t}\tif ($arrSpaceInfo ['uid'] == $gUid) {\t\t$tips['errors']['to_username'] = '无法给自己发送';\t\tkekezu::show_msg ( $tips, NULL, NULL, NULL, 'error' );\t}\tif (strtoupper ( CHARSET ) == 'GBK') {\t\t$title = kekezu::utftogbk($title );\t\t$content = kekezu::utftogbk($content );\t}\t$objMsgM->setUid ( $gUid );\t$objMsgM->setUsername ( $username );\t$objMsgM->setTo_uid ( $arrSpaceInfo ['uid'] );\t$objMsgM->setTo_username ( $arrSpaceInfo ['username'] );\t$objMsgM->setTitle ($title );\t$objMsgM->setContent ($content);\t$objMsgM->setOn_time ( time () );\t$objMsgM->create_keke_witkey_msg ();\tunset ( $objMsgM );\tkekezu::show_msg ( '已保存', 'index.php?do=user&view=message&op=outbox', NULL, NULL, 'ok' );}else{\t$objUid and $intObjUid = intval($objUid);\t$arrObjInfo =  kekezu::get_user_info ( $intObjUid);}\n我们跟进 utftogbk() /lib/inc/keke_base_class.php\nstatic function utftogbk($string) { \t\t$string = self::charset_encode ( \"utf-8\", \"gbk\", $string );\t\treturn $string;\t}\n继续 \nstatic function charset_encode($_input_charset, $_output_charset, $input) {\t\t$output = \"\";\t\t$string = $input;\t\tif (is_array ( $input )) {\t\t\t$key = array_keys ( $string );\t\t\t$size = sizeof ( $key );\t\t\tfor($i = 0; $i < $size; $i ++) {\t\t\t\t$string [$key [$i]] = self::charset_encode ( $_input_charset, $_output_charset, $string [$key [$i]] );\t\t\t}\t\t\treturn $string;\t\t} else {\t\t\tif (! isset ( $_output_charset ))\t\t\t\t$_output_charset = $_input_charset;\t\t\tif ($_input_charset == $_output_charset || $input == null) {\t\t\t\t$output = $input;\t\t\t} elseif (function_exists ( \"mb_convert_encoding\" )) {\t\t\t\t$output = mb_convert_encoding ( $input, $_output_charset, $_input_charset );\t\t\t} elseif (function_exists ( \"iconv\" )) {\t\t\t\t$output = iconv ( $_input_charset, $_output_charset, $input );\t\t\t} else\t\t\t\tdie ( \"sorry, you have no libs support for charset change.\" );\t\t\treturn $output;\t\t}\t}\niconv()函数，哈哈  我们随便注册个账号登陆 进入发消息界面  这里我们需要把发消息的对象填正确 下面的标题，内容随便你选哪个，我这里方便闭合，选择内容对象 admin（默认存在） 标题 111111 内容 123錦'and sleep(1),123)#   这里必须用#注释，%23是无效的\n\n\n\n成功 sleep()   修复方案：  你们懂的   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-01-23 16:40 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}