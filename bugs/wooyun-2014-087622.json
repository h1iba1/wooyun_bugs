{"id": 41801, "wybug_id": "wooyun-2014-087622", "wybug_title": "dayucms重置任意用户密码&amp;破解", "wybug_corp": "dayucms", "wybug_author": "darker", "wybug_date": "2014-12-22 12:02", "wybug_open_date": "2015-03-22 12:04", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "7", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-22：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-03-22：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 找回密码设计缺陷,导致可重置任意用户密码。 详细说明：  file:member/include/member.class.php\nfunction getpwd($username,$email)\t{\t\tglobal $DAYU,$memlang;\t\tif(!$username || !$email || !is_email($email) || !is_username($username))\t\t{\t\t\t$this->msg = $memlang['getpwd-user-noexists'];\t\t\treturn false;\t\t}\t\t\t\t$userinfo=$this->get($this->get_userid($username));\t\tif(!$userinfo)\t\t{\t\t\t$this->msg = $memlang['getpwd-username-noexists'];\t\t\treturn false;\t\t}\t\tif($userinfo['email']!=$email)\t\t{\t\t\t$this->msg = $memlang['getpwd-username-email'];\t\t\treturn false;\t\t}\t\t\t\t/*\t\t\t设置新密码\t\t*/\t\t$newpwd=mt_rand(100000,999999);\t\t$this->set($userinfo['id'], array('password'=>PWD($newpwd)));\t\trequire_once(DAYU_ROOT.'include/email.class.php');\t\t$sendemail=new email();\t\t$sendemail->send($userinfo['email'], $DAYU['site_name'].'找回密码操作',$userinfo['username'].'，您好，您的新密码已经重新设置为: '.$newpwd.', 请尽快登录会员中心修改密码! <a href=\"'.$DAYU['site_url'].'/member/index.php?file=login&action=login\">点此登录!</a>',MAIL_USER);\t\tinclude DAYU_ROOT.'include/sms.class.php';\t\t$sendsms=new sms();\t\t$sendsms->sendSMS($userinfo['telephone'],$userinfo['username'].'，您好，您的新密码已经重新设置为: '.$newpwd.', 请尽快登录会员中心修改密码! -'.$DAYU['site_name']);\t\treturn true;\t}\n$newpwd=mt_rand(100000,999999);找回用户密码:填写用户名&邮箱。会生成一个6位数数字密码。然后暴力破解：\ncase 'login':\t\t\tif($_userid) \t\t\t{\t\t\t\theader('location:index.php');\t\t\t\texit();\t\t\t}\t\t\tif(isset($do_submit) && $do_submit)\t\t\t{\t\t\t\t$forwardurl=isset($forwardurl)?$forwardurl:get_cookie('http_referer');\t\t\t\t$forwardurl=strpos(strtolower($forwardurl),'&action=logout')?'':$forwardurl;\t\t\t\t$url=$forwardurl?$forwardurl:(getpreurl()?getpreurl():$DAYU['site_url'].'member/index.php');\t\t\t\tif(LOGIN_CHECKCODE_ENABLED && ($_SESSION['checkcode']!=$chkcode || !$_SESSION['checkcode']))\t\t\t\t{\t\t\t\t\tshowmsg($memlang['err-checkcode']);\t\t\t\t}\t\t\t\tif(UC)\t\t\t\t{\t\t\t\t\t$action = 'login';\t\t\t\t\trequire dirname(__FILE__).'/api/passport_server_ucenter.php';\t\t\t\t\t$member->edit_password_username($username, $password);\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t$code='';\t\t\t\t}\t\t\t\t$userinfo=$member->login($username,$password,$cookietime);\t\t\t\tif(!$userinfo)\t\t\t\t{\t\t\t\t\tshowmsg($member->msg);\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t$_userid=$userinfo['id'];\t\t\t\t\t$modelid=$userinfo['modelid'];\t\t\t\t\tunset($_SESSION['checkcode']);\t\t\t\t\tset_cookie('http_referer','');\t\t\t\t\tshowmsg($memlang['login-ok'].$code,$url);\t\t\t\t}\t\t\t}\t\t\t$http_referer=isset($_SERVER['HTTP_REFERER']) && $_SERVER['HTTP_REFERER'] ?$_SERVER['HTTP_REFERER']:'';\t\t\tif(substr($http_referer,0,strlen(SITE_URL))!=SITE_URL || strpos($http_referer,'&action=logout'))\t\t\t{\t\t\t\t$http_referer='';\t\t\t}\t\t\tset_cookie('http_referer',$http_referer);\t\t\t$ischeckcode=LOGIN_CHECKCODE_ENABLED?true:false;\t\t\tinclude member_tlp('login');\t\t\tbreak;\n其中只判断了验证码是否正确，正确则执行登陆，错误则弹出错误，没有重置验证码。那么我们可以一次验证码多次使用。\n\n   漏洞证明：  成功破解密码。\n\n   修复方案：  1.重置生成的密码设置复杂些。2.验证码使用后要重置验证码。   版权声明：转载请注明来源 darker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}