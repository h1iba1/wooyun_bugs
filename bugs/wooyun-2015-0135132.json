{"id": 67004, "wybug_id": "wooyun-2015-0135132", "wybug_title": "网站安全狗禁止IIS执行程序bypass", "wybug_corp": "安全狗", "wybug_author": "RedFree", "wybug_date": "2015-08-19 10:47", "wybug_open_date": "2015-11-18 14:30", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["客户端程序设计错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-18：\t细节向公众公开  简要描述： 个人认为这个思路有点值得学习的地方，不敢私藏，发出来一起学习下。我也是日了狗了！ 详细说明：  网站安全狗会拦截命令的执行：\n\n\n\n执行白名单中的程序不会被拦截：\n\n\n\n    但是执行白名单中的程序并不是我们想要的结果（我想要提权，想要执行exp.exe），那该怎么办呢？    经过反复的测试，发现安全狗拦截的是IIS(时间久远，具体是aspnet_wp.exe还是w3wp.exe我记不清了)创建的进程。    由IIS启动的进程再去执行命令会不会被拦截呢？但是在想这个问题的时候，要先解决一个问题，那就是如何让IIS启动的进程再去启动一个新进程？    好在metasploit完美助我解决了这个问题：使用payload>windows>meterpreter>reverse_tcp监听9527端口\n\n再生成一个aspx的payload\n\n\n\n上传至目标，然后浏览器访问（页面一片空白，但是得到了一个meterpreter）\n\n\n\n此时一些常用的meterpreter命令都是可用的（不产生新进程的都可用，如ps、getuid等，已经有很多事可以做了），但尝试去执行程序时，却还是被拦截。\n\n\n\n\n\n    于是一个想法就诞生了：启动安全狗白名单中的进程，然后再使用migrate命令迁移payload到这个进程，再去执行命令会如何呢？   然后手工去运行测试白名单中的进程，结果大部分都是一闪而过，程序运行后就退出了，根本没有机会迁移进程。但当试到drwtsn32.exe的时候，奇迹出现了，这货是个界面程序，不会运行后立即退出。于是尝试使用execute -f C:/windows/system32/drwtsn32.exe来启动这个进程（我的测试系统是win2003）：\n\n执行成功，并返回了进程PID。接下来迁移payload到这个PID:\n\n再尝试去执行命令：\n\n好了，可以执行任意的命令了，来个shell吧：\n\n\n注：运气好了话有以network service权限运行的进程（如：wmiprvse.exe），这样就不用再启动一个进程了，直接迁移payload过去便可执行任意命令了！\n   漏洞证明：  \n\n   修复方案：  Null.   版权声明：转载请注明来源 RedFree@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-08-20 14:29 厂商回复： 巧妙的绕过了网狗对执行命令的限制，虽然没有扩大安全风险，安全狗将会在后续版本推出相关防护功能。 欢迎小伙伴们提出更多新(yin)奇(dang)的思路. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-19 11:08 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:12        | 我是一颗小小树)\t\t \n  果断日狗啊    \n     2015-08-19 15:44 |    \t\t带我玩 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 带我玩)\t\t \n  果断日狗啊     \n     2015-08-20 15:05 |    \t\tPiaCa \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:10        | 简单点!啪......嚓~~)\t\t \n  洞主每天都日狗，要不要吃俩大腰子补一补啊？    \n     2015-08-20 15:43 |    \t\tRedFree \t\t\t( 普通白帽子  |\t\t\t        Rank:180 漏洞数:40        | 每个系统都有它自身的弱点，无论是相对的还...)\t\t \n  @PiaCa 可以啊，快快快把你那俩大腰子给我留下来……    \n     2015-08-20 15:51 |    \t\t乌云首席鉴黄师 \t\t\t( 普通白帽子  |\t\t\t        Rank:256 漏洞数:88        | 妈妈，我要上电视)\t\t \n  不打雷或者$ ？这不科学    \n     2015-10-24 16:45 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:210 漏洞数:37        )\t\t \n  涨姿势了    \n     2015-11-18 15:44 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:662 漏洞数:108        | 一个想当文人的黑客~)\t\t \n  migrate命令迁移payload到这个进程 是什么原理，线程注入么    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}