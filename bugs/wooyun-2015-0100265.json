{"id": 37178, "wybug_id": "wooyun-2015-0100265", "wybug_title": "KingCms最新版越权大礼包", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-11 11:15", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作", "认证缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-11：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版越权大礼包 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9，官网下下来学习一下。在wooyun看到了几个漏洞，如：http://wooyun.org/bugs/wooyun-2010-043520这里的越权大礼包包括删除网站所有会员、重置所有会员密码、修改所有会员用户名。0x00：先来看看获得相关权限的绕过方法吧Kingcms使用$u=new user;$u->auth_role('XXX');来验证用户是否具有XXX的权限，关键是user类。/user/user.class.php,user的构造方法如下\npublic function __construct(){\t\t$cookie=kc_cookie('userauth');\t\t$cookiePass=substr($cookie,0,32);\t\t$ischeck=true;\t\t$GLOBALS['db']=new db;\t\t$GLOBALS['str']=new str;\t\t$GLOBALS['cache']=new cache;\t\tglobal $db,$str;\t\t\t\tif(empty($cookie) && !empty($_GET['jsoncallback'])\t\t\t&& !empty($_GET['USERID']) && !empty($_GET['SIGN'])){\t//第1处注释：这里很容易使条件成立，执行下面的if语句\t\t\t\t\t\t\t$get_userid=$_GET['USERID'];\t\t\t$get_sign=$_GET['SIGN'];\t\t\t\t\t\t$sign=md5($get_userid.SITEURL.kc_config('system.salt'));\t\t\t\t\t\t$userid = $sign==$get_sign ? $get_userid : 0;\t//第2处注释：这里是唯一的一次简单验证\t\t\t\t\t$ischeck=false; //第3处注释：在下面第4处注释处会用到\t\t}else{\t\t\t$userid=substr($cookie,32);\t\t}\t\tif(!kc_validate($userid,2)) $userid=0;\t\tif(empty($userid)){\t\t\t$user=array('userpass'=>'x');\t\t}else{\t\t\t$user=$db->getRows_one('%s_user','*','userid='.$userid);\t\t\tif(empty($user)) $user=array('userpass'=>'x');\t\t}\t\t\t\t//用户已登录\t\tif (md5($user['userpass'])==$cookiePass || $ischeck==false) {//第4处注释无关代码\n上面代码的第二处注释的地方，要获得需要操作的userid，要计量$sign=md5($get_userid.SITEURL.kc_config('system.salt'));\t其中的参数$get_userid是用户输入，SITEURL是当前域名，不包含www等二级域名,[小写]，kc_config('system.salt')是系统默认的，定值。这样，这里就可以绕过了。使得$ischeck=false。在第4处注释处，因为$ischeck=false，所以，用户已登陆，USERID输入10000(kingcms系统的超级管理员id),就获得了管理员的所有权限了。0x01：下面看看如何删除所有会员/user/manage.php\n/** * 删除会员 */function _delete(){\t\t$u=new user;$u->auth_role('admin');\t\t$userid=kc_post('userid',2,1);\t\t\tif($u->info['userid']==$userid) kc_tip('不能删除自己!');\t\t$db=new db;\t$db->delete('%s_user','userid='.$userid);\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_DELETE','cid'=>$userid));\tkc_tip('删除成功!','ok','refresh');}\n控制userid，从10001开始，步进为1，遍历就可以把所有会员全部删除了。过程见下图\n\n0x02：下面看看如何重置所有会员密码/user/manage.php\nfunction _resetpass(){\t$u=new user;$u->auth_role('admin');\t$userid=kc_post('userid',2,1);\tif($userid==$u->info['userid']) kc_tip('要修改自己的密码，请点击“修改密码”!');\t    $str=new str;\t$pwd=$str->random(10);\t$db=new db;\t$db->update('%s_user',array('userpass'=>md5($pwd)),'userid='.$userid);\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_RESETPASS','cid'=>$userid));\tkc_tip('成功设置用户密码为：'.$pwd,'ok');}\n控制userid，从10001开始，步进为1，遍历就可以把重置所有会员的密码了。过程见下图\n\n0x03：下面看看如何修改所有会员用户名/user/manage.php\nfunction _rename(){\t$u=new user;$u->auth_role('admin');\t$userid=kc_post('userid',2,1);\t\t$db=new db;\t$rs=$db->getRows_one('%s_user','username','userid='.$userid);\tif(empty($rs)) kc_tip('用户名记录已丢失!');\t\t$str=new str;\tif(empty($_POST['username'])) kc_tip('请填写用户名!','form');\tif($_POST['username']==$rs['username']) kc_tip('新的用户名不能和旧用户名一致!','form');\tif ($str->len($_POST['username'])>12) kc_tip('用户名太长，不能超过12字','form');\tif(preg_match('/[<>\\s\\!\\@\\/\\\\\\|\\]\\[\\}\\{\\#\\$\\%\\^\\&\\*\\(\\)\\_\\+\\=\\-]/',$_POST['username'])) kc_tip('用户名不能含有非法字符!','form');\t$uname=$db->encode($_POST['username']);\tif($db->getRows_one('%s_user','userid',\"username='$uname' and userid<>$userid\")) kc_tip('当前用户名已经存在!','form');\t$array=array('username'=>$_POST['username']);\t$db->update('%s_user',$array,'userid='.$userid);\t$js=\"\\$.kc_close();alert('成功修改用户名[{$rs['username']}]为[{$_POST['username']}]!');$('#form_publish [name=username]').val('{$_POST['username']}');\";\tkc_log(array('userid'=>$u->info['userid'],'app'=>'user','action'=>'USER_RENAME','cid'=>$userid));\tkc_ajax(array('JS'=>$js));}\n控制userid和POST[‘username’],从10001开始，步进为1，遍历就可以修改所有会员的用户名了。过程见下图\n\n   漏洞证明：  见 详细过程   修复方案：  修改验证方法   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}