{"id": 14945, "wybug_id": "wooyun-2015-0109211", "wybug_title": "cmseasy最新版 一枚注入", "wybug_corp": "cmseasy", "wybug_author": "玉林嘎", "wybug_date": "2015-04-21 17:22", "wybug_open_date": "2015-07-20 17:26", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-24：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-20：\t细节向公众公开  简要描述： 可惜没绕过360webscan(其实是轻松绕过的) 详细说明：  cmseasy最新版0318 存在一个注入漏洞文件：/lib/default/archive_act.php250-251行:\nfunction search_action() {//print_r($_SESSION);exit();        if (front::get('ule')) {            front::$get['keyword'] = str_replace('-', '%', front::$get['keyword']);            front::$get['keyword'] = urldecode(front::$get['keyword']);        }        if (front::get('keyword') && !front::post('keyword'))            front::$post['keyword'] = front::get('keyword');        front::check_type(front::post('keyword'), 'safe');        if (front::post('keyword')) {            $this->view->keyword = trim(front::post('keyword'));            session::set('keyword', trim(front::post('keyword')));            /* if(isset(front::$get['keyword']))              front::redirect(preg_replace('/keyword=[^&]+/','keyword='.urlencode($this->view->keyword),front::$uri));              else  front::redirect(front::$uri.'&keyword='.urlencode($this->view->keyword)); */        } else {            $this->view->keyword = session::get('keyword');        }                if(preg_match('/union/i',$this->view->keyword) || preg_match('/\"/i',$this->view->keyword) ||preg_match('/\\'/i',$this->view->keyword)){            exit('非法参数');        }\n重要代码：\nif (front::get('ule')) {            front::$get['keyword'] = str_replace('-', '%', front::$get['keyword']);            front::$get['keyword'] = urldecode(front::$get['keyword']);        }\nget获取的ule存在即可进入这个条件语句- 变成 % 之后urldecode导致可以直接引入' 只需传入-27即可再看\nsession::set('keyword', trim(front::post('keyword')));\n对应函数代码:\nclass session {    static function get($key) {        if (isset($_SESSION[$key]))            return $_SESSION[$key];        else            return false;    }    static function set($key,$var) {        $_SESSION[$key]=$var;    }    static function del($key) {        unset($_SESSION[$key]);    }}//session_start();\ncmseasy在赋予session值后 会进行一个write操作/lib/plugins/stsession.php\npublic function write($id,$data) {\t\t$sql = \"SELECT * FROM {$this->_prefix}sessionox where PHPSESSID = '$id'\";\t\t//var_dump($sql);\t\t$res = $this->_db->query($sql);\t\t$time = time();\t\t$row = $this->_db->fetch_array($res);\t\tif ($row) {\t\t\t//if ($row['data'] != $data) {\t\t\t$sql = \"UPDATE {$this->_prefix}sessionox SET update_time='$time',data='$data' WHERE PHPSESSID = '$id'\";\t\t\t$this->_db->query($sql);\t\t\t//}\t\t} else {\t\t\tif (!empty($data)) {\t\t\t\t$sql = \"INSERT INTO {$this->_prefix}sessionox (PHPSESSID, update_time, client_ip, data) VALUES ('$id','$time','$this->_ip','$data')\";\t\t\t\t$this->_db->query($sql);\t\t\t}\t\t}\t\treturn true;\t}\n$data数据进入update操作 造成注入而之后参数preg_match是在数据库操作之后 并无影响\nif(preg_match('/union/i',$this->view->keyword) || preg_match('/\"/i',$this->view->keyword) ||preg_match('/\\'/i',$this->view->keyword)){            exit('非法参数');        }\n而拦截白名单也做出更改了 想不到办法绕过360webscan\n/** *  拦截目录白名单 */function webscan_white($webscan_white_name,$webscan_white_url=array()) {  $url_path=$_SERVER['SCRIPT_NAME'];  foreach($_GET as $key=>$value){    $url_var.=$key.\"=\".$value.\"&\";  }  if (preg_match(\"/\".$webscan_white_name.\"/is\",$url_path)==1&&!empty($webscan_white_name)) {    return false;  }  foreach ($webscan_white_url as $key => $value) {    if(!empty($url_var)&&!empty($value)){      if (stristr($url_path,$key)&&stristr($url_var,$value)) {        return false;      }    }    elseif (empty($url_var)&&empty($value)) {      if (stristr($url_path,$key)) {        return false;      }    }  }  return true;}\n   漏洞证明：  证明一下存在注入http://127.0.0.1/cmseasy/index.php?case=archive&act=search&keyword=-27,client_ip=user()-23&ule=1\n\n\n\n绕过了360webscan就可以直接盲注了   修复方案：     版权声明：转载请注明来源 玉林嘎@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-04-21 17:24 厂商回复： 谢谢，马上修正 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-25 10:12 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  牛逼啊，还能找到注入，学习    \n     2015-04-26 13:11 |    \t\tAK-47 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:1        | 开开心心挖洞，踏踏实实上学！)\t\t \n  厉害，敢为楼主收徒不？    \n     2015-07-17 13:48 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  可以绕过的 改了等于没改case[case=admin]=1&case=archive&act=edit&catid=1 这样就轻松绕过了    \n     2015-07-17 19:12 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  @menmen519 门神 威武    \n     2015-07-22 23:36 |    \t\t好吃佬 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:24        | 混迹hacker，没有饭吃)\t\t \n  @menmen519 马克学习    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}