{"id": 2184, "wybug_id": "wooyun-2014-061133", "wybug_title": "最土团购注入两处 (直接提升自己权限)", "wybug_corp": "zuitu.com", "wybug_author": "′雨。", "wybug_date": "2014-05-17 20:33", "wybug_open_date": "2014-08-12 20:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-19：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-12：\t细节向公众公开  简要描述： 又是周末。还有一个多月就要高考了， 到时候我也就成了高三狗了。荒废了这前面的两年, 决定高三的时候还是得拼一下。希望能考上个自己理想的学校。 详细说明：  上次说了chinabank 把剩下的几个文件都报出来把。主要是通过验证的问题。 执行语句的时候会转义得找没单引号的地方。一些我没办法通过那验证, 还有一些就是把amount/100了 例如bill/return.php中的$v_amount = ($orderAmount/100);这个我也没办法利用了。  把能利用的写出来一下。0x01 order/sdopay/notify.php\n$amount=$_POST[\"Amount\"];$payamount=$_POST[\"PayAmount\"];$orderid=$_POST[\"OrderNo\"];$serialno=$_POST[\"serialno\"];$status=$_POST[\"Status\"];$merid=$_POST[\"MerchantNo\"];$paychannel=$_POST[\"PayChannel\"];$discount=$_POST[\"Discount\"];$signtype=$_POST[\"SignType\"];$paytime=$_POST[\"PayTime\"];$ctype=$_POST[\"CurrencyType\"];$prono=$_POST[\"ProductNo\"];$prodesc=$_POST[\"ProductDesc\"];$remark1=$_POST[\"Remark1\"];$remark2=$_POST[\"Remark2\"];$ex=$_POST[\"ExInfo\"];$mac=$_POST[\"MAC\"];$signString=$amount.\"|\".$payamount.\"|\".$orderid.\"|\".$serialno.\"|\".$status.\"|\".$merid.\"|\".$paychannel.\"|\".$discount.\"|\".$signtype.\"|\".$paytime.\"|\".$ctype.\"|\".$prono.\"|\".$prodesc.\"|\".$remark1.\"|\".$remark2.\"|\".$ex;if($signtype==\"2\")//md5{   $md5key=$INI['sdopay']['sec'];   $mac2 =md5($signString.\"|\".$md5key);   $ok = (strtoupper($mac)==strtoupper($mac2));}@list($_, $order_id, $city_id, $_) = explode('-', $orderid, 4);if (Table::Fetch('pay', $orderid)) die('OK');if ( $_ == 'charge' ) {  if ($ok == 1) {\t\t\t@list($_, $user_id, $create_time, $_) = explode('-', $orderid, 4);\t\t\tZFlow::CreateFromCharge($amount, $user_id, $create_time, 'sdopay',$serialno);\t        die(\"OK\");//必须输出且只能输出\"OK\"  \t}  }\n这里 主要是让  $ok 为 1 \nif($signtype==\"2\")//md5{   $md5key=$INI['sdopay']['sec'];   $mac2 =md5($signString.\"|\".$md5key);   $ok = (strtoupper($mac)==strtoupper($mac2));}\n首先让signtype为2mac2 $signString | $md5key 这里md5key默认都为空的 不用考虑。$mac为post来的 只要$mac和$mac2相等 就能让$ok为1\nstatic public function CreateFromCharge($money,$user_id,$time,$service='alipay',$trade_no=''){\t\tglobal $option_service;\t\tif (!$money || !$user_id || !$time) return 0;\t\t$pay_id = \"charge-{$user_id}-{$time}\";\t\t$pay = Table::Fetch('pay', $pay_id);\t\tif ( $pay ) return 0;\t\t\t$order_id = ZOrder::CreateFromCharge($money,$user_id,$time,$service);\t\tif (!$order_id) return 0;\t\t//insert pay record\t\t$pay = array(\t\t\t'id' => $pay_id,\t\t\t'vid' => $trade_no,\t\t\t'order_id' => $order_id,\t\t\t'bank' => $option_service[$service],\t\t\t'currency' => 'CNY',\t\t\t'money' => $money,\t\t\t'service' => $service,\t\t\t'create_time' => $time,\t\t);\t\tDB::Insert('pay', $pay);\t\tZCredit::Charge($user_id, $money);\t\t//end//\t\t//update user money;\t\t\t$user = Table::Fetch('user', $user_id);\t\t\tTable::UpdateCache('user', $user_id, array(\t\t\t\t\t'money' => array( \"money + {$money}\" ),\t\t\t\t\t));\n这里$amount 做的$money 可以看到没有被单引号 没有intval。而且直接update的是user table 。 且可控的是在set位。。管理和用户都是在user表里。 通过manager column 来判断是否为管理。这里直接update manager 为1 就能直接提升自己为管理。_________________________________________________________________________0x02 order/gopay/return.php\n$tranCode = $_REQUEST[\"tranCode\"];$merchantID = $_REQUEST[\"merchantID\"];$merOrderNum = $_REQUEST[\"merOrderNum\"];$tranAmt = $_REQUEST[\"tranAmt\"];$ticketAmt = $_REQUEST[\"ticketAmt\"];$tranDateTime = $_REQUEST[\"tranDateTime\"];$currencyType = $_REQUEST[\"currencyType\"];$merURL = $_REQUEST[\"merURL\"];$customerEMail = $_REQUEST[\"customerEMail\"];$authID = $_REQUEST[\"authID\"];$orgOrderNum = $_REQUEST[\"orgOrderNum\"];$orgtranDateTime = $_REQUEST[\"orgtranDateTime\"];$orgtranAmt = $_REQUEST[\"orgtranAmt\"];$orgTxnType = $_REQUEST[\"orgTxnType\"];$orgTxnStat = $_REQUEST[\"orgTxnStat\"];$msgExt = $_REQUEST[\"msgExt\"];$virCardNo = $_REQUEST[\"virCardNo\"];$virCardNoIn = $_REQUEST[\"virCardNoIn\"];$tranIP = $_REQUEST[\"tranIP\"];$isLocked = $_REQUEST[\"isLocked\"];$feeAmt = $_REQUEST[\"feeAmt\"];$respCode = $_REQUEST[\"respCode\"];$VerficationCode = $INI['gopay']['code'];$signValue = $_REQUEST[\"signValue\"];$orderId = preg_replace('/_/', '-', $merOrderNum);$str = \"tranCode=[$tranCode]merchantID=[$merchantID]merOrderNum=[$merOrderNum]tranAmt=[$tranAmt]ticketAmt=[$ticketAmt]tranDateTime=[$tranDateTime]currencyType=[$currencyType]merURL=[$merURL]customerEMail=[$customerEMail]authID=[$authID]orgOrderNum=[$orgOrderNum]orgtranDateTime=[$orgtranDateTime]orgtranAmt=[$orgtranAmt]orgTxnType=[$orgTxnType]orgTxnStat=[$orgTxnStat]msgExt=[$msgExt]virCardNo=[$virCardNo]virCardNoIn=[$virCardNoIn]tranIP=[$tranIP]isLocked=[$isLocked]feeAmt=[$feeAmt]respCode=[$respCode]VerficationCode=[$VerficationCode]\";$newSign = MD5($str);@list($_, $order_id, $city_id, $_) = explode('-', $orderId, 4);if (Table::Fetch('pay', $orderId)) die('SUCCESS');\tif( $newSign == $signValue && $respCode == '0000' ) {\t\t/* charge */\t\tif ( $_ == 'charge' ) {\t\t\t@list($_, $user_id, $create_time, $_) = explode('-', $orderId, 4);\t\t    ZFlow::CreateFromCharge($tranAmt, $user_id, $create_time, 'gopay',$tranCode);\t\t\tSession::Set('notice', \"国付宝充值{$tranAmt}元成功！\");\n这里验证了 $newSign == $signValue && $respCode == '0000' $newSign 又是Md5来的。 所以能通过验证了。。 ZFlow::CreateFromCharge($tranAmt  然后又进这函数 不多说了。_________________________________________________________________   漏洞证明：  第一处\n\n第二处\n\nupdate。\n\n   修复方案：  intval money加强验证。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-12 20:34 厂商回复： 此产品已不再维护，原站已经下线，感谢白帽子提交漏洞，中国因你们更精彩 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-17 20:36 |    \t\tGDH \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 谢谢大家对我的支持！)\t\t \n  www.社工库.com    \n     2014-05-17 20:36 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  莫名的伤感。    \n     2014-05-18 07:09 |    \t\tCougar \t\t\t( 实习白帽子  |\t\t\t        Rank:69 漏洞数:19        | 不容易。)\t\t \n  基友求详情    \n     2014-05-19 17:06 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  莫名的伤感    \n     2014-05-19 17:18 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  “此产品已不再维护，原站已经下线，感谢白帽子提交漏洞，中国因你们更精彩“——挺住~    \n     2014-05-19 19:24 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  大神！你这是在刷人民币啊！    \n     2014-05-19 20:03 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  还有18天高考的路过~    \n     2014-05-19 23:42 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  尼玛，你居然是高中生，碉堡了    \n     2014-05-20 10:16 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  雨 神，有人想给你生孩子    \n     2014-05-20 22:07 |    \t\t橘子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:3        | 呢个...羞射高中生一枚。带上大神@Haswell...)\t\t \n  高二狗同顶QAQ    \n     2014-06-05 21:35 |    \t\tpiaoye \t\t\t( 普通白帽子  |\t\t\t        Rank:343 漏洞数:53        | ww)\t\t \n  漏洞最土团购注入两处 (直接提升自己权限)已经对你公开了，可以提前去看看    \n     2014-08-12 22:22 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  你才高中……    \n     2014-08-13 00:24 |    \t\tCalify \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:5        | 未能联系到厂商或者厂商积极拒绝)\t\t \n  中国因你们更精彩    \n     2014-08-13 08:18 |    \t\tMr_Java \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:9        | 成功进入web端，哈哈！)\t\t \n  莫名的感伤。    \n     2014-08-13 10:48 |    \t\tgddhggf \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 来学习的)\t\t \n  自评rank20，结果最后给忽略了，只是多么大的心里落差。。厂商还来一句：中国因你们更精彩。厂商又调皮了。。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}