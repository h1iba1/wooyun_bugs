{"id": 49571, "wybug_id": "wooyun-2014-080875", "wybug_title": "qibocms 地方门户系统 注入#4(demo测试)", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-10-31 10:06", "wybug_open_date": "2015-01-29 10:08", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-29：\t细节向公众公开  简要描述： offset 详细说明：  在zhuangxiu/job.php中\nif(eregi(\"^([_0-9a-z]+)$\",$job)){\trequire_once(Mpath.\"inc/job/$job.php\");}elseif(eregi(\"^([_0-9a-z]+)$\",$action)){\trequire_once(Mpath.\"inc/job/$action.php\");}\n包含进来zhuangxiu\\inc\\job\\post_img.php中\nforeach( $photodb AS $key=>$value){\t\tif(strlen($value)>4&&!eregi(\"(gif|jpg|png)$\",$value)){ //这里限定了value结尾必须含有jpg啥的\t\t\tshowerr(\"只能上传GIF,JPG,PNG格式的文件,你不能上传此文件:$value\");\t\t}\t}\t$num=0;\tforeach( $photodb AS $key=>$value ){\t\t$titledb[$key]=filtrate($titledb[$key]);\t\t$value=trim($value);\t\t$value=filtrate($value);\t\tif($titledb[$key]>100){\t\t\tshowerr(\"标题不能大于50个汉字\");\t\t}\t\tif(strlen($value)<4){\t\t\t$db->query(\"DELETE FROM `{$_pre}pic` WHERE pid='{$piddb[$key]}' AND id='$id'\");\t\t}elseif($piddb[$key]){\t\t\t$num++;\t\t\t$db->query(\"UPDATE `{$_pre}pic` SET name='{$titledb[$key]}',imgurl='$value' WHERE pid='{$piddb[$key]}'\");\t\t}elseif($value){\t\t\t$num++;\t\t\t$db->query(\"INSERT INTO `{$_pre}pic` ( `id` , `fid` , `mid` , `uid` , `type` , `imgurl` , `name` ) VALUES ( '$id', '$fid', '$mid', '$lfjuid', '0', '$value', '{$titledb[$key]}')\");\t\t}\nUPDATE `{$_pre}pic` SET name='{$titledb[$key]}',imgurl='$value' WHERE pid='{$piddb[$key]}'注意看这语句。 $title 并没有初始化 那么结合qibocms的全局机制 那么就可以控制而且这里 $titledb[$key] 如果我们提交的$titledb 为字符串的话 那么[$key]就成了读取字符的了。  如果$key 为0 那么就是读取字符串的第一位 如果我们提交' 被qibocms的全局转义成了\\' 那么截取第一位 就是\\就能吃掉一个单引号了。 然后 刚好后面的一个变量可控。导致了可以注入。 $value 虽然结尾限定了必须为jpg但是直接注释掉后面的就行了。\n\n可以看到截取的\\ 吃掉了 单引号 造成了注入。构造一下。\n\n成功出数据。测试demo:\n\n成功报错 直接update column就出数据了。   漏洞证明：  \n\n   修复方案：  判断是不是数组。如果是数组的话 再进行这样的操作。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-31 15:52 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}