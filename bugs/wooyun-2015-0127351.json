{"id": 66089, "wybug_id": "wooyun-2015-0127351", "wybug_title": "【乌云峰会】3G/4G USIM卡密钥和参数破解", "wybug_corp": "移动运营商", "wybug_author": "Ruu", "wybug_date": "2015-07-20 11:53", "wybug_open_date": "2015-10-20 08:42", "wybug_type": "设计不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["卡", "旁路攻击"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-25：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-20：\t细节向公众公开  简要描述： USIM卡鉴权算法的执行过程会通过功耗泄露出密钥与运营商参数的相关信息，由此我们可以对其进行旁路功耗分析，最终实现对于USIM卡的复制。 详细说明：  1.关于USIM卡通常SIM（USIM）卡内的数据包括IMSI、ICCID、Ki（2G）、Key(3G)、OPC(3G)、PIN、PUK、OTA、JAVA应用等多种数据。SIM卡内的数据主要分为索引数据、业务数据、鉴权数据和位置数据四类。索引数据包括ICCID；业务数据包括IMSI、PIN、PUK、OTA菜单、JAVA应用数据；鉴权数据包括IMSI、 Ki(2G) Key(3G)、OPC(3G)、A3/A5/A8算法、MILENAGE算法等；位置数据包括LAI、TMSI、位置状态信息、BCCH信息等；当我们需要复制一张USIM卡，我们需要获取的首先是能代表它身份的ICCID和IMSI数据，其次最关键也是最大的难点就是获取它的密钥和运营商参数。在掌握了这些数据后我们就可以实现一张复制卡。2.旁路攻击传统的数学分析方法并不能解释物理设备的泄露效应，这是由于一个实际应用的密码系统的安全性不仅仅与其密码体系的设计有关，还涉及到程序和硬件的设计等多个方面，如果密码设计者、程序员和硬件设计工程师之间互相不了解不配合，最终系统的安全性往往也是不完善、不可靠的。物理泄露信息被研究者称为旁路信息（Side-Channel leakage），与之对应的攻击方法称为旁路攻击。旁路攻击是一种破解安全芯片内私有密钥的有效手段，包括时间分析攻击、功耗攻击、电磁辐射分析等。在各种旁路攻击技术手段中，相对而言功耗攻击的威胁最高。功耗攻击按其强度可分为简单功耗攻击（simple power analysis, SPA）、差分功耗攻击（differential power analysis, DPA）以及高阶DPA攻击（high order DPA, HDPA）。旁路攻击由于其具有易于实施和成功率高的特点，一经提出就引起了国内外从事密码和微电子的研究学者的极大关注。在旁路的各种攻击方式中，功耗攻击最具危险性也是最难控制的，因此功耗分析攻击技术倍受密码学研究者的重视，成为密码分析和密码工程领域发展最为迅速的方向之一。3.3G鉴权算法首先由网络侧得到USIM卡的鉴权请求和IMSI后，产生鉴权数据AV，其中AV包括的RAND和AUTN为主要的鉴权算法的输入数据。AUTN中包含了SQN、AMF、MAC的信息，ME侧使用网络侧传来的RAND和AUTN数据进行鉴权算法的计算，计算所得的XMAC与MAC进行比较，如果相同并验证SQN范围符合规范则完成了对网络侧的认证。再将由鉴权算法计算所得的RES发回网络侧完成网络侧对USIM卡的认证。至此，完成了3G网络的双向认证。而我们对于USIM卡的分析显然会着力于USIM卡对网络侧的鉴权。整个鉴权算法主要就是用到了RAND、SQN、AMF所包含的信息，结合USIM卡本身的K与运营商提供的OPC做了f1、f2、f3、f4、f5等多个计算。结合下图则能更好地了解到f1~f5各自的作用。\n\n4.利用旁路攻击分析鉴权算法并获取Key和OPc首先通过Python与卡进行通信，发送不正确的鉴权数据给它，自然返回鉴权失败。\n\n然后利用采集代码对于USIM卡鉴权算法的完整过程进行功耗采集\n\n根据经验选择重点分析的位置，采用自行开发的专业软件对其进行能量分析，可以依次获取出密钥和OPc的相关数据。\n\n   漏洞证明：  在上述的介绍和攻击过程之后，我们要证明自己是否拥有了这张卡正确的密钥和OPc，我们只要利用它们生成正确的鉴权参数再次发送给原卡，观察鉴权结果即可。\n\n由图可知，我们的攻击结果正确无误   修复方案：  上述漏洞很难完全修复，只能通过加强程序员和硬件工程师之间的交流，尽可能加强对于旁路功耗分析的防护方可缓解这一问题。建议移动运营商可以和这方面有经验的高校或公司合作。   版权声明：转载请注明来源 Ruu@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-07-22 08:41 厂商回复： CNVD未直接所述情况（所述情况在会议上已公开）,已经转由CNCERT同步抄报给中国电信、中国移动、中国联通等三家运营商集团公司，由其后续跟进评估处置。鼓励新类型漏洞，rank 20 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-18 11:57 |    \t\t末影人 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:9        | 末影人(Enderman)是一个三个方格高的人形生...)\t\t \n  前排    \n     2015-07-18 11:58 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1213 漏洞数:321        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  板凳 汽水    \n     2015-07-18 12:03 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1107 漏洞数:200        | <a href=javascrip:alert('xss')>s</a> 点...)\t\t \n  前排只卖矿泉水！！！    \n     2015-07-18 12:05 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1107 漏洞数:200        | <a href=javascrip:alert('xss')>s</a> 点...)\t\t \n  我猜这是路人甲登路人甲的号，以路人甲发的洞！    \n     2015-07-18 12:09 |    \t\t高小厨 \t\t\t( 普通白帽子  |\t\t\t        Rank:821 漏洞数:74        | 不会吹牛的小二不是好厨子！)\t\t \n  我去，牛    \n     2015-07-18 12:09 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:54        | 潜心代码审计。)\t\t \n  我猜这是路人甲登路人甲的号，以路人甲发的洞！    \n     2015-07-18 12:37 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:768 漏洞数:97        )\t\t \n  那么快！    \n     2015-07-18 12:44 |    \t\t番茄师傅 \t\t\t( 普通白帽子  |\t\t\t        Rank:260 漏洞数:61        | http://www.tomatoyu.com/)\t\t \n  屌！    \n     2015-07-18 13:04 |    \t\t无敌L.t.H \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | ‮……肉肉捉活，亭长放解)\t\t \n  坐等各国无良小编    \n     2015-07-18 13:15 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  U S I M    \n     2015-07-18 15:20 |    \t\t547 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:5        | ::)\t\t \n  前排围观，会火    \n     2015-07-18 16:13 |    \t\t番茄师傅 \t\t\t( 普通白帽子  |\t\t\t        Rank:260 漏洞数:61        | http://www.tomatoyu.com/)\t\t \n  记者同志拍这里 wooyun@番茄师傅    \n     2015-07-19 11:01 |    \t\t抚琴听海 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 交流qq  752247101)\t\t \n  火了\"    \n     2015-07-19 14:27 |    \t\t刹那永恒 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 此人很懒很懒非常懒)\t\t \n  CCAV电台看这里    \n     2015-07-21 15:01 |    \t\tCdreamy \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        )\t\t \n  CCAV电台看这里~~~~~~~~~~~~~~~~~~~~~    \n     2015-07-22 08:49 |    \t\tnzk1912 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:10        | 软件开发8年了，也来挖挖漏洞，为创建安全...)\t\t \n  断了多少人的财路啊！    \n     2015-07-22 08:50 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:25        | 开发真是日了狗了)\t\t \n  牛逼，学习    \n     2015-07-22 16:12 |    \t\t计算姬 \t\t\t( 普通白帽子  |\t\t\t        Rank:404 漏洞数:92        | 看我看我看我啊)\t\t \n  这些评论很乌云~    \n     2015-07-25 08:56 |    \t\tJotPot \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:10        | 小菜)\t\t \n  围观围观    \n     2015-07-25 13:21 |    \t\tFire ant \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:26        | 他们回来了................)\t\t \n  66666666666666666    \n     2015-08-07 23:32 |    \t\tjeffreys125 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:14        | 懒人。。)\t\t \n  666    \n     2015-09-02 13:10 |    \t\t老实先生 \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:6        | 只会注不会shell)\t\t \n  为什么看不到详情？    \n     2015-09-25 13:59 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  “通过Python与卡进行通信” “根据经验选择重点分析的位置，采用自行开发的专业软件对其进行能量分析” 这详情我也是醉了，以后发漏洞我也这样   “通过电脑对源码进行分析” “根据经验选择重点分析的位置，采用记事本对其进行逻辑分析，得到RCE一处 位置你猜 利用方式你猜”    \n     2015-10-20 08:47 |    \t\t丸子响当当 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:5        | 学习温习•••••••)\t\t \n  @索马里的海贼 顶！d=====(￣▽￣*)b    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}