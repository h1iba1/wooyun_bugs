{"id": 19168, "wybug_id": "wooyun-2012-09415", "wybug_title": "韩国某web编辑器0day", "wybug_corp": "韩国", "wybug_author": "ca3tie1", "wybug_date": "2012-07-10 13:53", "wybug_open_date": "2012-07-10 13:53", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "逻辑错误", "任意文件上传", "源码审核", "源码分析", "应用程序设计不当"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-07-10：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2012-07-10：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 该编辑器在韩国使用比较广泛，www.hani.co.kr、www.kbs.co.kr、www.joinsmsn.com中都有使用。由于涉及大大站，具体程序名称就不便直接发布了。 详细说明：  主要问题在于上传类在对文件扩展名做验证的时候不严谨导致攻击者可上传PHP。By Ca3tie1先看上传函数：\nif ($file->getFileSize(\"Filedata\") > 0) {$save_name = $req->get(\"save_name\");if ($save_name == null || $save_name == \"\")$save_name = $file -> nameUnique('ph_');$file_name = $file->getFileName(\"Filedata\");if ($file -> isUploadable($file_name))   //扩展名的验证，如果验证不过则扩展名定死为tmp。$file_ext = $file->name2Ext($file_name);  //取出扩展名else$file_ext = 'tmp';$save_name = uniqid(date('ymd_'));$file_server = $file->file_Copy(\"Filedata\", $savearea.$save_name.'.'.$file_ext);}\n跟进isUploadable函数：\nfunction isUploadable($fileName) {return !(rainUtil::find($this->forbidden_extension_patten, $fileName));}//这里涉及到forbidden_extension_patten，定义为：var $forbidden_extension_patten = '(html|htm|php|php3|cgi|phtml|shtml|jsp|asp|exe|com|dll)$';再继续跟进find函数：function find($patternStr, $str, $reg = Array()) {return (ereg($patternStr,$str, $reg)) ? true:false;    //问题就在这里了，ereg函数是区分大小写的！只要我们提交的文件名的扩展名为pHp即可绕过此处验证。}\n绕过扩展名验证后继续看上传函数中的取出扩展名的代码：\n$file_ext = $file->name2Ext($file_name);\n我们继续跟进name2Ext函数：\nfunction name2Ext($fileName) {$tar_file_extension = \"\";if ($fileName != \"\") {if (ereg(\"\\.([^\\.]+)$\", $fileName, $tmp_reg)) $tar_file_extension = substr(strtolower($tmp_reg[1]), 0, 4); //最终会将文件名中的扩展名转换成小写！！else $tar_file_extension = \"tmp\";} else $tar_file_extension = \"\";return $tar_file_extension;}\n完美绕过，这是韩国棒子写的程序，当然和国内的没法比。若分析有误望指出！拜谢！这个程序有多个版本，并且每个版本都有不同的漏洞，任意文件下载、突破目录限制上传等等！   漏洞证明：  \n\n\n\n   修复方案：  你懂的~！！！   版权声明：转载请注明来源 ca3tie1@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：8 (WooYun评价)  ", "replys": "漏洞评价：\n评论\n     2012-07-10 14:08 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  不错的    \n     2012-07-10 14:21 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  恭喜开号成功。    \n     2012-07-10 14:34 |    \t\t低调的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:466 漏洞数:68        | loading……………………)\t\t \n  我怎么记得这个好久之前在红黑出现过~    \n     2012-07-10 15:35 |    \t\tca3tie1 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | castiel)\t\t \n  @imlonghao 嘿嘿！！！    \n     2012-07-10 15:36 |    \t\tca3tie1 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | castiel)\t\t \n  @低调的瘦子 这个完全是本人挖掘！但是我想以前搞韩国的大牛应该还是有，不过不知道全不全。记得韩国的cheditor的0day也是一样，在我之前貌似也有大牛有，只是没放出来！    \n     2012-07-11 08:42 |    \t\t低调的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:466 漏洞数:68        | loading……………………)\t\t \n  @ca3tie1 http://www.2cto.com/Article/201205/129788.html 哈哈 也是你的！！不过这个五月一号就有了~~    \n     2012-07-11 16:43 |    \t\tca3tie1 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | castiel)\t\t \n  @低调的瘦子 嗯，最早是在我自己blog公布的，然后被转载出去的！    \n     2012-07-13 21:22 |    \t\t树熊 \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:7        | 关注技术、关注安全)\t\t \n  这个我要学习一下，在国内貌似这个editor用的不多，没这么看到过，主要还是ewebeditor和FCKeditor，收藏起来看看以后是否用的到，呵呵~    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 8, "Ranks": null}