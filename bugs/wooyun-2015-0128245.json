{"id": 66223, "wybug_id": "wooyun-2015-0128245", "wybug_title": "【乌云峰会】网易闪电邮远程命令执行附思路分析", "wybug_corp": "网易", "wybug_author": "gainover", "wybug_date": "2015-07-22 07:35", "wybug_open_date": "2015-10-23 10:48", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-23：\t细节向公众公开  简要描述： 打个卡。 详细说明：  1. 最新版本 2.4 build 1020\n\n2. 首先看看网易闪电邮的结构。\n\n左侧是邮件列表，右侧是邮件查看窗口，该窗口实际上就是一个内嵌的浏览器，分析得知，其中展示的页面为 viewer.html（绿色框框部分）， 而邮件正文部分（红色框框部分）则为一个具有临时名称的html文件，（如：tmpmail~2.html），viewer.html通过 iframe 标签嵌入 正文的html文件，为了避免邮件正文中存在XSS导致相关问题发生，网易闪电邮利用了 iframe的security属性来限制邮件正文html中脚本的执行，如下图所示：\n\n默认使用name=\"ps1\"的iframe来展示邮件正文内容， security=\"restricted\" 限制了该iframe内的html的脚本执行（The security attribute restricts use of the javascript, vbscript, and about protocols in the URL. https://msdn.microsoft.com/en-us/library/ms534622.aspx）也就是说，我们要执行XSS，得绕过 security=\"restricted\" ，但是这个似乎不太可能。如果是走这个思路，我们的测试到这里就已经结束了。3. 然而，在继续测试的过程中，我们又发现了一些有意思的点：用客户端发送一个邮件，插入一个图片。\n\n发送邮件后，来看看接收邮件方的情况：\n\n可以看到，在邮件目录下有几个文件：viewer.html: 上文提到的邮件展示页面tmpmail~7.html: 邮件正文内容页面mail.js: 邮件概要信息pkav.png: 发送时插入的图片4. 上面这4个文件有什么问题呢？首先，邮件展示页 viewer.html 在该邮件目录下，然后，插入的pkav.png 也在该邮件目录下。那么，如果我们插入一个“图片”，名字叫做 viewer.html，会不会覆盖掉原有的viewer.html，从而导致viewer.html加载我们的代码呢？这里有两种可能性，A. 程序先COPY一份正常的viewer.html到邮件目录下，然后程序将“viewer.html”图片下载到邮件目录中，覆盖掉原有的viewer.html，导致问题。B. 程序先将“viewer.html”图片下载到邮件目录中，然后COPY一份正常的viewer.html到邮件目录下，覆盖了“假”的viewer.html，viewer.html被覆盖为正常，不会导致问题。为了测试是A还是B，我们复制一份viewer.html，做一些修改，如下：\n\n还是和上面一样，将此文件当作图片插入到邮件中，然后进行发送。\n\n如上图所示，我们插入的代码不见了。这说明，程序走的是B流程，看样子这么不会存在问题了。。5. 然而，在viewer.html的末尾却发现了一些问题：\n\n可以看到，B流程里的覆盖操作，并非是拿程序里的viewer.html模板直接覆盖邮件目录下的viewer.html，而是某种“神秘”的写入操作。为什么说是“神秘”，因为多次测试后，并未发现明显的写入规律，不知道末尾产生的这段多余的机制是如何进行的。但是，如果我们把“恶意代码”追加到viewer.html的时候，就会发现我们追加的“恶意代码”会被留在viewer.html结尾。构造的恶意viewer.html如下图：\n\n收到邮件后，得到的viewer.html如下（左侧是收到的，右侧是发送的）：\n\n并且，收到邮件的时候，可以看到alert(1)被执行了。\n\n-----------------------------------------到了这里，我们得到了一个XSS的执行权限，怎么进一步利用呢？-----------------------------------------6. 首先考虑的就是会不会有命令执行？ 经过一番琢磨后，注意到了邮箱的附件功能。附件有一个双击执行的功能。\n\n看似很理所当然对吧？然而，这是一个用HTML来实现的邮件展示界面，HTML来要实现直接执行exe是不可行的，那么说明该html的容器（嵌入的浏览器）中必然实现了一些API接口来实现执行附件的功能。浏览器扩展的api一般都是在external对象上添加的，因此我们就到viewer.js里去搜索external\n\n可以看到，我们定位到了附件双击功能，确实对应着一条external的函数onAttachmentDblClicked，该函数有一个参数，并且是整数数字，试着推测了一下，该参数表示“第几个附件”的含义。7. 基于此，我们将此前的alert(1)的代码修改一下，在viewer.html末尾加上：\n<script>external.onAttachmentDblClicked(0);</script><style>#at-list{display:none}</style>\n其中 #at-list{display:none} 这条CSS 是为了隐藏邮件中看起来可疑的附件列表，如图所示：\n\n然后用客户端发送邮件，把修改后的viewer.html当作图片加入，编写一个 111.wsf 脚本文件：\n见测试代码部分\n然后，把111.wsf当作附件添加到邮件中，最后，发送邮件。\n\n8. 收到邮件，点开邮件后，external.onAttachmentDblClicked(0); 被执行，第一个附件相当于被双击，执行即，111.wsf中的命令被执行：\n\n   漏洞证明：  见详细说明   修复方案：  暂无   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-07-25 10:47 厂商回复： 非常感谢白帽子细致的分析，漏洞已修复，并更新到官网，感谢您对网易的关注！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-22 07:36 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  你认为的理所当然背后有这么多内容....    \n     2015-07-22 07:37 |    \t\t末影人 \t\t\t( 实习白帽子  |\t\t\t        Rank:35 漏洞数:9        | 末影人(Enderman)是一个三个方格高的人形生...)\t\t \n  记者快看这里    \n     2015-07-22 07:39 |    \t\tbitcoin \t\t\t( 普通白帽子  |\t\t\t        Rank:715 漏洞数:218        | 学习是最好的投资！)\t\t \n  膜拜大牛！    \n     2015-07-22 07:41 |    \t\tLooke \t\t\t( 普通白帽子  |\t\t\t        Rank:690 漏洞数:97        | 可顺势而为，何必逆水行舟)\t\t \n  前排    \n     2015-07-22 07:48 |    \t\t子墨 \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:22        | 天地不仁,以万物为刍狗;圣人不仁,以百姓为...)\t\t \n  大牛早！膜拜！    \n     2015-07-22 07:49 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1107 漏洞数:200        | <a href=javascrip:alert('xss')>s</a> 点...)\t\t \n  又来了！！    \n     2015-07-22 08:06 |    \t\t泪雨无魂 \t\t\t( 普通白帽子  |\t\t\t        Rank:133 漏洞数:43        )\t\t \n  又来了！！     \n     2015-07-22 08:11 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:982 漏洞数:170        )\t\t \n  ！！！完全停不下来    \n     2015-07-22 08:40 |    \t\tTon7BrEak \t\t\t( 普通白帽子  |\t\t\t        Rank:211 漏洞数:43        | 吃苦耐劳，我只会第一个！)\t\t \n  0.0 mark  make  马克    \n     2015-07-22 08:44 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1038 漏洞数:176        | px1624)\t\t \n  今天这么早额！核心应该明天就回来了，哈哈    \n     2015-07-22 08:50 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1144 漏洞数:114        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  前来膜拜    \n     2015-07-22 08:57 |    \t\tAaron \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:6        | 花开遍地，终为一代大侠。)\t\t \n  好厉害    \n     2015-07-22 08:58 |    \t\t甲鱼 \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:3        | 慢慢爬……)\t\t \n  裤衩一声一个闪电……    \n     2015-07-22 08:59 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1307 漏洞数:190        | 。)\t\t \n  电闪雷鸣    \n     2015-07-22 09:09 |    \t\tStardustsky \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | ……)\t\t \n  二哥快把你的洞都交出来！！！！    \n     2015-07-22 09:14 |    \t\tHyjal \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:11        | 挖掘机)\t\t \n  boom boom    \n     2015-07-22 09:16 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:433 漏洞数:100        | 什么狗屁爱，生活已乱套！人的一生中，...)\t\t \n  怎么又是你    \n     2015-07-22 09:38 |    \t\t无敌L.t.H \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:4        | ‮……肉肉捉活，亭长放解)\t\t \n  坐等渣浪无良小编    \n     2015-07-22 09:54 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  后排出售2哥帅照    \n     2015-07-22 09:55 |    \t\tYxWa \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:5        | 颠儿颠儿的小跑中...)\t\t \n  不要！停！    \n     2015-07-22 10:01 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:461 漏洞数:54        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  二哥我们的猴子咋办！！    \n     2015-07-22 10:05 |    \t\tWulala \t\t\t( 普通白帽子  |\t\t\t        Rank:227 漏洞数:24        | ^..^ ^..^ ^↓^ ^..^ ^..^)\t\t \n  迟到了      \n     2015-07-22 10:13 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3451 漏洞数:269        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  学习    \n     2015-07-22 10:16 |    \t\t举起手来 \t\t\t( 普通白帽子  |\t\t\t        Rank:581 漏洞数:61        | 准备好，举起手来！)\t\t \n  屌屌哒！    \n     2015-07-22 10:22 |    \t\t安全小飞侠 \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:12        | 安全小飞侠就是我，我就是安全小飞侠！)\t\t \n  学习    \n     2015-07-22 10:29 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  登错了小号？    \n     2015-07-22 10:38 |    \t\t小呆呆 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:7        | 每次有人骂我猪我都说我偶像也是猪)\t\t \n  2哥威武    \n     2015-07-22 12:33 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @猪猪侠  漏洞数:250这样真的好吗？    \n     2015-07-22 13:49 |    \t\t只抽红梅 \t\t\t( 普通白帽子  |\t\t\t        Rank:165 漏洞数:14        | 红梅花儿开，我从帝都来！)\t\t \n  总有人以为他以为的就是他以为的    \n     2015-07-22 14:59 |    \t\t无名 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:9        | 我是一只小菜鸟呀，伊雅伊尔哟。)\t\t \n  威武。    \n     2015-07-22 16:06 |    \t\tlxj616 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:90        | <hohoho>)\t\t \n  打个卡。。。。。。。。。。。。。。。。。。。。。    \n     2015-07-22 16:40 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2015-07-22 16:57 |    \t\t’‘Nome \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:19        | 在此感谢 @M4sk @mango @裤裆 @泳少 @5up3r...)\t\t \n  我只想，马上确认，马上修复，马上公开！谢谢    \n     2015-07-22 18:18 |    \t\t带头大哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:289 漏洞数:95        | 很早前，我就有个梦想。哪一天能站在国家会...)\t\t \n  打雷闪电3个勾，我要给你生猴子！    \n     2015-07-22 18:28 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  关注二哥的漏洞    \n     2015-07-22 19:33 |    \t\tQ1NG \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:18        | 临 兵 斗 者 皆 阵 列 前 行 !)\t\t \n  警察叔叔,就是他     \n     2015-07-22 20:34 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:25        | 开发真是日了狗了)\t\t \n  在乌云赚到百万的男人    \n     2015-07-22 20:37 |    \t\t晏子 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:4        | 无)\t\t \n  电闪雷鸣间下起了金币雨    \n     2015-07-22 20:55 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1540 漏洞数:207        | 逆流而上)\t\t \n  沙发！    \n     2015-07-22 21:49 |    \t\tFire ant \t\t\t( 实习白帽子  |\t\t\t        Rank:73 漏洞数:26        | 他们回来了................)\t\t \n  在乌云赚到百万的男人    \n     2015-07-22 22:28 |    \t\tMr.R \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:14        | 求大神带我飞 qq2584110147)\t\t \n  乌云赚到百万的男人    \n     2015-07-22 23:14 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:868 漏洞数:189        )\t\t \n  还不赶紧公开    \n     2015-07-23 09:40 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:433 漏洞数:100        | 什么狗屁爱，生活已乱套！人的一生中，...)\t\t \n  乌云赚到百万的男人 这有1万了吧？    \n     2015-07-23 13:01 |    \t\t青青 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 你好)\t\t \n  1w能干？    \n     2015-07-23 19:50 |    \t\t庙口大王 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:6        | 呵呵)\t\t \n  $$$    \n     2015-07-23 21:10 |    \t\t南柯太守 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 专注web开发的安全入门者)\t\t \n  G博士好吊    \n     2015-07-25 10:51 |    \t\t乌云首席鉴黄师 \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:64        | 妈妈，我要上电视)\t\t \n  摄像师，看这里！！    \n     2015-07-25 11:42 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  二哥穿着格子衫，笑的特帅    \n     2015-07-29 15:49 |    \t\t天鱼 \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:5        | 逝去的梦)\t\t \n  膜拜大牛！    \n     2015-09-13 00:35 |    \t\tRaven \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 挖洞不易，且挖且珍惜)\t\t \n  厉害厉害！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}