{"id": 1251, "wybug_id": "wooyun-2014-065835", "wybug_title": "Qibocms图片系统任意文件查看导致的多处注入(可提升自己为管理员)", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-06-23 11:14", "wybug_open_date": "2014-09-21 11:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-21：\t细节向公众公开  简要描述： 最大化。 还有个跟之前类似的洞 这里就不多说了。 详细说明：  http://bbs.qibosoft.com/down2.php?v=photo1.0#down下载地址还有类似的 就说这里了。在photo/member/post.php中\nrequire_once(Mpath.\"inc/check.postarticle.php\");if($job=='postnew'){\tif($step=='post')\t{\t\tpost_new();\t\t//生成静态\t\tmake_article_html(\"$Murl/member/post.php?job=endHTML&aid=$aid\");\t\t$mid && $mid<106 && $none='none';\t\trefreshto(\"?job=postnew&fid=$fid\",\"<CENTER>[<A HREF='?job=postnew&fid=$fid'>继续发表新主题</A>] <span style='display:$none;'>[<A HREF='?job=post_more&fid=$fid&aid=$aid'>续发本主题</A>]</span> [<A HREF='myarticle.php?job=myarticle&fid=$fid'>返回主题列表</A>] [<A HREF='$Mdomain/bencandy.php?fid=$fid&aid=$aid' target=_blank>查看主题</A>] [<A HREF='?job=edit&aid=$aid'>点击修改</A>]</CENTER>\",60);\t}\n在这里 又是包含这个文件进来。inc/check.postarticle.php进去看看。\n$postdb[smalltitle]\t=\tfiltrate($postdb[smalltitle]);\t$postdb[picurl]\t\t=\tfiltrate($postdb[picurl]);\t//$postdb[description]=\tfiltrate($postdb[description]);\t$postdb[author]\t\t=\tfiltrate($postdb[author]);\t$postdb[copyfrom]\t=\tfiltrate($postdb[copyfrom]);\t$postdb[copyfromurl]=\tfiltrate($postdb[copyfromurl]);\t$postdb[description]\t=\tpreg_replace('/javascript/i','java script',$postdb[description]);\t$postdb[description]\t=\tpreg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[description]);\t\t//针对火狐浏览器做的处理\t$postdb[content]=str_replace(\"=\\\\\\\"../$webdb[updir]/\",\"=\\\\\\\"$webdb[www_url]/$webdb[updir]/\",$postdb[content]);\tif(!$groupdb[PostNoDelCode]){\t\t$postdb[content]\t=\tpreg_replace('/javascript/i','java script',$postdb[content]);\t\t$postdb[content]\t=\tpreg_replace('/<iframe ([^<>]+)>/i','&lt;iframe \\\\1>',$postdb[content]);\t}\t//采集外部图片\t$postdb[content]\t=\tget_outpic($postdb[content],$fid,$GetOutPic);\n在这里又调用了get_outpic这个函数 可以跟之前发的媒体版结合解析漏洞Getshell那样一样的利用。这里我就不多说这个了、继续往下面看 看看有神马不同的没。这里和媒体版的那个还是有不同的\nif($post_db){\t\tforeach($post_db[photourl][url] AS $key=>$value){\t\t\t$value=trim($value);\t\t\tif(!$value||eregi(\"://\",$value)){\t\t\t\tcontinue;\t\t\t}\t\t\t\t\tif(!$postdb[picurl]){\t\t\t\tcopy(ROOT_PATH.\"$webdb[updir]/$value\",ROOT_PATH.\"$webdb[updir]/{$value}.jpg\");\t\t\t\t$postdb[picurl]=\"{$value}.jpg\";\t\t\t}\t\t\tmove_attachment($lfjuid,tempdir($value),$downloadDIR);\n在这里$post_db  结合 qibocms的伪全局 直接 提交一下就行了。\nforeach($post_db[photourl][url] AS $key=>$value){\t\t\t$value=trim($value);\t\t\tif(!$value||eregi(\"://\",$value)){\t\t\t\tcontinue;\t\t\t}\n在这里循环出来后 不能让他匹配出:// 然后继续看\tif(!$postdb[picurl]){ 当这个为false的时候进入分支所以就不提交这个了。\ncopy(ROOT_PATH.\"$webdb[updir]/$value\",ROOT_PATH.\"$webdb[updir]/{$value}.jpg\");\t\t\t\t$postdb[picurl]=\"{$value}.jpg\";\n然后把循环出来的value copy成jpg。这里如果我们控制这个$value为配置文件 然后copy成.php.jpg后就可以直接查看配置文件了。但是这只是一个任意文件读取。 怎么来把他最大利用呢。继续看在member/yz.php中elseif($action=='mobphone2'){\tif($lfjdb[mob_yz]){\t\tshowerr(\"请不要重复验证手机号码!\");\t}\tif(!$yznum){\t\tshowerr(\"请输入验证码\");\t}\telseif(!$md5code){\t\tshowerr(\"资料有误\");\t}else{\t\tunset($code,$mobphone,$uid);\t\tlist($code,$mobphone,$uid)=explode(\"\\t\",mymd5($md5code,\"DE\") );\t\tif($code!=$yznum||$uid!=$lfjuid){\t\t\tshowerr(\"验证码不对\");\t\t}\t} \tadd_user($lfjuid,$webdb[YZ_MobMoney],'手机号码审核奖分');\t$db->query(\"UPDATE {$pre}memberdata SET mobphone='$mobphone',mob_yz='1' WHERE uid='$lfjuid'\");把$mobphone直接带入到了查询当中 而且在set位 如果可以成功引入单引号的话 那可就可以直接提升自己为管理了。但是qibocms 对全局的GET POST COOKIE都addslashes了。来看看这函数\nfunction mymd5($string,$action=\"EN\",$rand=''){ //字符串加密和解密 \tglobal $webdb;    $secret_string = $webdb[mymd5].$rand.'5*j,.^&;?.%#@!'; //绝密字符串,可以任意设定 \tif(!is_string($string)){\t\t$string=strval($string);\t}    if($string===\"\") return \"\";     if($action==\"EN\") $md5code=substr(md5($string),8,10);     else{         $md5code=substr($string,-10);         $string=substr($string,0,strlen($string)-10);     }    //$key = md5($md5code.$_SERVER[\"HTTP_USER_AGENT\"].$secret_string);\t$key = md5($md5code.$secret_string);     $string = ($action==\"EN\"?$string:base64_decode($string));     $len = strlen($key);     $code = \"\";    for($i=0; $i<strlen($string); $i++){         $k = $i%$len;         $code .= $string[$i]^$key[$k];     }    $code = ($action == \"DE\" ? (substr(md5($code),8,10)==$md5code?$code:NULL) : base64_encode($code).\"$md5code\");\treturn $code; }\n是一个加密解密的函数　　如果可以知道key的话　那就可以自己生成一个语句然后来注入了。然后利用任意文件读取那洞 可以看到key的。SO Come on.   漏洞证明：  首先利用任意文件读取。读取data/config.php\n\n成功拿到key 然后自己写个脚本 来生成一个语句。\n\n\n\n构造一下语句yu',groupid=3 where uid=2#groupid 为3的话即为管理员不知道uid的话 可以直接就构造yu' 报错后就能看到uid然后调用函数生成一下语句。\n\n\n\n\n\n成功update。调用这函数的地方还有很多——————————————————————————————————————在inc/common.inc.php中\nif($_COOKIE[\"adminID\"]&&$detail=mymd5($_COOKIE[\"adminID\"],'DE',$onlineip)){\tunset($_uid,$_username,$_password);\tlist($_uid,$_username,$_password)=explode(\"\\t\",$detail);\t$lfjdb=$db->get_one(\"SELECT * FROM {$pre}memberdata WHERE uid='$_uid' AND username='$_username'\");}if($lfjdb[yz]){\t$lfjid=$lfjdb['username'];\t$lfjuid=$lfjdb['uid'];\t$lfjdb[icon] && $lfjdb[icon]=tempdir($lfjdb[icon]);\tif($lfjdb['groupid']==3||$lfjdb['groupid']==4){\t\t$web_admin=$sort_admin='1';\t}\tif( file_exists(ROOT_PATH.\"data/group/{$lfjdb[groupid]}.php\") ){\t\t$groupdb=@include( ROOT_PATH.\"data/group/{$lfjdb[groupid]}.php\");\n貌似验证通过了就直接登录后台　来看看。$_COOKIE[\"adminID\"]&&$detail=mymd5($_COOKIE[\"adminID\"],'DE',$onlineip在这里　调用了这函数　这里需要注意一下　后面还跟了第三个参数$onlineip看看第三个参数在函数中起的作用。\nfunction mymd5($string,$action=\"EN\",$rand=''){ //字符串加密和解密 \tglobal $webdb;    $secret_string = $webdb[mymd5].$rand.'5*j,.^&;?.%#@!';\n加入到了这个$secret_string里面。然后$onlineip　这个是根据xff来的 最后判断了一下是否是正确的ip如果不正确 ip就为0.0.0.0 这里我们构造xff为一个错误的ip就行$onlineip就为0.0.0.0了。 然后再生成一下语句。\n\n应该可以直接登录后台 懒得弄了。   修复方案：  源头还是任意文件查看。，   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-06-24 11:09 厂商回复： 感谢提出来！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-23 11:58 |    \t\tCplusHua \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:33        | 乌云奖金:-1)\t\t \n  你关注的白帽子 ′ 雨。 发表了漏洞 qibocms 黄页系统SQL注入一枚\t2014-06-23你关注的白帽子 ′ 雨。 发表了漏洞 Qibocms图片系统任意文件查看导致的多处注入(可提升自己为管理员)\t2014-06-23你关注的白帽子 ′ 雨。 发表了漏洞 Ecmall Sql二次注入第二弹\t2014-06-23你关注的白帽子 ′ 雨。 发表了漏洞 qibocms B2b 某隐蔽SQL注入漏洞\t2014-06-23    \n     2014-06-23 12:50 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  不会吧 就一个上首页。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}