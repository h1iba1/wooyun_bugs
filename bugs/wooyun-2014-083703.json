{"id": 48259, "wybug_id": "wooyun-2014-083703", "wybug_title": "轻探金山批量猜解MD5的hadoop集群", "wybug_corp": "金山毒霸", "wybug_author": "luwikes", "wybug_date": "2014-11-18 11:10", "wybug_open_date": "2015-01-02 11:12", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["目录遍历", "任意文件上传", "任意文件下载", "命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-11-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-02：\t细节向公众公开  简要描述： 8台服务器的集群跑md5，对外开放的哦~发现了不少小伙伴的真名字，^_^ 详细说明：  http://221.228.204.53:8080/（别问我为什么这个是金山的，看看54和46）先是简单的一个列目录\n\n然后翻了翻找到一个霸气系统http://221.228.204.53:8080/N-grammar/web/ui/\n\n可以上传文件其中有一处查看自己的任务，可以下载任意文件\n\n我上传了几个php文件，不是md5猜解，没有结果，所以现在看不到下载按钮了，就在结果列：关键代码：\nfunction download_file(){    \tif(!empty($_REQUEST['download_file']))    \t{\t\t$downfilename = $_REQUEST['download_file'];\t\t$tfile = $_SERVER['DOCUMENT_ROOT'].\"/N-grammar/web/data/result/\".$downfilename;\t\t\t\tif (file_exists($tfile))\t\t{\t\t\tif(!empty($_REQUEST['view'])){\t\t\t\t$table = false;\t\t\t\tif ($_REQUEST['view']=='table'){\t\t\t\t\tif (filesize($tfile ) < 100*1024){\t\t\t\t\t\t$table = true;\t\t\t\t\t}\t\t\t\t}\t\t\t\tif ($table == true){\t\t\t\t\theader(\"Content-type: text/html; charset=utf-8\");\t\t\t\t\techo \"<html>\\n<table border=1 cellspacing=0>\\n<tr><td>\";\t\t\t\t\techo str_replace(\"\\t\",\"</td><td>\",str_replace(\"\\n\",\"</td></tr>\\n<tr><td>\",file_get_contents($tfile)));\t\t\t\t\techo \"</td></tr>\\n</table>\\n</html>\";\t\t\t\t}else{\t\t\t\t\theader('Content-Type: text/plain; charset=utf-8');\t\t\t\t\t$fp = @fopen($tfile, \"r\");\t\t\t\t\t@fpassthru($fp);\t\t\t\t\t@fclose($fp);\t\t\t\t}\n下载了passwd，hosts等127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 bus_hadoop_master::1         localhost localhost.localdomain localhost6 localhost6.localdomain610.57.18.12  bus.hadoop.master10.57.18.20  bus.hadoop.slave0110.57.18.21  bus.hadoop.slave0210.57.18.22  bus.hadoop.slave0310.57.18.23  bus.hadoop.slave0410.57.18.10  bus.hadoop.slave0510.57.18.11  bus.hadoop.slave0610.57.14.222    pub.isilon.wx10.57.66.14     wuxi.hadoop.master110.57.66.15     wuxi.hadoop.master210.57.66.25     wuxi.hadoop.slave110.57.66.26     wuxi.hadoop.slave210.57.66.27     wuxi.hadoop.slave310.57.66.28     wuxi.hadoop.slave410.57.66.29     wuxi.hadoop.slave510.57.66.30     wuxi.hadoop.slave6小规模集群，用户很多，大家认识吗？root:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinadm:x:3:4:adm:/var/adm:/sbin/nologinlp:x:4:7:lp:/var/spool/lpd:/sbin/nologinsync:x:5:0:sync:/sbin:/bin/syncshutdown:x:6:0:shutdown:/sbin:/sbin/shutdownhalt:x:7:0:halt:/sbin:/sbin/haltmail:x:8:12:mail:/var/spool/mail:/sbin/nologinuucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologinoperator:x:11:0:operator:/root:/sbin/nologingames:x:12:100:games:/usr/games:/sbin/nologingopher:x:13:30:gopher:/var/gopher:/sbin/nologinftp:x:14:50:FTP User:/var/ftp:/sbin/nologinnobody:x:99:99:Nobody:/:/sbin/nologindbus:x:81:81:System message bus:/:/sbin/nologinvcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologinsaslauth:x:499:76:\"Saslauthd user\":/var/empty/saslauth:/sbin/nologinpostfix:x:89:89::/var/spool/postfix:/sbin/nologinhaldaemon:x:68:68:HAL daemon:/:/sbin/nologinsshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologinntp:x:38:38::/etc/ntp:/sbin/nologintcpdump:x:72:72::/:/sbin/nologinwww:x:80:80::/home/www:/sbin/nologinchenjian:x:500:500::/home/chenjian:/bin/bashchenwuzhou:x:501:501::/home/chenwuzhou:/bin/bashcuipeng:x:502:502::/home/cuipeng:/bin/bashdongqian:x:503:503::/home/dongqian:/bin/bashhukai:x:505:505::/home/hukai:/bin/bashliangxiaocong:x:506:506::/home/liangxiaocong:/bin/bashliheng:x:507:507::/home/liheng:/bin/bashlijianhui:x:508:508::/home/lijianhui:/bin/bashlilongwei:x:509:509::/home/lilongwei:/bin/bashliuwang:x:510:510::/home/liuwang:/bin/bashluhuiyong:x:512:512::/home/luhuiyong:/bin/bashwangchao:x:513:513::/home/wangchao:/bin/bashwangyan:x:514:514::/home/wangyan:/bin/bashzhaohaijun:x:516:516::/home/zhaohaijun:/bin/bashzhaoyiding:x:517:517::/home/zhaoyiding:/bin/bashzhengwei:x:518:518::/home/zhengwei:/bin/bashduhui:x:519:519::/home/duhui:/bin/bashxiehaijun:x:520:520::/home/xiehaijun:/bin/bashluozuozhi:x:521:521::/home/luozuozhi:/bin/bashdengguo:x:522:522::/home/dengguo:/bin/bashyanghongxin:x:523:523::/home/yanghongxin:/bin/bashdinghui:x:524:524::/home/dinghui:/bin/bashdengkun:x:525:525::/home/dengkun:/bin/bashrpc:x:32:32:Rpcbind Daemon:/var/cache/rpcbind:/sbin/nologinrpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologinnfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologinzookeeper:x:498:498:ZooKeeper:/var/run/zookeeper:/sbin/nologinhdfs:x:497:496:Hadoop HDFS:/var/lib/hadoop-hdfs:/bin/bashyarn:x:496:495:Hadoop Yarn:/var/lib/hadoop-yarn:/bin/bashmapred:x:495:494:Hadoop MapReduce:/var/lib/hadoop-mapreduce:/bin/bashhbase:x:494:493:HBase:/var/run/hbase:/sbin/nologinhive:x:493:492:Hive:/var/lib/hive:/sbin/nologinmysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/bashonline:x:527:527::/home/online:/bin/bashliujian:x:529:529::/home/liujian:/bin/bashchenjiliang:x:530:530::/home/chenjiliang:/bin/bashzouyipeng:x:531:531::/home/zouyipeng:/bin/bashpanhongan:x:532:532::/home/panhongan:/bin/bashlonglimin:x:533:533::/home/longlimin:/bin/bashzhangyan:x:534:534::/home/zhangyan:/bin/bashliuhaiwang:x:535:535::/home/liuhaiwang:/bin/bashfanyange:x:536:536::/home/fanyange:/bin/bashwujiaxiang:x:537:537::/home/wujiaxiang:/bin/bashgonglishan:x:538:538::/home/gonglishan:/bin/bashzenghuan:x:539:539::/home/zenghuan:/bin/bashliuyutong:x:540:540::/home/liuyutong:/bin/bashwanglinlin:x:541:541::/home/wanglinlin:/bin/bashyangtao:x:542:542::/home/yangtao:/bin/bashzhangyunpeng:x:543:543::/home/zhangyunpeng:/bin/bashrenwenjie:x:544:544::/home/renwenjie:/bin/bash下载了文件上传处理的函数：function upload_file($file_widget_name, $dst_file){\tif ($_FILES[$file_widget_name][\"error\"] > 0)  \t{  \t\techo \"Error: \".$_FILES[$file_widget_name][\"error\"].\"<br />\";\t\treturn 1;  \t}\telse  \t{\t\t$UPLOAD_FILE_TYPE = \"text/plain\";\t\t$UPLOAD_FILE_SIZE = 10 * 1024 * 1024;\t\tif ($_FILES[$file_widget_name][\"size\"] == 0)\t\t{\t\t\techo \"Error : 您上传了空文件.<br />\";\t\t\treturn 1;\t\t}\t\tif ($_FILES[$file_widget_name][\"type\"] != $UPLOAD_FILE_TYPE) \t\t{\t\t\techo \"Error : 不支持处理文件类型 \".$_FILES[$file_widget_name][\"type\"].\"<br />\";\t\t\treturn 1;\t\t}\t\tif ($_FILES[$file_widget_name][\"size\"] > $UPLOAD_FILE_SIZE) 可以看到只检查了contect-type于是上传一个试一下发现是在每一行后面加一个family值\n\n于是重新构造了一下，将family值修改了一下，再次上传\n\n菜刀连接的时候，没连上\n\n百撕不得骑姐啊。又上传了个phpinfo，这下执行了http://221.228.204.53:8080/N-grammar/web/upload/task/test4.php\n\n\n\n\n\n\n\n可能是eval被限制了，没有更深入试探哪些函数可以执行，友情检测，点到为止。。   漏洞证明：  http://221.228.204.53:8080/N-grammar/web/upload/task/test4.php\n\n\n\n\n\n\n\n   修复方案：  把上传、下载的代码再改改，顺便建议：这么好的环境，留下来吧，大家都能用O(∩_∩)O~   版权声明：转载请注明来源 luwikes@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-11-18 13:20 厂商回复： 收到，我们将尽快跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-11-18 13:41 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  这个碉堡！！    \n     2014-11-20 10:29 |    \t\tihacku \t\t\t( 普通白帽子  |\t\t\t        Rank:100 漏洞数:33        | 同程旅游安全工程师。找大神带节奏，邮箱 s...)\t\t \n  金山跑MD5干啥    \n     2014-11-20 12:23 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  @ihacku 应该是渗透测试人员搭建的    \n     2014-12-10 17:26 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  有点没看明白    \n     2014-12-10 17:43 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  @wefgod 哪儿没看明白？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}