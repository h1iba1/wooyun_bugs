{"id": 43895, "wybug_id": "wooyun-2014-081332", "wybug_title": "mallbuilder多用户商城系统越权漏洞&amp;跨站漏洞", "wybug_corp": "shop-builder.cn", "wybug_author": "nextdoor", "wybug_date": "2014-10-31 11:23", "wybug_open_date": "2014-12-30 14:44", "wybug_type": "非授权访问/权限绕过", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-11-05：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-01-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-30：\t细节向公众公开  简要描述： 越权漏洞可以遍历他人收货地址跨站漏洞可以会员cookie一处和可以盗取管理员cookie一处 详细说明：  版本系统 MallBuilder_v5.8.1.1官方demo v6.9.3版本有效0x01 越权漏洞可以遍历他人收货地址module\\member\\admin_orderadder.php\n//--修改收货地址if($_POST['submit']=='edit'){\t$flag=$orderadder->edit_orderadder($_POST['edid']); //跟踪edit_orderadder函数\tif(is_numeric($_POST['i']) and $_POST['ty']=='tg')\t{\t\t$admin->msg($config['weburl'].'/?m=tg&s=order&id='.$_POST['i']);  \t\t}\telseif($_POST['ty']=='pro')\t{\t\t$admin->msg($config['weburl'].'/?m=product&s=confirm_order');  \t\t}\telse\t{\t\t$admin->msg($config['weburl'].'/main.php?m=member&s=admin_orderadder');  \t}}//--删除收货地址if(!empty($_GET['edid'])&&is_numeric($_GET['edid'])){\t$flag=$orderadder->del_orderadder($_GET['edid']);  //del_orderadder函数\t$admin->msg($config['weburl'].'/main.php?m=member&s=admin_orderadder');}//--显示收货地址if(!empty($_GET['id'])&&is_numeric($_GET['id']))\t$tpl->assign(\"de\",$orderadder->get_orderadder($_GET['id']));\t$tpl->assign(\"list\",$orderadder->get_orderadderlist());\nmodule\\member\\includes\\plugin_orderadder_class.php\nfunction edit_orderadder($id=NULL)\t{\t\tglobal $buid;\t\tif($id)\t\t{\t\t\t$default=$_POST['default']?\"2\":\"1\";\t\t\t$_POST['zip']=$_POST['zip']?$_POST['zip']:NULL;\t\t\tif($default=='2')\t\t\t{\t\t\t\t$sql=\"UPDATE \".DELIVERYADDR.\" SET `default` = '1' WHERE  `userid` ='$buid' \";\t\t\t\t$this -> db->query($sql);\t\t\t\t}\t\t\t$sql=\"UPDATE \".DELIVERYADDR.\" SET `name` = '$_POST[name]',`provinceid` = '$_POST[province]',`cityid` = '$_POST[city]', `areaid` = '$_POST[area]', `area` = '$_POST[t]', `address` = '$_POST[address]',`zip` = '$_POST[zip]',`tel` = '$_POST[tel]',`mobile` = '$_POST[mobile]',`default` = '$default' WHERE  `id` ='$id' \"; //仅用id参数验证，存在越权操作，可以任意变量他人收货地址\t\t\t$this -> db->query($sql);\t\t\t\treturn $id;\t\t}\t}function del_orderadder($id=NULL)\t{\t\tglobal $buid;\t\t\tif(is_numeric($id))\t\t{\t\t\t$tel=$_POST['tel1'].'-'.$_POST['tel2'].'-'.$_POST['tel3'];\t\t\t$sql=\"delete from \".DELIVERYADDR.\"  where id=$id \"; //仅用id参数验证，\t\t\t$flag=$this -> db->query($sql);\t\t \t\t\treturn $flag;\t\t}\t}\n0x02跨站漏洞可以盗取会员cookie，这个是在空间评论处的动态，只有加他为好友后评论就可以了，导致只要用户登陆就会中招sns.php文件\nif(!empty($_POST['act']))\t{\t\tif($_POST['act']=='comment')\t\t{\t\t\t$sns->add_sns_comment($_POST['act']); //跟踪add_sns_comment函数\t\t}\t\telse\t\t{\t\t\t$sns->add_sns($_POST['act']);\t\t}\t}\nplugin_sns_class.php文件\nfunction add_sns_comment()\t{\t\tglobal $buid,$config;\t\t\t\t$sql=\"select logo,user from \".MEMBER.\"  WHERE userid='$buid'\";\t\t$this->db->query($sql);\t\t$re=$this->db->fetchRow();\t\t\t\t$member_id = $buid;\t\t$member_name = $re['user'];\t\t$original_id = $_POST['commentid'];\t\t$create_time  = time();\t\t$content = $_POST['commentcontent']?$_POST['commentcontent']:\"\";//接受post的content\t\tif($content)\t\t{\t\t\t$sql=\"insert into \".SNSCOMMENT.\" (original_id,member_id,member_name,content,addtime) VALUES ('$original_id','$member_id','$member_name','$content','$create_time')\"; //输入点$content未过滤\t\t\t$this->db->query($sql);\t\t\t$this->db->query(\"update \".SNS.\" set comment_count=comment_count+1 where id='$original_id'\");\t\t}\t}输出点在这个函数中function get_sns()\t{\t\tglobal $buid,$config;\t\t\t\t$sql=\"select fuid from \".FRIEND.\" where uid=$buid order by addtime desc\";\t\t$this->db->query($sql);\t\t$re=$this->db->getRows();\t\t\t\t$myfriend=$buid;\t\t\t\tforeach($re as $val)\t\t{\t\t\t$myfriend.=','.$val['fuid'];\t\t}\t\t\t\t$sql=\"select a.* , b.member_id as ouid , b.member_name as ouser , b.title as otitle, b.create_time as ocreate_time, b.content as ocontent,b.img as oimg,b.type as otype from \".SNS.\" a left join \".SNS.\" b on a.original_id= b.id where a.member_id in ($myfriend) order by a.create_time desc\";\t\t$this->db->query($sql);\t\t$re=$this->db->getRows();\t\tif(!$re)\t\t{\t\t\t$sql=\"select a.* , b.member_id as ouid , b.member_name as ouser , b.title as otitle, b.create_time as ocreate_time, b.content as ocontent,b.img as oimg,b.type as otype from \".SNS.\" a left join \".SNS.\" b on a.original_id= b.id order by rand() , a.create_time desc\";\t\t}\t\t$str=\"\";\t\tinclude_once($config['webroot'].\"/includes/page_utf_class.php\");\t\tinclude_once($config['webroot'].\"/module/sns/face.php\");\t\t\t$page = new Page;\t\t$page->listRows=10;\t\t\t\tif (!$page->__get('totalRows'))\t\t{\t\t\t$this->db->query($sql);\t\t\t$page->totalRows = $this->db->num_rows();\t\t}\t\t$p=$_GET['page']-1>0?$_GET['page']-1:\"0\";\t\t$page->firstRow=$p*$page->listRows;        $sql .= \"  limit \".$page->firstRow.\",\".$page->listRows;\t\t$this->db->query($sql);\t\t$re=$this->db->getRows();\t\t\t\tforeach($face_array as $key=>$val)\t\t{\t\t\t$searcharray[] =\"/\\/\".$key.\"/\";\t\t\t$replacearray[] = \"<img align='absmiddle' src='image/face/\".$val.\"'>\";\t\t}\t\t\t\tforeach($re as $val)\t\t{\t\t\t$comment=$con=$del=$a=$img=\"\";\t\t\t$sql=\"select logo,name from \".MEMBER.\" WHERE userid='$val[member_id]'\";\t\t\t$this->db->query($sql);\t\t\t$a=$this->db->fetchRow();\t\t\t$val['member_img'] = $a['logo']?$a['logo']:\"image/default/user_admin/default_user_portrait.gif\";\t\t\t$val['member_name']=$a['name']?$a['name']:$val['member_name'];\t\t\t\t\t\t$sql=\"select * from \".SNSCOMMENT.\"  WHERE original_id='$val[id]' order by id desc\";\t\t\t$this->db->query($sql);\t\t\t$ss=$this->db->getRows();\t\t\t$val['title']=preg_replace($searcharray,$replacearray,$val['title']);\t\t\tif($ss)\t\t\t{\t\t\t\t$comment=\"<div class='commnet'>\";\t\t\t\tforeach($ss as $list)\t\t\t\t{\t\t\t\t\t$comment.=\"<div class='commnet_list'><dl><dt><a target=\\\"_blank\\\" href=\\\"home.php?uid=\".$list['member_id'].\"\\\">$list[member_name]</a> $list[content]</dt><dd>\".date('Y-m-d',$list['addtime']).\"</dd></div>\";\t\t\t\t}\t\t\t\t$comment.=\"</div>\";\t\t\t}\t\t\tif($val['original_id'])\t\t\t{\t\t\t\t$con=\"<div class=\\\"quote-wrap\\\">\";\t\t\t\tif($val['original_status']==1)\t\t\t\t{\t\t\t\t\t$con.=\"原文已删除\";\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t$val['otitle']=preg_replace($searcharray,$replacearray,$val['otitle']);\t\t\t\t\tif($val['oimg'])\t\t\t\t\t{\t\t\t\t\t\t$oimg=\"<div class=\\\"sns-img clearfix\\\"><ul>\";\t\t\t\t\t\t$opic=explode(',',$val['oimg']);\t\t\t\t\t\tforeach($opic as $op)\t\t\t\t\t\t{\t\t\t\t\t\t\tif($val['otype']=='2')\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$oimg.=\"<li><img class=\\\"small\\\" src=\\\"\".$op.\"_120X120.jpg\\\"></li>\";\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\telse\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$oimg.=\"<li><img src=\\\"\".$op.\"\\\"></li>\";\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t\t$oimg.=\"</ul></div>\";\t\t\t\t\t}\t\t\t\t\t$con.=\"<p><a target=\\\"_blank\\\" href=\\\"home.php?uid=\".$val['ouid'].\"\\\">\".$val['ouser'].\"</a></p><div class=\\\"sns-text\\\"><div class=\\\"sns-title\\\"><span>\".$val['otitle'].\"</span>\".$oimg.\"</div></div><div class=\\\"sns-extra\\\"><a class=\\\"sns-time\\\" title=\\\"\".date('Y年m月d日 H:i',$val['ocreate_time']).\"\\\" href=\\\"#\\\">\".date('m月d日 H:i',$val['ocreate_time']).\"</a></div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t$con.=\"</div>\";\t\t\t}\t\t\t$fd_forward=\"<span><a data-param=\\\"{&quot;bid&quot;:&quot;\".$val['id'].\"&quot;}\\\" genre=\\\"sns_forward\\\" href=\\\"javascript:void(0);\\\">转发</a></span><span><a data-param=\\\"{&quot;bid&quot;:&quot;\".$val['id'].\"&quot;}\\\" genre=\\\"sns_comment\\\" href=\\\"javascript:void(0);\\\">评论</a></span>\";\t\t\t$del=\"\";\t\t\tif($val['member_id']==$buid)\t\t\t{\t\t\t\t$del=\"<div class=\\\"more-action\\\"><a data-param=\\\"{&quot;bid&quot;:&quot;\".$val['id'].\"&quot;}\\\" data_type=\\\"fd_del\\\" href=\\\"javascript:void(0);\\\"></a></div>\";\t\t\t}\t\t\tif($val['img'])\t\t\t{\t\t\t\t$img=\"<div class=\\\"sns-img clearfix\\\"><ul>\";\t\t\t\t$pic=explode(',',$val['img']);\t\t\t\tforeach($pic as $p)\t\t\t\t{\t\t\t\t\tif($val['type']=='2')\t\t\t\t\t{\t\t\t\t\t\t$img.=\"<li><img class=\\\"small\\\" src=\\\"\".$p.\"_120X120.jpg\\\"></li>\";\t\t\t\t\t\t}\t\t\t\t\telse\t\t\t\t\t{\t\t\t\t\t\t$img.=\"<li><img src=\\\"\".$p.\"\\\"></li>\";\t\t\t\t\t}\t\t\t\t}\t\t\t\t$img.=\"</ul></div>\";\t\t\t}\t\t\t$str.=\"<div class=\\\"sns-item\\\"><div class=\\\"sns-avatar\\\"><a target=\\\"_blank\\\" href=\\\"shop.php?uid=\".$val['member_id'].\"\\\"><img width=\\\"60\\\" height=\\\"60\\\" src=\\\"\".$val['member_img'].\"\\\" ></a></div>\".$del.\"<div class=\\\"sns-wrap\\\"><p class=\\\"clearfix\\\"><a target=\\\"_blank\\\" href=\\\"home.php?uid=\".$val['member_id'].\"\\\"><b>\".$val['member_name'].\"</b></a></p><div class=\\\"sns-text\\\"><div class=\\\"sns-title\\\">\".$val['title'].\"</div>\".$img.\"</div>\".$con.\"<div class=\\\"sns-extra\\\"><a class=\\\"sns-time\\\" title=\\\"\".date('Y年m月d日 H:i',$val['create_time']).\"\\\" href=\\\"#\\\">\".date('m月d日 H:i',$val['create_time']).\"</a><span class=\\\"sns-action\\\">\".$fd_forward.\"</span></div></div><div class='clear'></div>\".$comment.\"</div>\"; //未过滤\t\t}\t\tif(($_GET['page']+1)<= ceil($page->totalRows/$page->listRows))\t\t{\t\t\t$str.=\"<div id=more></div>\";\t\t}\t\treturn $str;\n0x03这个存在于收货地址处module\\member\\admin_orderadder.php\nif($_POST['submit']=='edit'){\t$flag=$orderadder->edit_orderadder($_POST['edid']); \tif(is_numeric($_POST['i']) and $_POST['ty']=='tg')\t{\t\t$admin->msg($config['weburl'].'/?m=tg&s=order&id='.$_POST['i']);  \t\t}\telseif($_POST['ty']=='pro')\t{\t\t$admin->msg($config['weburl'].'/?m=product&s=confirm_order');  \t\t}\telse\t{\t\t$admin->msg($config['weburl'].'/main.php?m=member&s=admin_orderadder');  \t}}\nmodule\\member\\includes\\plugin_orderadder_class.php\nfunction edit_orderadder($id=NULL)\t{\t\tglobal $buid;\t\tif($id)\t\t{\t\t\t$default=$_POST['default']?\"2\":\"1\";\t\t\t$_POST['zip']=$_POST['zip']?$_POST['zip']:NULL;\t\t\tif($default=='2')\t\t\t{\t\t\t\t$sql=\"UPDATE \".DELIVERYADDR.\" SET `default` = '1' WHERE  `userid` ='$buid' \";\t\t\t\t$this -> db->query($sql);\t\t\t\t}\t\t\t$sql=\"UPDATE \".DELIVERYADDR.\" SET `name` = '$_POST[name]',`provinceid` = '$_POST[province]',`cityid` = '$_POST[city]', `areaid` = '$_POST[area]', `area` = '$_POST[t]', `address` = '$_POST[address]',`zip` = '$_POST[zip]',`tel` = '$_POST[tel]',`mobile` = '$_POST[mobile]',`default` = '$default' WHERE  `id` ='$id' \"; //post接受的参数未过滤\t\t\t$this -> db->query($sql);\t\t\t\treturn $id;\t\t}\t}\n输出点module\\member\\admin\\delivery_address.php中\n$sql=\"select a.*,b.user from \".DELIVERYADDR.\" a left join \".MEMBER.\" b on a.userid=b.userid \";\t//================================\tinclude_once(\"../includes/page_utf_class.php\");\t$page = new Page;\t$page->listRows=10;\tif (!$page->__get('totalRows')){\t\t$db->query($sql);\t\t$page->totalRows = $db->num_rows();\t}\t$sql .= \"  limit \".$page->firstRow.\",\".$page->listRows;\t$de['page'] = $page->prompt();\t//=================================\t$db->query($sql);\t$de['list']=$db->getRows(); //未进行有效过滤形成跨站\t\t$tpl->assign(\"de\",$de);\t$tpl->display(\"delivery_address.htm\");\n   漏洞证明：  越权官网证明http://democn.mall-builder.com/main.php?m=member&s=admin_orderadder&id=188&type=edit更改id参数即可遍历全部收货地址\n\n\n\n\n\n跨站攻击，为了不影响测试用例，官网中测试可以插入标签，未做输出显示过滤下面在自己搭建的平台演示\n\n\n\n\n\n   修复方案：  过滤   版权声明：转载请注明来源 nextdoor@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-12-30 14:44 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}