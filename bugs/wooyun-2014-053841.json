{"id": 3645, "wybug_id": "wooyun-2014-053841", "wybug_title": "hdwiki注入导致任意文件下载", "wybug_corp": "互动在线（北京）科技有限公司", "wybug_author": "phith0n", "wybug_date": "2014-03-17 09:25", "wybug_open_date": "2014-06-12 09:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-03-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-03-27：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-05-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-06-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-06-12：\t细节向公众公开  简要描述： RT。为一个朋友找的。 详细说明：  hdwiki上传附件处文件名过滤不严，导致可以注入：\nfunction douploadimg() {\t\t$imgname=$_FILES['photofile']['name'];\t\t$extname=file::extname($imgname);\t\t$destfile=$_ENV['attachment']->makepath($extname);\t\t$arrupload=file::uploadfile($_FILES['photofile'],$destfile);\t\t\t\tif($arrupload['result']==true){\t\t\tif(isset($this->setting['watermark'])){\t\t\t\t$_ENV['watermark']->image($destfile,$destfile);\t\t\t}\t\t\t$uid=intval($this->user['uid'])?$this->user['uid']:0;\t\t\t$did=intval($this->get['2'])?$this->get['2']:0;\t\t\t$_ENV['attachment']->add_attachment($uid ,$did,$imgname ,$destfile ,htmlspecialchars($this->post['picAlt']) ,$extname);\n直接将$imgname插入attachment表。但前台没有输出点，只能够盲注。但因为是附件上传处，我们可以通过注入控制附件文件位置。下载的时候即可读取该文件，产生一个任意文件读取：\nfunction dodownload(){\t\tif(!isset($this->get[2]) || !is_numeric($this->get[2])){\t\t\t$this->message($this->view->lang['parameterError'],'BACK');\t\t}\t\t$result=$_ENV['attachment']->get_attachment('id',$this->get[2],0);\t\tif(!(bool)$attachment=$result[0]){\t\t\t$this->message($this->view->lang['attachIsNotExist'],'BACK');\t\t}\t\tif($this->user['uid'] != $attachment['uid']) {\t\t\t// 判断金币\t\t\t$credit1 = $this->user['credit1'];\t\t// 拥有金币数\t\t\t$coindown = $attachment['coindown'];\t// 下载此附件需要消耗金币数\t\t\tif(0 > $credit1 - $coindown) {\t\t\t\t// 金币不足\t\t\t\t$this->message($this->view->lang['goldNotEnough'],\"index.php?doc-view-\".$attachment['did'],0);\t\t\t}\t\t\t// 扣除金币\t\t\t$_ENV['user']->add_credit($this->user['uid'],'attachment-down',0,-$coindown);\t\t\t// 增加金币\t\t\t$_ENV['user']->add_credit($attachment['uid'],'attachment-down',0,$coindown);\t\t}\t\t$_ENV['attachment']->update_downloads($attachment['id']);\t\tfile::downloadfile($attachment['attachment'],$attachment['filename']);\t}\n   漏洞证明：  本地搭建最新版5.1。注册用户，新增或编辑词条。上传图片：\n\n中途抓包改包：\n\n其中config.php即为我要下载的文件。（最好用hex）附件上传完成后，来到：localhost/wiki/index.php?attachment-download-xx其中xx是刚才上传的附件的id，这个id不知道，但肯定是最后一个id，所以穷举一遍id值即可。\n\n下载后打开即为config.php的内容：\n\n   修复方案：  过滤$_FILE变量   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-06-12 09:26 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-03-17 09:26 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  注入导致任意文件下载    \n     2014-03-17 09:40 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  关注！    \n     2014-03-17 10:24 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  师傅  叼爆了。    \n     2014-05-04 17:49 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  mark    \n     2014-06-12 09:41 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  叼    \n     2014-07-02 14:59 |    \t\tD＆G \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:103        | going)\t\t \n  需要gpc为off么？测试发现gpc开了的时候，$_FILES中name变量被单引号截断了，没法传递单引号到数据库。    \n     2014-07-03 23:03 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @D＆G 话说 - - 那不是叫转义么。 刚才下了个看了看。 已经addslashes了。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}