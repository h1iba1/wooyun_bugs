{"id": 1216, "wybug_id": "wooyun-2014-070454", "wybug_title": "聊着聊着我就上了你……的微信（两处都可以劫持微信登录的漏洞）", "wybug_corp": "腾讯", "wybug_author": "呆子不开口", "wybug_date": "2014-07-31 14:12", "wybug_open_date": "2014-09-22 17:00", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感接口缺乏认证", "未授权访问", "用户敏感信息泄露", "认证设计不合理"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-31：\t该漏洞正等待厂商内部评估\t\t\t\t\t\t\t\t\t2014-08-01：\t厂商已经确认，与白帽子共同解决该漏洞中，漏洞信息仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向公众公开  简要描述： 聊着聊着我就上了你……的微信（两处都可以劫持微信登录的漏洞） 详细说明： 一、mac版客户端登录的劫持mac版客户端的扫码登录确认页的请求为如下（有些以星号代替了）http://szsupport.weixin.qq.com/cgi-bin/mmsupport-bin/qrcodelogin?username=*********&key=*************&clientversion=25030133&devicetype=android-18&lan=zh_CN&uuid=AXBIICc4sUSDsFnefkNP&pass_ticket=DebNjGnP2dJnq1bMvHvgL%2BezqqE70Ry9iWB625%2FRT8RRnwCD3tlq3qxuxG5YPzhx经过测试可发现，此请求无需用户扫码动作确认，也没有签名保护，其中username和uuid分别是用户的微信号和二维码字符，很容易得到。key无法被攻击者猜出，但是也可以通过别的方式得到，比如如下方式微信的公共账号发的文章url为这种：http://mp.weixin.qq.com/s?__biz=**********==&mid=10000001&idx=1&sn=bdc73ae816f2e7097c225b6070b1f2f2&from=singlemessage&isappinstalled=0#rd在微信中打开这种链接，最终的目标页会被微信浏览器加上key和pass_ticket参数，这样只要我们能在这篇文章中插入个自定义url的图片即可通过referer偷到这个key。公众账号发表的文章不可以直接写自定义的IMG，但通过修改http请求里的参数就可以把图片地址换成我们自己服务器上的url了这样只要发送给受害者点击，或者欺骗他扫描此链接的二维码，然后就可以得到key，然后拼接那个扫码登录确认页请求，点击确认登录，我们的客户端就可以自动登录了二、网页版微信登录的劫持网页版客户端的扫码登录确认页的请求为如下（有些以星号代替了）http://login.weixin.qq.com/confirm?uuid=e921eed1fbf84e&key=*****************&lang=zh_CN&scan=1406467880&clientversion=25030133&devicetype=android-18经过测试可发现，此请求也没有签名保护，但需用户扫码动作确认，其中uuid分别是二维码字符，很容易得到。key的话也可以通过如上方式获得。所以我们需要做的就是再让用户扫下码。网页版二维码链接原文是这种https://login.weixin.qq.com/l/e921eed1fbf84e，经测试发现，可以直接把这个链接发送给用户访问，也可以达到用户扫描的效果这样只要给受害者发送两个链接诱惑他点击，或者让他点击一个页面然后诱惑他去扫描内容中的二维码，就可以得到key，并让我们的请求合法。然后再拼接那个扫码登录确认页请求，点击确认登录，我们的网页版就可以自动登录了  漏洞证明： 首先在公众账号的内容中加入自定义图片\n\nmac客户端劫持：先发送欺骗她点击\n\n然后我会收到\n\n然后在浏览器点击确认登录\n\n最后登录成功\n\n网页版微信劫持：先聊\n\n然后收到key\n\n\n\n\n\n  修复方案： 如果没有需求，尽量公共账号发的消息文章中不允许有自定义src的图片保护好get参数key不被referer等泄露，如果可以尽量用postmac版的扫码登录需要做成和网页版一样，需要用户扫码确认才可以对登录确认页的参数进行签名校验等等……  版权声明：转载请注明来源 呆子不开口@乌云\n ", "wybug_reply": "漏洞回应 厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-01 17:31 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无 ", "replys": "漏洞评价：\n评论\n     2014-07-31 16:08 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  大杀器！    \n     2014-07-31 16:10 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @Finger 管理员    \n     2014-07-31 16:21 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  必杀技！    \n     2014-07-31 16:32 |    \t\t呆子不开口 \t\t\t( 普通白帽子  |\t\t\t        Rank:324 漏洞数:25        | 求各种兼职)\t\t \n  贵司人好多，再凑一个打麻将吧    \n     2014-07-31 17:02 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @呆子不开口 厂商确认中    \n     2014-09-22 17:53 |    \t\t养乐多Ngan \t\t\t( 普通白帽子  |\t\t\t        Rank:652 漏洞数:72        | Hello,world.其实最大的漏洞，是人心。)\t\t \n  膜拜啊！    \n     2014-09-22 18:11 |    \t\t继续沉默 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:9        | 好好学习，天天向上)\t\t \n  你竟敢欺负我们舟舟，她可是我最喜欢的作家    \n     2014-09-22 18:19 |    \t\ttracyfan \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:2        | 崇尚进攻只能编出烂代码的抢点型前锋)\t\t \n  霸气~ 要火    \n     2014-09-22 18:28 |    \t\t大白菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:19        )\t\t \n  膜拜了！！！    \n     2014-09-22 19:41 |    \t\t咖啡 \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:20        )\t\t \n  挖这个洞首要有一台Mac    \n     2014-09-22 19:55 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @呆子不开口 听说洞主是个段子手～果断看起洞主微薄学段子    \n     2014-09-23 09:33 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  牛逼啊！    \n     2014-09-23 10:44 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @redrain有节操 黄段子手    \n     2014-09-23 10:51 |    \t\tSeven.Sea \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:24        | 唯有安全与美食不可辜负。)\t\t \n  膜拜膜拜..洞主也是个段子手..    \n     2014-09-23 11:22 |    \t\t呆子不开口 \t\t\t( 普通白帽子  |\t\t\t        Rank:324 漏洞数:25        | 求各种兼职)\t\t \n  @xsser 我只是个影视剧爱好者，为了你我一直在追《古剑奇谭》    \n     2014-09-23 11:31 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @呆子不开口 尼玛    \n     2014-09-23 12:08 |    \t\t番茄师傅 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:59        | http://www.tomatoyu.com/)\t\t \n  屌    \n     2014-09-23 14:41 |    \t\t卡农的保镖 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 好)\t\t \n  兄弟 有果照吗 发出来阿    \n     2014-09-23 15:18 |    \t\twinsyk \t\t\t( 普通白帽子  |\t\t\t        Rank:108 漏洞数:16        | 越长大越孤单)\t\t \n  牛逼。    \n     2014-09-23 17:42 |    \t\thqdvista \t\t\t( 普通白帽子  |\t\t\t        Rank:154 漏洞数:31        | N/A)\t\t \n  这个洞就一个字：爽    \n     2014-09-23 18:16 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  CCAV的记者同志 往下拍 往下拍    \n     2014-09-23 20:11 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  可以试一下易信的    \n     2014-09-24 13:22 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  舟舟哭了……    \n     2015-03-02 18:55 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2015-04-24 16:06 |    \t\t鸡鸡 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:4        )\t\t \n  蒋方舟。。。。    \n     2015-04-24 17:47 |    \t\t無名老人 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:3        | 干过开发，日过渗透，江湖人称： 少女杀手)\t\t \n  厉害，厉害，洞主真仔细    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}