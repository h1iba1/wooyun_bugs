{"id": 5795, "wybug_id": "wooyun-2013-044084", "wybug_title": "phpcms v9 前台无限制GETSHELL（第一弹）", "wybug_corp": "phpcms", "wybug_author": "狗狗侠", "wybug_date": "2013-11-26 11:19", "wybug_open_date": "2014-02-24 11:19", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-01-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-02-24：\t细节向公众公开  简要描述：  详细说明：    第一次玩乌云，希望给个邀请码，壮我大乌云0x01:介绍    PHPCMS V9（后面简称V9）采用PHP5+MYSQL做为技术基础进行开发。V9采用OOP（面向对象）方式进行基础运行框架搭建。模块化开发方式做为功能开发形式。框架易于功能扩展，代码维护，优秀的二次开发能力，可满足所有网站的应用需求。 5年开发经验的优秀团队，在掌握了丰富的WEB开发经验和CMS产品开发经验的同时，勇于创新追求完美的设计理念，为全球多达10万网站提供助力，并被更多的政府机构、教育机构、事业单位、商业企业、个人站长所认可。0x02:漏洞分析在中 v9\\phpcms\\modules\\member\\index.php381行处\npublic function account_manage_avatar() {\t\t$memberinfo = $this->memberinfo;\t\t//初始化phpsso\t\t$phpsso_api_url = $this->_init_phpsso();\t\t$ps_auth_key = pc_base::load_config('system', 'phpsso_auth_key');\t\t$auth_data = $this->client->auth_data(array('uid'=>$this->memberinfo['phpssouid'], 'ps_auth_key'=>$ps_auth_key), '', $ps_auth_key);\t\t$upurl = base64_encode($phpsso_api_url.'/index.php?m=phpsso&c=index&a=uploadavatar&auth_data='.$auth_data);\t\t//获取头像数组\t\t$avatar = $this->client->ps_getavatar($this->memberinfo['phpssouid']);\t\t\t\tinclude template('member', 'account_manage_avatar');\t}\n这里是一个上传头像的功能模块，我们继续跟踪上传地址为v9/phpsso_server/index.php?m=phpsso&c=index&a=uploadavatar读取v9\\phpsso_server\\phpcms\\modules\\phpsso\\index.php文件其中uploadavatar为我们处理上传头像函数具体函数如下\npublic function uploadavatar() {\t\t\t\t//根据用户id创建文件夹\t\tif(isset($this->data['uid']) && isset($this->data['avatardata'])) {\t\t\t$this->uid = $this->data['uid'];\t\t\t$this->avatardata = $this->data['avatardata'];\t\t} else {\t\t\texit('0');\t\t}\t\t\t\t$dir1 = ceil($this->uid / 10000);\t\t$dir2 = ceil($this->uid % 10000 / 1000);\t\t\t\t//创建图片存储文件夹\t\t$avatarfile = pc_base::load_config('system', 'upload_path').'avatar/';\t\t$dir = $avatarfile.$dir1.'/'.$dir2.'/'.$this->uid.'/';\t\tif(!file_exists($dir)) {\t\t\tmkdir($dir, 0777, true);\t\t}\t\t\t\t//存储flashpost图片\t\t$filename = $dir.$this->uid.'.zip';\t\tfile_put_contents($filename, $this->avatardata);\t\techo $filename;exit();\t\t//解压缩文件\t\tpc_base::load_app_class('pclzip', 'phpsso', 0);\t\t$archive = new PclZip($filename);\t\tif ($archive->extract(PCLZIP_OPT_PATH, $dir) == 0) {\t\t\tdie(\"Error : \".$archive->errorInfo(true));\t\t}\t\t\t\t//判断文件安全，删除压缩包和非jpg图片\t\t$avatararr = array('180x180.jpg', '30x30.jpg', '45x45.jpg', '90x90.jpg');\t\tif($handle = opendir($dir)) {\t\t    while(false !== ($file = readdir($handle))) {\t\t\t\tif($file !== '.' && $file !== '..') {\t\t\t\t\tif(!in_array($file, $avatararr)) {\t\t\t\t\t\t@unlink($dir.$file);\t\t\t\t\t} else {\t\t\t\t\t\t$info = @getimagesize($dir.$file);\t\t\t\t\t\tif(!$info || $info[2] !=2) {\t\t\t\t\t\t\t@unlink($dir.$file);\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t    }\t\t    closedir($handle);    \t\t}\t\t$this->db->update(array('avatar'=>1), array('uid'=>$this->uid));\t\texit('1');\t}\n其中关键代码\npc_base::load_app_class('pclzip', 'phpsso', 0);\t\t$archive = new PclZip($filename);\t\tif ($archive->extract(PCLZIP_OPT_PATH, $dir) == 0) {\t\t\tdie(\"Error : \".$archive->errorInfo(true));\t\t}\n这里为解压缩文件接下来为判断是否为图片类型\n//判断文件安全，删除压缩包和非jpg图片\t\t$avatararr = array('180x180.jpg', '30x30.jpg', '45x45.jpg', '90x90.jpg');\t\tif($handle = opendir($dir)) {\t\t    while(false !== ($file = readdir($handle))) {\t\t\t\tif($file !== '.' && $file !== '..') {\t\t\t\t\tif(!in_array($file, $avatararr)) {\t\t\t\t\t\t@unlink($dir.$file);\t\t\t\t\t} else {\t\t\t\t\t\t$info = @getimagesize($dir.$file);\t\t\t\t\t\tif(!$info || $info[2] !=2) {\t\t\t\t\t\t\t@unlink($dir.$file);\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t    }\t\t    closedir($handle);    \t\t}\n为180x180.jpg', '30x30.jpg', '45x45.jpg', '90x90.jpg ，如果不为这几种，则就删除，但是他考虑到的仅仅是当前目录下的，没做循环遍历，导致我们可以新建一个目录，然后里面放入我们的PHP木马，然后压缩成zip，然后再上传，然后即可达到任意上传文件，直接前台无限制getshell0x03:漏洞利用  新建一个如图文件  新建一个22目录，目录里面放入我们的test.php文件，test.php里面放入我们的一句话，然后压缩成zip文件 \n\n 然后上传一个正常头像，获取一个路径，如正常头像地址为http://127.0.0.1/v9/phpsso_server/uploadfile/avatar/1/1/3/90x90.jpg然后我们再次上传，通过burpsuit抓包，将其中post的内容用paste from file替换掉\n\n然后发送最好获取shell路径为 在之前的正常路径下面加上我们的解压路径，如http://127.0.0.1/v9/phpsso_server/uploadfile/avatar/1/1/3/22/test.php\n\n0x04:修复这个phpcms 直接循环遍历一下验证吧0x05:奖励听说乌云通用型奖励很给力哦？ 是真的么？ 如果给力，我再来几发？ xsser?   漏洞证明：  \n\n   修复方案：  循环遍历验证下吧   版权声明：转载请注明来源 狗狗侠@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2013-11-26 13:36 厂商回复： 感谢提交！！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-26 11:21 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  又来了一个神奇的路人甲    \n     2013-11-26 11:22 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  关注之    \n     2013-11-26 11:24 |    \t\tMeirLin \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:30        | 号借人)\t\t \n  前台吗。霸气    \n     2013-11-26 11:27 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  连载的节奏？    \n     2013-11-26 11:29 |    \t\t九零少帅 \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:10        | 喂 你干嘛哩.)\t\t \n  @路人甲 求忽略！    \n     2013-11-26 11:42 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  路人甲好啊 这个奖励不都是发到乌云的账户了？    \n     2013-11-26 12:06 |    \t\tB1acken \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:56        | 渣渣)\t\t \n  前台无限制GETSHELL,亮了    \n     2013-11-26 12:10 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  @xsser 我是狗狗侠，请发到我乌云账户，不客气...哈哈    \n     2013-11-26 12:14 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @狗狗侠 瞄了个咪咪的    \n     2013-11-26 12:15 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1055 漏洞数:292        | 诶，现在通用奖励越来越低了；离买保时捷卡...)\t\t \n  Mark!    \n     2013-11-26 12:18 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n   @xsser  我是狗狗侠，这是我的新马甲，别客气    \n     2013-11-26 12:21 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  @xsser 我知道是谁了，感谢    \n     2013-11-26 12:22 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  @猪猪侠 现身吧    \n     2013-11-26 12:28 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @西毒 搞个猜马甲有奖活动吧    \n     2013-11-26 12:31 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  前台无限制GETSHELL,亮了    \n     2013-11-26 12:39 |    \t\t西毒 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:33        | 心存谦卑才能不断超越自我)\t\t \n  @xsser 好啊 好啊...猜对了乌云送妹子？    \n     2013-11-26 12:41 |    \t\t园长 \t\t\t( 普通白帽子  |\t\t\t        Rank:134 漏洞数:14        | 你在身边就是缘，缘分写在数据库里面。)\t\t \n  狗狗侠    \n     2013-11-26 13:08 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  这又是一哥的节奏吖    \n     2013-11-26 13:29 |    \t\tNetSeif \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:13        | ‮（子帽白心核)\t\t \n  霸气！    \n     2013-11-26 13:30 |    \t\tNetSeif \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:13        | ‮（子帽白心核)\t\t \n  ‮（子帽白心核    \n     2013-11-26 13:32 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  狗狗侠>_<    \n     2013-11-26 13:40 |    \t\t只发通用型 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:14        | 刷通用型奖金小号)\t\t \n  我猜是疯狗的马甲    \n     2013-11-26 14:59 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @只发通用型 楼上也是马甲无误    \n     2013-11-26 15:06 |    \t\t小米 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:3        | 性别男 爱好女 看AV我最行 要装逼找Helen ...)\t\t \n  难道你还有第二弹？    \n     2013-11-26 15:40 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @xsser 我猜是猪猪侠的..    \n     2013-11-26 15:43 |    \t\t浩天  \t\t\t( 普通白帽子  |\t\t\t        Rank:915 漏洞数:79        | 度假中...)\t\t \n  应该注册个猫猫侠、鸡鸡侠等等    \n     2013-11-26 16:26 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  马了个克的！    \n     2013-11-26 18:45 |    \t\tDistant \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 乌云奖金:999999999999999999999999.99 元)\t\t \n  @狗狗侠 要献身了吗    \n     2013-11-26 21:54 |    \t\t无名小卒 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 我不是黑阔，但我认识的全是黑阔！)\t\t \n  亮瞎我了！    \n     2013-11-26 22:07 |    \t\tSct7p \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:9        | 懂与不懂之间只隔了一层纸，懂的人会觉得很...)\t\t \n  狗狗侠，猪猪侠。干嘛不来个蜘蛛侠。或者来个什么犬夜叉啊。什么的    \n     2013-11-29 14:41 |    \t\t挖掘鸡 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 我爱挖掘鸡)\t\t \n  27-46-31-08@qq.com 哪位发送个来，我有挖掘鸡，看能不能批量，大家分享    \n     2013-11-29 14:49 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  为毛楼上这么多马甲。。。    \n     2013-11-29 14:53 |    \t\t钱 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 爱好互联网安全)\t\t \n  我也来一个。。    \n     2013-11-29 15:02 |    \t\t大肠精 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 业余兴趣而已)\t\t \n  应该要先获取管理密码吧    \n     2013-11-30 01:34 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  急需该洞子    \n     2013-11-30 08:33 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1055 漏洞数:292        | 诶，现在通用奖励越来越低了；离买保时捷卡...)\t\t \n  坐等第二弹！    \n     2013-11-30 09:28 |    \t\t九零少帅 \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:10        | 喂 你干嘛哩.)\t\t \n  @鬼魅羊羔 哎哟 这么马甲！好眼熟！    \n     2013-11-30 15:32 |    \t\tQQ852451559 \t\t\t( 实习白帽子  |\t\t\t        Rank:79 漏洞数:18        | 学生党)\t\t \n  mark    \n     2013-11-30 17:07 |    \t\t落月 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 落月，关注网络安全；关注黑帽劫持；)\t\t \n  0。霸气    \n     2013-11-30 20:50 |    \t\t挖掘鸡 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 我爱挖掘鸡)\t\t \n  给我，我来挖掘鸡批量出来    \n     2013-11-30 21:17 |    \t\tJ′aron \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | 问题真实存在但是影响不大.)\t\t \n  前台无限制GETSHELL,亮了    \n     2013-11-30 21:23 |    \t\t风风 \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:43        | 。)\t\t \n  猪猪侠，狗狗侠。目测要火鸡鸡侠，驴驴侠，羊羊侠，牛牛侠  这些谁注册，交版权费啊你们就是幸福的一家.    \n     2013-12-01 01:52 |    \t\tskysheep \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 关注网络安全。)\t\t \n  +1    \n     2013-12-01 22:34 |    \t\t邪少 \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:7        )\t\t \n  我草。。如何修复呢。。怎么修复啊。    \n     2013-12-02 13:10 |    \t\t冻心 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 爱wooyun  爱生活！)\t\t \n  这是要疯了吧这    \n     2013-12-03 04:42 |    \t\tskysheep \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 关注网络安全。)\t\t \n  注意这是第一蛋  蛋  蛋  蛋 。    \n     2013-12-16 23:18 |    \t\tHuc-Unis \t\t\t( 普通白帽子  |\t\t\t        Rank:1055 漏洞数:292        | 诶，现在通用奖励越来越低了；离买保时捷卡...)\t\t \n  敢问洞主测试的最高哪个版本的？9.5.1？我测试了的确不错！但其实是有限制的，有些不允许注册，或注册提示禁止的用户名！如何破也？    \n     2013-12-17 23:24 |    \t\tcnrstar \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:23        | Be my personal best!)\t\t \n  霸气～    \n     2013-12-18 21:58 |    \t\t冻心 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:3        | 爱wooyun  爱生活！)\t\t \n  为何是路人！！！！    \n     2013-12-20 18:04 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  好强大的狗狗侠..跟猪猪侠啥关系？    \n     2013-12-20 18:27 |    \t\t何松 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | 你看)\t\t \n  狗狗侠  - -爆了    \n     2013-12-20 21:18 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @Huc-Unis 求exp    \n     2013-12-22 00:00 |    \t\tWindy \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:10        | 苦逼的民工)\t\t \n  前台无限制GETSHELL！！！    \n     2013-12-24 22:48 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @xsser 这个是360上,10月11号就发布了的,相差了一个多月哦    \n     2013-12-25 02:00 |    \t\tWindy \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:10        | 苦逼的民工)\t\t \n  @挖掘鸡 求掘鸡。。。    \n     2013-12-25 22:06 |    \t\tKi11 \t\t\t( 路人 |\t\t\t        Rank:26 漏洞数:5        | ส็็็็็็็็็็็็็็็็็็็...)\t\t \n  路人还要等多少年？    \n     2013-12-30 18:18 |    \t\tscan_z \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:4        | /home/work/newsphp/newsroot/temp/smarty/...)\t\t \n  路人路过。。。    \n     2013-12-31 00:22 |    \t\t无名小卒 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 我不是黑阔，但我认识的全是黑阔！)\t\t \n  路人需要等多少年！    \n     2014-01-20 10:03 |    \t\tx1aoh4i \t\t\t( 普通白帽子  |\t\t\t        Rank:403 漏洞数:62        )\t\t \n    我也是马甲    \n     2014-02-12 20:06 |    \t\t军哥哥 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 艹艹艹艹)\t\t \n  狗侠的PHP技术不错啊！    \n     2014-02-24 18:23 |    \t\t乌云一哥 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:1        | echo file_get_contents('http://www.wooyu...)\t\t \n  ...这个漏洞。。。。貌似传了好久了    \n     2014-06-13 10:57 |    \t\t小贱人 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:3        | 资深菜鸟，)\t\t \n  已阅 不错    \n     2015-01-18 23:23 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  吊    \n     2015-03-17 09:30 |    \t\tbobbi \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 人生真是寂寞如雪)\t\t \n  66666666666    \n     2015-03-17 10:21 |    \t\tB1acken \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:56        | 渣渣)\t\t \n  @xsser 这个可以有    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}