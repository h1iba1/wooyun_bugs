{"id": 1623, "wybug_id": "wooyun-2014-063225", "wybug_title": "74cms 最新版 注入8-9", "wybug_corp": "74c,s.com", "wybug_author": "′雨。", "wybug_date": "2014-06-05 15:08", "wybug_open_date": "2014-09-03 15:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-03：\t细节向公众公开  简要描述： 骑士PHP人才系统：74cms V3.4.20140530 详细说明：  GBK 2字节一汉字 UTF8 三字节 一汉字。74cms 在读取数据库的时候 character_set_client=binary这样没办法来直接宽字节来注入了。得找一些转换编码的地方。錦 从UTF8 转成 GBK之后成了 %e5%5c74cms对GET POST COOKIE …… 都做了addslashes所以' 转义后为\\'\\->%5C   %e5%5c%5c' 两个\\\\ 则单引号出来再看看74cms的全局过滤\nfunction remove_xss($string) {     $string = preg_replace('/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]+/S', '', $string);    $parm1 = Array('javascript', 'vbscript', 'expression', 'applet', 'union', 'xml', 'blink', 'link', 'script', 'embed', 'object', 'iframe', 'frame', 'frameset', 'ilayer', 'layer', 'bgsound', 'title', 'base');    $parm2 = Array('onabort', 'onactivate', 'onafterprint', 'onafterupdate', 'onbeforeactivate', 'onbeforecopy', 'onbeforecut', 'onbeforedeactivate', 'onbeforeeditfocus', 'onbeforepaste', 'onbeforeprint', 'onbeforeunload', 'onbeforeupdate', 'onblur', 'onbounce', 'oncellchange', 'onchange', 'onclick', 'oncontextmenu', 'oncontrolselect', 'oncopy', 'oncut', 'ondataavailable', 'ondatasetchanged', 'ondatasetcomplete', 'ondblclick', 'ondeactivate', 'ondrag', 'ondragend', 'ondragenter', 'ondragleave', 'ondragover', 'ondragstart', 'ondrop', 'onerror', 'onerrorupdate', 'onfilterchange', 'onfinish', 'onfocus', 'onfocusin', 'onfocusout', 'onhelp', 'onkeydown', 'onkeypress', 'onkeyup', 'onlayoutcomplete', 'onload', 'onlosecapture', 'onmousedown', 'onmouseenter', 'onmouseleave', 'onmousemove', 'onmouseout', 'onmouseover', 'onmouseup', 'onmousewheel', 'onmove', 'onmoveend', 'onmovestart', 'onpaste', 'onpropertychange', 'onreadystatechange', 'onreset', 'onresize', 'onresizeend', 'onresizestart', 'onrowenter', 'onrowexit', 'onrowsdelete', 'onrowsinserted', 'onscroll', 'onselect', 'onselectionchange', 'onselectstart', 'onstart', 'onstop', 'onsubmit', 'onunload');    $parm = array_merge($parm1, $parm2); \tfor ($i = 0; $i < sizeof($parm); $i++) { \t\t$pattern = '/'; \t\tfor ($j = 0; $j < strlen($parm[$i]); $j++) { \t\t\tif ($j > 0) { \t\t\t\t$pattern .= '('; \t\t\t\t$pattern .= '(&#[x|X]0([9][a][b]);?)?'; \t\t\t\t$pattern .= '|(&#0([9][10][13]);?)?'; \t\t\t\t$pattern .= ')?'; \t\t\t}\t\t\t$pattern .= $parm[$i][$j]; \t\t}\t\t$pattern .= '/i';\t\t$string = preg_replace($pattern, '', $string); \t}\treturn $string;\n是开启了i修正符的 所以不能用大小写绕过  但是利用清空 uniounionn等 都行。__________________________________________________________________________第八处: plus/ajax_common.php中\nelseif($act==\"hotword\"){\tif (empty($_GET['query']))\t{\texit();\t}\t$gbk_query=trim($_GET['query']);\tif (strcasecmp(QISHI_DBCHARSET,\"utf8\")!=0)\t{\t$gbk_query=iconv(\"utf-8\",QISHI_DBCHARSET,$gbk_query);\t}\t$sql=\"SELECT * FROM \".table('hotword').\" WHERE w_word like '%{$gbk_query}%' ORDER BY `w_hot` DESC LIMIT 0 , 10\";\t$result = $db->query($sql);\twhile($row = $db->fetch_array($result))\t{\t\t$list[]=\"'\".$row['w_word'].\"'\";\t}\tif ($list)\t{\t$liststr=implode(',',$list);\t$str=\"{\";\t$str.=\"query:'{$gbk_query}',\";\t$str.=\"suggestions:[{$liststr}]\";\t$str.=\"}\";\n转码后直接带入查询 而且直接输出。测试一下有demo 虽然有安全狗 但是能绕过。\n\n_________________________________________________________________________第9处   在plus/ajax_officebuilding.php中\nelseif($act == 'key'){\t$key=trim($_GET['key']);\tif (!empty($key))\t{\tif (strcasecmp(QISHI_DBCHARSET,\"utf8\")!=0) $key=iconv(\"utf-8\",QISHI_DBCHARSET,$key);\t$result = $db->query(\"select * from \".table('category').\" where c_alias='QS_officebuilding' AND c_name LIKE '%{$key}%' \");\twhile($row = $db->fetch_array($result))\t{\t\tif ($listtype==\"li\")\t\t{\t\t$htm.=\"<li  title=\\\"{$row['c_name']}\\\" id=\\\"{$row['c_id']}\\\">{$row['c_name']}</li>\";\t\t}\t\telse\t\t{\t\t$_GET['officebuildingid']=$row['c_id'];\t\t$url=url_rewrite('QS_officebuilding',$_GET);\t\t$htm.=\"<li><a href=\\\"{$url}\\\" title=\\\"{$row['c_note']}\\\" class=\\\"vtip\\\">{$row['c_name']}</a><span>{$row['stat_jobs']}</span></li>\";\t\t}\t}\tif (empty($htm))\n转换编码后直接带入到查询中 然后直接输出测试一下demo\n\n   漏洞证明：  见上面。   修复方案：  注意转码的安全问题。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-06-07 16:32 厂商回复： 感谢反馈 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}