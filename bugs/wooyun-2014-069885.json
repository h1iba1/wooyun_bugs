{"id": 52858, "wybug_id": "wooyun-2014-069885", "wybug_title": "PHPB2B 最新版sql注射无限充值（官网demo成功）", "wybug_corp": "phpb2b.com", "wybug_author": "roker", "wybug_date": "2014-07-27 23:52", "wybug_open_date": "2014-10-25 23:54", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-30：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-02：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-25：\t细节向公众公开  简要描述： rt 详细说明：  看到注册用户处\nif(isset($_POST['register'])){\t$is_company = false;\t$if_need_check = false;\t$register_type = trim($_POST['register']);\t$register_typename = trim($_POST['typename']);\tpb_submit_check('data');\t$default_membergroupid_res = $pdb->GetRow(\"SELECT * FROM {$tb_prefix}membertypes WHERE name='\".$register_typename.\"'\");\t$default_membergroupid = $default_membergroupid_res['default_membergroup_id'];\tif(empty($default_membergroupid)) $default_membergroupid = $membergroup->field(\"id\",\"is_default=1\");\tif ($default_membergroupid_res['id']>1) {\t\t$is_company = true;\t}\t$member->setParams();\t$memberfield->setParams();\t$member->params['data']['member']['membergroup_id'] = $default_membergroupid;\t$time_limits = $pdb->GetOne(\"SELECT default_live_time FROM {$tb_prefix}membergroups WHERE id={$default_membergroupid}\");\t$member->params['data']['member']['service_start_date'] = $time_stamp;\t$member->params['data']['member']['service_end_date'] = $membergroup->getServiceEndtime($time_limits);\t$member->params['data']['member']['membertype_id'] = ($is_company)?2:1;\tif($member_reg_auth==\"1\" || $member_reg_auth!=0 || !empty($G['setting']['new_userauth'])){\t\t$member->params['data']['member']['status'] = 0;\t\t$if_need_check = true;\t}else{\t\t$member->params['data']['member']['status'] = 1;\t}\t$updated = false;\t$updated = $member->Add();\n跟进add\nfunction Add()\t{\t\tglobal $_PB_CACHE, $memberfield, $phpb2b_auth_key, $if_need_check;\t\t$error_msg = array();\t\tif (empty($this->params['data']['member']['username']) or \t\tempty($this->params['data']['member']['userpass']) or \t\tempty($this->params['data']['member']['email'])) return false;\t\t$space_name = $this->params['data']['member']['username'];\t\t$userpass = $this->params['data']['member']['userpass'];\t\t$this->params['data']['member']['userpass'] = $this->authPasswd($this->params['data']['member']['userpass']);\t\tif(empty($this->params['data']['member']['space_name']))\t\t$this->params['data']['member']['space_name'] = PbController::toAlphabets($space_name);//Todo:\t\t$uip = pb_ip2long(pb_getenv('REMOTE_ADDR'));\t\tif(empty($uip)){\t\t\tpheader(\"location:\".URL.\"redirect.php?message=\".urlencode(L('sys_error')));\t\t}\t\t$this->params['data']['member']['last_login'] = $this->params['data']['member']['created'] = $this->params['data']['member']['modified'] = $this->timestamp;\t\t$this->params['data']['member']['last_ip'] = pb_get_client_ip('str');\t\t$email_exists = $this->checkUserExistsByEmail($this->params['data']['member']['email']);\t\tif ($email_exists) {\t\t\tflash(\"email_exists\", null, 0);\t\t}\t\t$if_exists = $this->checkUserExist($this->params['data']['member']['username']);\t\tif ($if_exists) {\t\t\tflash('member_has_exists', null, 0);\t\t}else{\t\t\t$this->save($this->params['data']['member']);\nsave 函数把我们的post数据 做了foreach \nfunction save($obj_name, $obj_id, $data)\t{\t\tif (empty($data)) {\t\t\treturn false;\t\t}\t\tforeach ($data as $key=>$val) {\t\t\tif (in_array($key, array('title', 'keyword', 'description'))) {\t\t\t\t$this->add($obj_id, $obj_name, $key, $val);\t\t\t}\n官网测试下我们注册用户时。抓包，添加参数\ndata%5Bmember%5D%5Bbalance_amount%5D=9999.99\n\n\n成功充值。。\n\n   漏洞证明：  \n\n   修复方案：  你们更加专业   版权声明：转载请注明来源 roker@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-07-30 19:45 厂商回复： 确认 最新状态： 2014-07-30：新版已修正该问题https://github.com/ulinke/phpb2b/archive/master.zip  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}