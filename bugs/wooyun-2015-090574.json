{"id": 44942, "wybug_id": "wooyun-2015-090574", "wybug_title": "RoundCube Webmail邮件最新版正文存储型XSS", "wybug_corp": "RoundCube Webmail", "wybug_author": "phith0n", "wybug_date": "2015-01-07 22:21", "wybug_open_date": "2015-04-13 16:58", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-01-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-01-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-01-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-03-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-04-13：\t细节向公众公开  简要描述： 首先声明，我这个洞交到360了通过了，奖金500？侮辱我吗。作为重复漏洞乌云可以不给我通用奖励，所以大家也别说我一洞多投，我不是为了奖励来的。我问了那边，那边说交了的漏洞不能拒绝，我只好直接发过来了。我只是想体现他的价值。RoundCube Webmail是国外用的较广的一款开源php邮件系统，意义还是挺大的。 详细说明：  roundcube webmail官网：http://roundcube.net/，下载最新版本。/program/lib/Roundcube/rcube_washtml.php ，这文件实际上是一个富文本过滤类class rcube_washtml。roundcube就是利用这个类对富文本进行过滤。先大概看一下，我知道了这个类的特点：1.用DOM对换入的HTML做解析，取出所有标签、相应属性的键和值。2.利用白名单，只保留允许存在的标签和属性。3.根据保留下来的标签、属性键和值，拼接成过滤后的HTML，输出。实际上，从这个过程中我就看到了安全隐患。我曾经自己写过一个富文本类，类的前两点过程和这个类相同，但第三点，我是将结果同样保存为DOM对象，再转换成HTML进行输出。二者有什么差别？很大一点不同就是，roundcube对HTML进行拼接，拼接的过程中如果处理不好引号，很容易导致属性“值”越出引号范围，变成一个新的“属性”，比如onerror。好，我们看到246行，\nelse if ($key == 'style' && ($style = $this->wash_style($value))) {                $quot = strpos($style, '\"') !== false ? \"'\" : '\"';                $t .= ' style=' . $quot . $style . $quot;            }\n当属性名是style的话，就将值传入wash_style函数。这个函数顾名思义是过滤css用的，然后将返回值$style拼接到最终HTML里：$t .= ' style=' . $quot . $style . $quot;$quote就是一个引号，将$style 放入引号。这个$quote是前一句话定义的，当$style中有单引号的时候，$quote就是双引号，当$style中有双引号的时候，$quote就是单引号。但如果$style中两种引号都有呢？肯定是会导致引号被闭合的情况，那么后面就能够写其他属性了。后面还有一些麻烦的分析我就不写了，最后我的payload是：\n<img src=\"data:xxx1\" style=aaa:'\"/onerror=alert(1)//' >\n我们看到，style中间有单引号和双引号，因为都存在，所以选择单引号作为外部的闭合引号。而因为我内部也有单引号，所以将前面的单引号闭合了，导致后面的内容溢出，onerror成为一个新的属性，最后导致存储型XSS。经过该类处理过的HTML变成这样，chrome最新版下直接触发无需交互\n<!-- html ignored --><!-- body ignored --><img src=\"data:xxx1\" style='aaa: '\\\"/onerror=alert(1)//'' />\n测试，直接发送正文含有以上POC的邮件，roundcube打开邮件即可触发：\n\n   漏洞证明：  \n\n   修复方案：  不知道。   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2015-01-12 11:41 厂商回复： CNVD确认所述漏洞情况，暂未建立与软件生产厂商的直接处置渠道，待认领。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-01-07 22:23 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  精彩    \n     2015-01-07 22:23 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  mark顶师傅    \n     2015-01-07 22:24 |    \t\t天地不仁 以万物为刍狗 \t\t\t( 普通白帽子  |\t\t\t        Rank:977 漏洞数:264        | 天地本不仁 万物为刍狗)\t\t \n  我就说在哪见过  前排    \n     2015-01-07 22:26 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  难怪你在微博上说挖到一个国际0day    \n     2015-01-07 22:28 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3224 漏洞数:254        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  RoundCube 国外重量级用户特别多    \n     2015-01-07 22:31 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  投exploit-db    \n     2015-01-07 22:35 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  我在谷歌搜了一下 国内用户不是太多啊，大部分都是国外的啊，360那边价格貌似可以协商的啊。大牛何必动气呢    \n     2015-01-07 22:39 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  这邮箱貌似某平台，众测项目奖金50W，不过不知道说的是rmb还是云豆。。    \n     2015-01-07 22:43 |    \t\tonpu \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:19        | 静坐常思己过，闲谈莫论人非)\t\t \n  精彩    \n     2015-01-07 22:47 |    \t\tYang \t\t\t( 普通白帽子  |\t\t\t        Rank:247 漏洞数:86        | 作为菜鸟，大米手机摔破了怎么办？)\t\t \n  国际通用呀。！！    \n     2015-01-07 22:49 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  webmail记得搞不定帐号啊，你的帐号咋来的    \n     2015-01-07 22:54 |    \t\t南宁网警Mx \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:5        | 我是独行侠。有心交友qq1552673833)\t\t \n  众测项目奖金50W    \n     2015-01-07 23:03 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @南宁网警Mx @px1624 知道，但众测我不感兴趣。    \n     2015-01-07 23:06 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @phith0n 那个别太认真，目测说的是云豆。哈哈    \n     2015-01-07 23:07 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @phith0n 话说你帐号怎么来的    \n     2015-01-07 23:09 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @px1624 我注册的一个虚拟主机da面板送了一个邮箱    \n     2015-01-07 23:12 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  @phith0n 额。。。难怪，我们一直没法测试，就是因为没有测试帐号。。。    \n     2015-01-08 03:22 |    \t\t蓝莓说 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 爱网络安全 代码审计 php网站开发)\t\t \n  @phith0n  大牛求审计国外CodeIgniter框架    \n     2015-01-08 06:39 |    \t\tPower \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:22        | 还需要等待.........)\t\t \n  关注    \n     2015-01-08 09:25 |    \t\t盛大网络(乌云厂商)\t\t \n  这个在那个众测还是低危 500￥    \n     2015-01-08 12:08 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  nice    \n     2015-01-12 12:04 |    \t\tWoodee \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云路人甲，打脸pa pa pa)\t\t \n  这个厉害！    \n     2015-08-25 17:40 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  思路很赞,能绕过很多程序的 \"属性\"on iframe script 基本没戏了svg img html5 vectors还有机会    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}