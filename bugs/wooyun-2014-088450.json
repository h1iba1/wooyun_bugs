{"id": 45351, "wybug_id": "wooyun-2014-088450", "wybug_title": "phpyun v3.2 (20141222) 前台二次注入(直接出管理密码 demo测试)", "wybug_corp": "php云人才系统", "wybug_author": "′雨。", "wybug_date": "2014-12-25 15:26", "wybug_open_date": "2015-03-25 15:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-25：\t细节向公众公开  简要描述： 非盲注。 直接出管理的各种数据。依旧demo测试。 详细说明：  在ask/model/index.class.php中\nfunction attention_action()\t{ \t\t$this->is_login();//需要登录会员\t\t$is_set=$this->obj->DB_select_once(\"attention\",\"`uid`='\".$this->uid.\"' and `type`='\".(int)$_POST['type'].\"'\");//这里让type为1\t\t\tif($_POST['type']=='1')\t\t{\t\t\t$info=$this->obj->DB_select_once(\"question\",\"`id`='\".(int)$_POST['id'].\"'\",\"`id`,`title`,`uid`\");\t\t\t$gourl= $this->aurl(array(\"url\"=>\"c:content,id:\".$info['id']));\t\t\t$content=\"关注了<a href=\\\"\".$gourl.\"\\\" target=\\\"_blank\\\">《\".$info['title'].\"》</a>。\";\t\t\t$n_contemt=\"取消了对<a href=\\\"\".$gourl.\"\\\" target=\\\"_blank\\\">《\".$info['title'].\"》</a>的关注。\";\t\t\t$log=\"关注了《\".$info['title'].\"》\";\t\t\t$n_log=\"取消了对《\".$info['title'].\"》\";\t\t}else{\t\t\t$info=$this->obj->DB_select_once(\"q_class\",\"`id`='\".$_POST['id'].\"'\",\"`id`,`name`\");\t\t\t$gourl= $this->aurl(array(\"url\"=>\"c:getclass,id:\".$info['id']));\t\t\t$content=\"关注了<a href=\\\"\".$gourl.\"\\\" target=\\\"_blank\\\">\".$info['name'].\"</a>。\";\t\t\t$n_contemt=\"取消了<a href=\\\"\".$gourl.\"\\\" target=\\\"_blank\\\">\".$info['name'].\"</a>的关注。\";\t\t\t$log=\"关注了\".$info['name'];\t\t\t$n_log=\"取消了对\".$info['name'].\"</a>的关注。\";\t\t}\t\t\tif($info['uid']==$this->uid){\t\t\techo '4';\t\t}else if(is_array($is_set)){ //这里一开始$is_set为空所以不会进入这里 当第二次进入的时候 就是数组了 就会进这里面了所以这个洞 我们一个帐号用一次。\t\t\t$ids=@explode(',',$is_set['ids']);\t\t\tif(in_array($_POST['id'],$ids))\t\t\t{\t\t\t\tif($_POST['type']=='1')\t\t\t\t{\t\t\t\t\techo '2';\t\t\t\t}else{\t\t\t\t\tforeach($ids as $k=>$v )\t\t\t\t\t{\t\t\t\t\t\tif($v!=$_POST['id'])\t\t\t\t\t\t{\t\t\t\t\t\t\t$i_ids[]=$v;\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t\tif($i_ids)\t\t\t\t\t{\t\t\t\t\t\t$n_id=$this->obj->update_once(\"attention\",array(\"ids\"=>@implode(',',$i_ids)),array(\"id\"=>$is_set['id']));\t\t\t\t\t}else{\t\t\t\t\t\t$n_id=$this->obj->DB_delete_all(\"attention\",\"`id`='\".$is_set['id'].\"'\");\t\t\t\t\t}\t\t\t\t\tif($n_id)\t\t\t\t\t{\t\t\t\t\t\t$data['uid']=$this->uid;\t\t\t\t\t\t$data['content']=$n_contemt;\t\t\t\t\t\t$data['ctime']=time();\t\t\t\t\t\t$this->obj->insert_into(\"friend_state\",$data);\t\t\t\t\t\t$this->obj->member_log($n_log);\t\t\t\t\t\techo '3';\t\t\t\t\t}\t\t\t\t}\t\t\t}else{//当不为数组的时候 就是一开始为空的时候\t\t\t\t$i_ids=$is_set['ids'].','.$_POST['id'];//这里拼接了$_POST['id]  所以也算部分可控了。\t\t\t\t\t\t$n_id=$this->obj->update_once(\"attention\",array(\"ids\"=>$i_ids),array(\"id\"=>$is_set['id']));//带入到update中入库\t\t\t\tif($n_id)\n\nfunction attenquestion_action()\t{\t\tif($this->uid=='')\t\t{\t\t\t$this->obj->ACT_msg($_SERVER['HTTP_REFERER'],\"请先登录！\");\t\t}\t\t\t$this->public_action();\t\t$ids=$this->obj->DB_select_once(\"attention\",\"`uid`='\".$this->uid.\"' and `type`='1'\",\"`ids`\");//这里出库\t\t$ids=rtrim($ids['ids'],',');//对刚才入库的 赋值给$ids\t\t\t$pageurl=$this->aurl(array(\"url\"=>\"c:\".$_GET['c'].\",page:{{page}}\"));\t\t$question=$this->get_page(\"question\",\"`id` in (\".$ids.\")  order by `add_time` desc\",$pageurl,\"10\");//没有单引号\t\tif(!empty($question))\t\t{\t\t\tforeach($question as $k=>$v)\t\t\t{\t\t\t\t$uid[]=$v['uid'];\t\t\t}\t\t\t$uids=implode(',',$uid);\t\t\t$friend_info=$this->obj->DB_select_all(\"friend_info\",\"`uid` in (\".$uids.\")\",\"`uid`,`pic`\");\t\t\tforeach($question as $key=>$val)\t\t\t{\t\t\t\tforeach($friend_info as $k=>$v)\t\t\t\t{\t\t\t\t\tif($val['uid']==$v['uid'])\t\t\t\t\t{\t\t\t\t\t\tif($val['uid']==$v['uid'])\t\t\t\t\t\t{\t\t\t\t\t\t\tif($v['pic'])\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t$question[$key]['pic']=$v['pic'];\t\t\t\t\t\t\t}else{\t\t\t\t\t\t\t\t$question[$key]['pic']=$this->config['sy_weburl'].'/'.$this->config['sy_friend_icon'];\t\t\t\t\t\t\t}\t\t\t\t\t\t}\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t}\t\t$this->yunset(\"question\",$question); //这里直接把数据显示出来\n\nif($config['sy_istemplate']!='1' || md5(md5($config['sy_safekey']).$_GET['m'])!=$_POST['safekey']){   \tforeach($_POST  as $id=>$v){\t\t\t\t$str = html_entity_decode($v,ENT_QUOTES,\"GB2312\");\t\t\t\t$v = common_htmlspecialchars($id,$v,$str,$config);\t\t\t\tsafesql($id,$v,\"POST\",$config);\t\t\t\t$id = sfkeyword($id,$config);\t\t$v = sfkeyword($v,$config);\t\t$_POST[$id] = $v;\t}}\n继续bypass这个 http://www.hr135.com/company/index.php?m=index&c=index&id=3751&style=../../template/admin&tp=/admin_web_config拿到key 经过计算 继续bypass过滤。\n\n这里需要请求两次。然后访问 web/web/phpyun32/ask/index.php?m=index&c=attenquestion\n\n直接出数据。  这里我再测试一下demo。我这里惊人的发现。。 demo有安全狗 我擦 绕过了全局的注入 竟然没过安全狗懒得去研究安全狗了 直接输出一个 hello phpyun\n\n然后继续 \n\n成功出数据。   漏洞证明：  \n\n   修复方案：  无尽的过滤。     版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-12-25 15:48 厂商回复： 感谢提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-25 15:29 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  雨牛 厉害！    \n     2014-12-25 15:52 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @玉林嘎 么么哒 响应好快啊。    \n     2014-12-25 15:54 |    \t\tbacktrack丶yao \t\t\t( 普通白帽子  |\t\t\t        Rank:290 漏洞数:107        | \"><img src=x onerror=alert(666666);> <im...)\t\t \n   三个！    \n     2014-12-25 16:44 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  其他两个比较鸡肋啊 奏小厂商了 刚才看了看     \n     2014-12-25 16:58 |    \t\t′雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @menmen519   都不算鸡肋吧 没啥限制条件 只是发太多了  就小厂商拉，   还有几个没审核    \n     2014-12-25 17:16 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @′雨。 @menmen519 挖洞专业户，挖一堆是来刷屏的吧o(╯□╰)o    \n     2015-03-25 17:11 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  @′雨。 应该快到核心白帽子了吧。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}