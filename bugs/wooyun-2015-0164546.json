{"id": 76585, "wybug_id": "wooyun-2015-0164546", "wybug_title": "ThinkSAAS最新版2.4 Xss漏洞 指谁打谁", "wybug_corp": "thinksaas.cn", "wybug_author": "麦兜", "wybug_date": "2015-12-28 16:39", "wybug_open_date": "2016-02-09 23:29", "wybug_type": "XSS 跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-12-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-12-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-07：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-01-17：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-27：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-02-09：\t细节向公众公开  简要描述： thinksaas2.4+php2.6+apache2 未过滤感谢@xfkxfk 详细说明：  先看消息写入代码：/var/www/html/thinksaas/app/user/action/message.php\ncase \"do\":\t\t\t$msg_userid = $userid;\t\t$msg_touserid = intval($_POST['touserid']);\t\t$msg_content = tsFilter($_POST['content']); //用tsFilter过滤\t\t\t\taac('system')->antiWord($msg_content); //过滤垃圾词\t\t\t\taac('message')->sendmsg($msg_userid,$msg_touserid,$msg_content);               /×\t//发送消息\tpublic function sendmsg($userid,$touserid,$content){\t\t\t$userid = intval($userid);\t\t\t\t$touserid = intval($touserid);\t\t\t\t$content = str_replace(SITE_URL,'[SITE_URL]',$content);\t\t\t\t$content = addslashes(trim($content));\t\t\t\tif($touserid && $content){\t\t\t\t\t$messageid = $this->create('message',array(\t\t\t\t'userid'\t\t=> $userid,\t\t\t\t'touserid'\t\t=> $touserid,\t\t\t\t'content'\t\t=> $content,\t\t\t\t'addtime'\t\t\t=> time(),\t\t\t));\t\t\t\t\t}\t}\t\t}×/\t\theader(\"Location: \".tsUrl('message','my'));\t\t\t\tbreak;}\n/var/www/html/thinksaas/thinksaas/tsFunction.php\nfunction tsFilter($value) {\t$value = trim($value);\t//定义不允许提交的SQl命令和关键字\t$words = array();\t$words[] = \"add \";\t$words[] = \"and \";\t$words[] = \"count \";\t$words[] = \"order \";\t$words[] = \"table \";\t$words[] = \"by \";\t$words[] = \"create \";\t$words[] = \"delete \";\t$words[] = \"drop \";\t$words[] = \"from \";\t$words[] = \"grant \";\t$words[] = \"insert \";\t$words[] = \"select \";\t$words[] = \"truncate \";\t$words[] = \"update \";\t$words[] = \"use \";\t$words[] = \"--\";\t$words[] = \"#\";\t$words[] = \"group_concat\";\t$words[] = \"column_name\";\t$words[] = \"information_schema.columns\";\t$words[] = \"table_schema\";\t$words[] = \"union \";\t$words[] = \"where \";\t$words[] = \"alert\";\t$value = strtolower($value);\t//转换为小写\tforeach ($words as $word) {\t\tif (strstr($value, $word)) {\t\t\t$value = str_replace($word, '', $value);\t\t}\t}\treturn $value;}\n可以看到只过滤了一些sql注入关键字，问题是仅仅过滤了一遍。继续来看取出有没有过滤/var/www/html/thinksaas/app/message/action/my.php\n<?phpdefined('IN_TS') or die('Access Denied.');$arrMsg = $new['message']->findAll('message',array(\t'touserid'=>$strUser['userid'],\t'isread'=>'0',));foreach($arrMsg as $key=>$item){  //可以看到没编码也没过滤\t$arrMsg[$key]['content'] = str_replace('[SITE_URL]',SITE_URL,$item['content']);\tif($item['userid']){\t\t$arrMsg[$key]['user'] = aac('user')->getOneUser($item['userid']);\t}}$title = '我的消息盒子';include template(\"my\");\n   漏洞证明：  \n\n\n\n\n\n\n\n   修复方案：  编码过滤   版权声明：转载请注明来源 麦兜@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-12-28 23:03 厂商回复： 感谢反馈，已经修复。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}