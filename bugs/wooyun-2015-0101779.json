{"id": 36471, "wybug_id": "wooyun-2015-0101779", "wybug_title": "ThinkSAAS 前台SQL注入（通杀所有版本？？？）", "wybug_corp": "thinksaas.cn", "wybug_author": "胡小树", "wybug_date": "2015-03-17 16:43", "wybug_open_date": "2015-06-20 16:45", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-22：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-05：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-20：\t细节向公众公开  简要描述： 这几天一直在审计thinksaas，几个版本都看过，有个地方感觉有注入一直搞不定。在此感谢 @狗狗侠 @牛肉包子 两位大牛的指点 详细说明：  看最新版的，16天前更新的。app/group/action/do.php看下回复评论出的代码\ncase \"recomment\":\t\t\tif($_POST['token'] != $_SESSION['token']) {\t\t\techo 1;exit;\t\t}\t\t\t\t$referid = intval($_POST['referid']);\t\t$topicid = intval($_POST['topicid']);\t\t$content = tsClean($_POST['content']);\t\t$addtime = time();       // var_dump($content);\t\t$db->query(\"insert into \".dbprefix.\"group_topic_comment (`referid`,`topicid`,`userid`,`content`,`addtime`) values ('$referid','$topicid','$userid','$content','$addtime')\");\nContent  post获取，然后通过tsclean函数过滤，然后直接带入sql语句，跟踪下函数tsclean/thinksaas/thinksaas/tsFuction.phpfunction tsClean($text) {//var_dump($text);\t$text = stripslashes(trim($text));\t//去除前后空格，并去除反斜杠\t//$text = br2nl($text); //将br转换成/n\t///////XSS start\trequire_once 'thinksaas/xsshtml.class.php';\t$xss = new XssHtml($text);\t$text = $xss -> getHtml();\t//var_dump($text);\t//$text = substr ($text, 4);//去除左边<p>标签\t//$text = substr ($text, 0,-5);//去除右边</p>标签\t///////XSS end\t//$text = html_entity_decode($text,ENT_NOQUOTES,\"utf-8\");//把 HTML 实体转换为字符\t//$text = strip_tags($text); //去掉HTML及PHP标记\t//$text = cleanJs ( $text );\t$text = htmlentities($text, ENT_NOQUOTES, \"utf-8\");\t//把字符转换为 HTML 实体\treturn $text;}Stripslashes  反斜线将被去除，本地测试 了下输出，\n\nContent内容换行了，虽然单引号没有转义，但是很麻烦。蛋疼看下为啥换行了/thinksaas/thinksaas/xsshtml.class.php\n/**     * 获得过滤后的内容     */\tpublic function getHtml()\t{\t\tif (!$this->m_ok) {\t\t\treturn '';\t\t}\t\t$nodeList = $this->m_dom->getElementsByTagName('*');\t\tfor ($i = 0; $i < $nodeList->length; $i++){\t\t\t$node = $nodeList->item($i);\t\t\t//var_dump($this);\t\t\tif (in_array($node->nodeName, $this->m_AllowTag)) {\t\t\t\tif (method_exists($this, \"__node_{$node->nodeName}\")) {\t\t\t\t\tcall_user_func(array($this, \"__node_{$node->nodeName}\"), $node);\t\t\t\t}else{\t\t\t\t\tcall_user_func(array($this, '__node_default'), $node);\t\t\t\t}\t\t\t}\t\t}\t\t//var_dump($this->m_xss);\t    //var_dump($this->m_dom->saveHTML());\t\treturn strip_tags($this->m_dom->saveHTML(), '<' . implode('><', $this->m_AllowTag) . '>');\t}\n自己调试了 下过滤流程，引入了换行\n\n下面请看大牛给出的语句。insert into ts_group_topic_comment (`referid`,`topicid`,`userid`,`content`,`addtime`) values ('33','5','2','&lt;p&gt;123'or updatexml(1,concat(0x7e,(user())),0) or ' --&lt;/p&gt;','1426494649')再科普一下http://drops.wooyun.org/tips/2078这个地方讲的很详细   漏洞证明：  执行下sql试试\n\n虽然执行成功了，但是没回显啊。 有个好东西，错误日志，嘿嘿。错误日志的格式是 年月日-mysql-error.txtthinksaas\\tslogs\\20150316-mysql-error.txt\n\n看下其他的版本，官网的ThinkSAAS 2.3 2014-12-22 11:33:58 更新的好像也有这个问题啊\n\n再测试下官网吧。官网用的是mysqli连接方式那..http://www.thinksaas.cn/tslogs/20150316-mysqli-error.txt好吧，本地也搭建一个mysqli方式的\n\n本地测试也是成功的。。看下官网。单引号报错了。\n\n但是爆数据的时候，卡主了，我擦，\n\n官网提交回复直接卡主了，一直转圈圈。官网装waf之类设备了？还是代码不一样啊，我去。。。好吧，我承认我是 彩笔   修复方案：     版权声明：转载请注明来源 胡小树@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2015-06-20 16:45 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-06-07 20:24 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        | 学姿势，学思路。)\t\t \n  呵呵。    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}