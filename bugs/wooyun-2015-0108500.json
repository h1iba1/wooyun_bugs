{"id": 15901, "wybug_id": "wooyun-2015-0108500", "wybug_title": "逆向分析苏宁易购安卓客户端加密到解密获取明文密码（附demo验证）", "wybug_corp": "江苏苏宁易购电子商务有限公司", "wybug_author": "Nicky", "wybug_date": "2015-04-17 18:43", "wybug_open_date": "2015-07-18 16:14", "wybug_type": "用户敏感数据泄漏", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["手机软件安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-22：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-06-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-18：\t细节向公众公开  简要描述： 苏宁易购安卓客户端使用了有缺陷的加密方式，经过逆向分析后搞定了其加密解密方法，能成功读取用户明文用户名与密码，可导致用户帐号被盗。 详细说明：  第一次花这么长时间测一个漏洞（主要时间都花在写demo上了。。。），求加精1.苏宁易购Android最新版客户端使用的是通过本地xml文件和db方式存储用户登录凭证的。（1）/data/data/com.suning.mobile.ebuy/shared_prefs/EbuyPerferences.xml其中的  <string name=“logonAccount”>xxxx</string><string name=“logonPassword\">xxxxxxxxxxxxx（16位密文）</string>分别保存了用户的明文用户名与加密过后的密码\n\n(2)/data/data/com.suning.mobile.ebuy/databases/SUNINGEBUY.DB中的table_login_history表同样保存着明文的username与加密过后的password\n\n2.在正常情况下这样保存用户凭证问题不大，因为就算木马（读取应用私有文件需ROOT权限）获取了相关文件也不知道用户密码是多少。但经过分析，由于设计缺陷，用户密码可被逆向分析进行解密。（1）使用JEB反编绎其APK安装包，以logonPassword为关键词进行初步查找，分析其调用的加/解密方法；（2）当跟踪到package com.suning.mobile.ebuy.login.login.ui;下的类p(被混淆过的类名)时，发现调用了如下方法：\n\n看包名这应该是个和登录相关的方法，先是通过getPreferencesVal方法读取了xml文件中的logonPassword值赋值给v2,然后通过getPreferencesPassword(v1, v2)来解密出明文密码进行登录，其中的v1是通过getTop5LoginHistory()方法取了登录历史中最后一次登录的用户名。（3）继续分析getPreferencesPassword方法：\n\n这里直接将传入的两个参数（明文用户名，加密后的密码）传递到了PBECoder类的decrypty方法，然后返回一个字符串值，看这个名字就能猜到是用来解密的~（4）继续跟踪分析PBECoder类decrypty方法：\n\n调用了decrypt方法，这里decrypt方法传入的三个参数值的第一参数值是PBECoder.hex2byte(arg3)是指将传入arg3(加密后的密码)从hex转换成了byte值，arg2为明文用户名，PBECoder.salt为salt值。继续跟踪调用的decrypt方法\n\n发现这里用的是PBE算法加密，PBE——Password-based encryption（基于密码加密）。其特点在于口令由用户自己掌管，不借助任何物理媒体；采用随机数（这里我们叫做盐）杂凑多重加密等方法保证数据的安全性。如上就混杂了MD5与DES加密，是一种简便的加密方式。看着很安全？（5）继续分析发现此其salt取值方法是直接设置为sn201209：    static {        PBECoder.salt = \"sn201209\".getBytes();    }而正确的生成salt的方法是取随机值： public static byte[] initSalt() throws Exception {          byte[] salt = new byte[8];          Random random = new Random();          random.nextBytes(salt);          return salt;      }  这样产生了一个问题，我们能获取解密要用的用户名与加密后的密码又逆向出来了salt值与其解密方法，我们完全可以自己写个相同的解密方法。最后。。。经过三天的编写。。。demo终于出炉了（第一次写完整的android应用，改了多少报错就不说了。。。）   漏洞证明：  demo下载地址：链接: http://pan.baidu.com/s/1hq08FJY 密码: 27kcdemo使用方法：1.用户只要是登录过了苏宁易购安卓客户端且没退出登录就行2.需要ROOT权限（就是读个xml文件无其它操作）3.点击解密就能获取当前登录的用户的苏宁易购明文用户名与密码\n\n漏洞利用：用户手机中了木马，木马可以继续获取ROOT权限并盗得明文帐号密码   修复方案：  使用随机生成的salt   版权声明：转载请注明来源 Nicky@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-04-19 16:13 厂商回复： 感谢提交，移动客户端问题较多，一并处理，谢谢。 最新状态： 2015-05-27：稍后送上苏宁易购1000元礼品卡  ", "replys": "漏洞评价：\n评论\n     2015-04-17 18:44 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  漂漂    \n     2015-04-17 18:52 |    \t\tBMa \t\t\t( 普通白帽子  |\t\t\t        Rank:1776 漏洞数:200        )\t\t \n  我的膝盖都碎了 @Nicky 都不带我装逼，带我飞    \n     2015-04-17 19:35 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  @Nicky  好熟悉的id    \n     2015-04-17 19:39 |    \t\tTaro \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:48        | 走向最远的方向，哪怕前路迷茫；抱着最大的...)\t\t \n  求手下膝盖    \n     2015-04-17 20:32 |    \t\tizy \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:22        | http://1zy.pw/)\t\t \n  nice    \n     2015-04-17 20:46 |    \t\tNicky \t\t\t( 普通白帽子  |\t\t\t        Rank:477 漏洞数:69        | http://www.droidsec.cn 安卓安全中文站)\t\t \n  @疯狗 来个闪电呗    \n     2015-04-17 21:30 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  加解密/签名的文章快写完了.    \n     2015-04-17 22:00 |    \t\tNicky \t\t\t( 普通白帽子  |\t\t\t        Rank:477 漏洞数:69        | http://www.droidsec.cn 安卓安全中文站)\t\t \n  @瘦蛟舞 哈哈 期待    \n     2015-04-17 22:34 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  今天刚被苏宁卖东西的大叔大妈气到了。。    \n     2015-04-19 16:40 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:71        | I'm Me_Fortune)\t\t \n  6666666666666    \n     2015-04-20 09:27 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  看到二哥的评论，我估计苏宁要倒霉了    \n     2015-04-22 23:20 |    \t\tMr.R \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:14        | 求大神带我飞 qq2584110147)\t\t \n  好叼    \n     2015-07-03 17:13 |    \t\t冰海 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:7        | I can do better , why not ?)\t\t \n  稍后送上苏宁易购1000元礼品卡    \n     2015-07-12 21:21 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:30        | Wow~~~哈哈~~~)\t\t \n  点赞    \n     2015-07-18 19:48 |    \t\thack2012 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:3        | 关注信息安全 http://www.waitalone.cn/)\t\t \n  不错。。。    \n     2015-07-20 00:15 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @瘦蛟舞 @Nicky app其实根本没必要存 账号密码，还有对于中木马的话已经不是账号密码的问题了    \n     2015-07-20 11:39 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @小胖胖要减肥 要看本质~ 必然会存用户凭证来简化登录操作~不管是 session 还是帐号密码. 还有前端问题大多在触发上显得比后端鸡肋~    \n     2015-07-20 23:42 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @瘦蛟舞 app的登陆凭证可以根据多种算法计算，传输数据拦截可以让他没有意义，如果说到木马就没意思了，数据安全这块做到破解app也不能破解拦截到的传输加密就行了吧    \n     2015-07-21 08:25 |    \t\t小荷才露尖尖角 \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:13        | less is more)\t\t \n  赞深入分析    \n     2015-07-21 10:28 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @Nicky 骚年去大公司上班都不说话了呀.出来冒冒泡,哈哈    \n     2015-07-21 10:32 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @小胖胖要减肥 此漏洞不光你说的\"木马\",还需要 root,只看这两个利用条件漏洞就十分鸡肋~    \n     2015-07-21 12:10 |    \t\tNicky \t\t\t( 普通白帽子  |\t\t\t        Rank:477 漏洞数:69        | http://www.droidsec.cn 安卓安全中文站)\t\t \n  @瘦蛟舞 哈哈 这漏洞考虑利用条件确实鸡肋，但在目前移动客户端上可远程利用的高危太少了。。。    \n     2015-07-21 12:53 |    \t\tMe_Fortune \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:71        | I'm Me_Fortune)\t\t \n  @瘦蛟舞 大牛去哪了 - -    \n     2015-07-21 15:11 |    \t\t瘦蛟舞  \t\t\t( 普通白帽子  |\t\t\t        Rank:687 漏洞数:78        | 铁甲依然在)\t\t \n  @Me_Fortune 额,创业团队额. 有兴趣可以私聊    \n     2015-07-21 18:30 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  @Nicky 确实  20分 hah  移动安全对于甲方来说现在很多都比较鸡肋，除了一些大洞，服务端漏洞接口设计都能避免    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}