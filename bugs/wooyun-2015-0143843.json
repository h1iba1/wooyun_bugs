{"id": 84656, "wybug_id": "wooyun-2015-0143843", "wybug_title": "kppw最新版一处函数五处注入", "wybug_corp": "keke.com", "wybug_author": "路人甲", "wybug_date": "2015-10-07 09:26", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-14：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： SQL 详细说明：  问题函数在 \\lib\\sys\\keke_task_release_class.phpfilerPic函数具体代码如下：\npublic function filerPic($file_ids){\t\tglobal $_K;\t\tif($file_ids){\t\t\t$exts = array('gif','jpg','jpeg','png');\t\t\t$info = db_factory::query(' select file_name,save_name from '.TABLEPRE.'witkey_file where file_id in ('.$file_ids.')');\t\t\t$pic  = array();\t\t\tforeach($info as $v){\t\t\t\t$t = explode('.',$v['file_name']);\t\t\t\t$ext = strtolower($t[sizeof($t)-1]);\t\t\t\tif(in_array($ext,$exts)){\t\t\t\t\t$pic[] = $_K['siteurl'].'/'.$v['save_name'];\t\t\t\t}\t\t\t}\t\t\treturn implode(',',$pic);\t\t}else{\t\t\treturn NULL;\t\t}\t}\n\n$info = db_factory::query(' select file_name,save_name from '.TABLEPRE.'witkey_file where file_id in ('.$file_ids.')');\n此处$file_ids无单引号保护，无过滤，向上跟踪。\n\n来到lib\\sys\\keke_task_release_class.php 的public_pubtask函数。部分代码如下：\npublic function public_pubtask() {\t    $this->submit_check ();\t\t$std_obj = $this->_std_obj; \t\t$release_info = $std_obj->_release_info; \t\t$task_obj = $this->_task_obj; \t\t$user_info = $this->_user_info;\t\t$task_obj->setModel_id ( $this->_model_id );\t\t$task_obj->setIndus_id ( $release_info ['indus_id'] );\t\t$task_obj->setIndus_pid ( $release_info ['indus_pid'] );\t\t$task_obj->setProvince ( $release_info ['province'] );\t\t$task_obj->setCity ( $release_info ['city'] );\t\t$task_obj->setArea ( $release_info ['area'] );\t\t$task_obj->setTask_title ( kekezu::str_filter ( kekezu::escape($release_info ['txt_title']) ) );\t\t$task_obj->setTask_desc  ( kekezu::str_filter ( kekezu::escape($release_info ['tar_content'] ) ) ); \t\t$strFileIds = implode ( ',', array_filter ( explode ( '|', $release_info ['file_ids'] ) ) );\t\t$task_obj->setTask_file ( $strFileIds );\t\t$task_obj->setTask_pic($this->filerPic($strFileIds));\t\t$task_obj->setContact ( $release_info['txt_mobile'] );\t\t$task_obj->setProfit_rate ( $this->_task_config ['task_rate'] );\t\t$task_obj->setTask_fail_rate ( $this->_task_config ['task_fail_rate'] );\t\t$task_obj->setTask_cash ( $release_info ['txt_task_cash']); \t\t$task_obj->setReal_cash ( $release_info ['txt_task_cash'] * (100 - $this->_task_config ['task_rate']) / 100); \t\t$task_obj->setStart_time ( time () ); \t\t$time_arr = getdate ();\n可以看到代入filterPic函数的变量：\n$strFileIds = implode ( ',', array_filter ( explode ( '|', $release_info ['file_ids'] ) ) );\t\t$task_obj->setTask_file ( $strFileIds );\t\t$task_obj->setTask_pic($this->filerPic($strFileIds));\n简单的进行了字符串拆分和组合成数组然后将数组连接为字符串。并无判断和过滤。接下来进一步跟踪看$release_info形成时有无过滤。\n\n有五处引用public_pubtask()选取第一处进行跟踪来到 task\\dtender\\lib\\dtender_release_class.php   pub_task()函数再继续跟进最终引用地为  task\\dtender\\control\\pub.php具体代码如下：\ncase 'step3':\t\t$intFileCount = 0;\t\tif($arrPubInfo['file_ids']){\t\t\t$intFileCount = count(explode('|',$arrPubInfo['file_ids']));;\t\t}\t\tif (isset($formhash)&&kekezu::submitcheck($formhash)) {\t\t\t$arrPayitems = array(\t\t\t\t\t'urgent'=>intval($txt_urgent),\t\t\t\t\t'tasktop'=>intval($txt_tasktop)&&intval($text_tasktop) ?intval($text_tasktop):0,\t\t\t\t\t'workhide'=>intval($txt_workhide),\t\t\t\t\t'seohide'=>intval($txt_seohide),\t\t\t);\t\t\t$arrPayitems = array_filter($arrPayitems);\t\t\tPayitemClass::validPayitemCount($arrPayitems, $arrPubInfo['txt_task_day']);\t\t\t$_POST['payitem'] = $arrPayitems;\t\t\t$arrPubInfo and $_POST = array_merge ( $arrPubInfo, $_POST );\t\t\t$objRelease->save_task_obj ( $_POST, $stdCacheName ); \t\t\t$intTaskId = $objRelease->pub_task (); \t\t\t$objRelease->update_task_info ( $intTaskId, $stdCacheName ); \t\t\tkekezu::show_msg($tips,$strUrl.'&step=step4&taskId='.$intTaskId,NULL,NULL,'ok');\t\t}else{\t\t\t!$_SESSION[$stdCacheName] and kekezu::show_msg($_lang ['friendly_notice'],\"index.php?do=pubtask&id=$id\",2,\"任务已提交，不可再返回修改！\",\"warning\");\t\t\t$objRelease->check_access($step, $id, $arrPubInfo);\t\t\t$strTarComment = htmlspecialchars_decode($arrPubInfo['tar_content']);\t\t\t$strCommentLen = strlen($strTarComment);\t\t\tif($strCommentLen > 1000 ){\t\t\t\t$strPartComment = kekezu::cutstr($strTarComment,1000);\t\t\t}\t\t}\t\tbreak;\n并没有对fileids做特别过滤处理因为生成fileids在step2，并且并没有严格的判断。来实际操作演示一下，首先登录，选择发布任务\n\n到step2提交的时候抓包，如果上传了附件则会产生fileids,此处直接替换成我们要注入的脚本\n\n因为函数是在step3提交时调用。所以直接step3提交，\n\n成功注入盲注语句延时。其余四处原理一样，就不一一演示了。   漏洞证明：  如上。   修复方案：  同在武汉，求请吃饭   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-10-11 16:20 厂商回复： 感谢您的关注和支持，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}