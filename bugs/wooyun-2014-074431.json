{"id": 1595, "wybug_id": "wooyun-2014-074431", "wybug_title": "turbomail文件读取漏洞", "wybug_corp": "turbomail.org", "wybug_author": "applychen", "wybug_date": "2014-08-31 00:07", "wybug_open_date": "2014-09-05 00:08", "wybug_type": "任意文件遍历/下载", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件读取利用", "文件操作参数未加过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-31：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-05：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 登录情况下有效。 详细说明：  Web.xml中有个j2me的servlet\n\n打开反编译出来的J2MEServlet.java，有以下的代码：\nelse if (ACTION_TYPE.equals(\"ACTION_VIEW_EMAIL_ATTACHS\")) {/* 348 */         String sessionId = dataInputStream.readUTF();/* 349 */         if (sessionId == null) {/* 350 */           return;/*     */         }/*     */ /* 353 */         String mbtype = dataInputStream.readUTF();/* 354 */         String msgid = dataInputStream.readUTF();/* 355 */         String realFileName = dataInputStream.readUTF();/* 356 */         String fileName = dataInputStream.readUTF();/* 357 */         dataOutputStream.writeUTF(MailAdmin.getAttachContent(sessionId, /* 358 */           mbtype, msgid, realFileName, fileName));/*     */       }/*     */     }/*     */     catch (Exception e) {/* 362 */       e.printStackTrace();/*     */     }/*     */ /* 367 */     byte[] bs1 = byte_stream.toByteArray();/*     */ /* 369 */     byte[] bs = ZipUtil.compress(bs1);/* 370 */     response.setContentLength(bs.length);/* 371 */     response.getOutputStream().write(bs);/*     */ /* 374 */     response.getOutputStream().flush();/*     */   }\n程序使用readUTF()获取数据，然后在357那里调用了MailAdmin.getAttachContent()方法，在MailAdmin.java文件中找到此方法定义：\n/*      */   public static String getAttachContent(String sessionid, String mbtype, String msgid, String realFileName, String fileName)/*      */     throws UnsupportedEncodingException/*      */   {/*  421 */     MailSession ms = MailMain.s_sessionadmin.getSession(sessionid);/*  422 */     UserInfo userinfo = ms.userinfo;/*  423 */     msgid = /*  424 */       Util.formatRequest(msgid, MailMain.s_os, SysConts.New_InCharSet);/*  425 */     String prefix = ms.temp_path;/*  426 */     String path = prefix + SysConts.FILE_SEPARATOR + userinfo.getUid() + /*  427 */       \"@\" + userinfo.domain;/*  428 */     path = path + SysConts.FILE_SEPARATOR + /*  429 */       Util.GBToISO(mbtype, ms.encoding, MailMain.s_os);/*  430 */     path = path + SysConts.FILE_SEPARATOR + msgid;/*      */ /*  432 */     String realfile = path + SysConts.FILE_SEPARATOR + realFileName;/*  433 */     String strContent = \"\";/*      */ /*  435 */     if (fileName.endsWith(\".txt\")) {/*  436 */       FileInputStream fis = null;/*  437 */       byte[] bs = null;/*      */       try/*      */       {/*  440 */         File f = new File(realfile);/*  441 */         if (f.exists()) {/*  442 */           int iLen = (int)f.length();/*  443 */           bs = new byte[iLen];/*  444 */           fis = new FileInputStream(realfile);/*  445 */           fis.read(bs);/*  446 */           fis.close();/*      */         }/*      */       } catch (Exception localException) {/*      */       }/*      */       try {/*  451 */         if (fis != null)/*  452 */           fis.close();/*      */       }/*      */       catch (Exception localException1) {/*      */       }/*  456 */       if (bs != null)/*  457 */         strContent = new String(bs, ServerConf.s_Default_Encoding);/*  458 */     } else if (fileName.endsWith(\".pdf\")) {/*  459 */       strContent = PDFUtil.getTextFromPDF(realfile);/*  460 */     } else if (fileName.endsWith(\".doc\")) {/*  461 */       strContent = POIUtil.getTextFromWord(realfile);/*  462 */     } else if (fileName.endsWith(\".ppt\")) {/*  463 */       strContent = POIUtil.getTextFromPowerPoint(realfile);/*  464 */     } else if (fileName.endsWith(\".xls\")) {/*  465 */       strContent = POIUtil.getTextFromExcel(realfile);/*      */     }/*  467 */     strContent = Util.replace(strContent, \"\\r\", \"\");/*  468 */     return strContent;/*      */   }\n最终的读取的文件路径realfile由以下的数据组成：\nString realfile = path + SysConts.FILE_SEPARATOR + realFileName;\n控制realFileName参数的值即可浏览文件，下面用writeUTF构造POST数据（注意需要登录之后的sessionid）:\n\n读取回来的数据在程序中使用ZipUtil.compress()加密，大概是这个样子：\n\n其还有一个解密方法ZipUtil.decompress()，调用它解密数据：\n\nturbomail默认情况下是将密码(base64encode)以文件的形式存放在服务器上，此漏洞影响还是比较大的。   漏洞证明：  同上   修复方案：  混淆代码过滤数据你懂的   版权声明：转载请注明来源 applychen@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-05 00:08 厂商回复：  最新状态： 2014-09-11：谢谢查出此漏洞，此漏洞需要系统帐号登录后才可以使用，危害一般，新版本会修复此漏洞  ", "replys": "漏洞评价：\n评论\n     2014-09-04 16:50 |    \t\tapplychen \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:16        | 白发现首)\t\t \n  厂商你怎么了不要忽略啊……    \n     2014-09-12 00:38 |    \t\tapplychen \t\t\t( 普通白帽子  |\t\t\t        Rank:163 漏洞数:16        | 白发现首)\t\t \n  普通权限账号登录后一样可以利用，请复核一下吧    \n     2014-12-29 15:14 |    \t\tWens0n \t\t\t( 普通白帽子  |\t\t\t        Rank:102 漏洞数:22        | 精华漏洞数:32 | WooYun认证√  舞蹈系教授)\t\t \n  @applychen 厂家一般都是忽略葫芦娃兄弟的    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}