{"id": 72178, "wybug_id": "wooyun-2015-0151687", "wybug_title": "Discuz!最新版本帖子正文存在存储型xss漏洞", "wybug_corp": "Discuz!", "wybug_author": "Jannock", "wybug_date": "2015-11-04 12:04", "wybug_open_date": "2015-12-21 10:00", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["存储型"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-11-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-16：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-26：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-06：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-21：\t细节向公众公开  简要描述： 影响官方最新x2.5,x3.x，听说漏洞收藏太久会发霉。 详细说明：  需要开启多媒体代码功能（这个目前很多大站开启了）source\\function\\function_discuzcode.php\nif(strpos($msglower, '[/flash]') !== FALSE) {\t\t\t\t$message = preg_replace(\"/\\[flash(=(\\d+),(\\d+))?\\]\\s*([^\\[\\<\\r\\n]+?)\\s*\\[\\/flash\\]/ies\", $allowmediacode ? \"parseflash('\\\\2', '\\\\3', '\\\\4');\" : \"bbcodeurl('\\\\4', '<a href=\\\"{url}\\\" target=\\\"_blank\\\">{url}</a>')\", $message);\t\t\t}\n跟踪parseflash\nfunction parseflash($w, $h, $url) {\t$w = !$w ? 550 : $w;\t$h = !$h ? 400 : $h;\tpreg_match(\"/((https?){1}:\\/\\/|www\\.)[^\\[\\\"'\\?]+(\\.swf|\\.flv)(\\?.+)?/i\", $url, $matches);\t$url = $matches[0];\t$randomid = 'swf_'.random(3);\tif(fileext($url) != 'flv') {\t\treturn '<span id=\"'.$randomid.'\"></span><script type=\"text/javascript\" reload=\"1\">$(\\''.$randomid.'\\').innerHTML=AC_FL_RunContent(\\'width\\', \\''.$w.'\\', \\'height\\', \\''.$h.'\\', \\'allowNetworking\\', \\'internal\\', \\'allowScriptAccess\\', \\'never\\', \\'src\\', encodeURI(\\''.$url.'\\'), \\'quality\\', \\'high\\', \\'bgcolor\\', \\'#ffffff\\', \\'wmode\\', \\'transparent\\', \\'allowfullscreen\\', \\'true\\');</script>';\t} else {\t\treturn '<span id=\"'.$randomid.'\"></span><script type=\"text/javascript\" reload=\"1\">$(\\''.$randomid.'\\').innerHTML=AC_FL_RunContent(\\'width\\', \\''.$w.'\\', \\'height\\', \\''.$h.'\\', \\'allowNetworking\\', \\'internal\\', \\'allowScriptAccess\\', \\'never\\', \\'src\\', \\''.STATICURL.'image/common/flvplayer.swf\\', \\'flashvars\\', \\'file='.rawurlencode($url).'\\', \\'quality\\', \\'high\\', \\'wmode\\', \\'transparent\\', \\'allowfullscreen\\', \\'true\\');</script>';\t}}\n可以看出preg_match(\"/((https?){1}:\\/\\/|www\\.)[^\\[\\\"'\\?]+(\\.swf|\\.flv)(\\?.+)?/i\", $url, $matches);正则处理不当(\\?.+)从而可以带进“'” 到 encodeURI(\\''.$url.'\\')，从而造成存储型xss   漏洞证明：  内容中提交\n[flash]http://localhost/flash.swf?'+alert(0)+'[/flash]\n\n\n下面是 x25的\n\n大站实例\n\n   修复方案：  修正正则   版权声明：转载请注明来源 Jannock@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-11-06 09:59 厂商回复： 感谢您提出的问题，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-11-04 12:15 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1250 漏洞数:124        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  前排    \n     2015-11-04 12:20 |    \t\thecate \t\t\t( 普通白帽子  |\t\t\t        Rank:569 漏洞数:90        | ®高级安全工程师 | WooYun认证√)\t\t \n  发霉了拿出来晒晒    \n     2015-11-04 12:37 |    \t\t随风的风 \t\t\t( 普通白帽子  |\t\t\t        Rank:180 漏洞数:60        | 微信公众号：233sec  不定期分享各种漏洞思...)\t\t \n  发霉了，拿出来晒晒。    \n     2015-11-04 12:49 |    \t\tDaryl \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        | '\"><img/src=1 onerror=alert('干啥啥不会'...)\t\t \n  发霉了，拿出来晒晒。    \n     2015-11-04 13:12 |    \t\t带馅儿馒头 \t\t\t( 核心白帽子 |\t\t\t        Rank:1297 漏洞数:147        | 心在，梦在)\t\t \n  膜拜一哥    \n     2015-11-04 13:13 |    \t\t90Snake \t\t\t( 普通白帽子  |\t\t\t        Rank:124 漏洞数:43        | 最大的漏洞就是人，SSS论坛，各种神思路。)\t\t \n  发霉了，拿出来晒晒。    \n     2015-11-04 13:28 |    \t\t糖剩七颗 \t\t\t( 普通白帽子  |\t\t\t        Rank:626 漏洞数:81        | 天涯何处无屌丝)\t\t \n  永远的一哥    \n     2015-11-04 13:43 |    \t\tzhiher \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:4        )\t\t \n  永远的一哥    \n     2015-11-04 13:54 |    \t\t撸大叔 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:11        | 钓鱼培养耐心  养鱼需要精心！)\t\t \n  永远的一哥    \n     2015-11-04 14:16 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  放到阳光下    \n     2015-11-04 14:19 |    \t\t乐乐、 \t\t\t( 普通白帽子  |\t\t\t        Rank:868 漏洞数:189        )\t\t \n  卧槽 ...     \n     2015-11-04 15:13 |    \t\tForever80s \t\t\t( 普通白帽子  |\t\t\t        Rank:1037 漏洞数:146        )\t\t \n  额  不错    \n     2015-11-04 15:39 |    \t\t笙心 \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:12        )\t\t \n  永远的一哥     \n     2015-11-04 15:41 |    \t\t鬼见愁 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:1        | 挖洞之神)\t\t \n  @猪猪侠才是一哥    \n     2015-11-04 16:13 |    \t\tfakeidentity \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 既然给了我天空，那还束缚我干吗)\t\t \n  不明真相群众围观    \n     2015-11-04 16:17 |    \t\t晓海’ \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:3        | 一个IT界的酱油帝，坚信分享，创造未来！)\t\t \n  看来有一大波网站要沦陷了。    \n     2015-11-04 17:29 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  我擦，帖子正文。。。跟卡饭有关系没？    \n     2015-11-04 19:45 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:7        | 每日必关注乌云)\t\t \n  mark    \n     2015-11-04 20:43 |    \t\txiaokinghk \t\t\t( 实习白帽子  |\t\t\t        Rank:82 漏洞数:16        | 【DBA】)\t\t \n  围观一哥    \n     2015-11-05 00:20 |    \t\t邪少 \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:9        | 百里长苏)\t\t \n  @疯狗 那啥 secury.wooyun.org  国外的手机如何注册?    \n     2015-11-05 16:59 |    \t\tConTrol \t\t\t( 普通白帽子  |\t\t\t        Rank:135 漏洞数:43        | 【HD】以团队之名 以个人之荣耀 共建网...)\t\t \n  套上黑塑料袋晒一晒 有助于杀菌    \n     2015-11-06 01:15 |    \t\t安徽小伙怕过谁？ \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 学习中)\t\t \n  @Jannock永远的一哥发霉了拿出来晒晒 有助于杀菌    \n     2015-11-06 17:34 |    \t\t菜菜 \t\t\t( 实习白帽子  |\t\t\t        Rank:83 漏洞数:7        | cnidc.hk:500:D5B9985DFBA5FE8A050A39C249C...)\t\t \n  前排围观    \n     2015-11-12 08:53 |    \t\t风铃冷冷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | <img />)\t\t \n  厉害    \n     2015-12-03 17:05 |    \t\t珈蓝夜宇 \t\t\t( 普通白帽子  |\t\t\t        Rank:206 漏洞数:33        | 人不彻底绝望一次，就不会懂得什么是自己最...)\t\t \n  问个问题:  文中提到了:  localhost/flash.swf   那么,flash.swf这个文件是存不存在的呢?试了很多站都没能成功,调用外部的swf也没有成功    \n     2015-12-03 17:44 |    \t\t珈蓝夜宇 \t\t\t( 普通白帽子  |\t\t\t        Rank:206 漏洞数:33        | 人不彻底绝望一次，就不会懂得什么是自己最...)\t\t \n  x3.2中能成功,在下x2.5中不能成功,不知道是不是什么原因    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}