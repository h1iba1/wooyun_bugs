{"id": 71495, "wybug_id": "wooyun-2015-0137693", "wybug_title": "旧版本QQ中的一处打开聊天界面就能触发的远程命令执行", "wybug_corp": "腾讯", "wybug_author": "gainover", "wybug_date": "2015-08-28 22:01", "wybug_open_date": "2015-11-29 17:06", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "客户端安全"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-31：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-03：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-10-25：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-04：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-14：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-29：\t细节向公众公开  简要描述： 虽然这个漏洞已经由于QQ客户端的功能模块更新导致无法复现（大约是2014年4、5月份的版本），但是其中涉及的具体的“小问题”还是依然存在，如果找到了“可替代品”的“入口点”，危害可能将会再次出现。 详细说明：  1. QQ秀是由FLASH来编写的\n\n2. 以前的QQ秀提供了一个叫做心情秀的功能\n\n3. 心情秀可以在Q秀上显示一段自定义文字，还可以改变文字颜色，这及有可能是在TextField中来显示的，并且这个TextField支持htmlText，那么是否可以插入一个img标签呢？\n\n如上图所示，可以发现并不能输入特殊字符？4. 然而，似乎只是在客户端做了过滤而已。。我们抓包看看。\n\n5. 数据被huffcompress算法压缩了，给JS代码下断点，然后修改原始的Q秀数据，提交，\n\n可以看到不论是客户端，还是WEB页面，都成功渲染了我们所填写的HTML代码。6. 接着，我们得试试被img标签嵌入的FLASH是否可以执行恶意代码呢？经测试AS2编写的FLASH才能成功执行，说明父级FLASH为AS2编写。\n\n7. getURL试试。\n\n成功打开pkav.net8. 然后。。\n\n9. 那么有哪些可以被用来调用的API呢？找到Q秀的主FLASH文件。\n\n10. 看到了有意思的API，是吧？执行个calc试试？\n\n11. 似乎还缺点什么\n\n12. 继续反编译另外一个Q秀的FLASH，看名字似乎胜利就在眼前。\n\n13. 分析一下这个函数的作用～\n\n14. 尝试调用一下这个download API。\n\n成功下载了一个文件，但是文件内容却不对。。Why ?抓包找一下原因。\n\n看来客户端实现的代码大概是这样（伪代码）：\n\n15. 怎么办呢？团队的@sogili（长短短）同学提出的一个可能的解决方案，换行试试？\n\n16. 下载回的数据还是不对？继续抓包：\n\n似乎所有的\\r都不见了。。。17.为什么呢？\n\n上面是ExternalInterface.call的实际过程，推测“\\r\\n”可能是在拼接成XML数据之后被“格式化”为“标准”的 “\\n”。\n\n18. 为了避免这种情况，把\\r\\n改写成entity的形式，&#x0D;&#x0A;\n\n可是，参数在处理过程中，&会进行一次转义处理，依然不行。19. 是不是没办法了呢？我们把视线切换到 functionName，函数名未做任何过滤措施。\n\n20. 然后，我们闭合并构造XML。\n\n21. OK，这次我们的请求成功了。\n\n22. 到了这里，我们可以修改请求的host了，但是IP我们肯定没办法改掉了。我们找找看这个IP对应了多少域名\n\n23. 接着，我们的目标就是在这些域名下找到我们可以控制的资源。\n\n24. 最终，我们在b.qzone.qq.com下找到一个可以用来做bat的接口，注意值的双引号边界。\n\n这个接口在登录情况下，是需要csrftoken的，但是在未登录情况下访问，不需要token就可以直接返回数据，所以我们构造请求头时，并不需要带入cookie等信息。25. 最终：download API下载JSON为bat，在QQ默认安装情况下，下载文件的路径已知，openURL API指定程序路径进行执行。\n\n   漏洞证明：  结果已经不是那么重要了。。。   修复方案：  由于Q秀的版本更新，正好把心情秀这个功能去除了，新版本Q秀上不会显示心情秀了，不排除有类似其它问题。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-08-31 17:05 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 2015-08-31：这个漏洞是之前老版本的，还是非常感谢报告。另外我们处理漏洞的同学在wooyun后台执行漏洞确认操作时流程有误，感谢wooyun的同学协助修正流程！  ", "replys": "漏洞评价：\n评论\n     2015-08-28 22:02 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  我擦，这是二哥多年的神洞啊！    \n     2015-08-31 17:06 |    \t\t明月影 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:8        )\t\t \n  神洞……    \n     2015-08-31 17:07 |    \t\tking7 \t\t\t( 普通白帽子  |\t\t\t        Rank:645 漏洞数:113        | 收WB~~1：7手续费协商，个位数到三位数量都...)\t\t \n  二哥用这个搞定了不少妹子吧    \n     2015-08-31 17:15 |    \t\tboooooom  \t\t\t( 普通白帽子  |\t\t\t        Rank:467 漏洞数:50        | 我有一个好想法！)\t\t \n  膜拜！    \n     2015-08-31 17:23 |    \t\tHackBraid  \t\t\t( 核心白帽子 |\t\t\t        Rank:1741 漏洞数:278        | ...........................................)\t\t \n  收下我的双膝    \n     2015-08-31 17:23 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:232 漏洞数:80        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  多旧？    \n     2015-08-31 17:23 |    \t\tlxj616 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:90        | <hohoho>)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 17:27 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:657 漏洞数:133        | 290)\t\t \n  二哥肯定又找到新的漏洞了    \n     2015-08-31 17:31 |    \t\tDNS \t\t\t( 普通白帽子  |\t\t\t        Rank:510 漏洞数:60        | 没有我，你们就去背IP吧)\t\t \n  火钳刘明    \n     2015-08-31 17:32 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:259 漏洞数:20        | 当我又回首一切,这个世界会好吗?)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 17:36 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 17:38 |    \t\tMsyb \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:10        | 非常荣幸加入乌云。)\t\t \n  膜拜大神    \n     2015-08-31 17:40 |    \t\tDloveJ \t\t\t( 普通白帽子  |\t\t\t        Rank:1159 漏洞数:208        | <a href=javascrip:alert('xss')>s</a> 点...)\t\t \n  二哥霸气！！    \n     2015-08-31 17:43 |    \t\tHxai11 \t\t\t( 普通白帽子  |\t\t\t        Rank:1151 漏洞数:221        | 你的爱恨与纠葛，你的回忆与苦痛，都是一体...)\t\t \n  从此不再需要盗取QQ号了    \n     2015-08-31 17:50 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:3007 漏洞数:661        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 18:02 |    \t\t陆由乙 \t\t\t( 普通白帽子  |\t\t\t        Rank:175 漏洞数:53        | 呵呵！)\t\t \n  屌    \n     2015-08-31 18:08 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:245 漏洞数:63        | 潜心代码审计。)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 18:14 |    \t\tSunshie \t\t\t( 实习白帽子  |\t\t\t        Rank:63 漏洞数:11        | http://phpinfo.me)\t\t \n  本回复是被二哥命令执行后自动回复的     \n     2015-08-31 18:23 |    \t\t土夫子 \t\t\t( 普通白帽子  |\t\t\t        Rank:324 漏洞数:58        | 自由)\t\t \n  @疯狗  麻烦狗哥审核一下（二次更新，去掉了敏感信息）http://wooyun.org/bugs/wooyun-2015-0138110    \n     2015-08-31 18:26 |    \t\t浅蓝 \t\t\t( 普通白帽子  |\t\t\t        Rank:279 漏洞数:110        | 爱安全:www.ixsec.orgXsec社区:zone.ixse...)\t\t \n  二哥  请收下我的膝盖    \n     2015-08-31 18:46 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1213 漏洞数:321        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 18:49 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1077 漏洞数:139        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 18:58 |    \t\t大物期末不能挂 \t\t\t( 普通白帽子  |\t\t\t        Rank:132 漏洞数:23        | 1.一个学渣，只求每门都不挂2.想把漏洞提...)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 18:59 |    \t\t进击的zjx \t\t\t( 普通白帽子  |\t\t\t        Rank:461 漏洞数:76        | 本想成为从业者，奈何沦为爱好者！哎……这...)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 19:12 |    \t\t小草鸡炖蘑菇 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 既往不恋 当下不杂 未来不迎)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 19:18 |    \t\tSubmit \t\t\t( 普通白帽子  |\t\t\t        Rank:487 漏洞数:107        | 手头紧，卖点WB，1:10)\t\t \n  本回复是被二哥命令执行后自动回复的 (我不想回复的，我是被逼的，被远程执行命令回复)    \n     2015-08-31 19:19 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1542 漏洞数:208        | 逆流而上)\t\t \n  本回复是被二哥命令执行后自动回复的     \n     2015-08-31 19:25 |    \t\t毕月乌 \t\t\t( 普通白帽子  |\t\t\t        Rank:120 漏洞数:16        | 猜猜我是谁？)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 19:27 |    \t\tUndoit \t\t\t( 普通白帽子  |\t\t\t        Rank:167 漏洞数:25        | 打酱油)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 19:44 |    \t\t刘海哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:28        | 索要联系方式但不送礼物的厂商定义为无良厂...)\t\t \n  本回复是被二哥命令执行后自动回复的     \n     2015-08-31 19:52 |    \t\t冷白开。 \t\t\t( 普通白帽子  |\t\t\t        Rank:160 漏洞数:67        | QQ:970060225 拒绝黑产，欢迎大牛交流技术...)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 20:29 |    \t\t超人不会飞 \t\t\t( 实习白帽子  |\t\t\t        Rank:85 漏洞数:24        | 好好学习，天天向上!)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 20:36 |    \t\tQ1NG \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:21        | 临 兵 斗 者 皆 阵 列 前 行 !)\t\t \n  二哥快说还有好多,神洞  66666    \n     2015-08-31 21:01 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1038 漏洞数:177        | px1624)\t\t \n  擦，你不是在tw么    \n     2015-08-31 21:07 |    \t\t红糖哥 \t\t\t( 实习白帽子  |\t\t\t        Rank:70 漏洞数:8        | 红糖暖胃不暖逼)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 21:45 |    \t\t黑吃黑 \t\t\t( 普通白帽子  |\t\t\t        Rank:143 漏洞数:30        | 倚楼听风雨，淡看江湖路...)\t\t \n  过了一年才舍得发出来，应该有不少妹子被二哥命令执行了吧    \n     2015-08-31 21:49 |    \t\t不会游泳的鱼 \t\t\t( 普通白帽子  |\t\t\t        Rank:133 漏洞数:41        | 非著名白帽子)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 22:30 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1234 漏洞数:122        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  二哥太吊了    \n     2015-08-31 22:30 |    \t\t大师兄 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:6        | 每日必关注乌云)\t\t \n  二哥的神技，望尘莫及    \n     2015-08-31 22:49 |    \t\tfintop \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 小白一个)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-08-31 23:06 |    \t\tonpu \t\t\t( 普通白帽子  |\t\t\t        Rank:102 漏洞数:27        | 学习就是最好的投资，勿忘初心。)\t\t \n  二哥 请收下我的膝盖    \n     2015-08-31 23:36 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB!    \n     2015-09-01 10:04 |    \t\t小葵 \t\t\t( 实习白帽子  |\t\t\t        Rank:84 漏洞数:11        | 我们是害虫，我们是害虫！)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-09-03 18:26 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:189 漏洞数:25        | 开发真是日了狗了)\t\t \n  此号hacked by 二哥    \n     2015-09-03 20:08 |    \t\t哎呦我去 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 新手白帽子！！继续努力)\t\t \n  我只是个打酱油的    \n     2015-09-04 18:48 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:179 漏洞数:28        | 逆水行舟，不进则退。)\t\t \n  本回复是被二哥命令执行后自动回复的     \n     2015-09-04 21:57 |    \t\tMark \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:2        | 渗透你的心)\t\t \n  请收下我的膝盖    \n     2015-09-07 10:20 |    \t\t香草 \t\t\t( 实习白帽子  |\t\t\t        Rank:99 漏洞数:14        | javascript,xss,jsp、aspx)\t\t \n  听二哥说，思路很猥琐    \n     2015-09-11 22:36 |    \t\tjye33 \t\t\t( 普通白帽子  |\t\t\t        Rank:178 漏洞数:52        | 没有什么能够阻挡，我对静静的向往)\t\t \n  牛逼的二哥    \n     2015-09-27 11:25 |    \t\tHackshy \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:22        | 猪猪侠爱吃棒棒糖)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-09-28 17:49 |    \t\t指尖的温度 \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:9        )\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-10-02 16:10 |    \t\t金馆长 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | Up)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-10-08 17:34 |    \t\tCode Life \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:9        | Code Life,Jion It!)\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-11-04 17:55 |    \t\t小红猪 \t\t\t( 普通白帽子  |\t\t\t        Rank:214 漏洞数:40        )\t\t \n  本回复是被二哥命令执行后自动回复的    \n     2015-11-29 17:12 |    \t\t有归于无 \t\t\t( 实习白帽子  |\t\t\t        Rank:96 漏洞数:18        | 有归于无)\t\t \n  不愧是偶像啊    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}