{"id": 65735, "wybug_id": "wooyun-2015-0136903", "wybug_title": "微信公众号管理员后台点击我发的消息链接，公众号介绍等设置就会被修改（绕过csrf防护）", "wybug_corp": "腾讯", "wybug_author": "呆子不开口", "wybug_date": "2015-08-25 18:16", "wybug_open_date": "2015-10-09 19:38", "wybug_type": "CSRF", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["利用技巧", "绕过"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-25：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-09-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-09：\t细节向公众公开  简要描述： 微信公众号管理员在后台点击我发给他的链接，他的简介、头像、隐私设置、地址等设置就会被修改，还可以添加用户分组 详细说明：  微信公共号后台的CSRF防护是有的，token防护加referrer限制，看起来很完美但是，由于设计的一些不合理，仍然可被csrf攻击，以下是详情1、公众号后台的token的设计问题公众号后台的csrf防护的token直接在后台所有操作的url中都会出现。这样token就有可能被http包里的referer字段发往第三方而泄露。我在以前写过的文章 http://drops.wooyun.org/web/7112 里也提过这个问题的风险，当时我说削弱了防护体系。一旦其他的防护有问题的时候，这个问题就会被利用2、先偷TOKEN发送一个自己可控内容的https（公众后台是https的，只给https传递referrer）的url给微信公众账号，一旦他点击，管理后台url里的token就会发给我们。直接给公众号发送url，后台是不会识别的。需要一个小技巧来给后台发链接把链接到微信的聊天框中然后访问，然后微信内置浏览器会打开这个页面，然后再收藏这个页面然后再给公众号发收藏里的这个页面，这样在管理员的后台看到的就是一个富媒体格式的链接的3、某些处可绕过referrer微信公众号后台的操作都是post的，而且限制了referrer为本域但是有一些操作，比如公众号设置里的介绍、头像修改、添加分组、地址修改、隐私设置是否允许别人搜索的设置等地方的请求，虽然看起来也是post的但是你如果把post请求改成get，body的内容放到get参数中，这样的请求服务端也接受修改介绍的请求：\nhttps://mp.weixin.qq.com/cgi-bin/setuserinfo?action=intro&t=ajax-response&token=589115843&lang=zh_CN&f=json&ajax=1&random=0.3911454190965742&intro=hacked%20by%20shidada\n添加分组\nhttps://mp.weixin.qq.com/cgi-bin/modifygroup?t=ajax-friend-group&token=589115843&lang=zh_CN&f=json&ajax=1&random=0.0741190540138632&func=add&name=helloasasas\n关闭允许他人搜索到的设置\nhttps://mp.weixin.qq.com/cgi-bin/setuserinfo?t=ajax-response&token=589115843&lang=zh_CN&f=json&ajax=1&random=0.5444546448998153&action=search&open=0\n而且改成get请求后，referrer限制允许了空referrer的情况，这样我们的利用就更不易被察觉了，因为不需要直接发此链接让受害者点了4、怎么利用构造一个https页面，里面是伪装的内容，并且会发出空referer的带着token的get请求（可使用iframe动态加载form来发get请求）来完成如上一些敏感操作   漏洞证明：  拿了一个朋友的公众账号做测试，她不知情给公众账号发链接\n\n她点击后介绍被我修改成\"hacked by koreans\"\n\n由于她被我攻击，所以她要求我补偿她给她推广公众号，她的号和照片如下加他的公众账号吧，你的人生开始不再虚度\n\n\n\n   修复方案：  保护好token，不要放在get中post的请求不要让get发   版权声明：转载请注明来源 呆子不开口@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-08-25 19:37 厂商回复： 非常感谢您的报告，问题已着手处理，感谢大家对腾讯业务安全的关注。如果您有任何疑问，欢迎反馈，我们会有专人跟进处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-25 19:38 |    \t\tNoxxx \t\t\t( 普通白帽子  |\t\t\t        Rank:509 漏洞数:41        )\t\t \n  前排围观    \n     2015-08-25 19:44 |    \t\tniliu  \t\t\t( 核心白帽子 |\t\t\t        Rank:1540 漏洞数:207        | 逆流而上)\t\t \n  前排围观     \n     2015-08-25 19:50 |    \t\t机器猫 \t\t\t( 普通白帽子  |\t\t\t        Rank:1193 漏洞数:258        | 爱生活、爱腾讯、爱网络！)\t\t \n  前排围观    \n     2015-08-25 19:59 |    \t\tscanf \t\t\t( 核心白帽子 |\t\t\t        Rank:1282 漏洞数:190        | 。)\t\t \n  留名围观    \n     2015-08-25 20:01 |    \t\tXmyth_夏洛克 \t\t\t( 普通白帽子  |\t\t\t        Rank:609 漏洞数:83        | 啥都不会)\t\t \n  前排围观    \n     2015-08-25 20:03 |    \t\tLooke \t\t\t( 普通白帽子  |\t\t\t        Rank:649 漏洞数:94        | 可顺势而为，何必逆水行舟)\t\t \n  前排围观    \n     2015-08-25 20:05 |    \t\tSubmit \t\t\t( 普通白帽子  |\t\t\t        Rank:375 漏洞数:86        | 666)\t\t \n  前排围观    \n     2015-08-25 21:05 |    \t\t暮偶 \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 代码写的好累.)\t\t \n  前排围观     \n     2015-08-25 21:14 |    \t\tqglfnt \t\t\t( 普通白帽子  |\t\t\t        Rank:158 漏洞数:37        | 白天不懂夜的黑)\t\t \n  火钳留名    \n     2015-08-25 21:35 |    \t\t柱子 \t\t\t( 路人 |\t\t\t        Rank:25 漏洞数:4        | 专注APP)\t\t \n  留名围观    \n     2015-08-25 22:40 |    \t\tlufsy \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:3        | 自由，分享，共进)\t\t \n  mark    \n     2015-08-25 22:56 |    \t\tChinalover \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:4        | 你看得到我打在屏幕上的字，却看不到我落在...)\t\t \n  后排围观    \n     2015-08-25 22:56 |    \t\tJinone \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:28        | 安全盒子招人ing             有意请私信)\t\t \n  没位置了    \n     2015-08-25 23:18 |    \t\t小小泥娃 \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:4        | 高二)\t\t \n  没位置了    \n     2015-08-25 23:33 |    \t\t终于明白 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:4        | 菜鸟·····)\t\t \n  膜拜大牛~~~    \n     2015-08-26 08:42 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  不敢点你的链接了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}