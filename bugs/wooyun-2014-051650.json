{"id": 58299, "wybug_id": "wooyun-2014-051650", "wybug_title": "Thinksaas 失败的getshell &amp; 一枚注入。", "wybug_corp": "thinksaas.cn", "wybug_author": "′雨。", "wybug_date": "2014-02-21 21:43", "wybug_open_date": "2014-05-19 21:43", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-02-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-02-23：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-04-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-04-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-05-09：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-05-19：\t细节向公众公开  简要描述： /*为什么最新一直被走小厂商?累觉不爱。*/本来还以为能够直接前台getshell的。 能直接把代码写入文件。但是最后也都败给了转义符。还是来注入把。 详细说明：  0x01 失败的Getshell。\\app\\mail\\action\\admin\\do.php访问这里 无需登录。\n$arrData = array(\t\t\t'appname' => trim($_POST['appname']),\t\t\t'appdesc' => trim($_POST['appdesc']),\t\t\t'isenable' => trim($_POST['isenable']),\t\t\t'mailhost' => trim($_POST['mailhost']),\t\t\t'mailport' => trim($_POST['mailport']),\t\t\t'mailuser' => trim($_POST['mailuser']),\t\t\t'mailpwd' => trim($_POST['mailpwd']),\t\t);        \t\tforeach ($arrData as $key => $val){\t\t\t$db->query(\"UPDATE \".dbprefix.\"mail_options SET optionvalue='$val' where optionname='$key'\");\t\t}\t\t\t\t//更新缓存\t\t$arrOptions = $db->fetch_all_assoc(\"select optionname,optionvalue from \".dbprefix.\"mail_options\");\t\tforeach($arrOptions as $item){\t\t\t$arrOption[$item['optionname']] = $item['optionvalue'];\t\t}\t\t\t\tfileWrite('mail_options.php','data',$arrOption);\t\t$tsMySqlCache->set('mail_options',$arrOption);\t\t\t\tqiMsg(\"邮件配置更新成功，并重置了缓存文件^_^\");\n很多可控 但是在query执行语句的时候 单引号会被转义。 再继续看看。然后就带入了filewrite\nfunction fileWrite($file, $dir, $data, $isphp = 1) {\tglobal $TS_CF, $TS_MC;\t\t$dfile = $dir . '/' . $file;\t\t// 支持memcache\tif ($TS_CF ['memcache'] && extension_loaded ( 'memcache' )) {\t\t$TS_MC->delete ( md5 ( $dfile ) );\t\t$TS_MC->set ( md5 ( $dfile ), $data, 0, 172800 );\t}\t$a = var_export ($data, false);\t\t// 同时保存文件\t! is_dir ( $dir ) ? mkdir ( $dir, 0777 ) : '';\tif (is_file ( $dfile ))\t\tunlink ( $dfile );\tif ($isphp == 1) {\t\t$data = \"<?php\\ndefined('IN_TS') or die('Access Denied.');\\nreturn \" . var_export ( $data, true ) . \";\";\t\t\t}\t\tfile_put_contents ( $dfile, $data );\t\treturn true;\n直接写到php文件里面里。$dfile 不可控 但是是一个php文件 $data可控。在var_export 之前输出$dataArray ( [appname] => a' [appdesc] => [isenable] => [mailhost] => [mailport] => [mailuser] => [mailpwd] => ) 可以看到是没有转义的。 但是在经过var_export后 跟var_dump差不多 不同就是就是他会把这个弄成php格式。也把a'转义了。至此 Getshell 无望。mail options.php文件中\n<?phpdefined('IN_TS') or die('Access Denied.');return array (  'appname' => 'a\\'',  'appdesc' => '',  'isenable' => '',  'mailhost' => '',  'mailport' => '',  'mailuser' => '',  'mailpwd' => '',);\n_________________________________________________________________0x02 注入。还是这个文件。虽然进入query的转义了 但是还有其他的查询。\n\n   漏洞证明：  \n\n   修复方案：  求20。求保养。thanks   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-05-19 21:43 厂商回复： 最新版已经无法访问\\app\\mail\\action\\admin\\文件。官方2月20号已经修复上述普通用户访问管理员操作问题。再次感谢您的反馈，谢谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-02-21 21:48 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  能有钱就好嘛 不是么 亲    \n     2014-02-22 14:11 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @xsser 确定这种cms也有钱？    \n     2014-02-22 14:12 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @寂寞的瘦子 应该是的 要么是钱要么是QB 一定有吧    \n     2014-02-22 14:24 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @xsser 鼓掌~~，顺求审核我最新的洞，研究这个cms挖的我很累的说    \n     2014-02-23 11:38 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @thinksaas.cn 那把官网上下载的程序更新了嘛。   我再看看。    \n     2014-02-26 19:40 |    \t\t冷静 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        )\t\t \n  @xsser 这洞主还没16岁没银行卡,还是奖QB吧    \n     2014-02-27 09:12 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @冷静 ..你是哪个啊？   你怎知道。  上次你还发你空间图片来着 我还奇怪呢。    \n     2014-10-01 22:04 |    \t\tPythonPig \t\t\t( 普通白帽子  |\t\t\t        Rank:491 漏洞数:71        | 只会简单工具的小小菜)\t\t \n  问个低智商的问题，你上面图片上的内容除了post data那部分是hackbar得功能，图片中的“黑框”和右侧部分也是 hackbar还是其他工具？    \n     2014-10-01 22:15 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @PythonPig 一个控制台  一个日志。    \n     2014-10-01 22:59 |    \t\tPythonPig \t\t\t( 普通白帽子  |\t\t\t        Rank:491 漏洞数:71        | 只会简单工具的小小菜)\t\t \n  @′  雨。 额~~控制台指的是firefox的控制台？日志是查看的mysql的运行日志嘛？怎么感觉效果不是你这样的勒？thx~~    \n     2014-10-01 23:41 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @PythonPig mysql的控制台 另外个就是mysql的日志    \n     2014-10-07 15:45 |    \t\tPythonPig \t\t\t( 普通白帽子  |\t\t\t        Rank:491 漏洞数:71        | 只会简单工具的小小菜)\t\t \n  @′  雨。 用啥子软件查看的日志啊？我用文本查看，格式记我蛋碎一地啊    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}