{"id": 1077, "wybug_id": "wooyun-2014-067410", "wybug_title": "Hdwiki设计缺陷知邮箱可改密码（包括管理员）", "wybug_corp": "互动在线（北京）科技有限公司", "wybug_author": "′雨。", "wybug_date": "2014-07-04 18:40", "wybug_open_date": "2014-09-29 18:42", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-04：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-09：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-02：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-09-12：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-09-22：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-29：\t细节向公众公开  简要描述： 上Hdwiki官网 发现更新日期一直都没变。 还以为一直都没更新了, 结果今天下载一个下来看看。 发现之前发的洞竟然都补掉了。 看了看之前这个改密码那个 对比了一下。 发现增强了点验证。加入了一个算法。不过。。。。。。——————————————————————————————————ps. 更新程序了应该还是把日期更新了一下 要不别人会一直以为没更新的。 详细说明：   WooYun: Hdwiki 设计缺陷 知邮箱可改密码（包括管理员） 上次的 现在来看看现在的。依旧是control/user.php\n}else{\t\t\t$timetemp=date(\"Y-m-d H:i:s\",$this->time);\t\t\t$auth = util::strcode($timetemp, 'ENCODE');\t\t\t$verification= rand(1000,9999);\t\t\t$encryptstring=md5($this->time.$verification.$auth);\t\t\t$reseturl=WIKI_URL.\"/index.php?user-getpass-\".$user['uid'].'-'.$encryptstring;\t\t\t$_ENV['user']->update_getpass($user['uid'],$encryptstring);\t\t\t$mail_subject = $this->setting['site_name'].$this->view->lang['getPass'];\t\t\t$mail_message = $this->view->lang['resetPassMs1'].$user['username'].$this->view->lang['resetPassMs2'].$timetemp.$this->view->lang['resetPassMs3'].\"<a href='\".$reseturl.\"' target='_blank'>\".$reseturl.\"</a>\".$this->view->lang['resetPassMs4'].$this->setting['site_name'].$this->view->lang['resetPassMs5'].$this->setting['site_name'].$this->view->lang['resetPassMs6'];\t\t\t$this->load('mail');\t\t\t$_ENV['mail']->add(array(), array($email), $mail_subject, $mail_message, '', 1, 0);\t\t\t$this->message($this->view->lang['emailSucess'],'index.php?user-login',0);\t\t}\t}\n$encryptstring=md5($this->time.$verification.$auth);现在所验证的 对比之前的可以发现多了一个$auth 来看看怎么来的。\t$timetemp=date(\"Y-m-d H:i:s\",$this->time);\t\t\t$auth = util::strcode($timetemp, 'ENCODE');这里获取了一下时间 然后\nfunction strcode($string,$action='ENCODE'){\t\t$key\t= substr(md5($_SERVER[\"HTTP_USER_AGENT\"].PP_KEY),8,18);\t\t$string\t= $action == 'ENCODE' ? $string : base64_decode($string);\t\t$len\t= strlen($key);\t\t$code\t= '';\t\tfor($i=0; $i < strlen($string); $i++){\t\t\t$k\t\t= $i % $len;\t\t\t$code  .= $string[$i] ^ $key[$k];\t\t}\t\t$code = $action == 'DECODE' ? $code : base64_encode($code);\t\treturn $code;\t}\n主要关注他的key怎么来的。$key\t= substr(md5($_SERVER[\"HTTP_USER_AGENT\"].PP_KEY),8,18);首先对USER_AGENT.PP_KEY MD5一次 然后再来取。等等。。  user agent 是用户可控的, PP_KEY呢?竟然没有初始化, 那么PP_KEY就是PP_KEY 那么这个$key 全部就可控了。所以我们可以想对什么加密就对神马加密了。$timetemp=date(\"Y-m-d H:i:s\",$this->time);\t\t\t$auth = util::strcode($timetemp, 'ENCODE');然后这个是对时间加密一次 如果知道时间的话就能知道$auth然后继续$this->time.$verification.$auth第一个就是时间戳 第二个rand(1000,9999) 有8999种可能 直接枚举 第三个 知道时间就可以了。   漏洞证明：  这里由于管理员和用户在同一个表所以可以直接改管理员的密码。首先 http://web.com/web/hdwiki/index.php?user-getpass然后把要管理员的邮箱输入进去。 在点提交之前打开 (提交的时候一定要改一下user agent 如果不改user agent 会对应不上的 我这里改成的是asd)http://tool.chinaz.com/Tools/unixtime.aspx然后在点提交的时候 看一下时间戳 并记录下来。(我本地时间有点不准 无伤大雅)以我演示的为例, 时间戳为 1405589070然后把这个时间戳转换为时间 1405589070 -> 2014/7/17 17:24:30 （时间不准 别在意哈哈）$timetemp=date(\"Y-m-d H:i:s\",$this->time)Y-m-d H:i:s 这个的格式是这样的 年份-月份-日子 小时:分钟:秒所以把2014/7/17 17:24:30对应下来为2014-7-17 17:24:30但是这样是不对的  因为 Y-m-d H:i:s获取的是 格林威治标准时间与北京时间正好相差8个小时   所以$timetemp=2014-07-17 09:24:30然后带入那个算法当中 \n\n然后这样就拿到了$auth然后写个脚本 把8999种情况 全部遍历出来1405589070$iBlMHBUkAVkwHBxYICw8BVw0BBA==\n\n把8999种情况全部导出来  然后载入burpsuite\n\n前面那uid那里就是管理员的id  肯定是为1的。   修复方案：  增强验证增强算法随机生成一个Key咋样。   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-09-29 18:42 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-07-05 08:14 |    \t\t走火入魔 \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | 多读书，多看报，少吃零食，多睡觉。)\t\t \n  雨大牛 你这是要火火    \n     2015-08-06 00:20 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  忽略了    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}