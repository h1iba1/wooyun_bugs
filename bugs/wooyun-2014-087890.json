{"id": 45314, "wybug_id": "wooyun-2014-087890", "wybug_title": "ecshop一处验证码绕过逻辑漏洞", "wybug_corp": "ShopEx", "wybug_author": "路人甲", "wybug_date": "2014-12-26 22:02", "wybug_open_date": "2015-03-26 22:04", "wybug_type": "设计错误/逻辑缺陷", "wybug_level": "低", "wybug_rank_0": "5", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-12-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-12-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-12-31：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-02-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-03-03：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-03-13：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-03-26：\t细节向公众公开  简要描述： 一处逻辑漏洞导致绕过 详细说明：  虽然验证码进行了加密，但是逻辑上还有点问题问题出在..\\includes\\cls_captcha.php通过验证函数可以看到直接返回，并没有对验证失败进行处理\nfunction check_word($word)    {        $recorded = isset($_SESSION[$this->session_word]) ? base64_decode($_SESSION[$this->session_word]) : '';        $given    = $this->encrypts_word(strtoupper($word)); //MD5加密处理        return (preg_match(\"/$given/\", $recorded)); //验证规则    }\n也就是说如果登陆失败的时候没有对验证码SESSION置空的话，就可以在这次请求中反复尝试进行破解。下面代码可以看到并没有对验证错误的时候进行处理..\\ecshop\\admin\\privilege.php\nif (intval($_CFG['captcha']) & CAPTCHA_ADMIN)    {        include_once(ROOT_PATH . 'includes/cls_captcha.php');        /* 检查验证码是否正确 */        $validator = new captcha();        if (!empty($_POST['captcha']) && !$validator->check_word($_POST['captcha']))        {            sys_msg($_LANG['captcha_error'], 1);        }    }    $_POST['username'] = isset($_POST['username']) ? trim($_POST['username']) : '';    $_POST['password'] = isset($_POST['password']) ? trim($_POST['password']) : '';    $sql=\"SELECT `ec_salt` FROM \". $ecs->table('admin_user') .\"WHERE user_name = '\" . $_POST['username'].\"'\";   echo $sql.\"<br/>\";    $ec_salt =$db->getOne($sql);    if(!empty($ec_salt))    {         /* 检查密码是否正确 */         $sql = \"SELECT user_id, user_name, password, last_login, action_list, last_login,suppliers_id,ec_salt\".            \" FROM \" . $ecs->table('admin_user') .            \" WHERE user_name = '\" . $_POST['username']. \"' AND password = '\" . md5(md5($_POST['password']).$ec_salt) . \"'\";    }    else    {         /* 检查密码是否正确 */         $sql = \"SELECT user_id, user_name, password, last_login, action_list, last_login,suppliers_id,ec_salt\".            \" FROM \" . $ecs->table('admin_user') .            \" WHERE user_name = '\" . $_POST['username']. \"' AND password = '\" . md5($_POST['password']) . \"'\";    }    $row = $db->getRow($sql);    if ($row)    {....}\n   漏洞证明：  \n\n   修复方案：  通过以上代码，可以看出是验证码session没有置空导致的，每次登陆都session(null)就行了;   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-12-28 21:15 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}