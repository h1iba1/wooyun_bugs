{"id": 59176, "wybug_id": "wooyun-2014-048342", "wybug_title": "新东方某分站源码泄露源码审计中发现若干问题", "wybug_corp": "新东方", "wybug_author": "Mr .LZH", "wybug_date": "2014-01-17 15:52", "wybug_open_date": "2014-03-03 15:53", "wybug_type": "系统/服务运维配置不当", "wybug_level": "中", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["安全意识不足", "源代码泄漏"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-01-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-01-20：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-01-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-03：\t细节向公众公开  简要描述： 放下面说吧 详细说明：  网站地址：http://coolcampdv2011.xdf.cn一.源码泄露问题：svn备份文件未删除导致泄露,以下目录存在.svn目录.根目录不存在,幸好数据库连接信息在根目录下的文件.\n\n二.审计源码,发现advideo/login.php文件可直接注册管理员帐号.注册后进后台.后台地址：http://coolcampdv2011.xdf.cn/advideo/adindex.php页面源码如下:\n<?phprequire_once '../configure.php';require_once 'class/class_admin.php';require_once '../class/class_memcache.php';$conf = new configure ( );$mysqldb = $conf->mysql ();$smarty = $conf->smarty ();$memcache = new class_memcache ( $conf->memcache_host, $conf->memcache_post, $conf );$admin = new class_admin ( $mysqldb, $memcache, $conf );session_start ();$do = empty ( $_GET ['do'] ) ? '' : addslashes ( $_GET ['do'] );// smarty$smarty->assign ( 'crumbs', '0' ); // 面包屑$smarty->assign ( 'crumbs1', '' ); // 面包屑 第一级$smarty->assign ( 'crumbs2', '' ); // 面包屑 第二级if ($do == 'zhuce') {\t\t// advideo/adindex.php 页面点击‘注册’链接进入\t$smarty->assign ( 'title', '管理后台-管理员注册' ); // 页面title\t$smarty->display ( 'templates/zhuce.html' );} elseif ($do == 'modifypwd') {\t\t// 在space.php?do=input或list的‘修改密码’链接进入\t$smarty->assign ( 'title', '管理后台-管理员修改密码' ); // 页面title\t$smarty->assign ( 'email', empty ( $_SESSION ['usrInfo'] ['email'] ) ? '' : $_SESSION ['usrInfo'] ['email'] );\t$smarty->display ( 'templates/modifypwd.html' );} elseif ($do == 'inmodifypwd') {\t\t// 在advideo/login.php?do=modifypwd 修改密码页面中点击‘修改密码’按钮\t$email = empty ( $_POST ['email'] ) ? '' : $_POST ['email'];\t$oldpwd = empty ( $_POST ['oldpwd'] ) ? '' : $_POST ['oldpwd'];\t$newpwd = empty ( $_POST ['newpwd'] ) ? '' : $_POST ['newpwd'];\t$data = $admin->updatepwd ( $email, $oldpwd, $newpwd );\theader ( \"Content-Type: text/html; charset=utf8\" );\tif ($data == 1) {\t\techo \"<script> alert('修改密码成功！'); window.location.href='adindex.php'</script>\";\t} elseif ($data == 2) {\t\techo \"<script> alert('修改密码失败！有相同邮箱名称的管理员存在'); window.location.href='login.php?do=modifypwd'</script>\";\t} elseif ($data == 0) {\t\techo \"<script> alert('修改密码失败！管理员邮箱或者密码错误'); window.location.href='login.php?do=modifypwd'</script>\";\t} elseif ($data == 3) {\t\techo \"<script> alert('修改密码失败！未知错误'); window.location.href='login.php?do=modifypwd'</script>\";\t}} elseif ($do == 'register') {\t\t// advideo/login.php?do=zhuce 页面点击‘注册’按钮\t$email = empty ( $_POST ['email'] ) ? '' : $_POST ['email'];\t$pwd = empty ( $_POST ['pwd'] ) ? '' : $_POST ['pwd'];\t$data = $admin->insert ( $email, $pwd );\theader ( \"Content-Type: text/html; charset=utf8\" );\tif ($data == 1) {\t\techo \"<script> alert('注册成功！'); window.location.href='adindex.php'</script>\";\t} elseif ($data == 2) {\t\techo \"<script> alert('注册失败！有相同邮箱名称的管理员存在'); window.location.href='login.php?do=zhuce'</script>\";\t} elseif ($data == 0) {\t\techo \"<script> alert('注册失败！未知错误'); window.location.href='login.php?do=zhuce'</script>\";\t}} elseif ($do == 'adlogin') {\t\t// admin/adindex.php 页面点击‘登陆’按钮\t$email = empty ( $_POST ['email'] ) ? '' : $_POST ['email'];\t$pwd = empty ( $_POST ['password'] ) ? '' : $_POST ['password'];\t$data = $admin->login ( $email, $pwd ); // 1 有此人 0 无此人\theader ( \"Content-Type: text/html; charset=utf8\" );\tif ($data > 1) {\t\techo \"<script> alert('登陆失败！有相同邮箱名称的管理员存在'); window.location.href='adindex.php'</script>\";\t} elseif ($data == 1) {\t\tif (empty ( $_SESSION ['usrInfo'] )) {\t\t\t$_SESSION ['usrInfo'] = array ();\t\t}\t\t$_SESSION ['usrInfo'] ['email'] = $email; // 管理员邮箱\t\t$_SESSION ['usrInfo'] ['type'] = 1; // 是管理员\t\t$_SESSION ['usrInfo'] ['adminID'] = $admin->admininfo ['id']; // 管理员id\t\t$_SESSION ['usrInfo'] ['adminAuth'] = $admin->admininfo ['auth']; // 管理员权限\t\techo \"<script> window.location.href='space.php?do=list'</script>\";\t} elseif ($data == 0) {\t\techo \"<script> alert('登陆失败！管理员邮箱或者密码错误'); window.location.href='adindex.php'</script>\";\t}} elseif ($do == 'login') {\t\t// advideo/index.php 页面点击‘登陆’按钮\t$email = empty ( $_POST ['email'] ) ? '' : $_POST ['email'];\t$pwd = empty ( $_POST ['password'] ) ? '' : $_POST ['password'];\t$userHandler = $conf->userHandle ();\t$userHandler->CheckLogin ( $email, $pwd );\t$resp = $userHandler->LoginReturn ();\tif ($resp == 'succ') {\t\t//\t\tstdClass Object(\t\t//    \t[Token] => 0EB4AA80D9B183B00A11524BAB1A56E8\t\t//    \t[NickName] => liugj\t\t//    \t[UserId] => xdf00426    )\t\tif (empty ( $_SESSION ['usrInfo'] )) {\t\t\t$_SESSION ['usrInfo'] = array ();\t\t}\t\t$_SESSION ['usrInfo'] ['email'] = $email;\t\t$_SESSION ['usrInfo'] ['nick'] = $userHandler->checkLoginUserInfo->NickName;\t\t$_SESSION ['usrInfo'] ['UserId_Xdf'] = $userHandler->checkLoginUserInfo->UserId;\t\t$_SESSION ['usrInfo'] ['Token'] = $userHandler->checkLoginUserInfo->Token;\t\t$_SESSION ['usrInfo'] ['type'] = 2; // 是普通用户\t\theader ( \"Content-Type: text/html; charset=utf8\" );\t\techo '<script> window.location.href=\"space.php?do=input\" </script>';\t} else {\t\theader ( \"Content-Type: text/html; charset=utf8\" );\t\techo '<script> alert(\"' . $userHandler->message . '\"); window.location.href=\"index.php\"</script>';\t}} elseif ($do == 'logout') {\t\t$type = empty ( $_GET ['type'] ) ? 0 : intval ( $_GET ['type'] );\tsession_start ();\tsession_destroy ();\tif ($type == 2) {\t\theader ( \"Location: index.php\" );\t} elseif ($type == 1) {\t\theader ( \"Location: adindex.php\" );\t} else {\t\theader ( \"Location: index.php\" );\t}}?>\n三.文件上传可拿shell.查看class_upload.php文件可知.文件上传只简单验证文件Content-type类型,并保留原后缀.视频放在/uploads_video/dvdasai/时间/time ()_随机数.图片放在/uploads_img/time ()_随机数.此处time ()_随机数可由前端界面看到.故找到真实地址不难.四.注入.(此处只说明可能性)这里还是看源码得到的,源码多处使用直接拼接sql,并传递给class_mysql.php,没有任何过滤.具体自己看源码吧.当然,对于php,只要搭建环境时把配置里一个参数设置为on就可以防止注入，没具体查环境怎样，所以此处只说明可能性.服务器环境具体看http://coolcampdv2011.xdf.cn/uploads/phpinfo.php   漏洞证明：  \n\n   修复方案：  相信你们比我懂的。   版权声明：转载请注明来源 Mr .LZH@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：4  确认时间：2014-01-20 14:54 厂商回复： 谢谢提供信息，我们会尽快确认。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-01-20 15:24 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  我艹,4rank,这么多洞,而且还传得了webshell,给我4rank,话说@新东方 你们是有多抠啊    \n     2014-01-20 15:27 |    \t\tMr .LZH \t\t\t( 普通白帽子  |\t\t\t        Rank:583 漏洞数:75        | 非妹子勿扰···)\t\t \n  自我感觉不会再爱了,坑货一个,要不是前段日子考试,我拿下shell,脱完裤再发乌云     \n     2014-02-09 22:00 |    \t\t爱上襄阳 \t\t\t( 普通白帽子  |\t\t\t        Rank:345 漏洞数:86        | ...)\t\t \n  漏洞依然存在呢·    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 4, "Ranks": null}