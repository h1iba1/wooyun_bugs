{"id": 85955, "wybug_id": "wooyun-2016-0170003", "wybug_title": "上海格尔安全认证网关管理系统命令执行漏洞大礼包", "wybug_corp": "cncert国家互联网应急中心", "wybug_author": "xfkxfk", "wybug_date": "2016-01-15 11:52", "wybug_open_date": "2016-04-11 16:08", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "已交由第三方合作机构(cncert国家互联网应急中心)处理", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "源码审核", "模板文件操作参数未过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-01-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-01-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2016-01-22：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航、无声信息）\t\t\t\t\t\t\t\t\t2016-03-14：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2016-03-24：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-04-03：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-04-11：\t细节向公众公开  简要描述： 上海格尔安全认证网关管理系统命令执行漏洞多处 详细说明：  第一和第二处命令执行文件/kssl/kssl/WEBUI/www/api/service.php\n<?php\tinclude_once \"../global/common.php\";\tinclude_once \"../ssl/service_helper.php\";\t\t/*\t处理GET请求\t*/\t$service_path = $_GET['service_path'];\t\tswitch( $_GET['service_action'] )\t{\t\tcase 'start': {\t\t\tif ( true == start_service($service_path) ) {\t\t\t\t$retry_limit = 10;\t\t\t\t$state_expected = '已启动';\t\t\t\tWEBUI_log( LOG_INFO, \"启动代理服务$service_path\".\"成功\" );\t\t\t}\t\t\telse {\t\t\t\tWEBUI_log( LOG_INFO, \"启动代理服务$service_path\" );\t\t\t}\t\t\twhile( $service_path != \"\" && $retry_limit > 0 ) {\t\t\t\t$state = status_service($service_path);\t\t\t\t\t\t\t\t/*\t如果HRP状态达到了期望值，则中止重试操作\t*/\t\t\t\tif( $state == $state_expected ) {\t\t\t\t\tbreak;\t\t\t\t}\t\t\t\telse {\t\t\t\t\tsleep(1);\t\t\t\t\t$retry_limit--;\t\t\t\t}\t\t\t}\t\t\tbreak;\t\t}\t\tcase 'stop': {\t\t\tif ( true == stop_service($service_path) ) {\t\t\t\t$retry_limit = 10;\t\t\t\t$state_expected = '已停止';\t\t\t\tWEBUI_log( LOG_INFO, \"停止代理服务$service_path\".\"成功\" );\t\t\t}\t\t\telse {\t\t\t\tWEBUI_log( LOG_INFO, \"停止代理服务$service_path\" );\t\t\t}\t\t\twhile( $service_path != \"\" && $retry_limit > 0 ) {\t\t\t\t$state = status_service($service_path);\t\t\t\t\t\t\t\t/*\t如果HRP状态达到了期望值，则中止重试操作\t*/\t\t\t\tif( $state == $state_expected ) {\t\t\t\t\tbreak;\t\t\t\t}\t\t\t\telse {\t\t\t\t\tsleep(1);\t\t\t\t\t$retry_limit--;\t\t\t\t}\t\t\t}\t\t\tbreak;\t\t}\t\tcase 'download': {\t\t\t$proxy = get_proxy($service_path);\t\t\t\t\t\t$usermap_url = $proxy['usermap_url'];\t\t\tif( WEBUI_exec( \"$SSL_DIR/bin/hrp-download-usermap.sh $SSL_DIR/cfg/$service_path\", true ) ) {\t\t\t\tWEBUI_log( LOG_INFO, \"从$usermap_url\".\"下载代理服务$service_path\".\"的用户映射策略成功\" );\t\t\t}\t\t\telse {\t\t\t\tWEBUI_log( LOG_ERR, \"从$usermap_url\".\"下载代理服务$service_path\".\"的用户映射策略失败\" );\t\t\t}\t\t\t$acl_url = $proxy['acl_url'];\t\t\t\t\t\techo \"<script language='JavaScript'>\";\t\t\t\t\t\tif( WEBUI_exec( \"$SSL_DIR/bin/hrp-download-acl.sh $SSL_DIR/cfg/$service_path\", true ) ) {\t\t\t\tWEBUI_log( LOG_INFO, \"从$acl_url\".\"下载代理服务$service_path\".\"的ACL策略成功\" );\t\t\t\techo \"window.alert(\\\"激活策略成功\\\");\";\t\t\t}\t\t\telse {\t\t\t\tWEBUI_log( LOG_ERR, \"从$acl_url\".\"下载代理服务$service_path\".\"的ACL策略失败\" );\t\t\t\techo \"window.alert(\\\"激活策略失败\\\");\";\t\t\t}\t\t\techo \"window.close();\";\t\t\techo \"</script>\";\t\t\tbreak;\t\t}\t\tcase 'user': {\t\t\tif ( '已启动' != status_service($service_path) ) {\t\t\t\techo \"服务未启动\";\t\t\t\tbreak;\t\t\t}\t\t\t\t\t\t$proxy = get_proxy($service_path);\t\t\t$mrtg_enable = $proxy['mrtg_enable'];\t\t\t\t$mrtg_ip = $proxy['mrtg_ip'];\t\t\t\t$mrtg_port = $proxy['mrtg_port'];\t\t\t\tif ( $mrtg_enable == 'On' ) {\t\t\t\tsystem( \"curl http://$mrtg_ip:$mrtg_port/?ssl\" );\t\t\t}\t\t\telse {\t\t\t\techo \"实时状态查看功能未开启\";\t\t\t}\t\t\tbreak;\t\t}\t\tdefault:\t\t\tWEBUI_alert(\"无效参数：service_action=\".$_GET['service_action']);\t}?>\n注意这里的参数$service_path = $_GET['service_path'];最后$service_path进入函数start_service，stop_service，status_service这些函数的定义在文件/kssl/kssl/WEBUI/www/ssl/service_helper.php，跟进\nfunction start_service( $service_path ){\tglobal $SSL_DIR;\tglobal $PMONITOR_DIR;\t/*\t先检查HRP的配置文件，再运行PMonitor，错误定义见hrp-can-start.sh脚本的注释\t*/\texec( \"$SSL_DIR/bin/hrp-can-start.sh /kssl/HRP/cfg/$service_path 2>&1\", $results, $ret );\tswitch( $ret ) {\tcase 0:\t\tWEBUI_exec( \"$PMONITOR_DIR/bin/PMonitor --run -f $SSL_DIR/cfg/\".$service_path.\"/PMonitor.conf > /dev/null\", true );\t\treturn true;\tcase 1:\t\tWEBUI_alert( \"配置文件不存在，不能启动服务:\" );\t\treturn false;\tcase 2:\t\tWEBUI_alert( \"本机现在处于双机热备的待机状态，不能启动服务\" );\t\treturn false;\tcase 3:\t\tWEBUI_alert( \"使用了网络配置中不存在的IP地址，不能启动服务\" );\t\treturn false;\tcase 4:\t\tWEBUI_alert( \"监听的端口已经被其他程序所使用，不能启动服务\" );\t\treturn false;\tcase 5:\t\tWEBUI_exec( \"$SSL_DIR/bin/hrp-can-start.sh /kssl/HRP/cfg/$service_path 2>&1\", true, \"配置文件不完整,或者进行了错误配置\" );\t\treturn false;\t}}function stop_service( $service_path ){\tglobal $SSL_DIR;\tglobal $PMONITOR_DIR;\tWEBUI_exec( \"$PMONITOR_DIR/bin/PMonitor --kill -f $SSL_DIR/cfg/\".$service_path.\"/PMonitor.conf\", true );}function status_service( $service_path ){\tglobal $PMONITOR_DIR;\texec( \"$PMONITOR_DIR/bin/PMonitor -l | grep \\\"HRP_$service_path \\\" | awk -F= '{print $3}'\", $results, $ret );\tswitch( $results[0] ) {\t\tcase \"\":\t\t\treturn \"已停止\";\t\tcase \"NORMAL\":\t\t\treturn \"已启动\";\t\tcase \"INIT\":\t\tcase \"RETRYING\":\t\t\treturn \"启动中\";\t}}\n由于status_service函数中命令有双引号保护，双引号被转义，导致利用失败看看start_service和stop_service函数，$service_path进入了WEBUI_exec，跟进此函数文件/kssl/kssl/WEBUI/www/global/common.php\nfunction WEBUI_exec( $cmd, $show_err = false, $note = '' ){\texec( $cmd, $results, $ret );\tif( $ret != 0 ) {\t\t\t\tif( $show_err ) {\t\t\t$err = '执行 '.$cmd.' 命令失败';\t\t\tforeach ( $results as $err_line ) {//2007-5-8 yanhm bugfix for 0005289:错误信息太多 +{{\t\t\t\t//错误信息中删去命令帮助信息\t\t\t\tif ( strncmp($err_line, \"Usage\", 5) != 0 )\t\t\t\t\tbreak;//}}\t\t\t\t$err = $err.', '.$err_line;\t\t\t}\t\t\t\t\t\tWEBUI_alert( \"$note:$err\" );\t\t}\t\t\t\treturn false;\t}\treturn true;}\n最终进入了exec中，导致命令执行所以当service_action=start和service_action=stop时存在两处命令执行漏洞第三处和第四处命令执行文件/kssl/kssl/WEBUI/www/PrivManager.php\n<?php \t$setup_ini = \"/kssl/WEBUI/www/global/setup.ini\";    $title_php = \"/kssl/WEBUI/www/global/title.php\";    $version_php = \"/kssl/WEBUI/www/global/version.php\";    $copyright_php = \"/kssl/WEBUI/www/global/copyright.php\";    $logo_php = \"/kssl/WEBUI/www/global/logo.php\";        $logo_jpg_file = \"/kssl/WEBUI/www/image/logo.jpg\";\t\tfunction get_setup_ini()\t{\t\tglobal $setup_ini;\t\t$ini_array = array();\t\t$ini_array = parse_ini_file($setup_ini, true);\t\t\treturn $ini_array;\t}\t\t$setup = array();\t$setup = get_setup_ini();\t\tswitch( $_POST['submit_action'] )\t{\t\tcase 'set_privmanager': {\t\t\t\t\t\t$MODE = $_POST[\"modes\"];\t\t\t\t\t\t$titlenames = $_POST[\"titlenames\"];\t\t\t\t\t$copyright = $_POST[\"copyright\"];\t\t\t$version = $_POST[\"version\"];\t\t\t\t\t\t\t\t\tif( $titlenames == -1 ) {\t\t\t\t$titlenames = $_POST[\"othername\"];\t\t\t}\t\t\tif( $copyright == -1 ) {\t\t\t\t$copyright =$_POST[\"othercopyright\"];\t\t\t}\t\t\tif( $version == -1 ) {\t\t\t\t$version = $_POST[\"otherversion\"];\t\t\t}\t\t\t\t\t\t$logo = $titlenames.\"入口\";\t\t\t\t\t\t$f = fopen( \"$title_php\", \"w\" );            fwrite( $f, \"<?php\\n\" );            fwrite( $f, \"echo \\\"$titlenames\\\";\\n\" );            fwrite( $f, \"?>\\n\" );            fclose( $f );                        $f = fopen( \"$logo_php\", \"w\" );            fwrite( $f, \"<?php\\n\" );            fwrite( $f, \"echo \\\"$logo\\\";\\n\" );            fwrite( $f, \"?>\\n\" );            fclose( $f );            $f = fopen( \"$copyright_php\", \"w\" );            fwrite( $f, \"<?php\\n\" );            fwrite( $f, \"echo \\\"$copyright\\\";\\n\" );            fwrite( $f, \"?>\\n\" );            fclose( $f );\t\t\t                        $tmp_arr = explode(\".\", $version);            $big_version = $tmp_arr[0];            $tmp = strstr($version, \".\");            $l_version = substr($tmp, 1);            \t\t\t            $f = fopen( \"$version_php\", \"w\" );            fwrite( $f, \"<?php\\n\" );            fwrite( $f, \"\\$major=\\\"$big_version\\\";\\n\" );            fwrite( $f, \"\\$minor=\\\"$l_version\\\";\\n\" );\t\t\tfwrite( $f, \"\\$baseline=\\\"R\\\";\\n\" );\t\t\tfwrite( $f, \"\\$build=\\\"110106\\\";\\n\" );\t\t\tfwrite( $f, \"echo \\\"版本：\\$major.\\$minor \\$baseline-\\$build\\\";\\n\" );\t\t\tfwrite( $f, \"?>\\n\" );\t\t\tfclose( $f );                        $logo_jpg = $_POST[\"logo_jpg\"];                        $logo_jpg_path = \"/kssl/WEBUI/www/image/\".$logo_jpg;                        exec(\"cp --reply=yes $logo_jpg_path $logo_jpg_file\");            \t\t\tif( $MODE == 0 ) {\t\t\t\t$MODE_NAME = \"单权模式\";\t\t\t} else {\t\t\t\t$MODE_NAME = \"三权模式\";\t\t\t}\t\t\tif( WEBUI_exec( \"/kssl/WEBUI/bin/PrivManager.sh $MODE\", true ) ) {\t\t\t\tWEBUI_log( LOG_INFO, \"设备部署-设置完成!\" );\t\t\t\techo \"<script langauge=javascript>alert('设备部署-设置完成!')</script>\";\t\t\t\texec(\"touch /kssl/WEBUI/cfg/PrivManager.conf\");\t\t\t\techo \"<script langauge=javascript>window.location='index.php';</script>\";\t\t\t} else {\t\t\t\tWEBUI_log( LOG_ERR, \"设备部署-设置失败!\" );\t\t\t\techo \"<script langauge=javascript>alert('设备部署-设置失败!')</script>\";\t\t\t}\t\t\t\t\t\tbreak;\t\t}\t}?>\n可以清楚看到：$logo_jpg = $_POST[\"logo_jpg\"];exec(\"cp --reply=yes $logo_jpg_path $logo_jpg_file\");logo_jpg存在命令执行还有一处在：$MODE = $_POST[\"modes\"];WEBUI_exec( \"/kssl/WEBUI/bin/PrivManager.sh $MODE\", true )WEBUI_exec的内容见上面的内容==============================================================================上面的几处是直接没有判断登录状态的，直接利用，下面设计大面积登录验证绕过命令执行首先全局文件中，文件名为*_i.php的文件为正式功能文件且都有登录验证：\n<?php\t\tsession_start();\tinclude_once \"../global/common.php\";\tif( WEBUI_HasLogin() == false  ) {\t\techo \"<script language=\\\"javascript\\\">window.location = \\\"/login.php\\\";</script>\";\t}?>/*\t判断是否登录\t*/function WEBUI_HasLogin( $bRedirect = true ) {\tif( isset($_SESSION['KLSSL_WEBUI_LOGINSTATE']) ) {\t\treturn true;\t}\telse {\t\tif( $_COOKIE['KLSSL_WEBUI_USERNAME'] != \"\" and $_COOKIE['KLSSL_WEBUI_PASSWORD'] != \"\" ) {\t\t\tWEBUI_log( LOG_INFO, \"以Cookie方式登录\" );\t\t\treturn WEBUI_Login($_COOKIE['KLSSL_WEBUI_USERNAME'], $_COOKIE['KLSSL_WEBUI_PASSWORD']);\t\t}\t\telse {\t\t\tif ($bRedirect) {\t\t\t\theader(\"Location: /login.php\");\t\t\t\texit();         \t\t\t}               \t\t\treturn false;\t\t}\t}}\n当KLSSL_WEBUI_USERNAME和KLSSL_WEBUI_PASSWORD不为空时进入WEBUI_Login中function WEBUI_Login( $username, $password ){\tunset($_SESSION['KLSSL_WEBUI_LOGINSTATE']);\tif ( WEBUI_CheckPassword( $username, $password ) == false ) {\t\tWEBUI_log( LOG_INFO, \"用户\".$username.\"登录失败\" );\t\treturn false;\t}\telse {\t\tWEBUI_log( LOG_INFO, \"用户\".$username.\"登录成功\" );\t} \t$_SESSION['KLSSL_WEBUI_LOGINSTATE'] = $username;\treturn true;}最后进入WEBUI_CheckPassword中验证：function WEBUI_CheckPassword( $username, $password ){\tglobal $WEBUI_DIR; \texec( \"grep '$username:' $WEBUI_DIR/cfg/passwd | awk -F: '{print $2}'\", $results, $ret );\tif( $ret == 0 ) {\t\t// return ( md5($password) == $results[0] ) ;\t\treturn ( $password == $results[0] ) ;\t}\telse {\t\treturn false;\t}}可见名用户么密码都存在文件/kssl/kssl/WEBUI/cfg/passwd中所以通过上面的命令执行即可读取这里的账户信息进行登录或者再登录处提交username=12312312，随意字符串，然后password为空即可绕过登录成功登录后台</code>在登录后既有太对命令执行了，几乎所有的*_i.php文件都存在命令执行漏洞如：\nnet_curl_i.php<?php\t$results = array();\t/*\t处理POST请求\t*/\tswitch( $_POST['submit_action'] ) {\t\tcase 'curl': {\t\t\t$URL = $_POST['URL'];\t\t\texec( \"curl -k -v --connect-timeout 30 \".$URL.\" 2>&1\", $results, $ret );\t\t\tbreak;\t\t}\t}?>net_ping_i.php<?php\t/*\t处理POST请求\t*/\tswitch( $_POST['submit_action'] ) {\t\tcase 'ping': {\t\t\t$IP = $_POST['IP'];\t\t\texec( \"ping -W 3 -c 4 \".$IP, $results, $ret );\t\t\tbreak;\t\t}\t}?>net_telnet_i.php<?php\t$results = array();\t/*\t处理POST请求\t*/\tswitch( $_POST['submit_action'] ) {\t\tcase 'telnet': {\t\t\t$IP = $_POST['IP'];\t\t\t$PORT = $_POST['PORT'];\t\t\t//exec( \"/kssl/PMonitor/bin/Connector -p TCP -i \".$IP.\" -o \".$PORT, $results, $ret );\t\t\texec( \"/bin/nc -z \".$IP.\" \".$PORT, $results, $ret );\t\t\t//WEBUI_alert(\"/kssl/PMonitor/bin/Connector -p TCP -i \".$IP.\" -o \".$PORT);\t\t\tbreak;\t\t}\t}?>net_snmp_i.php$v3username=$_POST['v3username'];\t\t\t$password=$_POST['password'];\t\t\t$enc_password=$_POST['enc_password'];\t\t\t\t\t\t$snmpconf = get_snmpconf();\t\t\t$snmpconf['listenaddr'] = $ListenAddr;\t\t\t$snmpconf['version'] = $version;\t\t\t$snmpconf['v3username'] = $v3username;\t\t\t$snmpconf['password'] = $password;\t\t\t$snmpconf['enc_password'] = $enc_password;\t\t\t\t\t\texec(\"net-snmp-config --create-snmpv3-user -ro -a $password -x $enc_password -X DES -A MD5 $v3username\");剩下的就不一一列举了\n   漏洞证明：  \n\n\n\n可以看到id成功执行，且为root权限\n\n\n\n成功写入文件   修复方案：  登录验证，执行命令拼接参数过滤   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2016-01-19 11:52 厂商回复： CNVD未直接复现所述情况，已经由CNVD通过以往建立的处置渠道软件生产厂商通报，由其后续提供解决方案并协调相关用户单位处置。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-01-15 11:53 |    \t\t带头大哥 \t\t\t( 普通白帽子  |\t\t\t        Rank:699 漏洞数:214        | |任意邮件伪造| |目录遍历| |任意文件读取|...)\t\t \n  师傅就是牛！    \n     2016-01-15 11:54 |    \t\t带我玩 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:8        | 带我玩)\t\t \n  师傅就是牛！     \n     2016-01-15 12:12 |    \t\t麦兜 \t\t\t( 实习白帽子  |\t\t\t        Rank:65 漏洞数:10        | 麦兜爱吃苹果.)\t\t \n  师傅就是快    \n     2016-01-15 14:38 |    \t\t%230CC \t\t\t( 路人 |\t\t\t        Rank:6 漏洞数:2        | 溜溜)\t\t \n  你们能不能别这么赤裸裸的跟我表哥套近乎。。。    \n     2016-01-15 19:46 |    \t\tFnut \t\t\t( 实习白帽子  |\t\t\t        Rank:71 漏洞数:17        | 大王叫我来巡山，巡完南山巡北山)\t\t \n  师傅就是牛！    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}