{"id": 5607, "wybug_id": "wooyun-2013-045130", "wybug_title": "ThinkSNS一处任意文件包含", "wybug_corp": "ThinkSNS", "wybug_author": "齐迹", "wybug_date": "2013-12-06 15:39", "wybug_open_date": "2014-03-06 15:40", "wybug_type": "文件包含", "wybug_level": "中", "wybug_rank_0": "6", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["文件包含漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2013-12-06：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2013-12-06：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2013-12-09：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-01-30：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-02-09：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-02-19：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-03-06：\t细节向公众公开  简要描述： ThinkSNS一处任意文件包含。一定条件下可以getshell 详细说明：  问题发生在public/minify.php\nallowed_content_types\t=\tarray('js','css');$getfiles\t= explode(',', strip_tags($_GET['f']));//解析参数$gettype\t= (isset($_GET['t']) && $_GET['t']=='css')?'css':'js';if($gettype=='css'){\t$content_type\t=\t'text/css';}elseif($gettype=='js'){\t$content_type\t=\t'application/x-javascript';}else{\tdie('not allowed content type');}header (\"content-type: \".$content_type.\"; charset: utf-8\");\t\t//注意修改到你的编码header (\"cache-control: must-revalidate\");\t\t\t\t//header (\"expires: \" . gmdate (\"D, d M Y H:i:s\", time() + 60 * 60 * 24 * 7 ) . \" GMT\");\t//过期时间ob_start(\"compress\");function compress($buffer) {//去除文件中的注释\t$buffer = preg_replace('!/\\*[^*]*\\*+([^/][^*]*\\*+)*/!', '', $buffer);\treturn $buffer;}foreach($getfiles as $file){\t$fileType = strtolower( substr($file, strrpos($file, '.') + 1 ) );\tif(in_array($fileType, $allowed_content_types)){\t\t//包含你的全部css文档\t\tinclude($file);\t}else{\t\techo 'not allowed file type:'.$file;\t}}\n通过$_GET['f'] 可以传递一个js或者css后缀的文件，内容为php脚本即可被包含并执行。当allow_url_fopen=On 的情况下 利用就非常简单直接远程文件。当为Off的时候 就想办法上传一个js或者css文件到服务器 然后包含即可被执行！   漏洞证明：  写一个1.js在网站根目录\n<?phpphpinfo();\n访问http://xxxxxx/public/minify.php?f=../1.js\n\n   修复方案：  对参数进行严格过滤   版权声明：转载请注明来源 齐迹@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：1  确认时间：2013-12-06 15:57 厂商回复： 非常感谢！但是我们测试后无法直接包含远程文件。服务器上也不允许上传js、css文件，那么包含本地js/css文件有什么方法能造成比较大的危害呢？如果有，请再提交一个漏洞，给你高分，谢谢！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2013-12-06 15:43 |    \t\tzzR  \t\t\t( 核心白帽子 |\t\t\t        Rank:1382 漏洞数:122        | 收wb   1：5 无限量收   [平台担保])\t\t \n  期待    \n     2013-12-06 16:11 |    \t\t齐迹 \t\t\t( 核心白帽子 |\t\t\t        Rank:784 漏洞数:100        | 一名普通的phper开发者，关注web安全。)\t\t \n  @ThinkSNS 我勒个去。Include 的文件和后缀没有关系 和文件内容有关！没有看到phpinfo已经出来了吗？    \n     2013-12-06 16:20 |    \t\t秋风 \t\t\t( 普通白帽子  |\t\t\t        Rank:438 漏洞数:44        | 码农一枚，关注互联网安全)\t\t \n  @齐迹  include包含？放开这妹子，让我来！    \n     2013-12-06 16:44 |    \t\tteamtopkarl \t\t\t( 实习白帽子  |\t\t\t        Rank:48 漏洞数:7        | 对网络安全事业一直保持着激情)\t\t \n  我早发现了一处，利用解析漏洞还是可以利用的    \n     2013-12-09 15:07 |    \t\tThinkSNS(乌云厂商)\t\t \n  @齐迹 经测试，在开启allow_url_include时可以远程包含，allow_url_fopen开启也不能利用这个漏洞。因为php.ini默认不开启这个配置，所以我们没测试重现。漏洞还是要发包修复的，只是危害性小了一些，非常感谢。    \n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 1, "Ranks": null}