{"id": 50394, "wybug_id": "wooyun-2014-077943", "wybug_title": "CuuMall免费开源商城系统 越权集合 和cookie泄露用户名密码", "wybug_corp": "cuumall.com", "wybug_author": "menmen519", "wybug_date": "2014-10-02 10:19", "wybug_open_date": "2014-12-31 10:20", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["逻辑错误"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-10-02：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-10-09：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-10-12：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-12-03：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-12-13：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-12-23：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-31：\t细节向公众公开  简要描述： CuuMall免费开源商城系统 越权集合 详细说明：  CuuMall免费开源商城系统 越权可修改对方的 收货地址 个人信息 等等这里我们举一个例子，修改个人信息 直接看代码：UserInfoAction.class.php:(716-735)\npublic function posteditpro( )\t\t\t\t{\t\t\t\t\t\t\t\t$uid = $_POST['uid'];\t\t\t\t\t\t\t\t$data['shen'] = $_POST['shen'];\t\t\t\t\t\t\t\t$data['shi'] = $_POST['shi'];\t\t\t\t\t\t\t\t$data['qu'] = $_POST['qu'];\t\t\t\t\t\t\t\t$data['sex'] = $_POST['sex'];\t\t\t\t\t\t\t\t$data['realname'] = $_POST['realname'];\t\t\t\t\t\t\t\t$data['email'] = $_POST['email'];\t\t\t\t\t\t\t\t$data['more'] = $_POST['more'];\t\t\t\t\t\t\t\t$data['youbian'] = $_POST['youbian'];\t\t\t\t\t\t\t\t$data['tel'] = $_POST['tel'];\t\t\t\t\t\t\t\t$data['mob'] = $_POST['mob'];\t\t\t\t\t\t\t\t$data['qq'] = $_POST['qq'];\t\t\t\t\t\t\t\t$data['ww'] = $_POST['ww'];\t\t\t\t\t\t\t\t$rej = new Model( \"m_per\" );\t\t\t\t\t\t\t\t$rej->data( $data )->where( \"uid=\".$uid )->save( );\t\t\t\t\t\t\t\t$this->assign( \"msgTitle\", \"编辑个人档案成功！\" );\t\t\t\t\t\t\t\t$this->success( \"编辑个人档案成功！\" );\t\t\t\t}\n我们看看权限判断是靠什么：还是这个文件（28-35）\n$co = new Cookie( );\t\t\t\t\t\t\t\t$username = $co->get( c( \"GUESTCOOK\" ).\"mall-m-name\" );\t\t\t\t\t\t\t\t$password = $co->get( c( \"GUESTCOOK\" ).\"mall-m-pass\" );\t\t\t\t\t\t\t\tif ( empty( $username ) || empty( $password ) )\t\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\t\t\t\t\t$this->redirect( \"home/login\" );\t\t\t\t\t\t\t\t\t\t\t\texit( );\t\t\t\t\t\t\t\t}\n这里只是用cookie里面的用户名和密码这里的用户名和密码 都可完全转化为明文看一下 cookie.class.php:\nstatic function get($name) {        $value   = $_COOKIE[C('COOKIE_PREFIX').$name];        $value   =  unserialize(base64_decode($value));        return $value;    }\n这里没有任何秘钥 ，也就是说cookie里面的东西对于我们来说就是明文 那么我们回头再看 uid是post过来的 而且sql注入插入表：$rej->data( $data )->where( \"uid=\".$uid )->save( );这里明显只根据了uid做了判断 我们发送urlPOST /cuumall_v2.3/v2.3/mall_upload/index.php/home/userinfo/posteditpropostdata：shen=%E6%B9%96%E5%8C%97&shi=%E8%8D%86%E5%B7%9E%E5%B8%82&qu=%E6%B2%99%E5%B8%82%E5%8C%BA&uid=5&realname=&email=test%401.com&more=xddd&youbian=xxx&tel=xxxxx&mob=xxxxxxx&qq=xxxxxxxxxxxxx&ww=xxxxxxxxxxxxxx&imageField.x=93&imageField.y=17&__hash__=f543cb0871b243508a543f0b18b91026看看cookie里面的username，解出来是test 那么我们uid=5直接更改test2用户的信息资料\n\n这里被修改了 我们再看其他地方，还是这个文件：\npublic function postchgrejpro( )\t\t\t\t{\t\t\t\t\t\t\t\t$id = $_POST['id'];\t\t\t\t\t\t\t\t$data['shen'] = $_POST['shen'];\t\t\t\t\t\t\t\t$data['shi'] = $_POST['shi'];\t\t\t\t\t\t\t\t$data['qu'] = $_POST['qu'];\t\t\t\t\t\t\t\t$data['more'] = $_POST['more'];\t\t\t\t\t\t\t\t$data['youbian'] = $_POST['youbian'];\t\t\t\t\t\t\t\t$data['rejname'] = $_POST['rejname'];\t\t\t\t\t\t\t\t$data['mob'] = $_POST['mob'];\t\t\t\t\t\t\t\t$data['tel'] = $_POST['tel'];\t\t\t\t\t\t\t\t$data['email'] = $_POST['email'];\t\t\t\t\t\t\t\t$data['qq'] = $_POST['qq'];\t\t\t\t\t\t\t\t$data['ww'] = $_POST['ww'];\t\t\t\t\t\t\t\t$rej = new Model( \"m_rejpro\" );\t\t\t\t\t\t\t\t$rej->data( $data )->where( \"id=\".$id )->save( );\t\t\t\t\t\t\t\t$this->assign( \"waitSecond\", 3 );\t\t\t\t\t\t\t\t$this->assign( \"jumpUrl\", \"__APP__/home/userinfo/rejpru\" );\t\t\t\t\t\t\t\t$this->assign( \"msgTitle\", \"收货地址编辑成功\" );\t\t\t\t\t\t\t\t$this->success( \"收货地址编辑成功！\" );\t\t\t\t}\n原理和刚才那个一样 这里不多赘述其实应该还有好多地方，凡是用uid 做验证的 都具有越权操作   漏洞证明：     修复方案：     版权声明：转载请注明来源 menmen519@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：20  确认时间：2014-10-09 13:16 厂商回复： 感谢，已经着手处理 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-10-02 22:02 |    \t\tAres \t\t\t( 路人 |\t\t\t        Rank:29 漏洞数:8        | 来自幼儿园大班)\t\t \n  @menmen519 mark    \n     2014-10-02 23:25 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  我也是醉了。哥么你不休假啊- -@menmen519    \n     2014-10-02 23:45 |    \t\tmenmen519 \t\t\t( 普通白帽子  |\t\t\t        Rank:762 漏洞数:146        | http://menmen519.blog.sohu.com/)\t\t \n  @xiaoL 放假前提的    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 20, "Ranks": null}