{"id": 52885, "wybug_id": "wooyun-2014-069778", "wybug_title": "qibocms下载系统 注入&amp;另外一个老问题", "wybug_corp": "齐博CMS", "wybug_author": "′雨。", "wybug_date": "2014-07-28 10:23", "wybug_open_date": "2014-10-26 10:24", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": "", "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-07-28：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-07-28：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-09-21：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-10-01：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-10-11：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-10-26：\t细节向公众公开  简要描述： RT. 详细说明：  下载地址  http://bbs.qibosoft.com/down2.php?v=download1.0#down 0x01 老问题在download/inc/job/down_encode.php中\nif(eregi('.php',$url)){\t\theader(\"location:$true_url\");\texit;}$webdb[upfileType] = str_replace(' ','|',$webdb[upfileType]);if(file_exists(ROOT_PATH.\"$webdb[updir]/$url\") && eregi(\"($webdb[upfileType])$\",$url) && filesize(ROOT_PATH.\"$webdb[updir]/$url\")<1024*1024*10){\t$filetype=substr(strrchr($url,'.'),1);\tob_end_clean();\theader('Last-Modified: '.gmdate('D, d M Y H:i:s',time()).' GMT');\theader('Pragma: no-cache');\theader('Content-Encoding: none');\theader('Content-Disposition: attachment; filename='.\"$true_name.$filetype\");\theader('Content-type: '.$filetype);\theader('Content-Length: '.filesize(ROOT_PATH.\"$webdb[updir]/$url\"));\treadfile(ROOT_PATH.\"$webdb[updir]/$url\");\texit;\n厂商对上次我爆的那个洞做了修补 eregi(\"($webdb[upfileType])$\",$url 白名单验证。但是在download/inc/down_encode.php 中\n$true_url=tempdir($url);if(eregi('.php',$url)){\t\theader(\"location:$true_url\");\texit;}if(file_exists(ROOT_PATH.\"$webdb[updir]/$url\")&&filesize(ROOT_PATH.\"$webdb[updir]/$url\")<1024*1024*10){\t$filetype=substr(strrchr($url,'.'),1);\tob_end_clean();\theader('Last-Modified: '.gmdate('D, d M Y H:i:s',time()).' GMT');\theader('Pragma: no-cache');\theader('Content-Encoding: none');\theader('Content-Disposition: attachment; filename='.\"$true_name.$filetype\");\theader('Content-type: '.$filetype);\theader('Content-Length: '.filesize(ROOT_PATH.\"$webdb[updir]/$url\"));\treadfile(ROOT_PATH.\"$webdb[updir]/$url\");\texit;\n却没有做白名单验证 只是黑名单验证是否含有.php 按照上次发的那个可以绕过。然后这个涉及到了个入库出库 然后在发布软件的时候图片地址写要下载的就行了绕过黑名单参照这个。及剩下的参照下面这个 我就不多说了。 WooYun: qibocmsV7整站系统任意文件下载导致无限制注入多处(可提升自己为管理 Demo演示) ____________________________________________________________________0x02 注入在全局文件中 \n$_POST=Add_S($_POST);$_GET=Add_S($_GET);$_COOKIE=Add_S($_COOKIE);\n\nfunction Add_S($array){\tforeach($array as $key=>$value){\t\tif(!is_array($value)){\t\t\t$value=str_replace(\"&#x\",\"& # x\",$value);\t//过滤一些不安全字符\t\t\t$value=preg_replace(\"/eval/i\",\"eva l\",$value);\t//过滤不安全函数\t\t\t!get_magic_quotes_gpc() && $value=addslashes($value);\t\t\t$array[$key]=$value;\t\t}else{\t\t\t$array[$key]=Add_S($array[$key]); \t\t}\t}\treturn $array;}\n这里调用了这个函数来对get post cookie来转义 如果gpc off的话 就addslashes对数组中的value进行转义  这里没有对数组中的key进行过滤。在download/member/post.php中\nelseif($job=='manage'){\tif(!$atc_power)showerr(\"你没权限\");\tif($rsdb[pages]<2){\t\theader(\"location:post.php?job=edit&aid=$aid\");exit;\t}\tif($step==2){\t\tasort($orderDB);\t\t$i=0;\t\tforeach( $orderDB AS $key=>$value){\t\t\t$i++;\t\t\t$db->query(\"UPDATE {$_pre}reply SET orderid=$i WHERE aid='$aid' AND rid='$key'\");\t\t}\t\trefreshto(\"$FROMURL\",\"排序成功\",1);\t}\n\nif($lfjid){\tif($web_admin||$lfjuid==$rsdb[uid]){\t\t$atc_power=1;\t}}\n这个只要是你自己发布的就有权限了。 所以我们自己先发布一个。\nforeach( $orderDB AS $key=>$value){\t\t\t$i++;\t\t\t$db->query(\"UPDATE {$_pre}reply SET orderid=$i WHERE aid='$aid' AND rid='$key'\n这里把数组中的key循环出来后 没有做任何的过滤就带入到了查询当中造成了注入。   漏洞证明：  \n\n首先注册一个会员 投稿 因为if($rsdb[pages]<2){\t\theader(\"location:post.php?job=edit&aid=$aid\");exit;\t}验证了两页 所以得发两页。\n\n然后就成功注入了。   修复方案：  对于第一个问题  做白名单第二个 $key=intval($key);   版权声明：转载请注明来源 ′雨。@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：18  确认时间：2014-07-28 14:11 厂商回复： 感谢提出来 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 18, "Ranks": null}