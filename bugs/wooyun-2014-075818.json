{"id": 51069, "wybug_id": "wooyun-2014-075818", "wybug_title": "Maccms V8 最新版SQL注入（无视GPC）", "wybug_corp": "maccms.com", "wybug_author": "xiaoL", "wybug_date": "2014-09-15 16:04", "wybug_open_date": "2014-12-14 16:06", "wybug_type": "SQL注射漏洞", "wybug_level": "中", "wybug_rank_0": "10", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "注射漏洞利用技巧"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2014-09-15：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2014-09-15：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2014-09-18：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2014-11-09：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2014-11-19：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2014-11-29：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2014-12-14：\t细节向公众公开  简要描述： 官网刚下的程序，确认不重复。利用起来特别有意思。 详细说明：  苹果CMS使用be函数来获取参数\nfunction be($mode,$key,$sp=','){\tini_set(\"magic_quotes_runtime\", 0);\t$magicq= get_magic_quotes_gpc();\tswitch($mode)\t{\t\tcase 'post':\t\t\t$res=isset($_POST[$key]) ? $magicq?$_POST[$key]:@addslashes($_POST[$key]) : '';\t\t\tbreak;\t\tcase 'get':\t\t\t$res=isset($_GET[$key]) ? $magicq?$_GET[$key]:@addslashes($_GET[$key]) : '';\t\t\tbreak;\t\tcase 'arr':\t\t\t$arr =isset($_POST[$key]) ? $_POST[$key] : '';\t\t\tif($arr==\"\"){\t\t\t\t$value=\"0\";\t\t\t}\t\t\telse{\t\t\t\tfor($i=0;$i<count($arr);$i++){\t\t\t\t\t$res=implode($sp,$arr);\t\t\t\t} \t\t\t}\t\t\tbreak;\t\tdefault:\t\t\t$res=isset($_REQUEST[$key]) ? $magicq ? $_REQUEST[$key] : @addslashes($_REQUEST[$key]) : '';\t\t\tbreak;\t}\treturn $res;}\n其中arr方法没有过滤，因此开始找一个arr的点。终于找到一个能利用的。在admin\\tpl\\module\\art.php文件中存在\nelseif($method=='typesaveall'){\t$t_id = be('arr','t_id'); //使用了arr方法\t$ids = explode(',',$t_id);\tforeach($ids as $id){\t\t$t_name = be('post','t_name' .$id);\t\t$t_enname = be('post','t_enname' .$id) ;\t\t$t_sort = be('post','t_sort' .$id);\t\t$t_tpl = be('post','t_tpl' .$id);\t\t$t_tpl_art = be('post','t_tpl_art' .$id);\t\t\t\tif (isN($t_name)) { $t_name='未知';}\t\tif (isN($t_enname)) { $t_enname='weizhi';}\t\tif (!isNum($t_sort)) { $t_sort=0;}\t\tif (isN($t_tpl)) { $t_tpl = 'artlist.html';}\t\tif (isN($t_tpl_art)) { $t_tpl_art = 'art.html';}\t\t\t\t$db->Update ('{pre}art_type',array('t_name','t_enname', 't_sort','t_tpl','t_tpl_art'),array($t_name,$t_enname,$t_sort,$t_tpl,$t_tpl_art),'t_id='.$id); //最终带入了sql语句中。\t}\tupdateCacheFile();\tredirect( getReferer() );}\n   漏洞证明：  这个点比较有意思的就是虽然带入了语句，但是是update的类型，最后使用盲注。但是又不能使用逗号，经过多方咨询终于搞定。http://dev.mysql.com/doc/refman/5.0/en/string-functions.html#function_substringsubstring方法存在类似：SELECT SUBSTRING('Sakila' FROM -4 FOR 2);这样的方法即可不适用逗号使用ord避免了单引号出现。最后利用or 1 = (select ord(substring(user() from 1 for 1))=114)-- 1;来判断是否成功。初始下\n\n插入语句\n\n这里必须多条更新，插入到最后一条中，这样or成立，标签1就会被重置。就判断成功了。   修复方案：  arr方法过滤   版权声明：转载请注明来源 xiaoL@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：中 漏洞Rank：8  确认时间：2014-09-15 20:34 厂商回复： 利用起来有一定的前提，需要进入后台。确认此问题，稍后改进。 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2014-09-15 16:48 |    \t\t寂寞的瘦子 \t\t\t( 普通白帽子  |\t\t\t        Rank:242 漏洞数:53        | 一切语言转汇编理论)\t\t \n  吊.吊..吊...吊爆...了    \n     2014-09-15 18:53 |    \t\t袋鼠妈妈 \t\t\t( 普通白帽子  |\t\t\t        Rank:449 漏洞数:61        | 故乡的原风景.MP3)\t\t \n  吊.吊..吊...吊爆...了    \n     2014-09-16 11:09 |    \t\txiaoL \t\t\t( 普通白帽子  |\t\t\t        Rank:361 漏洞数:67        | PKAV技术宅社区!Blog:http://www.xlixli....)\t\t \n  @寂寞的瘦子 好久没看到你了- -    \n  \n\n\n", "wybug_level_fromcorp": "中", "wybug_rank_fromcorp": 8, "Ranks": null}