{"id": 66642, "wybug_id": "wooyun-2015-0131155", "wybug_title": "天融信WEB应用安全网关任意命令执行+SQL注入（无需登录）", "wybug_corp": "天融信", "wybug_author": "路人甲", "wybug_date": "2015-08-03 08:11", "wybug_open_date": "2015-11-01 16:06", "wybug_type": "命令执行", "wybug_level": "高", "wybug_rank_0": "20", "wybug_status": "厂商已经确认", "wybug_from": "http://www.wooyun.org", "wybug_tags": ["源码审核", "敏感文件操作参数未加过滤"], "wybug_detail": "漏洞详情 披露状态：   \t\t\t\t\t\t\t\t\t2015-08-03：\t细节已通知厂商并且等待厂商处理中\t\t\t\t\t\t\t\t\t2015-08-03：\t厂商已经确认，细节仅向厂商公开\t\t\t\t\t\t\t\t\t2015-08-06：\t细节向第三方安全合作伙伴开放\t\t\t\t\t\t\t\t\t2015-09-27：\t细节向核心白帽子及相关领域专家公开\t\t\t\t\t\t\t\t\t2015-10-07：\t细节向普通白帽子公开\t\t\t\t\t\t\t\t\t2015-10-17：\t细节向实习白帽子公开\t\t\t\t\t\t\t\t\t2015-11-01：\t细节向公众公开  简要描述： 天融信WEB应用安全网关三个不需要登录的任意命令执行和SQL注入+几十个普通权限的命令执行。 详细说明：  天融信的WEB应用安全网关我感觉是安全做的相对较好的一套系统，但最终还是找到一个疏漏的地方，可执行任意命令，同时还存在SQL注入,另外该系统在登录的前提下，还是有许多处可以直接执行命令的地方，这里就不多说了，望厂商自行修复。前面有人提交了该系统的命令执行漏洞，但需要登录，非常鸡肋\n WooYun: 天融信WEB应用安全网关可任意命令执行 \n漏洞一、命令执行漏洞这里首先给出不需要登录的命令执行。\n/function/ssh/file_ssh.php/function/ssh/file_ssh_exec.php/function/ssh/file_ssh_result.php\n直接访问\nhttps://122.156.42.163/function/ssh/file_ssh.php\n如图所示，并点击执行命令按钮\n\n跳转到如下的连接,输入命令，并点击提交命令：\nhttps://122.156.42.163/function/ssh/file_ssh_exec.php?action=user_query&id=2\n\n\n刷新页面，点击\"查看\"即可查看执行命令的结果，如下所示\n\n这里以执行 cat /etc/shadow 为例\n\n漏洞二、SQL注入\n/function/ssh/file_ssh.php\n部分代码为：\n/* 获取用户查询信息 */$id \t\t= getVar('id');$starttime \t= getVar(\"starttime\"); \t// 查询起始时间$stoptime\t= getVar(\"stoptime\"); \t// 查询结束时间$page_num \t\t= getVar(\"page_num\");\t\t\t\t// 分页变量$lines \t\t= getVar('lines');\t\t\t// 每页显示记录数$page_num\t\t= ($page_num != \"\") ? $page_num : 1;$lines \t\t= ($lines != '') ? $lines : 10;$offset\t\t= $lines * ( $page_num - 1 );/* 构建SQL查询语句 */$sql = \"\";$sql = \"SELECT * FROM tb_product\";$sql_where = \" WHERE 1\";$sql_orderby = \" order by status DESC limit $offset,$lines\";if($id != '' && $id != 'all'){    $sql_where .= \" AND id=\\\"$id\\\"\";}\n$lines参数，很明显的注入，但需要绕过系统本身的WAF,就不多说了漏洞三：无数个命令执行漏洞如下图所示\n\n\n\n这些文件（包括但不限于这些文件）均存在任意命令执行漏洞，简单贴下造成漏洞的代码命令执行一：\n/function/sysconfig/log_manage.phpclass Datamanage extends baseControl{\tpublic function doingSave()\t{\t\t$accesslog = getVar('accesslog');\t\t$accesslog2db = getVar('accesslog2db');\t\t$parselog = getVar('parselog');\t\t\t\t$accesslog = ($accesslog=='on')? 'start' : 'stop';\t\t$accesslog2db = ($accesslog2db=='on')? 'start' : 'stop';\t\t$parselog = ($parselog=='on')? 'start' : 'stop';\t\t\t\t$path = \"/usr/local/waf/waa/bin/waf_system_config.sh \";\t\t\t\t$cmd1 = $path.\" $accesslog accesslog\";\t\t@exec($cmd1, $out1, $ret1);\n命令执行二：\n/function/sysconfig/syslogng_configs.php\tclass Datamanage extends baseControl\t\t{\t\tpublic function doingSave()\t\t{\t\t\t$accesslog = getVar('accesslog');\t\t\t$accesslog2db = getVar('accesslog2db');\t\t\t$parselog = getVar('parselog');\t\t\t\t\t\t$accesslog = ($accesslog=='on')? 'start' : 'stop';\t\t\t$accesslog2db = ($accesslog2db=='on')? 'start' : 'stop';\t\t\t$parselog = ($parselog=='on')? 'start' : 'stop';\t\t\t\t\t\t$path = \"/usr/local/waf/waa/bin/waf_system_config.sh \";\t\t\t\t\t\t$cmd1 = $path.\" $accesslog accesslog\";\t\t\t@exec($cmd1, $out1, $ret1);\t\t\t\t\t\t$cmd2 = $path.\" $accesslog2db accesslog2db\";\t\t\t@exec($cmd2, $out2, $ret2);\t\t\t\t\t\t\t\t\t$cmd3 = $path.\" $parselog parselog\";\t\t\t@exec($cmd3, $out3, $ret3);\t\t\t\t\t\t$this->redirect(\"log_manage.php\");\t\t\t//jsAlert(\"操作成功\");\t\t\t//echo(\"<script language='javascript'>top.window.frames['carnoc'].location.reload();</script>\");\t\t\t//jsLocation('log_manage.php');\t\t\texit;\t\t}\n命令执行三：\n/function/appconfig/alarm/alarm_ddos.phpif(getVar(\"action\") == 'save'){   $weboc \t\t\t= getVar(\"weboc\");   $intervalValue \t\t= getVar(\"interval\");   if(getVar(\"yj\") == 1){\t\t$emailValue   \t\t = getVar(\"email\");\t\t$isEmailAbstratValue = getVar(\"isEmailAbstrat\");\t\t$emailValue = preg_replace(\"/[\\r|\\n]/i\", \"\", $emailValue);\t// 就剩下xxx,xxx,xxx了。\t\t}else{\t\t$emailValue   \t\t = \"NULL\";\t\t$isEmailAbstratValue = \"0\";\t}\tif(getVar(\"fx\") == 1){\t\t$smsValue \t\t\t = getVar(\"sjNum\");\t\t\t\t$smsValue = preg_replace(\"/[\\r|\\n]/i\", \"\", $smsValue);\t// 就剩下xxx,xxx,xxx了。\t\t//add by haoyh,2011-8-19，BUG[52534]处理连续逗号\t\t$smsValuearray =explode(',',$smsValue); \t\t$smsValue=\"\";\t\tforeach($smsValuearray as $value)\t\t{\t\t   if($value!=\"\")\t\t   {\t\t\t\t$smsValue.=$value.\",\";\t\t   }\t\t}\t\t$smsValue=trim($smsValue,\",\");\t\t}else{\t\t$smsValue \t\t\t = \"NULL\";\t\t\t}\tif($weboc == 0){\t\t$cmd = \"/usr/local/waf/waa/alarm/alarm_config.py ddos \".$weboc;\t\t\t\t}else{\t\t$cmd = \"/usr/local/waf/waa/alarm/alarm_config.py ddos \".$weboc.\" \".$intervalValue.\" \".$emailValue.\" \".$isEmailAbstratValue.\" \".$smsValue; \t}\t@exec($cmd, $out, $ret);\terror_show($message= array(\t\t'defaultUrl' => '/function/appconfig/alarm/alarm_ddos.php',\t\t'msg_content'=> ($ret ? \"操作失败\":\"操作成功\"),\t\t'label'=> '返回告警管理',\t\t'why' => $cmd,\t\t'where'=> 'DDos攻击告警修改',\t\t'status'=> $ret ? '1': '0',\t\t'menu'=>'appconfig'\t));}\n其他的命令执行还有非常多，请官方自行检查！   漏洞证明：  这里以执行 cat /etc/shadow 为例\n\n   修复方案：  过滤吧   版权声明：转载请注明来源 路人甲@乌云\n ", "wybug_reply": "漏洞回应  厂商回应： 危害等级：高 漏洞Rank：10  确认时间：2015-08-03 16:04 厂商回复： 感谢您的关注 最新状态： 暂无  ", "replys": "漏洞评价：\n评论\n     2015-08-03 09:12 |    \t\tYY-2012 \t\t\t( 普通白帽子  |\t\t\t        Rank:2924 漏洞数:653        | 意淫，是《红楼梦》原创的词汇，但后来演变...)\t\t \n  ……    \n     2015-08-03 09:14 |    \t\t大大灰狼 \t\t\t( 普通白帽子  |\t\t\t        Rank:248 漏洞数:53        | Newbie)\t\t \n  ...    \n     2015-08-03 11:33 |    \t\t我能拒绝么 \t\t\t( 路人 |\t\t\t        Rank:10 漏洞数:3        | 疯爆志林)\t\t \n  ...    \n     2015-08-03 11:34 |    \t\t正义的伙伴 \t\t\t( 普通白帽子  |\t\t\t        Rank:101 漏洞数:28        | 正义！！)\t\t \n  ...    \n     2015-08-03 16:41 |    \t\tWhysec \t\t\t( 路人 |\t\t\t        Rank:20 漏洞数:7        )\t\t \n  ...    \n     2015-08-06 19:11 |    \t\t草原飞歌 \t\t\t( 路人 |\t\t\t        Rank:4 漏洞数:1        | #乌云白帽子福利#我在乌云集市使用1WB参与...)\t\t \n  ...     \n     2015-08-07 09:13 |    \t\t野驴~ \t\t\t( 路人 |\t\t\t        Rank:5 漏洞数:2        | 充满强烈好奇心的菜鸟。)\t\t \n  ..    \n     2015-08-29 10:48 |    \t\tRainism \t\t\t( 路人 |\t\t\t        Rank:11 漏洞数:3        | hacking for fun)\t\t \n  ……    \n  \n\n\n", "wybug_level_fromcorp": "高", "wybug_rank_fromcorp": 10, "Ranks": null}